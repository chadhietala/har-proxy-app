{
  "log": {
    "version": "1.2",
    "creator": {
      "name": "WebInspector",
      "version": "537.36"
    },
    "pages": [
      {
        "startedDateTime": "2018-08-01T00:25:08.841Z",
        "id": "page_1",
        "title": "http://localhost:1234/",
        "pageTimings": {
          "onContentLoad": 354.6920000007958,
          "onLoad": 428.44899999909103
        }
      }
    ],
    "entries": [
      {
        "startedDateTime": "2018-08-01T00:25:08.841Z",
        "time": 12.934424998493341,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            },
            {
              "name": "Upgrade-Insecure-Requests",
              "value": "1"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 488,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "Last-Modified",
              "value": "Wed, 01 Aug 2018 00:24:11 GMT"
            },
            {
              "name": "Content-Type",
              "value": "text/html; charset=utf-8"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Encoding",
              "value": "gzip"
            },
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Transfer-Encoding",
              "value": "chunked"
            }
          ],
          "cookies": [],
          "content": {
            "size": 1053,
            "mimeType": "text/html",
            "compression": 517,
            "text": "<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <title>ProxyApp</title>\n    <meta name=\"description\" content=\"\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\n    \n<meta name=\"proxy-app/config/environment\" content=\"%7B%22modulePrefix%22%3A%22proxy-app%22%2C%22environment%22%3A%22development%22%2C%22rootURL%22%3A%22/%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%7D%2C%22APP%22%3A%7B%22name%22%3A%22proxy-app%22%2C%22version%22%3A%220.0.0+881d7dc7%22%7D%2C%22exportApplicationGlobal%22%3Atrue%7D\" />\n<script src=\"/ember-cli-live-reload.js\" type=\"text/javascript\"></script>\n\n    <link integrity=\"\" rel=\"stylesheet\" href=\"/assets/vendor.css\">\n    <link integrity=\"\" rel=\"stylesheet\" href=\"/assets/proxy-app.css\">\n\n    \n  </head>\n  <body>\n    \n\n    <script src=\"/assets/vendor.js\"></script>\n    <script src=\"/assets/proxy-app.js\"></script>\n\n    \n  </body>\n</html>\n"
          },
          "redirectURL": "",
          "headersSize": 316,
          "bodySize": 536,
          "_transferSize": 852
        },
        "cache": {},
        "timings": {
          "blocked": 1.0574249999983585,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.07400000000000007,
          "wait": 1.6000000004945323,
          "receive": 10.20299999800045,
          "_blocked_queueing": 0.42499999835854396
        },
        "serverIPAddress": "[::1]",
        "connection": "142393",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.861Z",
        "time": 10.611382001519814,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/ember-cli-live-reload.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 433,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "ETag",
              "value": "W/\"14e-6h4pfK8RHjxk/ZroCleHncFuVu8\""
            },
            {
              "name": "Content-Length",
              "value": "334"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Type",
              "value": "text/javascript; charset=utf-8"
            }
          ],
          "cookies": [],
          "content": {
            "size": 334,
            "mimeType": "text/javascript",
            "compression": 0,
            "text": "(function() {\n var srcUrl = null;\n var src = srcUrl || ((location.protocol || 'http:') + '//' + (location.hostname || 'localhost') + ':7021/livereload.js');\n var script    = document.createElement('script');\n script.type   = 'text/javascript';\n script.src    = src;\n document.getElementsByTagName('head')[0].appendChild(script);\n}());"
          },
          "redirectURL": "",
          "headersSize": 236,
          "bodySize": 334,
          "_transferSize": 570
        },
        "cache": {},
        "timings": {
          "blocked": 7.429382000001992,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.04499999999999993,
          "wait": 2.078999999868916,
          "receive": 1.0580000016489066,
          "_blocked_queueing": 0.3820000019914005
        },
        "serverIPAddress": "[::1]",
        "connection": "142393",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.861Z",
        "time": 25.23660100131383,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/assets/vendor.css",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/css,*/*;q=0.1"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 441,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Content-Encoding",
              "value": "gzip"
            },
            {
              "name": "Last-Modified",
              "value": "Wed, 01 Aug 2018 00:24:12 GMT"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Type",
              "value": "text/css; charset=utf-8"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "Transfer-Encoding",
              "value": "chunked"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            }
          ],
          "cookies": [],
          "content": {
            "size": 2200,
            "mimeType": "text/css",
            "compression": 1511,
            "text": "#ember-welcome-page-id-selector {\n  padding: 2em;\n  box-shadow: 0 0 0px 10px #FFFBF5;\n  font-family: \"Helvetica Neue\", \"Helvetica\", \"Roboto\", \"Arial\", sans-serif;\n  font-size: 16px;\n  line-height: 1.35em;\n  background: #FFFBF5;\n  color: #865931;\n  height: 100vh;\n}\n#ember-welcome-page-id-selector img {\n  max-width: 100%;\n}\n#ember-welcome-page-id-selector p {\n  margin: 0 0 .75em;\n}\n#ember-welcome-page-id-selector h2 {\n  color: #dd6a58;\n  margin-top: 1em;\n  font-size: 1.75em;\n  line-height: 1.2\n}\n#ember-welcome-page-id-selector a:link,\n#ember-welcome-page-id-selector a:visited {\n  color: #dd6a58;\n  text-decoration: none;\n}\n#ember-welcome-page-id-selector a:hover,\n#ember-welcome-page-id-selector a:active {\n  color: #c13c27;\n}\n#ember-welcome-page-id-selector .tomster {\n  flex: 2;\n}\n#ember-welcome-page-id-selector .welcome {\n  flex: 3;\n}\n#ember-welcome-page-id-selector .columns {\n  display: flex;\n  max-width: 960px;\n  margin: 0 auto;\n}\n#ember-welcome-page-id-selector .welcome ol {\n  list-style: disc;\n  padding-left: 2em;\n  margin-bottom: .75em;\n}\n#ember-welcome-page-id-selector .welcome > ol > li {\n  padding-bottom: .5em;\n}\n#ember-welcome-page-id-selector .postscript {\n  clear: both;\n  text-align: center;\n  padding-top: 3em;\n  font-size: 14px;\n  color: #888;\n  font-style: italic;\n  line-height: 2;\n}\n#ember-welcome-page-id-selector .postscript code {\n  background-color: #F8E7CF;\n  border-radius: 3px;\n  font-family: Menlo, Courier, monospace;\n  font-size: 0.9em;\n  padding: 0.2em 0.5em;\n  margin: 0 0.1em;\n}\n@media (max-width: 700px) {\n  #ember-welcome-page-id-selector {\n    padding: 1em;\n  }\n  #ember-welcome-page-id-selector .columns {\n    flex-direction: column;\n  }\n  #ember-welcome-page-id-selector .welcome,\n  #ember-welcome-page-id-selector .tomster {\n  }\n  #ember-welcome-page-id-selector .tomster img {\n    width: 50%;\n    margin: auto;\n    display: block;\n  }\n  #ember-welcome-page-id-selector h2 {\n    text-align: center;\n  }\n}\n@media (max-width: 400px) {\n  #ember-welcome-page-id-selector .tomster img {\n    width: 60%;\n  }\n  #ember-welcome-page-id-selector .welcome,\n  #ember-welcome-page-id-selector .tomster {\n    width: 100%;\n    float: none;\n    margin: auto;\n  }\n}\n"
          },
          "redirectURL": "",
          "headersSize": 315,
          "bodySize": 689,
          "_transferSize": 1004
        },
        "cache": {},
        "timings": {
          "blocked": 7.2116009999997335,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.04499999999999993,
          "wait": 11.113000001257518,
          "receive": 6.867000000056578,
          "_blocked_queueing": 0.6009999997331761
        },
        "serverIPAddress": "[::1]",
        "connection": "142427",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.861Z",
        "time": 11.866832997096935,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/assets/proxy-app.css",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/css,*/*;q=0.1"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 444,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Last-Modified",
              "value": "Tue, 31 Jul 2018 22:26:14 GMT"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Type",
              "value": "text/css; charset=utf-8"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Content-Length",
              "value": "0"
            }
          ],
          "cookies": [],
          "content": {
            "size": 0,
            "mimeType": "text/css",
            "compression": 0,
            "text": ""
          },
          "redirectURL": "",
          "headersSize": 282,
          "bodySize": 0,
          "_transferSize": 282
        },
        "cache": {},
        "timings": {
          "blocked": 7.515832999998238,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.04400000000000048,
          "wait": 2.751000001481967,
          "receive": 1.5559999956167303,
          "_blocked_queueing": 0.8329999982379377
        },
        "serverIPAddress": "[::1]",
        "connection": "142419",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.861Z",
        "time": 206.4850020020931,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/assets/vendor.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 425,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Content-Encoding",
              "value": "gzip"
            },
            {
              "name": "Last-Modified",
              "value": "Wed, 01 Aug 2018 00:24:12 GMT"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Type",
              "value": "application/javascript; charset=utf-8"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "Transfer-Encoding",
              "value": "chunked"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            }
          ],
          "cookies": [],
          "content": {
            "size": 2783982,
            "mimeType": "application/javascript",
            "compression": 2183419,
            "text": "d2luZG93LkVtYmVyRU5WID0geyJGRUFUVVJFUyI6e30sIkVYVEVORF9QUk9UT1RZUEVTIjp7IkRhdGUiOmZhbHNlfX07CnZhciBydW5uaW5nVGVzdHMgPSBmYWxzZTsKCgoKO3ZhciBsb2FkZXIsIGRlZmluZSwgcmVxdWlyZU1vZHVsZSwgcmVxdWlyZSwgcmVxdWlyZWpzOwoKKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIGRpY3QoKSB7CiAgICB2YXIgb2JqID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIG9ialsnX18nXSA9IHVuZGVmaW5lZDsKICAgIGRlbGV0ZSBvYmpbJ19fJ107CiAgICByZXR1cm4gb2JqOwogIH0KCiAgLy8gU2F2ZSBvZmYgdGhlIG9yaWdpbmFsIHZhbHVlcyBvZiB0aGVzZSBnbG9iYWxzLCBzbyB3ZSBjYW4gcmVzdG9yZSB0aGVtIGlmIHNvbWVvbmUgYXNrcyB1cyB0bwogIHZhciBvbGRHbG9iYWxzID0gewogICAgbG9hZGVyOiBsb2FkZXIsCiAgICBkZWZpbmU6IGRlZmluZSwKICAgIHJlcXVpcmVNb2R1bGU6IHJlcXVpcmVNb2R1bGUsCiAgICByZXF1aXJlOiByZXF1aXJlLAogICAgcmVxdWlyZWpzOiByZXF1aXJlanMKICB9OwoKICByZXF1aXJlanMgPSByZXF1aXJlID0gcmVxdWlyZU1vZHVsZSA9IGZ1bmN0aW9uIChpZCkgewogICAgdmFyIHBlbmRpbmcgPSBbXTsKICAgIHZhciBtb2QgPSBmaW5kTW9kdWxlKGlkLCAnKHJlcXVpcmUpJywgcGVuZGluZyk7CgogICAgZm9yICh2YXIgaSA9IHBlbmRpbmcubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgcGVuZGluZ1tpXS5leHBvcnRzKCk7CiAgICB9CgogICAgcmV0dXJuIG1vZC5tb2R1bGUuZXhwb3J0czsKICB9OwoKICBsb2FkZXIgPSB7CiAgICBub0NvbmZsaWN0OiBmdW5jdGlvbiAoYWxpYXNlcykgewogICAgICB2YXIgb2xkTmFtZSwgbmV3TmFtZTsKCiAgICAgIGZvciAob2xkTmFtZSBpbiBhbGlhc2VzKSB7CiAgICAgICAgaWYgKGFsaWFzZXMuaGFzT3duUHJvcGVydHkob2xkTmFtZSkpIHsKICAgICAgICAgIGlmIChvbGRHbG9iYWxzLmhhc093blByb3BlcnR5KG9sZE5hbWUpKSB7CiAgICAgICAgICAgIG5ld05hbWUgPSBhbGlhc2VzW29sZE5hbWVdOwoKICAgICAgICAgICAgZ2xvYmFsW25ld05hbWVdID0gZ2xvYmFsW29sZE5hbWVdOwogICAgICAgICAgICBnbG9iYWxbb2xkTmFtZV0gPSBvbGRHbG9iYWxzW29sZE5hbWVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIE9wdGlvbiB0byBlbmFibGUgb3IgZGlzYWJsZSB0aGUgZ2VuZXJhdGlvbiBvZiBkZWZhdWx0IGV4cG9ydHMKICAgIG1ha2VEZWZhdWx0RXhwb3J0OiB0cnVlCiAgfTsKCiAgdmFyIHJlZ2lzdHJ5ID0gZGljdCgpOwogIHZhciBzZWVuID0gZGljdCgpOwoKICB2YXIgdXVpZCA9IDA7CgogIGZ1bmN0aW9uIHVuc3VwcG9ydGVkTW9kdWxlKGxlbmd0aCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdhbiB1bnN1cHBvcnRlZCBtb2R1bGUgd2FzIGRlZmluZWQsIGV4cGVjdGVkIGBkZWZpbmUoaWQsIGRlcHMsIG1vZHVsZSlgIGluc3RlYWQgZ290OiBgJyArIGxlbmd0aCArICdgIGFyZ3VtZW50cyB0byBkZWZpbmVgJyk7CiAgfQoKICB2YXIgZGVmYXVsdERlcHMgPSBbJ3JlcXVpcmUnLCAnZXhwb3J0cycsICdtb2R1bGUnXTsKCiAgZnVuY3Rpb24gTW9kdWxlKGlkLCBkZXBzLCBjYWxsYmFjaywgYWxpYXMpIHsKICAgIHRoaXMudXVpZCA9IHV1aWQrKzsKICAgIHRoaXMuaWQgPSBpZDsKICAgIHRoaXMuZGVwcyA9ICFkZXBzLmxlbmd0aCAmJiBjYWxsYmFjay5sZW5ndGggPyBkZWZhdWx0RGVwcyA6IGRlcHM7CiAgICB0aGlzLm1vZHVsZSA9IHsgZXhwb3J0czoge30gfTsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMuaGFzRXhwb3J0c0FzRGVwID0gZmFsc2U7CiAgICB0aGlzLmlzQWxpYXMgPSBhbGlhczsKICAgIHRoaXMucmVpZmllZCA9IG5ldyBBcnJheShkZXBzLmxlbmd0aCk7CgogICAgLyoKICAgICAgIEVhY2ggbW9kdWxlIG5vcm1hbGx5IHBhc3NlcyB0aHJvdWdoIHRoZXNlIHN0YXRlcywgaW4gb3JkZXI6CiAgICAgICAgIG5ldyAgICAgICA6IGluaXRpYWwgc3RhdGUKICAgICAgICAgcGVuZGluZyAgIDogdGhpcyBtb2R1bGUgaXMgc2NoZWR1bGVkIHRvIGJlIGV4ZWN1dGVkCiAgICAgICAgIHJlaWZ5aW5nICA6IHRoaXMgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIGFyZSBiZWluZyBleGVjdXRlZAogICAgICAgICByZWlmaWVkICAgOiB0aGlzIG1vZHVsZSdzIGRlcGVuZGVuY2llcyBmaW5pc2hlZCBleGVjdXRpbmcgc3VjY2Vzc2Z1bGx5CiAgICAgICAgIGVycm9yZWQgICA6IHRoaXMgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIGZhaWxlZCB0byBleGVjdXRlCiAgICAgICAgIGZpbmFsaXplZCA6IHRoaXMgbW9kdWxlIGV4ZWN1dGVkIHN1Y2Nlc3NmdWxseQogICAgICovCiAgICB0aGlzLnN0YXRlID0gJ25ldyc7CiAgfQoKICBNb2R1bGUucHJvdG90eXBlLm1ha2VEZWZhdWx0RXhwb3J0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGV4cG9ydHMgPSB0aGlzLm1vZHVsZS5leHBvcnRzOwogICAgaWYgKGV4cG9ydHMgIT09IG51bGwgJiYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgZXhwb3J0cyA9PT0gJ2Z1bmN0aW9uJykgJiYgZXhwb3J0c1snZGVmYXVsdCddID09PSB1bmRlZmluZWQgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZShleHBvcnRzKSkgewogICAgICBleHBvcnRzWydkZWZhdWx0J10gPSBleHBvcnRzOwogICAgfQogIH07CgogIE1vZHVsZS5wcm90b3R5cGUuZXhwb3J0cyA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIGlmIGZpbmFsaXplZCwgdGhlcmUgaXMgbm8gd29yayB0byBkby4gSWYgcmVpZnlpbmcsIHRoZXJlIGlzIGEKICAgIC8vIGNpcmN1bGFyIGRlcGVuZGVuY3kgc28gd2UgbXVzdCByZXR1cm4gb3VyIChwYXJ0aWFsKSBleHBvcnRzLgogICAgaWYgKHRoaXMuc3RhdGUgPT09ICdmaW5hbGl6ZWQnIHx8IHRoaXMuc3RhdGUgPT09ICdyZWlmeWluZycpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kdWxlLmV4cG9ydHM7CiAgICB9CgoKICAgIGlmIChsb2FkZXIud3JhcE1vZHVsZXMpIHsKICAgICAgdGhpcy5jYWxsYmFjayA9IGxvYWRlci53cmFwTW9kdWxlcyh0aGlzLmlkLCB0aGlzLmNhbGxiYWNrKTsKICAgIH0KCiAgICB0aGlzLnJlaWZ5KCk7CgogICAgdmFyIHJlc3VsdCA9IHRoaXMuY2FsbGJhY2suYXBwbHkodGhpcywgdGhpcy5yZWlmaWVkKTsKICAgIHRoaXMucmVpZmllZC5sZW5ndGggPSAwOwogICAgdGhpcy5zdGF0ZSA9ICdmaW5hbGl6ZWQnOwoKICAgIGlmICghKHRoaXMuaGFzRXhwb3J0c0FzRGVwICYmIHJlc3VsdCA9PT0gdW5kZWZpbmVkKSkgewogICAgICB0aGlzLm1vZHVsZS5leHBvcnRzID0gcmVzdWx0OwogICAgfQogICAgaWYgKGxvYWRlci5tYWtlRGVmYXVsdEV4cG9ydCkgewogICAgICB0aGlzLm1ha2VEZWZhdWx0RXhwb3J0KCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5tb2R1bGUuZXhwb3J0czsKICB9OwoKICBNb2R1bGUucHJvdG90eXBlLnVuc2VlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdGF0ZSA9ICduZXcnOwogICAgdGhpcy5tb2R1bGUgPSB7IGV4cG9ydHM6IHt9IH07CiAgfTsKCiAgTW9kdWxlLnByb3RvdHlwZS5yZWlmeSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnN0YXRlID09PSAncmVpZmllZCcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5zdGF0ZSA9ICdyZWlmeWluZyc7CiAgICB0cnkgewogICAgICB0aGlzLnJlaWZpZWQgPSB0aGlzLl9yZWlmeSgpOwogICAgICB0aGlzLnN0YXRlID0gJ3JlaWZpZWQnOwogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdyZWlmeWluZycpIHsKICAgICAgICB0aGlzLnN0YXRlID0gJ2Vycm9yZWQnOwogICAgICB9CiAgICB9CiAgfTsKCiAgTW9kdWxlLnByb3RvdHlwZS5fcmVpZnkgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVpZmllZCA9IHRoaXMucmVpZmllZC5zbGljZSgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWlmaWVkLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBtb2QgPSByZWlmaWVkW2ldOwogICAgICByZWlmaWVkW2ldID0gbW9kLmV4cG9ydHMgPyBtb2QuZXhwb3J0cyA6IG1vZC5tb2R1bGUuZXhwb3J0cygpOwogICAgfQogICAgcmV0dXJuIHJlaWZpZWQ7CiAgfTsKCiAgTW9kdWxlLnByb3RvdHlwZS5maW5kRGVwcyA9IGZ1bmN0aW9uIChwZW5kaW5nKSB7CiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gJ25ldycpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuc3RhdGUgPSAncGVuZGluZyc7CgogICAgdmFyIGRlcHMgPSB0aGlzLmRlcHM7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXBzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBkZXAgPSBkZXBzW2ldOwogICAgICB2YXIgZW50cnkgPSB0aGlzLnJlaWZpZWRbaV0gPSB7IGV4cG9ydHM6IHVuZGVmaW5lZCwgbW9kdWxlOiB1bmRlZmluZWQgfTsKICAgICAgaWYgKGRlcCA9PT0gJ2V4cG9ydHMnKSB7CiAgICAgICAgdGhpcy5oYXNFeHBvcnRzQXNEZXAgPSB0cnVlOwogICAgICAgIGVudHJ5LmV4cG9ydHMgPSB0aGlzLm1vZHVsZS5leHBvcnRzOwogICAgICB9IGVsc2UgaWYgKGRlcCA9PT0gJ3JlcXVpcmUnKSB7CiAgICAgICAgZW50cnkuZXhwb3J0cyA9IHRoaXMubWFrZVJlcXVpcmUoKTsKICAgICAgfSBlbHNlIGlmIChkZXAgPT09ICdtb2R1bGUnKSB7CiAgICAgICAgZW50cnkuZXhwb3J0cyA9IHRoaXMubW9kdWxlOwogICAgICB9IGVsc2UgewogICAgICAgIGVudHJ5Lm1vZHVsZSA9IGZpbmRNb2R1bGUocmVzb2x2ZShkZXAsIHRoaXMuaWQpLCB0aGlzLmlkLCBwZW5kaW5nKTsKICAgICAgfQogICAgfQogIH07CgogIE1vZHVsZS5wcm90b3R5cGUubWFrZVJlcXVpcmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaWQgPSB0aGlzLmlkOwogICAgdmFyIHIgPSBmdW5jdGlvbiAoZGVwKSB7CiAgICAgIHJldHVybiByZXF1aXJlKHJlc29sdmUoZGVwLCBpZCkpOwogICAgfTsKICAgIHJbJ2RlZmF1bHQnXSA9IHI7CiAgICByLm1vZHVsZUlkID0gaWQ7CiAgICByLmhhcyA9IGZ1bmN0aW9uIChkZXApIHsKICAgICAgcmV0dXJuIGhhcyhyZXNvbHZlKGRlcCwgaWQpKTsKICAgIH07CiAgICByZXR1cm4gcjsKICB9OwoKICBkZWZpbmUgPSBmdW5jdGlvbiAoaWQsIGRlcHMsIGNhbGxiYWNrKSB7CiAgICB2YXIgbW9kdWxlID0gcmVnaXN0cnlbaWRdOwoKICAgIC8vIElmIGEgbW9kdWxlIGZvciB0aGlzIGlkIGhhcyBhbHJlYWR5IGJlZW4gZGVmaW5lZCBhbmQgaXMgaW4gYW55IHN0YXRlCiAgICAvLyBvdGhlciB0aGFuIGBuZXdgIChtZWFuaW5nIGl0IGhhcyBiZWVuIG9yIGlzIGN1cnJlbnRseSBiZWluZyByZXF1aXJlZCksCiAgICAvLyB0aGVuIHdlIHJldHVybiBlYXJseSB0byBhdm9pZCByZWRlZmluaXRpb24uCiAgICBpZiAobW9kdWxlICYmIG1vZHVsZS5zdGF0ZSAhPT0gJ25ldycpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICB1bnN1cHBvcnRlZE1vZHVsZShhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0KCiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGVwcykpIHsKICAgICAgY2FsbGJhY2sgPSBkZXBzOwogICAgICBkZXBzID0gW107CiAgICB9CgogICAgaWYgKGNhbGxiYWNrIGluc3RhbmNlb2YgQWxpYXMpIHsKICAgICAgcmVnaXN0cnlbaWRdID0gbmV3IE1vZHVsZShjYWxsYmFjay5pZCwgZGVwcywgY2FsbGJhY2ssIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgcmVnaXN0cnlbaWRdID0gbmV3IE1vZHVsZShpZCwgZGVwcywgY2FsbGJhY2ssIGZhbHNlKTsKICAgIH0KICB9OwoKICBkZWZpbmUuZXhwb3J0cyA9IGZ1bmN0aW9uIChuYW1lLCBkZWZhdWx0RXhwb3J0KSB7CiAgICB2YXIgbW9kdWxlID0gcmVnaXN0cnlbbmFtZV07CgogICAgLy8gSWYgYSBtb2R1bGUgZm9yIHRoaXMgbmFtZSBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYW5kIGlzIGluIGFueSBzdGF0ZQogICAgLy8gb3RoZXIgdGhhbiBgbmV3YCAobWVhbmluZyBpdCBoYXMgYmVlbiBvciBpcyBjdXJyZW50bHkgYmVpbmcgcmVxdWlyZWQpLAogICAgLy8gdGhlbiB3ZSByZXR1cm4gZWFybHkgdG8gYXZvaWQgcmVkZWZpbml0aW9uLgogICAgaWYgKG1vZHVsZSAmJiBtb2R1bGUuc3RhdGUgIT09ICduZXcnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBtb2R1bGUgPSBuZXcgTW9kdWxlKG5hbWUsIFtdLCBub29wLCBudWxsKTsKICAgIG1vZHVsZS5tb2R1bGUuZXhwb3J0cyA9IGRlZmF1bHRFeHBvcnQ7CiAgICBtb2R1bGUuc3RhdGUgPSAnZmluYWxpemVkJzsKICAgIHJlZ2lzdHJ5W25hbWVdID0gbW9kdWxlOwoKICAgIHJldHVybiBtb2R1bGU7CiAgfTsKCiAgZnVuY3Rpb24gbm9vcCgpIHt9CiAgLy8gd2UgZG9uJ3Qgc3VwcG9ydCBhbGwgb2YgQU1ECiAgLy8gZGVmaW5lLmFtZCA9IHt9OwoKICBmdW5jdGlvbiBBbGlhcyhpZCkgewogICAgdGhpcy5pZCA9IGlkOwogIH0KCiAgZGVmaW5lLmFsaWFzID0gZnVuY3Rpb24gKGlkLCB0YXJnZXQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIHJldHVybiBkZWZpbmUodGFyZ2V0LCBuZXcgQWxpYXMoaWQpKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEFsaWFzKGlkKTsKICB9OwoKICBmdW5jdGlvbiBtaXNzaW5nTW9kdWxlKGlkLCByZWZlcnJlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBtb2R1bGUgYCcgKyBpZCArICdgIGltcG9ydGVkIGZyb20gYCcgKyByZWZlcnJlciArICdgJyk7CiAgfQoKICBmdW5jdGlvbiBmaW5kTW9kdWxlKGlkLCByZWZlcnJlciwgcGVuZGluZykgewogICAgdmFyIG1vZCA9IHJlZ2lzdHJ5W2lkXSB8fCByZWdpc3RyeVtpZCArICcvaW5kZXgnXTsKCiAgICB3aGlsZSAobW9kICYmIG1vZC5pc0FsaWFzKSB7CiAgICAgIG1vZCA9IHJlZ2lzdHJ5W21vZC5pZF0gfHwgcmVnaXN0cnlbbW9kLmlkICsgJy9pbmRleCddOwogICAgfQoKICAgIGlmICghbW9kKSB7CiAgICAgIG1pc3NpbmdNb2R1bGUoaWQsIHJlZmVycmVyKTsKICAgIH0KCiAgICBpZiAocGVuZGluZyAmJiBtb2Quc3RhdGUgIT09ICdwZW5kaW5nJyAmJiBtb2Quc3RhdGUgIT09ICdmaW5hbGl6ZWQnKSB7CiAgICAgIG1vZC5maW5kRGVwcyhwZW5kaW5nKTsKICAgICAgcGVuZGluZy5wdXNoKG1vZCk7CiAgICB9CiAgICByZXR1cm4gbW9kOwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZShjaGlsZCwgaWQpIHsKICAgIGlmIChjaGlsZC5jaGFyQXQoMCkgIT09ICcuJykgewogICAgICByZXR1cm4gY2hpbGQ7CiAgICB9CgoKICAgIHZhciBwYXJ0cyA9IGNoaWxkLnNwbGl0KCcvJyk7CiAgICB2YXIgbmFtZVBhcnRzID0gaWQuc3BsaXQoJy8nKTsKICAgIHZhciBwYXJlbnRCYXNlID0gbmFtZVBhcnRzLnNsaWNlKDAsIC0xKTsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBhcnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgcGFydCA9IHBhcnRzW2ldOwoKICAgICAgaWYgKHBhcnQgPT09ICcuLicpIHsKICAgICAgICBpZiAocGFyZW50QmFzZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGFjY2VzcyBwYXJlbnQgbW9kdWxlIG9mIHJvb3QnKTsKICAgICAgICB9CiAgICAgICAgcGFyZW50QmFzZS5wb3AoKTsKICAgICAgfSBlbHNlIGlmIChwYXJ0ID09PSAnLicpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJlbnRCYXNlLnB1c2gocGFydCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcGFyZW50QmFzZS5qb2luKCcvJyk7CiAgfQoKICBmdW5jdGlvbiBoYXMoaWQpIHsKICAgIHJldHVybiAhIShyZWdpc3RyeVtpZF0gfHwgcmVnaXN0cnlbaWQgKyAnL2luZGV4J10pOwogIH0KCiAgcmVxdWlyZWpzLmVudHJpZXMgPSByZXF1aXJlanMuX2Vha19zZWVuID0gcmVnaXN0cnk7CiAgcmVxdWlyZWpzLmhhcyA9IGhhczsKICByZXF1aXJlanMudW5zZWUgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGZpbmRNb2R1bGUoaWQsICcodW5zZWUpJywgZmFsc2UpLnVuc2VlKCk7CiAgfTsKCiAgcmVxdWlyZWpzLmNsZWFyID0gZnVuY3Rpb24gKCkgewogICAgcmVxdWlyZWpzLmVudHJpZXMgPSByZXF1aXJlanMuX2Vha19zZWVuID0gcmVnaXN0cnkgPSBkaWN0KCk7CiAgICBzZWVuID0gZGljdCgpOwogIH07CgogIC8vIFRoaXMgY29kZSBwcmltZXMgdGhlIEpTIGVuZ2luZSBmb3IgZ29vZCBwZXJmb3JtYW5jZSBieSB3YXJtaW5nIHRoZQogIC8vIEpJVCBjb21waWxlciBmb3IgdGhlc2UgZnVuY3Rpb25zLgogIGRlZmluZSgnZm9vJywgZnVuY3Rpb24gKCkge30pOwogIGRlZmluZSgnZm9vL2JhcicsIFtdLCBmdW5jdGlvbiAoKSB7fSk7CiAgZGVmaW5lKCdmb28vYXNkZicsIFsnbW9kdWxlJywgJ2V4cG9ydHMnLCAncmVxdWlyZSddLCBmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzLCByZXF1aXJlKSB7CiAgICBpZiAocmVxdWlyZS5oYXMoJ2Zvby9iYXInKSkgewogICAgICByZXF1aXJlKCdmb28vYmFyJyk7CiAgICB9CiAgfSk7CiAgZGVmaW5lKCdmb28vYmF6JywgW10sIGRlZmluZS5hbGlhcygnZm9vJykpOwogIGRlZmluZSgnZm9vL3F1eicsIGRlZmluZS5hbGlhcygnZm9vJykpOwogIGRlZmluZS5hbGlhcygnZm9vJywgJ2Zvby9xdXgnKTsKICBkZWZpbmUoJ2Zvby9iYXInLCBbJ2ZvbycsICcuL3F1eicsICcuL2JheicsICcuL2FzZGYnLCAnLi9iYXInLCAnLi4vZm9vJ10sIGZ1bmN0aW9uICgpIHt9KTsKICBkZWZpbmUoJ2Zvby9tYWluJywgWydmb28vYmFyJ10sIGZ1bmN0aW9uICgpIHt9KTsKICBkZWZpbmUuZXhwb3J0cygnZm9vL2V4cG9ydHMnLCB7fSk7CgogIHJlcXVpcmUoJ2Zvby9leHBvcnRzJyk7CiAgcmVxdWlyZSgnZm9vL21haW4nKTsKICByZXF1aXJlLnVuc2VlKCdmb28vYmFyJyk7CgogIHJlcXVpcmVqcy5jbGVhcigpOwoKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgPT09ICdvYmplY3QnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsgcmVxdWlyZTogcmVxdWlyZSwgZGVmaW5lOiBkZWZpbmUgfTsKICB9Cn0pKHRoaXMpOwo7LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjMuMy4xCiAqIGh0dHBzOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHBzOi8vc2l6emxlanMuY29tLwogKgogKiBDb3B5cmlnaHQgSlMgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogKiBodHRwczovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDE4LTAxLTIwVDE3OjI0WgogKi8KKCBmdW5jdGlvbiggZ2xvYmFsLCBmYWN0b3J5ICkgewoKCSJ1c2Ugc3RyaWN0IjsKCglpZiAoIHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIHR5cGVvZiBtb2R1bGUuZXhwb3J0cyA9PT0gIm9iamVjdCIgKSB7CgoJCS8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgYHdpbmRvd2AKCQkvLyBpcyBwcmVzZW50LCBleGVjdXRlIHRoZSBmYWN0b3J5IGFuZCBnZXQgalF1ZXJ5LgoJCS8vIEZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3QgaGF2ZSBhIGB3aW5kb3dgIHdpdGggYSBgZG9jdW1lbnRgCgkJLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGZhY3RvcnkgYXMgbW9kdWxlLmV4cG9ydHMuCgkJLy8gVGhpcyBhY2NlbnR1YXRlcyB0aGUgbmVlZCBmb3IgdGhlIGNyZWF0aW9uIG9mIGEgcmVhbCBgd2luZG93YC4KCQkvLyBlLmcuIHZhciBqUXVlcnkgPSByZXF1aXJlKCJqcXVlcnkiKSh3aW5kb3cpOwoJCS8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8uCgkJbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWwuZG9jdW1lbnQgPwoJCQlmYWN0b3J5KCBnbG9iYWwsIHRydWUgKSA6CgkJCWZ1bmN0aW9uKCB3ICkgewoJCQkJaWYgKCAhdy5kb2N1bWVudCApIHsKCQkJCQl0aHJvdyBuZXcgRXJyb3IoICJqUXVlcnkgcmVxdWlyZXMgYSB3aW5kb3cgd2l0aCBhIGRvY3VtZW50IiApOwoJCQkJfQoJCQkJcmV0dXJuIGZhY3RvcnkoIHcgKTsKCQkJfTsKCX0gZWxzZSB7CgkJZmFjdG9yeSggZ2xvYmFsICk7Cgl9CgovLyBQYXNzIHRoaXMgaWYgd2luZG93IGlzIG5vdCBkZWZpbmVkIHlldAp9ICkoIHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDogdGhpcywgZnVuY3Rpb24oIHdpbmRvdywgbm9HbG9iYWwgKSB7CgovLyBFZGdlIDw9IDEyIC0gMTMrLCBGaXJlZm94IDw9MTggLSA0NSssIElFIDEwIC0gMTEsIFNhZmFyaSA1LjEgLSA5KywgaU9TIDYgLSA5LjEKLy8gdGhyb3cgZXhjZXB0aW9ucyB3aGVuIG5vbi1zdHJpY3QgY29kZSAoZS5nLiwgQVNQLk5FVCA0LjUpIGFjY2Vzc2VzIHN0cmljdCBtb2RlCi8vIGFyZ3VtZW50cy5jYWxsZWUuY2FsbGVyICh0cmFjLTEzMzM1KS4gQnV0IGFzIG9mIGpRdWVyeSAzLjAgKDIwMTYpLCBzdHJpY3QgbW9kZSBzaG91bGQgYmUgY29tbW9uCi8vIGVub3VnaCB0aGF0IGFsbCBzdWNoIGF0dGVtcHRzIGFyZSBndWFyZGVkIGluIGEgdHJ5IGJsb2NrLgoidXNlIHN0cmljdCI7Cgp2YXIgYXJyID0gW107Cgp2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7Cgp2YXIgZ2V0UHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7Cgp2YXIgc2xpY2UgPSBhcnIuc2xpY2U7Cgp2YXIgY29uY2F0ID0gYXJyLmNvbmNhdDsKCnZhciBwdXNoID0gYXJyLnB1c2g7Cgp2YXIgaW5kZXhPZiA9IGFyci5pbmRleE9mOwoKdmFyIGNsYXNzMnR5cGUgPSB7fTsKCnZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7Cgp2YXIgaGFzT3duID0gY2xhc3MydHlwZS5oYXNPd25Qcm9wZXJ0eTsKCnZhciBmblRvU3RyaW5nID0gaGFzT3duLnRvU3RyaW5nOwoKdmFyIE9iamVjdEZ1bmN0aW9uU3RyaW5nID0gZm5Ub1N0cmluZy5jYWxsKCBPYmplY3QgKTsKCnZhciBzdXBwb3J0ID0ge307Cgp2YXIgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIGlzRnVuY3Rpb24oIG9iaiApIHsKCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTU3LCBGaXJlZm94IDw9NTIKICAgICAgLy8gSW4gc29tZSBicm93c2VycywgdHlwZW9mIHJldHVybnMgImZ1bmN0aW9uIiBmb3IgSFRNTCA8b2JqZWN0PiBlbGVtZW50cwogICAgICAvLyAoaS5lLiwgYHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAib2JqZWN0IiApID09PSAiZnVuY3Rpb24iYCkuCiAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gY2xhc3NpZnkgKmFueSogRE9NIG5vZGUgYXMgYSBmdW5jdGlvbi4KICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG9iai5ub2RlVHlwZSAhPT0gIm51bWJlciI7CiAgfTsKCgp2YXIgaXNXaW5kb3cgPSBmdW5jdGlvbiBpc1dpbmRvdyggb2JqICkgewoJCXJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7Cgl9OwoKCgoKCXZhciBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzID0gewoJCXR5cGU6IHRydWUsCgkJc3JjOiB0cnVlLAoJCW5vTW9kdWxlOiB0cnVlCgl9OwoKCWZ1bmN0aW9uIERPTUV2YWwoIGNvZGUsIGRvYywgbm9kZSApIHsKCQlkb2MgPSBkb2MgfHwgZG9jdW1lbnQ7CgoJCXZhciBpLAoJCQlzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCggInNjcmlwdCIgKTsKCgkJc2NyaXB0LnRleHQgPSBjb2RlOwoJCWlmICggbm9kZSApIHsKCQkJZm9yICggaSBpbiBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzICkgewoJCQkJaWYgKCBub2RlWyBpIF0gKSB7CgkJCQkJc2NyaXB0WyBpIF0gPSBub2RlWyBpIF07CgkJCQl9CgkJCX0KCQl9CgkJZG9jLmhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdCApLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHNjcmlwdCApOwoJfQoKCmZ1bmN0aW9uIHRvVHlwZSggb2JqICkgewoJaWYgKCBvYmogPT0gbnVsbCApIHsKCQlyZXR1cm4gb2JqICsgIiI7Cgl9CgoJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTIuMyBvbmx5IChmdW5jdGlvbmlzaCBSZWdFeHApCglyZXR1cm4gdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIiA/CgkJY2xhc3MydHlwZVsgdG9TdHJpbmcuY2FsbCggb2JqICkgXSB8fCAib2JqZWN0IiA6CgkJdHlwZW9mIG9iajsKfQovKiBnbG9iYWwgU3ltYm9sICovCi8vIERlZmluaW5nIHRoaXMgZ2xvYmFsIGluIC5lc2xpbnRyYy5qc29uIHdvdWxkIGNyZWF0ZSBhIGRhbmdlciBvZiB1c2luZyB0aGUgZ2xvYmFsCi8vIHVuZ3VhcmRlZCBpbiBhbm90aGVyIHBsYWNlLCBpdCBzZWVtcyBzYWZlciB0byBkZWZpbmUgZ2xvYmFsIG9ubHkgZm9yIHRoaXMgbW9kdWxlCgoKCnZhcgoJdmVyc2lvbiA9ICIzLjMuMSIsCgoJLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKCWpRdWVyeSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCApIHsKCgkJLy8gVGhlIGpRdWVyeSBvYmplY3QgaXMgYWN0dWFsbHkganVzdCB0aGUgaW5pdCBjb25zdHJ1Y3RvciAnZW5oYW5jZWQnCgkJLy8gTmVlZCBpbml0IGlmIGpRdWVyeSBpcyBjYWxsZWQgKGp1c3QgYWxsb3cgZXJyb3IgdG8gYmUgdGhyb3duIGlmIG5vdCBpbmNsdWRlZCkKCQlyZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KCBzZWxlY3RvciwgY29udGV4dCApOwoJfSwKCgkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHkKCS8vIE1ha2Ugc3VyZSB3ZSB0cmltIEJPTSBhbmQgTkJTUAoJcnRyaW0gPSAvXltcc1x1RkVGRlx4QTBdK3xbXHNcdUZFRkZceEEwXSskL2c7CgpqUXVlcnkuZm4gPSBqUXVlcnkucHJvdG90eXBlID0gewoKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogdmVyc2lvbiwKCgljb25zdHJ1Y3RvcjogalF1ZXJ5LAoKCS8vIFRoZSBkZWZhdWx0IGxlbmd0aCBvZiBhIGpRdWVyeSBvYmplY3QgaXMgMAoJbGVuZ3RoOiAwLAoKCXRvQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzbGljZS5jYWxsKCB0aGlzICk7Cgl9LAoKCS8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKCS8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CglnZXQ6IGZ1bmN0aW9uKCBudW0gKSB7CgoJCS8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGluIGEgY2xlYW4gYXJyYXkKCQlpZiAoIG51bSA9PSBudWxsICkgewoJCQlyZXR1cm4gc2xpY2UuY2FsbCggdGhpcyApOwoJCX0KCgkJLy8gUmV0dXJuIGp1c3QgdGhlIG9uZSBlbGVtZW50IGZyb20gdGhlIHNldAoJCXJldHVybiBudW0gPCAwID8gdGhpc1sgbnVtICsgdGhpcy5sZW5ndGggXSA6IHRoaXNbIG51bSBdOwoJfSwKCgkvLyBUYWtlIGFuIGFycmF5IG9mIGVsZW1lbnRzIGFuZCBwdXNoIGl0IG9udG8gdGhlIHN0YWNrCgkvLyAocmV0dXJuaW5nIHRoZSBuZXcgbWF0Y2hlZCBlbGVtZW50IHNldCkKCXB1c2hTdGFjazogZnVuY3Rpb24oIGVsZW1zICkgewoKCQkvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAoJCXZhciByZXQgPSBqUXVlcnkubWVyZ2UoIHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMgKTsKCgkJLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKCQlyZXQucHJldk9iamVjdCA9IHRoaXM7CgoJCS8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CgkJcmV0dXJuIHJldDsKCX0sCgoJLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrICk7Cgl9LAoKCW1hcDogZnVuY3Rpb24oIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5Lm1hcCggdGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJfSApICk7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHNsaWNlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSApOwoJfSwKCglmaXJzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIDAgKTsKCX0sCgoJbGFzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZXEoIC0xICk7Cgl9LAoKCWVxOiBmdW5jdGlvbiggaSApIHsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGgsCgkJCWogPSAraSArICggaSA8IDAgPyBsZW4gOiAwICk7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqID49IDAgJiYgaiA8IGxlbiA/IFsgdGhpc1sgaiBdIF0gOiBbXSApOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcigpOwoJfSwKCgkvLyBGb3IgaW50ZXJuYWwgdXNlIG9ubHkuCgkvLyBCZWhhdmVzIGxpa2UgYW4gQXJyYXkncyBtZXRob2QsIG5vdCBsaWtlIGEgalF1ZXJ5IG1ldGhvZC4KCXB1c2g6IHB1c2gsCglzb3J0OiBhcnIuc29ydCwKCXNwbGljZTogYXJyLnNwbGljZQp9OwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCXZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKCQl0YXJnZXQgPSBhcmd1bWVudHNbIDAgXSB8fCB7fSwKCQlpID0gMSwKCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAoJCWRlZXAgPSBmYWxzZTsKCgkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCglpZiAoIHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIiApIHsKCQlkZWVwID0gdGFyZ2V0OwoKCQkvLyBTa2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CgkJdGFyZ2V0ID0gYXJndW1lbnRzWyBpIF0gfHwge307CgkJaSsrOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhaXNGdW5jdGlvbiggdGFyZ2V0ICkgKSB7CgkJdGFyZ2V0ID0ge307Cgl9CgoJLy8gRXh0ZW5kIGpRdWVyeSBpdHNlbGYgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCglpZiAoIGkgPT09IGxlbmd0aCApIHsKCQl0YXJnZXQgPSB0aGlzOwoJCWktLTsKCX0KCglmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCgkJLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwoJCWlmICggKCBvcHRpb25zID0gYXJndW1lbnRzWyBpIF0gKSAhPSBudWxsICkgewoKCQkJLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAoJCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCQlzcmMgPSB0YXJnZXRbIG5hbWUgXTsKCQkJCWNvcHkgPSBvcHRpb25zWyBuYW1lIF07CgoJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAoJCQkJaWYgKCB0YXJnZXQgPT09IGNvcHkgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJLy8gUmVjdXJzZSBpZiB3ZSdyZSBtZXJnaW5nIHBsYWluIG9iamVjdHMgb3IgYXJyYXlzCgkJCQlpZiAoIGRlZXAgJiYgY29weSAmJiAoIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb3B5ICkgfHwKCQkJCQkoIGNvcHlJc0FycmF5ID0gQXJyYXkuaXNBcnJheSggY29weSApICkgKSApIHsKCgkJCQkJaWYgKCBjb3B5SXNBcnJheSApIHsKCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgQXJyYXkuaXNBcnJheSggc3JjICkgPyBzcmMgOiBbXTsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJY2xvbmUgPSBzcmMgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoIHNyYyApID8gc3JjIDoge307CgkJCQkJfQoKCQkJCQkvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KCQkJCQl0YXJnZXRbIG5hbWUgXSA9IGpRdWVyeS5leHRlbmQoIGRlZXAsIGNsb25lLCBjb3B5ICk7CgoJCQkJLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwoJCQkJfSBlbHNlIGlmICggY29weSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXRhcmdldFsgbmFtZSBdID0gY29weTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJcmV0dXJuIHRhcmdldDsKfTsKCmpRdWVyeS5leHRlbmQoIHsKCgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKCWV4cGFuZG86ICJqUXVlcnkiICsgKCB2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSApLnJlcGxhY2UoIC9cRC9nLCAiIiApLAoKCS8vIEFzc3VtZSBqUXVlcnkgaXMgcmVhZHkgd2l0aG91dCB0aGUgcmVhZHkgbW9kdWxlCglpc1JlYWR5OiB0cnVlLAoKCWVycm9yOiBmdW5jdGlvbiggbXNnICkgewoJCXRocm93IG5ldyBFcnJvciggbXNnICk7Cgl9LAoKCW5vb3A6IGZ1bmN0aW9uKCkge30sCgoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgcHJvdG8sIEN0b3I7CgoJCS8vIERldGVjdCBvYnZpb3VzIG5lZ2F0aXZlcwoJCS8vIFVzZSB0b1N0cmluZyBpbnN0ZWFkIG9mIGpRdWVyeS50eXBlIHRvIGNhdGNoIGhvc3Qgb2JqZWN0cwoJCWlmICggIW9iaiB8fCB0b1N0cmluZy5jYWxsKCBvYmogKSAhPT0gIltvYmplY3QgT2JqZWN0XSIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXByb3RvID0gZ2V0UHJvdG8oIG9iaiApOwoKCQkvLyBPYmplY3RzIHdpdGggbm8gcHJvdG90eXBlIChlLmcuLCBgT2JqZWN0LmNyZWF0ZSggbnVsbCApYCkgYXJlIHBsYWluCgkJaWYgKCAhcHJvdG8gKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJLy8gT2JqZWN0cyB3aXRoIHByb3RvdHlwZSBhcmUgcGxhaW4gaWZmIHRoZXkgd2VyZSBjb25zdHJ1Y3RlZCBieSBhIGdsb2JhbCBPYmplY3QgZnVuY3Rpb24KCQlDdG9yID0gaGFzT3duLmNhbGwoIHByb3RvLCAiY29uc3RydWN0b3IiICkgJiYgcHJvdG8uY29uc3RydWN0b3I7CgkJcmV0dXJuIHR5cGVvZiBDdG9yID09PSAiZnVuY3Rpb24iICYmIGZuVG9TdHJpbmcuY2FsbCggQ3RvciApID09PSBPYmplY3RGdW5jdGlvblN0cmluZzsKCX0sCgoJaXNFbXB0eU9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCgkJLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi8KCQkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2VzbGludC9lc2xpbnQvaXNzdWVzLzYxMjUKCQl2YXIgbmFtZTsKCgkJZm9yICggbmFtZSBpbiBvYmogKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggY29kZSApIHsKCQlET01FdmFsKCBjb2RlICk7Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKCBvYmosIGNhbGxiYWNrICkgewoJCXZhciBsZW5ndGgsIGkgPSAwOwoKCQlpZiAoIGlzQXJyYXlMaWtlKCBvYmogKSApIHsKCQkJbGVuZ3RoID0gb2JqLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIGNhbGxiYWNrLmNhbGwoIG9ialsgaSBdLCBpLCBvYmpbIGkgXSApID09PSBmYWxzZSApIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJaWYgKCBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seQoJdHJpbTogZnVuY3Rpb24oIHRleHQgKSB7CgkJcmV0dXJuIHRleHQgPT0gbnVsbCA/CgkJCSIiIDoKCQkJKCB0ZXh0ICsgIiIgKS5yZXBsYWNlKCBydHJpbSwgIiIgKTsKCX0sCgoJLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQoJbWFrZUFycmF5OiBmdW5jdGlvbiggYXJyLCByZXN1bHRzICkgewoJCXZhciByZXQgPSByZXN1bHRzIHx8IFtdOwoKCQlpZiAoIGFyciAhPSBudWxsICkgewoJCQlpZiAoIGlzQXJyYXlMaWtlKCBPYmplY3QoIGFyciApICkgKSB7CgkJCQlqUXVlcnkubWVyZ2UoIHJldCwKCQkJCQl0eXBlb2YgYXJyID09PSAic3RyaW5nIiA/CgkJCQkJWyBhcnIgXSA6IGFycgoJCQkJKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guY2FsbCggcmV0LCBhcnIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJaW5BcnJheTogZnVuY3Rpb24oIGVsZW0sIGFyciwgaSApIHsKCQlyZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7Cgl9LAoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQoJLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAoJbWVyZ2U6IGZ1bmN0aW9uKCBmaXJzdCwgc2Vjb25kICkgewoJCXZhciBsZW4gPSArc2Vjb25kLmxlbmd0aCwKCQkJaiA9IDAsCgkJCWkgPSBmaXJzdC5sZW5ndGg7CgoJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQlmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGogXTsKCQl9CgoJCWZpcnN0Lmxlbmd0aCA9IGk7CgoJCXJldHVybiBmaXJzdDsKCX0sCgoJZ3JlcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0ICkgewoJCXZhciBjYWxsYmFja0ludmVyc2UsCgkJCW1hdGNoZXMgPSBbXSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJY2FsbGJhY2tFeHBlY3QgPSAhaW52ZXJ0OwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCgkJLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJY2FsbGJhY2tJbnZlcnNlID0gIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggY2FsbGJhY2tJbnZlcnNlICE9PSBjYWxsYmFja0V4cGVjdCApIHsKCQkJCW1hdGNoZXMucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gbWF0Y2hlczsKCX0sCgoJLy8gYXJnIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgltYXA6IGZ1bmN0aW9uKCBlbGVtcywgY2FsbGJhY2ssIGFyZyApIHsKCQl2YXIgbGVuZ3RoLCB2YWx1ZSwKCQkJaSA9IDAsCgkJCXJldCA9IFtdOwoKCQkvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwoJCWlmICggaXNBcnJheUxpa2UoIGVsZW1zICkgKSB7CgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQl2YWx1ZSA9IGNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpLCBhcmcgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJcmV0LnB1c2goIHZhbHVlICk7CgkJCQl9CgkJCX0KCgkJLy8gR28gdGhyb3VnaCBldmVyeSBrZXkgb24gdGhlIG9iamVjdCwKCQl9IGVsc2UgewoJCQlmb3IgKCBpIGluIGVsZW1zICkgewoJCQkJdmFsdWUgPSBjYWxsYmFjayggZWxlbXNbIGkgXSwgaSwgYXJnICk7CgoJCQkJaWYgKCB2YWx1ZSAhPSBudWxsICkgewoJCQkJCXJldC5wdXNoKCB2YWx1ZSApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIGNvbmNhdC5hcHBseSggW10sIHJldCApOwoJfSwKCgkvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKCWd1aWQ6IDEsCgoJLy8galF1ZXJ5LnN1cHBvcnQgaXMgbm90IHVzZWQgaW4gQ29yZSBidXQgb3RoZXIgcHJvamVjdHMgYXR0YWNoIHRoZWlyCgkvLyBwcm9wZXJ0aWVzIHRvIGl0IHNvIGl0IG5lZWRzIHRvIGV4aXN0LgoJc3VwcG9ydDogc3VwcG9ydAp9ICk7CgppZiAoIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgKSB7CglqUXVlcnkuZm5bIFN5bWJvbC5pdGVyYXRvciBdID0gYXJyWyBTeW1ib2wuaXRlcmF0b3IgXTsKfQoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCAiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciBTeW1ib2wiLnNwbGl0KCAiICIgKSwKZnVuY3Rpb24oIGksIG5hbWUgKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9ICk7CgpmdW5jdGlvbiBpc0FycmF5TGlrZSggb2JqICkgewoKCS8vIFN1cHBvcnQ6IHJlYWwgaU9TIDguMiBvbmx5IChub3QgcmVwcm9kdWNpYmxlIGluIHNpbXVsYXRvcikKCS8vIGBpbmAgY2hlY2sgdXNlZCB0byBwcmV2ZW50IEpJVCBlcnJvciAoZ2gtMjE0NSkKCS8vIGhhc093biBpc24ndCB1c2VkIGhlcmUgZHVlIHRvIGZhbHNlIG5lZ2F0aXZlcwoJLy8gcmVnYXJkaW5nIE5vZGVsaXN0IGxlbmd0aCBpbiBJRQoJdmFyIGxlbmd0aCA9ICEhb2JqICYmICJsZW5ndGgiIGluIG9iaiAmJiBvYmoubGVuZ3RoLAoJCXR5cGUgPSB0b1R5cGUoIG9iaiApOwoKCWlmICggaXNGdW5jdGlvbiggb2JqICkgfHwgaXNXaW5kb3coIG9iaiApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHlwZSA9PT0gImFycmF5IiB8fCBsZW5ndGggPT09IDAgfHwKCQl0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmICggbGVuZ3RoIC0gMSApIGluIG9iajsKfQp2YXIgU2l6emxlID0KLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYyLjMuMwogKiBodHRwczovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAxNi0wOC0wOAogKi8KKGZ1bmN0aW9uKCB3aW5kb3cgKSB7Cgp2YXIgaSwKCXN1cHBvcnQsCglFeHByLAoJZ2V0VGV4dCwKCWlzWE1MLAoJdG9rZW5pemUsCgljb21waWxlLAoJc2VsZWN0LAoJb3V0ZXJtb3N0Q29udGV4dCwKCXNvcnRJbnB1dCwKCWhhc0R1cGxpY2F0ZSwKCgkvLyBMb2NhbCBkb2N1bWVudCB2YXJzCglzZXREb2N1bWVudCwKCWRvY3VtZW50LAoJZG9jRWxlbSwKCWRvY3VtZW50SXNIVE1MLAoJcmJ1Z2d5UVNBLAoJcmJ1Z2d5TWF0Y2hlcywKCW1hdGNoZXMsCgljb250YWlucywKCgkvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhCglleHBhbmRvID0gInNpenpsZSIgKyAxICogbmV3IERhdGUoKSwKCXByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwKCWRpcnJ1bnMgPSAwLAoJZG9uZSA9IDAsCgljbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCXRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJY29tcGlsZXJDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCglzb3J0T3JkZXIgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJfQoJCXJldHVybiAwOwoJfSwKCgkvLyBJbnN0YW5jZSBtZXRob2RzCgloYXNPd24gPSAoe30pLmhhc093blByb3BlcnR5LAoJYXJyID0gW10sCglwb3AgPSBhcnIucG9wLAoJcHVzaF9uYXRpdmUgPSBhcnIucHVzaCwKCXB1c2ggPSBhcnIucHVzaCwKCXNsaWNlID0gYXJyLnNsaWNlLAoJLy8gVXNlIGEgc3RyaXBwZWQtZG93biBpbmRleE9mIGFzIGl0J3MgZmFzdGVyIHRoYW4gbmF0aXZlCgkvLyBodHRwczovL2pzcGVyZi5jb20vdGhvci1pbmRleG9mLXZzLWZvci81CglpbmRleE9mID0gZnVuY3Rpb24oIGxpc3QsIGVsZW0gKSB7CgkJdmFyIGkgPSAwLAoJCQlsZW4gPSBsaXN0Lmxlbmd0aDsKCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJaWYgKCBsaXN0W2ldID09PSBlbGVtICkgewoJCQkJcmV0dXJuIGk7CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfSwKCglib29sZWFucyA9ICJjaGVja2VkfHNlbGVjdGVkfGFzeW5jfGF1dG9mb2N1c3xhdXRvcGxheXxjb250cm9sc3xkZWZlcnxkaXNhYmxlZHxoaWRkZW58aXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCIsCgoJLy8gUmVndWxhciBleHByZXNzaW9ucwoKCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCgl3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAoKCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCN2YWx1ZS1kZWYtaWRlbnRpZmllcgoJaWRlbnRpZmllciA9ICIoPzpcXFxcLnxbXFx3LV18W15cMC1cXHhhMF0pKyIsCgoJLy8gQXR0cmlidXRlIHNlbGVjdG9yczogaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCglhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGlkZW50aWZpZXIgKyAiKSg/OiIgKyB3aGl0ZXNwYWNlICsKCQkvLyBPcGVyYXRvciAoY2FwdHVyZSAyKQoJCSIqKFsqXiR8IX5dPz0pIiArIHdoaXRlc3BhY2UgKwoJCS8vICJBdHRyaWJ1dGUgdmFsdWVzIG11c3QgYmUgQ1NTIGlkZW50aWZpZXJzIFtjYXB0dXJlIDVdIG9yIHN0cmluZ3MgW2NhcHR1cmUgMyBvciBjYXB0dXJlIDRdIgoJCSIqKD86JygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCJ8KCIgKyBpZGVudGlmaWVyICsgIikpfCkiICsgd2hpdGVzcGFjZSArCgkJIipcXF0iLAoKCXBzZXVkb3MgPSAiOigiICsgaWRlbnRpZmllciArICIpKD86XFwoKCIgKwoJCS8vIFRvIHJlZHVjZSB0aGUgbnVtYmVyIG9mIHNlbGVjdG9ycyBuZWVkaW5nIHRva2VuaXplIGluIHRoZSBwcmVGaWx0ZXIsIHByZWZlciBhcmd1bWVudHM6CgkJLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCgkJIignKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcIil8IiArCgkJLy8gMi4gc2ltcGxlIChjYXB0dXJlIDYpCgkJIigoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzICsgIikqKXwiICsKCQkvLyAzLiBhbnl0aGluZyBlbHNlIChjYXB0dXJlIDIpCgkJIi4qIiArCgkJIilcXCl8KSIsCgoJLy8gTGVhZGluZyBhbmQgbm9uLWVzY2FwZWQgdHJhaWxpbmcgd2hpdGVzcGFjZSwgY2FwdHVyaW5nIHNvbWUgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVycyBwcmVjZWRpbmcgdGhlIGxhdHRlcgoJcndoaXRlc3BhY2UgPSBuZXcgUmVnRXhwKCB3aGl0ZXNwYWNlICsgIisiLCAiZyIgKSwKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAoJcmNvbWJpbmF0b3JzID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqKFs+K35dfCIgKyB3aGl0ZXNwYWNlICsgIikiICsgd2hpdGVzcGFjZSArICIqIiApLAoKCXJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCAiPSIgKyB3aGl0ZXNwYWNlICsgIiooW15cXF0nXCJdKj8pIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsICJnIiApLAoKCXJwc2V1ZG8gPSBuZXcgUmVnRXhwKCBwc2V1ZG9zICksCglyaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoICJeIiArIGlkZW50aWZpZXIgKyAiJCIgKSwKCgltYXRjaEV4cHIgPSB7CgkJIklEIjogbmV3IFJlZ0V4cCggIl4jKCIgKyBpZGVudGlmaWVyICsgIikiICksCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGlkZW50aWZpZXIgKyAiKSIgKSwKCQkiVEFHIjogbmV3IFJlZ0V4cCggIl4oIiArIGlkZW50aWZpZXIgKyAifFsqXSkiICksCgkJIkFUVFIiOiBuZXcgUmVnRXhwKCAiXiIgKyBhdHRyaWJ1dGVzICksCgkJIlBTRVVETyI6IG5ldyBSZWdFeHAoICJeIiArIHBzZXVkb3MgKSwKCQkiQ0hJTEQiOiBuZXcgUmVnRXhwKCAiXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoIiArIHdoaXRlc3BhY2UgKwoJCQkiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKwoJCQkiKihcXGQrKXwpKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSIsICJpIiApLAoJCSJib29sIjogbmV3IFJlZ0V4cCggIl4oPzoiICsgYm9vbGVhbnMgKyAiKSQiLCAiaSIgKSwKCQkvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKCQkvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCgkJIm5lZWRzQ29udGV4dCI6IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArCgkJCXdoaXRlc3BhY2UgKyAiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIgKQoJfSwKCglyaW5wdXRzID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKCXJoZWFkZXIgPSAvXmhcZCQvaSwKCglybmF0aXZlID0gL15bXntdK1x7XHMqXFtuYXRpdmUgXHcvLAoKCS8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwoJcnF1aWNrRXhwciA9IC9eKD86IyhbXHctXSspfChcdyspfFwuKFtcdy1dKykpJC8sCgoJcnNpYmxpbmcgPSAvWyt+XS8sCgoJLy8gQ1NTIGVzY2FwZXMKCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKCXJ1bmVzY2FwZSA9IG5ldyBSZWdFeHAoICJcXFxcKFtcXGRhLWZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fCgiICsgd2hpdGVzcGFjZSArICIpfC4pIiwgImlnIiApLAoJZnVuZXNjYXBlID0gZnVuY3Rpb24oIF8sIGVzY2FwZWQsIGVzY2FwZWRXaGl0ZXNwYWNlICkgewoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwoJCS8vIE5hTiBtZWFucyBub24tY29kZXBvaW50CgkJLy8gU3VwcG9ydDogRmlyZWZveDwyNAoJCS8vIFdvcmthcm91bmQgZXJyb25lb3VzIG51bWVyaWMgaW50ZXJwcmV0YXRpb24gb2YgKyIweCIKCQlyZXR1cm4gaGlnaCAhPT0gaGlnaCB8fCBlc2NhcGVkV2hpdGVzcGFjZSA/CgkJCWVzY2FwZWQgOgoJCQloaWdoIDwgMCA/CgkJCQkvLyBCTVAgY29kZXBvaW50CgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoICsgMHgxMDAwMCApIDoKCQkJCS8vIFN1cHBsZW1lbnRhbCBQbGFuZSBjb2RlcG9pbnQgKHN1cnJvZ2F0ZSBwYWlyKQoJCQkJU3RyaW5nLmZyb21DaGFyQ29kZSggaGlnaCA+PiAxMCB8IDB4RDgwMCwgaGlnaCAmIDB4M0ZGIHwgMHhEQzAwICk7Cgl9LAoKCS8vIENTUyBzdHJpbmcvaWRlbnRpZmllciBzZXJpYWxpemF0aW9uCgkvLyBodHRwczovL2RyYWZ0cy5jc3N3Zy5vcmcvY3Nzb20vI2NvbW1vbi1zZXJpYWxpemluZy1pZGlvbXMKCXJjc3Nlc2NhcGUgPSAvKFtcMC1ceDFmXHg3Zl18Xi0/XGQpfF4tJHxbXlwwLVx4MWZceDdmLVx1RkZGRlx3LV0vZywKCWZjc3Nlc2NhcGUgPSBmdW5jdGlvbiggY2gsIGFzQ29kZVBvaW50ICkgewoJCWlmICggYXNDb2RlUG9pbnQgKSB7CgoJCQkvLyBVKzAwMDAgTlVMTCBiZWNvbWVzIFUrRkZGRCBSRVBMQUNFTUVOVCBDSEFSQUNURVIKCQkJaWYgKCBjaCA9PT0gIlwwIiApIHsKCQkJCXJldHVybiAiXHVGRkZEIjsKCQkJfQoKCQkJLy8gQ29udHJvbCBjaGFyYWN0ZXJzIGFuZCAoZGVwZW5kZW50IHVwb24gcG9zaXRpb24pIG51bWJlcnMgZ2V0IGVzY2FwZWQgYXMgY29kZSBwb2ludHMKCQkJcmV0dXJuIGNoLnNsaWNlKCAwLCAtMSApICsgIlxcIiArIGNoLmNoYXJDb2RlQXQoIGNoLmxlbmd0aCAtIDEgKS50b1N0cmluZyggMTYgKSArICIgIjsKCQl9CgoJCS8vIE90aGVyIHBvdGVudGlhbGx5LXNwZWNpYWwgQVNDSUkgY2hhcmFjdGVycyBnZXQgYmFja3NsYXNoLWVzY2FwZWQKCQlyZXR1cm4gIlxcIiArIGNoOwoJfSwKCgkvLyBVc2VkIGZvciBpZnJhbWVzCgkvLyBTZWUgc2V0RG9jdW1lbnQoKQoJLy8gUmVtb3ZpbmcgdGhlIGZ1bmN0aW9uIHdyYXBwZXIgY2F1c2VzIGEgIlBlcm1pc3Npb24gRGVuaWVkIgoJLy8gZXJyb3IgaW4gSUUKCXVubG9hZEhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQlzZXREb2N1bWVudCgpOwoJfSwKCglkaXNhYmxlZEFuY2VzdG9yID0gYWRkQ29tYmluYXRvcigKCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWUgJiYgKCJmb3JtIiBpbiBlbGVtIHx8ICJsYWJlbCIgaW4gZWxlbSk7CgkJfSwKCQl7IGRpcjogInBhcmVudE5vZGUiLCBuZXh0OiAibGVnZW5kIiB9CgkpOwoKLy8gT3B0aW1pemUgZm9yIHB1c2guYXBwbHkoIF8sIE5vZGVMaXN0ICkKdHJ5IHsKCXB1c2guYXBwbHkoCgkJKGFyciA9IHNsaWNlLmNhbGwoIHByZWZlcnJlZERvYy5jaGlsZE5vZGVzICkpLAoJCXByZWZlcnJlZERvYy5jaGlsZE5vZGVzCgkpOwoJLy8gU3VwcG9ydDogQW5kcm9pZDw0LjAKCS8vIERldGVjdCBzaWxlbnRseSBmYWlsaW5nIHB1c2guYXBwbHkKCWFyclsgcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMubGVuZ3RoIF0ubm9kZVR5cGU7Cn0gY2F0Y2ggKCBlICkgewoJcHVzaCA9IHsgYXBwbHk6IGFyci5sZW5ndGggPwoKCQkvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQoJCWZ1bmN0aW9uKCB0YXJnZXQsIGVscyApIHsKCQkJcHVzaF9uYXRpdmUuYXBwbHkoIHRhcmdldCwgc2xpY2UuY2FsbChlbHMpICk7CgkJfSA6CgoJCS8vIFN1cHBvcnQ6IElFPDkKCQkvLyBPdGhlcndpc2UgYXBwZW5kIGRpcmVjdGx5CgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQl2YXIgaiA9IHRhcmdldC5sZW5ndGgsCgkJCQlpID0gMDsKCQkJLy8gQ2FuJ3QgdHJ1c3QgTm9kZUxpc3QubGVuZ3RoCgkJCXdoaWxlICggKHRhcmdldFtqKytdID0gZWxzW2krK10pICkge30KCQkJdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOwoJCX0KCX07Cn0KCmZ1bmN0aW9uIFNpenpsZSggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7Cgl2YXIgbSwgaSwgZWxlbSwgbmlkLCBtYXRjaCwgZ3JvdXBzLCBuZXdTZWxlY3RvciwKCQluZXdDb250ZXh0ID0gY29udGV4dCAmJiBjb250ZXh0Lm93bmVyRG9jdW1lbnQsCgoJCS8vIG5vZGVUeXBlIGRlZmF1bHRzIHRvIDksIHNpbmNlIGNvbnRleHQgZGVmYXVsdHMgdG8gZG9jdW1lbnQKCQlub2RlVHlwZSA9IGNvbnRleHQgPyBjb250ZXh0Lm5vZGVUeXBlIDogOTsKCglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCgkvLyBSZXR1cm4gZWFybHkgZnJvbSBjYWxscyB3aXRoIGludmFsaWQgc2VsZWN0b3Igb3IgY29udGV4dAoJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciIHx8ICFzZWxlY3RvciB8fAoJCW5vZGVUeXBlICE9PSAxICYmIG5vZGVUeXBlICE9PSA5ICYmIG5vZGVUeXBlICE9PSAxMSApIHsKCgkJcmV0dXJuIHJlc3VsdHM7Cgl9CgoJLy8gVHJ5IHRvIHNob3J0Y3V0IGZpbmQgb3BlcmF0aW9ucyAoYXMgb3Bwb3NlZCB0byBmaWx0ZXJzKSBpbiBIVE1MIGRvY3VtZW50cwoJaWYgKCAhc2VlZCApIHsKCgkJaWYgKCAoIGNvbnRleHQgPyBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCA6IHByZWZlcnJlZERvYyApICE9PSBkb2N1bWVudCApIHsKCQkJc2V0RG9jdW1lbnQoIGNvbnRleHQgKTsKCQl9CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCWlmICggZG9jdW1lbnRJc0hUTUwgKSB7CgoJCQkvLyBJZiB0aGUgc2VsZWN0b3IgaXMgc3VmZmljaWVudGx5IHNpbXBsZSwgdHJ5IHVzaW5nIGEgImdldCpCeSoiIERPTSBtZXRob2QKCQkJLy8gKGV4Y2VwdGluZyBEb2N1bWVudEZyYWdtZW50IGNvbnRleHQsIHdoZXJlIHRoZSBtZXRob2RzIGRvbid0IGV4aXN0KQoJCQlpZiAoIG5vZGVUeXBlICE9PSAxMSAmJiAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoIHNlbGVjdG9yICkpICkgewoKCQkJCS8vIElEIHNlbGVjdG9yCgkJCQlpZiAoIChtID0gbWF0Y2hbMV0pICkgewoKCQkJCQkvLyBEb2N1bWVudCBjb250ZXh0CgkJCQkJaWYgKCBub2RlVHlwZSA9PT0gOSApIHsKCQkJCQkJaWYgKCAoZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKSkgKSB7CgoJCQkJCQkJLy8gU3VwcG9ydDogSUUsIE9wZXJhLCBXZWJraXQKCQkJCQkJCS8vIFRPRE86IGlkZW50aWZ5IHZlcnNpb25zCgkJCQkJCQkvLyBnZXRFbGVtZW50QnlJZCBjYW4gbWF0Y2ggZWxlbWVudHMgYnkgbmFtZSBpbnN0ZWFkIG9mIElECgkJCQkJCQlpZiAoIGVsZW0uaWQgPT09IG0gKSB7CgkJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoKCQkJCQkvLyBFbGVtZW50IGNvbnRleHQKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gU3VwcG9ydDogSUUsIE9wZXJhLCBXZWJraXQKCQkJCQkJLy8gVE9ETzogaWRlbnRpZnkgdmVyc2lvbnMKCQkJCQkJLy8gZ2V0RWxlbWVudEJ5SWQgY2FuIG1hdGNoIGVsZW1lbnRzIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQlpZiAoIG5ld0NvbnRleHQgJiYgKGVsZW0gPSBuZXdDb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCQljb250YWlucyggY29udGV4dCwgZWxlbSApICYmCgkJCQkJCQllbGVtLmlkID09PSBtICkgewoKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQkJCX0KCQkJCQl9CgoJCQkJLy8gVHlwZSBzZWxlY3RvcgoJCQkJfSBlbHNlIGlmICggbWF0Y2hbMl0gKSB7CgkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSApOwoJCQkJCXJldHVybiByZXN1bHRzOwoKCQkJCS8vIENsYXNzIHNlbGVjdG9yCgkJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYKCQkJCQljb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgKSB7CgoJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggbSApICk7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQl9CgkJCX0KCgkJCS8vIFRha2UgYWR2YW50YWdlIG9mIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJaWYgKCBzdXBwb3J0LnFzYSAmJgoJCQkJIWNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF0gJiYKCQkJCSghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdCggc2VsZWN0b3IgKSkgKSB7CgoJCQkJaWYgKCBub2RlVHlwZSAhPT0gMSApIHsKCQkJCQluZXdDb250ZXh0ID0gY29udGV4dDsKCQkJCQluZXdTZWxlY3RvciA9IHNlbGVjdG9yOwoKCQkJCS8vIHFTQSBsb29rcyBvdXRzaWRlIEVsZW1lbnQgY29udGV4dCwgd2hpY2ggaXMgbm90IHdoYXQgd2Ugd2FudAoJCQkJLy8gVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoaXMgd29ya2Fyb3VuZCB0ZWNobmlxdWUKCQkJCS8vIFN1cHBvcnQ6IElFIDw9OAoJCQkJLy8gRXhjbHVkZSBvYmplY3QgZWxlbWVudHMKCQkJCX0gZWxzZSBpZiAoIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIgKSB7CgoJCQkJCS8vIENhcHR1cmUgdGhlIGNvbnRleHQgSUQsIHNldHRpbmcgaXQgZmlyc3QgaWYgbmVjZXNzYXJ5CgkJCQkJaWYgKCAobmlkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoICJpZCIgKSkgKSB7CgkJCQkJCW5pZCA9IG5pZC5yZXBsYWNlKCByY3NzZXNjYXBlLCBmY3NzZXNjYXBlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJY29udGV4dC5zZXRBdHRyaWJ1dGUoICJpZCIsIChuaWQgPSBleHBhbmRvKSApOwoJCQkJCX0KCgkJCQkJLy8gUHJlZml4IGV2ZXJ5IHNlbGVjdG9yIGluIHRoZSBsaXN0CgkJCQkJZ3JvdXBzID0gdG9rZW5pemUoIHNlbGVjdG9yICk7CgkJCQkJaSA9IGdyb3Vwcy5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWdyb3Vwc1tpXSA9ICIjIiArIG5pZCArICIgIiArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwoJCQkJCX0KCQkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCAiLCIgKTsKCgkJCQkJLy8gRXhwYW5kIGNvbnRleHQgZm9yIHNpYmxpbmcgc2VsZWN0b3JzCgkJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8CgkJCQkJCWNvbnRleHQ7CgkJCQl9CgoJCQkJaWYgKCBuZXdTZWxlY3RvciApIHsKCQkJCQl0cnkgewoJCQkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLAoJCQkJCQkJbmV3Q29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKCBuZXdTZWxlY3RvciApCgkJCQkJCSk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0gY2F0Y2ggKCBxc2FFcnJvciApIHsKCQkJCQl9IGZpbmFsbHkgewoJCQkJCQlpZiAoIG5pZCA9PT0gZXhwYW5kbyApIHsKCQkJCQkJCWNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCAiaWQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gQWxsIG90aGVycwoJcmV0dXJuIHNlbGVjdCggc2VsZWN0b3IucmVwbGFjZSggcnRyaW0sICIkMSIgKSwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApOwp9CgovKioKICogQ3JlYXRlIGtleS12YWx1ZSBjYWNoZXMgb2YgbGltaXRlZCBzaXplCiAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmcsIG9iamVjdCl9IFJldHVybnMgdGhlIE9iamVjdCBkYXRhIGFmdGVyIHN0b3JpbmcgaXQgb24gaXRzZWxmIHdpdGgKICoJcHJvcGVydHkgbmFtZSB0aGUgKHNwYWNlLXN1ZmZpeGVkKSBzdHJpbmcgYW5kIChpZiB0aGUgY2FjaGUgaXMgbGFyZ2VyIHRoYW4gRXhwci5jYWNoZUxlbmd0aCkKICoJZGVsZXRpbmcgdGhlIG9sZGVzdCBlbnRyeQogKi8KZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7Cgl2YXIga2V5cyA9IFtdOwoKCWZ1bmN0aW9uIGNhY2hlKCBrZXksIHZhbHVlICkgewoJCS8vIFVzZSAoa2V5ICsgIiAiKSB0byBhdm9pZCBjb2xsaXNpb24gd2l0aCBuYXRpdmUgcHJvdG90eXBlIHByb3BlcnRpZXMgKHNlZSBJc3N1ZSAjMTU3KQoJCWlmICgga2V5cy5wdXNoKCBrZXkgKyAiICIgKSA+IEV4cHIuY2FjaGVMZW5ndGggKSB7CgkJCS8vIE9ubHkga2VlcCB0aGUgbW9zdCByZWNlbnQgZW50cmllcwoJCQlkZWxldGUgY2FjaGVbIGtleXMuc2hpZnQoKSBdOwoJCX0KCQlyZXR1cm4gKGNhY2hlWyBrZXkgKyAiICIgXSA9IHZhbHVlKTsKCX0KCXJldHVybiBjYWNoZTsKfQoKLyoqCiAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBtYXJrCiAqLwpmdW5jdGlvbiBtYXJrRnVuY3Rpb24oIGZuICkgewoJZm5bIGV4cGFuZG8gXSA9IHRydWU7CglyZXR1cm4gZm47Cn0KCi8qKgogKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudAogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBQYXNzZWQgdGhlIGNyZWF0ZWQgZWxlbWVudCBhbmQgcmV0dXJucyBhIGJvb2xlYW4gcmVzdWx0CiAqLwpmdW5jdGlvbiBhc3NlcnQoIGZuICkgewoJdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKTsKCgl0cnkgewoJCXJldHVybiAhIWZuKCBlbCApOwoJfSBjYXRjaCAoZSkgewoJCXJldHVybiBmYWxzZTsKCX0gZmluYWxseSB7CgkJLy8gUmVtb3ZlIGZyb20gaXRzIHBhcmVudCBieSBkZWZhdWx0CgkJaWYgKCBlbC5wYXJlbnROb2RlICkgewoJCQllbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBlbCApOwoJCX0KCQkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJCWVsID0gbnVsbDsKCX0KfQoKLyoqCiAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMKICogQHBhcmFtIHtTdHJpbmd9IGF0dHJzIFBpcGUtc2VwYXJhdGVkIGxpc3Qgb2YgYXR0cmlidXRlcwogKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBtZXRob2QgdGhhdCB3aWxsIGJlIGFwcGxpZWQKICovCmZ1bmN0aW9uIGFkZEhhbmRsZSggYXR0cnMsIGhhbmRsZXIgKSB7Cgl2YXIgYXJyID0gYXR0cnMuc3BsaXQoInwiKSwKCQlpID0gYXJyLmxlbmd0aDsKCgl3aGlsZSAoIGktLSApIHsKCQlFeHByLmF0dHJIYW5kbGVbIGFycltpXSBdID0gaGFuZGxlcjsKCX0KfQoKLyoqCiAqIENoZWNrcyBkb2N1bWVudCBvcmRlciBvZiB0d28gc2libGluZ3MKICogQHBhcmFtIHtFbGVtZW50fSBhCiAqIEBwYXJhbSB7RWxlbWVudH0gYgogKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGxlc3MgdGhhbiAwIGlmIGEgcHJlY2VkZXMgYiwgZ3JlYXRlciB0aGFuIDAgaWYgYSBmb2xsb3dzIGIKICovCmZ1bmN0aW9uIHNpYmxpbmdDaGVjayggYSwgYiApIHsKCXZhciBjdXIgPSBiICYmIGEsCgkJZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYKCQkJYS5zb3VyY2VJbmRleCAtIGIuc291cmNlSW5kZXg7CgoJLy8gVXNlIElFIHNvdXJjZUluZGV4IGlmIGF2YWlsYWJsZSBvbiBib3RoIG5vZGVzCglpZiAoIGRpZmYgKSB7CgkJcmV0dXJuIGRpZmY7Cgl9CgoJLy8gQ2hlY2sgaWYgYiBmb2xsb3dzIGEKCWlmICggY3VyICkgewoJCXdoaWxlICggKGN1ciA9IGN1ci5uZXh0U2libGluZykgKSB7CgkJCWlmICggY3VyID09PSBiICkgewoJCQkJcmV0dXJuIC0xOwoJCQl9CgkJfQoJfQoKCXJldHVybiBhID8gMSA6IC0xOwp9CgovKioKICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogKi8KZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8oIHR5cGUgKSB7CglyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSB0eXBlOwoJfTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgYnV0dG9ucwogKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogKi8KZnVuY3Rpb24gY3JlYXRlQnV0dG9uUHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiAobmFtZSA9PT0gImlucHV0IiB8fCBuYW1lID09PSAiYnV0dG9uIikgJiYgZWxlbS50eXBlID09PSB0eXBlOwoJfTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgOmVuYWJsZWQvOmRpc2FibGVkCiAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlzYWJsZWQgdHJ1ZSBmb3IgOmRpc2FibGVkOyBmYWxzZSBmb3IgOmVuYWJsZWQKICovCmZ1bmN0aW9uIGNyZWF0ZURpc2FibGVkUHNldWRvKCBkaXNhYmxlZCApIHsKCgkvLyBLbm93biA6ZGlzYWJsZWQgZmFsc2UgcG9zaXRpdmVzOiBmaWVsZHNldFtkaXNhYmxlZF0gPiBsZWdlbmQ6bnRoLW9mLXR5cGUobisyKSA6Y2FuLWRpc2FibGUKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCgkJLy8gT25seSBjZXJ0YWluIGVsZW1lbnRzIGNhbiBtYXRjaCA6ZW5hYmxlZCBvciA6ZGlzYWJsZWQKCQkvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zY3JpcHRpbmcuaHRtbCNzZWxlY3Rvci1lbmFibGVkCgkJLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc2NyaXB0aW5nLmh0bWwjc2VsZWN0b3ItZGlzYWJsZWQKCQlpZiAoICJmb3JtIiBpbiBlbGVtICkgewoKCQkJLy8gQ2hlY2sgZm9yIGluaGVyaXRlZCBkaXNhYmxlZG5lc3Mgb24gcmVsZXZhbnQgbm9uLWRpc2FibGVkIGVsZW1lbnRzOgoJCQkvLyAqIGxpc3RlZCBmb3JtLWFzc29jaWF0ZWQgZWxlbWVudHMgaW4gYSBkaXNhYmxlZCBmaWVsZHNldAoJCQkvLyAgIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2Zvcm1zLmh0bWwjY2F0ZWdvcnktbGlzdGVkCgkJCS8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjb25jZXB0LWZlLWRpc2FibGVkCgkJCS8vICogb3B0aW9uIGVsZW1lbnRzIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKCQkJLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NvbmNlcHQtb3B0aW9uLWRpc2FibGVkCgkJCS8vIEFsbCBzdWNoIGVsZW1lbnRzIGhhdmUgYSAiZm9ybSIgcHJvcGVydHkuCgkJCWlmICggZWxlbS5wYXJlbnROb2RlICYmIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlICkgewoKCQkJCS8vIE9wdGlvbiBlbGVtZW50cyBkZWZlciB0byBhIHBhcmVudCBvcHRncm91cCBpZiBwcmVzZW50CgkJCQlpZiAoICJsYWJlbCIgaW4gZWxlbSApIHsKCQkJCQlpZiAoICJsYWJlbCIgaW4gZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQlyZXR1cm4gZWxlbS5wYXJlbnROb2RlLmRpc2FibGVkID09PSBkaXNhYmxlZDsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFN1cHBvcnQ6IElFIDYgLSAxMQoJCQkJLy8gVXNlIHRoZSBpc0Rpc2FibGVkIHNob3J0Y3V0IHByb3BlcnR5IHRvIGNoZWNrIGZvciBkaXNhYmxlZCBmaWVsZHNldCBhbmNlc3RvcnMKCQkJCXJldHVybiBlbGVtLmlzRGlzYWJsZWQgPT09IGRpc2FibGVkIHx8CgoJCQkJCS8vIFdoZXJlIHRoZXJlIGlzIG5vIGlzRGlzYWJsZWQsIGNoZWNrIG1hbnVhbGx5CgkJCQkJLyoganNoaW50IC1XMDE4ICovCgkJCQkJZWxlbS5pc0Rpc2FibGVkICE9PSAhZGlzYWJsZWQgJiYKCQkJCQkJZGlzYWJsZWRBbmNlc3RvciggZWxlbSApID09PSBkaXNhYmxlZDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGRpc2FibGVkOwoKCQkvLyBUcnkgdG8gd2lubm93IG91dCBlbGVtZW50cyB0aGF0IGNhbid0IGJlIGRpc2FibGVkIGJlZm9yZSB0cnVzdGluZyB0aGUgZGlzYWJsZWQgcHJvcGVydHkuCgkJLy8gU29tZSB2aWN0aW1zIGdldCBjYXVnaHQgaW4gb3VyIG5ldCAobGFiZWwsIGxlZ2VuZCwgbWVudSwgdHJhY2spLCBidXQgaXQgc2hvdWxkbid0CgkJLy8gZXZlbiBleGlzdCBvbiB0aGVtLCBsZXQgYWxvbmUgaGF2ZSBhIGJvb2xlYW4gdmFsdWUuCgkJfSBlbHNlIGlmICggImxhYmVsIiBpbiBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CgkJfQoKCQkvLyBSZW1haW5pbmcgZWxlbWVudHMgYXJlIG5laXRoZXIgOmVuYWJsZWQgbm9yIDpkaXNhYmxlZAoJCXJldHVybiBmYWxzZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAqLwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIGFyZ3VtZW50ICkgewoJCWFyZ3VtZW50ID0gK2FyZ3VtZW50OwoJCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCXZhciBqLAoJCQkJbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKCQkJCWkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKCQkJLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCBzZWVkWyAoaiA9IG1hdGNoSW5kZXhlc1tpXSkgXSApIHsKCQkJCQlzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwp9CgovKioKICogQ2hlY2tzIGEgbm9kZSBmb3IgdmFsaWRpdHkgYXMgYSBTaXp6bGUgY29udGV4dAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0PX0gY29udGV4dAogKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICovCmZ1bmN0aW9uIHRlc3RDb250ZXh0KCBjb250ZXh0ICkgewoJcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnRleHQ7Cn0KCi8vIEV4cG9zZSBzdXBwb3J0IHZhcnMgZm9yIGNvbnZlbmllbmNlCnN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwoKLyoqCiAqIERldGVjdHMgWE1MIG5vZGVzCiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IGVsZW0gQW4gZWxlbWVudCBvciBhIGRvY3VtZW50CiAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUKICovCmlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykKCXZhciBkb2N1bWVudEVsZW1lbnQgPSBlbGVtICYmIChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkuZG9jdW1lbnRFbGVtZW50OwoJcmV0dXJuIGRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gIkhUTUwiIDogZmFsc2U7Cn07CgovKioKICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IFtkb2NdIEFuIGVsZW1lbnQgb3IgZG9jdW1lbnQgb2JqZWN0IHRvIHVzZSB0byBzZXQgdGhlIGRvY3VtZW50CiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGN1cnJlbnQgZG9jdW1lbnQKICovCnNldERvY3VtZW50ID0gU2l6emxlLnNldERvY3VtZW50ID0gZnVuY3Rpb24oIG5vZGUgKSB7Cgl2YXIgaGFzQ29tcGFyZSwgc3ViV2luZG93LAoJCWRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYzsKCgkvLyBSZXR1cm4gZWFybHkgaWYgZG9jIGlzIGludmFsaWQgb3IgYWxyZWFkeSBzZWxlY3RlZAoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsKCQlyZXR1cm4gZG9jdW1lbnQ7Cgl9CgoJLy8gVXBkYXRlIGdsb2JhbCB2YXJpYWJsZXMKCWRvY3VtZW50ID0gZG9jOwoJZG9jRWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCWRvY3VtZW50SXNIVE1MID0gIWlzWE1MKCBkb2N1bWVudCApOwoKCS8vIFN1cHBvcnQ6IElFIDktMTEsIEVkZ2UKCS8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMgKGpRdWVyeSAjMTM5MzYpCglpZiAoIHByZWZlcnJlZERvYyAhPT0gZG9jdW1lbnQgJiYKCQkoc3ViV2luZG93ID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcpICYmIHN1YldpbmRvdy50b3AgIT09IHN1YldpbmRvdyApIHsKCgkJLy8gU3VwcG9ydDogSUUgMTEsIEVkZ2UKCQlpZiAoIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyICkgewoJCQlzdWJXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggInVubG9hZCIsIHVubG9hZEhhbmRsZXIsIGZhbHNlICk7CgoJCS8vIFN1cHBvcnQ6IElFIDkgLSAxMCBvbmx5CgkJfSBlbHNlIGlmICggc3ViV2luZG93LmF0dGFjaEV2ZW50ICkgewoJCQlzdWJXaW5kb3cuYXR0YWNoRXZlbnQoICJvbnVubG9hZCIsIHVubG9hZEhhbmRsZXIgKTsKCQl9Cgl9CgoJLyogQXR0cmlidXRlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIFN1cHBvcnQ6IElFPDgKCS8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcwoJLy8gKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJCWVsLmNsYXNzTmFtZSA9ICJpIjsKCQlyZXR1cm4gIWVsLmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7Cgl9KTsKCgkvKiBnZXRFbGVtZW50KHMpQnkqCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJCWVsLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiAhZWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKS5sZW5ndGg7Cgl9KTsKCgkvLyBTdXBwb3J0OiBJRTw5CglzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBybmF0aXZlLnRlc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgKTsKCgkvLyBTdXBwb3J0OiBJRTwxMAoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtbWF0aWNhbGx5LXNldCBuYW1lcywKCS8vIHNvIHVzZSBhIHJvdW5kYWJvdXQgZ2V0RWxlbWVudHNCeU5hbWUgdGVzdAoJc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlkID0gZXhwYW5kbzsKCQlyZXR1cm4gIWRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aDsKCX0pOwoKCS8vIElEIGZpbHRlciBhbmQgZmluZAoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7CgkJRXhwci5maWx0ZXJbIklEIl0gPSBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsKCQkJfTsKCQl9OwoJCUV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uKCBpZCwgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCQl2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgkJCQlyZXR1cm4gZWxlbSA/IFsgZWxlbSBdIDogW107CgkJCX0KCQl9OwoJfSBlbHNlIHsKCQlFeHByLmZpbHRlclsiSUQiXSA9ICBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBhdHRySWQgPSBpZC5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmCgkJCQkJZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwoJCQl9OwoJCX07CgoJCS8vIFN1cHBvcnQ6IElFIDYgLSA3IG9ubHkKCQkvLyBnZXRFbGVtZW50QnlJZCBpcyBub3QgcmVsaWFibGUgYXMgYSBmaW5kIHNob3J0Y3V0CgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCApIHsKCQkJCXZhciBub2RlLCBpLCBlbGVtcywKCQkJCQllbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggaWQgKTsKCgkJCQlpZiAoIGVsZW0gKSB7CgoJCQkJCS8vIFZlcmlmeSB0aGUgaWQgYXR0cmlidXRlCgkJCQkJbm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCQkJCQlpZiAoIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gaWQgKSB7CgkJCQkJCXJldHVybiBbIGVsZW0gXTsKCQkJCQl9CgoJCQkJCS8vIEZhbGwgYmFjayBvbiBnZXRFbGVtZW50c0J5TmFtZQoJCQkJCWVsZW1zID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSggaWQgKTsKCQkJCQlpID0gMDsKCQkJCQl3aGlsZSAoIChlbGVtID0gZWxlbXNbaSsrXSkgKSB7CgkJCQkJCW5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CgkJCQkJCWlmICggbm9kZSAmJiBub2RlLnZhbHVlID09PSBpZCApIHsKCQkJCQkJCXJldHVybiBbIGVsZW0gXTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gW107CgkJCX0KCQl9OwoJfQoKCS8vIFRhZwoJRXhwci5maW5kWyJUQUciXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPwoJCWZ1bmN0aW9uKCB0YWcsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRG9jdW1lbnRGcmFnbWVudCBub2RlcyBkb24ndCBoYXZlIGdFQlROCgkJCX0gZWxzZSBpZiAoIHN1cHBvcnQucXNhICkgewoJCQkJcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnICk7CgkJCX0KCQl9IDoKCgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJdmFyIGVsZW0sCgkJCQl0bXAgPSBbXSwKCQkJCWkgPSAwLAoJCQkJLy8gQnkgaGFwcHkgY29pbmNpZGVuY2UsIGEgKGJyb2tlbikgZ0VCVE4gYXBwZWFycyBvbiBEb2N1bWVudEZyYWdtZW50IG5vZGVzIHRvbwoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdG1wOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX07CgoJLy8gQ2xhc3MKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGNsYXNzTmFtZSApOwoJCX0KCX07CgoJLyogUVNBL21hdGNoZXNTZWxlY3RvcgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQKCgkvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQoJcmJ1Z2d5TWF0Y2hlcyA9IFtdOwoKCS8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpCgkvLyBXZSBhbGxvdyB0aGlzIGJlY2F1c2Ugb2YgYSBidWcgaW4gSUU4LzkgdGhhdCB0aHJvd3MgYW4gZXJyb3IKCS8vIHdoZW5ldmVyIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBpcyBhY2Nlc3NlZCBvbiBhbiBpZnJhbWUKCS8vIFNvLCB3ZSBhbGxvdyA6Zm9jdXMgdG8gcGFzcyB0aHJvdWdoIFFTQSBhbGwgdGhlIHRpbWUgdG8gYXZvaWQgdGhlIElFIGVycm9yCgkvLyBTZWUgaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CglyYnVnZ3lRU0EgPSBbXTsKCglpZiAoIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApKSApIHsKCQkvLyBCdWlsZCBRU0EgcmVnZXgKCQkvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pCgkJYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCQkJLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQoJCQkvLyBUaGlzIGlzIHRvIHRlc3QgSUUncyB0cmVhdG1lbnQgb2Ygbm90IGV4cGxpY2l0bHkKCQkJLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsCgkJCS8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCgkJCS8vIGh0dHBzOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMjM1OQoJCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBlbCApLmlubmVySFRNTCA9ICI8YSBpZD0nIiArIGV4cGFuZG8gKyAiJz48L2E+IiArCgkJCQkiPHNlbGVjdCBpZD0nIiArIGV4cGFuZG8gKyAiLVxyXFwnIG1zYWxsb3djYXB0dXJlPScnPiIgKwoJCQkJIjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTEtMTIuMTYKCQkJLy8gTm90aGluZyBzaG91bGQgYmUgc2VsZWN0ZWQgd2hlbiBlbXB0eSBzdHJpbmdzIGZvbGxvdyBePSBvciAkPSBvciAqPQoJCQkvLyBUaGUgdGVzdCBhdHRyaWJ1dGUgbXVzdCBiZSB1bmtub3duIGluIE9wZXJhIGJ1dCAic2FmZSIgZm9yIFdpblJUCgkJCS8vIGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgoJCQlpZiAoIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIlttc2FsbG93Y2FwdHVyZV49JyddIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiICk7CgkJCX0KCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFlbC5xdWVyeVNlbGVjdG9yQWxsKCJbc2VsZWN0ZWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJcXFsiICsgd2hpdGVzcGFjZSArICIqKD86dmFsdWV8IiArIGJvb2xlYW5zICsgIikiICk7CgkJCX0KCgkJCS8vIFN1cHBvcnQ6IENocm9tZTwyOSwgQW5kcm9pZDw0LjQsIFNhZmFyaTw3LjArLCBpT1M8Ny4wKywgUGhhbnRvbUpTPDEuOS44KwoJCQlpZiAoICFlbC5xdWVyeVNlbGVjdG9yQWxsKCAiW2lkfj0iICsgZXhwYW5kbyArICItXSIgKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgifj0iKTsKCQkJfQoKCQkJLy8gV2Via2l0L09wZXJhIC0gOmNoZWNrZWQgc2hvdWxkIHJldHVybiBzZWxlY3RlZCBvcHRpb24gZWxlbWVudHMKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKCQkJLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKCQkJaWYgKCAhZWwucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoKCQkJLy8gU3VwcG9ydDogU2FmYXJpIDgrLCBpT1MgOCsKCQkJLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNjg1MQoJCQkvLyBJbi1wYWdlIGBzZWxlY3RvciNpZCBzaWJsaW5nLWNvbWJpbmF0b3Igc2VsZWN0b3JgIGZhaWxzCgkJCWlmICggIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoICJhIyIgKyBleHBhbmRvICsgIisqIiApLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCIuIy4rWyt+XSIpOwoJCQl9CgkJfSk7CgoJCWFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkJCWVsLmlubmVySFRNTCA9ICI8YSBocmVmPScnIGRpc2FibGVkPSdkaXNhYmxlZCc+PC9hPiIgKwoJCQkJIjxzZWxlY3QgZGlzYWJsZWQ9J2Rpc2FibGVkJz48b3B0aW9uLz48L3NlbGVjdD4iOwoKCQkJLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCgkJCS8vIFRoZSB0eXBlIGFuZCBuYW1lIGF0dHJpYnV0ZXMgYXJlIHJlc3RyaWN0ZWQgZHVyaW5nIC5pbm5lckhUTUwgYXNzaWdubWVudAoJCQl2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCQlpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgImhpZGRlbiIgKTsKCQkJZWwuYXBwZW5kQ2hpbGQoIGlucHV0ICkuc2V0QXR0cmlidXRlKCAibmFtZSIsICJEIiApOwoKCQkJLy8gU3VwcG9ydDogSUU4CgkJCS8vIEVuZm9yY2UgY2FzZS1zZW5zaXRpdml0eSBvZiBuYW1lIGF0dHJpYnV0ZQoJCQlpZiAoIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPWRdIikubGVuZ3RoICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICJuYW1lIiArIHdoaXRlc3BhY2UgKyAiKlsqXiR8IX5dPz0iICk7CgkJCX0KCgkJCS8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCgkJCS8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggIT09IDIgKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsKCQkJfQoKCQkJLy8gU3VwcG9ydDogSUU5LTExKwoJCQkvLyBJRSdzIDpkaXNhYmxlZCBzZWxlY3RvciBkb2VzIG5vdCBwaWNrIHVwIHRoZSBjaGlsZHJlbiBvZiBkaXNhYmxlZCBmaWVsZHNldHMKCQkJZG9jRWxlbS5hcHBlbmRDaGlsZCggZWwgKS5kaXNhYmxlZCA9IHRydWU7CgkJCWlmICggZWwucXVlcnlTZWxlY3RvckFsbCgiOmRpc2FibGVkIikubGVuZ3RoICE9PSAyICkgewoJCQkJcmJ1Z2d5UVNBLnB1c2goICI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiICk7CgkJCX0KCgkJCS8vIE9wZXJhIDEwLTExIGRvZXMgbm90IHRocm93IG9uIHBvc3QtY29tbWEgaW52YWxpZCBwc2V1ZG9zCgkJCWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKCQkJcmJ1Z2d5UVNBLnB1c2goIiwuKjoiKTsKCQl9KTsKCX0KCglpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdCggKG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwKCQlkb2NFbGVtLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgoJCWFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgoJCQkvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQoJCQlzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoID0gbWF0Y2hlcy5jYWxsKCBlbCwgIioiICk7CgoJCQkvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCgkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJbWF0Y2hlcy5jYWxsKCBlbCwgIltzIT0nJ106eCIgKTsKCQkJcmJ1Z2d5TWF0Y2hlcy5wdXNoKCAiIT0iLCBwc2V1ZG9zICk7CgkJfSk7Cgl9CgoJcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lRU0Euam9pbigifCIpICk7CglyYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cCggcmJ1Z2d5TWF0Y2hlcy5qb2luKCJ8IikgKTsKCgkvKiBDb250YWlucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoJaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApOwoKCS8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgoJLy8gUHVycG9zZWZ1bGx5IHNlbGYtZXhjbHVzaXZlCgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgoJY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdCggZG9jRWxlbS5jb250YWlucyApID8KCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJCWJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKCQkJCWFkb3duLmNvbnRhaW5zID8KCQkJCQlhZG93bi5jb250YWlucyggYnVwICkgOgoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgoJCQkpKTsKCQl9IDoKCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJaWYgKCBiICkgewoJCQkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCQkJaWYgKCBiID09PSBhICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJLyogU29ydGluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKCXNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCS8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KCQl2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CgkJaWYgKCBjb21wYXJlICkgewoJCQlyZXR1cm4gY29tcGFyZTsKCQl9CgoJCS8vIENhbGN1bGF0ZSBwb3NpdGlvbiBpZiBib3RoIGlucHV0cyBiZWxvbmcgdG8gdGhlIHNhbWUgZG9jdW1lbnQKCQljb21wYXJlID0gKCBhLm93bmVyRG9jdW1lbnQgfHwgYSApID09PSAoIGIub3duZXJEb2N1bWVudCB8fCBiICkgPwoJCQlhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBiICkgOgoKCQkJLy8gT3RoZXJ3aXNlIHdlIGtub3cgdGhleSBhcmUgZGlzY29ubmVjdGVkCgkJCTE7CgoJCS8vIERpc2Nvbm5lY3RlZCBub2RlcwoJCWlmICggY29tcGFyZSAmIDEgfHwKCQkJKCFzdXBwb3J0LnNvcnREZXRhY2hlZCAmJiBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBhICkgPT09IGNvbXBhcmUpICkgewoKCQkJLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CgkJCWlmICggYSA9PT0gZG9jdW1lbnQgfHwgYS5vd25lckRvY3VtZW50ID09PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCQlpZiAoIGIgPT09IGRvY3VtZW50IHx8IGIub3duZXJEb2N1bWVudCA9PT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYikgKSB7CgkJCQlyZXR1cm4gMTsKCQkJfQoKCQkJLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKCQkJcmV0dXJuIHNvcnRJbnB1dCA/CgkJCQkoIGluZGV4T2YoIHNvcnRJbnB1dCwgYSApIC0gaW5kZXhPZiggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoJCX0KCgkJcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwoJfSA6CglmdW5jdGlvbiggYSwgYiApIHsKCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlhdXAgPSBhLnBhcmVudE5vZGUsCgkJCWJ1cCA9IGIucGFyZW50Tm9kZSwKCQkJYXAgPSBbIGEgXSwKCQkJYnAgPSBbIGIgXTsKCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKCQlpZiAoICFhdXAgfHwgIWJ1cCApIHsKCQkJcmV0dXJuIGEgPT09IGRvY3VtZW50ID8gLTEgOgoJCQkJYiA9PT0gZG9jdW1lbnQgPyAxIDoKCQkJCWF1cCA/IC0xIDoKCQkJCWJ1cCA/IDEgOgoJCQkJc29ydElucHV0ID8KCQkJCSggaW5kZXhPZiggc29ydElucHV0LCBhICkgLSBpbmRleE9mKCBzb3J0SW5wdXQsIGIgKSApIDoKCQkJCTA7CgoJCS8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MsIHdlIGNhbiBkbyBhIHF1aWNrIGNoZWNrCgkJfSBlbHNlIGlmICggYXVwID09PSBidXAgKSB7CgkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKCQl9CgoJCS8vIE90aGVyd2lzZSB3ZSBuZWVkIGZ1bGwgbGlzdHMgb2YgdGhlaXIgYW5jZXN0b3JzIGZvciBjb21wYXJpc29uCgkJY3VyID0gYTsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWFwLnVuc2hpZnQoIGN1ciApOwoJCX0KCQljdXIgPSBiOwoJCXdoaWxlICggKGN1ciA9IGN1ci5wYXJlbnROb2RlKSApIHsKCQkJYnAudW5zaGlmdCggY3VyICk7CgkJfQoKCQkvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQoJCXdoaWxlICggYXBbaV0gPT09IGJwW2ldICkgewoJCQlpKys7CgkJfQoKCQlyZXR1cm4gaSA/CgkJCS8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBicFtpXSApIDoKCgkJCS8vIE90aGVyd2lzZSBub2RlcyBpbiBvdXIgZG9jdW1lbnQgc29ydCBmaXJzdAoJCQlhcFtpXSA9PT0gcHJlZmVycmVkRG9jID8gLTEgOgoJCQlicFtpXSA9PT0gcHJlZmVycmVkRG9jID8gMSA6CgkJCTA7Cgl9OwoKCXJldHVybiBkb2N1bWVudDsKfTsKClNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1lbnRzICkgewoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMgKTsKfTsKClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWxlbSwgZXhwciApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBlbGVtICk7Cgl9CgoJLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCglleHByID0gZXhwci5yZXBsYWNlKCByYXR0cmlidXRlUXVvdGVzLCAiPSckMSddIiApOwoKCWlmICggc3VwcG9ydC5tYXRjaGVzU2VsZWN0b3IgJiYgZG9jdW1lbnRJc0hUTUwgJiYKCQkhY29tcGlsZXJDYWNoZVsgZXhwciArICIgIiBdICYmCgkJKCAhcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KCBleHByICkgKSAmJgoJCSggIXJidWdneVFTQSAgICAgfHwgIXJidWdneVFTQS50ZXN0KCBleHByICkgKSApIHsKCgkJdHJ5IHsKCQkJdmFyIHJldCA9IG1hdGNoZXMuY2FsbCggZWxlbSwgZXhwciApOwoKCQkJLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoJCQlpZiAoIHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8CgkJCQkJLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKCQkJCQkvLyBmcmFnbWVudCBpbiBJRSA5CgkJCQkJZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9IGNhdGNoIChlKSB7fQoJfQoKCXJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbIGVsZW0gXSApLmxlbmd0aCA+IDA7Cn07CgpTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiggY29udGV4dCwgZWxlbSApIHsKCS8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAoJaWYgKCAoIGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0ICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7Cgl9CglyZXR1cm4gY29udGFpbnMoIGNvbnRleHQsIGVsZW0gKTsKfTsKClNpenpsZS5hdHRyID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUgKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggZWxlbSApOwoJfQoKCXZhciBmbiA9IEV4cHIuYXR0ckhhbmRsZVsgbmFtZS50b0xvd2VyQ2FzZSgpIF0sCgkJLy8gRG9uJ3QgZ2V0IGZvb2xlZCBieSBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKGpRdWVyeSAjMTM4MDcpCgkJdmFsID0gZm4gJiYgaGFzT3duLmNhbGwoIEV4cHIuYXR0ckhhbmRsZSwgbmFtZS50b0xvd2VyQ2FzZSgpICkgPwoJCQlmbiggZWxlbSwgbmFtZSwgIWRvY3VtZW50SXNIVE1MICkgOgoJCQl1bmRlZmluZWQ7CgoJcmV0dXJuIHZhbCAhPT0gdW5kZWZpbmVkID8KCQl2YWwgOgoJCXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhZG9jdW1lbnRJc0hUTUwgPwoJCQllbGVtLmdldEF0dHJpYnV0ZSggbmFtZSApIDoKCQkJKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/CgkJCQl2YWwudmFsdWUgOgoJCQkJbnVsbDsKfTsKClNpenpsZS5lc2NhcGUgPSBmdW5jdGlvbiggc2VsICkgewoJcmV0dXJuIChzZWwgKyAiIikucmVwbGFjZSggcmNzc2VzY2FwZSwgZmNzc2VzY2FwZSApOwp9OwoKU2l6emxlLmVycm9yID0gZnVuY3Rpb24oIG1zZyApIHsKCXRocm93IG5ldyBFcnJvciggIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cgKTsKfTsKCi8qKgogKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAqIEBwYXJhbSB7QXJyYXlMaWtlfSByZXN1bHRzCiAqLwpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewoJdmFyIGVsZW0sCgkJZHVwbGljYXRlcyA9IFtdLAoJCWogPSAwLAoJCWkgPSAwOwoKCS8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKCWhhc0R1cGxpY2F0ZSA9ICFzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXM7Cglzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoIDAgKTsKCXJlc3VsdHMuc29ydCggc29ydE9yZGVyICk7CgoJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCWlmICggZWxlbSA9PT0gcmVzdWx0c1sgaSBdICkgewoJCQkJaiA9IGR1cGxpY2F0ZXMucHVzaCggaSApOwoJCQl9CgkJfQoJCXdoaWxlICggai0tICkgewoJCQlyZXN1bHRzLnNwbGljZSggZHVwbGljYXRlc1sgaiBdLCAxICk7CgkJfQoJfQoKCS8vIENsZWFyIGlucHV0IGFmdGVyIHNvcnRpbmcgdG8gcmVsZWFzZSBvYmplY3RzCgkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9zaXp6bGUvcHVsbC8yMjUKCXNvcnRJbnB1dCA9IG51bGw7CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwpnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoICFub2RlVHlwZSApIHsKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCXdoaWxlICggKG5vZGUgPSBlbGVtW2krK10pICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoalF1ZXJ5ICMxMTE1MykKCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJfSBlbHNlIHsKCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJfQoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCX0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKCXJldHVybiByZXQ7Cn07CgpFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgljcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKCgltYXRjaDogbWF0Y2hFeHByLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWZpbmQ6IHt9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFszXSB8fCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKCQkJCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNiB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50CgkJCQk4IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXS5zbGljZSggMCwgMyApID09PSAibnRoIiApIHsKCQkJCS8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFszXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs1XSA9ICsoICggbWF0Y2hbN10gKyBtYXRjaFs4XSApIHx8IG1hdGNoWzNdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzNdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGV4Y2VzcywKCQkJCXVucXVvdGVkID0gIW1hdGNoWzZdICYmIG1hdGNoWzJdOwoKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQkvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwoJCQlpZiAoIG1hdGNoWzNdICkgewoJCQkJbWF0Y2hbMl0gPSBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIjsKCgkJCS8vIFN0cmlwIGV4Y2VzcyBjaGFyYWN0ZXJzIGZyb20gdW5xdW90ZWQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIHVucXVvdGVkICYmIHJwc2V1ZG8udGVzdCggdW5xdW90ZWQgKSAmJgoJCQkJLy8gR2V0IGV4Y2VzcyBmcm9tIHRva2VuaXplIChyZWN1cnNpdmVseSkKCQkJCShleGNlc3MgPSB0b2tlbml6ZSggdW5xdW90ZWQsIHRydWUgKSkgJiYKCQkJCS8vIGFkdmFuY2UgdG8gdGhlIG5leHQgY2xvc2luZyBwYXJlbnRoZXNpcwoJCQkJKGV4Y2VzcyA9IHVucXVvdGVkLmluZGV4T2YoICIpIiwgdW5xdW90ZWQubGVuZ3RoIC0gZXhjZXNzICkgLSB1bnF1b3RlZC5sZW5ndGgpICkgewoKCQkJCS8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CgkJCQltYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwLCBleGNlc3MgKTsKCQkJCW1hdGNoWzJdID0gdW5xdW90ZWQuc2xpY2UoIDAsIGV4Y2VzcyApOwoJCQl9CgoJCQkvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCAzICk7CgkJfQoJfSwKCglmaWx0ZXI6IHsKCgkJIlRBRyI6IGZ1bmN0aW9uKCBub2RlTmFtZVNlbGVjdG9yICkgewoJCQl2YXIgbm9kZU5hbWUgPSBub2RlTmFtZVNlbGVjdG9yLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICkudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICIqIiA/CgkJCQlmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH0gOgoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZTsKCQkJCX07CgkJfSwKCgkJIkNMQVNTIjogZnVuY3Rpb24oIGNsYXNzTmFtZSApIHsKCQkJdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlWyBjbGFzc05hbWUgKyAiICIgXTsKCgkJCXJldHVybiBwYXR0ZXJuIHx8CgkJCQkocGF0dGVybiA9IG5ldyBSZWdFeHAoICIoXnwiICsgd2hpdGVzcGFjZSArICIpIiArIGNsYXNzTmFtZSArICIoIiArIHdoaXRlc3BhY2UgKyAifCQpIiApKSAmJgoJCQkJY2xhc3NDYWNoZSggY2xhc3NOYW1lLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gcGF0dGVybi50ZXN0KCB0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICJzdHJpbmciICYmIGVsZW0uY2xhc3NOYW1lIHx8IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIgKTsKCQkJCX0pOwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgkJCQlpZiAoICFvcGVyYXRvciApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXN1bHQgKz0gIiI7CgoJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgoJCQkJCW9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAifj0iID8gKCAiICIgKyByZXN1bHQucmVwbGFjZSggcndoaXRlc3BhY2UsICIgIiApICsgIiAiICkuaW5kZXhPZiggY2hlY2sgKSA+IC0xIDoKCQkJCQlvcGVyYXRvciA9PT0gInw9IiA/IHJlc3VsdCA9PT0gY2hlY2sgfHwgcmVzdWx0LnNsaWNlKCAwLCBjaGVjay5sZW5ndGggKyAxICkgPT09IGNoZWNrICsgIi0iIDoKCQkJCQlmYWxzZTsKCQkJfTsKCQl9LAoKCQkiQ0hJTEQiOiBmdW5jdGlvbiggdHlwZSwgd2hhdCwgYXJndW1lbnQsIGZpcnN0LCBsYXN0ICkgewoJCQl2YXIgc2ltcGxlID0gdHlwZS5zbGljZSggMCwgMyApICE9PSAibnRoIiwKCQkJCWZvcndhcmQgPSB0eXBlLnNsaWNlKCAtNCApICE9PSAibGFzdCIsCgkJCQlvZlR5cGUgPSB3aGF0ID09PSAib2YtdHlwZSI7CgoJCQlyZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/CgoJCQkJLy8gU2hvcnRjdXQgZm9yIDpudGgtKihuKQoJCQkJZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQkJcmV0dXJuICEhZWxlbS5wYXJlbnROb2RlOwoJCQkJfSA6CgoJCQkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJCQl2YXIgY2FjaGUsIHVuaXF1ZUNhY2hlLCBvdXRlckNhY2hlLCBub2RlLCBub2RlSW5kZXgsIHN0YXJ0LAoJCQkJCQlkaXIgPSBzaW1wbGUgIT09IGZvcndhcmQgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCgkJCQkJCXBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKCQkJCQkJbmFtZSA9IG9mVHlwZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJCXVzZUNhY2hlID0gIXhtbCAmJiAhb2ZUeXBlLAoJCQkJCQlkaWZmID0gZmFsc2U7CgoJCQkJCWlmICggcGFyZW50ICkgewoKCQkJCQkJLy8gOihmaXJzdHxsYXN0fG9ubHkpLShjaGlsZHxvZi10eXBlKQoJCQkJCQlpZiAoIHNpbXBsZSApIHsKCQkJCQkJCXdoaWxlICggZGlyICkgewoJCQkJCQkJCW5vZGUgPSBlbGVtOwoJCQkJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlWyBkaXIgXSkgKSB7CgkJCQkJCQkJCWlmICggb2ZUeXBlID8KCQkJCQkJCQkJCW5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6CgkJCQkJCQkJCQlub2RlLm5vZGVUeXBlID09PSAxICkgewoKCQkJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCQkvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKCQkJCQkJCQlzdGFydCA9IGRpciA9IHR5cGUgPT09ICJvbmx5IiAmJiAhc3RhcnQgJiYgIm5leHRTaWJsaW5nIjsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQl9CgoJCQkJCQlzdGFydCA9IFsgZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZCBdOwoKCQkJCQkJLy8gbm9uLXhtbCA6bnRoLWNoaWxkKC4uLikgc3RvcmVzIGNhY2hlIGRhdGEgb24gYHBhcmVudGAKCQkJCQkJaWYgKCBmb3J3YXJkICYmIHVzZUNhY2hlICkgewoKCQkJCQkJCS8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleAoKCQkJCQkJCS8vIC4uLmluIGEgZ3ppcC1mcmllbmRseSB3YXkKCQkJCQkJCW5vZGUgPSBwYXJlbnQ7CgkJCQkJCQlvdXRlckNhY2hlID0gbm9kZVsgZXhwYW5kbyBdIHx8IChub2RlWyBleHBhbmRvIF0gPSB7fSk7CgoJCQkJCQkJLy8gU3VwcG9ydDogSUUgPDkgb25seQoJCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCgkJCQkJCQl1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSB8fAoJCQkJCQkJCShvdXRlckNhY2hlWyBub2RlLnVuaXF1ZUlEIF0gPSB7fSk7CgoJCQkJCQkJY2FjaGUgPSB1bmlxdWVDYWNoZVsgdHlwZSBdIHx8IFtdOwoJCQkJCQkJbm9kZUluZGV4ID0gY2FjaGVbIDAgXSA9PT0gZGlycnVucyAmJiBjYWNoZVsgMSBdOwoJCQkJCQkJZGlmZiA9IG5vZGVJbmRleCAmJiBjYWNoZVsgMiBdOwoJCQkJCQkJbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCgkJCQkJCQkJLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJLy8gV2hlbiBmb3VuZCwgY2FjaGUgaW5kZXhlcyBvbiBgcGFyZW50YCBhbmQgYnJlYWsKCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCXVuaXF1ZUNhY2hlWyB0eXBlIF0gPSBbIGRpcnJ1bnMsIG5vZGVJbmRleCwgZGlmZiBdOwoJCQkJCQkJCQlicmVhazsKCQkJCQkJCQl9CgkJCQkJCQl9CgoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gVXNlIHByZXZpb3VzbHktY2FjaGVkIGVsZW1lbnQgaW5kZXggaWYgYXZhaWxhYmxlCgkJCQkJCQlpZiAoIHVzZUNhY2hlICkgewoJCQkJCQkJCS8vIC4uLmluIGEgZ3ppcC1mcmllbmRseSB3YXkKCQkJCQkJCQlub2RlID0gZWxlbTsKCQkJCQkJCQlvdXRlckNhY2hlID0gbm9kZVsgZXhwYW5kbyBdIHx8IChub2RlWyBleHBhbmRvIF0gPSB7fSk7CgoJCQkJCQkJCS8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKCQkJCQkJCQkvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkKCQkJCQkJCQl1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSB8fAoJCQkJCQkJCQkob3V0ZXJDYWNoZVsgbm9kZS51bmlxdWVJRCBdID0ge30pOwoKCQkJCQkJCQljYWNoZSA9IHVuaXF1ZUNhY2hlWyB0eXBlIF0gfHwgW107CgkJCQkJCQkJbm9kZUluZGV4ID0gY2FjaGVbIDAgXSA9PT0gZGlycnVucyAmJiBjYWNoZVsgMSBdOwoJCQkJCQkJCWRpZmYgPSBub2RlSW5kZXg7CgkJCQkJCQl9CgoJCQkJCQkJLy8geG1sIDpudGgtY2hpbGQoLi4uKQoJCQkJCQkJLy8gb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQoJCQkJCQkJaWYgKCBkaWZmID09PSBmYWxzZSApIHsKCQkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydAoJCQkJCQkJCXdoaWxlICggKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbIGRpciBdIHx8CgkJCQkJCQkJCShkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpICkgewoKCQkJCQkJCQkJaWYgKCAoIG9mVHlwZSA/CgkJCQkJCQkJCQlub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOgoJCQkJCQkJCQkJbm9kZS5ub2RlVHlwZSA9PT0gMSApICYmCgkJCQkJCQkJCQkrK2RpZmYgKSB7CgoJCQkJCQkJCQkJLy8gQ2FjaGUgdGhlIGluZGV4IG9mIGVhY2ggZW5jb3VudGVyZWQgZWxlbWVudAoJCQkJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsKCQkJCQkJCQkJCQlvdXRlckNhY2hlID0gbm9kZVsgZXhwYW5kbyBdIHx8IChub2RlWyBleHBhbmRvIF0gPSB7fSk7CgoJCQkJCQkJCQkJCS8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKCQkJCQkJCQkJCQkvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkKCQkJCQkJCQkJCQl1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbIG5vZGUudW5pcXVlSUQgXSB8fAoJCQkJCQkJCQkJCQkob3V0ZXJDYWNoZVsgbm9kZS51bmlxdWVJRCBdID0ge30pOwoKCQkJCQkJCQkJCQl1bmlxdWVDYWNoZVsgdHlwZSBdID0gWyBkaXJydW5zLCBkaWZmIF07CgkJCQkJCQkJCQl9CgoJCQkJCQkJCQkJaWYgKCBub2RlID09PSBlbGVtICkgewoJCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQkJfQoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQkvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQoJCQkJCQlkaWZmIC09IGxhc3Q7CgkJCQkJCXJldHVybiBkaWZmID09PSBmaXJzdCB8fCAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwoJCQkJCX0KCQkJCX07CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBwc2V1ZG8sIGFyZ3VtZW50ICkgewoJCQkvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNwc2V1ZG8tY2xhc3NlcwoJCQkvLyBQcmlvcml0aXplIGJ5IGNhc2Ugc2Vuc2l0aXZpdHkgaW4gY2FzZSBjdXN0b20gcHNldWRvcyBhcmUgYWRkZWQgd2l0aCB1cHBlcmNhc2UgbGV0dGVycwoJCQkvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zCgkJCXZhciBhcmdzLAoJCQkJZm4gPSBFeHByLnBzZXVkb3NbIHBzZXVkbyBdIHx8IEV4cHIuc2V0RmlsdGVyc1sgcHNldWRvLnRvTG93ZXJDYXNlKCkgXSB8fAoJCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIHBzZXVkbzogIiArIHBzZXVkbyApOwoKCQkJLy8gVGhlIHVzZXIgbWF5IHVzZSBjcmVhdGVQc2V1ZG8gdG8gaW5kaWNhdGUgdGhhdAoJCQkvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbgoJCQkvLyBqdXN0IGFzIFNpenpsZSBkb2VzCgkJCWlmICggZm5bIGV4cGFuZG8gXSApIHsKCQkJCXJldHVybiBmbiggYXJndW1lbnQgKTsKCQkJfQoKCQkJLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzCgkJCWlmICggZm4ubGVuZ3RoID4gMSApIHsKCQkJCWFyZ3MgPSBbIHBzZXVkbywgcHNldWRvLCAiIiwgYXJndW1lbnQgXTsKCQkJCXJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkoIHBzZXVkby50b0xvd2VyQ2FzZSgpICkgPwoJCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcyApIHsKCQkJCQkJdmFyIGlkeCwKCQkJCQkJCW1hdGNoZWQgPSBmbiggc2VlZCwgYXJndW1lbnQgKSwKCQkJCQkJCWkgPSBtYXRjaGVkLmxlbmd0aDsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZHggPSBpbmRleE9mKCBzZWVkLCBtYXRjaGVkW2ldICk7CgkJCQkJCQlzZWVkWyBpZHggXSA9ICEoIG1hdGNoZXNbIGlkeCBdID0gbWF0Y2hlZFtpXSApOwoJCQkJCQl9CgkJCQkJfSkgOgoJCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsKCQkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZm47CgkJfQoJfSwKCglwc2V1ZG9zOiB7CgkJLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zCgkJIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgaW5wdXQgPSBbXSwKCQkJCXJlc3VsdHMgPSBbXSwKCQkJCW1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApICk7CgoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8KCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksCgkJCQkJCWkgPSBzZWVkLmxlbmd0aDsKCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pIDoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJaW5wdXRbMF0gPSBlbGVtOwoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKCQkJCQkvLyBEb24ndCBrZWVwIHRoZSBlbGVtZW50IChpc3N1ZSAjMjk5KQoJCQkJCWlucHV0WzBdID0gbnVsbDsKCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7CgkJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXRleHQgPSB0ZXh0LnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCS8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCgkJLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKCQkvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAoJCS8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgoJCS8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgoJCS8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgoJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KCQkibGFuZyI6IG1hcmtGdW5jdGlvbiggZnVuY3Rpb24oIGxhbmcgKSB7CgkJCS8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKCQkJaWYgKCAhcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSApIHsKCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CgkJCX0KCQkJbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgZWxlbUxhbmc7CgkJCQlkbyB7CgkJCQkJaWYgKCAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/CgkJCQkJCWVsZW0ubGFuZyA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikpICkgewoKCQkJCQkJZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwoJCQkJCQlyZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwoJCQkJCX0KCQkJCX0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9OwoJCX0pLAoKCQkvLyBNaXNjZWxsYW5lb3VzCgkJInRhcmdldCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOwoJCX0sCgoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBkb2NFbGVtOwoJCX0sCgoJCSJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwoJCX0sCgoJCS8vIEJvb2xlYW4gcHJvcGVydGllcwoJCSJlbmFibGVkIjogY3JlYXRlRGlzYWJsZWRQc2V1ZG8oIGZhbHNlICksCgkJImRpc2FibGVkIjogY3JlYXRlRGlzYWJsZWRQc2V1ZG8oIHRydWUgKSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gQ29udGVudHMKCQkiZW1wdHkiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KCQkJLy8gOmVtcHR5IGlzIG5lZ2F0ZWQgYnkgZWxlbWVudCAoMSkgb3IgY29udGVudCBub2RlcyAodGV4dDogMzsgY2RhdGE6IDQ7IGVudGl0eSByZWY6IDUpLAoJCQkvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQoJCQkvLyBub2RlVHlwZSA8IDYgd29ya3MgYmVjYXVzZSBhdHRyaWJ1dGVzICgyKSBkbyBub3QgYXBwZWFyIGFzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlIDwgNiApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCS8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiaW5wdXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJpbnB1dHMudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGF0dHI7CgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYKCQkJCWVsZW0udHlwZSA9PT0gInRleHQiICYmCgoJCQkJLy8gU3VwcG9ydDogSUU8OAoJCQkJLy8gTmV3IEhUTUw1IGF0dHJpYnV0ZSB2YWx1ZXMgKGUuZy4sICJzZWFyY2giKSBhcHBlYXIgd2l0aCBlbGVtLnR5cGUgPT09ICJ0ZXh0IgoJCQkJKCAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSAidGV4dCIgKTsKCQl9LAoKCQkvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCgkJImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbigpIHsKCQkJcmV0dXJuIFsgMCBdOwoJCX0pLAoKCQkibGFzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQlyZXR1cm4gWyBsZW5ndGggLSAxIF07CgkJfSksCgoJCSJlcSI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJcmV0dXJuIFsgYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudCBdOwoJCX0pLAoKCQkiZXZlbiI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDA7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkib2RkIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGggKSB7CgkJCXZhciBpID0gMTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpICs9IDIgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJsdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwoJCQlmb3IgKCA7IC0taSA+PSAwOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiggbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50ICkgewoJCQl2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CgkJCWZvciAoIDsgKytpIDwgbGVuZ3RoOyApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KQoJfQp9OwoKRXhwci5wc2V1ZG9zWyJudGgiXSA9IEV4cHIucHNldWRvc1siZXEiXTsKCi8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCmZvciAoIGkgaW4geyByYWRpbzogdHJ1ZSwgY2hlY2tib3g6IHRydWUsIGZpbGU6IHRydWUsIHBhc3N3b3JkOiB0cnVlLCBpbWFnZTogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVJbnB1dFBzZXVkbyggaSApOwp9CmZvciAoIGkgaW4geyBzdWJtaXQ6IHRydWUsIHJlc2V0OiB0cnVlIH0gKSB7CglFeHByLnBzZXVkb3NbIGkgXSA9IGNyZWF0ZUJ1dHRvblBzZXVkbyggaSApOwp9CgovLyBFYXN5IEFQSSBmb3IgY3JlYXRpbmcgbmV3IHNldEZpbHRlcnMKZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CnNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOwpFeHByLnNldEZpbHRlcnMgPSBuZXcgc2V0RmlsdGVycygpOwoKdG9rZW5pemUgPSBTaXp6bGUudG9rZW5pemUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIHBhcnNlT25seSApIHsKCXZhciBtYXRjaGVkLCBtYXRjaCwgdG9rZW5zLCB0eXBlLAoJCXNvRmFyLCBncm91cHMsIHByZUZpbHRlcnMsCgkJY2FjaGVkID0gdG9rZW5DYWNoZVsgc2VsZWN0b3IgKyAiICIgXTsKCglpZiAoIGNhY2hlZCApIHsKCQlyZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSggMCApOwoJfQoKCXNvRmFyID0gc2VsZWN0b3I7Cglncm91cHMgPSBbXTsKCXByZUZpbHRlcnMgPSBFeHByLnByZUZpbHRlcjsKCgl3aGlsZSAoIHNvRmFyICkgewoKCQkvLyBDb21tYSBhbmQgZmlyc3QgcnVuCgkJaWYgKCAhbWF0Y2hlZCB8fCAobWF0Y2ggPSByY29tbWEuZXhlYyggc29GYXIgKSkgKSB7CgkJCWlmICggbWF0Y2ggKSB7CgkJCQkvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAoJCQkJc29GYXIgPSBzb0Zhci5zbGljZSggbWF0Y2hbMF0ubGVuZ3RoICkgfHwgc29GYXI7CgkJCX0KCQkJZ3JvdXBzLnB1c2goICh0b2tlbnMgPSBbXSkgKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCXRva2Vucy5wdXNoKHsKCQkJCXZhbHVlOiBtYXRjaGVkLAoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQl0eXBlOiBtYXRjaFswXS5yZXBsYWNlKCBydHJpbSwgIiAiICkKCQkJfSk7CgkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJfQoKCQkvLyBGaWx0ZXJzCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKCQkJCXRva2Vucy5wdXNoKHsKCQkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCQl0eXBlOiB0eXBlLAoJCQkJCW1hdGNoZXM6IG1hdGNoCgkJCQl9KTsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJCX0KCQl9CgoJCWlmICggIW1hdGNoZWQgKSB7CgkJCWJyZWFrOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwoJLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCglyZXR1cm4gcGFyc2VPbmx5ID8KCQlzb0Zhci5sZW5ndGggOgoJCXNvRmFyID8KCQkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKCQkJLy8gQ2FjaGUgdGhlIHRva2VucwoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfTsKCmZ1bmN0aW9uIHRvU2VsZWN0b3IoIHRva2VucyApIHsKCXZhciBpID0gMCwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCXNlbGVjdG9yID0gIiI7Cglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlzZWxlY3RvciArPSB0b2tlbnNbaV0udmFsdWU7Cgl9CglyZXR1cm4gc2VsZWN0b3I7Cn0KCmZ1bmN0aW9uIGFkZENvbWJpbmF0b3IoIG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UgKSB7Cgl2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCgkJc2tpcCA9IGNvbWJpbmF0b3IubmV4dCwKCQlrZXkgPSBza2lwIHx8IGRpciwKCQljaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBrZXkgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfSA6CgoJCS8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwoJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCXZhciBvbGRDYWNoZSwgdW5pcXVlQ2FjaGUsIG91dGVyQ2FjaGUsCgkJCQluZXdDYWNoZSA9IFsgZGlycnVucywgZG9uZU5hbWUgXTsKCgkJCS8vIFdlIGNhbid0IHNldCBhcmJpdHJhcnkgZGF0YSBvbiBYTUwgbm9kZXMsIHNvIHRoZXkgZG9uJ3QgYmVuZWZpdCBmcm9tIGNvbWJpbmF0b3IgY2FjaGluZwoJCQlpZiAoIHhtbCApIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCW91dGVyQ2FjaGUgPSBlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KTsKCgkJCQkJCS8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKCQkJCQkJLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCgkJCQkJCXVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVsgZWxlbS51bmlxdWVJRCBdIHx8IChvdXRlckNhY2hlWyBlbGVtLnVuaXF1ZUlEIF0gPSB7fSk7CgoJCQkJCQlpZiAoIHNraXAgJiYgc2tpcCA9PT0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICkgewoJCQkJCQkJZWxlbSA9IGVsZW1bIGRpciBdIHx8IGVsZW07CgkJCQkJCX0gZWxzZSBpZiAoIChvbGRDYWNoZSA9IHVuaXF1ZUNhY2hlWyBrZXkgXSkgJiYKCQkJCQkJCW9sZENhY2hlWyAwIF0gPT09IGRpcnJ1bnMgJiYgb2xkQ2FjaGVbIDEgXSA9PT0gZG9uZU5hbWUgKSB7CgoJCQkJCQkJLy8gQXNzaWduIHRvIG5ld0NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKCQkJCQkJCXJldHVybiAobmV3Q2FjaGVbIDIgXSA9IG9sZENhY2hlWyAyIF0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwoJCQkJCQkJdW5pcXVlQ2FjaGVbIGtleSBdID0gbmV3Q2FjaGU7CgoJCQkJCQkJLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCgkJCQkJCQlpZiAoIChuZXdDYWNoZVsgMiBdID0gbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkpICkgewoJCQkJCQkJCXJldHVybiB0cnVlOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9Owp9CgpmdW5jdGlvbiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSB7CglyZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJdmFyIGkgPSBtYXRjaGVycy5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAhbWF0Y2hlcnNbaV0oIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9IDoKCQltYXRjaGVyc1swXTsKfQoKZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyggc2VsZWN0b3IsIGNvbnRleHRzLCByZXN1bHRzICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGNvbnRleHRzLmxlbmd0aDsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCVNpenpsZSggc2VsZWN0b3IsIGNvbnRleHRzW2ldLCByZXN1bHRzICk7Cgl9CglyZXR1cm4gcmVzdWx0czsKfQoKZnVuY3Rpb24gY29uZGVuc2UoIHVubWF0Y2hlZCwgbWFwLCBmaWx0ZXIsIGNvbnRleHQsIHhtbCApIHsKCXZhciBlbGVtLAoJCW5ld1VubWF0Y2hlZCA9IFtdLAoJCWkgPSAwLAoJCWxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCgkJbWFwcGVkID0gbWFwICE9IG51bGw7CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgKSB7CgkJCWlmICggIWZpbHRlciB8fCBmaWx0ZXIoIGVsZW0sIGNvbnRleHQsIHhtbCApICkgewoJCQkJbmV3VW5tYXRjaGVkLnB1c2goIGVsZW0gKTsKCQkJCWlmICggbWFwcGVkICkgewoJCQkJCW1hcC5wdXNoKCBpICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIG5ld1VubWF0Y2hlZDsKfQoKZnVuY3Rpb24gc2V0TWF0Y2hlciggcHJlRmlsdGVyLCBzZWxlY3RvciwgbWF0Y2hlciwgcG9zdEZpbHRlciwgcG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yICkgewoJaWYgKCBwb3N0RmlsdGVyICYmICFwb3N0RmlsdGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbHRlciA9IHNldE1hdGNoZXIoIHBvc3RGaWx0ZXIgKTsKCX0KCWlmICggcG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlclsgZXhwYW5kbyBdICkgewoJCXBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKTsKCX0KCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIHJlc3VsdHMsIGNvbnRleHQsIHhtbCApIHsKCQl2YXIgdGVtcCwgaSwgZWxlbSwKCQkJcHJlTWFwID0gW10sCgkJCXBvc3RNYXAgPSBbXSwKCQkJcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKCgkJCS8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CgkJCWVsZW1zID0gc2VlZCB8fCBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciB8fCAiKiIsIGNvbnRleHQubm9kZVR5cGUgPyBbIGNvbnRleHQgXSA6IGNvbnRleHQsIFtdICksCgoJCQkvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KCQkJbWF0Y2hlckluID0gcHJlRmlsdGVyICYmICggc2VlZCB8fCAhc2VsZWN0b3IgKSA/CgkJCQljb25kZW5zZSggZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwgKSA6CgkJCQllbGVtcywKCgkJCW1hdGNoZXJPdXQgPSBtYXRjaGVyID8KCQkJCS8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCgkJCQlwb3N0RmluZGVyIHx8ICggc2VlZCA/IHByZUZpbHRlciA6IHByZWV4aXN0aW5nIHx8IHBvc3RGaWx0ZXIgKSA/CgoJCQkJCS8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQoJCQkJCVtdIDoKCgkJCQkJLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CgkJCQkJcmVzdWx0cyA6CgkJCQltYXRjaGVySW47CgoJCS8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCgkJaWYgKCBtYXRjaGVyICkgewoJCQltYXRjaGVyKCBtYXRjaGVySW4sIG1hdGNoZXJPdXQsIGNvbnRleHQsIHhtbCApOwoJCX0KCgkJLy8gQXBwbHkgcG9zdEZpbHRlcgoJCWlmICggcG9zdEZpbHRlciApIHsKCQkJdGVtcCA9IGNvbmRlbnNlKCBtYXRjaGVyT3V0LCBwb3N0TWFwICk7CgkJCXBvc3RGaWx0ZXIoIHRlbXAsIFtdLCBjb250ZXh0LCB4bWwgKTsKCgkJCS8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KCQkJaSA9IHRlbXAubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWlmICggKGVsZW0gPSB0ZW1wW2ldKSApIHsKCQkJCQltYXRjaGVyT3V0WyBwb3N0TWFwW2ldIF0gPSAhKG1hdGNoZXJJblsgcG9zdE1hcFtpXSBdID0gZWxlbSk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggc2VlZCApIHsKCQkJaWYgKCBwb3N0RmluZGVyIHx8IHByZUZpbHRlciApIHsKCQkJCWlmICggcG9zdEZpbmRlciApIHsKCQkJCQkvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKCQkJCQl0ZW1wID0gW107CgkJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gbWF0Y2hlck91dFtpXSkgKSB7CgkJCQkJCQkvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAoJCQkJCQkJdGVtcC5wdXNoKCAobWF0Y2hlckluW2ldID0gZWxlbSkgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlwb3N0RmluZGVyKCBudWxsLCAobWF0Y2hlck91dCA9IFtdKSwgdGVtcCwgeG1sICk7CgkJCQl9CgoJCQkJLy8gTW92ZSBtYXRjaGVkIGVsZW1lbnRzIGZyb20gc2VlZCB0byByZXN1bHRzIHRvIGtlZXAgdGhlbSBzeW5jaHJvbml6ZWQKCQkJCWkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSAmJgoJCQkJCQkodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mKCBzZWVkLCBlbGVtICkgOiBwcmVNYXBbaV0pID4gLTEgKSB7CgoJCQkJCQlzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEFkZCBlbGVtZW50cyB0byByZXN1bHRzLCB0aHJvdWdoIHBvc3RGaW5kZXIgaWYgZGVmaW5lZAoJCX0gZWxzZSB7CgkJCW1hdGNoZXJPdXQgPSBjb25kZW5zZSgKCQkJCW1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPwoJCQkJCW1hdGNoZXJPdXQuc3BsaWNlKCBwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGggKSA6CgkJCQkJbWF0Y2hlck91dAoJCQkpOwoJCQlpZiAoIHBvc3RGaW5kZXIgKSB7CgkJCQlwb3N0RmluZGVyKCBudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIG1hdGNoZXJPdXQgKTsKCQkJfQoJCX0KCX0pOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zICkgewoJdmFyIGNoZWNrQ29udGV4dCwgbWF0Y2hlciwgaiwKCQlsZW4gPSB0b2tlbnMubGVuZ3RoLAoJCWxlYWRpbmdSZWxhdGl2ZSA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1swXS50eXBlIF0sCgkJaW1wbGljaXRSZWxhdGl2ZSA9IGxlYWRpbmdSZWxhdGl2ZSB8fCBFeHByLnJlbGF0aXZlWyIgIl0sCgkJaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAoKCQkvLyBUaGUgZm91bmRhdGlvbmFsIG1hdGNoZXIgZW5zdXJlcyB0aGF0IGVsZW1lbnRzIGFyZSByZWFjaGFibGUgZnJvbSB0b3AtbGV2ZWwgY29udGV4dChzKQoJCW1hdGNoQ29udGV4dCA9IGFkZENvbWJpbmF0b3IoIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwoJCX0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUgKSwKCQltYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGluZGV4T2YoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgcmV0ID0gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCQkvLyBBdm9pZCBoYW5naW5nIG9udG8gZWxlbWVudCAoaXNzdWUgIzI5OSkKCQkJY2hlY2tDb250ZXh0ID0gbnVsbDsKCQkJcmV0dXJuIHJldDsKCQl9IF07CgoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJaWYgKCAobWF0Y2hlciA9IEV4cHIucmVsYXRpdmVbIHRva2Vuc1tpXS50eXBlIF0pICkgewoJCQltYXRjaGVycyA9IFsgYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwgbWF0Y2hlcikgXTsKCQl9IGVsc2UgewoJCQltYXRjaGVyID0gRXhwci5maWx0ZXJbIHRva2Vuc1tpXS50eXBlIF0uYXBwbHkoIG51bGwsIHRva2Vuc1tpXS5tYXRjaGVzICk7CgoJCQkvLyBSZXR1cm4gc3BlY2lhbCB1cG9uIHNlZWluZyBhIHBvc2l0aW9uYWwgbWF0Y2hlcgoJCQlpZiAoIG1hdGNoZXJbIGV4cGFuZG8gXSApIHsKCQkJCS8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwoJCQkJaiA9ICsraTsKCQkJCWZvciAoIDsgaiA8IGxlbjsgaisrICkgewoJCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2pdLnR5cGUgXSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIHNldE1hdGNoZXIoCgkJCQkJaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIoIG1hdGNoZXJzICksCgkJCQkJaSA+IDEgJiYgdG9TZWxlY3RvcigKCQkJCQkJLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKCQkJCQkJdG9rZW5zLnNsaWNlKCAwLCBpIC0gMSApLmNvbmNhdCh7IHZhbHVlOiB0b2tlbnNbIGkgLSAyIF0udHlwZSA9PT0gIiAiID8gIioiIDogIiIgfSkKCQkJCQkpLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksCgkJCQkJbWF0Y2hlciwKCQkJCQlpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2VucyggdG9rZW5zLnNsaWNlKCBpLCBqICkgKSwKCQkJCQlqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKCAodG9rZW5zID0gdG9rZW5zLnNsaWNlKCBqICkpICksCgkJCQkJaiA8IGxlbiAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKQoJCQkJKTsKCQkJfQoJCQltYXRjaGVycy5wdXNoKCBtYXRjaGVyICk7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgewoJdmFyIGJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QgKSB7CgkJCXZhciBlbGVtLCBqLCBtYXRjaGVyLAoJCQkJbWF0Y2hlZENvdW50ID0gMCwKCQkJCWkgPSAiMCIsCgkJCQl1bm1hdGNoZWQgPSBzZWVkICYmIFtdLAoJCQkJc2V0TWF0Y2hlZCA9IFtdLAoJCQkJY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCgkJCQkvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgb3V0ZXJtb3N0ICksCgkJCQkvLyBVc2UgaW50ZWdlciBkaXJydW5zIGlmZiB0aGlzIGlzIHRoZSBvdXRlcm1vc3QgbWF0Y2hlcgoJCQkJZGlycnVuc1VuaXF1ZSA9IChkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSksCgkJCQlsZW4gPSBlbGVtcy5sZW5ndGg7CgoJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0ID09PSBkb2N1bWVudCB8fCBjb250ZXh0IHx8IG91dGVybW9zdDsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCgkJCS8vIFRvbGVyYXRlIE5vZGVMaXN0IHByb3BlcnRpZXMgKElFOiAibGVuZ3RoIjsgU2FmYXJpOiA8bnVtYmVyPikgbWF0Y2hpbmcgZWxlbWVudHMgYnkgaWQKCQkJZm9yICggOyBpICE9PSBsZW4gJiYgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBieUVsZW1lbnQgJiYgZWxlbSApIHsKCQkJCQlqID0gMDsKCQkJCQlpZiAoICFjb250ZXh0ICYmIGVsZW0ub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQgKSB7CgkJCQkJCXNldERvY3VtZW50KCBlbGVtICk7CgkJCQkJCXhtbCA9ICFkb2N1bWVudElzSFRNTDsKCQkJCQl9CgkJCQkJd2hpbGUgKCAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0IHx8IGRvY3VtZW50LCB4bWwpICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG91dGVybW9zdCApIHsKCQkJCQkJZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFRyYWNrIHVubWF0Y2hlZCBlbGVtZW50cyBmb3Igc2V0IGZpbHRlcnMKCQkJCWlmICggYnlTZXQgKSB7CgkJCQkJLy8gVGhleSB3aWxsIGhhdmUgZ29uZSB0aHJvdWdoIGFsbCBwb3NzaWJsZSBtYXRjaGVycwoJCQkJCWlmICggKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSApIHsKCQkJCQkJbWF0Y2hlZENvdW50LS07CgkJCQkJfQoKCQkJCQkvLyBMZW5ndGhlbiB0aGUgYXJyYXkgZm9yIGV2ZXJ5IGVsZW1lbnQsIG1hdGNoZWQgb3Igbm90CgkJCQkJaWYgKCBzZWVkICkgewoJCQkJCQl1bm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gYGlgIGlzIG5vdyB0aGUgY291bnQgb2YgZWxlbWVudHMgdmlzaXRlZCBhYm92ZSwgYW5kIGFkZGluZyBpdCB0byBgbWF0Y2hlZENvdW50YAoJCQkvLyBtYWtlcyB0aGUgbGF0dGVyIG5vbm5lZ2F0aXZlLgoJCQltYXRjaGVkQ291bnQgKz0gaTsKCgkJCS8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwoJCQkvLyBOT1RFOiBUaGlzIGNhbiBiZSBza2lwcGVkIGlmIHRoZXJlIGFyZSBubyB1bm1hdGNoZWQgZWxlbWVudHMgKGkuZS4sIGBtYXRjaGVkQ291bnRgCgkJCS8vIGVxdWFscyBgaWApLCB1bmxlc3Mgd2UgZGlkbid0IHZpc2l0IF9hbnlfIGVsZW1lbnRzIGluIHRoZSBhYm92ZSBsb29wIGJlY2F1c2Ugd2UgaGF2ZQoJCQkvLyBubyBlbGVtZW50IG1hdGNoZXJzIGFuZCBubyBzZWVkLgoJCQkvLyBJbmNyZW1lbnRpbmcgYW4gaW5pdGlhbGx5LXN0cmluZyAiMCIgYGlgIGFsbG93cyBgaWAgdG8gcmVtYWluIGEgc3RyaW5nIG9ubHkgaW4gdGhhdAoJCQkvLyBjYXNlLCB3aGljaCB3aWxsIHJlc3VsdCBpbiBhICIwMCIgYG1hdGNoZWRDb3VudGAgdGhhdCBkaWZmZXJzIGZyb20gYGlgIGJ1dCBpcyBhbHNvCgkJCS8vIG51bWVyaWNhbGx5IHplcm8uCgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCgkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZiAoICEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pICkgewoJCQkJCQkJCXNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwoJCQkJCXNldE1hdGNoZWQgPSBjb25kZW5zZSggc2V0TWF0Y2hlZCApOwoJCQkJfQoKCQkJCS8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsKCgkJCQkvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgoJCQkJCSggbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoICkgPiAxICkgewoKCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwoJCQl9CgoJCQlyZXR1cm4gdW5tYXRjaGVkOwoJCX07CgoJcmV0dXJuIGJ5U2V0ID8KCQltYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKCQlzdXBlck1hdGNoZXI7Cn0KCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgbWF0Y2ggLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7Cgl2YXIgaSwKCQlzZXRNYXRjaGVycyA9IFtdLAoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCAhY2FjaGVkICkgewoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJCWlmICggIW1hdGNoICkgewoJCQltYXRjaCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoJCX0KCQlpID0gbWF0Y2gubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggbWF0Y2hbaV0gKTsKCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsKCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9CgkJfQoKCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KCQljYWNoZWQgPSBjb21waWxlckNhY2hlKCBzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgKTsKCgkJLy8gU2F2ZSBzZWxlY3RvciBhbmQgdG9rZW5pemF0aW9uCgkJY2FjaGVkLnNlbGVjdG9yID0gc2VsZWN0b3I7Cgl9CglyZXR1cm4gY2FjaGVkOwp9OwoKLyoqCiAqIEEgbG93LWxldmVsIHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IHdvcmtzIHdpdGggU2l6emxlJ3MgY29tcGlsZWQKICogIHNlbGVjdG9yIGZ1bmN0aW9ucwogKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogKiAgc2VsZWN0b3IgZnVuY3Rpb24gYnVpbHQgd2l0aCBTaXp6bGUuY29tcGlsZQogKiBAcGFyYW0ge0VsZW1lbnR9IGNvbnRleHQKICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAqIEBwYXJhbSB7QXJyYXl9IFtzZWVkXSBBIHNldCBvZiBlbGVtZW50cyB0byBtYXRjaCBhZ2FpbnN0CiAqLwpzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgJiYgc2VsZWN0b3IsCgkJbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZSggKHNlbGVjdG9yID0gY29tcGlsZWQuc2VsZWN0b3IgfHwgc2VsZWN0b3IpICk7CgoJcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgoJLy8gVHJ5IHRvIG1pbmltaXplIG9wZXJhdGlvbnMgaWYgdGhlcmUgaXMgb25seSBvbmUgc2VsZWN0b3IgaW4gdGhlIGxpc3QgYW5kIG5vIHNlZWQKCS8vICh0aGUgbGF0dGVyIG9mIHdoaWNoIGd1YXJhbnRlZXMgdXMgY29udGV4dCkKCWlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoKCQkvLyBSZWR1Y2UgY29udGV4dCBpZiB0aGUgbGVhZGluZyBjb21wb3VuZCBzZWxlY3RvciBpcyBhbiBJRAoJCXRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAgKTsKCQlpZiAoIHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJgoJCQkJY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiBkb2N1bWVudElzSFRNTCAmJiBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgewoKCQkJY29udGV4dCA9ICggRXhwci5maW5kWyJJRCJdKCB0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLCBjb250ZXh0ICkgfHwgW10gKVswXTsKCQkJaWYgKCAhY29udGV4dCApIHsKCQkJCXJldHVybiByZXN1bHRzOwoKCQkJLy8gUHJlY29tcGlsZWQgbWF0Y2hlcnMgd2lsbCBzdGlsbCB2ZXJpZnkgYW5jZXN0cnksIHNvIHN0ZXAgdXAgYSBsZXZlbAoJCQl9IGVsc2UgaWYgKCBjb21waWxlZCApIHsKCQkJCWNvbnRleHQgPSBjb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UoIHRva2Vucy5zaGlmdCgpLnZhbHVlLmxlbmd0aCApOwoJCX0KCgkJLy8gRmV0Y2ggYSBzZWVkIHNldCBmb3IgcmlnaHQtdG8tbGVmdCBtYXRjaGluZwoJCWkgPSBtYXRjaEV4cHJbIm5lZWRzQ29udGV4dCJdLnRlc3QoIHNlbGVjdG9yICkgPyAwIDogdG9rZW5zLmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJdG9rZW4gPSB0b2tlbnNbaV07CgoJCQkvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCgkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKCQkJCS8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwoJCQkJaWYgKCAoc2VlZCA9IGZpbmQoCgkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLAoJCQkJCXJzaWJsaW5nLnRlc3QoIHRva2Vuc1swXS50eXBlICkgJiYgdGVzdENvbnRleHQoIGNvbnRleHQucGFyZW50Tm9kZSApIHx8IGNvbnRleHQKCQkJCSkpICkgewoKCQkJCQkvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKCQkJCQl0b2tlbnMuc3BsaWNlKCBpLCAxICk7CgkJCQkJc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKCB0b2tlbnMgKTsKCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgc2VlZCApOwoJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQl9CgoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIENvbXBpbGUgYW5kIGV4ZWN1dGUgYSBmaWx0ZXJpbmcgZnVuY3Rpb24gaWYgb25lIGlzIG5vdCBwcm92aWRlZAoJLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQoJKCBjb21waWxlZCB8fCBjb21waWxlKCBzZWxlY3RvciwgbWF0Y2ggKSApKAoJCXNlZWQsCgkJY29udGV4dCwKCQkhZG9jdW1lbnRJc0hUTUwsCgkJcmVzdWx0cywKCQkhY29udGV4dCB8fCByc2libGluZy50ZXN0KCBzZWxlY3RvciApICYmIHRlc3RDb250ZXh0KCBjb250ZXh0LnBhcmVudE5vZGUgKSB8fCBjb250ZXh0CgkpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovLyBPbmUtdGltZSBhc3NpZ25tZW50cwoKLy8gU29ydCBzdGFiaWxpdHkKc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgiIikuc29ydCggc29ydE9yZGVyICkuam9pbigiIikgPT09IGV4cGFuZG87CgovLyBTdXBwb3J0OiBDaHJvbWUgMTQtMzUrCi8vIEFsd2F5cyBhc3N1bWUgZHVwbGljYXRlcyBpZiB0aGV5IGFyZW4ndCBwYXNzZWQgdG8gdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24Kc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gISFoYXNEdXBsaWNhdGU7CgovLyBJbml0aWFsaXplIGFnYWluc3QgdGhlIGRlZmF1bHQgZG9jdW1lbnQKc2V0RG9jdW1lbnQoKTsKCi8vIFN1cHBvcnQ6IFdlYmtpdDw1MzcuMzIgLSBTYWZhcmkgNi4wLjMvQ2hyb21lIDI1IChmaXhlZCBpbiBDaHJvbWUgMjcpCi8vIERldGFjaGVkIG5vZGVzIGNvbmZvdW5kaW5nbHkgZm9sbG93ICplYWNoIG90aGVyKgpzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiggZWwgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBlbC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwczovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM2NDI5JTI4VlMuODUlMjkuYXNweAppZiAoICFhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJZWwuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIiA7Cn0pICkgewoJYWRkSGFuZGxlKCAidHlwZXxocmVmfGhlaWdodHx3aWR0aCIsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0eXBlIiA/IDEgOiAyICk7CgkJfQoJfSk7Cn0KCi8vIFN1cHBvcnQ6IElFPDkKLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKaWYgKCAhc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24oIGVsICkgewoJZWwuaW5uZXJIVE1MID0gIjxpbnB1dC8+IjsKCWVsLmZpcnN0Q2hpbGQuc2V0QXR0cmlidXRlKCAidmFsdWUiLCAiIiApOwoJcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBlbCApIHsKCXJldHVybiBlbC5nZXRBdHRyaWJ1dGUoImRpc2FibGVkIikgPT0gbnVsbDsKfSkgKSB7CglhZGRIYW5kbGUoIGJvb2xlYW5zLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIHZhbDsKCQlpZiAoICFpc1hNTCApIHsKCQkJcmV0dXJuIGVsZW1bIG5hbWUgXSA9PT0gdHJ1ZSA/IG5hbWUudG9Mb3dlckNhc2UoKSA6CgkJCQkJKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCQl2YWwudmFsdWUgOgoJCQkJbnVsbDsKCQl9Cgl9KTsKfQoKcmV0dXJuIFNpenpsZTsKCn0pKCB3aW5kb3cgKTsKCgoKalF1ZXJ5LmZpbmQgPSBTaXp6bGU7CmpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKCi8vIERlcHJlY2F0ZWQKalF1ZXJ5LmV4cHJbICI6IiBdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZVNvcnQgPSBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CmpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CmpRdWVyeS5pc1hNTERvYyA9IFNpenpsZS5pc1hNTDsKalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwpqUXVlcnkuZXNjYXBlU2VsZWN0b3IgPSBTaXp6bGUuZXNjYXBlOwoKCgoKdmFyIGRpciA9IGZ1bmN0aW9uKCBlbGVtLCBkaXIsIHVudGlsICkgewoJdmFyIG1hdGNoZWQgPSBbXSwKCQl0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CgoJd2hpbGUgKCAoIGVsZW0gPSBlbGVtWyBkaXIgXSApICYmIGVsZW0ubm9kZVR5cGUgIT09IDkgKSB7CgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQlpZiAoIHRydW5jYXRlICYmIGpRdWVyeSggZWxlbSApLmlzKCB1bnRpbCApICkgewoJCQkJYnJlYWs7CgkJCX0KCQkJbWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJfQoJfQoJcmV0dXJuIG1hdGNoZWQ7Cn07CgoKdmFyIHNpYmxpbmdzID0gZnVuY3Rpb24oIG4sIGVsZW0gKSB7Cgl2YXIgbWF0Y2hlZCA9IFtdOwoKCWZvciAoIDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcgKSB7CgkJaWYgKCBuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0gKSB7CgkJCW1hdGNoZWQucHVzaCggbiApOwoJCX0KCX0KCglyZXR1cm4gbWF0Y2hlZDsKfTsKCgp2YXIgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dDsKCgoKZnVuY3Rpb24gbm9kZU5hbWUoIGVsZW0sIG5hbWUgKSB7CgogIHJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoKfTsKdmFyIHJzaW5nbGVUYWcgPSAoIC9ePChbYS16XVteXC9cMD46XHgyMFx0XHJcblxmXSopW1x4MjBcdFxyXG5cZl0qXC8/Pig/OjxcL1wxPnwpJC9pICk7CgoKCi8vIEltcGxlbWVudCB0aGUgaWRlbnRpY2FsIGZ1bmN0aW9uYWxpdHkgZm9yIGZpbHRlciBhbmQgbm90CmZ1bmN0aW9uIHdpbm5vdyggZWxlbWVudHMsIHF1YWxpZmllciwgbm90ICkgewoJaWYgKCBpc0Z1bmN0aW9uKCBxdWFsaWZpZXIgKSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0gKTsKCX0KCgkvLyBTaW5nbGUgZWxlbWVudAoJaWYgKCBxdWFsaWZpZXIubm9kZVR5cGUgKSB7CgkJcmV0dXJuIGpRdWVyeS5ncmVwKCBlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAoIGVsZW0gPT09IHF1YWxpZmllciApICE9PSBub3Q7CgkJfSApOwoJfQoKCS8vIEFycmF5bGlrZSBvZiBlbGVtZW50cyAoalF1ZXJ5LCBhcmd1bWVudHMsIEFycmF5KQoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyICE9PSAic3RyaW5nIiApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggaW5kZXhPZi5jYWxsKCBxdWFsaWZpZXIsIGVsZW0gKSA+IC0xICkgIT09IG5vdDsKCQl9ICk7Cgl9CgoJLy8gRmlsdGVyZWQgZGlyZWN0bHkgZm9yIGJvdGggc2ltcGxlIGFuZCBjb21wbGV4IHNlbGVjdG9ycwoJcmV0dXJuIGpRdWVyeS5maWx0ZXIoIHF1YWxpZmllciwgZWxlbWVudHMsIG5vdCApOwp9CgpqUXVlcnkuZmlsdGVyID0gZnVuY3Rpb24oIGV4cHIsIGVsZW1zLCBub3QgKSB7Cgl2YXIgZWxlbSA9IGVsZW1zWyAwIF07CgoJaWYgKCBub3QgKSB7CgkJZXhwciA9ICI6bm90KCIgKyBleHByICsgIikiOwoJfQoKCWlmICggZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJcmV0dXJuIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZWxlbSwgZXhwciApID8gWyBlbGVtIF0gOiBbXTsKCX0KCglyZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlcyggZXhwciwgalF1ZXJ5LmdyZXAoIGVsZW1zLCBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMTsKCX0gKSApOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLCByZXQsCgkJCWxlbiA9IHRoaXMubGVuZ3RoLAoJCQlzZWxmID0gdGhpczsKCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeSggc2VsZWN0b3IgKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggc2VsZlsgaSBdLCB0aGlzICkgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCX0KCQkJfSApICk7CgkJfQoKCQlyZXQgPSB0aGlzLnB1c2hTdGFjayggW10gKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJalF1ZXJ5LmZpbmQoIHNlbGVjdG9yLCBzZWxmWyBpIF0sIHJldCApOwoJCX0KCgkJcmV0dXJuIGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlU29ydCggcmV0ICkgOiByZXQ7Cgl9LAoJZmlsdGVyOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3coIHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSApICk7Cgl9LAoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3coIHRoaXMsIHNlbGVjdG9yIHx8IFtdLCB0cnVlICkgKTsKCX0sCglpczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiAhIXdpbm5vdygKCQkJdGhpcywKCgkJCS8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKCQkJLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgoJCQl0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICYmIHJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSA/CgkJCQlqUXVlcnkoIHNlbGVjdG9yICkgOgoJCQkJc2VsZWN0b3IgfHwgW10sCgkJCWZhbHNlCgkJKS5sZW5ndGg7Cgl9Cn0gKTsKCgovLyBJbml0aWFsaXplIGEgalF1ZXJ5IG9iamVjdAoKCi8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQp2YXIgcm9vdGpRdWVyeSwKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCgkvLyBTaG9ydGN1dCBzaW1wbGUgI2lkIGNhc2UgZm9yIHNwZWVkCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0rKSkkLywKCglpbml0ID0galF1ZXJ5LmZuLmluaXQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3QgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gTWV0aG9kIGluaXQoKSBhY2NlcHRzIGFuIGFsdGVybmF0ZSByb290alF1ZXJ5CgkJLy8gc28gbWlncmF0ZSBjYW4gc3VwcG9ydCBqUXVlcnkuc3ViIChnaC0yMTAxKQoJCXJvb3QgPSByb290IHx8IHJvb3RqUXVlcnk7CgoJCS8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCWlmICggc2VsZWN0b3JbIDAgXSA9PT0gIjwiICYmCgkJCQlzZWxlY3Rvclsgc2VsZWN0b3IubGVuZ3RoIC0gMSBdID09PSAiPiIgJiYKCQkJCXNlbGVjdG9yLmxlbmd0aCA+PSAzICkgewoKCQkJCS8vIEFzc3VtZSB0aGF0IHN0cmluZ3MgdGhhdCBzdGFydCBhbmQgZW5kIHdpdGggPD4gYXJlIEhUTUwgYW5kIHNraXAgdGhlIHJlZ2V4IGNoZWNrCgkJCQltYXRjaCA9IFsgbnVsbCwgc2VsZWN0b3IsIG51bGwgXTsKCgkJCX0gZWxzZSB7CgkJCQltYXRjaCA9IHJxdWlja0V4cHIuZXhlYyggc2VsZWN0b3IgKTsKCQkJfQoKCQkJLy8gTWF0Y2ggaHRtbCBvciBtYWtlIHN1cmUgbm8gY29udGV4dCBpcyBzcGVjaWZpZWQgZm9yICNpZAoJCQlpZiAoIG1hdGNoICYmICggbWF0Y2hbIDEgXSB8fCAhY29udGV4dCApICkgewoKCQkJCS8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQoJCQkJaWYgKCBtYXRjaFsgMSBdICkgewoJCQkJCWNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFsgMCBdIDogY29udGV4dDsKCgkJCQkJLy8gT3B0aW9uIHRvIHJ1biBzY3JpcHRzIGlzIHRydWUgZm9yIGJhY2stY29tcGF0CgkJCQkJLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKCQkJCQlqUXVlcnkubWVyZ2UoIHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwoCgkJCQkJCW1hdGNoWyAxIF0sCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsCgkJCQkJCXRydWUKCQkJCQkpICk7CgoJCQkJCS8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbIDEgXSApICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KCBjb250ZXh0ICkgKSB7CgkJCQkJCWZvciAoIG1hdGNoIGluIGNvbnRleHQgKSB7CgoJCQkJCQkJLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQoJCQkJCQkJaWYgKCBpc0Z1bmN0aW9uKCB0aGlzWyBtYXRjaCBdICkgKSB7CgkJCQkJCQkJdGhpc1sgbWF0Y2ggXSggY29udGV4dFsgbWF0Y2ggXSApOwoKCQkJCQkJCS8vIC4uLmFuZCBvdGhlcndpc2Ugc2V0IGFzIGF0dHJpYnV0ZXMKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJdGhpcy5hdHRyKCBtYXRjaCwgY29udGV4dFsgbWF0Y2ggXSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQlyZXR1cm4gdGhpczsKCgkJCQkvLyBIQU5ETEU6ICQoI2lkKQoJCQkJfSBlbHNlIHsKCQkJCQllbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG1hdGNoWyAyIF0gKTsKCgkJCQkJaWYgKCBlbGVtICkgewoKCQkJCQkJLy8gSW5qZWN0IHRoZSBlbGVtZW50IGRpcmVjdGx5IGludG8gdGhlIGpRdWVyeSBvYmplY3QKCQkJCQkJdGhpc1sgMCBdID0gZWxlbTsKCQkJCQkJdGhpcy5sZW5ndGggPSAxOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCgkJCS8vIEhBTkRMRTogJChleHByLCAkKC4uLikpCgkJCX0gZWxzZSBpZiAoICFjb250ZXh0IHx8IGNvbnRleHQuanF1ZXJ5ICkgewoJCQkJcmV0dXJuICggY29udGV4dCB8fCByb290ICkuZmluZCggc2VsZWN0b3IgKTsKCgkJCS8vIEhBTkRMRTogJChleHByLCBjb250ZXh0KQoJCQkvLyAod2hpY2ggaXMganVzdCBlcXVpdmFsZW50IHRvOiAkKGNvbnRleHQpLmZpbmQoZXhwcikKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmNvbnN0cnVjdG9yKCBjb250ZXh0ICkuZmluZCggc2VsZWN0b3IgKTsKCQkJfQoKCQkvLyBIQU5ETEU6ICQoRE9NRWxlbWVudCkKCQl9IGVsc2UgaWYgKCBzZWxlY3Rvci5ub2RlVHlwZSApIHsKCQkJdGhpc1sgMCBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBpc0Z1bmN0aW9uKCBzZWxlY3RvciApICkgewoJCQlyZXR1cm4gcm9vdC5yZWFkeSAhPT0gdW5kZWZpbmVkID8KCQkJCXJvb3QucmVhZHkoIHNlbGVjdG9yICkgOgoKCQkJCS8vIEV4ZWN1dGUgaW1tZWRpYXRlbHkgaWYgcmVhZHkgaXMgbm90IHByZXNlbnQKCQkJCXNlbGVjdG9yKCBqUXVlcnkgKTsKCQl9CgoJCXJldHVybiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciwgdGhpcyApOwoJfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgovLyBJbml0aWFsaXplIGNlbnRyYWwgcmVmZXJlbmNlCnJvb3RqUXVlcnkgPSBqUXVlcnkoIGRvY3VtZW50ICk7CgoKdmFyIHJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoKCS8vIE1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWwgPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQlpZiAoIGpRdWVyeS5jb250YWlucyggdGhpcywgdGFyZ2V0c1sgaSBdICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9ICk7Cgl9LAoKCWNsb3Nlc3Q6IGZ1bmN0aW9uKCBzZWxlY3RvcnMsIGNvbnRleHQgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWwgPSB0aGlzLmxlbmd0aCwKCQkJbWF0Y2hlZCA9IFtdLAoJCQl0YXJnZXRzID0gdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgJiYgalF1ZXJ5KCBzZWxlY3RvcnMgKTsKCgkJLy8gUG9zaXRpb25hbCBzZWxlY3RvcnMgbmV2ZXIgbWF0Y2gsIHNpbmNlIHRoZXJlJ3Mgbm8gX3NlbGVjdGlvbl8gY29udGV4dAoJCWlmICggIXJuZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3JzICkgKSB7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWZvciAoIGN1ciA9IHRoaXNbIGkgXTsgY3VyICYmIGN1ciAhPT0gY29udGV4dDsgY3VyID0gY3VyLnBhcmVudE5vZGUgKSB7CgoJCQkJCS8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwoJCQkJCWlmICggY3VyLm5vZGVUeXBlIDwgMTEgJiYgKCB0YXJnZXRzID8KCQkJCQkJdGFyZ2V0cy5pbmRleCggY3VyICkgPiAtMSA6CgoJCQkJCQkvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUKCQkJCQkJY3VyLm5vZGVUeXBlID09PSAxICYmCgkJCQkJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGN1ciwgc2VsZWN0b3JzICkgKSApIHsKCgkJCQkJCW1hdGNoZWQucHVzaCggY3VyICk7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkLmxlbmd0aCA+IDEgPyBqUXVlcnkudW5pcXVlU29ydCggbWF0Y2hlZCApIDogbWF0Y2hlZCApOwoJfSwKCgkvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIHRoZSBzZXQKCWluZGV4OiBmdW5jdGlvbiggZWxlbSApIHsKCgkJLy8gTm8gYXJndW1lbnQsIHJldHVybiBpbmRleCBpbiBwYXJlbnQKCQlpZiAoICFlbGVtICkgewoJCQlyZXR1cm4gKCB0aGlzWyAwIF0gJiYgdGhpc1sgMCBdLnBhcmVudE5vZGUgKSA/IHRoaXMuZmlyc3QoKS5wcmV2QWxsKCkubGVuZ3RoIDogLTE7CgkJfQoKCQkvLyBJbmRleCBpbiBzZWxlY3RvcgoJCWlmICggdHlwZW9mIGVsZW0gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdGhpc1sgMCBdICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4gaW5kZXhPZi5jYWxsKCB0aGlzLAoKCQkJLy8gSWYgaXQgcmVjZWl2ZXMgYSBqUXVlcnkgb2JqZWN0LCB0aGUgZmlyc3QgZWxlbWVudCBpcyB1c2VkCgkJCWVsZW0uanF1ZXJ5ID8gZWxlbVsgMCBdIDogZWxlbQoJCSk7Cgl9LAoKCWFkZDogZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjaygKCQkJalF1ZXJ5LnVuaXF1ZVNvcnQoCgkJCQlqUXVlcnkubWVyZ2UoIHRoaXMuZ2V0KCksIGpRdWVyeSggc2VsZWN0b3IsIGNvbnRleHQgKSApCgkJCSkKCQkpOwoJfSwKCglhZGRCYWNrOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Cn0gKTsKCmZ1bmN0aW9uIHNpYmxpbmcoIGN1ciwgZGlyICkgewoJd2hpbGUgKCAoIGN1ciA9IGN1clsgZGlyIF0gKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQoJcmV0dXJuIGN1cjsKfQoKalF1ZXJ5LmVhY2goIHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJwYXJlbnROb2RlIiApOwoJfSwKCXBhcmVudHNVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwgKTsKCX0sCgluZXh0OiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gc2libGluZyggZWxlbSwgIm5leHRTaWJsaW5nIiApOwoJfSwKCXByZXY6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRBbGw6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZGlyKCBlbGVtLCAicHJldmlvdXNTaWJsaW5nIiApOwoJfSwKCW5leHRVbnRpbDogZnVuY3Rpb24oIGVsZW0sIGksIHVudGlsICkgewoJCXJldHVybiBkaXIoIGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsICk7Cgl9LAoJcHJldlVudGlsOiBmdW5jdGlvbiggZWxlbSwgaSwgdW50aWwgKSB7CgkJcmV0dXJuIGRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5ncyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5ncyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewogICAgICAgIGlmICggbm9kZU5hbWUoIGVsZW0sICJpZnJhbWUiICkgKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudDsKICAgICAgICB9CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5LCBpT1MgNyBvbmx5LCBBbmRyb2lkIEJyb3dzZXIgPD00LjMgb25seQogICAgICAgIC8vIFRyZWF0IHRoZSB0ZW1wbGF0ZSBlbGVtZW50IGFzIGEgcmVndWxhciBvbmUgaW4gYnJvd3NlcnMgdGhhdAogICAgICAgIC8vIGRvbid0IHN1cHBvcnQgaXQuCiAgICAgICAgaWYgKCBub2RlTmFtZSggZWxlbSwgInRlbXBsYXRlIiApICkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5jb250ZW50IHx8IGVsZW07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4galF1ZXJ5Lm1lcmdlKCBbXSwgZWxlbS5jaGlsZE5vZGVzICk7Cgl9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBmbiApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHVudGlsLCBzZWxlY3RvciApIHsKCQl2YXIgbWF0Y2hlZCA9IGpRdWVyeS5tYXAoIHRoaXMsIGZuLCB1bnRpbCApOwoKCQlpZiAoIG5hbWUuc2xpY2UoIC01ICkgIT09ICJVbnRpbCIgKSB7CgkJCXNlbGVjdG9yID0gdW50aWw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgKSB7CgkJCW1hdGNoZWQgPSBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgbWF0Y2hlZCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCA+IDEgKSB7CgoJCQkvLyBSZW1vdmUgZHVwbGljYXRlcwoJCQlpZiAoICFndWFyYW50ZWVkVW5pcXVlWyBuYW1lIF0gKSB7CgkJCQlqUXVlcnkudW5pcXVlU29ydCggbWF0Y2hlZCApOwoJCQl9CgoJCQkvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcwoJCQlpZiAoIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CgkJCQltYXRjaGVkLnJldmVyc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkICk7Cgl9Owp9ICk7CnZhciBybm90aHRtbHdoaXRlID0gKCAvW15ceDIwXHRcclxuXGZdKy9nICk7CgoKCi8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0ge307CglqUXVlcnkuZWFjaCggb3B0aW9ucy5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdLCBmdW5jdGlvbiggXywgZmxhZyApIHsKCQlvYmplY3RbIGZsYWcgXSA9IHRydWU7Cgl9ICk7CglyZXR1cm4gb2JqZWN0Owp9CgovKgogKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICoKICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICoKICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICoKICogUG9zc2libGUgb3B0aW9uczoKICoKICoJb25jZToJCQl3aWxsIGVuc3VyZSB0aGUgY2FsbGJhY2sgbGlzdCBjYW4gb25seSBiZSBmaXJlZCBvbmNlIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAqCQkJCQlhZnRlciB0aGUgbGlzdCBoYXMgYmVlbiBmaXJlZCByaWdodCBhd2F5IHdpdGggdGhlIGxhdGVzdCAibWVtb3JpemVkIgogKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAqCiAqCXVuaXF1ZToJCQl3aWxsIGVuc3VyZSBhIGNhbGxiYWNrIGNhbiBvbmx5IGJlIGFkZGVkIG9uY2UgKG5vIGR1cGxpY2F0ZSBpbiB0aGUgbGlzdCkKICoKICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogKgogKi8KalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCS8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKCS8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKCW9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPwoJCWNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSA6CgkJalF1ZXJ5LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwoJCWZpcmluZywKCgkJLy8gTGFzdCBmaXJlIHZhbHVlIGZvciBub24tZm9yZ2V0dGFibGUgbGlzdHMKCQltZW1vcnksCgoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IHdhcyBhbHJlYWR5IGZpcmVkCgkJZmlyZWQsCgoJCS8vIEZsYWcgdG8gcHJldmVudCBmaXJpbmcKCQlsb2NrZWQsCgoJCS8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CgkJbGlzdCA9IFtdLAoKCQkvLyBRdWV1ZSBvZiBleGVjdXRpb24gZGF0YSBmb3IgcmVwZWF0YWJsZSBsaXN0cwoJCXF1ZXVlID0gW10sCgoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IGFkZC9yZW1vdmUgYXMgbmVlZGVkKQoJCWZpcmluZ0luZGV4ID0gLTEsCgoJCS8vIEZpcmUgY2FsbGJhY2tzCgkJZmlyZSA9IGZ1bmN0aW9uKCkgewoKCQkJLy8gRW5mb3JjZSBzaW5nbGUtZmlyaW5nCgkJCWxvY2tlZCA9IGxvY2tlZCB8fCBvcHRpb25zLm9uY2U7CgoJCQkvLyBFeGVjdXRlIGNhbGxiYWNrcyBmb3IgYWxsIHBlbmRpbmcgZXhlY3V0aW9ucywKCQkJLy8gcmVzcGVjdGluZyBmaXJpbmdJbmRleCBvdmVycmlkZXMgYW5kIHJ1bnRpbWUgY2hhbmdlcwoJCQlmaXJlZCA9IGZpcmluZyA9IHRydWU7CgkJCWZvciAoIDsgcXVldWUubGVuZ3RoOyBmaXJpbmdJbmRleCA9IC0xICkgewoJCQkJbWVtb3J5ID0gcXVldWUuc2hpZnQoKTsKCQkJCXdoaWxlICggKytmaXJpbmdJbmRleCA8IGxpc3QubGVuZ3RoICkgewoKCQkJCQkvLyBSdW4gY2FsbGJhY2sgYW5kIGNoZWNrIGZvciBlYXJseSB0ZXJtaW5hdGlvbgoJCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggbWVtb3J5WyAwIF0sIG1lbW9yeVsgMSBdICkgPT09IGZhbHNlICYmCgkJCQkJCW9wdGlvbnMuc3RvcE9uRmFsc2UgKSB7CgoJCQkJCQkvLyBKdW1wIHRvIGVuZCBhbmQgZm9yZ2V0IHRoZSBkYXRhIHNvIC5hZGQgZG9lc24ndCByZS1maXJlCgkJCQkJCWZpcmluZ0luZGV4ID0gbGlzdC5sZW5ndGg7CgkJCQkJCW1lbW9yeSA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gRm9yZ2V0IHRoZSBkYXRhIGlmIHdlJ3JlIGRvbmUgd2l0aCBpdAoJCQlpZiAoICFvcHRpb25zLm1lbW9yeSApIHsKCQkJCW1lbW9yeSA9IGZhbHNlOwoJCQl9CgoJCQlmaXJpbmcgPSBmYWxzZTsKCgkJCS8vIENsZWFuIHVwIGlmIHdlJ3JlIGRvbmUgZmlyaW5nIGZvciBnb29kCgkJCWlmICggbG9ja2VkICkgewoKCQkJCS8vIEtlZXAgYW4gZW1wdHkgbGlzdCBpZiB3ZSBoYXZlIGRhdGEgZm9yIGZ1dHVyZSBhZGQgY2FsbHMKCQkJCWlmICggbWVtb3J5ICkgewoJCQkJCWxpc3QgPSBbXTsKCgkJCQkvLyBPdGhlcndpc2UsIHRoaXMgb2JqZWN0IGlzIHNwZW50CgkJCQl9IGVsc2UgewoJCQkJCWxpc3QgPSAiIjsKCQkJCX0KCQkJfQoJCX0sCgoJCS8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CgkJc2VsZiA9IHsKCgkJCS8vIEFkZCBhIGNhbGxiYWNrIG9yIGEgY29sbGVjdGlvbiBvZiBjYWxsYmFja3MgdG8gdGhlIGxpc3QKCQkJYWRkOiBmdW5jdGlvbigpIHsKCQkJCWlmICggbGlzdCApIHsKCgkJCQkJLy8gSWYgd2UgaGF2ZSBtZW1vcnkgZnJvbSBhIHBhc3QgcnVuLCB3ZSBzaG91bGQgZmlyZSBhZnRlciBhZGRpbmcKCQkJCQlpZiAoIG1lbW9yeSAmJiAhZmlyaW5nICkgewoJCQkJCQlmaXJpbmdJbmRleCA9IGxpc3QubGVuZ3RoIC0gMTsKCQkJCQkJcXVldWUucHVzaCggbWVtb3J5ICk7CgkJCQkJfQoKCQkJCQkoIGZ1bmN0aW9uIGFkZCggYXJncyApIHsKCQkJCQkJalF1ZXJ5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCQlpZiAoIGlzRnVuY3Rpb24oIGFyZyApICkgewoJCQkJCQkJCWlmICggIW9wdGlvbnMudW5pcXVlIHx8ICFzZWxmLmhhcyggYXJnICkgKSB7CgkJCQkJCQkJCWxpc3QucHVzaCggYXJnICk7CgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIGlmICggYXJnICYmIGFyZy5sZW5ndGggJiYgdG9UeXBlKCBhcmcgKSAhPT0gInN0cmluZyIgKSB7CgoJCQkJCQkJCS8vIEluc3BlY3QgcmVjdXJzaXZlbHkKCQkJCQkJCQlhZGQoIGFyZyApOwoJCQkJCQkJfQoJCQkJCQl9ICk7CgkJCQkJfSApKCBhcmd1bWVudHMgKTsKCgkJCQkJaWYgKCBtZW1vcnkgJiYgIWZpcmluZyApIHsKCQkJCQkJZmlyZSgpOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5LmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oIF8sIGFyZyApIHsKCQkJCQl2YXIgaW5kZXg7CgkJCQkJd2hpbGUgKCAoIGluZGV4ID0galF1ZXJ5LmluQXJyYXkoIGFyZywgbGlzdCwgaW5kZXggKSApID4gLTEgKSB7CgkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoKCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQlmaXJpbmdJbmRleC0tOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgoJCQkvLyBDaGVjayBpZiBhIGdpdmVuIGNhbGxiYWNrIGlzIGluIHRoZSBsaXN0LgoJCQkvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KCQkJaGFzOiBmdW5jdGlvbiggZm4gKSB7CgkJCQlyZXR1cm4gZm4gPwoJCQkJCWpRdWVyeS5pbkFycmF5KCBmbiwgbGlzdCApID4gLTEgOgoJCQkJCWxpc3QubGVuZ3RoID4gMDsKCQkJfSwKCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCWxpc3QgPSBbXTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoKCQkJLy8gRGlzYWJsZSAuZmlyZSBhbmQgLmFkZAoJCQkvLyBBYm9ydCBhbnkgY3VycmVudC9wZW5kaW5nIGV4ZWN1dGlvbnMKCQkJLy8gQ2xlYXIgYWxsIGNhbGxiYWNrcyBhbmQgdmFsdWVzCgkJCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCQkJbG9ja2VkID0gcXVldWUgPSBbXTsKCQkJCWxpc3QgPSBtZW1vcnkgPSAiIjsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQlkaXNhYmxlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gIWxpc3Q7CgkJCX0sCgoJCQkvLyBEaXNhYmxlIC5maXJlCgkJCS8vIEFsc28gZGlzYWJsZSAuYWRkIHVubGVzcyB3ZSBoYXZlIG1lbW9yeSAoc2luY2UgaXQgd291bGQgaGF2ZSBubyBlZmZlY3QpCgkJCS8vIEFib3J0IGFueSBwZW5kaW5nIGV4ZWN1dGlvbnMKCQkJbG9jazogZnVuY3Rpb24oKSB7CgkJCQlsb2NrZWQgPSBxdWV1ZSA9IFtdOwoJCQkJaWYgKCAhbWVtb3J5ICYmICFmaXJpbmcgKSB7CgkJCQkJbGlzdCA9IG1lbW9yeSA9ICIiOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCWxvY2tlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFsb2NrZWQ7CgkJCX0sCgoJCQkvLyBDYWxsIGFsbCBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dCBhbmQgYXJndW1lbnRzCgkJCWZpcmVXaXRoOiBmdW5jdGlvbiggY29udGV4dCwgYXJncyApIHsKCQkJCWlmICggIWxvY2tlZCApIHsKCQkJCQlhcmdzID0gYXJncyB8fCBbXTsKCQkJCQlhcmdzID0gWyBjb250ZXh0LCBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncyBdOwoJCQkJCXF1ZXVlLnB1c2goIGFyZ3MgKTsKCQkJCQlpZiAoICFmaXJpbmcgKSB7CgkJCQkJCWZpcmUoKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIENhbGwgYWxsIHRoZSBjYWxsYmFja3Mgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzCgkJCWZpcmU6IGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5maXJlV2l0aCggdGhpcywgYXJndW1lbnRzICk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CgoKZnVuY3Rpb24gSWRlbnRpdHkoIHYgKSB7CglyZXR1cm4gdjsKfQpmdW5jdGlvbiBUaHJvd2VyKCBleCApIHsKCXRocm93IGV4Owp9CgpmdW5jdGlvbiBhZG9wdFZhbHVlKCB2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0LCBub1ZhbHVlICkgewoJdmFyIG1ldGhvZDsKCgl0cnkgewoKCQkvLyBDaGVjayBmb3IgcHJvbWlzZSBhc3BlY3QgZmlyc3QgdG8gcHJpdmlsZWdlIHN5bmNocm9ub3VzIGJlaGF2aW9yCgkJaWYgKCB2YWx1ZSAmJiBpc0Z1bmN0aW9uKCAoIG1ldGhvZCA9IHZhbHVlLnByb21pc2UgKSApICkgewoJCQltZXRob2QuY2FsbCggdmFsdWUgKS5kb25lKCByZXNvbHZlICkuZmFpbCggcmVqZWN0ICk7CgoJCS8vIE90aGVyIHRoZW5hYmxlcwoJCX0gZWxzZSBpZiAoIHZhbHVlICYmIGlzRnVuY3Rpb24oICggbWV0aG9kID0gdmFsdWUudGhlbiApICkgKSB7CgkJCW1ldGhvZC5jYWxsKCB2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0ICk7CgoJCS8vIE90aGVyIG5vbi10aGVuYWJsZXMKCQl9IGVsc2UgewoKCQkJLy8gQ29udHJvbCBgcmVzb2x2ZWAgYXJndW1lbnRzIGJ5IGxldHRpbmcgQXJyYXkjc2xpY2UgY2FzdCBib29sZWFuIGBub1ZhbHVlYCB0byBpbnRlZ2VyOgoJCQkvLyAqIGZhbHNlOiBbIHZhbHVlIF0uc2xpY2UoIDAgKSA9PiByZXNvbHZlKCB2YWx1ZSApCgkJCS8vICogdHJ1ZTogWyB2YWx1ZSBdLnNsaWNlKCAxICkgPT4gcmVzb2x2ZSgpCgkJCXJlc29sdmUuYXBwbHkoIHVuZGVmaW5lZCwgWyB2YWx1ZSBdLnNsaWNlKCBub1ZhbHVlICkgKTsKCQl9CgoJLy8gRm9yIFByb21pc2VzL0ErLCBjb252ZXJ0IGV4Y2VwdGlvbnMgaW50byByZWplY3Rpb25zCgkvLyBTaW5jZSBqUXVlcnkud2hlbiBkb2Vzbid0IHVud3JhcCB0aGVuYWJsZXMsIHdlIGNhbiBza2lwIHRoZSBleHRyYSBjaGVja3MgYXBwZWFyaW5nIGluCgkvLyBEZWZlcnJlZCN0aGVuIHRvIGNvbmRpdGlvbmFsbHkgc3VwcHJlc3MgcmVqZWN0aW9uLgoJfSBjYXRjaCAoIHZhbHVlICkgewoKCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCBvbmx5CgkJLy8gU3RyaWN0IG1vZGUgZnVuY3Rpb25zIGludm9rZWQgd2l0aG91dCAuY2FsbC8uYXBwbHkgZ2V0IGdsb2JhbC1vYmplY3QgY29udGV4dAoJCXJlamVjdC5hcHBseSggdW5kZWZpbmVkLCBbIHZhbHVlIF0gKTsKCX0KfQoKalF1ZXJ5LmV4dGVuZCggewoKCURlZmVycmVkOiBmdW5jdGlvbiggZnVuYyApIHsKCQl2YXIgdHVwbGVzID0gWwoKCQkJCS8vIGFjdGlvbiwgYWRkIGxpc3RlbmVyLCBjYWxsYmFja3MsCgkJCQkvLyAuLi4gLnRoZW4gaGFuZGxlcnMsIGFyZ3VtZW50IGluZGV4LCBbZmluYWwgc3RhdGVdCgkJCQlbICJub3RpZnkiLCAicHJvZ3Jlc3MiLCBqUXVlcnkuQ2FsbGJhY2tzKCAibWVtb3J5IiApLAoJCQkJCWpRdWVyeS5DYWxsYmFja3MoICJtZW1vcnkiICksIDIgXSwKCQkJCVsgInJlc29sdmUiLCAiZG9uZSIsIGpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwKCQkJCQlqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksIDAsICJyZXNvbHZlZCIgXSwKCQkJCVsgInJlamVjdCIsICJmYWlsIiwgalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLAoJCQkJCWpRdWVyeS5DYWxsYmFja3MoICJvbmNlIG1lbW9yeSIgKSwgMSwgInJlamVjdGVkIiBdCgkJCV0sCgkJCXN0YXRlID0gInBlbmRpbmciLAoJCQlwcm9taXNlID0gewoJCQkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZTsKCQkJCX0sCgkJCQlhbHdheXM6IGZ1bmN0aW9uKCkgewoJCQkJCWRlZmVycmVkLmRvbmUoIGFyZ3VtZW50cyApLmZhaWwoIGFyZ3VtZW50cyApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCQkJCSJjYXRjaCI6IGZ1bmN0aW9uKCBmbiApIHsKCQkJCQlyZXR1cm4gcHJvbWlzZS50aGVuKCBudWxsLCBmbiApOwoJCQkJfSwKCgkJCQkvLyBLZWVwIHBpcGUgZm9yIGJhY2stY29tcGF0CgkJCQlwaXBlOiBmdW5jdGlvbiggLyogZm5Eb25lLCBmbkZhaWwsIGZuUHJvZ3Jlc3MgKi8gKSB7CgkJCQkJdmFyIGZucyA9IGFyZ3VtZW50czsKCgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZCggZnVuY3Rpb24oIG5ld0RlZmVyICkgewoJCQkJCQlqUXVlcnkuZWFjaCggdHVwbGVzLCBmdW5jdGlvbiggaSwgdHVwbGUgKSB7CgoJCQkJCQkJLy8gTWFwIHR1cGxlcyAocHJvZ3Jlc3MsIGRvbmUsIGZhaWwpIHRvIGFyZ3VtZW50cyAoZG9uZSwgZmFpbCwgcHJvZ3Jlc3MpCgkJCQkJCQl2YXIgZm4gPSBpc0Z1bmN0aW9uKCBmbnNbIHR1cGxlWyA0IF0gXSApICYmIGZuc1sgdHVwbGVbIDQgXSBdOwoKCQkJCQkJCS8vIGRlZmVycmVkLnByb2dyZXNzKGZ1bmN0aW9uKCkgeyBiaW5kIHRvIG5ld0RlZmVyIG9yIG5ld0RlZmVyLm5vdGlmeSB9KQoJCQkJCQkJLy8gZGVmZXJyZWQuZG9uZShmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZXNvbHZlIH0pCgkJCQkJCQkvLyBkZWZlcnJlZC5mYWlsKGZ1bmN0aW9uKCkgeyBiaW5kIHRvIG5ld0RlZmVyIG9yIG5ld0RlZmVyLnJlamVjdCB9KQoJCQkJCQkJZGVmZXJyZWRbIHR1cGxlWyAxIF0gXSggZnVuY3Rpb24oKSB7CgkJCQkJCQkJdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCQkJCWlmICggcmV0dXJuZWQgJiYgaXNGdW5jdGlvbiggcmV0dXJuZWQucHJvbWlzZSApICkgewoJCQkJCQkJCQlyZXR1cm5lZC5wcm9taXNlKCkKCQkJCQkJCQkJCS5wcm9ncmVzcyggbmV3RGVmZXIubm90aWZ5ICkKCQkJCQkJCQkJCS5kb25lKCBuZXdEZWZlci5yZXNvbHZlICkKCQkJCQkJCQkJCS5mYWlsKCBuZXdEZWZlci5yZWplY3QgKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQluZXdEZWZlclsgdHVwbGVbIDAgXSArICJXaXRoIiBdKAoJCQkJCQkJCQkJdGhpcywKCQkJCQkJCQkJCWZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfSApOwoJCQkJCQl9ICk7CgkJCQkJCWZucyA9IG51bGw7CgkJCQkJfSApLnByb21pc2UoKTsKCQkJCX0sCgkJCQl0aGVuOiBmdW5jdGlvbiggb25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MgKSB7CgkJCQkJdmFyIG1heERlcHRoID0gMDsKCQkJCQlmdW5jdGlvbiByZXNvbHZlKCBkZXB0aCwgZGVmZXJyZWQsIGhhbmRsZXIsIHNwZWNpYWwgKSB7CgkJCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGF0ID0gdGhpcywKCQkJCQkJCQlhcmdzID0gYXJndW1lbnRzLAoJCQkJCQkJCW1pZ2h0VGhyb3cgPSBmdW5jdGlvbigpIHsKCQkJCQkJCQkJdmFyIHJldHVybmVkLCB0aGVuOwoKCQkJCQkJCQkJLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjMKCQkJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTkKCQkJCQkJCQkJLy8gSWdub3JlIGRvdWJsZS1yZXNvbHV0aW9uIGF0dGVtcHRzCgkJCQkJCQkJCWlmICggZGVwdGggPCBtYXhEZXB0aCApIHsKCQkJCQkJCQkJCXJldHVybjsKCQkJCQkJCQkJfQoKCQkJCQkJCQkJcmV0dXJuZWQgPSBoYW5kbGVyLmFwcGx5KCB0aGF0LCBhcmdzICk7CgoJCQkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4xCgkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTQ4CgkJCQkJCQkJCWlmICggcmV0dXJuZWQgPT09IGRlZmVycmVkLnByb21pc2UoKSApIHsKCQkJCQkJCQkJCXRocm93IG5ldyBUeXBlRXJyb3IoICJUaGVuYWJsZSBzZWxmLXJlc29sdXRpb24iICk7CgkJCQkJCQkJCX0KCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb25zIDIuMy4zLjEsIDMuNQoJCQkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01NAoJCQkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC03NQoJCQkJCQkJCQkvLyBSZXRyaWV2ZSBgdGhlbmAgb25seSBvbmNlCgkJCQkJCQkJCXRoZW4gPSByZXR1cm5lZCAmJgoKCQkJCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjQKCQkJCQkJCQkJCS8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTY0CgkJCQkJCQkJCQkvLyBPbmx5IGNoZWNrIG9iamVjdHMgYW5kIGZ1bmN0aW9ucyBmb3IgdGhlbmFiaWxpdHkKCQkJCQkJCQkJCSggdHlwZW9mIHJldHVybmVkID09PSAib2JqZWN0IiB8fAoJCQkJCQkJCQkJCXR5cGVvZiByZXR1cm5lZCA9PT0gImZ1bmN0aW9uIiApICYmCgkJCQkJCQkJCQlyZXR1cm5lZC50aGVuOwoKCQkJCQkJCQkJLy8gSGFuZGxlIGEgcmV0dXJuZWQgdGhlbmFibGUKCQkJCQkJCQkJaWYgKCBpc0Z1bmN0aW9uKCB0aGVuICkgKSB7CgoJCQkJCQkJCQkJLy8gU3BlY2lhbCBwcm9jZXNzb3JzIChub3RpZnkpIGp1c3Qgd2FpdCBmb3IgcmVzb2x1dGlvbgoJCQkJCQkJCQkJaWYgKCBzcGVjaWFsICkgewoJCQkJCQkJCQkJCXRoZW4uY2FsbCgKCQkJCQkJCQkJCQkJcmV0dXJuZWQsCgkJCQkJCQkJCQkJCXJlc29sdmUoIG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksIHNwZWNpYWwgKSwKCQkJCQkJCQkJCQkJcmVzb2x2ZSggbWF4RGVwdGgsIGRlZmVycmVkLCBUaHJvd2VyLCBzcGVjaWFsICkKCQkJCQkJCQkJCQkpOwoKCQkJCQkJCQkJCS8vIE5vcm1hbCBwcm9jZXNzb3JzIChyZXNvbHZlKSBhbHNvIGhvb2sgaW50byBwcm9ncmVzcwoJCQkJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJCQkJLy8gLi4uYW5kIGRpc3JlZ2FyZCBvbGRlciByZXNvbHV0aW9uIHZhbHVlcwoJCQkJCQkJCQkJCW1heERlcHRoKys7CgoJCQkJCQkJCQkJCXRoZW4uY2FsbCgKCQkJCQkJCQkJCQkJcmV0dXJuZWQsCgkJCQkJCQkJCQkJCXJlc29sdmUoIG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksIHNwZWNpYWwgKSwKCQkJCQkJCQkJCQkJcmVzb2x2ZSggbWF4RGVwdGgsIGRlZmVycmVkLCBUaHJvd2VyLCBzcGVjaWFsICksCgkJCQkJCQkJCQkJCXJlc29sdmUoIG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksCgkJCQkJCQkJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoICkKCQkJCQkJCQkJCQkpOwoJCQkJCQkJCQkJfQoKCQkJCQkJCQkJLy8gSGFuZGxlIGFsbCBvdGhlciByZXR1cm5lZCB2YWx1ZXMKCQkJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJCQkvLyBPbmx5IHN1YnN0aXR1dGUgaGFuZGxlcnMgcGFzcyBvbiBjb250ZXh0CgkJCQkJCQkJCQkvLyBhbmQgbXVsdGlwbGUgdmFsdWVzIChub24tc3BlYyBiZWhhdmlvcikKCQkJCQkJCQkJCWlmICggaGFuZGxlciAhPT0gSWRlbnRpdHkgKSB7CgkJCQkJCQkJCQkJdGhhdCA9IHVuZGVmaW5lZDsKCQkJCQkJCQkJCQlhcmdzID0gWyByZXR1cm5lZCBdOwoJCQkJCQkJCQkJfQoKCQkJCQkJCQkJCS8vIFByb2Nlc3MgdGhlIHZhbHVlKHMpCgkJCQkJCQkJCQkvLyBEZWZhdWx0IHByb2Nlc3MgaXMgcmVzb2x2ZQoJCQkJCQkJCQkJKCBzcGVjaWFsIHx8IGRlZmVycmVkLnJlc29sdmVXaXRoICkoIHRoYXQsIGFyZ3MgKTsKCQkJCQkJCQkJfQoJCQkJCQkJCX0sCgoJCQkJCQkJCS8vIE9ubHkgbm9ybWFsIHByb2Nlc3NvcnMgKHJlc29sdmUpIGNhdGNoIGFuZCByZWplY3QgZXhjZXB0aW9ucwoJCQkJCQkJCXByb2Nlc3MgPSBzcGVjaWFsID8KCQkJCQkJCQkJbWlnaHRUaHJvdyA6CgkJCQkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJCQltaWdodFRocm93KCk7CgkJCQkJCQkJCQl9IGNhdGNoICggZSApIHsKCgkJCQkJCQkJCQkJaWYgKCBqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayApIHsKCQkJCQkJCQkJCQkJalF1ZXJ5LkRlZmVycmVkLmV4Y2VwdGlvbkhvb2soIGUsCgkJCQkJCQkJCQkJCQlwcm9jZXNzLnN0YWNrVHJhY2UgKTsKCQkJCQkJCQkJCQl9CgoJCQkJCQkJCQkJCS8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy40LjEKCQkJCQkJCQkJCQkvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC02MQoJCQkJCQkJCQkJCS8vIElnbm9yZSBwb3N0LXJlc29sdXRpb24gZXhjZXB0aW9ucwoJCQkJCQkJCQkJCWlmICggZGVwdGggKyAxID49IG1heERlcHRoICkgewoKCQkJCQkJCQkJCQkJLy8gT25seSBzdWJzdGl0dXRlIGhhbmRsZXJzIHBhc3Mgb24gY29udGV4dAoJCQkJCQkJCQkJCQkvLyBhbmQgbXVsdGlwbGUgdmFsdWVzIChub24tc3BlYyBiZWhhdmlvcikKCQkJCQkJCQkJCQkJaWYgKCBoYW5kbGVyICE9PSBUaHJvd2VyICkgewoJCQkJCQkJCQkJCQkJdGhhdCA9IHVuZGVmaW5lZDsKCQkJCQkJCQkJCQkJCWFyZ3MgPSBbIGUgXTsKCQkJCQkJCQkJCQkJfQoKCQkJCQkJCQkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggdGhhdCwgYXJncyApOwoJCQkJCQkJCQkJCX0KCQkJCQkJCQkJCX0KCQkJCQkJCQkJfTsKCgkJCQkJCQkvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy4zLjMuMQoJCQkJCQkJLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTcKCQkJCQkJCS8vIFJlLXJlc29sdmUgcHJvbWlzZXMgaW1tZWRpYXRlbHkgdG8gZG9kZ2UgZmFsc2UgcmVqZWN0aW9uIGZyb20KCQkJCQkJCS8vIHN1YnNlcXVlbnQgZXJyb3JzCgkJCQkJCQlpZiAoIGRlcHRoICkgewoJCQkJCQkJCXByb2Nlc3MoKTsKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCS8vIENhbGwgYW4gb3B0aW9uYWwgaG9vayB0byByZWNvcmQgdGhlIHN0YWNrLCBpbiBjYXNlIG9mIGV4Y2VwdGlvbgoJCQkJCQkJCS8vIHNpbmNlIGl0J3Mgb3RoZXJ3aXNlIGxvc3Qgd2hlbiBleGVjdXRpb24gZ29lcyBhc3luYwoJCQkJCQkJCWlmICggalF1ZXJ5LkRlZmVycmVkLmdldFN0YWNrSG9vayApIHsKCQkJCQkJCQkJcHJvY2Vzcy5zdGFja1RyYWNlID0galF1ZXJ5LkRlZmVycmVkLmdldFN0YWNrSG9vaygpOwoJCQkJCQkJCX0KCQkJCQkJCQl3aW5kb3cuc2V0VGltZW91dCggcHJvY2VzcyApOwoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZCggZnVuY3Rpb24oIG5ld0RlZmVyICkgewoKCQkJCQkJLy8gcHJvZ3Jlc3NfaGFuZGxlcnMuYWRkKCAuLi4gKQoJCQkJCQl0dXBsZXNbIDAgXVsgMyBdLmFkZCgKCQkJCQkJCXJlc29sdmUoCgkJCQkJCQkJMCwKCQkJCQkJCQluZXdEZWZlciwKCQkJCQkJCQlpc0Z1bmN0aW9uKCBvblByb2dyZXNzICkgPwoJCQkJCQkJCQlvblByb2dyZXNzIDoKCQkJCQkJCQkJSWRlbnRpdHksCgkJCQkJCQkJbmV3RGVmZXIubm90aWZ5V2l0aAoJCQkJCQkJKQoJCQkJCQkpOwoKCQkJCQkJLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmFkZCggLi4uICkKCQkJCQkJdHVwbGVzWyAxIF1bIDMgXS5hZGQoCgkJCQkJCQlyZXNvbHZlKAoJCQkJCQkJCTAsCgkJCQkJCQkJbmV3RGVmZXIsCgkJCQkJCQkJaXNGdW5jdGlvbiggb25GdWxmaWxsZWQgKSA/CgkJCQkJCQkJCW9uRnVsZmlsbGVkIDoKCQkJCQkJCQkJSWRlbnRpdHkKCQkJCQkJCSkKCQkJCQkJKTsKCgkJCQkJCS8vIHJlamVjdGVkX2hhbmRsZXJzLmFkZCggLi4uICkKCQkJCQkJdHVwbGVzWyAyIF1bIDMgXS5hZGQoCgkJCQkJCQlyZXNvbHZlKAoJCQkJCQkJCTAsCgkJCQkJCQkJbmV3RGVmZXIsCgkJCQkJCQkJaXNGdW5jdGlvbiggb25SZWplY3RlZCApID8KCQkJCQkJCQkJb25SZWplY3RlZCA6CgkJCQkJCQkJCVRocm93ZXIKCQkJCQkJCSkKCQkJCQkJKTsKCQkJCQl9ICkucHJvbWlzZSgpOwoJCQkJfSwKCgkJCQkvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewoJCQkJCXJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQoIG9iaiwgcHJvbWlzZSApIDogcHJvbWlzZTsKCQkJCX0KCQkJfSwKCQkJZGVmZXJyZWQgPSB7fTsKCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwoJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLAoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgNSBdOwoKCQkJLy8gcHJvbWlzZS5wcm9ncmVzcyA9IGxpc3QuYWRkCgkJCS8vIHByb21pc2UuZG9uZSA9IGxpc3QuYWRkCgkJCS8vIHByb21pc2UuZmFpbCA9IGxpc3QuYWRkCgkJCXByb21pc2VbIHR1cGxlWyAxIF0gXSA9IGxpc3QuYWRkOwoKCQkJLy8gSGFuZGxlIHN0YXRlCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7CgkJCQlsaXN0LmFkZCgKCQkJCQlmdW5jdGlvbigpIHsKCgkJCQkJCS8vIHN0YXRlID0gInJlc29sdmVkIiAoaS5lLiwgZnVsZmlsbGVkKQoJCQkJCQkvLyBzdGF0ZSA9ICJyZWplY3RlZCIKCQkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsKCQkJCQl9LAoKCQkJCQkvLyByZWplY3RlZF9jYWxsYmFja3MuZGlzYWJsZQoJCQkJCS8vIGZ1bGZpbGxlZF9jYWxsYmFja3MuZGlzYWJsZQoJCQkJCXR1cGxlc1sgMyAtIGkgXVsgMiBdLmRpc2FibGUsCgoJCQkJCS8vIHJlamVjdGVkX2hhbmRsZXJzLmRpc2FibGUKCQkJCQkvLyBmdWxmaWxsZWRfaGFuZGxlcnMuZGlzYWJsZQoJCQkJCXR1cGxlc1sgMyAtIGkgXVsgMyBdLmRpc2FibGUsCgoJCQkJCS8vIHByb2dyZXNzX2NhbGxiYWNrcy5sb2NrCgkJCQkJdHVwbGVzWyAwIF1bIDIgXS5sb2NrLAoKCQkJCQkvLyBwcm9ncmVzc19oYW5kbGVycy5sb2NrCgkJCQkJdHVwbGVzWyAwIF1bIDMgXS5sb2NrCgkJCQkpOwoJCQl9CgoJCQkvLyBwcm9ncmVzc19oYW5kbGVycy5maXJlCgkJCS8vIGZ1bGZpbGxlZF9oYW5kbGVycy5maXJlCgkJCS8vIHJlamVjdGVkX2hhbmRsZXJzLmZpcmUKCQkJbGlzdC5hZGQoIHR1cGxlWyAzIF0uZmlyZSApOwoKCQkJLy8gZGVmZXJyZWQubm90aWZ5ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLm5vdGlmeVdpdGgoLi4uKSB9CgkJCS8vIGRlZmVycmVkLnJlc29sdmUgPSBmdW5jdGlvbigpIHsgZGVmZXJyZWQucmVzb2x2ZVdpdGgoLi4uKSB9CgkJCS8vIGRlZmVycmVkLnJlamVjdCA9IGZ1bmN0aW9uKCkgeyBkZWZlcnJlZC5yZWplY3RXaXRoKC4uLikgfQoJCQlkZWZlcnJlZFsgdHVwbGVbIDAgXSBdID0gZnVuY3Rpb24oKSB7CgkJCQlkZWZlcnJlZFsgdHVwbGVbIDAgXSArICJXaXRoIiBdKCB0aGlzID09PSBkZWZlcnJlZCA/IHVuZGVmaW5lZCA6IHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX07CgoJCQkvLyBkZWZlcnJlZC5ub3RpZnlXaXRoID0gbGlzdC5maXJlV2l0aAoJCQkvLyBkZWZlcnJlZC5yZXNvbHZlV2l0aCA9IGxpc3QuZmlyZVdpdGgKCQkJLy8gZGVmZXJyZWQucmVqZWN0V2l0aCA9IGxpc3QuZmlyZVdpdGgKCQkJZGVmZXJyZWRbIHR1cGxlWyAwIF0gKyAiV2l0aCIgXSA9IGxpc3QuZmlyZVdpdGg7CgkJfSApOwoKCQkvLyBNYWtlIHRoZSBkZWZlcnJlZCBhIHByb21pc2UKCQlwcm9taXNlLnByb21pc2UoIGRlZmVycmVkICk7CgoJCS8vIENhbGwgZ2l2ZW4gZnVuYyBpZiBhbnkKCQlpZiAoIGZ1bmMgKSB7CgkJCWZ1bmMuY2FsbCggZGVmZXJyZWQsIGRlZmVycmVkICk7CgkJfQoKCQkvLyBBbGwgZG9uZSEKCQlyZXR1cm4gZGVmZXJyZWQ7Cgl9LAoKCS8vIERlZmVycmVkIGhlbHBlcgoJd2hlbjogZnVuY3Rpb24oIHNpbmdsZVZhbHVlICkgewoJCXZhcgoKCQkJLy8gY291bnQgb2YgdW5jb21wbGV0ZWQgc3Vib3JkaW5hdGVzCgkJCXJlbWFpbmluZyA9IGFyZ3VtZW50cy5sZW5ndGgsCgoJCQkvLyBjb3VudCBvZiB1bnByb2Nlc3NlZCBhcmd1bWVudHMKCQkJaSA9IHJlbWFpbmluZywKCgkJCS8vIHN1Ym9yZGluYXRlIGZ1bGZpbGxtZW50IGRhdGEKCQkJcmVzb2x2ZUNvbnRleHRzID0gQXJyYXkoIGkgKSwKCQkJcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cyApLAoKCQkJLy8gdGhlIG1hc3RlciBEZWZlcnJlZAoJCQltYXN0ZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKCgkJCS8vIHN1Ym9yZGluYXRlIGNhbGxiYWNrIGZhY3RvcnkKCQkJdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXNvbHZlQ29udGV4dHNbIGkgXSA9IHRoaXM7CgkJCQkJcmVzb2x2ZVZhbHVlc1sgaSBdID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOwoJCQkJCWlmICggISggLS1yZW1haW5pbmcgKSApIHsKCQkJCQkJbWFzdGVyLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9OwoKCQkvLyBTaW5nbGUtIGFuZCBlbXB0eSBhcmd1bWVudHMgYXJlIGFkb3B0ZWQgbGlrZSBQcm9taXNlLnJlc29sdmUKCQlpZiAoIHJlbWFpbmluZyA8PSAxICkgewoJCQlhZG9wdFZhbHVlKCBzaW5nbGVWYWx1ZSwgbWFzdGVyLmRvbmUoIHVwZGF0ZUZ1bmMoIGkgKSApLnJlc29sdmUsIG1hc3Rlci5yZWplY3QsCgkJCQkhcmVtYWluaW5nICk7CgoJCQkvLyBVc2UgLnRoZW4oKSB0byB1bndyYXAgc2Vjb25kYXJ5IHRoZW5hYmxlcyAoY2YuIGdoLTMwMDApCgkJCWlmICggbWFzdGVyLnN0YXRlKCkgPT09ICJwZW5kaW5nIiB8fAoJCQkJaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdICYmIHJlc29sdmVWYWx1ZXNbIGkgXS50aGVuICkgKSB7CgoJCQkJcmV0dXJuIG1hc3Rlci50aGVuKCk7CgkJCX0KCQl9CgoJCS8vIE11bHRpcGxlIGFyZ3VtZW50cyBhcmUgYWdncmVnYXRlZCBsaWtlIFByb21pc2UuYWxsIGFycmF5IGVsZW1lbnRzCgkJd2hpbGUgKCBpLS0gKSB7CgkJCWFkb3B0VmFsdWUoIHJlc29sdmVWYWx1ZXNbIGkgXSwgdXBkYXRlRnVuYyggaSApLCBtYXN0ZXIucmVqZWN0ICk7CgkJfQoKCQlyZXR1cm4gbWFzdGVyLnByb21pc2UoKTsKCX0KfSApOwoKCi8vIFRoZXNlIHVzdWFsbHkgaW5kaWNhdGUgYSBwcm9ncmFtbWVyIG1pc3Rha2UgZHVyaW5nIGRldmVsb3BtZW50LAovLyB3YXJuIGFib3V0IHRoZW0gQVNBUCByYXRoZXIgdGhhbiBzd2FsbG93aW5nIHRoZW0gYnkgZGVmYXVsdC4KdmFyIHJlcnJvck5hbWVzID0gL14oRXZhbHxJbnRlcm5hbHxSYW5nZXxSZWZlcmVuY2V8U3ludGF4fFR5cGV8VVJJKUVycm9yJC87CgpqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayA9IGZ1bmN0aW9uKCBlcnJvciwgc3RhY2sgKSB7CgoJLy8gU3VwcG9ydDogSUUgOCAtIDkgb25seQoJLy8gQ29uc29sZSBleGlzdHMgd2hlbiBkZXYgdG9vbHMgYXJlIG9wZW4sIHdoaWNoIGNhbiBoYXBwZW4gYXQgYW55IHRpbWUKCWlmICggd2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUud2FybiAmJiBlcnJvciAmJiByZXJyb3JOYW1lcy50ZXN0KCBlcnJvci5uYW1lICkgKSB7CgkJd2luZG93LmNvbnNvbGUud2FybiggImpRdWVyeS5EZWZlcnJlZCBleGNlcHRpb246ICIgKyBlcnJvci5tZXNzYWdlLCBlcnJvci5zdGFjaywgc3RhY2sgKTsKCX0KfTsKCgoKCmpRdWVyeS5yZWFkeUV4Y2VwdGlvbiA9IGZ1bmN0aW9uKCBlcnJvciApIHsKCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQl0aHJvdyBlcnJvcjsKCX0gKTsKfTsKCgoKCi8vIFRoZSBkZWZlcnJlZCB1c2VkIG9uIERPTSByZWFkeQp2YXIgcmVhZHlMaXN0ID0galF1ZXJ5LkRlZmVycmVkKCk7CgpqUXVlcnkuZm4ucmVhZHkgPSBmdW5jdGlvbiggZm4gKSB7CgoJcmVhZHlMaXN0CgkJLnRoZW4oIGZuICkKCgkJLy8gV3JhcCBqUXVlcnkucmVhZHlFeGNlcHRpb24gaW4gYSBmdW5jdGlvbiBzbyB0aGF0IHRoZSBsb29rdXAKCQkvLyBoYXBwZW5zIGF0IHRoZSB0aW1lIG9mIGVycm9yIGhhbmRsaW5nIGluc3RlYWQgb2YgY2FsbGJhY2sKCQkvLyByZWdpc3RyYXRpb24uCgkJLmNhdGNoKCBmdW5jdGlvbiggZXJyb3IgKSB7CgkJCWpRdWVyeS5yZWFkeUV4Y2VwdGlvbiggZXJyb3IgKTsKCQl9ICk7CgoJcmV0dXJuIHRoaXM7Cn07CgpqUXVlcnkuZXh0ZW5kKCB7CgoJLy8gSXMgdGhlIERPTSByZWFkeSB0byBiZSB1c2VkPyBTZXQgdG8gdHJ1ZSBvbmNlIGl0IG9jY3Vycy4KCWlzUmVhZHk6IGZhbHNlLAoKCS8vIEEgY291bnRlciB0byB0cmFjayBob3cgbWFueSBpdGVtcyB0byB3YWl0IGZvciBiZWZvcmUKCS8vIHRoZSByZWFkeSBldmVudCBmaXJlcy4gU2VlICM2NzgxCglyZWFkeVdhaXQ6IDEsCgoJLy8gSGFuZGxlIHdoZW4gdGhlIERPTSBpcyByZWFkeQoJcmVhZHk6IGZ1bmN0aW9uKCB3YWl0ICkgewoKCQkvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CgkJaWYgKCB3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQoJCWpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKCgkJLy8gSWYgYSBub3JtYWwgRE9NIFJlYWR5IGV2ZW50IGZpcmVkLCBkZWNyZW1lbnQsIGFuZCB3YWl0IGlmIG5lZWQgYmUKCQlpZiAoIHdhaXQgIT09IHRydWUgJiYgLS1qUXVlcnkucmVhZHlXYWl0ID4gMCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgdGhlcmUgYXJlIGZ1bmN0aW9ucyBib3VuZCwgdG8gZXhlY3V0ZQoJCXJlYWR5TGlzdC5yZXNvbHZlV2l0aCggZG9jdW1lbnQsIFsgalF1ZXJ5IF0gKTsKCX0KfSApOwoKalF1ZXJ5LnJlYWR5LnRoZW4gPSByZWFkeUxpc3QudGhlbjsKCi8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCmZ1bmN0aW9uIGNvbXBsZXRlZCgpIHsKCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkICk7Cgl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQgKTsKCWpRdWVyeS5yZWFkeSgpOwp9CgovLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZAovLyBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KLy8gU3VwcG9ydDogSUUgPD05IC0gMTAgb25seQovLyBPbGRlciBJRSBzb21ldGltZXMgc2lnbmFscyAiaW50ZXJhY3RpdmUiIHRvbyBzb29uCmlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiB8fAoJKCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAibG9hZGluZyIgJiYgIWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCApICkgewoKCS8vIEhhbmRsZSBpdCBhc3luY2hyb25vdXNseSB0byBhbGxvdyBzY3JpcHRzIHRoZSBvcHBvcnR1bml0eSB0byBkZWxheSByZWFkeQoJd2luZG93LnNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoKfSBlbHNlIHsKCgkvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCApOwoKCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQgKTsKfQoKCgoKLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCi8vIFRoZSB2YWx1ZS9zIGNhbiBvcHRpb25hbGx5IGJlIGV4ZWN1dGVkIGlmIGl0J3MgYSBmdW5jdGlvbgp2YXIgYWNjZXNzID0gZnVuY3Rpb24oIGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3ICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IGVsZW1zLmxlbmd0aCwKCQlidWxrID0ga2V5ID09IG51bGw7CgoJLy8gU2V0cyBtYW55IHZhbHVlcwoJaWYgKCB0b1R5cGUoIGtleSApID09PSAib2JqZWN0IiApIHsKCQljaGFpbmFibGUgPSB0cnVlOwoJCWZvciAoIGkgaW4ga2V5ICkgewoJCQlhY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5WyBpIF0sIHRydWUsIGVtcHR5R2V0LCByYXcgKTsKCQl9CgoJLy8gU2V0cyBvbmUgdmFsdWUKCX0gZWxzZSBpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJY2hhaW5hYmxlID0gdHJ1ZTsKCgkJaWYgKCAhaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmF3ID0gdHJ1ZTsKCQl9CgoJCWlmICggYnVsayApIHsKCgkJCS8vIEJ1bGsgb3BlcmF0aW9ucyBydW4gYWdhaW5zdCB0aGUgZW50aXJlIHNldAoJCQlpZiAoIHJhdyApIHsKCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwoJCQkJZm4gPSBudWxsOwoKCQkJLy8gLi4uZXhjZXB0IHdoZW4gZXhlY3V0aW5nIGZ1bmN0aW9uIHZhbHVlcwoJCQl9IGVsc2UgewoJCQkJYnVsayA9IGZuOwoJCQkJZm4gPSBmdW5jdGlvbiggZWxlbSwga2V5LCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gYnVsay5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdmFsdWUgKTsKCQkJCX07CgkJCX0KCQl9CgoJCWlmICggZm4gKSB7CgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJZm4oCgkJCQkJZWxlbXNbIGkgXSwga2V5LCByYXcgPwoJCQkJCXZhbHVlIDoKCQkJCQl2YWx1ZS5jYWxsKCBlbGVtc1sgaSBdLCBpLCBmbiggZWxlbXNbIGkgXSwga2V5ICkgKQoJCQkJKTsKCQkJfQoJCX0KCX0KCglpZiAoIGNoYWluYWJsZSApIHsKCQlyZXR1cm4gZWxlbXM7Cgl9CgoJLy8gR2V0cwoJaWYgKCBidWxrICkgewoJCXJldHVybiBmbi5jYWxsKCBlbGVtcyApOwoJfQoKCXJldHVybiBsZW4gPyBmbiggZWxlbXNbIDAgXSwga2V5ICkgOiBlbXB0eUdldDsKfTsKCgovLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKdmFyIHJtc1ByZWZpeCA9IC9eLW1zLS8sCglyZGFzaEFscGhhID0gLy0oW2Etel0pL2c7CgovLyBVc2VkIGJ5IGNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKZnVuY3Rpb24gZmNhbWVsQ2FzZSggYWxsLCBsZXR0ZXIgKSB7CglyZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7Cn0KCi8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKLy8gU3VwcG9ydDogSUUgPD05IC0gMTEsIEVkZ2UgMTIgLSAxNQovLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAoIzk1NzIpCmZ1bmN0aW9uIGNhbWVsQ2FzZSggc3RyaW5nICkgewoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBybXNQcmVmaXgsICJtcy0iICkucmVwbGFjZSggcmRhc2hBbHBoYSwgZmNhbWVsQ2FzZSApOwp9CnZhciBhY2NlcHREYXRhID0gZnVuY3Rpb24oIG93bmVyICkgewoKCS8vIEFjY2VwdHMgb25seToKCS8vICAtIE5vZGUKCS8vICAgIC0gTm9kZS5FTEVNRU5UX05PREUKCS8vICAgIC0gTm9kZS5ET0NVTUVOVF9OT0RFCgkvLyAgLSBPYmplY3QKCS8vICAgIC0gQW55CglyZXR1cm4gb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgfHwgISggK293bmVyLm5vZGVUeXBlICk7Cn07CgoKCgpmdW5jdGlvbiBEYXRhKCkgewoJdGhpcy5leHBhbmRvID0galF1ZXJ5LmV4cGFuZG8gKyBEYXRhLnVpZCsrOwp9CgpEYXRhLnVpZCA9IDE7CgpEYXRhLnByb3RvdHlwZSA9IHsKCgljYWNoZTogZnVuY3Rpb24oIG93bmVyICkgewoKCQkvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUKCQl2YXIgdmFsdWUgPSBvd25lclsgdGhpcy5leHBhbmRvIF07CgoJCS8vIElmIG5vdCwgY3JlYXRlIG9uZQoJCWlmICggIXZhbHVlICkgewoJCQl2YWx1ZSA9IHt9OwoKCQkJLy8gV2UgY2FuIGFjY2VwdCBkYXRhIGZvciBub24tZWxlbWVudCBub2RlcyBpbiBtb2Rlcm4gYnJvd3NlcnMsCgkJCS8vIGJ1dCB3ZSBzaG91bGQgbm90LCBzZWUgIzgzMzUuCgkJCS8vIEFsd2F5cyByZXR1cm4gYW4gZW1wdHkgb2JqZWN0LgoJCQlpZiAoIGFjY2VwdERhdGEoIG93bmVyICkgKSB7CgoJCQkJLy8gSWYgaXQgaXMgYSBub2RlIHVubGlrZWx5IHRvIGJlIHN0cmluZ2lmeS1lZCBvciBsb29wZWQgb3ZlcgoJCQkJLy8gdXNlIHBsYWluIGFzc2lnbm1lbnQKCQkJCWlmICggb3duZXIubm9kZVR5cGUgKSB7CgkJCQkJb3duZXJbIHRoaXMuZXhwYW5kbyBdID0gdmFsdWU7CgoJCQkJLy8gT3RoZXJ3aXNlIHNlY3VyZSBpdCBpbiBhIG5vbi1lbnVtZXJhYmxlIHByb3BlcnR5CgkJCQkvLyBjb25maWd1cmFibGUgbXVzdCBiZSB0cnVlIHRvIGFsbG93IHRoZSBwcm9wZXJ0eSB0byBiZQoJCQkJLy8gZGVsZXRlZCB3aGVuIGRhdGEgaXMgcmVtb3ZlZAoJCQkJfSBlbHNlIHsKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIG93bmVyLCB0aGlzLmV4cGFuZG8sIHsKCQkJCQkJdmFsdWU6IHZhbHVlLAoJCQkJCQljb25maWd1cmFibGU6IHRydWUKCQkJCQl9ICk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB2YWx1ZTsKCX0sCglzZXQ6IGZ1bmN0aW9uKCBvd25lciwgZGF0YSwgdmFsdWUgKSB7CgkJdmFyIHByb3AsCgkJCWNhY2hlID0gdGhpcy5jYWNoZSggb3duZXIgKTsKCgkJLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwoJCS8vIEFsd2F5cyB1c2UgY2FtZWxDYXNlIGtleSAoZ2gtMjI1NykKCQlpZiAoIHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiApIHsKCQkJY2FjaGVbIGNhbWVsQ2FzZSggZGF0YSApIF0gPSB2YWx1ZTsKCgkJLy8gSGFuZGxlOiBbIG93bmVyLCB7IHByb3BlcnRpZXMgfSBdIGFyZ3MKCQl9IGVsc2UgewoKCQkJLy8gQ29weSB0aGUgcHJvcGVydGllcyBvbmUtYnktb25lIHRvIHRoZSBjYWNoZSBvYmplY3QKCQkJZm9yICggcHJvcCBpbiBkYXRhICkgewoJCQkJY2FjaGVbIGNhbWVsQ2FzZSggcHJvcCApIF0gPSBkYXRhWyBwcm9wIF07CgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlOwoJfSwKCWdldDogZnVuY3Rpb24oIG93bmVyLCBrZXkgKSB7CgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcy5jYWNoZSggb3duZXIgKSA6CgoJCQkvLyBBbHdheXMgdXNlIGNhbWVsQ2FzZSBrZXkgKGdoLTIyNTcpCgkJCW93bmVyWyB0aGlzLmV4cGFuZG8gXSAmJiBvd25lclsgdGhpcy5leHBhbmRvIF1bIGNhbWVsQ2FzZSgga2V5ICkgXTsKCX0sCglhY2Nlc3M6IGZ1bmN0aW9uKCBvd25lciwga2V5LCB2YWx1ZSApIHsKCgkJLy8gSW4gY2FzZXMgd2hlcmUgZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBObyBrZXkgd2FzIHNwZWNpZmllZAoJCS8vICAgMi4gQSBzdHJpbmcga2V5IHdhcyBzcGVjaWZpZWQsIGJ1dCBubyB2YWx1ZSBwcm92aWRlZAoJCS8vCgkJLy8gVGFrZSB0aGUgInJlYWQiIHBhdGggYW5kIGFsbG93IHRoZSBnZXQgbWV0aG9kIHRvIGRldGVybWluZQoJCS8vIHdoaWNoIHZhbHVlIHRvIHJldHVybiwgcmVzcGVjdGl2ZWx5IGVpdGhlcjoKCQkvLwoJCS8vICAgMS4gVGhlIGVudGlyZSBjYWNoZSBvYmplY3QKCQkvLyAgIDIuIFRoZSBkYXRhIHN0b3JlZCBhdCB0aGUga2V5CgkJLy8KCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkIHx8CgkJCQkoICgga2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCApICkgewoKCQkJcmV0dXJuIHRoaXMuZ2V0KCBvd25lciwga2V5ICk7CgkJfQoKCQkvLyBXaGVuIHRoZSBrZXkgaXMgbm90IGEgc3RyaW5nLCBvciBib3RoIGEga2V5IGFuZCB2YWx1ZQoJCS8vIGFyZSBzcGVjaWZpZWQsIHNldCBvciBleHRlbmQgKGV4aXN0aW5nIG9iamVjdHMpIHdpdGggZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBBbiBvYmplY3Qgb2YgcHJvcGVydGllcwoJCS8vICAgMi4gQSBrZXkgYW5kIHZhbHVlCgkJLy8KCQl0aGlzLnNldCggb3duZXIsIGtleSwgdmFsdWUgKTsKCgkJLy8gU2luY2UgdGhlICJzZXQiIHBhdGggY2FuIGhhdmUgdHdvIHBvc3NpYmxlIGVudHJ5IHBvaW50cwoJCS8vIHJldHVybiB0aGUgZXhwZWN0ZWQgZGF0YSBiYXNlZCBvbiB3aGljaCBwYXRoIHdhcyB0YWtlblsqXQoJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiBrZXk7Cgl9LAoJcmVtb3ZlOiBmdW5jdGlvbiggb3duZXIsIGtleSApIHsKCQl2YXIgaSwKCQkJY2FjaGUgPSBvd25lclsgdGhpcy5leHBhbmRvIF07CgoJCWlmICggY2FjaGUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgIT09IHVuZGVmaW5lZCApIHsKCgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzCgkJCWlmICggQXJyYXkuaXNBcnJheSgga2V5ICkgKSB7CgoJCQkJLy8gSWYga2V5IGlzIGFuIGFycmF5IG9mIGtleXMuLi4KCQkJCS8vIFdlIGFsd2F5cyBzZXQgY2FtZWxDYXNlIGtleXMsIHNvIHJlbW92ZSB0aGF0LgoJCQkJa2V5ID0ga2V5Lm1hcCggY2FtZWxDYXNlICk7CgkJCX0gZWxzZSB7CgkJCQlrZXkgPSBjYW1lbENhc2UoIGtleSApOwoKCQkJCS8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KCQkJCS8vIE90aGVyd2lzZSwgY3JlYXRlIGFuIGFycmF5IGJ5IG1hdGNoaW5nIG5vbi13aGl0ZXNwYWNlCgkJCQlrZXkgPSBrZXkgaW4gY2FjaGUgPwoJCQkJCVsga2V5IF0gOgoJCQkJCSgga2V5Lm1hdGNoKCBybm90aHRtbHdoaXRlICkgfHwgW10gKTsKCQkJfQoKCQkJaSA9IGtleS5sZW5ndGg7CgoJCQl3aGlsZSAoIGktLSApIHsKCQkJCWRlbGV0ZSBjYWNoZVsga2V5WyBpIF0gXTsKCQkJfQoJCX0KCgkJLy8gUmVtb3ZlIHRoZSBleHBhbmRvIGlmIHRoZXJlJ3Mgbm8gbW9yZSBkYXRhCgkJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCB8fCBqUXVlcnkuaXNFbXB0eU9iamVjdCggY2FjaGUgKSApIHsKCgkJCS8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUKCQkJLy8gV2Via2l0ICYgQmxpbmsgcGVyZm9ybWFuY2Ugc3VmZmVycyB3aGVuIGRlbGV0aW5nIHByb3BlcnRpZXMKCQkJLy8gZnJvbSBET00gbm9kZXMsIHNvIHNldCB0byB1bmRlZmluZWQgaW5zdGVhZAoJCQkvLyBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zNzg2MDcgKGJ1ZyByZXN0cmljdGVkKQoJCQlpZiAoIG93bmVyLm5vZGVUeXBlICkgewoJCQkJb3duZXJbIHRoaXMuZXhwYW5kbyBdID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJZGVsZXRlIG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCQkJfQoJCX0KCX0sCgloYXNEYXRhOiBmdW5jdGlvbiggb3duZXIgKSB7CgkJdmFyIGNhY2hlID0gb3duZXJbIHRoaXMuZXhwYW5kbyBdOwoJCXJldHVybiBjYWNoZSAhPT0gdW5kZWZpbmVkICYmICFqUXVlcnkuaXNFbXB0eU9iamVjdCggY2FjaGUgKTsKCX0KfTsKdmFyIGRhdGFQcml2ID0gbmV3IERhdGEoKTsKCnZhciBkYXRhVXNlciA9IG5ldyBEYXRhKCk7CgoKCi8vCUltcGxlbWVudGF0aW9uIFN1bW1hcnkKLy8KLy8JMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAovLwkyLiBJbXByb3ZlIHRoZSBtb2R1bGUncyBtYWludGFpbmFiaWxpdHkgYnkgcmVkdWNpbmcgdGhlIHN0b3JhZ2UKLy8JCXBhdGhzIHRvIGEgc2luZ2xlIG1lY2hhbmlzbS4KLy8JMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgovLwk0LiBfTmV2ZXJfIGV4cG9zZSAicHJpdmF0ZSIgZGF0YSB0byB1c2VyIGNvZGUgKFRPRE86IERyb3AgX2RhdGEsIF9yZW1vdmVEYXRhKQovLwk1LiBBdm9pZCBleHBvc2luZyBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzIG9uIHVzZXIgb2JqZWN0cyAoZWcuIGV4cGFuZG8gcHJvcGVydGllcykKLy8JNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0Cgp2YXIgcmJyYWNlID0gL14oPzpce1tcd1xXXSpcfXxcW1tcd1xXXSpcXSkkLywKCXJtdWx0aURhc2ggPSAvW0EtWl0vZzsKCmZ1bmN0aW9uIGdldERhdGEoIGRhdGEgKSB7CglpZiAoIGRhdGEgPT09ICJ0cnVlIiApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglpZiAoIGRhdGEgPT09ICJmYWxzZSIgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWlmICggZGF0YSA9PT0gIm51bGwiICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCglpZiAoIGRhdGEgPT09ICtkYXRhICsgIiIgKSB7CgkJcmV0dXJuICtkYXRhOwoJfQoKCWlmICggcmJyYWNlLnRlc3QoIGRhdGEgKSApIHsKCQlyZXR1cm4gSlNPTi5wYXJzZSggZGF0YSApOwoJfQoKCXJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBkYXRhQXR0ciggZWxlbSwga2V5LCBkYXRhICkgewoJdmFyIG5hbWU7CgoJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQoJLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCglpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCW5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJCYiICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCXRyeSB7CgkJCQlkYXRhID0gZ2V0RGF0YSggZGF0YSApOwoJCQl9IGNhdGNoICggZSApIHt9CgoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKCQkJZGF0YVVzZXIuc2V0KCBlbGVtLCBrZXksIGRhdGEgKTsKCQl9IGVsc2UgewoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0KCX0KCXJldHVybiBkYXRhOwp9CgpqUXVlcnkuZXh0ZW5kKCB7CgloYXNEYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZGF0YVVzZXIuaGFzRGF0YSggZWxlbSApIHx8IGRhdGFQcml2Lmhhc0RhdGEoIGVsZW0gKTsKCX0sCgoJZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGRhdGFVc2VyLmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlkYXRhVXNlci5yZW1vdmUoIGVsZW0sIG5hbWUgKTsKCX0sCgoJLy8gVE9ETzogTm93IHRoYXQgYWxsIGNhbGxzIHRvIF9kYXRhIGFuZCBfcmVtb3ZlRGF0YSBoYXZlIGJlZW4gcmVwbGFjZWQKCS8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFQcml2IG1ldGhvZHMsIHRoZXNlIGNhbiBiZSBkZXByZWNhdGVkLgoJX2RhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBkYXRhICkgewoJCXJldHVybiBkYXRhUHJpdi5hY2Nlc3MoIGVsZW0sIG5hbWUsIGRhdGEgKTsKCX0sCgoJX3JlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgbmFtZSApOwoJfQp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CglkYXRhOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgaSwgbmFtZSwgZGF0YSwKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKCgkJLy8gR2V0cyBhbGwgdmFsdWVzCgkJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJCWRhdGEgPSBkYXRhVXNlci5nZXQoIGVsZW0gKTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFQcml2LmdldCggZWxlbSwgImhhc0RhdGFBdHRycyIgKSApIHsKCQkJCQlpID0gYXR0cnMubGVuZ3RoOwoJCQkJCXdoaWxlICggaS0tICkgewoKCQkJCQkJLy8gU3VwcG9ydDogSUUgMTEgb25seQoJCQkJCQkvLyBUaGUgYXR0cnMgZWxlbWVudHMgY2FuIGJlIG51bGwgKCMxNDg5NCkKCQkJCQkJaWYgKCBhdHRyc1sgaSBdICkgewoJCQkJCQkJbmFtZSA9IGF0dHJzWyBpIF0ubmFtZTsKCQkJCQkJCWlmICggbmFtZS5pbmRleE9mKCAiZGF0YS0iICkgPT09IDAgKSB7CgkJCQkJCQkJbmFtZSA9IGNhbWVsQ2FzZSggbmFtZS5zbGljZSggNSApICk7CgkJCQkJCQkJZGF0YUF0dHIoIGVsZW0sIG5hbWUsIGRhdGFbIG5hbWUgXSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWRhdGFQcml2LnNldCggZWxlbSwgImhhc0RhdGFBdHRycyIsIHRydWUgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGRhdGE7CgkJfQoKCQkvLyBTZXRzIG11bHRpcGxlIHZhbHVlcwoJCWlmICggdHlwZW9mIGtleSA9PT0gIm9iamVjdCIgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJZGF0YVVzZXIuc2V0KCB0aGlzLCBrZXkgKTsKCQkJfSApOwoJCX0KCgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZGF0YTsKCgkJCS8vIFRoZSBjYWxsaW5nIGpRdWVyeSBvYmplY3QgKGVsZW1lbnQgbWF0Y2hlcykgaXMgbm90IGVtcHR5CgkJCS8vIChhbmQgdGhlcmVmb3JlIGhhcyBhbiBlbGVtZW50IGFwcGVhcnMgYXQgdGhpc1sgMCBdKSBhbmQgdGhlCgkJCS8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CgkJCS8vIHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGZvciBlbGVtID0gdGhpc1sgMCBdIHdoaWNoIHdpbGwKCQkJLy8gdGhyb3cgYW4gZXhjZXB0aW9uIGlmIGFuIGF0dGVtcHQgdG8gcmVhZCBhIGRhdGEgY2FjaGUgaXMgbWFkZS4KCQkJaWYgKCBlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQoJCQkJLy8gVGhlIGtleSB3aWxsIGFsd2F5cyBiZSBjYW1lbENhc2VkIGluIERhdGEKCQkJCWRhdGEgPSBkYXRhVXNlci5nZXQoIGVsZW0sIGtleSApOwoJCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9CgoJCQkJLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCgkJCQkvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCgkJCQlkYXRhID0gZGF0YUF0dHIoIGVsZW0sIGtleSApOwoJCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9CgoJCQkJLy8gV2UgdHJpZWQgcmVhbGx5IGhhcmQsIGJ1dCB0aGUgZGF0YSBkb2Vzbid0IGV4aXN0LgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGRhdGEuLi4KCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCgkJCQkvLyBXZSBhbHdheXMgc3RvcmUgdGhlIGNhbWVsQ2FzZWQga2V5CgkJCQlkYXRhVXNlci5zZXQoIHRoaXMsIGtleSwgdmFsdWUgKTsKCQkJfSApOwoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSwgbnVsbCwgdHJ1ZSApOwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbigga2V5ICkgewoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlkYXRhVXNlci5yZW1vdmUoIHRoaXMsIGtleSApOwoJCX0gKTsKCX0KfSApOwoKCmpRdWVyeS5leHRlbmQoIHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQl2YXIgcXVldWU7CgoJCWlmICggZWxlbSApIHsKCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwoJCQlxdWV1ZSA9IGRhdGFQcml2LmdldCggZWxlbSwgdHlwZSApOwoKCQkJLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAoJCQlpZiAoIGRhdGEgKSB7CgkJCQlpZiAoICFxdWV1ZSB8fCBBcnJheS5pc0FycmF5KCBkYXRhICkgKSB7CgkJCQkJcXVldWUgPSBkYXRhUHJpdi5hY2Nlc3MoIGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoIGRhdGEgKSApOwoJCQkJfSBlbHNlIHsKCQkJCQlxdWV1ZS5wdXNoKCBkYXRhICk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHF1ZXVlIHx8IFtdOwoJCX0KCX0sCgoJZGVxdWV1ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKCBlbGVtLCB0eXBlICksCgkJCXN0YXJ0TGVuZ3RoID0gcXVldWUubGVuZ3RoLAoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCksCgkJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCB0eXBlICksCgkJCW5leHQgPSBmdW5jdGlvbigpIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCBlbGVtLCB0eXBlICk7CgkJCX07CgoJCS8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKCQlpZiAoIGZuID09PSAiaW5wcm9ncmVzcyIgKSB7CgkJCWZuID0gcXVldWUuc2hpZnQoKTsKCQkJc3RhcnRMZW5ndGgtLTsKCQl9CgoJCWlmICggZm4gKSB7CgoJCQkvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCgkJCS8vIGF1dG9tYXRpY2FsbHkgZGVxdWV1ZWQKCQkJaWYgKCB0eXBlID09PSAiZngiICkgewoJCQkJcXVldWUudW5zaGlmdCggImlucHJvZ3Jlc3MiICk7CgkJCX0KCgkJCS8vIENsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCWZuLmNhbGwoIGVsZW0sIG5leHQsIGhvb2tzICk7CgkJfQoKCQlpZiAoICFzdGFydExlbmd0aCAmJiBob29rcyApIHsKCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCX0KCX0sCgoJLy8gTm90IHB1YmxpYyAtIGdlbmVyYXRlIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybiB0aGUgY3VycmVudCBvbmUKCV9xdWV1ZUhvb2tzOiBmdW5jdGlvbiggZWxlbSwgdHlwZSApIHsKCQl2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKCQlyZXR1cm4gZGF0YVByaXYuZ2V0KCBlbGVtLCBrZXkgKSB8fCBkYXRhUHJpdi5hY2Nlc3MoIGVsZW0sIGtleSwgewoJCQllbXB0eTogalF1ZXJ5LkNhbGxiYWNrcyggIm9uY2UgbWVtb3J5IiApLmFkZCggZnVuY3Rpb24oKSB7CgkJCQlkYXRhUHJpdi5yZW1vdmUoIGVsZW0sIFsgdHlwZSArICJxdWV1ZSIsIGtleSBdICk7CgkJCX0gKQoJCX0gKTsKCX0KfSApOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1sgMCBdLCB0eXBlICk7CgkJfQoKCQlyZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBFbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWyAwIF0gIT09ICJpbnByb2dyZXNzIiApIHsKCQkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQkJfQoJCQl9ICk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJfSApOwoJfSwKCWNsZWFyUXVldWU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCXJldHVybiB0aGlzLnF1ZXVlKCB0eXBlIHx8ICJmeCIsIFtdICk7Cgl9LAoKCS8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKCS8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQoJcHJvbWlzZTogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQl2YXIgdG1wLAoJCQljb3VudCA9IDEsCgkJCWRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWVsZW1lbnRzID0gdGhpcywKCQkJaSA9IHRoaXMubGVuZ3RoLAoJCQlyZXNvbHZlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoICEoIC0tY291bnQgKSApIHsKCQkJCQlkZWZlci5yZXNvbHZlV2l0aCggZWxlbWVudHMsIFsgZWxlbWVudHMgXSApOwoJCQkJfQoJCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJb2JqID0gdHlwZTsKCQkJdHlwZSA9IHVuZGVmaW5lZDsKCQl9CgkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCgkJd2hpbGUgKCBpLS0gKSB7CgkJCXRtcCA9IGRhdGFQcml2LmdldCggZWxlbWVudHNbIGkgXSwgdHlwZSArICJxdWV1ZUhvb2tzIiApOwoJCQlpZiAoIHRtcCAmJiB0bXAuZW1wdHkgKSB7CgkJCQljb3VudCsrOwoJCQkJdG1wLmVtcHR5LmFkZCggcmVzb2x2ZSApOwoJCQl9CgkJfQoJCXJlc29sdmUoKTsKCQlyZXR1cm4gZGVmZXIucHJvbWlzZSggb2JqICk7Cgl9Cn0gKTsKdmFyIHBudW0gPSAoIC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8gKS5zb3VyY2U7Cgp2YXIgcmNzc051bSA9IG5ldyBSZWdFeHAoICJeKD86KFsrLV0pPXwpKCIgKyBwbnVtICsgIikoW2EteiVdKikkIiwgImkiICk7CgoKdmFyIGNzc0V4cGFuZCA9IFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXTsKCnZhciBpc0hpZGRlbldpdGhpblRyZWUgPSBmdW5jdGlvbiggZWxlbSwgZWwgKSB7CgoJCS8vIGlzSGlkZGVuV2l0aGluVHJlZSBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwoJCS8vIGluIHRoYXQgY2FzZSwgZWxlbWVudCB3aWxsIGJlIHNlY29uZCBhcmd1bWVudAoJCWVsZW0gPSBlbCB8fCBlbGVtOwoKCQkvLyBJbmxpbmUgc3R5bGUgdHJ1bXBzIGFsbAoJCXJldHVybiBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICJub25lIiB8fAoJCQllbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmCgoJCQkvLyBPdGhlcndpc2UsIGNoZWNrIGNvbXB1dGVkIHN0eWxlCgkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00MyAtIDQ1CgkJCS8vIERpc2Nvbm5lY3RlZCBlbGVtZW50cyBjYW4gaGF2ZSBjb21wdXRlZCBkaXNwbGF5OiBub25lLCBzbyBmaXJzdCBjb25maXJtIHRoYXQgZWxlbSBpcwoJCQkvLyBpbiB0aGUgZG9jdW1lbnQuCgkJCWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgJiYKCgkJCWpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSI7Cgl9OwoKdmFyIHN3YXAgPSBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgY2FsbGJhY2ssIGFyZ3MgKSB7Cgl2YXIgcmV0LCBuYW1lLAoJCW9sZCA9IHt9OwoKCS8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwoJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9wdGlvbnNbIG5hbWUgXTsKCX0KCglyZXQgPSBjYWxsYmFjay5hcHBseSggZWxlbSwgYXJncyB8fCBbXSApOwoKCS8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwoJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJfQoKCXJldHVybiByZXQ7Cn07CgoKCgpmdW5jdGlvbiBhZGp1c3RDU1MoIGVsZW0sIHByb3AsIHZhbHVlUGFydHMsIHR3ZWVuICkgewoJdmFyIGFkanVzdGVkLCBzY2FsZSwKCQltYXhJdGVyYXRpb25zID0gMjAsCgkJY3VycmVudFZhbHVlID0gdHdlZW4gPwoJCQlmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0d2Vlbi5jdXIoKTsKCQkJfSA6CgkJCWZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sIHByb3AsICIiICk7CgkJCX0sCgkJaW5pdGlhbCA9IGN1cnJlbnRWYWx1ZSgpLAoJCXVuaXQgPSB2YWx1ZVBhcnRzICYmIHZhbHVlUGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkvLyBTdGFydGluZyB2YWx1ZSBjb21wdXRhdGlvbiBpcyByZXF1aXJlZCBmb3IgcG90ZW50aWFsIHVuaXQgbWlzbWF0Y2hlcwoJCWluaXRpYWxJblVuaXQgPSAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSB8fCB1bml0ICE9PSAicHgiICYmICtpbml0aWFsICkgJiYKCQkJcmNzc051bS5leGVjKCBqUXVlcnkuY3NzKCBlbGVtLCBwcm9wICkgKTsKCglpZiAoIGluaXRpYWxJblVuaXQgJiYgaW5pdGlhbEluVW5pdFsgMyBdICE9PSB1bml0ICkgewoKCQkvLyBTdXBwb3J0OiBGaXJlZm94IDw9NTQKCQkvLyBIYWx2ZSB0aGUgaXRlcmF0aW9uIHRhcmdldCB2YWx1ZSB0byBwcmV2ZW50IGludGVyZmVyZW5jZSBmcm9tIENTUyB1cHBlciBib3VuZHMgKGdoLTIxNDQpCgkJaW5pdGlhbCA9IGluaXRpYWwgLyAyOwoKCQkvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCgkJdW5pdCA9IHVuaXQgfHwgaW5pdGlhbEluVW5pdFsgMyBdOwoKCQkvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAoJCWluaXRpYWxJblVuaXQgPSAraW5pdGlhbCB8fCAxOwoKCQl3aGlsZSAoIG1heEl0ZXJhdGlvbnMtLSApIHsKCgkJCS8vIEV2YWx1YXRlIGFuZCB1cGRhdGUgb3VyIGJlc3QgZ3Vlc3MgKGRvdWJsaW5nIGd1ZXNzZXMgdGhhdCB6ZXJvIG91dCkuCgkJCS8vIEZpbmlzaCBpZiB0aGUgc2NhbGUgZXF1YWxzIG9yIGNyb3NzZXMgMSAobWFraW5nIHRoZSBvbGQqbmV3IHByb2R1Y3Qgbm9uLXBvc2l0aXZlKS4KCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCApOwoJCQlpZiAoICggMSAtIHNjYWxlICkgKiAoIDEgLSAoIHNjYWxlID0gY3VycmVudFZhbHVlKCkgLyBpbml0aWFsIHx8IDAuNSApICkgPD0gMCApIHsKCQkJCW1heEl0ZXJhdGlvbnMgPSAwOwoJCQl9CgkJCWluaXRpYWxJblVuaXQgPSBpbml0aWFsSW5Vbml0IC8gc2NhbGU7CgoJCX0KCgkJaW5pdGlhbEluVW5pdCA9IGluaXRpYWxJblVuaXQgKiAyOwoJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgaW5pdGlhbEluVW5pdCArIHVuaXQgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgdHdlZW4gcHJvcGVydGllcyBsYXRlciBvbgoJCXZhbHVlUGFydHMgPSB2YWx1ZVBhcnRzIHx8IFtdOwoJfQoKCWlmICggdmFsdWVQYXJ0cyApIHsKCQlpbml0aWFsSW5Vbml0ID0gK2luaXRpYWxJblVuaXQgfHwgK2luaXRpYWwgfHwgMDsKCgkJLy8gQXBwbHkgcmVsYXRpdmUgb2Zmc2V0ICgrPS8tPSkgaWYgc3BlY2lmaWVkCgkJYWRqdXN0ZWQgPSB2YWx1ZVBhcnRzWyAxIF0gPwoJCQlpbml0aWFsSW5Vbml0ICsgKCB2YWx1ZVBhcnRzWyAxIF0gKyAxICkgKiB2YWx1ZVBhcnRzWyAyIF0gOgoJCQkrdmFsdWVQYXJ0c1sgMiBdOwoJCWlmICggdHdlZW4gKSB7CgkJCXR3ZWVuLnVuaXQgPSB1bml0OwoJCQl0d2Vlbi5zdGFydCA9IGluaXRpYWxJblVuaXQ7CgkJCXR3ZWVuLmVuZCA9IGFkanVzdGVkOwoJCX0KCX0KCXJldHVybiBhZGp1c3RlZDsKfQoKCnZhciBkZWZhdWx0RGlzcGxheU1hcCA9IHt9OwoKZnVuY3Rpb24gZ2V0RGVmYXVsdERpc3BsYXkoIGVsZW0gKSB7Cgl2YXIgdGVtcCwKCQlkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQsCgkJbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLAoJCWRpc3BsYXkgPSBkZWZhdWx0RGlzcGxheU1hcFsgbm9kZU5hbWUgXTsKCglpZiAoIGRpc3BsYXkgKSB7CgkJcmV0dXJuIGRpc3BsYXk7Cgl9CgoJdGVtcCA9IGRvYy5ib2R5LmFwcGVuZENoaWxkKCBkb2MuY3JlYXRlRWxlbWVudCggbm9kZU5hbWUgKSApOwoJZGlzcGxheSA9IGpRdWVyeS5jc3MoIHRlbXAsICJkaXNwbGF5IiApOwoKCXRlbXAucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggdGVtcCApOwoKCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCWRpc3BsYXkgPSAiYmxvY2siOwoJfQoJZGVmYXVsdERpc3BsYXlNYXBbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwoKCXJldHVybiBkaXNwbGF5Owp9CgpmdW5jdGlvbiBzaG93SGlkZSggZWxlbWVudHMsIHNob3cgKSB7Cgl2YXIgZGlzcGxheSwgZWxlbSwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCS8vIERldGVybWluZSBuZXcgZGlzcGxheSB2YWx1ZSBmb3IgZWxlbWVudHMgdGhhdCBuZWVkIHRvIGNoYW5nZQoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQllbGVtID0gZWxlbWVudHNbIGluZGV4IF07CgkJaWYgKCAhZWxlbS5zdHlsZSApIHsKCQkJY29udGludWU7CgkJfQoKCQlkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwoJCWlmICggc2hvdyApIHsKCgkJCS8vIFNpbmNlIHdlIGZvcmNlIHZpc2liaWxpdHkgdXBvbiBjYXNjYWRlLWhpZGRlbiBlbGVtZW50cywgYW4gaW1tZWRpYXRlIChhbmQgc2xvdykKCQkJLy8gY2hlY2sgaXMgcmVxdWlyZWQgaW4gdGhpcyBmaXJzdCBsb29wIHVubGVzcyB3ZSBoYXZlIGEgbm9uZW1wdHkgZGlzcGxheSB2YWx1ZSAoZWl0aGVyCgkJCS8vIGlubGluZSBvciBhYm91dC10by1iZS1yZXN0b3JlZCkKCQkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgKSB7CgkJCQl2YWx1ZXNbIGluZGV4IF0gPSBkYXRhUHJpdi5nZXQoIGVsZW0sICJkaXNwbGF5IiApIHx8IG51bGw7CgkJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gKSB7CgkJCQkJZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CgkJCQl9CgkJCX0KCQkJaWYgKCBlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuV2l0aGluVHJlZSggZWxlbSApICkgewoJCQkJdmFsdWVzWyBpbmRleCBdID0gZ2V0RGVmYXVsdERpc3BsYXkoIGVsZW0gKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWlmICggZGlzcGxheSAhPT0gIm5vbmUiICkgewoJCQkJdmFsdWVzWyBpbmRleCBdID0gIm5vbmUiOwoKCQkJCS8vIFJlbWVtYmVyIHdoYXQgd2UncmUgb3ZlcndyaXRpbmcKCQkJCWRhdGFQcml2LnNldCggZWxlbSwgImRpc3BsYXkiLCBkaXNwbGF5ICk7CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wIHRvIGF2b2lkIGNvbnN0YW50IHJlZmxvdwoJZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoIHZhbHVlc1sgaW5kZXggXSAhPSBudWxsICkgewoJCQllbGVtZW50c1sgaW5kZXggXS5zdHlsZS5kaXNwbGF5ID0gdmFsdWVzWyBpbmRleCBdOwoJCX0KCX0KCglyZXR1cm4gZWxlbWVudHM7Cn0KCmpRdWVyeS5mbi5leHRlbmQoIHsKCXNob3c6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcywgdHJ1ZSApOwoJfSwKCWhpZGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBzaG93SGlkZSggdGhpcyApOwoJfSwKCXRvZ2dsZTogZnVuY3Rpb24oIHN0YXRlICkgewoJCWlmICggdHlwZW9mIHN0YXRlID09PSAiYm9vbGVhbiIgKSB7CgkJCXJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBpc0hpZGRlbldpdGhpblRyZWUoIHRoaXMgKSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnNob3coKTsKCQkJfSBlbHNlIHsKCQkJCWpRdWVyeSggdGhpcyApLmhpZGUoKTsKCQkJfQoJCX0gKTsKCX0KfSApOwp2YXIgcmNoZWNrYWJsZVR5cGUgPSAoIC9eKD86Y2hlY2tib3h8cmFkaW8pJC9pICk7Cgp2YXIgcnRhZ05hbWUgPSAoIC88KFthLXpdW15cL1wwPlx4MjBcdFxyXG5cZl0rKS9pICk7Cgp2YXIgcnNjcmlwdFR5cGUgPSAoIC9eJHxebW9kdWxlJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSApOwoKCgovLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQp2YXIgd3JhcE1hcCA9IHsKCgkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQoJb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKCgkvLyBYSFRNTCBwYXJzZXJzIGRvIG5vdCBtYWdpY2FsbHkgaW5zZXJ0IGVsZW1lbnRzIGluIHRoZQoJLy8gc2FtZSB3YXkgdGhhdCB0YWcgc291cCBwYXJzZXJzIGRvLiBTbyB3ZSBjYW5ub3Qgc2hvcnRlbgoJLy8gdGhpcyBieSBvbWl0dGluZyA8dGJvZHk+IG9yIG90aGVyIHJlcXVpcmVkIGVsZW1lbnRzLgoJdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCgljb2w6IFsgMiwgIjx0YWJsZT48Y29sZ3JvdXA+IiwgIjwvY29sZ3JvdXA+PC90YWJsZT4iIF0sCgl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKCXRkOiBbIDMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+IiBdLAoKCV9kZWZhdWx0OiBbIDAsICIiLCAiIiBdCn07CgovLyBTdXBwb3J0OiBJRSA8PTkgb25seQp3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247Cgp3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwp3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCgpmdW5jdGlvbiBnZXRBbGwoIGNvbnRleHQsIHRhZyApIHsKCgkvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CgkvLyBVc2UgdHlwZW9mIHRvIGF2b2lkIHplcm8tYXJndW1lbnQgbWV0aG9kIGludm9jYXRpb24gb24gaG9zdCBvYmplY3RzICgjMTUxNTEpCgl2YXIgcmV0OwoKCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCXJldCA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyB8fCAiKiIgKTsKCgl9IGVsc2UgaWYgKCB0eXBlb2YgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsICE9PSAidW5kZWZpbmVkIiApIHsKCQlyZXQgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoIHRhZyB8fCAiKiIgKTsKCgl9IGVsc2UgewoJCXJldCA9IFtdOwoJfQoKCWlmICggdGFnID09PSB1bmRlZmluZWQgfHwgdGFnICYmIG5vZGVOYW1lKCBjb250ZXh0LCB0YWcgKSApIHsKCQlyZXR1cm4galF1ZXJ5Lm1lcmdlKCBbIGNvbnRleHQgXSwgcmV0ICk7Cgl9CgoJcmV0dXJuIHJldDsKfQoKCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7Cgl2YXIgaSA9IDAsCgkJbCA9IGVsZW1zLmxlbmd0aDsKCglmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJZGF0YVByaXYuc2V0KAoJCQllbGVtc1sgaSBdLAoJCQkiZ2xvYmFsRXZhbCIsCgkJCSFyZWZFbGVtZW50cyB8fCBkYXRhUHJpdi5nZXQoIHJlZkVsZW1lbnRzWyBpIF0sICJnbG9iYWxFdmFsIiApCgkJKTsKCX0KfQoKCnZhciByaHRtbCA9IC88fCYjP1x3KzsvOwoKZnVuY3Rpb24gYnVpbGRGcmFnbWVudCggZWxlbXMsIGNvbnRleHQsIHNjcmlwdHMsIHNlbGVjdGlvbiwgaWdub3JlZCApIHsKCXZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosCgkJZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQlub2RlcyA9IFtdLAoJCWkgPSAwLAoJCWwgPSBlbGVtcy5sZW5ndGg7CgoJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCWVsZW0gPSBlbGVtc1sgaSBdOwoKCQlpZiAoIGVsZW0gfHwgZWxlbSA9PT0gMCApIHsKCgkJCS8vIEFkZCBub2RlcyBkaXJlY3RseQoJCQlpZiAoIHRvVHlwZSggZWxlbSApID09PSAib2JqZWN0IiApIHsKCgkJCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKCQkJCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIGVsZW0ubm9kZVR5cGUgPyBbIGVsZW0gXSA6IGVsZW0gKTsKCgkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQoJCQl9IGVsc2UgaWYgKCAhcmh0bWwudGVzdCggZWxlbSApICkgewoJCQkJbm9kZXMucHVzaCggY29udGV4dC5jcmVhdGVUZXh0Tm9kZSggZWxlbSApICk7CgoJCQkvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKCQkJfSBlbHNlIHsKCQkJCXRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZCggY29udGV4dC5jcmVhdGVFbGVtZW50KCAiZGl2IiApICk7CgoJCQkJLy8gRGVzZXJpYWxpemUgYSBzdGFuZGFyZCByZXByZXNlbnRhdGlvbgoJCQkJdGFnID0gKCBydGFnTmFtZS5leGVjKCBlbGVtICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKTsKCQkJCXdyYXAgPSB3cmFwTWFwWyB0YWcgXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwoJCQkJdG1wLmlubmVySFRNTCA9IHdyYXBbIDEgXSArIGpRdWVyeS5odG1sUHJlZmlsdGVyKCBlbGVtICkgKyB3cmFwWyAyIF07CgoJCQkJLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50CgkJCQlqID0gd3JhcFsgMCBdOwoJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJdG1wID0gdG1wLmxhc3RDaGlsZDsKCQkJCX0KCgkJCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKCQkJCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7CgoJCQkJLy8gUmVtZW1iZXIgdGhlIHRvcC1sZXZlbCBjb250YWluZXIKCQkJCXRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CgoJCQkJLy8gRW5zdXJlIHRoZSBjcmVhdGVkIG5vZGVzIGFyZSBvcnBoYW5lZCAoIzEyMzkyKQoJCQkJdG1wLnRleHRDb250ZW50ID0gIiI7CgkJCX0KCQl9Cgl9CgoJLy8gUmVtb3ZlIHdyYXBwZXIgZnJvbSBmcmFnbWVudAoJZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKCglpID0gMDsKCXdoaWxlICggKCBlbGVtID0gbm9kZXNbIGkrKyBdICkgKSB7CgoJCS8vIFNraXAgZWxlbWVudHMgYWxyZWFkeSBpbiB0aGUgY29udGV4dCBjb2xsZWN0aW9uICh0cmFjLTQwODcpCgkJaWYgKCBzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoIGVsZW0sIHNlbGVjdGlvbiApID4gLTEgKSB7CgkJCWlmICggaWdub3JlZCApIHsKCQkJCWlnbm9yZWQucHVzaCggZWxlbSApOwoJCQl9CgkJCWNvbnRpbnVlOwoJCX0KCgkJY29udGFpbnMgPSBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwoKCQkvLyBBcHBlbmQgdG8gZnJhZ21lbnQKCQl0bXAgPSBnZXRBbGwoIGZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7CgoJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKCQlpZiAoIGNvbnRhaW5zICkgewoJCQlzZXRHbG9iYWxFdmFsKCB0bXAgKTsKCQl9CgoJCS8vIENhcHR1cmUgZXhlY3V0YWJsZXMKCQlpZiAoIHNjcmlwdHMgKSB7CgkJCWogPSAwOwoJCQl3aGlsZSAoICggZWxlbSA9IHRtcFsgaisrIF0gKSApIHsKCQkJCWlmICggcnNjcmlwdFR5cGUudGVzdCggZWxlbS50eXBlIHx8ICIiICkgKSB7CgkJCQkJc2NyaXB0cy5wdXNoKCBlbGVtICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGZyYWdtZW50Owp9CgoKKCBmdW5jdGlvbigpIHsKCXZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQlkaXYgPSBmcmFnbWVudC5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApLAoJCWlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApOwoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHkKCS8vIENoZWNrIHN0YXRlIGxvc3QgaWYgdGhlIG5hbWUgaXMgc2V0ICgjMTEyMTcpCgkvLyBTdXBwb3J0OiBXaW5kb3dzIFdlYiBBcHBzIChXV0EpCgkvLyBgbmFtZWAgYW5kIGB0eXBlYCBtdXN0IHVzZSAuc2V0QXR0cmlidXRlIGZvciBXV0EgKCMxNDkwMSkKCWlucHV0LnNldEF0dHJpYnV0ZSggInR5cGUiLCAicmFkaW8iICk7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgImNoZWNrZWQiICk7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7CgoJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApOwoKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjEgb25seQoJLy8gT2xkZXIgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBkaXYuY2xvbmVOb2RlKCB0cnVlICkuY2xvbmVOb2RlKCB0cnVlICkubGFzdENoaWxkLmNoZWNrZWQ7CgoJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CgkvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZAoJZGl2LmlubmVySFRNTCA9ICI8dGV4dGFyZWE+eDwvdGV4dGFyZWE+IjsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSAhIWRpdi5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuZGVmYXVsdFZhbHVlOwp9ICkoKTsKdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgoKdmFyCglya2V5RXZlbnQgPSAvXmtleS8sCglybW91c2VFdmVudCA9IC9eKD86bW91c2V8cG9pbnRlcnxjb250ZXh0bWVudXxkcmFnfGRyb3ApfGNsaWNrLywKCXJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkvOwoKZnVuY3Rpb24gcmV0dXJuVHJ1ZSgpIHsKCXJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZXR1cm5GYWxzZSgpIHsKCXJldHVybiBmYWxzZTsKfQoKLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKLy8gU2VlICMxMzM5MyBmb3IgbW9yZSBpbmZvCmZ1bmN0aW9uIHNhZmVBY3RpdmVFbGVtZW50KCkgewoJdHJ5IHsKCQlyZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCX0gY2F0Y2ggKCBlcnIgKSB7IH0KfQoKZnVuY3Rpb24gb24oIGVsZW0sIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSApIHsKCXZhciBvcmlnRm4sIHR5cGU7CgoJLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCglpZiAoIHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIgKSB7CgoJCS8vICggdHlwZXMtT2JqZWN0LCBzZWxlY3RvciwgZGF0YSApCgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoKCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQlkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKCQkJc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfQoJCWZvciAoIHR5cGUgaW4gdHlwZXMgKSB7CgkJCW9uKCBlbGVtLCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbIHR5cGUgXSwgb25lICk7CgkJfQoJCXJldHVybiBlbGVtOwoJfQoKCWlmICggZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwgKSB7CgoJCS8vICggdHlwZXMsIGZuICkKCQlmbiA9IHNlbGVjdG9yOwoJCWRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKCX0gZWxzZSBpZiAoIGZuID09IG51bGwgKSB7CgkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoKCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJZm4gPSBkYXRhOwoJCQlkYXRhID0gdW5kZWZpbmVkOwoJCX0gZWxzZSB7CgoJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCWZuID0gZGF0YTsKCQkJZGF0YSA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9Cgl9CglpZiAoIGZuID09PSBmYWxzZSApIHsKCQlmbiA9IHJldHVybkZhbHNlOwoJfSBlbHNlIGlmICggIWZuICkgewoJCXJldHVybiBlbGVtOwoJfQoKCWlmICggb25lID09PSAxICkgewoJCW9yaWdGbiA9IGZuOwoJCWZuID0gZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCgkJCWpRdWVyeSgpLm9mZiggZXZlbnQgKTsKCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCgkJLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KCQlmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKCBvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKysgKTsKCX0KCXJldHVybiBlbGVtLmVhY2goIGZ1bmN0aW9uKCkgewoJCWpRdWVyeS5ldmVudC5hZGQoIHRoaXMsIHR5cGVzLCBmbiwgZGF0YSwgc2VsZWN0b3IgKTsKCX0gKTsKfQoKLyoKICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgbWFuYWdpbmcgZXZlbnRzIC0tIG5vdCBwYXJ0IG9mIHRoZSBwdWJsaWMgaW50ZXJmYWNlLgogKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogKi8KalF1ZXJ5LmV2ZW50ID0gewoKCWdsb2JhbDoge30sCgoJYWRkOiBmdW5jdGlvbiggZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yICkgewoKCQl2YXIgaGFuZGxlT2JqSW4sIGV2ZW50SGFuZGxlLCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YVByaXYuZ2V0KCBlbGVtICk7CgoJCS8vIERvbid0IGF0dGFjaCBldmVudHMgdG8gbm9EYXRhIG9yIHRleHQvY29tbWVudCBub2RlcyAoYnV0IGFsbG93IHBsYWluIG9iamVjdHMpCgkJaWYgKCAhZWxlbURhdGEgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgoJCWlmICggaGFuZGxlci5oYW5kbGVyICkgewoJCQloYW5kbGVPYmpJbiA9IGhhbmRsZXI7CgkJCWhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwoJCQlzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwoJCX0KCgkJLy8gRW5zdXJlIHRoYXQgaW52YWxpZCBzZWxlY3RvcnMgdGhyb3cgZXhjZXB0aW9ucyBhdCBhdHRhY2ggdGltZQoJCS8vIEV2YWx1YXRlIGFnYWluc3QgZG9jdW1lbnRFbGVtZW50IGluIGNhc2UgZWxlbSBpcyBhIG5vbi1lbGVtZW50IG5vZGUgKGUuZy4sIGRvY3VtZW50KQoJCWlmICggc2VsZWN0b3IgKSB7CgkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvciggZG9jdW1lbnRFbGVtZW50LCBzZWxlY3RvciApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCgkJaWYgKCAhaGFuZGxlci5ndWlkICkgewoJCQloYW5kbGVyLmd1aWQgPSBqUXVlcnkuZ3VpZCsrOwoJCX0KCgkJLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdAoJCWlmICggISggZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzICkgKSB7CgkJCWV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwoJCX0KCQlpZiAoICEoIGV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlICkgKSB7CgkJCWV2ZW50SGFuZGxlID0gZWxlbURhdGEuaGFuZGxlID0gZnVuY3Rpb24oIGUgKSB7CgoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPwoJCQkJCWpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseSggZWxlbSwgYXJndW1lbnRzICkgOiB1bmRlZmluZWQ7CgkJCX07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbIHQgXSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbIDEgXTsKCQkJbmFtZXNwYWNlcyA9ICggdG1wWyAyIF0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCgkJCWlmICggIXR5cGUgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFsgdHlwZSBdIHx8IHt9OwoKCQkJLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCgkJCXR5cGUgPSAoIHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlICkgfHwgdHlwZTsKCgkJCS8vIFVwZGF0ZSBzcGVjaWFsIGJhc2VkIG9uIG5ld2x5IHJlc2V0IHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwoJCQloYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKCB7CgkJCQl0eXBlOiB0eXBlLAoJCQkJb3JpZ1R5cGU6IG9yaWdUeXBlLAoJCQkJZGF0YTogZGF0YSwKCQkJCWhhbmRsZXI6IGhhbmRsZXIsCgkJCQlndWlkOiBoYW5kbGVyLmd1aWQsCgkJCQlzZWxlY3Rvcjogc2VsZWN0b3IsCgkJCQluZWVkc0NvbnRleHQ6IHNlbGVjdG9yICYmIGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dC50ZXN0KCBzZWxlY3RvciApLAoJCQkJbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oICIuIiApCgkJCX0sIGhhbmRsZU9iakluICk7CgoJCQkvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdAoJCQlpZiAoICEoIGhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gKSApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fAoJCQkJCXNwZWNpYWwuc2V0dXAuY2FsbCggZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUgKSA9PT0gZmFsc2UgKSB7CgoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAoIHNwZWNpYWwuYWRkICkgewoJCQkJc3BlY2lhbC5hZGQuY2FsbCggZWxlbSwgaGFuZGxlT2JqICk7CgoJCQkJaWYgKCAhaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCApIHsKCQkJCQloYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwoJCQkJfQoJCQl9CgoJCQkvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJaGFuZGxlcnMuc3BsaWNlKCBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaiApOwoJCQl9IGVsc2UgewoJCQkJaGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CgkJCX0KCgkJCS8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbFsgdHlwZSBdID0gdHJ1ZTsKCQl9CgoJfSwKCgkvLyBEZXRhY2ggYW4gZXZlbnQgb3Igc2V0IG9mIGV2ZW50cyBmcm9tIGFuIGVsZW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBzZWxlY3RvciwgbWFwcGVkVHlwZXMgKSB7CgoJCXZhciBqLCBvcmlnQ291bnQsIHRtcCwKCQkJZXZlbnRzLCB0LCBoYW5kbGVPYmosCgkJCXNwZWNpYWwsIGhhbmRsZXJzLCB0eXBlLCBuYW1lc3BhY2VzLCBvcmlnVHlwZSwKCQkJZWxlbURhdGEgPSBkYXRhUHJpdi5oYXNEYXRhKCBlbGVtICkgJiYgZGF0YVByaXYuZ2V0KCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbICIiIF07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbIHQgXSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbIDEgXTsKCQkJbmFtZXNwYWNlcyA9ICggdG1wWyAyIF0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbIDIgXSAmJgoJCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCAiXFwuKD86LipcXC58KSIgKSArICIoXFwufCQpIiApOwoKCQkJLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwoJCQlvcmlnQ291bnQgPSBqID0gaGFuZGxlcnMubGVuZ3RoOwoJCQl3aGlsZSAoIGotLSApIHsKCQkJCWhhbmRsZU9iaiA9IGhhbmRsZXJzWyBqIF07CgoJCQkJaWYgKCAoIG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUgKSAmJgoJCQkJCSggIWhhbmRsZXIgfHwgaGFuZGxlci5ndWlkID09PSBoYW5kbGVPYmouZ3VpZCApICYmCgkJCQkJKCAhdG1wIHx8IHRtcC50ZXN0KCBoYW5kbGVPYmoubmFtZXNwYWNlICkgKSAmJgoJCQkJCSggIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwKCQkJCQkJc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yICkgKSB7CgkJCQkJaGFuZGxlcnMuc3BsaWNlKCBqLCAxICk7CgoJCQkJCWlmICggaGFuZGxlT2JqLnNlbGVjdG9yICkgewoJCQkJCQloYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CgkJCQkJfQoJCQkJCWlmICggc3BlY2lhbC5yZW1vdmUgKSB7CgkJCQkJCXNwZWNpYWwucmVtb3ZlLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAoJCQkvLyAoYXZvaWRzIHBvdGVudGlhbCBmb3IgZW5kbGVzcyByZWN1cnNpb24gZHVyaW5nIHJlbW92YWwgb2Ygc3BlY2lhbCBldmVudCBoYW5kbGVycykKCQkJaWYgKCBvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCApIHsKCQkJCWlmICggIXNwZWNpYWwudGVhcmRvd24gfHwKCQkJCQlzcGVjaWFsLnRlYXJkb3duLmNhbGwoIGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSApID09PSBmYWxzZSApIHsKCgkJCQkJalF1ZXJ5LnJlbW92ZUV2ZW50KCBlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUgKTsKCQkJCX0KCgkJCQlkZWxldGUgZXZlbnRzWyB0eXBlIF07CgkJCX0KCQl9CgoJCS8vIFJlbW92ZSBkYXRhIGFuZCB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCgkJaWYgKCBqUXVlcnkuaXNFbXB0eU9iamVjdCggZXZlbnRzICkgKSB7CgkJCWRhdGFQcml2LnJlbW92ZSggZWxlbSwgImhhbmRsZSBldmVudHMiICk7CgkJfQoJfSwKCglkaXNwYXRjaDogZnVuY3Rpb24oIG5hdGl2ZUV2ZW50ICkgewoKCQkvLyBNYWtlIGEgd3JpdGFibGUgalF1ZXJ5LkV2ZW50IGZyb20gdGhlIG5hdGl2ZSBldmVudCBvYmplY3QKCQl2YXIgZXZlbnQgPSBqUXVlcnkuZXZlbnQuZml4KCBuYXRpdmVFdmVudCApOwoKCQl2YXIgaSwgaiwgcmV0LCBtYXRjaGVkLCBoYW5kbGVPYmosIGhhbmRsZXJRdWV1ZSwKCQkJYXJncyA9IG5ldyBBcnJheSggYXJndW1lbnRzLmxlbmd0aCApLAoJCQloYW5kbGVycyA9ICggZGF0YVByaXYuZ2V0KCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307CgoJCS8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CgkJYXJnc1sgMCBdID0gZXZlbnQ7CgoJCWZvciAoIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrICkgewoJCQlhcmdzWyBpIF0gPSBhcmd1bWVudHNbIGkgXTsKCQl9CgoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgaGFuZGxlcnMKCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJaSA9IDA7CgkJd2hpbGUgKCAoIG1hdGNoZWQgPSBoYW5kbGVyUXVldWVbIGkrKyBdICkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCWV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CgoJCQlqID0gMDsKCQkJd2hpbGUgKCAoIGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbIGorKyBdICkgJiYKCQkJCSFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJCS8vIFRyaWdnZXJlZCBldmVudCBtdXN0IGVpdGhlciAxKSBoYXZlIG5vIG5hbWVzcGFjZSwgb3IgMikgaGF2ZSBuYW1lc3BhY2UocykKCQkJCS8vIGEgc3Vic2V0IG9yIGVxdWFsIHRvIHRob3NlIGluIHRoZSBib3VuZCBldmVudCAoYm90aCBjYW4gaGF2ZSBubyBuYW1lc3BhY2UpLgoJCQkJaWYgKCAhZXZlbnQucm5hbWVzcGFjZSB8fCBldmVudC5ybmFtZXNwYWNlLnRlc3QoIGhhbmRsZU9iai5uYW1lc3BhY2UgKSApIHsKCgkJCQkJZXZlbnQuaGFuZGxlT2JqID0gaGFuZGxlT2JqOwoJCQkJCWV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKCgkJCQkJcmV0ID0gKCAoIGpRdWVyeS5ldmVudC5zcGVjaWFsWyBoYW5kbGVPYmoub3JpZ1R5cGUgXSB8fCB7fSApLmhhbmRsZSB8fAoJCQkJCQloYW5kbGVPYmouaGFuZGxlciApLmFwcGx5KCBtYXRjaGVkLmVsZW0sIGFyZ3MgKTsKCgkJCQkJaWYgKCByZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJaWYgKCAoIGV2ZW50LnJlc3VsdCA9IHJldCApID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgloYW5kbGVyczogZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVycyApIHsKCQl2YXIgaSwgaGFuZGxlT2JqLCBzZWwsIG1hdGNoZWRIYW5kbGVycywgbWF0Y2hlZFNlbGVjdG9ycywKCQkJaGFuZGxlclF1ZXVlID0gW10sCgkJCWRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAoJCQljdXIgPSBldmVudC50YXJnZXQ7CgoJCS8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYKCgkJCS8vIFN1cHBvcnQ6IElFIDw9OQoJCQkvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAodHJhYy0xMzE4MCkKCQkJY3VyLm5vZGVUeXBlICYmCgoJCQkvLyBTdXBwb3J0OiBGaXJlZm94IDw9NDIKCQkJLy8gU3VwcHJlc3Mgc3BlYy12aW9sYXRpbmcgY2xpY2tzIGluZGljYXRpbmcgYSBub24tcHJpbWFyeSBwb2ludGVyIGJ1dHRvbiAodHJhYy0zODYxKQoJCQkvLyBodHRwczovL3d3dy53My5vcmcvVFIvRE9NLUxldmVsLTMtRXZlbnRzLyNldmVudC10eXBlLWNsaWNrCgkJCS8vIFN1cHBvcnQ6IElFIDExIG9ubHkKCQkJLy8gLi4uYnV0IG5vdCBhcnJvdyBrZXkgImNsaWNrcyIgb2YgcmFkaW8gaW5wdXRzLCB3aGljaCBjYW4gaGF2ZSBgYnV0dG9uYCAtMSAoZ2gtMjM0MykKCQkJISggZXZlbnQudHlwZSA9PT0gImNsaWNrIiAmJiBldmVudC5idXR0b24gPj0gMSApICkgewoKCQkJZm9yICggOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMgKSB7CgoJCQkJLy8gRG9uJ3QgY2hlY2sgbm9uLWVsZW1lbnRzICgjMTMyMDgpCgkJCQkvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKCQkJCWlmICggY3VyLm5vZGVUeXBlID09PSAxICYmICEoIGV2ZW50LnR5cGUgPT09ICJjbGljayIgJiYgY3VyLmRpc2FibGVkID09PSB0cnVlICkgKSB7CgkJCQkJbWF0Y2hlZEhhbmRsZXJzID0gW107CgkJCQkJbWF0Y2hlZFNlbGVjdG9ycyA9IHt9OwoJCQkJCWZvciAoIGkgPSAwOyBpIDwgZGVsZWdhdGVDb3VudDsgaSsrICkgewoJCQkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaSBdOwoKCQkJCQkJLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKCMxMzIwMykKCQkJCQkJc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgIiAiOwoKCQkJCQkJaWYgKCBtYXRjaGVkU2VsZWN0b3JzWyBzZWwgXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJbWF0Y2hlZFNlbGVjdG9yc1sgc2VsIF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8KCQkJCQkJCQlqUXVlcnkoIHNlbCwgdGhpcyApLmluZGV4KCBjdXIgKSA+IC0xIDoKCQkJCQkJCQlqUXVlcnkuZmluZCggc2VsLCB0aGlzLCBudWxsLCBbIGN1ciBdICkubGVuZ3RoOwoJCQkJCQl9CgkJCQkJCWlmICggbWF0Y2hlZFNlbGVjdG9yc1sgc2VsIF0gKSB7CgkJCQkJCQltYXRjaGVkSGFuZGxlcnMucHVzaCggaGFuZGxlT2JqICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBtYXRjaGVkSGFuZGxlcnMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCggeyBlbGVtOiBjdXIsIGhhbmRsZXJzOiBtYXRjaGVkSGFuZGxlcnMgfSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwoJCWN1ciA9IHRoaXM7CgkJaWYgKCBkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoICkgewoJCQloYW5kbGVyUXVldWUucHVzaCggeyBlbGVtOiBjdXIsIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZSggZGVsZWdhdGVDb3VudCApIH0gKTsKCQl9CgoJCXJldHVybiBoYW5kbGVyUXVldWU7Cgl9LAoKCWFkZFByb3A6IGZ1bmN0aW9uKCBuYW1lLCBob29rICkgewoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSwgbmFtZSwgewoJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQljb25maWd1cmFibGU6IHRydWUsCgoJCQlnZXQ6IGlzRnVuY3Rpb24oIGhvb2sgKSA/CgkJCQlmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHRoaXMub3JpZ2luYWxFdmVudCApIHsKCQkJCQkJCXJldHVybiBob29rKCB0aGlzLm9yaWdpbmFsRXZlbnQgKTsKCQkJCQl9CgkJCQl9IDoKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCWlmICggdGhpcy5vcmlnaW5hbEV2ZW50ICkgewoJCQkJCQkJcmV0dXJuIHRoaXMub3JpZ2luYWxFdmVudFsgbmFtZSBdOwoJCQkJCX0KCQkJCX0sCgoJCQlzZXQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcywgbmFtZSwgewoJCQkJCWVudW1lcmFibGU6IHRydWUsCgkJCQkJY29uZmlndXJhYmxlOiB0cnVlLAoJCQkJCXdyaXRhYmxlOiB0cnVlLAoJCQkJCXZhbHVlOiB2YWx1ZQoJCQkJfSApOwoJCQl9CgkJfSApOwoJfSwKCglmaXg6IGZ1bmN0aW9uKCBvcmlnaW5hbEV2ZW50ICkgewoJCXJldHVybiBvcmlnaW5hbEV2ZW50WyBqUXVlcnkuZXhwYW5kbyBdID8KCQkJb3JpZ2luYWxFdmVudCA6CgkJCW5ldyBqUXVlcnkuRXZlbnQoIG9yaWdpbmFsRXZlbnQgKTsKCX0sCgoJc3BlY2lhbDogewoJCWxvYWQ6IHsKCgkJCS8vIFByZXZlbnQgdHJpZ2dlcmVkIGltYWdlLmxvYWQgZXZlbnRzIGZyb20gYnViYmxpbmcgdG8gd2luZG93LmxvYWQKCQkJbm9CdWJibGU6IHRydWUKCQl9LAoJCWZvY3VzOiB7CgoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgIT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5mb2N1cyApIHsKCQkJCQl0aGlzLmZvY3VzKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgoJCX0sCgkJYmx1cjogewoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcyA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmJsdXIgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKCQl9LAoJCWNsaWNrOiB7CgoJCQkvLyBGb3IgY2hlY2tib3gsIGZpcmUgbmF0aXZlIGV2ZW50IHNvIGNoZWNrZWQgc3RhdGUgd2lsbCBiZSByaWdodAoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giICYmIHRoaXMuY2xpY2sgJiYgbm9kZU5hbWUoIHRoaXMsICJpbnB1dCIgKSApIHsKCQkJCQl0aGlzLmNsaWNrKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoKCQkJLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCgkJCV9kZWZhdWx0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlyZXR1cm4gbm9kZU5hbWUoIGV2ZW50LnRhcmdldCwgImEiICk7CgkJCX0KCQl9LAoKCQliZWZvcmV1bmxvYWQ6IHsKCQkJcG9zdERpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJLy8gU3VwcG9ydDogRmlyZWZveCAyMCsKCQkJCS8vIEZpcmVmb3ggZG9lc24ndCBhbGVydCBpZiB0aGUgcmV0dXJuVmFsdWUgZmllbGQgaXMgbm90IHNldC4KCQkJCWlmICggZXZlbnQucmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgZXZlbnQub3JpZ2luYWxFdmVudCApIHsKCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZXZlbnQucmVzdWx0OwoJCQkJfQoJCQl9CgkJfQoJfQp9OwoKalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCgkvLyBUaGlzICJpZiIgaXMgbmVlZGVkIGZvciBwbGFpbiBvYmplY3RzCglpZiAoIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciApIHsKCQllbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIoIHR5cGUsIGhhbmRsZSApOwoJfQp9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7CgoJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkCglpZiAoICEoIHRoaXMgaW5zdGFuY2VvZiBqUXVlcnkuRXZlbnQgKSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOwoJfQoKCS8vIEV2ZW50IG9iamVjdAoJaWYgKCBzcmMgJiYgc3JjLnR5cGUgKSB7CgkJdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwoJCXRoaXMudHlwZSA9IHNyYy50eXBlOwoKCQkvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gc3JjLmRlZmF1bHRQcmV2ZW50ZWQgfHwKCQkJCXNyYy5kZWZhdWx0UHJldmVudGVkID09PSB1bmRlZmluZWQgJiYKCgkJCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDw9Mi4zIG9ubHkKCQkJCXNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgPwoJCQlyZXR1cm5UcnVlIDoKCQkJcmV0dXJuRmFsc2U7CgoJCS8vIENyZWF0ZSB0YXJnZXQgcHJvcGVydGllcwoJCS8vIFN1cHBvcnQ6IFNhZmFyaSA8PTYgLSA3IG9ubHkKCQkvLyBUYXJnZXQgc2hvdWxkIG5vdCBiZSBhIHRleHQgbm9kZSAoIzUwNCwgIzEzMTQzKQoJCXRoaXMudGFyZ2V0ID0gKCBzcmMudGFyZ2V0ICYmIHNyYy50YXJnZXQubm9kZVR5cGUgPT09IDMgKSA/CgkJCXNyYy50YXJnZXQucGFyZW50Tm9kZSA6CgkJCXNyYy50YXJnZXQ7CgoJCXRoaXMuY3VycmVudFRhcmdldCA9IHNyYy5jdXJyZW50VGFyZ2V0OwoJCXRoaXMucmVsYXRlZFRhcmdldCA9IHNyYy5yZWxhdGVkVGFyZ2V0OwoKCS8vIEV2ZW50IHR5cGUKCX0gZWxzZSB7CgkJdGhpcy50eXBlID0gc3JjOwoJfQoKCS8vIFB1dCBleHBsaWNpdGx5IHByb3ZpZGVkIHByb3BlcnRpZXMgb250byB0aGUgZXZlbnQgb2JqZWN0CglpZiAoIHByb3BzICkgewoJCWpRdWVyeS5leHRlbmQoIHRoaXMsIHByb3BzICk7Cgl9CgoJLy8gQ3JlYXRlIGEgdGltZXN0YW1wIGlmIGluY29taW5nIGV2ZW50IGRvZXNuJ3QgaGF2ZSBvbmUKCXRoaXMudGltZVN0YW1wID0gc3JjICYmIHNyYy50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKCgkvLyBNYXJrIGl0IGFzIGZpeGVkCgl0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwovLyBodHRwczovL3d3dy53My5vcmcvVFIvMjAwMy9XRC1ET00tTGV2ZWwtMy1FdmVudHMtMjAwMzAzMzEvZWNtYS1zY3JpcHQtYmluZGluZy5odG1sCmpRdWVyeS5FdmVudC5wcm90b3R5cGUgPSB7Cgljb25zdHJ1Y3RvcjogalF1ZXJ5LkV2ZW50LAoJaXNEZWZhdWx0UHJldmVudGVkOiByZXR1cm5GYWxzZSwKCWlzUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCWlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkOiByZXR1cm5GYWxzZSwKCWlzU2ltdWxhdGVkOiBmYWxzZSwKCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gcmV0dXJuVHJ1ZTsKCgkJaWYgKCBlICYmICF0aGlzLmlzU2ltdWxhdGVkICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQgKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQgKSB7CgkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJfQoKCQl0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwoJfQp9OwoKLy8gSW5jbHVkZXMgYWxsIGNvbW1vbiBldmVudCBwcm9wcyBpbmNsdWRpbmcgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQgc3BlY2lmaWMgcHJvcHMKalF1ZXJ5LmVhY2goIHsKCWFsdEtleTogdHJ1ZSwKCWJ1YmJsZXM6IHRydWUsCgljYW5jZWxhYmxlOiB0cnVlLAoJY2hhbmdlZFRvdWNoZXM6IHRydWUsCgljdHJsS2V5OiB0cnVlLAoJZGV0YWlsOiB0cnVlLAoJZXZlbnRQaGFzZTogdHJ1ZSwKCW1ldGFLZXk6IHRydWUsCglwYWdlWDogdHJ1ZSwKCXBhZ2VZOiB0cnVlLAoJc2hpZnRLZXk6IHRydWUsCgl2aWV3OiB0cnVlLAoJImNoYXIiOiB0cnVlLAoJY2hhckNvZGU6IHRydWUsCglrZXk6IHRydWUsCglrZXlDb2RlOiB0cnVlLAoJYnV0dG9uOiB0cnVlLAoJYnV0dG9uczogdHJ1ZSwKCWNsaWVudFg6IHRydWUsCgljbGllbnRZOiB0cnVlLAoJb2Zmc2V0WDogdHJ1ZSwKCW9mZnNldFk6IHRydWUsCglwb2ludGVySWQ6IHRydWUsCglwb2ludGVyVHlwZTogdHJ1ZSwKCXNjcmVlblg6IHRydWUsCglzY3JlZW5ZOiB0cnVlLAoJdGFyZ2V0VG91Y2hlczogdHJ1ZSwKCXRvRWxlbWVudDogdHJ1ZSwKCXRvdWNoZXM6IHRydWUsCgoJd2hpY2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgYnV0dG9uID0gZXZlbnQuYnV0dG9uOwoKCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQlpZiAoIGV2ZW50LndoaWNoID09IG51bGwgJiYgcmtleUV2ZW50LnRlc3QoIGV2ZW50LnR5cGUgKSApIHsKCQkJcmV0dXJuIGV2ZW50LmNoYXJDb2RlICE9IG51bGwgPyBldmVudC5jaGFyQ29kZSA6IGV2ZW50LmtleUNvZGU7CgkJfQoKCQkvLyBBZGQgd2hpY2ggZm9yIGNsaWNrOiAxID09PSBsZWZ0OyAyID09PSBtaWRkbGU7IDMgPT09IHJpZ2h0CgkJaWYgKCAhZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQgJiYgcm1vdXNlRXZlbnQudGVzdCggZXZlbnQudHlwZSApICkgewoJCQlpZiAoIGJ1dHRvbiAmIDEgKSB7CgkJCQlyZXR1cm4gMTsKCQkJfQoKCQkJaWYgKCBidXR0b24gJiAyICkgewoJCQkJcmV0dXJuIDM7CgkJCX0KCgkJCWlmICggYnV0dG9uICYgNCApIHsKCQkJCXJldHVybiAyOwoJCQl9CgoJCQlyZXR1cm4gMDsKCQl9CgoJCXJldHVybiBldmVudC53aGljaDsKCX0KfSwgalF1ZXJ5LmV2ZW50LmFkZFByb3AgKTsKCi8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwovLyBzbyB0aGF0IGV2ZW50IGRlbGVnYXRpb24gd29ya3MgaW4galF1ZXJ5LgovLyBEbyB0aGUgc2FtZSBmb3IgcG9pbnRlcmVudGVyL3BvaW50ZXJsZWF2ZSBhbmQgcG9pbnRlcm92ZXIvcG9pbnRlcm91dAovLwovLyBTdXBwb3J0OiBTYWZhcmkgNyBvbmx5Ci8vIFNhZmFyaSBzZW5kcyBtb3VzZWVudGVyIHRvbyBvZnRlbjsgc2VlOgovLyBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NzAyNTgKLy8gZm9yIHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYnVnIChpdCBleGlzdGVkIGluIG9sZGVyIENocm9tZSB2ZXJzaW9ucyBhcyB3ZWxsKS4KalF1ZXJ5LmVhY2goIHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0IiwKCXBvaW50ZXJlbnRlcjogInBvaW50ZXJvdmVyIiwKCXBvaW50ZXJsZWF2ZTogInBvaW50ZXJvdXQiCn0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7CglqUXVlcnkuZXZlbnQuc3BlY2lhbFsgb3JpZyBdID0gewoJCWRlbGVnYXRlVHlwZTogZml4LAoJCWJpbmRUeXBlOiBmaXgsCgoJCWhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgcmV0LAoJCQkJdGFyZ2V0ID0gdGhpcywKCQkJCXJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LAoJCQkJaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwoKCQkJLy8gRm9yIG1vdXNlZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KCQkJLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKCQkJaWYgKCAhcmVsYXRlZCB8fCAoIHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKCB0YXJnZXQsIHJlbGF0ZWQgKSApICkgewoJCQkJZXZlbnQudHlwZSA9IGhhbmRsZU9iai5vcmlnVHlwZTsKCQkJCXJldCA9IGhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWV2ZW50LnR5cGUgPSBmaXg7CgkJCX0KCQkJcmV0dXJuIHJldDsKCQl9Cgl9Owp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJb246IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuICkgewoJCXJldHVybiBvbiggdGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCW9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIG9uKCB0aGlzLCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAxICk7Cgl9LAoJb2ZmOiBmdW5jdGlvbiggdHlwZXMsIHNlbGVjdG9yLCBmbiApIHsKCQl2YXIgaGFuZGxlT2JqLCB0eXBlOwoJCWlmICggdHlwZXMgJiYgdHlwZXMucHJldmVudERlZmF1bHQgJiYgdHlwZXMuaGFuZGxlT2JqICkgewoKCQkJLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAoJCQloYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CgkJCWpRdWVyeSggdHlwZXMuZGVsZWdhdGVUYXJnZXQgKS5vZmYoCgkJCQloYW5kbGVPYmoubmFtZXNwYWNlID8KCQkJCQloYW5kbGVPYmoub3JpZ1R5cGUgKyAiLiIgKyBoYW5kbGVPYmoubmFtZXNwYWNlIDoKCQkJCQloYW5kbGVPYmoub3JpZ1R5cGUsCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsCgkJCQloYW5kbGVPYmouaGFuZGxlcgoJCQkpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoKCQkJLy8gKCB0eXBlcy1vYmplY3QgWywgc2VsZWN0b3JdICkKCQkJZm9yICggdHlwZSBpbiB0eXBlcyApIHsKCQkJCXRoaXMub2ZmKCB0eXBlLCBzZWxlY3RvciwgdHlwZXNbIHR5cGUgXSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCQlpZiAoIHNlbGVjdG9yID09PSBmYWxzZSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgKSB7CgoJCQkvLyAoIHR5cGVzIFssIGZuXSApCgkJCWZuID0gc2VsZWN0b3I7CgkJCXNlbGVjdG9yID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IgKTsKCQl9ICk7Cgl9Cn0gKTsKCgp2YXIKCgkvKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGVuICovCgoJLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9lc2xpbnQvZXNsaW50L2lzc3Vlcy8zMjI5CglyeGh0bWxUYWcgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbYS16XVteXC9cMD5ceDIwXHRcclxuXGZdKilbXj5dKilcLz4vZ2ksCgoJLyogZXNsaW50LWVuYWJsZSAqLwoKCS8vIFN1cHBvcnQ6IElFIDw9MTAgLSAxMSwgRWRnZSAxMiAtIDEzIG9ubHkKCS8vIEluIElFL0VkZ2UgdXNpbmcgcmVnZXggZ3JvdXBzIGhlcmUgY2F1c2VzIHNldmVyZSBzbG93ZG93bnMuCgkvLyBTZWUgaHR0cHM6Ly9jb25uZWN0Lm1pY3Jvc29mdC5jb20vSUUvZmVlZGJhY2svZGV0YWlscy8xNzM2NTEyLwoJcm5vSW5uZXJodG1sID0gLzxzY3JpcHR8PHN0eWxlfDxsaW5rL2ksCgoJLy8gY2hlY2tlZD0iY2hlY2tlZCIgb3IgY2hlY2tlZAoJcmNoZWNrZWQgPSAvY2hlY2tlZFxzKig/OltePV18PVxzKi5jaGVja2VkLikvaSwKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZzsKCi8vIFByZWZlciBhIHRib2R5IG92ZXIgaXRzIHBhcmVudCB0YWJsZSBmb3IgY29udGFpbmluZyBuZXcgcm93cwpmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoIGVsZW0sIGNvbnRlbnQgKSB7CglpZiAoIG5vZGVOYW1lKCBlbGVtLCAidGFibGUiICkgJiYKCQlub2RlTmFtZSggY29udGVudC5ub2RlVHlwZSAhPT0gMTEgPyBjb250ZW50IDogY29udGVudC5maXJzdENoaWxkLCAidHIiICkgKSB7CgoJCXJldHVybiBqUXVlcnkoIGVsZW0gKS5jaGlsZHJlbiggInRib2R5IiApWyAwIF0gfHwgZWxlbTsKCX0KCglyZXR1cm4gZWxlbTsKfQoKLy8gUmVwbGFjZS9yZXN0b3JlIHRoZSB0eXBlIGF0dHJpYnV0ZSBvZiBzY3JpcHQgZWxlbWVudHMgZm9yIHNhZmUgRE9NIG1hbmlwdWxhdGlvbgpmdW5jdGlvbiBkaXNhYmxlU2NyaXB0KCBlbGVtICkgewoJZWxlbS50eXBlID0gKCBlbGVtLmdldEF0dHJpYnV0ZSggInR5cGUiICkgIT09IG51bGwgKSArICIvIiArIGVsZW0udHlwZTsKCXJldHVybiBlbGVtOwp9CmZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoIGVsZW0gKSB7CglpZiAoICggZWxlbS50eXBlIHx8ICIiICkuc2xpY2UoIDAsIDUgKSA9PT0gInRydWUvIiApIHsKCQllbGVtLnR5cGUgPSBlbGVtLnR5cGUuc2xpY2UoIDUgKTsKCX0gZWxzZSB7CgkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoICJ0eXBlIiApOwoJfQoKCXJldHVybiBlbGVtOwp9CgpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgewoJdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CgoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgoJaWYgKCBkYXRhUHJpdi5oYXNEYXRhKCBzcmMgKSApIHsKCQlwZGF0YU9sZCA9IGRhdGFQcml2LmFjY2Vzcyggc3JjICk7CgkJcGRhdGFDdXIgPSBkYXRhUHJpdi5zZXQoIGRlc3QsIHBkYXRhT2xkICk7CgkJZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwoKCQlpZiAoIGV2ZW50cyApIHsKCQkJZGVsZXRlIHBkYXRhQ3VyLmhhbmRsZTsKCQkJcGRhdGFDdXIuZXZlbnRzID0ge307CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyAyLiBDb3B5IHVzZXIgZGF0YQoJaWYgKCBkYXRhVXNlci5oYXNEYXRhKCBzcmMgKSApIHsKCQl1ZGF0YU9sZCA9IGRhdGFVc2VyLmFjY2Vzcyggc3JjICk7CgkJdWRhdGFDdXIgPSBqUXVlcnkuZXh0ZW5kKCB7fSwgdWRhdGFPbGQgKTsKCgkJZGF0YVVzZXIuc2V0KCBkZXN0LCB1ZGF0YUN1ciApOwoJfQp9CgovLyBGaXggSUUgYnVncywgc2VlIHN1cHBvcnQgdGVzdHMKZnVuY3Rpb24gZml4SW5wdXQoIHNyYywgZGVzdCApIHsKCXZhciBub2RlTmFtZSA9IGRlc3Qubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCgkvLyBGYWlscyB0byBwZXJzaXN0IHRoZSBjaGVja2VkIHN0YXRlIG9mIGEgY2xvbmVkIGNoZWNrYm94IG9yIHJhZGlvIGJ1dHRvbi4KCWlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdCggc3JjLnR5cGUgKSApIHsKCQlkZXN0LmNoZWNrZWQgPSBzcmMuY2hlY2tlZDsKCgkvLyBGYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZCBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwoJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgKSB7CgkJZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwoJfQp9CgpmdW5jdGlvbiBkb21NYW5pcCggY29sbGVjdGlvbiwgYXJncywgY2FsbGJhY2ssIGlnbm9yZWQgKSB7CgoJLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwoJYXJncyA9IGNvbmNhdC5hcHBseSggW10sIGFyZ3MgKTsKCgl2YXIgZnJhZ21lbnQsIGZpcnN0LCBzY3JpcHRzLCBoYXNTY3JpcHRzLCBub2RlLCBkb2MsCgkJaSA9IDAsCgkJbCA9IGNvbGxlY3Rpb24ubGVuZ3RoLAoJCWlOb0Nsb25lID0gbCAtIDEsCgkJdmFsdWUgPSBhcmdzWyAwIF0sCgkJdmFsdWVJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbiggdmFsdWUgKTsKCgkvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKCWlmICggdmFsdWVJc0Z1bmN0aW9uIHx8CgkJCSggbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJgoJCQkJIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgKSB7CgkJcmV0dXJuIGNvbGxlY3Rpb24uZWFjaCggZnVuY3Rpb24oIGluZGV4ICkgewoJCQl2YXIgc2VsZiA9IGNvbGxlY3Rpb24uZXEoIGluZGV4ICk7CgkJCWlmICggdmFsdWVJc0Z1bmN0aW9uICkgewoJCQkJYXJnc1sgMCBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpICk7CgkJCX0KCQkJZG9tTWFuaXAoIHNlbGYsIGFyZ3MsIGNhbGxiYWNrLCBpZ25vcmVkICk7CgkJfSApOwoJfQoKCWlmICggbCApIHsKCQlmcmFnbWVudCA9IGJ1aWxkRnJhZ21lbnQoIGFyZ3MsIGNvbGxlY3Rpb25bIDAgXS5vd25lckRvY3VtZW50LCBmYWxzZSwgY29sbGVjdGlvbiwgaWdub3JlZCApOwoJCWZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJZnJhZ21lbnQgPSBmaXJzdDsKCQl9CgoJCS8vIFJlcXVpcmUgZWl0aGVyIG5ldyBjb250ZW50IG9yIGFuIGludGVyZXN0IGluIGlnbm9yZWQgZWxlbWVudHMgdG8gaW52b2tlIHRoZSBjYWxsYmFjawoJCWlmICggZmlyc3QgfHwgaWdub3JlZCApIHsKCQkJc2NyaXB0cyA9IGpRdWVyeS5tYXAoIGdldEFsbCggZnJhZ21lbnQsICJzY3JpcHQiICksIGRpc2FibGVTY3JpcHQgKTsKCQkJaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwoKCQkJLy8gVXNlIHRoZSBvcmlnaW5hbCBmcmFnbWVudCBmb3IgdGhlIGxhc3QgaXRlbQoJCQkvLyBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKCQkJLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKCM4MDcwKS4KCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJbm9kZSA9IGZyYWdtZW50OwoKCQkJCWlmICggaSAhPT0gaU5vQ2xvbmUgKSB7CgkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOwoKCQkJCQkvLyBLZWVwIHJlZmVyZW5jZXMgdG8gY2xvbmVkIHNjcmlwdHMgZm9yIGxhdGVyIHJlc3RvcmF0aW9uCgkJCQkJaWYgKCBoYXNTY3JpcHRzICkgewoKCQkJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CgkJCQkJCS8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKCQkJCQkJalF1ZXJ5Lm1lcmdlKCBzY3JpcHRzLCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsKCQkJCQl9CgkJCQl9CgoJCQkJY2FsbGJhY2suY2FsbCggY29sbGVjdGlvblsgaSBdLCBub2RlLCBpICk7CgkJCX0KCgkJCWlmICggaGFzU2NyaXB0cyApIHsKCQkJCWRvYyA9IHNjcmlwdHNbIHNjcmlwdHMubGVuZ3RoIC0gMSBdLm93bmVyRG9jdW1lbnQ7CgoJCQkJLy8gUmVlbmFibGUgc2NyaXB0cwoJCQkJalF1ZXJ5Lm1hcCggc2NyaXB0cywgcmVzdG9yZVNjcmlwdCApOwoKCQkJCS8vIEV2YWx1YXRlIGV4ZWN1dGFibGUgc2NyaXB0cyBvbiBmaXJzdCBkb2N1bWVudCBpbnNlcnRpb24KCQkJCWZvciAoIGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrICkgewoJCQkJCW5vZGUgPSBzY3JpcHRzWyBpIF07CgkJCQkJaWYgKCByc2NyaXB0VHlwZS50ZXN0KCBub2RlLnR5cGUgfHwgIiIgKSAmJgoJCQkJCQkhZGF0YVByaXYuYWNjZXNzKCBub2RlLCAiZ2xvYmFsRXZhbCIgKSAmJgoJCQkJCQlqUXVlcnkuY29udGFpbnMoIGRvYywgbm9kZSApICkgewoKCQkJCQkJaWYgKCBub2RlLnNyYyAmJiAoIG5vZGUudHlwZSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgICE9PSAibW9kdWxlIiApIHsKCgkJCQkJCQkvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAoJCQkJCQkJaWYgKCBqUXVlcnkuX2V2YWxVcmwgKSB7CgkJCQkJCQkJalF1ZXJ5Ll9ldmFsVXJsKCBub2RlLnNyYyApOwoJCQkJCQkJfQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJRE9NRXZhbCggbm9kZS50ZXh0Q29udGVudC5yZXBsYWNlKCByY2xlYW5TY3JpcHQsICIiICksIGRvYywgbm9kZSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiBjb2xsZWN0aW9uOwp9CgpmdW5jdGlvbiByZW1vdmUoIGVsZW0sIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCXZhciBub2RlLAoJCW5vZGVzID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKCBzZWxlY3RvciwgZWxlbSApIDogZWxlbSwKCQlpID0gMDsKCglmb3IgKCA7ICggbm9kZSA9IG5vZGVzWyBpIF0gKSAhPSBudWxsOyBpKysgKSB7CgkJaWYgKCAha2VlcERhdGEgJiYgbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBub2RlICkgKTsKCQl9CgoJCWlmICggbm9kZS5wYXJlbnROb2RlICkgewoJCQlpZiAoIGtlZXBEYXRhICYmIGpRdWVyeS5jb250YWlucyggbm9kZS5vd25lckRvY3VtZW50LCBub2RlICkgKSB7CgkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIG5vZGUsICJzY3JpcHQiICkgKTsKCQkJfQoJCQlub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIG5vZGUgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCmpRdWVyeS5leHRlbmQoIHsKCWh0bWxQcmVmaWx0ZXI6IGZ1bmN0aW9uKCBodG1sICkgewoJCXJldHVybiBodG1sLnJlcGxhY2UoIHJ4aHRtbFRhZywgIjwkMT48LyQyPiIgKTsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBlbGVtLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQl2YXIgaSwgbCwgc3JjRWxlbWVudHMsIGRlc3RFbGVtZW50cywKCQkJY2xvbmUgPSBlbGVtLmNsb25lTm9kZSggdHJ1ZSApLAoJCQlpblBhZ2UgPSBqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApOwoKCQkvLyBGaXggSUUgY2xvbmluZyBpc3N1ZXMKCQlpZiAoICFzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSApICYmCgkJCQkhalF1ZXJ5LmlzWE1MRG9jKCBlbGVtICkgKSB7CgoJCQkvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHBzOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKCQkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSApOwoJCQlzcmNFbGVtZW50cyA9IGdldEFsbCggZWxlbSApOwoKCQkJZm9yICggaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQlmaXhJbnB1dCggc3JjRWxlbWVudHNbIGkgXSwgZGVzdEVsZW1lbnRzWyBpIF0gKTsKCQkJfQoJCX0KCgkJLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQoJCWlmICggZGF0YUFuZEV2ZW50cyApIHsKCQkJaWYgKCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQkJCXNyY0VsZW1lbnRzID0gc3JjRWxlbWVudHMgfHwgZ2V0QWxsKCBlbGVtICk7CgkJCQlkZXN0RWxlbWVudHMgPSBkZXN0RWxlbWVudHMgfHwgZ2V0QWxsKCBjbG9uZSApOwoKCQkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWNsb25lQ29weUV2ZW50KCBzcmNFbGVtZW50c1sgaSBdLCBkZXN0RWxlbWVudHNbIGkgXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJY2xvbmVDb3B5RXZlbnQoIGVsZW0sIGNsb25lICk7CgkJCX0KCQl9CgoJCS8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKCQlkZXN0RWxlbWVudHMgPSBnZXRBbGwoIGNsb25lLCAic2NyaXB0IiApOwoJCWlmICggZGVzdEVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCXNldEdsb2JhbEV2YWwoIGRlc3RFbGVtZW50cywgIWluUGFnZSAmJiBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKCQl9CgoJCS8vIFJldHVybiB0aGUgY2xvbmVkIHNldAoJCXJldHVybiBjbG9uZTsKCX0sCgoJY2xlYW5EYXRhOiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJdmFyIGRhdGEsIGVsZW0sIHR5cGUsCgkJCXNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKCBlbGVtID0gZWxlbXNbIGkgXSApICE9PSB1bmRlZmluZWQ7IGkrKyApIHsKCQkJaWYgKCBhY2NlcHREYXRhKCBlbGVtICkgKSB7CgkJCQlpZiAoICggZGF0YSA9IGVsZW1bIGRhdGFQcml2LmV4cGFuZG8gXSApICkgewoJCQkJCWlmICggZGF0YS5ldmVudHMgKSB7CgkJCQkJCWZvciAoIHR5cGUgaW4gZGF0YS5ldmVudHMgKSB7CgkJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgoJCQkJCQkJLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUrCgkJCQkJLy8gQXNzaWduIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHVzaW5nIGRlbGV0ZSwgc2VlIERhdGEjcmVtb3ZlCgkJCQkJZWxlbVsgZGF0YVByaXYuZXhwYW5kbyBdID0gdW5kZWZpbmVkOwoJCQkJfQoJCQkJaWYgKCBlbGVtWyBkYXRhVXNlci5leHBhbmRvIF0gKSB7CgoJCQkJCS8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUrCgkJCQkJLy8gQXNzaWduIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHVzaW5nIGRlbGV0ZSwgc2VlIERhdGEjcmVtb3ZlCgkJCQkJZWxlbVsgZGF0YVVzZXIuZXhwYW5kbyBdID0gdW5kZWZpbmVkOwoJCQkJfQoJCQl9CgkJfQoJfQp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gcmVtb3ZlKCB0aGlzLCBzZWxlY3RvciwgdHJ1ZSApOwoJfSwKCglyZW1vdmU6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gcmVtb3ZlKCB0aGlzLCBzZWxlY3RvciApOwoJfSwKCgl0ZXh0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQlyZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CgkJCQlqUXVlcnkudGV4dCggdGhpcyApIDoKCQkJCXRoaXMuZW1wdHkoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQkJdGhpcy50ZXh0Q29udGVudCA9IHZhbHVlOwoJCQkJCX0KCQkJCX0gKTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCApOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBkb21NYW5pcCggdGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0gKTsKCX0sCgoJcHJlcGVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQoIHRoaXMsIGVsZW0gKTsKCQkJCXRhcmdldC5pbnNlcnRCZWZvcmUoIGVsZW0sIHRhcmdldC5maXJzdENoaWxkICk7CgkJCX0KCQl9ICk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGRvbU1hbmlwKCB0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQlpZiAoIHRoaXMucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGVsZW0sIHRoaXMgKTsKCQkJfQoJCX0gKTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBkb21NYW5pcCggdGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLm5leHRTaWJsaW5nICk7CgkJCX0KCQl9ICk7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSwKCQkJaSA9IDA7CgoJCWZvciAoIDsgKCBlbGVtID0gdGhpc1sgaSBdICkgIT0gbnVsbDsgaSsrICkgewoJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgoJCQkJLy8gUHJldmVudCBtZW1vcnkgbGVha3MKCQkJCWpRdWVyeS5jbGVhbkRhdGEoIGdldEFsbCggZWxlbSwgZmFsc2UgKSApOwoKCQkJCS8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCgkJCQllbGVtLnRleHRDb250ZW50ID0gIiI7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICkgewoJCWRhdGFBbmRFdmVudHMgPSBkYXRhQW5kRXZlbnRzID09IG51bGwgPyBmYWxzZSA6IGRhdGFBbmRFdmVudHM7CgkJZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwoKCQlyZXR1cm4gdGhpcy5tYXAoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4galF1ZXJ5LmNsb25lKCB0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApOwoJCX0gKTsKCX0sCgoJaHRtbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGVsZW0gPSB0aGlzWyAwIF0gfHwge30sCgkJCQlpID0gMCwKCQkJCWwgPSB0aGlzLmxlbmd0aDsKCgkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJcmV0dXJuIGVsZW0uaW5uZXJIVE1MOwoJCQl9CgoJCQkvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhcm5vSW5uZXJodG1sLnRlc3QoIHZhbHVlICkgJiYKCQkJCSF3cmFwTWFwWyAoIHJ0YWdOYW1lLmV4ZWMoIHZhbHVlICkgfHwgWyAiIiwgIiIgXSApWyAxIF0udG9Mb3dlckNhc2UoKSBdICkgewoKCQkJCXZhbHVlID0galF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoIHZhbHVlICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQkJCWVsZW0gPSB0aGlzWyBpIF0gfHwge307CgoJCQkJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgkJCQkJCQllbGVtLmlubmVySFRNTCA9IHZhbHVlOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQllbGVtID0gMDsKCgkJCQkvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKCQkJCX0gY2F0Y2ggKCBlICkge30KCQkJfQoKCQkJaWYgKCBlbGVtICkgewoJCQkJdGhpcy5lbXB0eSgpLmFwcGVuZCggdmFsdWUgKTsKCQkJfQoJCX0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoICk7Cgl9LAoKCXJlcGxhY2VXaXRoOiBmdW5jdGlvbigpIHsKCQl2YXIgaWdub3JlZCA9IFtdOwoKCQkvLyBNYWtlIHRoZSBjaGFuZ2VzLCByZXBsYWNpbmcgZWFjaCBub24taWdub3JlZCBjb250ZXh0IGVsZW1lbnQgd2l0aCB0aGUgbmV3IGNvbnRlbnQKCQlyZXR1cm4gZG9tTWFuaXAoIHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7CgoJCQlpZiAoIGpRdWVyeS5pbkFycmF5KCB0aGlzLCBpZ25vcmVkICkgPCAwICkgewoJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCB0aGlzICkgKTsKCQkJCWlmICggcGFyZW50ICkgewoJCQkJCXBhcmVudC5yZXBsYWNlQ2hpbGQoIGVsZW0sIHRoaXMgKTsKCQkJCX0KCQkJfQoKCQkvLyBGb3JjZSBjYWxsYmFjayBpbnZvY2F0aW9uCgkJfSwgaWdub3JlZCApOwoJfQp9ICk7CgpqUXVlcnkuZWFjaCggewoJYXBwZW5kVG86ICJhcHBlbmQiLAoJcHJlcGVuZFRvOiAicHJlcGVuZCIsCglpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAoJaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCglyZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCn0sIGZ1bmN0aW9uKCBuYW1lLCBvcmlnaW5hbCApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBlbGVtcywKCQkJcmV0ID0gW10sCgkJCWluc2VydCA9IGpRdWVyeSggc2VsZWN0b3IgKSwKCQkJbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLAoJCQlpID0gMDsKCgkJZm9yICggOyBpIDw9IGxhc3Q7IGkrKyApIHsKCQkJZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUoIHRydWUgKTsKCQkJalF1ZXJ5KCBpbnNlcnRbIGkgXSApWyBvcmlnaW5hbCBdKCBlbGVtcyApOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CgkJCS8vIC5nZXQoKSBiZWNhdXNlIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKCQkJcHVzaC5hcHBseSggcmV0LCBlbGVtcy5nZXQoKSApOwoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCByZXQgKTsKCX07Cn0gKTsKdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoICJeKCIgKyBwbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIiApOwoKdmFyIGdldFN0eWxlcyA9IGZ1bmN0aW9uKCBlbGVtICkgewoKCQkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHksIEZpcmVmb3ggPD0zMCAoIzE1MDk4LCAjMTQxNTApCgkJLy8gSUUgdGhyb3dzIG9uIGVsZW1lbnRzIGNyZWF0ZWQgaW4gcG9wdXBzCgkJLy8gRkYgbWVhbndoaWxlIHRocm93cyBvbiBmcmFtZSBlbGVtZW50cyB0aHJvdWdoICJkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlIgoJCXZhciB2aWV3ID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwoKCQlpZiAoICF2aWV3IHx8ICF2aWV3Lm9wZW5lciApIHsKCQkJdmlldyA9IHdpbmRvdzsKCQl9CgoJCXJldHVybiB2aWV3LmdldENvbXB1dGVkU3R5bGUoIGVsZW0gKTsKCX07Cgp2YXIgcmJveFN0eWxlID0gbmV3IFJlZ0V4cCggY3NzRXhwYW5kLmpvaW4oICJ8IiApLCAiaSIgKTsKCgoKKCBmdW5jdGlvbigpIHsKCgkvLyBFeGVjdXRpbmcgYm90aCBwaXhlbFBvc2l0aW9uICYgYm94U2l6aW5nUmVsaWFibGUgdGVzdHMgcmVxdWlyZSBvbmx5IG9uZSBsYXlvdXQKCS8vIHNvIHRoZXkncmUgZXhlY3V0ZWQgYXQgdGhlIHNhbWUgdGltZSB0byBzYXZlIHRoZSBzZWNvbmQgY29tcHV0YXRpb24uCglmdW5jdGlvbiBjb21wdXRlU3R5bGVUZXN0cygpIHsKCgkJLy8gVGhpcyBpcyBhIHNpbmdsZXRvbiwgd2UgbmVlZCB0byBleGVjdXRlIGl0IG9ubHkgb25jZQoJCWlmICggIWRpdiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7bGVmdDotMTExMTFweDt3aWR0aDo2MHB4OyIgKwoJCQkibWFyZ2luLXRvcDoxcHg7cGFkZGluZzowO2JvcmRlcjowIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9CgkJCSJwb3NpdGlvbjpyZWxhdGl2ZTtkaXNwbGF5OmJsb2NrO2JveC1zaXppbmc6Ym9yZGVyLWJveDtvdmVyZmxvdzpzY3JvbGw7IiArCgkJCSJtYXJnaW46YXV0bztib3JkZXI6MXB4O3BhZGRpbmc6MXB4OyIgKwoJCQkid2lkdGg6NjAlO3RvcDoxJSI7CgkJZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKCBjb250YWluZXIgKS5hcHBlbmRDaGlsZCggZGl2ICk7CgoJCXZhciBkaXZTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYgKTsKCQlwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAiMSUiOwoKCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCAtIDQuMyBvbmx5LCBGaXJlZm94IDw9MyAtIDQ0CgkJcmVsaWFibGVNYXJnaW5MZWZ0VmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS5tYXJnaW5MZWZ0ICkgPT09IDEyOwoKCQkvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCAtIDQuMyBvbmx5LCBTYWZhcmkgPD05LjEgLSAxMC4xLCBpT1MgPD03LjAgLSA5LjMKCQkvLyBTb21lIHN0eWxlcyBjb21lIGJhY2sgd2l0aCBwZXJjZW50YWdlIHZhbHVlcywgZXZlbiB0aG91Z2ggdGhleSBzaG91bGRuJ3QKCQlkaXYuc3R5bGUucmlnaHQgPSAiNjAlIjsKCQlwaXhlbEJveFN0eWxlc1ZhbCA9IHJvdW5kUGl4ZWxNZWFzdXJlcyggZGl2U3R5bGUucmlnaHQgKSA9PT0gMzY7CgoJCS8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CgkJLy8gRGV0ZWN0IG1pc3JlcG9ydGluZyBvZiBjb250ZW50IGRpbWVuc2lvbnMgZm9yIGJveC1zaXppbmc6Ym9yZGVyLWJveCBlbGVtZW50cwoJCWJveFNpemluZ1JlbGlhYmxlVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKCBkaXZTdHlsZS53aWR0aCApID09PSAzNjsKCgkJLy8gU3VwcG9ydDogSUUgOSBvbmx5CgkJLy8gRGV0ZWN0IG92ZXJmbG93OnNjcm9sbCBzY3Jld2luZXNzIChnaC0zNjk5KQoJCWRpdi5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CgkJc2Nyb2xsYm94U2l6ZVZhbCA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gMzYgfHwgImFic29sdXRlIjsKCgkJZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCgkJLy8gTnVsbGlmeSB0aGUgZGl2IHNvIGl0IHdvdWxkbid0IGJlIHN0b3JlZCBpbiB0aGUgbWVtb3J5IGFuZAoJCS8vIGl0IHdpbGwgYWxzbyBiZSBhIHNpZ24gdGhhdCBjaGVja3MgYWxyZWFkeSBwZXJmb3JtZWQKCQlkaXYgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJvdW5kUGl4ZWxNZWFzdXJlcyggbWVhc3VyZSApIHsKCQlyZXR1cm4gTWF0aC5yb3VuZCggcGFyc2VGbG9hdCggbWVhc3VyZSApICk7Cgl9CgoJdmFyIHBpeGVsUG9zaXRpb25WYWwsIGJveFNpemluZ1JlbGlhYmxlVmFsLCBzY3JvbGxib3hTaXplVmFsLCBwaXhlbEJveFN0eWxlc1ZhbCwKCQlyZWxpYWJsZU1hcmdpbkxlZnRWYWwsCgkJY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCS8vIEZpbmlzaCBlYXJseSBpbiBsaW1pdGVkIChub24tYnJvd3NlcikgZW52aXJvbm1lbnRzCglpZiAoICFkaXYuc3R5bGUgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkKCS8vIFN0eWxlIG9mIGNsb25lZCBlbGVtZW50IGFmZmVjdHMgc291cmNlIGVsZW1lbnQgY2xvbmVkICgjODkwOCkKCWRpdi5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICJjb250ZW50LWJveCI7CglkaXYuY2xvbmVOb2RlKCB0cnVlICkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsKCXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAiY29udGVudC1ib3giOwoKCWpRdWVyeS5leHRlbmQoIHN1cHBvcnQsIHsKCQlib3hTaXppbmdSZWxpYWJsZTogZnVuY3Rpb24oKSB7CgkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCXJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKCQl9LAoJCXBpeGVsQm94U3R5bGVzOiBmdW5jdGlvbigpIHsKCQkJY29tcHV0ZVN0eWxlVGVzdHMoKTsKCQkJcmV0dXJuIHBpeGVsQm94U3R5bGVzVmFsOwoJCX0sCgkJcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCWNvbXB1dGVTdHlsZVRlc3RzKCk7CgkJCXJldHVybiBwaXhlbFBvc2l0aW9uVmFsOwoJCX0sCgkJcmVsaWFibGVNYXJnaW5MZWZ0OiBmdW5jdGlvbigpIHsKCQkJY29tcHV0ZVN0eWxlVGVzdHMoKTsKCQkJcmV0dXJuIHJlbGlhYmxlTWFyZ2luTGVmdFZhbDsKCQl9LAoJCXNjcm9sbGJveFNpemU6IGZ1bmN0aW9uKCkgewoJCQljb21wdXRlU3R5bGVUZXN0cygpOwoJCQlyZXR1cm4gc2Nyb2xsYm94U2l6ZVZhbDsKCQl9Cgl9ICk7Cn0gKSgpOwoKCmZ1bmN0aW9uIGN1ckNTUyggZWxlbSwgbmFtZSwgY29tcHV0ZWQgKSB7Cgl2YXIgd2lkdGgsIG1pbldpZHRoLCBtYXhXaWR0aCwgcmV0LAoKCQkvLyBTdXBwb3J0OiBGaXJlZm94IDUxKwoJCS8vIFJldHJpZXZpbmcgc3R5bGUgYmVmb3JlIGNvbXB1dGVkIHNvbWVob3cKCQkvLyBmaXhlcyBhbiBpc3N1ZSB3aXRoIGdldHRpbmcgd3JvbmcgdmFsdWVzCgkJLy8gb24gZGV0YWNoZWQgZWxlbWVudHMKCQlzdHlsZSA9IGVsZW0uc3R5bGU7CgoJY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoIGVsZW0gKTsKCgkvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG5lZWRlZCBmb3I6CgkvLyAgIC5jc3MoJ2ZpbHRlcicpIChJRSA5IG9ubHksICMxMjUzNykKCS8vICAgLmNzcygnLS1jdXN0b21Qcm9wZXJ0eSkgKCMzMTQ0KQoJaWYgKCBjb21wdXRlZCApIHsKCQlyZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKCBuYW1lICkgfHwgY29tcHV0ZWRbIG5hbWUgXTsKCgkJaWYgKCByZXQgPT09ICIiICYmICFqUXVlcnkuY29udGFpbnMoIGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSApICkgewoJCQlyZXQgPSBqUXVlcnkuc3R5bGUoIGVsZW0sIG5hbWUgKTsKCQl9CgoJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJLy8gQW5kcm9pZCBCcm93c2VyIHJldHVybnMgcGVyY2VudGFnZSBmb3Igc29tZSB2YWx1ZXMsCgkJLy8gYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscy4KCQkvLyBUaGlzIGlzIGFnYWluc3QgdGhlIENTU09NIGRyYWZ0IHNwZWM6CgkJLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKCQlpZiAoICFzdXBwb3J0LnBpeGVsQm94U3R5bGVzKCkgJiYgcm51bW5vbnB4LnRlc3QoIHJldCApICYmIHJib3hTdHlsZS50ZXN0KCBuYW1lICkgKSB7CgoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCXdpZHRoID0gc3R5bGUud2lkdGg7CgkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJcmV0ID0gY29tcHV0ZWQud2lkdGg7CgoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CgkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CgkJfQoJfQoKCXJldHVybiByZXQgIT09IHVuZGVmaW5lZCA/CgoJCS8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkKCQkvLyBJRSByZXR1cm5zIHpJbmRleCB2YWx1ZSBhcyBhbiBpbnRlZ2VyLgoJCXJldCArICIiIDoKCQlyZXQ7Cn0KCgpmdW5jdGlvbiBhZGRHZXRIb29rSWYoIGNvbmRpdGlvbkZuLCBob29rRm4gKSB7CgoJLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KCXJldHVybiB7CgkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCBjb25kaXRpb25GbigpICkgewoKCQkJCS8vIEhvb2sgbm90IG5lZWRlZCAob3IgaXQncyBub3QgcG9zc2libGUgdG8gdXNlIGl0IGR1ZQoJCQkJLy8gdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwgcmVtb3ZlIGl0LgoJCQkJZGVsZXRlIHRoaXMuZ2V0OwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBIb29rIG5lZWRlZDsgcmVkZWZpbmUgaXQgc28gdGhhdCB0aGUgc3VwcG9ydCB0ZXN0IGlzIG5vdCBleGVjdXRlZCBhZ2Fpbi4KCQkJcmV0dXJuICggdGhpcy5nZXQgPSBob29rRm4gKS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoJfTsKfQoKCnZhcgoKCS8vIFN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUKCS8vIGV4Y2VwdCAidGFibGUiLCAidGFibGUtY2VsbCIsIG9yICJ0YWJsZS1jYXB0aW9uIgoJLy8gU2VlIGhlcmUgZm9yIGRpc3BsYXkgdmFsdWVzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0NTUy9kaXNwbGF5CglyZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCglyY3VzdG9tUHJvcCA9IC9eLS0vLAoJY3NzU2hvdyA9IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHZpc2liaWxpdHk6ICJoaWRkZW4iLCBkaXNwbGF5OiAiYmxvY2siIH0sCgljc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CgkJbGV0dGVyU3BhY2luZzogIjAiLAoJCWZvbnRXZWlnaHQ6ICI0MDAiCgl9LAoKCWNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk1veiIsICJtcyIgXSwKCWVtcHR5U3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLnN0eWxlOwoKLy8gUmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggbmFtZSApIHsKCgkvLyBTaG9ydGN1dCBmb3IgbmFtZXMgdGhhdCBhcmUgbm90IHZlbmRvciBwcmVmaXhlZAoJaWYgKCBuYW1lIGluIGVtcHR5U3R5bGUgKSB7CgkJcmV0dXJuIG5hbWU7Cgl9CgoJLy8gQ2hlY2sgZm9yIHZlbmRvciBwcmVmaXhlZCBuYW1lcwoJdmFyIGNhcE5hbWUgPSBuYW1lWyAwIF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoIDEgKSwKCQlpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCW5hbWUgPSBjc3NQcmVmaXhlc1sgaSBdICsgY2FwTmFtZTsKCQlpZiAoIG5hbWUgaW4gZW1wdHlTdHlsZSApIHsKCQkJcmV0dXJuIG5hbWU7CgkJfQoJfQp9CgovLyBSZXR1cm4gYSBwcm9wZXJ0eSBtYXBwZWQgYWxvbmcgd2hhdCBqUXVlcnkuY3NzUHJvcHMgc3VnZ2VzdHMgb3IgdG8KLy8gYSB2ZW5kb3IgcHJlZml4ZWQgcHJvcGVydHkuCmZ1bmN0aW9uIGZpbmFsUHJvcE5hbWUoIG5hbWUgKSB7Cgl2YXIgcmV0ID0galF1ZXJ5LmNzc1Byb3BzWyBuYW1lIF07CglpZiAoICFyZXQgKSB7CgkJcmV0ID0galF1ZXJ5LmNzc1Byb3BzWyBuYW1lIF0gPSB2ZW5kb3JQcm9wTmFtZSggbmFtZSApIHx8IG5hbWU7Cgl9CglyZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICkgewoKCS8vIEFueSByZWxhdGl2ZSAoKy8tKSB2YWx1ZXMgaGF2ZSBhbHJlYWR5IGJlZW4KCS8vIG5vcm1hbGl6ZWQgYXQgdGhpcyBwb2ludAoJdmFyIG1hdGNoZXMgPSByY3NzTnVtLmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgoJCS8vIEd1YXJkIGFnYWluc3QgdW5kZWZpbmVkICJzdWJ0cmFjdCIsIGUuZy4sIHdoZW4gdXNlZCBhcyBpbiBjc3NIb29rcwoJCU1hdGgubWF4KCAwLCBtYXRjaGVzWyAyIF0gLSAoIHN1YnRyYWN0IHx8IDAgKSApICsgKCBtYXRjaGVzWyAzIF0gfHwgInB4IiApIDoKCQl2YWx1ZTsKfQoKZnVuY3Rpb24gYm94TW9kZWxBZGp1c3RtZW50KCBlbGVtLCBkaW1lbnNpb24sIGJveCwgaXNCb3JkZXJCb3gsIHN0eWxlcywgY29tcHV0ZWRWYWwgKSB7Cgl2YXIgaSA9IGRpbWVuc2lvbiA9PT0gIndpZHRoIiA/IDEgOiAwLAoJCWV4dHJhID0gMCwKCQlkZWx0YSA9IDA7CgoJLy8gQWRqdXN0bWVudCBtYXkgbm90IGJlIG5lY2Vzc2FyeQoJaWYgKCBib3ggPT09ICggaXNCb3JkZXJCb3ggPyAiYm9yZGVyIiA6ICJjb250ZW50IiApICkgewoJCXJldHVybiAwOwoJfQoKCWZvciAoIDsgaSA8IDQ7IGkgKz0gMiApIHsKCgkJLy8gQm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luCgkJaWYgKCBib3ggPT09ICJtYXJnaW4iICkgewoJCQlkZWx0YSArPSBqUXVlcnkuY3NzKCBlbGVtLCBib3ggKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQkvLyBJZiB3ZSBnZXQgaGVyZSB3aXRoIGEgY29udGVudC1ib3gsIHdlJ3JlIHNlZWtpbmcgInBhZGRpbmciIG9yICJib3JkZXIiIG9yICJtYXJnaW4iCgkJaWYgKCAhaXNCb3JkZXJCb3ggKSB7CgoJCQkvLyBBZGQgcGFkZGluZwoJCQlkZWx0YSArPSBqUXVlcnkuY3NzKCBlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgoJCQkvLyBGb3IgImJvcmRlciIgb3IgIm1hcmdpbiIsIGFkZCBib3JkZXIKCQkJaWYgKCBib3ggIT09ICJwYWRkaW5nIiApIHsKCQkJCWRlbHRhICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIEJ1dCBzdGlsbCBrZWVwIHRyYWNrIG9mIGl0IG90aGVyd2lzZQoJCQl9IGVsc2UgewoJCQkJZXh0cmEgKz0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgoJCS8vIElmIHdlIGdldCBoZXJlIHdpdGggYSBib3JkZXItYm94IChjb250ZW50ICsgcGFkZGluZyArIGJvcmRlciksIHdlJ3JlIHNlZWtpbmcgImNvbnRlbnQiIG9yCgkJLy8gInBhZGRpbmciIG9yICJtYXJnaW4iCgkJfSBlbHNlIHsKCgkJCS8vIEZvciAiY29udGVudCIsIHN1YnRyYWN0IHBhZGRpbmcKCQkJaWYgKCBib3ggPT09ICJjb250ZW50IiApIHsKCQkJCWRlbHRhIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gRm9yICJjb250ZW50IiBvciAicGFkZGluZyIsIHN1YnRyYWN0IGJvcmRlcgoJCQlpZiAoIGJveCAhPT0gIm1hcmdpbiIgKSB7CgkJCQlkZWx0YSAtPSBqUXVlcnkuY3NzKCBlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFsgaSBdICsgIldpZHRoIiwgdHJ1ZSwgc3R5bGVzICk7CgkJCX0KCQl9Cgl9CgoJLy8gQWNjb3VudCBmb3IgcG9zaXRpdmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlciB3aGVuIHJlcXVlc3RlZCBieSBwcm92aWRpbmcgY29tcHV0ZWRWYWwKCWlmICggIWlzQm9yZGVyQm94ICYmIGNvbXB1dGVkVmFsID49IDAgKSB7CgoJCS8vIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyBhIHJvdW5kZWQgc3VtIG9mIGNvbnRlbnQsIHBhZGRpbmcsIHNjcm9sbCBndXR0ZXIsIGFuZCBib3JkZXIKCQkvLyBBc3N1bWluZyBpbnRlZ2VyIHNjcm9sbCBndXR0ZXIsIHN1YnRyYWN0IHRoZSByZXN0IGFuZCByb3VuZCBkb3duCgkJZGVsdGEgKz0gTWF0aC5tYXgoIDAsIE1hdGguY2VpbCgKCQkJZWxlbVsgIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICkgXSAtCgkJCWNvbXB1dGVkVmFsIC0KCQkJZGVsdGEgLQoJCQlleHRyYSAtCgkJCTAuNQoJCSkgKTsKCX0KCglyZXR1cm4gZGVsdGE7Cn0KCmZ1bmN0aW9uIGdldFdpZHRoT3JIZWlnaHQoIGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEgKSB7CgoJLy8gU3RhcnQgd2l0aCBjb21wdXRlZCBzdHlsZQoJdmFyIHN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApLAoJCXZhbCA9IGN1ckNTUyggZWxlbSwgZGltZW5zaW9uLCBzdHlsZXMgKSwKCQlpc0JvcmRlckJveCA9IGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQl2YWx1ZUlzQm9yZGVyQm94ID0gaXNCb3JkZXJCb3g7CgoJLy8gU3VwcG9ydDogRmlyZWZveCA8PTU0CgkvLyBSZXR1cm4gYSBjb25mb3VuZGluZyBub24tcGl4ZWwgdmFsdWUgb3IgZmVpZ24gaWdub3JhbmNlLCBhcyBhcHByb3ByaWF0ZS4KCWlmICggcm51bW5vbnB4LnRlc3QoIHZhbCApICkgewoJCWlmICggIWV4dHJhICkgewoJCQlyZXR1cm4gdmFsOwoJCX0KCQl2YWwgPSAiYXV0byI7Cgl9CgoJLy8gQ2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKCS8vIGZvciBnZXRDb21wdXRlZFN0eWxlIHNpbGVudGx5IGZhbGxzIGJhY2sgdG8gdGhlIHJlbGlhYmxlIGVsZW0uc3R5bGUKCXZhbHVlSXNCb3JkZXJCb3ggPSB2YWx1ZUlzQm9yZGVyQm94ICYmCgkJKCBzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBkaW1lbnNpb24gXSApOwoKCS8vIEZhbGwgYmFjayB0byBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgd2hlbiB2YWx1ZSBpcyAiYXV0byIKCS8vIFRoaXMgaGFwcGVucyBmb3IgaW5saW5lIGVsZW1lbnRzIHdpdGggbm8gZXhwbGljaXQgc2V0dGluZyAoZ2gtMzU3MSkKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjEgLSA0LjMgb25seQoJLy8gQWxzbyB1c2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciBtaXNyZXBvcnRlZCBpbmxpbmUgZGltZW5zaW9ucyAoZ2gtMzYwMikKCWlmICggdmFsID09PSAiYXV0byIgfHwKCQkhcGFyc2VGbG9hdCggdmFsICkgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiLCBmYWxzZSwgc3R5bGVzICkgPT09ICJpbmxpbmUiICkgewoKCQl2YWwgPSBlbGVtWyAib2Zmc2V0IiArIGRpbWVuc2lvblsgMCBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoIDEgKSBdOwoKCQkvLyBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgcHJvdmlkZSBib3JkZXItYm94IHZhbHVlcwoJCXZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlOwoJfQoKCS8vIE5vcm1hbGl6ZSAiIiBhbmQgYXV0bwoJdmFsID0gcGFyc2VGbG9hdCggdmFsICkgfHwgMDsKCgkvLyBBZGp1c3QgZm9yIHRoZSBlbGVtZW50J3MgYm94IG1vZGVsCglyZXR1cm4gKCB2YWwgKwoJCWJveE1vZGVsQWRqdXN0bWVudCgKCQkJZWxlbSwKCQkJZGltZW5zaW9uLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveCwKCQkJc3R5bGVzLAoKCQkJLy8gUHJvdmlkZSB0aGUgY3VycmVudCBjb21wdXRlZCBzaXplIHRvIHJlcXVlc3Qgc2Nyb2xsIGd1dHRlciBjYWxjdWxhdGlvbiAoZ2gtMzU4OSkKCQkJdmFsCgkJKQoJKSArICJweCI7Cn0KCmpRdWVyeS5leHRlbmQoIHsKCgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCgkJCQkJLy8gV2Ugc2hvdWxkIGFsd2F5cyBnZXQgYSBudW1iZXIgYmFjayBmcm9tIG9wYWNpdHkKCQkJCQl2YXIgcmV0ID0gY3VyQ1NTKCBlbGVtLCAib3BhY2l0eSIgKTsKCQkJCQlyZXR1cm4gcmV0ID09PSAiIiA/ICIxIiA6IHJldDsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gRG9uJ3QgYXV0b21hdGljYWxseSBhZGQgInB4IiB0byB0aGVzZSBwb3NzaWJseS11bml0bGVzcyBwcm9wZXJ0aWVzCgljc3NOdW1iZXI6IHsKCQkiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiOiB0cnVlLAoJCSJjb2x1bW5Db3VudCI6IHRydWUsCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZmxleEdyb3ciOiB0cnVlLAoJCSJmbGV4U2hyaW5rIjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JkZXIiOiB0cnVlLAoJCSJvcnBoYW5zIjogdHJ1ZSwKCQkid2lkb3dzIjogdHJ1ZSwKCQkiekluZGV4IjogdHJ1ZSwKCQkiem9vbSI6IHRydWUKCX0sCgoJLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQoJY3NzUHJvcHM6IHt9LAoKCS8vIEdldCBhbmQgc2V0IHRoZSBzdHlsZSBwcm9wZXJ0eSBvbiBhIERPTSBOb2RlCglzdHlsZTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlLCBleHRyYSApIHsKCgkJLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCXZhciByZXQsIHR5cGUsIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGNhbWVsQ2FzZSggbmFtZSApLAoJCQlpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KCBuYW1lICksCgkJCXN0eWxlID0gZWxlbS5zdHlsZTsKCgkJLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lLiBXZSBkb24ndAoJCS8vIHdhbnQgdG8gcXVlcnkgdGhlIHZhbHVlIGlmIGl0IGlzIGEgQ1NTIGN1c3RvbSBwcm9wZXJ0eQoJCS8vIHNpbmNlIHRoZXkgYXJlIHVzZXItZGVmaW5lZC4KCQlpZiAoICFpc0N1c3RvbVByb3AgKSB7CgkJCW5hbWUgPSBmaW5hbFByb3BOYW1lKCBvcmlnTmFtZSApOwoJCX0KCgkJLy8gR2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbiwgdGhlbiB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gQ2hlY2sgaWYgd2UncmUgc2V0dGluZyBhIHZhbHVlCgkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0eXBlID0gdHlwZW9mIHZhbHVlOwoKCQkJLy8gQ29udmVydCAiKz0iIG9yICItPSIgdG8gcmVsYXRpdmUgbnVtYmVycyAoIzczNDUpCgkJCWlmICggdHlwZSA9PT0gInN0cmluZyIgJiYgKCByZXQgPSByY3NzTnVtLmV4ZWMoIHZhbHVlICkgKSAmJiByZXRbIDEgXSApIHsKCQkJCXZhbHVlID0gYWRqdXN0Q1NTKCBlbGVtLCBuYW1lLCByZXQgKTsKCgkJCQkvLyBGaXhlcyBidWcgIzkyMzcKCQkJCXR5cGUgPSAibnVtYmVyIjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoYXQgbnVsbCBhbmQgTmFOIHZhbHVlcyBhcmVuJ3Qgc2V0ICgjNzExNikKCQkJaWYgKCB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkIHRoZSB1bml0IChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCgkJCWlmICggdHlwZSA9PT0gIm51bWJlciIgKSB7CgkJCQl2YWx1ZSArPSByZXQgJiYgcmV0WyAzIF0gfHwgKCBqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdID8gIiIgOiAicHgiICk7CgkJCX0KCgkJCS8vIGJhY2tncm91bmQtKiBwcm9wcyBhZmZlY3Qgb3JpZ2luYWwgY2xvbmUncyB2YWx1ZXMKCQkJaWYgKCAhc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICIiICYmIG5hbWUuaW5kZXhPZiggImJhY2tncm91bmQiICkgPT09IDAgKSB7CgkJCQlzdHlsZVsgbmFtZSBdID0gImluaGVyaXQiOwoJCQl9CgoJCQkvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKCQkJaWYgKCAhaG9va3MgfHwgISggInNldCIgaW4gaG9va3MgKSB8fAoJCQkJKCB2YWx1ZSA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIGV4dHJhICkgKSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCWlmICggaXNDdXN0b21Qcm9wICkgewoJCQkJCXN0eWxlLnNldFByb3BlcnR5KCBuYW1lLCB2YWx1ZSApOwoJCQkJfSBlbHNlIHsKCQkJCQlzdHlsZVsgbmFtZSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmCgkJCQkoIHJldCA9IGhvb2tzLmdldCggZWxlbSwgZmFsc2UsIGV4dHJhICkgKSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXJldHVybiByZXQ7CgkJCX0KCgkJCS8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CgkJCXJldHVybiBzdHlsZVsgbmFtZSBdOwoJCX0KCX0sCgoJY3NzOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZXh0cmEsIHN0eWxlcyApIHsKCQl2YXIgdmFsLCBudW0sIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGNhbWVsQ2FzZSggbmFtZSApLAoJCQlpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KCBuYW1lICk7CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZS4gV2UgZG9uJ3QKCQkvLyB3YW50IHRvIG1vZGlmeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5CgkJLy8gc2luY2UgdGhleSBhcmUgdXNlci1kZWZpbmVkLgoJCWlmICggIWlzQ3VzdG9tUHJvcCApIHsKCQkJbmFtZSA9IGZpbmFsUHJvcE5hbWUoIG9yaWdOYW1lICk7CgkJfQoKCQkvLyBUcnkgcHJlZml4ZWQgbmFtZSBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCBuYW1lCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07CgoJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCgkJaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyApIHsKCQkJdmFsID0gaG9va3MuZ2V0KCBlbGVtLCB0cnVlLCBleHRyYSApOwoJCX0KCgkJLy8gT3RoZXJ3aXNlLCBpZiBhIHdheSB0byBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGV4aXN0cywgdXNlIHRoYXQKCQlpZiAoIHZhbCA9PT0gdW5kZWZpbmVkICkgewoJCQl2YWwgPSBjdXJDU1MoIGVsZW0sIG5hbWUsIHN0eWxlcyApOwoJCX0KCgkJLy8gQ29udmVydCAibm9ybWFsIiB0byBjb21wdXRlZCB2YWx1ZQoJCWlmICggdmFsID09PSAibm9ybWFsIiAmJiBuYW1lIGluIGNzc05vcm1hbFRyYW5zZm9ybSApIHsKCQkJdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtWyBuYW1lIF07CgkJfQoKCQkvLyBNYWtlIG51bWVyaWMgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKCQlpZiAoIGV4dHJhID09PSAiIiB8fCBleHRyYSApIHsKCQkJbnVtID0gcGFyc2VGbG9hdCggdmFsICk7CgkJCXJldHVybiBleHRyYSA9PT0gdHJ1ZSB8fCBpc0Zpbml0ZSggbnVtICkgPyBudW0gfHwgMCA6IHZhbDsKCQl9CgoJCXJldHVybiB2YWw7Cgl9Cn0gKTsKCmpRdWVyeS5lYWNoKCBbICJoZWlnaHQiLCAid2lkdGgiIF0sIGZ1bmN0aW9uKCBpLCBkaW1lbnNpb24gKSB7CglqUXVlcnkuY3NzSG9va3NbIGRpbWVuc2lvbiBdID0gewoJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkLCBleHRyYSApIHsKCQkJaWYgKCBjb21wdXRlZCApIHsKCgkJCQkvLyBDZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KCQkJCS8vIGJ1dCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0CgkJCQlyZXR1cm4gcmRpc3BsYXlzd2FwLnRlc3QoIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApICkgJiYKCgkJCQkJLy8gU3VwcG9ydDogU2FmYXJpIDgrCgkJCQkJLy8gVGFibGUgY29sdW1ucyBpbiBTYWZhcmkgaGF2ZSBub24temVybyBvZmZzZXRXaWR0aCAmIHplcm8KCQkJCQkvLyBnZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCB1bmxlc3MgZGlzcGxheSBpcyBjaGFuZ2VkLgoJCQkJCS8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQoJCQkJCS8vIFJ1bm5pbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IG9uIGEgZGlzY29ubmVjdGVkIG5vZGUKCQkJCQkvLyBpbiBJRSB0aHJvd3MgYW4gZXJyb3IuCgkJCQkJKCAhZWxlbS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCB8fCAhZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCApID8KCQkJCQkJc3dhcCggZWxlbSwgY3NzU2hvdywgZnVuY3Rpb24oKSB7CgkJCQkJCQlyZXR1cm4gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgZGltZW5zaW9uLCBleHRyYSApOwoJCQkJCQl9ICkgOgoJCQkJCQlnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBkaW1lbnNpb24sIGV4dHJhICk7CgkJCX0KCQl9LAoKCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgZXh0cmEgKSB7CgkJCXZhciBtYXRjaGVzLAoJCQkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksCgkJCQlpc0JvcmRlckJveCA9IGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCXN1YnRyYWN0ID0gZXh0cmEgJiYgYm94TW9kZWxBZGp1c3RtZW50KAoJCQkJCWVsZW0sCgkJCQkJZGltZW5zaW9uLAoJCQkJCWV4dHJhLAoJCQkJCWlzQm9yZGVyQm94LAoJCQkJCXN0eWxlcwoJCQkJKTsKCgkJCS8vIEFjY291bnQgZm9yIHVucmVsaWFibGUgYm9yZGVyLWJveCBkaW1lbnNpb25zIGJ5IGNvbXBhcmluZyBvZmZzZXQqIHRvIGNvbXB1dGVkIGFuZAoJCQkvLyBmYWtpbmcgYSBjb250ZW50LWJveCB0byBnZXQgYm9yZGVyIGFuZCBwYWRkaW5nIChnaC0zNjk5KQoJCQlpZiAoIGlzQm9yZGVyQm94ICYmIHN1cHBvcnQuc2Nyb2xsYm94U2l6ZSgpID09PSBzdHlsZXMucG9zaXRpb24gKSB7CgkJCQlzdWJ0cmFjdCAtPSBNYXRoLmNlaWwoCgkJCQkJZWxlbVsgIm9mZnNldCIgKyBkaW1lbnNpb25bIDAgXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKCAxICkgXSAtCgkJCQkJcGFyc2VGbG9hdCggc3R5bGVzWyBkaW1lbnNpb24gXSApIC0KCQkJCQlib3hNb2RlbEFkanVzdG1lbnQoIGVsZW0sIGRpbWVuc2lvbiwgImJvcmRlciIsIGZhbHNlLCBzdHlsZXMgKSAtCgkJCQkJMC41CgkJCQkpOwoJCQl9CgoJCQkvLyBDb252ZXJ0IHRvIHBpeGVscyBpZiB2YWx1ZSBhZGp1c3RtZW50IGlzIG5lZWRlZAoJCQlpZiAoIHN1YnRyYWN0ICYmICggbWF0Y2hlcyA9IHJjc3NOdW0uZXhlYyggdmFsdWUgKSApICYmCgkJCQkoIG1hdGNoZXNbIDMgXSB8fCAicHgiICkgIT09ICJweCIgKSB7CgoJCQkJZWxlbS5zdHlsZVsgZGltZW5zaW9uIF0gPSB2YWx1ZTsKCQkJCXZhbHVlID0galF1ZXJ5LmNzcyggZWxlbSwgZGltZW5zaW9uICk7CgkJCX0KCgkJCXJldHVybiBzZXRQb3NpdGl2ZU51bWJlciggZWxlbSwgdmFsdWUsIHN1YnRyYWN0ICk7CgkJfQoJfTsKfSApOwoKalF1ZXJ5LmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBhZGRHZXRIb29rSWYoIHN1cHBvcnQucmVsaWFibGVNYXJnaW5MZWZ0LAoJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCWlmICggY29tcHV0ZWQgKSB7CgkJCXJldHVybiAoIHBhcnNlRmxvYXQoIGN1ckNTUyggZWxlbSwgIm1hcmdpbkxlZnQiICkgKSB8fAoJCQkJZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0KCQkJCQlzd2FwKCBlbGVtLCB7IG1hcmdpbkxlZnQ6IDAgfSwgZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7CgkJCQkJfSApCgkJCQkpICsgInB4IjsKCQl9Cgl9Cik7CgovLyBUaGVzZSBob29rcyBhcmUgdXNlZCBieSBhbmltYXRlIHRvIGV4cGFuZCBwcm9wZXJ0aWVzCmpRdWVyeS5lYWNoKCB7CgltYXJnaW46ICIiLAoJcGFkZGluZzogIiIsCglib3JkZXI6ICJXaWR0aCIKfSwgZnVuY3Rpb24oIHByZWZpeCwgc3VmZml4ICkgewoJalF1ZXJ5LmNzc0hvb2tzWyBwcmVmaXggKyBzdWZmaXggXSA9IHsKCQlleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIGkgPSAwLAoJCQkJZXhwYW5kZWQgPSB7fSwKCgkJCQkvLyBBc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKCQkJCXBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCAiICIgKSA6IFsgdmFsdWUgXTsKCgkJCWZvciAoIDsgaSA8IDQ7IGkrKyApIHsKCQkJCWV4cGFuZGVkWyBwcmVmaXggKyBjc3NFeHBhbmRbIGkgXSArIHN1ZmZpeCBdID0KCQkJCQlwYXJ0c1sgaSBdIHx8IHBhcnRzWyBpIC0gMiBdIHx8IHBhcnRzWyAwIF07CgkJCX0KCgkJCXJldHVybiBleHBhbmRlZDsKCQl9Cgl9OwoKCWlmICggcHJlZml4ICE9PSAibWFyZ2luIiApIHsKCQlqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwoJfQp9ICk7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJCXZhciBzdHlsZXMsIGxlbiwKCQkJCW1hcCA9IHt9LAoJCQkJaSA9IDA7CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIG5hbWUgKSApIHsKCQkJCXN0eWxlcyA9IGdldFN0eWxlcyggZWxlbSApOwoJCQkJbGVuID0gbmFtZS5sZW5ndGg7CgoJCQkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkJbWFwWyBuYW1lWyBpIF0gXSA9IGpRdWVyeS5jc3MoIGVsZW0sIG5hbWVbIGkgXSwgZmFsc2UsIHN0eWxlcyApOwoJCQkJfQoKCQkJCXJldHVybiBtYXA7CgkJCX0KCgkJCXJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8KCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSwgdmFsdWUgKSA6CgkJCQlqUXVlcnkuY3NzKCBlbGVtLCBuYW1lICk7CgkJfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9Cn0gKTsKCgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCBqUXVlcnkuZWFzaW5nLl9kZWZhdWx0OwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKAoJCQkJcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCgkJCSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CgkJfQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJLy8gVXNlIGEgcHJvcGVydHkgb24gdGhlIGVsZW1lbnQgZGlyZWN0bHkgd2hlbiBpdCBpcyBub3QgYSBET00gZWxlbWVudCwKCQkJLy8gb3Igd2hlbiB0aGVyZSBpcyBubyBtYXRjaGluZyBzdHlsZSBwcm9wZXJ0eSB0aGF0IGV4aXN0cy4KCQkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICE9PSAxIHx8CgkJCQl0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJiB0d2Vlbi5lbGVtLnN0eWxlWyB0d2Vlbi5wcm9wIF0gPT0gbnVsbCApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIFBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzLgoJCQkvLyBTaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQ7CgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzLWlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOwoKCQkJLy8gRW1wdHkgc3RyaW5ncywgbnVsbCwgdW5kZWZpbmVkIGFuZCAiYXV0byIgYXJlIGNvbnZlcnRlZCB0byAwLgoJCQlyZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKCB0d2VlbiApIHsKCgkJCS8vIFVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0LgoJCQkvLyBVc2UgY3NzSG9vayBpZiBpdHMgdGhlcmUuCgkJCS8vIFVzZSAuc3R5bGUgaWYgYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUuCgkJCWlmICggalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSApIHsKCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0ubm9kZVR5cGUgPT09IDEgJiYKCQkJCSggdHdlZW4uZWxlbS5zdHlsZVsgalF1ZXJ5LmNzc1Byb3BzWyB0d2Vlbi5wcm9wIF0gXSAhPSBudWxsIHx8CgkJCQkJalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCApOwoJCQl9IGVsc2UgewoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCQl9CgkJfQoJfQp9OwoKLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKLy8gUGFuaWMgYmFzZWQgYXBwcm9hY2ggdG8gc2V0dGluZyB0aGluZ3Mgb24gZGlzY29ubmVjdGVkIG5vZGVzClR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCWlmICggdHdlZW4uZWxlbS5ub2RlVHlwZSAmJiB0d2Vlbi5lbGVtLnBhcmVudE5vZGUgKSB7CgkJCXR3ZWVuLmVsZW1bIHR3ZWVuLnByb3AgXSA9IHR3ZWVuLm5vdzsKCQl9Cgl9Cn07CgpqUXVlcnkuZWFzaW5nID0gewoJbGluZWFyOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcDsKCX0sCglzd2luZzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDAuNSAtIE1hdGguY29zKCBwICogTWF0aC5QSSApIC8gMjsKCX0sCglfZGVmYXVsdDogInN3aW5nIgp9OwoKalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CgovLyBCYWNrIGNvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludApqUXVlcnkuZnguc3RlcCA9IHt9OwoKCgoKdmFyCglmeE5vdywgaW5Qcm9ncmVzcywKCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAoJcnJ1biA9IC9xdWV1ZUhvb2tzJC87CgpmdW5jdGlvbiBzY2hlZHVsZSgpIHsKCWlmICggaW5Qcm9ncmVzcyApIHsKCQlpZiAoIGRvY3VtZW50LmhpZGRlbiA9PT0gZmFsc2UgJiYgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSApIHsKCQkJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSggc2NoZWR1bGUgKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuc2V0VGltZW91dCggc2NoZWR1bGUsIGpRdWVyeS5meC5pbnRlcnZhbCApOwoJCX0KCgkJalF1ZXJ5LmZ4LnRpY2soKTsKCX0KfQoKLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQpmdW5jdGlvbiBjcmVhdGVGeE5vdygpIHsKCXdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlmeE5vdyA9IHVuZGVmaW5lZDsKCX0gKTsKCXJldHVybiAoIGZ4Tm93ID0gRGF0ZS5ub3coKSApOwp9CgovLyBHZW5lcmF0ZSBwYXJhbWV0ZXJzIHRvIGNyZWF0ZSBhIHN0YW5kYXJkIGFuaW1hdGlvbgpmdW5jdGlvbiBnZW5GeCggdHlwZSwgaW5jbHVkZVdpZHRoICkgewoJdmFyIHdoaWNoLAoJCWkgPSAwLAoJCWF0dHJzID0geyBoZWlnaHQ6IHR5cGUgfTsKCgkvLyBJZiB3ZSBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDEgdG8gZG8gYWxsIGNzc0V4cGFuZCB2YWx1ZXMsCgkvLyBvdGhlcndpc2Ugc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodAoJaW5jbHVkZVdpZHRoID0gaW5jbHVkZVdpZHRoID8gMSA6IDA7Cglmb3IgKCA7IGkgPCA0OyBpICs9IDIgLSBpbmNsdWRlV2lkdGggKSB7CgkJd2hpY2ggPSBjc3NFeHBhbmRbIGkgXTsKCQlhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwoJfQoKCWlmICggaW5jbHVkZVdpZHRoICkgewoJCWF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7Cgl9CgoJcmV0dXJuIGF0dHJzOwp9CgpmdW5jdGlvbiBjcmVhdGVUd2VlbiggdmFsdWUsIHByb3AsIGFuaW1hdGlvbiApIHsKCXZhciB0d2VlbiwKCQljb2xsZWN0aW9uID0gKCBBbmltYXRpb24udHdlZW5lcnNbIHByb3AgXSB8fCBbXSApLmNvbmNhdCggQW5pbWF0aW9uLnR3ZWVuZXJzWyAiKiIgXSApLAoJCWluZGV4ID0gMCwKCQlsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJaWYgKCAoIHR3ZWVuID0gY29sbGVjdGlvblsgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIHByb3AsIHZhbHVlICkgKSApIHsKCgkJCS8vIFdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CgkJCXJldHVybiB0d2VlbjsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGRlZmF1bHRQcmVmaWx0ZXIoIGVsZW0sIHByb3BzLCBvcHRzICkgewoJdmFyIHByb3AsIHZhbHVlLCB0b2dnbGUsIGhvb2tzLCBvbGRmaXJlLCBwcm9wVHdlZW4sIHJlc3RvcmVEaXNwbGF5LCBkaXNwbGF5LAoJCWlzQm94ID0gIndpZHRoIiBpbiBwcm9wcyB8fCAiaGVpZ2h0IiBpbiBwcm9wcywKCQlhbmltID0gdGhpcywKCQlvcmlnID0ge30sCgkJc3R5bGUgPSBlbGVtLnN0eWxlLAoJCWhpZGRlbiA9IGVsZW0ubm9kZVR5cGUgJiYgaXNIaWRkZW5XaXRoaW5UcmVlKCBlbGVtICksCgkJZGF0YVNob3cgPSBkYXRhUHJpdi5nZXQoIGVsZW0sICJmeHNob3ciICk7CgoJLy8gUXVldWUtc2tpcHBpbmcgYW5pbWF0aW9ucyBoaWphY2sgdGhlIGZ4IGhvb2tzCglpZiAoICFvcHRzLnF1ZXVlICkgewoJCWhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKCBlbGVtLCAiZngiICk7CgkJaWYgKCBob29rcy51bnF1ZXVlZCA9PSBudWxsICkgewoJCQlob29rcy51bnF1ZXVlZCA9IDA7CgkJCW9sZGZpcmUgPSBob29rcy5lbXB0eS5maXJlOwoJCQlob29rcy5lbXB0eS5maXJlID0gZnVuY3Rpb24oKSB7CgkJCQlpZiAoICFob29rcy51bnF1ZXVlZCApIHsKCQkJCQlvbGRmaXJlKCk7CgkJCQl9CgkJCX07CgkJfQoJCWhvb2tzLnVucXVldWVkKys7CgoJCWFuaW0uYWx3YXlzKCBmdW5jdGlvbigpIHsKCgkJCS8vIEVuc3VyZSB0aGUgY29tcGxldGUgaGFuZGxlciBpcyBjYWxsZWQgYmVmb3JlIHRoaXMgY29tcGxldGVzCgkJCWFuaW0uYWx3YXlzKCBmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9ICk7CgkJfSApOwoJfQoKCS8vIERldGVjdCBzaG93L2hpZGUgYW5pbWF0aW9ucwoJZm9yICggcHJvcCBpbiBwcm9wcyApIHsKCQl2YWx1ZSA9IHByb3BzWyBwcm9wIF07CgkJaWYgKCByZnh0eXBlcy50ZXN0KCB2YWx1ZSApICkgewoJCQlkZWxldGUgcHJvcHNbIHByb3AgXTsKCQkJdG9nZ2xlID0gdG9nZ2xlIHx8IHZhbHVlID09PSAidG9nZ2xlIjsKCQkJaWYgKCB2YWx1ZSA9PT0gKCBoaWRkZW4gPyAiaGlkZSIgOiAic2hvdyIgKSApIHsKCgkJCQkvLyBQcmV0ZW5kIHRvIGJlIGhpZGRlbiBpZiB0aGlzIGlzIGEgInNob3ciIGFuZAoJCQkJLy8gdGhlcmUgaXMgc3RpbGwgZGF0YSBmcm9tIGEgc3RvcHBlZCBzaG93L2hpZGUKCQkJCWlmICggdmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaGlkZGVuID0gdHJ1ZTsKCgkJCQkvLyBJZ25vcmUgYWxsIG90aGVyIG5vLW9wIHNob3cvaGlkZSBkYXRhCgkJCQl9IGVsc2UgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQl9CgkJCW9yaWdbIHByb3AgXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93WyBwcm9wIF0gfHwgalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wICk7CgkJfQoJfQoKCS8vIEJhaWwgb3V0IGlmIHRoaXMgaXMgYSBuby1vcCBsaWtlIC5oaWRlKCkuaGlkZSgpCglwcm9wVHdlZW4gPSAhalF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3BzICk7CglpZiAoICFwcm9wVHdlZW4gJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gUmVzdHJpY3QgIm92ZXJmbG93IiBhbmQgImRpc3BsYXkiIHN0eWxlcyBkdXJpbmcgYm94IGFuaW1hdGlvbnMKCWlmICggaXNCb3ggJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCgkJLy8gU3VwcG9ydDogSUUgPD05IC0gMTEsIEVkZ2UgMTIgLSAxNQoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QgaW5mZXIgdGhlIHNob3J0aGFuZAoJCS8vIGZyb20gaWRlbnRpY2FsbHktdmFsdWVkIG92ZXJmbG93WCBhbmQgb3ZlcmZsb3dZIGFuZCBFZGdlIGp1c3QgbWlycm9ycwoJCS8vIHRoZSBvdmVyZmxvd1ggdmFsdWUgdGhlcmUuCgkJb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgoJCS8vIElkZW50aWZ5IGEgZGlzcGxheSB0eXBlLCBwcmVmZXJyaW5nIG9sZCBzaG93L2hpZGUgZGF0YSBvdmVyIHRoZSBDU1MgY2FzY2FkZQoJCXJlc3RvcmVEaXNwbGF5ID0gZGF0YVNob3cgJiYgZGF0YVNob3cuZGlzcGxheTsKCQlpZiAoIHJlc3RvcmVEaXNwbGF5ID09IG51bGwgKSB7CgkJCXJlc3RvcmVEaXNwbGF5ID0gZGF0YVByaXYuZ2V0KCBlbGVtLCAiZGlzcGxheSIgKTsKCQl9CgkJZGlzcGxheSA9IGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApOwoJCWlmICggZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQlpZiAoIHJlc3RvcmVEaXNwbGF5ICkgewoJCQkJZGlzcGxheSA9IHJlc3RvcmVEaXNwbGF5OwoJCQl9IGVsc2UgewoKCQkJCS8vIEdldCBub25lbXB0eSB2YWx1ZShzKSBieSB0ZW1wb3JhcmlseSBmb3JjaW5nIHZpc2liaWxpdHkKCQkJCXNob3dIaWRlKCBbIGVsZW0gXSwgdHJ1ZSApOwoJCQkJcmVzdG9yZURpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXkgfHwgcmVzdG9yZURpc3BsYXk7CgkJCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICk7CgkJCQlzaG93SGlkZSggWyBlbGVtIF0gKTsKCQkJfQoJCX0KCgkJLy8gQW5pbWF0ZSBpbmxpbmUgZWxlbWVudHMgYXMgaW5saW5lLWJsb2NrCgkJaWYgKCBkaXNwbGF5ID09PSAiaW5saW5lIiB8fCBkaXNwbGF5ID09PSAiaW5saW5lLWJsb2NrIiAmJiByZXN0b3JlRGlzcGxheSAhPSBudWxsICkgewoJCQlpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJmbG9hdCIgKSA9PT0gIm5vbmUiICkgewoKCQkJCS8vIFJlc3RvcmUgdGhlIG9yaWdpbmFsIGRpc3BsYXkgdmFsdWUgYXQgdGhlIGVuZCBvZiBwdXJlIHNob3cvaGlkZSBhbmltYXRpb25zCgkJCQlpZiAoICFwcm9wVHdlZW4gKSB7CgkJCQkJYW5pbS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCQkJc3R5bGUuZGlzcGxheSA9IHJlc3RvcmVEaXNwbGF5OwoJCQkJCX0gKTsKCQkJCQlpZiAoIHJlc3RvcmVEaXNwbGF5ID09IG51bGwgKSB7CgkJCQkJCWRpc3BsYXkgPSBzdHlsZS5kaXNwbGF5OwoJCQkJCQlyZXN0b3JlRGlzcGxheSA9IGRpc3BsYXkgPT09ICJub25lIiA/ICIiIDogZGlzcGxheTsKCQkJCQl9CgkJCQl9CgkJCQlzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CgkJCX0KCQl9Cgl9CgoJaWYgKCBvcHRzLm92ZXJmbG93ICkgewoJCXN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJYW5pbS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQlzdHlsZS5vdmVyZmxvdyA9IG9wdHMub3ZlcmZsb3dbIDAgXTsKCQkJc3R5bGUub3ZlcmZsb3dYID0gb3B0cy5vdmVyZmxvd1sgMSBdOwoJCQlzdHlsZS5vdmVyZmxvd1kgPSBvcHRzLm92ZXJmbG93WyAyIF07CgkJfSApOwoJfQoKCS8vIEltcGxlbWVudCBzaG93L2hpZGUgYW5pbWF0aW9ucwoJcHJvcFR3ZWVuID0gZmFsc2U7Cglmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgoJCS8vIEdlbmVyYWwgc2hvdy9oaWRlIHNldHVwIGZvciB0aGlzIGVsZW1lbnQgYW5pbWF0aW9uCgkJaWYgKCAhcHJvcFR3ZWVuICkgewoJCQlpZiAoIGRhdGFTaG93ICkgewoJCQkJaWYgKCAiaGlkZGVuIiBpbiBkYXRhU2hvdyApIHsKCQkJCQloaWRkZW4gPSBkYXRhU2hvdy5oaWRkZW47CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlkYXRhU2hvdyA9IGRhdGFQcml2LmFjY2VzcyggZWxlbSwgImZ4c2hvdyIsIHsgZGlzcGxheTogcmVzdG9yZURpc3BsYXkgfSApOwoJCQl9CgoJCQkvLyBTdG9yZSBoaWRkZW4vdmlzaWJsZSBmb3IgdG9nZ2xlIHNvIGAuc3RvcCgpLnRvZ2dsZSgpYCAicmV2ZXJzZXMiCgkJCWlmICggdG9nZ2xlICkgewoJCQkJZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKCQkJfQoKCQkJLy8gU2hvdyBlbGVtZW50cyBiZWZvcmUgYW5pbWF0aW5nIHRoZW0KCQkJaWYgKCBoaWRkZW4gKSB7CgkJCQlzaG93SGlkZSggWyBlbGVtIF0sIHRydWUgKTsKCQkJfQoKCQkJLyogZXNsaW50LWRpc2FibGUgbm8tbG9vcC1mdW5jICovCgoJCQlhbmltLmRvbmUoIGZ1bmN0aW9uKCkgewoKCQkJLyogZXNsaW50LWVuYWJsZSBuby1sb29wLWZ1bmMgKi8KCgkJCQkvLyBUaGUgZmluYWwgc3RlcCBvZiBhICJoaWRlIiBhbmltYXRpb24gaXMgYWN0dWFsbHkgaGlkaW5nIHRoZSBlbGVtZW50CgkJCQlpZiAoICFoaWRkZW4gKSB7CgkJCQkJc2hvd0hpZGUoIFsgZWxlbSBdICk7CgkJCQl9CgkJCQlkYXRhUHJpdi5yZW1vdmUoIGVsZW0sICJmeHNob3ciICk7CgkJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBwcm9wLCBvcmlnWyBwcm9wIF0gKTsKCQkJCX0KCQkJfSApOwoJCX0KCgkJLy8gUGVyLXByb3BlcnR5IHNldHVwCgkJcHJvcFR3ZWVuID0gY3JlYXRlVHdlZW4oIGhpZGRlbiA/IGRhdGFTaG93WyBwcm9wIF0gOiAwLCBwcm9wLCBhbmltICk7CgkJaWYgKCAhKCBwcm9wIGluIGRhdGFTaG93ICkgKSB7CgkJCWRhdGFTaG93WyBwcm9wIF0gPSBwcm9wVHdlZW4uc3RhcnQ7CgkJCWlmICggaGlkZGVuICkgewoJCQkJcHJvcFR3ZWVuLmVuZCA9IHByb3BUd2Vlbi5zdGFydDsKCQkJCXByb3BUd2Vlbi5zdGFydCA9IDA7CgkJCX0KCQl9Cgl9Cn0KCmZ1bmN0aW9uIHByb3BGaWx0ZXIoIHByb3BzLCBzcGVjaWFsRWFzaW5nICkgewoJdmFyIGluZGV4LCBuYW1lLCBlYXNpbmcsIHZhbHVlLCBob29rczsKCgkvLyBjYW1lbENhc2UsIHNwZWNpYWxFYXNpbmcgYW5kIGV4cGFuZCBjc3NIb29rIHBhc3MKCWZvciAoIGluZGV4IGluIHByb3BzICkgewoJCW5hbWUgPSBjYW1lbENhc2UoIGluZGV4ICk7CgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOwoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCBBcnJheS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQllYXNpbmcgPSB2YWx1ZVsgMSBdOwoJCQl2YWx1ZSA9IHByb3BzWyBpbmRleCBdID0gdmFsdWVbIDAgXTsKCQl9CgoJCWlmICggaW5kZXggIT09IG5hbWUgKSB7CgkJCXByb3BzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJZGVsZXRlIHByb3BzWyBpbmRleCBdOwoJCX0KCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXTsKCQlpZiAoIGhvb2tzICYmICJleHBhbmQiIGluIGhvb2tzICkgewoJCQl2YWx1ZSA9IGhvb2tzLmV4cGFuZCggdmFsdWUgKTsKCQkJZGVsZXRlIHByb3BzWyBuYW1lIF07CgoJCQkvLyBOb3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29uJ3Qgb3ZlcndyaXRlIGV4aXN0aW5nIGtleXMuCgkJCS8vIFJldXNpbmcgJ2luZGV4JyBiZWNhdXNlIHdlIGhhdmUgdGhlIGNvcnJlY3QgIm5hbWUiCgkJCWZvciAoIGluZGV4IGluIHZhbHVlICkgewoJCQkJaWYgKCAhKCBpbmRleCBpbiBwcm9wcyApICkgewoJCQkJCXByb3BzWyBpbmRleCBdID0gdmFsdWVbIGluZGV4IF07CgkJCQkJc3BlY2lhbEVhc2luZ1sgaW5kZXggXSA9IGVhc2luZzsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXNwZWNpYWxFYXNpbmdbIG5hbWUgXSA9IGVhc2luZzsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKCXZhciByZXN1bHQsCgkJc3RvcHBlZCwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gQW5pbWF0aW9uLnByZWZpbHRlcnMubGVuZ3RoLAoJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKCBmdW5jdGlvbigpIHsKCgkJCS8vIERvbid0IG1hdGNoIGVsZW0gaW4gdGhlIDphbmltYXRlZCBzZWxlY3RvcgoJCQlkZWxldGUgdGljay5lbGVtOwoJCX0gKSwKCQl0aWNrID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc3RvcHBlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoKCQkJCS8vIFN1cHBvcnQ6IEFuZHJvaWQgMi4zIG9ubHkKCQkJCS8vIEFyY2hhaWMgY3Jhc2ggYnVnIHdvbid0IGFsbG93IHVzIHRvIHVzZSBgMSAtICggMC41IHx8IDAgKWAgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQkJCWFuaW1hdGlvbi50d2VlbnNbIGluZGV4IF0ucnVuKCBwZXJjZW50ICk7CgkJCX0KCgkJCWRlZmVycmVkLm5vdGlmeVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBwZXJjZW50LCByZW1haW5pbmcgXSApOwoKCQkJLy8gSWYgdGhlcmUncyBtb3JlIHRvIGRvLCB5aWVsZAoJCQlpZiAoIHBlcmNlbnQgPCAxICYmIGxlbmd0aCApIHsKCQkJCXJldHVybiByZW1haW5pbmc7CgkJCX0KCgkJCS8vIElmIHRoaXMgd2FzIGFuIGVtcHR5IGFuaW1hdGlvbiwgc3ludGhlc2l6ZSBhIGZpbmFsIHByb2dyZXNzIG5vdGlmaWNhdGlvbgoJCQlpZiAoICFsZW5ndGggKSB7CgkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgMSwgMCBdICk7CgkJCX0KCgkJCS8vIFJlc29sdmUgdGhlIGFuaW1hdGlvbiBhbmQgcmVwb3J0IGl0cyBjb25jbHVzaW9uCgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiBdICk7CgkJCXJldHVybiBmYWxzZTsKCQl9LAoJCWFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoIHsKCQkJZWxlbTogZWxlbSwKCQkJcHJvcHM6IGpRdWVyeS5leHRlbmQoIHt9LCBwcm9wZXJ0aWVzICksCgkJCW9wdHM6IGpRdWVyeS5leHRlbmQoIHRydWUsIHsKCQkJCXNwZWNpYWxFYXNpbmc6IHt9LAoJCQkJZWFzaW5nOiBqUXVlcnkuZWFzaW5nLl9kZWZhdWx0CgkJCX0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCgkJCQkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBlbmQsIHdlIHdhbnQgdG8gcnVuIGFsbCB0aGUgdHdlZW5zCgkJCQkJLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0CgkJCQkJbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKCQkJCWlmICggc3RvcHBlZCApIHsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJCXN0b3BwZWQgPSB0cnVlOwoJCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIFJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWU7IG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQubm90aWZ5V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIDEsIDAgXSApOwoJCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgZ290b0VuZCBdICk7CgkJCQl9IGVsc2UgewoJCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJfSApLAoJCXByb3BzID0gYW5pbWF0aW9uLnByb3BzOwoKCXByb3BGaWx0ZXIoIHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nICk7CgoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlyZXN1bHQgPSBBbmltYXRpb24ucHJlZmlsdGVyc1sgaW5kZXggXS5jYWxsKCBhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyApOwoJCWlmICggcmVzdWx0ICkgewoJCQlpZiAoIGlzRnVuY3Rpb24oIHJlc3VsdC5zdG9wICkgKSB7CgkJCQlqUXVlcnkuX3F1ZXVlSG9va3MoIGFuaW1hdGlvbi5lbGVtLCBhbmltYXRpb24ub3B0cy5xdWV1ZSApLnN0b3AgPQoJCQkJCXJlc3VsdC5zdG9wLmJpbmQoIHJlc3VsdCApOwoJCQl9CgkJCXJldHVybiByZXN1bHQ7CgkJfQoJfQoKCWpRdWVyeS5tYXAoIHByb3BzLCBjcmVhdGVUd2VlbiwgYW5pbWF0aW9uICk7CgoJaWYgKCBpc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCS8vIEF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCglhbmltYXRpb24KCQkucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKCglqUXVlcnkuZngudGltZXIoCgkJalF1ZXJ5LmV4dGVuZCggdGljaywgewoJCQllbGVtOiBlbGVtLAoJCQlhbmltOiBhbmltYXRpb24sCgkJCXF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZQoJCX0gKQoJKTsKCglyZXR1cm4gYW5pbWF0aW9uOwp9CgpqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZCggQW5pbWF0aW9uLCB7CgoJdHdlZW5lcnM6IHsKCQkiKiI6IFsgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCQl2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKCBwcm9wLCB2YWx1ZSApOwoJCQlhZGp1c3RDU1MoIHR3ZWVuLmVsZW0sIHByb3AsIHJjc3NOdW0uZXhlYyggdmFsdWUgKSwgdHdlZW4gKTsKCQkJcmV0dXJuIHR3ZWVuOwoJCX0gXQoJfSwKCgl0d2VlbmVyOiBmdW5jdGlvbiggcHJvcHMsIGNhbGxiYWNrICkgewoJCWlmICggaXNGdW5jdGlvbiggcHJvcHMgKSApIHsKCQkJY2FsbGJhY2sgPSBwcm9wczsKCQkJcHJvcHMgPSBbICIqIiBdOwoJCX0gZWxzZSB7CgkJCXByb3BzID0gcHJvcHMubWF0Y2goIHJub3RodG1sd2hpdGUgKTsKCQl9CgoJCXZhciBwcm9wLAoJCQlpbmRleCA9IDAsCgkJCWxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCgkJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOwoJCQlBbmltYXRpb24udHdlZW5lcnNbIHByb3AgXSA9IEFuaW1hdGlvbi50d2VlbmVyc1sgcHJvcCBdIHx8IFtdOwoJCQlBbmltYXRpb24udHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0KCX0sCgoJcHJlZmlsdGVyczogWyBkZWZhdWx0UHJlZmlsdGVyIF0sCgoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7CgkJaWYgKCBwcmVwZW5kICkgewoJCQlBbmltYXRpb24ucHJlZmlsdGVycy51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCUFuaW1hdGlvbi5wcmVmaWx0ZXJzLnB1c2goIGNhbGxiYWNrICk7CgkJfQoJfQp9ICk7CgpqUXVlcnkuc3BlZWQgPSBmdW5jdGlvbiggc3BlZWQsIGVhc2luZywgZm4gKSB7Cgl2YXIgb3B0ID0gc3BlZWQgJiYgdHlwZW9mIHNwZWVkID09PSAib2JqZWN0IiA/IGpRdWVyeS5leHRlbmQoIHt9LCBzcGVlZCApIDogewoJCWNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8CgkJCWlzRnVuY3Rpb24oIHNwZWVkICkgJiYgc3BlZWQsCgkJZHVyYXRpb246IHNwZWVkLAoJCWVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCS8vIEdvIHRvIHRoZSBlbmQgc3RhdGUgaWYgZnggYXJlIG9mZgoJaWYgKCBqUXVlcnkuZngub2ZmICkgewoJCW9wdC5kdXJhdGlvbiA9IDA7CgoJfSBlbHNlIHsKCQlpZiAoIHR5cGVvZiBvcHQuZHVyYXRpb24gIT09ICJudW1iZXIiICkgewoJCQlpZiAoIG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzICkgewoJCQkJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF07CgoJCQl9IGVsc2UgewoJCQkJb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKCQkJfQoJCX0KCX0KCgkvLyBOb3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCglpZiAoIG9wdC5xdWV1ZSA9PSBudWxsIHx8IG9wdC5xdWV1ZSA9PT0gdHJ1ZSApIHsKCQlvcHQucXVldWUgPSAiZngiOwoJfQoKCS8vIFF1ZXVlaW5nCglvcHQub2xkID0gb3B0LmNvbXBsZXRlOwoKCW9wdC5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmICggaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJZmFkZVRvOiBmdW5jdGlvbiggc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrICkgewoKCQkvLyBTaG93IGFueSBoaWRkZW4gZWxlbWVudHMgYWZ0ZXIgc2V0dGluZyBvcGFjaXR5IHRvIDAKCQlyZXR1cm4gdGhpcy5maWx0ZXIoIGlzSGlkZGVuV2l0aGluVHJlZSApLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpCgoJCQkvLyBBbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKCQkJLmVuZCgpLmFuaW1hdGUoIHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoKCQkJCS8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CgkJCQl2YXIgYW5pbSA9IEFuaW1hdGlvbiggdGhpcywgalF1ZXJ5LmV4dGVuZCgge30sIHByb3AgKSwgb3B0YWxsICk7CgoJCQkJLy8gRW1wdHkgYW5pbWF0aW9ucywgb3IgZmluaXNoaW5nIHJlc29sdmVzIGltbWVkaWF0ZWx5CgkJCQlpZiAoIGVtcHR5IHx8IGRhdGFQcml2LmdldCggdGhpcywgImZpbmlzaCIgKSApIHsKCQkJCQlhbmltLnN0b3AoIHRydWUgKTsKCQkJCX0KCQkJfTsKCQkJZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZGVxdWV1ZSA9IHRydWUsCgkJCQlpbmRleCA9IHR5cGUgIT0gbnVsbCAmJiB0eXBlICsgInF1ZXVlSG9va3MiLAoJCQkJdGltZXJzID0galF1ZXJ5LnRpbWVycywKCQkJCWRhdGEgPSBkYXRhUHJpdi5nZXQoIHRoaXMgKTsKCgkJCWlmICggaW5kZXggKSB7CgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewoJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaW5kZXggaW4gZGF0YSApIHsKCQkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJgoJCQkJCSggdHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSApICkgewoKCQkJCQl0aW1lcnNbIGluZGV4IF0uYW5pbS5zdG9wKCBnb3RvRW5kICk7CgkJCQkJZGVxdWV1ZSA9IGZhbHNlOwoJCQkJCXRpbWVycy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQl9CgkJCX0KCgkJCS8vIFN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQuCgkJCS8vIFRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2gKCQkJLy8gd2lsbCBkZXF1ZXVlIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kLgoJCQlpZiAoIGRlcXVldWUgfHwgIWdvdG9FbmQgKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgdHlwZSApOwoJCQl9CgkJfSApOwoJfSwKCWZpbmlzaDogZnVuY3Rpb24oIHR5cGUgKSB7CgkJaWYgKCB0eXBlICE9PSBmYWxzZSApIHsKCQkJdHlwZSA9IHR5cGUgfHwgImZ4IjsKCQl9CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCWRhdGEgPSBkYXRhUHJpdi5nZXQoIHRoaXMgKSwKCQkJCXF1ZXVlID0gZGF0YVsgdHlwZSArICJxdWV1ZSIgXSwKCQkJCWhvb2tzID0gZGF0YVsgdHlwZSArICJxdWV1ZUhvb2tzIiBdLAoJCQkJdGltZXJzID0galF1ZXJ5LnRpbWVycywKCQkJCWxlbmd0aCA9IHF1ZXVlID8gcXVldWUubGVuZ3RoIDogMDsKCgkJCS8vIEVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGEKCQkJZGF0YS5maW5pc2ggPSB0cnVlOwoKCQkJLy8gRW1wdHkgdGhlIHF1ZXVlIGZpcnN0CgkJCWpRdWVyeS5xdWV1ZSggdGhpcywgdHlwZSwgW10gKTsKCgkJCWlmICggaG9va3MgJiYgaG9va3Muc3RvcCApIHsKCQkJCWhvb2tzLnN0b3AuY2FsbCggdGhpcywgdHJ1ZSApOwoJCQl9CgoJCQkvLyBMb29rIGZvciBhbnkgYWN0aXZlIGFuaW1hdGlvbnMsIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbIGluZGV4IF0ucXVldWUgPT09IHR5cGUgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggdHJ1ZSApOwoJCQkJCXRpbWVycy5zcGxpY2UoIGluZGV4LCAxICk7CgkJCQl9CgkJCX0KCgkJCS8vIExvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCgkJCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJCQlpZiAoIHF1ZXVlWyBpbmRleCBdICYmIHF1ZXVlWyBpbmRleCBdLmZpbmlzaCApIHsKCQkJCQlxdWV1ZVsgaW5kZXggXS5maW5pc2guY2FsbCggdGhpcyApOwoJCQkJfQoJCQl9CgoJCQkvLyBUdXJuIG9mZiBmaW5pc2hpbmcgZmxhZwoJCQlkZWxldGUgZGF0YS5maW5pc2g7CgkJfSApOwoJfQp9ICk7CgpqUXVlcnkuZWFjaCggWyAidG9nZ2xlIiwgInNob3ciLCAiaGlkZSIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7Cgl2YXIgY3NzRm4gPSBqUXVlcnkuZm5bIG5hbWUgXTsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gImJvb2xlYW4iID8KCQkJY3NzRm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApIDoKCQkJdGhpcy5hbmltYXRlKCBnZW5GeCggbmFtZSwgdHJ1ZSApLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfTsKfSApOwoKLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwpqUXVlcnkuZWFjaCggewoJc2xpZGVEb3duOiBnZW5GeCggInNob3ciICksCglzbGlkZVVwOiBnZW5GeCggImhpZGUiICksCglzbGlkZVRvZ2dsZTogZ2VuRngoICJ0b2dnbGUiICksCglmYWRlSW46IHsgb3BhY2l0eTogInNob3ciIH0sCglmYWRlT3V0OiB7IG9wYWNpdHk6ICJoaWRlIiB9LAoJZmFkZVRvZ2dsZTogeyBvcGFjaXR5OiAidG9nZ2xlIiB9Cn0sIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCXJldHVybiB0aGlzLmFuaW1hdGUoIHByb3BzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApOwoJfTsKfSApOwoKalF1ZXJ5LnRpbWVycyA9IFtdOwpqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uKCkgewoJdmFyIHRpbWVyLAoJCWkgPSAwLAoJCXRpbWVycyA9IGpRdWVyeS50aW1lcnM7CgoJZnhOb3cgPSBEYXRlLm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoKCQkvLyBSdW4gdGhlIHRpbWVyIGFuZCBzYWZlbHkgcmVtb3ZlIGl0IHdoZW4gZG9uZSAoYWxsb3dpbmcgZm9yIGV4dGVybmFsIHJlbW92YWwpCgkJaWYgKCAhdGltZXIoKSAmJiB0aW1lcnNbIGkgXSA9PT0gdGltZXIgKSB7CgkJCXRpbWVycy5zcGxpY2UoIGktLSwgMSApOwoJCX0KCX0KCglpZiAoICF0aW1lcnMubGVuZ3RoICkgewoJCWpRdWVyeS5meC5zdG9wKCk7Cgl9CglmeE5vdyA9IHVuZGVmaW5lZDsKfTsKCmpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uKCB0aW1lciApIHsKCWpRdWVyeS50aW1lcnMucHVzaCggdGltZXIgKTsKCWpRdWVyeS5meC5zdGFydCgpOwp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CmpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uKCkgewoJaWYgKCBpblByb2dyZXNzICkgewoJCXJldHVybjsKCX0KCglpblByb2dyZXNzID0gdHJ1ZTsKCXNjaGVkdWxlKCk7Cn07CgpqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uKCkgewoJaW5Qcm9ncmVzcyA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewoJc2xvdzogNjAwLAoJZmFzdDogMjAwLAoKCS8vIERlZmF1bHQgc3BlZWQKCV9kZWZhdWx0OiA0MDAKfTsKCgovLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCi8vIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDEwMDMyNDAxNDc0Ny9odHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCmpRdWVyeS5mbi5kZWxheSA9IGZ1bmN0aW9uKCB0aW1lLCB0eXBlICkgewoJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUsIGZ1bmN0aW9uKCBuZXh0LCBob29rcyApIHsKCQl2YXIgdGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KCBuZXh0LCB0aW1lICk7CgkJaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJfTsKCX0gKTsKfTsKCgooIGZ1bmN0aW9uKCkgewoJdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImlucHV0IiApLAoJCXNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzZWxlY3QiICksCgkJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAib3B0aW9uIiApICk7CgoJaW5wdXQudHlwZSA9ICJjaGVja2JveCI7CgoJLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMyBvbmx5CgkvLyBEZWZhdWx0IHZhbHVlIGZvciBhIGNoZWNrYm94IHNob3VsZCBiZSAib24iCglzdXBwb3J0LmNoZWNrT24gPSBpbnB1dC52YWx1ZSAhPT0gIiI7CgoJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CgkvLyBNdXN0IGFjY2VzcyBzZWxlY3RlZEluZGV4IHRvIG1ha2UgZGVmYXVsdCBvcHRpb25zIHNlbGVjdAoJc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKCgkvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKCS8vIEFuIGlucHV0IGxvc2VzIGl0cyB2YWx1ZSBhZnRlciBiZWNvbWluZyBhIHJhZGlvCglpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKTsKCWlucHV0LnZhbHVlID0gInQiOwoJaW5wdXQudHlwZSA9ICJyYWRpbyI7CglzdXBwb3J0LnJhZGlvVmFsdWUgPSBpbnB1dC52YWx1ZSA9PT0gInQiOwp9ICkoKTsKCgp2YXIgYm9vbEhvb2ssCglhdHRySGFuZGxlID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZTsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCWF0dHI6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkucmVtb3ZlQXR0ciggdGhpcywgbmFtZSApOwoJCX0gKTsKCX0KfSApOwoKalF1ZXJ5LmV4dGVuZCggewoJYXR0cjogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLAoJCQluVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJCS8vIERvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKCQlpZiAoIG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAoJCWlmICggdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIGpRdWVyeS5wcm9wKCBlbGVtLCBuYW1lLCB2YWx1ZSApOwoJCX0KCgkJLy8gQXR0cmlidXRlIGhvb2tzIGFyZSBkZXRlcm1pbmVkIGJ5IHRoZSBsb3dlcmNhc2UgdmVyc2lvbgoJCS8vIEdyYWIgbmVjZXNzYXJ5IGhvb2sgaWYgb25lIGlzIGRlZmluZWQKCQlpZiAoIG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCQkJaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzWyBuYW1lLnRvTG93ZXJDYXNlKCkgXSB8fAoJCQkJKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QoIG5hbWUgKSA/IGJvb2xIb29rIDogdW5kZWZpbmVkICk7CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggdmFsdWUgPT09IG51bGwgKSB7CgkJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmCgkJCQkoIHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSApICE9PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgoJCQllbGVtLnNldEF0dHJpYnV0ZSggbmFtZSwgdmFsdWUgKyAiIiApOwoJCQlyZXR1cm4gdmFsdWU7CgkJfQoKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmICggcmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkgKSAhPT0gbnVsbCApIHsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXJldCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sIG5hbWUgKTsKCgkJLy8gTm9uLWV4aXN0ZW50IGF0dHJpYnV0ZXMgcmV0dXJuIG51bGwsIHdlIG5vcm1hbGl6ZSB0byB1bmRlZmluZWQKCQlyZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7Cgl9LAoKCWF0dHJIb29rczogewoJCXR5cGU6IHsKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQlpZiAoICFzdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICJyYWRpbyIgJiYKCQkJCQlub2RlTmFtZSggZWxlbSwgImlucHV0IiApICkgewoJCQkJCXZhciB2YWwgPSBlbGVtLnZhbHVlOwoJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAidHlwZSIsIHZhbHVlICk7CgkJCQkJaWYgKCB2YWwgKSB7CgkJCQkJCWVsZW0udmFsdWUgPSB2YWw7CgkJCQkJfQoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJcmVtb3ZlQXR0cjogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCXZhciBuYW1lLAoJCQlpID0gMCwKCgkJCS8vIEF0dHJpYnV0ZSBuYW1lcyBjYW4gY29udGFpbiBub24tSFRNTCB3aGl0ZXNwYWNlIGNoYXJhY3RlcnMKCQkJLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjYXR0cmlidXRlcy0yCgkJCWF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKCBybm90aHRtbHdoaXRlICk7CgoJCWlmICggYXR0ck5hbWVzICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCXdoaWxlICggKCBuYW1lID0gYXR0ck5hbWVzWyBpKysgXSApICkgewoJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIG5hbWUgKTsKCQkJfQoJCX0KCX0KfSApOwoKLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwpib29sSG9vayA9IHsKCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBuYW1lICkgewoJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lICk7CgkJfQoJCXJldHVybiBuYW1lOwoJfQp9OwoKalF1ZXJ5LmVhY2goIGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKCAvXHcrL2cgKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7Cgl2YXIgZ2V0dGVyID0gYXR0ckhhbmRsZVsgbmFtZSBdIHx8IGpRdWVyeS5maW5kLmF0dHI7CgoJYXR0ckhhbmRsZVsgbmFtZSBdID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCXZhciByZXQsIGhhbmRsZSwKCQkJbG93ZXJjYXNlTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCgkJaWYgKCAhaXNYTUwgKSB7CgoJCQkvLyBBdm9pZCBhbiBpbmZpbml0ZSBsb29wIGJ5IHRlbXBvcmFyaWx5IHJlbW92aW5nIHRoaXMgZnVuY3Rpb24gZnJvbSB0aGUgZ2V0dGVyCgkJCWhhbmRsZSA9IGF0dHJIYW5kbGVbIGxvd2VyY2FzZU5hbWUgXTsKCQkJYXR0ckhhbmRsZVsgbG93ZXJjYXNlTmFtZSBdID0gcmV0OwoJCQlyZXQgPSBnZXR0ZXIoIGVsZW0sIG5hbWUsIGlzWE1MICkgIT0gbnVsbCA/CgkJCQlsb3dlcmNhc2VOYW1lIDoKCQkJCW51bGw7CgkJCWF0dHJIYW5kbGVbIGxvd2VyY2FzZU5hbWUgXSA9IGhhbmRsZTsKCQl9CgkJcmV0dXJuIHJldDsKCX07Cn0gKTsKCgoKCnZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKCXJjbGlja2FibGUgPSAvXig/OmF8YXJlYSkkL2k7CgpqUXVlcnkuZm4uZXh0ZW5kKCB7Cglwcm9wOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJcmV0dXJuIGFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJZGVsZXRlIHRoaXNbIGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZSBdOwoJCX0gKTsKCX0KfSApOwoKalF1ZXJ5LmV4dGVuZCggewoJcHJvcDogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCXZhciByZXQsIGhvb2tzLAoJCQluVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgoJCS8vIERvbid0IGdldC9zZXQgcHJvcGVydGllcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKCQlpZiAoIG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCgkJCS8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKCQkJbmFtZSA9IGpRdWVyeS5wcm9wRml4WyBuYW1lIF0gfHwgbmFtZTsKCQkJaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzWyBuYW1lIF07CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYKCQkJCSggcmV0ID0gaG9va3Muc2V0KCBlbGVtLCB2YWx1ZSwgbmFtZSApICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgkJCX0KCgkJCXJldHVybiAoIGVsZW1bIG5hbWUgXSA9IHZhbHVlICk7CgkJfQoKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmICggcmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkgKSAhPT0gbnVsbCApIHsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXJldHVybiBlbGVtWyBuYW1lIF07Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCQkJLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQoJCQkJLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlCgkJCQkvLyBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKCQkJCS8vIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDE0MTExNjIzMzM0Ny9odHRwOi8vZmx1aWRwcm9qZWN0Lm9yZy9ibG9nLzIwMDgvMDEvMDkvZ2V0dGluZy1zZXR0aW5nLWFuZC1yZW1vdmluZy10YWJpbmRleC12YWx1ZXMtd2l0aC1qYXZhc2NyaXB0LwoJCQkJLy8gVXNlIHByb3BlciBhdHRyaWJ1dGUgcmV0cmlldmFsKCMxMjA3MikKCQkJCXZhciB0YWJpbmRleCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ0YWJpbmRleCIgKTsKCgkJCQlpZiAoIHRhYmluZGV4ICkgewoJCQkJCXJldHVybiBwYXJzZUludCggdGFiaW5kZXgsIDEwICk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCXJmb2N1c2FibGUudGVzdCggZWxlbS5ub2RlTmFtZSApIHx8CgkJCQkJcmNsaWNrYWJsZS50ZXN0KCBlbGVtLm5vZGVOYW1lICkgJiYKCQkJCQllbGVtLmhyZWYKCQkJCSkgewoJCQkJCXJldHVybiAwOwoJCQkJfQoKCQkJCXJldHVybiAtMTsKCQkJfQoJCX0KCX0sCgoJcHJvcEZpeDogewoJCSJmb3IiOiAiaHRtbEZvciIsCgkJImNsYXNzIjogImNsYXNzTmFtZSIKCX0KfSApOwoKLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5Ci8vIEFjY2Vzc2luZyB0aGUgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eQovLyBmb3JjZXMgdGhlIGJyb3dzZXIgdG8gcmVzcGVjdCBzZXR0aW5nIHNlbGVjdGVkCi8vIG9uIHRoZSBvcHRpb24KLy8gVGhlIGdldHRlciBlbnN1cmVzIGEgZGVmYXVsdCBvcHRpb24gaXMgc2VsZWN0ZWQKLy8gd2hlbiBpbiBhbiBvcHRncm91cAovLyBlc2xpbnQgcnVsZSAibm8tdW51c2VkLWV4cHJlc3Npb25zIiBpcyBkaXNhYmxlZCBmb3IgdGhpcyBjb2RlCi8vIHNpbmNlIGl0IGNvbnNpZGVycyBzdWNoIGFjY2Vzc2lvbnMgbm9vcAppZiAoICFzdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoKCQkJLyogZXNsaW50IG5vLXVudXNlZC1leHByZXNzaW9uczogIm9mZiIgKi8KCgkJCXZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CgkJCWlmICggcGFyZW50ICYmIHBhcmVudC5wYXJlbnROb2RlICkgewoJCQkJcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlyZXR1cm4gbnVsbDsKCQl9LAoJCXNldDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCQkvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLwoKCQkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQlwYXJlbnQuc2VsZWN0ZWRJbmRleDsKCgkJCQlpZiAoIHBhcmVudC5wYXJlbnROb2RlICkgewoJCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgpqUXVlcnkuZWFjaCggWwoJInRhYkluZGV4IiwKCSJyZWFkT25seSIsCgkibWF4TGVuZ3RoIiwKCSJjZWxsU3BhY2luZyIsCgkiY2VsbFBhZGRpbmciLAoJInJvd1NwYW4iLAoJImNvbFNwYW4iLAoJInVzZU1hcCIsCgkiZnJhbWVCb3JkZXIiLAoJImNvbnRlbnRFZGl0YWJsZSIKXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkucHJvcEZpeFsgdGhpcy50b0xvd2VyQ2FzZSgpIF0gPSB0aGlzOwp9ICk7CgoKCgoJLy8gU3RyaXAgYW5kIGNvbGxhcHNlIHdoaXRlc3BhY2UgYWNjb3JkaW5nIHRvIEhUTUwgc3BlYwoJLy8gaHR0cHM6Ly9pbmZyYS5zcGVjLndoYXR3Zy5vcmcvI3N0cmlwLWFuZC1jb2xsYXBzZS1hc2NpaS13aGl0ZXNwYWNlCglmdW5jdGlvbiBzdHJpcEFuZENvbGxhcHNlKCB2YWx1ZSApIHsKCQl2YXIgdG9rZW5zID0gdmFsdWUubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbXTsKCQlyZXR1cm4gdG9rZW5zLmpvaW4oICIgIiApOwoJfQoKCmZ1bmN0aW9uIGdldENsYXNzKCBlbGVtICkgewoJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlICYmIGVsZW0uZ2V0QXR0cmlidXRlKCAiY2xhc3MiICkgfHwgIiI7Cn0KCmZ1bmN0aW9uIGNsYXNzZXNUb0FycmF5KCB2YWx1ZSApIHsKCWlmICggQXJyYXkuaXNBcnJheSggdmFsdWUgKSApIHsKCQlyZXR1cm4gdmFsdWU7Cgl9CglpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIHZhbHVlLm1hdGNoKCBybm90aHRtbHdoaXRlICkgfHwgW107Cgl9CglyZXR1cm4gW107Cn0KCmpRdWVyeS5mbi5leHRlbmQoIHsKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY3VyVmFsdWUsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLAoJCQlpID0gMDsKCgkJaWYgKCBpc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLmFkZENsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCBnZXRDbGFzcyggdGhpcyApICkgKTsKCQkJfSApOwoJCX0KCgkJY2xhc3NlcyA9IGNsYXNzZXNUb0FycmF5KCB2YWx1ZSApOwoKCQlpZiAoIGNsYXNzZXMubGVuZ3RoICkgewoJCQl3aGlsZSAoICggZWxlbSA9IHRoaXNbIGkrKyBdICkgKSB7CgkJCQljdXJWYWx1ZSA9IGdldENsYXNzKCBlbGVtICk7CgkJCQljdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggIiAiICsgc3RyaXBBbmRDb2xsYXBzZSggY3VyVmFsdWUgKSArICIgIiApOwoKCQkJCWlmICggY3VyICkgewoJCQkJCWogPSAwOwoJCQkJCXdoaWxlICggKCBjbGF6eiA9IGNsYXNzZXNbIGorKyBdICkgKSB7CgkJCQkJCWlmICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPCAwICkgewoJCQkJCQkJY3VyICs9IGNsYXp6ICsgIiAiOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBPbmx5IGFzc2lnbiBpZiBkaWZmZXJlbnQgdG8gYXZvaWQgdW5uZWVkZWQgcmVuZGVyaW5nLgoJCQkJCWZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKCBjdXIgKTsKCQkJCQlpZiAoIGN1clZhbHVlICE9PSBmaW5hbFZhbHVlICkgewoJCQkJCQllbGVtLnNldEF0dHJpYnV0ZSggImNsYXNzIiwgZmluYWxWYWx1ZSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY3VyVmFsdWUsIGNsYXp6LCBqLCBmaW5hbFZhbHVlLAoJCQlpID0gMDsKCgkJaWYgKCBpc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCBnZXRDbGFzcyggdGhpcyApICkgKTsKCQkJfSApOwoJCX0KCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJcmV0dXJuIHRoaXMuYXR0ciggImNsYXNzIiwgIiIgKTsKCQl9CgoJCWNsYXNzZXMgPSBjbGFzc2VzVG9BcnJheSggdmFsdWUgKTsKCgkJaWYgKCBjbGFzc2VzLmxlbmd0aCApIHsKCQkJd2hpbGUgKCAoIGVsZW0gPSB0aGlzWyBpKysgXSApICkgewoJCQkJY3VyVmFsdWUgPSBnZXRDbGFzcyggZWxlbSApOwoKCQkJCS8vIFRoaXMgZXhwcmVzc2lvbiBpcyBoZXJlIGZvciBiZXR0ZXIgY29tcHJlc3NpYmlsaXR5IChzZWUgYWRkQ2xhc3MpCgkJCQljdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICggIiAiICsgc3RyaXBBbmRDb2xsYXBzZSggY3VyVmFsdWUgKSArICIgIiApOwoKCQkJCWlmICggY3VyICkgewoJCQkJCWogPSAwOwoJCQkJCXdoaWxlICggKCBjbGF6eiA9IGNsYXNzZXNbIGorKyBdICkgKSB7CgoJCQkJCQkvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCgkJCQkJCXdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPiAtMSApIHsKCQkJCQkJCWN1ciA9IGN1ci5yZXBsYWNlKCAiICIgKyBjbGF6eiArICIgIiwgIiAiICk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCS8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCgkJCQkJZmluYWxWYWx1ZSA9IHN0cmlwQW5kQ29sbGFwc2UoIGN1ciApOwoJCQkJCWlmICggY3VyVmFsdWUgIT09IGZpbmFsVmFsdWUgKSB7CgkJCQkJCWVsZW0uc2V0QXR0cmlidXRlKCAiY2xhc3MiLCBmaW5hbFZhbHVlICk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWUsCgkJCWlzVmFsaWRWYWx1ZSA9IHR5cGUgPT09ICJzdHJpbmciIHx8IEFycmF5LmlzQXJyYXkoIHZhbHVlICk7CgoJCWlmICggdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgaXNWYWxpZFZhbHVlICkgewoJCQlyZXR1cm4gc3RhdGVWYWwgPyB0aGlzLmFkZENsYXNzKCB2YWx1ZSApIDogdGhpcy5yZW1vdmVDbGFzcyggdmFsdWUgKTsKCQl9CgoJCWlmICggaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS50b2dnbGVDbGFzcygKCQkJCQl2YWx1ZS5jYWxsKCB0aGlzLCBpLCBnZXRDbGFzcyggdGhpcyApLCBzdGF0ZVZhbCApLAoJCQkJCXN0YXRlVmFsCgkJCQkpOwoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNsYXNzTmFtZSwgaSwgc2VsZiwgY2xhc3NOYW1lczsKCgkJCWlmICggaXNWYWxpZFZhbHVlICkgewoKCQkJCS8vIFRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCgkJCQlpID0gMDsKCQkJCXNlbGYgPSBqUXVlcnkoIHRoaXMgKTsKCQkJCWNsYXNzTmFtZXMgPSBjbGFzc2VzVG9BcnJheSggdmFsdWUgKTsKCgkJCQl3aGlsZSAoICggY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0gKSApIHsKCgkJCQkJLy8gQ2hlY2sgZWFjaCBjbGFzc05hbWUgZ2l2ZW4sIHNwYWNlIHNlcGFyYXRlZCBsaXN0CgkJCQkJaWYgKCBzZWxmLmhhc0NsYXNzKCBjbGFzc05hbWUgKSApIHsKCQkJCQkJc2VsZi5yZW1vdmVDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2VsZi5hZGRDbGFzcyggY2xhc3NOYW1lICk7CgkJCQkJfQoJCQkJfQoKCQkJLy8gVG9nZ2xlIHdob2xlIGNsYXNzIG5hbWUKCQkJfSBlbHNlIGlmICggdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlID09PSAiYm9vbGVhbiIgKSB7CgkJCQljbGFzc05hbWUgPSBnZXRDbGFzcyggdGhpcyApOwoJCQkJaWYgKCBjbGFzc05hbWUgKSB7CgoJCQkJCS8vIFN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKCQkJCQlkYXRhUHJpdi5zZXQoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgY2xhc3NOYW1lICk7CgkJCQl9CgoJCQkJLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgYGZhbHNlYCwKCQkJCS8vIHRoZW4gcmVtb3ZlIHRoZSB3aG9sZSBjbGFzc25hbWUgKGlmIHRoZXJlIHdhcyBvbmUsIHRoZSBhYm92ZSBzYXZlZCBpdCkuCgkJCQkvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLAoJCQkJLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgoJCQkJaWYgKCB0aGlzLnNldEF0dHJpYnV0ZSApIHsKCQkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImNsYXNzIiwKCQkJCQkJY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/CgkJCQkJCSIiIDoKCQkJCQkJZGF0YVByaXYuZ2V0KCB0aGlzLCAiX19jbGFzc05hbWVfXyIgKSB8fCAiIgoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9ICk7Cgl9LAoKCWhhc0NsYXNzOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGNsYXNzTmFtZSwgZWxlbSwKCQkJaSA9IDA7CgoJCWNsYXNzTmFtZSA9ICIgIiArIHNlbGVjdG9yICsgIiAiOwoJCXdoaWxlICggKCBlbGVtID0gdGhpc1sgaSsrIF0gKSApIHsKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmCgkJCQkoICIgIiArIHN0cmlwQW5kQ29sbGFwc2UoIGdldENsYXNzKCBlbGVtICkgKSArICIgIiApLmluZGV4T2YoIGNsYXNzTmFtZSApID4gLTEgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0KfSApOwoKCgoKdmFyIHJyZXR1cm4gPSAvXHIvZzsKCmpRdWVyeS5mbi5leHRlbmQoIHsKCXZhbDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBob29rcywgcmV0LCB2YWx1ZUlzRnVuY3Rpb24sCgkJCWVsZW0gPSB0aGlzWyAwIF07CgoJCWlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCWlmICggZWxlbSApIHsKCQkJCWhvb2tzID0galF1ZXJ5LnZhbEhvb2tzWyBlbGVtLnR5cGUgXSB8fAoJCQkJCWpRdWVyeS52YWxIb29rc1sgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkJaWYgKCBob29rcyAmJgoJCQkJCSJnZXQiIGluIGhvb2tzICYmCgkJCQkJKCByZXQgPSBob29rcy5nZXQoIGVsZW0sICJ2YWx1ZSIgKSApICE9PSB1bmRlZmluZWQKCQkJCSkgewoJCQkJCXJldHVybiByZXQ7CgkJCQl9CgoJCQkJcmV0ID0gZWxlbS52YWx1ZTsKCgkJCQkvLyBIYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCgkJCQlpZiAoIHR5cGVvZiByZXQgPT09ICJzdHJpbmciICkgewoJCQkJCXJldHVybiByZXQucmVwbGFjZSggcnJldHVybiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBIYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKCQkJCXJldHVybiByZXQgPT0gbnVsbCA/ICIiIDogcmV0OwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQl2YWx1ZUlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKCB2YWx1ZSApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJdmFyIHZhbDsKCgkJCWlmICggdGhpcy5ub2RlVHlwZSAhPT0gMSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB2YWx1ZUlzRnVuY3Rpb24gKSB7CgkJCQl2YWwgPSB2YWx1ZS5jYWxsKCB0aGlzLCBpLCBqUXVlcnkoIHRoaXMgKS52YWwoKSApOwoJCQl9IGVsc2UgewoJCQkJdmFsID0gdmFsdWU7CgkJCX0KCgkJCS8vIFRyZWF0IG51bGwvdW5kZWZpbmVkIGFzICIiOyBjb252ZXJ0IG51bWJlcnMgdG8gc3RyaW5nCgkJCWlmICggdmFsID09IG51bGwgKSB7CgkJCQl2YWwgPSAiIjsKCgkJCX0gZWxzZSBpZiAoIHR5cGVvZiB2YWwgPT09ICJudW1iZXIiICkgewoJCQkJdmFsICs9ICIiOwoKCQkJfSBlbHNlIGlmICggQXJyYXkuaXNBcnJheSggdmFsICkgKSB7CgkJCQl2YWwgPSBqUXVlcnkubWFwKCB2YWwsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQlyZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKCQkJCX0gKTsKCQkJfQoKCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwoJCQlpZiAoICFob29rcyB8fCAhKCAic2V0IiBpbiBob29rcyApIHx8IGhvb2tzLnNldCggdGhpcywgdmFsLCAidmFsdWUiICkgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMudmFsdWUgPSB2YWw7CgkJCX0KCQl9ICk7Cgl9Cn0gKTsKCmpRdWVyeS5leHRlbmQoIHsKCXZhbEhvb2tzOiB7CgkJb3B0aW9uOiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCQkJdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoIGVsZW0sICJ2YWx1ZSIgKTsKCQkJCXJldHVybiB2YWwgIT0gbnVsbCA/CgkJCQkJdmFsIDoKCgkJCQkJLy8gU3VwcG9ydDogSUUgPD0xMCAtIDExIG9ubHkKCQkJCQkvLyBvcHRpb24udGV4dCB0aHJvd3MgZXhjZXB0aW9ucyAoIzE0Njg2LCAjMTQ4NTgpCgkJCQkJLy8gU3RyaXAgYW5kIGNvbGxhcHNlIHdoaXRlc3BhY2UKCQkJCQkvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnLyNzdHJpcC1hbmQtY29sbGFwc2Utd2hpdGVzcGFjZQoJCQkJCXN0cmlwQW5kQ29sbGFwc2UoIGpRdWVyeS50ZXh0KCBlbGVtICkgKTsKCQkJfQoJCX0sCgkJc2VsZWN0OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgdmFsdWUsIG9wdGlvbiwgaSwKCQkJCQlvcHRpb25zID0gZWxlbS5vcHRpb25zLAoJCQkJCWluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAoJCQkJCW9uZSA9IGVsZW0udHlwZSA9PT0gInNlbGVjdC1vbmUiLAoJCQkJCXZhbHVlcyA9IG9uZSA/IG51bGwgOiBbXSwKCQkJCQltYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aDsKCgkJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCQlpID0gbWF4OwoKCQkJCX0gZWxzZSB7CgkJCQkJaSA9IG9uZSA/IGluZGV4IDogMDsKCQkJCX0KCgkJCQkvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCgkJCQlmb3IgKCA7IGkgPCBtYXg7IGkrKyApIHsKCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07CgoJCQkJCS8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CgkJCQkJLy8gSUU4LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAoIzI1NTEpCgkJCQkJaWYgKCAoIG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCApICYmCgoJCQkJCQkJLy8gRG9uJ3QgcmV0dXJuIG9wdGlvbnMgdGhhdCBhcmUgZGlzYWJsZWQgb3IgaW4gYSBkaXNhYmxlZCBvcHRncm91cAoJCQkJCQkJIW9wdGlvbi5kaXNhYmxlZCAmJgoJCQkJCQkJKCAhb3B0aW9uLnBhcmVudE5vZGUuZGlzYWJsZWQgfHwKCQkJCQkJCQkhbm9kZU5hbWUoIG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiICkgKSApIHsKCgkJCQkJCS8vIEdldCB0aGUgc3BlY2lmaWMgdmFsdWUgZm9yIHRoZSBvcHRpb24KCQkJCQkJdmFsdWUgPSBqUXVlcnkoIG9wdGlvbiApLnZhbCgpOwoKCQkJCQkJLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKCQkJCQkJaWYgKCBvbmUgKSB7CgkJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJCX0KCgkJCQkJCS8vIE11bHRpLVNlbGVjdHMgcmV0dXJuIGFuIGFycmF5CgkJCQkJCXZhbHVlcy5wdXNoKCB2YWx1ZSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9LAoKCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCQl2YXIgb3B0aW9uU2V0LCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQl2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KCB2YWx1ZSApLAoJCQkJCWkgPSBvcHRpb25zLmxlbmd0aDsKCgkJCQl3aGlsZSAoIGktLSApIHsKCQkJCQlvcHRpb24gPSBvcHRpb25zWyBpIF07CgoJCQkJCS8qIGVzbGludC1kaXNhYmxlIG5vLWNvbmQtYXNzaWduICovCgoJCQkJCWlmICggb3B0aW9uLnNlbGVjdGVkID0KCQkJCQkJalF1ZXJ5LmluQXJyYXkoIGpRdWVyeS52YWxIb29rcy5vcHRpb24uZ2V0KCBvcHRpb24gKSwgdmFsdWVzICkgPiAtMQoJCQkJCSkgewoJCQkJCQlvcHRpb25TZXQgPSB0cnVlOwoJCQkJCX0KCgkJCQkJLyogZXNsaW50LWVuYWJsZSBuby1jb25kLWFzc2lnbiAqLwoJCQkJfQoKCQkJCS8vIEZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CgkJCQlpZiAoICFvcHRpb25TZXQgKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9CgkJfQoJfQp9ICk7CgovLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgpqUXVlcnkuZWFjaCggWyAicmFkaW8iLCAiY2hlY2tib3giIF0sIGZ1bmN0aW9uKCkgewoJalF1ZXJ5LnZhbEhvb2tzWyB0aGlzIF0gPSB7CgkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7CgkJCWlmICggQXJyYXkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJCXJldHVybiAoIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkoIGVsZW0gKS52YWwoKSwgdmFsdWUgKSA+IC0xICk7CgkJCX0KCQl9Cgl9OwoJaWYgKCAhc3VwcG9ydC5jaGVja09uICkgewoJCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdLmdldCA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwoJCX07Cgl9Cn0gKTsKCgoKCi8vIFJldHVybiBqUXVlcnkgZm9yIGF0dHJpYnV0ZXMtb25seSBpbmNsdXNpb24KCgpzdXBwb3J0LmZvY3VzaW4gPSAib25mb2N1c2luIiBpbiB3aW5kb3c7CgoKdmFyIHJmb2N1c01vcnBoID0gL14oPzpmb2N1c2luZm9jdXN8Zm9jdXNvdXRibHVyKSQvLAoJc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2sgPSBmdW5jdGlvbiggZSApIHsKCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJfTsKCmpRdWVyeS5leHRlbmQoIGpRdWVyeS5ldmVudCwgewoKCXRyaWdnZXI6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzICkgewoKCQl2YXIgaSwgY3VyLCB0bXAsIGJ1YmJsZVR5cGUsIG9udHlwZSwgaGFuZGxlLCBzcGVjaWFsLCBsYXN0RWxlbWVudCwKCQkJZXZlbnRQYXRoID0gWyBlbGVtIHx8IGRvY3VtZW50IF0sCgkJCXR5cGUgPSBoYXNPd24uY2FsbCggZXZlbnQsICJ0eXBlIiApID8gZXZlbnQudHlwZSA6IGV2ZW50LAoJCQluYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoIGV2ZW50LCAibmFtZXNwYWNlIiApID8gZXZlbnQubmFtZXNwYWNlLnNwbGl0KCAiLiIgKSA6IFtdOwoKCQljdXIgPSBsYXN0RWxlbWVudCA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwoKCQkvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKCQlpZiAoIHJmb2N1c01vcnBoLnRlc3QoIHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdHlwZS5pbmRleE9mKCAiLiIgKSA+IC0xICkgewoKCQkJLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQoJCQluYW1lc3BhY2VzID0gdHlwZS5zcGxpdCggIi4iICk7CgkJCXR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7CgkJCW5hbWVzcGFjZXMuc29ydCgpOwoJCX0KCQlvbnR5cGUgPSB0eXBlLmluZGV4T2YoICI6IiApIDwgMCAmJiAib24iICsgdHlwZTsKCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCgkJZXZlbnQgPSBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/CgkJCWV2ZW50IDoKCQkJbmV3IGpRdWVyeS5FdmVudCggdHlwZSwgdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiAmJiBldmVudCApOwoKCQkvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCgkJZXZlbnQuaXNUcmlnZ2VyID0gb25seUhhbmRsZXJzID8gMiA6IDM7CgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCAiLiIgKTsKCQlldmVudC5ybmFtZXNwYWNlID0gZXZlbnQubmFtZXNwYWNlID8KCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCAiXFwuKD86LipcXC58KSIgKSArICIoXFwufCQpIiApIDoKCQkJbnVsbDsKCgkJLy8gQ2xlYW4gdXAgdGhlIGV2ZW50IGluIGNhc2UgaXQgaXMgYmVpbmcgcmV1c2VkCgkJZXZlbnQucmVzdWx0ID0gdW5kZWZpbmVkOwoJCWlmICggIWV2ZW50LnRhcmdldCApIHsKCQkJZXZlbnQudGFyZ2V0ID0gZWxlbTsKCQl9CgoJCS8vIENsb25lIGFueSBpbmNvbWluZyBkYXRhIGFuZCBwcmVwZW5kIHRoZSBldmVudCwgY3JlYXRpbmcgdGhlIGhhbmRsZXIgYXJnIGxpc3QKCQlkYXRhID0gZGF0YSA9PSBudWxsID8KCQkJWyBldmVudCBdIDoKCQkJalF1ZXJ5Lm1ha2VBcnJheSggZGF0YSwgWyBldmVudCBdICk7CgoJCS8vIEFsbG93IHNwZWNpYWwgZXZlbnRzIHRvIGRyYXcgb3V0c2lkZSB0aGUgbGluZXMKCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseSggZWxlbSwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRGV0ZXJtaW5lIGV2ZW50IHByb3BhZ2F0aW9uIHBhdGggaW4gYWR2YW5jZSwgcGVyIFczQyBldmVudHMgc3BlYyAoIzk5NTEpCgkJLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICgjOTcyNCkKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIXNwZWNpYWwubm9CdWJibGUgJiYgIWlzV2luZG93KCBlbGVtICkgKSB7CgoJCQlidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKCQkJaWYgKCAhcmZvY3VzTW9ycGgudGVzdCggYnViYmxlVHlwZSArIHR5cGUgKSApIHsKCQkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCQl9CgkJCWZvciAoIDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCWV2ZW50UGF0aC5wdXNoKCBjdXIgKTsKCQkJCXRtcCA9IGN1cjsKCQkJfQoKCQkJLy8gT25seSBhZGQgd2luZG93IGlmIHdlIGdvdCB0byBkb2N1bWVudCAoZS5nLiwgbm90IHBsYWluIG9iaiBvciBkZXRhY2hlZCBET00pCgkJCWlmICggdG1wID09PSAoIGVsZW0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyApOwoJCQl9CgkJfQoKCQkvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCgkJaSA9IDA7CgkJd2hpbGUgKCAoIGN1ciA9IGV2ZW50UGF0aFsgaSsrIF0gKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJbGFzdEVsZW1lbnQgPSBjdXI7CgkJCWV2ZW50LnR5cGUgPSBpID4gMSA/CgkJCQlidWJibGVUeXBlIDoKCQkJCXNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKCgkJCS8vIGpRdWVyeSBoYW5kbGVyCgkJCWhhbmRsZSA9ICggZGF0YVByaXYuZ2V0KCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmCgkJCQlkYXRhUHJpdi5nZXQoIGN1ciwgImhhbmRsZSIgKTsKCQkJaWYgKCBoYW5kbGUgKSB7CgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQl9CgoJCQkvLyBOYXRpdmUgaGFuZGxlcgoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKCQkJaWYgKCBoYW5kbGUgJiYgaGFuZGxlLmFwcGx5ICYmIGFjY2VwdERhdGEoIGN1ciApICkgewoJCQkJZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KCBjdXIsIGRhdGEgKTsKCQkJCWlmICggZXZlbnQucmVzdWx0ID09PSBmYWxzZSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgkJfQoJCWV2ZW50LnR5cGUgPSB0eXBlOwoKCQkvLyBJZiBub2JvZHkgcHJldmVudGVkIHRoZSBkZWZhdWx0IGFjdGlvbiwgZG8gaXQgbm93CgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCgkJCWlmICggKCAhc3BlY2lhbC5fZGVmYXVsdCB8fAoJCQkJc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZXZlbnRQYXRoLnBvcCgpLCBkYXRhICkgPT09IGZhbHNlICkgJiYKCQkJCWFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgoJCQkJLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQoJCQkJaWYgKCBvbnR5cGUgJiYgaXNGdW5jdGlvbiggZWxlbVsgdHlwZSBdICkgJiYgIWlzV2luZG93KCBlbGVtICkgKSB7CgoJCQkJCS8vIERvbid0IHJlLXRyaWdnZXIgYW4gb25GT08gZXZlbnQgd2hlbiB3ZSBjYWxsIGl0cyBGT08oKSBtZXRob2QKCQkJCQl0bXAgPSBlbGVtWyBvbnR5cGUgXTsKCgkJCQkJaWYgKCB0bXAgKSB7CgkJCQkJCWVsZW1bIG9udHlwZSBdID0gbnVsbDsKCQkJCQl9CgoJCQkJCS8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCgkJCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCA9IHR5cGU7CgoJCQkJCWlmICggZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCQkJbGFzdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2sgKTsKCQkJCQl9CgoJCQkJCWVsZW1bIHR5cGUgXSgpOwoKCQkJCQlpZiAoIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQkJCWxhc3RFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIHR5cGUsIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrICk7CgkJCQkJfQoKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwoKCQkJCQlpZiAoIHRtcCApIHsKCQkJCQkJZWxlbVsgb250eXBlIF0gPSB0bXA7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgkvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUKCS8vIFVzZWQgb25seSBmb3IgYGZvY3VzKGluIHwgb3V0KWAgZXZlbnRzCglzaW11bGF0ZTogZnVuY3Rpb24oIHR5cGUsIGVsZW0sIGV2ZW50ICkgewoJCXZhciBlID0galF1ZXJ5LmV4dGVuZCgKCQkJbmV3IGpRdWVyeS5FdmVudCgpLAoJCQlldmVudCwKCQkJewoJCQkJdHlwZTogdHlwZSwKCQkJCWlzU2ltdWxhdGVkOiB0cnVlCgkJCX0KCQkpOwoKCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggZSwgbnVsbCwgZWxlbSApOwoJfQoKfSApOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoKCXRyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlqUXVlcnkuZXZlbnQudHJpZ2dlciggdHlwZSwgZGF0YSwgdGhpcyApOwoJCX0gKTsKCX0sCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWyAwIF07CgkJaWYgKCBlbGVtICkgewoJCQlyZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIGVsZW0sIHRydWUgKTsKCQl9Cgl9Cn0gKTsKCgovLyBTdXBwb3J0OiBGaXJlZm94IDw9NDQKLy8gRmlyZWZveCBkb2Vzbid0IGhhdmUgZm9jdXMoaW4gfCBvdXQpIGV2ZW50cwovLyBSZWxhdGVkIHRpY2tldCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY4Nzc4NwovLwovLyBTdXBwb3J0OiBDaHJvbWUgPD00OCAtIDQ5LCBTYWZhcmkgPD05LjAgLSA5LjEKLy8gZm9jdXMoaW4gfCBvdXQpIGV2ZW50cyBmaXJlIGFmdGVyIGZvY3VzICYgYmx1ciBldmVudHMsCi8vIHdoaWNoIGlzIHNwZWMgdmlvbGF0aW9uIC0gaHR0cDovL3d3dy53My5vcmcvVFIvRE9NLUxldmVsLTMtRXZlbnRzLyNldmVudHMtZm9jdXNldmVudC1ldmVudC1vcmRlcgovLyBSZWxhdGVkIHRpY2tldCAtIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTQ0OTg1NwppZiAoICFzdXBwb3J0LmZvY3VzaW4gKSB7CglqUXVlcnkuZWFjaCggeyBmb2N1czogImZvY3VzaW4iLCBibHVyOiAiZm9jdXNvdXQiIH0sIGZ1bmN0aW9uKCBvcmlnLCBmaXggKSB7CgoJCS8vIEF0dGFjaCBhIHNpbmdsZSBjYXB0dXJpbmcgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CgkJdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWpRdWVyeS5ldmVudC5zaW11bGF0ZSggZml4LCBldmVudC50YXJnZXQsIGpRdWVyeS5ldmVudC5maXgoIGV2ZW50ICkgKTsKCQl9OwoKCQlqUXVlcnkuZXZlbnQuc3BlY2lhbFsgZml4IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCXZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywKCQkJCQlhdHRhY2hlcyA9IGRhdGFQcml2LmFjY2VzcyggZG9jLCBmaXggKTsKCgkJCQlpZiAoICFhdHRhY2hlcyApIHsKCQkJCQlkb2MuYWRkRXZlbnRMaXN0ZW5lciggb3JpZywgaGFuZGxlciwgdHJ1ZSApOwoJCQkJfQoJCQkJZGF0YVByaXYuYWNjZXNzKCBkb2MsIGZpeCwgKCBhdHRhY2hlcyB8fCAwICkgKyAxICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCXZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcywKCQkJCQlhdHRhY2hlcyA9IGRhdGFQcml2LmFjY2VzcyggZG9jLCBmaXggKSAtIDE7CgoJCQkJaWYgKCAhYXR0YWNoZXMgKSB7CgkJCQkJZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCQlkYXRhUHJpdi5yZW1vdmUoIGRvYywgZml4ICk7CgoJCQkJfSBlbHNlIHsKCQkJCQlkYXRhUHJpdi5hY2Nlc3MoIGRvYywgZml4LCBhdHRhY2hlcyApOwoJCQkJfQoJCQl9CgkJfTsKCX0gKTsKfQp2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247Cgp2YXIgbm9uY2UgPSBEYXRlLm5vdygpOwoKdmFyIHJxdWVyeSA9ICggL1w/LyApOwoKCgovLyBDcm9zcy1icm93c2VyIHhtbCBwYXJzaW5nCmpRdWVyeS5wYXJzZVhNTCA9IGZ1bmN0aW9uKCBkYXRhICkgewoJdmFyIHhtbDsKCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CgkvLyBJRSB0aHJvd3Mgb24gcGFyc2VGcm9tU3RyaW5nIHdpdGggaW52YWxpZCBpbnB1dC4KCXRyeSB7CgkJeG1sID0gKCBuZXcgd2luZG93LkRPTVBhcnNlcigpICkucGFyc2VGcm9tU3RyaW5nKCBkYXRhLCAidGV4dC94bWwiICk7Cgl9IGNhdGNoICggZSApIHsKCQl4bWwgPSB1bmRlZmluZWQ7Cgl9CgoJaWYgKCAheG1sIHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCApIHsKCQlqUXVlcnkuZXJyb3IoICJJbnZhbGlkIFhNTDogIiArIGRhdGEgKTsKCX0KCXJldHVybiB4bWw7Cn07CgoKdmFyCglyYnJhY2tldCA9IC9cW1xdJC8sCglyQ1JMRiA9IC9ccj9cbi9nLAoJcnN1Ym1pdHRlclR5cGVzID0gL14oPzpzdWJtaXR8YnV0dG9ufGltYWdlfHJlc2V0fGZpbGUpJC9pLAoJcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwoKZnVuY3Rpb24gYnVpbGRQYXJhbXMoIHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkICkgewoJdmFyIG5hbWU7CgoJaWYgKCBBcnJheS5pc0FycmF5KCBvYmogKSApIHsKCgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCgkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7CgoJCQkJLy8gVHJlYXQgZWFjaCBhcnJheSBpdGVtIGFzIGEgc2NhbGFyLgoJCQkJYWRkKCBwcmVmaXgsIHYgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy8gSXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzIG51bWVyaWMgaW5kZXguCgkJCQlidWlsZFBhcmFtcygKCQkJCQlwcmVmaXggKyAiWyIgKyAoIHR5cGVvZiB2ID09PSAib2JqZWN0IiAmJiB2ICE9IG51bGwgPyBpIDogIiIgKSArICJdIiwKCQkJCQl2LAoJCQkJCXRyYWRpdGlvbmFsLAoJCQkJCWFkZAoJCQkJKTsKCQkJfQoJCX0gKTsKCgl9IGVsc2UgaWYgKCAhdHJhZGl0aW9uYWwgJiYgdG9UeXBlKCBvYmogKSA9PT0gIm9iamVjdCIgKSB7CgoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgoJCS8vIFNlcmlhbGl6ZSBzY2FsYXIgaXRlbS4KCQlhZGQoIHByZWZpeCwgb2JqICk7Cgl9Cn0KCi8vIFNlcmlhbGl6ZSBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzIG9yIGEgc2V0IG9mCi8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwpqUXVlcnkucGFyYW0gPSBmdW5jdGlvbiggYSwgdHJhZGl0aW9uYWwgKSB7Cgl2YXIgcHJlZml4LAoJCXMgPSBbXSwKCQlhZGQgPSBmdW5jdGlvbigga2V5LCB2YWx1ZU9yRnVuY3Rpb24gKSB7CgoJCQkvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHVzZSBpdHMgcmV0dXJuIHZhbHVlCgkJCXZhciB2YWx1ZSA9IGlzRnVuY3Rpb24oIHZhbHVlT3JGdW5jdGlvbiApID8KCQkJCXZhbHVlT3JGdW5jdGlvbigpIDoKCQkJCXZhbHVlT3JGdW5jdGlvbjsKCgkJCXNbIHMubGVuZ3RoIF0gPSBlbmNvZGVVUklDb21wb25lbnQoIGtleSApICsgIj0iICsKCQkJCWVuY29kZVVSSUNvbXBvbmVudCggdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKTsKCQl9OwoKCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCglpZiAoIEFycmF5LmlzQXJyYXkoIGEgKSB8fCAoIGEuanF1ZXJ5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdCggYSApICkgKSB7CgoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKCQl9ICk7CgoJfSBlbHNlIHsKCgkJLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCgkJLy8gZGlkIGl0KSwgb3RoZXJ3aXNlIGVuY29kZSBwYXJhbXMgcmVjdXJzaXZlbHkuCgkJZm9yICggcHJlZml4IGluIGEgKSB7CgkJCWJ1aWxkUGFyYW1zKCBwcmVmaXgsIGFbIHByZWZpeCBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgcmVzdWx0aW5nIHNlcmlhbGl6YXRpb24KCXJldHVybiBzLmpvaW4oICImIiApOwp9OwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJc2VyaWFsaXplOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5LnBhcmFtKCB0aGlzLnNlcmlhbGl6ZUFycmF5KCkgKTsKCX0sCglzZXJpYWxpemVBcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsKCgkJCS8vIENhbiBhZGQgcHJvcEhvb2sgZm9yICJlbGVtZW50cyIgdG8gZmlsdGVyIG9yIGFkZCBmb3JtIGVsZW1lbnRzCgkJCXZhciBlbGVtZW50cyA9IGpRdWVyeS5wcm9wKCB0aGlzLCAiZWxlbWVudHMiICk7CgkJCXJldHVybiBlbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkoIGVsZW1lbnRzICkgOiB0aGlzOwoJCX0gKQoJCS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQl2YXIgdHlwZSA9IHRoaXMudHlwZTsKCgkJCS8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKCQkJcmV0dXJuIHRoaXMubmFtZSAmJiAhalF1ZXJ5KCB0aGlzICkuaXMoICI6ZGlzYWJsZWQiICkgJiYKCQkJCXJzdWJtaXR0YWJsZS50ZXN0KCB0aGlzLm5vZGVOYW1lICkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KCB0eXBlICkgJiYKCQkJCSggdGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KCB0eXBlICkgKTsKCQl9ICkKCQkubWFwKCBmdW5jdGlvbiggaSwgZWxlbSApIHsKCQkJdmFyIHZhbCA9IGpRdWVyeSggdGhpcyApLnZhbCgpOwoKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJcmV0dXJuIGpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApIHsKCQkJCQlyZXR1cm4geyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJCQl9ICk7CgkJCX0KCgkJCXJldHVybiB7IG5hbWU6IGVsZW0ubmFtZSwgdmFsdWU6IHZhbC5yZXBsYWNlKCByQ1JMRiwgIlxyXG4iICkgfTsKCQl9ICkuZ2V0KCk7Cgl9Cn0gKTsKCgp2YXIKCXIyMCA9IC8lMjAvZywKCXJoYXNoID0gLyMuKiQvLAoJcmFudGlDYWNoZSA9IC8oWz8mXSlfPVteJl0qLywKCXJoZWFkZXJzID0gL14oLio/KTpbIFx0XSooW15cclxuXSopJC9tZywKCgkvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KCXJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCglybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKCXJwcm90b2NvbCA9IC9eXC9cLy8sCgoJLyogUHJlZmlsdGVycwoJICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKCSAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CgkgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CgkgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCgkgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCgkgKi8KCXByZWZpbHRlcnMgPSB7fSwKCgkvKiBUcmFuc3BvcnRzIGJpbmRpbmdzCgkgKiAxKSBrZXkgaXMgdGhlIGRhdGFUeXBlCgkgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAoJICogMykgc2VsZWN0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gZ28gdG8gIioiIGlmIG5lZWRlZAoJICovCgl0cmFuc3BvcnRzID0ge30sCgoJLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCglhbGxUeXBlcyA9ICIqLyIuY29uY2F0KCAiKiIgKSwKCgkvLyBBbmNob3IgdGFnIGZvciBwYXJzaW5nIHRoZSBkb2N1bWVudCBvcmlnaW4KCW9yaWdpbkFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJb3JpZ2luQW5jaG9yLmhyZWYgPSBsb2NhdGlvbi5ocmVmOwoKLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBzdHJ1Y3R1cmUgKSB7CgoJLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiIKCXJldHVybiBmdW5jdGlvbiggZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jICkgewoKCQlpZiAoIHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciICkgewoJCQlmdW5jID0gZGF0YVR5cGVFeHByZXNzaW9uOwoJCQlkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CgkJfQoKCQl2YXIgZGF0YVR5cGUsCgkJCWkgPSAwLAoJCQlkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaCggcm5vdGh0bWx3aGl0ZSApIHx8IFtdOwoKCQlpZiAoIGlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCgkJCS8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KCQkJd2hpbGUgKCAoIGRhdGFUeXBlID0gZGF0YVR5cGVzWyBpKysgXSApICkgewoKCQkJCS8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCgkJCQlpZiAoIGRhdGFUeXBlWyAwIF0gPT09ICIrIiApIHsKCQkJCQlkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKCAxICkgfHwgIioiOwoJCQkJCSggc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdICkudW5zaGlmdCggZnVuYyApOwoKCQkJCS8vIE90aGVyd2lzZSBhcHBlbmQKCQkJCX0gZWxzZSB7CgkJCQkJKCBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gPSBzdHJ1Y3R1cmVbIGRhdGFUeXBlIF0gfHwgW10gKS5wdXNoKCBmdW5jICk7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCgl2YXIgaW5zcGVjdGVkID0ge30sCgkJc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7CgkJdmFyIHNlbGVjdGVkOwoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsKCQkJdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3RvcnkoIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkJaWYgKCB0eXBlb2YgZGF0YVR5cGVPclRyYW5zcG9ydCA9PT0gInN0cmluZyIgJiYKCQkJCSFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbIGRhdGFUeXBlT3JUcmFuc3BvcnQgXSApIHsKCgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9ICk7CgkJcmV0dXJuIHNlbGVjdGVkOwoJfQoKCXJldHVybiBpbnNwZWN0KCBvcHRpb25zLmRhdGFUeXBlc1sgMCBdICkgfHwgIWluc3BlY3RlZFsgIioiIF0gJiYgaW5zcGVjdCggIioiICk7Cn0KCi8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwovLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKLy8gRml4ZXMgIzk4ODcKZnVuY3Rpb24gYWpheEV4dGVuZCggdGFyZ2V0LCBzcmMgKSB7Cgl2YXIga2V5LCBkZWVwLAoJCWZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKCglmb3IgKCBrZXkgaW4gc3JjICkgewoJCWlmICggc3JjWyBrZXkgXSAhPT0gdW5kZWZpbmVkICkgewoJCQkoIGZsYXRPcHRpb25zWyBrZXkgXSA/IHRhcmdldCA6ICggZGVlcCB8fCAoIGRlZXAgPSB7fSApICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgovKiBIYW5kbGVzIHJlc3BvbnNlcyB0byBhbiBhamF4IHJlcXVlc3Q6CiAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogKi8KZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyggcywganFYSFIsIHJlc3BvbnNlcyApIHsKCgl2YXIgY3QsIHR5cGUsIGZpbmFsRGF0YVR5cGUsIGZpcnN0RGF0YVR5cGUsCgkJY29udGVudHMgPSBzLmNvbnRlbnRzLAoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzOwoKCS8vIFJlbW92ZSBhdXRvIGRhdGFUeXBlIGFuZCBnZXQgY29udGVudC10eXBlIGluIHRoZSBwcm9jZXNzCgl3aGlsZSAoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJDb250ZW50LVR5cGUiICk7CgkJfQoJfQoKCS8vIENoZWNrIGlmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGtub3duIGNvbnRlbnQtdHlwZQoJaWYgKCBjdCApIHsKCQlmb3IgKCB0eXBlIGluIGNvbnRlbnRzICkgewoJCQlpZiAoIGNvbnRlbnRzWyB0eXBlIF0gJiYgY29udGVudHNbIHR5cGUgXS50ZXN0KCBjdCApICkgewoJCQkJZGF0YVR5cGVzLnVuc2hpZnQoIHR5cGUgKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQoJaWYgKCBkYXRhVHlwZXNbIDAgXSBpbiByZXNwb25zZXMgKSB7CgkJZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1sgMCBdOwoJfSBlbHNlIHsKCgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbIDAgXSBdICkgewoJCQkJZmluYWxEYXRhVHlwZSA9IHR5cGU7CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoICFmaXJzdERhdGFUeXBlICkgewoJCQkJZmlyc3REYXRhVHlwZSA9IHR5cGU7CgkJCX0KCQl9CgoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgoJCS8vIFdvcmsgd2l0aCBhIGNvcHkgb2YgZGF0YVR5cGVzIGluIGNhc2Ugd2UgbmVlZCB0byBtb2RpZnkgaXQgZm9yIGNvbnZlcnNpb24KCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwoKCS8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwoJaWYgKCBkYXRhVHlwZXNbIDEgXSApIHsKCQlmb3IgKCBjb252IGluIHMuY29udmVydGVycyApIHsKCQkJY29udmVydGVyc1sgY29udi50b0xvd2VyQ2FzZSgpIF0gPSBzLmNvbnZlcnRlcnNbIGNvbnYgXTsKCQl9Cgl9CgoJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCS8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlCgl3aGlsZSAoIGN1cnJlbnQgKSB7CgoJCWlmICggcy5yZXNwb25zZUZpZWxkc1sgY3VycmVudCBdICkgewoJCQlqcVhIUlsgcy5yZXNwb25zZUZpZWxkc1sgY3VycmVudCBdIF0gPSByZXNwb25zZTsKCQl9CgoJCS8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCgkJaWYgKCAhcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyICkgewoJCQlyZXNwb25zZSA9IHMuZGF0YUZpbHRlciggcmVzcG9uc2UsIHMuZGF0YVR5cGUgKTsKCQl9CgoJCXByZXYgPSBjdXJyZW50OwoJCWN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKCgkJaWYgKCBjdXJyZW50ICkgewoKCQkJLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwoJCQlpZiAoIGN1cnJlbnQgPT09ICIqIiApIHsKCgkJCQljdXJyZW50ID0gcHJldjsKCgkJCS8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKCQkJfSBlbHNlIGlmICggcHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQgKSB7CgoJCQkJLy8gU2VlayBhIGRpcmVjdCBjb252ZXJ0ZXIKCQkJCWNvbnYgPSBjb252ZXJ0ZXJzWyBwcmV2ICsgIiAiICsgY3VycmVudCBdIHx8IGNvbnZlcnRlcnNbICIqICIgKyBjdXJyZW50IF07CgoJCQkJLy8gSWYgbm9uZSBmb3VuZCwgc2VlayBhIHBhaXIKCQkJCWlmICggIWNvbnYgKSB7CgkJCQkJZm9yICggY29udjIgaW4gY29udmVydGVycyApIHsKCgkJCQkJCS8vIElmIGNvbnYyIG91dHB1dHMgY3VycmVudAoJCQkJCQl0bXAgPSBjb252Mi5zcGxpdCggIiAiICk7CgkJCQkJCWlmICggdG1wWyAxIF0gPT09IGN1cnJlbnQgKSB7CgoJCQkJCQkJLy8gSWYgcHJldiBjYW4gYmUgY29udmVydGVkIHRvIGFjY2VwdGVkIGlucHV0CgkJCQkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIHRtcFsgMCBdIF0gfHwKCQkJCQkJCQljb252ZXJ0ZXJzWyAiKiAiICsgdG1wWyAwIF0gXTsKCQkJCQkJCWlmICggY29udiApIHsKCgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzLnRocm93cyApIHsKCQkJCQkJcmVzcG9uc2UgPSBjb252KCByZXNwb25zZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJcmV0dXJuIHsKCQkJCQkJCQlzdGF0ZTogInBhcnNlcmVycm9yIiwKCQkJCQkJCQllcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudAoJCQkJCQkJfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9CgpqUXVlcnkuZXh0ZW5kKCB7CgoJLy8gQ291bnRlciBmb3IgaG9sZGluZyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSBxdWVyaWVzCglhY3RpdmU6IDAsCgoJLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAoJbGFzdE1vZGlmaWVkOiB7fSwKCWV0YWc6IHt9LAoKCWFqYXhTZXR0aW5nczogewoJCXVybDogbG9jYXRpb24uaHJlZiwKCQl0eXBlOiAiR0VUIiwKCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBsb2NhdGlvbi5wcm90b2NvbCApLAoJCWdsb2JhbDogdHJ1ZSwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCgoJCS8qCgkJdGltZW91dDogMCwKCQlkYXRhOiBudWxsLAoJCWRhdGFUeXBlOiBudWxsLAoJCXVzZXJuYW1lOiBudWxsLAoJCXBhc3N3b3JkOiBudWxsLAoJCWNhY2hlOiBudWxsLAoJCXRocm93czogZmFsc2UsCgkJdHJhZGl0aW9uYWw6IGZhbHNlLAoJCWhlYWRlcnM6IHt9LAoJCSovCgoJCWFjY2VwdHM6IHsKCQkJIioiOiBhbGxUeXBlcywKCQkJdGV4dDogInRleHQvcGxhaW4iLAoJCQlodG1sOiAidGV4dC9odG1sIiwKCQkJeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCgkJCWpzb246ICJhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L2phdmFzY3JpcHQiCgkJfSwKCgkJY29udGVudHM6IHsKCQkJeG1sOiAvXGJ4bWxcYi8sCgkJCWh0bWw6IC9cYmh0bWwvLAoJCQlqc29uOiAvXGJqc29uXGIvCgkJfSwKCgkJcmVzcG9uc2VGaWVsZHM6IHsKCQkJeG1sOiAicmVzcG9uc2VYTUwiLAoJCQl0ZXh0OiAicmVzcG9uc2VUZXh0IiwKCQkJanNvbjogInJlc3BvbnNlSlNPTiIKCQl9LAoKCQkvLyBEYXRhIGNvbnZlcnRlcnMKCQkvLyBLZXlzIHNlcGFyYXRlIHNvdXJjZSAob3IgY2F0Y2hhbGwgIioiKSBhbmQgZGVzdGluYXRpb24gdHlwZXMgd2l0aCBhIHNpbmdsZSBzcGFjZQoJCWNvbnZlcnRlcnM6IHsKCgkJCS8vIENvbnZlcnQgYW55dGhpbmcgdG8gdGV4dAoJCQkiKiB0ZXh0IjogU3RyaW5nLAoKCQkJLy8gVGV4dCB0byBodG1sICh0cnVlID0gbm8gdHJhbnNmb3JtYXRpb24pCgkJCSJ0ZXh0IGh0bWwiOiB0cnVlLAoKCQkJLy8gRXZhbHVhdGUgdGV4dCBhcyBhIGpzb24gZXhwcmVzc2lvbgoJCQkidGV4dCBqc29uIjogSlNPTi5wYXJzZSwKCgkJCS8vIFBhcnNlIHRleHQgYXMgeG1sCgkJCSJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAoJCX0sCgoJCS8vIEZvciBvcHRpb25zIHRoYXQgc2hvdWxkbid0IGJlIGRlZXAgZXh0ZW5kZWQ6CgkJLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgoJCS8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCgkJLy8gZGVlcCBleHRlbmRlZCAoc2VlIGFqYXhFeHRlbmQpCgkJZmxhdE9wdGlvbnM6IHsKCQkJdXJsOiB0cnVlLAoJCQljb250ZXh0OiB0cnVlCgkJfQoJfSwKCgkvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAoJLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgoJLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KCWFqYXhTZXR1cDogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7CgkJcmV0dXJuIHNldHRpbmdzID8KCgkJCS8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CgkJCWFqYXhFeHRlbmQoIGFqYXhFeHRlbmQoIHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyApLCBzZXR0aW5ncyApIDoKCgkJCS8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKCQkJYWpheEV4dGVuZCggalF1ZXJ5LmFqYXhTZXR0aW5ncywgdGFyZ2V0ICk7Cgl9LAoKCWFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycyApLAoJYWpheFRyYW5zcG9ydDogYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCB0cmFuc3BvcnRzICksCgoJLy8gTWFpbiBtZXRob2QKCWFqYXg6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCS8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCgkJaWYgKCB0eXBlb2YgdXJsID09PSAib2JqZWN0IiApIHsKCQkJb3B0aW9ucyA9IHVybDsKCQkJdXJsID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCgkJdmFyIHRyYW5zcG9ydCwKCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KCQkJY2FjaGVVUkwsCgoJCQkvLyBSZXNwb25zZSBoZWFkZXJzCgkJCXJlc3BvbnNlSGVhZGVyc1N0cmluZywKCQkJcmVzcG9uc2VIZWFkZXJzLAoKCQkJLy8gdGltZW91dCBoYW5kbGUKCQkJdGltZW91dFRpbWVyLAoKCQkJLy8gVXJsIGNsZWFudXAgdmFyCgkJCXVybEFuY2hvciwKCgkJCS8vIFJlcXVlc3Qgc3RhdGUgKGJlY29tZXMgZmFsc2UgdXBvbiBzZW5kIGFuZCB0cnVlIHVwb24gY29tcGxldGlvbikKCQkJY29tcGxldGVkLAoKCQkJLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCgkJCWZpcmVHbG9iYWxzLAoKCQkJLy8gTG9vcCB2YXJpYWJsZQoJCQlpLAoKCQkJLy8gdW5jYWNoZWQgcGFydCBvZiB0aGUgdXJsCgkJCXVuY2FjaGVkLAoKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCgkJCS8vIENhbGxiYWNrcyBjb250ZXh0CgkJCWNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAoKCQkJLy8gQ29udGV4dCBmb3IgZ2xvYmFsIGV2ZW50cyBpcyBjYWxsYmFja0NvbnRleHQgaWYgaXQgaXMgYSBET00gbm9kZSBvciBqUXVlcnkgY29sbGVjdGlvbgoJCQlnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYKCQkJCSggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/CgkJCQkJalF1ZXJ5KCBjYWxsYmFja0NvbnRleHQgKSA6CgkJCQkJalF1ZXJ5LmV2ZW50LAoKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCAib25jZSBtZW1vcnkiICksCgoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoKCQkJLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKCQkJcmVxdWVzdEhlYWRlcnMgPSB7fSwKCQkJcmVxdWVzdEhlYWRlcnNOYW1lcyA9IHt9LAoKCQkJLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCgkJCXN0ckFib3J0ID0gImNhbmNlbGVkIiwKCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBjb21wbGV0ZWQgKSB7CgkJCQkJCWlmICggIXJlc3BvbnNlSGVhZGVycyApIHsKCQkJCQkJCXJlc3BvbnNlSGVhZGVycyA9IHt9OwoJCQkJCQkJd2hpbGUgKCAoIG1hdGNoID0gcmhlYWRlcnMuZXhlYyggcmVzcG9uc2VIZWFkZXJzU3RyaW5nICkgKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWyAxIF0udG9Mb3dlckNhc2UoKSBdID0gbWF0Y2hbIDIgXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQltYXRjaCA9IHJlc3BvbnNlSGVhZGVyc1sga2V5LnRvTG93ZXJDYXNlKCkgXTsKCQkJCQl9CgkJCQkJcmV0dXJuIG1hdGNoID09IG51bGwgPyBudWxsIDogbWF0Y2g7CgkJCQl9LAoKCQkJCS8vIFJhdyBzdHJpbmcKCQkJCWdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIGNvbXBsZXRlZCA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CgkJCQl9LAoKCQkJCS8vIENhY2hlcyB0aGUgaGVhZGVyCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJCQkJaWYgKCBjb21wbGV0ZWQgPT0gbnVsbCApIHsKCQkJCQkJbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIG5hbWUudG9Mb3dlckNhc2UoKSBdID0KCQkJCQkJCXJlcXVlc3RIZWFkZXJzTmFtZXNbIG5hbWUudG9Mb3dlckNhc2UoKSBdIHx8IG5hbWU7CgkJCQkJCXJlcXVlc3RIZWFkZXJzWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCgkJCQlvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlpZiAoIGNvbXBsZXRlZCA9PSBudWxsICkgewoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCQlzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewoJCQkJCXZhciBjb2RlOwoJCQkJCWlmICggbWFwICkgewoJCQkJCQlpZiAoIGNvbXBsZXRlZCApIHsKCgkJCQkJCQkvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKCQkJCQkJCWpxWEhSLmFsd2F5cyggbWFwWyBqcVhIUi5zdGF0dXMgXSApOwoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCS8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2tzIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCgkJCQkJCQlmb3IgKCBjb2RlIGluIG1hcCApIHsKCQkJCQkJCQlzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gQ2FuY2VsIHRoZSByZXF1ZXN0CgkJCQlhYm9ydDogZnVuY3Rpb24oIHN0YXR1c1RleHQgKSB7CgkJCQkJdmFyIGZpbmFsVGV4dCA9IHN0YXR1c1RleHQgfHwgc3RyQWJvcnQ7CgkJCQkJaWYgKCB0cmFuc3BvcnQgKSB7CgkJCQkJCXRyYW5zcG9ydC5hYm9ydCggZmluYWxUZXh0ICk7CgkJCQkJfQoJCQkJCWRvbmUoIDAsIGZpbmFsVGV4dCApOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9OwoKCQkvLyBBdHRhY2ggZGVmZXJyZWRzCgkJZGVmZXJyZWQucHJvbWlzZSgganFYSFIgKTsKCgkJLy8gQWRkIHByb3RvY29sIGlmIG5vdCBwcm92aWRlZCAocHJlZmlsdGVycyBtaWdodCBleHBlY3QgaXQpCgkJLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICgjMTAwOTM6IGNvbnNpc3RlbmN5IHdpdGggb2xkIHNpZ25hdHVyZSkKCQkvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUKCQlzLnVybCA9ICggKCB1cmwgfHwgcy51cmwgfHwgbG9jYXRpb24uaHJlZiApICsgIiIgKQoJCQkucmVwbGFjZSggcnByb3RvY29sLCBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKTsKCgkJLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CgkJcy50eXBlID0gb3B0aW9ucy5tZXRob2QgfHwgb3B0aW9ucy50eXBlIHx8IHMubWV0aG9kIHx8IHMudHlwZTsKCgkJLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAoJCXMuZGF0YVR5cGVzID0gKCBzLmRhdGFUeXBlIHx8ICIqIiApLnRvTG93ZXJDYXNlKCkubWF0Y2goIHJub3RodG1sd2hpdGUgKSB8fCBbICIiIF07CgoJCS8vIEEgY3Jvc3MtZG9tYWluIHJlcXVlc3QgaXMgaW4gb3JkZXIgd2hlbiB0aGUgb3JpZ2luIGRvZXNuJ3QgbWF0Y2ggdGhlIGN1cnJlbnQgb3JpZ2luLgoJCWlmICggcy5jcm9zc0RvbWFpbiA9PSBudWxsICkgewoJCQl1cmxBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCgkJCS8vIFN1cHBvcnQ6IElFIDw9OCAtIDExLCBFZGdlIDEyIC0gMTUKCQkJLy8gSUUgdGhyb3dzIGV4Y2VwdGlvbiBvbiBhY2Nlc3NpbmcgdGhlIGhyZWYgcHJvcGVydHkgaWYgdXJsIGlzIG1hbGZvcm1lZCwKCQkJLy8gZS5nLiBodHRwOi8vZXhhbXBsZS5jb206ODB4LwoJCQl0cnkgewoJCQkJdXJsQW5jaG9yLmhyZWYgPSBzLnVybDsKCgkJCQkvLyBTdXBwb3J0OiBJRSA8PTggLSAxMSBvbmx5CgkJCQkvLyBBbmNob3IncyBob3N0IHByb3BlcnR5IGlzbid0IGNvcnJlY3RseSBzZXQgd2hlbiBzLnVybCBpcyByZWxhdGl2ZQoJCQkJdXJsQW5jaG9yLmhyZWYgPSB1cmxBbmNob3IuaHJlZjsKCQkJCXMuY3Jvc3NEb21haW4gPSBvcmlnaW5BbmNob3IucHJvdG9jb2wgKyAiLy8iICsgb3JpZ2luQW5jaG9yLmhvc3QgIT09CgkJCQkJdXJsQW5jaG9yLnByb3RvY29sICsgIi8vIiArIHVybEFuY2hvci5ob3N0OwoJCQl9IGNhdGNoICggZSApIHsKCgkJCQkvLyBJZiB0aGVyZSBpcyBhbiBlcnJvciBwYXJzaW5nIHRoZSBVUkwsIGFzc3VtZSBpdCBpcyBjcm9zc0RvbWFpbiwKCQkJCS8vIGl0IGNhbiBiZSByZWplY3RlZCBieSB0aGUgdHJhbnNwb3J0IGlmIGl0IGlzIGludmFsaWQKCQkJCXMuY3Jvc3NEb21haW4gPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBDb252ZXJ0IGRhdGEgaWYgbm90IGFscmVhZHkgYSBzdHJpbmcKCQlpZiAoIHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIHR5cGVvZiBzLmRhdGEgIT09ICJzdHJpbmciICkgewoJCQlzLmRhdGEgPSBqUXVlcnkucGFyYW0oIHMuZGF0YSwgcy50cmFkaXRpb25hbCApOwoJCX0KCgkJLy8gQXBwbHkgcHJlZmlsdGVycwoJCWluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKCBwcmVmaWx0ZXJzLCBzLCBvcHRpb25zLCBqcVhIUiApOwoKCQkvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhIHByZWZpbHRlciwgc3RvcCB0aGVyZQoJCWlmICggY29tcGxldGVkICkgewoJCQlyZXR1cm4ganFYSFI7CgkJfQoKCQkvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwoJCS8vIERvbid0IGZpcmUgZXZlbnRzIGlmIGpRdWVyeS5ldmVudCBpcyB1bmRlZmluZWQgaW4gYW4gQU1ELXVzYWdlIHNjZW5hcmlvICgjMTUxMTgpCgkJZmlyZUdsb2JhbHMgPSBqUXVlcnkuZXZlbnQgJiYgcy5nbG9iYWw7CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoICJhamF4U3RhcnQiICk7CgkJfQoKCQkvLyBVcHBlcmNhc2UgdGhlIHR5cGUKCQlzLnR5cGUgPSBzLnR5cGUudG9VcHBlckNhc2UoKTsKCgkJLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKCQlzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KCBzLnR5cGUgKTsKCgkJLy8gU2F2ZSB0aGUgVVJMIGluIGNhc2Ugd2UncmUgdG95aW5nIHdpdGggdGhlIElmLU1vZGlmaWVkLVNpbmNlCgkJLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCgkJLy8gUmVtb3ZlIGhhc2ggdG8gc2ltcGxpZnkgdXJsIG1hbmlwdWxhdGlvbgoJCWNhY2hlVVJMID0gcy51cmwucmVwbGFjZSggcmhhc2gsICIiICk7CgoJCS8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CgkJaWYgKCAhcy5oYXNDb250ZW50ICkgewoKCQkJLy8gUmVtZW1iZXIgdGhlIGhhc2ggc28gd2UgY2FuIHB1dCBpdCBiYWNrCgkJCXVuY2FjaGVkID0gcy51cmwuc2xpY2UoIGNhY2hlVVJMLmxlbmd0aCApOwoKCQkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUgYW5kIHNob3VsZCBiZSBwcm9jZXNzZWQsIGFwcGVuZCBkYXRhIHRvIHVybAoJCQlpZiAoIHMuZGF0YSAmJiAoIHMucHJvY2Vzc0RhdGEgfHwgdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgKSApIHsKCQkJCWNhY2hlVVJMICs9ICggcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YTsKCgkJCQkvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CgkJCQlkZWxldGUgcy5kYXRhOwoJCQl9CgoJCQkvLyBBZGQgb3IgdXBkYXRlIGFudGktY2FjaGUgcGFyYW0gaWYgbmVlZGVkCgkJCWlmICggcy5jYWNoZSA9PT0gZmFsc2UgKSB7CgkJCQljYWNoZVVSTCA9IGNhY2hlVVJMLnJlcGxhY2UoIHJhbnRpQ2FjaGUsICIkMSIgKTsKCQkJCXVuY2FjaGVkID0gKCBycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgIl89IiArICggbm9uY2UrKyApICsgdW5jYWNoZWQ7CgkJCX0KCgkJCS8vIFB1dCBoYXNoIGFuZCBhbnRpLWNhY2hlIG9uIHRoZSBVUkwgdGhhdCB3aWxsIGJlIHJlcXVlc3RlZCAoZ2gtMTczMikKCQkJcy51cmwgPSBjYWNoZVVSTCArIHVuY2FjaGVkOwoKCQkvLyBDaGFuZ2UgJyUyMCcgdG8gJysnIGlmIHRoaXMgaXMgZW5jb2RlZCBmb3JtIGJvZHkgY29udGVudCAoZ2gtMjY1OCkKCQl9IGVsc2UgaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJgoJCQkoIHMuY29udGVudFR5cGUgfHwgIiIgKS5pbmRleE9mKCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiApID09PSAwICkgewoJCQlzLmRhdGEgPSBzLmRhdGEucmVwbGFjZSggcjIwLCAiKyIgKTsKCQl9CgoJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJaWYgKCBzLmlmTW9kaWZpZWQgKSB7CgkJCWlmICggalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApIHsKCQkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoICJJZi1Nb2RpZmllZC1TaW5jZSIsIGpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gKTsKCQkJfQoJCQlpZiAoIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1sgY2FjaGVVUkwgXSApOwoJCQl9CgkJfQoKCQkvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKCQlpZiAoIHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSApIHsKCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIkNvbnRlbnQtVHlwZSIsIHMuY29udGVudFR5cGUgKTsKCQl9CgoJCS8vIFNldCB0aGUgQWNjZXB0cyBoZWFkZXIgZm9yIHRoZSBzZXJ2ZXIsIGRlcGVuZGluZyBvbiB0aGUgZGF0YVR5cGUKCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkiQWNjZXB0IiwKCQkJcy5kYXRhVHlwZXNbIDAgXSAmJiBzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWyAwIF0gXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWyAwIF0gXSArCgkJCQkJKCBzLmRhdGFUeXBlc1sgMCBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIgKSA6CgkJCQlzLmFjY2VwdHNbICIqIiBdCgkJKTsKCgkJLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCgkJZm9yICggaSBpbiBzLmhlYWRlcnMgKSB7CgkJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIGksIHMuaGVhZGVyc1sgaSBdICk7CgkJfQoKCQkvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CgkJaWYgKCBzLmJlZm9yZVNlbmQgJiYKCQkJKCBzLmJlZm9yZVNlbmQuY2FsbCggY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcyApID09PSBmYWxzZSB8fCBjb21wbGV0ZWQgKSApIHsKCgkJCS8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgoJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCQl9CgoJCS8vIEFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgoJCXN0ckFib3J0ID0gImFib3J0IjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCgkJY29tcGxldGVEZWZlcnJlZC5hZGQoIHMuY29tcGxldGUgKTsKCQlqcVhIUi5kb25lKCBzLnN1Y2Nlc3MgKTsKCQlqcVhIUi5mYWlsKCBzLmVycm9yICk7CgoJCS8vIEdldCB0cmFuc3BvcnQKCQl0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CgkJaWYgKCAhdHJhbnNwb3J0ICkgewoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsKCQl9IGVsc2UgewoJCQlqcVhIUi5yZWFkeVN0YXRlID0gMTsKCgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCgkJCS8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGFqYXhTZW5kLCBzdG9wIHRoZXJlCgkJCWlmICggY29tcGxldGVkICkgewoJCQkJcmV0dXJuIGpxWEhSOwoJCQl9CgoJCQkvLyBUaW1lb3V0CgkJCWlmICggcy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwICkgewoJCQkJdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCWpxWEhSLmFib3J0KCAidGltZW91dCIgKTsKCQkJCX0sIHMudGltZW91dCApOwoJCQl9CgoJCQl0cnkgewoJCQkJY29tcGxldGVkID0gZmFsc2U7CgkJCQl0cmFuc3BvcnQuc2VuZCggcmVxdWVzdEhlYWRlcnMsIGRvbmUgKTsKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJLy8gUmV0aHJvdyBwb3N0LWNvbXBsZXRpb24gZXhjZXB0aW9ucwoJCQkJaWYgKCBjb21wbGV0ZWQgKSB7CgkJCQkJdGhyb3cgZTsKCQkJCX0KCgkJCQkvLyBQcm9wYWdhdGUgb3RoZXJzIGFzIHJlc3VsdHMKCQkJCWRvbmUoIC0xLCBlICk7CgkJCX0KCQl9CgoJCS8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQoJCWZ1bmN0aW9uIGRvbmUoIHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzICkgewoJCQl2YXIgaXNTdWNjZXNzLCBzdWNjZXNzLCBlcnJvciwgcmVzcG9uc2UsIG1vZGlmaWVkLAoJCQkJc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CgoJCQkvLyBJZ25vcmUgcmVwZWF0IGludm9jYXRpb25zCgkJCWlmICggY29tcGxldGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQljb21wbGV0ZWQgPSB0cnVlOwoKCQkJLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKCQkJaWYgKCB0aW1lb3V0VGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aW1lb3V0VGltZXIgKTsKCQkJfQoKCQkJLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KCQkJLy8gKG5vIG1hdHRlciBob3cgbG9uZyB0aGUganFYSFIgb2JqZWN0IHdpbGwgYmUgdXNlZCkKCQkJdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKCQkJLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwoJCQlyZXNwb25zZUhlYWRlcnNTdHJpbmcgPSBoZWFkZXJzIHx8ICIiOwoKCQkJLy8gU2V0IHJlYWR5U3RhdGUKCQkJanFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCgkJCS8vIERldGVybWluZSBpZiBzdWNjZXNzZnVsCgkJCWlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwoKCQkJLy8gR2V0IHJlc3BvbnNlIGRhdGEKCQkJaWYgKCByZXNwb25zZXMgKSB7CgkJCQlyZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKTsKCQkJfQoKCQkJLy8gQ29udmVydCBubyBtYXR0ZXIgd2hhdCAodGhhdCB3YXkgcmVzcG9uc2VYWFggZmllbGRzIGFyZSBhbHdheXMgc2V0KQoJCQlyZXNwb25zZSA9IGFqYXhDb252ZXJ0KCBzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcyApOwoKCQkJLy8gSWYgc3VjY2Vzc2Z1bCwgaGFuZGxlIHR5cGUgY2hhaW5pbmcKCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7CgoJCQkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQkJCWlmICggcy5pZk1vZGlmaWVkICkgewoJCQkJCW1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoICJMYXN0LU1vZGlmaWVkIiApOwoJCQkJCWlmICggbW9kaWZpZWQgKSB7CgkJCQkJCWpRdWVyeS5sYXN0TW9kaWZpZWRbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQkJbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlciggImV0YWciICk7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gaWYgbm8gY29udGVudAoJCQkJaWYgKCBzdGF0dXMgPT09IDIwNCB8fCBzLnR5cGUgPT09ICJIRUFEIiApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7CgoJCQkJLy8gaWYgbm90IG1vZGlmaWVkCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQKCQkJCX0gZWxzZSB7CgkJCQkJc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwoJCQkJCWVycm9yID0gcmVzcG9uc2UuZXJyb3I7CgkJCQkJaXNTdWNjZXNzID0gIWVycm9yOwoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCS8vIEV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0IGFuZCBub3JtYWxpemUgZm9yIG5vbi1hYm9ydHMKCQkJCWVycm9yID0gc3RhdHVzVGV4dDsKCQkJCWlmICggc3RhdHVzIHx8ICFzdGF0dXNUZXh0ICkgewoJCQkJCXN0YXR1c1RleHQgPSAiZXJyb3IiOwoJCQkJCWlmICggc3RhdHVzIDwgMCApIHsKCQkJCQkJc3RhdHVzID0gMDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CgkJCWpxWEhSLnN0YXR1cyA9IHN0YXR1czsKCQkJanFYSFIuc3RhdHVzVGV4dCA9ICggbmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0ICkgKyAiIjsKCgkJCS8vIFN1Y2Nlc3MvRXJyb3IKCQkJaWYgKCBpc1N1Y2Nlc3MgKSB7CgkJCQlkZWZlcnJlZC5yZXNvbHZlV2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIHN1Y2Nlc3MsIHN0YXR1c1RleHQsIGpxWEhSIF0gKTsKCQkJfSBlbHNlIHsKCQkJCWRlZmVycmVkLnJlamVjdFdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCwgZXJyb3IgXSApOwoJCQl9CgoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlqcVhIUi5zdGF0dXNDb2RlKCBzdGF0dXNDb2RlICk7CgkJCXN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoIGlzU3VjY2VzcyA/ICJhamF4U3VjY2VzcyIgOiAiYWpheEVycm9yIiwKCQkJCQlbIGpxWEhSLCBzLCBpc1N1Y2Nlc3MgPyBzdWNjZXNzIDogZXJyb3IgXSApOwoJCQl9CgoJCQkvLyBDb21wbGV0ZQoJCQljb21wbGV0ZURlZmVycmVkLmZpcmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsganFYSFIsIHN0YXR1c1RleHQgXSApOwoKCQkJaWYgKCBmaXJlR2xvYmFscyApIHsKCQkJCWdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCAiYWpheENvbXBsZXRlIiwgWyBqcVhIUiwgcyBdICk7CgoJCQkJLy8gSGFuZGxlIHRoZSBnbG9iYWwgQUpBWCBjb3VudGVyCgkJCQlpZiAoICEoIC0talF1ZXJ5LmFjdGl2ZSApICkgewoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyKCAiYWpheFN0b3AiICk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBqcVhIUjsKCX0sCgoJZ2V0SlNPTjogZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIiApOwoJfSwKCglnZXRTY3JpcHQ6IGZ1bmN0aW9uKCB1cmwsIGNhbGxiYWNrICkgewoJCXJldHVybiBqUXVlcnkuZ2V0KCB1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiICk7Cgl9Cn0gKTsKCmpRdWVyeS5lYWNoKCBbICJnZXQiLCAicG9zdCIgXSwgZnVuY3Rpb24oIGksIG1ldGhvZCApIHsKCWpRdWVyeVsgbWV0aG9kIF0gPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSApIHsKCgkJLy8gU2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKCQlpZiAoIGlzRnVuY3Rpb24oIGRhdGEgKSApIHsKCQkJdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CgkJCWNhbGxiYWNrID0gZGF0YTsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIFRoZSB1cmwgY2FuIGJlIGFuIG9wdGlvbnMgb2JqZWN0ICh3aGljaCB0aGVuIG11c3QgaGF2ZSAudXJsKQoJCXJldHVybiBqUXVlcnkuYWpheCggalF1ZXJ5LmV4dGVuZCggewoJCQl1cmw6IHVybCwKCQkJdHlwZTogbWV0aG9kLAoJCQlkYXRhVHlwZTogdHlwZSwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2sKCQl9LCBqUXVlcnkuaXNQbGFpbk9iamVjdCggdXJsICkgJiYgdXJsICkgKTsKCX07Cn0gKTsKCgpqUXVlcnkuX2V2YWxVcmwgPSBmdW5jdGlvbiggdXJsICkgewoJcmV0dXJuIGpRdWVyeS5hamF4KCB7CgkJdXJsOiB1cmwsCgoJCS8vIE1ha2UgdGhpcyBleHBsaWNpdCwgc2luY2UgdXNlciBjYW4gb3ZlcnJpZGUgdGhpcyB0aHJvdWdoIGFqYXhTZXR1cCAoIzExMjY0KQoJCXR5cGU6ICJHRVQiLAoJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQljYWNoZTogdHJ1ZSwKCQlhc3luYzogZmFsc2UsCgkJZ2xvYmFsOiBmYWxzZSwKCQkidGhyb3dzIjogdHJ1ZQoJfSApOwp9OwoKCmpRdWVyeS5mbi5leHRlbmQoIHsKCXdyYXBBbGw6IGZ1bmN0aW9uKCBodG1sICkgewoJCXZhciB3cmFwOwoKCQlpZiAoIHRoaXNbIDAgXSApIHsKCQkJaWYgKCBpc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCQlodG1sID0gaHRtbC5jYWxsKCB0aGlzWyAwIF0gKTsKCQkJfQoKCQkJLy8gVGhlIGVsZW1lbnRzIHRvIHdyYXAgdGhlIHRhcmdldCBhcm91bmQKCQkJd3JhcCA9IGpRdWVyeSggaHRtbCwgdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgKS5lcSggMCApLmNsb25lKCB0cnVlICk7CgoJCQlpZiAoIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgewoJCQkJd3JhcC5pbnNlcnRCZWZvcmUoIHRoaXNbIDAgXSApOwoJCQl9CgoJCQl3cmFwLm1hcCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9IHRoaXM7CgoJCQkJd2hpbGUgKCBlbGVtLmZpcnN0RWxlbWVudENoaWxkICkgewoJCQkJCWVsZW0gPSBlbGVtLmZpcnN0RWxlbWVudENoaWxkOwoJCQkJfQoKCQkJCXJldHVybiBlbGVtOwoJCQl9ICkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGlzRnVuY3Rpb24oIGh0bWwgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS53cmFwSW5uZXIoIGh0bWwuY2FsbCggdGhpcywgaSApICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IGpRdWVyeSggdGhpcyApLAoJCQkJY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CgoJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCApIHsKCQkJCWNvbnRlbnRzLndyYXBBbGwoIGh0bWwgKTsKCgkJCX0gZWxzZSB7CgkJCQlzZWxmLmFwcGVuZCggaHRtbCApOwoJCQl9CgkJfSApOwoJfSwKCgl3cmFwOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgaHRtbElzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKCBodG1sICk7CgoJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBodG1sSXNGdW5jdGlvbiA/IGh0bWwuY2FsbCggdGhpcywgaSApIDogaHRtbCApOwoJCX0gKTsKCX0sCgoJdW53cmFwOiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdGhpcy5wYXJlbnQoIHNlbGVjdG9yICkubm90KCAiYm9keSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5KCB0aGlzICkucmVwbGFjZVdpdGgoIHRoaXMuY2hpbGROb2RlcyApOwoJCX0gKTsKCQlyZXR1cm4gdGhpczsKCX0KfSApOwoKCmpRdWVyeS5leHByLnBzZXVkb3MuaGlkZGVuID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4gIWpRdWVyeS5leHByLnBzZXVkb3MudmlzaWJsZSggZWxlbSApOwp9OwpqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUgPSBmdW5jdGlvbiggZWxlbSApIHsKCXJldHVybiAhISggZWxlbS5vZmZzZXRXaWR0aCB8fCBlbGVtLm9mZnNldEhlaWdodCB8fCBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoICk7Cn07CgoKCgpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwoJfSBjYXRjaCAoIGUgKSB7fQp9OwoKdmFyIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CgoJCS8vIEZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCgkJMDogMjAwLAoKCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQoJCS8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAoJCTEyMjM6IDIwNAoJfSwKCXhoclN1cHBvcnRlZCA9IGpRdWVyeS5hamF4U2V0dGluZ3MueGhyKCk7CgpzdXBwb3J0LmNvcnMgPSAhIXhoclN1cHBvcnRlZCAmJiAoICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZCApOwpzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKCmpRdWVyeS5hamF4VHJhbnNwb3J0KCBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXZhciBjYWxsYmFjaywgZXJyb3JDYWxsYmFjazsKCgkvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CglpZiAoIHN1cHBvcnQuY29ycyB8fCB4aHJTdXBwb3J0ZWQgJiYgIW9wdGlvbnMuY3Jvc3NEb21haW4gKSB7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIGhlYWRlcnMsIGNvbXBsZXRlICkgewoJCQkJdmFyIGksCgkJCQkJeGhyID0gb3B0aW9ucy54aHIoKTsKCgkJCQl4aHIub3BlbigKCQkJCQlvcHRpb25zLnR5cGUsCgkJCQkJb3B0aW9ucy51cmwsCgkJCQkJb3B0aW9ucy5hc3luYywKCQkJCQlvcHRpb25zLnVzZXJuYW1lLAoJCQkJCW9wdGlvbnMucGFzc3dvcmQKCQkJCSk7CgoJCQkJLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAoJCQkJaWYgKCBvcHRpb25zLnhockZpZWxkcyApIHsKCQkJCQlmb3IgKCBpIGluIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCQl4aHJbIGkgXSA9IG9wdGlvbnMueGhyRmllbGRzWyBpIF07CgkJCQkJfQoJCQkJfQoKCQkJCS8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKCQkJCWlmICggb3B0aW9ucy5taW1lVHlwZSAmJiB4aHIub3ZlcnJpZGVNaW1lVHlwZSApIHsKCQkJCQl4aHIub3ZlcnJpZGVNaW1lVHlwZSggb3B0aW9ucy5taW1lVHlwZSApOwoJCQkJfQoKCQkJCS8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCgkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCgkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCWlmICggIW9wdGlvbnMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdICkgewoJCQkJCWhlYWRlcnNbICJYLVJlcXVlc3RlZC1XaXRoIiBdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCQkJCX0KCgkJCQkvLyBTZXQgaGVhZGVycwoJCQkJZm9yICggaSBpbiBoZWFkZXJzICkgewoJCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKCBpLCBoZWFkZXJzWyBpIF0gKTsKCQkJCX0KCgkJCQkvLyBDYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQljYWxsYmFjayA9IGVycm9yQ2FsbGJhY2sgPSB4aHIub25sb2FkID0KCQkJCQkJCQl4aHIub25lcnJvciA9IHhoci5vbmFib3J0ID0geGhyLm9udGltZW91dCA9CgkJCQkJCQkJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwoKCQkJCQkJCWlmICggdHlwZSA9PT0gImFib3J0IiApIHsKCQkJCQkJCQl4aHIuYWJvcnQoKTsKCQkJCQkJCX0gZWxzZSBpZiAoIHR5cGUgPT09ICJlcnJvciIgKSB7CgoJCQkJCQkJCS8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CgkJCQkJCQkJLy8gT24gYSBtYW51YWwgbmF0aXZlIGFib3J0LCBJRTkgdGhyb3dzCgkJCQkJCQkJLy8gZXJyb3JzIG9uIGFueSBwcm9wZXJ0eSBhY2Nlc3MgdGhhdCBpcyBub3QgcmVhZHlTdGF0ZQoJCQkJCQkJCWlmICggdHlwZW9mIHhoci5zdGF0dXMgIT09ICJudW1iZXIiICkgewoJCQkJCQkJCQljb21wbGV0ZSggMCwgImVycm9yIiApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWNvbXBsZXRlKAoKCQkJCQkJCQkJCS8vIEZpbGU6IHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIDA7IHNlZSAjODYwNSwgIzE0MjA3CgkJCQkJCQkJCQl4aHIuc3RhdHVzLAoJCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQKCQkJCQkJCQkJKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQl4aHJTdWNjZXNzU3RhdHVzWyB4aHIuc3RhdHVzIF0gfHwgeGhyLnN0YXR1cywKCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQsCgoJCQkJCQkJCQkvLyBTdXBwb3J0OiBJRSA8PTkgb25seQoJCQkJCQkJCQkvLyBJRTkgaGFzIG5vIFhIUjIgYnV0IHRocm93cyBvbiBiaW5hcnkgKHRyYWMtMTE0MjYpCgkJCQkJCQkJCS8vIEZvciBYSFIyIG5vbi10ZXh0LCBsZXQgdGhlIGNhbGxlciBoYW5kbGUgaXQgKGdoLTI0OTgpCgkJCQkJCQkJCSggeGhyLnJlc3BvbnNlVHlwZSB8fCAidGV4dCIgKSAhPT0gInRleHQiICB8fAoJCQkJCQkJCQl0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCAhPT0gInN0cmluZyIgPwoJCQkJCQkJCQkJeyBiaW5hcnk6IHhoci5yZXNwb25zZSB9IDoKCQkJCQkJCQkJCXsgdGV4dDogeGhyLnJlc3BvbnNlVGV4dCB9LAoJCQkJCQkJCQl4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKCQkJCQkJCQkpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfTsKCQkJCX07CgoJCQkJLy8gTGlzdGVuIHRvIGV2ZW50cwoJCQkJeGhyLm9ubG9hZCA9IGNhbGxiYWNrKCk7CgkJCQllcnJvckNhbGxiYWNrID0geGhyLm9uZXJyb3IgPSB4aHIub250aW1lb3V0ID0gY2FsbGJhY2soICJlcnJvciIgKTsKCgkJCQkvLyBTdXBwb3J0OiBJRSA5IG9ubHkKCQkJCS8vIFVzZSBvbnJlYWR5c3RhdGVjaGFuZ2UgdG8gcmVwbGFjZSBvbmFib3J0CgkJCQkvLyB0byBoYW5kbGUgdW5jYXVnaHQgYWJvcnRzCgkJCQlpZiAoIHhoci5vbmFib3J0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJeGhyLm9uYWJvcnQgPSBlcnJvckNhbGxiYWNrOwoJCQkJfSBlbHNlIHsKCQkJCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgoJCQkJCQkvLyBDaGVjayByZWFkeVN0YXRlIGJlZm9yZSB0aW1lb3V0IGFzIGl0IGNoYW5nZXMKCQkJCQkJaWYgKCB4aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKCgkJCQkJCQkvLyBBbGxvdyBvbmVycm9yIHRvIGJlIGNhbGxlZCBmaXJzdCwKCQkJCQkJCS8vIGJ1dCB0aGF0IHdpbGwgbm90IGhhbmRsZSBhIG5hdGl2ZSBhYm9ydAoJCQkJCQkJLy8gQWxzbywgc2F2ZSBlcnJvckNhbGxiYWNrIHRvIGEgdmFyaWFibGUKCQkJCQkJCS8vIGFzIHhoci5vbmVycm9yIGNhbm5vdCBiZSBhY2Nlc3NlZAoJCQkJCQkJd2luZG93LnNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQkJCWVycm9yQ2FsbGJhY2soKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9OwoJCQkJfQoKCQkJCS8vIENyZWF0ZSB0aGUgYWJvcnQgY2FsbGJhY2sKCQkJCWNhbGxiYWNrID0gY2FsbGJhY2soICJhYm9ydCIgKTsKCgkJCQl0cnkgewoKCQkJCQkvLyBEbyBzZW5kIHRoZSByZXF1ZXN0ICh0aGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24pCgkJCQkJeGhyLnNlbmQoIG9wdGlvbnMuaGFzQ29udGVudCAmJiBvcHRpb25zLmRhdGEgfHwgbnVsbCApOwoJCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJCS8vICMxNDY4MzogT25seSByZXRocm93IGlmIHRoaXMgaGFzbid0IGJlZW4gbm90aWZpZWQgYXMgYW4gZXJyb3IgeWV0CgkJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQkJdGhyb3cgZTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhYm9ydDogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrKCk7CgkJCQl9CgkJCX0KCQl9OwoJfQp9ICk7CgoKCgovLyBQcmV2ZW50IGF1dG8tZXhlY3V0aW9uIG9mIHNjcmlwdHMgd2hlbiBubyBleHBsaWNpdCBkYXRhVHlwZSB3YXMgcHJvdmlkZWQgKFNlZSBnaC0yNDMyKQpqUXVlcnkuYWpheFByZWZpbHRlciggZnVuY3Rpb24oIHMgKSB7CglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJcy5jb250ZW50cy5zY3JpcHQgPSBmYWxzZTsKCX0KfSApOwoKLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKalF1ZXJ5LmFqYXhTZXR1cCggewoJYWNjZXB0czogewoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgIiArCgkJCSJhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCgl9LAoJY29udGVudHM6IHsKCQlzY3JpcHQ6IC9cYig/OmphdmF8ZWNtYSlzY3JpcHRcYi8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSApOwoKLy8gSGFuZGxlIGNhY2hlJ3Mgc3BlY2lhbCBjYXNlIGFuZCBjcm9zc0RvbWFpbgpqUXVlcnkuYWpheFByZWZpbHRlciggInNjcmlwdCIsIGZ1bmN0aW9uKCBzICkgewoJaWYgKCBzLmNhY2hlID09PSB1bmRlZmluZWQgKSB7CgkJcy5jYWNoZSA9IGZhbHNlOwoJfQoJaWYgKCBzLmNyb3NzRG9tYWluICkgewoJCXMudHlwZSA9ICJHRVQiOwoJfQp9ICk7CgovLyBCaW5kIHNjcmlwdCB0YWcgaGFjayB0cmFuc3BvcnQKalF1ZXJ5LmFqYXhUcmFuc3BvcnQoICJzY3JpcHQiLCBmdW5jdGlvbiggcyApIHsKCgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJdmFyIHNjcmlwdCwgY2FsbGJhY2s7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIF8sIGNvbXBsZXRlICkgewoJCQkJc2NyaXB0ID0galF1ZXJ5KCAiPHNjcmlwdD4iICkucHJvcCggewoJCQkJCWNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwKCQkJCQlzcmM6IHMudXJsCgkJCQl9ICkub24oCgkJCQkJImxvYWQgZXJyb3IiLAoJCQkJCWNhbGxiYWNrID0gZnVuY3Rpb24oIGV2dCApIHsKCQkJCQkJc2NyaXB0LnJlbW92ZSgpOwoJCQkJCQljYWxsYmFjayA9IG51bGw7CgkJCQkJCWlmICggZXZ0ICkgewoJCQkJCQkJY29tcGxldGUoIGV2dC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwLCBldnQudHlwZSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJKTsKCgkJCQkvLyBVc2UgbmF0aXZlIERPTSBtYW5pcHVsYXRpb24gdG8gYXZvaWQgb3VyIGRvbU1hbmlwIEFKQVggdHJpY2tlcnkKCQkJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoIHNjcmlwdFsgMCBdICk7CgkJCX0sCgkJCWFib3J0OiBmdW5jdGlvbigpIHsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2soKTsKCQkJCX0KCQkJfQoJCX07Cgl9Cn0gKTsKCgoKCnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoIHsKCWpzb25wOiAiY2FsbGJhY2siLAoJanNvbnBDYWxsYmFjazogZnVuY3Rpb24oKSB7CgkJdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8ICggalF1ZXJ5LmV4cGFuZG8gKyAiXyIgKyAoIG5vbmNlKysgKSApOwoJCXRoaXNbIGNhbGxiYWNrIF0gPSB0cnVlOwoJCXJldHVybiBjYWxsYmFjazsKCX0KfSApOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCgl2YXIgY2FsbGJhY2tOYW1lLCBvdmVyd3JpdHRlbiwgcmVzcG9uc2VDb250YWluZXIsCgkJanNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KCQkJInVybCIgOgoJCQl0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJgoJCQkJKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkKCQkJCQkuaW5kZXhPZiggImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgKSA9PT0gMCAmJgoJCQkJcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgoJCSk7CgoJLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKCWlmICgganNvblByb3AgfHwgcy5kYXRhVHlwZXNbIDAgXSA9PT0gImpzb25wIiApIHsKCgkJLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAoJCWNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGlzRnVuY3Rpb24oIHMuanNvbnBDYWxsYmFjayApID8KCQkJcy5qc29ucENhbGxiYWNrKCkgOgoJCQlzLmpzb25wQ2FsbGJhY2s7CgoJCS8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKCQlpZiAoIGpzb25Qcm9wICkgewoJCQlzWyBqc29uUHJvcCBdID0gc1sganNvblByb3AgXS5yZXBsYWNlKCByanNvbnAsICIkMSIgKyBjYWxsYmFja05hbWUgKTsKCQl9IGVsc2UgaWYgKCBzLmpzb25wICE9PSBmYWxzZSApIHsKCQkJcy51cmwgKz0gKCBycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsKCQl9CgoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KCQlzLmNvbnZlcnRlcnNbICJzY3JpcHQganNvbiIgXSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFyZXNwb25zZUNvbnRhaW5lciApIHsKCQkJCWpRdWVyeS5lcnJvciggY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIgKTsKCQkJfQoJCQlyZXR1cm4gcmVzcG9uc2VDb250YWluZXJbIDAgXTsKCQl9OwoKCQkvLyBGb3JjZSBqc29uIGRhdGFUeXBlCgkJcy5kYXRhVHlwZXNbIDAgXSA9ICJqc29uIjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFjawoJCW92ZXJ3cml0dGVuID0gd2luZG93WyBjYWxsYmFja05hbWUgXTsKCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gZnVuY3Rpb24oKSB7CgkJCXJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwoJCX07CgoJCS8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQoJCWpxWEhSLmFsd2F5cyggZnVuY3Rpb24oKSB7CgoJCQkvLyBJZiBwcmV2aW91cyB2YWx1ZSBkaWRuJ3QgZXhpc3QgLSByZW1vdmUgaXQKCQkJaWYgKCBvdmVyd3JpdHRlbiA9PT0gdW5kZWZpbmVkICkgewoJCQkJalF1ZXJ5KCB3aW5kb3cgKS5yZW1vdmVQcm9wKCBjYWxsYmFja05hbWUgKTsKCgkJCS8vIE90aGVyd2lzZSByZXN0b3JlIHByZWV4aXN0aW5nIHZhbHVlCgkJCX0gZWxzZSB7CgkJCQl3aW5kb3dbIGNhbGxiYWNrTmFtZSBdID0gb3ZlcndyaXR0ZW47CgkJCX0KCgkJCS8vIFNhdmUgYmFjayBhcyBmcmVlCgkJCWlmICggc1sgY2FsbGJhY2tOYW1lIF0gKSB7CgoJCQkJLy8gTWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCgkJCQlzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgoJCQkJLy8gU2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQoJCQkJb2xkQ2FsbGJhY2tzLnB1c2goIGNhbGxiYWNrTmFtZSApOwoJCQl9CgoJCQkvLyBDYWxsIGlmIGl0IHdhcyBhIGZ1bmN0aW9uIGFuZCB3ZSBoYXZlIGEgcmVzcG9uc2UKCQkJaWYgKCByZXNwb25zZUNvbnRhaW5lciAmJiBpc0Z1bmN0aW9uKCBvdmVyd3JpdHRlbiApICkgewoJCQkJb3ZlcndyaXR0ZW4oIHJlc3BvbnNlQ29udGFpbmVyWyAwIF0gKTsKCQkJfQoKCQkJcmVzcG9uc2VDb250YWluZXIgPSBvdmVyd3JpdHRlbiA9IHVuZGVmaW5lZDsKCQl9ICk7CgoJCS8vIERlbGVnYXRlIHRvIHNjcmlwdAoJCXJldHVybiAic2NyaXB0IjsKCX0KfSApOwoKCgoKLy8gU3VwcG9ydDogU2FmYXJpIDggb25seQovLyBJbiBTYWZhcmkgOCBkb2N1bWVudHMgY3JlYXRlZCB2aWEgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50Ci8vIGNvbGxhcHNlIHNpYmxpbmcgZm9ybXM6IHRoZSBzZWNvbmQgb25lIGJlY29tZXMgYSBjaGlsZCBvZiB0aGUgZmlyc3Qgb25lLgovLyBCZWNhdXNlIG9mIHRoYXQsIHRoaXMgc2VjdXJpdHkgbWVhc3VyZSBoYXMgdG8gYmUgZGlzYWJsZWQgaW4gU2FmYXJpIDguCi8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMzczMzcKc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQgPSAoIGZ1bmN0aW9uKCkgewoJdmFyIGJvZHkgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoICIiICkuYm9keTsKCWJvZHkuaW5uZXJIVE1MID0gIjxmb3JtPjwvZm9ybT48Zm9ybT48L2Zvcm0+IjsKCXJldHVybiBib2R5LmNoaWxkTm9kZXMubGVuZ3RoID09PSAyOwp9ICkoKTsKCgovLyBBcmd1bWVudCAiZGF0YSIgc2hvdWxkIGJlIHN0cmluZyBvZiBodG1sCi8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwKLy8gZGVmYXVsdHMgdG8gZG9jdW1lbnQKLy8ga2VlcFNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwpqUXVlcnkucGFyc2VIVE1MID0gZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewoJaWYgKCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIFtdOwoJfQoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCWtlZXBTY3JpcHRzID0gY29udGV4dDsKCQljb250ZXh0ID0gZmFsc2U7Cgl9CgoJdmFyIGJhc2UsIHBhcnNlZCwgc2NyaXB0czsKCglpZiAoICFjb250ZXh0ICkgewoKCQkvLyBTdG9wIHNjcmlwdHMgb3IgaW5saW5lIGV2ZW50IGhhbmRsZXJzIGZyb20gYmVpbmcgZXhlY3V0ZWQgaW1tZWRpYXRlbHkKCQkvLyBieSB1c2luZyBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbgoJCWlmICggc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQgKSB7CgkJCWNvbnRleHQgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoICIiICk7CgoJCQkvLyBTZXQgdGhlIGJhc2UgaHJlZiBmb3IgdGhlIGNyZWF0ZWQgZG9jdW1lbnQKCQkJLy8gc28gYW55IHBhcnNlZCBlbGVtZW50cyB3aXRoIFVSTHMKCQkJLy8gYXJlIGJhc2VkIG9uIHRoZSBkb2N1bWVudCdzIFVSTCAoZ2gtMjk2NSkKCQkJYmFzZSA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCggImJhc2UiICk7CgkJCWJhc2UuaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgkJCWNvbnRleHQuaGVhZC5hcHBlbmRDaGlsZCggYmFzZSApOwoJCX0gZWxzZSB7CgkJCWNvbnRleHQgPSBkb2N1bWVudDsKCQl9Cgl9CgoJcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKCBkYXRhICk7CglzY3JpcHRzID0gIWtlZXBTY3JpcHRzICYmIFtdOwoKCS8vIFNpbmdsZSB0YWcKCWlmICggcGFyc2VkICkgewoJCXJldHVybiBbIGNvbnRleHQuY3JlYXRlRWxlbWVudCggcGFyc2VkWyAxIF0gKSBdOwoJfQoKCXBhcnNlZCA9IGJ1aWxkRnJhZ21lbnQoIFsgZGF0YSBdLCBjb250ZXh0LCBzY3JpcHRzICk7CgoJaWYgKCBzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoICkgewoJCWpRdWVyeSggc2NyaXB0cyApLnJlbW92ZSgpOwoJfQoKCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwp9OwoKCi8qKgogKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlCiAqLwpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7Cgl2YXIgc2VsZWN0b3IsIHR5cGUsIHJlc3BvbnNlLAoJCXNlbGYgPSB0aGlzLAoJCW9mZiA9IHVybC5pbmRleE9mKCAiICIgKTsKCglpZiAoIG9mZiA+IC0xICkgewoJCXNlbGVjdG9yID0gc3RyaXBBbmRDb2xsYXBzZSggdXJsLnNsaWNlKCBvZmYgKSApOwoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7Cgl9CgoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uCglpZiAoIGlzRnVuY3Rpb24oIHBhcmFtcyApICkgewoKCQkvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawoJCWNhbGxiYWNrID0gcGFyYW1zOwoJCXBhcmFtcyA9IHVuZGVmaW5lZDsKCgkvLyBPdGhlcndpc2UsIGJ1aWxkIGEgcGFyYW0gc3RyaW5nCgl9IGVsc2UgaWYgKCBwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgKSB7CgkJdHlwZSA9ICJQT1NUIjsKCX0KCgkvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAoJaWYgKCBzZWxmLmxlbmd0aCA+IDAgKSB7CgkJalF1ZXJ5LmFqYXgoIHsKCQkJdXJsOiB1cmwsCgoJCQkvLyBJZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQuCgkJCS8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQoJCQkvLyB1c2VyIGNhbiBvdmVycmlkZSBpdCB0aHJvdWdoIGFqYXhTZXR1cCBtZXRob2QKCQkJdHlwZTogdHlwZSB8fCAiR0VUIiwKCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJZGF0YTogcGFyYW1zCgkJfSApLmRvbmUoIGZ1bmN0aW9uKCByZXNwb25zZVRleHQgKSB7CgoJCQkvLyBTYXZlIHJlc3BvbnNlIGZvciB1c2UgaW4gY29tcGxldGUgY2FsbGJhY2sKCQkJcmVzcG9uc2UgPSBhcmd1bWVudHM7CgoJCQlzZWxmLmh0bWwoIHNlbGVjdG9yID8KCgkJCQkvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKCQkJCS8vIEV4Y2x1ZGUgc2NyaXB0cyB0byBhdm9pZCBJRSAnUGVybWlzc2lvbiBEZW5pZWQnIGVycm9ycwoJCQkJalF1ZXJ5KCAiPGRpdj4iICkuYXBwZW5kKCBqUXVlcnkucGFyc2VIVE1MKCByZXNwb25zZVRleHQgKSApLmZpbmQoIHNlbGVjdG9yICkgOgoKCQkJCS8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CgkJCQlyZXNwb25zZVRleHQgKTsKCgkJLy8gSWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMsIHRoaXMgZnVuY3Rpb24gZ2V0cyAiZGF0YSIsICJzdGF0dXMiLCAianFYSFIiCgkJLy8gYnV0IHRoZXkgYXJlIGlnbm9yZWQgYmVjYXVzZSByZXNwb25zZSB3YXMgc2V0IGFib3ZlLgoJCS8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciIKCQl9ICkuYWx3YXlzKCBjYWxsYmFjayAmJiBmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJc2VsZi5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLCByZXNwb25zZSB8fCBbIGpxWEhSLnJlc3BvbnNlVGV4dCwgc3RhdHVzLCBqcVhIUiBdICk7CgkJCX0gKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgoKCgovLyBBdHRhY2ggYSBidW5jaCBvZiBmdW5jdGlvbnMgZm9yIGhhbmRsaW5nIGNvbW1vbiBBSkFYIGV2ZW50cwpqUXVlcnkuZWFjaCggWwoJImFqYXhTdGFydCIsCgkiYWpheFN0b3AiLAoJImFqYXhDb21wbGV0ZSIsCgkiYWpheEVycm9yIiwKCSJhamF4U3VjY2VzcyIsCgkiYWpheFNlbmQiCl0sIGZ1bmN0aW9uKCBpLCB0eXBlICkgewoJalF1ZXJ5LmZuWyB0eXBlIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9ICk7CgoKCgpqUXVlcnkuZXhwci5wc2V1ZG9zLmFuaW1hdGVkID0gZnVuY3Rpb24oIGVsZW0gKSB7CglyZXR1cm4galF1ZXJ5LmdyZXAoIGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCX0gKS5sZW5ndGg7Cn07CgoKCgpqUXVlcnkub2Zmc2V0ID0gewoJc2V0T2Zmc2V0OiBmdW5jdGlvbiggZWxlbSwgb3B0aW9ucywgaSApIHsKCQl2YXIgY3VyUG9zaXRpb24sIGN1ckxlZnQsIGN1ckNTU1RvcCwgY3VyVG9wLCBjdXJPZmZzZXQsIGN1ckNTU0xlZnQsIGNhbGN1bGF0ZVBvc2l0aW9uLAoJCQlwb3NpdGlvbiA9IGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSwKCQkJY3VyRWxlbSA9IGpRdWVyeSggZWxlbSApLAoJCQlwcm9wcyA9IHt9OwoKCQkvLyBTZXQgcG9zaXRpb24gZmlyc3QsIGluLWNhc2UgdG9wL2xlZnQgYXJlIHNldCBldmVuIG9uIHN0YXRpYyBlbGVtCgkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCWVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCgkJY3VyT2Zmc2V0ID0gY3VyRWxlbS5vZmZzZXQoKTsKCQljdXJDU1NUb3AgPSBqUXVlcnkuY3NzKCBlbGVtLCAidG9wIiApOwoJCWN1ckNTU0xlZnQgPSBqUXVlcnkuY3NzKCBlbGVtLCAibGVmdCIgKTsKCQljYWxjdWxhdGVQb3NpdGlvbiA9ICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSAmJgoJCQkoIGN1ckNTU1RvcCArIGN1ckNTU0xlZnQgKS5pbmRleE9mKCAiYXV0byIgKSA+IC0xOwoKCQkvLyBOZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlcgoJCS8vIHRvcCBvciBsZWZ0IGlzIGF1dG8gYW5kIHBvc2l0aW9uIGlzIGVpdGhlciBhYnNvbHV0ZSBvciBmaXhlZAoJCWlmICggY2FsY3VsYXRlUG9zaXRpb24gKSB7CgkJCWN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwoJCQljdXJUb3AgPSBjdXJQb3NpdGlvbi50b3A7CgkJCWN1ckxlZnQgPSBjdXJQb3NpdGlvbi5sZWZ0OwoKCQl9IGVsc2UgewoJCQljdXJUb3AgPSBwYXJzZUZsb2F0KCBjdXJDU1NUb3AgKSB8fCAwOwoJCQljdXJMZWZ0ID0gcGFyc2VGbG9hdCggY3VyQ1NTTGVmdCApIHx8IDA7CgkJfQoKCQlpZiAoIGlzRnVuY3Rpb24oIG9wdGlvbnMgKSApIHsKCgkJCS8vIFVzZSBqUXVlcnkuZXh0ZW5kIGhlcmUgdG8gYWxsb3cgbW9kaWZpY2F0aW9uIG9mIGNvb3JkaW5hdGVzIGFyZ3VtZW50IChnaC0xODQ4KQoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBqUXVlcnkuZXh0ZW5kKCB7fSwgY3VyT2Zmc2V0ICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJLy8gb2Zmc2V0KCkgcmVsYXRlcyBhbiBlbGVtZW50J3MgYm9yZGVyIGJveCB0byB0aGUgZG9jdW1lbnQgb3JpZ2luCglvZmZzZXQ6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkvLyBQcmVzZXJ2ZSBjaGFpbmluZyBmb3Igc2V0dGVyCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJCXRoaXMgOgoJCQkJdGhpcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJCQlqUXVlcnkub2Zmc2V0LnNldE9mZnNldCggdGhpcywgb3B0aW9ucywgaSApOwoJCQkJfSApOwoJCX0KCgkJdmFyIHJlY3QsIHdpbiwKCQkJZWxlbSA9IHRoaXNbIDAgXTsKCgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmV0dXJuIHplcm9zIGZvciBkaXNjb25uZWN0ZWQgYW5kIGhpZGRlbiAoZGlzcGxheTogbm9uZSkgZWxlbWVudHMgKGdoLTIzMTApCgkJLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CgkJLy8gUnVubmluZyBnZXRCb3VuZGluZ0NsaWVudFJlY3Qgb24gYQoJCS8vIGRpc2Nvbm5lY3RlZCBub2RlIGluIElFIHRocm93cyBhbiBlcnJvcgoJCWlmICggIWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGggKSB7CgkJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJLy8gR2V0IGRvY3VtZW50LXJlbGF0aXZlIHBvc2l0aW9uIGJ5IGFkZGluZyB2aWV3cG9ydCBzY3JvbGwgdG8gdmlld3BvcnQtcmVsYXRpdmUgZ0JDUgoJCXJlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCXdpbiA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsKCQlyZXR1cm4gewoJCQl0b3A6IHJlY3QudG9wICsgd2luLnBhZ2VZT2Zmc2V0LAoJCQlsZWZ0OiByZWN0LmxlZnQgKyB3aW4ucGFnZVhPZmZzZXQKCQl9OwoJfSwKCgkvLyBwb3NpdGlvbigpIHJlbGF0ZXMgYW4gZWxlbWVudCdzIG1hcmdpbiBib3ggdG8gaXRzIG9mZnNldCBwYXJlbnQncyBwYWRkaW5nIGJveAoJLy8gVGhpcyBjb3JyZXNwb25kcyB0byB0aGUgYmVoYXZpb3Igb2YgQ1NTIGFic29sdXRlIHBvc2l0aW9uaW5nCglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpc1sgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgb2Zmc2V0UGFyZW50LCBvZmZzZXQsIGRvYywKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJcGFyZW50T2Zmc2V0ID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCgkJLy8gcG9zaXRpb246Zml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHRoZSB2aWV3cG9ydCwgd2hpY2ggaXRzZWxmIGFsd2F5cyBoYXMgemVybyBvZmZzZXQKCQlpZiAoIGpRdWVyeS5jc3MoIGVsZW0sICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIiApIHsKCgkJCS8vIEFzc3VtZSBwb3NpdGlvbjpmaXhlZCBpbXBsaWVzIGF2YWlsYWJpbGl0eSBvZiBnZXRCb3VuZGluZ0NsaWVudFJlY3QKCQkJb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCgkJfSBlbHNlIHsKCQkJb2Zmc2V0ID0gdGhpcy5vZmZzZXQoKTsKCgkJCS8vIEFjY291bnQgZm9yIHRoZSAqcmVhbCogb2Zmc2V0IHBhcmVudCwgd2hpY2ggY2FuIGJlIHRoZSBkb2N1bWVudCBvciBpdHMgcm9vdCBlbGVtZW50CgkJCS8vIHdoZW4gYSBzdGF0aWNhbGx5IHBvc2l0aW9uZWQgZWxlbWVudCBpcyBpZGVudGlmaWVkCgkJCWRvYyA9IGVsZW0ub3duZXJEb2N1bWVudDsKCQkJb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQgfHwgZG9jLmRvY3VtZW50RWxlbWVudDsKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYKCQkJCSggb2Zmc2V0UGFyZW50ID09PSBkb2MuYm9keSB8fCBvZmZzZXRQYXJlbnQgPT09IGRvYy5kb2N1bWVudEVsZW1lbnQgKSAmJgoJCQkJalF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50LCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoKCQkJCW9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5wYXJlbnROb2RlOwoJCQl9CgkJCWlmICggb2Zmc2V0UGFyZW50ICYmIG9mZnNldFBhcmVudCAhPT0gZWxlbSAmJiBvZmZzZXRQYXJlbnQubm9kZVR5cGUgPT09IDEgKSB7CgoJCQkJLy8gSW5jb3Jwb3JhdGUgYm9yZGVycyBpbnRvIGl0cyBvZmZzZXQsIHNpbmNlIHRoZXkgYXJlIG91dHNpZGUgaXRzIGNvbnRlbnQgb3JpZ2luCgkJCQlwYXJlbnRPZmZzZXQgPSBqUXVlcnkoIG9mZnNldFBhcmVudCApLm9mZnNldCgpOwoJCQkJcGFyZW50T2Zmc2V0LnRvcCArPSBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJCXBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3MoIG9mZnNldFBhcmVudCwgImJvcmRlckxlZnRXaWR0aCIsIHRydWUgKTsKCQkJfQoJCX0KCgkJLy8gU3VidHJhY3QgcGFyZW50IG9mZnNldHMgYW5kIGVsZW1lbnQgbWFyZ2lucwoJCXJldHVybiB7CgkJCXRvcDogb2Zmc2V0LnRvcCAtIHBhcmVudE9mZnNldC50b3AgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luVG9wIiwgdHJ1ZSApLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCAtIHBhcmVudE9mZnNldC5sZWZ0IC0galF1ZXJ5LmNzcyggZWxlbSwgIm1hcmdpbkxlZnQiLCB0cnVlICkKCQl9OwoJfSwKCgkvLyBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBkb2N1bWVudEVsZW1lbnQgaW4gdGhlIGZvbGxvd2luZyBjYXNlczoKCS8vIDEpIEZvciB0aGUgZWxlbWVudCBpbnNpZGUgdGhlIGlmcmFtZSB3aXRob3V0IG9mZnNldFBhcmVudCwgdGhpcyBtZXRob2Qgd2lsbCByZXR1cm4KCS8vICAgIGRvY3VtZW50RWxlbWVudCBvZiB0aGUgcGFyZW50IHdpbmRvdwoJLy8gMikgRm9yIHRoZSBoaWRkZW4gb3IgZGV0YWNoZWQgZWxlbWVudAoJLy8gMykgRm9yIGJvZHkgb3IgaHRtbCBlbGVtZW50LCBpLmUuIGluIGNhc2Ugb2YgdGhlIGh0bWwgbm9kZSAtIGl0IHdpbGwgcmV0dXJuIGl0c2VsZgoJLy8KCS8vIGJ1dCB0aG9zZSBleGNlcHRpb25zIHdlcmUgbmV2ZXIgcHJlc2VudGVkIGFzIGEgcmVhbCBsaWZlIHVzZS1jYXNlcwoJLy8gYW5kIG1pZ2h0IGJlIGNvbnNpZGVyZWQgYXMgbW9yZSBwcmVmZXJhYmxlIHJlc3VsdHMuCgkvLwoJLy8gVGhpcyBsb2dpYywgaG93ZXZlciwgaXMgbm90IGd1YXJhbnRlZWQgYW5kIGNhbiBjaGFuZ2UgYXQgYW55IHBvaW50IGluIHRoZSBmdXR1cmUKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50OwoKCQkJd2hpbGUgKCBvZmZzZXRQYXJlbnQgJiYgalF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50LCAicG9zaXRpb24iICkgPT09ICJzdGF0aWMiICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoKCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CgkJfSApOwoJfQp9ICk7CgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHsgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0Iiwgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIHByb3AgKSB7Cgl2YXIgdG9wID0gInBhZ2VZT2Zmc2V0IiA9PT0gcHJvcDsKCglqUXVlcnkuZm5bIG1ldGhvZCBdID0gZnVuY3Rpb24oIHZhbCApIHsKCQlyZXR1cm4gYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgbWV0aG9kLCB2YWwgKSB7CgoJCQkvLyBDb2FsZXNjZSBkb2N1bWVudHMgYW5kIHdpbmRvd3MKCQkJdmFyIHdpbjsKCQkJaWYgKCBpc1dpbmRvdyggZWxlbSApICkgewoJCQkJd2luID0gZWxlbTsKCQkJfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCXdpbiA9IGVsZW0uZGVmYXVsdFZpZXc7CgkJCX0KCgkJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gd2luID8gd2luWyBwcm9wIF0gOiBlbGVtWyBtZXRob2QgXTsKCQkJfQoKCQkJaWYgKCB3aW4gKSB7CgkJCQl3aW4uc2Nyb2xsVG8oCgkJCQkJIXRvcCA/IHZhbCA6IHdpbi5wYWdlWE9mZnNldCwKCQkJCQl0b3AgPyB2YWwgOiB3aW4ucGFnZVlPZmZzZXQKCQkJCSk7CgoJCQl9IGVsc2UgewoJCQkJZWxlbVsgbWV0aG9kIF0gPSB2YWw7CgkJCX0KCQl9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCApOwoJfTsKfSApOwoKLy8gU3VwcG9ydDogU2FmYXJpIDw9NyAtIDkuMSwgQ2hyb21lIDw9MzcgLSA0OQovLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgovLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKLy8gQmxpbmsgYnVnOiBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD01ODkzNDcKLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodDsKLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKalF1ZXJ5LmVhY2goIFsgInRvcCIsICJsZWZ0IiBdLCBmdW5jdGlvbiggaSwgcHJvcCApIHsKCWpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gYWRkR2V0SG9va0lmKCBzdXBwb3J0LnBpeGVsUG9zaXRpb24sCgkJZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQlpZiAoIGNvbXB1dGVkICkgewoJCQkJY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKCgkJCQkvLyBJZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CgkJCQkJalF1ZXJ5KCBlbGVtICkucG9zaXRpb24oKVsgcHJvcCBdICsgInB4IiA6CgkJCQkJY29tcHV0ZWQ7CgkJCX0KCQl9CgkpOwp9ICk7CgoKLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LAoJCWZ1bmN0aW9uKCBkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lICkgewoKCQkvLyBNYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBhY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCB2YWx1ZSApIHsKCQkJCXZhciBkb2M7CgoJCQkJaWYgKCBpc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyAkKCB3aW5kb3cgKS5vdXRlcldpZHRoL0hlaWdodCByZXR1cm4gdy9oIGluY2x1ZGluZyBzY3JvbGxiYXJzIChnaC0xNzI5KQoJCQkJCXJldHVybiBmdW5jTmFtZS5pbmRleE9mKCAib3V0ZXIiICkgPT09IDAgPwoJCQkJCQllbGVtWyAiaW5uZXIiICsgbmFtZSBdIDoKCQkJCQkJZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwoJCQkJfQoKCQkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQlkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLAoJCQkJCS8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCXJldHVybiBNYXRoLm1heCgKCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwKCQkJCQkJZWxlbS5ib2R5WyAib2Zmc2V0IiArIG5hbWUgXSwgZG9jWyAib2Zmc2V0IiArIG5hbWUgXSwKCQkJCQkJZG9jWyAiY2xpZW50IiArIG5hbWUgXQoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoKCQkJCQkvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CgkJCQkJalF1ZXJ5LmNzcyggZWxlbSwgdHlwZSwgZXh0cmEgKSA6CgoJCQkJCS8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKCQkJCQlqUXVlcnkuc3R5bGUoIGVsZW0sIHR5cGUsIHZhbHVlLCBleHRyYSApOwoJCQl9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSApOwoJCX07Cgl9ICk7Cn0gKTsKCgpqUXVlcnkuZWFjaCggKCAiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IHJlc2l6ZSBzY3JvbGwgY2xpY2sgZGJsY2xpY2sgIiArCgkibW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgIiArCgkiY2hhbmdlIHNlbGVjdCBzdWJtaXQga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBjb250ZXh0bWVudSIgKS5zcGxpdCggIiAiICksCglmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkvLyBIYW5kbGUgZXZlbnQgYmluZGluZwoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZGF0YSwgZm4gKSB7CgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8KCQkJdGhpcy5vbiggbmFtZSwgbnVsbCwgZGF0YSwgZm4gKSA6CgkJCXRoaXMudHJpZ2dlciggbmFtZSApOwoJfTsKfSApOwoKalF1ZXJ5LmZuLmV4dGVuZCggewoJaG92ZXI6IGZ1bmN0aW9uKCBmbk92ZXIsIGZuT3V0ICkgewoJCXJldHVybiB0aGlzLm1vdXNlZW50ZXIoIGZuT3ZlciApLm1vdXNlbGVhdmUoIGZuT3V0IHx8IGZuT3ZlciApOwoJfQp9ICk7CgoKCgpqUXVlcnkuZm4uZXh0ZW5kKCB7CgoJYmluZDogZnVuY3Rpb24oIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIG51bGwsIGRhdGEsIGZuICk7Cgl9LAoJdW5iaW5kOiBmdW5jdGlvbiggdHlwZXMsIGZuICkgewoJCXJldHVybiB0aGlzLm9mZiggdHlwZXMsIG51bGwsIGZuICk7Cgl9LAoKCWRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vbiggdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiApOwoJfSwKCXVuZGVsZWdhdGU6IGZ1bmN0aW9uKCBzZWxlY3RvciwgdHlwZXMsIGZuICkgewoKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPwoJCQl0aGlzLm9mZiggc2VsZWN0b3IsICIqKiIgKSA6CgkJCXRoaXMub2ZmKCB0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCX0KfSApOwoKLy8gQmluZCBhIGZ1bmN0aW9uIHRvIGEgY29udGV4dCwgb3B0aW9uYWxseSBwYXJ0aWFsbHkgYXBwbHlpbmcgYW55Ci8vIGFyZ3VtZW50cy4KLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQovLyBIb3dldmVyLCBpdCBpcyBub3Qgc2xhdGVkIGZvciByZW1vdmFsIGFueSB0aW1lIHNvb24KalF1ZXJ5LnByb3h5ID0gZnVuY3Rpb24oIGZuLCBjb250ZXh0ICkgewoJdmFyIHRtcCwgYXJncywgcHJveHk7CgoJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gInN0cmluZyIgKSB7CgkJdG1wID0gZm5bIGNvbnRleHQgXTsKCQljb250ZXh0ID0gZm47CgkJZm4gPSB0bXA7Cgl9CgoJLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKCS8vIHRoaXMgdGhyb3dzIGEgVHlwZUVycm9yLCBidXQgd2Ugd2lsbCBqdXN0IHJldHVybiB1bmRlZmluZWQuCglpZiAoICFpc0Z1bmN0aW9uKCBmbiApICkgewoJCXJldHVybiB1bmRlZmluZWQ7Cgl9CgoJLy8gU2ltdWxhdGVkIGJpbmQKCWFyZ3MgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKCXByb3h5ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZuLmFwcGx5KCBjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KCBzbGljZS5jYWxsKCBhcmd1bWVudHMgKSApICk7Cgl9OwoKCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJcHJveHkuZ3VpZCA9IGZuLmd1aWQgPSBmbi5ndWlkIHx8IGpRdWVyeS5ndWlkKys7CgoJcmV0dXJuIHByb3h5Owp9OwoKalF1ZXJ5LmhvbGRSZWFkeSA9IGZ1bmN0aW9uKCBob2xkICkgewoJaWYgKCBob2xkICkgewoJCWpRdWVyeS5yZWFkeVdhaXQrKzsKCX0gZWxzZSB7CgkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7Cgl9Cn07CmpRdWVyeS5pc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKalF1ZXJ5LnBhcnNlSlNPTiA9IEpTT04ucGFyc2U7CmpRdWVyeS5ub2RlTmFtZSA9IG5vZGVOYW1lOwpqUXVlcnkuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CmpRdWVyeS5pc1dpbmRvdyA9IGlzV2luZG93OwpqUXVlcnkuY2FtZWxDYXNlID0gY2FtZWxDYXNlOwpqUXVlcnkudHlwZSA9IHRvVHlwZTsKCmpRdWVyeS5ub3cgPSBEYXRlLm5vdzsKCmpRdWVyeS5pc051bWVyaWMgPSBmdW5jdGlvbiggb2JqICkgewoKCS8vIEFzIG9mIGpRdWVyeSAzLjAsIGlzTnVtZXJpYyBpcyBsaW1pdGVkIHRvCgkvLyBzdHJpbmdzIGFuZCBudW1iZXJzIChwcmltaXRpdmVzIG9yIG9iamVjdHMpCgkvLyB0aGF0IGNhbiBiZSBjb2VyY2VkIHRvIGZpbml0ZSBudW1iZXJzIChnaC0yNjYyKQoJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggb2JqICk7CglyZXR1cm4gKCB0eXBlID09PSAibnVtYmVyIiB8fCB0eXBlID09PSAic3RyaW5nIiApICYmCgoJCS8vIHBhcnNlRmxvYXQgTmFOcyBudW1lcmljLWNhc3QgZmFsc2UgcG9zaXRpdmVzICgiIikKCQkvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQoJCS8vIHN1YnRyYWN0aW9uIGZvcmNlcyBpbmZpbml0aWVzIHRvIE5hTgoJCSFpc05hTiggb2JqIC0gcGFyc2VGbG9hdCggb2JqICkgKTsKfTsKCgoKCi8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgovLyBmaWxlcyB0aGF0IG1heSB1c2UgZGVmaW5lLCBidXQgbm90IHZpYSBhIHByb3BlciBjb25jYXRlbmF0aW9uIHNjcmlwdCB0aGF0Ci8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdAovLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCi8vIGRlcml2ZWQgZnJvbSBmaWxlIG5hbWVzLCBhbmQgalF1ZXJ5IGlzIG5vcm1hbGx5IGRlbGl2ZXJlZCBpbiBhIGxvd2VyY2FzZQovLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMKLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgoKLy8gTm90ZSB0aGF0IGZvciBtYXhpbXVtIHBvcnRhYmlsaXR5LCBsaWJyYXJpZXMgdGhhdCBhcmUgbm90IGpRdWVyeSBzaG91bGQKLy8gZGVjbGFyZSB0aGVtc2VsdmVzIGFzIGFub255bW91cyBtb2R1bGVzLCBhbmQgYXZvaWQgc2V0dGluZyBhIGdsb2JhbCBpZiBhbgovLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQovLyBodHRwczovL2dpdGh1Yi5jb20vanJidXJrZS9yZXF1aXJlanMvd2lraS9VcGRhdGluZy1leGlzdGluZy1saWJyYXJpZXMjd2lraS1hbm9uCgppZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbigpIHsKCQlyZXR1cm4galF1ZXJ5OwoJfSApOwp9CgoKCgp2YXIKCgkvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAoKCS8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCglfJCA9IHdpbmRvdy4kOwoKalF1ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiggZGVlcCApIHsKCWlmICggd2luZG93LiQgPT09IGpRdWVyeSApIHsKCQl3aW5kb3cuJCA9IF8kOwoJfQoKCWlmICggZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkgKSB7CgkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7Cgl9CgoJcmV0dXJuIGpRdWVyeTsKfTsKCi8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4gQU1ECi8vICgjNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQppZiAoICFub0dsb2JhbCApIHsKCXdpbmRvdy5qUXVlcnkgPSB3aW5kb3cuJCA9IGpRdWVyeTsKfQoKCgoKcmV0dXJuIGpRdWVyeTsKfSApOwoKOyhmdW5jdGlvbigpIHsKLyohCiAqIEBvdmVydmlldyAgRW1iZXIgLSBKYXZhU2NyaXB0IEFwcGxpY2F0aW9uIEZyYW1ld29yawogKiBAY29weXJpZ2h0IENvcHlyaWdodCAyMDExLTIwMTggVGlsZGUgSW5jLiBhbmQgY29udHJpYnV0b3JzCiAqICAgICAgICAgICAgUG9ydGlvbnMgQ29weXJpZ2h0IDIwMDYtMjAxMSBTdHJvYmUgSW5jLgogKiAgICAgICAgICAgIFBvcnRpb25zIENvcHlyaWdodCAyMDA4LTIwMTEgQXBwbGUgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBAbGljZW5zZSAgIExpY2Vuc2VkIHVuZGVyIE1JVCBsaWNlbnNlCiAqICAgICAgICAgICAgU2VlIGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20vZW1iZXJqcy9lbWJlci5qcy9tYXN0ZXIvTElDRU5TRQogKiBAdmVyc2lvbiAgIDMuMy4xCiAqLwoKLypnbG9iYWxzIHByb2Nlc3MgKi8KdmFyIGVuaWZlZCwgcmVxdWlyZU1vZHVsZSwgRW1iZXI7CgovLyBVc2VkIGluIGVtYmVyLWVudmlyb25tZW50L2xpYi9nbG9iYWwuanMKbWFpbkNvbnRleHQgPSB0aGlzOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCgooZnVuY3Rpb24oKSB7CiAgZnVuY3Rpb24gbWlzc2luZ01vZHVsZShuYW1lLCByZWZlcnJlck5hbWUpIHsKICAgIGlmIChyZWZlcnJlck5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBtb2R1bGUgJyArIG5hbWUgKyAnIHJlcXVpcmVkIGJ5OiAnICsgcmVmZXJyZXJOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgbW9kdWxlICcgKyBuYW1lKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGludGVybmFsUmVxdWlyZShfbmFtZSwgcmVmZXJyZXJOYW1lKSB7CiAgICB2YXIgbmFtZSA9IF9uYW1lOwogICAgdmFyIG1vZCA9IHJlZ2lzdHJ5W25hbWVdOwoKICAgIGlmICghbW9kKSB7CiAgICAgIG5hbWUgPSBuYW1lICsgJy9pbmRleCc7CiAgICAgIG1vZCA9IHJlZ2lzdHJ5W25hbWVdOwogICAgfQoKICAgIHZhciBleHBvcnRzID0gc2VlbltuYW1lXTsKCiAgICBpZiAoZXhwb3J0cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiBleHBvcnRzOwogICAgfQoKICAgIGV4cG9ydHMgPSBzZWVuW25hbWVdID0ge307CgogICAgaWYgKCFtb2QpIHsKICAgICAgbWlzc2luZ01vZHVsZShfbmFtZSwgcmVmZXJyZXJOYW1lKTsKICAgIH0KCiAgICB2YXIgZGVwcyA9IG1vZC5kZXBzOwogICAgdmFyIGNhbGxiYWNrID0gbW9kLmNhbGxiYWNrOwogICAgdmFyIHJlaWZpZWQgPSBuZXcgQXJyYXkoZGVwcy5sZW5ndGgpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVwcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoZGVwc1tpXSA9PT0gJ2V4cG9ydHMnKSB7CiAgICAgICAgcmVpZmllZFtpXSA9IGV4cG9ydHM7CiAgICAgIH0gZWxzZSBpZiAoZGVwc1tpXSA9PT0gJ3JlcXVpcmUnKSB7CiAgICAgICAgcmVpZmllZFtpXSA9IHJlcXVpcmVNb2R1bGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVpZmllZFtpXSA9IGludGVybmFsUmVxdWlyZShkZXBzW2ldLCBuYW1lKTsKICAgICAgfQogICAgfQoKICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIHJlaWZpZWQpOwoKICAgIHJldHVybiBleHBvcnRzOwogIH0KCiAgdmFyIGlzTm9kZSA9CiAgICB0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJyAmJgogICAgdHlwZW9mIHByb2Nlc3MgIT09ICd1bmRlZmluZWQnICYmCiAgICB7fS50b1N0cmluZy5jYWxsKHByb2Nlc3MpID09PSAnW29iamVjdCBwcm9jZXNzXSc7CgogIGlmICghaXNOb2RlKSB7CiAgICBFbWJlciA9IHRoaXMuRW1iZXIgPSB0aGlzLkVtYmVyIHx8IHt9OwogIH0KCiAgaWYgKHR5cGVvZiBFbWJlciA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIEVtYmVyID0ge307CiAgfQoKICBpZiAodHlwZW9mIEVtYmVyLl9fbG9hZGVyID09PSAndW5kZWZpbmVkJykgewogICAgdmFyIHJlZ2lzdHJ5ID0ge307CiAgICB2YXIgc2VlbiA9IHt9OwoKICAgIGVuaWZlZCA9IGZ1bmN0aW9uKG5hbWUsIGRlcHMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciB2YWx1ZSA9IHt9OwoKICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgIHZhbHVlLmRlcHMgPSBbXTsKICAgICAgICB2YWx1ZS5jYWxsYmFjayA9IGRlcHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUuZGVwcyA9IGRlcHM7CiAgICAgICAgdmFsdWUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgfQoKICAgICAgcmVnaXN0cnlbbmFtZV0gPSB2YWx1ZTsKICAgIH07CgogICAgcmVxdWlyZU1vZHVsZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgcmV0dXJuIGludGVybmFsUmVxdWlyZShuYW1lLCBudWxsKTsKICAgIH07CgogICAgLy8gc2V0dXAgYHJlcXVpcmVgIG1vZHVsZQogICAgcmVxdWlyZU1vZHVsZVsnZGVmYXVsdCddID0gcmVxdWlyZU1vZHVsZTsKCiAgICByZXF1aXJlTW9kdWxlLmhhcyA9IGZ1bmN0aW9uIHJlZ2lzdHJ5SGFzKG1vZHVsZU5hbWUpIHsKICAgICAgcmV0dXJuICEhcmVnaXN0cnlbbW9kdWxlTmFtZV0gfHwgISFyZWdpc3RyeVttb2R1bGVOYW1lICsgJy9pbmRleCddOwogICAgfTsKCiAgICByZXF1aXJlTW9kdWxlLl9lYWtfc2VlbiA9IHJlZ2lzdHJ5OwoKICAgIEVtYmVyLl9fbG9hZGVyID0gewogICAgICBkZWZpbmU6IGVuaWZlZCwKICAgICAgcmVxdWlyZTogcmVxdWlyZU1vZHVsZSwKICAgICAgcmVnaXN0cnk6IHJlZ2lzdHJ5LAogICAgfTsKICB9IGVsc2UgewogICAgZW5pZmVkID0gRW1iZXIuX19sb2FkZXIuZGVmaW5lOwogICAgcmVxdWlyZU1vZHVsZSA9IEVtYmVyLl9fbG9hZGVyLnJlcXVpcmU7CiAgfQp9KSgpOwoKZW5pZmVkKCdAZW1iZXIvYXBwbGljYXRpb24vZ2xvYmFscy1yZXNvbHZlcicsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdlbWJlci11dGlscycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZGVidWcnLCAnQGVtYmVyL3N0cmluZycsICdlbWJlci1ydW50aW1lJywgJ0BlbWJlci9hcHBsaWNhdGlvbi9saWIvdmFsaWRhdGUtdHlwZScsICdlbWJlci1nbGltbWVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX2VtYmVyVXRpbHMsIF9lbWJlck1ldGFsLCBfZGVidWcsIF9zdHJpbmcsIF9lbWJlclJ1bnRpbWUsIF92YWxpZGF0ZVR5cGUsIF9lbWJlckdsaW1tZXIpIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBEZWZhdWx0UmVzb2x2ZXIgPSBmdW5jdGlvbiAoX0VtYmVyT2JqZWN0KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKERlZmF1bHRSZXNvbHZlciwgX0VtYmVyT2JqZWN0KTsKCiAgICBmdW5jdGlvbiBEZWZhdWx0UmVzb2x2ZXIocHJvcHMpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBEZWZhdWx0UmVzb2x2ZXIpOwoKICAgICAgaWYgKHByb3BzID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZSBtaXNzaW5nIHByb3BzJyk7CiAgICAgIH0KICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRW1iZXJPYmplY3QuY2FsbCh0aGlzLCBwcm9wcykpOwogICAgfQoKICAgIERlZmF1bHRSZXNvbHZlci5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocHJvcHMpIHsKICAgICAgaWYgKHByb3BzID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0YXRpYyBjcmVhdGUgbWlzc2luZyBwcm9wcycpOwogICAgICB9CiAgICAgIHJldHVybiBfRW1iZXJPYmplY3QuY3JlYXRlLmNhbGwodGhpcywgcHJvcHMpOwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiBpbml0KCkgewogICAgICBpZiAodGhpcy5uYW1lc3BhY2UgPT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignaW5pdCBtaXNzaW5nIG5hbWVzcGFjZScpOwogICAgICB9CiAgICAgIHRoaXMuX3BhcnNlTmFtZUNhY2hlID0gKDAsIF9lbWJlclV0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uIG5vcm1hbGl6ZShmdWxsTmFtZSkgewogICAgICB2YXIgX2Z1bGxOYW1lJHNwbGl0ID0gZnVsbE5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgIHR5cGUgPSBfZnVsbE5hbWUkc3BsaXRbMF0sCiAgICAgICAgICBuYW1lID0gX2Z1bGxOYW1lJHNwbGl0WzFdOwoKICAgICAgKHRydWUgJiYgIShmdWxsTmFtZS5zcGxpdCgnOicpLmxlbmd0aCA9PT0gMikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUcmllZCB0byBub3JtYWxpemUgYSBjb250YWluZXIgbmFtZSB3aXRob3V0IGEgY29sb24gKDopIGluIGl0LiAnICsgJ1lvdSBwcm9iYWJseSB0cmllZCB0byBsb29rdXAgYSBuYW1lIHRoYXQgZGlkIG5vdCBjb250YWluIGEgdHlwZSwgJyArICdhIGNvbG9uLCBhbmQgYSBuYW1lLiBBIHByb3BlciBsb29rdXAgbmFtZSB3b3VsZCBiZSBgdmlldzpwb3N0YC4nLCBmdWxsTmFtZS5zcGxpdCgnOicpLmxlbmd0aCA9PT0gMikpOwoKCiAgICAgIGlmICh0eXBlICE9PSAndGVtcGxhdGUnKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IG5hbWUucmVwbGFjZSgvKFwufF98LSkuL2csIGZ1bmN0aW9uIChtKSB7CiAgICAgICAgICByZXR1cm4gbS5jaGFyQXQoMSkudG9VcHBlckNhc2UoKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHR5cGUgKyAnOicgKyByZXN1bHQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICB9CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoZnVsbE5hbWUpIHsKICAgICAgdmFyIHBhcnNlZE5hbWUgPSB0aGlzLnBhcnNlTmFtZShmdWxsTmFtZSk7CiAgICAgIHZhciByZXNvbHZlTWV0aG9kTmFtZSA9IHBhcnNlZE5hbWUucmVzb2x2ZU1ldGhvZE5hbWU7CiAgICAgIHZhciByZXNvbHZlZCA9IHZvaWQgMDsKCiAgICAgIGlmICh0aGlzW3Jlc29sdmVNZXRob2ROYW1lXSkgewogICAgICAgIHJlc29sdmVkID0gdGhpc1tyZXNvbHZlTWV0aG9kTmFtZV0ocGFyc2VkTmFtZSk7CiAgICAgIH0KCiAgICAgIHJlc29sdmVkID0gcmVzb2x2ZWQgfHwgdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CgogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChwYXJzZWROYW1lLnJvb3QgJiYgcGFyc2VkTmFtZS5yb290LkxPR19SRVNPTFZFUikgewogICAgICAgICAgdGhpcy5fbG9nTG9va3VwKHJlc29sdmVkLCBwYXJzZWROYW1lKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChyZXNvbHZlZCkgewogICAgICAgICgwLCBfdmFsaWRhdGVUeXBlLmRlZmF1bHQpKHJlc29sdmVkLCBwYXJzZWROYW1lKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc29sdmVkOwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLnBhcnNlTmFtZSA9IGZ1bmN0aW9uIHBhcnNlTmFtZShmdWxsTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5fcGFyc2VOYW1lQ2FjaGVbZnVsbE5hbWVdIHx8ICh0aGlzLl9wYXJzZU5hbWVDYWNoZVtmdWxsTmFtZV0gPSB0aGlzLl9wYXJzZU5hbWUoZnVsbE5hbWUpKTsKICAgIH07CgogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS5fcGFyc2VOYW1lID0gZnVuY3Rpb24gX3BhcnNlTmFtZShmdWxsTmFtZSkgewogICAgICB2YXIgX2Z1bGxOYW1lJHNwbGl0MiA9IGZ1bGxOYW1lLnNwbGl0KCc6JyksCiAgICAgICAgICB0eXBlID0gX2Z1bGxOYW1lJHNwbGl0MlswXSwKICAgICAgICAgIGZ1bGxOYW1lV2l0aG91dFR5cGUgPSBfZnVsbE5hbWUkc3BsaXQyWzFdOwoKICAgICAgdmFyIG5hbWUgPSBmdWxsTmFtZVdpdGhvdXRUeXBlOwogICAgICB2YXIgbmFtZXNwYWNlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ25hbWVzcGFjZScpOwogICAgICB2YXIgcm9vdCA9IG5hbWVzcGFjZTsKICAgICAgdmFyIGxhc3RTbGFzaEluZGV4ID0gbmFtZS5sYXN0SW5kZXhPZignLycpOwogICAgICB2YXIgZGlybmFtZSA9IGxhc3RTbGFzaEluZGV4ICE9PSAtMSA/IG5hbWUuc2xpY2UoMCwgbGFzdFNsYXNoSW5kZXgpIDogbnVsbDsKCiAgICAgIGlmICh0eXBlICE9PSAndGVtcGxhdGUnICYmIGxhc3RTbGFzaEluZGV4ICE9PSAtMSkgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJy8nKTsKICAgICAgICBuYW1lID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIG5hbWVzcGFjZU5hbWUgPSAoMCwgX3N0cmluZy5jYXBpdGFsaXplKShwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignLicpKTsKICAgICAgICByb290ID0gKDAsIF9lbWJlck1ldGFsLmZpbmROYW1lc3BhY2UpKG5hbWVzcGFjZU5hbWUpOwoKICAgICAgICAodHJ1ZSAmJiAhKHJvb3QpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGFyZSBsb29raW5nIGZvciBhICcgKyBuYW1lICsgJyAnICsgdHlwZSArICcgaW4gdGhlICcgKyBuYW1lc3BhY2VOYW1lICsgJyBuYW1lc3BhY2UsIGJ1dCB0aGUgbmFtZXNwYWNlIGNvdWxkIG5vdCBiZSBmb3VuZCcsIHJvb3QpKTsKICAgICAgfQoKICAgICAgdmFyIHJlc29sdmVNZXRob2ROYW1lID0gZnVsbE5hbWVXaXRob3V0VHlwZSA9PT0gJ21haW4nID8gJ01haW4nIDogKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHR5cGUpOwoKICAgICAgaWYgKCEobmFtZSAmJiB0eXBlKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgZnVsbE5hbWU6IGAnICsgZnVsbE5hbWUgKyAnYCwgbXVzdCBiZSBvZiB0aGUgZm9ybSBgdHlwZTpuYW1lYCAnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBmdWxsTmFtZTogZnVsbE5hbWUsCiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBmdWxsTmFtZVdpdGhvdXRUeXBlOiBmdWxsTmFtZVdpdGhvdXRUeXBlLAogICAgICAgIGRpcm5hbWU6IGRpcm5hbWUsCiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICByb290OiByb290LAogICAgICAgIHJlc29sdmVNZXRob2ROYW1lOiAncmVzb2x2ZScgKyByZXNvbHZlTWV0aG9kTmFtZQogICAgICB9OwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLmxvb2t1cERlc2NyaXB0aW9uID0gZnVuY3Rpb24gbG9va3VwRGVzY3JpcHRpb24oZnVsbE5hbWUpIHsKICAgICAgdmFyIHBhcnNlZE5hbWUgPSB0aGlzLnBhcnNlTmFtZShmdWxsTmFtZSk7CiAgICAgIHZhciBkZXNjcmlwdGlvbiA9IHZvaWQgMDsKCiAgICAgIGlmIChwYXJzZWROYW1lLnR5cGUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICByZXR1cm4gJ3RlbXBsYXRlIGF0ICcgKyBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGUucmVwbGFjZSgvXC4vZywgJy8nKTsKICAgICAgfQoKICAgICAgZGVzY3JpcHRpb24gPSBwYXJzZWROYW1lLnJvb3QgKyAnLicgKyAoMCwgX3N0cmluZy5jbGFzc2lmeSkocGFyc2VkTmFtZS5uYW1lKS5yZXBsYWNlKC9cLi9nLCAnJyk7CgogICAgICBpZiAocGFyc2VkTmFtZS50eXBlICE9PSAnbW9kZWwnKSB7CiAgICAgICAgZGVzY3JpcHRpb24gKz0gKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHBhcnNlZE5hbWUudHlwZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBkZXNjcmlwdGlvbjsKICAgIH07CgogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS5tYWtlVG9TdHJpbmcgPSBmdW5jdGlvbiBtYWtlVG9TdHJpbmcoZmFjdG9yeSkgewogICAgICByZXR1cm4gZmFjdG9yeS50b1N0cmluZygpOwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLnVzZVJvdXRlck5hbWluZyA9IGZ1bmN0aW9uIHVzZVJvdXRlck5hbWluZyhwYXJzZWROYW1lKSB7CiAgICAgIGlmIChwYXJzZWROYW1lLm5hbWUgPT09ICdiYXNpYycpIHsKICAgICAgICBwYXJzZWROYW1lLm5hbWUgPSAnJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXJzZWROYW1lLm5hbWUgPSBwYXJzZWROYW1lLm5hbWUucmVwbGFjZSgvXC4vZywgJ18nKTsKICAgICAgfQogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLnJlc29sdmVUZW1wbGF0ZSA9IGZ1bmN0aW9uIHJlc29sdmVUZW1wbGF0ZShwYXJzZWROYW1lKSB7CiAgICAgIHZhciB0ZW1wbGF0ZU5hbWUgPSBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGUucmVwbGFjZSgvXC4vZywgJy8nKTsKCiAgICAgIHJldHVybiAoMCwgX2VtYmVyR2xpbW1lci5nZXRUZW1wbGF0ZSkodGVtcGxhdGVOYW1lKSB8fCAoMCwgX2VtYmVyR2xpbW1lci5nZXRUZW1wbGF0ZSkoKDAsIF9zdHJpbmcuZGVjYW1lbGl6ZSkodGVtcGxhdGVOYW1lKSk7CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZVZpZXcgPSBmdW5jdGlvbiByZXNvbHZlVmlldyhwYXJzZWROYW1lKSB7CiAgICAgIHRoaXMudXNlUm91dGVyTmFtaW5nKHBhcnNlZE5hbWUpOwogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZUNvbnRyb2xsZXIgPSBmdW5jdGlvbiByZXNvbHZlQ29udHJvbGxlcihwYXJzZWROYW1lKSB7CiAgICAgIHRoaXMudXNlUm91dGVyTmFtaW5nKHBhcnNlZE5hbWUpOwogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZVJvdXRlID0gZnVuY3Rpb24gcmVzb2x2ZVJvdXRlKHBhcnNlZE5hbWUpIHsKICAgICAgdGhpcy51c2VSb3V0ZXJOYW1pbmcocGFyc2VkTmFtZSk7CiAgICAgIHJldHVybiB0aGlzLnJlc29sdmVPdGhlcihwYXJzZWROYW1lKTsKICAgIH07CgogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS5yZXNvbHZlTW9kZWwgPSBmdW5jdGlvbiByZXNvbHZlTW9kZWwocGFyc2VkTmFtZSkgewogICAgICB2YXIgY2xhc3NOYW1lID0gKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHBhcnNlZE5hbWUubmFtZSk7CiAgICAgIHZhciBmYWN0b3J5ID0gKDAsIF9lbWJlck1ldGFsLmdldCkocGFyc2VkTmFtZS5yb290LCBjbGFzc05hbWUpOwoKICAgICAgcmV0dXJuIGZhY3Rvcnk7CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZUhlbHBlciA9IGZ1bmN0aW9uIHJlc29sdmVIZWxwZXIocGFyc2VkTmFtZSkgewogICAgICByZXR1cm4gdGhpcy5yZXNvbHZlT3RoZXIocGFyc2VkTmFtZSk7CiAgICB9OwoKICAgIERlZmF1bHRSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZU90aGVyID0gZnVuY3Rpb24gcmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShwYXJzZWROYW1lLm5hbWUpICsgKDAsIF9zdHJpbmcuY2xhc3NpZnkpKHBhcnNlZE5hbWUudHlwZSk7CiAgICAgIHZhciBmYWN0b3J5ID0gKDAsIF9lbWJlck1ldGFsLmdldCkocGFyc2VkTmFtZS5yb290LCBjbGFzc05hbWUpOwogICAgICByZXR1cm4gZmFjdG9yeTsKICAgIH07CgogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS5yZXNvbHZlTWFpbiA9IGZ1bmN0aW9uIHJlc29sdmVNYWluKHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICgwLCBfc3RyaW5nLmNsYXNzaWZ5KShwYXJzZWROYW1lLnR5cGUpOwogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkocGFyc2VkTmFtZS5yb290LCBjbGFzc05hbWUpOwogICAgfTsKCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLmtub3duRm9yVHlwZSA9IGZ1bmN0aW9uIGtub3duRm9yVHlwZSh0eXBlKSB7CiAgICAgIHZhciBuYW1lc3BhY2UgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbmFtZXNwYWNlJyk7CiAgICAgIHZhciBzdWZmaXggPSAoMCwgX3N0cmluZy5jbGFzc2lmeSkodHlwZSk7CiAgICAgIHZhciB0eXBlUmVnZXhwID0gbmV3IFJlZ0V4cChzdWZmaXggKyAnJCcpOwoKICAgICAgdmFyIGtub3duID0gKDAsIF9lbWJlclV0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgICB2YXIga25vd25LZXlzID0gT2JqZWN0LmtleXMobmFtZXNwYWNlKTsKICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGtub3duS2V5cy5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgICB2YXIgbmFtZSA9IGtub3duS2V5c1tpbmRleF07CgogICAgICAgIGlmICh0eXBlUmVnZXhwLnRlc3QobmFtZSkpIHsKICAgICAgICAgIHZhciBjb250YWluZXJOYW1lID0gdGhpcy50cmFuc2xhdGVUb0NvbnRhaW5lckZ1bGxuYW1lKHR5cGUsIG5hbWUpOwoKICAgICAgICAgIGtub3duW2NvbnRhaW5lck5hbWVdID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBrbm93bjsKICAgIH07CgogICAgRGVmYXVsdFJlc29sdmVyLnByb3RvdHlwZS50cmFuc2xhdGVUb0NvbnRhaW5lckZ1bGxuYW1lID0gZnVuY3Rpb24gdHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZSh0eXBlLCBuYW1lKSB7CiAgICAgIHZhciBzdWZmaXggPSAoMCwgX3N0cmluZy5jbGFzc2lmeSkodHlwZSk7CiAgICAgIHZhciBuYW1lUHJlZml4ID0gbmFtZS5zbGljZSgwLCBzdWZmaXgubGVuZ3RoICogLTEpOwogICAgICB2YXIgZGFzaGVyaXplZE5hbWUgPSAoMCwgX3N0cmluZy5kYXNoZXJpemUpKG5hbWVQcmVmaXgpOwoKICAgICAgcmV0dXJuIHR5cGUgKyAnOicgKyBkYXNoZXJpemVkTmFtZTsKICAgIH07CgogICAgcmV0dXJuIERlZmF1bHRSZXNvbHZlcjsKICB9KF9lbWJlclJ1bnRpbWUuT2JqZWN0KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gRGVmYXVsdFJlc29sdmVyOwoKCiAgaWYgKHRydWUpIHsKICAgIC8qKgogICAgICAgIEBtZXRob2QgX2xvZ0xvb2t1cAogICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gZm91bmQKICAgICAgICBAcGFyYW0ge09iamVjdH0gcGFyc2VkTmFtZQogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICBEZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLl9sb2dMb29rdXAgPSBmdW5jdGlvbiAoZm91bmQsIHBhcnNlZE5hbWUpIHsKICAgICAgdmFyIHN5bWJvbCA9IGZvdW5kID8gJ1vinJNdJyA6ICdbIF0nOwoKICAgICAgdmFyIHBhZGRpbmcgPSB2b2lkIDA7CiAgICAgIGlmIChwYXJzZWROYW1lLmZ1bGxOYW1lLmxlbmd0aCA+IDYwKSB7CiAgICAgICAgcGFkZGluZyA9ICcuJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYWRkaW5nID0gbmV3IEFycmF5KDYwIC0gcGFyc2VkTmFtZS5mdWxsTmFtZS5sZW5ndGgpLmpvaW4oJy4nKTsKICAgICAgfQoKICAgICAgKDAsIF9kZWJ1Zy5pbmZvKShzeW1ib2wsIHBhcnNlZE5hbWUuZnVsbE5hbWUsIHBhZGRpbmcsIHRoaXMubG9va3VwRGVzY3JpcHRpb24ocGFyc2VkTmFtZS5mdWxsTmFtZSkpOwogICAgfTsKICB9Cn0pOwplbmlmZWQoJ0BlbWJlci9hcHBsaWNhdGlvbi9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1vd25lcicsICdAZW1iZXIvYXBwbGljYXRpb24vbGliL2xhenlfbG9hZCcsICdAZW1iZXIvYXBwbGljYXRpb24vbGliL2FwcGxpY2F0aW9uJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJPd25lciwgX2xhenlfbG9hZCwgX2FwcGxpY2F0aW9uKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2dldE93bmVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2VtYmVyT3duZXIuZ2V0T3duZXI7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdzZXRPd25lcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9lbWJlck93bmVyLnNldE93bmVyOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnb25Mb2FkJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2xhenlfbG9hZC5vbkxvYWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdydW5Mb2FkSG9va3MnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbGF6eV9sb2FkLnJ1bkxvYWRIb29rczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19sb2FkZWQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbGF6eV9sb2FkLl9sb2FkZWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdkZWZhdWx0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FwcGxpY2F0aW9uLmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ0BlbWJlci9hcHBsaWNhdGlvbi9pbnN0YW5jZScsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdAZW1iZXIvcG9seWZpbGxzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLWJyb3dzZXItZW52aXJvbm1lbnQnLCAnZW1iZXItdmlld3MnLCAnQGVtYmVyL2VuZ2luZS9pbnN0YW5jZScsICdlbWJlci1nbGltbWVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX3BvbHlmaWxscywgX2VtYmVyTWV0YWwsIF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudCwgX2VtYmVyVmlld3MsIF9pbnN0YW5jZSwgX2VtYmVyR2xpbW1lcikgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICBUaGUgYEFwcGxpY2F0aW9uSW5zdGFuY2VgIGVuY2Fwc3VsYXRlcyBhbGwgb2YgdGhlIHN0YXRlZnVsIGFzcGVjdHMgb2YgYQogICAgcnVubmluZyBgQXBwbGljYXRpb25gLgogIAogICAgQXQgYSBoaWdoLWxldmVsLCB3ZSBicmVhayBhcHBsaWNhdGlvbiBib290IGludG8gdHdvIGRpc3RpbmN0IHBoYXNlczoKICAKICAgICogRGVmaW5pdGlvbiB0aW1lLCB3aGVyZSBhbGwgb2YgdGhlIGNsYXNzZXMsIHRlbXBsYXRlcywgYW5kIG90aGVyCiAgICAgIGRlcGVuZGVuY2llcyBhcmUgbG9hZGVkICh0eXBpY2FsbHkgaW4gdGhlIGJyb3dzZXIpLgogICAgKiBSdW4gdGltZSwgd2hlcmUgd2UgYmVnaW4gZXhlY3V0aW5nIHRoZSBhcHBsaWNhdGlvbiBvbmNlIGV2ZXJ5dGhpbmcKICAgICAgaGFzIGxvYWRlZC4KICAKICAgIERlZmluaXRpb24gdGltZSBjYW4gYmUgZXhwZW5zaXZlIGFuZCBvbmx5IG5lZWRzIHRvIGhhcHBlbiBvbmNlIHNpbmNlIGl0IGlzCiAgICBhbiBpZGVtcG90ZW50IG9wZXJhdGlvbi4gRm9yIGV4YW1wbGUsIGJldHdlZW4gdGVzdCBydW5zIGFuZCBGYXN0Qm9vdAogICAgcmVxdWVzdHMsIHRoZSBhcHBsaWNhdGlvbiBzdGF5cyB0aGUgc2FtZS4gSXQgaXMgb25seSB0aGUgc3RhdGUgdGhhdCB3ZSB3YW50CiAgICB0byByZXNldC4KICAKICAgIFRoYXQgc3RhdGUgaXMgd2hhdCB0aGUgYEFwcGxpY2F0aW9uSW5zdGFuY2VgIG1hbmFnZXM6IGl0IGlzIHJlc3BvbnNpYmxlIGZvcgogICAgY3JlYXRpbmcgdGhlIGNvbnRhaW5lciB0aGF0IGNvbnRhaW5zIGFsbCBhcHBsaWNhdGlvbiBzdGF0ZSwgYW5kIGRpc3Bvc2luZyBvZgogICAgaXQgb25jZSB0aGUgcGFydGljdWxhciB0ZXN0IHJ1biBvciBGYXN0Qm9vdCByZXF1ZXN0IGhhcyBmaW5pc2hlZC4KICAKICAgIEBwdWJsaWMKICAgIEBjbGFzcyBBcHBsaWNhdGlvbkluc3RhbmNlCiAgICBAZXh0ZW5kcyBFbmdpbmVJbnN0YW5jZQogICovCgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL2FwcGxpY2F0aW9uCiAgKi8KCiAgdmFyIEFwcGxpY2F0aW9uSW5zdGFuY2UgPSBfaW5zdGFuY2UuZGVmYXVsdC5leHRlbmQoewogICAgLyoqCiAgICAgIFRoZSBgQXBwbGljYXRpb25gIGZvciB3aGljaCB0aGlzIGlzIGFuIGluc3RhbmNlLgogICAgICAgQHByb3BlcnR5IHtBcHBsaWNhdGlvbn0gYXBwbGljYXRpb24KICAgICAgQHByaXZhdGUKICAgICovCiAgICBhcHBsaWNhdGlvbjogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIERPTSBldmVudHMgZm9yIHdoaWNoIHRoZSBldmVudCBkaXNwYXRjaGVyIHNob3VsZCBsaXN0ZW4uCiAgICAgICBCeSBkZWZhdWx0LCB0aGUgYXBwbGljYXRpb24ncyBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYCBsaXN0ZW5zCiAgICAgIGZvciBhIHNldCBvZiBzdGFuZGFyZCBET00gZXZlbnRzLCBzdWNoIGFzIGBtb3VzZWRvd25gIGFuZAogICAgICBga2V5dXBgLCBhbmQgZGVsZWdhdGVzIHRoZW0gdG8geW91ciBhcHBsaWNhdGlvbidzIGBFbWJlci5WaWV3YAogICAgICBpbnN0YW5jZXMuCiAgICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkge09iamVjdH0gY3VzdG9tRXZlbnRzCiAgICAqLwogICAgY3VzdG9tRXZlbnRzOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgcm9vdCBET00gZWxlbWVudCBvZiB0aGUgQXBwbGljYXRpb24gYXMgYW4gZWxlbWVudCBvciBhCiAgICAgIFtqUXVlcnktY29tcGF0aWJsZSBzZWxlY3RvcgogICAgICBzdHJpbmddKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jYXRlZ29yeS9zZWxlY3RvcnMvKS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSB7U3RyaW5nfERPTUVsZW1lbnR9IHJvb3RFbGVtZW50CiAgICAqLwogICAgcm9vdEVsZW1lbnQ6IG51bGwsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdGhpcy5hcHBsaWNhdGlvbi5fd2F0Y2hJbnN0YW5jZSh0aGlzKTsKCiAgICAgIC8vIFJlZ2lzdGVyIHRoaXMgaW5zdGFuY2UgaW4gdGhlIHBlci1pbnN0YW5jZSByZWdpc3RyeS4KICAgICAgLy8KICAgICAgLy8gV2h5IGRvIHdlIG5lZWQgdG8gcmVnaXN0ZXIgdGhlIGluc3RhbmNlIGluIHRoZSBmaXJzdCBwbGFjZT8KICAgICAgLy8gQmVjYXVzZSB3ZSBuZWVkIGEgZ29vZCB3YXkgZm9yIHRoZSByb290IHJvdXRlIChhLmsuYSBBcHBsaWNhdGlvblJvdXRlKQogICAgICAvLyB0byBub3RpZnkgdXMgd2hlbiBpdCBoYXMgY3JlYXRlZCB0aGUgcm9vdC1tb3N0IHZpZXcuIFRoYXQgdmlldyBpcyB0aGVuCiAgICAgIC8vIGFwcGVuZGVkIHRvIHRoZSByb290RWxlbWVudCwgaW4gdGhlIGNhc2Ugb2YgYXBwcywgdG8gdGhlIGZpeHR1cmUgaGFybmVzcwogICAgICAvLyBpbiB0ZXN0cywgb3IgcmVuZGVyZWQgdG8gYSBzdHJpbmcgaW4gdGhlIGNhc2Ugb2YgRmFzdEJvb3QuCiAgICAgIHRoaXMucmVnaXN0ZXIoJy1hcHBsaWNhdGlvbi1pbnN0YW5jZTptYWluJywgdGhpcywgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CiAgICB9LAogICAgX2Jvb3RTeW5jOiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICBpZiAodGhpcy5fYm9vdGVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBuZXcgQm9vdE9wdGlvbnMob3B0aW9ucyk7CgogICAgICB0aGlzLnNldHVwUmVnaXN0cnkob3B0aW9ucyk7CgogICAgICBpZiAob3B0aW9ucy5yb290RWxlbWVudCkgewogICAgICAgIHRoaXMucm9vdEVsZW1lbnQgPSBvcHRpb25zLnJvb3RFbGVtZW50OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucm9vdEVsZW1lbnQgPSB0aGlzLmFwcGxpY2F0aW9uLnJvb3RFbGVtZW50OwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5sb2NhdGlvbikgewogICAgICAgIHZhciByb3V0ZXIgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm91dGVyJyk7CiAgICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkocm91dGVyLCAnbG9jYXRpb24nLCBvcHRpb25zLmxvY2F0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy5hcHBsaWNhdGlvbi5ydW5JbnN0YW5jZUluaXRpYWxpemVycyh0aGlzKTsKCiAgICAgIGlmIChvcHRpb25zLmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICB0aGlzLnNldHVwRXZlbnREaXNwYXRjaGVyKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuX2Jvb3RlZCA9IHRydWU7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBzZXR1cFJlZ2lzdHJ5OiBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICB0aGlzLmNvbnN0cnVjdG9yLnNldHVwUmVnaXN0cnkodGhpcy5fX3JlZ2lzdHJ5X18sIG9wdGlvbnMpOwogICAgfSwKCgogICAgcm91dGVyOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMubG9va3VwKCdyb3V0ZXI6bWFpbicpOwogICAgfSkucmVhZE9ubHkoKSwKCiAgICBkaWRDcmVhdGVSb290VmlldzogZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgdmlldy5hcHBlbmRUbyh0aGlzLnJvb3RFbGVtZW50KTsKICAgIH0sCiAgICBzdGFydFJvdXRpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJvdXRlciA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyb3V0ZXInKTsKICAgICAgcm91dGVyLnN0YXJ0Um91dGluZygpOwogICAgICB0aGlzLl9kaWRTZXR1cFJvdXRlciA9IHRydWU7CiAgICB9LAogICAgc2V0dXBSb3V0ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuX2RpZFNldHVwUm91dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX2RpZFNldHVwUm91dGVyID0gdHJ1ZTsKCiAgICAgIHZhciByb3V0ZXIgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm91dGVyJyk7CiAgICAgIHJvdXRlci5zZXR1cFJvdXRlcigpOwogICAgfSwKICAgIGhhbmRsZVVSTDogZnVuY3Rpb24gKHVybCkgewogICAgICB2YXIgcm91dGVyID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3JvdXRlcicpOwoKICAgICAgdGhpcy5zZXR1cFJvdXRlcigpOwogICAgICByZXR1cm4gcm91dGVyLmhhbmRsZVVSTCh1cmwpOwogICAgfSwKICAgIHNldHVwRXZlbnREaXNwYXRjaGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBkaXNwYXRjaGVyID0gdGhpcy5sb29rdXAoJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicpOwogICAgICB2YXIgYXBwbGljYXRpb25DdXN0b21FdmVudHMgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLmFwcGxpY2F0aW9uLCAnY3VzdG9tRXZlbnRzJyk7CiAgICAgIHZhciBpbnN0YW5jZUN1c3RvbUV2ZW50cyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdjdXN0b21FdmVudHMnKTsKCiAgICAgIHZhciBjdXN0b21FdmVudHMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBhcHBsaWNhdGlvbkN1c3RvbUV2ZW50cywgaW5zdGFuY2VDdXN0b21FdmVudHMpOwogICAgICBkaXNwYXRjaGVyLnNldHVwKGN1c3RvbUV2ZW50cywgdGhpcy5yb290RWxlbWVudCk7CgogICAgICByZXR1cm4gZGlzcGF0Y2hlcjsKICAgIH0sCiAgICBnZXRVUkw6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyb3V0ZXIudXJsJyk7CiAgICB9LAogICAgdmlzaXQ6IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHRoaXMuc2V0dXBSb3V0ZXIoKTsKCiAgICAgIHZhciBib290T3B0aW9ucyA9IHRoaXMuX19jb250YWluZXJfXy5sb29rdXAoJy1lbnZpcm9ubWVudDptYWluJyk7CgogICAgICB2YXIgcm91dGVyID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3JvdXRlcicpOwoKICAgICAgdmFyIGhhbmRsZVRyYW5zaXRpb25SZXNvbHZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghYm9vdE9wdGlvbnMub3B0aW9ucy5zaG91bGRSZW5kZXIpIHsKICAgICAgICAgIC8vIE5vIHJlbmRlcmluZyBpcyBuZWVkZWQsIGFuZCByb3V0aW5nIGhhcyBjb21wbGV0ZWQsIHNpbXBseSByZXR1cm4uCiAgICAgICAgICByZXR1cm4gX3RoaXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSB2aXNpdCBwcm9taXNlIHJlc29sdmVzIHdoZW4gYWxsIHJlbmRlcmluZyBoYXMgY29tcGxldGVkCiAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckdsaW1tZXIucmVuZGVyU2V0dGxlZCkoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGhhbmRsZVRyYW5zaXRpb25SZWplY3QgPSBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBpZiAoZXJyb3IuZXJyb3IpIHsKICAgICAgICAgIHRocm93IGVycm9yLmVycm9yOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gJ1RyYW5zaXRpb25BYm9ydGVkJyAmJiByb3V0ZXIuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb24pIHsKICAgICAgICAgIHJldHVybiByb3V0ZXIuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb24udGhlbihoYW5kbGVUcmFuc2l0aW9uUmVzb2x2ZSwgaGFuZGxlVHJhbnNpdGlvblJlamVjdCk7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAnVHJhbnNpdGlvbkFib3J0ZWQnKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3IubWVzc2FnZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBsb2NhdGlvbiA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHJvdXRlciwgJ2xvY2F0aW9uJyk7CgogICAgICAvLyBLZWVwcyB0aGUgbG9jYXRpb24gYWRhcHRlcidzIGludGVybmFsIFVSTCBpbi1zeW5jCiAgICAgIGxvY2F0aW9uLnNldFVSTCh1cmwpOwoKICAgICAgLy8gZ2V0VVJMIHJldHVybnMgdGhlIHNldCB1cmwgd2l0aCB0aGUgcm9vdFVSTCBzdHJpcHBlZCBvZmYKICAgICAgcmV0dXJuIHJvdXRlci5oYW5kbGVVUkwobG9jYXRpb24uZ2V0VVJMKCkpLnRoZW4oaGFuZGxlVHJhbnNpdGlvblJlc29sdmUsIGhhbmRsZVRyYW5zaXRpb25SZWplY3QpOwogICAgfSwKICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuYXBwbGljYXRpb24uX3Vud2F0Y2hJbnN0YW5jZSh0aGlzKTsKICAgIH0KICB9KTsKCiAgQXBwbGljYXRpb25JbnN0YW5jZS5yZW9wZW5DbGFzcyh7CiAgICBzZXR1cFJlZ2lzdHJ5OiBmdW5jdGlvbiAocmVnaXN0cnkpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwoKICAgICAgaWYgKCFvcHRpb25zLnRvRW52aXJvbm1lbnQpIHsKICAgICAgICBvcHRpb25zID0gbmV3IEJvb3RPcHRpb25zKG9wdGlvbnMpOwogICAgICB9CgogICAgICByZWdpc3RyeS5yZWdpc3RlcignLWVudmlyb25tZW50Om1haW4nLCBvcHRpb25zLnRvRW52aXJvbm1lbnQoKSwgewogICAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgICB9KTsKICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6LWRvY3VtZW50Jywgb3B0aW9ucy5kb2N1bWVudCwgewogICAgICAgIGluc3RhbnRpYXRlOiBmYWxzZQogICAgICB9KTsKCiAgICAgIHRoaXMuX3N1cGVyKHJlZ2lzdHJ5LCBvcHRpb25zKTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICBBIGxpc3Qgb2YgYm9vdC10aW1lIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgY3VzdG9taXppbmcgdGhlIGJlaGF2aW9yIG9mCiAgICBhbiBgQXBwbGljYXRpb25JbnN0YW5jZWAuCiAgCiAgICBUaGlzIGlzIGFuIGludGVyZmFjZSBjbGFzcyB0aGF0IGV4aXN0cyBwdXJlbHkgdG8gZG9jdW1lbnQgdGhlIGF2YWlsYWJsZQogICAgb3B0aW9uczsgeW91IGRvIG5vdCBuZWVkIHRvIGNvbnN0cnVjdCBpdCBtYW51YWxseS4gU2ltcGx5IHBhc3MgYSByZWd1bGFyCiAgICBKYXZhU2NyaXB0IG9iamVjdCBjb250YWluaW5nIHRoZSBkZXNpcmVkIG9wdGlvbnMgaW50byBtZXRob2RzIHRoYXQgcmVxdWlyZQogICAgb25lIG9mIHRoZXNlIG9wdGlvbnMgb2JqZWN0OgogIAogICAgYGBgamF2YXNjcmlwdAogICAgTXlBcHAudmlzaXQoIi8iLCB7IGxvY2F0aW9uOiAibm9uZSIsIHJvb3RFbGVtZW50OiAiI2NvbnRhaW5lciIgfSk7CiAgICBgYGAKICAKICAgIE5vdCBhbGwgY29tYmluYXRpb25zIG9mIHRoZSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmUgdmFsaWQuIFNlZSB0aGUgZG9jdW1lbnRhdGlvbgogICAgb24gYEFwcGxpY2F0aW9uI3Zpc2l0YCBmb3IgdGhlIHN1cHBvcnRlZCBjb25maWd1cmF0aW9ucy4KICAKICAgIEludGVybmFsLCBleHBlcmltZW50YWwgb3Igb3RoZXJ3aXNlIHVuc3RhYmxlIGZsYWdzIGFyZSBtYXJrZWQgYXMgcHJpdmF0ZS4KICAKICAgIEBjbGFzcyBCb290T3B0aW9ucwogICAgQG5hbWVzcGFjZSBBcHBsaWNhdGlvbkluc3RhbmNlCiAgICBAcHVibGljCiAgKi8KCiAgdmFyIEJvb3RPcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQm9vdE9wdGlvbnMoKSB7CiAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fTsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBCb290T3B0aW9ucyk7CgogICAgICAvKioKICAgICAgICBQcm92aWRlIGEgc3BlY2lmaWMgaW5zdGFuY2Ugb2YgalF1ZXJ5LiBUaGlzIGlzIHVzZWZ1bCBpbiBjb25qdW5jdGlvbiB3aXRoCiAgICAgICAgdGhlIGBkb2N1bWVudGAgb3B0aW9uLCBhcyBpdCBhbGxvd3MgeW91IHRvIHVzZSBhIGNvcHkgb2YgYGpRdWVyeWAgdGhhdCBpcwogICAgICAgIGFwcHJvcHJpYXRlbHkgYm91bmQgdG8gdGhlIGZvcmVpZ24gYGRvY3VtZW50YCAoZS5nLiBhIGpzZG9tKS4KICAgICAgICAgVGhpcyBpcyBoaWdobHkgZXhwZXJpbWVudGFsIGFuZCBzdXBwb3J0IHZlcnkgaW5jb21wbGV0ZSBhdCB0aGUgbW9tZW50LgogICAgICAgICBAcHJvcGVydHkgalF1ZXJ5CiAgICAgICAgQHR5cGUgT2JqZWN0CiAgICAgICAgQGRlZmF1bHQgYXV0by1kZXRlY3RlZAogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIHRoaXMualF1ZXJ5ID0gX2VtYmVyVmlld3MualF1ZXJ5OyAvLyBUaGlzIGRlZmF1bHQgaXMgb3ZlcnJpZGFibGUgYmVsb3cKCiAgICAgIC8qKgogICAgICAgIEludGVyYWN0aXZlIG1vZGU6IHdoZXRoZXIgd2UgbmVlZCB0byBzZXQgdXAgZXZlbnQgZGVsZWdhdGlvbiBhbmQgaW52b2tlCiAgICAgICAgbGlmZWN5Y2xlIGNhbGxiYWNrcyBvbiBDb21wb25lbnRzLgogICAgICAgICBAcHJvcGVydHkgaXNJbnRlcmFjdGl2ZQogICAgICAgIEB0eXBlIGJvb2xlYW4KICAgICAgICBAZGVmYXVsdCBhdXRvLWRldGVjdGVkCiAgICAgICAgQHByaXZhdGUKICAgICAgKi8KICAgICAgdGhpcy5pc0ludGVyYWN0aXZlID0gX2VtYmVyQnJvd3NlckVudmlyb25tZW50Lmhhc0RPTTsgLy8gVGhpcyBkZWZhdWx0IGlzIG92ZXJyaWRhYmxlIGJlbG93CgogICAgICAvKioKICAgICAgICBAcHJvcGVydHkgX3JlbmRlck1vZGUKICAgICAgICBAdHlwZSBzdHJpbmcKICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgIEBwcml2YXRlCiAgICAgICovCiAgICAgIHRoaXMuX3JlbmRlck1vZGUgPSBvcHRpb25zLl9yZW5kZXJNb2RlOwoKICAgICAgLyoqCiAgICAgICAgUnVuIGluIGEgZnVsbCBicm93c2VyIGVudmlyb25tZW50LgogICAgICAgICBXaGVuIHRoaXMgZmxhZyBpcyBzZXQgdG8gYHRydWVgLCBpdCB3aWxsIGRpc2FibGUgbW9zdCBicm93c2VyLXNwZWNpZmljCiAgICAgICAgYW5kIGludGVyYWN0aXZlIGZlYXR1cmVzLiBTcGVjaWZpY2FsbHk6CiAgICAgICAgICogSXQgZG9lcyBub3QgdXNlIGBqUXVlcnlgIHRvIGFwcGVuZCB0aGUgcm9vdCB2aWV3OyB0aGUgYHJvb3RFbGVtZW50YAogICAgICAgICAgKGVpdGhlciBzcGVjaWZpZWQgYXMgYSBzdWJzZXF1ZW50IG9wdGlvbiBvciBvbiB0aGUgYXBwbGljYXRpb24gaXRzZWxmKQogICAgICAgICAgbXVzdCBhbHJlYWR5IGJlIGFuIGBFbGVtZW50YCBpbiB0aGUgZ2l2ZW4gYGRvY3VtZW50YCAoYXMgb3Bwb3NlZCB0byBhCiAgICAgICAgICBzdHJpbmcgc2VsZWN0b3IpLgogICAgICAgICAqIEl0IGRvZXMgbm90IHNldCB1cCBhbiBgRXZlbnREaXNwYXRjaGVyYC4KICAgICAgICAgKiBJdCBkb2VzIG5vdCBydW4gYW55IGBDb21wb25lbnRgIGxpZmVjeWNsZSBob29rcyAoc3VjaCBhcyBgZGlkSW5zZXJ0RWxlbWVudGApLgogICAgICAgICAqIEl0IHNldHMgdGhlIGBsb2NhdGlvbmAgb3B0aW9uIHRvIGAibm9uZSJgLiAoSWYgeW91IHdvdWxkIGxpa2UgdG8gdXNlCiAgICAgICAgICB0aGUgbG9jYXRpb24gYWRhcHRlciBzcGVjaWZpZWQgaW4gdGhlIGFwcCdzIHJvdXRlciBpbnN0ZWFkLCB5b3UgY2FuIGFsc28KICAgICAgICAgIHNwZWNpZnkgYHsgbG9jYXRpb246IG51bGwgfWAgdG8gc3BlY2lmaWNhbGx5IG9wdC1vdXQuKQogICAgICAgICBAcHJvcGVydHkgaXNCcm93c2VyCiAgICAgICAgQHR5cGUgYm9vbGVhbgogICAgICAgIEBkZWZhdWx0IGF1dG8tZGV0ZWN0ZWQKICAgICAgICBAcHVibGljCiAgICAgICovCiAgICAgIGlmIChvcHRpb25zLmlzQnJvd3NlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5pc0Jyb3dzZXIgPSAhIW9wdGlvbnMuaXNCcm93c2VyOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaXNCcm93c2VyID0gX2VtYmVyQnJvd3NlckVudmlyb25tZW50Lmhhc0RPTTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLmlzQnJvd3NlcikgewogICAgICAgIHRoaXMualF1ZXJ5ID0gbnVsbDsKICAgICAgICB0aGlzLmlzSW50ZXJhY3RpdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmxvY2F0aW9uID0gJ25vbmUnOwogICAgICB9CgogICAgICAvKioKICAgICAgICBEaXNhYmxlIHJlbmRlcmluZyBjb21wbGV0ZWx5LgogICAgICAgICBXaGVuIHRoaXMgZmxhZyBpcyBzZXQgdG8gYHRydWVgLCBpdCB3aWxsIGRpc2FibGUgdGhlIGVudGlyZSByZW5kZXJpbmcKICAgICAgICBwaXBlbGluZS4gRXNzZW50aWFsbHksIHRoaXMgcHV0cyB0aGUgYXBwIGludG8gInJvdXRpbmctb25seSIgbW9kZS4gTm8KICAgICAgICB0ZW1wbGF0ZXMgd2lsbCBiZSByZW5kZXJlZCwgYW5kIG5vIENvbXBvbmVudHMgd2lsbCBiZSBjcmVhdGVkLgogICAgICAgICBAcHJvcGVydHkgc2hvdWxkUmVuZGVyCiAgICAgICAgQHR5cGUgYm9vbGVhbgogICAgICAgIEBkZWZhdWx0IHRydWUKICAgICAgICBAcHVibGljCiAgICAgICovCiAgICAgIGlmIChvcHRpb25zLnNob3VsZFJlbmRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5zaG91bGRSZW5kZXIgPSAhIW9wdGlvbnMuc2hvdWxkUmVuZGVyOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2hvdWxkUmVuZGVyID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLnNob3VsZFJlbmRlcikgewogICAgICAgIHRoaXMualF1ZXJ5ID0gbnVsbDsKICAgICAgICB0aGlzLmlzSW50ZXJhY3RpdmUgPSBmYWxzZTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAgSWYgcHJlc2VudCwgcmVuZGVyIGludG8gdGhlIGdpdmVuIGBEb2N1bWVudGAgb2JqZWN0IGluc3RlYWQgb2YgdGhlCiAgICAgICAgZ2xvYmFsIGB3aW5kb3cuZG9jdW1lbnRgIG9iamVjdC4KICAgICAgICAgSW4gcHJhY3RpY2UsIHRoaXMgaXMgb25seSB1c2VmdWwgaW4gbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQgb3IgaW4KICAgICAgICBub24taW50ZXJhY3RpdmUgbW9kZSwgYmVjYXVzZSBFbWJlcidzIGBqUXVlcnlgIGRlcGVuZGVuY3kgaXMKICAgICAgICBpbXBsaWNpdGx5IGJvdW5kIHRvIHRoZSBjdXJyZW50IGRvY3VtZW50LCBjYXVzaW5nIGV2ZW50IGRlbGVnYXRpb24KICAgICAgICB0byBub3Qgd29yayBwcm9wZXJseSB3aGVuIHRoZSBhcHAgaXMgcmVuZGVyZWQgaW50byBhIGZvcmVpZ24KICAgICAgICBkb2N1bWVudCBvYmplY3QgKHN1Y2ggYXMgYW4gaWZyYW1lJ3MgYGNvbnRlbnREb2N1bWVudGApLgogICAgICAgICBJbiBub24tYnJvd3NlciBtb2RlLCB0aGlzIGNvdWxkIGJlIGEgImBEb2N1bWVudGAtbGlrZSIgb2JqZWN0IGFzCiAgICAgICAgRW1iZXIgb25seSBpbnRlcmFjdCB3aXRoIGEgc21hbGwgc3Vic2V0IG9mIHRoZSBET00gQVBJIGluIG5vbi0KICAgICAgICBpbnRlcmFjdGl2ZSBtb2RlLiBXaGlsZSB0aGUgZXhhY3QgcmVxdWlyZW1lbnRzIGhhdmUgbm90IHlldCBiZWVuCiAgICAgICAgZm9ybWFsaXplZCwgdGhlIGBTaW1wbGVET01gIGxpYnJhcnkncyBpbXBsZW1lbnRhdGlvbiBpcyBrbm93biB0bwogICAgICAgIHdvcmsuCiAgICAgICAgIEBwcm9wZXJ0eSBkb2N1bWVudAogICAgICAgIEB0eXBlIERvY3VtZW50CiAgICAgICAgQGRlZmF1bHQgdGhlIGdsb2JhbCBgZG9jdW1lbnRgIG9iamVjdAogICAgICAgIEBwdWJsaWMKICAgICAgKi8KICAgICAgaWYgKG9wdGlvbnMuZG9jdW1lbnQpIHsKICAgICAgICB0aGlzLmRvY3VtZW50ID0gb3B0aW9ucy5kb2N1bWVudDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmRvY3VtZW50ID0gdHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJyA/IGRvY3VtZW50IDogbnVsbDsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAgSWYgcHJlc2VudCwgb3ZlcnJpZGVzIHRoZSBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHkgb24KICAgICAgICB0aGUgaW5zdGFuY2UuIFRoaXMgaXMgdXNlZnVsIGZvciB0ZXN0aW5nIGVudmlyb25tZW50LCB3aGVyZSB5b3UKICAgICAgICBtaWdodCB3YW50IHRvIGFwcGVuZCB0aGUgcm9vdCB2aWV3IHRvIGEgZml4dHVyZSBhcmVhLgogICAgICAgICBJbiBub24tYnJvd3NlciBtb2RlLCBiZWNhdXNlIEVtYmVyIGRvZXMgbm90IGhhdmUgYWNjZXNzIHRvIGpRdWVyeSwKICAgICAgICB0aGlzIG9wdGlvbnMgbXVzdCBiZSBzcGVjaWZpZWQgYXMgYSBET00gYEVsZW1lbnRgIG9iamVjdCBpbnN0ZWFkIG9mCiAgICAgICAgYSBzZWxlY3RvciBzdHJpbmcuCiAgICAgICAgIFNlZSB0aGUgZG9jdW1lbnRhdGlvbiBvbiBgQXBwbGljYXRpb25gJ3MgYHJvb3RFbGVtZW50YCBmb3IKICAgICAgICBkZXRhaWxzLgogICAgICAgICBAcHJvcGVydHkgcm9vdEVsZW1lbnQKICAgICAgICBAdHlwZSBTdHJpbmd8RWxlbWVudAogICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICBAcHVibGljCiAgICAgICAqLwogICAgICBpZiAob3B0aW9ucy5yb290RWxlbWVudCkgewogICAgICAgIHRoaXMucm9vdEVsZW1lbnQgPSBvcHRpb25zLnJvb3RFbGVtZW50OwogICAgICB9CgogICAgICAvLyBTZXQgdGhlc2Ugb3B0aW9ucyBsYXN0IHRvIGdpdmUgdGhlIHVzZXIgYSBjaGFuY2UgdG8gb3ZlcnJpZGUgdGhlCiAgICAgIC8vIGRlZmF1bHRzIGZyb20gdGhlICJjb21ibyIgb3B0aW9ucyBsaWtlIGBpc0Jyb3dzZXJgIChhbHRob3VnaCBpbgogICAgICAvLyBwcmFjdGljZSwgdGhlIHJlc3VsdGluZyBjb21iaW5hdGlvbiBpcyBwcm9iYWJseSBpbnZhbGlkKQoKICAgICAgLyoqCiAgICAgICAgSWYgcHJlc2VudCwgb3ZlcnJpZGVzIHRoZSByb3V0ZXIncyBgbG9jYXRpb25gIHByb3BlcnR5IHdpdGggdGhpcwogICAgICAgIHZhbHVlLiBUaGlzIGlzIHVzZWZ1bCBmb3IgZW52aXJvbm1lbnRzIHdoZXJlIHRyeWluZyB0byBtb2RpZnkgdGhlCiAgICAgICAgVVJMIHdvdWxkIGJlIGluYXBwcm9wcmlhdGUuCiAgICAgICAgIEBwcm9wZXJ0eSBsb2NhdGlvbgogICAgICAgIEB0eXBlIHN0cmluZwogICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICBAcHVibGljCiAgICAgICovCiAgICAgIGlmIChvcHRpb25zLmxvY2F0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmxvY2F0aW9uID0gb3B0aW9ucy5sb2NhdGlvbjsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMualF1ZXJ5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmpRdWVyeSA9IG9wdGlvbnMualF1ZXJ5OwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5pc0ludGVyYWN0aXZlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLmlzSW50ZXJhY3RpdmUgPSAhIW9wdGlvbnMuaXNJbnRlcmFjdGl2ZTsKICAgICAgfQogICAgfQoKICAgIEJvb3RPcHRpb25zLnByb3RvdHlwZS50b0Vudmlyb25tZW50ID0gZnVuY3Rpb24gdG9FbnZpcm9ubWVudCgpIHsKICAgICAgLy8gRG8gd2UgcmVhbGx5IHdhbnQgdG8gYXNzaWduIGFsbCBvZiB0aGlzIT8KICAgICAgdmFyIGVudiA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudCk7CiAgICAgIC8vIEZvciBjb21wYXRpYmlsaXR5IHdpdGggZXhpc3RpbmcgY29kZQogICAgICBlbnYuaGFzRE9NID0gdGhpcy5pc0Jyb3dzZXI7CiAgICAgIGVudi5pc0ludGVyYWN0aXZlID0gdGhpcy5pc0ludGVyYWN0aXZlOwogICAgICBlbnYuX3JlbmRlck1vZGUgPSB0aGlzLl9yZW5kZXJNb2RlOwogICAgICBlbnYub3B0aW9ucyA9IHRoaXM7CiAgICAgIHJldHVybiBlbnY7CiAgICB9OwoKICAgIHJldHVybiBCb290T3B0aW9uczsKICB9KCk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IEFwcGxpY2F0aW9uSW5zdGFuY2U7Cn0pOwplbmlmZWQoJ0BlbWJlci9hcHBsaWNhdGlvbi9saWIvYXBwbGljYXRpb24nLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnZW1iZXItdXRpbHMnLCAnZW1iZXItZW52aXJvbm1lbnQnLCAnZW1iZXItYnJvd3Nlci1lbnZpcm9ubWVudCcsICdAZW1iZXIvZGVidWcnLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi9sYXp5X2xvYWQnLCAnZW1iZXItcnVudGltZScsICdlbWJlci12aWV3cycsICdlbWJlci1yb3V0aW5nJywgJ0BlbWJlci9hcHBsaWNhdGlvbi9pbnN0YW5jZScsICdAZW1iZXIvZW5naW5lJywgJ2NvbnRhaW5lcicsICdlbWJlci1nbGltbWVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX2VtYmVyVXRpbHMsIF9lbWJlckVudmlyb25tZW50LCBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQsIF9kZWJ1ZywgX3J1bmxvb3AsIF9lbWJlck1ldGFsLCBfbGF6eV9sb2FkLCBfZW1iZXJSdW50aW1lLCBfZW1iZXJWaWV3cywgX2VtYmVyUm91dGluZywgX2luc3RhbmNlLCBfZW5naW5lLCBfY29udGFpbmVyLCBfZW1iZXJHbGltbWVyKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3RlbXBsYXRlT2JqZWN0ID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbJy1idWNrZXQtY2FjaGU6bWFpbiddLCBbJy1idWNrZXQtY2FjaGU6bWFpbiddKTsKCiAgdmFyIGxpYnJhcmllc1JlZ2lzdGVyZWQgPSBmYWxzZTsKCiAgLyoqCiAgICBBbiBpbnN0YW5jZSBvZiBgQXBwbGljYXRpb25gIGlzIHRoZSBzdGFydGluZyBwb2ludCBmb3IgZXZlcnkgRW1iZXIKICAgIGFwcGxpY2F0aW9uLiBJdCBoZWxwcyB0byBpbnN0YW50aWF0ZSwgaW5pdGlhbGl6ZSBhbmQgY29vcmRpbmF0ZSB0aGUgbWFueQogICAgb2JqZWN0cyB0aGF0IG1ha2UgdXAgeW91ciBhcHAuCiAgCiAgICBFYWNoIEVtYmVyIGFwcCBoYXMgb25lIGFuZCBvbmx5IG9uZSBgQXBwbGljYXRpb25gIG9iamVjdC4gSW4gZmFjdCwgdGhlCiAgICB2ZXJ5IGZpcnN0IHRoaW5nIHlvdSBzaG91bGQgZG8gaW4geW91ciBhcHBsaWNhdGlvbiBpcyBjcmVhdGUgdGhlIGluc3RhbmNlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICB3aW5kb3cuQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICBgYGAKICAKICAgIFR5cGljYWxseSwgdGhlIGFwcGxpY2F0aW9uIG9iamVjdCBpcyB0aGUgb25seSBnbG9iYWwgdmFyaWFibGUuIEFsbCBvdGhlcgogICAgY2xhc3NlcyBpbiB5b3VyIGFwcCBzaG91bGQgYmUgcHJvcGVydGllcyBvbiB0aGUgYEFwcGxpY2F0aW9uYCBpbnN0YW5jZSwKICAgIHdoaWNoIGhpZ2hsaWdodHMgaXRzIGZpcnN0IHJvbGU6IGEgZ2xvYmFsIG5hbWVzcGFjZS4KICAKICAgIEZvciBleGFtcGxlLCBpZiB5b3UgZGVmaW5lIGEgdmlldyBjbGFzcywgaXQgbWlnaHQgbG9vayBsaWtlIHRoaXM6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIEFwcC5NeVZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZCgpOwogICAgYGBgCiAgCiAgICBCeSBkZWZhdWx0LCBjYWxsaW5nIGBBcHBsaWNhdGlvbi5jcmVhdGUoKWAgd2lsbCBhdXRvbWF0aWNhbGx5IGluaXRpYWxpemUKICAgIHlvdXIgYXBwbGljYXRpb24gYnkgY2FsbGluZyB0aGUgYEFwcGxpY2F0aW9uLmluaXRpYWxpemUoKWAgbWV0aG9kLiBJZgogICAgeW91IG5lZWQgdG8gZGVsYXkgaW5pdGlhbGl6YXRpb24sIHlvdSBjYW4gY2FsbCB5b3VyIGFwcCdzIGBkZWZlclJlYWRpbmVzcygpYAogICAgbWV0aG9kLiBXaGVuIHlvdSBhcmUgcmVhZHkgZm9yIHlvdXIgYXBwIHRvIGJlIGluaXRpYWxpemVkLCBjYWxsIGl0cwogICAgYGFkdmFuY2VSZWFkaW5lc3MoKWAgbWV0aG9kLgogIAogICAgWW91IGNhbiBkZWZpbmUgYSBgcmVhZHlgIG1ldGhvZCBvbiB0aGUgYEFwcGxpY2F0aW9uYCBpbnN0YW5jZSwgd2hpY2gKICAgIHdpbGwgYmUgcnVuIGJ5IEVtYmVyIHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGluaXRpYWxpemVkLgogIAogICAgQmVjYXVzZSBgQXBwbGljYXRpb25gIGluaGVyaXRzIGZyb20gYEVtYmVyLk5hbWVzcGFjZWAsIGFueSBjbGFzc2VzCiAgICB5b3UgY3JlYXRlIHdpbGwgaGF2ZSB1c2VmdWwgc3RyaW5nIHJlcHJlc2VudGF0aW9ucyB3aGVuIGNhbGxpbmcgYHRvU3RyaW5nKClgLgogICAgU2VlIHRoZSBgRW1iZXIuTmFtZXNwYWNlYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgogIAogICAgV2hpbGUgeW91IGNhbiB0aGluayBvZiB5b3VyIGBBcHBsaWNhdGlvbmAgYXMgYSBjb250YWluZXIgdGhhdCBob2xkcyB0aGUKICAgIG90aGVyIGNsYXNzZXMgaW4geW91ciBhcHBsaWNhdGlvbiwgdGhlcmUgYXJlIHNldmVyYWwgb3RoZXIgcmVzcG9uc2liaWxpdGllcwogICAgZ29pbmcgb24gdW5kZXItdGhlLWhvb2QgdGhhdCB5b3UgbWF5IHdhbnQgdG8gdW5kZXJzdGFuZC4KICAKICAgICMjIyBFdmVudCBEZWxlZ2F0aW9uCiAgCiAgICBFbWJlciB1c2VzIGEgdGVjaG5pcXVlIGNhbGxlZCBfZXZlbnQgZGVsZWdhdGlvbl8uIFRoaXMgYWxsb3dzIHRoZSBmcmFtZXdvcmsKICAgIHRvIHNldCB1cCBhIGdsb2JhbCwgc2hhcmVkIGV2ZW50IGxpc3RlbmVyIGluc3RlYWQgb2YgcmVxdWlyaW5nIGVhY2ggdmlldyB0bwogICAgZG8gaXQgbWFudWFsbHkuIEZvciBleGFtcGxlLCBpbnN0ZWFkIG9mIGVhY2ggdmlldyByZWdpc3RlcmluZyBpdHMgb3duCiAgICBgbW91c2Vkb3duYCBsaXN0ZW5lciBvbiBpdHMgYXNzb2NpYXRlZCBlbGVtZW50LCBFbWJlciBzZXRzIHVwIGEgYG1vdXNlZG93bmAKICAgIGxpc3RlbmVyIG9uIHRoZSBgYm9keWAuCiAgCiAgICBJZiBhIGBtb3VzZWRvd25gIGV2ZW50IG9jY3VycywgRW1iZXIgd2lsbCBsb29rIGF0IHRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50IGFuZAogICAgc3RhcnQgd2Fsa2luZyB1cCB0aGUgRE9NIG5vZGUgdHJlZSwgZmluZGluZyBjb3JyZXNwb25kaW5nIHZpZXdzIGFuZCBpbnZva2luZwogICAgdGhlaXIgYG1vdXNlRG93bmAgbWV0aG9kIGFzIGl0IGdvZXMuCiAgCiAgICBgQXBwbGljYXRpb25gIGhhcyBhIG51bWJlciBvZiBkZWZhdWx0IGV2ZW50cyB0aGF0IGl0IGxpc3RlbnMgZm9yLCBhcwogICAgd2VsbCBhcyBhIG1hcHBpbmcgZnJvbSBsb3dlcmNhc2UgZXZlbnRzIHRvIGNhbWVsLWNhc2VkIHZpZXcgbWV0aG9kIG5hbWVzLiBGb3IKICAgIGV4YW1wbGUsIHRoZSBga2V5cHJlc3NgIGV2ZW50IGNhdXNlcyB0aGUgYGtleVByZXNzYCBtZXRob2Qgb24gdGhlIHZpZXcgdG8gYmUKICAgIGNhbGxlZCwgdGhlIGBkYmxjbGlja2AgZXZlbnQgY2F1c2VzIGBkb3VibGVDbGlja2AgdG8gYmUgY2FsbGVkLCBhbmQgc28gb24uCiAgCiAgICBJZiB0aGVyZSBpcyBhIGJ1YmJsaW5nIGJyb3dzZXIgZXZlbnQgdGhhdCBFbWJlciBkb2VzIG5vdCBsaXN0ZW4gZm9yIGJ5CiAgICBkZWZhdWx0LCB5b3UgY2FuIHNwZWNpZnkgY3VzdG9tIGV2ZW50cyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyB2aWV3IG1ldGhvZAogICAgbmFtZXMgYnkgc2V0dGluZyB0aGUgYXBwbGljYXRpb24ncyBgY3VzdG9tRXZlbnRzYCBwcm9wZXJ0eToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgbGV0IEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSh7CiAgICAgIGN1c3RvbUV2ZW50czogewogICAgICAgIC8vIGFkZCBzdXBwb3J0IGZvciB0aGUgcGFzdGUgZXZlbnQKICAgICAgICBwYXN0ZTogJ3Bhc3RlJwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgVG8gcHJldmVudCBFbWJlciBmcm9tIHNldHRpbmcgdXAgYSBsaXN0ZW5lciBmb3IgYSBkZWZhdWx0IGV2ZW50LAogICAgc3BlY2lmeSB0aGUgZXZlbnQgbmFtZSB3aXRoIGEgYG51bGxgIHZhbHVlIGluIHRoZSBgY3VzdG9tRXZlbnRzYAogICAgcHJvcGVydHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAvLyBwcmV2ZW50IGxpc3RlbmVycyBmb3IgbW91c2VlbnRlci9tb3VzZWxlYXZlIGV2ZW50cwogICAgICAgIG1vdXNlZW50ZXI6IG51bGwsCiAgICAgICAgbW91c2VsZWF2ZTogbnVsbAogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQnkgZGVmYXVsdCwgdGhlIGFwcGxpY2F0aW9uIHNldHMgdXAgdGhlc2UgZXZlbnQgbGlzdGVuZXJzIG9uIHRoZSBkb2N1bWVudAogICAgYm9keS4gSG93ZXZlciwgaW4gY2FzZXMgd2hlcmUgeW91IGFyZSBlbWJlZGRpbmcgYW4gRW1iZXIgYXBwbGljYXRpb24gaW5zaWRlCiAgICBhbiBleGlzdGluZyBwYWdlLCB5b3UgbWF5IHdhbnQgaXQgdG8gc2V0IHVwIHRoZSBsaXN0ZW5lcnMgb24gYW4gZWxlbWVudAogICAgaW5zaWRlIHRoZSBib2R5LgogIAogICAgRm9yIGV4YW1wbGUsIGlmIG9ubHkgZXZlbnRzIGluc2lkZSBhIERPTSBlbGVtZW50IHdpdGggdGhlIElEIG9mIGBlbWJlci1hcHBgCiAgICBzaG91bGQgYmUgZGVsZWdhdGVkLCBzZXQgeW91ciBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAKICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICByb290RWxlbWVudDogJyNlbWJlci1hcHAnCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhlIGByb290RWxlbWVudGAgY2FuIGJlIGVpdGhlciBhIERPTSBlbGVtZW50IG9yIGEgalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3IKICAgIHN0cmluZy4gTm90ZSB0aGF0ICp2aWV3cyBhcHBlbmRlZCB0byB0aGUgRE9NIG91dHNpZGUgdGhlIHJvb3QgZWxlbWVudCB3aWxsCiAgICBub3QgcmVjZWl2ZSBldmVudHMuKiBJZiB5b3Ugc3BlY2lmeSBhIGN1c3RvbSByb290IGVsZW1lbnQsIG1ha2Ugc3VyZSB5b3Ugb25seQogICAgYXBwZW5kIHZpZXdzIGluc2lkZSBpdCEKICAKICAgIFRvIGxlYXJuIG1vcmUgYWJvdXQgdGhlIGV2ZW50cyBFbWJlciBjb21wb25lbnRzIHVzZSwgc2VlCiAgCiAgICBbY29tcG9uZW50cy9oYW5kbGluZy1ldmVudHNdKGh0dHBzOi8vZ3VpZGVzLmVtYmVyanMuY29tL2N1cnJlbnQvY29tcG9uZW50cy9oYW5kbGluZy1ldmVudHMvI3RvY19ldmVudC1uYW1lcykuCiAgCiAgICAjIyMgSW5pdGlhbGl6ZXJzCiAgCiAgICBMaWJyYXJpZXMgb24gdG9wIG9mIEVtYmVyIGNhbiBhZGQgaW5pdGlhbGl6ZXJzLCBsaWtlIHNvOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICBBcHBsaWNhdGlvbi5pbml0aWFsaXplcih7CiAgICAgIG5hbWU6ICdhcGktYWRhcHRlcicsCiAgCiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2FwaS1hZGFwdGVyOm1haW4nLCBBcGlBZGFwdGVyKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIEluaXRpYWxpemVycyBwcm92aWRlIGFuIG9wcG9ydHVuaXR5IHRvIGFjY2VzcyB0aGUgaW50ZXJuYWwgcmVnaXN0cnksIHdoaWNoCiAgICBvcmdhbml6ZXMgdGhlIGRpZmZlcmVudCBjb21wb25lbnRzIG9mIGFuIEVtYmVyIGFwcGxpY2F0aW9uLiBBZGRpdGlvbmFsbHkKICAgIHRoZXkgcHJvdmlkZSBhIGNoYW5jZSB0byBhY2Nlc3MgdGhlIGluc3RhbnRpYXRlZCBhcHBsaWNhdGlvbi4gQmV5b25kCiAgICBiZWluZyB1c2VkIGZvciBsaWJyYXJpZXMsIGluaXRpYWxpemVycyBhcmUgYWxzbyBhIGdyZWF0IHdheSB0byBvcmdhbml6ZQogICAgZGVwZW5kZW5jeSBpbmplY3Rpb24gb3Igc2V0dXAgaW4geW91ciBvd24gYXBwbGljYXRpb24uCiAgCiAgICAjIyMgUm91dGluZwogIAogICAgSW4gYWRkaXRpb24gdG8gY3JlYXRpbmcgeW91ciBhcHBsaWNhdGlvbidzIHJvdXRlciwgYEFwcGxpY2F0aW9uYCBpcwogICAgYWxzbyByZXNwb25zaWJsZSBmb3IgdGVsbGluZyB0aGUgcm91dGVyIHdoZW4gdG8gc3RhcnQgcm91dGluZy4gVHJhbnNpdGlvbnMKICAgIGJldHdlZW4gcm91dGVzIGNhbiBiZSBsb2dnZWQgd2l0aCB0aGUgYExPR19UUkFOU0lUSU9OU2AgZmxhZywgYW5kIG1vcmUKICAgIGRldGFpbGVkIGludHJhLXRyYW5zaXRpb24gbG9nZ2luZyBjYW4gYmUgbG9nZ2VkIHdpdGgKICAgIHRoZSBgTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMYCBmbGFnOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgTE9HX1RSQU5TSVRJT05TOiB0cnVlLCAvLyBiYXNpYyBsb2dnaW5nIG9mIHN1Y2Nlc3NmdWwgdHJhbnNpdGlvbnMKICAgICAgTE9HX1RSQU5TSVRJT05TX0lOVEVSTkFMOiB0cnVlIC8vIGRldGFpbGVkIGxvZ2dpbmcgb2YgYWxsIHJvdXRpbmcgc3RlcHMKICAgIH0pOwogICAgYGBgCiAgCiAgICBCeSBkZWZhdWx0LCB0aGUgcm91dGVyIHdpbGwgYmVnaW4gdHJ5aW5nIHRvIHRyYW5zbGF0ZSB0aGUgY3VycmVudCBVUkwgaW50bwogICAgYXBwbGljYXRpb24gc3RhdGUgb25jZSB0aGUgYnJvd3NlciBlbWl0cyB0aGUgYERPTUNvbnRlbnRSZWFkeWAgZXZlbnQuIElmIHlvdQogICAgbmVlZCB0byBkZWZlciByb3V0aW5nLCB5b3UgY2FuIGNhbGwgdGhlIGFwcGxpY2F0aW9uJ3MgYGRlZmVyUmVhZGluZXNzKClgCiAgICBtZXRob2QuIE9uY2Ugcm91dGluZyBjYW4gYmVnaW4sIGNhbGwgdGhlIGBhZHZhbmNlUmVhZGluZXNzKClgIG1ldGhvZC4KICAKICAgIElmIHRoZXJlIGlzIGFueSBzZXR1cCByZXF1aXJlZCBiZWZvcmUgcm91dGluZyBiZWdpbnMsIHlvdSBjYW4gaW1wbGVtZW50IGEKICAgIGByZWFkeSgpYCBtZXRob2Qgb24geW91ciBhcHAgdGhhdCB3aWxsIGJlIGludm9rZWQgaW1tZWRpYXRlbHkgYmVmb3JlIHJvdXRpbmcKICAgIGJlZ2lucy4KICAKICAgIEBjbGFzcyBBcHBsaWNhdGlvbgogICAgQGV4dGVuZHMgRW5naW5lCiAgICBAdXNlcyBSZWdpc3RyeVByb3h5TWl4aW4KICAgIEBwdWJsaWMKICAqLwoKICB2YXIgQXBwbGljYXRpb24gPSBfZW5naW5lLmRlZmF1bHQuZXh0ZW5kKHsKICAgIC8qKgogICAgICBUaGUgcm9vdCBET00gZWxlbWVudCBvZiB0aGUgQXBwbGljYXRpb24uIFRoaXMgY2FuIGJlIHNwZWNpZmllZCBhcyBhbgogICAgICBlbGVtZW50IG9yIGEKICAgICAgW2pRdWVyeS1jb21wYXRpYmxlIHNlbGVjdG9yIHN0cmluZ10oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NhdGVnb3J5L3NlbGVjdG9ycy8pLgogICAgICAgVGhpcyBpcyB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBBcHBsaWNhdGlvbidzLAogICAgICBgZXZlbnREaXNwYXRjaGVyYCwgd2hpY2ggc2V0cyB1cCB0aGUgbGlzdGVuZXJzIGZvciBldmVudCBkZWxlZ2F0aW9uLiBFdmVyeQogICAgICB2aWV3IGluIHlvdXIgYXBwbGljYXRpb24gc2hvdWxkIGJlIGEgY2hpbGQgb2YgdGhlIGVsZW1lbnQgeW91IHNwZWNpZnkgaGVyZS4KICAgICAgIEBwcm9wZXJ0eSByb290RWxlbWVudAogICAgICBAdHlwZSBET01FbGVtZW50CiAgICAgIEBkZWZhdWx0ICdib2R5JwogICAgICBAcHVibGljCiAgICAqLwogICAgcm9vdEVsZW1lbnQ6ICdib2R5JywKCiAgICAvKioKICAgICAgVGhlIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIHJlc3BvbnNpYmxlIGZvciBkZWxlZ2F0aW5nIGV2ZW50cyB0byB0aGlzCiAgICAgIGFwcGxpY2F0aW9uJ3Mgdmlld3MuCiAgICAgICBUaGUgZXZlbnQgZGlzcGF0Y2hlciBpcyBjcmVhdGVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBhdCBpbml0aWFsaXphdGlvbiB0aW1lCiAgICAgIGFuZCBzZXRzIHVwIGV2ZW50IGxpc3RlbmVycyBvbiB0aGUgRE9NIGVsZW1lbnQgZGVzY3JpYmVkIGJ5IHRoZQogICAgICBhcHBsaWNhdGlvbidzIGByb290RWxlbWVudGAgcHJvcGVydHkuCiAgICAgICBTZWUgdGhlIGRvY3VtZW50YXRpb24gZm9yIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICAgQHByb3BlcnR5IGV2ZW50RGlzcGF0Y2hlcgogICAgICBAdHlwZSBFbWJlci5FdmVudERpc3BhdGNoZXIKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgZXZlbnREaXNwYXRjaGVyOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgRE9NIGV2ZW50cyBmb3Igd2hpY2ggdGhlIGV2ZW50IGRpc3BhdGNoZXIgc2hvdWxkIGxpc3Rlbi4KICAgICAgIEJ5IGRlZmF1bHQsIHRoZSBhcHBsaWNhdGlvbidzIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGxpc3RlbnMKICAgICAgZm9yIGEgc2V0IG9mIHN0YW5kYXJkIERPTSBldmVudHMsIHN1Y2ggYXMgYG1vdXNlZG93bmAgYW5kCiAgICAgIGBrZXl1cGAsIGFuZCBkZWxlZ2F0ZXMgdGhlbSB0byB5b3VyIGFwcGxpY2F0aW9uJ3MgYEVtYmVyLlZpZXdgCiAgICAgIGluc3RhbmNlcy4KICAgICAgIElmIHlvdSB3b3VsZCBsaWtlIGFkZGl0aW9uYWwgYnViYmxpbmcgZXZlbnRzIHRvIGJlIGRlbGVnYXRlZCB0byB5b3VyCiAgICAgIHZpZXdzLCBzZXQgeW91ciBgQXBwbGljYXRpb25gJ3MgYGN1c3RvbUV2ZW50c2AgcHJvcGVydHkKICAgICAgdG8gYSBoYXNoIGNvbnRhaW5pbmcgdGhlIERPTSBldmVudCBuYW1lIGFzIHRoZSBrZXkgYW5kIHRoZQogICAgICBjb3JyZXNwb25kaW5nIHZpZXcgbWV0aG9kIG5hbWUgYXMgdGhlIHZhbHVlLiBTZXR0aW5nIGFuIGV2ZW50IHRvCiAgICAgIGEgdmFsdWUgb2YgYG51bGxgIHdpbGwgcHJldmVudCBhIGRlZmF1bHQgZXZlbnQgbGlzdGVuZXIgZnJvbSBiZWluZwogICAgICBhZGRlZCBmb3IgdGhhdCBldmVudC4KICAgICAgIFRvIGFkZCBuZXcgZXZlbnRzIHRvIGJlIGxpc3RlbmVkIHRvOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICAgIGN1c3RvbUV2ZW50czogewogICAgICAgICAgLy8gYWRkIHN1cHBvcnQgZm9yIHRoZSBwYXN0ZSBldmVudAogICAgICAgICAgcGFzdGU6ICdwYXN0ZScKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRvIHByZXZlbnQgZGVmYXVsdCBldmVudHMgZnJvbSBiZWluZyBsaXN0ZW5lZCB0bzoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAgIC8vIHJlbW92ZSBzdXBwb3J0IGZvciBtb3VzZWVudGVyIC8gbW91c2VsZWF2ZSBldmVudHMKICAgICAgICAgIG1vdXNlZW50ZXI6IG51bGwsCiAgICAgICAgICBtb3VzZWxlYXZlOiBudWxsCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBwcm9wZXJ0eSBjdXN0b21FdmVudHMKICAgICAgQHR5cGUgT2JqZWN0CiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGN1c3RvbUV2ZW50czogbnVsbCwKCiAgICAvKioKICAgICAgV2hldGhlciB0aGUgYXBwbGljYXRpb24gc2hvdWxkIGF1dG9tYXRpY2FsbHkgc3RhcnQgcm91dGluZyBhbmQgcmVuZGVyCiAgICAgIHRlbXBsYXRlcyB0byB0aGUgYHJvb3RFbGVtZW50YCBvbiBET00gcmVhZHkuIFdoaWxlIGRlZmF1bHQgYnkgdHJ1ZSwKICAgICAgb3RoZXIgZW52aXJvbm1lbnRzIHN1Y2ggYXMgRmFzdEJvb3Qgb3IgYSB0ZXN0aW5nIGhhcm5lc3MgY2FuIHNldCB0aGlzCiAgICAgIHByb3BlcnR5IHRvIGBmYWxzZWAgYW5kIGNvbnRyb2wgdGhlIHByZWNpc2UgdGltaW5nIGFuZCBiZWhhdmlvciBvZiB0aGUgYm9vdAogICAgICBwcm9jZXNzLgogICAgICAgQHByb3BlcnR5IGF1dG9ib290CiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGF1dG9ib290OiB0cnVlLAoKICAgIC8qKgogICAgICBXaGV0aGVyIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgYmUgY29uZmlndXJlZCBmb3IgdGhlIGxlZ2FjeSAiZ2xvYmFscyBtb2RlIi4KICAgICAgVW5kZXIgdGhpcyBtb2RlLCB0aGUgQXBwbGljYXRpb24gb2JqZWN0IHNlcnZlcyBhcyBhIGdsb2JhbCBuYW1lc3BhY2UgZm9yIGFsbAogICAgICBjbGFzc2VzLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgIEFwcC5Sb3V0ZXIucmVvcGVuKHsKICAgICAgICBsb2NhdGlvbjogJ25vbmUnCiAgICAgIH0pOwogICAgICAgQXBwLlJvdXRlci5tYXAoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgIEFwcC5NeUNvbXBvbmVudCA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIC4uLgogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGlzIGZsYWcgYWxzbyBleHBvc2VzIG90aGVyIGludGVybmFsIEFQSXMgdGhhdCBhc3N1bWVzIHRoZSBleGlzdGVuY2Ugb2YKICAgICAgYSBzcGVjaWFsICJkZWZhdWx0IGluc3RhbmNlIiwgbGlrZSBgQXBwLl9fY29udGFpbmVyX18ubG9va3VwKC4uLilgLgogICAgICAgVGhpcyBvcHRpb24gaXMgY3VycmVudGx5IG5vdCBjb25maWd1cmFibGUsIGl0cyB2YWx1ZSBpcyBkZXJpdmVkIGZyb20KICAgICAgdGhlIGBhdXRvYm9vdGAgZmxhZyDigJMgZGlzYWJsaW5nIGBhdXRvYm9vdGAgYWxzbyBpbXBsaWVzIG9wdGluZy1vdXQgb2YKICAgICAgZ2xvYmFscyBtb2RlIHN1cHBvcnQsIGFsdGhvdWdoIHRoZXkgYXJlIHVsdGltYXRlbHkgb3J0aG9nb25hbCBjb25jZXJucy4KICAgICAgIFNvbWUgb2YgdGhlIGdsb2JhbCBtb2RlcyBmZWF0dXJlcyBhcmUgYWxyZWFkeSBkZXByZWNhdGVkIGluIDEueC4gVGhlCiAgICAgIGV4aXN0ZW5jZSBvZiB0aGlzIGZsYWcgaXMgdG8gdW50YW5nbGUgdGhlIGdsb2JhbHMgbW9kZSBjb2RlIHBhdGhzIGZyb20KICAgICAgdGhlIGF1dG9ib290IGNvZGUgcGF0aHMsIHNvIHRoYXQgdGhlc2UgbGVnYWN5IGZlYXR1cmVzIGNhbiBiZSByZXZpZXdlZAogICAgICBmb3IgZGVwcmVjYXRpb24vcmVtb3ZhbCBzZXBhcmF0ZWx5LgogICAgICAgRm9yY2luZyB0aGUgKGF1dG9ib290PXRydWUsIF9nbG9iYWxzTW9kZT1mYWxzZSkgaGVyZSBhbmQgcnVubmluZyB0aGUgdGVzdHMKICAgICAgd291bGQgcmV2ZWFsIGFsbCB0aGUgcGxhY2VzIHdoZXJlIHdlIGFyZSBzdGlsbCByZWx5aW5nIG9uIHRoZXNlIGxlZ2FjeQogICAgICBiZWhhdmlvciBpbnRlcm5hbGx5IChtb3N0bHkganVzdCB0ZXN0cykuCiAgICAgICBAcHJvcGVydHkgX2dsb2JhbHNNb2RlCiAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9nbG9iYWxzTW9kZTogdHJ1ZSwKCiAgICAvKioKICAgICAgQW4gYXJyYXkgb2YgYXBwbGljYXRpb24gaW5zdGFuY2VzIGNyZWF0ZWQgYnkgYGJ1aWxkSW5zdGFuY2UoKWAuIFVzZWQKICAgICAgaW50ZXJuYWxseSB0byBlbnN1cmUgdGhhdCBhbGwgaW5zdGFuY2VzIGdldCBkZXN0cm95ZWQuCiAgICAgICBAcHJvcGVydHkgX2FwcGxpY2F0aW9uSW5zdGFuY2VzCiAgICAgIEB0eXBlIEFycmF5CiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHByaXZhdGUKICAgICovCiAgICBfYXBwbGljYXRpb25JbnN0YW5jZXM6IG51bGwsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICBpZiAoIXRoaXMuJCkgewogICAgICAgIHRoaXMuJCA9IF9lbWJlclZpZXdzLmpRdWVyeTsKICAgICAgfQoKICAgICAgcmVnaXN0ZXJMaWJyYXJpZXMoKTsKCiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5MT0dfVkVSU0lPTikgewogICAgICAgICAgLy8gd2Ugb25seSBuZWVkIHRvIHNlZSB0aGlzIG9uY2UgcGVyIEFwcGxpY2F0aW9uI2luaXQKICAgICAgICAgIF9lbWJlckVudmlyb25tZW50LkVOVi5MT0dfVkVSU0lPTiA9IGZhbHNlOwogICAgICAgICAgX2VtYmVyTWV0YWwubGlicmFyaWVzLmxvZ1ZlcnNpb25zKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTdGFydCBvZmYgdGhlIG51bWJlciBvZiBkZWZlcnJhbHMgYXQgMS4gVGhpcyB3aWxsIGJlIGRlY3JlbWVudGVkIGJ5CiAgICAgIC8vIHRoZSBBcHBsaWNhdGlvbidzIG93biBgYm9vdGAgbWV0aG9kLgogICAgICB0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMgPSAxOwogICAgICB0aGlzLl9ib290ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fYXBwbGljYXRpb25JbnN0YW5jZXMgPSBbXTsKCiAgICAgIHRoaXMuYXV0b2Jvb3QgPSB0aGlzLl9nbG9iYWxzTW9kZSA9ICEhdGhpcy5hdXRvYm9vdDsKCiAgICAgIGlmICh0aGlzLl9nbG9iYWxzTW9kZSkgewogICAgICAgIHRoaXMuX3ByZXBhcmVGb3JHbG9iYWxzTW9kZSgpOwogICAgICB9CgogICAgICBpZiAodGhpcy5hdXRvYm9vdCkgewogICAgICAgIHRoaXMud2FpdEZvckRPTVJlYWR5KCk7CiAgICAgIH0KICAgIH0sCiAgICBidWlsZEluc3RhbmNlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fTsKCiAgICAgIG9wdGlvbnMuYmFzZSA9IHRoaXM7CiAgICAgIG9wdGlvbnMuYXBwbGljYXRpb24gPSB0aGlzOwogICAgICByZXR1cm4gX2luc3RhbmNlLmRlZmF1bHQuY3JlYXRlKG9wdGlvbnMpOwogICAgfSwKICAgIF93YXRjaEluc3RhbmNlOiBmdW5jdGlvbiAoaW5zdGFuY2UpIHsKICAgICAgdGhpcy5fYXBwbGljYXRpb25JbnN0YW5jZXMucHVzaChpbnN0YW5jZSk7CiAgICB9LAogICAgX3Vud2F0Y2hJbnN0YW5jZTogZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAgIHZhciBpbmRleCA9IHRoaXMuX2FwcGxpY2F0aW9uSW5zdGFuY2VzLmluZGV4T2YoaW5zdGFuY2UpOwogICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uSW5zdGFuY2VzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBfcHJlcGFyZUZvckdsb2JhbHNNb2RlOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIENyZWF0ZSBzdWJjbGFzcyBvZiBSb3V0ZXIgZm9yIHRoaXMgQXBwbGljYXRpb24gaW5zdGFuY2UuCiAgICAgIC8vIFRoaXMgaXMgdG8gZW5zdXJlIHRoYXQgc29tZW9uZSByZW9wZW5pbmcgYEFwcC5Sb3V0ZXJgIGRvZXMgbm90CiAgICAgIC8vIHRhbXBlciB3aXRoIHRoZSBkZWZhdWx0IGBSb3V0ZXJgLgogICAgICB0aGlzLlJvdXRlciA9ICh0aGlzLlJvdXRlciB8fCBfZW1iZXJSb3V0aW5nLlJvdXRlcikuZXh0ZW5kKCk7CgogICAgICB0aGlzLl9idWlsZERlcHJlY2F0ZWRJbnN0YW5jZSgpOwogICAgfSwKICAgIF9idWlsZERlcHJlY2F0ZWRJbnN0YW5jZTogZnVuY3Rpb24gKCkgewogICAgICAvLyBCdWlsZCBhIGRlZmF1bHQgaW5zdGFuY2UKICAgICAgdmFyIGluc3RhbmNlID0gdGhpcy5idWlsZEluc3RhbmNlKCk7CgogICAgICAvLyBMZWdhY3kgc3VwcG9ydCBmb3IgQXBwLl9fY29udGFpbmVyX18gYW5kIG90aGVyIGdsb2JhbCBtZXRob2RzCiAgICAgIC8vIG9uIEFwcCB0aGF0IHJlbHkgb24gYSBzaW5nbGUsIGRlZmF1bHQgaW5zdGFuY2UuCiAgICAgIHRoaXMuX19kZXByZWNhdGVkSW5zdGFuY2VfXyA9IGluc3RhbmNlOwogICAgICB0aGlzLl9fY29udGFpbmVyX18gPSBpbnN0YW5jZS5fX2NvbnRhaW5lcl9fOwogICAgfSwKICAgIHdhaXRGb3JET01SZWFkeTogZnVuY3Rpb24gKCkgewogICAgICBpZiAoIXRoaXMuJCB8fCB0aGlzLiQuaXNSZWFkeSkgewogICAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2FjdGlvbnMnLCB0aGlzLCAnZG9tUmVhZHknKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiQoKS5yZWFkeSgoMCwgX3J1bmxvb3AuYmluZCkodGhpcywgJ2RvbVJlYWR5JykpOwogICAgICB9CiAgICB9LAogICAgZG9tUmVhZHk6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHRoaXMuX2Jvb3RTeW5jKCk7CgogICAgICAvLyBDb250aW51ZXMgdG8gYGRpZEJlY29tZVJlYWR5YAogICAgfSwKICAgIGRlZmVyUmVhZGluZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICh0cnVlICYmICEodGhpcyBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IGNhbGwgZGVmZXJSZWFkaW5lc3Mgb24gYW4gaW5zdGFuY2Ugb2YgQXBwbGljYXRpb24nLCB0aGlzIGluc3RhbmNlb2YgQXBwbGljYXRpb24pKTsKICAgICAgKHRydWUgJiYgISh0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMgPiAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgZGVmZXIgcmVhZGluZXNzIHNpbmNlIHRoZSBgcmVhZHkoKWAgaG9vayBoYXMgYWxyZWFkeSBiZWVuIGNhbGxlZC4nLCB0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMgPiAwKSk7CgogICAgICB0aGlzLl9yZWFkaW5lc3NEZWZlcnJhbHMrKzsKICAgIH0sCiAgICBhZHZhbmNlUmVhZGluZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICh0cnVlICYmICEodGhpcyBpbnN0YW5jZW9mIEFwcGxpY2F0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IGNhbGwgYWR2YW5jZVJlYWRpbmVzcyBvbiBhbiBpbnN0YW5jZSBvZiBBcHBsaWNhdGlvbicsIHRoaXMgaW5zdGFuY2VvZiBBcHBsaWNhdGlvbikpOwoKICAgICAgdGhpcy5fcmVhZGluZXNzRGVmZXJyYWxzLS07CgogICAgICBpZiAodGhpcy5fcmVhZGluZXNzRGVmZXJyYWxzID09PSAwKSB7CiAgICAgICAgKDAsIF9ydW5sb29wLm9uY2UpKHRoaXMsIHRoaXMuZGlkQmVjb21lUmVhZHkpOwogICAgICB9CiAgICB9LAogICAgYm9vdDogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fYm9vdFByb21pc2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYm9vdFByb21pc2U7CiAgICAgIH0KCiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5fYm9vdFN5bmMoKTsKICAgICAgfSBjYXRjaCAoXykgewogICAgICAgIC8vIElnbm9yZSB0aGUgZXJyb3I6IGluIHRoZSBhc3luY2hyb25vdXMgYm9vdCBwYXRoLCB0aGUgZXJyb3IgaXMgYWxyZWFkeSByZWZsZWN0ZWQKICAgICAgICAvLyBpbiB0aGUgcHJvbWlzZSByZWplY3Rpb24KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2Jvb3RQcm9taXNlOwogICAgfSwKICAgIF9ib290U3luYzogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fYm9vdGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBFdmVuIHRob3VnaCB0aGlzIHJldHVybnMgc3luY2hyb25vdXNseSwgd2Ugc3RpbGwgbmVlZCB0byBtYWtlIHN1cmUgdGhlCiAgICAgIC8vIGJvb3QgcHJvbWlzZSBleGlzdHMgZm9yIGJvb2sta2VlcGluZyBwdXJwb3NlczogaWYgYW55dGhpbmcgd2VudCB3cm9uZyBpbgogICAgICAvLyB0aGUgYm9vdCBwcm9jZXNzLCB3ZSBuZWVkIHRvIHN0b3JlIHRoZSBlcnJvciBhcyBhIHJlamVjdGlvbiBvbiB0aGUgYm9vdAogICAgICAvLyBwcm9taXNlIHNvIHRoYXQgYSBmdXR1cmUgY2FsbGVyIG9mIGBib290KClgIGNhbiB0ZWxsIHdoYXQgZmFpbGVkLgogICAgICB2YXIgZGVmZXIgPSB0aGlzLl9ib290UmVzb2x2ZXIgPSBfZW1iZXJSdW50aW1lLlJTVlAuZGVmZXIoKTsKICAgICAgdGhpcy5fYm9vdFByb21pc2UgPSBkZWZlci5wcm9taXNlOwoKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLnJ1bkluaXRpYWxpemVycygpOwogICAgICAgICgwLCBfbGF6eV9sb2FkLnJ1bkxvYWRIb29rcykoJ2FwcGxpY2F0aW9uJywgdGhpcyk7CiAgICAgICAgdGhpcy5hZHZhbmNlUmVhZGluZXNzKCk7CiAgICAgICAgLy8gQ29udGludWVzIHRvIGBkaWRCZWNvbWVSZWFkeWAKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBGb3IgdGhlIGFzeW5jaHJvbm91cyBib290IHBhdGgKICAgICAgICBkZWZlci5yZWplY3QoZXJyb3IpOwoKICAgICAgICAvLyBGb3IgdGhlIHN5bmNocm9ub3VzIGJvb3QgcGF0aAogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9LAogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgKHRydWUgJiYgISh0aGlzLl9nbG9iYWxzTW9kZSAmJiB0aGlzLmF1dG9ib290KSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0NhbGxpbmcgcmVzZXQoKSBvbiBpbnN0YW5jZXMgb2YgYEFwcGxpY2F0aW9uYCBpcyBub3RcbiAgICAgICAgICAgIHN1cHBvcnRlZCB3aGVuIGdsb2JhbHMgbW9kZSBpcyBkaXNhYmxlZDsgY2FsbCBgdmlzaXQoKWAgdG9cbiAgICAgICAgICAgIGNyZWF0ZSBuZXcgYEFwcGxpY2F0aW9uSW5zdGFuY2VgcyBhbmQgZGlzcG9zZSB0aGVtXG4gICAgICAgICAgICB2aWEgdGhlaXIgYGRlc3Ryb3koKWAgbWV0aG9kIGluc3RlYWQuJywgdGhpcy5fZ2xvYmFsc01vZGUgJiYgdGhpcy5hdXRvYm9vdCkpOwoKCiAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuX19kZXByZWNhdGVkSW5zdGFuY2VfXzsKCiAgICAgIHRoaXMuX3JlYWRpbmVzc0RlZmVycmFscyA9IDE7CiAgICAgIHRoaXMuX2Jvb3RQcm9taXNlID0gbnVsbDsKICAgICAgdGhpcy5fYm9vdFJlc29sdmVyID0gbnVsbDsKICAgICAgdGhpcy5fYm9vdGVkID0gZmFsc2U7CgogICAgICBmdW5jdGlvbiBoYW5kbGVSZXNldCgpIHsKICAgICAgICAoMCwgX3J1bmxvb3AucnVuKShpbnN0YW5jZSwgJ2Rlc3Ryb3knKTsKICAgICAgICB0aGlzLl9idWlsZERlcHJlY2F0ZWRJbnN0YW5jZSgpOwogICAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2FjdGlvbnMnLCB0aGlzLCAnX2Jvb3RTeW5jJyk7CiAgICAgIH0KCiAgICAgICgwLCBfcnVubG9vcC5qb2luKSh0aGlzLCBoYW5kbGVSZXNldCk7CiAgICB9LAogICAgZGlkQmVjb21lUmVhZHk6IGZ1bmN0aW9uICgpIHsKICAgICAgdHJ5IHsKICAgICAgICAvLyBUT0RPOiBJcyB0aGlzIHN0aWxsIG5lZWRlZCBmb3IgX2dsb2JhbHNNb2RlID0gZmFsc2U/CiAgICAgICAgaWYgKCEoMCwgX2RlYnVnLmlzVGVzdGluZykoKSkgewogICAgICAgICAgLy8gRWFnZXJseSBuYW1lIGFsbCBjbGFzc2VzIHRoYXQgYXJlIGFscmVhZHkgbG9hZGVkCiAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwucHJvY2Vzc0FsbE5hbWVzcGFjZXMpKCk7CiAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0TmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQpKHRydWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gU2VlIGRvY3VtZW50YXRpb24gb24gYF9hdXRvYm9vdCgpYCBmb3IgZGV0YWlscwogICAgICAgIGlmICh0aGlzLmF1dG9ib290KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB2b2lkIDA7CgogICAgICAgICAgaWYgKHRoaXMuX2dsb2JhbHNNb2RlKSB7CiAgICAgICAgICAgIC8vIElmIHdlIGFscmVhZHkgaGF2ZSB0aGUgX19kZXByZWNhdGVkSW5zdGFuY2VfXyBseWluZyBhcm91bmQsIGJvb3QgaXQgdG8KICAgICAgICAgICAgLy8gYXZvaWQgdW5uZWNlc3Nhcnkgd29yawogICAgICAgICAgICBpbnN0YW5jZSA9IHRoaXMuX19kZXByZWNhdGVkSW5zdGFuY2VfXzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgYnVpbGQgYW4gaW5zdGFuY2UgYW5kIGJvb3QgaXQuIFRoaXMgaXMgY3VycmVudGx5IHVucmVhY2hhYmxlLAogICAgICAgICAgICAvLyBiZWNhdXNlIHdlIGZvcmNlZCBfZ2xvYmFsc01vZGUgdG8gPT09IGF1dG9ib290OyBidXQgaGF2aW5nIHRoaXMgYnJhbmNoCiAgICAgICAgICAgIC8vIGFsbG93cyB1cyB0byBsb2NhbGx5IHRvZ2dsZSB0aGF0IGZsYWcgZm9yIHdlZWRpbmcgb3V0IGxlZ2FjeSBnbG9iYWxzIG1vZGUKICAgICAgICAgICAgLy8gZGVwZW5kZW5jaWVzIGluZGVwZW5kZW50bHkKICAgICAgICAgICAgaW5zdGFuY2UgPSB0aGlzLmJ1aWxkSW5zdGFuY2UoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpbnN0YW5jZS5fYm9vdFN5bmMoKTsKCiAgICAgICAgICAvLyBUT0RPOiBBcHAucmVhZHkoKSBpcyBub3QgY2FsbGVkIHdoZW4gYXV0b2Jvb3QgaXMgZGlzYWJsZWQsIGlzIHRoaXMgY29ycmVjdD8KICAgICAgICAgIHRoaXMucmVhZHkoKTsKCiAgICAgICAgICBpbnN0YW5jZS5zdGFydFJvdXRpbmcoKTsKICAgICAgICB9CgogICAgICAgIC8vIEZvciB0aGUgYXN5bmNocm9ub3VzIGJvb3QgcGF0aAogICAgICAgIHRoaXMuX2Jvb3RSZXNvbHZlci5yZXNvbHZlKHRoaXMpOwoKICAgICAgICAvLyBGb3IgdGhlIHN5bmNocm9ub3VzIGJvb3QgcGF0aAogICAgICAgIHRoaXMuX2Jvb3RlZCA9IHRydWU7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgLy8gRm9yIHRoZSBhc3luY2hyb25vdXMgYm9vdCBwYXRoCiAgICAgICAgdGhpcy5fYm9vdFJlc29sdmVyLnJlamVjdChlcnJvcik7CgogICAgICAgIC8vIEZvciB0aGUgc3luY2hyb25vdXMgYm9vdCBwYXRoCiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0sCiAgICByZWFkeTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3aWxsRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0TmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQpKGZhbHNlKTsKICAgICAgdGhpcy5fYm9vdGVkID0gZmFsc2U7CiAgICAgIHRoaXMuX2Jvb3RQcm9taXNlID0gbnVsbDsKICAgICAgdGhpcy5fYm9vdFJlc29sdmVyID0gbnVsbDsKCiAgICAgIGlmIChfbGF6eV9sb2FkLl9sb2FkZWQuYXBwbGljYXRpb24gPT09IHRoaXMpIHsKICAgICAgICBfbGF6eV9sb2FkLl9sb2FkZWQuYXBwbGljYXRpb24gPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9hcHBsaWNhdGlvbkluc3RhbmNlcy5sZW5ndGgpIHsKICAgICAgICB0aGlzLl9hcHBsaWNhdGlvbkluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICByZXR1cm4gaS5kZXN0cm95KCk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5fYXBwbGljYXRpb25JbnN0YW5jZXMubGVuZ3RoID0gMDsKICAgICAgfQogICAgfSwKICAgIHZpc2l0OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICByZXR1cm4gdGhpcy5ib290KCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gX3RoaXMuYnVpbGRJbnN0YW5jZSgpOwoKICAgICAgICByZXR1cm4gaW5zdGFuY2UuYm9vdChvcHRpb25zKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS52aXNpdCh1cmwpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgKDAsIF9ydW5sb29wLnJ1bikoaW5zdGFuY2UsICdkZXN0cm95Jyk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIEFwcGxpY2F0aW9uLnJlb3BlbkNsYXNzKHsKICAgIGJ1aWxkUmVnaXN0cnk6IGZ1bmN0aW9uICgpIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFycwogICAgICB2YXIgcmVnaXN0cnkgPSB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgY29tbW9uU2V0dXBSZWdpc3RyeShyZWdpc3RyeSk7CgogICAgICAoMCwgX2VtYmVyR2xpbW1lci5zZXR1cEFwcGxpY2F0aW9uUmVnaXN0cnkpKHJlZ2lzdHJ5KTsKCiAgICAgIHJldHVybiByZWdpc3RyeTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gY29tbW9uU2V0dXBSZWdpc3RyeShyZWdpc3RyeSkgewogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3JvdXRlcjptYWluJywgX2VtYmVyUm91dGluZy5Sb3V0ZXIuZXh0ZW5kKCkpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJy12aWV3LXJlZ2lzdHJ5Om1haW4nLCB7CiAgICAgIGNyZWF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdyb3V0ZTpiYXNpYycsIF9lbWJlclJvdXRpbmcuUm91dGUpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicsIF9lbWJlclZpZXdzLkV2ZW50RGlzcGF0Y2hlcik7CgogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZXI6bWFpbicsICduYW1lc3BhY2UnLCAnYXBwbGljYXRpb246bWFpbicpOwoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdsb2NhdGlvbjphdXRvJywgX2VtYmVyUm91dGluZy5BdXRvTG9jYXRpb24pOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2xvY2F0aW9uOmhhc2gnLCBfZW1iZXJSb3V0aW5nLkhhc2hMb2NhdGlvbik7CiAgICByZWdpc3RyeS5yZWdpc3RlcignbG9jYXRpb246aGlzdG9yeScsIF9lbWJlclJvdXRpbmcuSGlzdG9yeUxvY2F0aW9uKTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdsb2NhdGlvbjpub25lJywgX2VtYmVyUm91dGluZy5Ob25lTG9jYXRpb24pOwoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0KSwgewogICAgICBjcmVhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbmV3IF9lbWJlclJvdXRpbmcuQnVja2V0Q2FjaGUoKTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKHRydWUpIHsKICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6cm91dGVyJywgX2VtYmVyUm91dGluZy5Sb3V0ZXJTZXJ2aWNlKTsKICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOnJvdXRlcicsICdfcm91dGVyJywgJ3JvdXRlcjptYWluJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZWdpc3RlckxpYnJhcmllcygpIHsKICAgIGlmICghbGlicmFyaWVzUmVnaXN0ZXJlZCkgewogICAgICBsaWJyYXJpZXNSZWdpc3RlcmVkID0gdHJ1ZTsKCiAgICAgIGlmIChfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaGFzRE9NICYmICFfZW1iZXJWaWV3cy5qUXVlcnlEaXNhYmxlZCkgewogICAgICAgIF9lbWJlck1ldGFsLmxpYnJhcmllcy5yZWdpc3RlckNvcmVMaWJyYXJ5KCdqUXVlcnknLCAoMCwgX2VtYmVyVmlld3MualF1ZXJ5KSgpLmpxdWVyeSk7CiAgICAgIH0KICAgIH0KICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IEFwcGxpY2F0aW9uOwp9KTsKZW5pZmVkKCdAZW1iZXIvYXBwbGljYXRpb24vbGliL2xhenlfbG9hZCcsIFsnZXhwb3J0cycsICdlbWJlci1lbnZpcm9ubWVudCcsICdlbWJlci1icm93c2VyLWVudmlyb25tZW50J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJFbnZpcm9ubWVudCwgX2VtYmVyQnJvd3NlckVudmlyb25tZW50KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLl9sb2FkZWQgPSB1bmRlZmluZWQ7CiAgZXhwb3J0cy5vbkxvYWQgPSBvbkxvYWQ7CiAgZXhwb3J0cy5ydW5Mb2FkSG9va3MgPSBydW5Mb2FkSG9va3M7CgoKICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2FwcGxpY2F0aW9uCiAgKi8KCiAgLypnbG9iYWxzIEN1c3RvbUV2ZW50ICovCgogIHZhciBsb2FkSG9va3MgPSBfZW1iZXJFbnZpcm9ubWVudC5FTlYuRU1CRVJfTE9BRF9IT09LUyB8fCB7fTsKICB2YXIgbG9hZGVkID0ge307CiAgdmFyIF9sb2FkZWQgPSBleHBvcnRzLl9sb2FkZWQgPSBsb2FkZWQ7CgogIC8qKgogICAgRGV0ZWN0cyB3aGVuIGEgc3BlY2lmaWMgcGFja2FnZSBvZiBFbWJlciAoZS5nLiAnQXBwbGljYXRpb24nKQogICAgaGFzIGZ1bGx5IGxvYWRlZCBhbmQgaXMgYXZhaWxhYmxlIGZvciBleHRlbnNpb24uCiAgCiAgICBUaGUgcHJvdmlkZWQgYGNhbGxiYWNrYCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmFtZWAgcGFzc2VkCiAgICByZXNvbHZlZCBmcm9tIGEgc3RyaW5nIGludG8gdGhlIG9iamVjdDoKICAKICAgIGBgYCBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBvbkxvYWQgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgb25Mb2FkKCdFbWJlci5BcHBsaWNhdGlvbicgZnVuY3Rpb24oaGJhcnMpIHsKICAgICAgaGJhcnMucmVnaXN0ZXJIZWxwZXIoLi4uKTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIG9uTG9hZAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXBwbGljYXRpb24KICAgIEBwYXJhbSBuYW1lIHtTdHJpbmd9IG5hbWUgb2YgaG9vawogICAgQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0gY2FsbGJhY2sgdG8gYmUgY2FsbGVkCiAgICBAcHJpdmF0ZQogICovCiAgZnVuY3Rpb24gb25Mb2FkKG5hbWUsIGNhbGxiYWNrKSB7CiAgICB2YXIgb2JqZWN0ID0gbG9hZGVkW25hbWVdOwoKICAgIGxvYWRIb29rc1tuYW1lXSA9IGxvYWRIb29rc1tuYW1lXSB8fCBbXTsKICAgIGxvYWRIb29rc1tuYW1lXS5wdXNoKGNhbGxiYWNrKTsKCiAgICBpZiAob2JqZWN0KSB7CiAgICAgIGNhbGxiYWNrKG9iamVjdCk7CiAgICB9CiAgfQoKICAvKioKICAgIENhbGxlZCB3aGVuIGFuIEVtYmVyLmpzIHBhY2thZ2UgKGUuZyBBcHBsaWNhdGlvbikgaGFzIGZpbmlzaGVkCiAgICBsb2FkaW5nLiBUcmlnZ2VycyBhbnkgY2FsbGJhY2tzIHJlZ2lzdGVyZWQgZm9yIHRoaXMgZXZlbnQuCiAgCiAgICBAbWV0aG9kIHJ1bkxvYWRIb29rcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXBwbGljYXRpb24KICAgIEBwYXJhbSBuYW1lIHtTdHJpbmd9IG5hbWUgb2YgaG9vawogICAgQHBhcmFtIG9iamVjdCB7T2JqZWN0fSBvYmplY3QgdG8gcGFzcyB0byBjYWxsYmFja3MKICAgIEBwcml2YXRlCiAgKi8KICBmdW5jdGlvbiBydW5Mb2FkSG9va3MobmFtZSwgb2JqZWN0KSB7CiAgICBsb2FkZWRbbmFtZV0gPSBvYmplY3Q7CgogICAgaWYgKF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC53aW5kb3cgJiYgdHlwZW9mIEN1c3RvbUV2ZW50ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhciBldmVudCA9IG5ldyBDdXN0b21FdmVudChuYW1lLCB7IGRldGFpbDogb2JqZWN0LCBuYW1lOiBuYW1lIH0pOwogICAgICBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQud2luZG93LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfQoKICAgIGlmIChsb2FkSG9va3NbbmFtZV0pIHsKICAgICAgbG9hZEhvb2tzW25hbWVdLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG9iamVjdCk7CiAgICAgIH0pOwogICAgfQogIH0KfSk7CmVuaWZlZCgnQGVtYmVyL2FwcGxpY2F0aW9uL2xpYi92YWxpZGF0ZS10eXBlJywgWydleHBvcnRzJywgJ0BlbWJlci9kZWJ1ZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSB2YWxpZGF0ZVR5cGU7CgoKICB2YXIgVkFMSURBVEVEX1RZUEVTID0gewogICAgcm91dGU6IFsnYXNzZXJ0JywgJ2lzUm91dGVGYWN0b3J5JywgJ0VtYmVyLlJvdXRlJ10sCiAgICBjb21wb25lbnQ6IFsnZGVwcmVjYXRlJywgJ2lzQ29tcG9uZW50RmFjdG9yeScsICdFbWJlci5Db21wb25lbnQnXSwKICAgIHZpZXc6IFsnZGVwcmVjYXRlJywgJ2lzVmlld0ZhY3RvcnknLCAnRW1iZXIuVmlldyddLAogICAgc2VydmljZTogWydkZXByZWNhdGUnLCAnaXNTZXJ2aWNlRmFjdG9yeScsICdFbWJlci5TZXJ2aWNlJ10KICB9OwoKICBmdW5jdGlvbiB2YWxpZGF0ZVR5cGUocmVzb2x2ZWRUeXBlLCBwYXJzZWROYW1lKSB7CiAgICB2YXIgdmFsaWRhdGlvbkF0dHJpYnV0ZXMgPSBWQUxJREFURURfVFlQRVNbcGFyc2VkTmFtZS50eXBlXTsKCiAgICBpZiAoIXZhbGlkYXRpb25BdHRyaWJ1dGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZmFjdG9yeUZsYWcgPSB2YWxpZGF0aW9uQXR0cmlidXRlc1sxXSwKICAgICAgICBleHBlY3RlZFR5cGUgPSB2YWxpZGF0aW9uQXR0cmlidXRlc1syXTsKICAgICh0cnVlICYmICEoISFyZXNvbHZlZFR5cGVbZmFjdG9yeUZsYWddKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0V4cGVjdGVkICcgKyBwYXJzZWROYW1lLmZ1bGxOYW1lICsgJyB0byByZXNvbHZlIHRvIGFuICcgKyBleHBlY3RlZFR5cGUgKyAnIGJ1dCAnICsgKCdpbnN0ZWFkIGl0IHdhcyAnICsgcmVzb2x2ZWRUeXBlICsgJy4nKSwgISFyZXNvbHZlZFR5cGVbZmFjdG9yeUZsYWddKSk7CiAgfQp9KTsKZW5pZmVkKCdAZW1iZXIvY2FuYXJ5LWZlYXR1cmVzL2luZGV4JywgWydleHBvcnRzJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnZW1iZXItZW52aXJvbm1lbnQnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9wb2x5ZmlsbHMsIF9lbWJlckVudmlyb25tZW50KSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5FTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTiA9IGV4cG9ydHMuRU1CRVJfVEVNUExBVEVfQkxPQ0tfTEVUX0hFTFBFUiA9IGV4cG9ydHMuR0xJTU1FUl9DVVNUT01fQ09NUE9ORU5UX01BTkFHRVIgPSBleHBvcnRzLkVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyA9IGV4cG9ydHMuRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OID0gZXhwb3J0cy5FTUJFUl9FTkdJTkVTX01PVU5UX1BBUkFNUyA9IGV4cG9ydHMuRU1CRVJfUk9VVElOR19ST1VURVJfU0VSVklDRSA9IGV4cG9ydHMuRU1CRVJfR0xJTU1FUl9OQU1FRF9BUkdVTUVOVFMgPSBleHBvcnRzLkVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTiA9IGV4cG9ydHMuRU1CRVJfTElCUkFSSUVTX0lTUkVHSVNURVJFRCA9IGV4cG9ydHMuRkVBVFVSRVMgPSBleHBvcnRzLkRFRkFVTFRfRkVBVFVSRVMgPSB1bmRlZmluZWQ7CiAgICBleHBvcnRzLmlzRW5hYmxlZCA9IGlzRW5hYmxlZDsKCiAgICAvKioKICAgICBAbW9kdWxlIGVtYmVyL2NhbmFyeS1mZWF0dXJlcwogICAgIEBwcml2YXRlCiAgICAqLwogICAgdmFyIERFRkFVTFRfRkVBVFVSRVMgPSBleHBvcnRzLkRFRkFVTFRfRkVBVFVSRVMgPSB7CiAgICAgICAgRU1CRVJfTElCUkFSSUVTX0lTUkVHSVNURVJFRDogZmFsc2UsCiAgICAgICAgRU1CRVJfSU1QUk9WRURfSU5TVFJVTUVOVEFUSU9OOiBmYWxzZSwKICAgICAgICBFTUJFUl9HTElNTUVSX05BTUVEX0FSR1VNRU5UUzogdHJ1ZSwKICAgICAgICBFTUJFUl9ST1VUSU5HX1JPVVRFUl9TRVJWSUNFOiB0cnVlLAogICAgICAgIEVNQkVSX0VOR0lORVNfTU9VTlRfUEFSQU1TOiB0cnVlLAogICAgICAgIEVNQkVSX01PRFVMRV9VTklGSUNBVElPTjogZmFsc2UsCiAgICAgICAgR0xJTU1FUl9DVVNUT01fQ09NUE9ORU5UX01BTkFHRVI6IGZhbHNlLAogICAgICAgIEVNQkVSX1RFTVBMQVRFX0JMT0NLX0xFVF9IRUxQRVI6IHRydWUsCiAgICAgICAgRU1CRVJfTUVUQUxfVFJBQ0tFRF9QUk9QRVJUSUVTOiBmYWxzZSwKICAgICAgICBFTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTjogZmFsc2UKICAgIH07CiAgICAvKioKICAgICAgVGhlIGhhc2ggb2YgZW5hYmxlZCBDYW5hcnkgZmVhdHVyZXMuIEFkZCB0byB0aGlzLCBhbnkgY2FuYXJ5IGZlYXR1cmVzCiAgICAgIGJlZm9yZSBjcmVhdGluZyB5b3VyIGFwcGxpY2F0aW9uLgogICAgCiAgICAgIEFsdGVybmF0aXZlbHkgKGFuZCByZWNvbW1lbmRlZCksIHlvdSBjYW4gYWxzbyBkZWZpbmUgYEVtYmVyRU5WLkZFQVRVUkVTYAogICAgICBpZiB5b3UgbmVlZCB0byBlbmFibGUgZmVhdHVyZXMgZmxhZ2dlZCBhdCBydW50aW1lLgogICAgCiAgICAgIEBjbGFzcyBGRUFUVVJFUwogICAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICAgIEBzdGF0aWMKICAgICAgQHNpbmNlIDEuMS4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICB2YXIgRkVBVFVSRVMgPSBleHBvcnRzLkZFQVRVUkVTID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShERUZBVUxUX0ZFQVRVUkVTLCBfZW1iZXJFbnZpcm9ubWVudC5FTlYuRkVBVFVSRVMpOwogICAgLyoqCiAgICAgIERldGVybWluZSB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgYGZlYXR1cmVgIGlzIGVuYWJsZWQuIFVzZWQgYnkgRW1iZXIncwogICAgICBidWlsZCB0b29scyB0byBleGNsdWRlIGV4cGVyaW1lbnRhbCBmZWF0dXJlcyBmcm9tIGJldGEvc3RhYmxlIGJ1aWxkcy4KICAgIAogICAgICBZb3UgY2FuIGRlZmluZSB0aGUgZm9sbG93aW5nIGNvbmZpZ3VyYXRpb24gb3B0aW9uczoKICAgIAogICAgICAqIGBFbWJlckVOVi5FTkFCTEVfT1BUSU9OQUxfRkVBVFVSRVNgIC0gZW5hYmxlIGFueSBmZWF0dXJlcyB0aGF0IGhhdmUgbm90IGJlZW4gZXhwbGljaXRseQogICAgICAgIGVuYWJsZWQvZGlzYWJsZWQuCiAgICAKICAgICAgQG1ldGhvZCBpc0VuYWJsZWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IGZlYXR1cmUgVGhlIGZlYXR1cmUgdG8gY2hlY2sKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgQGZvciBFbWJlci5GRUFUVVJFUwogICAgICBAc2luY2UgMS4xLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGlzRW5hYmxlZChmZWF0dXJlKSB7CiAgICAgICAgdmFyIGZlYXR1cmVWYWx1ZSA9IEZFQVRVUkVTW2ZlYXR1cmVdOwogICAgICAgIGlmIChmZWF0dXJlVmFsdWUgPT09IHRydWUgfHwgZmVhdHVyZVZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmVhdHVyZVZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoX2VtYmVyRW52aXJvbm1lbnQuRU5WLkVOQUJMRV9PUFRJT05BTF9GRUFUVVJFUykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmVhdHVyZVZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5FTkFCTEVfT1BUSU9OQUxfRkVBVFVSRVMgJiYgdmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHZhciBFTUJFUl9MSUJSQVJJRVNfSVNSRUdJU1RFUkVEID0gZXhwb3J0cy5FTUJFUl9MSUJSQVJJRVNfSVNSRUdJU1RFUkVEID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX0xJQlJBUklFU19JU1JFR0lTVEVSRUQpOwogICAgdmFyIEVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTiA9IGV4cG9ydHMuRU1CRVJfSU1QUk9WRURfSU5TVFJVTUVOVEFUSU9OID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX0lNUFJPVkVEX0lOU1RSVU1FTlRBVElPTik7CiAgICB2YXIgRU1CRVJfR0xJTU1FUl9OQU1FRF9BUkdVTUVOVFMgPSBleHBvcnRzLkVNQkVSX0dMSU1NRVJfTkFNRURfQVJHVU1FTlRTID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX0dMSU1NRVJfTkFNRURfQVJHVU1FTlRTKTsKICAgIHZhciBFTUJFUl9ST1VUSU5HX1JPVVRFUl9TRVJWSUNFID0gZXhwb3J0cy5FTUJFUl9ST1VUSU5HX1JPVVRFUl9TRVJWSUNFID0gZmVhdHVyZVZhbHVlKEZFQVRVUkVTLkVNQkVSX1JPVVRJTkdfUk9VVEVSX1NFUlZJQ0UpOwogICAgdmFyIEVNQkVSX0VOR0lORVNfTU9VTlRfUEFSQU1TID0gZXhwb3J0cy5FTUJFUl9FTkdJTkVTX01PVU5UX1BBUkFNUyA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5FTUJFUl9FTkdJTkVTX01PVU5UX1BBUkFNUyk7CiAgICB2YXIgRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OID0gZXhwb3J0cy5FTUJFUl9NT0RVTEVfVU5JRklDQVRJT04gPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OKTsKICAgIHZhciBFTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMgPSBleHBvcnRzLkVNQkVSX01FVEFMX1RSQUNLRURfUFJPUEVSVElFUyA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5FTUJFUl9NRVRBTF9UUkFDS0VEX1BST1BFUlRJRVMpOwogICAgdmFyIEdMSU1NRVJfQ1VTVE9NX0NPTVBPTkVOVF9NQU5BR0VSID0gZXhwb3J0cy5HTElNTUVSX0NVU1RPTV9DT01QT05FTlRfTUFOQUdFUiA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5HTElNTUVSX0NVU1RPTV9DT01QT05FTlRfTUFOQUdFUik7CiAgICB2YXIgRU1CRVJfVEVNUExBVEVfQkxPQ0tfTEVUX0hFTFBFUiA9IGV4cG9ydHMuRU1CRVJfVEVNUExBVEVfQkxPQ0tfTEVUX0hFTFBFUiA9IGZlYXR1cmVWYWx1ZShGRUFUVVJFUy5FTUJFUl9URU1QTEFURV9CTE9DS19MRVRfSEVMUEVSKTsKICAgIHZhciBFTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTiA9IGV4cG9ydHMuRU1CRVJfR0xJTU1FUl9BTkdMRV9CUkFDS0VUX0lOVk9DQVRJT04gPSBmZWF0dXJlVmFsdWUoRkVBVFVSRVMuRU1CRVJfR0xJTU1FUl9BTkdMRV9CUkFDS0VUX0lOVk9DQVRJT04pOwogICAgLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5kZXguanMubWFwCn0pOwplbmlmZWQoJ0BlbWJlci9jb250cm9sbGVyL2luZGV4JywgWydleHBvcnRzJywgJ2VtYmVyLXJ1bnRpbWUnLCAnQGVtYmVyL2NvbnRyb2xsZXIvbGliL2NvbnRyb2xsZXJfbWl4aW4nLCAnZW1iZXItbWV0YWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlclJ1bnRpbWUsIF9jb250cm9sbGVyX21peGluLCBfZW1iZXJNZXRhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5pbmplY3QgPSBpbmplY3Q7CgoKICAvKioKICBAbW9kdWxlIEBlbWJlci9jb250cm9sbGVyCiAgKi8KCiAgLyoqCiAgICBAY2xhc3MgQ29udHJvbGxlcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEB1c2VzIEVtYmVyLkNvbnRyb2xsZXJNaXhpbgogICAgQHB1YmxpYwogICovCiAgdmFyIENvbnRyb2xsZXIgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoX2NvbnRyb2xsZXJfbWl4aW4uZGVmYXVsdCk7CgogIC8qKgogICAgQ3JlYXRlcyBhIHByb3BlcnR5IHRoYXQgbGF6aWx5IGxvb2tzIHVwIGFub3RoZXIgY29udHJvbGxlciBpbiB0aGUgY29udGFpbmVyLgogICAgQ2FuIG9ubHkgYmUgdXNlZCB3aGVuIGRlZmluaW5nIGFub3RoZXIgY29udHJvbGxlci4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBhcHAvY29udHJvbGxlcnMvcG9zdC5qcwogICAgaW1wb3J0IENvbnRyb2xsZXIsIHsKICAgICAgaW5qZWN0IGFzIGNvbnRyb2xsZXIKICAgIH0gZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogIAogICAgZXhwb3J0IGRlZmF1bHQgQ29udHJvbGxlci5leHRlbmQoewogICAgICBwb3N0czogY29udHJvbGxlcigpCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhpcyBleGFtcGxlIHdpbGwgY3JlYXRlIGEgYHBvc3RzYCBwcm9wZXJ0eSBvbiB0aGUgYHBvc3RgIGNvbnRyb2xsZXIgdGhhdAogICAgbG9va3MgdXAgdGhlIGBwb3N0c2AgY29udHJvbGxlciBpbiB0aGUgY29udGFpbmVyLCBtYWtpbmcgaXQgZWFzeSB0bwogICAgcmVmZXJlbmNlIG90aGVyIGNvbnRyb2xsZXJzLgogIAogICAgQG1ldGhvZCBpbmplY3QKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL2NvbnRyb2xsZXIKICAgIEBzaW5jZSAxLjEwLjAKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIChvcHRpb25hbCkgbmFtZSBvZiB0aGUgY29udHJvbGxlciB0byBpbmplY3QsIGRlZmF1bHRzCiAgICAgICAgICAgdG8gdGhlIHByb3BlcnR5J3MgbmFtZQogICAgQHJldHVybiB7RW1iZXIuSW5qZWN0ZWRQcm9wZXJ0eX0gaW5qZWN0aW9uIGRlc2NyaXB0b3IgaW5zdGFuY2UKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGluamVjdChuYW1lLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IF9lbWJlck1ldGFsLkluamVjdGVkUHJvcGVydHkoJ2NvbnRyb2xsZXInLCBuYW1lLCBvcHRpb25zKTsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IENvbnRyb2xsZXI7Cn0pOwplbmlmZWQoJ0BlbWJlci9jb250cm9sbGVyL2xpYi9jb250cm9sbGVyX21peGluJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXJ1bnRpbWUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoX2VtYmVyUnVudGltZS5BY3Rpb25IYW5kbGVyLCB7CiAgICAvKiBkdWNrdHlwZSBhcyBhIGNvbnRyb2xsZXIgKi8KICAgIGlzQ29udHJvbGxlcjogdHJ1ZSwKCiAgICAvKioKICAgICAgVGhlIG9iamVjdCB0byB3aGljaCBhY3Rpb25zIGZyb20gdGhlIHZpZXcgc2hvdWxkIGJlIHNlbnQuCiAgICAgICBGb3IgZXhhbXBsZSwgd2hlbiBhIEhhbmRsZWJhcnMgdGVtcGxhdGUgdXNlcyB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciwKICAgICAgaXQgd2lsbCBhdHRlbXB0IHRvIHNlbmQgdGhlIGFjdGlvbiB0byB0aGUgdmlldydzIGNvbnRyb2xsZXIncyBgdGFyZ2V0YC4KICAgICAgIEJ5IGRlZmF1bHQsIHRoZSB2YWx1ZSBvZiB0aGUgdGFyZ2V0IHByb3BlcnR5IGlzIHNldCB0byB0aGUgcm91dGVyLCBhbmQKICAgICAgaXMgaW5qZWN0ZWQgd2hlbiBhIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkLiBUaGlzIGluamVjdGlvbiBpcyBhcHBsaWVkCiAgICAgIGFzIHBhcnQgb2YgdGhlIGFwcGxpY2F0aW9uJ3MgaW5pdGlhbGl6YXRpb24gcHJvY2Vzcy4gSW4gbW9zdCBjYXNlcyB0aGUKICAgICAgYHRhcmdldGAgcHJvcGVydHkgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHNldCB0byB0aGUgbG9naWNhbCBjb25zdW1lciBvZgogICAgICBhY3Rpb25zIGZvciB0aGUgY29udHJvbGxlci4KICAgICAgIEBwcm9wZXJ0eSB0YXJnZXQKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHVibGljCiAgICAqLwogICAgdGFyZ2V0OiBudWxsLAoKICAgIHN0b3JlOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgY29udHJvbGxlcidzIGN1cnJlbnQgbW9kZWwuIFdoZW4gcmV0cmlldmluZyBvciBtb2RpZnlpbmcgYSBjb250cm9sbGVyJ3MKICAgICAgbW9kZWwsIHRoaXMgcHJvcGVydHkgc2hvdWxkIGJlIHVzZWQgaW5zdGVhZCBvZiB0aGUgYGNvbnRlbnRgIHByb3BlcnR5LgogICAgICAgQHByb3BlcnR5IG1vZGVsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBtb2RlbDogbnVsbAogIH0pOwp9KTsKZW5pZmVkKCdAZW1iZXIvZGVidWcvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnL2xpYi93YXJuJywgJ0BlbWJlci9kZWJ1Zy9saWIvZGVwcmVjYXRlJywgJ0BlbWJlci9kZWJ1Zy9saWIvdGVzdGluZycsICdAZW1iZXIvZXJyb3InLCAnZW1iZXItYnJvd3Nlci1lbnZpcm9ubWVudCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3dhcm4yLCBfZGVwcmVjYXRlMiwgX3Rlc3RpbmcsIF9lcnJvciwgX2VtYmVyQnJvd3NlckVudmlyb25tZW50KSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5fd2FybklmVXNpbmdTdHJpcHBlZEZlYXR1cmVGbGFncyA9IGV4cG9ydHMuZ2V0RGVidWdGdW5jdGlvbiA9IGV4cG9ydHMuc2V0RGVidWdGdW5jdGlvbiA9IGV4cG9ydHMuZGVwcmVjYXRlRnVuYyA9IGV4cG9ydHMucnVuSW5EZWJ1ZyA9IGV4cG9ydHMuZGVidWdGcmVlemUgPSBleHBvcnRzLmRlYnVnU2VhbCA9IGV4cG9ydHMuZGVwcmVjYXRlID0gZXhwb3J0cy5kZWJ1ZyA9IGV4cG9ydHMud2FybiA9IGV4cG9ydHMuaW5mbyA9IGV4cG9ydHMuYXNzZXJ0ID0gZXhwb3J0cy5zZXRUZXN0aW5nID0gZXhwb3J0cy5pc1Rlc3RpbmcgPSBleHBvcnRzLnJlZ2lzdGVyRGVwcmVjYXRpb25IYW5kbGVyID0gZXhwb3J0cy5yZWdpc3Rlcldhcm5IYW5kbGVyID0gdW5kZWZpbmVkOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdyZWdpc3Rlcldhcm5IYW5kbGVyJywgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBfd2FybjIucmVnaXN0ZXJIYW5kbGVyOwogICAgICAgIH0KICAgIH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdyZWdpc3RlckRlcHJlY2F0aW9uSGFuZGxlcicsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gX2RlcHJlY2F0ZTIucmVnaXN0ZXJIYW5kbGVyOwogICAgICAgIH0KICAgIH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdpc1Rlc3RpbmcnLCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIF90ZXN0aW5nLmlzVGVzdGluZzsKICAgICAgICB9CiAgICB9KTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnc2V0VGVzdGluZycsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gX3Rlc3Rpbmcuc2V0VGVzdGluZzsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBUaGVzZSBhcmUgdGhlIGRlZmF1bHQgcHJvZHVjdGlvbiBidWlsZCB2ZXJzaW9uczoKICAgIHZhciBub29wID0gZnVuY3Rpb24gKCkge307CiAgICB2YXIgYXNzZXJ0ID0gbm9vcDsKICAgIHZhciBpbmZvID0gbm9vcDsKICAgIHZhciB3YXJuID0gbm9vcDsKICAgIHZhciBkZWJ1ZyA9IG5vb3A7CiAgICB2YXIgZGVwcmVjYXRlID0gbm9vcDsKICAgIHZhciBkZWJ1Z1NlYWwgPSBub29wOwogICAgdmFyIGRlYnVnRnJlZXplID0gbm9vcDsKICAgIHZhciBydW5JbkRlYnVnID0gbm9vcDsKICAgIHZhciBzZXREZWJ1Z0Z1bmN0aW9uID0gbm9vcDsKICAgIHZhciBnZXREZWJ1Z0Z1bmN0aW9uID0gbm9vcDsKICAgIHZhciBkZXByZWNhdGVGdW5jID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aCAtIDFdOwogICAgfTsKICAgIGlmICh0cnVlKSB7CiAgICAgICAgZXhwb3J0cy5zZXREZWJ1Z0Z1bmN0aW9uID0gc2V0RGVidWdGdW5jdGlvbiA9IGZ1bmN0aW9uICh0eXBlLCBjYWxsYmFjaykgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2Fzc2VydCc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMuYXNzZXJ0ID0gYXNzZXJ0ID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYXNlICdpbmZvJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5pbmZvID0gaW5mbyA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FzZSAnd2Fybic6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMud2FybiA9IHdhcm4gPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNhc2UgJ2RlYnVnJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5kZWJ1ZyA9IGRlYnVnID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYXNlICdkZXByZWNhdGUnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBleHBvcnRzLmRlcHJlY2F0ZSA9IGRlcHJlY2F0ZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FzZSAnZGVidWdTZWFsJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5kZWJ1Z1NlYWwgPSBkZWJ1Z1NlYWwgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNhc2UgJ2RlYnVnRnJlZXplJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5kZWJ1Z0ZyZWV6ZSA9IGRlYnVnRnJlZXplID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBjYXNlICdydW5JbkRlYnVnJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5ydW5JbkRlYnVnID0gcnVuSW5EZWJ1ZyA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2FzZSAnZGVwcmVjYXRlRnVuYyc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cG9ydHMuZGVwcmVjYXRlRnVuYyA9IGRlcHJlY2F0ZUZ1bmMgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZXhwb3J0cy5nZXREZWJ1Z0Z1bmN0aW9uID0gZ2V0RGVidWdGdW5jdGlvbiA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnYXNzZXJ0JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXNzZXJ0OwogICAgICAgICAgICAgICAgY2FzZSAnaW5mbyc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgICAgICAgICBjYXNlICd3YXJuJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2FybjsKICAgICAgICAgICAgICAgIGNhc2UgJ2RlYnVnJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVidWc7CiAgICAgICAgICAgICAgICBjYXNlICdkZXByZWNhdGUnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZXByZWNhdGU7CiAgICAgICAgICAgICAgICBjYXNlICdkZWJ1Z1NlYWwnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWJ1Z1NlYWw7CiAgICAgICAgICAgICAgICBjYXNlICdkZWJ1Z0ZyZWV6ZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlYnVnRnJlZXplOwogICAgICAgICAgICAgICAgY2FzZSAncnVuSW5EZWJ1Zyc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJ1bkluRGVidWc7CiAgICAgICAgICAgICAgICBjYXNlICdkZXByZWNhdGVGdW5jJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVwcmVjYXRlRnVuYzsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2RlYnVnCiAgICAqLwogICAgaWYgKHRydWUpIHsKICAgICAgICAvKioKICAgICAgICAgIFZlcmlmeSB0aGF0IGEgY2VydGFpbiBleHBlY3RhdGlvbiBpcyBtZXQsIG9yIHRocm93IGEgZXhjZXB0aW9uIG90aGVyd2lzZS4KICAgICAgICAgICAgIFRoaXMgaXMgdXNlZnVsIGZvciBjb21tdW5pY2F0aW5nIGFzc3VtcHRpb25zIGluIHRoZSBjb2RlIHRvIG90aGVyIGh1bWFuCiAgICAgICAgICByZWFkZXJzIGFzIHdlbGwgYXMgY2F0Y2hpbmcgYnVncyB0aGF0IGFjY2lkZW50YWxseSB2aW9sYXRlcyB0aGVzZQogICAgICAgICAgZXhwZWN0YXRpb25zLgogICAgICAgICAgICAgQXNzZXJ0aW9ucyBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZSBmcmVlbHkgYWRkZWQKICAgICAgICAgIGZvciBkb2N1bWVudGF0aW9uIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMgd2l0aG91dCB3b3JyaWVzIG9mIGluY3VyaW5nIGFueQogICAgICAgICAgcGVyZm9ybWFuY2UgcGVuYWx0eS4gSG93ZXZlciwgYmVjYXVzZSBvZiB0aGF0LCB0aGV5IHNob3VsZCBub3QgYmUgdXNlZCBmb3IKICAgICAgICAgIGNoZWNrcyB0aGF0IGNvdWxkIHJlYXNvbmFibHkgZmFpbCBkdXJpbmcgbm9ybWFsIHVzYWdlLiBGdXJ0aGVybW9yZSwgY2FyZQogICAgICAgICAgc2hvdWxkIGJlIHRha2VuIHRvIGF2b2lkIGFjY2lkZW50YWxseSByZWx5aW5nIG9uIHNpZGUtZWZmZWN0cyBwcm9kdWNlZCBmcm9tCiAgICAgICAgICBldmFsdWF0aW5nIHRoZSBjb25kaXRpb24gaXRzZWxmLCBzaW5jZSB0aGUgY29kZSB3aWxsIG5vdCBydW4gaW4gcHJvZHVjdGlvbi4KICAgICAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICAgIGltcG9ydCB7IGFzc2VydCB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICAgICAgICAvLyBUZXN0IGZvciB0cnV0aGluZXNzCiAgICAgICAgICBhc3NlcnQoJ011c3QgcGFzcyBhIHN0cmluZycsIHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnKTsKICAgICAgICAgICAgIC8vIEZhaWwgdW5jb25kaXRpb25hbGx5CiAgICAgICAgICBhc3NlcnQoJ1RoaXMgY29kZSBwYXRoIHNob3VsZCBuZXZlciBiZSBydW4nKTsKICAgICAgICAgIGBgYAogICAgICAgICAgICAgQG1ldGhvZCBhc3NlcnQKICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgIEBmb3IgQGVtYmVyL2RlYnVnCiAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gZGVzY3JpcHRpb24gRGVzY3JpYmVzIHRoZSBleHBlY3RhdGlvbi4gVGhpcyB3aWxsIGJlY29tZSB0aGUKICAgICAgICAgICAgdGV4dCBvZiB0aGUgRXJyb3IgdGhyb3duIGlmIHRoZSBhc3NlcnRpb24gZmFpbHMuCiAgICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IGNvbmRpdGlvbiBNdXN0IGJlIHRydXRoeSBmb3IgdGhlIGFzc2VydGlvbiB0byBwYXNzLiBJZgogICAgICAgICAgICBmYWxzeSwgYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLgogICAgICAgICAgQHB1YmxpYwogICAgICAgICAgQHNpbmNlIDEuMC4wCiAgICAgICAgKi8KICAgICAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdhc3NlcnQnLCBmdW5jdGlvbiBhc3NlcnQoZGVzYywgdGVzdCkgewogICAgICAgICAgICBpZiAoIXRlc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgnQXNzZXJ0aW9uIEZhaWxlZDogJyArIGRlc2MpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgLyoqCiAgICAgICAgICBEaXNwbGF5IGEgZGVidWcgbm90aWNlLgogICAgICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICAgICAgZnJlZWx5IGFkZGVkIGZvciBkb2N1bWVudGF0aW9uIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMgd2l0aG91dCB3b3JyaWVzIG9mCiAgICAgICAgICBpbmN1cmluZyBhbnkgcGVyZm9ybWFuY2UgcGVuYWx0eS4KICAgICAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICAgIGltcG9ydCB7IGRlYnVnIH0gZnJvbSAnQGVtYmVyL2RlYnVnJzsKICAgICAgICAgICAgIGRlYnVnKCdJXCdtIGEgZGVidWcgbm90aWNlIScpOwogICAgICAgICAgYGBgCiAgICAgICAgICAgICBAbWV0aG9kIGRlYnVnCiAgICAgICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICAgICAgQHN0YXRpYwogICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgQSBkZWJ1ZyBtZXNzYWdlIHRvIGRpc3BsYXkuCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdkZWJ1ZycsIGZ1bmN0aW9uIGRlYnVnKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqLwogICAgICAgICAgICBpZiAoY29uc29sZS5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnREVCVUc6ICcgKyBtZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdERUJVRzogJyArIG1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qIGVzbGludC1lbnNhYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgICB9KTsKICAgICAgICAvKioKICAgICAgICAgIERpc3BsYXkgYW4gaW5mbyBub3RpY2UuCiAgICAgICAgICAgICBDYWxscyB0byB0aGlzIGZ1bmN0aW9uIGFyZSByZW1vdmVkIGZyb20gcHJvZHVjdGlvbiBidWlsZHMsIHNvIHRoZXkgY2FuIGJlCiAgICAgICAgICBmcmVlbHkgYWRkZWQgZm9yIGRvY3VtZW50YXRpb24gYW5kIGRlYnVnZ2luZyBwdXJwb3NlcyB3aXRob3V0IHdvcnJpZXMgb2YKICAgICAgICAgIGluY3VyaW5nIGFueSBwZXJmb3JtYW5jZSBwZW5hbHR5LgogICAgICAgICAgICAgQG1ldGhvZCBpbmZvCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICovCiAgICAgICAgc2V0RGVidWdGdW5jdGlvbignaW5mbycsIGZ1bmN0aW9uIGluZm8oKSB7CiAgICAgICAgICAgIHZhciBfY29uc29sZTsKCiAgICAgICAgICAgIChfY29uc29sZSA9IGNvbnNvbGUpLmluZm8uYXBwbHkoX2NvbnNvbGUsIGFyZ3VtZW50cyk7IC8qIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZSAqLwogICAgICAgIH0pOwogICAgICAgIC8qKgogICAgICAgICBAbW9kdWxlIEBlbWJlci9hcHBsaWNhdGlvbgogICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICAvKioKICAgICAgICAgIEFsaWFzIGFuIG9sZCwgZGVwcmVjYXRlZCBtZXRob2Qgd2l0aCBpdHMgbmV3IGNvdW50ZXJwYXJ0LgogICAgICAgICAgICAgRGlzcGxheSBhIGRlcHJlY2F0aW9uIHdhcm5pbmcgd2l0aCB0aGUgcHJvdmlkZWQgbWVzc2FnZSBhbmQgYSBzdGFjayB0cmFjZQogICAgICAgICAgKENocm9tZSBhbmQgRmlyZWZveCBvbmx5KSB3aGVuIHRoZSBhc3NpZ25lZCBtZXRob2QgaXMgY2FsbGVkLgogICAgICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICAgICAgZnJlZWx5IGFkZGVkIGZvciBkb2N1bWVudGF0aW9uIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMgd2l0aG91dCB3b3JyaWVzIG9mCiAgICAgICAgICBpbmN1cmluZyBhbnkgcGVyZm9ybWFuY2UgcGVuYWx0eS4KICAgICAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICAgIGltcG9ydCB7IGRlcHJlY2F0ZUZ1bmMgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24vZGVwcmVjYXRpb25zJzsKICAgICAgICAgICAgIEVtYmVyLm9sZE1ldGhvZCA9IGRlcHJlY2F0ZUZ1bmMoJ1BsZWFzZSB1c2UgdGhlIG5ldywgdXBkYXRlZCBtZXRob2QnLCBvcHRpb25zLCBFbWJlci5uZXdNZXRob2QpOwogICAgICAgICAgYGBgCiAgICAgICAgICAgICBAbWV0aG9kIGRlcHJlY2F0ZUZ1bmMKICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgIEBmb3IgQGVtYmVyL2FwcGxpY2F0aW9uL2RlcHJlY2F0aW9ucwogICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgQSBkZXNjcmlwdGlvbiBvZiB0aGUgZGVwcmVjYXRpb24uCiAgICAgICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdCBmb3IgYGRlcHJlY2F0ZWAuCiAgICAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBuZXcgZnVuY3Rpb24gY2FsbGVkIHRvIHJlcGxhY2UgaXRzIGRlcHJlY2F0ZWQgY291bnRlcnBhcnQuCiAgICAgICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gQSBuZXcgZnVuY3Rpb24gdGhhdCB3cmFwcyB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gd2l0aCBhIGRlcHJlY2F0aW9uIHdhcm5pbmcKICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgKi8KICAgICAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdkZXByZWNhdGVGdW5jJywgZnVuY3Rpb24gZGVwcmVjYXRlRnVuYygpIHsKICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMykgewogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBhcmdzWzBdLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBhcmdzWzFdLAogICAgICAgICAgICAgICAgICAgIGZ1bmMgPSBhcmdzWzJdOwoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwcmVjYXRlKG1lc3NhZ2UsIGZhbHNlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfbWVzc2FnZSA9IGFyZ3NbMF0sCiAgICAgICAgICAgICAgICAgICAgX2Z1bmMgPSBhcmdzWzFdOwoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwcmVjYXRlKF9tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2Z1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAvKioKICAgICAgICAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAgICAgICAgQHB1YmxpYwogICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgICBSdW4gYSBmdW5jdGlvbiBtZWFudCBmb3IgZGVidWdnaW5nLgogICAgICAgICAgICAgQ2FsbHMgdG8gdGhpcyBmdW5jdGlvbiBhcmUgcmVtb3ZlZCBmcm9tIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB0aGV5IGNhbiBiZQogICAgICAgICAgZnJlZWx5IGFkZGVkIGZvciBkb2N1bWVudGF0aW9uIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMgd2l0aG91dCB3b3JyaWVzIG9mCiAgICAgICAgICBpbmN1cmluZyBhbnkgcGVyZm9ybWFuY2UgcGVuYWx0eS4KICAgICAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICAgICBpbXBvcnQgeyBydW5JbkRlYnVnIH0gZnJvbSAnQGVtYmVyL2RlYnVnJzsKICAgICAgICAgICAgIHJ1bkluRGVidWcoKCkgPT4gewogICAgICAgICAgICBDb21wb25lbnQucmVvcGVuKHsKICAgICAgICAgICAgICBkaWRJbnNlcnRFbGVtZW50KCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkknbSBoYXBweSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGBgYAogICAgICAgICAgICAgQG1ldGhvZCBydW5JbkRlYnVnCiAgICAgICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICAgICAgQHN0YXRpYwogICAgICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICBAc2luY2UgMS41LjAKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAqLwogICAgICAgIHNldERlYnVnRnVuY3Rpb24oJ3J1bkluRGVidWcnLCBmdW5jdGlvbiBydW5JbkRlYnVnKGZ1bmMpIHsKICAgICAgICAgICAgZnVuYygpOwogICAgICAgIH0pOwogICAgICAgIHNldERlYnVnRnVuY3Rpb24oJ2RlYnVnU2VhbCcsIGZ1bmN0aW9uIGRlYnVnU2VhbChvYmopIHsKICAgICAgICAgICAgT2JqZWN0LnNlYWwob2JqKTsKICAgICAgICB9KTsKICAgICAgICBzZXREZWJ1Z0Z1bmN0aW9uKCdkZWJ1Z0ZyZWV6ZScsIGZ1bmN0aW9uIGRlYnVnRnJlZXplKG9iaikgewogICAgICAgICAgICBPYmplY3QuZnJlZXplKG9iaik7CiAgICAgICAgfSk7CiAgICAgICAgc2V0RGVidWdGdW5jdGlvbignZGVwcmVjYXRlJywgX2RlcHJlY2F0ZTIuZGVmYXVsdCk7CiAgICAgICAgc2V0RGVidWdGdW5jdGlvbignd2FybicsIF93YXJuMi5kZWZhdWx0KTsKICAgIH0KICAgIHZhciBfd2FybklmVXNpbmdTdHJpcHBlZEZlYXR1cmVGbGFncyA9IHZvaWQgMDsKICAgIGlmICh0cnVlICYmICEoMCwgX3Rlc3RpbmcuaXNUZXN0aW5nKSgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIChfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaXNGaXJlZm94IHx8IF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC5pc0Nocm9tZSkgJiYgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kYXRhc2V0ICYmICFkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZGF0YXNldC5lbWJlckV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgICAgIHZhciBkb3dubG9hZFVSTCA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoX2VtYmVyQnJvd3NlckVudmlyb25tZW50LmlzQ2hyb21lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvd25sb2FkVVJMID0gJ2h0dHBzOi8vY2hyb21lLmdvb2dsZS5jb20vd2Vic3RvcmUvZGV0YWlsL2VtYmVyLWluc3BlY3Rvci9ibWRibG5jZWdrZW5rYWNpZWloZmhwamZwcG9jb25oaSc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaXNGaXJlZm94KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvd25sb2FkVVJMID0gJ2h0dHBzOi8vYWRkb25zLm1vemlsbGEub3JnL2VuLVVTL2ZpcmVmb3gvYWRkb24vZW1iZXItaW5zcGVjdG9yLyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRlYnVnKCdGb3IgbW9yZSBhZHZhbmNlZCBkZWJ1Z2dpbmcsIGluc3RhbGwgdGhlIEVtYmVyIEluc3BlY3RvciBmcm9tICcgKyBkb3dubG9hZFVSTCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9CiAgICB9CiAgICBleHBvcnRzLmFzc2VydCA9IGFzc2VydDsKICAgIGV4cG9ydHMuaW5mbyA9IGluZm87CiAgICBleHBvcnRzLndhcm4gPSB3YXJuOwogICAgZXhwb3J0cy5kZWJ1ZyA9IGRlYnVnOwogICAgZXhwb3J0cy5kZXByZWNhdGUgPSBkZXByZWNhdGU7CiAgICBleHBvcnRzLmRlYnVnU2VhbCA9IGRlYnVnU2VhbDsKICAgIGV4cG9ydHMuZGVidWdGcmVlemUgPSBkZWJ1Z0ZyZWV6ZTsKICAgIGV4cG9ydHMucnVuSW5EZWJ1ZyA9IHJ1bkluRGVidWc7CiAgICBleHBvcnRzLmRlcHJlY2F0ZUZ1bmMgPSBkZXByZWNhdGVGdW5jOwogICAgZXhwb3J0cy5zZXREZWJ1Z0Z1bmN0aW9uID0gc2V0RGVidWdGdW5jdGlvbjsKICAgIGV4cG9ydHMuZ2V0RGVidWdGdW5jdGlvbiA9IGdldERlYnVnRnVuY3Rpb247CiAgICBleHBvcnRzLl93YXJuSWZVc2luZ1N0cmlwcGVkRmVhdHVyZUZsYWdzID0gX3dhcm5JZlVzaW5nU3RyaXBwZWRGZWF0dXJlRmxhZ3M7Cn0pOwplbmlmZWQoJ0BlbWJlci9kZWJ1Zy9saWIvZGVwcmVjYXRlJywgWydleHBvcnRzJywgJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzJywgJ2VtYmVyLWVudmlyb25tZW50JywgJ0BlbWJlci9kZWJ1Zy9pbmRleCcsICdAZW1iZXIvZGVidWcvbGliL2hhbmRsZXJzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfZW1iZXJFbnZpcm9ubWVudCwgX2luZGV4LCBfaGFuZGxlcnMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLm1pc3NpbmdPcHRpb25zVW50aWxEZXByZWNhdGlvbiA9IGV4cG9ydHMubWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uID0gZXhwb3J0cy5taXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSB1bmRlZmluZWQ7CgogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAgICBAcHVibGljCiAgICAqLwogICAgLyoqCiAgICAgIEFsbG93cyBmb3IgcnVudGltZSByZWdpc3RyYXRpb24gb2YgaGFuZGxlciBmdW5jdGlvbnMgdGhhdCBvdmVycmlkZSB0aGUgZGVmYXVsdCBkZXByZWNhdGlvbiBiZWhhdmlvci4KICAgICAgRGVwcmVjYXRpb25zIGFyZSBpbnZva2VkIGJ5IGNhbGxzIHRvIFtAZW1iZXIvYXBwbGljYXRpb24vZGVwcmVjYXRpb25zL2RlcHJlY2F0ZV0oaHR0cHM6Ly9lbWJlcmpzLmNvbS9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0BlbWJlciUyRmFwcGxpY2F0aW9uJTJGZGVwcmVjYXRpb25zL21ldGhvZHMvZGVwcmVjYXRlP2FuY2hvcj1kZXByZWNhdGUpLgogICAgICBUaGUgZm9sbG93aW5nIGV4YW1wbGUgZGVtb25zdHJhdGVzIGl0cyB1c2FnZSBieSByZWdpc3RlcmluZyBhIGhhbmRsZXIgdGhhdCB0aHJvd3MgYW4gZXJyb3IgaWYgdGhlCiAgICAgIG1lc3NhZ2UgY29udGFpbnMgdGhlIHdvcmQgInNob3VsZCIsIG90aGVyd2lzZSBkZWZlcnMgdG8gdGhlIGRlZmF1bHQgaGFuZGxlci4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IHJlZ2lzdGVyRGVwcmVjYXRpb25IYW5kbGVyIH0gZnJvbSAnQGVtYmVyL2RlYnVnJzsKICAgIAogICAgICByZWdpc3RlckRlcHJlY2F0aW9uSGFuZGxlcigobWVzc2FnZSwgb3B0aW9ucywgbmV4dCkgPT4gewogICAgICAgIGlmIChtZXNzYWdlLmluZGV4T2YoJ3Nob3VsZCcpICE9PSAtMSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEZXByZWNhdGlvbiBtZXNzYWdlIHdpdGggc2hvdWxkOiAke21lc3NhZ2V9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRlZmVyIHRvIHdoYXRldmVyIGhhbmRsZXIgd2FzIHJlZ2lzdGVyZWQgYmVmb3JlIHRoaXMgb25lCiAgICAgICAgICBuZXh0KG1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFRoZSBoYW5kbGVyIGZ1bmN0aW9uIHRha2VzIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzOgogICAgCiAgICAgIDx1bD4KICAgICAgICA8bGk+IDxjb2RlPm1lc3NhZ2U8L2NvZGU+IC0gVGhlIG1lc3NhZ2UgcmVjZWl2ZWQgZnJvbSB0aGUgZGVwcmVjYXRpb24gY2FsbC48L2xpPgogICAgICAgIDxsaT4gPGNvZGU+b3B0aW9uczwvY29kZT4gLSBBbiBvYmplY3QgcGFzc2VkIGluIHdpdGggdGhlIGRlcHJlY2F0aW9uIGNhbGwgY29udGFpbmluZyBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIGluY2x1ZGluZzo8L2xpPgogICAgICAgICAgPHVsPgogICAgICAgICAgICA8bGk+IDxjb2RlPmlkPC9jb2RlPiAtIEFuIGlkIG9mIHRoZSBkZXByZWNhdGlvbiBpbiB0aGUgZm9ybSBvZiA8Y29kZT5wYWNrYWdlLW5hbWUuc3BlY2lmaWMtZGVwcmVjYXRpb248L2NvZGU+LjwvbGk+CiAgICAgICAgICAgIDxsaT4gPGNvZGU+dW50aWw8L2NvZGU+IC0gVGhlIEVtYmVyIHZlcnNpb24gbnVtYmVyIHRoZSBmZWF0dXJlIGFuZCBkZXByZWNhdGlvbiB3aWxsIGJlIHJlbW92ZWQgaW4uPC9saT4KICAgICAgICAgIDwvdWw+CiAgICAgICAgPGxpPiA8Y29kZT5uZXh0PC9jb2RlPiAtIEEgZnVuY3Rpb24gdGhhdCBjYWxscyBpbnRvIHRoZSBwcmV2aW91c2x5IHJlZ2lzdGVyZWQgaGFuZGxlci48L2xpPgogICAgICA8L3VsPgogICAgCiAgICAgIEBwdWJsaWMKICAgICAgQHN0YXRpYwogICAgICBAbWV0aG9kIHJlZ2lzdGVyRGVwcmVjYXRpb25IYW5kbGVyCiAgICAgIEBmb3IgQGVtYmVyL2RlYnVnCiAgICAgIEBwYXJhbSBoYW5kbGVyIHtGdW5jdGlvbn0gQSBmdW5jdGlvbiB0byBoYW5kbGUgZGVwcmVjYXRpb24gY2FsbHMuCiAgICAgIEBzaW5jZSAyLjEuMAogICAgKi8KICAgIHZhciByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiAoKSB7fTsKICAgIHZhciBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gdm9pZCAwOwogICAgdmFyIG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IHZvaWQgMDsKICAgIHZhciBtaXNzaW5nT3B0aW9uc1VudGlsRGVwcmVjYXRpb24gPSB2b2lkIDA7CiAgICB2YXIgZGVwcmVjYXRlID0gZnVuY3Rpb24gKCkge307CiAgICBpZiAodHJ1ZSkgewogICAgICAgIGV4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gcmVnaXN0ZXJIYW5kbGVyID0gZnVuY3Rpb24gcmVnaXN0ZXJIYW5kbGVyKGhhbmRsZXIpIHsKICAgICAgICAgICAgKDAsIF9oYW5kbGVycy5yZWdpc3RlckhhbmRsZXIpKCdkZXByZWNhdGUnLCBoYW5kbGVyKTsKICAgICAgICB9OwogICAgICAgIHZhciBmb3JtYXRNZXNzYWdlID0gZnVuY3Rpb24gZm9ybWF0TWVzc2FnZShfbWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IF9tZXNzYWdlOwogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmlkKSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSArICgnIFtkZXByZWNhdGlvbiBpZDogJyArIG9wdGlvbnMuaWQgKyAnXScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudXJsKSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlICs9ICcgU2VlICcgKyBvcHRpb25zLnVybCArICcgZm9yIG1vcmUgZGV0YWlscy4nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgIH07CiAgICAgICAgcmVnaXN0ZXJIYW5kbGVyKGZ1bmN0aW9uIGxvZ0RlcHJlY2F0aW9uVG9Db25zb2xlKG1lc3NhZ2UsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZWRNZXNzYWdlID0gZm9ybWF0TWVzc2FnZShtZXNzYWdlLCBvcHRpb25zKTsKICAgICAgICAgICAgY29uc29sZS53YXJuKCdERVBSRUNBVElPTjogJyArIHVwZGF0ZWRNZXNzYWdlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGNhcHR1cmVFcnJvckZvclN0YWNrID0gdm9pZCAwOwogICAgICAgIGlmIChuZXcgRXJyb3IoKS5zdGFjaykgewogICAgICAgICAgICBjYXB0dXJlRXJyb3JGb3JTdGFjayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYXB0dXJlRXJyb3JGb3JTdGFjayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgX19mYWlsX18uZmFpbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZWdpc3RlckhhbmRsZXIoZnVuY3Rpb24gbG9nRGVwcmVjYXRpb25TdGFja1RyYWNlKG1lc3NhZ2UsIG9wdGlvbnMsIG5leHQpIHsKICAgICAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5MT0dfU1RBQ0tUUkFDRV9PTl9ERVBSRUNBVElPTikgewogICAgICAgICAgICAgICAgdmFyIHN0YWNrU3RyID0gJyc7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjYXB0dXJlRXJyb3JGb3JTdGFjaygpOwogICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKGVycm9yLnN0YWNrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yWydhcmd1bWVudHMnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUKICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSBlcnJvci5zdGFjay5yZXBsYWNlKC9eXHMrYXRccysvZ20sICcnKS5yZXBsYWNlKC9eKFteXChdKz8pKFtcbiRdKS9nbSwgJ3thbm9ueW1vdXN9KCQxKSQyJykucmVwbGFjZSgvXk9iamVjdC48YW5vbnltb3VzPlxzKlwoKFteXCldKylcKS9nbSwgJ3thbm9ueW1vdXN9KCQxKScpLnNwbGl0KCdcbicpOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmVmb3gKICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSBlcnJvci5zdGFjay5yZXBsYWNlKC8oPzpcbkA6MCk/XHMrJC9tLCAnJykucmVwbGFjZSgvXlwoL2dtLCAne2Fub255bW91c30oJykuc3BsaXQoJ1xuJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0YWNrU3RyID0gJ1xuICAgICcgKyBzdGFjay5zbGljZSgyKS5qb2luKCdcbiAgICAnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1cGRhdGVkTWVzc2FnZSA9IGZvcm1hdE1lc3NhZ2UobWVzc2FnZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0RFUFJFQ0FUSU9OOiAnICsgdXBkYXRlZE1lc3NhZ2UgKyBzdGFja1N0cik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dChtZXNzYWdlLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJlZ2lzdGVySGFuZGxlcihmdW5jdGlvbiByYWlzZU9uRGVwcmVjYXRpb24obWVzc2FnZSwgb3B0aW9ucywgbmV4dCkgewogICAgICAgICAgICBpZiAoX2VtYmVyRW52aXJvbm1lbnQuRU5WLlJBSVNFX09OX0RFUFJFQ0FUSU9OKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZE1lc3NhZ2UgPSBmb3JtYXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHVwZGF0ZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHQobWVzc2FnZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBleHBvcnRzLm1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24gPSBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gJ1doZW4gY2FsbGluZyBgZGVwcmVjYXRlYCB5b3UgJyArICdtdXN0IHByb3ZpZGUgYW4gYG9wdGlvbnNgIGhhc2ggYXMgdGhlIHRoaXJkIHBhcmFtZXRlci4gICcgKyAnYG9wdGlvbnNgIHNob3VsZCBpbmNsdWRlIGBpZGAgYW5kIGB1bnRpbGAgcHJvcGVydGllcy4nOwogICAgICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uID0gJ1doZW4gY2FsbGluZyBgZGVwcmVjYXRlYCB5b3UgbXVzdCBwcm92aWRlIGBpZGAgaW4gb3B0aW9ucy4nOwogICAgICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uID0gJ1doZW4gY2FsbGluZyBgZGVwcmVjYXRlYCB5b3UgbXVzdCBwcm92aWRlIGB1bnRpbGAgaW4gb3B0aW9ucy4nOwogICAgICAgIC8qKgogICAgICAgICBAbW9kdWxlIEBlbWJlci9hcHBsaWNhdGlvbgogICAgICAgICBAcHVibGljCiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgICBEaXNwbGF5IGEgZGVwcmVjYXRpb24gd2FybmluZyB3aXRoIHRoZSBwcm92aWRlZCBtZXNzYWdlIGFuZCBhIHN0YWNrIHRyYWNlCiAgICAgICAgICAoQ2hyb21lIGFuZCBGaXJlZm94IG9ubHkpLgogICAgICAgICAgICAgKiBJbiBhIHByb2R1Y3Rpb24gYnVpbGQsIHRoaXMgbWV0aG9kIGlzIGRlZmluZWQgYXMgYW4gZW1wdHkgZnVuY3Rpb24gKE5PUCkuCiAgICAgICAgICBVc2VzIG9mIHRoaXMgbWV0aG9kIGluIEVtYmVyIGl0c2VsZiBhcmUgc3RyaXBwZWQgZnJvbSB0aGUgZW1iZXIucHJvZC5qcyBidWlsZC4KICAgICAgICAgICAgIEBtZXRob2QgZGVwcmVjYXRlCiAgICAgICAgICBAZm9yIEBlbWJlci9hcHBsaWNhdGlvbi9kZXByZWNhdGlvbnMKICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIEEgZGVzY3JpcHRpb24gb2YgdGhlIGRlcHJlY2F0aW9uLgogICAgICAgICAgQHBhcmFtIHtCb29sZWFufSB0ZXN0IEEgYm9vbGVhbi4gSWYgZmFsc3ksIHRoZSBkZXByZWNhdGlvbiB3aWxsIGJlIGRpc3BsYXllZC4KICAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5pZCBBIHVuaXF1ZSBpZCBmb3IgdGhpcyBkZXByZWNhdGlvbi4gVGhlIGlkIGNhbiBiZQogICAgICAgICAgICB1c2VkIGJ5IEVtYmVyIGRlYnVnZ2luZyB0b29scyB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIChyYWlzZSwgbG9nIG9yIHNpbGVuY2UpCiAgICAgICAgICAgIGZvciB0aGF0IHNwZWNpZmljIGRlcHJlY2F0aW9uLiBUaGUgaWQgc2hvdWxkIGJlIG5hbWVzcGFjZWQgYnkgZG90cywgZS5nLgogICAgICAgICAgICAidmlldy5oZWxwZXIuc2VsZWN0Ii4KICAgICAgICAgIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnVudGlsIFRoZSB2ZXJzaW9uIG9mIEVtYmVyIHdoZW4gdGhpcyBkZXByZWNhdGlvbgogICAgICAgICAgICB3YXJuaW5nIHdpbGwgYmUgcmVtb3ZlZC4KICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy51cmxdIEFuIG9wdGlvbmFsIHVybCB0byB0aGUgdHJhbnNpdGlvbiBndWlkZSBvbiB0aGUKICAgICAgICAgICAgZW1iZXJqcy5jb20gd2Vic2l0ZS4KICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAgIEBzaW5jZSAxLjAuMAogICAgICAgICovCiAgICAgICAgZGVwcmVjYXRlID0gZnVuY3Rpb24gZGVwcmVjYXRlKG1lc3NhZ2UsIHRlc3QsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5fRU5BQkxFX0RFUFJFQ0FUSU9OX09QVElPTlNfU1VQUE9SVCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgKDAsIF9pbmRleC5hc3NlcnQpKG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24sICEhKG9wdGlvbnMgJiYgKG9wdGlvbnMuaWQgfHwgb3B0aW9ucy51bnRpbCkpKTsKICAgICAgICAgICAgICAgICgwLCBfaW5kZXguYXNzZXJ0KShtaXNzaW5nT3B0aW9uc0lkRGVwcmVjYXRpb24sICEhb3B0aW9ucy5pZCk7CiAgICAgICAgICAgICAgICAoMCwgX2luZGV4LmFzc2VydCkobWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uLCAhIW9wdGlvbnMudW50aWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkRFUFJFQ0FURV9PUFRJT05TX01JU1NJTkcgJiYgKCFvcHRpb25zIHx8ICFvcHRpb25zLmlkICYmICFvcHRpb25zLnVudGlsKSAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9ERVBSRUNBVElPTl9PUFRJT05TX1NVUFBPUlQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGRlcHJlY2F0ZShtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uLCBmYWxzZSwgewogICAgICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItZGVidWcuZGVwcmVjYXRlLW9wdGlvbnMtbWlzc2luZycsCiAgICAgICAgICAgICAgICAgICAgdW50aWw6ICczLjAuMCcsCiAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjIueC8jdG9jX2VtYmVyLWRlYnVnLWZ1bmN0aW9uLW9wdGlvbnMnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5ERVBSRUNBVEVfSURfTUlTU0lORyAmJiBvcHRpb25zICYmICFvcHRpb25zLmlkICYmIF9lbWJlckVudmlyb25tZW50LkVOVi5fRU5BQkxFX0RFUFJFQ0FUSU9OX09QVElPTlNfU1VQUE9SVCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZGVwcmVjYXRlKG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiwgZmFsc2UsIHsKICAgICAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLWRlYnVnLmRlcHJlY2F0ZS1pZC1taXNzaW5nJywKICAgICAgICAgICAgICAgICAgICB1bnRpbDogJzMuMC4wJywKICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92Mi54LyN0b2NfZW1iZXItZGVidWctZnVuY3Rpb24tb3B0aW9ucycKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkRFUFJFQ0FURV9VTlRJTF9NSVNTSU5HICYmIG9wdGlvbnMgJiYgIW9wdGlvbnMudW50aWwgJiYgX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfREVQUkVDQVRJT05fT1BUSU9OU19TVVBQT1JUID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBkZXByZWNhdGUobWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uLCAhIShvcHRpb25zICYmIG9wdGlvbnMudW50aWwpLCB7CiAgICAgICAgICAgICAgICAgICAgaWQ6ICdlbWJlci1kZWJ1Zy5kZXByZWNhdGUtdW50aWwtbWlzc2luZycsCiAgICAgICAgICAgICAgICAgICAgdW50aWw6ICczLjAuMCcsCiAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjIueC8jdG9jX2VtYmVyLWRlYnVnLWZ1bmN0aW9uLW9wdGlvbnMnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoMCwgX2hhbmRsZXJzLmludm9rZSkoJ2RlcHJlY2F0ZScsIG1lc3NhZ2UsIHRlc3QsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLmRlZmF1bHQgPSBkZXByZWNhdGU7CiAgICBleHBvcnRzLnJlZ2lzdGVySGFuZGxlciA9IHJlZ2lzdGVySGFuZGxlcjsKICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb247CiAgICBleHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbjsKICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uID0gbWlzc2luZ09wdGlvbnNVbnRpbERlcHJlY2F0aW9uOwp9KTsKZW5pZmVkKCdAZW1iZXIvZGVidWcvbGliL2hhbmRsZXJzJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIEhBTkRMRVJTID0gZXhwb3J0cy5IQU5ETEVSUyA9IHt9OwogICAgdmFyIHJlZ2lzdGVySGFuZGxlciA9IGZ1bmN0aW9uICgpIHt9OwogICAgdmFyIGludm9rZSA9IGZ1bmN0aW9uICgpIHt9OwogICAgaWYgKHRydWUpIHsKICAgICAgICBleHBvcnRzLnJlZ2lzdGVySGFuZGxlciA9IHJlZ2lzdGVySGFuZGxlciA9IGZ1bmN0aW9uIHJlZ2lzdGVySGFuZGxlcih0eXBlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgbmV4dEhhbmRsZXIgPSBIQU5ETEVSU1t0eXBlXSB8fCBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgSEFORExFUlNbdHlwZV0gPSBmdW5jdGlvbiAobWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgY2FsbGJhY2sobWVzc2FnZSwgb3B0aW9ucywgbmV4dEhhbmRsZXIpOwogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgZXhwb3J0cy5pbnZva2UgPSBpbnZva2UgPSBmdW5jdGlvbiBpbnZva2UodHlwZSwgbWVzc2FnZSwgdGVzdCwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAodGVzdCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYW5kbGVyRm9yVHlwZSA9IEhBTkRMRVJTW3R5cGVdOwogICAgICAgICAgICBpZiAoaGFuZGxlckZvclR5cGUpIHsKICAgICAgICAgICAgICAgIGhhbmRsZXJGb3JUeXBlKG1lc3NhZ2UsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucmVnaXN0ZXJIYW5kbGVyID0gcmVnaXN0ZXJIYW5kbGVyOwogICAgZXhwb3J0cy5pbnZva2UgPSBpbnZva2U7Cn0pOwplbmlmZWQoIkBlbWJlci9kZWJ1Zy9saWIvdGVzdGluZyIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIGV4cG9ydHMuaXNUZXN0aW5nID0gaXNUZXN0aW5nOwogICAgZXhwb3J0cy5zZXRUZXN0aW5nID0gc2V0VGVzdGluZzsKICAgIHZhciB0ZXN0aW5nID0gZmFsc2U7CiAgICBmdW5jdGlvbiBpc1Rlc3RpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRlc3Rpbmc7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRUZXN0aW5nKHZhbHVlKSB7CiAgICAgICAgdGVzdGluZyA9ICEhdmFsdWU7CiAgICB9CiAgICAvLyMgc291cmNlTWFwcGluZ1VSTD10ZXN0aW5nLmpzLm1hcAp9KTsKZW5pZmVkKCdAZW1iZXIvZGVidWcvbGliL3dhcm4nLCBbJ2V4cG9ydHMnLCAnZW1iZXItZW52aXJvbm1lbnQnLCAnQGVtYmVyL2RlYnVnL2luZGV4JywgJ0BlbWJlci9kZWJ1Zy9saWIvZGVwcmVjYXRlJywgJ0BlbWJlci9kZWJ1Zy9saWIvaGFuZGxlcnMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckVudmlyb25tZW50LCBfaW5kZXgsIF9kZXByZWNhdGUsIF9oYW5kbGVycykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IGV4cG9ydHMubWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uID0gZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSB1bmRlZmluZWQ7CgogICAgdmFyIHJlZ2lzdGVySGFuZGxlciA9IGZ1bmN0aW9uICgpIHt9OwogICAgdmFyIHdhcm4gPSBmdW5jdGlvbiAoKSB7fTsKICAgIHZhciBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gdm9pZCAwOwogICAgdmFyIG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IHZvaWQgMDsKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAgICovCiAgICBpZiAodHJ1ZSkgewogICAgICAgIC8qKgogICAgICAgICAgQWxsb3dzIGZvciBydW50aW1lIHJlZ2lzdHJhdGlvbiBvZiBoYW5kbGVyIGZ1bmN0aW9ucyB0aGF0IG92ZXJyaWRlIHRoZSBkZWZhdWx0IHdhcm5pbmcgYmVoYXZpb3IuCiAgICAgICAgICBXYXJuaW5ncyBhcmUgaW52b2tlZCBieSBjYWxscyBtYWRlIHRvIFtAZW1iZXIvZGVidWcvd2Fybl0oaHR0cHM6Ly9lbWJlcmpzLmNvbS9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0BlbWJlciUyRmRlYnVnL21ldGhvZHMvd2Fybj9hbmNob3I9d2FybikuCiAgICAgICAgICBUaGUgZm9sbG93aW5nIGV4YW1wbGUgZGVtb25zdHJhdGVzIGl0cyB1c2FnZSBieSByZWdpc3RlcmluZyBhIGhhbmRsZXIgdGhhdCBkb2VzIG5vdGhpbmcgb3ZlcnJpZGluZyBFbWJlcidzCiAgICAgICAgICBkZWZhdWx0IHdhcm5pbmcgYmVoYXZpb3IuCiAgICAgICAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgICBpbXBvcnQgeyByZWdpc3Rlcldhcm5IYW5kbGVyIH0gZnJvbSAnQGVtYmVyL2RlYnVnJzsKICAgICAgICAgICAgIC8vIG5leHQgaXMgbm90IGNhbGxlZCwgc28gbm8gd2FybmluZ3MgZ2V0IHRoZSBkZWZhdWx0IGJlaGF2aW9yCiAgICAgICAgICByZWdpc3Rlcldhcm5IYW5kbGVyKCgpID0+IHt9KTsKICAgICAgICAgIGBgYAogICAgICAgICAgICAgVGhlIGhhbmRsZXIgZnVuY3Rpb24gdGFrZXMgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaT4gPGNvZGU+bWVzc2FnZTwvY29kZT4gLSBUaGUgbWVzc2FnZSByZWNlaXZlZCBmcm9tIHRoZSB3YXJuIGNhbGwuIDwvbGk+CiAgICAgICAgICAgIDxsaT4gPGNvZGU+b3B0aW9uczwvY29kZT4gLSBBbiBvYmplY3QgcGFzc2VkIGluIHdpdGggdGhlIHdhcm4gY2FsbCBjb250YWluaW5nIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gaW5jbHVkaW5nOjwvbGk+CiAgICAgICAgICAgICAgPHVsPgogICAgICAgICAgICAgICAgPGxpPiA8Y29kZT5pZDwvY29kZT4gLSBBbiBpZCBvZiB0aGUgd2FybmluZyBpbiB0aGUgZm9ybSBvZiA8Y29kZT5wYWNrYWdlLW5hbWUuc3BlY2lmaWMtd2FybmluZzwvY29kZT4uPC9saT4KICAgICAgICAgICAgICA8L3VsPgogICAgICAgICAgICA8bGk+IDxjb2RlPm5leHQ8L2NvZGU+IC0gQSBmdW5jdGlvbiB0aGF0IGNhbGxzIGludG8gdGhlIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCBoYW5kbGVyLjwvbGk+CiAgICAgICAgICA8L3VsPgogICAgICAgICAgICAgQHB1YmxpYwogICAgICAgICAgQHN0YXRpYwogICAgICAgICAgQG1ldGhvZCByZWdpc3Rlcldhcm5IYW5kbGVyCiAgICAgICAgICBAZm9yIEBlbWJlci9kZWJ1ZwogICAgICAgICAgQHBhcmFtIGhhbmRsZXIge0Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHRvIGhhbmRsZSB3YXJuaW5ncy4KICAgICAgICAgIEBzaW5jZSAyLjEuMAogICAgICAgICovCiAgICAgICAgZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSByZWdpc3RlckhhbmRsZXIgPSBmdW5jdGlvbiByZWdpc3RlckhhbmRsZXIoaGFuZGxlcikgewogICAgICAgICAgICAoMCwgX2hhbmRsZXJzLnJlZ2lzdGVySGFuZGxlcikoJ3dhcm4nLCBoYW5kbGVyKTsKICAgICAgICB9OwogICAgICAgIHJlZ2lzdGVySGFuZGxlcihmdW5jdGlvbiBsb2dXYXJuaW5nKG1lc3NhZ2UpIHsKICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqLwogICAgICAgICAgICBjb25zb2xlLndhcm4oJ1dBUk5JTkc6ICcgKyBtZXNzYWdlKTsKICAgICAgICAgICAgaWYgKGNvbnNvbGUudHJhY2UpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgICB9KTsKICAgICAgICBleHBvcnRzLm1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24gPSBtaXNzaW5nT3B0aW9uc0RlcHJlY2F0aW9uID0gJ1doZW4gY2FsbGluZyBgd2FybmAgeW91ICcgKyAnbXVzdCBwcm92aWRlIGFuIGBvcHRpb25zYCBoYXNoIGFzIHRoZSB0aGlyZCBwYXJhbWV0ZXIuICAnICsgJ2BvcHRpb25zYCBzaG91bGQgaW5jbHVkZSBhbiBgaWRgIHByb3BlcnR5Lic7CiAgICAgICAgZXhwb3J0cy5taXNzaW5nT3B0aW9uc0lkRGVwcmVjYXRpb24gPSBtaXNzaW5nT3B0aW9uc0lkRGVwcmVjYXRpb24gPSAnV2hlbiBjYWxsaW5nIGB3YXJuYCB5b3UgbXVzdCBwcm92aWRlIGBpZGAgaW4gb3B0aW9ucy4nOwogICAgICAgIC8qKgogICAgICAgICAgRGlzcGxheSBhIHdhcm5pbmcgd2l0aCB0aGUgcHJvdmlkZWQgbWVzc2FnZS4KICAgICAgICAgICAgICogSW4gYSBwcm9kdWN0aW9uIGJ1aWxkLCB0aGlzIG1ldGhvZCBpcyBkZWZpbmVkIGFzIGFuIGVtcHR5IGZ1bmN0aW9uIChOT1ApLgogICAgICAgICAgVXNlcyBvZiB0aGlzIG1ldGhvZCBpbiBFbWJlciBpdHNlbGYgYXJlIHN0cmlwcGVkIGZyb20gdGhlIGVtYmVyLnByb2QuanMgYnVpbGQuCiAgICAgICAgICAgICBAbWV0aG9kIHdhcm4KICAgICAgICAgIEBmb3IgQGVtYmVyL2RlYnVnCiAgICAgICAgICBAc3RhdGljCiAgICAgICAgICBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBBIHdhcm5pbmcgdG8gZGlzcGxheS4KICAgICAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gdGVzdCBBbiBvcHRpb25hbCBib29sZWFuLiBJZiBmYWxzeSwgdGhlIHdhcm5pbmcKICAgICAgICAgICAgd2lsbCBiZSBkaXNwbGF5ZWQuCiAgICAgICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbiBvYmplY3QgdGhhdCBjYW4gYmUgdXNlZCB0byBwYXNzIGEgdW5pcXVlCiAgICAgICAgICAgIGBpZGAgZm9yIHRoaXMgd2FybmluZy4gIFRoZSBgaWRgIGNhbiBiZSB1c2VkIGJ5IEVtYmVyIGRlYnVnZ2luZyB0b29scwogICAgICAgICAgICB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIChyYWlzZSwgbG9nLCBvciBzaWxlbmNlKSBmb3IgdGhhdCBzcGVjaWZpYyB3YXJuaW5nLgogICAgICAgICAgICBUaGUgYGlkYCBzaG91bGQgYmUgbmFtZXNwYWNlZCBieSBkb3RzLCBlLmcuICJlbWJlci1kZWJ1Zy5mZWF0dXJlLWZsYWctd2l0aC1mZWF0dXJlcy1zdHJpcHBlZCIKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAgIEBzaW5jZSAxLjAuMAogICAgICAgICovCiAgICAgICAgd2FybiA9IGZ1bmN0aW9uIHdhcm4obWVzc2FnZSwgdGVzdCwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgdGVzdCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0ZXN0OwogICAgICAgICAgICAgICAgdGVzdCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9XQVJOX09QVElPTlNfU1VQUE9SVCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgKDAsIF9pbmRleC5hc3NlcnQpKG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24sICEhb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAoMCwgX2luZGV4LmFzc2VydCkobWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uLCAhIShvcHRpb25zICYmIG9wdGlvbnMuaWQpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9wdGlvbnMgJiYgX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfV0FSTl9PUFRJT05TX1NVUFBPUlQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICgwLCBfZGVwcmVjYXRlLmRlZmF1bHQpKG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb24sIGZhbHNlLCB7CiAgICAgICAgICAgICAgICAgICAgaWQ6ICdlbWJlci1kZWJ1Zy53YXJuLW9wdGlvbnMtbWlzc2luZycsCiAgICAgICAgICAgICAgICAgICAgdW50aWw6ICczLjAuMCcsCiAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjIueC8jdG9jX2VtYmVyLWRlYnVnLWZ1bmN0aW9uLW9wdGlvbnMnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiAhb3B0aW9ucy5pZCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9XQVJOX09QVElPTlNfU1VQUE9SVCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgKDAsIF9kZXByZWNhdGUuZGVmYXVsdCkobWlzc2luZ09wdGlvbnNJZERlcHJlY2F0aW9uLCBmYWxzZSwgewogICAgICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItZGVidWcud2Fybi1pZC1taXNzaW5nJywKICAgICAgICAgICAgICAgICAgICB1bnRpbDogJzMuMC4wJywKICAgICAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92Mi54LyN0b2NfZW1iZXItZGVidWctZnVuY3Rpb24tb3B0aW9ucycKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgICgwLCBfaGFuZGxlcnMuaW52b2tlKSgnd2FybicsIG1lc3NhZ2UsIHRlc3QsIG9wdGlvbnMpOwogICAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLmRlZmF1bHQgPSB3YXJuOwogICAgZXhwb3J0cy5yZWdpc3RlckhhbmRsZXIgPSByZWdpc3RlckhhbmRsZXI7CiAgICBleHBvcnRzLm1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zSWREZXByZWNhdGlvbjsKICAgIGV4cG9ydHMubWlzc2luZ09wdGlvbnNEZXByZWNhdGlvbiA9IG1pc3NpbmdPcHRpb25zRGVwcmVjYXRpb247Cn0pOwplbmlmZWQoJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzL2luZGV4JywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgUFJPUEVSVFlfQkFTRURfREVTQ1JJUFRPUlMgPSBleHBvcnRzLlBST1BFUlRZX0JBU0VEX0RFU0NSSVBUT1JTID0gISEnMy4yLjAnOwogIHZhciBFTUJFUl9FWFRFTkRfUFJPVE9UWVBFUyA9IGV4cG9ydHMuRU1CRVJfRVhURU5EX1BST1RPVFlQRVMgPSAhISczLjIuMC1iZXRhLjUnOwogIHZhciBERVBSRUNBVEVfT1BUSU9OU19NSVNTSU5HID0gZXhwb3J0cy5ERVBSRUNBVEVfT1BUSU9OU19NSVNTSU5HID0gISEnMi4xLjAtYmV0YS4xJzsKICB2YXIgREVQUkVDQVRFX0lEX01JU1NJTkcgPSBleHBvcnRzLkRFUFJFQ0FURV9JRF9NSVNTSU5HID0gISEnMi4xLjAtYmV0YS4xJzsKICB2YXIgREVQUkVDQVRFX1VOVElMX01JU1NJTkcgPSBleHBvcnRzLkRFUFJFQ0FURV9VTlRJTF9NSVNTSU5HID0gISEnMi4xLjAtYmV0YS4xJzsKICB2YXIgUlVOX1NZTkMgPSBleHBvcnRzLlJVTl9TWU5DID0gISEnMy4wLjAtYmV0YS40JzsKICB2YXIgUkVHSVNUUllfUkVTT0xWRVJfQVNfRlVOQ1RJT04gPSBleHBvcnRzLlJFR0lTVFJZX1JFU09MVkVSX0FTX0ZVTkNUSU9OID0gISEnMi4zLjAtYmV0YS4zJzsKICB2YXIgTE9HR0VSID0gZXhwb3J0cy5MT0dHRVIgPSAhISczLjIuMC1iZXRhLjEnOwogIHZhciBQT1NJVElPTkFMX1BBUkFNX0NPTkZMSUNUID0gZXhwb3J0cy5QT1NJVElPTkFMX1BBUkFNX0NPTkZMSUNUID0gISEnMy4xLjAtYmV0YS4xJzsKICB2YXIgRElEX0lOSVRfQVRUUlMgPSBleHBvcnRzLkRJRF9JTklUX0FUVFJTID0gISEnMi42LjAtYmV0YS4xJzsKICB2YXIgUFJPUEVSVFlfV0lMTF9DSEFOR0UgPSBleHBvcnRzLlBST1BFUlRZX1dJTExfQ0hBTkdFID0gISEnMy4xLjAtYmV0YS4xJzsKICB2YXIgUFJPUEVSVFlfRElEX0NIQU5HRSA9IGV4cG9ydHMuUFJPUEVSVFlfRElEX0NIQU5HRSA9ICEhJzMuMS4wLWJldGEuMSc7CiAgdmFyIFJPVVRFUl9ST1VURVIgPSBleHBvcnRzLlJPVVRFUl9ST1VURVIgPSAhISczLjIuMC1iZXRhLjEnOwogIHZhciBPUlBIQU5fT1VUTEVUX1JFTkRFUiA9IGV4cG9ydHMuT1JQSEFOX09VVExFVF9SRU5ERVIgPSAhIScyLjExLjAtYmV0YS4xJzsKICB2YXIgQVJSQVlfQVRfRUFDSCA9IGV4cG9ydHMuQVJSQVlfQVRfRUFDSCA9ICEhJzMuMS4wLWJldGEuMSc7CiAgdmFyIFRBUkdFVF9PQkpFQ1QgPSBleHBvcnRzLlRBUkdFVF9PQkpFQ1QgPSAhIScyLjE4LjAtYmV0YS4xJzsKICB2YXIgUkVOREVSX0hFTFBFUiA9IGV4cG9ydHMuUkVOREVSX0hFTFBFUiA9ICEhJzIuMTEuMC1iZXRhLjEnOwogIHZhciBCSU5ESU5HX1NVUFBPUlQgPSBleHBvcnRzLkJJTkRJTkdfU1VQUE9SVCA9ICEhJzIuNy4wLWJldGEuMSc7CiAgLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5kZXguanMubWFwCn0pOwplbmlmZWQoJ0BlbWJlci9lbmdpbmUvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2VuZ2luZS9saWIvZW5naW5lLXBhcmVudCcsICdlbWJlci1iYWJlbCcsICdlbWJlci11dGlscycsICdAZW1iZXIvY29udHJvbGxlcicsICdlbWJlci1ydW50aW1lJywgJ2NvbnRhaW5lcicsICdkYWctbWFwJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvYXBwbGljYXRpb24vZ2xvYmFscy1yZXNvbHZlcicsICdAZW1iZXIvZW5naW5lL2luc3RhbmNlJywgJ2VtYmVyLXJvdXRpbmcnLCAnZW1iZXItZXh0ZW5zaW9uLXN1cHBvcnQnLCAnZW1iZXItdmlld3MnLCAnZW1iZXItZ2xpbW1lciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VuZ2luZVBhcmVudCwgX2VtYmVyQmFiZWwsIF9lbWJlclV0aWxzLCBfY29udHJvbGxlciwgX2VtYmVyUnVudGltZSwgX2NvbnRhaW5lciwgX2RhZ01hcCwgX2RlYnVnLCBfZW1iZXJNZXRhbCwgX2dsb2JhbHNSZXNvbHZlciwgX2luc3RhbmNlLCBfZW1iZXJSb3V0aW5nLCBfZW1iZXJFeHRlbnNpb25TdXBwb3J0LCBfZW1iZXJWaWV3cywgX2VtYmVyR2xpbW1lcikgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5zZXRFbmdpbmVQYXJlbnQgPSBleHBvcnRzLmdldEVuZ2luZVBhcmVudCA9IHVuZGVmaW5lZDsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2dldEVuZ2luZVBhcmVudCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9lbmdpbmVQYXJlbnQuZ2V0RW5naW5lUGFyZW50OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnc2V0RW5naW5lUGFyZW50JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2VuZ2luZVBhcmVudC5zZXRFbmdpbmVQYXJlbnQ7CiAgICB9CiAgfSk7CgogIHZhciBfdGVtcGxhdGVPYmplY3QgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsnLWJ1Y2tldC1jYWNoZTptYWluJ10sIFsnLWJ1Y2tldC1jYWNoZTptYWluJ10pOwoKICBmdW5jdGlvbiBwcm9wcyhvYmopIHsKICAgIHZhciBwcm9wZXJ0aWVzID0gW107CgogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBwcm9wZXJ0aWVzLnB1c2goa2V5KTsKICAgIH0KCiAgICByZXR1cm4gcHJvcGVydGllczsKICB9CgogIC8qKgogICAgVGhlIGBFbmdpbmVgIGNsYXNzIGNvbnRhaW5zIGNvcmUgZnVuY3Rpb25hbGl0eSBmb3IgYm90aCBhcHBsaWNhdGlvbnMgYW5kCiAgICBlbmdpbmVzLgogIAogICAgRWFjaCBlbmdpbmUgbWFuYWdlcyBhIHJlZ2lzdHJ5IHRoYXQncyB1c2VkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbiBhbmQKICAgIGV4cG9zZWQgdGhyb3VnaCBgUmVnaXN0cnlQcm94eWAuCiAgCiAgICBFbmdpbmVzIGFsc28gbWFuYWdlIGluaXRpYWxpemVycyBhbmQgaW5zdGFuY2UgaW5pdGlhbGl6ZXJzLgogIAogICAgRW5naW5lcyBjYW4gc3Bhd24gYEVuZ2luZUluc3RhbmNlYCBpbnN0YW5jZXMgdmlhIGBidWlsZEluc3RhbmNlKClgLgogIAogICAgQGNsYXNzIEVuZ2luZQogICAgQGV4dGVuZHMgRW1iZXIuTmFtZXNwYWNlCiAgICBAdXNlcyBSZWdpc3RyeVByb3h5CiAgICBAcHVibGljCiAgKi8KICB2YXIgRW5naW5lID0gX2VtYmVyUnVudGltZS5OYW1lc3BhY2UuZXh0ZW5kKF9lbWJlclJ1bnRpbWUuUmVnaXN0cnlQcm94eU1peGluLCB7CiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLmJ1aWxkUmVnaXN0cnkoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBBIHByaXZhdGUgZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgYW4gZW5naW5lJ3MgaW5pdGlhbGl6ZXJzIGhhdmUgcnVuIHlldC4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSBfaW5pdGlhbGl6ZXJzUmFuCiAgICAqLwogICAgX2luaXRpYWxpemVyc1JhbjogZmFsc2UsCgogICAgZW5zdXJlSW5pdGlhbGl6ZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZXJzUmFuKSB7CiAgICAgICAgdGhpcy5ydW5Jbml0aWFsaXplcnMoKTsKICAgICAgICB0aGlzLl9pbml0aWFsaXplcnNSYW4gPSB0cnVlOwogICAgICB9CiAgICB9LAogICAgYnVpbGRJbnN0YW5jZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDoge307CgogICAgICB0aGlzLmVuc3VyZUluaXRpYWxpemVycygpOwogICAgICBvcHRpb25zLmJhc2UgPSB0aGlzOwogICAgICByZXR1cm4gX2luc3RhbmNlLmRlZmF1bHQuY3JlYXRlKG9wdGlvbnMpOwogICAgfSwKICAgIGJ1aWxkUmVnaXN0cnk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJlZ2lzdHJ5ID0gdGhpcy5fX3JlZ2lzdHJ5X18gPSB0aGlzLmNvbnN0cnVjdG9yLmJ1aWxkUmVnaXN0cnkodGhpcyk7CgogICAgICByZXR1cm4gcmVnaXN0cnk7CiAgICB9LAogICAgaW5pdGlhbGl6ZXI6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3IuaW5pdGlhbGl6ZXIob3B0aW9ucyk7CiAgICB9LAogICAgaW5zdGFuY2VJbml0aWFsaXplcjogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5pbnN0YW5jZUluaXRpYWxpemVyKG9wdGlvbnMpOwogICAgfSwKICAgIHJ1bkluaXRpYWxpemVyczogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5fcnVuSW5pdGlhbGl6ZXIoJ2luaXRpYWxpemVycycsIGZ1bmN0aW9uIChuYW1lLCBpbml0aWFsaXplcikgewogICAgICAgICh0cnVlICYmICEoISFpbml0aWFsaXplcikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdObyBhcHBsaWNhdGlvbiBpbml0aWFsaXplciBuYW1lZCBcJycgKyBuYW1lICsgJ1wnJywgISFpbml0aWFsaXplcikpOwoKICAgICAgICBpbml0aWFsaXplci5pbml0aWFsaXplKF90aGlzKTsKICAgICAgfSk7CiAgICB9LAogICAgcnVuSW5zdGFuY2VJbml0aWFsaXplcnM6IGZ1bmN0aW9uIChpbnN0YW5jZSkgewogICAgICB0aGlzLl9ydW5Jbml0aWFsaXplcignaW5zdGFuY2VJbml0aWFsaXplcnMnLCBmdW5jdGlvbiAobmFtZSwgaW5pdGlhbGl6ZXIpIHsKICAgICAgICAodHJ1ZSAmJiAhKCEhaW5pdGlhbGl6ZXIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnTm8gaW5zdGFuY2UgaW5pdGlhbGl6ZXIgbmFtZWQgXCcnICsgbmFtZSArICdcJycsICEhaW5pdGlhbGl6ZXIpKTsKCiAgICAgICAgaW5pdGlhbGl6ZXIuaW5pdGlhbGl6ZShpbnN0YW5jZSk7CiAgICAgIH0pOwogICAgfSwKICAgIF9ydW5Jbml0aWFsaXplcjogZnVuY3Rpb24gKGJ1Y2tldE5hbWUsIGNiKSB7CiAgICAgIHZhciBpbml0aWFsaXplcnNCeU5hbWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLmNvbnN0cnVjdG9yLCBidWNrZXROYW1lKTsKICAgICAgdmFyIGluaXRpYWxpemVycyA9IHByb3BzKGluaXRpYWxpemVyc0J5TmFtZSk7CiAgICAgIHZhciBncmFwaCA9IG5ldyBfZGFnTWFwLmRlZmF1bHQoKTsKICAgICAgdmFyIGluaXRpYWxpemVyID0gdm9pZCAwOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbml0aWFsaXplcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpbml0aWFsaXplciA9IGluaXRpYWxpemVyc0J5TmFtZVtpbml0aWFsaXplcnNbaV1dOwogICAgICAgIGdyYXBoLmFkZChpbml0aWFsaXplci5uYW1lLCBpbml0aWFsaXplciwgaW5pdGlhbGl6ZXIuYmVmb3JlLCBpbml0aWFsaXplci5hZnRlcik7CiAgICAgIH0KCiAgICAgIGdyYXBoLnRvcHNvcnQoY2IpOwogICAgfQogIH0pOwoKICBFbmdpbmUucmVvcGVuQ2xhc3MoewogICAgaW5pdGlhbGl6ZXJzOiBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgaW5zdGFuY2VJbml0aWFsaXplcnM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogICAgLyoqCiAgICAgIFRoZSBnb2FsIG9mIGluaXRpYWxpemVycyBzaG91bGQgYmUgdG8gcmVnaXN0ZXIgZGVwZW5kZW5jaWVzIGFuZCBpbmplY3Rpb25zLgogICAgICBUaGlzIHBoYXNlIHJ1bnMgb25jZS4gQmVjYXVzZSB0aGVzZSBpbml0aWFsaXplcnMgbWF5IGxvYWQgY29kZSwgdGhleSBhcmUKICAgICAgYWxsb3dlZCB0byBkZWZlciBhcHBsaWNhdGlvbiByZWFkaW5lc3MgYW5kIGFkdmFuY2UgaXQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcwogICAgICB0aGUgY29udGFpbmVyIG9yIHN0b3JlIHlvdSBzaG91bGQgdXNlIGFuIEluc3RhbmNlSW5pdGlhbGl6ZXIgdGhhdCB3aWxsIGJlIHJ1bgogICAgICBhZnRlciBhbGwgaW5pdGlhbGl6ZXJzIGFuZCB0aGVyZWZvcmUgYWZ0ZXIgYWxsIGNvZGUgaXMgbG9hZGVkIGFuZCB0aGUgYXBwIGlzCiAgICAgIHJlYWR5LgogICAgICAgSW5pdGlhbGl6ZXIgcmVjZWl2ZXMgYW4gb2JqZWN0IHdoaWNoIGhhcyB0aGUgZm9sbG93aW5nIGF0dHJpYnV0ZXM6CiAgICAgIGBuYW1lYCwgYGJlZm9yZWAsIGBhZnRlcmAsIGBpbml0aWFsaXplYC4gVGhlIG9ubHkgcmVxdWlyZWQgYXR0cmlidXRlIGlzCiAgICAgIGBpbml0aWFsaXplYCwgYWxsIG90aGVycyBhcmUgb3B0aW9uYWwuCiAgICAgICAqIGBuYW1lYCBhbGxvd3MgeW91IHRvIHNwZWNpZnkgdW5kZXIgd2hpY2ggbmFtZSB0aGUgaW5pdGlhbGl6ZXIgaXMgcmVnaXN0ZXJlZC4KICAgICAgVGhpcyBtdXN0IGJlIGEgdW5pcXVlIG5hbWUsIGFzIHRyeWluZyB0byByZWdpc3RlciB0d28gaW5pdGlhbGl6ZXJzIHdpdGggdGhlCiAgICAgIHNhbWUgbmFtZSB3aWxsIHJlc3VsdCBpbiBhbiBlcnJvci4KICAgICAgIGBgYGFwcC9pbml0aWFsaXplci9uYW1lZC1pbml0aWFsaXplci5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnUnVubmluZyBuYW1lZEluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ25hbWVkLWluaXRpYWxpemVyJywKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgKiBgYmVmb3JlYCBhbmQgYGFmdGVyYCBhcmUgdXNlZCB0byBlbnN1cmUgdGhhdCB0aGlzIGluaXRpYWxpemVyIGlzIHJhbiBwcmlvcgogICAgICBvciBhZnRlciB0aGUgb25lIGlkZW50aWZpZWQgYnkgdGhlIHZhbHVlLiBUaGlzIHZhbHVlIGNhbiBiZSBhIHNpbmdsZSBzdHJpbmcKICAgICAgb3IgYW4gYXJyYXkgb2Ygc3RyaW5ncywgcmVmZXJlbmNpbmcgdGhlIGBuYW1lYCBvZiBvdGhlciBpbml0aWFsaXplcnMuCiAgICAgICBBbiBleGFtcGxlIG9mIG9yZGVyaW5nIGluaXRpYWxpemVycywgd2UgY3JlYXRlIGFuIGluaXRpYWxpemVyIG5hbWVkIGBmaXJzdGA6CiAgICAgICBgYGBhcHAvaW5pdGlhbGl6ZXIvZmlyc3QuanMKICAgICAgaW1wb3J0IHsgZGVidWcgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgZGVidWcoJ0ZpcnN0IGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ2ZpcnN0JywKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgYGBgYmFzaAogICAgICAvLyBERUJVRzogRmlyc3QgaW5pdGlhbGl6ZXIhCiAgICAgIGBgYAogICAgICAgV2UgYWRkIGFub3RoZXIgaW5pdGlhbGl6ZXIgbmFtZWQgYHNlY29uZGAsIHNwZWNpZnlpbmcgdGhhdCBpdCBzaG91bGQgcnVuCiAgICAgIGFmdGVyIHRoZSBpbml0aWFsaXplciBuYW1lZCBgZmlyc3RgOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3NlY29uZC5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnU2Vjb25kIGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ3NlY29uZCcsCiAgICAgICAgYWZ0ZXI6ICdmaXJzdCcsCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgIGBgYAogICAgICAvLyBERUJVRzogRmlyc3QgaW5pdGlhbGl6ZXIhCiAgICAgIC8vIERFQlVHOiBTZWNvbmQgaW5pdGlhbGl6ZXIhCiAgICAgIGBgYAogICAgICAgQWZ0ZXJ3YXJkcyB3ZSBhZGQgYSBmdXJ0aGVyIGluaXRpYWxpemVyIG5hbWVkIGBwcmVgLCB0aGlzIHRpbWUgc3BlY2lmeWluZwogICAgICB0aGF0IGl0IHNob3VsZCBydW4gYmVmb3JlIHRoZSBpbml0aWFsaXplciBuYW1lZCBgZmlyc3RgOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3ByZS5qcwogICAgICBpbXBvcnQgeyBkZWJ1ZyB9IGZyb20gJ0BlbWJlci9kZWJ1Zyc7CiAgICAgICBleHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICBkZWJ1ZygnUHJlIGluaXRpYWxpemVyIScpOwogICAgICB9CiAgICAgICBleHBvcnQgZGVmYXVsdCB7CiAgICAgICAgbmFtZTogJ3ByZScsCiAgICAgICAgYmVmb3JlOiAnZmlyc3QnLAogICAgICAgIGluaXRpYWxpemUKICAgICAgfTsKICAgICAgYGBgCiAgICAgICBgYGBiYXNoCiAgICAgIC8vIERFQlVHOiBQcmUgaW5pdGlhbGl6ZXIhCiAgICAgIC8vIERFQlVHOiBGaXJzdCBpbml0aWFsaXplciEKICAgICAgLy8gREVCVUc6IFNlY29uZCBpbml0aWFsaXplciEKICAgICAgYGBgCiAgICAgICBGaW5hbGx5IHdlIGFkZCBhbiBpbml0aWFsaXplciBuYW1lZCBgcG9zdGAsIHNwZWNpZnlpbmcgaXQgc2hvdWxkIHJ1biBhZnRlcgogICAgICBib3RoIHRoZSBgZmlyc3RgIGFuZCB0aGUgYHNlY29uZGAgaW5pdGlhbGl6ZXJzOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL3Bvc3QuanMKICAgICAgaW1wb3J0IHsgZGVidWcgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgZGVidWcoJ1Bvc3QgaW5pdGlhbGl6ZXIhJyk7CiAgICAgIH0KICAgICAgIGV4cG9ydCBkZWZhdWx0IHsKICAgICAgICBuYW1lOiAncG9zdCcsCiAgICAgICAgYWZ0ZXI6IFsnZmlyc3QnLCAnc2Vjb25kJ10sCiAgICAgICAgaW5pdGlhbGl6ZQogICAgICB9OwogICAgICBgYGAKICAgICAgIGBgYGJhc2gKICAgICAgLy8gREVCVUc6IFByZSBpbml0aWFsaXplciEKICAgICAgLy8gREVCVUc6IEZpcnN0IGluaXRpYWxpemVyIQogICAgICAvLyBERUJVRzogU2Vjb25kIGluaXRpYWxpemVyIQogICAgICAvLyBERUJVRzogUG9zdCBpbml0aWFsaXplciEKICAgICAgYGBgCiAgICAgICAqIGBpbml0aWFsaXplYCBpcyBhIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgcmVjZWl2ZXMgb25lIGFyZ3VtZW50LAogICAgICAgIGBhcHBsaWNhdGlvbmAsIG9uIHdoaWNoIHlvdSBjYW4gb3BlcmF0ZS4KICAgICAgIEV4YW1wbGUgb2YgdXNpbmcgYGFwcGxpY2F0aW9uYCB0byByZWdpc3RlciBhbiBhZGFwdGVyOgogICAgICAgYGBgYXBwL2luaXRpYWxpemVyL2FwaS1hZGFwdGVyLmpzCiAgICAgIGltcG9ydCBBcGlBZGFwdGVyIGZyb20gJy4uL3V0aWxzL2FwaS1hZGFwdGVyJzsKICAgICAgIGV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoJ2FwaS1hZGFwdGVyOm1haW4nLCBBcGlBZGFwdGVyKTsKICAgICAgfQogICAgICAgZXhwb3J0IGRlZmF1bHQgewogICAgICAgIG5hbWU6ICdwb3N0JywKICAgICAgICBhZnRlcjogWydmaXJzdCcsICdzZWNvbmQnXSwKICAgICAgICBpbml0aWFsaXplCiAgICAgIH07CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBpbml0aWFsaXplcgogICAgICBAcGFyYW0gaW5pdGlhbGl6ZXIge09iamVjdH0KICAgICAgQHB1YmxpYwogICAgKi8KCiAgICBpbml0aWFsaXplcjogYnVpbGRJbml0aWFsaXplck1ldGhvZCgnaW5pdGlhbGl6ZXJzJywgJ2luaXRpYWxpemVyJyksCgogICAgLyoqCiAgICAgIEluc3RhbmNlIGluaXRpYWxpemVycyBydW4gYWZ0ZXIgYWxsIGluaXRpYWxpemVycyBoYXZlIHJ1bi4gQmVjYXVzZQogICAgICBpbnN0YW5jZSBpbml0aWFsaXplcnMgcnVuIGFmdGVyIHRoZSBhcHAgaXMgZnVsbHkgc2V0IHVwLiBXZSBoYXZlIGFjY2VzcwogICAgICB0byB0aGUgc3RvcmUsIGNvbnRhaW5lciwgYW5kIG90aGVyIGl0ZW1zLiBIb3dldmVyLCB0aGVzZSBpbml0aWFsaXplcnMgcnVuCiAgICAgIGFmdGVyIGNvZGUgaGFzIGxvYWRlZCBhbmQgYXJlIG5vdCBhbGxvd2VkIHRvIGRlZmVyIHJlYWRpbmVzcy4KICAgICAgIEluc3RhbmNlIGluaXRpYWxpemVyIHJlY2VpdmVzIGFuIG9iamVjdCB3aGljaCBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICBgbmFtZWAsIGBiZWZvcmVgLCBgYWZ0ZXJgLCBgaW5pdGlhbGl6ZWAuIFRoZSBvbmx5IHJlcXVpcmVkIGF0dHJpYnV0ZSBpcwogICAgICBgaW5pdGlhbGl6ZWAsIGFsbCBvdGhlcnMgYXJlIG9wdGlvbmFsLgogICAgICAgKiBgbmFtZWAgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IHVuZGVyIHdoaWNoIG5hbWUgdGhlIGluc3RhbmNlSW5pdGlhbGl6ZXIgaXMKICAgICAgcmVnaXN0ZXJlZC4gVGhpcyBtdXN0IGJlIGEgdW5pcXVlIG5hbWUsIGFzIHRyeWluZyB0byByZWdpc3RlciB0d28KICAgICAgaW5zdGFuY2VJbml0aWFsaXplciB3aXRoIHRoZSBzYW1lIG5hbWUgd2lsbCByZXN1bHQgaW4gYW4gZXJyb3IuCiAgICAgICBgYGBhcHAvaW5pdGlhbGl6ZXIvbmFtZWQtaW5zdGFuY2UtaW5pdGlhbGl6ZXIuanMKICAgICAgaW1wb3J0IHsgZGVidWcgfSBmcm9tICdAZW1iZXIvZGVidWcnOwogICAgICAgZXhwb3J0IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgZGVidWcoJ1J1bm5pbmcgbmFtZWQtaW5zdGFuY2UtaW5pdGlhbGl6ZXIhJyk7CiAgICAgIH0KICAgICAgIGV4cG9ydCBkZWZhdWx0IHsKICAgICAgICBuYW1lOiAnbmFtZWQtaW5zdGFuY2UtaW5pdGlhbGl6ZXInLAogICAgICAgIGluaXRpYWxpemUKICAgICAgfTsKICAgICAgYGBgCiAgICAgICAqIGBiZWZvcmVgIGFuZCBgYWZ0ZXJgIGFyZSB1c2VkIHRvIGVuc3VyZSB0aGF0IHRoaXMgaW5pdGlhbGl6ZXIgaXMgcmFuIHByaW9yCiAgICAgIG9yIGFmdGVyIHRoZSBvbmUgaWRlbnRpZmllZCBieSB0aGUgdmFsdWUuIFRoaXMgdmFsdWUgY2FuIGJlIGEgc2luZ2xlIHN0cmluZwogICAgICBvciBhbiBhcnJheSBvZiBzdHJpbmdzLCByZWZlcmVuY2luZyB0aGUgYG5hbWVgIG9mIG90aGVyIGluaXRpYWxpemVycy4KICAgICAgICogU2VlIEFwcGxpY2F0aW9uLmluaXRpYWxpemVyIGZvciBkaXNjdXNzaW9uIG9uIHRoZSB1c2FnZSBvZiBiZWZvcmUKICAgICAgYW5kIGFmdGVyLgogICAgICAgRXhhbXBsZSBpbnN0YW5jZUluaXRpYWxpemVyIHRvIHByZWxvYWQgZGF0YSBpbnRvIHRoZSBzdG9yZS4KICAgICAgIGBgYGFwcC9pbml0aWFsaXplci9wcmVsb2FkLWRhdGEuanMKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgICB2YXIgdXNlckNvbmZpZywgdXNlckNvbmZpZ0VuY29kZWQsIHN0b3JlOwogICAgICAgICAgLy8gV2UgaGF2ZSBhIEhUTUwgZXNjYXBlZCBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB1c2VyJ3MgYmFzaWMKICAgICAgICAgIC8vIGNvbmZpZ3VyYXRpb24gZ2VuZXJhdGVkIHNlcnZlciBzaWRlIGFuZCBzdG9yZWQgaW4gdGhlIERPTSBvZiB0aGUgbWFpbgogICAgICAgICAgLy8gaW5kZXguaHRtbCBmaWxlLiBUaGlzIGFsbG93cyB0aGUgYXBwIHRvIGhhdmUgYWNjZXNzIHRvIGEgc2V0IG9mIGRhdGEKICAgICAgICAgIC8vIHdpdGhvdXQgbWFraW5nIGFueSBhZGRpdGlvbmFsIHJlbW90ZSBjYWxscy4gR29vZCBmb3IgYmFzaWMgZGF0YSB0aGF0IGlzCiAgICAgICAgICAvLyBuZWVkZWQgZm9yIGltbWVkaWF0ZSByZW5kZXJpbmcgb2YgdGhlIHBhZ2UuIEtlZXAgaW4gbWluZCwgdGhpcyBkYXRhLAogICAgICAgICAgLy8gbGlrZSBhbGwgbG9jYWwgbW9kZWxzIGFuZCBkYXRhIGNhbiBiZSBtYW5pcHVsYXRlZCBieSB0aGUgdXNlciwgc28gaXQKICAgICAgICAgIC8vIHNob3VsZCBub3QgYmUgcmVsaWVkIHVwb24gZm9yIHNlY3VyaXR5IG9yIGF1dGhvcml6YXRpb24uCiAgICAgICAgICAgLy8gR3JhYiB0aGUgZW5jb2RlZCBkYXRhIGZyb20gdGhlIG1ldGEgdGFnCiAgICAgICAgICB1c2VyQ29uZmlnRW5jb2RlZCA9ICQoJ2hlYWQgbWV0YVtuYW1lPWFwcC11c2VyLWNvbmZpZ10nKS5hdHRyKCdjb250ZW50Jyk7CiAgICAgICAgICAgLy8gVW5lc2NhcGUgdGhlIHRleHQsIHRoZW4gcGFyc2UgdGhlIHJlc3VsdGluZyBKU09OIGludG8gYSByZWFsIG9iamVjdAogICAgICAgICAgdXNlckNvbmZpZyA9IEpTT04ucGFyc2UodW5lc2NhcGUodXNlckNvbmZpZ0VuY29kZWQpKTsKICAgICAgICAgICAvLyBMb29rdXAgdGhlIHN0b3JlCiAgICAgICAgICBzdG9yZSA9IGFwcGxpY2F0aW9uLmxvb2t1cCgnc2VydmljZTpzdG9yZScpOwogICAgICAgICAgIC8vIFB1c2ggdGhlIGVuY29kZWQgSlNPTiBpbnRvIHRoZSBzdG9yZQogICAgICAgICAgc3RvcmUucHVzaFBheWxvYWQodXNlckNvbmZpZyk7CiAgICAgIH0KICAgICAgIGV4cG9ydCBkZWZhdWx0IHsKICAgICAgICBuYW1lOiAnbmFtZWQtaW5zdGFuY2UtaW5pdGlhbGl6ZXInLAogICAgICAgIGluaXRpYWxpemUKICAgICAgfTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGluc3RhbmNlSW5pdGlhbGl6ZXIKICAgICAgQHBhcmFtIGluc3RhbmNlSW5pdGlhbGl6ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGluc3RhbmNlSW5pdGlhbGl6ZXI6IGJ1aWxkSW5pdGlhbGl6ZXJNZXRob2QoJ2luc3RhbmNlSW5pdGlhbGl6ZXJzJywgJ2luc3RhbmNlIGluaXRpYWxpemVyJyksCgogICAgYnVpbGRSZWdpc3RyeTogZnVuY3Rpb24gKG5hbWVzcGFjZSkgewogICAgICB2YXIgcmVnaXN0cnkgPSBuZXcgX2NvbnRhaW5lci5SZWdpc3RyeSh7CiAgICAgICAgcmVzb2x2ZXI6IHJlc29sdmVyRm9yKG5hbWVzcGFjZSkKICAgICAgfSk7CgogICAgICByZWdpc3RyeS5zZXQgPSBfZW1iZXJNZXRhbC5zZXQ7CgogICAgICByZWdpc3RyeS5yZWdpc3RlcignYXBwbGljYXRpb246bWFpbicsIG5hbWVzcGFjZSwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CgogICAgICBjb21tb25TZXR1cFJlZ2lzdHJ5KHJlZ2lzdHJ5KTsKICAgICAgKDAsIF9lbWJlckdsaW1tZXIuc2V0dXBFbmdpbmVSZWdpc3RyeSkocmVnaXN0cnkpOwoKICAgICAgcmV0dXJuIHJlZ2lzdHJ5OwogICAgfSwKCgogICAgLyoqCiAgICAgIFNldCB0aGlzIHRvIHByb3ZpZGUgYW4gYWx0ZXJuYXRlIGNsYXNzIHRvIGBEZWZhdWx0UmVzb2x2ZXJgCiAgICAgICBAZGVwcmVjYXRlZCBVc2UgJ1Jlc29sdmVyJyBpbnN0ZWFkCiAgICAgIEBwcm9wZXJ0eSByZXNvbHZlcgogICAgICBAcHVibGljCiAgICAqLwogICAgcmVzb2x2ZXI6IG51bGwsCgogICAgLyoqCiAgICAgIFNldCB0aGlzIHRvIHByb3ZpZGUgYW4gYWx0ZXJuYXRlIGNsYXNzIHRvIGBEZWZhdWx0UmVzb2x2ZXJgCiAgICAgICBAcHJvcGVydHkgcmVzb2x2ZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIFJlc29sdmVyOiBudWxsCiAgfSk7CgogIC8qKgogICAgVGhpcyBmdW5jdGlvbiBkZWZpbmVzIHRoZSBkZWZhdWx0IGxvb2t1cCBydWxlcyBmb3IgY29udGFpbmVyIGxvb2t1cHM6CiAgCiAgICAqIHRlbXBsYXRlcyBhcmUgbG9va2VkIHVwIG9uIGBFbWJlci5URU1QTEFURVNgCiAgICAqIG90aGVyIG5hbWVzIGFyZSBsb29rZWQgdXAgb24gdGhlIGFwcGxpY2F0aW9uIGFmdGVyIGNsYXNzaWZ5aW5nIHRoZSBuYW1lLgogICAgICBGb3IgZXhhbXBsZSwgYGNvbnRyb2xsZXI6cG9zdGAgbG9va3MgdXAgYEFwcC5Qb3N0Q29udHJvbGxlcmAgYnkgZGVmYXVsdC4KICAgICogaWYgdGhlIGRlZmF1bHQgbG9va3VwIGZhaWxzLCBsb29rIGZvciByZWdpc3RlcmVkIGNsYXNzZXMgb24gdGhlIGNvbnRhaW5lcgogIAogICAgVGhpcyBhbGxvd3MgdGhlIGFwcGxpY2F0aW9uIHRvIHJlZ2lzdGVyIGRlZmF1bHQgaW5qZWN0aW9ucyBpbiB0aGUgY29udGFpbmVyCiAgICB0aGF0IGNvdWxkIGJlIG92ZXJyaWRkZW4gYnkgdGhlIG5vcm1hbCBuYW1pbmcgY29udmVudGlvbi4KICAKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHJlc29sdmVyRm9yCiAgICBAcGFyYW0ge0VtYmVyLk5hbWVzcGFjZX0gbmFtZXNwYWNlIHRoZSBuYW1lc3BhY2UgdG8gbG9vayBmb3IgY2xhc3NlcwogICAgQHJldHVybiB7Kn0gdGhlIHJlc29sdmVkIHZhbHVlIGZvciBhIGdpdmVuIGxvb2t1cAogICovCiAgZnVuY3Rpb24gcmVzb2x2ZXJGb3IobmFtZXNwYWNlKSB7CiAgICB2YXIgUmVzb2x2ZXJDbGFzcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKG5hbWVzcGFjZSwgJ1Jlc29sdmVyJykgfHwgX2dsb2JhbHNSZXNvbHZlci5kZWZhdWx0OwogICAgdmFyIHByb3BzID0geyBuYW1lc3BhY2U6IG5hbWVzcGFjZSB9OwogICAgcmV0dXJuIFJlc29sdmVyQ2xhc3MuY3JlYXRlKHByb3BzKTsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkSW5pdGlhbGl6ZXJNZXRob2QoYnVja2V0TmFtZSwgaHVtYW5OYW1lKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGluaXRpYWxpemVyKSB7CiAgICAgIC8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGluaXRpYWxpemVyIGJlaW5nIGFkZGVkIHRvIGEgc3ViY2xhc3MsIHdlIGFyZSBnb2luZyB0byByZW9wZW4gdGhlIGNsYXNzCiAgICAgIC8vIHRvIG1ha2Ugc3VyZSB3ZSBoYXZlIGEgbmV3IGBpbml0aWFsaXplcnNgIG9iamVjdCwgd2hpY2ggZXh0ZW5kcyBmcm9tIHRoZSBwYXJlbnQgY2xhc3MnIHVzaW5nCiAgICAgIC8vIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UuIFdpdGhvdXQgdGhpcywgYXR0ZW1wdGluZyB0byBhZGQgaW5pdGlhbGl6ZXJzIHRvIHRoZSBzdWJjbGFzcyB3b3VsZAogICAgICAvLyBwb2xsdXRlIHRoZSBwYXJlbnQgY2xhc3MgYXMgd2VsbCBhcyBvdGhlciBzdWJjbGFzc2VzLgogICAgICBpZiAodGhpcy5zdXBlcmNsYXNzW2J1Y2tldE5hbWVdICE9PSB1bmRlZmluZWQgJiYgdGhpcy5zdXBlcmNsYXNzW2J1Y2tldE5hbWVdID09PSB0aGlzW2J1Y2tldE5hbWVdKSB7CiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgYXR0cnNbYnVja2V0TmFtZV0gPSBPYmplY3QuY3JlYXRlKHRoaXNbYnVja2V0TmFtZV0pOwogICAgICAgIHRoaXMucmVvcGVuQ2xhc3MoYXR0cnMpOwogICAgICB9CgogICAgICAodHJ1ZSAmJiAhKCF0aGlzW2J1Y2tldE5hbWVdW2luaXRpYWxpemVyLm5hbWVdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSAnICsgaHVtYW5OYW1lICsgJyBcJycgKyBpbml0aWFsaXplci5uYW1lICsgJ1wnIGhhcyBhbHJlYWR5IGJlZW4gcmVnaXN0ZXJlZCcsICF0aGlzW2J1Y2tldE5hbWVdW2luaXRpYWxpemVyLm5hbWVdKSk7CiAgICAgICh0cnVlICYmICEoKDAsIF9lbWJlclV0aWxzLmNhbkludm9rZSkoaW5pdGlhbGl6ZXIsICdpbml0aWFsaXplJykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQW4gJyArIGh1bWFuTmFtZSArICcgY2Fubm90IGJlIHJlZ2lzdGVyZWQgd2l0aG91dCBhbiBpbml0aWFsaXplIGZ1bmN0aW9uJywgKDAsIF9lbWJlclV0aWxzLmNhbkludm9rZSkoaW5pdGlhbGl6ZXIsICdpbml0aWFsaXplJykpKTsKICAgICAgKHRydWUgJiYgIShpbml0aWFsaXplci5uYW1lICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQW4gJyArIGh1bWFuTmFtZSArICcgY2Fubm90IGJlIHJlZ2lzdGVyZWQgd2l0aG91dCBhIG5hbWUgcHJvcGVydHknLCBpbml0aWFsaXplci5uYW1lICE9PSB1bmRlZmluZWQpKTsKCgogICAgICB0aGlzW2J1Y2tldE5hbWVdW2luaXRpYWxpemVyLm5hbWVdID0gaW5pdGlhbGl6ZXI7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY29tbW9uU2V0dXBSZWdpc3RyeShyZWdpc3RyeSkgewogICAgcmVnaXN0cnkub3B0aW9uc0ZvclR5cGUoJ2NvbXBvbmVudCcsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgIHJlZ2lzdHJ5Lm9wdGlvbnNGb3JUeXBlKCd2aWV3JywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb250cm9sbGVyOmJhc2ljJywgX2NvbnRyb2xsZXIuZGVmYXVsdCwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CgogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCd2aWV3JywgJ192aWV3UmVnaXN0cnknLCAnLXZpZXctcmVnaXN0cnk6bWFpbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyZW5kZXJlcicsICdfdmlld1JlZ2lzdHJ5JywgJy12aWV3LXJlZ2lzdHJ5Om1haW4nKTsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignZXZlbnRfZGlzcGF0Y2hlcjptYWluJywgJ192aWV3UmVnaXN0cnknLCAnLXZpZXctcmVnaXN0cnk6bWFpbicpOwoKICAgIHJlZ2lzdHJ5LmluamVjdGlvbigncm91dGUnLCAnX3RvcExldmVsVmlld1RlbXBsYXRlJywgJ3RlbXBsYXRlOi1vdXRsZXQnKTsKCiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3ZpZXc6LW91dGxldCcsICduYW1lc3BhY2UnLCAnYXBwbGljYXRpb246bWFpbicpOwoKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignY29udHJvbGxlcicsICd0YXJnZXQnLCAncm91dGVyOm1haW4nKTsKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignY29udHJvbGxlcicsICduYW1lc3BhY2UnLCAnYXBwbGljYXRpb246bWFpbicpOwoKICAgIHJlZ2lzdHJ5LmluamVjdGlvbigncm91dGVyJywgJ19idWNrZXRDYWNoZScsICgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0KSk7CiAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3JvdXRlJywgJ19idWNrZXRDYWNoZScsICgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0KSk7CgogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZScsICdfcm91dGVyJywgJ3JvdXRlcjptYWluJyk7CgogICAgLy8gUmVnaXN0ZXIgdGhlIHJvdXRpbmcgc2VydmljZS4uLgogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6LXJvdXRpbmcnLCBfZW1iZXJSb3V0aW5nLlJvdXRpbmdTZXJ2aWNlKTsKICAgIC8vIFRoZW4gaW5qZWN0IHRoZSBhcHAgcm91dGVyIGludG8gaXQKICAgIHJlZ2lzdHJ5LmluamVjdGlvbignc2VydmljZTotcm91dGluZycsICdyb3V0ZXInLCAncm91dGVyOm1haW4nKTsKCiAgICAvLyBERUJVR0dJTkcKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdyZXNvbHZlci1mb3ItZGVidWdnaW5nOm1haW4nLCByZWdpc3RyeS5yZXNvbHZlciwgewogICAgICBpbnN0YW50aWF0ZTogZmFsc2UKICAgIH0pOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdjb250YWluZXItZGVidWctYWRhcHRlcjptYWluJywgJ3Jlc29sdmVyJywgJ3Jlc29sdmVyLWZvci1kZWJ1Z2dpbmc6bWFpbicpOwogICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdkYXRhLWFkYXB0ZXI6bWFpbicsICdjb250YWluZXJEZWJ1Z0FkYXB0ZXInLCAnY29udGFpbmVyLWRlYnVnLWFkYXB0ZXI6bWFpbicpOwogICAgLy8gQ3VzdG9tIHJlc29sdmVyIGF1dGhvcnMgbWF5IHdhbnQgdG8gcmVnaXN0ZXIgdGhlaXIgb3duIENvbnRhaW5lckRlYnVnQWRhcHRlciB3aXRoIHRoaXMga2V5CgogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbnRhaW5lci1kZWJ1Zy1hZGFwdGVyOm1haW4nLCBfZW1iZXJFeHRlbnNpb25TdXBwb3J0LkNvbnRhaW5lckRlYnVnQWRhcHRlcik7CgogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbXBvbmVudC1sb29rdXA6bWFpbicsIF9lbWJlclZpZXdzLkNvbXBvbmVudExvb2t1cCk7CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSBFbmdpbmU7Cn0pOwplbmlmZWQoJ0BlbWJlci9lbmdpbmUvaW5zdGFuY2UnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnZW1iZXItdXRpbHMnLCAnZW1iZXItcnVudGltZScsICdAZW1iZXIvZGVidWcnLCAnQGVtYmVyL2Vycm9yJywgJ2NvbnRhaW5lcicsICdAZW1iZXIvZW5naW5lL2xpYi9lbmdpbmUtcGFyZW50J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX2VtYmVyVXRpbHMsIF9lbWJlclJ1bnRpbWUsIF9kZWJ1ZywgX2Vycm9yLCBfY29udGFpbmVyLCBfZW5naW5lUGFyZW50KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgX3RlbXBsYXRlT2JqZWN0ID0gKDAsIF9lbWJlckJhYmVsLnRhZ2dlZFRlbXBsYXRlTGl0ZXJhbExvb3NlKShbJy1idWNrZXQtY2FjaGU6bWFpbiddLCBbJy1idWNrZXQtY2FjaGU6bWFpbiddKSwKICAgICAgX3RlbXBsYXRlT2JqZWN0MiA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyd0ZW1wbGF0ZS1jb21waWxlcjptYWluJ10sIFsndGVtcGxhdGUtY29tcGlsZXI6bWFpbiddKTsKCiAgLyoqCiAgICBUaGUgYEVuZ2luZUluc3RhbmNlYCBlbmNhcHN1bGF0ZXMgYWxsIG9mIHRoZSBzdGF0ZWZ1bCBhc3BlY3RzIG9mIGEKICAgIHJ1bm5pbmcgYEVuZ2luZWAuCiAgCiAgICBAcHVibGljCiAgICBAY2xhc3MgRW5naW5lSW5zdGFuY2UKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAdXNlcyBSZWdpc3RyeVByb3h5TWl4aW4KICAgIEB1c2VzIENvbnRhaW5lclByb3h5TWl4aW4KICAqLwoKICB2YXIgRW5naW5lSW5zdGFuY2UgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoX2VtYmVyUnVudGltZS5SZWdpc3RyeVByb3h5TWl4aW4sIF9lbWJlclJ1bnRpbWUuQ29udGFpbmVyUHJveHlNaXhpbiwgewogICAgLyoqCiAgICAgIFRoZSBiYXNlIGBFbmdpbmVgIGZvciB3aGljaCB0aGlzIGlzIGFuIGluc3RhbmNlLgogICAgICAgQHByb3BlcnR5IHtFbmdpbmV9IGVuZ2luZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGJhc2U6IG51bGwsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgKDAsIF9lbWJlclV0aWxzLmd1aWRGb3IpKHRoaXMpOwoKICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2U7CgogICAgICBpZiAoIWJhc2UpIHsKICAgICAgICBiYXNlID0gdGhpcy5hcHBsaWNhdGlvbjsKICAgICAgICB0aGlzLmJhc2UgPSBiYXNlOwogICAgICB9CgogICAgICAvLyBDcmVhdGUgYSBwZXItaW5zdGFuY2UgcmVnaXN0cnkgdGhhdCB3aWxsIHVzZSB0aGUgYXBwbGljYXRpb24ncyByZWdpc3RyeQogICAgICAvLyBhcyBhIGZhbGxiYWNrIGZvciByZXNvbHZpbmcgcmVnaXN0cmF0aW9ucy4KICAgICAgdmFyIHJlZ2lzdHJ5ID0gdGhpcy5fX3JlZ2lzdHJ5X18gPSBuZXcgX2NvbnRhaW5lci5SZWdpc3RyeSh7CiAgICAgICAgZmFsbGJhY2s6IGJhc2UuX19yZWdpc3RyeV9fCiAgICAgIH0pOwoKICAgICAgLy8gQ3JlYXRlIGEgcGVyLWluc3RhbmNlIGNvbnRhaW5lciBmcm9tIHRoZSBpbnN0YW5jZSdzIHJlZ2lzdHJ5CiAgICAgIHRoaXMuX19jb250YWluZXJfXyA9IHJlZ2lzdHJ5LmNvbnRhaW5lcih7IG93bmVyOiB0aGlzIH0pOwoKICAgICAgdGhpcy5fYm9vdGVkID0gZmFsc2U7CiAgICB9LAogICAgYm9vdDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIGlmICh0aGlzLl9ib290UHJvbWlzZSkgewogICAgICAgIHJldHVybiB0aGlzLl9ib290UHJvbWlzZTsKICAgICAgfQoKICAgICAgdGhpcy5fYm9vdFByb21pc2UgPSBuZXcgX2VtYmVyUnVudGltZS5SU1ZQLlByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZShfdGhpcy5fYm9vdFN5bmMob3B0aW9ucykpOwogICAgICB9KTsKCiAgICAgIHJldHVybiB0aGlzLl9ib290UHJvbWlzZTsKICAgIH0sCiAgICBfYm9vdFN5bmM6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLl9ib290ZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgKHRydWUgJiYgISgoMCwgX2VuZ2luZVBhcmVudC5nZXRFbmdpbmVQYXJlbnQpKHRoaXMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkFuIGVuZ2luZSBpbnN0YW5jZSdzIHBhcmVudCBtdXN0IGJlIHNldCB2aWEgYHNldEVuZ2luZVBhcmVudChlbmdpbmUsIHBhcmVudClgIHByaW9yIHRvIGNhbGxpbmcgYGVuZ2luZS5ib290KClgLiIsICgwLCBfZW5naW5lUGFyZW50LmdldEVuZ2luZVBhcmVudCkodGhpcykpKTsKCgogICAgICB0aGlzLmNsb25lUGFyZW50RGVwZW5kZW5jaWVzKCk7CgogICAgICB0aGlzLnNldHVwUmVnaXN0cnkob3B0aW9ucyk7CgogICAgICB0aGlzLmJhc2UucnVuSW5zdGFuY2VJbml0aWFsaXplcnModGhpcyk7CgogICAgICB0aGlzLl9ib290ZWQgPSB0cnVlOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2V0dXBSZWdpc3RyeTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogdGhpcy5fX2NvbnRhaW5lcl9fLmxvb2t1cCgnLWVudmlyb25tZW50Om1haW4nKTsKCiAgICAgIHRoaXMuY29uc3RydWN0b3Iuc2V0dXBSZWdpc3RyeSh0aGlzLl9fcmVnaXN0cnlfXywgb3B0aW9ucyk7CiAgICB9LAogICAgdW5yZWdpc3RlcjogZnVuY3Rpb24gKGZ1bGxOYW1lKSB7CiAgICAgIHRoaXMuX19jb250YWluZXJfXy5yZXNldChmdWxsTmFtZSk7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgYnVpbGRDaGlsZEVuZ2luZUluc3RhbmNlOiBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge307CgogICAgICB2YXIgRW5naW5lID0gdGhpcy5sb29rdXAoJ2VuZ2luZTonICsgbmFtZSk7CgogICAgICBpZiAoIUVuZ2luZSkgewogICAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdCgnWW91IGF0dGVtcHRlZCB0byBtb3VudCB0aGUgZW5naW5lIFwnJyArIG5hbWUgKyAnXCcsIGJ1dCBpdCBpcyBub3QgcmVnaXN0ZXJlZCB3aXRoIGl0cyBwYXJlbnQuJyk7CiAgICAgIH0KCiAgICAgIHZhciBlbmdpbmVJbnN0YW5jZSA9IEVuZ2luZS5idWlsZEluc3RhbmNlKG9wdGlvbnMpOwoKICAgICAgKDAsIF9lbmdpbmVQYXJlbnQuc2V0RW5naW5lUGFyZW50KShlbmdpbmVJbnN0YW5jZSwgdGhpcyk7CgogICAgICByZXR1cm4gZW5naW5lSW5zdGFuY2U7CiAgICB9LAogICAgY2xvbmVQYXJlbnREZXBlbmRlbmNpZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcGFyZW50ID0gKDAsIF9lbmdpbmVQYXJlbnQuZ2V0RW5naW5lUGFyZW50KSh0aGlzKTsKCiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gWydyb3V0ZTpiYXNpYycsICdzZXJ2aWNlOi1yb3V0aW5nJywgJ3NlcnZpY2U6LWdsaW1tZXItZW52aXJvbm1lbnQnXTsKCiAgICAgIHJlZ2lzdHJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5yZWdpc3RlcihrZXksIHBhcmVudC5yZXNvbHZlUmVnaXN0cmF0aW9uKGtleSkpOwogICAgICB9KTsKCiAgICAgIHZhciBlbnYgPSBwYXJlbnQubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICB0aGlzLnJlZ2lzdGVyKCctZW52aXJvbm1lbnQ6bWFpbicsIGVudiwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CgogICAgICB2YXIgc2luZ2xldG9ucyA9IFsncm91dGVyOm1haW4nLCAoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdCksICctdmlldy1yZWdpc3RyeTptYWluJywgJ3JlbmRlcmVyOi0nICsgKGVudi5pc0ludGVyYWN0aXZlID8gJ2RvbScgOiAnaW5lcnQnKSwgJ3NlcnZpY2U6LWRvY3VtZW50JywgKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QyKV07CgogICAgICBpZiAoZW52LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICBzaW5nbGV0b25zLnB1c2goJ2V2ZW50X2Rpc3BhdGNoZXI6bWFpbicpOwogICAgICB9CgogICAgICBzaW5nbGV0b25zLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHJldHVybiBfdGhpczIucmVnaXN0ZXIoa2V5LCBwYXJlbnQubG9va3VwKGtleSksIHsgaW5zdGFudGlhdGU6IGZhbHNlIH0pOwogICAgICB9KTsKCiAgICAgIHRoaXMuaW5qZWN0KCd2aWV3JywgJ19lbnZpcm9ubWVudCcsICctZW52aXJvbm1lbnQ6bWFpbicpOwogICAgICB0aGlzLmluamVjdCgncm91dGUnLCAnX2Vudmlyb25tZW50JywgJy1lbnZpcm9ubWVudDptYWluJyk7CiAgICB9CiAgfSk7CgogIEVuZ2luZUluc3RhbmNlLnJlb3BlbkNsYXNzKHsKICAgIHNldHVwUmVnaXN0cnk6IGZ1bmN0aW9uIChyZWdpc3RyeSwgb3B0aW9ucykgewogICAgICAvLyB3aGVuIG5vIG9wdGlvbnMvZW52aXJvbm1lbnQgaXMgcHJlc2VudCwgZG8gbm90aGluZwogICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigndmlldycsICdfZW52aXJvbm1lbnQnLCAnLWVudmlyb25tZW50Om1haW4nKTsKICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyb3V0ZScsICdfZW52aXJvbm1lbnQnLCAnLWVudmlyb25tZW50Om1haW4nKTsKCiAgICAgIGlmIChvcHRpb25zLmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3ZpZXcnLCAncmVuZGVyZXInLCAncmVuZGVyZXI6LWRvbScpOwogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbignY29tcG9uZW50JywgJ3JlbmRlcmVyJywgJ3JlbmRlcmVyOi1kb20nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3ZpZXcnLCAncmVuZGVyZXInLCAncmVuZGVyZXI6LWluZXJ0Jyk7CiAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdjb21wb25lbnQnLCAncmVuZGVyZXInLCAncmVuZGVyZXI6LWluZXJ0Jyk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gRW5naW5lSW5zdGFuY2U7Cn0pOwplbmlmZWQoJ0BlbWJlci9lbmdpbmUvbGliL2VuZ2luZS1wYXJlbnQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlclV0aWxzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmdldEVuZ2luZVBhcmVudCA9IGdldEVuZ2luZVBhcmVudDsKICBleHBvcnRzLnNldEVuZ2luZVBhcmVudCA9IHNldEVuZ2luZVBhcmVudDsKCgogIHZhciBFTkdJTkVfUEFSRU5UID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ0VOR0lORV9QQVJFTlQnKTsKCiAgLyoqCiAgICBgZ2V0RW5naW5lUGFyZW50YCByZXRyaWV2ZXMgYW4gZW5naW5lIGluc3RhbmNlJ3MgcGFyZW50IGluc3RhbmNlLgogIAogICAgQG1ldGhvZCBnZXRFbmdpbmVQYXJlbnQKICAgIEBwYXJhbSB7RW5naW5lSW5zdGFuY2V9IGVuZ2luZSBBbiBlbmdpbmUgaW5zdGFuY2UuCiAgICBAcmV0dXJuIHtFbmdpbmVJbnN0YW5jZX0gVGhlIHBhcmVudCBlbmdpbmUgaW5zdGFuY2UuCiAgICBAZm9yIEBlbWJlci9lbmdpbmUKICAgIEBzdGF0aWMKICAgIEBwcml2YXRlCiAgKi8KICAvKioKICBAbW9kdWxlIEBlbWJlci9lbmdpbmUKICAqLwogIGZ1bmN0aW9uIGdldEVuZ2luZVBhcmVudChlbmdpbmUpIHsKICAgIHJldHVybiBlbmdpbmVbRU5HSU5FX1BBUkVOVF07CiAgfQoKICAvKioKICAgIGBzZXRFbmdpbmVQYXJlbnRgIHNldHMgYW4gZW5naW5lIGluc3RhbmNlJ3MgcGFyZW50IGluc3RhbmNlLgogIAogICAgQG1ldGhvZCBzZXRFbmdpbmVQYXJlbnQKICAgIEBwYXJhbSB7RW5naW5lSW5zdGFuY2V9IGVuZ2luZSBBbiBlbmdpbmUgaW5zdGFuY2UuCiAgICBAcGFyYW0ge0VuZ2luZUluc3RhbmNlfSBwYXJlbnQgVGhlIHBhcmVudCBlbmdpbmUgaW5zdGFuY2UuCiAgICBAcHJpdmF0ZQogICovCiAgZnVuY3Rpb24gc2V0RW5naW5lUGFyZW50KGVuZ2luZSwgcGFyZW50KSB7CiAgICBlbmdpbmVbRU5HSU5FX1BBUkVOVF0gPSBwYXJlbnQ7CiAgfQp9KTsKZW5pZmVkKCJAZW1iZXIvZXJyb3IvaW5kZXgiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvZXJyb3IKICAgICovCiAgICBmdW5jdGlvbiBFeHRlbmRCdWlsdGluKGtsYXNzKSB7CiAgICAgICAgZnVuY3Rpb24gRXh0ZW5kYWJsZUJ1aWx0aW4oKSB7CiAgICAgICAgICAgIGtsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICAgIEV4dGVuZGFibGVCdWlsdGluLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoa2xhc3MucHJvdG90eXBlKTsKICAgICAgICBFeHRlbmRhYmxlQnVpbHRpbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBFeHRlbmRhYmxlQnVpbHRpbjsKICAgICAgICByZXR1cm4gRXh0ZW5kYWJsZUJ1aWx0aW47CiAgICB9CiAgICAvKioKICAgICAgQSBzdWJjbGFzcyBvZiB0aGUgSmF2YVNjcmlwdCBFcnJvciBvYmplY3QgZm9yIHVzZSBpbiBFbWJlci4KICAgIAogICAgICBAY2xhc3MgRW1iZXJFcnJvcgogICAgICBAZXh0ZW5kcyBFcnJvcgogICAgICBAY29uc3RydWN0b3IKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICB2YXIgRW1iZXJFcnJvciA9IGZ1bmN0aW9uIChfRXh0ZW5kQnVpbHRpbikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRW1iZXJFcnJvciwgX0V4dGVuZEJ1aWx0aW4pOwoKICAgICAgICBmdW5jdGlvbiBFbWJlckVycm9yKG1lc3NhZ2UpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBFbWJlckVycm9yKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRXh0ZW5kQnVpbHRpbi5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIGlmICghKF90aGlzIGluc3RhbmNlb2YgRW1iZXJFcnJvcikpIHsKICAgICAgICAgICAgICAgIHZhciBfcmV0OwoKICAgICAgICAgICAgICAgIHJldHVybiBfcmV0ID0gbmV3IEVtYmVyRXJyb3IobWVzc2FnZSksICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKShfdGhpcywgX3JldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbChfdGhpcywgbWVzc2FnZSk7CiAgICAgICAgICAgIF90aGlzLnN0YWNrID0gZXJyb3Iuc3RhY2s7CiAgICAgICAgICAgIF90aGlzLmRlc2NyaXB0aW9uID0gZXJyb3IuZGVzY3JpcHRpb247CiAgICAgICAgICAgIF90aGlzLmZpbGVOYW1lID0gZXJyb3IuZmlsZU5hbWU7CiAgICAgICAgICAgIF90aGlzLmxpbmVOdW1iZXIgPSBlcnJvci5saW5lTnVtYmVyOwogICAgICAgICAgICBfdGhpcy5tZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgX3RoaXMubmFtZSA9IGVycm9yLm5hbWU7CiAgICAgICAgICAgIF90aGlzLm51bWJlciA9IGVycm9yLm51bWJlcjsKICAgICAgICAgICAgX3RoaXMuY29kZSA9IGVycm9yLmNvZGU7CiAgICAgICAgICAgIHJldHVybiBfdGhpczsKICAgICAgICB9CgogICAgICAgIHJldHVybiBFbWJlckVycm9yOwogICAgfShFeHRlbmRCdWlsdGluKEVycm9yKSk7CgogICAgZXhwb3J0cy5kZWZhdWx0ID0gRW1iZXJFcnJvcjsKfSk7CmVuaWZlZCgnQGVtYmVyL2luc3RydW1lbnRhdGlvbi9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1lbnZpcm9ubWVudCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyRW52aXJvbm1lbnQpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLmZsYWdnZWRJbnN0cnVtZW50ID0gZXhwb3J0cy5zdWJzY3JpYmVycyA9IHVuZGVmaW5lZDsKICAgIGV4cG9ydHMuaW5zdHJ1bWVudCA9IGluc3RydW1lbnQ7CiAgICBleHBvcnRzLl9pbnN0cnVtZW50U3RhcnQgPSBfaW5zdHJ1bWVudFN0YXJ0OwogICAgZXhwb3J0cy5zdWJzY3JpYmUgPSBzdWJzY3JpYmU7CiAgICBleHBvcnRzLnVuc3Vic2NyaWJlID0gdW5zdWJzY3JpYmU7CiAgICBleHBvcnRzLnJlc2V0ID0gcmVzZXQ7CgogICAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9pbnN0cnVtZW50YXRpb24KICAgIEBwcml2YXRlCiAgICAqLwogICAgLyoqCiAgICAgIFRoZSBwdXJwb3NlIG9mIHRoZSBFbWJlciBJbnN0cnVtZW50YXRpb24gbW9kdWxlIGlzCiAgICAgIHRvIHByb3ZpZGUgZWZmaWNpZW50LCBnZW5lcmFsLXB1cnBvc2UgaW5zdHJ1bWVudGF0aW9uCiAgICAgIGZvciBFbWJlci4KICAgIAogICAgICBTdWJzY3JpYmUgdG8gYSBsaXN0ZW5lciBieSB1c2luZyBgc3Vic2NyaWJlYDoKICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IHN1YnNjcmliZSB9IGZyb20gJ0BlbWJlci9pbnN0cnVtZW50YXRpb24nOwogICAgCiAgICAgIHN1YnNjcmliZSgicmVuZGVyIiwgewogICAgICAgIGJlZm9yZShuYW1lLCB0aW1lc3RhbXAsIHBheWxvYWQpIHsKICAgIAogICAgICAgIH0sCiAgICAKICAgICAgICBhZnRlcihuYW1lLCB0aW1lc3RhbXAsIHBheWxvYWQpIHsKICAgIAogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIElmIHlvdSByZXR1cm4gYSB2YWx1ZSBmcm9tIHRoZSBgYmVmb3JlYCBjYWxsYmFjaywgdGhhdCBzYW1lCiAgICAgIHZhbHVlIHdpbGwgYmUgcGFzc2VkIGFzIGEgZm91cnRoIHBhcmFtZXRlciB0byB0aGUgYGFmdGVyYAogICAgICBjYWxsYmFjay4KICAgIAogICAgICBJbnN0cnVtZW50IGEgYmxvY2sgb2YgY29kZSBieSB1c2luZyBgaW5zdHJ1bWVudGA6CiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBpbnN0cnVtZW50IH0gZnJvbSAnQGVtYmVyL2luc3RydW1lbnRhdGlvbic7CiAgICAKICAgICAgaW5zdHJ1bWVudCgicmVuZGVyLmhhbmRsZWJhcnMiLCBwYXlsb2FkLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyByZW5kZXJpbmcgbG9naWMKICAgICAgfSwgYmluZGluZyk7CiAgICAgIGBgYAogICAgCiAgICAgIEV2ZW50IG5hbWVzIHBhc3NlZCB0byBgaW5zdHJ1bWVudGAgYXJlIG5hbWVzcGFjZWQKICAgICAgYnkgcGVyaW9kcywgZnJvbSBtb3JlIGdlbmVyYWwgdG8gbW9yZSBzcGVjaWZpYy4gU3Vic2NyaWJlcnMKICAgICAgY2FuIGxpc3RlbiBmb3IgZXZlbnRzIGJ5IHdoYXRldmVyIGxldmVsIG9mIGdyYW51bGFyaXR5IHRoZXkKICAgICAgYXJlIGludGVyZXN0ZWQgaW4uCiAgICAKICAgICAgSW4gdGhlIGFib3ZlIGV4YW1wbGUsIHRoZSBldmVudCBpcyBgcmVuZGVyLmhhbmRsZWJhcnNgLAogICAgICBhbmQgdGhlIHN1YnNjcmliZXIgbGlzdGVuZWQgZm9yIGFsbCBldmVudHMgYmVnaW5uaW5nIHdpdGgKICAgICAgYHJlbmRlcmAuIEl0IHdvdWxkIHJlY2VpdmUgY2FsbGJhY2tzIGZvciBldmVudHMgbmFtZWQKICAgICAgYHJlbmRlcmAsIGByZW5kZXIuaGFuZGxlYmFyc2AsIGByZW5kZXIuY29udGFpbmVyYCwgb3IKICAgICAgZXZlbiBgcmVuZGVyLmhhbmRsZWJhcnMubGF5b3V0YC4KICAgIAogICAgICBAY2xhc3MgSW5zdHJ1bWVudGF0aW9uCiAgICAgIEBzdGF0aWMKICAgICAgQHByaXZhdGUKICAgICovCiAgICAvKiBlc2xpbnQgbm8tY29uc29sZTpvZmYgKi8KICAgIC8qIGdsb2JhbCBjb25zb2xlICovCiAgICB2YXIgc3Vic2NyaWJlcnMgPSBleHBvcnRzLnN1YnNjcmliZXJzID0gW107CiAgICB2YXIgY2FjaGUgPSB7fTsKICAgIGZ1bmN0aW9uIHBvcHVsYXRlTGlzdGVuZXJzKG5hbWUpIHsKICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgdmFyIHN1YnNjcmliZXIgPSB2b2lkIDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzY3JpYmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBzdWJzY3JpYmVyID0gc3Vic2NyaWJlcnNbaV07CiAgICAgICAgICAgIGlmIChzdWJzY3JpYmVyLnJlZ2V4LnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKHN1YnNjcmliZXIub2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYWNoZVtuYW1lXSA9IGxpc3RlbmVyczsKICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfQogICAgdmFyIHRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBlcmYgPSAndW5kZWZpbmVkJyAhPT0gdHlwZW9mIHdpbmRvdyA/IHdpbmRvdy5wZXJmb3JtYW5jZSB8fCB7fSA6IHt9OwogICAgICAgIHZhciBmbiA9IHBlcmYubm93IHx8IHBlcmYubW96Tm93IHx8IHBlcmYud2Via2l0Tm93IHx8IHBlcmYubXNOb3cgfHwgcGVyZi5vTm93OwogICAgICAgIC8vIGZuLmJpbmQgd2lsbCBiZSBhdmFpbGFibGUgaW4gYWxsIHRoZSBicm93c2VycyB0aGF0IHN1cHBvcnQgdGhlIGFkdmFuY2VkIHdpbmRvdy5wZXJmb3JtYW5jZS4uLiA7LSkKICAgICAgICByZXR1cm4gZm4gPyBmbi5iaW5kKHBlcmYpIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gK25ldyBEYXRlKCk7CiAgICAgICAgfTsKICAgIH0oKTsKICAgIGZ1bmN0aW9uIGluc3RydW1lbnQobmFtZSwgcDEsIHAyLCBwMykgewogICAgICAgIHZhciBwYXlsb2FkID0gdm9pZCAwOwogICAgICAgIHZhciBjYWxsYmFjayA9IHZvaWQgMDsKICAgICAgICB2YXIgYmluZGluZyA9IHZvaWQgMDsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8PSAzICYmIHR5cGVvZiBwMSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBwYXlsb2FkID0ge307CiAgICAgICAgICAgIGNhbGxiYWNrID0gcDE7CiAgICAgICAgICAgIGJpbmRpbmcgPSBwMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXlsb2FkID0gcDEgfHwge307CiAgICAgICAgICAgIGNhbGxiYWNrID0gcDI7CiAgICAgICAgICAgIGJpbmRpbmcgPSBwMzsKICAgICAgICB9CiAgICAgICAgaWYgKHN1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbChiaW5kaW5nKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsaXplciA9IF9pbnN0cnVtZW50U3RhcnQobmFtZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gcGF5bG9hZDsKICAgICAgICB9KTsKICAgICAgICBpZiAoZmluYWxpemVyKSB7CiAgICAgICAgICAgIHJldHVybiB3aXRoRmluYWxpemVyKGNhbGxiYWNrLCBmaW5hbGl6ZXIsIHBheWxvYWQsIGJpbmRpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKGJpbmRpbmcpOwogICAgICAgIH0KICAgIH0KICAgIHZhciBmbGFnZ2VkSW5zdHJ1bWVudCA9IHZvaWQgMDsKICAgIGlmIChmYWxzZSkgewogICAgICAgIGV4cG9ydHMuZmxhZ2dlZEluc3RydW1lbnQgPSBmbGFnZ2VkSW5zdHJ1bWVudCA9IGluc3RydW1lbnQ7CiAgICB9IGVsc2UgewogICAgICAgIGV4cG9ydHMuZmxhZ2dlZEluc3RydW1lbnQgPSBmbGFnZ2VkSW5zdHJ1bWVudCA9IGZ1bmN0aW9uIChfbmFtZSwgX3BheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpOwogICAgICAgIH07CiAgICB9CiAgICBleHBvcnRzLmZsYWdnZWRJbnN0cnVtZW50ID0gZmxhZ2dlZEluc3RydW1lbnQ7CgogICAgZnVuY3Rpb24gd2l0aEZpbmFsaXplcihjYWxsYmFjaywgZmluYWxpemVyLCBwYXlsb2FkLCBiaW5kaW5nKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjay5jYWxsKGJpbmRpbmcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGF5bG9hZC5leGNlcHRpb24gPSBlOwogICAgICAgICAgICByZXN1bHQgPSBwYXlsb2FkOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGZpbmFsaXplcigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gTk9PUCgpIHt9CiAgICBmdW5jdGlvbiBfaW5zdHJ1bWVudFN0YXJ0KG5hbWUsIF9wYXlsb2FkLCBfcGF5bG9hZFBhcmFtKSB7CiAgICAgICAgaWYgKHN1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gTk9PUDsKICAgICAgICB9CiAgICAgICAgdmFyIGxpc3RlbmVycyA9IGNhY2hlW25hbWVdOwogICAgICAgIGlmICghbGlzdGVuZXJzKSB7CiAgICAgICAgICAgIGxpc3RlbmVycyA9IHBvcHVsYXRlTGlzdGVuZXJzKG5hbWUpOwogICAgICAgIH0KICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gTk9PUDsKICAgICAgICB9CiAgICAgICAgdmFyIHBheWxvYWQgPSBfcGF5bG9hZChfcGF5bG9hZFBhcmFtKTsKICAgICAgICB2YXIgU1RSVUNUVVJFRF9QUk9GSUxFID0gX2VtYmVyRW52aXJvbm1lbnQuRU5WLlNUUlVDVFVSRURfUFJPRklMRTsKICAgICAgICB2YXIgdGltZU5hbWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKFNUUlVDVFVSRURfUFJPRklMRSkgewogICAgICAgICAgICB0aW1lTmFtZSA9IG5hbWUgKyAnOiAnICsgcGF5bG9hZC5vYmplY3Q7CiAgICAgICAgICAgIGNvbnNvbGUudGltZSh0aW1lTmFtZSk7CiAgICAgICAgfQogICAgICAgIHZhciBiZWZvcmVWYWx1ZXMgPSBuZXcgQXJyYXkobGlzdGVuZXJzLmxlbmd0aCk7CiAgICAgICAgdmFyIGkgPSB2b2lkIDA7CiAgICAgICAgdmFyIGxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgIHZhciB0aW1lc3RhbXAgPSB0aW1lKCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RlbmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyc1tpXTsKICAgICAgICAgICAgYmVmb3JlVmFsdWVzW2ldID0gbGlzdGVuZXIuYmVmb3JlKG5hbWUsIHRpbWVzdGFtcCwgcGF5bG9hZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbiBfaW5zdHJ1bWVudEVuZCgpIHsKICAgICAgICAgICAgdmFyIGkgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHRpbWVzdGFtcCA9IHRpbWUoKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3RlbmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGxpc3RlbmVyLmFmdGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIuYWZ0ZXIobmFtZSwgdGltZXN0YW1wLCBwYXlsb2FkLCBiZWZvcmVWYWx1ZXNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChTVFJVQ1RVUkVEX1BST0ZJTEUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUudGltZUVuZCh0aW1lTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQogICAgLyoqCiAgICAgIFN1YnNjcmliZXMgdG8gYSBwYXJ0aWN1bGFyIGV2ZW50IG9yIGluc3RydW1lbnRlZCBibG9jayBvZiBjb2RlLgogICAgCiAgICAgIEBtZXRob2Qgc3Vic2NyaWJlCiAgICAgIEBmb3IgQGVtYmVyL2luc3RydW1lbnRhdGlvbgogICAgICBAc3RhdGljCiAgICAKICAgICAgQHBhcmFtIHtTdHJpbmd9IFtwYXR0ZXJuXSBOYW1lc3BhY2VkIGV2ZW50IG5hbWUuCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBCZWZvcmUgYW5kIEFmdGVyIGhvb2tzLgogICAgCiAgICAgIEByZXR1cm4ge1N1YnNjcmliZXJ9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gc3Vic2NyaWJlKHBhdHRlcm4sIG9iamVjdCkgewogICAgICAgIHZhciBwYXRocyA9IHBhdHRlcm4uc3BsaXQoJy4nKTsKICAgICAgICB2YXIgcGF0aCA9IHZvaWQgMDsKICAgICAgICB2YXIgcmVnZXhlcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcGF0aCA9IHBhdGhzW2ldOwogICAgICAgICAgICBpZiAocGF0aCA9PT0gJyonKSB7CiAgICAgICAgICAgICAgICByZWdleGVzLnB1c2goJ1teXFwuXSonKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlZ2V4ZXMucHVzaChwYXRoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVnZXggPSByZWdleGVzLmpvaW4oJ1xcLicpOwogICAgICAgIHJlZ2V4ID0gcmVnZXggKyAnKFxcLi4qKT8nOwogICAgICAgIHZhciBzdWJzY3JpYmVyID0gewogICAgICAgICAgICBwYXR0ZXJuOiBwYXR0ZXJuLAogICAgICAgICAgICByZWdleDogbmV3IFJlZ0V4cCgnXicgKyByZWdleCArICckJyksCiAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgfTsKICAgICAgICBzdWJzY3JpYmVycy5wdXNoKHN1YnNjcmliZXIpOwogICAgICAgIGNhY2hlID0ge307CiAgICAgICAgcmV0dXJuIHN1YnNjcmliZXI7CiAgICB9CiAgICAvKioKICAgICAgVW5zdWJzY3JpYmVzIGZyb20gYSBwYXJ0aWN1bGFyIGV2ZW50IG9yIGluc3RydW1lbnRlZCBibG9jayBvZiBjb2RlLgogICAgCiAgICAgIEBtZXRob2QgdW5zdWJzY3JpYmUKICAgICAgQGZvciBAZW1iZXIvaW5zdHJ1bWVudGF0aW9uCiAgICAgIEBzdGF0aWMKICAgIAogICAgICBAcGFyYW0ge09iamVjdH0gW3N1YnNjcmliZXJdCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gdW5zdWJzY3JpYmUoc3Vic2NyaWJlcikgewogICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzY3JpYmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoc3Vic2NyaWJlcnNbaV0gPT09IHN1YnNjcmliZXIpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdWJzY3JpYmVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIGNhY2hlID0ge307CiAgICB9CiAgICAvKioKICAgICAgUmVzZXRzIGBJbnN0cnVtZW50YXRpb25gIGJ5IGZsdXNoaW5nIGxpc3Qgb2Ygc3Vic2NyaWJlcnMuCiAgICAKICAgICAgQG1ldGhvZCByZXNldAogICAgICBAZm9yIEBlbWJlci9pbnN0cnVtZW50YXRpb24KICAgICAgQHN0YXRpYwogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIHN1YnNjcmliZXJzLmxlbmd0aCA9IDA7CiAgICAgICAgY2FjaGUgPSB7fTsKICAgIH0KICAgIC8vIyBzb3VyY2VNYXBwaW5nVVJMPWluZGV4LmpzLm1hcAp9KTsKZW5pZmVkKCdAZW1iZXIvbWFwL2luZGV4JywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci11dGlscycsICdAZW1iZXIvbWFwL2xpYi9vcmRlcmVkLXNldCcsICdAZW1iZXIvbWFwL2xpYi91dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9kZWJ1ZywgX2VtYmVyVXRpbHMsIF9vcmRlcmVkU2V0LCBfdXRpbHMpIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBNYXAgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBNYXAoKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTWFwKTsKICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdVc2Ugb2YgQGVtYmVyL01hcCBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIG5hdGl2ZSBgTWFwYCBpbnN0ZWFkJywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLW1hcC1kZXByZWNhdGlvbicsCiAgICAgICAgdW50aWw6ICczLjUuMCcKICAgICAgfSkpOwoKCiAgICAgIHRoaXMuX2tleXMgPSBuZXcgX29yZGVyZWRTZXQuZGVmYXVsdCgpOwogICAgICB0aGlzLl92YWx1ZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLnNpemUgPSAwOwogICAgfQoKICAgIC8qKgogICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICBAc3RhdGljCiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBNYXAuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKCkgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKCk7CiAgICB9OwoKICAgIE1hcC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICBpZiAodGhpcy5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdmFsdWVzID0gdGhpcy5fdmFsdWVzOwogICAgICB2YXIgZ3VpZCA9ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKShrZXkpOwoKICAgICAgcmV0dXJuIHZhbHVlc1tndWlkXTsKICAgIH07CgogICAgTWFwLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiBzZXQoa2V5LCB2YWx1ZSkgewogICAgICB2YXIga2V5cyA9IHRoaXMuX2tleXM7CiAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7CiAgICAgIHZhciBndWlkID0gKDAsIF9lbWJlclV0aWxzLmd1aWRGb3IpKGtleSk7CgogICAgICAvLyBlbnN1cmUgd2UgZG9uJ3Qgc3RvcmUgLTAKICAgICAgdmFyIGsgPSBrZXkgPT09IC0wID8gMCA6IGtleTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb21wYXJlLW5lZy16ZXJvCgogICAgICBrZXlzLmFkZChrLCBndWlkKTsKCiAgICAgIHZhbHVlc1tndWlkXSA9IHZhbHVlOwoKICAgICAgdGhpcy5zaXplID0ga2V5cy5zaXplOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIE1hcC5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24gX2RlbGV0ZShrZXkpIHsKICAgICAgaWYgKHRoaXMuc2l6ZSA9PT0gMCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBkb24ndCB1c2UgRVM2ICJkZWxldGUiIGJlY2F1c2UgaXQgd2lsbCBiZSBhbm5veWluZwogICAgICAvLyB0byB1c2UgaW4gYnJvd3NlcnMgdGhhdCBhcmUgbm90IEVTNiBmcmllbmRseTsKICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwogICAgICB2YXIgdmFsdWVzID0gdGhpcy5fdmFsdWVzOwogICAgICB2YXIgZ3VpZCA9ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKShrZXkpOwoKICAgICAgaWYgKGtleXMuZGVsZXRlKGtleSwgZ3VpZCkpIHsKICAgICAgICBkZWxldGUgdmFsdWVzW2d1aWRdOwogICAgICAgIHRoaXMuc2l6ZSA9IGtleXMuc2l6ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH07CgogICAgTWFwLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLl9rZXlzLmhhcyhrZXkpOwogICAgfTsKCiAgICBNYXAucHJvdG90eXBlLmZvckVhY2ggPSBmdW5jdGlvbiBmb3JFYWNoKGNhbGxiYWNrIC8qLCAuLi50aGlzQXJnKi8pIHsKICAgICAgKHRydWUgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KShPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY2FsbGJhY2spICsgJyBpcyBub3QgYSBmdW5jdGlvbicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICAgIGlmICh0aGlzLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBtYXAgPSB0aGlzOwogICAgICB2YXIgY2IgPSB2b2lkIDAsCiAgICAgICAgICB0aGlzQXJnID0gdm9pZCAwOwoKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgICB0aGlzQXJnID0gYXJndW1lbnRzWzFdOwogICAgICAgIGNiID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwodGhpc0FyZywgbWFwLmdldChrZXkpLCBrZXksIG1hcCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYiA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhtYXAuZ2V0KGtleSksIGtleSwgbWFwKTsKICAgICAgICB9OwogICAgICB9CgogICAgICB0aGlzLl9rZXlzLmZvckVhY2goY2IpOwogICAgfTsKCiAgICBNYXAucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHRoaXMuX2tleXMuY2xlYXIoKTsKICAgICAgdGhpcy5fdmFsdWVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5zaXplID0gMDsKICAgIH07CgogICAgTWFwLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24gY29weSgpIHsKICAgICAgcmV0dXJuICgwLCBfdXRpbHMuY29weU1hcCkodGhpcywgbmV3IE1hcCgpKTsKICAgIH07CgogICAgcmV0dXJuIE1hcDsKICB9KCk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IE1hcDsKfSk7CmVuaWZlZCgnQGVtYmVyL21hcC9saWIvb3JkZXJlZC1zZXQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLXV0aWxzJywgJ0BlbWJlci9tYXAvbGliL3V0aWxzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX2RlYnVnLCBfZW1iZXJVdGlscywgX3V0aWxzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLl9fT3JkZXJlZFNldF9fID0gdW5kZWZpbmVkOwoKICB2YXIgX19PcmRlcmVkU2V0X18gPSBleHBvcnRzLl9fT3JkZXJlZFNldF9fID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gX19PcmRlcmVkU2V0X18oKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgX19PcmRlcmVkU2V0X18pOwoKICAgICAgdGhpcy5jbGVhcigpOwogICAgfQogICAgLyoqCiAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBzdGF0aWMKICAgICAgQHJldHVybiB7RW1iZXIuT3JkZXJlZFNldH0KICAgICAgQHByaXZhdGUKICAgICovCgoKICAgIF9fT3JkZXJlZFNldF9fLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgdmFyIENvbnN0cnVjdG9yID0gdGhpczsKICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3RvcigpOwogICAgfTsKCiAgICAvKioKICAgICAgQG1ldGhvZCBjbGVhcgogICAgICBAcHJpdmF0ZQogICAgKi8KCgogICAgX19PcmRlcmVkU2V0X18ucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHRoaXMucHJlc2VuY2VTZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLmxpc3QgPSBbXTsKICAgICAgdGhpcy5zaXplID0gMDsKICAgIH07CgogICAgLyoqCiAgICAgIEBtZXRob2QgYWRkCiAgICAgIEBwYXJhbSBvYmoKICAgICAgQHBhcmFtIGd1aWQgKG9wdGlvbmFsLCBhbmQgZm9yIGludGVybmFsIHVzZSkKICAgICAgQHJldHVybiB7RW1iZXIuT3JkZXJlZFNldH0KICAgICAgQHByaXZhdGUKICAgICovCgoKICAgIF9fT3JkZXJlZFNldF9fLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQob2JqLCBfZ3VpZCkgewogICAgICB2YXIgZ3VpZCA9IF9ndWlkIHx8ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKShvYmopOwogICAgICB2YXIgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0OwogICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgICAgIGlmIChwcmVzZW5jZVNldFtndWlkXSAhPT0gdHJ1ZSkgewogICAgICAgIHByZXNlbmNlU2V0W2d1aWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLnNpemUgPSBsaXN0LnB1c2gob2JqKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIC8qKgogICAgICBAc2luY2UgMS44LjAKICAgICAgQG1ldGhvZCBkZWxldGUKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0gX2d1aWQgKG9wdGlvbmFsIGFuZCBmb3IgaW50ZXJuYWwgdXNlIG9ubHkpCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBfX09yZGVyZWRTZXRfXy5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24gX2RlbGV0ZShvYmosIF9ndWlkKSB7CiAgICAgIHZhciBndWlkID0gX2d1aWQgfHwgKDAsIF9lbWJlclV0aWxzLmd1aWRGb3IpKG9iaik7CiAgICAgIHZhciBwcmVzZW5jZVNldCA9IHRoaXMucHJlc2VuY2VTZXQ7CiAgICAgIHZhciBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgaWYgKHByZXNlbmNlU2V0W2d1aWRdID09PSB0cnVlKSB7CiAgICAgICAgZGVsZXRlIHByZXNlbmNlU2V0W2d1aWRdOwogICAgICAgIHZhciBpbmRleCA9IGxpc3QuaW5kZXhPZihvYmopOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBsaXN0LnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2l6ZSA9IGxpc3QubGVuZ3RoOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAgQG1ldGhvZCBpc0VtcHR5CiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBfX09yZGVyZWRTZXRfXy5wcm90b3R5cGUuaXNFbXB0eSA9IGZ1bmN0aW9uIGlzRW1wdHkoKSB7CiAgICAgIHJldHVybiB0aGlzLnNpemUgPT09IDA7CiAgICB9OwoKICAgIC8qKgogICAgICBAbWV0aG9kIGhhcwogICAgICBAcGFyYW0gb2JqCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBfX09yZGVyZWRTZXRfXy5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKG9iaikgewogICAgICBpZiAodGhpcy5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgZ3VpZCA9ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKShvYmopOwogICAgICB2YXIgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0OwoKICAgICAgcmV0dXJuIHByZXNlbmNlU2V0W2d1aWRdID09PSB0cnVlOwogICAgfTsKCiAgICAvKioKICAgICAgQG1ldGhvZCBmb3JFYWNoCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgIEBwYXJhbSBzZWxmCiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBfX09yZGVyZWRTZXRfXy5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uIGZvckVhY2goZm4gLyosIC4uLnRoaXNBcmcqLykgewogICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChmbikgKyAnIGlzIG5vdCBhIGZ1bmN0aW9uJywgdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSk7CgoKICAgICAgaWYgKHRoaXMuc2l6ZSA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGxpc3QgPSB0aGlzLmxpc3Q7CgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgZm4uY2FsbChhcmd1bWVudHNbMV0sIGxpc3RbaV0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgbGlzdC5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgIGZuKGxpc3RbX2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgIEBtZXRob2QgdG9BcnJheQogICAgICBAcmV0dXJuIHtBcnJheX0KICAgICAgQHByaXZhdGUKICAgICovCgoKICAgIF9fT3JkZXJlZFNldF9fLnByb3RvdHlwZS50b0FycmF5ID0gZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIHRoaXMubGlzdC5zbGljZSgpOwogICAgfTsKCiAgICAvKioKICAgICAgQG1ldGhvZCBjb3B5CiAgICAgIEByZXR1cm4ge0VtYmVyLk9yZGVyZWRTZXR9CiAgICAgIEBwcml2YXRlCiAgICAqLwoKCiAgICBfX09yZGVyZWRTZXRfXy5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkoKSB7CiAgICAgIHZhciBDb25zdHJ1Y3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgIHZhciBzZXQgPSBuZXcgQ29uc3RydWN0b3IoKTsKCiAgICAgIHNldC5wcmVzZW5jZVNldCA9ICgwLCBfdXRpbHMuY29weU51bGwpKHRoaXMucHJlc2VuY2VTZXQpOwogICAgICBzZXQubGlzdCA9IHRoaXMudG9BcnJheSgpOwogICAgICBzZXQuc2l6ZSA9IHRoaXMuc2l6ZTsKCiAgICAgIHJldHVybiBzZXQ7CiAgICB9OwoKICAgIHJldHVybiBfX09yZGVyZWRTZXRfXzsKICB9KCk7CgogIHZhciBPcmRlcmVkU2V0ID0gZnVuY3Rpb24gKF9PcmRlcmVkU2V0X18pIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoT3JkZXJlZFNldCwgX09yZGVyZWRTZXRfXyk7CgogICAgZnVuY3Rpb24gT3JkZXJlZFNldCgpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBPcmRlcmVkU2V0KTsKCiAgICAgIHZhciBfdGhpcyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfT3JkZXJlZFNldF9fLmNhbGwodGhpcykpOwoKICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdVc2Ugb2YgQGVtYmVyL09yZGVyZWRTZXQgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBuYXRpdmUgYE1hcGAgaW5zdGVhZCcsIGZhbHNlLCB7CiAgICAgICAgaWQ6ICdlbWJlci1tYXAtZGVwcmVjYXRpb24nLAogICAgICAgIHVudGlsOiAnMy41LjAnCiAgICAgIH0pKTsKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIHJldHVybiBPcmRlcmVkU2V0OwogIH0oX19PcmRlcmVkU2V0X18pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBPcmRlcmVkU2V0Owp9KTsKZW5pZmVkKCJAZW1iZXIvbWFwL2xpYi91dGlscyIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5jb3B5TnVsbCA9IGNvcHlOdWxsOwogIGV4cG9ydHMuY29weU1hcCA9IGNvcHlNYXA7CiAgZnVuY3Rpb24gY29weU51bGwob2JqKSB7CiAgICB2YXIgb3V0cHV0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAvLyBoYXNPd25Qcm9wZXJ5IGlzIG5vdCBuZWVkZWQgYmVjYXVzZSBvYmogaXMgT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgb3V0cHV0W3Byb3BdID0gb2JqW3Byb3BdOwogICAgfQoKICAgIHJldHVybiBvdXRwdXQ7CiAgfQoKICBmdW5jdGlvbiBjb3B5TWFwKG9yaWdpbmFsLCBuZXdPYmplY3QpIHsKICAgIHZhciBrZXlzID0gb3JpZ2luYWwuX2tleXMuY29weSgpOwogICAgdmFyIHZhbHVlcyA9IGNvcHlOdWxsKG9yaWdpbmFsLl92YWx1ZXMpOwoKICAgIG5ld09iamVjdC5fa2V5cyA9IGtleXM7CiAgICBuZXdPYmplY3QuX3ZhbHVlcyA9IHZhbHVlczsKICAgIG5ld09iamVjdC5zaXplID0gb3JpZ2luYWwuc2l6ZTsKCiAgICByZXR1cm4gbmV3T2JqZWN0OwogIH0KfSk7CmVuaWZlZCgnQGVtYmVyL21hcC93aXRoLWRlZmF1bHQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnQGVtYmVyL2RlYnVnJywgJ0BlbWJlci9tYXAvaW5kZXgnLCAnQGVtYmVyL21hcC9saWIvdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsLCBfZGVidWcsIF9pbmRleCwgX3V0aWxzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgTWFwV2l0aERlZmF1bHQgPSBmdW5jdGlvbiAoX01hcCkgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShNYXBXaXRoRGVmYXVsdCwgX01hcCk7CgogICAgZnVuY3Rpb24gTWFwV2l0aERlZmF1bHQob3B0aW9ucykgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1hcFdpdGhEZWZhdWx0KTsKICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdVc2Ugb2YgQGVtYmVyL01hcFdpdGhEZWZhdWx0IGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgbmF0aXZlIGBNYXBgIGluc3RlYWQnLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItbWFwLWRlcHJlY2F0aW9uJywKICAgICAgICB1bnRpbDogJzMuNS4wJwogICAgICB9KSk7CgogICAgICB2YXIgX3RoaXMgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX01hcC5jYWxsKHRoaXMpKTsKCiAgICAgIF90aGlzLmRlZmF1bHRWYWx1ZSA9IG9wdGlvbnMuZGVmYXVsdFZhbHVlOwogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgLyoqCiAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBzdGF0aWMKICAgICAgQHBhcmFtIFtvcHRpb25zXQogICAgICAgIEBwYXJhbSB7Kn0gW29wdGlvbnMuZGVmYXVsdFZhbHVlXQogICAgICBAcmV0dXJuIHtNYXBXaXRoRGVmYXVsdHxNYXB9IElmIG9wdGlvbnMgYXJlIHBhc3NlZCwgcmV0dXJucwogICAgICAgIGBNYXBXaXRoRGVmYXVsdGAgb3RoZXJ3aXNlIHJldHVybnMgYEVtYmVyTWFwYAogICAgICBAcHJpdmF0ZQogICAgKi8KCgogICAgTWFwV2l0aERlZmF1bHQuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbmV3IE1hcFdpdGhEZWZhdWx0KG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgX2luZGV4LmRlZmF1bHQoKTsKICAgICAgfQogICAgfTsKCiAgICBNYXBXaXRoRGVmYXVsdC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICB2YXIgaGFzVmFsdWUgPSB0aGlzLmhhcyhrZXkpOwoKICAgICAgaWYgKGhhc1ZhbHVlKSB7CiAgICAgICAgcmV0dXJuIF9NYXAucHJvdG90eXBlLmdldC5jYWxsKHRoaXMsIGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHRoaXMuZGVmYXVsdFZhbHVlKGtleSk7CiAgICAgICAgdGhpcy5zZXQoa2V5LCBkZWZhdWx0VmFsdWUpOwogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH07CgogICAgTWFwV2l0aERlZmF1bHQucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5KCkgewogICAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICByZXR1cm4gKDAsIF91dGlscy5jb3B5TWFwKSh0aGlzLCBuZXcgQ29uc3RydWN0b3IoewogICAgICAgIGRlZmF1bHRWYWx1ZTogdGhpcy5kZWZhdWx0VmFsdWUKICAgICAgfSkpOwogICAgfTsKCiAgICByZXR1cm4gTWFwV2l0aERlZmF1bHQ7CiAgfShfaW5kZXguZGVmYXVsdCk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IE1hcFdpdGhEZWZhdWx0Owp9KTsKZW5pZmVkKCdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJywgWydleHBvcnRzJywgJ0BlbWJlci9vYmplY3QvbGliL2NvbXB1dGVkL2NvbXB1dGVkX21hY3JvcycsICdAZW1iZXIvb2JqZWN0L2xpYi9jb21wdXRlZC9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfY29tcHV0ZWRfbWFjcm9zLCBfcmVkdWNlX2NvbXB1dGVkX21hY3JvcykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdlbXB0eScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuZW1wdHk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdub3RFbXB0eScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3Mubm90RW1wdHk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdub25lJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5ub25lOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnbm90JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5ub3Q7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdib29sJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5ib29sOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnbWF0Y2gnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLm1hdGNoOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZXF1YWwnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmVxdWFsOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZ3QnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmd0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZ3RlJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbXB1dGVkX21hY3Jvcy5ndGU7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdsdCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MubHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdsdGUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLmx0ZTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ29uZVdheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3Mub25lV2F5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAncmVhZE9ubHknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLnJlYWRPbmx5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZGVwcmVjYXRpbmdBbGlhcycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuZGVwcmVjYXRpbmdBbGlhczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2FuZCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb21wdXRlZF9tYWNyb3MuYW5kOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcHV0ZWRfbWFjcm9zLm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnc3VtJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3Muc3VtOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnbWluJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWluOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnbWF4JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWF4OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnbWFwJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWFwOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnc29ydCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLnNvcnQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdzZXREaWZmJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3Muc2V0RGlmZjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ21hcEJ5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MubWFwQnk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdmaWx0ZXInLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy5maWx0ZXI7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdmaWx0ZXJCeScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLmZpbHRlckJ5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAndW5pcScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLnVuaXE7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICd1bmlxQnknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcmVkdWNlX2NvbXB1dGVkX21hY3Jvcy51bmlxQnk7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICd1bmlvbicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLnVuaW9uOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnaW50ZXJzZWN0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JlZHVjZV9jb21wdXRlZF9tYWNyb3MuaW50ZXJzZWN0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnY29sbGVjdCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zLmNvbGxlY3Q7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ0BlbWJlci9vYmplY3QvbGliL2NvbXB1dGVkL2NvbXB1dGVkX21hY3JvcycsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZGVidWcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfZGVidWcpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMub3IgPSBleHBvcnRzLmFuZCA9IHVuZGVmaW5lZDsKICBleHBvcnRzLmVtcHR5ID0gZW1wdHk7CiAgZXhwb3J0cy5ub3RFbXB0eSA9IG5vdEVtcHR5OwogIGV4cG9ydHMubm9uZSA9IG5vbmU7CiAgZXhwb3J0cy5ub3QgPSBub3Q7CiAgZXhwb3J0cy5ib29sID0gYm9vbDsKICBleHBvcnRzLm1hdGNoID0gbWF0Y2g7CiAgZXhwb3J0cy5lcXVhbCA9IGVxdWFsOwogIGV4cG9ydHMuZ3QgPSBndDsKICBleHBvcnRzLmd0ZSA9IGd0ZTsKICBleHBvcnRzLmx0ID0gbHQ7CiAgZXhwb3J0cy5sdGUgPSBsdGU7CiAgZXhwb3J0cy5vbmVXYXkgPSBvbmVXYXk7CiAgZXhwb3J0cy5yZWFkT25seSA9IHJlYWRPbmx5OwogIGV4cG9ydHMuZGVwcmVjYXRpbmdBbGlhcyA9IGRlcHJlY2F0aW5nQWxpYXM7CgoKICAvKioKICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAqLwoKICBmdW5jdGlvbiBleHBhbmRQcm9wZXJ0aWVzVG9BcnJheShwcmVkaWNhdGVOYW1lLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgZXhwYW5kZWRQcm9wZXJ0aWVzID0gW107CgogICAgZnVuY3Rpb24gZXh0cmFjdFByb3BlcnR5KGVudHJ5KSB7CiAgICAgIGV4cGFuZGVkUHJvcGVydGllcy5wdXNoKGVudHJ5KTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHByb3BlcnR5ID0gcHJvcGVydGllc1tpXTsKICAgICAgKHRydWUgJiYgIShwcm9wZXJ0eS5pbmRleE9mKCcgJykgPCAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0RlcGVuZGVudCBrZXlzIHBhc3NlZCB0byBjb21wdXRlZC4nICsgcHJlZGljYXRlTmFtZSArICcoKSBjYW5cJ3QgaGF2ZSBzcGFjZXMuJywgcHJvcGVydHkuaW5kZXhPZignICcpIDwgMCkpOwoKCiAgICAgICgwLCBfZW1iZXJNZXRhbC5leHBhbmRQcm9wZXJ0aWVzKShwcm9wZXJ0eSwgZXh0cmFjdFByb3BlcnR5KTsKICAgIH0KCiAgICByZXR1cm4gZXhwYW5kZWRQcm9wZXJ0aWVzOwogIH0KCiAgZnVuY3Rpb24gZ2VuZXJhdGVDb21wdXRlZFdpdGhQcmVkaWNhdGUobmFtZSwgcHJlZGljYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgcHJvcGVydGllcyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIHByb3BlcnRpZXNbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHZhciBkZXBlbmRlbnRLZXlzID0gZXhwYW5kUHJvcGVydGllc1RvQXJyYXkobmFtZSwgcHJvcGVydGllcyk7CgogICAgICB2YXIgY29tcHV0ZWRGdW5jID0gbmV3IF9lbWJlck1ldGFsLkNvbXB1dGVkUHJvcGVydHkoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBsYXN0SWR4ID0gZGVwZW5kZW50S2V5cy5sZW5ndGggLSAxOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxhc3RJZHg7IGkrKykgewogICAgICAgICAgdmFyIHZhbHVlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5c1tpXSk7CiAgICAgICAgICBpZiAoIXByZWRpY2F0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleXNbbGFzdElkeF0pOwogICAgICB9LCB7IGRlcGVuZGVudEtleXM6IGRlcGVuZGVudEtleXMgfSk7CgogICAgICByZXR1cm4gY29tcHV0ZWRGdW5jOwogICAgfTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdHJ1ZSBpZiB0aGUgdmFsdWUgb2YgdGhlIGRlcGVuZGVudAogICAgcHJvcGVydHkgaXMgbnVsbCwgYW4gZW1wdHkgc3RyaW5nLCBlbXB0eSBhcnJheSwgb3IgZW1wdHkgZnVuY3Rpb24uCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBlbXB0eSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFRvRG9MaXN0ID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaXNEb25lOiBlbXB0eSgndG9kb3MnKQogICAgfSk7CiAgCiAgICBsZXQgdG9kb0xpc3QgPSBUb0RvTGlzdC5jcmVhdGUoewogICAgICB0b2RvczogWydVbml0IFRlc3QnLCAnRG9jdW1lbnRhdGlvbicsICdSZWxlYXNlJ10KICAgIH0pOwogIAogICAgdG9kb0xpc3QuZ2V0KCdpc0RvbmUnKTsgLy8gZmFsc2UKICAgIHRvZG9MaXN0LmdldCgndG9kb3MnKS5jbGVhcigpOwogICAgdG9kb0xpc3QuZ2V0KCdpc0RvbmUnKTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAc2luY2UgMS42LjAKICAgIEBtZXRob2QgZW1wdHkKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmCiAgICB0aGUgdmFsdWUgb2YgdGhlIGRlcGVuZGVudCBwcm9wZXJ0eSBpcyBudWxsLCBhbiBlbXB0eSBzdHJpbmcsIGVtcHR5IGFycmF5LAogICAgb3IgZW1wdHkgZnVuY3Rpb24gYW5kIGZhbHNlIGlmIHRoZSB1bmRlcmx5aW5nIHZhbHVlIGlzIG5vdCBlbXB0eS4KICAKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGVtcHR5KGRlcGVuZGVudEtleSkgewogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5ICsgJy5sZW5ndGgnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuaXNFbXB0eSkoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KSk7CiAgICB9KTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdHJ1ZSBpZiB0aGUgdmFsdWUgb2YgdGhlIGRlcGVuZGVudAogICAgcHJvcGVydHkgaXMgTk9UIG51bGwsIGFuIGVtcHR5IHN0cmluZywgZW1wdHkgYXJyYXksIG9yIGVtcHR5IGZ1bmN0aW9uLgogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbm90RW1wdHkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzU3R1ZmY6IG5vdEVtcHR5KCdiYWNrcGFjaycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoeyBiYWNrcGFjazogWydGb29kJywgJ1NsZWVwaW5nIEJhZycsICdUZW50J10gfSk7CiAgCiAgICBoYW1zdGVyLmdldCgnaGFzU3R1ZmYnKTsgICAgICAgICAvLyB0cnVlCiAgICBoYW1zdGVyLmdldCgnYmFja3BhY2snKS5jbGVhcigpOyAvLyBbXQogICAgaGFtc3Rlci5nZXQoJ2hhc1N0dWZmJyk7ICAgICAgICAgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBub3RFbXB0eQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIHRydWUgaWYKICAgIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eSBpcyBub3QgZW1wdHkuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBub3RFbXB0eShkZXBlbmRlbnRLZXkpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSArICcubGVuZ3RoJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gISgwLCBfZW1iZXJNZXRhbC5pc0VtcHR5KSgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpKTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgcmV0dXJucyB0cnVlIGlmIHRoZSB2YWx1ZSBvZiB0aGUgZGVwZW5kZW50CiAgICBwcm9wZXJ0eSBpcyBudWxsIG9yIHVuZGVmaW5lZC4gVGhpcyBhdm9pZHMgZXJyb3JzIGZyb20gSlNMaW50IGNvbXBsYWluaW5nCiAgICBhYm91dCB1c2Ugb2YgPT0sIHdoaWNoIGNhbiBiZSB0ZWNobmljYWxseSBjb25mdXNpbmcuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBub25lIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGlzSHVuZ3J5OiBub25lKCdmb29kJykKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgaGFtc3Rlci5nZXQoJ2lzSHVuZ3J5Jyk7IC8vIHRydWUKICAgIGhhbXN0ZXIuc2V0KCdmb29kJywgJ0JhbmFuYScpOwogICAgaGFtc3Rlci5nZXQoJ2lzSHVuZ3J5Jyk7IC8vIGZhbHNlCiAgICBoYW1zdGVyLnNldCgnZm9vZCcsIG51bGwpOwogICAgaGFtc3Rlci5nZXQoJ2lzSHVuZ3J5Jyk7IC8vIHRydWUKICAgIGBgYAogIAogICAgQG1ldGhvZCBub25lCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoCiAgICByZXR1cm5zIHRydWUgaWYgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIG51bGwgb3IgdW5kZWZpbmVkLgogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gbm9uZShkZXBlbmRlbnRLZXkpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmlzTm9uZSkoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KSk7CiAgICB9KTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdGhlIGludmVyc2UgYm9vbGVhbiB2YWx1ZQogICAgb2YgdGhlIG9yaWdpbmFsIHZhbHVlIGZvciB0aGUgZGVwZW5kZW50IHByb3BlcnR5LgogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbm90IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgVXNlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGlzQW5vbnltb3VzOiBub3QoJ2xvZ2dlZEluJykKICAgIH0pOwogIAogICAgbGV0IHVzZXIgPSBVc2VyLmNyZWF0ZSh7bG9nZ2VkSW46IGZhbHNlfSk7CiAgCiAgICB1c2VyLmdldCgnaXNBbm9ueW1vdXMnKTsgLy8gdHJ1ZQogICAgdXNlci5zZXQoJ2xvZ2dlZEluJywgdHJ1ZSk7CiAgICB1c2VyLmdldCgnaXNBbm9ueW1vdXMnKTsgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBub3QKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucwogICAgaW52ZXJzZSBvZiB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBub3QoZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCBjb252ZXJ0cyB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnR5CiAgICBpbnRvIGEgYm9vbGVhbiB2YWx1ZS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGJvb2wgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzQmFuYW5hczogYm9vbCgnbnVtQmFuYW5hcycpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuZ2V0KCdoYXNCYW5hbmFzJyk7IC8vIGZhbHNlCiAgICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDApOwogICAgaGFtc3Rlci5nZXQoJ2hhc0JhbmFuYXMnKTsgLy8gZmFsc2UKICAgIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMSk7CiAgICBoYW1zdGVyLmdldCgnaGFzQmFuYW5hcycpOyAvLyB0cnVlCiAgICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIG51bGwpOwogICAgaGFtc3Rlci5nZXQoJ2hhc0JhbmFuYXMnKTsgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBib29sCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNvbnZlcnRzCiAgICB0byBib29sZWFuIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGJvb2woZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIG1hdGNoZXMgdGhlIG9yaWdpbmFsIHZhbHVlIGZvciB0aGUKICAgIGRlcGVuZGVudCBwcm9wZXJ0eSBhZ2FpbnN0IGEgZ2l2ZW4gUmVnRXhwLCByZXR1cm5pbmcgYHRydWVgCiAgICBpZiB0aGUgdmFsdWUgbWF0Y2hlcyB0aGUgUmVnRXhwIGFuZCBgZmFsc2VgIGlmIGl0IGRvZXMgbm90LgogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbWF0Y2ggfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBVc2VyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzVmFsaWRFbWFpbDogbWF0Y2goJ2VtYWlsJywgL14uK0AuK1wuLiskLykKICAgIH0pOwogIAogICAgbGV0IHVzZXIgPSBVc2VyLmNyZWF0ZSh7bG9nZ2VkSW46IGZhbHNlfSk7CiAgCiAgICB1c2VyLmdldCgnaGFzVmFsaWRFbWFpbCcpOyAvLyBmYWxzZQogICAgdXNlci5zZXQoJ2VtYWlsJywgJycpOwogICAgdXNlci5nZXQoJ2hhc1ZhbGlkRW1haWwnKTsgLy8gZmFsc2UKICAgIHVzZXIuc2V0KCdlbWFpbCcsICdlbWJlcl9oYW1zdGVyQGV4YW1wbGUuY29tJyk7CiAgICB1c2VyLmdldCgnaGFzVmFsaWRFbWFpbCcpOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2QgbWF0Y2gKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtSZWdFeHB9IHJlZ2V4cAogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggbWF0Y2gKICAgIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkgYWdhaW5zdCBhIGdpdmVuIFJlZ0V4cAogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gbWF0Y2goZGVwZW5kZW50S2V5LCByZWdleHApIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICB2YXIgdmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpOwogICAgICByZXR1cm4gcmVnZXhwLnRlc3QodmFsdWUpOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eQogICAgaXMgZXF1YWwgdG8gdGhlIGdpdmVuIHZhbHVlLgogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZXF1YWwgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgc2F0aXNmaWVkOiBlcXVhbCgncGVyY2VudENhcnJvdHNFYXRlbicsIDEwMCkKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgaGFtc3Rlci5nZXQoJ3NhdGlzZmllZCcpOyAvLyBmYWxzZQogICAgaGFtc3Rlci5zZXQoJ3BlcmNlbnRDYXJyb3RzRWF0ZW4nLCAxMDApOwogICAgaGFtc3Rlci5nZXQoJ3NhdGlzZmllZCcpOyAvLyB0cnVlCiAgICBoYW1zdGVyLnNldCgncGVyY2VudENhcnJvdHNFYXRlbicsIDUwKTsKICAgIGhhbXN0ZXIuZ2V0KCdzYXRpc2ZpZWQnKTsgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBlcXVhbAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ8T2JqZWN0fSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmCiAgICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGVxdWFsIHRvIHRoZSBnaXZlbiB2YWx1ZS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGVxdWFsKGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KSA9PT0gdmFsdWU7CiAgICB9KTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdHJ1ZSBpZiB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnR5CiAgICBpcyBncmVhdGVyIHRoYW4gdGhlIHByb3ZpZGVkIHZhbHVlLgogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgZ3QgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgaGFzVG9vTWFueUJhbmFuYXM6IGd0KCdudW1CYW5hbmFzJywgMTApCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogICAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAzKTsKICAgIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogICAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAxMSk7CiAgICBoYW1zdGVyLmdldCgnaGFzVG9vTWFueUJhbmFuYXMnKTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGd0CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmCiAgICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGdyZWF0ZXIgdGhhbiBnaXZlbiB2YWx1ZS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGd0KGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KSA+IHZhbHVlOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eQogICAgaXMgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGd0ZSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBoYXNUb29NYW55QmFuYW5hczogZ3RlKCdudW1CYW5hbmFzJywgMTApCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogICAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAzKTsKICAgIGhhbXN0ZXIuZ2V0KCdoYXNUb29NYW55QmFuYW5hcycpOyAvLyBmYWxzZQogICAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAxMCk7CiAgICBoYW1zdGVyLmdldCgnaGFzVG9vTWFueUJhbmFuYXMnKTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGd0ZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcGFyYW0ge051bWJlcn0gdmFsdWUKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIHJldHVybnMgdHJ1ZSBpZgogICAgdGhlIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eSBpcyBncmVhdGVyIG9yIGVxdWFsIHRoZW4gZ2l2ZW4gdmFsdWUuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBndGUoZGVwZW5kZW50S2V5LCB2YWx1ZSkgewogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpID49IHZhbHVlOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eQogICAgaXMgbGVzcyB0aGFuIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGx0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIG5lZWRzTW9yZUJhbmFuYXM6IGx0KCdudW1CYW5hbmFzJywgMykKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgaGFtc3Rlci5nZXQoJ25lZWRzTW9yZUJhbmFuYXMnKTsgLy8gdHJ1ZQogICAgaGFtc3Rlci5zZXQoJ251bUJhbmFuYXMnLCAzKTsKICAgIGhhbXN0ZXIuZ2V0KCduZWVkc01vcmVCYW5hbmFzJyk7IC8vIGZhbHNlCiAgICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDIpOwogICAgaGFtc3Rlci5nZXQoJ25lZWRzTW9yZUJhbmFuYXMnKTsgLy8gdHJ1ZQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGx0CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmCiAgICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGxlc3MgdGhlbiBnaXZlbiB2YWx1ZS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGx0KGRlcGVuZGVudEtleSwgdmFsdWUpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KSA8IHZhbHVlOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRydWUgaWYgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0eQogICAgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGx0ZSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBuZWVkc01vcmVCYW5hbmFzOiBsdGUoJ251bUJhbmFuYXMnLCAzKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKCk7CiAgCiAgICBoYW1zdGVyLmdldCgnbmVlZHNNb3JlQmFuYW5hcycpOyAvLyB0cnVlCiAgICBoYW1zdGVyLnNldCgnbnVtQmFuYW5hcycsIDUpOwogICAgaGFtc3Rlci5nZXQoJ25lZWRzTW9yZUJhbmFuYXMnKTsgLy8gZmFsc2UKICAgIGhhbXN0ZXIuc2V0KCdudW1CYW5hbmFzJywgMyk7CiAgICBoYW1zdGVyLmdldCgnbmVlZHNNb3JlQmFuYW5hcycpOyAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2QgbHRlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7TnVtYmVyfSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyB0cnVlIGlmCiAgICB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5IGlzIGxlc3Mgb3IgZXF1YWwgdGhhbiBnaXZlbiB2YWx1ZS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGx0ZShkZXBlbmRlbnRLZXksIHZhbHVlKSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKShkZXBlbmRlbnRLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsIGRlcGVuZGVudEtleSkgPD0gdmFsdWU7CiAgICB9KTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHBlcmZvcm1zIGEgbG9naWNhbCBgYW5kYCBvbiB0aGUKICAgIG9yaWdpbmFsIHZhbHVlcyBmb3IgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0aWVzLgogIAogICAgWW91IG1heSBwYXNzIGluIG1vcmUgdGhhbiB0d28gcHJvcGVydGllcyBhbmQgZXZlbiB1c2UKICAgIHByb3BlcnR5IGJyYWNlIGV4cGFuc2lvbi4gIFRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsCiAgICByZXR1cm4gdGhlIGZpcnN0IGZhbHN5IHZhbHVlIG9yIGxhc3QgdHJ1dGh5IHZhbHVlCiAgICBqdXN0IGxpa2UgSmF2YVNjcmlwdCdzIGAmJmAgb3BlcmF0b3IuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBhbmQgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVhZHlGb3JDYW1wOiBhbmQoJ2hhc1RlbnQnLCAnaGFzQmFja3BhY2snKSwKICAgICAgcmVhZHlGb3JIaWtlOiBhbmQoJ2hhc1dhbGtpbmdTdGljaycsICdoYXNCYWNrcGFjaycpCiAgICB9KTsKICAKICAgIGxldCB0b21zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIHRvbXN0ZXIuZ2V0KCdyZWFkeUZvckNhbXAnKTsgLy8gZmFsc2UKICAgIHRvbXN0ZXIuc2V0KCdoYXNUZW50JywgdHJ1ZSk7CiAgICB0b21zdGVyLmdldCgncmVhZHlGb3JDYW1wJyk7IC8vIGZhbHNlCiAgICB0b21zdGVyLnNldCgnaGFzQmFja3BhY2snLCB0cnVlKTsKICAgIHRvbXN0ZXIuZ2V0KCdyZWFkeUZvckNhbXAnKTsgLy8gdHJ1ZQogICAgdG9tc3Rlci5zZXQoJ2hhc0JhY2twYWNrJywgJ1llcycpOwogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9yQ2FtcCcpOyAvLyAnWWVzJwogICAgdG9tc3Rlci5zZXQoJ2hhc1dhbGtpbmdTdGljaycsIG51bGwpOwogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9ySGlrZScpOyAvLyBudWxsCiAgICBgYGAKICAKICAgIEBtZXRob2QgYW5kCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkqCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBwZXJmb3JtcwogICAgYSBsb2dpY2FsIGBhbmRgIG9uIHRoZSB2YWx1ZXMgb2YgYWxsIHRoZSBvcmlnaW5hbCB2YWx1ZXMgZm9yIHByb3BlcnRpZXMuCiAgICBAcHVibGljCiAgKi8KICB2YXIgYW5kID0gZXhwb3J0cy5hbmQgPSBnZW5lcmF0ZUNvbXB1dGVkV2l0aFByZWRpY2F0ZSgnYW5kJywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfSk7CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBwZXJmb3JtcyBhIGxvZ2ljYWwgYG9yYCBvbiB0aGUKICAgIG9yaWdpbmFsIHZhbHVlcyBmb3IgdGhlIHByb3ZpZGVkIGRlcGVuZGVudCBwcm9wZXJ0aWVzLgogIAogICAgWW91IG1heSBwYXNzIGluIG1vcmUgdGhhbiB0d28gcHJvcGVydGllcyBhbmQgZXZlbiB1c2UKICAgIHByb3BlcnR5IGJyYWNlIGV4cGFuc2lvbi4gIFRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsCiAgICByZXR1cm4gdGhlIGZpcnN0IHRydXRoeSB2YWx1ZSBvciBsYXN0IGZhbHN5IHZhbHVlIGp1c3QKICAgIGxpa2UgSmF2YVNjcmlwdCdzIGB8fGAgb3BlcmF0b3IuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBvciB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IEhhbXN0ZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICByZWFkeUZvclJhaW46IG9yKCdoYXNKYWNrZXQnLCAnaGFzVW1icmVsbGEnKSwKICAgICAgcmVhZHlGb3JCZWFjaDogb3IoJ3toYXNTdW5zY3JlZW4saGFzVW1icmVsbGF9JykKICAgIH0pOwogIAogICAgbGV0IHRvbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9yUmFpbicpOyAvLyB1bmRlZmluZWQKICAgIHRvbXN0ZXIuc2V0KCdoYXNVbWJyZWxsYScsIHRydWUpOwogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9yUmFpbicpOyAvLyB0cnVlCiAgICB0b21zdGVyLnNldCgnaGFzSmFja2V0JywgJ1llcycpOwogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9yUmFpbicpOyAvLyAnWWVzJwogICAgdG9tc3Rlci5zZXQoJ2hhc1N1bnNjcmVlbicsICdDaGVjaycpOwogICAgdG9tc3Rlci5nZXQoJ3JlYWR5Rm9yQmVhY2gnKTsgLy8gJ0NoZWNrJwogICAgYGBgCiAgCiAgICBAbWV0aG9kIG9yCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkqCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBwZXJmb3JtcwogICAgYSBsb2dpY2FsIGBvcmAgb24gdGhlIHZhbHVlcyBvZiBhbGwgdGhlIG9yaWdpbmFsIHZhbHVlcyBmb3IgcHJvcGVydGllcy4KICAgIEBwdWJsaWMKICAqLwogIHZhciBvciA9IGV4cG9ydHMub3IgPSBnZW5lcmF0ZUNvbXB1dGVkV2l0aFByZWRpY2F0ZSgnb3InLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgIHJldHVybiAhdmFsdWU7CiAgfSk7CgogIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBwcm9wZXJ0eSB0aGF0IGlzIGFuIGFsaWFzIGZvciBhbm90aGVyIHByb3BlcnR5CiAgICBvbiBhbiBvYmplY3QuIENhbGxzIHRvIGBnZXRgIG9yIGBzZXRgIHRoaXMgcHJvcGVydHkgYmVoYXZlIGFzCiAgICB0aG91Z2ggdGhleSB3ZXJlIGNhbGxlZCBvbiB0aGUgb3JpZ2luYWwgcHJvcGVydHkuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBhbGlhcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIG5hbWU6ICdBbGV4IE1hdGNobmVlcicsCiAgICAgIG5vbWVuOiBhbGlhcygnbmFtZScpCiAgICB9KTsKICAKICAgIGxldCBhbGV4ID0gUGVyc29uLmNyZWF0ZSgpOwogIAogICAgYWxleC5nZXQoJ25vbWVuJyk7IC8vICdBbGV4IE1hdGNobmVlcicKICAgIGFsZXguZ2V0KCduYW1lJyk7ICAvLyAnQWxleCBNYXRjaG5lZXInCiAgCiAgICBhbGV4LnNldCgnbm9tZW4nLCAnQG1hY2h0eScpOwogICAgYWxleC5nZXQoJ25hbWUnKTsgIC8vICdAbWFjaHR5JwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGFsaWFzCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNyZWF0ZXMgYW4KICAgIGFsaWFzIHRvIHRoZSBvcmlnaW5hbCB2YWx1ZSBmb3IgcHJvcGVydHkuCiAgICBAcHVibGljCiAgKi8KCiAgLyoqCiAgICBXaGVyZSBgY29tcHV0ZWQuYWxpYXNgIGFsaWFzZXMgYGdldGAgYW5kIGBzZXRgLCBhbmQgYWxsb3dzIGZvciBiaWRpcmVjdGlvbmFsCiAgICBkYXRhIGZsb3csIGBjb21wdXRlZC5vbmVXYXlgIG9ubHkgcHJvdmlkZXMgYW4gYWxpYXNlZCBgZ2V0YC4gVGhlIGBzZXRgIHdpbGwKICAgIG5vdCBtdXRhdGUgdGhlIHVwc3RyZWFtIHByb3BlcnR5LCByYXRoZXIgY2F1c2VzIHRoZSBjdXJyZW50IHByb3BlcnR5IHRvCiAgICBiZWNvbWUgdGhlIHZhbHVlIHNldC4gVGhpcyBjYXVzZXMgdGhlIGRvd25zdHJlYW0gcHJvcGVydHkgdG8gcGVybWFuZW50bHkKICAgIGRpdmVyZ2UgZnJvbSB0aGUgdXBzdHJlYW0gcHJvcGVydHkuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBvbmVXYXkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBVc2VyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBudWxsLAogICAgICBsYXN0TmFtZTogbnVsbCwKICAgICAgbmlja05hbWU6IG9uZVdheSgnZmlyc3ROYW1lJykKICAgIH0pOwogIAogICAgbGV0IHRlZGR5ID0gVXNlci5jcmVhdGUoewogICAgICBmaXJzdE5hbWU6ICdUZWRkeScsCiAgICAgIGxhc3ROYW1lOiAnWmVlbm55JwogICAgfSk7CiAgCiAgICB0ZWRkeS5nZXQoJ25pY2tOYW1lJyk7ICAgICAgICAgICAgICAvLyAnVGVkZHknCiAgICB0ZWRkeS5zZXQoJ25pY2tOYW1lJywgJ1RlZGR5QmVhcicpOyAvLyAnVGVkZHlCZWFyJwogICAgdGVkZHkuZ2V0KCdmaXJzdE5hbWUnKTsgICAgICAgICAgICAgLy8gJ1RlZGR5JwogICAgYGBgCiAgCiAgICBAbWV0aG9kIG9uZVdheQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjcmVhdGVzIGEKICAgIG9uZSB3YXkgY29tcHV0ZWQgcHJvcGVydHkgdG8gdGhlIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIG9uZVdheShkZXBlbmRlbnRLZXkpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuYWxpYXMpKGRlcGVuZGVudEtleSkub25lV2F5KCk7CiAgfQoKICAvKioKICAgIFRoaXMgaXMgYSBtb3JlIHNlbWFudGljYWxseSBtZWFuaW5nZnVsIGFsaWFzIG9mIGBjb21wdXRlZC5vbmVXYXlgLAogICAgd2hvc2UgbmFtZSBpcyBzb21ld2hhdCBhbWJpZ3VvdXMgYXMgdG8gd2hpY2ggZGlyZWN0aW9uIHRoZSBkYXRhIGZsb3dzLgogIAogICAgQG1ldGhvZCByZWFkcwogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjcmVhdGVzIGEKICAgICAgb25lIHdheSBjb21wdXRlZCBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgogICAgQHB1YmxpYwogICAqLwoKICAvKioKICAgIFdoZXJlIGBjb21wdXRlZC5vbmVXYXlgIHByb3ZpZGVzIG9uZVdheSBiaW5kaW5ncywgYGNvbXB1dGVkLnJlYWRPbmx5YCBwcm92aWRlcwogICAgYSByZWFkT25seSBvbmUgd2F5IGJpbmRpbmcuIFZlcnkgb2Z0ZW4gd2hlbiB1c2luZyBgY29tcHV0ZWQub25lV2F5YCBvbmUgZG9lcwogICAgbm90IGFsc28gd2FudCBjaGFuZ2VzIHRvIHByb3BhZ2F0ZSBiYWNrIHVwLCBhcyB0aGV5IHdpbGwgcmVwbGFjZSB0aGUgdmFsdWUuCiAgCiAgICBUaGlzIHByZXZlbnRzIHRoZSByZXZlcnNlIGZsb3csIGFuZCBhbHNvIHRocm93cyBhbiBleGNlcHRpb24gd2hlbiBpdCBvY2N1cnMuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyByZWFkT25seSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFVzZXIgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6IG51bGwsCiAgICAgIGxhc3ROYW1lOiBudWxsLAogICAgICBuaWNrTmFtZTogcmVhZE9ubHkoJ2ZpcnN0TmFtZScpCiAgICB9KTsKICAKICAgIGxldCB0ZWRkeSA9IFVzZXIuY3JlYXRlKHsKICAgICAgZmlyc3ROYW1lOiAnVGVkZHknLAogICAgICBsYXN0TmFtZTogICdaZWVubnknCiAgICB9KTsKICAKICAgIHRlZGR5LmdldCgnbmlja05hbWUnKTsgICAgICAgICAgICAgIC8vICdUZWRkeScKICAgIHRlZGR5LnNldCgnbmlja05hbWUnLCAnVGVkZHlCZWFyJyk7IC8vIHRocm93cyBFeGNlcHRpb24KICAgIC8vIHRocm93IG5ldyBFbWJlckVycm9yKCdDYW5ub3QgU2V0OiBuaWNrTmFtZSBvbjogPFVzZXI6ZW1iZXIyNzI4OD4nICk7YAogICAgdGVkZHkuZ2V0KCdmaXJzdE5hbWUnKTsgICAgICAgICAgICAgLy8gJ1RlZGR5JwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHJlYWRPbmx5CiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVkIHByb3BlcnR5IHdoaWNoIGNyZWF0ZXMgYQogICAgb25lIHdheSBjb21wdXRlZCBwcm9wZXJ0eSB0byB0aGUgb3JpZ2luYWwgdmFsdWUgZm9yIHByb3BlcnR5LgogICAgQHNpbmNlIDEuNS4wCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiByZWFkT25seShkZXBlbmRlbnRLZXkpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuYWxpYXMpKGRlcGVuZGVudEtleSkucmVhZE9ubHkoKTsKICB9CgogIC8qKgogICAgQ3JlYXRlcyBhIG5ldyBwcm9wZXJ0eSB0aGF0IGlzIGFuIGFsaWFzIGZvciBhbm90aGVyIHByb3BlcnR5CiAgICBvbiBhbiBvYmplY3QuIENhbGxzIHRvIGBnZXRgIG9yIGBzZXRgIHRoaXMgcHJvcGVydHkgYmVoYXZlIGFzCiAgICB0aG91Z2ggdGhleSB3ZXJlIGNhbGxlZCBvbiB0aGUgb3JpZ2luYWwgcHJvcGVydHksIGJ1dCBhbHNvCiAgICBwcmludCBhIGRlcHJlY2F0aW9uIHdhcm5pbmcuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBkZXByZWNhdGluZ0FsaWFzIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGJhbmFuYUNvdW50OiBkZXByZWNhdGluZ0FsaWFzKCdjYXZlbmRpc2hDb3VudCcsIHsKICAgICAgICBpZDogJ2hhbXN0ZXIuZGVwcmVjYXRlLWJhbmFuYScsCiAgICAgICAgdW50aWw6ICczLjAuMCcKICAgICAgfSkKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSgpOwogIAogICAgaGFtc3Rlci5zZXQoJ2JhbmFuYUNvdW50JywgNSk7IC8vIFByaW50cyBhIGRlcHJlY2F0aW9uIHdhcm5pbmcuCiAgICBoYW1zdGVyLmdldCgnY2F2ZW5kaXNoQ291bnQnKTsgLy8gNQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGRlcHJlY2F0aW5nQWxpYXMKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgT3B0aW9ucyBmb3IgYGRlcHJlY2F0ZWAuCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCBjcmVhdGVzIGFuCiAgICBhbGlhcyB3aXRoIGEgZGVwcmVjYXRpb24gdG8gdGhlIG9yaWdpbmFsIHZhbHVlIGZvciBwcm9wZXJ0eS4KICAgIEBzaW5jZSAxLjcuMAogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gZGVwcmVjYXRpbmdBbGlhcyhkZXBlbmRlbnRLZXksIG9wdGlvbnMpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGRlcGVuZGVudEtleSwgewogICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1VzYWdlIG9mIGAnICsga2V5ICsgJ2AgaXMgZGVwcmVjYXRlZCwgdXNlIGAnICsgZGVwZW5kZW50S2V5ICsgJ2AgaW5zdGVhZC4nLCBmYWxzZSwgb3B0aW9ucykpOwoKICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgZGVwZW5kZW50S2V5KTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnVXNhZ2Ugb2YgYCcgKyBrZXkgKyAnYCBpcyBkZXByZWNhdGVkLCB1c2UgYCcgKyBkZXBlbmRlbnRLZXkgKyAnYCBpbnN0ZWFkLicsIGZhbHNlLCBvcHRpb25zKSk7CgogICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMsIGRlcGVuZGVudEtleSwgdmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfQp9KTsKZW5pZmVkKCdAZW1iZXIvb2JqZWN0L2xpYi9jb21wdXRlZC9yZWR1Y2VfY29tcHV0ZWRfbWFjcm9zJywgWydleHBvcnRzJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1tZXRhbCcsICdlbWJlci1ydW50aW1lJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZGVidWcsIF9lbWJlck1ldGFsLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLnVuaW9uID0gdW5kZWZpbmVkOwogIGV4cG9ydHMuc3VtID0gc3VtOwogIGV4cG9ydHMubWF4ID0gbWF4OwogIGV4cG9ydHMubWluID0gbWluOwogIGV4cG9ydHMubWFwID0gbWFwOwogIGV4cG9ydHMubWFwQnkgPSBtYXBCeTsKICBleHBvcnRzLmZpbHRlciA9IGZpbHRlcjsKICBleHBvcnRzLmZpbHRlckJ5ID0gZmlsdGVyQnk7CiAgZXhwb3J0cy51bmlxID0gdW5pcTsKICBleHBvcnRzLnVuaXFCeSA9IHVuaXFCeTsKICBleHBvcnRzLmludGVyc2VjdCA9IGludGVyc2VjdDsKICBleHBvcnRzLnNldERpZmYgPSBzZXREaWZmOwogIGV4cG9ydHMuY29sbGVjdCA9IGNvbGxlY3Q7CiAgZXhwb3J0cy5zb3J0ID0gc29ydDsKCgogIGZ1bmN0aW9uIHJlZHVjZU1hY3JvKGRlcGVuZGVudEtleSwgY2FsbGJhY2ssIGluaXRpYWxWYWx1ZSwgbmFtZSkgewogICAgKHRydWUgJiYgISghL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRGVwZW5kZW50IGtleSBwYXNzZWQgdG8gYGNvbXB1dGVkLicgKyBuYW1lICsgJ2Agc2hvdWxkblwndCBjb250YWluIGJyYWNlIGV4cGFuZGluZyBwYXR0ZXJuLicsICEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KSkpOwoKCiAgICB2YXIgY3AgPSBuZXcgX2VtYmVyTWV0YWwuQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBhcnIgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpOwogICAgICBpZiAoYXJyID09PSBudWxsIHx8IHR5cGVvZiBhcnIgIT09ICdvYmplY3QnKSB7CiAgICAgICAgcmV0dXJuIGluaXRpYWxWYWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gYXJyLnJlZHVjZShjYWxsYmFjaywgaW5pdGlhbFZhbHVlLCB0aGlzKTsKICAgIH0sIHsgZGVwZW5kZW50S2V5czogW2RlcGVuZGVudEtleSArICcuW10nXSwgcmVhZE9ubHk6IHRydWUgfSk7CgogICAgcmV0dXJuIGNwOwogIH0gLyoqCiAgICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAgICovCgoKICBmdW5jdGlvbiBhcnJheU1hY3JvKGRlcGVuZGVudEtleSwgY2FsbGJhY2spIHsKICAgIC8vIFRoaXMgaXMgYSBiaXQgdWdseQogICAgdmFyIHByb3BlcnR5TmFtZSA9IHZvaWQgMDsKICAgIGlmICgvQGVhY2gvLnRlc3QoZGVwZW5kZW50S2V5KSkgewogICAgICBwcm9wZXJ0eU5hbWUgPSBkZXBlbmRlbnRLZXkucmVwbGFjZSgvXC5AZWFjaC4qJC8sICcnKTsKICAgIH0gZWxzZSB7CiAgICAgIHByb3BlcnR5TmFtZSA9IGRlcGVuZGVudEtleTsKICAgICAgZGVwZW5kZW50S2V5ICs9ICcuW10nOwogICAgfQoKICAgIHZhciBjcCA9IG5ldyBfZW1iZXJNZXRhbC5Db21wdXRlZFByb3BlcnR5KGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZhbHVlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgcHJvcGVydHlOYW1lKTsKICAgICAgaWYgKCgwLCBfZW1iZXJSdW50aW1lLmlzQXJyYXkpKHZhbHVlKSkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKShjYWxsYmFjay5jYWxsKHRoaXMsIHZhbHVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICAgIH0KICAgIH0sIHsgcmVhZE9ubHk6IHRydWUgfSk7CgogICAgY3AucHJvcGVydHkoZGVwZW5kZW50S2V5KTsgLy8gdGhpcyBmb3JjZXMgdG8gZXhwYW5kIHByb3BlcnRpZXMgR0ggIzE1ODU1CgogICAgcmV0dXJuIGNwOwogIH0KCiAgZnVuY3Rpb24gbXVsdGlBcnJheU1hY3JvKF9kZXBlbmRlbnRLZXlzLCBjYWxsYmFjaywgbmFtZSkgewogICAgKHRydWUgJiYgIShfZGVwZW5kZW50S2V5cy5ldmVyeShmdW5jdGlvbiAoZGVwZW5kZW50S2V5KSB7CiAgICAgIHJldHVybiAhL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSk7CiAgICB9KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdEZXBlbmRlbnQga2V5cyBwYXNzZWQgdG8gYGNvbXB1dGVkLicgKyBuYW1lICsgJ2Agc2hvdWxkblwndCBjb250YWluIGJyYWNlIGV4cGFuZGluZyBwYXR0ZXJuLicsIF9kZXBlbmRlbnRLZXlzLmV2ZXJ5KGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgICAgcmV0dXJuICEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KTsKICAgIH0pKSk7CgogICAgdmFyIGRlcGVuZGVudEtleXMgPSBfZGVwZW5kZW50S2V5cy5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4ga2V5ICsgJy5bXSc7CiAgICB9KTsKCiAgICB2YXIgY3AgPSBuZXcgX2VtYmVyTWV0YWwuQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKShjYWxsYmFjay5jYWxsKHRoaXMsIF9kZXBlbmRlbnRLZXlzKSk7CiAgICB9LCB7IGRlcGVuZGVudEtleXM6IGRlcGVuZGVudEtleXMsIHJlYWRPbmx5OiB0cnVlIH0pOwoKICAgIHJldHVybiBjcDsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0aGF0IHJldHVybnMgdGhlIHN1bSBvZiB0aGUgdmFsdWVzCiAgICBpbiB0aGUgZGVwZW5kZW50IGFycmF5LgogIAogICAgQG1ldGhvZCBzdW0KICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgdGhlIHN1bSBvZiBhbGwgdmFsdWVzIGluIHRoZSBkZXBlbmRlbnRLZXkncyBhcnJheQogICAgQHNpbmNlIDEuNC4wCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBzdW0oZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gcmVkdWNlTWFjcm8oZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAoc3VtLCBpdGVtKSB7CiAgICAgIHJldHVybiBzdW0gKyBpdGVtOwogICAgfSwgMCwgJ3N1bScpOwogIH0KCiAgLyoqCiAgICBBIGNvbXB1dGVkIHByb3BlcnR5IHRoYXQgY2FsY3VsYXRlcyB0aGUgbWF4aW11bSB2YWx1ZSBpbiB0aGUKICAgIGRlcGVuZGVudCBhcnJheS4gVGhpcyB3aWxsIHJldHVybiBgLUluZmluaXR5YCB3aGVuIHRoZSBkZXBlbmRlbnQKICAgIGFycmF5IGlzIGVtcHR5LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbWFwQnksIG1heCB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGNoaWxkQWdlczogbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpLAogICAgICBtYXhDaGlsZEFnZTogbWF4KCdjaGlsZEFnZXMnKQogICAgfSk7CiAgCiAgICBsZXQgbG9yZEJ5cm9uID0gUGVyc29uLmNyZWF0ZSh7IGNoaWxkcmVuOiBbXSB9KTsKICAKICAgIGxvcmRCeXJvbi5nZXQoJ21heENoaWxkQWdlJyk7IC8vIC1JbmZpbml0eQogICAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0KHsKICAgICAgbmFtZTogJ0F1Z3VzdGEgQWRhIEJ5cm9uJywgYWdlOiA3CiAgICB9KTsKICAgIGxvcmRCeXJvbi5nZXQoJ21heENoaWxkQWdlJyk7IC8vIDcKICAgIGxvcmRCeXJvbi5nZXQoJ2NoaWxkcmVuJykucHVzaE9iamVjdHMoW3sKICAgICAgbmFtZTogJ0FsbGVncmEgQnlyb24nLAogICAgICBhZ2U6IDUKICAgIH0sIHsKICAgICAgbmFtZTogJ0VsaXphYmV0aCBNZWRvcmEgTGVpZ2gnLAogICAgICBhZ2U6IDgKICAgIH1dKTsKICAgIGxvcmRCeXJvbi5nZXQoJ21heENoaWxkQWdlJyk7IC8vIDgKICAgIGBgYAogIAogICAgSWYgdGhlIHR5cGVzIG9mIHRoZSBhcmd1bWVudHMgYXJlIG5vdCBudW1iZXJzLAogICAgdGhleSB3aWxsIGJlIGNvbnZlcnRlZCB0byBudW1iZXJzIGFuZCB0aGUgdHlwZQogICAgb2YgdGhlIHJldHVybiB2YWx1ZSB3aWxsIGFsd2F5cyBiZSBgTnVtYmVyYC4KICAgIEZvciBleGFtcGxlLCB0aGUgbWF4IG9mIGEgbGlzdCBvZiBEYXRlIG9iamVjdHMgd2lsbCBiZQogICAgdGhlIGhpZ2hlc3QgdGltZXN0YW1wIGFzIGEgYE51bWJlcmAuCiAgICBUaGlzIGJlaGF2aW9yIGlzIGNvbnNpc3RlbnQgd2l0aCBgTWF0aC5tYXhgLgogIAogICAgQG1ldGhvZCBtYXgKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgdGhlIGxhcmdlc3QgdmFsdWUgaW4gdGhlIGRlcGVuZGVudEtleSdzIGFycmF5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBtYXgoZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gcmVkdWNlTWFjcm8oZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAobWF4LCBpdGVtKSB7CiAgICAgIHJldHVybiBNYXRoLm1heChtYXgsIGl0ZW0pOwogICAgfSwgLUluZmluaXR5LCAnbWF4Jyk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCBjYWxjdWxhdGVzIHRoZSBtaW5pbXVtIHZhbHVlIGluIHRoZQogICAgZGVwZW5kZW50IGFycmF5LiBUaGlzIHdpbGwgcmV0dXJuIGBJbmZpbml0eWAgd2hlbiB0aGUgZGVwZW5kZW50CiAgICBhcnJheSBpcyBlbXB0eS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IG1hcEJ5LCBtaW4gfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBjaGlsZEFnZXM6IG1hcEJ5KCdjaGlsZHJlbicsICdhZ2UnKSwKICAgICAgbWluQ2hpbGRBZ2U6IG1pbignY2hpbGRBZ2VzJykKICAgIH0pOwogIAogICAgbGV0IGxvcmRCeXJvbiA9IFBlcnNvbi5jcmVhdGUoeyBjaGlsZHJlbjogW10gfSk7CiAgCiAgICBsb3JkQnlyb24uZ2V0KCdtaW5DaGlsZEFnZScpOyAvLyBJbmZpbml0eQogICAgbG9yZEJ5cm9uLmdldCgnY2hpbGRyZW4nKS5wdXNoT2JqZWN0KHsKICAgICAgbmFtZTogJ0F1Z3VzdGEgQWRhIEJ5cm9uJywgYWdlOiA3CiAgICB9KTsKICAgIGxvcmRCeXJvbi5nZXQoJ21pbkNoaWxkQWdlJyk7IC8vIDcKICAgIGxvcmRCeXJvbi5nZXQoJ2NoaWxkcmVuJykucHVzaE9iamVjdHMoW3sKICAgICAgbmFtZTogJ0FsbGVncmEgQnlyb24nLAogICAgICBhZ2U6IDUKICAgIH0sIHsKICAgICAgbmFtZTogJ0VsaXphYmV0aCBNZWRvcmEgTGVpZ2gnLAogICAgICBhZ2U6IDgKICAgIH1dKTsKICAgIGxvcmRCeXJvbi5nZXQoJ21pbkNoaWxkQWdlJyk7IC8vIDUKICAgIGBgYAogIAogICAgSWYgdGhlIHR5cGVzIG9mIHRoZSBhcmd1bWVudHMgYXJlIG5vdCBudW1iZXJzLAogICAgdGhleSB3aWxsIGJlIGNvbnZlcnRlZCB0byBudW1iZXJzIGFuZCB0aGUgdHlwZQogICAgb2YgdGhlIHJldHVybiB2YWx1ZSB3aWxsIGFsd2F5cyBiZSBgTnVtYmVyYC4KICAgIEZvciBleGFtcGxlLCB0aGUgbWluIG9mIGEgbGlzdCBvZiBEYXRlIG9iamVjdHMgd2lsbCBiZQogICAgdGhlIGxvd2VzdCB0aW1lc3RhbXAgYXMgYSBgTnVtYmVyYC4KICAgIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoIGBNYXRoLm1pbmAuCiAgCiAgICBAbWV0aG9kIG1pbgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyB0aGUgc21hbGxlc3QgdmFsdWUgaW4gdGhlIGRlcGVuZGVudEtleSdzIGFycmF5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBtaW4oZGVwZW5kZW50S2V5KSB7CiAgICByZXR1cm4gcmVkdWNlTWFjcm8oZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAobWluLCBpdGVtKSB7CiAgICAgIHJldHVybiBNYXRoLm1pbihtaW4sIGl0ZW0pOwogICAgfSwgSW5maW5pdHksICdtaW4nKTsKICB9CgogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSBtYXBwZWQgdmlhIHRoZSBjYWxsYmFjawogIAogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZS4KICAgIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICBgaW5kZXhgIGlzIHRoZSBpbnRlZ2VyIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uKGl0ZW0sIGluZGV4KTsKICAgIGBgYAogIAogICAgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbWFwIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGV4Y2l0aW5nQ2hvcmVzOiBtYXAoJ2Nob3JlcycsIGZ1bmN0aW9uKGNob3JlLCBpbmRleCkgewogICAgICAgIHJldHVybiBjaG9yZS50b1VwcGVyQ2FzZSgpICsgJyEnOwogICAgICB9KQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHsKICAgICAgY2hvcmVzOiBbJ2NsZWFuJywgJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cyddCiAgICB9KTsKICAKICAgIGhhbXN0ZXIuZ2V0KCdleGNpdGluZ0Nob3JlcycpOyAvLyBbJ0NMRUFOIScsICdXUklURSBNT1JFIFVOSVQgVEVTVFMhJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCBtYXAKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGFuIGFycmF5IG1hcHBlZCB2aWEgdGhlIGNhbGxiYWNrCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBtYXAoZGVwZW5kZW50S2V5LCBjYWxsYmFjaykgewogICAgcmV0dXJuIGFycmF5TWFjcm8oZGVwZW5kZW50S2V5LCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLm1hcChjYWxsYmFjaywgdGhpcyk7CiAgICB9KTsKICB9CgogIC8qKgogICAgUmV0dXJucyBhbiBhcnJheSBtYXBwZWQgdG8gdGhlIHNwZWNpZmllZCBrZXkuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBtYXBCeSB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGNoaWxkQWdlczogbWFwQnkoJ2NoaWxkcmVuJywgJ2FnZScpCiAgICB9KTsKICAKICAgIGxldCBsb3JkQnlyb24gPSBQZXJzb24uY3JlYXRlKHsgY2hpbGRyZW46IFtdIH0pOwogIAogICAgbG9yZEJ5cm9uLmdldCgnY2hpbGRBZ2VzJyk7IC8vIFtdCiAgICBsb3JkQnlyb24uZ2V0KCdjaGlsZHJlbicpLnB1c2hPYmplY3QoeyBuYW1lOiAnQXVndXN0YSBBZGEgQnlyb24nLCBhZ2U6IDcgfSk7CiAgICBsb3JkQnlyb24uZ2V0KCdjaGlsZEFnZXMnKTsgLy8gWzddCiAgICBsb3JkQnlyb24uZ2V0KCdjaGlsZHJlbicpLnB1c2hPYmplY3RzKFt7CiAgICAgIG5hbWU6ICdBbGxlZ3JhIEJ5cm9uJywKICAgICAgYWdlOiA1CiAgICB9LCB7CiAgICAgIG5hbWU6ICdFbGl6YWJldGggTWVkb3JhIExlaWdoJywKICAgICAgYWdlOiA4CiAgICB9XSk7CiAgICBsb3JkQnlyb24uZ2V0KCdjaGlsZEFnZXMnKTsgLy8gWzcsIDUsIDhdCiAgICBgYGAKICAKICAgIEBtZXRob2QgbWFwQnkKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBhbiBhcnJheSBtYXBwZWQgdG8gdGhlIHNwZWNpZmllZCBrZXkKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIG1hcEJ5KGRlcGVuZGVudEtleSwgcHJvcGVydHlLZXkpIHsKICAgICh0cnVlICYmICEodHlwZW9mIHByb3BlcnR5S2V5ID09PSAnc3RyaW5nJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgY29tcHV0ZWQubWFwQnlgIGV4cGVjdHMgYSBwcm9wZXJ0eSBzdHJpbmcgZm9yIGl0cyBzZWNvbmQgYXJndW1lbnQsICcgKyAncGVyaGFwcyB5b3UgbWVhbnQgdG8gdXNlICJtYXAiJywgdHlwZW9mIHByb3BlcnR5S2V5ID09PSAnc3RyaW5nJykpOwogICAgKHRydWUgJiYgISghL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRGVwZW5kZW50IGtleSBwYXNzZWQgdG8gYGNvbXB1dGVkLm1hcEJ5YCBzaG91bGRuXCd0IGNvbnRhaW4gYnJhY2UgZXhwYW5kaW5nIHBhdHRlcm4uJywgIS9bXFtcXVx7XH1dL2cudGVzdChkZXBlbmRlbnRLZXkpKSk7CgoKICAgIHJldHVybiBtYXAoZGVwZW5kZW50S2V5ICsgJy5AZWFjaC4nICsgcHJvcGVydHlLZXksIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpdGVtLCBwcm9wZXJ0eUtleSk7CiAgICB9KTsKICB9CgogIC8qKgogICAgRmlsdGVycyB0aGUgYXJyYXkgYnkgdGhlIGNhbGxiYWNrLgogIAogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZS4KICAgIGBpdGVtYCBpcyB0aGUgY3VycmVudCBpdGVtIGluIHRoZSBpdGVyYXRpb24uCiAgICBgaW5kZXhgIGlzIHRoZSBpbnRlZ2VyIGluZGV4IG9mIHRoZSBjdXJyZW50IGl0ZW0gaW4gdGhlIGl0ZXJhdGlvbi4KICAgIGBhcnJheWAgaXMgdGhlIGRlcGVuZGFudCBhcnJheSBpdHNlbGYuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbihpdGVtLCBpbmRleCwgYXJyYXkpOwogICAgYGBgCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVtYWluaW5nQ2hvcmVzOiBmaWx0ZXIoJ2Nob3JlcycsIGZ1bmN0aW9uKGNob3JlLCBpbmRleCwgYXJyYXkpIHsKICAgICAgICByZXR1cm4gIWNob3JlLmRvbmU7CiAgICAgIH0pCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBjaG9yZXM6IFsKICAgICAgICB7IG5hbWU6ICdjb29rJywgZG9uZTogdHJ1ZSB9LAogICAgICAgIHsgbmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZSB9LAogICAgICAgIHsgbmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlIH0KICAgICAgXQogICAgfSk7CiAgCiAgICBoYW1zdGVyLmdldCgncmVtYWluaW5nQ2hvcmVzJyk7IC8vIFt7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfV0KICAgIGBgYAogIAogICAgWW91IGNhbiBhbHNvIHVzZSBgQGVhY2gucHJvcGVydHlgIGluIHlvdXIgZGVwZW5kZW50IGtleSwgdGhlIGNhbGxiYWNrIHdpbGwgc3RpbGwgdXNlIHRoZSB1bmRlcmx5aW5nIGFycmF5OgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgeyBmaWx0ZXIgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgcmVtYWluaW5nQ2hvcmVzOiBmaWx0ZXIoJ2Nob3Jlcy5AZWFjaC5kb25lJywgZnVuY3Rpb24oY2hvcmUsIGluZGV4LCBhcnJheSkgewogICAgICAgIHJldHVybiAhY2hvcmUuZ2V0KCdkb25lJyk7CiAgICAgIH0pCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBjaG9yZXM6IEEoWwogICAgICAgIEVtYmVyT2JqZWN0LmNyZWF0ZSh7IG5hbWU6ICdjb29rJywgZG9uZTogdHJ1ZSB9KSwKICAgICAgICBFbWJlck9iamVjdC5jcmVhdGUoeyBuYW1lOiAnY2xlYW4nLCBkb25lOiB0cnVlIH0pLAogICAgICAgIEVtYmVyT2JqZWN0LmNyZWF0ZSh7IG5hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZSB9KQogICAgICBdKQogICAgfSk7CiAgICBoYW1zdGVyLmdldCgncmVtYWluaW5nQ2hvcmVzJyk7IC8vIFt7bmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlfV0KICAgIGhhbXN0ZXIuZ2V0KCdjaG9yZXMnKS5vYmplY3RBdCgyKS5zZXQoJ2RvbmUnLCB0cnVlKTsKICAgIGhhbXN0ZXIuZ2V0KCdyZW1haW5pbmdDaG9yZXMnKTsgLy8gW10KICAgIGBgYAogIAogIAogICAgQG1ldGhvZCBmaWx0ZXIKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IHRoZSBmaWx0ZXJlZCBhcnJheQogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gZmlsdGVyKGRlcGVuZGVudEtleSwgY2FsbGJhY2spIHsKICAgIHJldHVybiBhcnJheU1hY3JvKGRlcGVuZGVudEtleSwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5maWx0ZXIoY2FsbGJhY2ssIHRoaXMpOwogICAgfSk7CiAgfQoKICAvKioKICAgIEZpbHRlcnMgdGhlIGFycmF5IGJ5IHRoZSBwcm9wZXJ0eSBhbmQgdmFsdWUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGZpbHRlckJ5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIHJlbWFpbmluZ0Nob3JlczogZmlsdGVyQnkoJ2Nob3JlcycsICdkb25lJywgZmFsc2UpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBjaG9yZXM6IFsKICAgICAgICB7IG5hbWU6ICdjb29rJywgZG9uZTogdHJ1ZSB9LAogICAgICAgIHsgbmFtZTogJ2NsZWFuJywgZG9uZTogdHJ1ZSB9LAogICAgICAgIHsgbmFtZTogJ3dyaXRlIG1vcmUgdW5pdCB0ZXN0cycsIGRvbmU6IGZhbHNlIH0KICAgICAgXQogICAgfSk7CiAgCiAgICBoYW1zdGVyLmdldCgncmVtYWluaW5nQ2hvcmVzJyk7IC8vIFt7IG5hbWU6ICd3cml0ZSBtb3JlIHVuaXQgdGVzdHMnLCBkb25lOiBmYWxzZSB9XQogICAgYGBgCiAgCiAgICBAbWV0aG9kIGZpbHRlckJ5CiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBkZXBlbmRlbnRLZXkKICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wZXJ0eUtleQogICAgQHBhcmFtIHsqfSB2YWx1ZQogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gdGhlIGZpbHRlcmVkIGFycmF5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBmaWx0ZXJCeShkZXBlbmRlbnRLZXksIHByb3BlcnR5S2V5LCB2YWx1ZSkgewogICAgKHRydWUgJiYgISghL1tcW1xdXHtcfV0vZy50ZXN0KGRlcGVuZGVudEtleSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRGVwZW5kZW50IGtleSBwYXNzZWQgdG8gYGNvbXB1dGVkLmZpbHRlckJ5YCBzaG91bGRuXCd0IGNvbnRhaW4gYnJhY2UgZXhwYW5kaW5nIHBhdHRlcm4uJywgIS9bXFtcXVx7XH1dL2cudGVzdChkZXBlbmRlbnRLZXkpKSk7CgoKICAgIHZhciBjYWxsYmFjayA9IHZvaWQgMDsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkoaXRlbSwgcHJvcGVydHlLZXkpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpdGVtLCBwcm9wZXJ0eUtleSkgPT09IHZhbHVlOwogICAgICB9OwogICAgfQoKICAgIHJldHVybiBmaWx0ZXIoZGVwZW5kZW50S2V5ICsgJy5AZWFjaC4nICsgcHJvcGVydHlLZXksIGNhbGxiYWNrKTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZSB1bmlxdWUKICAgIGVsZW1lbnRzIGZyb20gb25lIG9yIG1vcmUgZGVwZW5kZW50IGFycmF5cy4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHVuaXEgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgdW5pcXVlRnJ1aXRzOiB1bmlxKCdmcnVpdHMnKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHsKICAgICAgZnJ1aXRzOiBbCiAgICAgICAgJ2JhbmFuYScsCiAgICAgICAgJ2dyYXBlJywKICAgICAgICAna2FsZScsCiAgICAgICAgJ2JhbmFuYScKICAgICAgXQogICAgfSk7CiAgCiAgICBoYW1zdGVyLmdldCgndW5pcXVlRnJ1aXRzJyk7IC8vIFsnYmFuYW5hJywgJ2dyYXBlJywgJ2thbGUnXQogICAgYGBgCiAgCiAgICBAbWV0aG9kIHVuaXEKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5KgogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlCiAgICB1bmlxdWUgZWxlbWVudHMgZnJvbSB0aGUgZGVwZW5kZW50IGFycmF5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiB1bmlxKCkgewogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KCiAgICByZXR1cm4gbXVsdGlBcnJheU1hY3JvKGFyZ3MsIGZ1bmN0aW9uIChkZXBlbmRlbnRLZXlzKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB2YXIgdW5pcSA9ICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICAgIHZhciBzZWVuID0gbmV3IFNldCgpOwoKICAgICAgZGVwZW5kZW50S2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShfdGhpcywgZGVwZW5kZW50S2V5KTsKICAgICAgICBpZiAoKDAsIF9lbWJlclJ1bnRpbWUuaXNBcnJheSkodmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgIGlmICghc2Vlbi5oYXMoaXRlbSkpIHsKICAgICAgICAgICAgICBzZWVuLmFkZChpdGVtKTsKICAgICAgICAgICAgICB1bmlxLnB1c2goaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gdW5pcTsKICAgIH0sICd1bmlxJyk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgdW5pcXVlCiAgICBlbGVtZW50cyBmcm9tIGFuIGFycmF5LCB3aXRoIHVuaXF1ZW5lc3MgZGV0ZXJtaW5lZCBieSBzcGVjaWZpYyBrZXkuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyB1bmlxQnkgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBIYW1zdGVyID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgdW5pcXVlRnJ1aXRzOiB1bmlxQnkoJ2ZydWl0cycsICdpZCcpCiAgICB9KTsKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoewogICAgICBmcnVpdHM6IFsKICAgICAgICB7IGlkOiAxLCAnYmFuYW5hJyB9LAogICAgICAgIHsgaWQ6IDIsICdncmFwZScgfSwKICAgICAgICB7IGlkOiAzLCAncGVhY2gnIH0sCiAgICAgICAgeyBpZDogMSwgJ2JhbmFuYScgfQogICAgICBdCiAgICB9KTsKICAgIGhhbXN0ZXIuZ2V0KCd1bmlxdWVGcnVpdHMnKTsgLy8gWyB7IGlkOiAxLCAnYmFuYW5hJyB9LCB7IGlkOiAyLCAnZ3JhcGUnIH0sIHsgaWQ6IDMsICdwZWFjaCcgfV0KICAgIGBgYAogIAogICAgQG1ldGhvZCB1bmlxQnkKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGRlcGVuZGVudEtleQogICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5CiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICAgIHVuaXF1ZSBlbGVtZW50cyBmcm9tIHRoZSBkZXBlbmRlbnQgYXJyYXkKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIHVuaXFCeShkZXBlbmRlbnRLZXksIHByb3BlcnR5S2V5KSB7CiAgICAodHJ1ZSAmJiAhKCEvW1xbXF1ce1x9XS9nLnRlc3QoZGVwZW5kZW50S2V5KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdEZXBlbmRlbnQga2V5IHBhc3NlZCB0byBgY29tcHV0ZWQudW5pcUJ5YCBzaG91bGRuXCd0IGNvbnRhaW4gYnJhY2UgZXhwYW5kaW5nIHBhdHRlcm4uJywgIS9bXFtcXVx7XH1dL2cudGVzdChkZXBlbmRlbnRLZXkpKSk7CgoKICAgIHZhciBjcCA9IG5ldyBfZW1iZXJNZXRhbC5Db21wdXRlZFByb3BlcnR5KGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxpc3QgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBkZXBlbmRlbnRLZXkpOwogICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuaXNBcnJheSkobGlzdCkgPyAoMCwgX2VtYmVyUnVudGltZS51bmlxQnkpKGxpc3QsIHByb3BlcnR5S2V5KSA6ICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICB9LCB7IGRlcGVuZGVudEtleXM6IFtkZXBlbmRlbnRLZXkgKyAnLltdJ10sIHJlYWRPbmx5OiB0cnVlIH0pOwoKICAgIHJldHVybiBjcDsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZSB1bmlxdWUKICAgIGVsZW1lbnRzIGZyb20gb25lIG9yIG1vcmUgZGVwZW5kZW50IGFycmF5cy4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHVuaW9uIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIHVuaXF1ZUZydWl0czogdW5pb24oJ2ZydWl0cycsICd2ZWdldGFibGVzJykKICAgIH0pOwogIAogICAgbGV0IGhhbXN0ZXIgPSBIYW1zdGVyLmNyZWF0ZSh7CiAgICAgIGZydWl0czogWwogICAgICAgICdiYW5hbmEnLAogICAgICAgICdncmFwZScsCiAgICAgICAgJ2thbGUnLAogICAgICAgICdiYW5hbmEnLAogICAgICAgICd0b21hdG8nCiAgICAgIF0sCiAgICAgIHZlZ2V0YWJsZXM6IFsKICAgICAgICAndG9tYXRvJywKICAgICAgICAnY2Fycm90JywKICAgICAgICAnbGV0dHVjZScKICAgICAgXQogICAgfSk7CiAgCiAgICBoYW1zdGVyLmdldCgndW5pcXVlRnJ1aXRzJyk7IC8vIFsnYmFuYW5hJywgJ2dyYXBlJywgJ2thbGUnLCAndG9tYXRvJywgJ2NhcnJvdCcsICdsZXR0dWNlJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCB1bmlvbgogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHlLZXkqCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICAgIHVuaXF1ZSBlbGVtZW50cyBmcm9tIHRoZSBkZXBlbmRlbnQgYXJyYXkKICAgIEBwdWJsaWMKICAqLwogIHZhciB1bmlvbiA9IGV4cG9ydHMudW5pb24gPSB1bmlxOwoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUgZWxlbWVudHMKICAgIHR3byBvciBtb3JlIGRlcGVuZGVudCBhcnJheXMgaGF2ZSBpbiBjb21tb24uCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBpbnRlcnNlY3QgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBvYmogPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBmcmllbmRzSW5Db21tb246IGludGVyc2VjdCgnYWRhRnJpZW5kcycsICdjaGFybGVzRnJpZW5kcycpCiAgICB9KS5jcmVhdGUoewogICAgICBhZGFGcmllbmRzOiBbJ0NoYXJsZXMgQmFiYmFnZScsICdKb2huIEhvYmhvdXNlJywgJ1dpbGxpYW0gS2luZycsICdNYXJ5IFNvbWVydmlsbGUnXSwKICAgICAgY2hhcmxlc0ZyaWVuZHM6IFsnV2lsbGlhbSBLaW5nJywgJ01hcnkgU29tZXJ2aWxsZScsICdBZGEgTG92ZWxhY2UnLCAnR2VvcmdlIFBlYWNvY2snXQogICAgfSk7CiAgCiAgICBvYmouZ2V0KCdmcmllbmRzSW5Db21tb24nKTsgLy8gWydXaWxsaWFtIEtpbmcnLCAnTWFyeSBTb21lcnZpbGxlJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCBpbnRlcnNlY3QKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5S2V5KgogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZXMgYSBuZXcgYXJyYXkgd2l0aCBhbGwgdGhlCiAgICBkdXBsaWNhdGVkIGVsZW1lbnRzIGZyb20gdGhlIGRlcGVuZGVudCBhcnJheXMKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGludGVyc2VjdCgpIHsKICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgIH0KCiAgICByZXR1cm4gbXVsdGlBcnJheU1hY3JvKGFyZ3MsIGZ1bmN0aW9uIChkZXBlbmRlbnRLZXlzKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIGFycmF5cyA9IGRlcGVuZGVudEtleXMubWFwKGZ1bmN0aW9uIChkZXBlbmRlbnRLZXkpIHsKICAgICAgICB2YXIgYXJyYXkgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShfdGhpczIsIGRlcGVuZGVudEtleSk7CiAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJSdW50aW1lLmlzQXJyYXkpKGFycmF5KSA/IGFycmF5IDogW107CiAgICAgIH0pOwoKICAgICAgdmFyIHJlc3VsdHMgPSBhcnJheXMucG9wKCkuZmlsdGVyKGZ1bmN0aW9uIChjYW5kaWRhdGUpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICAgICAgICB2YXIgYXJyYXkgPSBhcnJheXNbaV07CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGlmIChhcnJheVtqXSA9PT0gY2FuZGlkYXRlKSB7CiAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGZvdW5kID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwgJ2ludGVyc2VjdCcpOwoKICAgICAgcmV0dXJuICgwLCBfZW1iZXJSdW50aW1lLkEpKHJlc3VsdHMpOwogICAgfSk7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggcmV0dXJucyBhIG5ldyBhcnJheSB3aXRoIGFsbCB0aGUKICAgIHByb3BlcnRpZXMgZnJvbSB0aGUgZmlyc3QgZGVwZW5kZW50IGFycmF5IHRoYXQgYXJlIG5vdCBpbiB0aGUgc2Vjb25kCiAgICBkZXBlbmRlbnQgYXJyYXkuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzZXREaWZmIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGxpa2VzOiBbJ2JhbmFuYScsICdncmFwZScsICdrYWxlJ10sCiAgICAgIHdhbnRzOiBzZXREaWZmKCdsaWtlcycsICdmcnVpdHMnKQogICAgfSk7CiAgCiAgICBsZXQgaGFtc3RlciA9IEhhbXN0ZXIuY3JlYXRlKHsKICAgICAgZnJ1aXRzOiBbCiAgICAgICAgJ2dyYXBlJywKICAgICAgICAna2FsZScsCiAgICAgIF0KICAgIH0pOwogIAogICAgaGFtc3Rlci5nZXQoJ3dhbnRzJyk7IC8vIFsnYmFuYW5hJ10KICAgIGBgYAogIAogICAgQG1ldGhvZCBzZXREaWZmCiAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7U3RyaW5nfSBzZXRBUHJvcGVydHkKICAgIEBwYXJhbSB7U3RyaW5nfSBzZXRCUHJvcGVydHkKICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IGNvbXB1dGVzIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZQogICAgaXRlbXMgZnJvbSB0aGUgZmlyc3QgZGVwZW5kZW50IGFycmF5IHRoYXQgYXJlIG5vdCBpbiB0aGUgc2Vjb25kCiAgICBkZXBlbmRlbnQgYXJyYXkKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIHNldERpZmYoc2V0QVByb3BlcnR5LCBzZXRCUHJvcGVydHkpIHsKICAgICh0cnVlICYmICEoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgY29tcHV0ZWQuc2V0RGlmZmAgcmVxdWlyZXMgZXhhY3RseSB0d28gZGVwZW5kZW50IGFycmF5cy4nLCBhcmd1bWVudHMubGVuZ3RoID09PSAyKSk7CiAgICAodHJ1ZSAmJiAhKCEvW1xbXF1ce1x9XS9nLnRlc3Qoc2V0QVByb3BlcnR5KSAmJiAhL1tcW1xdXHtcfV0vZy50ZXN0KHNldEJQcm9wZXJ0eSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRGVwZW5kZW50IGtleXMgcGFzc2VkIHRvIGBjb21wdXRlZC5zZXREaWZmYCBzaG91bGRuXCd0IGNvbnRhaW4gYnJhY2UgZXhwYW5kaW5nIHBhdHRlcm4uJywgIS9bXFtcXVx7XH1dL2cudGVzdChzZXRBUHJvcGVydHkpICYmICEvW1xbXF1ce1x9XS9nLnRlc3Qoc2V0QlByb3BlcnR5KSkpOwoKCiAgICB2YXIgY3AgPSBuZXcgX2VtYmVyTWV0YWwuQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzZXRBID0gdGhpcy5nZXQoc2V0QVByb3BlcnR5KTsKICAgICAgdmFyIHNldEIgPSB0aGlzLmdldChzZXRCUHJvcGVydHkpOwoKICAgICAgaWYgKCEoMCwgX2VtYmVyUnVudGltZS5pc0FycmF5KShzZXRBKSkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKSgpOwogICAgICB9CiAgICAgIGlmICghKDAsIF9lbWJlclJ1bnRpbWUuaXNBcnJheSkoc2V0QikpIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkoc2V0QSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzZXRBLmZpbHRlcihmdW5jdGlvbiAoeCkgewogICAgICAgIHJldHVybiBzZXRCLmluZGV4T2YoeCkgPT09IC0xOwogICAgICB9KTsKICAgIH0sIHsKICAgICAgZGVwZW5kZW50S2V5czogW3NldEFQcm9wZXJ0eSArICcuW10nLCBzZXRCUHJvcGVydHkgKyAnLltdJ10sCiAgICAgIHJlYWRPbmx5OiB0cnVlCiAgICB9KTsKCiAgICByZXR1cm4gY3A7CiAgfQoKICAvKioKICAgIEEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCByZXR1cm5zIHRoZSBhcnJheSBvZiB2YWx1ZXMKICAgIGZvciB0aGUgcHJvdmlkZWQgZGVwZW5kZW50IHByb3BlcnRpZXMuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBjb2xsZWN0IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgCiAgICBsZXQgSGFtc3RlciA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIGNsb3RoZXM6IGNvbGxlY3QoJ2hhdCcsICdzaGlydCcpCiAgICB9KTsKICAKICAgIGxldCBoYW1zdGVyID0gSGFtc3Rlci5jcmVhdGUoKTsKICAKICAgIGhhbXN0ZXIuZ2V0KCdjbG90aGVzJyk7IC8vIFtudWxsLCBudWxsXQogICAgaGFtc3Rlci5zZXQoJ2hhdCcsICdDYW1wIEhhdCcpOwogICAgaGFtc3Rlci5zZXQoJ3NoaXJ0JywgJ0NhbXAgU2hpcnQnKTsKICAgIGhhbXN0ZXIuZ2V0KCdjbG90aGVzJyk7IC8vIFsnQ2FtcCBIYXQnLCAnQ2FtcCBTaGlydCddCiAgICBgYGAKICAKICAgIEBtZXRob2QgY29sbGVjdAogICAgQGZvciBAZW1iZXIvb2JqZWN0L2NvbXB1dGVkCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge1N0cmluZ30gZGVwZW5kZW50S2V5KgogICAgQHJldHVybiB7Q29tcHV0ZWRQcm9wZXJ0eX0gY29tcHV0ZWQgcHJvcGVydHkgd2hpY2ggbWFwcwogICAgdmFsdWVzIG9mIGFsbCBwYXNzZWQgaW4gcHJvcGVydGllcyB0byBhbiBhcnJheS4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGNvbGxlY3QoKSB7CiAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGRlcGVuZGVudEtleXMgPSBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICBkZXBlbmRlbnRLZXlzW19rZXkzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgICB9CgogICAgcmV0dXJuIG11bHRpQXJyYXlNYWNybyhkZXBlbmRlbnRLZXlzLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwcm9wZXJ0aWVzID0gKDAsIF9lbWJlck1ldGFsLmdldFByb3BlcnRpZXMpKHRoaXMsIGRlcGVuZGVudEtleXMpOwogICAgICB2YXIgcmVzID0gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgICAgZm9yICh2YXIga2V5IGluIHByb3BlcnRpZXMpIHsKICAgICAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBpZiAocHJvcGVydGllc1trZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmVzLnB1c2gobnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXMucHVzaChwcm9wZXJ0aWVzW2tleV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzOwogICAgfSwgJ2NvbGxlY3QnKTsKICB9CgogIC8qKgogICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB3aGljaCByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggYWxsIHRoZQogICAgcHJvcGVydGllcyBmcm9tIHRoZSBmaXJzdCBkZXBlbmRlbnQgYXJyYXkgc29ydGVkIGJhc2VkIG9uIGEgcHJvcGVydHkKICAgIG9yIHNvcnQgZnVuY3Rpb24uCiAgCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24oaXRlbUEsIGl0ZW1CKTsKICAgIGBgYAogIAogICAgLSBgaXRlbUFgIHRoZSBmaXJzdCBpdGVtIHRvIGNvbXBhcmUuCiAgICAtIGBpdGVtQmAgdGhlIHNlY29uZCBpdGVtIHRvIGNvbXBhcmUuCiAgCiAgICBUaGlzIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gbmVnYXRpdmUgbnVtYmVyIChlLmcuIGAtMWApIHdoZW4gYGl0ZW1BYCBzaG91bGQgY29tZSBiZWZvcmUKICAgIGBpdGVtQmAuIEl0IHNob3VsZCByZXR1cm4gcG9zaXRpdmUgbnVtYmVyIChlLmcuIGAxYCkgd2hlbiBgaXRlbUFgIHNob3VsZCBjb21lIGFmdGVyCiAgICBgaXRlbUJgLiBJZiB0aGUgYGl0ZW1BYCBhbmQgYGl0ZW1CYCBhcmUgZXF1YWwgdGhpcyBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIGAwYC4KICAKICAgIFRoZXJlZm9yZSwgaWYgdGhpcyBmdW5jdGlvbiBpcyBjb21wYXJpbmcgc29tZSBudW1lcmljIHZhbHVlcywgc2ltcGxlIGBpdGVtQSAtIGl0ZW1CYCBvcgogICAgYGl0ZW1BLmdldCggJ2ZvbycgKSAtIGl0ZW1CLmdldCggJ2ZvbycgKWAgY2FuIGJlIHVzZWQgaW5zdGVhZCBvZiBzZXJpZXMgb2YgYGlmYC4KICAKICAgIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHNvcnQgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBUb0RvTGlzdCA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgIC8vIHVzaW5nIHN0YW5kYXJkIGFzY2VuZGluZyBzb3J0CiAgICAgIHRvZG9zU29ydGluZzogT2JqZWN0LmZyZWV6ZShbJ25hbWUnXSksCiAgICAgIHNvcnRlZFRvZG9zOiBzb3J0KCd0b2RvcycsICd0b2Rvc1NvcnRpbmcnKSwKICAKICAgICAgLy8gdXNpbmcgZGVzY2VuZGluZyBzb3J0CiAgICAgIHRvZG9zU29ydGluZ0Rlc2M6IE9iamVjdC5mcmVlemUoWyduYW1lOmRlc2MnXSksCiAgICAgIHNvcnRlZFRvZG9zRGVzYzogc29ydCgndG9kb3MnLCAndG9kb3NTb3J0aW5nRGVzYycpLAogIAogICAgICAvLyB1c2luZyBhIGN1c3RvbSBzb3J0IGZ1bmN0aW9uCiAgICAgIHByaW9yaXR5VG9kb3M6IHNvcnQoJ3RvZG9zJywgZnVuY3Rpb24oYSwgYil7CiAgICAgICAgaWYgKGEucHJpb3JpdHkgPiBiLnByaW9yaXR5KSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiAwOwogICAgICB9KQogICAgfSk7CiAgCiAgICBsZXQgdG9kb0xpc3QgPSBUb0RvTGlzdC5jcmVhdGUoe3RvZG9zOiBbCiAgICAgIHsgbmFtZTogJ1VuaXQgVGVzdCcsIHByaW9yaXR5OiAyIH0sCiAgICAgIHsgbmFtZTogJ0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTogMyB9LAogICAgICB7IG5hbWU6ICdSZWxlYXNlJywgcHJpb3JpdHk6IDEgfQogICAgXX0pOwogIAogICAgdG9kb0xpc3QuZ2V0KCdzb3J0ZWRUb2RvcycpOyAgICAgIC8vIFt7IG5hbWU6J0RvY3VtZW50YXRpb24nLCBwcmlvcml0eTozIH0sIHsgbmFtZTonUmVsZWFzZScsIHByaW9yaXR5OjEgfSwgeyBuYW1lOidVbml0IFRlc3QnLCBwcmlvcml0eToyIH1dCiAgICB0b2RvTGlzdC5nZXQoJ3NvcnRlZFRvZG9zRGVzYycpOyAgLy8gW3sgbmFtZTonVW5pdCBUZXN0JywgcHJpb3JpdHk6MiB9LCB7IG5hbWU6J1JlbGVhc2UnLCBwcmlvcml0eToxIH0sIHsgbmFtZTonRG9jdW1lbnRhdGlvbicsIHByaW9yaXR5OjMgfV0KICAgIHRvZG9MaXN0LmdldCgncHJpb3JpdHlUb2RvcycpOyAgICAvLyBbeyBuYW1lOidSZWxlYXNlJywgcHJpb3JpdHk6MSB9LCB7IG5hbWU6J1VuaXQgVGVzdCcsIHByaW9yaXR5OjIgfSwgeyBuYW1lOidEb2N1bWVudGF0aW9uJywgcHJpb3JpdHk6MyB9XQogICAgYGBgCiAgCiAgICBAbWV0aG9kIHNvcnQKICAgIEBmb3IgQGVtYmVyL29iamVjdC9jb21wdXRlZAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtTdHJpbmd9IGl0ZW1zS2V5CiAgICBAcGFyYW0ge1N0cmluZyBvciBGdW5jdGlvbn0gc29ydERlZmluaXRpb24gYSBkZXBlbmRlbnQga2V5IHRvIGFuCiAgICBhcnJheSBvZiBzb3J0IHByb3BlcnRpZXMgKGFkZCBgOmRlc2NgIHRvIHRoZSBhcnJheXMgc29ydCBwcm9wZXJ0aWVzIHRvIHNvcnQgZGVzY2VuZGluZykgb3IgYSBmdW5jdGlvbiB0byB1c2Ugd2hlbiBzb3J0aW5nCiAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSBjb21wdXRlcyBhIG5ldyBzb3J0ZWQgYXJyYXkgYmFzZWQKICAgIG9uIHRoZSBzb3J0IHByb3BlcnR5IGFycmF5IG9yIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBzb3J0KGl0ZW1zS2V5LCBzb3J0RGVmaW5pdGlvbikgewogICAgKHRydWUgJiYgIShhcmd1bWVudHMubGVuZ3RoID09PSAyKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Bjb21wdXRlZC5zb3J0YCByZXF1aXJlcyB0d28gYXJndW1lbnRzOiBhbiBhcnJheSBrZXkgdG8gc29ydCBhbmQgJyArICdlaXRoZXIgYSBzb3J0IHByb3BlcnRpZXMga2V5IG9yIHNvcnQgZnVuY3Rpb24nLCBhcmd1bWVudHMubGVuZ3RoID09PSAyKSk7CgoKICAgIGlmICh0eXBlb2Ygc29ydERlZmluaXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIGN1c3RvbVNvcnQoaXRlbXNLZXksIHNvcnREZWZpbml0aW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwcm9wZXJ0eVNvcnQoaXRlbXNLZXksIHNvcnREZWZpbml0aW9uKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGN1c3RvbVNvcnQoaXRlbXNLZXksIGNvbXBhcmF0b3IpIHsKICAgIHJldHVybiBhcnJheU1hY3JvKGl0ZW1zS2V5LCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICByZXR1cm4gdmFsdWUuc2xpY2UoKS5zb3J0KGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3IuY2FsbChfdGhpczMsIHgsIHkpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLy8gVGhpcyBvbmUgbmVlZHMgdG8gZHluYW1pY2FsbHkgc2V0IHVwIGFuZCB0ZWFyIGRvd24gb2JzZXJ2ZXJzIG9uIHRoZSBpdGVtc0tleQogIC8vIGRlcGVuZGluZyBvbiB0aGUgc29ydFByb3BlcnRpZXMKICBmdW5jdGlvbiBwcm9wZXJ0eVNvcnQoaXRlbXNLZXksIHNvcnRQcm9wZXJ0aWVzS2V5KSB7CiAgICB2YXIgY3AgPSBuZXcgX2VtYmVyTWV0YWwuQ29tcHV0ZWRQcm9wZXJ0eShmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgdmFyIHNvcnRQcm9wZXJ0aWVzID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgc29ydFByb3BlcnRpZXNLZXkpOwoKICAgICAgKHRydWUgJiYgISgoMCwgX2VtYmVyUnVudGltZS5pc0FycmF5KShzb3J0UHJvcGVydGllcykgJiYgc29ydFByb3BlcnRpZXMuZXZlcnkoZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHMgPT09ICdzdHJpbmcnOwogICAgICB9KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgc29ydCBkZWZpbml0aW9uIGZvciBcJycgKyBrZXkgKyAnXCcgb24gJyArIHRoaXMgKyAnIG11c3QgYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheSBvZiBzdHJpbmdzJywgKDAsIF9lbWJlclJ1bnRpbWUuaXNBcnJheSkoc29ydFByb3BlcnRpZXMpICYmIHNvcnRQcm9wZXJ0aWVzLmV2ZXJ5KGZ1bmN0aW9uIChzKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBzID09PSAnc3RyaW5nJzsKICAgICAgfSkpKTsKCgogICAgICAvLyBBZGQvcmVtb3ZlIHByb3BlcnR5IG9ic2VydmVycyBhcyByZXF1aXJlZC4KICAgICAgdmFyIGFjdGl2ZU9ic2VydmVyc01hcCA9IGNwLl9hY3RpdmVPYnNlcnZlck1hcCB8fCAoY3AuX2FjdGl2ZU9ic2VydmVyTWFwID0gbmV3IFdlYWtNYXAoKSk7CiAgICAgIHZhciBhY3RpdmVPYnNlcnZlcnMgPSBhY3RpdmVPYnNlcnZlcnNNYXAuZ2V0KHRoaXMpOwoKICAgICAgaWYgKGFjdGl2ZU9ic2VydmVycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYWN0aXZlT2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgIHJldHVybiBfZW1iZXJNZXRhbC5yZW1vdmVPYnNlcnZlci5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzb3J0UHJvcGVydHlEaWRDaGFuZ2UoKSB7CiAgICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgICB9CgogICAgICB2YXIgaXRlbXNLZXlJc0F0VGhpcyA9IGl0ZW1zS2V5ID09PSAnQHRoaXMnOwogICAgICB2YXIgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzID0gbm9ybWFsaXplU29ydFByb3BlcnRpZXMoc29ydFByb3BlcnRpZXMpOwogICAgICBpZiAobm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHZhciBwYXRoID0gaXRlbXNLZXlJc0F0VGhpcyA/ICdbXScgOiBpdGVtc0tleSArICcuW10nOwogICAgICAgICgwLCBfZW1iZXJNZXRhbC5hZGRPYnNlcnZlcikodGhpcywgcGF0aCwgc29ydFByb3BlcnR5RGlkQ2hhbmdlKTsKICAgICAgICBhY3RpdmVPYnNlcnZlcnMgPSBbW3RoaXMsIHBhdGgsIHNvcnRQcm9wZXJ0eURpZENoYW5nZV1dOwogICAgICB9IGVsc2UgewogICAgICAgIGFjdGl2ZU9ic2VydmVycyA9IG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcy5tYXAoZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICAgIHZhciBwcm9wID0gX3JlZlswXTsKCiAgICAgICAgICB2YXIgcGF0aCA9IGl0ZW1zS2V5SXNBdFRoaXMgPyAnQGVhY2guJyArIHByb3AgOiBpdGVtc0tleSArICcuQGVhY2guJyArIHByb3A7CiAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwuYWRkT2JzZXJ2ZXIpKF90aGlzNCwgcGF0aCwgc29ydFByb3BlcnR5RGlkQ2hhbmdlKTsKICAgICAgICAgIHJldHVybiBbX3RoaXM0LCBwYXRoLCBzb3J0UHJvcGVydHlEaWRDaGFuZ2VdOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBhY3RpdmVPYnNlcnZlcnNNYXAuc2V0KHRoaXMsIGFjdGl2ZU9ic2VydmVycyk7CgogICAgICB2YXIgaXRlbXMgPSBpdGVtc0tleUlzQXRUaGlzID8gdGhpcyA6ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsIGl0ZW1zS2V5KTsKICAgICAgaWYgKCEoMCwgX2VtYmVyUnVudGltZS5pc0FycmF5KShpdGVtcykpIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgICAgfQoKICAgICAgaWYgKG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkoaXRlbXMuc2xpY2UoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHNvcnRCeU5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcyhpdGVtcywgbm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzKTsKICAgICAgfQogICAgfSwgeyBkZXBlbmRlbnRLZXlzOiBbc29ydFByb3BlcnRpZXNLZXkgKyAnLltdJ10sIHJlYWRPbmx5OiB0cnVlIH0pOwoKICAgIGNwLl9hY3RpdmVPYnNlcnZlck1hcCA9IHVuZGVmaW5lZDsKCiAgICByZXR1cm4gY3A7CiAgfQoKICBmdW5jdGlvbiBub3JtYWxpemVTb3J0UHJvcGVydGllcyhzb3J0UHJvcGVydGllcykgewogICAgcmV0dXJuIHNvcnRQcm9wZXJ0aWVzLm1hcChmdW5jdGlvbiAocCkgewogICAgICB2YXIgX3Akc3BsaXQgPSBwLnNwbGl0KCc6JyksCiAgICAgICAgICBwcm9wID0gX3Akc3BsaXRbMF0sCiAgICAgICAgICBkaXJlY3Rpb24gPSBfcCRzcGxpdFsxXTsKCiAgICAgIGRpcmVjdGlvbiA9IGRpcmVjdGlvbiB8fCAnYXNjJzsKCiAgICAgIHJldHVybiBbcHJvcCwgZGlyZWN0aW9uXTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc29ydEJ5Tm9ybWFsaXplZFNvcnRQcm9wZXJ0aWVzKGl0ZW1zLCBub3JtYWxpemVkU29ydFByb3BlcnRpZXMpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKShpdGVtcy5zbGljZSgpLnNvcnQoZnVuY3Rpb24gKGl0ZW1BLCBpdGVtQikgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vcm1hbGl6ZWRTb3J0UHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBfbm9ybWFsaXplZFNvcnRQcm9wZXIgPSBub3JtYWxpemVkU29ydFByb3BlcnRpZXNbaV0sCiAgICAgICAgICAgIHByb3AgPSBfbm9ybWFsaXplZFNvcnRQcm9wZXJbMF0sCiAgICAgICAgICAgIGRpcmVjdGlvbiA9IF9ub3JtYWxpemVkU29ydFByb3BlclsxXTsKCiAgICAgICAgdmFyIHJlc3VsdCA9ICgwLCBfZW1iZXJSdW50aW1lLmNvbXBhcmUpKCgwLCBfZW1iZXJNZXRhbC5nZXQpKGl0ZW1BLCBwcm9wKSwgKDAsIF9lbWJlck1ldGFsLmdldCkoaXRlbUIsIHByb3ApKTsKICAgICAgICBpZiAocmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICByZXR1cm4gZGlyZWN0aW9uID09PSAnZGVzYycgPyAtMSAqIHJlc3VsdCA6IHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9KSk7CiAgfQp9KTsKZW5pZmVkKCdAZW1iZXIvcG9seWZpbGxzL2luZGV4JywgWydleHBvcnRzJywgJ0BlbWJlci9wb2x5ZmlsbHMvbGliL2Fzc2lnbicsICdAZW1iZXIvcG9seWZpbGxzL2xpYi9tZXJnZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2Fzc2lnbiwgX21lcmdlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2Fzc2lnbicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hc3NpZ24uZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2Fzc2lnblBvbHlmaWxsJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2Fzc2lnbi5hc3NpZ247CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdtZXJnZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9tZXJnZS5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKZW5pZmVkKCJAZW1iZXIvcG9seWZpbGxzL2xpYi9hc3NpZ24iLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICBleHBvcnRzLmFzc2lnbiA9IGFzc2lnbjsKICAgIC8qKgogICAgIEBtb2R1bGUgQGVtYmVyL3BvbHlmaWxscwogICAgKi8KICAgIC8qKgogICAgICBDb3B5IHByb3BlcnRpZXMgZnJvbSBhIHNvdXJjZSBvYmplY3QgdG8gYSB0YXJnZXQgb2JqZWN0LgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnQGVtYmVyL3BvbHlmaWxscyc7CiAgICAKICAgICAgdmFyIGEgPSB7IGZpcnN0OiAnWWVodWRhJyB9OwogICAgICB2YXIgYiA9IHsgbGFzdDogJ0thdHonIH07CiAgICAgIHZhciBjID0geyBjb21wYW55OiAnVGlsZGUgSW5jLicgfTsKICAgICAgYXNzaWduKGEsIGIsIGMpOyAvLyBhID09PSB7IGZpcnN0OiAnWWVodWRhJywgbGFzdDogJ0thdHonLCBjb21wYW55OiAnVGlsZGUgSW5jLicgfSwgYiA9PT0geyBsYXN0OiAnS2F0eicgfSwgYyA9PT0geyBjb21wYW55OiAnVGlsZGUgSW5jLicgfQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGFzc2lnbgogICAgICBAZm9yIEBlbWJlci9wb2x5ZmlsbHMKICAgICAgQHBhcmFtIHtPYmplY3R9IHRhcmdldCBUaGUgb2JqZWN0IHRvIGFzc2lnbiBpbnRvCiAgICAgIEBwYXJhbSB7T2JqZWN0fSAuLi5hcmdzIFRoZSBvYmplY3RzIHRvIGNvcHkgcHJvcGVydGllcyBmcm9tCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHB1YmxpYwogICAgICBAc3RhdGljCiAgICAqLwogICAgZnVuY3Rpb24gYXNzaWduKHRhcmdldCkgewogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBhcmcgPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgIGlmICghYXJnKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdXBkYXRlcyA9IE9iamVjdC5rZXlzKGFyZyk7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCB1cGRhdGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgICAgdmFyIHByb3AgPSB1cGRhdGVzW19pXTsKICAgICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IGFyZ1twcm9wXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLy8gTm90ZTogV2UgdXNlIHRoZSBicmFja2V0IG5vdGF0aW9uIHNvCiAgICAvLyAgICAgICB0aGF0IHRoZSBiYWJlbCBwbHVnaW4gZG9lcyBub3QKICAgIC8vICAgICAgIHRyYW5zZm9ybSBpdC4KICAgIC8vIGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL2JhYmVsLXBsdWdpbi10cmFuc2Zvcm0tb2JqZWN0LWFzc2lnbgogICAgdmFyIF9hc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgZXhwb3J0cy5kZWZhdWx0ID0gX2Fzc2lnbiB8fCBhc3NpZ247Cn0pOwplbmlmZWQoJ0BlbWJlci9wb2x5ZmlsbHMvbGliL21lcmdlJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5kZWZhdWx0ID0gbWVyZ2U7CiAgICAvKioKICAgICBAbW9kdWxlIEBlbWJlci9wb2x5ZmlsbHMKICAgICovCiAgICAvKioKICAgICAgTWVyZ2UgdGhlIGNvbnRlbnRzIG9mIHR3byBvYmplY3RzIHRvZ2V0aGVyIGludG8gdGhlIGZpcnN0IG9iamVjdC4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IG1lcmdlIH0gZnJvbSAnQGVtYmVyL3BvbHlmaWxscyc7CiAgICAKICAgICAgbWVyZ2UoeyBmaXJzdDogJ1RvbScgfSwgeyBsYXN0OiAnRGFsZScgfSk7IC8vIHsgZmlyc3Q6ICdUb20nLCBsYXN0OiAnRGFsZScgfQogICAgICB2YXIgYSA9IHsgZmlyc3Q6ICdZZWh1ZGEnIH07CiAgICAgIHZhciBiID0geyBsYXN0OiAnS2F0eicgfTsKICAgICAgbWVyZ2UoYSwgYik7IC8vIGEgPT0geyBmaXJzdDogJ1llaHVkYScsIGxhc3Q6ICdLYXR6JyB9LCBiID09IHsgbGFzdDogJ0thdHonIH0KICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBtZXJnZQogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL3BvbHlmaWxscwogICAgICBAcGFyYW0ge09iamVjdH0gb3JpZ2luYWwgVGhlIG9iamVjdCB0byBtZXJnZSBpbnRvCiAgICAgIEBwYXJhbSB7T2JqZWN0fSB1cGRhdGVzIFRoZSBvYmplY3QgdG8gY29weSBwcm9wZXJ0aWVzIGZyb20KICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2Uob3JpZ2luYWwsIHVwZGF0ZXMpIHsKICAgICAgICBpZiAodXBkYXRlcyA9PT0gbnVsbCB8fCB0eXBlb2YgdXBkYXRlcyAhPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvcHMgPSBPYmplY3Qua2V5cyh1cGRhdGVzKTsKICAgICAgICB2YXIgcHJvcCA9IHZvaWQgMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHByb3AgPSBwcm9wc1tpXTsKICAgICAgICAgICAgb3JpZ2luYWxbcHJvcF0gPSB1cGRhdGVzW3Byb3BdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3JpZ2luYWw7CiAgICB9CiAgICAvLyMgc291cmNlTWFwcGluZ1VSTD1tZXJnZS5qcy5tYXAKfSk7CmVuaWZlZCgnQGVtYmVyL3J1bmxvb3AvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLWVycm9yLWhhbmRsaW5nJywgJ2VtYmVyLW1ldGFsJywgJ2JhY2tidXJuZXInLCAnQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9kZWJ1ZywgX2VtYmVyRXJyb3JIYW5kbGluZywgX2VtYmVyTWV0YWwsIF9iYWNrYnVybmVyLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmJpbmQgPSBleHBvcnRzLl9nbG9iYWxzUnVuID0gZXhwb3J0cy5iYWNrYnVybmVyID0gZXhwb3J0cy5xdWV1ZXMgPSBleHBvcnRzLl9yc3ZwRXJyb3JRdWV1ZSA9IHVuZGVmaW5lZDsKICBleHBvcnRzLmdldEN1cnJlbnRSdW5Mb29wID0gZ2V0Q3VycmVudFJ1bkxvb3A7CiAgZXhwb3J0cy5ydW4gPSBydW47CiAgZXhwb3J0cy5qb2luID0gam9pbjsKICBleHBvcnRzLmJlZ2luID0gYmVnaW47CiAgZXhwb3J0cy5lbmQgPSBlbmQ7CiAgZXhwb3J0cy5zY2hlZHVsZSA9IHNjaGVkdWxlOwogIGV4cG9ydHMuaGFzU2NoZWR1bGVkVGltZXJzID0gaGFzU2NoZWR1bGVkVGltZXJzOwogIGV4cG9ydHMuY2FuY2VsVGltZXJzID0gY2FuY2VsVGltZXJzOwogIGV4cG9ydHMubGF0ZXIgPSBsYXRlcjsKICBleHBvcnRzLm9uY2UgPSBvbmNlOwogIGV4cG9ydHMuc2NoZWR1bGVPbmNlID0gc2NoZWR1bGVPbmNlOwogIGV4cG9ydHMubmV4dCA9IG5leHQ7CiAgZXhwb3J0cy5jYW5jZWwgPSBjYW5jZWw7CiAgZXhwb3J0cy5kZWJvdW5jZSA9IGRlYm91bmNlOwogIGV4cG9ydHMudGhyb3R0bGUgPSB0aHJvdHRsZTsKCgogIHZhciBjdXJyZW50UnVuTG9vcCA9IG51bGw7CiAgZnVuY3Rpb24gZ2V0Q3VycmVudFJ1bkxvb3AoKSB7CiAgICByZXR1cm4gY3VycmVudFJ1bkxvb3A7CiAgfQoKICBmdW5jdGlvbiBvbkJlZ2luKGN1cnJlbnQpIHsKICAgIGN1cnJlbnRSdW5Mb29wID0gY3VycmVudDsKICB9CgogIGZ1bmN0aW9uIG9uRW5kKGN1cnJlbnQsIG5leHQpIHsKICAgIGN1cnJlbnRSdW5Mb29wID0gbmV4dDsKICB9CgogIHZhciBfcnN2cEVycm9yUXVldWUgPSBleHBvcnRzLl9yc3ZwRXJyb3JRdWV1ZSA9ICgnJyArIE1hdGgucmFuZG9tKCkgKyBEYXRlLm5vdygpKS5yZXBsYWNlKCcuJywgJycpOwoKICAvKioKICAgIEFycmF5IG9mIG5hbWVkIHF1ZXVlcy4gVGhpcyBhcnJheSBkZXRlcm1pbmVzIHRoZSBvcmRlciBpbiB3aGljaCBxdWV1ZXMKICAgIGFyZSBmbHVzaGVkIGF0IHRoZSBlbmQgb2YgdGhlIFJ1bkxvb3AuIFlvdSBjYW4gZGVmaW5lIHlvdXIgb3duIHF1ZXVlcyBieQogICAgc2ltcGx5IGFkZGluZyB0aGUgcXVldWUgbmFtZSB0byB0aGlzIGFycmF5LiBOb3JtYWxseSB5b3Ugc2hvdWxkIG5vdCBuZWVkCiAgICB0byBpbnNwZWN0IG9yIG1vZGlmeSB0aGlzIHByb3BlcnR5LgogIAogICAgQHByb3BlcnR5IHF1ZXVlcwogICAgQHR5cGUgQXJyYXkKICAgIEBkZWZhdWx0IFsnYWN0aW9ucycsICdkZXN0cm95J10KICAgIEBwcml2YXRlCiAgKi8KICB2YXIgcXVldWVzID0gZXhwb3J0cy5xdWV1ZXMgPSBbJ2FjdGlvbnMnLAoKICAvLyB1c2VkIGluIHJvdXRlciB0cmFuc2l0aW9ucyB0byBwcmV2ZW50IHVubmVjZXNzYXJ5IGxvYWRpbmcgc3RhdGUgZW50cnkKICAvLyBpZiBhbGwgY29udGV4dCBwcm9taXNlcyByZXNvbHZlIG9uIHRoZSAnYWN0aW9ucycgcXVldWUgZmlyc3QKICAncm91dGVyVHJhbnNpdGlvbnMnLCAncmVuZGVyJywgJ2FmdGVyUmVuZGVyJywgJ2Rlc3Ryb3knLAoKICAvLyB1c2VkIHRvIHJlLXRocm93IHVuaGFuZGxlZCBSU1ZQIHJlamVjdGlvbiBlcnJvcnMgc3BlY2lmaWNhbGx5IGluIHRoaXMKICAvLyBwb3NpdGlvbiB0byBhdm9pZCBicmVha2luZyBhbnl0aGluZyByZW5kZXJlZCBpbiB0aGUgb3RoZXIgc2VjdGlvbnMKICBfcnN2cEVycm9yUXVldWVdOwoKICB2YXIgYmFja2J1cm5lck9wdGlvbnMgPSB7CiAgICBkZWZhdWx0UXVldWU6ICdhY3Rpb25zJywKICAgIG9uQmVnaW46IG9uQmVnaW4sCiAgICBvbkVuZDogb25FbmQsCiAgICBvbkVycm9yVGFyZ2V0OiBfZW1iZXJFcnJvckhhbmRsaW5nLm9uRXJyb3JUYXJnZXQsCiAgICBvbkVycm9yTWV0aG9kOiAnb25lcnJvcicKICB9OwoKICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5SVU5fU1lOQykgewogICAgcXVldWVzLnVuc2hpZnQoJ3N5bmMnKTsKCiAgICBiYWNrYnVybmVyT3B0aW9ucy5zeW5jID0gewogICAgICBiZWZvcmU6IF9lbWJlck1ldGFsLmJlZ2luUHJvcGVydHlDaGFuZ2VzLAogICAgICBhZnRlcjogX2VtYmVyTWV0YWwuZW5kUHJvcGVydHlDaGFuZ2VzCiAgICB9OwogIH0KCiAgdmFyIGJhY2tidXJuZXIgPSBleHBvcnRzLmJhY2tidXJuZXIgPSBuZXcgX2JhY2tidXJuZXIuZGVmYXVsdChxdWV1ZXMsIGJhY2tidXJuZXJPcHRpb25zKTsKCiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3J1bmxvb3AKICAqLwogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBydW4gLSB0aGlzIGlzIGlkZWFsbHkgdGhlIG9ubHkgcHVibGljIEFQSSB0aGUgZGV2IHNlZXMKICAvLwoKICAvKioKICAgIFJ1bnMgdGhlIHBhc3NlZCB0YXJnZXQgYW5kIG1ldGhvZCBpbnNpZGUgb2YgYSBSdW5Mb29wLCBlbnN1cmluZyBhbnkKICAgIGRlZmVycmVkIGFjdGlvbnMgaW5jbHVkaW5nIGJpbmRpbmdzIGFuZCB2aWV3cyB1cGRhdGVzIGFyZSBmbHVzaGVkIGF0IHRoZQogICAgZW5kLgogIAogICAgTm9ybWFsbHkgeW91IHNob3VsZCBub3QgbmVlZCB0byBpbnZva2UgdGhpcyBtZXRob2QgeW91cnNlbGYuIEhvd2V2ZXIgaWYKICAgIHlvdSBhcmUgaW1wbGVtZW50aW5nIHJhdyBldmVudCBoYW5kbGVycyB3aGVuIGludGVyZmFjaW5nIHdpdGggb3RoZXIKICAgIGxpYnJhcmllcyBvciBwbHVnaW5zLCB5b3Ugc2hvdWxkIHByb2JhYmx5IHdyYXAgYWxsIG9mIHlvdXIgY29kZSBpbnNpZGUgdGhpcwogICAgY2FsbC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHJ1biB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIHJ1bihmdW5jdGlvbigpIHsKICAgICAgLy8gY29kZSB0byBiZSBleGVjdXRlZCB3aXRoaW4gYSBSdW5Mb29wCiAgICB9KTsKICAgIGBgYAogICAgQG1ldGhvZCBydW4KICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBzdGF0aWMKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2YgbWV0aG9kIHRvIGNhbGwKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgTWV0aG9kIHRvIGludm9rZS4KICAgICAgTWF5IGJlIGEgZnVuY3Rpb24gb3IgYSBzdHJpbmcuIElmIHlvdSBwYXNzIGEgc3RyaW5nCiAgICAgIHRoZW4gaXQgd2lsbCBiZSBsb29rZWQgdXAgb24gdGhlIHBhc3NlZCB0YXJnZXQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgeW91IHdpc2ggdG8gcGFzcyB0byB0aGUgbWV0aG9kLgogICAgQHJldHVybiB7T2JqZWN0fSByZXR1cm4gdmFsdWUgZnJvbSBpbnZva2luZyB0aGUgcGFzc2VkIGZ1bmN0aW9uLgogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gcnVuKCkgewogICAgcmV0dXJuIGJhY2tidXJuZXIucnVuLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3VtZW50cyk7CiAgfQoKICAvLyB1c2VkIGZvciB0aGUgRW1iZXIucnVuIGdsb2JhbCBvbmx5CiAgdmFyIF9nbG9iYWxzUnVuID0gZXhwb3J0cy5fZ2xvYmFsc1J1biA9IHJ1bi5iaW5kKG51bGwpOwoKICAvKioKICAgIElmIG5vIHJ1bi1sb29wIGlzIHByZXNlbnQsIGl0IGNyZWF0ZXMgYSBuZXcgb25lLiBJZiBhIHJ1biBsb29wIGlzCiAgICBwcmVzZW50IGl0IHdpbGwgcXVldWUgaXRzZWxmIHRvIHJ1biBvbiB0aGUgZXhpc3RpbmcgcnVuLWxvb3BzIGFjdGlvbgogICAgcXVldWUuCiAgCiAgICBQbGVhc2Ugbm90ZTogVGhpcyBpcyBub3QgZm9yIG5vcm1hbCB1c2FnZSwgYW5kIHNob3VsZCBiZSB1c2VkIHNwYXJpbmdseS4KICAKICAgIElmIGludm9rZWQgd2hlbiBub3Qgd2l0aGluIGEgcnVuIGxvb3A6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBqb2luIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgam9pbihmdW5jdGlvbigpIHsKICAgICAgLy8gY3JlYXRlcyBhIG5ldyBydW4tbG9vcAogICAgfSk7CiAgICBgYGAKICAKICAgIEFsdGVybmF0aXZlbHksIGlmIGNhbGxlZCB3aXRoaW4gYW4gZXhpc3RpbmcgcnVuIGxvb3A6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBydW4sIGpvaW4gfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBydW4oZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNyZWF0ZXMgYSBuZXcgcnVuLWxvb3AKICAKICAgICAgam9pbihmdW5jdGlvbigpIHsKICAgICAgICAvLyBqb2lucyB3aXRoIHRoZSBleGlzdGluZyBydW4tbG9vcCwgYW5kIHF1ZXVlcyBmb3IgaW52b2NhdGlvbiBvbgogICAgICAgIC8vIHRoZSBleGlzdGluZyBydW4tbG9vcHMgYWN0aW9uIHF1ZXVlLgogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGpvaW4KICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2YgbWV0aG9kIHRvIGNhbGwKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgTWV0aG9kIHRvIGludm9rZS4KICAgICAgTWF5IGJlIGEgZnVuY3Rpb24gb3IgYSBzdHJpbmcuIElmIHlvdSBwYXNzIGEgc3RyaW5nCiAgICAgIHRoZW4gaXQgd2lsbCBiZSBsb29rZWQgdXAgb24gdGhlIHBhc3NlZCB0YXJnZXQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBBbnkgYWRkaXRpb25hbCBhcmd1bWVudHMgeW91IHdpc2ggdG8gcGFzcyB0byB0aGUgbWV0aG9kLgogICAgQHJldHVybiB7T2JqZWN0fSBSZXR1cm4gdmFsdWUgZnJvbSBpbnZva2luZyB0aGUgcGFzc2VkIGZ1bmN0aW9uLiBQbGVhc2Ugbm90ZSwKICAgIHdoZW4gY2FsbGVkIHdpdGhpbiBhbiBleGlzdGluZyBsb29wLCBubyByZXR1cm4gdmFsdWUgaXMgcG9zc2libGUuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBqb2luKCkgewogICAgcmV0dXJuIGJhY2tidXJuZXIuam9pbi5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KCiAgLyoqCiAgICBBbGxvd3MgeW91IHRvIHNwZWNpZnkgd2hpY2ggY29udGV4dCB0byBjYWxsIHRoZSBzcGVjaWZpZWQgZnVuY3Rpb24gaW4gd2hpbGUKICAgIGFkZGluZyB0aGUgZXhlY3V0aW9uIG9mIHRoYXQgZnVuY3Rpb24gdG8gdGhlIEVtYmVyIHJ1biBsb29wLiBUaGlzIGFiaWxpdHkKICAgIG1ha2VzIHRoaXMgbWV0aG9kIGEgZ3JlYXQgd2F5IHRvIGFzeW5jaHJvbm91c2x5IGludGVncmF0ZSB0aGlyZC1wYXJ0eSBsaWJyYXJpZXMKICAgIGludG8geW91ciBFbWJlciBhcHBsaWNhdGlvbi4KICAKICAgIGBiaW5kYCB0YWtlcyB0d28gbWFpbiBhcmd1bWVudHMsIHRoZSBkZXNpcmVkIGNvbnRleHQgYW5kIHRoZSBmdW5jdGlvbiB0bwogICAgaW52b2tlIGluIHRoYXQgY29udGV4dC4gQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIHdpbGwgYmUgc3VwcGxpZWQgYXMgYXJndW1lbnRzCiAgICB0byB0aGUgZnVuY3Rpb24gdGhhdCBpcyBwYXNzZWQgaW4uCiAgCiAgICBMZXQncyB1c2UgdGhlIGNyZWF0aW9uIG9mIGEgVGlueU1DRSBjb21wb25lbnQgYXMgYW4gZXhhbXBsZS4gQ3VycmVudGx5LAogICAgVGlueU1DRSBwcm92aWRlcyBhIHNldHVwIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHdlIGNhbiB1c2UgdG8gZG8gc29tZSBwcm9jZXNzaW5nCiAgICBhZnRlciB0aGUgVGlueU1DRSBpbnN0YW5jZSBpcyBpbml0aWFsaXplZCBidXQgYmVmb3JlIGl0IGlzIGFjdHVhbGx5IHJlbmRlcmVkLgogICAgV2UgY2FuIHVzZSB0aGF0IHNldHVwIG9wdGlvbiB0byBkbyBzb21lIGFkZGl0aW9uYWwgc2V0dXAgZm9yIG91ciBjb21wb25lbnQuCiAgICBUaGUgY29tcG9uZW50IGl0c2VsZiBjb3VsZCBsb29rIHNvbWV0aGluZyBsaWtlIHRoZSBmb2xsb3dpbmc6CiAgCiAgICBgYGBhcHAvY29tcG9uZW50cy9yaWNoLXRleHQtZWRpdG9yLmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0L2V2ZW50ZWQnOwogICAgaW1wb3J0IHsgYmluZCB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICBpbml0aWFsaXplVGlueU1DRTogb24oJ2RpZEluc2VydEVsZW1lbnQnLCBmdW5jdGlvbigpIHsKICAgICAgICB0aW55bWNlLmluaXQoewogICAgICAgICAgc2VsZWN0b3I6ICcjJyArIHRoaXMuJCgpLnByb3AoJ2lkJyksCiAgICAgICAgICBzZXR1cDogYmluZCh0aGlzLCB0aGlzLnNldHVwRWRpdG9yKQogICAgICAgIH0pOwogICAgICB9KSwKICAKICAgICAgZGlkSW5zZXJ0RWxlbWVudCgpIHsKICAgICAgICB0aW55bWNlLmluaXQoewogICAgICAgICAgc2VsZWN0b3I6ICcjJyArIHRoaXMuJCgpLnByb3AoJ2lkJyksCiAgICAgICAgICBzZXR1cDogYmluZCh0aGlzLCB0aGlzLnNldHVwRWRpdG9yKQogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHNldHVwRWRpdG9yKGVkaXRvcikgewogICAgICAgIHRoaXMuc2V0KCdlZGl0b3InLCBlZGl0b3IpOwogIAogICAgICAgIGVkaXRvci5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnY29udGVudCBjaGFuZ2VkIScpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgSW4gdGhpcyBleGFtcGxlLCB3ZSB1c2UgYGJpbmRgIHRvIGJpbmQgdGhlIHNldHVwRWRpdG9yIG1ldGhvZCB0byB0aGUKICAgIGNvbnRleHQgb2YgdGhlIFJpY2hUZXh0RWRpdG9yIGNvbXBvbmVudCBhbmQgdG8gaGF2ZSB0aGUgaW52b2NhdGlvbiBvZiB0aGF0CiAgICBtZXRob2QgYmUgc2FmZWx5IGhhbmRsZWQgYW5kIGV4ZWN1dGVkIGJ5IHRoZSBFbWJlciBydW4gbG9vcC4KICAKICAgIEBtZXRob2QgYmluZAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gY2FsbAogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBNZXRob2QgdG8gaW52b2tlLgogICAgICBNYXkgYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4gSWYgeW91IHBhc3MgYSBzdHJpbmcKICAgICAgdGhlbiBpdCB3aWxsIGJlIGxvb2tlZCB1cCBvbiB0aGUgcGFzc2VkIHRhcmdldC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIEFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyB5b3Ugd2lzaCB0byBwYXNzIHRvIHRoZSBtZXRob2QuCiAgICBAcmV0dXJuIHtGdW5jdGlvbn0gcmV0dXJucyBhIG5ldyBmdW5jdGlvbiB0aGF0IHdpbGwgYWx3YXlzIGhhdmUgYSBwYXJ0aWN1bGFyIGNvbnRleHQKICAgIEBzaW5jZSAxLjQuMAogICAgQHB1YmxpYwogICovCiAgdmFyIGJpbmQgPSBleHBvcnRzLmJpbmQgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgY3VycmllZCA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICBjdXJyaWVkW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgfQoKICAgICh0cnVlICYmICEoZnVuY3Rpb24gKG1ldGhvZE9yVGFyZ2V0LCBtZXRob2RPckFyZykgewogICAgICAvLyBBcHBsaWVzIHRoZSBzYW1lIGxvZ2ljIGFzIGJhY2tidXJuZXIgcGFyc2VBcmdzIGZvciBkZXRlY3RpbmcgaWYgYSBtZXRob2QKICAgICAgLy8gaXMgYWN0dWFsbHkgYmVpbmcgcGFzc2VkLgogICAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBtZXRob2RPclRhcmdldCA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBtZXRob2RPckFyZzsKICAgICAgICByZXR1cm4gdHlwZSA9PT0gJ2Z1bmN0aW9uJyB8fCAvLyBzZWNvbmQgYXJndW1lbnQgaXMgYSBmdW5jdGlvbgogICAgICAgIG1ldGhvZE9yVGFyZ2V0ICE9PSBudWxsICYmIHR5cGUgPT09ICdzdHJpbmcnICYmIG1ldGhvZE9yQXJnIGluIG1ldGhvZE9yVGFyZ2V0IHx8IC8vIHNlY29uZCBhcmd1bWVudCBpcyB0aGUgbmFtZSBvZiBhIG1ldGhvZCBpbiBmaXJzdCBhcmd1bWVudAogICAgICAgIHR5cGVvZiBtZXRob2RPclRhcmdldCA9PT0gJ2Z1bmN0aW9uJyAvL2ZpcnN0IGFyZ3VtZW50IGlzIGEgZnVuY3Rpb24KICAgICAgICA7CiAgICAgIH0KICAgIH0uYXBwbHkodW5kZWZpbmVkLCBjdXJyaWVkKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdjb3VsZCBub3QgZmluZCBhIHN1aXRhYmxlIG1ldGhvZCB0byBiaW5kJywgZnVuY3Rpb24gKG1ldGhvZE9yVGFyZ2V0LCBtZXRob2RPckFyZykgewogICAgICB2YXIgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDtpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgbWV0aG9kT3JBcmc7cmV0dXJuIHR5cGUgPT09ICdmdW5jdGlvbicgfHwgbWV0aG9kT3JUYXJnZXQgIT09IG51bGwgJiYgdHlwZSA9PT0gJ3N0cmluZycgJiYgbWV0aG9kT3JBcmcgaW4gbWV0aG9kT3JUYXJnZXQgfHwgdHlwZW9mIG1ldGhvZE9yVGFyZ2V0ID09PSAnZnVuY3Rpb24nOwogICAgICB9CiAgICB9LmFwcGx5KHVuZGVmaW5lZCwgY3VycmllZCkpKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIGFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGpvaW4uYXBwbHkodW5kZWZpbmVkLCBjdXJyaWVkLmNvbmNhdChhcmdzKSk7CiAgICB9OwogIH07CgogIC8qKgogICAgQmVnaW5zIGEgbmV3IFJ1bkxvb3AuIEFueSBkZWZlcnJlZCBhY3Rpb25zIGludm9rZWQgYWZ0ZXIgdGhlIGJlZ2luIHdpbGwKICAgIGJlIGJ1ZmZlcmVkIHVudGlsIHlvdSBpbnZva2UgYSBtYXRjaGluZyBjYWxsIHRvIGBlbmQoKWAuIFRoaXMgaXMKICAgIGEgbG93ZXItbGV2ZWwgd2F5IHRvIHVzZSBhIFJ1bkxvb3AgaW5zdGVhZCBvZiB1c2luZyBgcnVuKClgLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgYmVnaW4sIGVuZCB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGJlZ2luKCk7CiAgICAvLyBjb2RlIHRvIGJlIGV4ZWN1dGVkIHdpdGhpbiBhIFJ1bkxvb3AKICAgIGVuZCgpOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGJlZ2luCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcmV0dXJuIHt2b2lkfQogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gYmVnaW4oKSB7CiAgICBiYWNrYnVybmVyLmJlZ2luKCk7CiAgfQoKICAvKioKICAgIEVuZHMgYSBSdW5Mb29wLiBUaGlzIG11c3QgYmUgY2FsbGVkIHNvbWV0aW1lIGFmdGVyIHlvdSBjYWxsCiAgICBgYmVnaW4oKWAgdG8gZmx1c2ggYW55IGRlZmVycmVkIGFjdGlvbnMuIFRoaXMgaXMgYSBsb3dlci1sZXZlbCB3YXkKICAgIHRvIHVzZSBhIFJ1bkxvb3AgaW5zdGVhZCBvZiB1c2luZyBgcnVuKClgLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgYmVnaW4sIGVuZCB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGJlZ2luKCk7CiAgICAvLyBjb2RlIHRvIGJlIGV4ZWN1dGVkIHdpdGhpbiBhIFJ1bkxvb3AKICAgIGVuZCgpOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGVuZAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHJldHVybiB7dm9pZH0KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGVuZCgpIHsKICAgIGJhY2tidXJuZXIuZW5kKCk7CiAgfQoKICAvKioKICAgIEFkZHMgdGhlIHBhc3NlZCB0YXJnZXQvbWV0aG9kIGFuZCBhbnkgb3B0aW9uYWwgYXJndW1lbnRzIHRvIHRoZSBuYW1lZAogICAgcXVldWUgdG8gYmUgZXhlY3V0ZWQgYXQgdGhlIGVuZCBvZiB0aGUgUnVuTG9vcC4gSWYgeW91IGhhdmUgbm90IGFscmVhZHkKICAgIHN0YXJ0ZWQgYSBSdW5Mb29wIHdoZW4gY2FsbGluZyB0aGlzIG1ldGhvZCBvbmUgd2lsbCBiZSBzdGFydGVkIGZvciB5b3UKICAgIGF1dG9tYXRpY2FsbHkuCiAgCiAgICBBdCB0aGUgZW5kIG9mIGEgUnVuTG9vcCwgYW55IG1ldGhvZHMgc2NoZWR1bGVkIGluIHRoaXMgd2F5IHdpbGwgYmUgaW52b2tlZC4KICAgIE1ldGhvZHMgd2lsbCBiZSBpbnZva2VkIGluIGFuIG9yZGVyIG1hdGNoaW5nIHRoZSBuYW1lZCBxdWV1ZXMgZGVmaW5lZCBpbgogICAgdGhlIGBxdWV1ZXNgIHByb3BlcnR5LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgc2NoZWR1bGUgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBzY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIGZ1bmN0aW9uKCkgewogICAgICAvLyB0aGlzIHdpbGwgYmUgZXhlY3V0ZWQgaW4gdGhlICdhY3Rpb25zJyBxdWV1ZSwgYWZ0ZXIgYmluZGluZ3MgaGF2ZSBzeW5jZWQuCiAgICAgIGNvbnNvbGUubG9nKCdzY2hlZHVsZWQgb24gYWN0aW9ucyBxdWV1ZScpOwogICAgfSk7CiAgCiAgICAvLyBOb3RlIHRoZSBmdW5jdGlvbnMgd2lsbCBiZSBydW4gaW4gb3JkZXIgYmFzZWQgb24gdGhlIHJ1biBxdWV1ZXMgb3JkZXIuCiAgICAvLyBPdXRwdXQgd291bGQgYmU6CiAgICAvLyAgIHNjaGVkdWxlZCBvbiBzeW5jIHF1ZXVlCiAgICAvLyAgIHNjaGVkdWxlZCBvbiBhY3Rpb25zIHF1ZXVlCiAgICBgYGAKICAKICAgIEBtZXRob2Qgc2NoZWR1bGUKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7U3RyaW5nfSBxdWV1ZSBUaGUgbmFtZSBvZiB0aGUgcXVldWUgdG8gc2NoZWR1bGUgYWdhaW5zdC4gRGVmYXVsdCBxdWV1ZXMgaXMgJ2FjdGlvbnMnCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9iamVjdCB0byB1c2UgYXMgdGhlIGNvbnRleHQgd2hlbiBpbnZva2luZyBhIG1ldGhvZC4KICAgIEBwYXJhbSB7U3RyaW5nfEZ1bmN0aW9ufSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0CiAgICAgIHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlIHRhcmdldCBvYmplY3QgYXQgdGhlIHRpbWUgdGhlIHNjaGVkdWxlZCBpdGVtIGlzCiAgICAgIGludm9rZWQgYWxsb3dpbmcgeW91IHRvIGNoYW5nZSB0aGUgdGFyZ2V0IGZ1bmN0aW9uLgogICAgQHBhcmFtIHtPYmplY3R9IFthcmd1bWVudHMqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBxdWV1ZWQgbWV0aG9kLgogICAgQHJldHVybiB7Kn0gVGltZXIgaW5mb3JtYXRpb24gZm9yIHVzZSBpbiBjYW5jZWxpbmcsIHNlZSBgY2FuY2VsYC4KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIHNjaGVkdWxlKHF1ZXVlIC8qLCB0YXJnZXQsIG1ldGhvZCAqLykgewogICAgKHRydWUgJiYgIShjdXJyZW50UnVuTG9vcCB8fCAhKDAsIF9kZWJ1Zy5pc1Rlc3RpbmcpKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGhhdmUgdHVybmVkIG9uIHRlc3RpbmcgbW9kZSwgd2hpY2ggZGlzYWJsZWQgdGhlIHJ1bi1sb29wXCdzIGF1dG9ydW4uICcgKyAnWW91IHdpbGwgbmVlZCB0byB3cmFwIGFueSBjb2RlIHdpdGggYXN5bmNocm9ub3VzIHNpZGUtZWZmZWN0cyBpbiBhIHJ1bicsIGN1cnJlbnRSdW5Mb29wIHx8ICEoMCwgX2RlYnVnLmlzVGVzdGluZykoKSkpOwogICAgKHRydWUgJiYgIShxdWV1ZSAhPT0gJ3N5bmMnKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1NjaGVkdWxpbmcgaW50byB0aGUgXCcnICsgcXVldWUgKyAnXCcgcnVuIGxvb3AgcXVldWUgaXMgZGVwcmVjYXRlZC4nLCBxdWV1ZSAhPT0gJ3N5bmMnLCB7CiAgICAgIGlkOiAnZW1iZXItbWV0YWwucnVuLnN5bmMnLAogICAgICB1bnRpbDogJzMuNS4wJwogICAgfSkpOwoKCiAgICByZXR1cm4gYmFja2J1cm5lci5zY2hlZHVsZS5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KCiAgLy8gVXNlZCBieSBnbG9iYWwgdGVzdCB0ZWFyZG93bgogIGZ1bmN0aW9uIGhhc1NjaGVkdWxlZFRpbWVycygpIHsKICAgIHJldHVybiBiYWNrYnVybmVyLmhhc1RpbWVycygpOwogIH0KCiAgLy8gVXNlZCBieSBnbG9iYWwgdGVzdCB0ZWFyZG93bgogIGZ1bmN0aW9uIGNhbmNlbFRpbWVycygpIHsKICAgIGJhY2tidXJuZXIuY2FuY2VsVGltZXJzKCk7CiAgfQoKICAvKioKICAgIEludm9rZXMgdGhlIHBhc3NlZCB0YXJnZXQvbWV0aG9kIGFuZCBvcHRpb25hbCBhcmd1bWVudHMgYWZ0ZXIgYSBzcGVjaWZpZWQKICAgIHBlcmlvZCBvZiB0aW1lLiBUaGUgbGFzdCBwYXJhbWV0ZXIgb2YgdGhpcyBtZXRob2QgbXVzdCBhbHdheXMgYmUgYSBudW1iZXIKICAgIG9mIG1pbGxpc2Vjb25kcy4KICAKICAgIFlvdSBzaG91bGQgdXNlIHRoaXMgbWV0aG9kIHdoZW5ldmVyIHlvdSBuZWVkIHRvIHJ1biBzb21lIGFjdGlvbiBhZnRlciBhCiAgICBwZXJpb2Qgb2YgdGltZSBpbnN0ZWFkIG9mIHVzaW5nIGBzZXRUaW1lb3V0KClgLiBUaGlzIG1ldGhvZCB3aWxsIGVuc3VyZSB0aGF0CiAgICBpdGVtcyB0aGF0IGV4cGlyZSBkdXJpbmcgdGhlIHNhbWUgc2NyaXB0IGV4ZWN1dGlvbiBjeWNsZSBhbGwgZXhlY3V0ZQogICAgdG9nZXRoZXIsIHdoaWNoIGlzIG9mdGVuIG1vcmUgZWZmaWNpZW50IHRoYW4gdXNpbmcgYSByZWFsIHNldFRpbWVvdXQuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBsYXRlciB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGxhdGVyKG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNvZGUgaGVyZSB3aWxsIGV4ZWN1dGUgd2l0aGluIGEgUnVuTG9vcCBpbiBhYm91dCA1MDBtcyB3aXRoIHRoaXMgPT0gbXlDb250ZXh0CiAgICB9LCA1MDApOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGxhdGVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBpbnZva2UKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIElmIHlvdSBwYXNzIGEgc3RyaW5nIGl0IHdpbGwgYmUgcmVzb2x2ZWQgb24gdGhlCiAgICAgIHRhcmdldCBhdCB0aGUgdGltZSB0aGUgbWV0aG9kIGlzIGludm9rZWQuCiAgICBAcGFyYW0ge09iamVjdH0gW2FyZ3MqXSBPcHRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgdGltZW91dC4KICAgIEBwYXJhbSB7TnVtYmVyfSB3YWl0IE51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdC4KICAgIEByZXR1cm4geyp9IFRpbWVyIGluZm9ybWF0aW9uIGZvciB1c2UgaW4gY2FuY2VsaW5nLCBzZWUgYGNhbmNlbGAuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBsYXRlcigpIC8qdGFyZ2V0LCBtZXRob2QqL3sKICAgIHJldHVybiBiYWNrYnVybmVyLmxhdGVyLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3VtZW50cyk7CiAgfQoKICAvKioKICAgU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gb25lIHRpbWUgZHVyaW5nIHRoZSBjdXJyZW50IFJ1bkxvb3AuIFRoaXMgaXMgZXF1aXZhbGVudAogICAgdG8gY2FsbGluZyBgc2NoZWR1bGVPbmNlYCB3aXRoIHRoZSAiYWN0aW9ucyIgcXVldWUuCiAgCiAgICBAbWV0aG9kIG9uY2UKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgdGFyZ2V0IG9mIHRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZS4KICAgICAgSWYgeW91IHBhc3MgYSBzdHJpbmcgaXQgd2lsbCBiZSByZXNvbHZlZCBvbiB0aGUKICAgICAgdGFyZ2V0IGF0IHRoZSB0aW1lIHRoZSBtZXRob2QgaXMgaW52b2tlZC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogICAgQHJldHVybiB7T2JqZWN0fSBUaW1lciBpbmZvcm1hdGlvbiBmb3IgdXNlIGluIGNhbmNlbGluZywgc2VlIGBjYW5jZWxgLgogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gb25jZSgpIHsKICAgICh0cnVlICYmICEoY3VycmVudFJ1bkxvb3AgfHwgISgwLCBfZGVidWcuaXNUZXN0aW5nKSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBoYXZlIHR1cm5lZCBvbiB0ZXN0aW5nIG1vZGUsIHdoaWNoIGRpc2FibGVkIHRoZSBydW4tbG9vcFwncyBhdXRvcnVuLiAnICsgJ1lvdSB3aWxsIG5lZWQgdG8gd3JhcCBhbnkgY29kZSB3aXRoIGFzeW5jaHJvbm91cyBzaWRlLWVmZmVjdHMgaW4gYSBydW4nLCBjdXJyZW50UnVuTG9vcCB8fCAhKDAsIF9kZWJ1Zy5pc1Rlc3RpbmcpKCkpKTsKCiAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICBhcmdzW19rZXkzXSA9IGFyZ3VtZW50c1tfa2V5M107CiAgICB9CgogICAgYXJncy51bnNoaWZ0KCdhY3Rpb25zJyk7CiAgICByZXR1cm4gYmFja2J1cm5lci5zY2hlZHVsZU9uY2UuYXBwbHkoYmFja2J1cm5lciwgYXJncyk7CiAgfQoKICAvKioKICAgIFNjaGVkdWxlcyBhIGZ1bmN0aW9uIHRvIHJ1biBvbmUgdGltZSBpbiBhIGdpdmVuIHF1ZXVlIG9mIHRoZSBjdXJyZW50IFJ1bkxvb3AuCiAgICBDYWxsaW5nIHRoaXMgbWV0aG9kIHdpdGggdGhlIHNhbWUgcXVldWUvdGFyZ2V0L21ldGhvZCBjb21iaW5hdGlvbiB3aWxsIGhhdmUKICAgIG5vIGVmZmVjdCAocGFzdCB0aGUgaW5pdGlhbCBjYWxsKS4KICAKICAgIE5vdGUgdGhhdCBhbHRob3VnaCB5b3UgY2FuIHBhc3Mgb3B0aW9uYWwgYXJndW1lbnRzIHRoZXNlIHdpbGwgbm90IGJlCiAgICBjb25zaWRlcmVkIHdoZW4gbG9va2luZyBmb3IgZHVwbGljYXRlcy4gTmV3IGFyZ3VtZW50cyB3aWxsIHJlcGxhY2UgcHJldmlvdXMKICAgIGNhbGxzLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcnVuLCBzY2hlZHVsZU9uY2UgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBmdW5jdGlvbiBzYXlIaSgpIHsKICAgICAgY29uc29sZS5sb2coJ2hpJyk7CiAgICB9CiAgCiAgICBydW4oZnVuY3Rpb24oKSB7CiAgICAgIHNjaGVkdWxlT25jZSgnYWZ0ZXJSZW5kZXInLCBteUNvbnRleHQsIHNheUhpKTsKICAgICAgc2NoZWR1bGVPbmNlKCdhZnRlclJlbmRlcicsIG15Q29udGV4dCwgc2F5SGkpOwogICAgICAvLyBzYXlIaSB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgb25jZSwgaW4gdGhlIGFmdGVyUmVuZGVyIHF1ZXVlIG9mIHRoZSBSdW5Mb29wCiAgICB9KTsKICAgIGBgYAogIAogICAgQWxzbyBub3RlIHRoYXQgZm9yIGBzY2hlZHVsZU9uY2VgIHRvIHByZXZlbnQgYWRkaXRpb25hbCBjYWxscywgeW91IG5lZWQgdG8KICAgIHBhc3MgdGhlIHNhbWUgZnVuY3Rpb24gaW5zdGFuY2UuIFRoZSBmb2xsb3dpbmcgY2FzZSB3b3JrcyBhcyBleHBlY3RlZDoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIGxvZygpIHsKICAgICAgY29uc29sZS5sb2coJ0xvZ2dpbmcgb25seSBvbmNlJyk7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBzY2hlZHVsZUl0KCkgewogICAgICBzY2hlZHVsZU9uY2UoJ2FjdGlvbnMnLCBteUNvbnRleHQsIGxvZyk7CiAgICB9CiAgCiAgICBzY2hlZHVsZUl0KCk7CiAgICBzY2hlZHVsZUl0KCk7CiAgICBgYGAKICAKICAgIEJ1dCB0aGlzIG90aGVyIGNhc2Ugd2lsbCBzY2hlZHVsZSB0aGUgZnVuY3Rpb24gbXVsdGlwbGUgdGltZXM6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBzY2hlZHVsZU9uY2UgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBmdW5jdGlvbiBzY2hlZHVsZUl0KCkgewogICAgICBzY2hlZHVsZU9uY2UoJ2FjdGlvbnMnLCBteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnNvbGUubG9nKCdDbG9zdXJlJyk7CiAgICAgIH0pOwogICAgfQogIAogICAgc2NoZWR1bGVJdCgpOwogICAgc2NoZWR1bGVJdCgpOwogIAogICAgLy8gIkNsb3N1cmUiIHdpbGwgcHJpbnQgdHdpY2UsIGV2ZW4gdGhvdWdoIHdlJ3JlIHVzaW5nIGBzY2hlZHVsZU9uY2VgLAogICAgLy8gYmVjYXVzZSB0aGUgZnVuY3Rpb24gd2UgcGFzcyB0byBpdCB3b24ndCBtYXRjaCB0aGUKICAgIC8vIHByZXZpb3VzbHkgc2NoZWR1bGVkIG9wZXJhdGlvbi4KICAgIGBgYAogIAogICAgQXZhaWxhYmxlIHF1ZXVlcywgYW5kIHRoZWlyIG9yZGVyLCBjYW4gYmUgZm91bmQgYXQgYHF1ZXVlc2AKICAKICAgIEBtZXRob2Qgc2NoZWR1bGVPbmNlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge1N0cmluZ30gW3F1ZXVlXSBUaGUgbmFtZSBvZiB0aGUgcXVldWUgdG8gc2NoZWR1bGUgYWdhaW5zdC4gRGVmYXVsdCBxdWV1ZXMgaXMgJ2FjdGlvbnMnLgogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSB0YXJnZXQgb2YgdGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICBJZiB5b3UgcGFzcyBhIHN0cmluZyBpdCB3aWxsIGJlIHJlc29sdmVkIG9uIHRoZQogICAgICB0YXJnZXQgYXQgdGhlIHRpbWUgdGhlIG1ldGhvZCBpcyBpbnZva2VkLgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgICBAcmV0dXJuIHtPYmplY3R9IFRpbWVyIGluZm9ybWF0aW9uIGZvciB1c2UgaW4gY2FuY2VsaW5nLCBzZWUgYGNhbmNlbGAuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBzY2hlZHVsZU9uY2UocXVldWUgLyosIHRhcmdldCwgbWV0aG9kKi8pIHsKICAgICh0cnVlICYmICEoY3VycmVudFJ1bkxvb3AgfHwgISgwLCBfZGVidWcuaXNUZXN0aW5nKSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBoYXZlIHR1cm5lZCBvbiB0ZXN0aW5nIG1vZGUsIHdoaWNoIGRpc2FibGVkIHRoZSBydW4tbG9vcFwncyBhdXRvcnVuLiAnICsgJ1lvdSB3aWxsIG5lZWQgdG8gd3JhcCBhbnkgY29kZSB3aXRoIGFzeW5jaHJvbm91cyBzaWRlLWVmZmVjdHMgaW4gYSBydW4nLCBjdXJyZW50UnVuTG9vcCB8fCAhKDAsIF9kZWJ1Zy5pc1Rlc3RpbmcpKCkpKTsKICAgICh0cnVlICYmICEocXVldWUgIT09ICdzeW5jJykgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdTY2hlZHVsaW5nIGludG8gdGhlIFwnJyArIHF1ZXVlICsgJ1wnIHJ1biBsb29wIHF1ZXVlIGlzIGRlcHJlY2F0ZWQuJywgcXVldWUgIT09ICdzeW5jJywgewogICAgICBpZDogJ2VtYmVyLW1ldGFsLnJ1bi5zeW5jJywKICAgICAgdW50aWw6ICczLjUuMCcKICAgIH0pKTsKCiAgICByZXR1cm4gYmFja2J1cm5lci5zY2hlZHVsZU9uY2UuYXBwbHkoYmFja2J1cm5lciwgYXJndW1lbnRzKTsKICB9CgogIC8qKgogICAgU2NoZWR1bGVzIGFuIGl0ZW0gdG8gcnVuIGZyb20gd2l0aGluIGEgc2VwYXJhdGUgcnVuIGxvb3AsIGFmdGVyCiAgICBjb250cm9sIGhhcyBiZWVuIHJldHVybmVkIHRvIHRoZSBzeXN0ZW0uIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjYWxsaW5nCiAgICBgbGF0ZXJgIHdpdGggYSB3YWl0IHRpbWUgb2YgMW1zLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgbmV4dCB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIG5leHQobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgICAgLy8gY29kZSB0byBiZSBleGVjdXRlZCBpbiB0aGUgbmV4dCBydW4gbG9vcCwKICAgICAgLy8gd2hpY2ggd2lsbCBiZSBzY2hlZHVsZWQgYWZ0ZXIgdGhlIGN1cnJlbnQgb25lCiAgICB9KTsKICAgIGBgYAogIAogICAgTXVsdGlwbGUgb3BlcmF0aW9ucyBzY2hlZHVsZWQgd2l0aCBgbmV4dGAgd2lsbCBjb2FsZXNjZQogICAgaW50byB0aGUgc2FtZSBsYXRlciBydW4gbG9vcCwgYWxvbmcgd2l0aCBhbnkgb3RoZXIgb3BlcmF0aW9ucwogICAgc2NoZWR1bGVkIGJ5IGBsYXRlcmAgdGhhdCBleHBpcmUgcmlnaHQgYXJvdW5kIHRoZSBzYW1lCiAgICB0aW1lIHRoYXQgYG5leHRgIG9wZXJhdGlvbnMgd2lsbCBmaXJlLgogIAogICAgTm90ZSB0aGF0IHRoZXJlIGFyZSBvZnRlbiBhbHRlcm5hdGl2ZXMgdG8gdXNpbmcgYG5leHRgLgogICAgRm9yIGluc3RhbmNlLCBpZiB5b3UnZCBsaWtlIHRvIHNjaGVkdWxlIGFuIG9wZXJhdGlvbiB0byBoYXBwZW4KICAgIGFmdGVyIGFsbCBET00gZWxlbWVudCBvcGVyYXRpb25zIGhhdmUgY29tcGxldGVkIHdpdGhpbiB0aGUgY3VycmVudAogICAgcnVuIGxvb3AsIHlvdSBjYW4gbWFrZSB1c2Ugb2YgdGhlIGBhZnRlclJlbmRlcmAgcnVuIGxvb3AgcXVldWUgKGFkZGVkCiAgICBieSB0aGUgYGVtYmVyLXZpZXdzYCBwYWNrYWdlLCBhbG9uZyB3aXRoIHRoZSBwcmVjZWRpbmcgYHJlbmRlcmAgcXVldWUKICAgIHdoZXJlIGFsbCB0aGUgRE9NIGVsZW1lbnQgb3BlcmF0aW9ucyBoYXBwZW4pLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIGltcG9ydCB7IHNjaGVkdWxlT25jZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGV4cG9ydCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgZGlkSW5zZXJ0RWxlbWVudCgpIHsKICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgIHNjaGVkdWxlT25jZSgnYWZ0ZXJSZW5kZXInLCB0aGlzLCAncHJvY2Vzc0NoaWxkRWxlbWVudHMnKTsKICAgICAgfSwKICAKICAgICAgcHJvY2Vzc0NoaWxkRWxlbWVudHMoKSB7CiAgICAgICAgLy8gLi4uIGRvIHNvbWV0aGluZyB3aXRoIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudAogICAgICAgIC8vIGVsZW1lbnRzIGFmdGVyIHRoZXkndmUgZmluaXNoZWQgcmVuZGVyaW5nLCB3aGljaAogICAgICAgIC8vIGNhbid0IGJlIGRvbmUgd2l0aGluIHRoaXMgY29tcG9uZW50J3MKICAgICAgICAvLyBgZGlkSW5zZXJ0RWxlbWVudGAgaG9vayBiZWNhdXNlIHRoYXQgZ2V0cyBydW4KICAgICAgICAvLyBiZWZvcmUgdGhlIGNoaWxkIGVsZW1lbnRzIGhhdmUgYmVlbiBhZGRlZCB0byB0aGUgRE9NLgogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgT25lIGJlbmVmaXQgb2YgdGhlIGFib3ZlIGFwcHJvYWNoIGNvbXBhcmVkIHRvIHVzaW5nIGBuZXh0YCBpcwogICAgdGhhdCB5b3Ugd2lsbCBiZSBhYmxlIHRvIHBlcmZvcm0gRE9NL0NTUyBvcGVyYXRpb25zIGJlZm9yZSB1bnByb2Nlc3NlZAogICAgZWxlbWVudHMgYXJlIHJlbmRlcmVkIHRvIHRoZSBzY3JlZW4sIHdoaWNoIG1heSBwcmV2ZW50IGZsaWNrZXJpbmcgb3IKICAgIG90aGVyIGFydGlmYWN0cyBjYXVzZWQgYnkgZGVsYXlpbmcgcHJvY2Vzc2luZyB1bnRpbCBhZnRlciByZW5kZXJpbmcuCiAgCiAgICBUaGUgb3RoZXIgbWFqb3IgYmVuZWZpdCB0byB0aGUgYWJvdmUgYXBwcm9hY2ggaXMgdGhhdCBgbmV4dGAKICAgIGludHJvZHVjZXMgYW4gZWxlbWVudCBvZiBub24tZGV0ZXJtaW5pc20sIHdoaWNoIGNhbiBtYWtlIHRoaW5ncyBtdWNoCiAgICBoYXJkZXIgdG8gdGVzdCwgZHVlIHRvIGl0cyByZWxpYW5jZSBvbiBgc2V0VGltZW91dGA7IGl0J3MgbXVjaCBoYXJkZXIKICAgIHRvIGd1YXJhbnRlZSB0aGUgb3JkZXIgb2Ygc2NoZWR1bGVkIG9wZXJhdGlvbnMgd2hlbiB0aGV5IGFyZSBzY2hlZHVsZWQKICAgIG91dHNpZGUgb2YgdGhlIGN1cnJlbnQgcnVuIGxvb3AsIGkuZS4gd2l0aCBgbmV4dGAuCiAgCiAgICBAbWV0aG9kIG5leHQKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSB0YXJnZXQgb2YgbWV0aG9kIHRvIGludm9rZQogICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBUaGUgbWV0aG9kIHRvIGludm9rZS4KICAgICAgSWYgeW91IHBhc3MgYSBzdHJpbmcgaXQgd2lsbCBiZSByZXNvbHZlZCBvbiB0aGUKICAgICAgdGFyZ2V0IGF0IHRoZSB0aW1lIHRoZSBtZXRob2QgaXMgaW52b2tlZC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogICAgQHJldHVybiB7T2JqZWN0fSBUaW1lciBpbmZvcm1hdGlvbiBmb3IgdXNlIGluIGNhbmNlbGluZywgc2VlIGBjYW5jZWxgLgogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gbmV4dCgpIHsKICAgIGZvciAodmFyIF9sZW40ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW40KSwgX2tleTQgPSAwOyBfa2V5NCA8IF9sZW40OyBfa2V5NCsrKSB7CiAgICAgIGFyZ3NbX2tleTRdID0gYXJndW1lbnRzW19rZXk0XTsKICAgIH0KCiAgICBhcmdzLnB1c2goMSk7CiAgICByZXR1cm4gYmFja2J1cm5lci5sYXRlci5hcHBseShiYWNrYnVybmVyLCBhcmdzKTsKICB9CgogIC8qKgogICAgQ2FuY2VscyBhIHNjaGVkdWxlZCBpdGVtLiBNdXN0IGJlIGEgdmFsdWUgcmV0dXJuZWQgYnkgYGxhdGVyKClgLAogICAgYG9uY2UoKWAsIGBzY2hlZHVsZU9uY2UoKWAsIGBuZXh0KClgLCBgZGVib3VuY2UoKWAsIG9yCiAgICBgdGhyb3R0bGUoKWAuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgewogICAgICBuZXh0LAogICAgICBjYW5jZWwsCiAgICAgIGxhdGVyLAogICAgICBzY2hlZHVsZU9uY2UsCiAgICAgIG9uY2UsCiAgICAgIHRocm90dGxlLAogICAgICBkZWJvdW5jZQogICAgfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgCiAgICBsZXQgcnVuTmV4dCA9IG5leHQobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgICAgLy8gd2lsbCBub3QgYmUgZXhlY3V0ZWQKICAgIH0pOwogIAogICAgY2FuY2VsKHJ1bk5leHQpOwogIAogICAgbGV0IHJ1bkxhdGVyID0gbGF0ZXIobXlDb250ZXh0LCBmdW5jdGlvbigpIHsKICAgICAgLy8gd2lsbCBub3QgYmUgZXhlY3V0ZWQKICAgIH0sIDUwMCk7CiAgCiAgICBjYW5jZWwocnVuTGF0ZXIpOwogIAogICAgbGV0IHJ1blNjaGVkdWxlT25jZSA9IHNjaGVkdWxlT25jZSgnYWZ0ZXJSZW5kZXInLCBteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSk7CiAgCiAgICBjYW5jZWwocnVuU2NoZWR1bGVPbmNlKTsKICAKICAgIGxldCBydW5PbmNlID0gb25jZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSk7CiAgCiAgICBjYW5jZWwocnVuT25jZSk7CiAgCiAgICBsZXQgdGhyb3R0bGUgPSB0aHJvdHRsZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIG5vdCBiZSBleGVjdXRlZAogICAgfSwgMSwgZmFsc2UpOwogIAogICAgY2FuY2VsKHRocm90dGxlKTsKICAKICAgIGxldCBkZWJvdW5jZSA9IGRlYm91bmNlKG15Q29udGV4dCwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIHdpbGwgbm90IGJlIGV4ZWN1dGVkCiAgICB9LCAxKTsKICAKICAgIGNhbmNlbChkZWJvdW5jZSk7CiAgCiAgICBsZXQgZGVib3VuY2VJbW1lZGlhdGUgPSBkZWJvdW5jZShteUNvbnRleHQsIGZ1bmN0aW9uKCkgewogICAgICAvLyB3aWxsIGJlIGV4ZWN1dGVkIHNpbmNlIHdlIHBhc3NlZCBpbiB0cnVlIChpbW1lZGlhdGUpCiAgICB9LCAxMDAsIHRydWUpOwogIAogICAgLy8gdGhlIDEwMG1zIGRlbGF5IHVudGlsIHRoaXMgbWV0aG9kIGNhbiBiZSBjYWxsZWQgYWdhaW4gd2lsbCBiZSBjYW5jZWxlZAogICAgY2FuY2VsKGRlYm91bmNlSW1tZWRpYXRlKTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBjYW5jZWwKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL3J1bmxvb3AKICAgIEBwYXJhbSB7T2JqZWN0fSB0aW1lciBUaW1lciBvYmplY3QgdG8gY2FuY2VsCiAgICBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIGNhbmNlbGVkIG9yIGZhbHNlL3VuZGVmaW5lZCBpZiBpdCB3YXNuJ3QgZm91bmQKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGNhbmNlbCh0aW1lcikgewogICAgcmV0dXJuIGJhY2tidXJuZXIuY2FuY2VsKHRpbWVyKTsKICB9CgogIC8qKgogICAgRGVsYXkgY2FsbGluZyB0aGUgdGFyZ2V0IG1ldGhvZCB1bnRpbCB0aGUgZGVib3VuY2UgcGVyaW9kIGhhcyBlbGFwc2VkCiAgICB3aXRoIG5vIGFkZGl0aW9uYWwgZGVib3VuY2UgY2FsbHMuIElmIGBkZWJvdW5jZWAgaXMgY2FsbGVkIGFnYWluIGJlZm9yZQogICAgdGhlIHNwZWNpZmllZCB0aW1lIGhhcyBlbGFwc2VkLCB0aGUgdGltZXIgaXMgcmVzZXQgYW5kIHRoZSBlbnRpcmUgcGVyaW9kCiAgICBtdXN0IHBhc3MgYWdhaW4gYmVmb3JlIHRoZSB0YXJnZXQgbWV0aG9kIGlzIGNhbGxlZC4KICAKICAgIFRoaXMgbWV0aG9kIHNob3VsZCBiZSB1c2VkIHdoZW4gYW4gZXZlbnQgbWF5IGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcwogICAgYnV0IHRoZSBhY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uY2Ugd2hlbiB0aGUgZXZlbnQgaXMgZG9uZSBmaXJpbmcuCiAgICBBIGNvbW1vbiBleGFtcGxlIGlzIGZvciBzY3JvbGwgZXZlbnRzIHdoZXJlIHlvdSBvbmx5IHdhbnQgdXBkYXRlcyB0bwogICAgaGFwcGVuIG9uY2Ugc2Nyb2xsaW5nIGhhcyBjZWFzZWQuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBkZWJvdW5jZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGZ1bmN0aW9uIHdob1JhbigpIHsKICAgICAgY29uc29sZS5sb2codGhpcy5uYW1lICsgJyByYW4uJyk7CiAgICB9CiAgCiAgICBsZXQgbXlDb250ZXh0ID0geyBuYW1lOiAnZGVib3VuY2UnIH07CiAgCiAgICBkZWJvdW5jZShteUNvbnRleHQsIHdob1JhbiwgMTUwKTsKICAKICAgIC8vIGxlc3MgdGhhbiAxNTBtcyBwYXNzZXMKICAgIGRlYm91bmNlKG15Q29udGV4dCwgd2hvUmFuLCAxNTApOwogIAogICAgLy8gMTUwbXMgcGFzc2VzCiAgICAvLyB3aG9SYW4gaXMgaW52b2tlZCB3aXRoIGNvbnRleHQgbXlDb250ZXh0CiAgICAvLyBjb25zb2xlIGxvZ3MgJ2RlYm91bmNlIHJhbi4nIG9uZSB0aW1lLgogICAgYGBgCiAgCiAgICBJbW1lZGlhdGUgYWxsb3dzIHlvdSB0byBydW4gdGhlIGZ1bmN0aW9uIGltbWVkaWF0ZWx5LCBidXQgZGVib3VuY2UKICAgIG90aGVyIGNhbGxzIGZvciB0aGlzIGZ1bmN0aW9uIHVudGlsIHRoZSB3YWl0IHRpbWUgaGFzIGVsYXBzZWQuIElmCiAgICBgZGVib3VuY2VgIGlzIGNhbGxlZCBhZ2FpbiBiZWZvcmUgdGhlIHNwZWNpZmllZCB0aW1lIGhhcyBlbGFwc2VkLAogICAgdGhlIHRpbWVyIGlzIHJlc2V0IGFuZCB0aGUgZW50aXJlIHBlcmlvZCBtdXN0IHBhc3MgYWdhaW4gYmVmb3JlCiAgICB0aGUgbWV0aG9kIGNhbiBiZSBjYWxsZWQgYWdhaW4uCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBkZWJvdW5jZSB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIGZ1bmN0aW9uIHdob1JhbigpIHsKICAgICAgY29uc29sZS5sb2codGhpcy5uYW1lICsgJyByYW4uJyk7CiAgICB9CiAgCiAgICBsZXQgbXlDb250ZXh0ID0geyBuYW1lOiAnZGVib3VuY2UnIH07CiAgCiAgICBkZWJvdW5jZShteUNvbnRleHQsIHdob1JhbiwgMTUwLCB0cnVlKTsKICAKICAgIC8vIGNvbnNvbGUgbG9ncyAnZGVib3VuY2UgcmFuLicgb25lIHRpbWUgaW1tZWRpYXRlbHkuCiAgICAvLyAxMDBtcyBwYXNzZXMKICAgIGRlYm91bmNlKG15Q29udGV4dCwgd2hvUmFuLCAxNTAsIHRydWUpOwogIAogICAgLy8gMTUwbXMgcGFzc2VzIGFuZCBub3RoaW5nIGVsc2UgaXMgbG9nZ2VkIHRvIHRoZSBjb25zb2xlIGFuZAogICAgLy8gdGhlIGRlYm91bmNlZSBpcyBubyBsb25nZXIgYmVpbmcgd2F0Y2hlZAogICAgZGVib3VuY2UobXlDb250ZXh0LCB3aG9SYW4sIDE1MCwgdHJ1ZSk7CiAgCiAgICAvLyBjb25zb2xlIGxvZ3MgJ2RlYm91bmNlIHJhbi4nIG9uZSB0aW1lIGltbWVkaWF0ZWx5LgogICAgLy8gMTUwbXMgcGFzc2VzIGFuZCBub3RoaW5nIGVsc2UgaXMgbG9nZ2VkIHRvIHRoZSBjb25zb2xlIGFuZAogICAgLy8gdGhlIGRlYm91bmNlZSBpcyBubyBsb25nZXIgYmVpbmcgd2F0Y2hlZAogICAgYGBgCiAgCiAgICBAbWV0aG9kIGRlYm91bmNlCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9ydW5sb29wCiAgICBAcGFyYW0ge09iamVjdH0gW3RhcmdldF0gdGFyZ2V0IG9mIG1ldGhvZCB0byBpbnZva2UKICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgVGhlIG1ldGhvZCB0byBpbnZva2UuCiAgICAgIE1heSBiZSBhIGZ1bmN0aW9uIG9yIGEgc3RyaW5nLiBJZiB5b3UgcGFzcyBhIHN0cmluZwogICAgICB0aGVuIGl0IHdpbGwgYmUgbG9va2VkIHVwIG9uIHRoZSBwYXNzZWQgdGFyZ2V0LgogICAgQHBhcmFtIHtPYmplY3R9IFthcmdzKl0gT3B0aW9uYWwgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIHRpbWVvdXQuCiAgICBAcGFyYW0ge051bWJlcn0gd2FpdCBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBUcmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUgbGVhZGluZyBpbnN0ZWFkCiAgICAgIG9mIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB3YWl0IGludGVydmFsLiBEZWZhdWx0cyB0byBmYWxzZS4KICAgIEByZXR1cm4ge0FycmF5fSBUaW1lciBpbmZvcm1hdGlvbiBmb3IgdXNlIGluIGNhbmNlbGluZywgc2VlIGBjYW5jZWxgLgogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gZGVib3VuY2UoKSB7CiAgICByZXR1cm4gYmFja2J1cm5lci5kZWJvdW5jZS5hcHBseShiYWNrYnVybmVyLCBhcmd1bWVudHMpOwogIH0KCiAgLyoqCiAgICBFbnN1cmUgdGhhdCB0aGUgdGFyZ2V0IG1ldGhvZCBpcyBuZXZlciBjYWxsZWQgbW9yZSBmcmVxdWVudGx5IHRoYW4KICAgIHRoZSBzcGVjaWZpZWQgc3BhY2luZyBwZXJpb2QuIFRoZSB0YXJnZXQgbWV0aG9kIGlzIGNhbGxlZCBpbW1lZGlhdGVseS4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHRocm90dGxlIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgZnVuY3Rpb24gd2hvUmFuKCkgewogICAgICBjb25zb2xlLmxvZyh0aGlzLm5hbWUgKyAnIHJhbi4nKTsKICAgIH0KICAKICAgIGxldCBteUNvbnRleHQgPSB7IG5hbWU6ICd0aHJvdHRsZScgfTsKICAKICAgIHRocm90dGxlKG15Q29udGV4dCwgd2hvUmFuLCAxNTApOwogICAgLy8gd2hvUmFuIGlzIGludm9rZWQgd2l0aCBjb250ZXh0IG15Q29udGV4dAogICAgLy8gY29uc29sZSBsb2dzICd0aHJvdHRsZSByYW4uJwogIAogICAgLy8gNTBtcyBwYXNzZXMKICAgIHRocm90dGxlKG15Q29udGV4dCwgd2hvUmFuLCAxNTApOwogIAogICAgLy8gNTBtcyBwYXNzZXMKICAgIHRocm90dGxlKG15Q29udGV4dCwgd2hvUmFuLCAxNTApOwogIAogICAgLy8gMTUwbXMgcGFzc2VzCiAgICB0aHJvdHRsZShteUNvbnRleHQsIHdob1JhbiwgMTUwKTsKICAgIC8vIHdob1JhbiBpcyBpbnZva2VkIHdpdGggY29udGV4dCBteUNvbnRleHQKICAgIC8vIGNvbnNvbGUgbG9ncyAndGhyb3R0bGUgcmFuLicKICAgIGBgYAogIAogICAgQG1ldGhvZCB0aHJvdHRsZQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvcnVubG9vcAogICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIHRhcmdldCBvZiBtZXRob2QgdG8gaW52b2tlCiAgICBAcGFyYW0ge0Z1bmN0aW9ufFN0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlLgogICAgICBNYXkgYmUgYSBmdW5jdGlvbiBvciBhIHN0cmluZy4gSWYgeW91IHBhc3MgYSBzdHJpbmcKICAgICAgdGhlbiBpdCB3aWxsIGJlIGxvb2tlZCB1cCBvbiB0aGUgcGFzc2VkIHRhcmdldC4KICAgIEBwYXJhbSB7T2JqZWN0fSBbYXJncypdIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSB0aW1lb3V0LgogICAgQHBhcmFtIHtOdW1iZXJ9IHNwYWNpbmcgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBzcGFjZSBvdXQgcmVxdWVzdHMuCiAgICBAcGFyYW0ge0Jvb2xlYW59IGltbWVkaWF0ZSBUcmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUgbGVhZGluZyBpbnN0ZWFkCiAgICAgIG9mIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB3YWl0IGludGVydmFsLiBEZWZhdWx0cyB0byB0cnVlLgogICAgQHJldHVybiB7QXJyYXl9IFRpbWVyIGluZm9ybWF0aW9uIGZvciB1c2UgaW4gY2FuY2VsaW5nLCBzZWUgYGNhbmNlbGAuCiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiB0aHJvdHRsZSgpIHsKICAgIHJldHVybiBiYWNrYnVybmVyLnRocm90dGxlLmFwcGx5KGJhY2tidXJuZXIsIGFyZ3VtZW50cyk7CiAgfQp9KTsKZW5pZmVkKCdAZW1iZXIvc2VydmljZS9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1ydW50aW1lJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJSdW50aW1lLCBfZW1iZXJNZXRhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5pbmplY3QgPSBpbmplY3Q7CgoKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvc2VydmljZQogICBAcHVibGljCiAgICovCgogIC8qKgogICAgQ3JlYXRlcyBhIHByb3BlcnR5IHRoYXQgbGF6aWx5IGxvb2tzIHVwIGEgc2VydmljZSBpbiB0aGUgY29udGFpbmVyLiBUaGVyZQogICAgYXJlIG5vIHJlc3RyaWN0aW9ucyBhcyB0byB3aGF0IG9iamVjdHMgYSBzZXJ2aWNlIGNhbiBiZSBpbmplY3RlZCBpbnRvLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIGF1dGhNYW5hZ2VyOiBzZXJ2aWNlKCdhdXRoJyksCiAgCiAgICAgIG1vZGVsKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnYXV0aE1hbmFnZXInKS5maW5kQ3VycmVudFVzZXIoKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgZXhhbXBsZSB3aWxsIGNyZWF0ZSBhbiBgYXV0aE1hbmFnZXJgIHByb3BlcnR5IG9uIHRoZSBhcHBsaWNhdGlvbiByb3V0ZQogICAgdGhhdCBsb29rcyB1cCB0aGUgYGF1dGhgIHNlcnZpY2UgaW4gdGhlIGNvbnRhaW5lciwgbWFraW5nIGl0IGVhc2lseQogICAgYWNjZXNzaWJsZSBpbiB0aGUgYG1vZGVsYCBob29rLgogIAogICAgQG1ldGhvZCBpbmplY3QKICAgIEBzdGF0aWMKICAgIEBzaW5jZSAxLjEwLjAKICAgIEBmb3IgQGVtYmVyL3NlcnZpY2UKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIChvcHRpb25hbCkgbmFtZSBvZiB0aGUgc2VydmljZSB0byBpbmplY3QsIGRlZmF1bHRzIHRvCiAgICAgICAgICAgdGhlIHByb3BlcnR5J3MgbmFtZQogICAgQHJldHVybiB7RW1iZXIuSW5qZWN0ZWRQcm9wZXJ0eX0gaW5qZWN0aW9uIGRlc2NyaXB0b3IgaW5zdGFuY2UKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGluamVjdChuYW1lLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IF9lbWJlck1ldGFsLkluamVjdGVkUHJvcGVydHkoJ3NlcnZpY2UnLCBuYW1lLCBvcHRpb25zKTsKICB9CgogIC8qKgogICAgQGNsYXNzIFNlcnZpY2UKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAc2luY2UgMS4xMC4wCiAgICBAcHVibGljCiAgKi8KICB2YXIgU2VydmljZSA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0LmV4dGVuZCgpOwoKICBTZXJ2aWNlLnJlb3BlbkNsYXNzKHsKICAgIGlzU2VydmljZUZhY3Rvcnk6IHRydWUKICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gU2VydmljZTsKfSk7CmVuaWZlZCgnQGVtYmVyL3N0cmluZy9pbmRleCcsIFsnZXhwb3J0cycsICdAZW1iZXIvc3RyaW5nL2xpYi9zdHJpbmdfcmVnaXN0cnknLCAnZW1iZXItZW52aXJvbm1lbnQnLCAnZW1iZXItdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9zdHJpbmdfcmVnaXN0cnksIF9lbWJlckVudmlyb25tZW50LCBfZW1iZXJVdGlscykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuX3NldFN0cmluZ3MgPSBleHBvcnRzLl9nZXRTdHJpbmdzID0gdW5kZWZpbmVkOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfZ2V0U3RyaW5ncycsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gX3N0cmluZ19yZWdpc3RyeS5nZXRTdHJpbmdzOwogICAgICAgIH0KICAgIH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfc2V0U3RyaW5ncycsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gX3N0cmluZ19yZWdpc3RyeS5zZXRTdHJpbmdzOwogICAgICAgIH0KICAgIH0pOwogICAgZXhwb3J0cy5sb2MgPSBsb2M7CiAgICBleHBvcnRzLncgPSB3OwogICAgZXhwb3J0cy5kZWNhbWVsaXplID0gZGVjYW1lbGl6ZTsKICAgIGV4cG9ydHMuZGFzaGVyaXplID0gZGFzaGVyaXplOwogICAgZXhwb3J0cy5jYW1lbGl6ZSA9IGNhbWVsaXplOwogICAgZXhwb3J0cy5jbGFzc2lmeSA9IGNsYXNzaWZ5OwogICAgZXhwb3J0cy51bmRlcnNjb3JlID0gdW5kZXJzY29yZTsKICAgIGV4cG9ydHMuY2FwaXRhbGl6ZSA9IGNhcGl0YWxpemU7CgogICAgdmFyIFNUUklOR19EQVNIRVJJWkVfUkVHRVhQID0gL1sgX10vZzsKICAgIHZhciBTVFJJTkdfREFTSEVSSVpFX0NBQ0hFID0gbmV3IF9lbWJlclV0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICByZXR1cm4gZGVjYW1lbGl6ZShrZXkpLnJlcGxhY2UoU1RSSU5HX0RBU0hFUklaRV9SRUdFWFAsICctJyk7CiAgICB9KTsKICAgIHZhciBTVFJJTkdfQ0FNRUxJWkVfUkVHRVhQXzEgPSAvKFwtfFxffFwufFxzKSsoLik/L2c7CiAgICB2YXIgU1RSSU5HX0NBTUVMSVpFX1JFR0VYUF8yID0gLyhefFwvKShbQS1aXSkvZzsKICAgIHZhciBDQU1FTElaRV9DQUNIRSA9IG5ldyBfZW1iZXJVdGlscy5DYWNoZSgxMDAwLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleS5yZXBsYWNlKFNUUklOR19DQU1FTElaRV9SRUdFWFBfMSwgZnVuY3Rpb24gKF9tYXRjaCwgX3NlcGFyYXRvciwgY2hyKSB7CiAgICAgICAgICAgIHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnOwogICAgICAgIH0pLnJlcGxhY2UoU1RSSU5HX0NBTUVMSVpFX1JFR0VYUF8yLCBmdW5jdGlvbiAobWF0Y2ggLyosIHNlcGFyYXRvciwgY2hyICovKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaC50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfSk7CiAgICB2YXIgU1RSSU5HX0NMQVNTSUZZX1JFR0VYUF8xID0gL14oXC18XykrKC4pPy87CiAgICB2YXIgU1RSSU5HX0NMQVNTSUZZX1JFR0VYUF8yID0gLyguKShcLXxcX3xcLnxccykrKC4pPy9nOwogICAgdmFyIFNUUklOR19DTEFTU0lGWV9SRUdFWFBfMyA9IC8oXnxcL3xcLikoW2Etel0pL2c7CiAgICB2YXIgQ0xBU1NJRllfQ0FDSEUgPSBuZXcgX2VtYmVyVXRpbHMuQ2FjaGUoMTAwMCwgZnVuY3Rpb24gKHN0cikgewogICAgICAgIHZhciByZXBsYWNlMSA9IGZ1bmN0aW9uIChfbWF0Y2gsIF9zZXBhcmF0b3IsIGNocikgewogICAgICAgICAgICByZXR1cm4gY2hyID8gJ18nICsgY2hyLnRvVXBwZXJDYXNlKCkgOiAnJzsKICAgICAgICB9OwogICAgICAgIHZhciByZXBsYWNlMiA9IGZ1bmN0aW9uIChfbWF0Y2gsIGluaXRpYWxDaGFyLCBfc2VwYXJhdG9yLCBjaHIpIHsKICAgICAgICAgICAgcmV0dXJuIGluaXRpYWxDaGFyICsgKGNociA/IGNoci50b1VwcGVyQ2FzZSgpIDogJycpOwogICAgICAgIH07CiAgICAgICAgdmFyIHBhcnRzID0gc3RyLnNwbGl0KCcvJyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBwYXJ0c1tpXSA9IHBhcnRzW2ldLnJlcGxhY2UoU1RSSU5HX0NMQVNTSUZZX1JFR0VYUF8xLCByZXBsYWNlMSkucmVwbGFjZShTVFJJTkdfQ0xBU1NJRllfUkVHRVhQXzIsIHJlcGxhY2UyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKS5yZXBsYWNlKFNUUklOR19DTEFTU0lGWV9SRUdFWFBfMywgZnVuY3Rpb24gKG1hdGNoIC8qLCBzZXBhcmF0b3IsIGNociAqLykgewogICAgICAgICAgICByZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKICAgICAgICB9KTsKICAgIH0pOwogICAgdmFyIFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8xID0gLyhbYS16XGRdKShbQS1aXSspL2c7CiAgICB2YXIgU1RSSU5HX1VOREVSU0NPUkVfUkVHRVhQXzIgPSAvXC18XHMrL2c7CiAgICB2YXIgVU5ERVJTQ09SRV9DQUNIRSA9IG5ldyBfZW1iZXJVdGlscy5DYWNoZSgxMDAwLCBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8xLCAnJDFfJDInKS5yZXBsYWNlKFNUUklOR19VTkRFUlNDT1JFX1JFR0VYUF8yLCAnXycpLnRvTG93ZXJDYXNlKCk7CiAgICB9KTsKICAgIHZhciBTVFJJTkdfQ0FQSVRBTElaRV9SRUdFWFAgPSAvKF58XC8pKFthLXpcdTAwQzAtXHUwMjRGXSkvZzsKICAgIHZhciBDQVBJVEFMSVpFX0NBQ0hFID0gbmV3IF9lbWJlclV0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoU1RSSU5HX0NBUElUQUxJWkVfUkVHRVhQLCBmdW5jdGlvbiAobWF0Y2ggLyosIHNlcGFyYXRvciwgY2hyICovKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaC50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0pOwogICAgfSk7CiAgICB2YXIgU1RSSU5HX0RFQ0FNRUxJWkVfUkVHRVhQID0gLyhbYS16XGRdKShbQS1aXSkvZzsKICAgIHZhciBERUNBTUVMSVpFX0NBQ0hFID0gbmV3IF9lbWJlclV0aWxzLkNhY2hlKDEwMDAsIGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoU1RSSU5HX0RFQ0FNRUxJWkVfUkVHRVhQLCAnJDFfJDInKS50b0xvd2VyQ2FzZSgpOwogICAgfSk7CiAgICAvKioKICAgICAgRGVmaW5lcyBzdHJpbmcgaGVscGVyIG1ldGhvZHMgaW5jbHVkaW5nIHN0cmluZyBmb3JtYXR0aW5nIGFuZCBsb2NhbGl6YXRpb24uCiAgICAgIFVubGVzcyBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nYCBpcyBgZmFsc2VgIHRoZXNlIG1ldGhvZHMgd2lsbCBhbHNvIGJlCiAgICAgIGFkZGVkIHRvIHRoZSBgU3RyaW5nLnByb3RvdHlwZWAgYXMgd2VsbC4KICAgIAogICAgICBAY2xhc3MgU3RyaW5nCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBfZm10KHN0ciwgZm9ybWF0cykgewogICAgICAgIC8vIGZpcnN0LCByZXBsYWNlIGFueSBPUkRFUkVEIHJlcGxhY2VtZW50cy4KICAgICAgICB2YXIgaWR4ID0gMDsgLy8gdGhlIGN1cnJlbnQgaW5kZXggZm9yIG5vbi1udW1lcmljYWwgcmVwbGFjZW1lbnRzCiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8lQChbMC05XSspPy9nLCBmdW5jdGlvbiAoX3MsIGFyZ0luZGV4KSB7CiAgICAgICAgICAgIHZhciBpID0gYXJnSW5kZXggPyBwYXJzZUludChhcmdJbmRleCwgMTApIC0gMSA6IGlkeCsrOwogICAgICAgICAgICB2YXIgciA9IGkgPCBmb3JtYXRzLmxlbmd0aCA/IGZvcm1hdHNbaV0gOiB1bmRlZmluZWQ7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgciA9PT0gJ3N0cmluZycgPyByIDogciA9PT0gbnVsbCA/ICcobnVsbCknIDogciA9PT0gdW5kZWZpbmVkID8gJycgOiAnJyArIHI7CiAgICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAgRm9ybWF0cyB0aGUgcGFzc2VkIHN0cmluZywgYnV0IGZpcnN0IGxvb2tzIHVwIHRoZSBzdHJpbmcgaW4gdGhlIGxvY2FsaXplZAogICAgICBzdHJpbmdzIGhhc2guIFRoaXMgaXMgYSBjb252ZW5pZW50IHdheSB0byBsb2NhbGl6ZSB0ZXh0LgogICAgCiAgICAgIE5vdGUgdGhhdCBpdCBpcyB0cmFkaXRpb25hbCBidXQgbm90IHJlcXVpcmVkIHRvIHByZWZpeCBsb2NhbGl6ZWQgc3RyaW5nCiAgICAgIGtleXMgd2l0aCBhbiB1bmRlcnNjb3JlIG9yIG90aGVyIGNoYXJhY3RlciBzbyB5b3UgY2FuIGVhc2lseSBpZGVudGlmeQogICAgICBsb2NhbGl6ZWQgc3RyaW5ncy4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGxvYyB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgCiAgICAgIEVtYmVyLlNUUklOR1MgPSB7CiAgICAgICAgJ19IZWxsbyBXb3JsZCc6ICdCb25qb3VyIGxlIG1vbmRlJywKICAgICAgICAnX0hlbGxvICVAICVAJzogJ0JvbmpvdXIgJUAgJUAnCiAgICAgIH07CiAgICAKICAgICAgbG9jKCJfSGVsbG8gV29ybGQiKTsgIC8vICdCb25qb3VyIGxlIG1vbmRlJzsKICAgICAgbG9jKCJfSGVsbG8gJUAgJUAiLCBbIkpvaG4iLCAiU21pdGgiXSk7ICAvLyAiQm9uam91ciBKb2huIFNtaXRoIjsKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBsb2MKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdAogICAgICBAcGFyYW0ge0FycmF5fSBmb3JtYXRzIE9wdGlvbmFsIGFycmF5IG9mIHBhcmFtZXRlcnMgdG8gaW50ZXJwb2xhdGUgaW50byBzdHJpbmcuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gZm9ybWF0dGVkIHN0cmluZwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gbG9jKHN0ciwgZm9ybWF0cykgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShmb3JtYXRzKSB8fCBhcmd1bWVudHMubGVuZ3RoID4gMikgewogICAgICAgICAgICBmb3JtYXRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICB9CiAgICAgICAgc3RyID0gKDAsIF9zdHJpbmdfcmVnaXN0cnkuZ2V0U3RyaW5nKShzdHIpIHx8IHN0cjsKICAgICAgICByZXR1cm4gX2ZtdChzdHIsIGZvcm1hdHMpOwogICAgfQogICAgLyoqCiAgICAgIFNwbGl0cyBhIHN0cmluZyBpbnRvIHNlcGFyYXRlIHVuaXRzIHNlcGFyYXRlZCBieSBzcGFjZXMsIGVsaW1pbmF0aW5nIGFueQogICAgICBlbXB0eSBzdHJpbmdzIGluIHRoZSBwcm9jZXNzLiBUaGlzIGlzIGEgY29udmVuaWVuY2UgbWV0aG9kIGZvciBzcGxpdCB0aGF0CiAgICAgIGlzIG1vc3RseSB1c2VmdWwgd2hlbiBhcHBsaWVkIHRvIHRoZSBgU3RyaW5nLnByb3RvdHlwZWAuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyB3IH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAKICAgICAgdygiYWxwaGEgYmV0YSBnYW1tYSIpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgY29uc29sZS5sb2coa2V5KTsKICAgICAgfSk7CiAgICAKICAgICAgLy8gPiBhbHBoYQogICAgICAvLyA+IGJldGEKICAgICAgLy8gPiBnYW1tYQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIHcKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIHNwbGl0CiAgICAgIEByZXR1cm4ge0FycmF5fSBhcnJheSBjb250YWluaW5nIHRoZSBzcGxpdCBzdHJpbmdzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiB3KHN0cikgewogICAgICAgIHJldHVybiBzdHIuc3BsaXQoL1xzKy8pOwogICAgfQogICAgLyoqCiAgICAgIENvbnZlcnRzIGEgY2FtZWxpemVkIHN0cmluZyBpbnRvIGFsbCBsb3dlciBjYXNlIHNlcGFyYXRlZCBieSB1bmRlcnNjb3Jlcy4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICdpbm5lckhUTUwnLmRlY2FtZWxpemUoKTsgICAgICAgICAgIC8vICdpbm5lcl9odG1sJwogICAgICAnYWN0aW9uX25hbWUnLmRlY2FtZWxpemUoKTsgICAgICAgIC8vICdhY3Rpb25fbmFtZScKICAgICAgJ2Nzcy1jbGFzcy1uYW1lJy5kZWNhbWVsaXplKCk7ICAgICAvLyAnY3NzLWNsYXNzLW5hbWUnCiAgICAgICdteSBmYXZvcml0ZSBpdGVtcycuZGVjYW1lbGl6ZSgpOyAgLy8gJ215IGZhdm9yaXRlIGl0ZW1zJwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGRlY2FtZWxpemUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGRlY2FtZWxpemUuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGRlY2FtZWxpemVkIHN0cmluZy4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGRlY2FtZWxpemUoc3RyKSB7CiAgICAgICAgcmV0dXJuIERFQ0FNRUxJWkVfQ0FDSEUuZ2V0KHN0cik7CiAgICB9CiAgICAvKioKICAgICAgUmVwbGFjZXMgdW5kZXJzY29yZXMsIHNwYWNlcywgb3IgY2FtZWxDYXNlIHdpdGggZGFzaGVzLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgJ2lubmVySFRNTCcuZGFzaGVyaXplKCk7ICAgICAgICAgIC8vICdpbm5lci1odG1sJwogICAgICAnYWN0aW9uX25hbWUnLmRhc2hlcml6ZSgpOyAgICAgICAgLy8gJ2FjdGlvbi1uYW1lJwogICAgICAnY3NzLWNsYXNzLW5hbWUnLmRhc2hlcml6ZSgpOyAgICAgLy8gJ2Nzcy1jbGFzcy1uYW1lJwogICAgICAnbXkgZmF2b3JpdGUgaXRlbXMnLmRhc2hlcml6ZSgpOyAgLy8gJ215LWZhdm9yaXRlLWl0ZW1zJwogICAgICAncHJpdmF0ZURvY3Mvb3duZXJJbnZvaWNlJy5kYXNoZXJpemUoKTsgLy8gJ3ByaXZhdGUtZG9jcy9vd25lci1pbnZvaWNlJwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGRhc2hlcml6ZQogICAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gZGFzaGVyaXplLgogICAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSBkYXNoZXJpemVkIHN0cmluZy4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGRhc2hlcml6ZShzdHIpIHsKICAgICAgICByZXR1cm4gU1RSSU5HX0RBU0hFUklaRV9DQUNIRS5nZXQoc3RyKTsKICAgIH0KICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSBsb3dlckNhbWVsQ2FzZSBmb3JtIG9mIGEgc3RyaW5nLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgJ2lubmVySFRNTCcuY2FtZWxpemUoKTsgICAgICAgICAgLy8gJ2lubmVySFRNTCcKICAgICAgJ2FjdGlvbl9uYW1lJy5jYW1lbGl6ZSgpOyAgICAgICAgLy8gJ2FjdGlvbk5hbWUnCiAgICAgICdjc3MtY2xhc3MtbmFtZScuY2FtZWxpemUoKTsgICAgIC8vICdjc3NDbGFzc05hbWUnCiAgICAgICdteSBmYXZvcml0ZSBpdGVtcycuY2FtZWxpemUoKTsgIC8vICdteUZhdm9yaXRlSXRlbXMnCiAgICAgICdNeSBGYXZvcml0ZSBJdGVtcycuY2FtZWxpemUoKTsgIC8vICdteUZhdm9yaXRlSXRlbXMnCiAgICAgICdwcml2YXRlLWRvY3Mvb3duZXItaW52b2ljZScuY2FtZWxpemUoKTsgLy8gJ3ByaXZhdGVEb2NzL293bmVySW52b2ljZScKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBjYW1lbGl6ZQogICAgICBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gY2FtZWxpemUuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGNhbWVsaXplZCBzdHJpbmcuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBjYW1lbGl6ZShzdHIpIHsKICAgICAgICByZXR1cm4gQ0FNRUxJWkVfQ0FDSEUuZ2V0KHN0cik7CiAgICB9CiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgVXBwZXJDYW1lbENhc2UgZm9ybSBvZiBhIHN0cmluZy4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICdpbm5lckhUTUwnLmNsYXNzaWZ5KCk7ICAgICAgICAgIC8vICdJbm5lckhUTUwnCiAgICAgICdhY3Rpb25fbmFtZScuY2xhc3NpZnkoKTsgICAgICAgIC8vICdBY3Rpb25OYW1lJwogICAgICAnY3NzLWNsYXNzLW5hbWUnLmNsYXNzaWZ5KCk7ICAgICAvLyAnQ3NzQ2xhc3NOYW1lJwogICAgICAnbXkgZmF2b3JpdGUgaXRlbXMnLmNsYXNzaWZ5KCk7ICAvLyAnTXlGYXZvcml0ZUl0ZW1zJwogICAgICAncHJpdmF0ZS1kb2NzL293bmVyLWludm9pY2UnLmNsYXNzaWZ5KCk7IC8vICdQcml2YXRlRG9jcy9Pd25lckludm9pY2UnCiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgY2xhc3NpZnkKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciB0aGUgc3RyaW5nIHRvIGNsYXNzaWZ5CiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIGNsYXNzaWZpZWQgc3RyaW5nCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBjbGFzc2lmeShzdHIpIHsKICAgICAgICByZXR1cm4gQ0xBU1NJRllfQ0FDSEUuZ2V0KHN0cik7CiAgICB9CiAgICAvKioKICAgICAgTW9yZSBnZW5lcmFsIHRoYW4gZGVjYW1lbGl6ZS4gUmV0dXJucyB0aGUgbG93ZXJcX2Nhc2VcX2FuZFxfdW5kZXJzY29yZWQKICAgICAgZm9ybSBvZiBhIHN0cmluZy4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICdpbm5lckhUTUwnLnVuZGVyc2NvcmUoKTsgICAgICAgICAgLy8gJ2lubmVyX2h0bWwnCiAgICAgICdhY3Rpb25fbmFtZScudW5kZXJzY29yZSgpOyAgICAgICAgLy8gJ2FjdGlvbl9uYW1lJwogICAgICAnY3NzLWNsYXNzLW5hbWUnLnVuZGVyc2NvcmUoKTsgICAgIC8vICdjc3NfY2xhc3NfbmFtZScKICAgICAgJ215IGZhdm9yaXRlIGl0ZW1zJy51bmRlcnNjb3JlKCk7ICAvLyAnbXlfZmF2b3JpdGVfaXRlbXMnCiAgICAgICdwcml2YXRlRG9jcy9vd25lckludm9pY2UnLnVuZGVyc2NvcmUoKTsgLy8gJ3ByaXZhdGVfZG9jcy9vd25lcl9pbnZvaWNlJwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIHVuZGVyc2NvcmUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIHVuZGVyc2NvcmUuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIHVuZGVyc2NvcmVkIHN0cmluZy4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIHVuZGVyc2NvcmUoc3RyKSB7CiAgICAgICAgcmV0dXJuIFVOREVSU0NPUkVfQ0FDSEUuZ2V0KHN0cik7CiAgICB9CiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgQ2FwaXRhbGl6ZWQgZm9ybSBvZiBhIHN0cmluZwogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgJ2lubmVySFRNTCcuY2FwaXRhbGl6ZSgpICAgICAgICAgLy8gJ0lubmVySFRNTCcKICAgICAgJ2FjdGlvbl9uYW1lJy5jYXBpdGFsaXplKCkgICAgICAgLy8gJ0FjdGlvbl9uYW1lJwogICAgICAnY3NzLWNsYXNzLW5hbWUnLmNhcGl0YWxpemUoKSAgICAvLyAnQ3NzLWNsYXNzLW5hbWUnCiAgICAgICdteSBmYXZvcml0ZSBpdGVtcycuY2FwaXRhbGl6ZSgpIC8vICdNeSBmYXZvcml0ZSBpdGVtcycKICAgICAgJ3ByaXZhdGVEb2NzL293bmVySW52b2ljZScuY2FwaXRhbGl6ZSgpOyAvLyAnUHJpdmF0ZURvY3Mvb3duZXJJbnZvaWNlJwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGNhcGl0YWxpemUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGNhcGl0YWxpemUuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGNhcGl0YWxpemVkIHN0cmluZy4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGNhcGl0YWxpemUoc3RyKSB7CiAgICAgICAgcmV0dXJuIENBUElUQUxJWkVfQ0FDSEUuZ2V0KHN0cik7CiAgICB9CiAgICBpZiAoX2VtYmVyRW52aXJvbm1lbnQuRU5WLkVYVEVORF9QUk9UT1RZUEVTLlN0cmluZykgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFN0cmluZy5wcm90b3R5cGUsIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgU2VlIFtTdHJpbmcud10oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvdz9hbmNob3I9dykuCiAgICAgICAgICAgICAgICAgICBAbWV0aG9kIHcKICAgICAgICAgICAgICBAZm9yIEBlbWJlci9zdHJpbmcKICAgICAgICAgICAgICBAc3RhdGljCiAgICAgICAgICAgICAgQHByaXZhdGUKICAgICAgICAgICAgKi8KICAgICAgICAgICAgdzogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3KHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICBTZWUgW1N0cmluZy5sb2NdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL2xvYz9hbmNob3I9bG9jKS4KICAgICAgICAgICAgICAgICAgIEBtZXRob2QgbG9jCiAgICAgICAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgICAgICAgQHN0YXRpYwogICAgICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgICAgICovCiAgICAgICAgICAgIGxvYzogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9jKHRoaXMsIGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICBTZWUgW1N0cmluZy5jYW1lbGl6ZV0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvY2FtZWxpemU/YW5jaG9yPWNhbWVsaXplKS4KICAgICAgICAgICAgICAgICAgIEBtZXRob2QgY2FtZWxpemUKICAgICAgICAgICAgICBAZm9yIEBlbWJlci9zdHJpbmcKICAgICAgICAgICAgICBAc3RhdGljCiAgICAgICAgICAgICAgQHByaXZhdGUKICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FtZWxpemU6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgd3JpdGVhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FtZWxpemUodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgIFNlZSBbU3RyaW5nLmRlY2FtZWxpemVdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1N0cmluZy9tZXRob2RzL2RlY2FtZWxpemU/YW5jaG9yPWRlY2FtZWxpemUpLgogICAgICAgICAgICAgICAgICAgQG1ldGhvZCBkZWNhbWVsaXplCiAgICAgICAgICAgICAgQGZvciBAZW1iZXIvc3RyaW5nCiAgICAgICAgICAgICAgQHN0YXRpYwogICAgICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgICAgICovCiAgICAgICAgICAgIGRlY2FtZWxpemU6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgd3JpdGVhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVjYW1lbGl6ZSh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgU2VlIFtTdHJpbmcuZGFzaGVyaXplXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9kYXNoZXJpemU/YW5jaG9yPWRhc2hlcml6ZSkuCiAgICAgICAgICAgICAgICAgICBAbWV0aG9kIGRhc2hlcml6ZQogICAgICAgICAgICAgIEBmb3IgQGVtYmVyL3N0cmluZwogICAgICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICAqLwogICAgICAgICAgICBkYXNoZXJpemU6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgd3JpdGVhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGFzaGVyaXplKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICBTZWUgW1N0cmluZy51bmRlcnNjb3JlXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy91bmRlcnNjb3JlP2FuY2hvcj11bmRlcnNjb3JlKS4KICAgICAgICAgICAgICAgICAgIEBtZXRob2QgdW5kZXJzY29yZQogICAgICAgICAgICAgIEBmb3IgQGVtYmVyL3N0cmluZwogICAgICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICAqLwogICAgICAgICAgICB1bmRlcnNjb3JlOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHdyaXRlYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVyc2NvcmUodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgIFNlZSBbU3RyaW5nLmNsYXNzaWZ5XSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9jbGFzc2lmeT9hbmNob3I9Y2xhc3NpZnkpLgogICAgICAgICAgICAgICAgICAgQG1ldGhvZCBjbGFzc2lmeQogICAgICAgICAgICAgIEBmb3IgQGVtYmVyL3N0cmluZwogICAgICAgICAgICAgIEBzdGF0aWMKICAgICAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICAqLwogICAgICAgICAgICBjbGFzc2lmeTogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc2lmeSh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgU2VlIFtTdHJpbmcuY2FwaXRhbGl6ZV0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvU3RyaW5nL21ldGhvZHMvY2FwaXRhbGl6ZT9hbmNob3I9Y2FwaXRhbGl6ZSkuCiAgICAgICAgICAgICAgICAgICBAbWV0aG9kIGNhcGl0YWxpemUKICAgICAgICAgICAgICBAZm9yIEBlbWJlci9zdHJpbmcKICAgICAgICAgICAgICBAc3RhdGljCiAgICAgICAgICAgICAgQHByaXZhdGUKICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FwaXRhbGl6ZTogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB3cml0ZWFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYXBpdGFsaXplKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyMgc291cmNlTWFwcGluZ1VSTD1pbmRleC5qcy5tYXAKfSk7CmVuaWZlZCgiQGVtYmVyL3N0cmluZy9saWIvc3RyaW5nX3JlZ2lzdHJ5IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgZXhwb3J0cy5zZXRTdHJpbmdzID0gc2V0U3RyaW5nczsKICAgIGV4cG9ydHMuZ2V0U3RyaW5ncyA9IGdldFN0cmluZ3M7CiAgICBleHBvcnRzLmdldFN0cmluZyA9IGdldFN0cmluZzsKICAgIC8vIFNUQVRFIHdpdGhpbiBhIG1vZHVsZSBpcyBmcm93bmVkIHVwb24sIHRoaXMgZXhpc3RzCiAgICAvLyB0byBzdXBwb3J0IEVtYmVyLlNUUklOR1MgYnV0IHNoaWVsZCBlbWJlciBpbnRlcm5hbHMgZnJvbSB0aGlzIGxlZ2FjeSBnbG9iYWwKICAgIC8vIEFQSS4KICAgIHZhciBTVFJJTkdTID0ge307CiAgICBmdW5jdGlvbiBzZXRTdHJpbmdzKHN0cmluZ3MpIHsKICAgICAgICBTVFJJTkdTID0gc3RyaW5nczsKICAgIH0KICAgIGZ1bmN0aW9uIGdldFN0cmluZ3MoKSB7CiAgICAgICAgcmV0dXJuIFNUUklOR1M7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRTdHJpbmcobmFtZSkgewogICAgICAgIHJldHVybiBTVFJJTkdTW25hbWVdOwogICAgfQogICAgLy8jIHNvdXJjZU1hcHBpbmdVUkw9c3RyaW5nX3JlZ2lzdHJ5LmpzLm1hcAp9KTsKZW5pZmVkKCdAZ2xpbW1lci9lbmNvZGVyJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuSW5zdHJ1Y3Rpb25FbmNvZGVyID0gdW5kZWZpbmVkOwoKICAgIHZhciBJbnN0cnVjdGlvbkVuY29kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gSW5zdHJ1Y3Rpb25FbmNvZGVyKGJ1ZmZlcikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEluc3RydWN0aW9uRW5jb2Rlcik7CgogICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgdGhpcy50eXBlUG9zID0gMDsKICAgICAgICAgICAgdGhpcy5zaXplID0gMDsKICAgICAgICB9CgogICAgICAgIEluc3RydWN0aW9uRW5jb2Rlci5wcm90b3R5cGUuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKHR5cGUsIG1hY2hpbmUpIHsKICAgICAgICAgICAgaWYgKHR5cGUgPiAyNTUgLyogVFlQRV9TSVpFICovKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcGNvZGUgdHlwZSBvdmVyIDgtYml0cy4gR290ICcgKyB0eXBlICsgJy4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWZmZXIucHVzaCh0eXBlIHwgbWFjaGluZSB8IGFyZ3VtZW50cy5sZW5ndGggLSAyIDw8IDggLyogQVJHX1NISUZUICovKTsKICAgICAgICAgICAgdGhpcy50eXBlUG9zID0gdGhpcy5idWZmZXIubGVuZ3RoIC0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBvcCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3AgPT09ICdudW1iZXInICYmIG9wID4gNjU1MzUgLyogTUFYX1NJWkUgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcGVyYW5kIG92ZXIgMTYtYml0cy4gR290ICcgKyBvcCArICcuJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5idWZmZXIucHVzaChvcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zaXplID0gdGhpcy5idWZmZXIubGVuZ3RoOwogICAgICAgIH07CgogICAgICAgIEluc3RydWN0aW9uRW5jb2Rlci5wcm90b3R5cGUucGF0Y2ggPSBmdW5jdGlvbiBwYXRjaChwb3NpdGlvbiwgdGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlcltwb3NpdGlvbiArIDFdID09PSAtMSkgewogICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbcG9zaXRpb24gKyAxXSA9IHRhcmdldDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHBhdGNoIG9wZXJhbmQgaW4gcG9wdWxhdGVkIHNsb3QgaW5zdGVhZCBvZiBhIHJlc2VydmVkIHNsb3QuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBJbnN0cnVjdGlvbkVuY29kZXIucHJvdG90eXBlLnBhdGNoV2l0aCA9IGZ1bmN0aW9uIHBhdGNoV2l0aChwb3NpdGlvbiwgdGFyZ2V0LCBvcGVyYW5kKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlcltwb3NpdGlvbiArIDFdID09PSAtMSkgewogICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbcG9zaXRpb24gKyAxXSA9IHRhcmdldDsKICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW3Bvc2l0aW9uICsgMl0gPSBvcGVyYW5kOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gcGF0Y2ggb3BlcmFuZCBpbiBwb3B1bGF0ZWQgc2xvdCBpbnN0ZWFkIG9mIGEgcmVzZXJ2ZWQgc2xvdC4nKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBJbnN0cnVjdGlvbkVuY29kZXI7CiAgICB9KCk7CgogICAgZXhwb3J0cy5JbnN0cnVjdGlvbkVuY29kZXIgPSBJbnN0cnVjdGlvbkVuY29kZXI7Cn0pOwplbmlmZWQoJ0BnbGltbWVyL2xvdy1sZXZlbCcsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLlN0YWNrID0gZXhwb3J0cy5TdG9yYWdlID0gdW5kZWZpbmVkOwoKICAgIHZhciBTdG9yYWdlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFN0b3JhZ2UoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU3RvcmFnZSk7CgogICAgICAgICAgICB0aGlzLmFycmF5ID0gW107CiAgICAgICAgICAgIHRoaXMubmV4dCA9IDA7CiAgICAgICAgfQoKICAgICAgICBTdG9yYWdlLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgc2xvdCA9IHRoaXMubmV4dCwKICAgICAgICAgICAgICAgIGFycmF5ID0gdGhpcy5hcnJheTsKCiAgICAgICAgICAgIGlmIChzbG90ID09PSBhcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXMubmV4dCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHByZXYgPSBhcnJheVtzbG90XTsKICAgICAgICAgICAgICAgIHRoaXMubmV4dCA9IHByZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hcnJheVtzbG90XSA9IGVsZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBzbG90OwogICAgICAgIH07CgogICAgICAgIFN0b3JhZ2UucHJvdG90eXBlLmRlcmVmID0gZnVuY3Rpb24gZGVyZWYocG9pbnRlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVtwb2ludGVyXTsKICAgICAgICB9OwoKICAgICAgICBTdG9yYWdlLnByb3RvdHlwZS5kcm9wID0gZnVuY3Rpb24gZHJvcChwb2ludGVyKSB7CiAgICAgICAgICAgIHRoaXMuYXJyYXlbcG9pbnRlcl0gPSB0aGlzLm5leHQ7CiAgICAgICAgICAgIHRoaXMubmV4dCA9IHBvaW50ZXI7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFN0b3JhZ2U7CiAgICB9KCk7CgogICAgdmFyIFN0YWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFN0YWNrKCkgewogICAgICAgICAgICB2YXIgdmVjID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBbXTsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTdGFjayk7CgogICAgICAgICAgICB0aGlzLnZlYyA9IHZlYzsKICAgICAgICB9CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uIGNsb25lKCkgewogICAgICAgICAgICByZXR1cm4gbmV3IFN0YWNrKHRoaXMudmVjLnNsaWNlKCkpOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS5zbGljZUZyb20gPSBmdW5jdGlvbiBzbGljZUZyb20oc3RhcnQpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTdGFjayh0aGlzLnZlYy5zbGljZShzdGFydCkpOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlKHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTdGFjayh0aGlzLnZlYy5zbGljZShzdGFydCwgZW5kKSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RhY2sucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5KGZyb20sIHRvKSB7CiAgICAgICAgICAgIHRoaXMudmVjW3RvXSA9IHRoaXMudmVjW2Zyb21dOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS53cml0ZVJhdyA9IGZ1bmN0aW9uIHdyaXRlUmF3KHBvcywgdmFsdWUpIHsKICAgICAgICAgICAgLy8gVE9ETzogR3Jvdz8KICAgICAgICAgICAgdGhpcy52ZWNbcG9zXSA9IHZhbHVlOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS53cml0ZVNtaSA9IGZ1bmN0aW9uIHdyaXRlU21pKHBvcywgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy52ZWNbcG9zXSA9IGVuY29kZVNtaSh2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RhY2sucHJvdG90eXBlLmdldFJhdyA9IGZ1bmN0aW9uIGdldFJhdyhwb3MpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmVjW3Bvc107CiAgICAgICAgfTsKCiAgICAgICAgU3RhY2sucHJvdG90eXBlLmdldFNtaSA9IGZ1bmN0aW9uIGdldFNtaShwb3MpIHsKICAgICAgICAgICAgcmV0dXJuIGRlY29kZVNtaSh0aGlzLnZlY1twb3NdKTsKICAgICAgICB9OwoKICAgICAgICBTdGFjay5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICAgICAgdGhpcy52ZWMubGVuZ3RoID0gMDsKICAgICAgICB9OwoKICAgICAgICBTdGFjay5wcm90b3R5cGUubGVuID0gZnVuY3Rpb24gbGVuKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52ZWMubGVuZ3RoOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBTdGFjazsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBkZWNvZGVTbWkoc21pKSB7CiAgICAgICAgc3dpdGNoIChzbWkgJiA3KSB7CiAgICAgICAgICAgIGNhc2UgMCAvKiBOVU1CRVIgKi86CiAgICAgICAgICAgICAgICByZXR1cm4gc21pID4+IDM7CiAgICAgICAgICAgIGNhc2UgNCAvKiBORUdBVElWRSAqLzoKICAgICAgICAgICAgICAgIHJldHVybiAtKHNtaSA+PiAzKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndW5yZWFjaGFibGUnKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBlbmNvZGVTbWkocHJpbWl0aXZlKSB7CiAgICAgICAgaWYgKHByaW1pdGl2ZSA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguYWJzKHByaW1pdGl2ZSkgPDwgMyB8IDQgLyogTkVHQVRJVkUgKi87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByaW1pdGl2ZSA8PCAzIHwgMCAvKiBOVU1CRVIgKi87CiAgICAgICAgfQogICAgfQoKICAgIGV4cG9ydHMuU3RvcmFnZSA9IFN0b3JhZ2U7CiAgICBleHBvcnRzLlN0YWNrID0gU3RhY2s7Cn0pOwplbmlmZWQoJ0BnbGltbWVyL25vZGUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnQGdsaW1tZXIvcnVudGltZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9ydW50aW1lKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5zZXJpYWxpemVCdWlsZGVyID0gZXhwb3J0cy5Ob2RlRE9NVHJlZUNvbnN0cnVjdGlvbiA9IHVuZGVmaW5lZDsKCiAgICB2YXIgTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb24gPSBmdW5jdGlvbiAoX0RPTVRyZWVDb25zdHJ1Y3Rpb24pIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKE5vZGVET01UcmVlQ29uc3RydWN0aW9uLCBfRE9NVHJlZUNvbnN0cnVjdGlvbik7CgogICAgICAgIGZ1bmN0aW9uIE5vZGVET01UcmVlQ29uc3RydWN0aW9uKGRvYykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE5vZGVET01UcmVlQ29uc3RydWN0aW9uKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRE9NVHJlZUNvbnN0cnVjdGlvbi5jYWxsKHRoaXMsIGRvYykpOwogICAgICAgIH0KICAgICAgICAvLyBvdmVycmlkZSB0byBwcmV2ZW50IHVzYWdlIG9mIGB0aGlzLmRvY3VtZW50YCB1bnRpbCBhZnRlciB0aGUgY29uc3RydWN0b3IKCgogICAgICAgIE5vZGVET01UcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZS5zZXR1cFVzZWxlc3NFbGVtZW50ID0gZnVuY3Rpb24gc2V0dXBVc2VsZXNzRWxlbWVudCgpIHt9OwoKICAgICAgICBOb2RlRE9NVHJlZUNvbnN0cnVjdGlvbi5wcm90b3R5cGUuaW5zZXJ0SFRNTEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEhUTUxCZWZvcmUocGFyZW50LCByZWZlcmVuY2UsIGh0bWwpIHsKICAgICAgICAgICAgdmFyIHByZXYgPSByZWZlcmVuY2UgPyByZWZlcmVuY2UucHJldmlvdXNTaWJsaW5nIDogcGFyZW50Lmxhc3RDaGlsZDsKICAgICAgICAgICAgdmFyIHJhdyA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlUmF3SFRNTFNlY3Rpb24oaHRtbCk7CiAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUocmF3LCByZWZlcmVuY2UpOwogICAgICAgICAgICB2YXIgZmlyc3QgPSBwcmV2ID8gcHJldi5uZXh0U2libGluZyA6IHBhcmVudC5maXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdCA9IHJlZmVyZW5jZSA/IHJlZmVyZW5jZS5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOwogICAgICAgICAgICByZXR1cm4gbmV3IF9ydW50aW1lLkNvbmNyZXRlQm91bmRzKHBhcmVudCwgZmlyc3QsIGxhc3QpOwogICAgICAgIH07CgogICAgICAgIE5vZGVET01UcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZS5jcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gY3JlYXRlRWxlbWVudCh0YWcpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpOwogICAgICAgIH07CgogICAgICAgIE5vZGVET01UcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBOb2RlRE9NVHJlZUNvbnN0cnVjdGlvbjsKICAgIH0oX3J1bnRpbWUuRE9NVHJlZUNvbnN0cnVjdGlvbik7CgogICAgdmFyIFRFWFRfTk9ERSA9IDM7CiAgICBmdW5jdGlvbiBjdXJyZW50Tm9kZShjdXJzb3IpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGN1cnNvci5lbGVtZW50LAogICAgICAgICAgICBuZXh0U2libGluZyA9IGN1cnNvci5uZXh0U2libGluZzsKCiAgICAgICAgaWYgKG5leHRTaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lmxhc3RDaGlsZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgU2VyaWFsaXplQnVpbGRlciA9IGZ1bmN0aW9uIChfTmV3RWxlbWVudEJ1aWxkZXIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNlcmlhbGl6ZUJ1aWxkZXIsIF9OZXdFbGVtZW50QnVpbGRlcik7CgogICAgICAgIGZ1bmN0aW9uIFNlcmlhbGl6ZUJ1aWxkZXIoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU2VyaWFsaXplQnVpbGRlcik7CgogICAgICAgICAgICB2YXIgX3RoaXMyID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9OZXdFbGVtZW50QnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKCiAgICAgICAgICAgIF90aGlzMi5zZXJpYWxpemVCbG9ja0RlcHRoID0gMDsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMjsKICAgICAgICB9CgogICAgICAgIFNlcmlhbGl6ZUJ1aWxkZXIucHJvdG90eXBlLl9fb3BlbkJsb2NrID0gZnVuY3Rpb24gX19vcGVuQmxvY2soKSB7CiAgICAgICAgICAgIHZhciBkZXB0aCA9IHRoaXMuc2VyaWFsaXplQmxvY2tEZXB0aCsrOwogICAgICAgICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJStiOicgKyBkZXB0aCArICclJyk7CiAgICAgICAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19vcGVuQmxvY2suY2FsbCh0aGlzKTsKICAgICAgICB9OwoKICAgICAgICBTZXJpYWxpemVCdWlsZGVyLnByb3RvdHlwZS5fX2Nsb3NlQmxvY2sgPSBmdW5jdGlvbiBfX2Nsb3NlQmxvY2soKSB7CiAgICAgICAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19jbG9zZUJsb2NrLmNhbGwodGhpcyk7CiAgICAgICAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KCclLWI6JyArIC0tdGhpcy5zZXJpYWxpemVCbG9ja0RlcHRoICsgJyUnKTsKICAgICAgICB9OwoKICAgICAgICBTZXJpYWxpemVCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZEhUTUwgPSBmdW5jdGlvbiBfX2FwcGVuZEhUTUwoaHRtbCkgewogICAgICAgICAgICAvLyBEbyB3ZSBuZWVkIHRvIHJ1biB0aGUgaHRtbCB0b2tlbml6ZXIgaGVyZT8KICAgICAgICAgICAgdmFyIGZpcnN0ID0gdGhpcy5fX2FwcGVuZENvbW1lbnQoJyVnbG1yJScpOwogICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50LnRhZ05hbWUgPT09ICdUQUJMRScpIHsKICAgICAgICAgICAgICAgIHZhciBvcGVuSW5kZXggPSBodG1sLmluZGV4T2YoJzwnKTsKICAgICAgICAgICAgICAgIGlmIChvcGVuSW5kZXggPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ciA9IGh0bWwuc2xpY2Uob3BlbkluZGV4ICsgMSwgb3BlbkluZGV4ICsgMyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRyID09PSAndHInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgPSAnPHRib2R5PicgKyBodG1sICsgJzwvdGJvZHk+JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGh0bWwgPT09ICcnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJSAlJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5fX2FwcGVuZENvbW1lbnQoJyVnbG1yJScpOwogICAgICAgICAgICByZXR1cm4gbmV3IF9ydW50aW1lLkNvbmNyZXRlQm91bmRzKHRoaXMuZWxlbWVudCwgZmlyc3QsIGxhc3QpOwogICAgICAgIH07CgogICAgICAgIFNlcmlhbGl6ZUJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kVGV4dCA9IGZ1bmN0aW9uIF9fYXBwZW5kVGV4dChzdHJpbmcpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBjdXJyZW50Tm9kZSh0aGlzKTsKICAgICAgICAgICAgaWYgKHN0cmluZyA9PT0gJycpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJSAlJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudCAmJiBjdXJyZW50Lm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KCclfCUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZFRleHQuY2FsbCh0aGlzLCBzdHJpbmcpOwogICAgICAgIH07CgogICAgICAgIFNlcmlhbGl6ZUJ1aWxkZXIucHJvdG90eXBlLmNsb3NlRWxlbWVudCA9IGZ1bmN0aW9uIGNsb3NlRWxlbWVudCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudFsnbmVlZHNFeHRyYUNsb3NlJ10gPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudFsnbmVlZHNFeHRyYUNsb3NlJ10gPSBmYWxzZTsKICAgICAgICAgICAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuY2xvc2VFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5jbG9zZUVsZW1lbnQuY2FsbCh0aGlzKTsKICAgICAgICB9OwoKICAgICAgICBTZXJpYWxpemVCdWlsZGVyLnByb3RvdHlwZS5vcGVuRWxlbWVudCA9IGZ1bmN0aW9uIG9wZW5FbGVtZW50KHRhZykgewogICAgICAgICAgICBpZiAodGFnID09PSAndHInKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50LnRhZ05hbWUgIT09ICdUQk9EWScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5FbGVtZW50KCd0Ym9keScpOwogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIGNsb3NlQmxvY2sgY29tbWVudCBmcm9tIGJlaW5nIHJlLXBhcmVudGVkCiAgICAgICAgICAgICAgICAgICAgLy8gdW5kZXIgdGhlIGF1dG8gaW5zZXJ0ZWQgdGJvZHkuIFJlaHlkcmF0aW9uIGJ1aWxkZXIgbmVlZHMgdG8KICAgICAgICAgICAgICAgICAgICAvLyBhY2NvdW50IGZvciB0aGUgaW5zZXJ0aW9uIHNpbmNlIGl0IGlzIGluamVjdGVkIGhlcmUgYW5kIG5vdAogICAgICAgICAgICAgICAgICAgIC8vIHJlYWxseSBpbiB0aGUgdGVtcGxhdGUuCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3RpbmdbJ25lZWRzRXh0cmFDbG9zZSddID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZsdXNoRWxlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLm9wZW5FbGVtZW50LmNhbGwodGhpcywgdGFnKTsKICAgICAgICB9OwoKICAgICAgICBTZXJpYWxpemVCdWlsZGVyLnByb3RvdHlwZS5wdXNoUmVtb3RlRWxlbWVudCA9IGZ1bmN0aW9uIHB1c2hSZW1vdGVFbGVtZW50KGVsZW1lbnQsIGN1cnNvcklkKSB7CiAgICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tOwoKICAgICAgICAgICAgdmFyIHNjcmlwdCA9IGRvbS5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnZ2xtcicsIGN1cnNvcklkKTsKICAgICAgICAgICAgZG9tLmluc2VydEJlZm9yZShlbGVtZW50LCBzY3JpcHQsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5wdXNoUmVtb3RlRWxlbWVudC5jYWxsKHRoaXMsIGVsZW1lbnQsIGN1cnNvcklkLCBuZXh0U2libGluZyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFNlcmlhbGl6ZUJ1aWxkZXI7CiAgICB9KF9ydW50aW1lLk5ld0VsZW1lbnRCdWlsZGVyKTsKCiAgICBmdW5jdGlvbiBzZXJpYWxpemVCdWlsZGVyKGVudiwgY3Vyc29yKSB7CiAgICAgICAgcmV0dXJuIFNlcmlhbGl6ZUJ1aWxkZXIuZm9ySW5pdGlhbFJlbmRlcihlbnYsIGN1cnNvcik7CiAgICB9CgogICAgZXhwb3J0cy5Ob2RlRE9NVHJlZUNvbnN0cnVjdGlvbiA9IE5vZGVET01UcmVlQ29uc3RydWN0aW9uOwogICAgZXhwb3J0cy5zZXJpYWxpemVCdWlsZGVyID0gc2VyaWFsaXplQnVpbGRlcjsKfSk7CmVuaWZlZCgnQGdsaW1tZXIvb3Bjb2RlLWNvbXBpbGVyJywgWydleHBvcnRzJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnZW1iZXItYmFiZWwnLCAnQGdsaW1tZXIvdXRpbCcsICdAZ2xpbW1lci92bScsICdAZ2xpbW1lci93aXJlLWZvcm1hdCcsICdAZ2xpbW1lci9lbmNvZGVyJywgJ0BnbGltbWVyL3Byb2dyYW0nXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9wb2x5ZmlsbHMsIF9lbWJlckJhYmVsLCBfdXRpbCwgX3ZtLCBfd2lyZUZvcm1hdCwgX2VuY29kZXIsIF9wcm9ncmFtKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5QTEFDRUhPTERFUl9IQU5ETEUgPSBleHBvcnRzLldyYXBwZWRCdWlsZGVyID0gZXhwb3J0cy5sb2dPcGNvZGUgPSBleHBvcnRzLmRlYnVnU2xpY2UgPSBleHBvcnRzLmRlYnVnID0gZXhwb3J0cy50ZW1wbGF0ZUZhY3RvcnkgPSBleHBvcnRzLlBhcnRpYWxEZWZpbml0aW9uID0gZXhwb3J0cy5TdGRPcGNvZGVCdWlsZGVyID0gZXhwb3J0cy5PcGNvZGVCdWlsZGVyID0gZXhwb3J0cy5FYWdlck9wY29kZUJ1aWxkZXIgPSBleHBvcnRzLkxhenlPcGNvZGVCdWlsZGVyID0gZXhwb3J0cy5Db21waWxhYmxlUHJvZ3JhbSA9IGV4cG9ydHMuQ29tcGlsYWJsZUJsb2NrID0gZXhwb3J0cy5kZWJ1Z0NvbXBpbGVyID0gZXhwb3J0cy5BYnN0cmFjdENvbXBpbGVyID0gZXhwb3J0cy5jb21waWxlID0gZXhwb3J0cy5MYXp5Q29tcGlsZXIgPSBleHBvcnRzLk1hY3JvcyA9IGV4cG9ydHMuQVRUUlNfQkxPQ0sgPSB1bmRlZmluZWQ7CgoKICAgIHZhciBQTEFDRUhPTERFUl9IQU5ETEUgPSAtMTsKCiAgICB2YXIgT3BzJDE7CiAgICAoZnVuY3Rpb24gKE9wcyQkMSkgewogICAgICAgIE9wcyQkMVtPcHMkJDFbIk9wZW5Db21wb25lbnRFbGVtZW50Il0gPSAwXSA9ICJPcGVuQ29tcG9uZW50RWxlbWVudCI7CiAgICAgICAgT3BzJCQxW09wcyQkMVsiRGlkQ3JlYXRlRWxlbWVudCJdID0gMV0gPSAiRGlkQ3JlYXRlRWxlbWVudCI7CiAgICAgICAgT3BzJCQxW09wcyQkMVsiU2V0Q29tcG9uZW50QXR0cnMiXSA9IDJdID0gIlNldENvbXBvbmVudEF0dHJzIjsKICAgICAgICBPcHMkJDFbT3BzJCQxWyJEaWRSZW5kZXJMYXlvdXQiXSA9IDNdID0gIkRpZFJlbmRlckxheW91dCI7CiAgICAgICAgT3BzJCQxW09wcyQkMVsiRGVidWdnZXIiXSA9IDRdID0gIkRlYnVnZ2VyIjsKICAgIH0pKE9wcyQxIHx8IChPcHMkMSA9IHt9KSk7CgogICAgdmFyIE9wcyQyID0gX3dpcmVGb3JtYXQuT3BzOwogICAgdmFyIEFUVFJTX0JMT0NLID0gJyZhdHRycyc7CgogICAgdmFyIENvbXBpbGVycyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb21waWxlcnMoKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDA7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ29tcGlsZXJzKTsKCiAgICAgICAgICAgIHRoaXMub2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgICAgICB0aGlzLm5hbWVzID0gKDAsIF91dGlsLmRpY3QpKCk7CiAgICAgICAgICAgIHRoaXMuZnVuY3MgPSBbXTsKICAgICAgICB9CgogICAgICAgIENvbXBpbGVycy5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkKG5hbWUsIGZ1bmMpIHsKICAgICAgICAgICAgdGhpcy5mdW5jcy5wdXNoKGZ1bmMpOwogICAgICAgICAgICB0aGlzLm5hbWVzW25hbWVdID0gdGhpcy5mdW5jcy5sZW5ndGggLSAxOwogICAgICAgIH07CgogICAgICAgIENvbXBpbGVycy5wcm90b3R5cGUuY29tcGlsZSA9IGZ1bmN0aW9uIGNvbXBpbGUoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgbmFtZSA9IHNleHBbdGhpcy5vZmZzZXRdOwogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLm5hbWVzW25hbWVdOwogICAgICAgICAgICB2YXIgZnVuYyA9IHRoaXMuZnVuY3NbaW5kZXhdOwoKICAgICAgICAgICAgZnVuYyhzZXhwLCBidWlsZGVyKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ29tcGlsZXJzOwogICAgfSgpOwoKICAgIHZhciBfc3RhdGVtZW50Q29tcGlsZXIgPSB2b2lkIDA7CiAgICBmdW5jdGlvbiBzdGF0ZW1lbnRDb21waWxlcigpIHsKICAgICAgICBpZiAoX3N0YXRlbWVudENvbXBpbGVyKSB7CiAgICAgICAgICAgIHJldHVybiBfc3RhdGVtZW50Q29tcGlsZXI7CiAgICAgICAgfQogICAgICAgIHZhciBTVEFURU1FTlRTID0gX3N0YXRlbWVudENvbXBpbGVyID0gbmV3IENvbXBpbGVycygpOwogICAgICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLlRleHQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIGJ1aWxkZXIudGV4dChzZXhwWzFdKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5Db21tZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLmNvbW1lbnQoc2V4cFsxXSk7CiAgICAgICAgfSk7CiAgICAgICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQ2xvc2VFbGVtZW50LCBmdW5jdGlvbiAoX3NleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgYnVpbGRlci5jbG9zZUVsZW1lbnQoKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5GbHVzaEVsZW1lbnQsIGZ1bmN0aW9uIChfc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLmZsdXNoRWxlbWVudCgpOwogICAgICAgIH0pOwogICAgICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLk1vZGlmaWVyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgcmVmZXJyZXIgPSBidWlsZGVyLnJlZmVycmVyOwogICAgICAgICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICAgICAgICBwYXJhbXMgPSBzZXhwWzJdLAogICAgICAgICAgICAgICAgaGFzaCA9IHNleHBbM107CgogICAgICAgICAgICB2YXIgaGFuZGxlID0gYnVpbGRlci5jb21waWxlci5yZXNvbHZlTW9kaWZpZXIobmFtZSwgcmVmZXJyZXIpOwogICAgICAgICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLm1vZGlmaWVyKGhhbmRsZSwgcGFyYW1zLCBoYXNoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvciAnICsgbmFtZSArICcgaXMgbm90IGEgbW9kaWZpZXI6IEhlbHBlcnMgbWF5IG5vdCBiZSB1c2VkIGluIHRoZSBlbGVtZW50IGZvcm0uJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5TdGF0aWNBdHRyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHNleHBbMl0sCiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBzZXhwWzNdOwoKICAgICAgICAgICAgYnVpbGRlci5zdGF0aWNBdHRyKG5hbWUsIG5hbWVzcGFjZSwgdmFsdWUpOwogICAgICAgIH0pOwogICAgICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLkR5bmFtaWNBdHRyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBkeW5hbWljQXR0cihzZXhwLCBmYWxzZSwgYnVpbGRlcik7CiAgICAgICAgfSk7CiAgICAgICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuVHJ1c3RpbmdBdHRyLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBkeW5hbWljQXR0cihzZXhwLCB0cnVlLCBidWlsZGVyKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5PcGVuRWxlbWVudCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgYnVpbGRlci5vcGVuUHJpbWl0aXZlRWxlbWVudChzZXhwWzFdKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5PcGVuU3BsYXR0ZWRFbGVtZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLnNldENvbXBvbmVudEF0dHJzKHRydWUpOwogICAgICAgICAgICBidWlsZGVyLnB1dENvbXBvbmVudE9wZXJhdGlvbnMoKTsKICAgICAgICAgICAgYnVpbGRlci5vcGVuUHJpbWl0aXZlRWxlbWVudChzZXhwWzFdKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5EeW5hbWljQ29tcG9uZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHNleHBbMV0sCiAgICAgICAgICAgICAgICBhdHRycyA9IHNleHBbMl0sCiAgICAgICAgICAgICAgICBhcmdzID0gc2V4cFszXSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gc2V4cFs0XTsKCiAgICAgICAgICAgIHZhciBibG9jayA9IGJ1aWxkZXIudGVtcGxhdGUodGVtcGxhdGUpOwogICAgICAgICAgICB2YXIgYXR0cnNCbG9jayA9IGF0dHJzLmxlbmd0aCA+IDAgPyBidWlsZGVyLmlubGluZUJsb2NrKHsKICAgICAgICAgICAgICAgIHN0YXRlbWVudHM6IGF0dHJzLAogICAgICAgICAgICAgICAgcGFyYW1ldGVyczogX3V0aWwuRU1QVFlfQVJSQVkKICAgICAgICAgICAgfSkgOiBudWxsOwogICAgICAgICAgICBidWlsZGVyLmR5bmFtaWNDb21wb25lbnQoZGVmaW5pdGlvbiwgYXR0cnNCbG9jaywgbnVsbCwgYXJncywgZmFsc2UsIGJsb2NrLCBudWxsKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5Db21wb25lbnQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciB0YWcgPSBzZXhwWzFdLAogICAgICAgICAgICAgICAgX2F0dHJzID0gc2V4cFsyXSwKICAgICAgICAgICAgICAgIGFyZ3MgPSBzZXhwWzNdLAogICAgICAgICAgICAgICAgYmxvY2sgPSBzZXhwWzRdOwogICAgICAgICAgICB2YXIgcmVmZXJyZXIgPSBidWlsZGVyLnJlZmVycmVyOwoKICAgICAgICAgICAgdmFyIF9idWlsZGVyJGNvbXBpbGVyJHJlcyA9IGJ1aWxkZXIuY29tcGlsZXIucmVzb2x2ZUxheW91dEZvclRhZyh0YWcsIHJlZmVycmVyKSwKICAgICAgICAgICAgICAgIGhhbmRsZSA9IF9idWlsZGVyJGNvbXBpbGVyJHJlcy5oYW5kbGUsCiAgICAgICAgICAgICAgICBjYXBhYmlsaXRpZXMgPSBfYnVpbGRlciRjb21waWxlciRyZXMuY2FwYWJpbGl0aWVzLAogICAgICAgICAgICAgICAgY29tcGlsYWJsZSA9IF9idWlsZGVyJGNvbXBpbGVyJHJlcy5jb21waWxhYmxlOwoKICAgICAgICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCAmJiBjYXBhYmlsaXRpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRycyA9IFtbT3BzJDIuQ2xpZW50U2lkZVN0YXRlbWVudCwgT3BzJDEuU2V0Q29tcG9uZW50QXR0cnMsIHRydWVdXS5jb25jYXQoX2F0dHJzLCBbW09wcyQyLkNsaWVudFNpZGVTdGF0ZW1lbnQsIE9wcyQxLlNldENvbXBvbmVudEF0dHJzLCBmYWxzZV1dKTsKICAgICAgICAgICAgICAgIHZhciBhdHRyc0Jsb2NrID0gYnVpbGRlci5pbmxpbmVCbG9jayh7IHN0YXRlbWVudHM6IGF0dHJzLCBwYXJhbWV0ZXJzOiBfdXRpbC5FTVBUWV9BUlJBWSB9KTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGJ1aWxkZXIudGVtcGxhdGUoYmxvY2spOwogICAgICAgICAgICAgICAgaWYgKGNvbXBpbGFibGUpIHsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnB1c2hDb21wb25lbnREZWZpbml0aW9uKGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBjb21waWxhYmxlLCBhdHRyc0Jsb2NrLCBudWxsLCBhcmdzLCBmYWxzZSwgY2hpbGQgJiYgY2hpbGQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnB1c2hDb21wb25lbnREZWZpbml0aW9uKGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBhdHRyc0Jsb2NrLCBudWxsLCBhcmdzLCBmYWxzZSwgY2hpbGQgJiYgY2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb21waWxlIEVycm9yOiBDYW5ub3QgZmluZCBjb21wb25lbnQgJyArIHRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5QYXJ0aWFsLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICAgICAgICBldmFsSW5mbyA9IHNleHBbMl07CiAgICAgICAgICAgIHZhciByZWZlcnJlciA9IGJ1aWxkZXIucmVmZXJyZXI7CgogICAgICAgICAgICBidWlsZGVyLnJlcGxheWFibGVJZih7CiAgICAgICAgICAgICAgICBhcmdzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5leHByKG5hbWUpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZHVwKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZUcnVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VQYXJ0aWFsKHJlZmVycmVyLCBidWlsZGVyLmV2YWxTeW1ib2xzKCksIGV2YWxJbmZvKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnBvcFNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5wb3BGcmFtZSgpOyAvLyBGSVhNRTogV0FUCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIFNUQVRFTUVOVFMuYWRkKE9wcyQyLllpZWxkLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgdG8gPSBzZXhwWzFdLAogICAgICAgICAgICAgICAgcGFyYW1zID0gc2V4cFsyXTsKCiAgICAgICAgICAgIGJ1aWxkZXIueWllbGQodG8sIHBhcmFtcyk7CiAgICAgICAgfSk7CiAgICAgICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQXR0clNwbGF0LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgdG8gPSBzZXhwWzFdOwoKICAgICAgICAgICAgYnVpbGRlci55aWVsZCh0bywgW10pOwogICAgICAgICAgICBidWlsZGVyLnNldENvbXBvbmVudEF0dHJzKGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5EZWJ1Z2dlciwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgdmFyIGV2YWxJbmZvID0gc2V4cFsxXTsKCiAgICAgICAgICAgIGJ1aWxkZXIuZGVidWdnZXIoYnVpbGRlci5ldmFsU3ltYm9scygpLCBldmFsSW5mbyk7CiAgICAgICAgfSk7CiAgICAgICAgU1RBVEVNRU5UUy5hZGQoT3BzJDIuQ2xpZW50U2lkZVN0YXRlbWVudCwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgQ0xJRU5UX1NJREUuY29tcGlsZShzZXhwLCBidWlsZGVyKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5BcHBlbmQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHNleHBbMV0sCiAgICAgICAgICAgICAgICB0cnVzdGluZyA9IHNleHBbMl07CgogICAgICAgICAgICB2YXIgcmV0dXJuZWQgPSBidWlsZGVyLmNvbXBpbGVJbmxpbmUoc2V4cCkgfHwgdmFsdWU7CiAgICAgICAgICAgIGlmIChyZXR1cm5lZCA9PT0gdHJ1ZSkgcmV0dXJuOwogICAgICAgICAgICBidWlsZGVyLmd1YXJkZWRBcHBlbmQodmFsdWUsIHRydXN0aW5nKTsKICAgICAgICB9KTsKICAgICAgICBTVEFURU1FTlRTLmFkZChPcHMkMi5CbG9jaywgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBzZXhwWzFdLAogICAgICAgICAgICAgICAgcGFyYW1zID0gc2V4cFsyXSwKICAgICAgICAgICAgICAgIGhhc2ggPSBzZXhwWzNdLAogICAgICAgICAgICAgICAgX3RlbXBsYXRlID0gc2V4cFs0XSwKICAgICAgICAgICAgICAgIF9pbnZlcnNlID0gc2V4cFs1XTsKCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGJ1aWxkZXIudGVtcGxhdGUoX3RlbXBsYXRlKTsKICAgICAgICAgICAgdmFyIGludmVyc2UgPSBidWlsZGVyLnRlbXBsYXRlKF9pbnZlcnNlKTsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlQmxvY2sgPSB0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZTsKICAgICAgICAgICAgdmFyIGludmVyc2VCbG9jayA9IGludmVyc2UgJiYgaW52ZXJzZTsKICAgICAgICAgICAgYnVpbGRlci5jb21waWxlQmxvY2sobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZUJsb2NrLCBpbnZlcnNlQmxvY2spOwogICAgICAgIH0pOwogICAgICAgIHZhciBDTElFTlRfU0lERSA9IG5ldyBDb21waWxlcnMoMSk7CiAgICAgICAgQ0xJRU5UX1NJREUuYWRkKE9wcyQxLk9wZW5Db21wb25lbnRFbGVtZW50LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLnB1dENvbXBvbmVudE9wZXJhdGlvbnMoKTsKICAgICAgICAgICAgYnVpbGRlci5vcGVuUHJpbWl0aXZlRWxlbWVudChzZXhwWzJdKTsKICAgICAgICB9KTsKICAgICAgICBDTElFTlRfU0lERS5hZGQoT3BzJDEuRGlkQ3JlYXRlRWxlbWVudCwgZnVuY3Rpb24gKF9zZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIGJ1aWxkZXIuZGlkQ3JlYXRlRWxlbWVudChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgIH0pOwogICAgICAgIENMSUVOVF9TSURFLmFkZChPcHMkMS5TZXRDb21wb25lbnRBdHRycywgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgYnVpbGRlci5zZXRDb21wb25lbnRBdHRycyhzZXhwWzJdKTsKICAgICAgICB9KTsKICAgICAgICBDTElFTlRfU0lERS5hZGQoT3BzJDEuRGVidWdnZXIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWRlYnVnZ2VyCiAgICAgICAgICAgIGRlYnVnZ2VyOwogICAgICAgIH0pOwogICAgICAgIENMSUVOVF9TSURFLmFkZChPcHMkMS5EaWRSZW5kZXJMYXlvdXQsIGZ1bmN0aW9uIChfc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLmRpZFJlbmRlckxheW91dChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBTVEFURU1FTlRTOwogICAgfQogICAgZnVuY3Rpb24gZHluYW1pY0F0dHIoc2V4cCwgdHJ1c3RpbmcsIGJ1aWxkZXIpIHsKICAgICAgICB2YXIgbmFtZSA9IHNleHBbMV0sCiAgICAgICAgICAgIHZhbHVlID0gc2V4cFsyXSwKICAgICAgICAgICAgbmFtZXNwYWNlID0gc2V4cFszXTsKCiAgICAgICAgYnVpbGRlci5leHByKHZhbHVlKTsKICAgICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgICAgIGJ1aWxkZXIuZHluYW1pY0F0dHIobmFtZSwgbmFtZXNwYWNlLCB0cnVzdGluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnVpbGRlci5keW5hbWljQXR0cihuYW1lLCBudWxsLCB0cnVzdGluZyk7CiAgICAgICAgfQogICAgfQogICAgdmFyIF9leHByZXNzaW9uQ29tcGlsZXIgPSB2b2lkIDA7CiAgICBmdW5jdGlvbiBleHByZXNzaW9uQ29tcGlsZXIoKSB7CiAgICAgICAgaWYgKF9leHByZXNzaW9uQ29tcGlsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIF9leHByZXNzaW9uQ29tcGlsZXI7CiAgICAgICAgfQogICAgICAgIHZhciBFWFBSRVNTSU9OUyA9IF9leHByZXNzaW9uQ29tcGlsZXIgPSBuZXcgQ29tcGlsZXJzKCk7CiAgICAgICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLlVua25vd24sIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBjb21waWxlciA9IGJ1aWxkZXIuY29tcGlsZXIsCiAgICAgICAgICAgICAgICByZWZlcnJlciA9IGJ1aWxkZXIucmVmZXJyZXIsCiAgICAgICAgICAgICAgICBhc1BhcnRpYWwgPSBidWlsZGVyLmNvbnRhaW5pbmdMYXlvdXQuYXNQYXJ0aWFsOwoKICAgICAgICAgICAgdmFyIG5hbWUgPSBzZXhwWzFdOwogICAgICAgICAgICB2YXIgaGFuZGxlID0gY29tcGlsZXIucmVzb2x2ZUhlbHBlcihuYW1lLCByZWZlcnJlcik7CiAgICAgICAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGJ1aWxkZXIuaGVscGVyKGhhbmRsZSwgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXNQYXJ0aWFsKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLnJlc29sdmVNYXliZUxvY2FsKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnVpbGRlci5nZXRWYXJpYWJsZSgwKTsKICAgICAgICAgICAgICAgIGJ1aWxkZXIuZ2V0UHJvcGVydHkobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBFWFBSRVNTSU9OUy5hZGQoT3BzJDIuQ29uY2F0LCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgcGFydHMgPSBzZXhwWzFdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLmV4cHIocGFydHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1aWxkZXIuY29uY2F0KHBhcnRzLmxlbmd0aCk7CiAgICAgICAgfSk7CiAgICAgICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLkhlbHBlciwgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgdmFyIGNvbXBpbGVyID0gYnVpbGRlci5jb21waWxlciwKICAgICAgICAgICAgICAgIHJlZmVycmVyID0gYnVpbGRlci5yZWZlcnJlcjsKICAgICAgICAgICAgdmFyIG5hbWUgPSBzZXhwWzFdLAogICAgICAgICAgICAgICAgcGFyYW1zID0gc2V4cFsyXSwKICAgICAgICAgICAgICAgIGhhc2ggPSBzZXhwWzNdOwoKICAgICAgICAgICAgLy8gVE9ETzogdHJpYWdlIHRoaXMgaW4gdGhlIFdGIGNvbXBpbGVyCiAgICAgICAgICAgIGlmIChuYW1lID09PSAnY29tcG9uZW50JykgewogICAgICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSBwYXJhbXNbMF0sCiAgICAgICAgICAgICAgICAgICAgcmVzdEFyZ3MgPSBwYXJhbXMuc2xpY2UoMSk7CgogICAgICAgICAgICAgICAgYnVpbGRlci5jdXJyeUNvbXBvbmVudChkZWZpbml0aW9uLCByZXN0QXJncywgaGFzaCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZSA9IGNvbXBpbGVyLnJlc29sdmVIZWxwZXIobmFtZSwgcmVmZXJyZXIpOwogICAgICAgICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLmhlbHBlcihoYW5kbGUsIHBhcmFtcywgaGFzaCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbXBpbGUgRXJyb3I6ICcgKyBuYW1lICsgJyBpcyBub3QgYSBoZWxwZXInKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIEVYUFJFU1NJT05TLmFkZChPcHMkMi5HZXQsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBoZWFkID0gc2V4cFsxXSwKICAgICAgICAgICAgICAgIHBhdGggPSBzZXhwWzJdOwoKICAgICAgICAgICAgYnVpbGRlci5nZXRWYXJpYWJsZShoZWFkKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLmdldFByb3BlcnR5KHBhdGhbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLk1heWJlTG9jYWwsIGZ1bmN0aW9uIChzZXhwLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBwYXRoID0gc2V4cFsxXTsKCiAgICAgICAgICAgIGlmIChidWlsZGVyLmNvbnRhaW5pbmdMYXlvdXQuYXNQYXJ0aWFsKSB7CiAgICAgICAgICAgICAgICB2YXIgaGVhZCA9IHBhdGhbMF07CiAgICAgICAgICAgICAgICBwYXRoID0gcGF0aC5zbGljZSgxKTsKICAgICAgICAgICAgICAgIGJ1aWxkZXIucmVzb2x2ZU1heWJlTG9jYWwoaGVhZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLmdldFZhcmlhYmxlKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgYnVpbGRlci5nZXRQcm9wZXJ0eShwYXRoW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIEVYUFJFU1NJT05TLmFkZChPcHMkMi5VbmRlZmluZWQsIGZ1bmN0aW9uIChfc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICByZXR1cm4gYnVpbGRlci5wdXNoUHJpbWl0aXZlUmVmZXJlbmNlKHVuZGVmaW5lZCk7CiAgICAgICAgfSk7CiAgICAgICAgRVhQUkVTU0lPTlMuYWRkKE9wcyQyLkhhc0Jsb2NrLCBmdW5jdGlvbiAoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICBidWlsZGVyLmhhc0Jsb2NrKHNleHBbMV0pOwogICAgICAgIH0pOwogICAgICAgIEVYUFJFU1NJT05TLmFkZChPcHMkMi5IYXNCbG9ja1BhcmFtcywgZnVuY3Rpb24gKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgYnVpbGRlci5oYXNCbG9ja1BhcmFtcyhzZXhwWzFdKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRVhQUkVTU0lPTlM7CiAgICB9CgogICAgdmFyIE1hY3JvcyA9IGZ1bmN0aW9uIE1hY3JvcygpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1hY3Jvcyk7CgogICAgICAgIHZhciBfcG9wdWxhdGVCdWlsdGlucyA9IHBvcHVsYXRlQnVpbHRpbnMoKSwKICAgICAgICAgICAgYmxvY2tzID0gX3BvcHVsYXRlQnVpbHRpbnMuYmxvY2tzLAogICAgICAgICAgICBpbmxpbmVzID0gX3BvcHVsYXRlQnVpbHRpbnMuaW5saW5lczsKCiAgICAgICAgdGhpcy5ibG9ja3MgPSBibG9ja3M7CiAgICAgICAgdGhpcy5pbmxpbmVzID0gaW5saW5lczsKICAgIH07CgogICAgdmFyIEJsb2NrcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBCbG9ja3MoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQmxvY2tzKTsKCiAgICAgICAgICAgIHRoaXMubmFtZXMgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgICAgICAgdGhpcy5mdW5jcyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgQmxvY2tzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQobmFtZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmZ1bmNzLnB1c2goZnVuYyk7CiAgICAgICAgICAgIHRoaXMubmFtZXNbbmFtZV0gPSB0aGlzLmZ1bmNzLmxlbmd0aCAtIDE7CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tzLnByb3RvdHlwZS5hZGRNaXNzaW5nID0gZnVuY3Rpb24gYWRkTWlzc2luZyhmdW5jKSB7CiAgICAgICAgICAgIHRoaXMubWlzc2luZyA9IGZ1bmM7CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tzLnByb3RvdHlwZS5jb21waWxlID0gZnVuY3Rpb24gY29tcGlsZShuYW1lLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMubmFtZXNbbmFtZV07CiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkKSB7CgogICAgICAgICAgICAgICAgdmFyIGZ1bmMgPSB0aGlzLm1pc3Npbmc7CiAgICAgICAgICAgICAgICB2YXIgaGFuZGxlZCA9IGZ1bmMobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgYnVpbGRlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX2Z1bmMgPSB0aGlzLmZ1bmNzW2luZGV4XTsKICAgICAgICAgICAgICAgIF9mdW5jKHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEJsb2NrczsKICAgIH0oKTsKCiAgICB2YXIgSW5saW5lcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBJbmxpbmVzKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIElubGluZXMpOwoKICAgICAgICAgICAgdGhpcy5uYW1lcyA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICB0aGlzLmZ1bmNzID0gW107CiAgICAgICAgfQoKICAgICAgICBJbmxpbmVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQobmFtZSwgZnVuYykgewogICAgICAgICAgICB0aGlzLmZ1bmNzLnB1c2goZnVuYyk7CiAgICAgICAgICAgIHRoaXMubmFtZXNbbmFtZV0gPSB0aGlzLmZ1bmNzLmxlbmd0aCAtIDE7CiAgICAgICAgfTsKCiAgICAgICAgSW5saW5lcy5wcm90b3R5cGUuYWRkTWlzc2luZyA9IGZ1bmN0aW9uIGFkZE1pc3NpbmcoZnVuYykgewogICAgICAgICAgICB0aGlzLm1pc3NpbmcgPSBmdW5jOwogICAgICAgIH07CgogICAgICAgIElubGluZXMucHJvdG90eXBlLmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKHNleHAsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gc2V4cFsxXTsKICAgICAgICAgICAgLy8gVE9ETzogRml4IHRoaXMgc28gdGhhdCBleHByZXNzaW9uIG1hY3JvcyBjYW4gcmV0dXJuCiAgICAgICAgICAgIC8vIHRoaW5ncyBsaWtlIGNvbXBvbmVudHMsIHNvIHRoYXQge3tjb21wb25lbnQgZm9vfX0KICAgICAgICAgICAgLy8gaXMgdGhlIHNhbWUgYXMge3soY29tcG9uZW50IGZvbyl9fQogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSByZXR1cm4gWydleHByJywgdmFsdWVdOwogICAgICAgICAgICB2YXIgbmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGhhc2ggPSB2b2lkIDA7CiAgICAgICAgICAgIGlmICh2YWx1ZVswXSA9PT0gT3BzJDIuSGVscGVyKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gdmFsdWVbMV07CiAgICAgICAgICAgICAgICBwYXJhbXMgPSB2YWx1ZVsyXTsKICAgICAgICAgICAgICAgIGhhc2ggPSB2YWx1ZVszXTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZVswXSA9PT0gT3BzJDIuVW5rbm93bikgewogICAgICAgICAgICAgICAgbmFtZSA9IHZhbHVlWzFdOwogICAgICAgICAgICAgICAgcGFyYW1zID0gaGFzaCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWydleHByJywgdmFsdWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMubmFtZXNbbmFtZV07CiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkICYmIHRoaXMubWlzc2luZykgewogICAgICAgICAgICAgICAgdmFyIGZ1bmMgPSB0aGlzLm1pc3Npbmc7CiAgICAgICAgICAgICAgICB2YXIgcmV0dXJuZWQgPSBmdW5jKG5hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gWydleHByJywgdmFsdWVdIDogcmV0dXJuZWQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdmFyIF9mdW5jMiA9IHRoaXMuZnVuY3NbaW5kZXhdOwogICAgICAgICAgICAgICAgdmFyIF9yZXR1cm5lZCA9IF9mdW5jMihuYW1lLCBwYXJhbXMsIGhhc2gsIGJ1aWxkZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9yZXR1cm5lZCA9PT0gZmFsc2UgPyBbJ2V4cHInLCB2YWx1ZV0gOiBfcmV0dXJuZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWydleHByJywgdmFsdWVdOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIElubGluZXM7CiAgICB9KCk7CgogICAgZnVuY3Rpb24gcG9wdWxhdGVCdWlsdGlucygpIHsKICAgICAgICB2YXIgYmxvY2tzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBuZXcgQmxvY2tzKCk7CiAgICAgICAgdmFyIGlubGluZXMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG5ldyBJbmxpbmVzKCk7CgogICAgICAgIGJsb2Nrcy5hZGQoJ2lmJywgZnVuY3Rpb24gKHBhcmFtcywgX2hhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIC8vICAgICAgICBQdXRBcmdzCiAgICAgICAgICAgIC8vICAgICAgICBUZXN0KEVudmlyb25tZW50KQogICAgICAgICAgICAvLyAgICAgICAgRW50ZXIoQkVHSU4sIEVORCkKICAgICAgICAgICAgLy8gQkVHSU46IE5vb3AKICAgICAgICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRUxTRSkKICAgICAgICAgICAgLy8gICAgICAgIEV2YWx1YXRlKGRlZmF1bHQpCiAgICAgICAgICAgIC8vICAgICAgICBKdW1wKEVORCkKICAgICAgICAgICAgLy8gRUxTRTogIE5vb3AKICAgICAgICAgICAgLy8gICAgICAgIEV2YWx1bGF0ZShpbnZlcnNlKQogICAgICAgICAgICAvLyBFTkQ6ICAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgRXhpdAogICAgICAgICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NZTlRBWCBFUlJPUjogI2lmIHJlcXVpcmVzIGEgc2luZ2xlIGFyZ3VtZW50Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVpbGRlci5yZXBsYXlhYmxlSWYoewogICAgICAgICAgICAgICAgYXJnczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZXhwcihwYXJhbXNbMF0pOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIudG9Cb29sZWFuKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZUcnVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZGYWxzZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2soaW52ZXJzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBibG9ja3MuYWRkKCd1bmxlc3MnLCBmdW5jdGlvbiAocGFyYW1zLCBfaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpIHsKICAgICAgICAgICAgLy8gICAgICAgIFB1dEFyZ3MKICAgICAgICAgICAgLy8gICAgICAgIFRlc3QoRW52aXJvbm1lbnQpCiAgICAgICAgICAgIC8vICAgICAgICBFbnRlcihCRUdJTiwgRU5EKQogICAgICAgICAgICAvLyBCRUdJTjogTm9vcAogICAgICAgICAgICAvLyAgICAgICAgSnVtcFVubGVzcyhFTFNFKQogICAgICAgICAgICAvLyAgICAgICAgRXZhbHVhdGUoZGVmYXVsdCkKICAgICAgICAgICAgLy8gICAgICAgIEp1bXAoRU5EKQogICAgICAgICAgICAvLyBFTFNFOiAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgRXZhbHVsYXRlKGludmVyc2UpCiAgICAgICAgICAgIC8vIEVORDogICBOb29wCiAgICAgICAgICAgIC8vICAgICAgICBFeGl0CiAgICAgICAgICAgIGlmICghcGFyYW1zIHx8IHBhcmFtcy5sZW5ndGggIT09IDEpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU1lOVEFYIEVSUk9SOiAjdW5sZXNzIHJlcXVpcmVzIGEgc2luZ2xlIGFyZ3VtZW50Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVpbGRlci5yZXBsYXlhYmxlSWYoewogICAgICAgICAgICAgICAgYXJnczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZXhwcihwYXJhbXNbMF0pOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIudG9Cb29sZWFuKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZUcnVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayhpbnZlcnNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZGYWxzZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBibG9ja3MuYWRkKCd3aXRoJywgZnVuY3Rpb24gKHBhcmFtcywgX2hhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIC8vICAgICAgICBQdXRBcmdzCiAgICAgICAgICAgIC8vICAgICAgICBUZXN0KEVudmlyb25tZW50KQogICAgICAgICAgICAvLyAgICAgICAgRW50ZXIoQkVHSU4sIEVORCkKICAgICAgICAgICAgLy8gQkVHSU46IE5vb3AKICAgICAgICAgICAgLy8gICAgICAgIEp1bXBVbmxlc3MoRUxTRSkKICAgICAgICAgICAgLy8gICAgICAgIEV2YWx1YXRlKGRlZmF1bHQpCiAgICAgICAgICAgIC8vICAgICAgICBKdW1wKEVORCkKICAgICAgICAgICAgLy8gRUxTRTogIE5vb3AKICAgICAgICAgICAgLy8gICAgICAgIEV2YWx1bGF0ZShpbnZlcnNlKQogICAgICAgICAgICAvLyBFTkQ6ICAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgRXhpdAogICAgICAgICAgICBpZiAoIXBhcmFtcyB8fCBwYXJhbXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NZTlRBWCBFUlJPUjogI3dpdGggcmVxdWlyZXMgYSBzaW5nbGUgYXJndW1lbnQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWlsZGVyLnJlcGxheWFibGVJZih7CiAgICAgICAgICAgICAgICBhcmdzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5leHByKHBhcmFtc1swXSk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5kdXAoKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnRvQm9vbGVhbigpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlmVHJ1ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUsIDEpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlmRmFsc2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW52ZXJzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKGludmVyc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgYmxvY2tzLmFkZCgnZWFjaCcsIGZ1bmN0aW9uIChwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIC8vICAgICAgICAgRW50ZXIoQkVHSU4sIEVORCkKICAgICAgICAgICAgLy8gQkVHSU46ICBOb29wCiAgICAgICAgICAgIC8vICAgICAgICAgUHV0QXJncwogICAgICAgICAgICAvLyAgICAgICAgIFB1dEl0ZXJhYmxlCiAgICAgICAgICAgIC8vICAgICAgICAgSnVtcFVubGVzcyhFTFNFKQogICAgICAgICAgICAvLyAgICAgICAgIEVudGVyTGlzdChCRUdJTjIsIEVORDIpCiAgICAgICAgICAgIC8vIElURVI6ICAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgIE5leHRJdGVyKEJSRUFLKQogICAgICAgICAgICAvLyBCRUdJTjI6IE5vb3AKICAgICAgICAgICAgLy8gICAgICAgICBQdXNoQ2hpbGRTY29wZQogICAgICAgICAgICAvLyAgICAgICAgIEV2YWx1YXRlKGRlZmF1bHQpCiAgICAgICAgICAgIC8vICAgICAgICAgUG9wU2NvcGUKICAgICAgICAgICAgLy8gRU5EMjogICBOb29wCiAgICAgICAgICAgIC8vICAgICAgICAgRXhpdAogICAgICAgICAgICAvLyAgICAgICAgIEp1bXAoSVRFUikKICAgICAgICAgICAgLy8gQlJFQUs6ICBOb29wCiAgICAgICAgICAgIC8vICAgICAgICAgRXhpdExpc3QKICAgICAgICAgICAgLy8gICAgICAgICBKdW1wKEVORCkKICAgICAgICAgICAgLy8gRUxTRTogICBOb29wCiAgICAgICAgICAgIC8vICAgICAgICAgRXZhbHVsYXRlKGludmVyc2UpCiAgICAgICAgICAgIC8vIEVORDogICAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgIEV4aXQKICAgICAgICAgICAgYnVpbGRlci5yZXBsYXlhYmxlKHsKICAgICAgICAgICAgICAgIGFyZ3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzaCAmJiBoYXNoWzBdWzBdID09PSAna2V5JykgewogICAgICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmV4cHIoaGFzaFsxXVswXSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5wdXNoUHJpbWl0aXZlUmVmZXJlbmNlKG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmV4cHIocGFyYW1zWzBdKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBib2R5OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5wdXRJdGVyYXRvcigpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuanVtcFVubGVzcygnRUxTRScpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIucHVzaEZyYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5kdXAoX3ZtLlJlZ2lzdGVyLmZwLCAxKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnJldHVyblRvKCdJVEVSJyk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5lbnRlckxpc3QoJ0JPRFknKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmxhYmVsKCdJVEVSJyk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5pdGVyYXRlKCdCUkVBSycpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIubGFiZWwoJ0JPRFknKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0Jsb2NrKHRlbXBsYXRlLCAyKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnBvcCgyKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmp1bXAoJ0ZJTkFMTFknKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmxhYmVsKCdCUkVBSycpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZXhpdExpc3QoKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLnBvcEZyYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5qdW1wKCdGSU5BTExZJyk7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5sYWJlbCgnRUxTRScpOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnZlcnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2soaW52ZXJzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBibG9ja3MuYWRkKCdpbi1lbGVtZW50JywgZnVuY3Rpb24gKHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIF9pbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIGlmICghcGFyYW1zIHx8IHBhcmFtcy5sZW5ndGggIT09IDEpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU1lOVEFYIEVSUk9SOiAjaW4tZWxlbWVudCByZXF1aXJlcyBhIHNpbmdsZSBhcmd1bWVudCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1aWxkZXIucmVwbGF5YWJsZUlmKHsKICAgICAgICAgICAgICAgIGFyZ3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5cyA9IGhhc2hbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IGhhc2hbMV07CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ25leHRTaWJsaW5nJyB8fCBrZXkgPT09ICdndWlkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5leHByKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NZTlRBWCBFUlJPUjogI2luLWVsZW1lbnQgZG9lcyBub3QgdGFrZSBhIGAnICsga2V5c1swXSArICdgIG9wdGlvbicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZXhwcihwYXJhbXNbMF0pOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuZHVwKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaWZUcnVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5wdXNoUmVtb3RlRWxlbWVudCgpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIucG9wUmVtb3RlRWxlbWVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBibG9ja3MuYWRkKCctd2l0aC1keW5hbWljLXZhcnMnLCBmdW5jdGlvbiAoX3BhcmFtcywgaGFzaCwgdGVtcGxhdGUsIF9pbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIGlmIChoYXNoKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZXMgPSBoYXNoWzBdLAogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25zID0gaGFzaFsxXTsKCiAgICAgICAgICAgICAgICBidWlsZGVyLmNvbXBpbGVQYXJhbXMoZXhwcmVzc2lvbnMpOwogICAgICAgICAgICAgICAgYnVpbGRlci5wdXNoRHluYW1pY1Njb3BlKCk7CiAgICAgICAgICAgICAgICBidWlsZGVyLmJpbmREeW5hbWljU2NvcGUobmFtZXMpOwogICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSk7CiAgICAgICAgICAgICAgICBidWlsZGVyLnBvcER5bmFtaWNTY29wZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWNCbG9jayh0ZW1wbGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBibG9ja3MuYWRkKCdjb21wb25lbnQnLCBmdW5jdGlvbiAoX3BhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpIHsKCiAgICAgICAgICAgIHZhciB0YWcgPSBfcGFyYW1zWzBdOwogICAgICAgICAgICBpZiAodHlwZW9mIHRhZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCA9IGJ1aWxkZXIuc3RhdGljQ29tcG9uZW50SGVscGVyKF9wYXJhbXNbMF0sIGhhc2gsIHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCkgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IF9wYXJhbXNbMF0sCiAgICAgICAgICAgICAgICBwYXJhbXMgPSBfcGFyYW1zLnNsaWNlKDEpOwoKICAgICAgICAgICAgYnVpbGRlci5keW5hbWljQ29tcG9uZW50KGRlZmluaXRpb24sIG51bGwsIHBhcmFtcywgaGFzaCwgdHJ1ZSwgdGVtcGxhdGUsIGludmVyc2UpOwogICAgICAgIH0pOwogICAgICAgIGlubGluZXMuYWRkKCdjb21wb25lbnQnLCBmdW5jdGlvbiAoX25hbWUsIF9wYXJhbXMsIGhhc2gsIGJ1aWxkZXIpIHsKCiAgICAgICAgICAgIHZhciB0YWcgPSBfcGFyYW1zICYmIF9wYXJhbXNbMF07CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gYnVpbGRlci5zdGF0aWNDb21wb25lbnRIZWxwZXIodGFnLCBoYXNoLCBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCkgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gX3BhcmFtc1swXSwKICAgICAgICAgICAgICAgIHBhcmFtcyA9IF9wYXJhbXMuc2xpY2UoMSk7CgogICAgICAgICAgICBidWlsZGVyLmR5bmFtaWNDb21wb25lbnQoZGVmaW5pdGlvbiwgbnVsbCwgcGFyYW1zLCBoYXNoLCB0cnVlLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHsgYmxvY2tzOiBibG9ja3MsIGlubGluZXM6IGlubGluZXMgfTsKICAgIH0KCiAgICB2YXIgUExBQ0VIT0xERVJfSEFORExFJDEgPSAtMTsKCiAgICB2YXIgQ29tcGlsYWJsZVByb2dyYW0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29tcGlsYWJsZVByb2dyYW0oY29tcGlsZXIsIGxheW91dCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbXBpbGFibGVQcm9ncmFtKTsKCiAgICAgICAgICAgIHRoaXMuY29tcGlsZXIgPSBjb21waWxlcjsKICAgICAgICAgICAgdGhpcy5sYXlvdXQgPSBsYXlvdXQ7CiAgICAgICAgICAgIHRoaXMuY29tcGlsZWQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgQ29tcGlsYWJsZVByb2dyYW0ucHJvdG90eXBlLmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKCkgewogICAgICAgICAgICBpZiAodGhpcy5jb21waWxlZCAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY29tcGlsZWQ7CiAgICAgICAgICAgIHRoaXMuY29tcGlsZWQgPSBQTEFDRUhPTERFUl9IQU5ETEUkMTsKICAgICAgICAgICAgdmFyIHN0YXRlbWVudHMgPSB0aGlzLmxheW91dC5ibG9jay5zdGF0ZW1lbnRzOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tcGlsZWQgPSB0aGlzLmNvbXBpbGVyLmFkZChzdGF0ZW1lbnRzLCB0aGlzLmxheW91dCk7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDb21waWxhYmxlUHJvZ3JhbSwgW3sKICAgICAgICAgICAga2V5OiAnc3ltYm9sVGFibGUnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxheW91dC5ibG9jazsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gQ29tcGlsYWJsZVByb2dyYW07CiAgICB9KCk7CgogICAgdmFyIENvbXBpbGFibGVCbG9jayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb21waWxhYmxlQmxvY2soY29tcGlsZXIsIHBhcnNlZCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbXBpbGFibGVCbG9jayk7CgogICAgICAgICAgICB0aGlzLmNvbXBpbGVyID0gY29tcGlsZXI7CiAgICAgICAgICAgIHRoaXMucGFyc2VkID0gcGFyc2VkOwogICAgICAgICAgICB0aGlzLmNvbXBpbGVkID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIENvbXBpbGFibGVCbG9jay5wcm90b3R5cGUuY29tcGlsZSA9IGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbXBpbGVkICE9PSBudWxsKSByZXR1cm4gdGhpcy5jb21waWxlZDsKICAgICAgICAgICAgLy8gVHJhY2sgdGhhdCBjb21waWxhdGlvbiBoYXMgc3RhcnRlZCBidXQgbm90IHlldCBmaW5pc2hlZCBieSB0ZW1wb3JhcmlseQogICAgICAgICAgICAvLyB1c2luZyBhIHBsYWNlaG9sZGVyIGhhbmRsZS4gSW4gZWFnZXIgY29tcGlsYXRpb24gbW9kZSwgd2hlcmUgY29tcGlsZSgpCiAgICAgICAgICAgIC8vIG1heSBiZSBjYWxsZWQgcmVjdXJzaXZlbHksIHdlIHVzZSB0aGlzIGFzIGEgc2lnbmFsIHRoYXQgdGhlIGhhbmRsZSBjYW5ub3QKICAgICAgICAgICAgLy8gYmUga25vd24gc3luY2hyb25vdXNseSBhbmQgbXVzdCBiZSBsaW5rZWQgbGF6aWx5LgogICAgICAgICAgICB0aGlzLmNvbXBpbGVkID0gUExBQ0VIT0xERVJfSEFORExFJDE7CiAgICAgICAgICAgIHZhciBfcGFyc2VkID0gdGhpcy5wYXJzZWQsCiAgICAgICAgICAgICAgICBzdGF0ZW1lbnRzID0gX3BhcnNlZC5ibG9jay5zdGF0ZW1lbnRzLAogICAgICAgICAgICAgICAgY29udGFpbmluZ0xheW91dCA9IF9wYXJzZWQuY29udGFpbmluZ0xheW91dDsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkID0gdGhpcy5jb21waWxlci5hZGQoc3RhdGVtZW50cywgY29udGFpbmluZ0xheW91dCk7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDb21waWxhYmxlQmxvY2ssIFt7CiAgICAgICAgICAgIGtleTogJ3N5bWJvbFRhYmxlJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZWQuYmxvY2s7CiAgICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgcmV0dXJuIENvbXBpbGFibGVCbG9jazsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBjb21waWxlKHN0YXRlbWVudHMsIGJ1aWxkZXIsIGNvbXBpbGVyKSB7CiAgICAgICAgdmFyIHNDb21waWxlciA9IHN0YXRlbWVudENvbXBpbGVyKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHNDb21waWxlci5jb21waWxlKHN0YXRlbWVudHNbaV0sIGJ1aWxkZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgaGFuZGxlID0gYnVpbGRlci5jb21taXQoKTsKICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlYnVnU2xpY2UocHJvZ3JhbSwgc3RhcnQsIGVuZCkge30KICAgIGZ1bmN0aW9uIGxvZ09wY29kZSh0eXBlLCBwYXJhbXMpIHsKICAgICAgICB2YXIgb3V0ID0gdHlwZTsKICAgICAgICBpZiAocGFyYW1zKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gT2JqZWN0LmtleXMocGFyYW1zKS5tYXAoZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgICAgIHJldHVybiAnICcgKyBwICsgJz0nICsganNvbihwYXJhbXNbcF0pOwogICAgICAgICAgICB9KS5qb2luKCcnKTsKICAgICAgICAgICAgb3V0ICs9IGFyZ3M7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnKCcgKyBvdXQgKyAnKSc7CiAgICB9CiAgICBmdW5jdGlvbiBqc29uKHBhcmFtKSB7fQogICAgZnVuY3Rpb24gZGVidWcocG9zLCBjLCBvcCkgewogICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBvcGVyYW5kcyA9IEFycmF5KF9sZW4gPiAzID8gX2xlbiAtIDMgOiAwKSwgX2tleSA9IDM7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgb3BlcmFuZHNbX2tleSAtIDNdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1ldGFkYXRhID0gbnVsbDsKICAgICAgICBpZiAoIW1ldGFkYXRhKSB7CiAgICAgICAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoJ01pc3NpbmcgT3Bjb2RlIE1ldGFkYXRhIGZvciAnICsgb3ApOwogICAgICAgIH0KICAgICAgICB2YXIgb3V0ID0gKDAsIF91dGlsLmRpY3QpKCk7CiAgICAgICAgbWV0YWRhdGEub3BzLmZvckVhY2goZnVuY3Rpb24gKG9wZXJhbmQsIGluZGV4KSB7CiAgICAgICAgICAgIHZhciBvcCA9IG9wZXJhbmRzW2luZGV4XTsKICAgICAgICAgICAgc3dpdGNoIChvcGVyYW5kLnR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3RvJzoKICAgICAgICAgICAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IHBvcyArIG9wOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnaTMyJzoKICAgICAgICAgICAgICAgIGNhc2UgJ3N5bWJvbCc6CiAgICAgICAgICAgICAgICBjYXNlICdibG9jayc6CiAgICAgICAgICAgICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBvcDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2hhbmRsZSc6CiAgICAgICAgICAgICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBjLnJlc29sdmVIYW5kbGUob3ApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnc3RyJzoKICAgICAgICAgICAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IGMuZ2V0U3RyaW5nKG9wKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ29wdGlvbi1zdHInOgogICAgICAgICAgICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gb3AgPyBjLmdldFN0cmluZyhvcCkgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnc3RyLWFycmF5JzoKICAgICAgICAgICAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IGMuZ2V0U3RyaW5nQXJyYXkob3ApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnYXJyYXknOgogICAgICAgICAgICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gYy5nZXRBcnJheShvcCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdib29sJzoKICAgICAgICAgICAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9ICEhb3A7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdwcmltaXRpdmUnOgogICAgICAgICAgICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gZGVjb2RlUHJpbWl0aXZlKG9wLCBjKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3JlZ2lzdGVyJzoKICAgICAgICAgICAgICAgICAgICBvdXRbb3BlcmFuZC5uYW1lXSA9IF92bS5SZWdpc3RlcltvcF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzZXJpYWxpemFibGUnOgogICAgICAgICAgICAgICAgICAgIG91dFtvcGVyYW5kLm5hbWVdID0gYy5nZXRTZXJpYWxpemFibGUob3ApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnbGF6eS1jb25zdGFudCc6CiAgICAgICAgICAgICAgICAgICAgb3V0W29wZXJhbmQubmFtZV0gPSBjLmdldE90aGVyKG9wKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBbbWV0YWRhdGEubmFtZSwgb3V0XTsKICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZVByaW1pdGl2ZShwcmltaXRpdmUsIGNvbnN0YW50cykgewogICAgICAgIHZhciBmbGFnID0gcHJpbWl0aXZlICYgNzsgLy8gMTExCiAgICAgICAgdmFyIHZhbHVlID0gcHJpbWl0aXZlID4+IDM7CiAgICAgICAgc3dpdGNoIChmbGFnKSB7CiAgICAgICAgICAgIGNhc2UgMCAvKiBOVU1CRVIgKi86CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgMSAvKiBGTE9BVCAqLzoKICAgICAgICAgICAgICAgIHJldHVybiBjb25zdGFudHMuZ2V0TnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAyIC8qIFNUUklORyAqLzoKICAgICAgICAgICAgICAgIHJldHVybiBjb25zdGFudHMuZ2V0U3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAzIC8qIEJPT0xFQU5fT1JfVk9JRCAqLzoKICAgICAgICAgICAgICAgIHN3aXRjaCAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDQgLyogTkVHQVRJVkUgKi86CiAgICAgICAgICAgICAgICByZXR1cm4gY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBTdGRMaWIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gU3RkTGliKG1haW4sIHRydXN0aW5nR3VhcmRlZEFwcGVuZCwgY2F1dGlvdXNHdWFyZGVkQXBwZW5kKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU3RkTGliKTsKCiAgICAgICAgICAgIHRoaXMubWFpbiA9IG1haW47CiAgICAgICAgICAgIHRoaXMudHJ1c3RpbmdHdWFyZGVkQXBwZW5kID0gdHJ1c3RpbmdHdWFyZGVkQXBwZW5kOwogICAgICAgICAgICB0aGlzLmNhdXRpb3VzR3VhcmRlZEFwcGVuZCA9IGNhdXRpb3VzR3VhcmRlZEFwcGVuZDsKICAgICAgICB9CgogICAgICAgIFN0ZExpYi5jb21waWxlID0gZnVuY3Rpb24gY29tcGlsZShjb21waWxlcikgewogICAgICAgICAgICB2YXIgbWFpbiA9IHRoaXMuc3RkKGNvbXBpbGVyLCBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGIubWFpbigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHRydXN0aW5nR3VhcmRlZEFwcGVuZCA9IHRoaXMuc3RkKGNvbXBpbGVyLCBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGIuc3RkQXBwZW5kKHRydWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIGNhdXRpb3VzR3VhcmRlZEFwcGVuZCA9IHRoaXMuc3RkKGNvbXBpbGVyLCBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGIuc3RkQXBwZW5kKGZhbHNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgU3RkTGliKG1haW4sIHRydXN0aW5nR3VhcmRlZEFwcGVuZCwgY2F1dGlvdXNHdWFyZGVkQXBwZW5kKTsKICAgICAgICB9OwoKICAgICAgICBTdGRMaWIuc3RkID0gZnVuY3Rpb24gc3RkKGNvbXBpbGVyLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gU3RkT3Bjb2RlQnVpbGRlci5idWlsZChjb21waWxlciwgY2FsbGJhY2spOwogICAgICAgIH07CgogICAgICAgIFN0ZExpYi5wcm90b3R5cGUuZ2V0QXBwZW5kID0gZnVuY3Rpb24gZ2V0QXBwZW5kKHRydXN0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVzdGluZyA/IHRoaXMudHJ1c3RpbmdHdWFyZGVkQXBwZW5kIDogdGhpcy5jYXV0aW91c0d1YXJkZWRBcHBlbmQ7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFN0ZExpYjsKICAgIH0oKTsKCiAgICB2YXIgQWJzdHJhY3RDb21waWxlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBBYnN0cmFjdENvbXBpbGVyKG1hY3JvcywgcHJvZ3JhbSwgcmVzb2x2ZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBBYnN0cmFjdENvbXBpbGVyKTsKCiAgICAgICAgICAgIHRoaXMubWFjcm9zID0gbWFjcm9zOwogICAgICAgICAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwogICAgICAgICAgICB0aGlzLnJlc29sdmVyID0gcmVzb2x2ZXI7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgICAgIH0KCiAgICAgICAgQWJzdHJhY3RDb21waWxlci5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RkTGliID0gU3RkTGliLmNvbXBpbGUodGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgQWJzdHJhY3RDb21waWxlci5wcm90b3R5cGUuY29tcGlsZUlubGluZSA9IGZ1bmN0aW9uIGNvbXBpbGVJbmxpbmUoc2V4cCwgYnVpbGRlcikgewogICAgICAgICAgICB2YXIgaW5saW5lcyA9IHRoaXMubWFjcm9zLmlubGluZXM7CgogICAgICAgICAgICByZXR1cm4gaW5saW5lcy5jb21waWxlKHNleHAsIGJ1aWxkZXIpOwogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0Q29tcGlsZXIucHJvdG90eXBlLmNvbXBpbGVCbG9jayA9IGZ1bmN0aW9uIGNvbXBpbGVCbG9jayhuYW1lLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBibG9ja3MgPSB0aGlzLm1hY3Jvcy5ibG9ja3M7CgogICAgICAgICAgICBibG9ja3MuY29tcGlsZShuYW1lLCBwYXJhbXMsIGhhc2gsIHRlbXBsYXRlLCBpbnZlcnNlLCBidWlsZGVyKTsKICAgICAgICB9OwoKICAgICAgICBBYnN0cmFjdENvbXBpbGVyLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQoc3RhdGVtZW50cywgY29udGFpbmluZ0xheW91dCkgewogICAgICAgICAgICByZXR1cm4gY29tcGlsZShzdGF0ZW1lbnRzLCB0aGlzLmJ1aWxkZXJGb3IoY29udGFpbmluZ0xheW91dCksIHRoaXMpOwogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0Q29tcGlsZXIucHJvdG90eXBlLmNvbW1pdCA9IGZ1bmN0aW9uIGNvbW1pdChzY29wZVNpemUsIGJ1ZmZlcikgewogICAgICAgICAgICB2YXIgaGVhcCA9IHRoaXMucHJvZ3JhbS5oZWFwOwogICAgICAgICAgICAvLyBUT0RPOiBjaGFuZ2UgdGhlIHdob2xlIG1hbGxvYyBBUEkgYW5kIGRvIHNvbWV0aGluZyBtb3JlIGVmZmljaWVudAogICAgICAgICAgICB2YXIgaGFuZGxlID0gaGVhcC5tYWxsb2MoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGJ1ZmZlcltpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICBoZWFwLnB1c2hQbGFjZWhvbGRlcih2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGhlYXAucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGVhcC5maW5pc2hNYWxsb2MoaGFuZGxlLCBzY29wZVNpemUpOwogICAgICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0Q29tcGlsZXIucHJvdG90eXBlLnJlc29sdmVMYXlvdXRGb3JUYWcgPSBmdW5jdGlvbiByZXNvbHZlTGF5b3V0Rm9yVGFnKHRhZywgcmVmZXJyZXIpIHsKICAgICAgICAgICAgdmFyIHJlc29sdmVyID0gdGhpcy5yZXNvbHZlcjsKCiAgICAgICAgICAgIHZhciBoYW5kbGUgPSByZXNvbHZlci5sb29rdXBDb21wb25lbnREZWZpbml0aW9uKHRhZywgcmVmZXJyZXIpOwogICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSByZXR1cm4geyBoYW5kbGU6IG51bGwsIGNhcGFiaWxpdGllczogbnVsbCwgY29tcGlsYWJsZTogbnVsbCB9OwogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlTGF5b3V0Rm9ySGFuZGxlKGhhbmRsZSk7CiAgICAgICAgfTsKCiAgICAgICAgQWJzdHJhY3RDb21waWxlci5wcm90b3R5cGUucmVzb2x2ZUxheW91dEZvckhhbmRsZSA9IGZ1bmN0aW9uIHJlc29sdmVMYXlvdXRGb3JIYW5kbGUoaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlciA9IHRoaXMucmVzb2x2ZXI7CgogICAgICAgICAgICB2YXIgY2FwYWJpbGl0aWVzID0gcmVzb2x2ZXIuZ2V0Q2FwYWJpbGl0aWVzKGhhbmRsZSk7CiAgICAgICAgICAgIHZhciBjb21waWxhYmxlID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCkgewogICAgICAgICAgICAgICAgY29tcGlsYWJsZSA9IHJlc29sdmVyLmdldExheW91dChoYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBoYW5kbGU6IGhhbmRsZSwKICAgICAgICAgICAgICAgIGNhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzLAogICAgICAgICAgICAgICAgY29tcGlsYWJsZTogY29tcGlsYWJsZQogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0Q29tcGlsZXIucHJvdG90eXBlLnJlc29sdmVNb2RpZmllciA9IGZ1bmN0aW9uIHJlc29sdmVNb2RpZmllcihuYW1lLCByZWZlcnJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBNb2RpZmllcihuYW1lLCByZWZlcnJlcik7CiAgICAgICAgfTsKCiAgICAgICAgQWJzdHJhY3RDb21waWxlci5wcm90b3R5cGUucmVzb2x2ZUhlbHBlciA9IGZ1bmN0aW9uIHJlc29sdmVIZWxwZXIobmFtZSwgcmVmZXJyZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubG9va3VwSGVscGVyKG5hbWUsIHJlZmVycmVyKTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEFic3RyYWN0Q29tcGlsZXIsIFt7CiAgICAgICAgICAgIGtleTogJ2NvbnN0YW50cycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvZ3JhbS5jb25zdGFudHM7CiAgICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgcmV0dXJuIEFic3RyYWN0Q29tcGlsZXI7CiAgICB9KCk7CgogICAgdmFyIGRlYnVnQ29tcGlsZXIgPSB2b2lkIDA7CgogICAgdmFyIFdyYXBwZWRCdWlsZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFdyYXBwZWRCdWlsZGVyKGNvbXBpbGVyLCBsYXlvdXQpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBXcmFwcGVkQnVpbGRlcik7CgogICAgICAgICAgICB0aGlzLmNvbXBpbGVyID0gY29tcGlsZXI7CiAgICAgICAgICAgIHRoaXMubGF5b3V0ID0gbGF5b3V0OwogICAgICAgICAgICB0aGlzLmNvbXBpbGVkID0gbnVsbDsKICAgICAgICAgICAgdmFyIGJsb2NrID0gbGF5b3V0LmJsb2NrOwoKICAgICAgICAgICAgdmFyIHN5bWJvbHMgPSBibG9jay5zeW1ib2xzLnNsaWNlKCk7CiAgICAgICAgICAgIC8vIGVuc3VyZSBBVFRSU19CTE9DSyBpcyBhbHdheXMgaW5jbHVkZWQgKG9ubHkgb25jZSkgaW4gdGhlIGxpc3Qgb2Ygc3ltYm9scwogICAgICAgICAgICB2YXIgYXR0cnNCbG9ja0luZGV4ID0gc3ltYm9scy5pbmRleE9mKEFUVFJTX0JMT0NLKTsKICAgICAgICAgICAgaWYgKGF0dHJzQmxvY2tJbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHRoaXMuYXR0cnNCbG9ja051bWJlciA9IHN5bWJvbHMucHVzaChBVFRSU19CTE9DSyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmF0dHJzQmxvY2tOdW1iZXIgPSBhdHRyc0Jsb2NrSW5kZXggKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc3ltYm9sVGFibGUgPSB7CiAgICAgICAgICAgICAgICBoYXNFdmFsOiBibG9jay5oYXNFdmFsLAogICAgICAgICAgICAgICAgc3ltYm9sczogc3ltYm9scwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgV3JhcHBlZEJ1aWxkZXIucHJvdG90eXBlLmNvbXBpbGUgPSBmdW5jdGlvbiBjb21waWxlKCkgewogICAgICAgICAgICBpZiAodGhpcy5jb21waWxlZCAhPT0gbnVsbCkgcmV0dXJuIHRoaXMuY29tcGlsZWQ7CiAgICAgICAgICAgIC8vPT09PT09PT1EWU5BTUlDCiAgICAgICAgICAgIC8vICAgICAgICBQdXRWYWx1ZShUYWdFeHByKQogICAgICAgICAgICAvLyAgICAgICAgVGVzdAogICAgICAgICAgICAvLyAgICAgICAgSnVtcFVubGVzcyhCT0RZKQogICAgICAgICAgICAvLyAgICAgICAgUHV0Q29tcG9uZW50T3BlcmF0aW9ucwogICAgICAgICAgICAvLyAgICAgICAgT3BlbkR5bmFtaWNQcmltaXRpdmVFbGVtZW50CiAgICAgICAgICAgIC8vICAgICAgICBEaWRDcmVhdGVFbGVtZW50CiAgICAgICAgICAgIC8vICAgICAgICAuLi5hdHRyIHN0YXRlbWVudHMuLi4KICAgICAgICAgICAgLy8gICAgICAgIEZsdXNoRWxlbWVudAogICAgICAgICAgICAvLyBCT0RZOiAgTm9vcAogICAgICAgICAgICAvLyAgICAgICAgLi4uYm9keSBzdGF0ZW1lbnRzLi4uCiAgICAgICAgICAgIC8vICAgICAgICBQdXRWYWx1ZShUYWdFeHByKQogICAgICAgICAgICAvLyAgICAgICAgVGVzdAogICAgICAgICAgICAvLyAgICAgICAgSnVtcFVubGVzcyhFTkQpCiAgICAgICAgICAgIC8vICAgICAgICBDbG9zZUVsZW1lbnQKICAgICAgICAgICAgLy8gRU5EOiAgIE5vb3AKICAgICAgICAgICAgLy8gICAgICAgIERpZFJlbmRlckxheW91dAogICAgICAgICAgICAvLyAgICAgICAgRXhpdAogICAgICAgICAgICAvLwogICAgICAgICAgICAvLz09PT09PT09U1RBVElDCiAgICAgICAgICAgIC8vICAgICAgICBPcGVuUHJpbWl0aXZlRWxlbWVudE9wY29kZQogICAgICAgICAgICAvLyAgICAgICAgRGlkQ3JlYXRlRWxlbWVudAogICAgICAgICAgICAvLyAgICAgICAgLi4uYXR0ciBzdGF0ZW1lbnRzLi4uCiAgICAgICAgICAgIC8vICAgICAgICBGbHVzaEVsZW1lbnQKICAgICAgICAgICAgLy8gICAgICAgIC4uLmJvZHkgc3RhdGVtZW50cy4uLgogICAgICAgICAgICAvLyAgICAgICAgQ2xvc2VFbGVtZW50CiAgICAgICAgICAgIC8vICAgICAgICBEaWRSZW5kZXJMYXlvdXQKICAgICAgICAgICAgLy8gICAgICAgIEV4aXQKICAgICAgICAgICAgdmFyIGNvbXBpbGVyID0gdGhpcy5jb21waWxlciwKICAgICAgICAgICAgICAgIGxheW91dCA9IHRoaXMubGF5b3V0OwoKICAgICAgICAgICAgdmFyIGIgPSBjb21waWxlci5idWlsZGVyRm9yKGxheW91dCk7CiAgICAgICAgICAgIGIuc3RhcnRMYWJlbHMoKTsKICAgICAgICAgICAgYi5mZXRjaChfdm0uUmVnaXN0ZXIuczEpOwogICAgICAgICAgICBiLmdldENvbXBvbmVudFRhZ05hbWUoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgYi5wcmltaXRpdmVSZWZlcmVuY2UoKTsKICAgICAgICAgICAgYi5kdXAoKTsKICAgICAgICAgICAgYi5sb2FkKF92bS5SZWdpc3Rlci5zMSk7CiAgICAgICAgICAgIGIuanVtcFVubGVzcygnQk9EWScpOwogICAgICAgICAgICBiLmZldGNoKF92bS5SZWdpc3Rlci5zMSk7CiAgICAgICAgICAgIGIuc2V0Q29tcG9uZW50QXR0cnModHJ1ZSk7CiAgICAgICAgICAgIGIucHV0Q29tcG9uZW50T3BlcmF0aW9ucygpOwogICAgICAgICAgICBiLm9wZW5EeW5hbWljRWxlbWVudCgpOwogICAgICAgICAgICBiLmRpZENyZWF0ZUVsZW1lbnQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgYi55aWVsZCh0aGlzLmF0dHJzQmxvY2tOdW1iZXIsIFtdKTsKICAgICAgICAgICAgYi5zZXRDb21wb25lbnRBdHRycyhmYWxzZSk7CiAgICAgICAgICAgIGIuZmx1c2hFbGVtZW50KCk7CiAgICAgICAgICAgIGIubGFiZWwoJ0JPRFknKTsKICAgICAgICAgICAgYi5pbnZva2VTdGF0aWNCbG9jayhibG9ja0ZvcihsYXlvdXQsIGNvbXBpbGVyKSk7CiAgICAgICAgICAgIGIuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMxKTsKICAgICAgICAgICAgYi5qdW1wVW5sZXNzKCdFTkQnKTsKICAgICAgICAgICAgYi5jbG9zZUVsZW1lbnQoKTsKICAgICAgICAgICAgYi5sYWJlbCgnRU5EJyk7CiAgICAgICAgICAgIGIubG9hZChfdm0uUmVnaXN0ZXIuczEpOwogICAgICAgICAgICBiLnN0b3BMYWJlbHMoKTsKICAgICAgICAgICAgdmFyIGhhbmRsZSA9IGIuY29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkID0gaGFuZGxlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBXcmFwcGVkQnVpbGRlcjsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBibG9ja0ZvcihsYXlvdXQsIGNvbXBpbGVyKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDb21waWxhYmxlQmxvY2soY29tcGlsZXIsIHsKICAgICAgICAgICAgYmxvY2s6IHsKICAgICAgICAgICAgICAgIHN0YXRlbWVudHM6IGxheW91dC5ibG9jay5zdGF0ZW1lbnRzLAogICAgICAgICAgICAgICAgcGFyYW1ldGVyczogX3V0aWwuRU1QVFlfQVJSQVkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29udGFpbmluZ0xheW91dDogbGF5b3V0CiAgICAgICAgfSk7CiAgICB9CgogICAgdmFyIENvbXBvbmVudEJ1aWxkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50QnVpbGRlcihidWlsZGVyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ29tcG9uZW50QnVpbGRlcik7CgogICAgICAgICAgICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogICAgICAgIH0KCiAgICAgICAgQ29tcG9uZW50QnVpbGRlci5wcm90b3R5cGUuc3RhdGljID0gZnVuY3Rpb24gX3N0YXRpYyhoYW5kbGUsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IGFyZ3NbMF0sCiAgICAgICAgICAgICAgICBoYXNoID0gYXJnc1sxXSwKICAgICAgICAgICAgICAgIF9kZWZhdWx0ID0gYXJnc1syXSwKICAgICAgICAgICAgICAgIGludmVyc2UgPSBhcmdzWzNdOwogICAgICAgICAgICB2YXIgYnVpbGRlciA9IHRoaXMuYnVpbGRlcjsKCiAgICAgICAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfYnVpbGRlciRjb21waWxlciRyZXMyID0gYnVpbGRlci5jb21waWxlci5yZXNvbHZlTGF5b3V0Rm9ySGFuZGxlKGhhbmRsZSksCiAgICAgICAgICAgICAgICAgICAgY2FwYWJpbGl0aWVzID0gX2J1aWxkZXIkY29tcGlsZXIkcmVzMi5jYXBhYmlsaXRpZXMsCiAgICAgICAgICAgICAgICAgICAgY29tcGlsYWJsZSA9IF9idWlsZGVyJGNvbXBpbGVyJHJlczIuY29tcGlsYWJsZTsKCiAgICAgICAgICAgICAgICBpZiAoY29tcGlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIucHVzaENvbXBvbmVudERlZmluaXRpb24oaGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmludm9rZVN0YXRpY0NvbXBvbmVudChjYXBhYmlsaXRpZXMsIGNvbXBpbGFibGUsIG51bGwsIHBhcmFtcywgaGFzaCwgZmFsc2UsIF9kZWZhdWx0LCBpbnZlcnNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYnVpbGRlci5wdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlQ29tcG9uZW50KGNhcGFiaWxpdGllcywgbnVsbCwgcGFyYW1zLCBoYXNoLCBmYWxzZSwgX2RlZmF1bHQsIGludmVyc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbXBvbmVudEJ1aWxkZXI7CiAgICB9KCk7CgogICAgdmFyIExhYmVscyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBMYWJlbHMoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTGFiZWxzKTsKCiAgICAgICAgICAgIHRoaXMubGFiZWxzID0gKDAsIF91dGlsLmRpY3QpKCk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0cyA9IFtdOwogICAgICAgIH0KCiAgICAgICAgTGFiZWxzLnByb3RvdHlwZS5sYWJlbCA9IGZ1bmN0aW9uIGxhYmVsKG5hbWUsIGluZGV4KSB7CiAgICAgICAgICAgIHRoaXMubGFiZWxzW25hbWVdID0gaW5kZXg7CiAgICAgICAgfTsKCiAgICAgICAgTGFiZWxzLnByb3RvdHlwZS50YXJnZXQgPSBmdW5jdGlvbiB0YXJnZXQoYXQsIF90YXJnZXQpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRzLnB1c2goeyBhdDogYXQsIHRhcmdldDogX3RhcmdldCB9KTsKICAgICAgICB9OwoKICAgICAgICBMYWJlbHMucHJvdG90eXBlLnBhdGNoID0gZnVuY3Rpb24gcGF0Y2goZW5jb2RlcikgewogICAgICAgICAgICB2YXIgdGFyZ2V0cyA9IHRoaXMudGFyZ2V0cywKICAgICAgICAgICAgICAgIGxhYmVscyA9IHRoaXMubGFiZWxzOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0YXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX3RhcmdldHMkaSA9IHRhcmdldHNbaV0sCiAgICAgICAgICAgICAgICAgICAgYXQgPSBfdGFyZ2V0cyRpLmF0LAogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IF90YXJnZXRzJGkudGFyZ2V0OwoKICAgICAgICAgICAgICAgIHZhciBhZGRyZXNzID0gbGFiZWxzW3RhcmdldF0gLSBhdDsKICAgICAgICAgICAgICAgIGVuY29kZXIucGF0Y2goYXQsIGFkZHJlc3MpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIExhYmVsczsKICAgIH0oKTsKCiAgICB2YXIgU3RkT3Bjb2RlQnVpbGRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTdGRPcGNvZGVCdWlsZGVyKGNvbXBpbGVyKSB7CiAgICAgICAgICAgIHZhciBzaXplID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAwOwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFN0ZE9wY29kZUJ1aWxkZXIpOwoKICAgICAgICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgICAgICAgICAgdGhpcy5lbmNvZGVyID0gbmV3IF9lbmNvZGVyLkluc3RydWN0aW9uRW5jb2RlcihbXSk7CiAgICAgICAgICAgIHRoaXMubGFiZWxzU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgICAgICAgdGhpcy5jb21waWxlciA9IGNvbXBpbGVyOwogICAgICAgIH0KCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5idWlsZCA9IGZ1bmN0aW9uIGJ1aWxkKGNvbXBpbGVyLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgYnVpbGRlciA9IG5ldyBTdGRPcGNvZGVCdWlsZGVyKGNvbXBpbGVyKTsKICAgICAgICAgICAgY2FsbGJhY2soYnVpbGRlcik7CiAgICAgICAgICAgIHJldHVybiBidWlsZGVyLmNvbW1pdCgpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKG5hbWUpIHsKICAgICAgICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMCk7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci5lbmNvZGUobmFtZSwgMCwgYXJndW1lbnRzWzFdKTsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAwLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDAsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaE1hY2hpbmUgPSBmdW5jdGlvbiBwdXNoTWFjaGluZShuYW1lKSB7CiAgICAgICAgICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDEwMjQgLyogTUFDSElORV9NQVNLICovKTsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAxMDI0IC8qIE1BQ0hJTkVfTUFTSyAqLywgYXJndW1lbnRzWzFdKTsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAxMDI0IC8qIE1BQ0hJTkVfTUFTSyAqLywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAxMDI0IC8qIE1BQ0hJTkVfTUFTSyAqLywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaE1hY2hpbmUoMjQgLyogUmV0dXJuICovKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29tcGlsZXIuY29tbWl0KHRoaXMuc2l6ZSwgdGhpcy5lbmNvZGVyLmJ1ZmZlcik7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucmVzZXJ2ZSA9IGZ1bmN0aW9uIHJlc2VydmUobmFtZSkgewogICAgICAgICAgICB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDAsIC0xKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXNlcnZlV2l0aE9wZXJhbmQgPSBmdW5jdGlvbiByZXNlcnZlV2l0aE9wZXJhbmQobmFtZSwgb3BlcmFuZCkgewogICAgICAgICAgICB0aGlzLmVuY29kZXIuZW5jb2RlKG5hbWUsIDAsIC0xLCBvcGVyYW5kKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXNlcnZlTWFjaGluZSA9IGZ1bmN0aW9uIHJlc2VydmVNYWNoaW5lKG5hbWUpIHsKICAgICAgICAgICAgdGhpcy5lbmNvZGVyLmVuY29kZShuYW1lLCAxMDI0IC8qIE1BQ0hJTkVfTUFTSyAqLywgLTEpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm1haW4gPSBmdW5jdGlvbiBtYWluKCkgewogICAgICAgICAgICB0aGlzLnB1c2goNjggLyogTWFpbiAqLywgX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5pbnZva2VQcmVwYXJlZENvbXBvbmVudChmYWxzZSwgZmFsc2UsIHRydWUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmFwcGVuZEhUTUwgPSBmdW5jdGlvbiBhcHBlbmRIVE1MKCkgewogICAgICAgICAgICB0aGlzLnB1c2goMjggLyogQXBwZW5kSFRNTCAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuYXBwZW5kU2FmZUhUTUwgPSBmdW5jdGlvbiBhcHBlbmRTYWZlSFRNTCgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDI5IC8qIEFwcGVuZFNhZmVIVE1MICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5hcHBlbmREb2N1bWVudEZyYWdtZW50ID0gZnVuY3Rpb24gYXBwZW5kRG9jdW1lbnRGcmFnbWVudCgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDMwIC8qIEFwcGVuZERvY3VtZW50RnJhZ21lbnQgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmFwcGVuZE5vZGUgPSBmdW5jdGlvbiBhcHBlbmROb2RlKCkgewogICAgICAgICAgICB0aGlzLnB1c2goMzEgLyogQXBwZW5kTm9kZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuYXBwZW5kVGV4dCA9IGZ1bmN0aW9uIGFwcGVuZFRleHQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgzMiAvKiBBcHBlbmRUZXh0ICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5iZWdpbkNvbXBvbmVudFRyYW5zYWN0aW9uID0gZnVuY3Rpb24gYmVnaW5Db21wb25lbnRUcmFuc2FjdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDkxIC8qIEJlZ2luQ29tcG9uZW50VHJhbnNhY3Rpb24gKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmNvbW1pdENvbXBvbmVudFRyYW5zYWN0aW9uID0gZnVuY3Rpb24gY29tbWl0Q29tcG9uZW50VHJhbnNhY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg5MiAvKiBDb21taXRDb21wb25lbnRUcmFuc2FjdGlvbiAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaER5bmFtaWNTY29wZSA9IGZ1bmN0aW9uIHB1c2hEeW5hbWljU2NvcGUoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0NCAvKiBQdXNoRHluYW1pY1Njb3BlICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wb3BEeW5hbWljU2NvcGUgPSBmdW5jdGlvbiBwb3BEeW5hbWljU2NvcGUoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0NSAvKiBQb3BEeW5hbWljU2NvcGUgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gcHVzaFJlbW90ZUVsZW1lbnQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0MSAvKiBQdXNoUmVtb3RlRWxlbWVudCAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucG9wUmVtb3RlRWxlbWVudCA9IGZ1bmN0aW9uIHBvcFJlbW90ZUVsZW1lbnQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0MiAvKiBQb3BSZW1vdGVFbGVtZW50ICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoUm9vdFNjb3BlID0gZnVuY3Rpb24gcHVzaFJvb3RTY29wZShzeW1ib2xzLCBiaW5kQ2FsbGVyU2NvcGUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDIwIC8qIFJvb3RTY29wZSAqLywgc3ltYm9scywgYmluZENhbGxlclNjb3BlID8gMSA6IDApOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hWaXJ0dWFsUm9vdFNjb3BlID0gZnVuY3Rpb24gcHVzaFZpcnR1YWxSb290U2NvcGUocmVnaXN0ZXIpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDIxIC8qIFZpcnR1YWxSb290U2NvcGUgKi8sIHJlZ2lzdGVyKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoQ2hpbGRTY29wZSA9IGZ1bmN0aW9uIHB1c2hDaGlsZFNjb3BlKCkgewogICAgICAgICAgICB0aGlzLnB1c2goMjIgLyogQ2hpbGRTY29wZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucG9wU2NvcGUgPSBmdW5jdGlvbiBwb3BTY29wZSgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDIzIC8qIFBvcFNjb3BlICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wcmVwYXJlQXJncyA9IGZ1bmN0aW9uIHByZXBhcmVBcmdzKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg3OSAvKiBQcmVwYXJlQXJncyAqLywgc3RhdGUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmNyZWF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudChzdGF0ZSwgaGFzRGVmYXVsdCkgewogICAgICAgICAgICB2YXIgZmxhZyA9IGhhc0RlZmF1bHQgfCAwOwogICAgICAgICAgICB0aGlzLnB1c2goODEgLyogQ3JlYXRlQ29tcG9uZW50ICovLCBmbGFnLCBzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yID0gZnVuY3Rpb24gcmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg4MiAvKiBSZWdpc3RlckNvbXBvbmVudERlc3RydWN0b3IgKi8sIHN0YXRlKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXRDb21wb25lbnRPcGVyYXRpb25zID0gZnVuY3Rpb24gcHV0Q29tcG9uZW50T3BlcmF0aW9ucygpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDgzIC8qIFB1dENvbXBvbmVudE9wZXJhdGlvbnMgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmdldENvbXBvbmVudFNlbGYgPSBmdW5jdGlvbiBnZXRDb21wb25lbnRTZWxmKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg4NCAvKiBHZXRDb21wb25lbnRTZWxmICovLCBzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZ2V0Q29tcG9uZW50VGFnTmFtZSA9IGZ1bmN0aW9uIGdldENvbXBvbmVudFRhZ05hbWUoc3RhdGUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDg1IC8qIEdldENvbXBvbmVudFRhZ05hbWUgKi8sIHN0YXRlKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5nZXRDb21wb25lbnRMYXlvdXQgPSBmdW5jdGlvbiBnZXRDb21wb25lbnRMYXlvdXQoc3RhdGUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDg2IC8qIEdldENvbXBvbmVudExheW91dCAqLywgc3RhdGUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnNldHVwRm9yRXZhbCA9IGZ1bmN0aW9uIHNldHVwRm9yRXZhbChzdGF0ZSkgewogICAgICAgICAgICB0aGlzLnB1c2goODcgLyogU2V0dXBGb3JFdmFsICovLCBzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaW52b2tlQ29tcG9uZW50TGF5b3V0ID0gZnVuY3Rpb24gaW52b2tlQ29tcG9uZW50TGF5b3V0KHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg5MCAvKiBJbnZva2VDb21wb25lbnRMYXlvdXQgKi8sIHN0YXRlKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5kaWRDcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gZGlkQ3JlYXRlRWxlbWVudChzdGF0ZSkgewogICAgICAgICAgICB0aGlzLnB1c2goOTMgLyogRGlkQ3JlYXRlRWxlbWVudCAqLywgc3RhdGUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmRpZFJlbmRlckxheW91dCA9IGZ1bmN0aW9uIGRpZFJlbmRlckxheW91dChzdGF0ZSkgewogICAgICAgICAgICB0aGlzLnB1c2goOTQgLyogRGlkUmVuZGVyTGF5b3V0ICovLCBzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaEZyYW1lID0gZnVuY3Rpb24gcHVzaEZyYW1lKCkgewogICAgICAgICAgICB0aGlzLnB1c2hNYWNoaW5lKDU3IC8qIFB1c2hGcmFtZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucG9wRnJhbWUgPSBmdW5jdGlvbiBwb3BGcmFtZSgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoTWFjaGluZSg1OCAvKiBQb3BGcmFtZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaFNtYWxsRnJhbWUgPSBmdW5jdGlvbiBwdXNoU21hbGxGcmFtZSgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoTWFjaGluZSg1OSAvKiBQdXNoU21hbGxGcmFtZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucG9wU21hbGxGcmFtZSA9IGZ1bmN0aW9uIHBvcFNtYWxsRnJhbWUoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaE1hY2hpbmUoNjAgLyogUG9wU21hbGxGcmFtZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaW52b2tlVmlydHVhbCA9IGZ1bmN0aW9uIGludm9rZVZpcnR1YWwoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaE1hY2hpbmUoNDkgLyogSW52b2tlVmlydHVhbCAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaW52b2tlWWllbGQgPSBmdW5jdGlvbiBpbnZva2VZaWVsZCgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDUxIC8qIEludm9rZVlpZWxkICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS50b0Jvb2xlYW4gPSBmdW5jdGlvbiB0b0Jvb2xlYW4oKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg2MyAvKiBUb0Jvb2xlYW4gKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmludm9rZVByZXBhcmVkQ29tcG9uZW50ID0gZnVuY3Rpb24gaW52b2tlUHJlcGFyZWRDb21wb25lbnQoaGFzQmxvY2ssIGJpbmRhYmxlQmxvY2tzLCBiaW5kYWJsZUF0TmFtZXMpIHsKICAgICAgICAgICAgdmFyIHBvcHVsYXRlTGF5b3V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBudWxsOwoKICAgICAgICAgICAgdGhpcy5iZWdpbkNvbXBvbmVudFRyYW5zYWN0aW9uKCk7CiAgICAgICAgICAgIHRoaXMucHVzaER5bmFtaWNTY29wZSgpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUNvbXBvbmVudChfdm0uUmVnaXN0ZXIuczAsIGhhc0Jsb2NrKTsKICAgICAgICAgICAgLy8gdGhpcyBoYXMgdG8gcnVuIGFmdGVyIGNyZWF0ZUNvbXBvbmVudCB0byBhbGxvdwogICAgICAgICAgICAvLyBmb3IgbGF0ZS1ib3VuZCBsYXlvdXRzLCBidXQgYSBjYWxsZXIgaXMgZnJlZQogICAgICAgICAgICAvLyB0byBwb3B1bGF0ZSB0aGUgbGF5b3V0IGVhcmxpZXIgaWYgaXQgd2FudHMgdG8KICAgICAgICAgICAgLy8gYW5kIGRvIG5vdGhpbmcgaGVyZS4KICAgICAgICAgICAgaWYgKHBvcHVsYXRlTGF5b3V0KSBwb3B1bGF0ZUxheW91dCgpOwogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQ29tcG9uZW50RGVzdHJ1Y3Rvcihfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB0aGlzLmdldENvbXBvbmVudFNlbGYoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5wdXNoVmlydHVhbFJvb3RTY29wZShfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB0aGlzLnNldFZhcmlhYmxlKDApOwogICAgICAgICAgICB0aGlzLnNldHVwRm9yRXZhbChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICBpZiAoYmluZGFibGVBdE5hbWVzKSB0aGlzLnNldE5hbWVkVmFyaWFibGVzKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIGlmIChiaW5kYWJsZUJsb2NrcykgdGhpcy5zZXRCbG9ja3MoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5wb3AoKTsKICAgICAgICAgICAgdGhpcy5pbnZva2VDb21wb25lbnRMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5kaWRSZW5kZXJMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgICAgICAgICB0aGlzLnBvcFNjb3BlKCk7CiAgICAgICAgICAgIHRoaXMucG9wRHluYW1pY1Njb3BlKCk7CiAgICAgICAgICAgIHRoaXMuY29tbWl0Q29tcG9uZW50VHJhbnNhY3Rpb24oKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5jb21waWxlSW5saW5lID0gZnVuY3Rpb24gY29tcGlsZUlubGluZShzZXhwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVyLmNvbXBpbGVJbmxpbmUoc2V4cCwgdGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuY29tcGlsZUJsb2NrID0gZnVuY3Rpb24gY29tcGlsZUJsb2NrKG5hbWUsIHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UpIHsKICAgICAgICAgICAgdGhpcy5jb21waWxlci5jb21waWxlQmxvY2sobmFtZSwgcGFyYW1zLCBoYXNoLCB0ZW1wbGF0ZSwgaW52ZXJzZSwgdGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUubGFiZWwgPSBmdW5jdGlvbiBsYWJlbChuYW1lKSB7CiAgICAgICAgICAgIHRoaXMubGFiZWxzLmxhYmVsKG5hbWUsIHRoaXMubmV4dFBvcyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuc3RhcnRMYWJlbHMgPSBmdW5jdGlvbiBzdGFydExhYmVscygpIHsKICAgICAgICAgICAgdGhpcy5sYWJlbHNTdGFjay5wdXNoKG5ldyBMYWJlbHMoKSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuc3RvcExhYmVscyA9IGZ1bmN0aW9uIHN0b3BMYWJlbHMoKSB7CiAgICAgICAgICAgIHZhciBsYWJlbCA9IHRoaXMubGFiZWxzU3RhY2sucG9wKCk7CiAgICAgICAgICAgIGxhYmVsLnBhdGNoKHRoaXMuZW5jb2Rlcik7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaEN1cnJpZWRDb21wb25lbnQgPSBmdW5jdGlvbiBwdXNoQ3VycmllZENvbXBvbmVudCgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDc0IC8qIFB1c2hDdXJyaWVkQ29tcG9uZW50ICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoRHluYW1pY0NvbXBvbmVudEluc3RhbmNlID0gZnVuY3Rpb24gcHVzaER5bmFtaWNDb21wb25lbnRJbnN0YW5jZSgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDczIC8qIFB1c2hEeW5hbWljQ29tcG9uZW50SW5zdGFuY2UgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm9wZW5EeW5hbWljRWxlbWVudCA9IGZ1bmN0aW9uIG9wZW5EeW5hbWljRWxlbWVudCgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDM0IC8qIE9wZW5EeW5hbWljRWxlbWVudCAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZmx1c2hFbGVtZW50ID0gZnVuY3Rpb24gZmx1c2hFbGVtZW50KCkgewogICAgICAgICAgICB0aGlzLnB1c2goMzggLyogRmx1c2hFbGVtZW50ICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5jbG9zZUVsZW1lbnQgPSBmdW5jdGlvbiBjbG9zZUVsZW1lbnQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgzOSAvKiBDbG9zZUVsZW1lbnQgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1dEl0ZXJhdG9yID0gZnVuY3Rpb24gcHV0SXRlcmF0b3IoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg2NiAvKiBQdXRJdGVyYXRvciAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZW50ZXJMaXN0ID0gZnVuY3Rpb24gZW50ZXJMaXN0KHN0YXJ0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZSg2NCAvKiBFbnRlckxpc3QgKi8pOwogICAgICAgICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHN0YXJ0KTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5leGl0TGlzdCA9IGZ1bmN0aW9uIGV4aXRMaXN0KCkgewogICAgICAgICAgICB0aGlzLnB1c2goNjUgLyogRXhpdExpc3QgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLml0ZXJhdGUgPSBmdW5jdGlvbiBpdGVyYXRlKGJyZWFrcykgewogICAgICAgICAgICB0aGlzLnJlc2VydmUoNjcgLyogSXRlcmF0ZSAqLyk7CiAgICAgICAgICAgIHRoaXMubGFiZWxzLnRhcmdldCh0aGlzLnBvcywgYnJlYWtzKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5zZXROYW1lZFZhcmlhYmxlcyA9IGZ1bmN0aW9uIHNldE5hbWVkVmFyaWFibGVzKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgyIC8qIFNldE5hbWVkVmFyaWFibGVzICovLCBzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuc2V0QmxvY2tzID0gZnVuY3Rpb24gc2V0QmxvY2tzKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgzIC8qIFNldEJsb2NrcyAqLywgc3RhdGUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnNldFZhcmlhYmxlID0gZnVuY3Rpb24gc2V0VmFyaWFibGUoc3ltYm9sKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0IC8qIFNldFZhcmlhYmxlICovLCBzeW1ib2wpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnNldEJsb2NrID0gZnVuY3Rpb24gc2V0QmxvY2soc3ltYm9sKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg1IC8qIFNldEJsb2NrICovLCBzeW1ib2wpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmdldFZhcmlhYmxlID0gZnVuY3Rpb24gZ2V0VmFyaWFibGUoc3ltYm9sKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg2IC8qIEdldFZhcmlhYmxlICovLCBzeW1ib2wpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmdldEJsb2NrID0gZnVuY3Rpb24gZ2V0QmxvY2soc3ltYm9sKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg4IC8qIEdldEJsb2NrICovLCBzeW1ib2wpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmhhc0Jsb2NrID0gZnVuY3Rpb24gaGFzQmxvY2soc3ltYm9sKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg5IC8qIEhhc0Jsb2NrICovLCBzeW1ib2wpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmNvbmNhdCA9IGZ1bmN0aW9uIGNvbmNhdChzaXplKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgxMSAvKiBDb25jYXQgKi8sIHNpemUpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmxvYWQgPSBmdW5jdGlvbiBsb2FkKHJlZ2lzdGVyKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgxOCAvKiBMb2FkICovLCByZWdpc3Rlcik7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZmV0Y2ggPSBmdW5jdGlvbiBmZXRjaChyZWdpc3RlcikgewogICAgICAgICAgICB0aGlzLnB1c2goMTkgLyogRmV0Y2ggKi8sIHJlZ2lzdGVyKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5kdXAgPSBmdW5jdGlvbiBkdXAoKSB7CiAgICAgICAgICAgIHZhciByZWdpc3RlciA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogX3ZtLlJlZ2lzdGVyLnNwOwogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAwOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaCgxNiAvKiBEdXAgKi8sIHJlZ2lzdGVyLCBvZmZzZXQpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uIHBvcCgpIHsKICAgICAgICAgICAgdmFyIGNvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAxOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaCgxNyAvKiBQb3AgKi8sIGNvdW50KTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXR1cm5UbyA9IGZ1bmN0aW9uIHJldHVyblRvKGxhYmVsKSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZU1hY2hpbmUoMjUgLyogUmV0dXJuVG8gKi8pOwogICAgICAgICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIGxhYmVsKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wcmltaXRpdmVSZWZlcmVuY2UgPSBmdW5jdGlvbiBwcmltaXRpdmVSZWZlcmVuY2UoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgxNCAvKiBQcmltaXRpdmVSZWZlcmVuY2UgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnJlaWZ5VTMyID0gZnVuY3Rpb24gcmVpZnlVMzIoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgxNSAvKiBSZWlmeVUzMiAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZW50ZXIgPSBmdW5jdGlvbiBlbnRlcihhcmdzKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg2MSAvKiBFbnRlciAqLywgYXJncyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZXhpdCA9IGZ1bmN0aW9uIGV4aXQoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg2MiAvKiBFeGl0ICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXR1cm4gPSBmdW5jdGlvbiBfcmV0dXJuKCkgewogICAgICAgICAgICB0aGlzLnB1c2hNYWNoaW5lKDI0IC8qIFJldHVybiAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuanVtcCA9IGZ1bmN0aW9uIGp1bXAodGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZU1hY2hpbmUoNTIgLyogSnVtcCAqLyk7CiAgICAgICAgICAgIHRoaXMubGFiZWxzLnRhcmdldCh0aGlzLnBvcywgdGFyZ2V0KTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5qdW1wSWYgPSBmdW5jdGlvbiBqdW1wSWYodGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZSg1MyAvKiBKdW1wSWYgKi8pOwogICAgICAgICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHRhcmdldCk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuanVtcFVubGVzcyA9IGZ1bmN0aW9uIGp1bXBVbmxlc3ModGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZSg1NCAvKiBKdW1wVW5sZXNzICovKTsKICAgICAgICAgICAgdGhpcy5sYWJlbHMudGFyZ2V0KHRoaXMucG9zLCB0YXJnZXQpOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmp1bXBFcSA9IGZ1bmN0aW9uIGp1bXBFcSh2YWx1ZSwgdGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXJ2ZVdpdGhPcGVyYW5kKDU1IC8qIEp1bXBFcSAqLywgdmFsdWUpOwogICAgICAgICAgICB0aGlzLmxhYmVscy50YXJnZXQodGhpcy5wb3MsIHRhcmdldCk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuYXNzZXJ0U2FtZSA9IGZ1bmN0aW9uIGFzc2VydFNhbWUoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg1NiAvKiBBc3NlcnRTYW1lICovKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoRW1wdHlBcmdzID0gZnVuY3Rpb24gcHVzaEVtcHR5QXJncygpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDc3IC8qIFB1c2hFbXB0eUFyZ3MgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnN3aXRjaCA9IGZ1bmN0aW9uIF9zd2l0Y2goX29wY29kZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIFNldHVwIHRoZSBzd2l0Y2ggRFNMCiAgICAgICAgICAgIHZhciBjbGF1c2VzID0gW107CiAgICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICAgIGZ1bmN0aW9uIHdoZW4obWF0Y2gsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjbGF1c2VzLnB1c2goeyBtYXRjaDogbWF0Y2gsIGNhbGxiYWNrOiBjYWxsYmFjaywgbGFiZWw6ICdDTEFVU0UnICsgY291bnQrKyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDYWxsIHRoZSBjYWxsYmFjawogICAgICAgICAgICBjYWxsYmFjayh3aGVuKTsKICAgICAgICAgICAgLy8gRW1pdCB0aGUgb3Bjb2RlcyBmb3IgdGhlIHN3aXRjaAogICAgICAgICAgICB0aGlzLmVudGVyKDIpOwogICAgICAgICAgICB0aGlzLmFzc2VydFNhbWUoKTsKICAgICAgICAgICAgdGhpcy5yZWlmeVUzMigpOwogICAgICAgICAgICB0aGlzLnN0YXJ0TGFiZWxzKCk7CiAgICAgICAgICAgIC8vIEZpcnN0LCBlbWl0IHRoZSBqdW1wIG9wY29kZXMuIFdlIGRvbid0IG5lZWQgYSBqdW1wIGZvciB0aGUgbGFzdAogICAgICAgICAgICAvLyBvcGNvZGUsIHNpbmNlIGl0IGJsZWVkcyBkaXJlY3RseSBpbnRvIGl0cyBjbGF1c2UuCiAgICAgICAgICAgIGNsYXVzZXMuc2xpY2UoMCwgLTEpLmZvckVhY2goZnVuY3Rpb24gKGNsYXVzZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmp1bXBFcShjbGF1c2UubWF0Y2gsIGNsYXVzZS5sYWJlbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBFbnVtZXJhdGUgdGhlIGNsYXVzZXMgaW4gcmV2ZXJzZSBvcmRlci4gRWFybGllciBtYXRjaGVzIHdpbGwKICAgICAgICAgICAgLy8gcmVxdWlyZSBmZXdlciBjaGVja3MuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSBjbGF1c2VzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhdXNlID0gY2xhdXNlc1tpXTsKICAgICAgICAgICAgICAgIHRoaXMubGFiZWwoY2xhdXNlLmxhYmVsKTsKICAgICAgICAgICAgICAgIHRoaXMucG9wKDIpOwogICAgICAgICAgICAgICAgY2xhdXNlLmNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAvLyBUaGUgZmlyc3QgbWF0Y2ggaXMgc3BlY2lhbDogaXQgaXMgcGxhY2VkIGRpcmVjdGx5IGJlZm9yZSB0aGUgRU5ECiAgICAgICAgICAgICAgICAvLyBsYWJlbCwgc28gbm8gYWRkaXRpb25hbCBqdW1wIGlzIG5lZWRlZCBhdCB0aGUgZW5kIG9mIGl0LgogICAgICAgICAgICAgICAgaWYgKGkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmp1bXAoJ0VORCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubGFiZWwoJ0VORCcpOwogICAgICAgICAgICB0aGlzLnN0b3BMYWJlbHMoKTsKICAgICAgICAgICAgdGhpcy5leGl0KCk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuc3RkQXBwZW5kID0gZnVuY3Rpb24gc3RkQXBwZW5kKHRydXN0aW5nKSB7CiAgICAgICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5zd2l0Y2godGhpcy5jb250ZW50VHlwZSgpLCBmdW5jdGlvbiAod2hlbikgewogICAgICAgICAgICAgICAgd2hlbigxIC8qIFN0cmluZyAqLywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0cnVzdGluZykgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpczIuYXNzZXJ0U2FtZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBfdGhpczIuYXBwZW5kSFRNTCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzMi5hcHBlbmRUZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB3aGVuKDAgLyogQ29tcG9uZW50ICovLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMyLnB1c2hDdXJyaWVkQ29tcG9uZW50KCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMyLnB1c2hEeW5hbWljQ29tcG9uZW50SW5zdGFuY2UoKTsKICAgICAgICAgICAgICAgICAgICBfdGhpczIuaW52b2tlQmFyZUNvbXBvbmVudCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB3aGVuKDMgLyogU2FmZVN0cmluZyAqLywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzMi5hc3NlcnRTYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMyLmFwcGVuZFNhZmVIVE1MKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHdoZW4oNCAvKiBGcmFnbWVudCAqLywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIF90aGlzMi5hc3NlcnRTYW1lKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMyLmFwcGVuZERvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgd2hlbig1IC8qIE5vZGUgKi8sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczIuYXNzZXJ0U2FtZSgpOwogICAgICAgICAgICAgICAgICAgIF90aGlzMi5hcHBlbmROb2RlKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucG9wdWxhdGVMYXlvdXQgPSBmdW5jdGlvbiBwb3B1bGF0ZUxheW91dChzdGF0ZSkgewogICAgICAgICAgICB0aGlzLnB1c2goODkgLyogUG9wdWxhdGVMYXlvdXQgKi8sIHN0YXRlKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5pbnZva2VCYXJlQ29tcG9uZW50ID0gZnVuY3Rpb24gaW52b2tlQmFyZUNvbXBvbmVudCgpIHsKICAgICAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLmZldGNoKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIHRoaXMuZHVwKF92bS5SZWdpc3Rlci5zcCwgMSk7CiAgICAgICAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICAgICAgICB0aGlzLnB1c2hFbXB0eUFyZ3MoKTsKICAgICAgICAgICAgdGhpcy5wcmVwYXJlQXJncyhfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB0aGlzLmludm9rZVByZXBhcmVkQ29tcG9uZW50KGZhbHNlLCBmYWxzZSwgdHJ1ZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgX3RoaXMzLmdldENvbXBvbmVudExheW91dChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICAgICAgX3RoaXMzLnBvcHVsYXRlTGF5b3V0KF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmxvYWQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICB9OwoKICAgICAgICBTdGRPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5pc0NvbXBvbmVudCA9IGZ1bmN0aW9uIGlzQ29tcG9uZW50KCkgewogICAgICAgICAgICB0aGlzLnB1c2goNjkgLyogSXNDb21wb25lbnQgKi8pOwogICAgICAgIH07CgogICAgICAgIFN0ZE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmNvbnRlbnRUeXBlID0gZnVuY3Rpb24gY29udGVudFR5cGUoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg3MCAvKiBDb250ZW50VHlwZSAqLyk7CiAgICAgICAgfTsKCiAgICAgICAgU3RkT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaEJsb2NrU2NvcGUgPSBmdW5jdGlvbiBwdXNoQmxvY2tTY29wZSgpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDQ3IC8qIFB1c2hCbG9ja1Njb3BlICovKTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFN0ZE9wY29kZUJ1aWxkZXIsIFt7CiAgICAgICAgICAgIGtleTogJ3BvcycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2Rlci50eXBlUG9zOwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICduZXh0UG9zJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGVyLnNpemU7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ2xhYmVscycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubGFiZWxzU3RhY2suY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gU3RkT3Bjb2RlQnVpbGRlcjsKICAgIH0oKTsKCiAgICB2YXIgT3Bjb2RlQnVpbGRlciA9IGZ1bmN0aW9uIChfU3RkT3Bjb2RlQnVpbGRlcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoT3Bjb2RlQnVpbGRlciwgX1N0ZE9wY29kZUJ1aWxkZXIpOwoKICAgICAgICBmdW5jdGlvbiBPcGNvZGVCdWlsZGVyKGNvbXBpbGVyLCBjb250YWluaW5nTGF5b3V0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgT3Bjb2RlQnVpbGRlcik7CgogICAgICAgICAgICB2YXIgX3RoaXM0ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9TdGRPcGNvZGVCdWlsZGVyLmNhbGwodGhpcywgY29tcGlsZXIsIGNvbnRhaW5pbmdMYXlvdXQgPyBjb250YWluaW5nTGF5b3V0LmJsb2NrLnN5bWJvbHMubGVuZ3RoIDogMCkpOwoKICAgICAgICAgICAgX3RoaXM0LmNvbnRhaW5pbmdMYXlvdXQgPSBjb250YWluaW5nTGF5b3V0OwogICAgICAgICAgICBfdGhpczQuY29tcG9uZW50ID0gbmV3IENvbXBvbmVudEJ1aWxkZXIoX3RoaXM0KTsKICAgICAgICAgICAgX3RoaXM0LmV4cHJlc3Npb25Db21waWxlciA9IGV4cHJlc3Npb25Db21waWxlcigpOwogICAgICAgICAgICBfdGhpczQuaXNDb21wb25lbnRBdHRycyA9IGZhbHNlOwogICAgICAgICAgICBfdGhpczQuY29uc3RhbnRzID0gY29tcGlsZXIuY29uc3RhbnRzOwogICAgICAgICAgICBfdGhpczQuc3RkTGliID0gY29tcGlsZXIuc3RkTGliOwogICAgICAgICAgICByZXR1cm4gX3RoaXM0OwogICAgICAgIH0KICAgICAgICAvLy8gTUVDSEFOSUNTCgoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5zZXRDb21wb25lbnRBdHRycyA9IGZ1bmN0aW9uIHNldENvbXBvbmVudEF0dHJzKGVuYWJsZWQpIHsKICAgICAgICAgICAgdGhpcy5pc0NvbXBvbmVudEF0dHJzID0gZW5hYmxlZDsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5leHByID0gZnVuY3Rpb24gZXhwcihleHByZXNzaW9uKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGV4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4cHJlc3Npb25Db21waWxlci5jb21waWxlKGV4cHJlc3Npb24sIHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoUHJpbWl0aXZlUmVmZXJlbmNlKGV4cHJlc3Npb24pOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaEFyZ3MgPSBmdW5jdGlvbiBwdXNoQXJncyhuYW1lcywgZmxhZ3MpIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSB0aGlzLmNvbnN0YW50cy5zdHJpbmdBcnJheShuYW1lcyk7CiAgICAgICAgICAgIHRoaXMucHVzaCg3NiAvKiBQdXNoQXJncyAqLywgc2VyaWFsaXplZCwgZmxhZ3MpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hZaWVsZGFibGVCbG9jayA9IGZ1bmN0aW9uIHB1c2hZaWVsZGFibGVCbG9jayhibG9jaykgewogICAgICAgICAgICB0aGlzLnB1c2hTeW1ib2xUYWJsZShibG9jayAmJiBibG9jay5zeW1ib2xUYWJsZSk7CiAgICAgICAgICAgIHRoaXMucHVzaEJsb2NrU2NvcGUoKTsKICAgICAgICAgICAgdGhpcy5wdXNoQmxvY2soYmxvY2spOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmN1cnJ5Q29tcG9uZW50ID0gZnVuY3Rpb24gY3VycnlDb21wb25lbnQoZGVmaW5pdGlvbiwKICAgICAgICAvKiBUT0RPOiBhdHRyczogT3B0aW9uPFJhd0lubGluZUJsb2NrPiwgKi9wYXJhbXMsIGhhc2gsIHN5bnRoZXRpYykgewogICAgICAgICAgICB2YXIgcmVmZXJyZXIgPSB0aGlzLmNvbnRhaW5pbmdMYXlvdXQucmVmZXJyZXI7CiAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgIHRoaXMuY29tcGlsZUFyZ3MocGFyYW1zLCBoYXNoLCBudWxsLCBzeW50aGV0aWMpOwogICAgICAgICAgICB0aGlzLnB1c2goODAgLyogQ2FwdHVyZUFyZ3MgKi8pOwogICAgICAgICAgICB0aGlzLmV4cHIoZGVmaW5pdGlvbik7CiAgICAgICAgICAgIHRoaXMucHVzaCg3MSAvKiBDdXJyeUNvbXBvbmVudCAqLywgdGhpcy5jb25zdGFudHMuc2VyaWFsaXphYmxlKHJlZmVycmVyKSk7CiAgICAgICAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgICAgICAgdGhpcy5mZXRjaChfdm0uUmVnaXN0ZXIudjApOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hTeW1ib2xUYWJsZSA9IGZ1bmN0aW9uIHB1c2hTeW1ib2xUYWJsZSh0YWJsZSkgewogICAgICAgICAgICBpZiAodGFibGUpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zdGFudCA9IHRoaXMuY29uc3RhbnRzLnNlcmlhbGl6YWJsZSh0YWJsZSk7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2goNDggLyogUHVzaFN5bWJvbFRhYmxlICovLCBjb25zdGFudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnByaW1pdGl2ZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmludm9rZUNvbXBvbmVudCA9IGZ1bmN0aW9uIGludm9rZUNvbXBvbmVudChjYXBhYmlsaXRpZXMsIGF0dHJzLCBwYXJhbXMsIGhhc2gsIHN5bnRoZXRpYywgYmxvY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICAgICAgICB2YXIgaW52ZXJzZSA9IGFyZ3VtZW50cy5sZW5ndGggPiA2ICYmIGFyZ3VtZW50c1s2XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzZdIDogbnVsbDsKICAgICAgICAgICAgdmFyIGxheW91dCA9IGFyZ3VtZW50c1s3XTsKCiAgICAgICAgICAgIHRoaXMuZmV0Y2goX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgdGhpcy5kdXAoX3ZtLlJlZ2lzdGVyLnNwLCAxKTsKICAgICAgICAgICAgdGhpcy5sb2FkKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgIHZhciBiaW5kYWJsZUJsb2NrcyA9ICEhKGJsb2NrIHx8IGludmVyc2UgfHwgYXR0cnMpOwogICAgICAgICAgICB2YXIgYmluZGFibGVBdE5hbWVzID0gY2FwYWJpbGl0aWVzID09PSB0cnVlIHx8IGNhcGFiaWxpdGllcy5wcmVwYXJlQXJncyB8fCAhIShoYXNoICYmIGhhc2hbMF0ubGVuZ3RoICE9PSAwKTsKICAgICAgICAgICAgdmFyIGJsb2NrcyA9IHsgbWFpbjogYmxvY2ssIGVsc2U6IGludmVyc2UsIGF0dHJzOiBhdHRycyB9OwogICAgICAgICAgICB0aGlzLmNvbXBpbGVBcmdzKHBhcmFtcywgaGFzaCwgYmxvY2tzLCBzeW50aGV0aWMpOwogICAgICAgICAgICB0aGlzLnByZXBhcmVBcmdzKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIHRoaXMuaW52b2tlUHJlcGFyZWRDb21wb25lbnQoYmxvY2sgIT09IG51bGwsIGJpbmRhYmxlQmxvY2tzLCBiaW5kYWJsZUF0TmFtZXMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChsYXlvdXQpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczUucHVzaFN5bWJvbFRhYmxlKGxheW91dC5zeW1ib2xUYWJsZSk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM1LnB1c2hMYXlvdXQobGF5b3V0KTsKICAgICAgICAgICAgICAgICAgICBfdGhpczUucmVzb2x2ZUxheW91dCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczUuZ2V0Q29tcG9uZW50TGF5b3V0KF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGhpczUucG9wdWxhdGVMYXlvdXQoX3ZtLlJlZ2lzdGVyLnMwKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmludm9rZVN0YXRpY0NvbXBvbmVudCA9IGZ1bmN0aW9uIGludm9rZVN0YXRpY0NvbXBvbmVudChjYXBhYmlsaXRpZXMsIGxheW91dCwgYXR0cnMsIHBhcmFtcywgaGFzaCwgc3ludGhldGljLCBibG9jaykgewogICAgICAgICAgICB2YXIgaW52ZXJzZSA9IGFyZ3VtZW50cy5sZW5ndGggPiA3ICYmIGFyZ3VtZW50c1s3XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzddIDogbnVsbDsKICAgICAgICAgICAgdmFyIHN5bWJvbFRhYmxlID0gbGF5b3V0LnN5bWJvbFRhYmxlOwoKICAgICAgICAgICAgdmFyIGJhaWxPdXQgPSBzeW1ib2xUYWJsZS5oYXNFdmFsIHx8IGNhcGFiaWxpdGllcy5wcmVwYXJlQXJnczsKICAgICAgICAgICAgaWYgKGJhaWxPdXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW52b2tlQ29tcG9uZW50KGNhcGFiaWxpdGllcywgYXR0cnMsIHBhcmFtcywgaGFzaCwgc3ludGhldGljLCBibG9jaywgaW52ZXJzZSwgbGF5b3V0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmZldGNoKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIHRoaXMuZHVwKF92bS5SZWdpc3Rlci5zcCwgMSk7CiAgICAgICAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB2YXIgc3ltYm9scyA9IHN5bWJvbFRhYmxlLnN5bWJvbHM7CgogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmNyZWF0ZUFyZ3MpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbXBpbGVBcmdzKG51bGwsIGhhc2gsIG51bGwsIHN5bnRoZXRpYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5iZWdpbkNvbXBvbmVudFRyYW5zYWN0aW9uKCk7CiAgICAgICAgICAgIGlmIChjYXBhYmlsaXRpZXMuZHluYW1pY1Njb3BlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hEeW5hbWljU2NvcGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmNyZWF0ZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUNvbXBvbmVudChfdm0uUmVnaXN0ZXIuczAsIGJsb2NrICE9PSBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmNyZWF0ZUFyZ3MpIHsKICAgICAgICAgICAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyQ29tcG9uZW50RGVzdHJ1Y3Rvcihfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgdGhpcy5nZXRDb21wb25lbnRTZWxmKF92bS5SZWdpc3Rlci5zMCk7CiAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goeyBzeW1ib2w6IDAsIGlzQmxvY2s6IGZhbHNlIH0pOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN5bWJvbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBzeW1ib2wgPSBzeW1ib2xzW2ldOwogICAgICAgICAgICAgICAgc3dpdGNoIChzeW1ib2wuY2hhckF0KDApKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWxsZXJCbG9jayA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzeW1ib2wgPT09ICcmZGVmYXVsdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxlckJsb2NrID0gYmxvY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3ltYm9sID09PSAnJmludmVyc2UnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsZXJCbG9jayA9IGludmVyc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3ltYm9sID09PSBBVFRSU19CTE9DSykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGVyQmxvY2sgPSBhdHRyczsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICgwLCBfdXRpbC51bnJlYWNoYWJsZSkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGVyQmxvY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHVzaFlpZWxkYWJsZUJsb2NrKGNhbGxlckJsb2NrKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzLnB1c2goeyBzeW1ib2w6IGkgKyAxLCBpc0Jsb2NrOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoWWllbGRhYmxlQmxvY2sobnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncy5wdXNoKHsgc3ltYm9sOiBpICsgMSwgaXNCbG9jazogdHJ1ZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdAJzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5cyA9IGhhc2hbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMgPSBoYXNoWzFdOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvb2t1cE5hbWUgPSBzeW1ib2w7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzeW50aGV0aWMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb2t1cE5hbWUgPSBzeW1ib2wuc2xpY2UoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0ga2V5cy5pbmRleE9mKGxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cHIodmFsdWVzW2luZGV4XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncy5wdXNoKHsgc3ltYm9sOiBpICsgMSwgaXNCbG9jazogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wdXNoUm9vdFNjb3BlKHN5bWJvbHMubGVuZ3RoICsgMSwgISEoYmxvY2sgfHwgaW52ZXJzZSB8fCBhdHRycykpOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IGJpbmRpbmdzLmxlbmd0aCAtIDE7IF9pID49IDA7IF9pLS0pIHsKICAgICAgICAgICAgICAgIHZhciBfYmluZGluZ3MkX2kgPSBiaW5kaW5nc1tfaV0sCiAgICAgICAgICAgICAgICAgICAgX3N5bWJvbCA9IF9iaW5kaW5ncyRfaS5zeW1ib2wsCiAgICAgICAgICAgICAgICAgICAgaXNCbG9jayA9IF9iaW5kaW5ncyRfaS5pc0Jsb2NrOwoKICAgICAgICAgICAgICAgIGlmIChpc0Jsb2NrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRCbG9jayhfc3ltYm9sKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRWYXJpYWJsZShfc3ltYm9sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmludm9rZVN0YXRpYyhsYXlvdXQpOwogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmNyZWF0ZUluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRpZFJlbmRlckxheW91dChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgICAgICAgdGhpcy5wb3BTY29wZSgpOwogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmR5bmFtaWNTY29wZSkgewogICAgICAgICAgICAgICAgdGhpcy5wb3BEeW5hbWljU2NvcGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNvbW1pdENvbXBvbmVudFRyYW5zYWN0aW9uKCk7CiAgICAgICAgICAgIHRoaXMubG9hZChfdm0uUmVnaXN0ZXIuczApOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmR5bmFtaWNDb21wb25lbnQgPSBmdW5jdGlvbiBkeW5hbWljQ29tcG9uZW50KGRlZmluaXRpb24sIGF0dHJzLCBwYXJhbXMsIGhhc2gsIHN5bnRoZXRpYywgYmxvY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICAgICAgICB2YXIgaW52ZXJzZSA9IGFyZ3VtZW50cy5sZW5ndGggPiA2ICYmIGFyZ3VtZW50c1s2XSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzZdIDogbnVsbDsKCiAgICAgICAgICAgIHRoaXMucmVwbGF5YWJsZSh7CiAgICAgICAgICAgICAgICBhcmdzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM2LmV4cHIoZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM2LmR1cCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGJvZHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczYuanVtcFVubGVzcygnRUxTRScpOwogICAgICAgICAgICAgICAgICAgIF90aGlzNi5yZXNvbHZlRHluYW1pY0NvbXBvbmVudChfdGhpczYuY29udGFpbmluZ0xheW91dC5yZWZlcnJlcik7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM2LnB1c2hEeW5hbWljQ29tcG9uZW50SW5zdGFuY2UoKTsKICAgICAgICAgICAgICAgICAgICBfdGhpczYuaW52b2tlQ29tcG9uZW50KHRydWUsIGF0dHJzLCBwYXJhbXMsIGhhc2gsIHN5bnRoZXRpYywgYmxvY2ssIGludmVyc2UpOwogICAgICAgICAgICAgICAgICAgIF90aGlzNi5sYWJlbCgnRUxTRScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS55aWVsZCA9IGZ1bmN0aW9uIF95aWVsZCh0bywgcGFyYW1zKSB7CiAgICAgICAgICAgIHRoaXMuY29tcGlsZUFyZ3MocGFyYW1zLCBudWxsLCBudWxsLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2V0QmxvY2sodG8pOwogICAgICAgICAgICB0aGlzLnJlc29sdmVCbG9jaygpOwogICAgICAgICAgICB0aGlzLmludm9rZVlpZWxkKCk7CiAgICAgICAgICAgIHRoaXMucG9wU2NvcGUoKTsKICAgICAgICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmd1YXJkZWRBcHBlbmQgPSBmdW5jdGlvbiBndWFyZGVkQXBwZW5kKGV4cHJlc3Npb24sIHRydXN0aW5nKSB7CiAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgIHRoaXMuZXhwcihleHByZXNzaW9uKTsKICAgICAgICAgICAgdGhpcy5wdXNoTWFjaGluZSg1MCAvKiBJbnZva2VTdGF0aWMgKi8sIHRoaXMuc3RkTGliLmdldEFwcGVuZCh0cnVzdGluZykpOwogICAgICAgICAgICB0aGlzLnBvcEZyYW1lKCk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaW52b2tlU3RhdGljQmxvY2sgPSBmdW5jdGlvbiBpbnZva2VTdGF0aWNCbG9jayhibG9jaykgewogICAgICAgICAgICB2YXIgY2FsbGVyQ291bnQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgICAgICAgICAgIHZhciBwYXJhbWV0ZXJzID0gYmxvY2suc3ltYm9sVGFibGUucGFyYW1ldGVyczsKCiAgICAgICAgICAgIHZhciBjYWxsZWVDb3VudCA9IHBhcmFtZXRlcnMubGVuZ3RoOwogICAgICAgICAgICB2YXIgY291bnQgPSBNYXRoLm1pbihjYWxsZXJDb3VudCwgY2FsbGVlQ291bnQpOwogICAgICAgICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICAgICAgICBpZiAoY291bnQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVzaENoaWxkU2NvcGUoKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZHVwKF92bS5SZWdpc3Rlci5mcCwgY2FsbGVyQ291bnQgLSBpKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFZhcmlhYmxlKHBhcmFtZXRlcnNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucHVzaEJsb2NrKGJsb2NrKTsKICAgICAgICAgICAgdGhpcy5yZXNvbHZlQmxvY2soKTsKICAgICAgICAgICAgdGhpcy5pbnZva2VWaXJ0dWFsKCk7CiAgICAgICAgICAgIGlmIChjb3VudCkgewogICAgICAgICAgICAgICAgdGhpcy5wb3BTY29wZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucG9wRnJhbWUoKTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5zdHJpbmcgPSBmdW5jdGlvbiBzdHJpbmcoX3N0cmluZykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdGFudHMuc3RyaW5nKF9zdHJpbmcpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm5hbWVzID0gZnVuY3Rpb24gbmFtZXMoX25hbWVzKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9uYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG4gPSBfbmFtZXNbaV07CiAgICAgICAgICAgICAgICBuYW1lc1tpXSA9IHRoaXMuY29uc3RhbnRzLnN0cmluZyhuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdGFudHMuYXJyYXkobmFtZXMpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnN5bWJvbHMgPSBmdW5jdGlvbiBzeW1ib2xzKF9zeW1ib2xzMikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdGFudHMuYXJyYXkoX3N5bWJvbHMyKTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wcmltaXRpdmUgPSBmdW5jdGlvbiBwcmltaXRpdmUoX3ByaW1pdGl2ZSkgewogICAgICAgICAgICB2YXIgdHlwZSA9IDAgLyogTlVNQkVSICovOwogICAgICAgICAgICB2YXIgcHJpbWl0aXZlID0gdm9pZCAwOwogICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBfcHJpbWl0aXZlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWl0aXZlICUgMSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3ByaW1pdGl2ZSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmltaXRpdmUgPSBfcHJpbWl0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbWl0aXZlID0gdGhpcy5jb25zdGFudHMubnVtYmVyKF9wcmltaXRpdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9IDQgLyogTkVHQVRJVkUgKi87CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwcmltaXRpdmUgPSB0aGlzLmNvbnN0YW50cy5udW1iZXIoX3ByaW1pdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAxIC8qIEZMT0FUICovOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICAgICAgcHJpbWl0aXZlID0gdGhpcy5zdHJpbmcoX3ByaW1pdGl2ZSk7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IDIgLyogU1RSSU5HICovOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICAgICAgICAgICAgcHJpbWl0aXZlID0gX3ByaW1pdGl2ZSB8IDA7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IDMgLyogQk9PTEVBTl9PUl9WT0lEICovOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICAgICAgICAgICAgICAvLyBhc3N1bWUgbnVsbAogICAgICAgICAgICAgICAgICAgIHByaW1pdGl2ZSA9IDI7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IDMgLyogQk9PTEVBTl9PUl9WT0lEICovOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAndW5kZWZpbmVkJzoKICAgICAgICAgICAgICAgICAgICBwcmltaXRpdmUgPSAzOwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAzIC8qIEJPT0xFQU5fT1JfVk9JRCAqLzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHByaW1pdGl2ZSBwYXNzZWQgdG8gcHVzaFByaW1pdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbW1lZGlhdGUgPSB0aGlzLnNpemVJbW1lZGlhdGUocHJpbWl0aXZlIDw8IDMgfCB0eXBlLCBwcmltaXRpdmUpOwogICAgICAgICAgICB0aGlzLnB1c2goMTMgLyogUHJpbWl0aXZlICovLCBpbW1lZGlhdGUpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnNpemVJbW1lZGlhdGUgPSBmdW5jdGlvbiBzaXplSW1tZWRpYXRlKHNoaWZ0ZWQsIHByaW1pdGl2ZSkgewogICAgICAgICAgICBpZiAoc2hpZnRlZCA+PSA2NTUzNSAvKiBNQVhfU0laRSAqLyB8fCBzaGlmdGVkIDwgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLm51bWJlcihwcmltaXRpdmUpIDw8IDMgfCA1IC8qIEJJR19OVU0gKi87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNoaWZ0ZWQ7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaFByaW1pdGl2ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uIHB1c2hQcmltaXRpdmVSZWZlcmVuY2UocHJpbWl0aXZlKSB7CiAgICAgICAgICAgIHRoaXMucHJpbWl0aXZlKHByaW1pdGl2ZSk7CiAgICAgICAgICAgIHRoaXMucHJpbWl0aXZlUmVmZXJlbmNlKCk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaENvbXBvbmVudERlZmluaXRpb24gPSBmdW5jdGlvbiBwdXNoQ29tcG9uZW50RGVmaW5pdGlvbihoYW5kbGUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDcyIC8qIFB1c2hDb21wb25lbnREZWZpbml0aW9uICovLCB0aGlzLmNvbnN0YW50cy5oYW5kbGUoaGFuZGxlKSk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucmVzb2x2ZUR5bmFtaWNDb21wb25lbnQgPSBmdW5jdGlvbiByZXNvbHZlRHluYW1pY0NvbXBvbmVudChyZWZlcnJlcikgewogICAgICAgICAgICB0aGlzLnB1c2goNzUgLyogUmVzb2x2ZUR5bmFtaWNDb21wb25lbnQgKi8sIHRoaXMuY29uc3RhbnRzLnNlcmlhbGl6YWJsZShyZWZlcnJlcikpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnN0YXRpY0NvbXBvbmVudEhlbHBlciA9IGZ1bmN0aW9uIHN0YXRpY0NvbXBvbmVudEhlbHBlcih0YWcsIGhhc2gsIHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHZhciBfY29tcGlsZXIkcmVzb2x2ZUxheW8gPSB0aGlzLmNvbXBpbGVyLnJlc29sdmVMYXlvdXRGb3JUYWcodGFnLCB0aGlzLnJlZmVycmVyKSwKICAgICAgICAgICAgICAgIGhhbmRsZSA9IF9jb21waWxlciRyZXNvbHZlTGF5by5oYW5kbGUsCiAgICAgICAgICAgICAgICBjYXBhYmlsaXRpZXMgPSBfY29tcGlsZXIkcmVzb2x2ZUxheW8uY2FwYWJpbGl0aWVzLAogICAgICAgICAgICAgICAgY29tcGlsYWJsZSA9IF9jb21waWxlciRyZXNvbHZlTGF5by5jb21waWxhYmxlOwoKICAgICAgICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCAmJiBjYXBhYmlsaXRpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChjb21waWxhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoLmxlbmd0aDsgaSA9IGkgKyAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoW2ldWzBdID0gJ0AnICsgaGFzaFtpXVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hDb21wb25lbnREZWZpbml0aW9uKGhhbmRsZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnZva2VTdGF0aWNDb21wb25lbnQoY2FwYWJpbGl0aWVzLCBjb21waWxhYmxlLCBudWxsLCBudWxsLCBoYXNoLCBmYWxzZSwgdGVtcGxhdGUgJiYgdGVtcGxhdGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5pbnZva2VQYXJ0aWFsID0gZnVuY3Rpb24gaW52b2tlUGFydGlhbChyZWZlcnJlciwgc3ltYm9scywgZXZhbEluZm8pIHsKICAgICAgICAgICAgdmFyIF9tZXRhID0gdGhpcy5jb25zdGFudHMuc2VyaWFsaXphYmxlKHJlZmVycmVyKTsKICAgICAgICAgICAgdmFyIF9zeW1ib2xzID0gdGhpcy5jb25zdGFudHMuc3RyaW5nQXJyYXkoc3ltYm9scyk7CiAgICAgICAgICAgIHZhciBfZXZhbEluZm8gPSB0aGlzLmNvbnN0YW50cy5hcnJheShldmFsSW5mbyk7CiAgICAgICAgICAgIHRoaXMucHVzaCg5NSAvKiBJbnZva2VQYXJ0aWFsICovLCBfbWV0YSwgX3N5bWJvbHMsIF9ldmFsSW5mbyk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucmVzb2x2ZU1heWJlTG9jYWwgPSBmdW5jdGlvbiByZXNvbHZlTWF5YmVMb2NhbChuYW1lKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg5NiAvKiBSZXNvbHZlTWF5YmVMb2NhbCAqLywgdGhpcy5zdHJpbmcobmFtZSkpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmRlYnVnZ2VyID0gZnVuY3Rpb24gX2RlYnVnZ2VyKHN5bWJvbHMsIGV2YWxJbmZvKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg5NyAvKiBEZWJ1Z2dlciAqLywgdGhpcy5jb25zdGFudHMuc3RyaW5nQXJyYXkoc3ltYm9scyksIHRoaXMuY29uc3RhbnRzLmFycmF5KGV2YWxJbmZvKSk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUudGV4dCA9IGZ1bmN0aW9uIHRleHQoX3RleHQpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDI2IC8qIFRleHQgKi8sIHRoaXMuY29uc3RhbnRzLnN0cmluZyhfdGV4dCkpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm9wZW5QcmltaXRpdmVFbGVtZW50ID0gZnVuY3Rpb24gb3BlblByaW1pdGl2ZUVsZW1lbnQodGFnKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCgzMyAvKiBPcGVuRWxlbWVudCAqLywgdGhpcy5jb25zdGFudHMuc3RyaW5nKHRhZykpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm1vZGlmaWVyID0gZnVuY3Rpb24gbW9kaWZpZXIobG9jYXRvciwgcGFyYW1zLCBoYXNoKSB7CiAgICAgICAgICAgIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgIHRoaXMuY29tcGlsZUFyZ3MocGFyYW1zLCBoYXNoLCBudWxsLCB0cnVlKTsKICAgICAgICAgICAgdGhpcy5wdXNoKDQwIC8qIE1vZGlmaWVyICovLCB0aGlzLmNvbnN0YW50cy5oYW5kbGUobG9jYXRvcikpOwogICAgICAgICAgICB0aGlzLnBvcEZyYW1lKCk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuY29tbWVudCA9IGZ1bmN0aW9uIGNvbW1lbnQoX2NvbW1lbnQpIHsKICAgICAgICAgICAgdmFyIGNvbW1lbnQgPSB0aGlzLmNvbnN0YW50cy5zdHJpbmcoX2NvbW1lbnQpOwogICAgICAgICAgICB0aGlzLnB1c2goMjcgLyogQ29tbWVudCAqLywgY29tbWVudCk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuZHluYW1pY0F0dHIgPSBmdW5jdGlvbiBkeW5hbWljQXR0cihfbmFtZSwgX25hbWVzcGFjZSwgdHJ1c3RpbmcpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSB0aGlzLmNvbnN0YW50cy5zdHJpbmcoX25hbWUpOwogICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gX25hbWVzcGFjZSA/IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfbmFtZXNwYWNlKSA6IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ29tcG9uZW50QXR0cnMpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVzaCgzNyAvKiBDb21wb25lbnRBdHRyICovLCBuYW1lLCB0cnVzdGluZyA9PT0gdHJ1ZSA/IDEgOiAwLCBuYW1lc3BhY2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoKDM2IC8qIER5bmFtaWNBdHRyICovLCBuYW1lLCB0cnVzdGluZyA9PT0gdHJ1ZSA/IDEgOiAwLCBuYW1lc3BhY2UpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuc3RhdGljQXR0ciA9IGZ1bmN0aW9uIHN0YXRpY0F0dHIoX25hbWUsIF9uYW1lc3BhY2UsIF92YWx1ZSkgewogICAgICAgICAgICB2YXIgbmFtZSA9IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfbmFtZSk7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdGhpcy5jb25zdGFudHMuc3RyaW5nKF9uYW1lc3BhY2UpIDogMDsKICAgICAgICAgICAgaWYgKHRoaXMuaXNDb21wb25lbnRBdHRycykgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoUHJpbWl0aXZlUmVmZXJlbmNlKF92YWx1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2goMzcgLyogQ29tcG9uZW50QXR0ciAqLywgbmFtZSwgMSwgbmFtZXNwYWNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuY29uc3RhbnRzLnN0cmluZyhfdmFsdWUpOwogICAgICAgICAgICAgICAgdGhpcy5wdXNoKDM1IC8qIFN0YXRpY0F0dHIgKi8sIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaGFzQmxvY2tQYXJhbXMgPSBmdW5jdGlvbiBoYXNCbG9ja1BhcmFtcyh0bykgewogICAgICAgICAgICB0aGlzLmdldEJsb2NrKHRvKTsKICAgICAgICAgICAgdGhpcy5yZXNvbHZlQmxvY2soKTsKICAgICAgICAgICAgdGhpcy5wdXNoKDEwIC8qIEhhc0Jsb2NrUGFyYW1zICovKTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5nZXRQcm9wZXJ0eSA9IGZ1bmN0aW9uIGdldFByb3BlcnR5KGtleSkgewogICAgICAgICAgICB0aGlzLnB1c2goNyAvKiBHZXRQcm9wZXJ0eSAqLywgdGhpcy5zdHJpbmcoa2V5KSk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaGVscGVyID0gZnVuY3Rpb24gaGVscGVyKF9oZWxwZXIsIHBhcmFtcywgaGFzaCkgewogICAgICAgICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICAgICAgICB0aGlzLmNvbXBpbGVBcmdzKHBhcmFtcywgaGFzaCwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgICAgIHRoaXMucHVzaCgxIC8qIEhlbHBlciAqLywgdGhpcy5jb25zdGFudHMuaGFuZGxlKF9oZWxwZXIpKTsKICAgICAgICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgICAgICAgICB0aGlzLmZldGNoKF92bS5SZWdpc3Rlci52MCk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuYmluZER5bmFtaWNTY29wZSA9IGZ1bmN0aW9uIGJpbmREeW5hbWljU2NvcGUoX25hbWVzKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0MyAvKiBCaW5kRHluYW1pY1Njb3BlICovLCB0aGlzLm5hbWVzKF9uYW1lcykpOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnJlcGxheWFibGUgPSBmdW5jdGlvbiByZXBsYXlhYmxlKF9yZWYpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBfcmVmLmFyZ3MsCiAgICAgICAgICAgICAgICBib2R5ID0gX3JlZi5ib2R5OwoKICAgICAgICAgICAgLy8gU3RhcnQgYSBuZXcgbGFiZWwgZnJhbWUsIHRvIGdpdmUgRU5EIGFuZCBSRVRVUk4KICAgICAgICAgICAgLy8gYSB1bmlxdWUgbWVhbmluZy4KICAgICAgICAgICAgdGhpcy5zdGFydExhYmVscygpOwogICAgICAgICAgICB0aGlzLnB1c2hGcmFtZSgpOwogICAgICAgICAgICAvLyBJZiB0aGUgYm9keSBpbnZva2VzIGEgYmxvY2ssIGl0cyByZXR1cm4gd2lsbCByZXR1cm4gdG8KICAgICAgICAgICAgLy8gRU5ELiBPdGhlcndpc2UsIHRoZSByZXR1cm4gaW4gUkVUVVJOIHdpbGwgcmV0dXJuIHRvIEVORC4KICAgICAgICAgICAgdGhpcy5yZXR1cm5UbygnRU5ESU5JVElBTCcpOwogICAgICAgICAgICAvLyBQdXNoIHRoZSBhcmd1bWVudHMgb250byB0aGUgc3RhY2suIFRoZSBhcmdzKCkgZnVuY3Rpb24KICAgICAgICAgICAgLy8gdGVsbHMgdXMgaG93IG1hbnkgc3RhY2sgZWxlbWVudHMgdG8gcmV0YWluIGZvciByZS1leGVjdXRpb24KICAgICAgICAgICAgLy8gd2hlbiB1cGRhdGluZy4KICAgICAgICAgICAgdmFyIGNvdW50ID0gYXJncygpOwogICAgICAgICAgICAvLyBTdGFydCBhIG5ldyB1cGRhdGluZyBjbG9zdXJlLCByZW1lbWJlcmluZyBgY291bnRgIGVsZW1lbnRzCiAgICAgICAgICAgIC8vIGZyb20gdGhlIHN0YWNrLiBFdmVyeXRoaW5nIGFmdGVyIHRoaXMgcG9pbnQsIGFuZCBiZWZvcmUgRU5ELAogICAgICAgICAgICAvLyB3aWxsIGV4ZWN1dGUgYm90aCBpbml0aWFsbHkgYW5kIHRvIHVwZGF0ZSB0aGUgYmxvY2suCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIFRoZSBlbnRlciBhbmQgZXhpdCBvcGNvZGVzIGFsc28gdHJhY2sgdGhlIGFyZWEgb2YgdGhlIERPTQogICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHdpdGggdGhpcyBibG9jay4gSWYgYW4gYXNzZXJ0aW9uIGluc2lkZSB0aGUgYmxvY2sKICAgICAgICAgICAgLy8gZmFpbHMgKGZvciBleGFtcGxlLCB0aGUgdGVzdCB2YWx1ZSBjaGFuZ2VzIGZyb20gdHJ1ZSB0byBmYWxzZQogICAgICAgICAgICAvLyBpbiBhbiAjaWYpLCB0aGUgRE9NIGlzIGNsZWFyZWQgYW5kIHRoZSBwcm9ncmFtIGlzIHJlLWV4ZWN1dGVkLAogICAgICAgICAgICAvLyByZXN0b3JpbmcgYGNvdW50YCBlbGVtZW50cyB0byB0aGUgc3RhY2sgYW5kIGV4ZWN1dGluZyB0aGUKICAgICAgICAgICAgLy8gaW5zdHJ1Y3Rpb25zIGJldHdlZW4gdGhlIGVudGVyIGFuZCBleGl0LgogICAgICAgICAgICB0aGlzLmVudGVyKGNvdW50KTsKICAgICAgICAgICAgLy8gRXZhbHVhdGUgdGhlIGJvZHkgb2YgdGhlIGJsb2NrLiBUaGUgYm9keSBvZiB0aGUgYmxvY2sgbWF5CiAgICAgICAgICAgIC8vIHJldHVybiwgd2hpY2ggd2lsbCBqdW1wIGV4ZWN1dGlvbiB0byBFTkQgZHVyaW5nIGluaXRpYWwKICAgICAgICAgICAgLy8gZXhlY3V0aW9uLCBhbmQgZXhpdCB0aGUgdXBkYXRpbmcgcm91dGluZS4KICAgICAgICAgICAgYm9keSgpOwogICAgICAgICAgICAvLyBBbGwgZXhlY3V0aW9uIHBhdGhzIGluIHRoZSBib2R5IHNob3VsZCBydW4gdGhlIEZJTkFMTFkgb25jZQogICAgICAgICAgICAvLyB0aGV5IGFyZSBkb25lLiBJdCBpcyBleGVjdXRlZCBib3RoIGR1cmluZyBpbml0aWFsIGV4ZWN1dGlvbgogICAgICAgICAgICAvLyBhbmQgZHVyaW5nIHVwZGF0aW5nIGV4ZWN1dGlvbi4KICAgICAgICAgICAgdGhpcy5sYWJlbCgnRklOQUxMWScpOwogICAgICAgICAgICAvLyBGaW5hbGl6ZSB0aGUgRE9NLgogICAgICAgICAgICB0aGlzLmV4aXQoKTsKICAgICAgICAgICAgLy8gSW4gaW5pdGlhbCBleGVjdXRpb24sIHRoaXMgaXMgYSBub29wOiBpdCByZXR1cm5zIHRvIHRoZQogICAgICAgICAgICAvLyBpbW1lZGlhdGVseSBmb2xsb3dpbmcgb3Bjb2RlLiBJbiB1cGRhdGluZyBleGVjdXRpb24sIHRoaXMKICAgICAgICAgICAgLy8gZXhpdHMgdGhlIHVwZGF0aW5nIHJvdXRpbmUuCiAgICAgICAgICAgIHRoaXMucmV0dXJuKCk7CiAgICAgICAgICAgIC8vIENsZWFudXAgY29kZSBmb3IgdGhlIGJsb2NrLiBSdW5zIG9uIGluaXRpYWwgZXhlY3V0aW9uCiAgICAgICAgICAgIC8vIGJ1dCBub3Qgb24gdXBkYXRpbmcuCiAgICAgICAgICAgIHRoaXMubGFiZWwoJ0VORElOSVRJQUwnKTsKICAgICAgICAgICAgdGhpcy5wb3BGcmFtZSgpOwogICAgICAgICAgICB0aGlzLnN0b3BMYWJlbHMoKTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXBsYXlhYmxlSWYgPSBmdW5jdGlvbiByZXBsYXlhYmxlSWYoX3JlZjIpIHsKICAgICAgICAgICAgdmFyIF90aGlzNyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgYXJncyA9IF9yZWYyLmFyZ3MsCiAgICAgICAgICAgICAgICBpZlRydWUgPSBfcmVmMi5pZlRydWUsCiAgICAgICAgICAgICAgICBpZkZhbHNlID0gX3JlZjIuaWZGYWxzZTsKCiAgICAgICAgICAgIHRoaXMucmVwbGF5YWJsZSh7CiAgICAgICAgICAgICAgICBhcmdzOiBhcmdzLAogICAgICAgICAgICAgICAgYm9keTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBjb25kaXRpb25hbCBpcyBmYWxzZSwganVtcCB0byB0aGUgRUxTRSBsYWJlbC4KICAgICAgICAgICAgICAgICAgICBfdGhpczcuanVtcFVubGVzcygnRUxTRScpOwogICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgZXhlY3V0ZSB0aGUgY29kZSBhc3NvY2lhdGVkIHdpdGggdGhlIHRydWUgYnJhbmNoLgogICAgICAgICAgICAgICAgICAgIGlmVHJ1ZSgpOwogICAgICAgICAgICAgICAgICAgIC8vIFdlJ3JlIGRvbmUsIHNvIHJldHVybi4gSW4gdGhlIGluaXRpYWwgZXhlY3V0aW9uLCB0aGlzIHJ1bnMKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY2xlYW51cCBjb2RlLiBJbiB0aGUgdXBkYXRpbmcgVk0sIGl0IGV4aXRzIHRoZSB1cGRhdGluZwogICAgICAgICAgICAgICAgICAgIC8vIHJvdXRpbmUuCiAgICAgICAgICAgICAgICAgICAgX3RoaXM3Lmp1bXAoJ0ZJTkFMTFknKTsKICAgICAgICAgICAgICAgICAgICBfdGhpczcubGFiZWwoJ0VMU0UnKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgY29uZGl0aW9uYWwgaXMgZmFsc2UsIGFuZCBjb2RlIGFzc29jaWF0aWVkIGl0aCB0aGUKICAgICAgICAgICAgICAgICAgICAvLyBmYWxzZSBicmFuY2ggd2FzIHByb3ZpZGVkLCBleGVjdXRlIGl0LiBJZiB0aGVyZSB3YXMgbm8gY29kZQogICAgICAgICAgICAgICAgICAgIC8vIGFzc29jaWF0ZWQgd2l0aCB0aGUgZmFsc2UgYnJhbmNoLCBqdW1waW5nIHRvIHRoZSBlbHNlIHN0YXRlbWVudAogICAgICAgICAgICAgICAgICAgIC8vIGhhcyBubyBvdGhlciBiZWhhdmlvci4KICAgICAgICAgICAgICAgICAgICBpZiAoaWZGYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZkZhbHNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5pbmxpbmVCbG9jayA9IGZ1bmN0aW9uIGlubGluZUJsb2NrKGJsb2NrKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ29tcGlsYWJsZUJsb2NrKHRoaXMuY29tcGlsZXIsIHsKICAgICAgICAgICAgICAgIGJsb2NrOiBibG9jaywKICAgICAgICAgICAgICAgIGNvbnRhaW5pbmdMYXlvdXQ6IHRoaXMuY29udGFpbmluZ0xheW91dAogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5ldmFsU3ltYm9scyA9IGZ1bmN0aW9uIGV2YWxTeW1ib2xzKCkgewogICAgICAgICAgICB2YXIgYmxvY2sgPSB0aGlzLmNvbnRhaW5pbmdMYXlvdXQuYmxvY2s7CgogICAgICAgICAgICByZXR1cm4gYmxvY2suaGFzRXZhbCA/IGJsb2NrLnN5bWJvbHMgOiBudWxsOwogICAgICAgIH07CgogICAgICAgIE9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmNvbXBpbGVQYXJhbXMgPSBmdW5jdGlvbiBjb21waWxlUGFyYW1zKHBhcmFtcykgewogICAgICAgICAgICBpZiAoIXBhcmFtcykgcmV0dXJuIDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmV4cHIocGFyYW1zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFyYW1zLmxlbmd0aDsKICAgICAgICB9OwoKICAgICAgICBPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5jb21waWxlQXJncyA9IGZ1bmN0aW9uIGNvbXBpbGVBcmdzKHBhcmFtcywgaGFzaCwgYmxvY2tzLCBzeW50aGV0aWMpIHsKICAgICAgICAgICAgaWYgKGJsb2NrcykgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoWWllbGRhYmxlQmxvY2soYmxvY2tzLm1haW4pOwogICAgICAgICAgICAgICAgdGhpcy5wdXNoWWllbGRhYmxlQmxvY2soYmxvY2tzLmVsc2UpOwogICAgICAgICAgICAgICAgdGhpcy5wdXNoWWllbGRhYmxlQmxvY2soYmxvY2tzLmF0dHJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY291bnQgPSB0aGlzLmNvbXBpbGVQYXJhbXMocGFyYW1zKTsKICAgICAgICAgICAgdmFyIGZsYWdzID0gY291bnQgPDwgNDsKICAgICAgICAgICAgaWYgKHN5bnRoZXRpYykgZmxhZ3MgfD0gODsKICAgICAgICAgICAgaWYgKGJsb2NrcykgewogICAgICAgICAgICAgICAgZmxhZ3MgfD0gNzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgICAgICAgaWYgKGhhc2gpIHsKICAgICAgICAgICAgICAgIG5hbWVzID0gaGFzaFswXTsKICAgICAgICAgICAgICAgIHZhciB2YWwgPSBoYXNoWzFdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cHIodmFsW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnB1c2hBcmdzKG5hbWVzLCBmbGFncyk7CiAgICAgICAgfTsKCiAgICAgICAgT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUudGVtcGxhdGUgPSBmdW5jdGlvbiB0ZW1wbGF0ZShibG9jaykgewogICAgICAgICAgICBpZiAoIWJsb2NrKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5saW5lQmxvY2soYmxvY2spOwogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoT3Bjb2RlQnVpbGRlciwgW3sKICAgICAgICAgICAga2V5OiAncmVmZXJyZXInLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5pbmdMYXlvdXQgJiYgdGhpcy5jb250YWluaW5nTGF5b3V0LnJlZmVycmVyOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBPcGNvZGVCdWlsZGVyOwogICAgfShTdGRPcGNvZGVCdWlsZGVyKTsKCiAgICB2YXIgTGF6eU9wY29kZUJ1aWxkZXIgPSBmdW5jdGlvbiAoX09wY29kZUJ1aWxkZXIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKExhenlPcGNvZGVCdWlsZGVyLCBfT3Bjb2RlQnVpbGRlcik7CgogICAgICAgIGZ1bmN0aW9uIExhenlPcGNvZGVCdWlsZGVyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIExhenlPcGNvZGVCdWlsZGVyKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfT3Bjb2RlQnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIExhenlPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoQmxvY2sgPSBmdW5jdGlvbiBwdXNoQmxvY2soYmxvY2spIHsKICAgICAgICAgICAgaWYgKGJsb2NrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hPdGhlcihibG9jayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnByaW1pdGl2ZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIExhenlPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXNvbHZlQmxvY2sgPSBmdW5jdGlvbiByZXNvbHZlQmxvY2soKSB7CiAgICAgICAgICAgIHRoaXMucHVzaCg0NiAvKiBDb21waWxlQmxvY2sgKi8pOwogICAgICAgIH07CgogICAgICAgIExhenlPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoTGF5b3V0ID0gZnVuY3Rpb24gcHVzaExheW91dChsYXlvdXQpIHsKICAgICAgICAgICAgaWYgKGxheW91dCkgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoT3RoZXIobGF5b3V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucHJpbWl0aXZlKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTGF6eU9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnJlc29sdmVMYXlvdXQgPSBmdW5jdGlvbiByZXNvbHZlTGF5b3V0KCkgewogICAgICAgICAgICB0aGlzLnB1c2goNDYgLyogQ29tcGlsZUJsb2NrICovKTsKICAgICAgICB9OwoKICAgICAgICBMYXp5T3Bjb2RlQnVpbGRlci5wcm90b3R5cGUuaW52b2tlU3RhdGljID0gZnVuY3Rpb24gaW52b2tlU3RhdGljKGNvbXBpbGFibGUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoT3RoZXIoY29tcGlsYWJsZSk7CiAgICAgICAgICAgIHRoaXMucHVzaCg0NiAvKiBDb21waWxlQmxvY2sgKi8pOwogICAgICAgICAgICB0aGlzLnB1c2hNYWNoaW5lKDQ5IC8qIEludm9rZVZpcnR1YWwgKi8pOwogICAgICAgIH07CgogICAgICAgIExhenlPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5wdXNoT3RoZXIgPSBmdW5jdGlvbiBwdXNoT3RoZXIodmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5wdXNoKDEyIC8qIENvbnN0YW50ICovLCB0aGlzLm90aGVyKHZhbHVlKSk7CiAgICAgICAgfTsKCiAgICAgICAgTGF6eU9wY29kZUJ1aWxkZXIucHJvdG90eXBlLm90aGVyID0gZnVuY3Rpb24gb3RoZXIodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLm90aGVyKHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGF6eU9wY29kZUJ1aWxkZXI7CiAgICB9KE9wY29kZUJ1aWxkZXIpOwoKICAgIHZhciBFYWdlck9wY29kZUJ1aWxkZXIgPSBmdW5jdGlvbiAoX09wY29kZUJ1aWxkZXIyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShFYWdlck9wY29kZUJ1aWxkZXIsIF9PcGNvZGVCdWlsZGVyMik7CgogICAgICAgIGZ1bmN0aW9uIEVhZ2VyT3Bjb2RlQnVpbGRlcigpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBFYWdlck9wY29kZUJ1aWxkZXIpOwogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9PcGNvZGVCdWlsZGVyMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIEVhZ2VyT3Bjb2RlQnVpbGRlci5wcm90b3R5cGUucHVzaEJsb2NrID0gZnVuY3Rpb24gcHVzaEJsb2NrKGJsb2NrKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGUgPSBibG9jayA/IGJsb2NrLmNvbXBpbGUoKSA6IG51bGw7CiAgICAgICAgICAgIHRoaXMucHJpbWl0aXZlKGhhbmRsZSk7CiAgICAgICAgfTsKCiAgICAgICAgRWFnZXJPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXNvbHZlQmxvY2sgPSBmdW5jdGlvbiByZXNvbHZlQmxvY2soKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9OwoKICAgICAgICBFYWdlck9wY29kZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hMYXlvdXQgPSBmdW5jdGlvbiBwdXNoTGF5b3V0KGxheW91dCkgewogICAgICAgICAgICBpZiAobGF5b3V0KSB7CiAgICAgICAgICAgICAgICB0aGlzLnByaW1pdGl2ZShsYXlvdXQuY29tcGlsZSgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucHJpbWl0aXZlKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRWFnZXJPcGNvZGVCdWlsZGVyLnByb3RvdHlwZS5yZXNvbHZlTGF5b3V0ID0gZnVuY3Rpb24gcmVzb2x2ZUxheW91dCgpIHt9OwoKICAgICAgICBFYWdlck9wY29kZUJ1aWxkZXIucHJvdG90eXBlLmludm9rZVN0YXRpYyA9IGZ1bmN0aW9uIGludm9rZVN0YXRpYyhjb21waWxhYmxlKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGUgPSBjb21waWxhYmxlLmNvbXBpbGUoKTsKICAgICAgICAgICAgLy8gSWYgdGhlIGhhbmRsZSBmb3IgdGhlIGludm9rZWQgY29tcG9uZW50IGlzIG5vdCB5ZXQga25vd24gKGZvciBleGFtcGxlLAogICAgICAgICAgICAvLyBiZWNhdXNlIHRoaXMgaXMgYSByZWN1cnNpdmUgaW52b2NhdGlvbiBhbmQgd2UncmUgc3RpbGwgY29tcGlsaW5nKSwgcHVzaCBhCiAgICAgICAgICAgIC8vIGZ1bmN0aW9uIHRoYXQgd2lsbCBwcm9kdWNlIHRoZSBjb3JyZWN0IGhhbmRsZSB3aGVuIHRoZSBoZWFwIGlzCiAgICAgICAgICAgIC8vIHNlcmlhbGl6ZWQuCiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IFBMQUNFSE9MREVSX0hBTkRMRSQxKSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hNYWNoaW5lKDUwIC8qIEludm9rZVN0YXRpYyAqLywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb21waWxhYmxlLmNvbXBpbGUoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5wdXNoTWFjaGluZSg1MCAvKiBJbnZva2VTdGF0aWMgKi8sIGhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRWFnZXJPcGNvZGVCdWlsZGVyOwogICAgfShPcGNvZGVCdWlsZGVyKTsKCiAgICB2YXIgTGF6eUNvbXBpbGVyID0gZnVuY3Rpb24gKF9BYnN0cmFjdENvbXBpbGVyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShMYXp5Q29tcGlsZXIsIF9BYnN0cmFjdENvbXBpbGVyKTsKCiAgICAgICAgLy8gRklYTUU6IHR1cm4gdG8gc3RhdGljIG1ldGhvZAogICAgICAgIGZ1bmN0aW9uIExhenlDb21waWxlcihsb29rdXAsIHJlc29sdmVyLCBtYWNyb3MpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBMYXp5Q29tcGlsZXIpOwoKICAgICAgICAgICAgdmFyIGNvbnN0YW50cyA9IG5ldyBfcHJvZ3JhbS5MYXp5Q29uc3RhbnRzKHJlc29sdmVyKTsKICAgICAgICAgICAgdmFyIHByb2dyYW0gPSBuZXcgX3Byb2dyYW0uUHJvZ3JhbShjb25zdGFudHMpOwogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9BYnN0cmFjdENvbXBpbGVyLmNhbGwodGhpcywgbWFjcm9zLCBwcm9ncmFtLCBsb29rdXApKTsKICAgICAgICB9CgogICAgICAgIExhenlDb21waWxlci5wcm90b3R5cGUuYnVpbGRlckZvciA9IGZ1bmN0aW9uIGJ1aWxkZXJGb3IoY29udGFpbmluZ0xheW91dCkgewogICAgICAgICAgICByZXR1cm4gbmV3IExhenlPcGNvZGVCdWlsZGVyKHRoaXMsIGNvbnRhaW5pbmdMYXlvdXQpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBMYXp5Q29tcGlsZXI7CiAgICB9KEFic3RyYWN0Q29tcGlsZXIpOwoKICAgIHZhciBQYXJ0aWFsRGVmaW5pdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBQYXJ0aWFsRGVmaW5pdGlvbihuYW1lLCAvLyBmb3IgZGVidWdnaW5nCiAgICAgICAgdGVtcGxhdGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBQYXJ0aWFsRGVmaW5pdGlvbik7CgogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLnRlbXBsYXRlID0gdGVtcGxhdGU7CiAgICAgICAgfQoKICAgICAgICBQYXJ0aWFsRGVmaW5pdGlvbi5wcm90b3R5cGUuZ2V0UGFydGlhbCA9IGZ1bmN0aW9uIGdldFBhcnRpYWwoKSB7CiAgICAgICAgICAgIHZhciBwYXJ0aWFsID0gdGhpcy50ZW1wbGF0ZS5hc1BhcnRpYWwoKTsKICAgICAgICAgICAgdmFyIGhhbmRsZSA9IHBhcnRpYWwuY29tcGlsZSgpOwogICAgICAgICAgICByZXR1cm4geyBzeW1ib2xUYWJsZTogcGFydGlhbC5zeW1ib2xUYWJsZSwgaGFuZGxlOiBoYW5kbGUgfTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUGFydGlhbERlZmluaXRpb247CiAgICB9KCk7CgogICAgdmFyIGNsaWVudElkID0gMDsKICAgIGZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShfcmVmMykgewogICAgICAgIHZhciB0ZW1wbGF0ZUlkID0gX3JlZjMuaWQsCiAgICAgICAgICAgIG1ldGEgPSBfcmVmMy5tZXRhLAogICAgICAgICAgICBibG9jayA9IF9yZWYzLmJsb2NrOwoKICAgICAgICB2YXIgcGFyc2VkQmxvY2sgPSB2b2lkIDA7CiAgICAgICAgdmFyIGlkID0gdGVtcGxhdGVJZCB8fCAnY2xpZW50LScgKyBjbGllbnRJZCsrOwogICAgICAgIHZhciBjcmVhdGUgPSBmdW5jdGlvbiAoY29tcGlsZXIsIGVudk1ldGEpIHsKICAgICAgICAgICAgdmFyIG5ld01ldGEgPSBlbnZNZXRhID8gKDAsIF91dGlsLmFzc2lnbikoe30sIGVudk1ldGEsIG1ldGEpIDogbWV0YTsKICAgICAgICAgICAgaWYgKCFwYXJzZWRCbG9jaykgewogICAgICAgICAgICAgICAgcGFyc2VkQmxvY2sgPSBKU09OLnBhcnNlKGJsb2NrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRlbXBsYXRlSW1wbChjb21waWxlciwgeyBpZDogaWQsIGJsb2NrOiBwYXJzZWRCbG9jaywgcmVmZXJyZXI6IG5ld01ldGEgfSk7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4geyBpZDogaWQsIG1ldGE6IG1ldGEsIGNyZWF0ZTogY3JlYXRlIH07CiAgICB9CgogICAgdmFyIFRlbXBsYXRlSW1wbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUZW1wbGF0ZUltcGwoY29tcGlsZXIsIHBhcnNlZExheW91dCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFRlbXBsYXRlSW1wbCk7CgogICAgICAgICAgICB0aGlzLmNvbXBpbGVyID0gY29tcGlsZXI7CiAgICAgICAgICAgIHRoaXMucGFyc2VkTGF5b3V0ID0gcGFyc2VkTGF5b3V0OwogICAgICAgICAgICB0aGlzLmxheW91dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucGFydGlhbCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMud3JhcHBlZExheW91dCA9IG51bGw7CiAgICAgICAgICAgIHZhciBibG9jayA9IHBhcnNlZExheW91dC5ibG9jazsKCiAgICAgICAgICAgIHRoaXMuc3ltYm9scyA9IGJsb2NrLnN5bWJvbHM7CiAgICAgICAgICAgIHRoaXMuaGFzRXZhbCA9IGJsb2NrLmhhc0V2YWw7CiAgICAgICAgICAgIHRoaXMucmVmZXJyZXIgPSBwYXJzZWRMYXlvdXQucmVmZXJyZXI7CiAgICAgICAgICAgIHRoaXMuaWQgPSBwYXJzZWRMYXlvdXQuaWQgfHwgJ2NsaWVudC0nICsgY2xpZW50SWQrKzsKICAgICAgICB9CgogICAgICAgIFRlbXBsYXRlSW1wbC5wcm90b3R5cGUuYXNMYXlvdXQgPSBmdW5jdGlvbiBhc0xheW91dCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGF5b3V0KSByZXR1cm4gdGhpcy5sYXlvdXQ7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheW91dCA9IG5ldyBDb21waWxhYmxlUHJvZ3JhbSh0aGlzLmNvbXBpbGVyLCAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCB0aGlzLnBhcnNlZExheW91dCwgeyBhc1BhcnRpYWw6IGZhbHNlIH0pKTsKICAgICAgICB9OwoKICAgICAgICBUZW1wbGF0ZUltcGwucHJvdG90eXBlLmFzUGFydGlhbCA9IGZ1bmN0aW9uIGFzUGFydGlhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFydGlhbCkgcmV0dXJuIHRoaXMucGFydGlhbDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0ID0gbmV3IENvbXBpbGFibGVQcm9ncmFtKHRoaXMuY29tcGlsZXIsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHRoaXMucGFyc2VkTGF5b3V0LCB7IGFzUGFydGlhbDogdHJ1ZSB9KSk7CiAgICAgICAgfTsKCiAgICAgICAgVGVtcGxhdGVJbXBsLnByb3RvdHlwZS5hc1dyYXBwZWRMYXlvdXQgPSBmdW5jdGlvbiBhc1dyYXBwZWRMYXlvdXQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLndyYXBwZWRMYXlvdXQpIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQ7CiAgICAgICAgICAgIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQgPSBuZXcgV3JhcHBlZEJ1aWxkZXIodGhpcy5jb21waWxlciwgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgdGhpcy5wYXJzZWRMYXlvdXQsIHsgYXNQYXJ0aWFsOiBmYWxzZSB9KSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFRlbXBsYXRlSW1wbDsKICAgIH0oKTsKCiAgICBleHBvcnRzLkFUVFJTX0JMT0NLID0gQVRUUlNfQkxPQ0s7CiAgICBleHBvcnRzLk1hY3JvcyA9IE1hY3JvczsKICAgIGV4cG9ydHMuTGF6eUNvbXBpbGVyID0gTGF6eUNvbXBpbGVyOwogICAgZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTsKICAgIGV4cG9ydHMuQWJzdHJhY3RDb21waWxlciA9IEFic3RyYWN0Q29tcGlsZXI7CiAgICBleHBvcnRzLmRlYnVnQ29tcGlsZXIgPSBkZWJ1Z0NvbXBpbGVyOwogICAgZXhwb3J0cy5Db21waWxhYmxlQmxvY2sgPSBDb21waWxhYmxlQmxvY2s7CiAgICBleHBvcnRzLkNvbXBpbGFibGVQcm9ncmFtID0gQ29tcGlsYWJsZVByb2dyYW07CiAgICBleHBvcnRzLkxhenlPcGNvZGVCdWlsZGVyID0gTGF6eU9wY29kZUJ1aWxkZXI7CiAgICBleHBvcnRzLkVhZ2VyT3Bjb2RlQnVpbGRlciA9IEVhZ2VyT3Bjb2RlQnVpbGRlcjsKICAgIGV4cG9ydHMuT3Bjb2RlQnVpbGRlciA9IE9wY29kZUJ1aWxkZXI7CiAgICBleHBvcnRzLlN0ZE9wY29kZUJ1aWxkZXIgPSBTdGRPcGNvZGVCdWlsZGVyOwogICAgZXhwb3J0cy5QYXJ0aWFsRGVmaW5pdGlvbiA9IFBhcnRpYWxEZWZpbml0aW9uOwogICAgZXhwb3J0cy50ZW1wbGF0ZUZhY3RvcnkgPSB0ZW1wbGF0ZUZhY3Rvcnk7CiAgICBleHBvcnRzLmRlYnVnID0gZGVidWc7CiAgICBleHBvcnRzLmRlYnVnU2xpY2UgPSBkZWJ1Z1NsaWNlOwogICAgZXhwb3J0cy5sb2dPcGNvZGUgPSBsb2dPcGNvZGU7CiAgICBleHBvcnRzLldyYXBwZWRCdWlsZGVyID0gV3JhcHBlZEJ1aWxkZXI7CiAgICBleHBvcnRzLlBMQUNFSE9MREVSX0hBTkRMRSA9IFBMQUNFSE9MREVSX0hBTkRMRTsKfSk7CmVuaWZlZCgnQGdsaW1tZXIvcHJvZ3JhbScsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdAZ2xpbW1lci91dGlsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuT3Bjb2RlID0gZXhwb3J0cy5Qcm9ncmFtID0gZXhwb3J0cy5SdW50aW1lUHJvZ3JhbSA9IGV4cG9ydHMuV3JpdGVPbmx5UHJvZ3JhbSA9IGV4cG9ydHMuSGVhcCA9IGV4cG9ydHMuTGF6eUNvbnN0YW50cyA9IGV4cG9ydHMuQ29uc3RhbnRzID0gZXhwb3J0cy5SdW50aW1lQ29uc3RhbnRzID0gZXhwb3J0cy5Xcml0ZU9ubHlDb25zdGFudHMgPSBleHBvcnRzLldFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT04gPSB1bmRlZmluZWQ7CgoKICAgIHZhciBVTlJFU09MVkVEID0ge307CiAgICB2YXIgV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTiA9IDA7CiAgICB2YXIgV0VMTF9LTk9XX0VNUFRZX0FSUkFZID0gT2JqZWN0LmZyZWV6ZShbXSk7CgogICAgdmFyIFdyaXRlT25seUNvbnN0YW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBXcml0ZU9ubHlDb25zdGFudHMoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgV3JpdGVPbmx5Q29uc3RhbnRzKTsKCiAgICAgICAgICAgIC8vIGAwYCBtZWFucyBOVUxMCiAgICAgICAgICAgIHRoaXMuc3RyaW5ncyA9IFtdOwogICAgICAgICAgICB0aGlzLmFycmF5cyA9IFtXRUxMX0tOT1dfRU1QVFlfQVJSQVldOwogICAgICAgICAgICB0aGlzLnRhYmxlcyA9IFtdOwogICAgICAgICAgICB0aGlzLmhhbmRsZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5yZXNvbHZlZCA9IFtdOwogICAgICAgICAgICB0aGlzLm51bWJlcnMgPSBbXTsKICAgICAgICB9CgogICAgICAgIFdyaXRlT25seUNvbnN0YW50cy5wcm90b3R5cGUuc3RyaW5nID0gZnVuY3Rpb24gc3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuc3RyaW5ncy5pbmRleE9mKHZhbHVlKTsKICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnB1c2godmFsdWUpIC0gMTsKICAgICAgICB9OwoKICAgICAgICBXcml0ZU9ubHlDb25zdGFudHMucHJvdG90eXBlLnN0cmluZ0FycmF5ID0gZnVuY3Rpb24gc3RyaW5nQXJyYXkoc3RyaW5ncykgewogICAgICAgICAgICB2YXIgX3N0cmluZ3MgPSBuZXcgQXJyYXkoc3RyaW5ncy5sZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIF9zdHJpbmdzW2ldID0gdGhpcy5zdHJpbmcoc3RyaW5nc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXkoX3N0cmluZ3MpOwogICAgICAgIH07CgogICAgICAgIFdyaXRlT25seUNvbnN0YW50cy5wcm90b3R5cGUuYXJyYXkgPSBmdW5jdGlvbiBhcnJheSh2YWx1ZXMpIHsKICAgICAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBXRUxMX0tOT1dOX0VNUFRZX0FSUkFZX1BPU0lUSU9OOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuYXJyYXlzLmluZGV4T2YodmFsdWVzKTsKICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheXMucHVzaCh2YWx1ZXMpIC0gMTsKICAgICAgICB9OwoKICAgICAgICBXcml0ZU9ubHlDb25zdGFudHMucHJvdG90eXBlLmhhbmRsZSA9IGZ1bmN0aW9uIGhhbmRsZShfaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuaGFuZGxlcy5pbmRleE9mKF9oYW5kbGUpOwogICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVzb2x2ZWQucHVzaChVTlJFU09MVkVEKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlcy5wdXNoKF9oYW5kbGUpIC0gMTsKICAgICAgICB9OwoKICAgICAgICBXcml0ZU9ubHlDb25zdGFudHMucHJvdG90eXBlLnNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIHNlcmlhbGl6YWJsZSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgc3RyID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLnN0cmluZ3MuaW5kZXhPZihzdHIpOwogICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MucHVzaChzdHIpIC0gMTsKICAgICAgICB9OwoKICAgICAgICBXcml0ZU9ubHlDb25zdGFudHMucHJvdG90eXBlLm51bWJlciA9IGZ1bmN0aW9uIG51bWJlcihfbnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMubnVtYmVycy5pbmRleE9mKF9udW1iZXIpOwogICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLm51bWJlcnMucHVzaChfbnVtYmVyKSAtIDE7CiAgICAgICAgfTsKCiAgICAgICAgV3JpdGVPbmx5Q29uc3RhbnRzLnByb3RvdHlwZS50b1Bvb2wgPSBmdW5jdGlvbiB0b1Bvb2woKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBzdHJpbmdzOiB0aGlzLnN0cmluZ3MsCiAgICAgICAgICAgICAgICBhcnJheXM6IHRoaXMuYXJyYXlzLAogICAgICAgICAgICAgICAgaGFuZGxlczogdGhpcy5oYW5kbGVzLAogICAgICAgICAgICAgICAgbnVtYmVyczogdGhpcy5udW1iZXJzCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFdyaXRlT25seUNvbnN0YW50czsKICAgIH0oKTsKCiAgICB2YXIgUnVudGltZUNvbnN0YW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBSdW50aW1lQ29uc3RhbnRzKHJlc29sdmVyLCBwb29sKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUnVudGltZUNvbnN0YW50cyk7CgogICAgICAgICAgICB0aGlzLnJlc29sdmVyID0gcmVzb2x2ZXI7CiAgICAgICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvb2wuc3RyaW5nczsKICAgICAgICAgICAgdGhpcy5hcnJheXMgPSBwb29sLmFycmF5czsKICAgICAgICAgICAgdGhpcy5oYW5kbGVzID0gcG9vbC5oYW5kbGVzOwogICAgICAgICAgICB0aGlzLnJlc29sdmVkID0gdGhpcy5oYW5kbGVzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVU5SRVNPTFZFRDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMubnVtYmVycyA9IHBvb2wubnVtYmVyczsKICAgICAgICB9CgogICAgICAgIFJ1bnRpbWVDb25zdGFudHMucHJvdG90eXBlLmdldFN0cmluZyA9IGZ1bmN0aW9uIGdldFN0cmluZyh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzW3ZhbHVlXTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lQ29uc3RhbnRzLnByb3RvdHlwZS5nZXROdW1iZXIgPSBmdW5jdGlvbiBnZXROdW1iZXIodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyc1t2YWx1ZV07CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZUNvbnN0YW50cy5wcm90b3R5cGUuZ2V0U3RyaW5nQXJyYXkgPSBmdW5jdGlvbiBnZXRTdHJpbmdBcnJheSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSB0aGlzLmdldEFycmF5KHZhbHVlKTsKICAgICAgICAgICAgdmFyIF9uYW1lcyA9IG5ldyBBcnJheShuYW1lcy5sZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IG5hbWVzW2ldOwogICAgICAgICAgICAgICAgX25hbWVzW2ldID0gdGhpcy5nZXRTdHJpbmcobik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9uYW1lczsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lQ29uc3RhbnRzLnByb3RvdHlwZS5nZXRBcnJheSA9IGZ1bmN0aW9uIGdldEFycmF5KHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFycmF5c1t2YWx1ZV07CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZUNvbnN0YW50cy5wcm90b3R5cGUucmVzb2x2ZUhhbmRsZSA9IGZ1bmN0aW9uIHJlc29sdmVIYW5kbGUoaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHJlc29sdmVkID0gdGhpcy5yZXNvbHZlZFtpbmRleF07CiAgICAgICAgICAgIGlmIChyZXNvbHZlZCA9PT0gVU5SRVNPTFZFRCkgewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMuaGFuZGxlc1tpbmRleF07CiAgICAgICAgICAgICAgICByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZWRbaW5kZXhdID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlKGhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkOwogICAgICAgIH07CgogICAgICAgIFJ1bnRpbWVDb25zdGFudHMucHJvdG90eXBlLmdldFNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIGdldFNlcmlhbGl6YWJsZShzKSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHRoaXMuc3RyaW5nc1tzXSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJ1bnRpbWVDb25zdGFudHM7CiAgICB9KCk7CgogICAgdmFyIENvbnN0YW50cyA9IGZ1bmN0aW9uIChfV3JpdGVPbmx5Q29uc3RhbnRzKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShDb25zdGFudHMsIF9Xcml0ZU9ubHlDb25zdGFudHMpOwoKICAgICAgICBmdW5jdGlvbiBDb25zdGFudHMocmVzb2x2ZXIsIHBvb2wpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb25zdGFudHMpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9Xcml0ZU9ubHlDb25zdGFudHMuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpcy5yZXNvbHZlciA9IHJlc29sdmVyOwogICAgICAgICAgICBpZiAocG9vbCkgewogICAgICAgICAgICAgICAgX3RoaXMuc3RyaW5ncyA9IHBvb2wuc3RyaW5nczsKICAgICAgICAgICAgICAgIF90aGlzLmFycmF5cyA9IHBvb2wuYXJyYXlzOwogICAgICAgICAgICAgICAgX3RoaXMuaGFuZGxlcyA9IHBvb2wuaGFuZGxlczsKICAgICAgICAgICAgICAgIF90aGlzLnJlc29sdmVkID0gX3RoaXMuaGFuZGxlcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBVTlJFU09MVkVEOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBfdGhpcy5udW1iZXJzID0gcG9vbC5udW1iZXJzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfdGhpczsKICAgICAgICB9CgogICAgICAgIENvbnN0YW50cy5wcm90b3R5cGUuZ2V0TnVtYmVyID0gZnVuY3Rpb24gZ2V0TnVtYmVyKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm51bWJlcnNbdmFsdWVdOwogICAgICAgIH07CgogICAgICAgIENvbnN0YW50cy5wcm90b3R5cGUuZ2V0U3RyaW5nID0gZnVuY3Rpb24gZ2V0U3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3NbdmFsdWVdOwogICAgICAgIH07CgogICAgICAgIENvbnN0YW50cy5wcm90b3R5cGUuZ2V0U3RyaW5nQXJyYXkgPSBmdW5jdGlvbiBnZXRTdHJpbmdBcnJheSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSB0aGlzLmdldEFycmF5KHZhbHVlKTsKICAgICAgICAgICAgdmFyIF9uYW1lcyA9IG5ldyBBcnJheShuYW1lcy5sZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IG5hbWVzW2ldOwogICAgICAgICAgICAgICAgX25hbWVzW2ldID0gdGhpcy5nZXRTdHJpbmcobik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9uYW1lczsKICAgICAgICB9OwoKICAgICAgICBDb25zdGFudHMucHJvdG90eXBlLmdldEFycmF5ID0gZnVuY3Rpb24gZ2V0QXJyYXkodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlzW3ZhbHVlXTsKICAgICAgICB9OwoKICAgICAgICBDb25zdGFudHMucHJvdG90eXBlLnJlc29sdmVIYW5kbGUgPSBmdW5jdGlvbiByZXNvbHZlSGFuZGxlKGluZGV4KSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZWRbaW5kZXhdOwogICAgICAgICAgICBpZiAocmVzb2x2ZWQgPT09IFVOUkVTT0xWRUQpIHsKICAgICAgICAgICAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZXNbaW5kZXhdOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQgPSB0aGlzLnJlc29sdmVkW2luZGV4XSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZShoYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9OwoKICAgICAgICBDb25zdGFudHMucHJvdG90eXBlLmdldFNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIGdldFNlcmlhbGl6YWJsZShzKSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHRoaXMuc3RyaW5nc1tzXSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbnN0YW50czsKICAgIH0oV3JpdGVPbmx5Q29uc3RhbnRzKTsKCiAgICB2YXIgTGF6eUNvbnN0YW50cyA9IGZ1bmN0aW9uIChfQ29uc3RhbnRzKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShMYXp5Q29uc3RhbnRzLCBfQ29uc3RhbnRzKTsKCiAgICAgICAgZnVuY3Rpb24gTGF6eUNvbnN0YW50cygpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBMYXp5Q29uc3RhbnRzKTsKCiAgICAgICAgICAgIHZhciBfdGhpczIgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NvbnN0YW50cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKCiAgICAgICAgICAgIF90aGlzMi5vdGhlcnMgPSBbXTsKICAgICAgICAgICAgX3RoaXMyLnNlcmlhbGl6YWJsZXMgPSBbXTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMjsKICAgICAgICB9CgogICAgICAgIExhenlDb25zdGFudHMucHJvdG90eXBlLnNlcmlhbGl6YWJsZSA9IGZ1bmN0aW9uIHNlcmlhbGl6YWJsZSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLnNlcmlhbGl6YWJsZXMuaW5kZXhPZih2YWx1ZSk7CiAgICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXphYmxlcy5wdXNoKHZhbHVlKSAtIDE7CiAgICAgICAgfTsKCiAgICAgICAgTGF6eUNvbnN0YW50cy5wcm90b3R5cGUuZ2V0U2VyaWFsaXphYmxlID0gZnVuY3Rpb24gZ2V0U2VyaWFsaXphYmxlKHMpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXphYmxlc1tzXTsKICAgICAgICB9OwoKICAgICAgICBMYXp5Q29uc3RhbnRzLnByb3RvdHlwZS5nZXRPdGhlciA9IGZ1bmN0aW9uIGdldE90aGVyKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm90aGVyc1t2YWx1ZSAtIDFdOwogICAgICAgIH07CgogICAgICAgIExhenlDb25zdGFudHMucHJvdG90eXBlLm90aGVyID0gZnVuY3Rpb24gb3RoZXIoX290aGVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm90aGVycy5wdXNoKF9vdGhlcik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIExhenlDb25zdGFudHM7CiAgICB9KENvbnN0YW50cyk7CgogICAgdmFyIE9wY29kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBPcGNvZGUoaGVhcCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE9wY29kZSk7CgogICAgICAgICAgICB0aGlzLmhlYXAgPSBoZWFwOwogICAgICAgICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgICAgfQoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKE9wY29kZSwgW3sKICAgICAgICAgICAga2V5OiAnc2l6ZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJhd1R5cGUgPSB0aGlzLmhlYXAuZ2V0YnlhZGRyKHRoaXMub2Zmc2V0KTsKICAgICAgICAgICAgICAgIHJldHVybiAoKHJhd1R5cGUgJiA3NjggLyogT1BFUkFORF9MRU5fTUFTSyAqLykgPj4gOCAvKiBBUkdfU0hJRlQgKi8pICsgMTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnaXNNYWNoaW5lJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcmF3VHlwZSA9IHRoaXMuaGVhcC5nZXRieWFkZHIodGhpcy5vZmZzZXQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJhd1R5cGUgJiAxMDI0IC8qIE1BQ0hJTkVfTUFTSyAqLzsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAndHlwZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGVhcC5nZXRieWFkZHIodGhpcy5vZmZzZXQpICYgMjU1IC8qIFRZUEVfTUFTSyAqLzsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnb3AxJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5oZWFwLmdldGJ5YWRkcih0aGlzLm9mZnNldCArIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICdvcDInLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmhlYXAuZ2V0YnlhZGRyKHRoaXMub2Zmc2V0ICsgMik7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ29wMycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGVhcC5nZXRieWFkZHIodGhpcy5vZmZzZXQgKyAzKTsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gT3Bjb2RlOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGVuY29kZVRhYmxlSW5mbyhzaXplLCBzY29wZVNpemUsIHN0YXRlKSB7CiAgICAgICAgcmV0dXJuIHNpemUgfCBzY29wZVNpemUgPDwgMTYgfCBzdGF0ZSA8PCAzMDsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYW5nZVN0YXRlKGluZm8sIG5ld1N0YXRlKSB7CiAgICAgICAgcmV0dXJuIGluZm8gfCBuZXdTdGF0ZSA8PCAzMDsKICAgIH0KICAgIHZhciBQQUdFX1NJWkUgPSAweDEwMDAwMDsKICAgIC8qKgogICAgICogVGhlIEhlYXAgaXMgcmVzcG9uc2libGUgZm9yIGR5bmFtaWNhbGx5IGFsbG9jYXRpbmcKICAgICAqIG1lbW9yeSBpbiB3aGljaCB3ZSByZWFkL3dyaXRlIHRoZSBWTSdzIGluc3RydWN0aW9ucwogICAgICogZnJvbS90by4gV2hlbiB3ZSBtYWxsb2Mgd2UgcGFzcyBvdXQgYSBWTUhhbmRsZSwgd2hpY2gKICAgICAqIGlzIHVzZWQgYXMgYW4gaW5kaXJlY3Qgd2F5IG9mIGFjY2Vzc2luZyB0aGUgbWVtb3J5IGR1cmluZwogICAgICogZXhlY3V0aW9uIG9mIHRoZSBWTS4gSW50ZXJuYWxseSB3ZSB0cmFjayB0aGUgZGlmZmVyZW50CiAgICAgKiByZWdpb25zIG9mIHRoZSBtZW1vcnkgaW4gYW4gaW50IGFycmF5IGtub3duIGFzIHRoZSB0YWJsZS4KICAgICAqCiAgICAgKiBUaGUgdGFibGUgMzItYml0IGFsaWduZWQgYW5kIGhhcyB0aGUgZm9sbG93aW5nIGxheW91dDoKICAgICAqCiAgICAgKiB8IC4uLiB8IGhwICh1MzIpIHwgICAgICAgaW5mbyAodTMyKSAgICAgICAgICB8CiAgICAgKiB8IC4uLiB8ICBIYW5kbGUgIHwgU2l6ZSB8IFNjb3BlIFNpemUgfCBTdGF0ZSB8CiAgICAgKiB8IC4uLiB8IDMyLWJpdHMgIHwgMTZiICB8ICAgIDE0YiAgICAgfCAgMmIgICB8CiAgICAgKgogICAgICogV2l0aCB0aGlzIGluZm9ybWF0aW9uIHdlIGVmZmVjdGl2ZWx5IGhhdmUgdGhlIGFiaWxpdHkgdG8KICAgICAqIGNvbnRyb2wgd2hlbiB3ZSB3YW50IHRvIGZyZWUgbWVtb3J5LiBUaGF0IGJlaW5nIHNhaWQgeW91CiAgICAgKiBjYW4gbm90IGZyZWUgZHVyaW5nIGV4ZWN1dGlvbiBhcyByYXcgYWRkcmVzcyBhcmUgb25seQogICAgICogdmFsaWQgZHVyaW5nIHRoZSBleGVjdXRpb24uIFRoaXMgbWVhbnMgeW91IGNhbm5vdCBjbG9zZQogICAgICogb3ZlciB0aGVtIGFzIHlvdSB3aWxsIGhhdmUgYSBiYWQgbWVtb3J5IGFjY2VzcyBleGNlcHRpb24uCiAgICAgKi8KCiAgICB2YXIgSGVhcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBIZWFwKHNlcmlhbGl6ZWRIZWFwKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSGVhcCk7CgogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVycyA9IFtdOwogICAgICAgICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlID0gMDsKICAgICAgICAgICAgdGhpcy5jYXBhY2l0eSA9IFBBR0VfU0laRTsKICAgICAgICAgICAgaWYgKHNlcmlhbGl6ZWRIZWFwKSB7CiAgICAgICAgICAgICAgICB2YXIgYnVmZmVyID0gc2VyaWFsaXplZEhlYXAuYnVmZmVyLAogICAgICAgICAgICAgICAgICAgIHRhYmxlID0gc2VyaWFsaXplZEhlYXAudGFibGUsCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlID0gc2VyaWFsaXplZEhlYXAuaGFuZGxlOwoKICAgICAgICAgICAgICAgIHRoaXMuaGVhcCA9IG5ldyBVaW50MTZBcnJheShidWZmZXIpOwogICAgICAgICAgICAgICAgdGhpcy50YWJsZSA9IHRhYmxlOwogICAgICAgICAgICAgICAgdGhpcy5vZmZzZXQgPSB0aGlzLmhlYXAubGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGUgPSBoYW5kbGU7CiAgICAgICAgICAgICAgICB0aGlzLmNhcGFjaXR5ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVhcCA9IG5ldyBVaW50MTZBcnJheShQQUdFX1NJWkUpOwogICAgICAgICAgICAgICAgdGhpcy50YWJsZSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBIZWFwLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gcHVzaChpdGVtKSB7CiAgICAgICAgICAgIHRoaXMuc2l6ZUNoZWNrKCk7CiAgICAgICAgICAgIHRoaXMuaGVhcFt0aGlzLm9mZnNldCsrXSA9IGl0ZW07CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUuc2l6ZUNoZWNrID0gZnVuY3Rpb24gc2l6ZUNoZWNrKCkgewogICAgICAgICAgICBpZiAodGhpcy5jYXBhY2l0eSA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIGhlYXAgPSBzbGljZSh0aGlzLmhlYXAsIDAsIHRoaXMub2Zmc2V0KTsKICAgICAgICAgICAgICAgIHRoaXMuaGVhcCA9IG5ldyBVaW50MTZBcnJheShoZWFwLmxlbmd0aCArIFBBR0VfU0laRSk7CiAgICAgICAgICAgICAgICB0aGlzLmhlYXAuc2V0KGhlYXAsIDApOwogICAgICAgICAgICAgICAgdGhpcy5jYXBhY2l0eSA9IFBBR0VfU0laRTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNhcGFjaXR5LS07CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUuZ2V0YnlhZGRyID0gZnVuY3Rpb24gZ2V0YnlhZGRyKGFkZHJlc3MpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGVhcFthZGRyZXNzXTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5zZXRieWFkZHIgPSBmdW5jdGlvbiBzZXRieWFkZHIoYWRkcmVzcywgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5oZWFwW2FkZHJlc3NdID0gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUubWFsbG9jID0gZnVuY3Rpb24gbWFsbG9jKCkgewogICAgICAgICAgICB0aGlzLnRhYmxlLnB1c2godGhpcy5vZmZzZXQsIDApOwogICAgICAgICAgICB2YXIgaGFuZGxlID0gdGhpcy5oYW5kbGU7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlICs9IDIgLyogRU5UUllfU0laRSAqLzsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5maW5pc2hNYWxsb2MgPSBmdW5jdGlvbiBmaW5pc2hNYWxsb2MoaGFuZGxlLCBzY29wZVNpemUpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy50YWJsZVtoYW5kbGVdOwogICAgICAgICAgICB2YXIgZmluaXNoID0gdGhpcy5vZmZzZXQ7CiAgICAgICAgICAgIHZhciBpbnN0cnVjdGlvblNpemUgPSBmaW5pc2ggLSBzdGFydDsKICAgICAgICAgICAgdmFyIGluZm8gPSBlbmNvZGVUYWJsZUluZm8oaW5zdHJ1Y3Rpb25TaXplLCBzY29wZVNpemUsIDAgLyogQWxsb2NhdGVkICovKTsKICAgICAgICAgICAgdGhpcy50YWJsZVtoYW5kbGUgKyAxIC8qIElORk9fT0ZGU0VUICovXSA9IGluZm87CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uIHNpemUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9mZnNldDsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5nZXRhZGRyID0gZnVuY3Rpb24gZ2V0YWRkcihoYW5kbGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGFibGVbaGFuZGxlXTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5nZXRoYW5kbGUgPSBmdW5jdGlvbiBnZXRoYW5kbGUoYWRkcmVzcykgewogICAgICAgICAgICB0aGlzLnRhYmxlLnB1c2goYWRkcmVzcywgZW5jb2RlVGFibGVJbmZvKDAsIDAsIDMgLyogUG9pbnRlciAqLykpOwogICAgICAgICAgICB2YXIgaGFuZGxlID0gdGhpcy5oYW5kbGU7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlICs9IDIgLyogRU5UUllfU0laRSAqLzsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5zaXplb2YgPSBmdW5jdGlvbiBzaXplb2YoaGFuZGxlKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5zY29wZXNpemVvZiA9IGZ1bmN0aW9uIHNjb3Blc2l6ZW9mKGhhbmRsZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9IHRoaXMudGFibGVbaGFuZGxlICsgMSAvKiBJTkZPX09GRlNFVCAqL107CiAgICAgICAgICAgIHJldHVybiAoaW5mbyAmIDEwNzM2NzYyODggLyogU0NPUEVfTUFTSyAqLykgPj4gMTY7CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUuZnJlZSA9IGZ1bmN0aW9uIGZyZWUoaGFuZGxlKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gdGhpcy50YWJsZVtoYW5kbGUgKyAxIC8qIElORk9fT0ZGU0VUICovXTsKICAgICAgICAgICAgdGhpcy50YWJsZVtoYW5kbGUgKyAxIC8qIElORk9fT0ZGU0VUICovXSA9IGNoYW5nZVN0YXRlKGluZm8sIDEgLyogRnJlZWQgKi8pOwogICAgICAgIH07CgogICAgICAgIEhlYXAucHJvdG90eXBlLmNvbXBhY3QgPSBmdW5jdGlvbiBjb21wYWN0KCkgewogICAgICAgICAgICB2YXIgY29tcGFjdGVkU2l6ZSA9IDA7CiAgICAgICAgICAgIHZhciB0YWJsZSA9IHRoaXMudGFibGUsCiAgICAgICAgICAgICAgICBsZW5ndGggPSB0aGlzLnRhYmxlLmxlbmd0aCwKICAgICAgICAgICAgICAgIGhlYXAgPSB0aGlzLmhlYXA7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyIC8qIEVOVFJZX1NJWkUgKi8pIHsKICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSB0YWJsZVtpXTsKICAgICAgICAgICAgICAgIHZhciBpbmZvID0gdGFibGVbaSArIDEgLyogSU5GT19PRkZTRVQgKi9dOwogICAgICAgICAgICAgICAgdmFyIHNpemUgPSBpbmZvICYgNjU1MzUgLyogU0laRV9NQVNLICovOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gaW5mbyAmIDMyMjEyMjU0NzIgLyogU1RBVEVfTUFTSyAqLyA+PiAzMDsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gMiAvKiBQdXJnZWQgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gMSAvKiBGcmVlZCAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2l0aW9uIHRvICJhbHJlYWR5IGZyZWVkIiBha2EgInB1cmdlZCIKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYSBnb29kIGltcHJvdmVtZW50IHdvdWxkIGJlIHRvIHJldXNlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZXNlIHNsb3RzCiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlW2kgKyAxIC8qIElORk9fT0ZGU0VUICovXSA9IGNoYW5nZVN0YXRlKGluZm8sIDIgLyogUHVyZ2VkICovKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGFjdGVkU2l6ZSArPSBzaXplOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09IDAgLyogQWxsb2NhdGVkICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBvZmZzZXQ7IGogPD0gaSArIHNpemU7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhcFtqIC0gY29tcGFjdGVkU2l6ZV0gPSBoZWFwW2pdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlW2ldID0gb2Zmc2V0IC0gY29tcGFjdGVkU2l6ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAzIC8qIFBvaW50ZXIgKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVbaV0gPSBvZmZzZXQgLSBjb21wYWN0ZWRTaXplOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9mZnNldCA9IHRoaXMub2Zmc2V0IC0gY29tcGFjdGVkU2l6ZTsKICAgICAgICB9OwoKICAgICAgICBIZWFwLnByb3RvdHlwZS5wdXNoUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiBwdXNoUGxhY2Vob2xkZXIodmFsdWVGdW5jKSB7CiAgICAgICAgICAgIHRoaXMuc2l6ZUNoZWNrKCk7CiAgICAgICAgICAgIHZhciBhZGRyZXNzID0gdGhpcy5vZmZzZXQrKzsKICAgICAgICAgICAgdGhpcy5oZWFwW2FkZHJlc3NdID0gNjU1MzUgLyogTUFYX1NJWkUgKi87CiAgICAgICAgICAgIHRoaXMucGxhY2Vob2xkZXJzLnB1c2goW2FkZHJlc3MsIHZhbHVlRnVuY10pOwogICAgICAgIH07CgogICAgICAgIEhlYXAucHJvdG90eXBlLnBhdGNoUGxhY2Vob2xkZXJzID0gZnVuY3Rpb24gcGF0Y2hQbGFjZWhvbGRlcnMoKSB7CiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlcnMgPSB0aGlzLnBsYWNlaG9sZGVyczsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGxhY2Vob2xkZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX3BsYWNlaG9sZGVycyRpID0gcGxhY2Vob2xkZXJzW2ldLAogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgPSBfcGxhY2Vob2xkZXJzJGlbMF0sCiAgICAgICAgICAgICAgICAgICAgZ2V0VmFsdWUgPSBfcGxhY2Vob2xkZXJzJGlbMV07CgoKICAgICAgICAgICAgICAgIHRoaXMuc2V0YnlhZGRyKGFkZHJlc3MsIGdldFZhbHVlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgSGVhcC5wcm90b3R5cGUuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHRoaXMub2Zmc2V0OwoKICAgICAgICAgICAgdGhpcy5wYXRjaFBsYWNlaG9sZGVycygpOwogICAgICAgICAgICAvLyBPbmx5IGNhbGxlZCBpbiBlYWdlciBtb2RlCiAgICAgICAgICAgIHZhciBidWZmZXIgPSBzbGljZSh0aGlzLmhlYXAsIDAsIG9mZnNldCkuYnVmZmVyOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaGFuZGxlOiB0aGlzLmhhbmRsZSwKICAgICAgICAgICAgICAgIHRhYmxlOiB0aGlzLnRhYmxlLAogICAgICAgICAgICAgICAgYnVmZmVyOiBidWZmZXIKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gSGVhcDsKICAgIH0oKTsKCiAgICB2YXIgV3JpdGVPbmx5UHJvZ3JhbSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBXcml0ZU9ubHlQcm9ncmFtKCkgewogICAgICAgICAgICB2YXIgY29uc3RhbnRzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBuZXcgV3JpdGVPbmx5Q29uc3RhbnRzKCk7CiAgICAgICAgICAgIHZhciBoZWFwID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBuZXcgSGVhcCgpOwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFdyaXRlT25seVByb2dyYW0pOwoKICAgICAgICAgICAgdGhpcy5jb25zdGFudHMgPSBjb25zdGFudHM7CiAgICAgICAgICAgIHRoaXMuaGVhcCA9IGhlYXA7CiAgICAgICAgICAgIHRoaXMuX29wY29kZSA9IG5ldyBPcGNvZGUodGhpcy5oZWFwKTsKICAgICAgICB9CgogICAgICAgIFdyaXRlT25seVByb2dyYW0ucHJvdG90eXBlLm9wY29kZSA9IGZ1bmN0aW9uIG9wY29kZShvZmZzZXQpIHsKICAgICAgICAgICAgdGhpcy5fb3Bjb2RlLm9mZnNldCA9IG9mZnNldDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29wY29kZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gV3JpdGVPbmx5UHJvZ3JhbTsKICAgIH0oKTsKCiAgICB2YXIgUnVudGltZVByb2dyYW0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gUnVudGltZVByb2dyYW0oY29uc3RhbnRzLCBoZWFwKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUnVudGltZVByb2dyYW0pOwoKICAgICAgICAgICAgdGhpcy5jb25zdGFudHMgPSBjb25zdGFudHM7CiAgICAgICAgICAgIHRoaXMuaGVhcCA9IGhlYXA7CiAgICAgICAgICAgIHRoaXMuX29wY29kZSA9IG5ldyBPcGNvZGUodGhpcy5oZWFwKTsKICAgICAgICB9CgogICAgICAgIFJ1bnRpbWVQcm9ncmFtLmh5ZHJhdGUgPSBmdW5jdGlvbiBoeWRyYXRlKHJhd0hlYXAsIHBvb2wsIHJlc29sdmVyKSB7CiAgICAgICAgICAgIHZhciBoZWFwID0gbmV3IEhlYXAocmF3SGVhcCk7CiAgICAgICAgICAgIHZhciBjb25zdGFudHMgPSBuZXcgUnVudGltZUNvbnN0YW50cyhyZXNvbHZlciwgcG9vbCk7CiAgICAgICAgICAgIHJldHVybiBuZXcgUnVudGltZVByb2dyYW0oY29uc3RhbnRzLCBoZWFwKTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lUHJvZ3JhbS5wcm90b3R5cGUub3Bjb2RlID0gZnVuY3Rpb24gb3Bjb2RlKG9mZnNldCkgewogICAgICAgICAgICB0aGlzLl9vcGNvZGUub2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb3Bjb2RlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBSdW50aW1lUHJvZ3JhbTsKICAgIH0oKTsKCiAgICB2YXIgUHJvZ3JhbSA9IGZ1bmN0aW9uIChfV3JpdGVPbmx5UHJvZ3JhbSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUHJvZ3JhbSwgX1dyaXRlT25seVByb2dyYW0pOwoKICAgICAgICBmdW5jdGlvbiBQcm9ncmFtKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFByb2dyYW0pOwogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9Xcml0ZU9ubHlQcm9ncmFtLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFByb2dyYW07CiAgICB9KFdyaXRlT25seVByb2dyYW0pOwoKICAgIGZ1bmN0aW9uIHNsaWNlKGFyciwgc3RhcnQsIGVuZCkgewogICAgICAgIGlmIChhcnIuc2xpY2UgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gYXJyLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0ID0gbmV3IFVpbnQxNkFycmF5KGVuZCk7CiAgICAgICAgZm9yICg7IHN0YXJ0IDwgZW5kOyBzdGFydCsrKSB7CiAgICAgICAgICAgIHJldFtzdGFydF0gPSBhcnJbc3RhcnRdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIGV4cG9ydHMuV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTiA9IFdFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT047CiAgICBleHBvcnRzLldyaXRlT25seUNvbnN0YW50cyA9IFdyaXRlT25seUNvbnN0YW50czsKICAgIGV4cG9ydHMuUnVudGltZUNvbnN0YW50cyA9IFJ1bnRpbWVDb25zdGFudHM7CiAgICBleHBvcnRzLkNvbnN0YW50cyA9IENvbnN0YW50czsKICAgIGV4cG9ydHMuTGF6eUNvbnN0YW50cyA9IExhenlDb25zdGFudHM7CiAgICBleHBvcnRzLkhlYXAgPSBIZWFwOwogICAgZXhwb3J0cy5Xcml0ZU9ubHlQcm9ncmFtID0gV3JpdGVPbmx5UHJvZ3JhbTsKICAgIGV4cG9ydHMuUnVudGltZVByb2dyYW0gPSBSdW50aW1lUHJvZ3JhbTsKICAgIGV4cG9ydHMuUHJvZ3JhbSA9IFByb2dyYW07CiAgICBleHBvcnRzLk9wY29kZSA9IE9wY29kZTsKfSk7CmVuaWZlZCgnQGdsaW1tZXIvcmVmZXJlbmNlJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BnbGltbWVyL3V0aWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsLCBfdXRpbCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuaXNNb2RpZmllZCA9IGV4cG9ydHMuUmVmZXJlbmNlQ2FjaGUgPSBleHBvcnRzLm1hcCA9IGV4cG9ydHMuQ2FjaGVkUmVmZXJlbmNlID0gZXhwb3J0cy5VcGRhdGFibGVUYWcgPSBleHBvcnRzLkNhY2hlZFRhZyA9IGV4cG9ydHMuY29tYmluZSA9IGV4cG9ydHMuY29tYmluZVNsaWNlID0gZXhwb3J0cy5jb21iaW5lVGFnZ2VkID0gZXhwb3J0cy5EaXJ0eWFibGVUYWcgPSBleHBvcnRzLmJ1bXAgPSBleHBvcnRzLmlzQ29uc3RUYWcgPSBleHBvcnRzLmlzQ29uc3QgPSBleHBvcnRzLkNVUlJFTlRfVEFHID0gZXhwb3J0cy5WT0xBVElMRV9UQUcgPSBleHBvcnRzLkNPTlNUQU5UX1RBRyA9IGV4cG9ydHMuVGFnV3JhcHBlciA9IGV4cG9ydHMuUmV2aXNpb25UYWcgPSBleHBvcnRzLlZPTEFUSUxFID0gZXhwb3J0cy5JTklUSUFMID0gZXhwb3J0cy5DT05TVEFOVCA9IGV4cG9ydHMuSXRlcmF0b3JTeW5jaHJvbml6ZXIgPSBleHBvcnRzLlJlZmVyZW5jZUl0ZXJhdG9yID0gZXhwb3J0cy5JdGVyYXRpb25BcnRpZmFjdHMgPSBleHBvcnRzLkxpc3RJdGVtID0gZXhwb3J0cy5Db25zdFJlZmVyZW5jZSA9IHVuZGVmaW5lZDsKCgogICAgdmFyIENPTlNUQU5UID0gMDsKICAgIHZhciBJTklUSUFMID0gMTsKICAgIHZhciBWT0xBVElMRSA9IE5hTjsKCiAgICB2YXIgUmV2aXNpb25UYWcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gUmV2aXNpb25UYWcoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmV2aXNpb25UYWcpOwogICAgICAgIH0KCiAgICAgICAgUmV2aXNpb25UYWcucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24gdmFsaWRhdGUoc25hcHNob3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWUoKSA9PT0gc25hcHNob3Q7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJldmlzaW9uVGFnOwogICAgfSgpOwoKICAgIFJldmlzaW9uVGFnLmlkID0gMDsKICAgIHZhciBWQUxVRSA9IFtdOwogICAgdmFyIFZBTElEQVRFID0gW107CgogICAgdmFyIFRhZ1dyYXBwZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVGFnV3JhcHBlcih0eXBlLCBpbm5lcikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFRhZ1dyYXBwZXIpOwoKICAgICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgICAgdGhpcy5pbm5lciA9IGlubmVyOwogICAgICAgIH0KCiAgICAgICAgVGFnV3JhcHBlci5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgdmFyIGZ1bmMgPSBWQUxVRVt0aGlzLnR5cGVdOwogICAgICAgICAgICByZXR1cm4gZnVuYyh0aGlzLmlubmVyKTsKICAgICAgICB9OwoKICAgICAgICBUYWdXcmFwcGVyLnByb3RvdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uIHZhbGlkYXRlKHNuYXBzaG90KSB7CiAgICAgICAgICAgIHZhciBmdW5jID0gVkFMSURBVEVbdGhpcy50eXBlXTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmModGhpcy5pbm5lciwgc25hcHNob3QpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBUYWdXcmFwcGVyOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyKFR5cGUpIHsKICAgICAgICB2YXIgdHlwZSA9IFZBTFVFLmxlbmd0aDsKICAgICAgICBWQUxVRS5wdXNoKGZ1bmN0aW9uICh0YWcpIHsKICAgICAgICAgICAgcmV0dXJuIHRhZy52YWx1ZSgpOwogICAgICAgIH0pOwogICAgICAgIFZBTElEQVRFLnB1c2goZnVuY3Rpb24gKHRhZywgc25hcHNob3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhZy52YWxpZGF0ZShzbmFwc2hvdCk7CiAgICAgICAgfSk7CiAgICAgICAgVHlwZS5pZCA9IHR5cGU7CiAgICB9CiAgICAvLy8KICAgIC8vIENPTlNUQU5UOiAwCiAgICBWQUxVRS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gQ09OU1RBTlQ7CiAgICB9KTsKICAgIFZBTElEQVRFLnB1c2goZnVuY3Rpb24gKF90YWcsIHNuYXBzaG90KSB7CiAgICAgICAgcmV0dXJuIHNuYXBzaG90ID09PSBDT05TVEFOVDsKICAgIH0pOwogICAgdmFyIENPTlNUQU5UX1RBRyA9IG5ldyBUYWdXcmFwcGVyKDAsIG51bGwpOwogICAgLy8gVk9MQVRJTEU6IDEKICAgIFZBTFVFLnB1c2goZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBWT0xBVElMRTsKICAgIH0pOwogICAgVkFMSURBVEUucHVzaChmdW5jdGlvbiAoX3RhZywgc25hcHNob3QpIHsKICAgICAgICByZXR1cm4gc25hcHNob3QgPT09IFZPTEFUSUxFOwogICAgfSk7CiAgICB2YXIgVk9MQVRJTEVfVEFHID0gbmV3IFRhZ1dyYXBwZXIoMSwgbnVsbCk7CiAgICAvLyBDVVJSRU5UOiAyCiAgICBWQUxVRS5wdXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJFJFVklTSU9OOwogICAgfSk7CiAgICBWQUxJREFURS5wdXNoKGZ1bmN0aW9uIChfdGFnLCBzbmFwc2hvdCkgewogICAgICAgIHJldHVybiBzbmFwc2hvdCA9PT0gJFJFVklTSU9OOwogICAgfSk7CiAgICB2YXIgQ1VSUkVOVF9UQUcgPSBuZXcgVGFnV3JhcHBlcigyLCBudWxsKTsKICAgIGZ1bmN0aW9uIGlzQ29uc3QoX3JlZikgewogICAgICAgIHZhciB0YWcgPSBfcmVmLnRhZzsKCiAgICAgICAgcmV0dXJuIHRhZyA9PT0gQ09OU1RBTlRfVEFHOwogICAgfQogICAgZnVuY3Rpb24gaXNDb25zdFRhZyh0YWcpIHsKICAgICAgICByZXR1cm4gdGFnID09PSBDT05TVEFOVF9UQUc7CiAgICB9CiAgICAvLy8KICAgIHZhciAkUkVWSVNJT04gPSBJTklUSUFMOwogICAgZnVuY3Rpb24gYnVtcCgpIHsKICAgICAgICAkUkVWSVNJT04rKzsKICAgIH0KCiAgICB2YXIgRGlydHlhYmxlVGFnID0gZnVuY3Rpb24gKF9SZXZpc2lvblRhZykgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRGlydHlhYmxlVGFnLCBfUmV2aXNpb25UYWcpOwoKICAgICAgICBEaXJ0eWFibGVUYWcuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKCkgewogICAgICAgICAgICB2YXIgcmV2aXNpb24gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6ICRSRVZJU0lPTjsKCiAgICAgICAgICAgIHJldHVybiBuZXcgVGFnV3JhcHBlcih0aGlzLmlkLCBuZXcgRGlydHlhYmxlVGFnKHJldmlzaW9uKSk7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gRGlydHlhYmxlVGFnKCkgewogICAgICAgICAgICB2YXIgcmV2aXNpb24gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6ICRSRVZJU0lPTjsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBEaXJ0eWFibGVUYWcpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9SZXZpc2lvblRhZy5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzLnJldmlzaW9uID0gcmV2aXNpb247CiAgICAgICAgICAgIHJldHVybiBfdGhpczsKICAgICAgICB9CgogICAgICAgIERpcnR5YWJsZVRhZy5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV2aXNpb247CiAgICAgICAgfTsKCiAgICAgICAgRGlydHlhYmxlVGFnLnByb3RvdHlwZS5kaXJ0eSA9IGZ1bmN0aW9uIGRpcnR5KCkgewogICAgICAgICAgICB0aGlzLnJldmlzaW9uID0gKyskUkVWSVNJT047CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIERpcnR5YWJsZVRhZzsKICAgIH0oUmV2aXNpb25UYWcpOwoKICAgIHJlZ2lzdGVyKERpcnR5YWJsZVRhZyk7CiAgICBmdW5jdGlvbiBjb21iaW5lVGFnZ2VkKHRhZ2dlZCkgewogICAgICAgIHZhciBvcHRpbWl6ZWQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRhZ2dlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRhZyA9IHRhZ2dlZFtpXS50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IFZPTEFUSUxFX1RBRykgcmV0dXJuIFZPTEFUSUxFX1RBRzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ09OU1RBTlRfVEFHKSBjb250aW51ZTsKICAgICAgICAgICAgb3B0aW1pemVkLnB1c2godGFnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9jb21iaW5lKG9wdGltaXplZCk7CiAgICB9CiAgICBmdW5jdGlvbiBjb21iaW5lU2xpY2Uoc2xpY2UpIHsKICAgICAgICB2YXIgb3B0aW1pemVkID0gW107CiAgICAgICAgdmFyIG5vZGUgPSBzbGljZS5oZWFkKCk7CiAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBWT0xBVElMRV9UQUcpIHJldHVybiBWT0xBVElMRV9UQUc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IENPTlNUQU5UX1RBRykgb3B0aW1pemVkLnB1c2godGFnKTsKICAgICAgICAgICAgbm9kZSA9IHNsaWNlLm5leHROb2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gX2NvbWJpbmUob3B0aW1pemVkKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNvbWJpbmUodGFncykgewogICAgICAgIHZhciBvcHRpbWl6ZWQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRhZ3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHZhciB0YWcgPSB0YWdzW2ldOwogICAgICAgICAgICBpZiAodGFnID09PSBWT0xBVElMRV9UQUcpIHJldHVybiBWT0xBVElMRV9UQUc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IENPTlNUQU5UX1RBRykgY29udGludWU7CiAgICAgICAgICAgIG9wdGltaXplZC5wdXNoKHRhZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBfY29tYmluZShvcHRpbWl6ZWQpOwogICAgfQogICAgZnVuY3Rpb24gX2NvbWJpbmUodGFncykgewogICAgICAgIHN3aXRjaCAodGFncy5sZW5ndGgpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIENPTlNUQU5UX1RBRzsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZ3NbMF07CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBUYWdzUGFpci5jcmVhdGUodGFnc1swXSwgdGFnc1sxXSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gVGFnc0NvbWJpbmF0b3IuY3JlYXRlKHRhZ3MpOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgQ2FjaGVkVGFnID0gZnVuY3Rpb24gKF9SZXZpc2lvblRhZzIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKENhY2hlZFRhZywgX1JldmlzaW9uVGFnMik7CgogICAgICAgIGZ1bmN0aW9uIENhY2hlZFRhZygpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDYWNoZWRUYWcpOwoKICAgICAgICAgICAgdmFyIF90aGlzMiA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfUmV2aXNpb25UYWcyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwoKICAgICAgICAgICAgX3RoaXMyLmxhc3RDaGVja2VkID0gbnVsbDsKICAgICAgICAgICAgX3RoaXMyLmxhc3RWYWx1ZSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBfdGhpczI7CiAgICAgICAgfQoKICAgICAgICBDYWNoZWRUYWcucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciBsYXN0Q2hlY2tlZCA9IHRoaXMubGFzdENoZWNrZWQsCiAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSB0aGlzLmxhc3RWYWx1ZTsKCiAgICAgICAgICAgIGlmIChsYXN0Q2hlY2tlZCAhPT0gJFJFVklTSU9OKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RDaGVja2VkID0gJFJFVklTSU9OOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0VmFsdWUgPSBsYXN0VmFsdWUgPSB0aGlzLmNvbXB1dGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0VmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgQ2FjaGVkVGFnLnByb3RvdHlwZS5pbnZhbGlkYXRlID0gZnVuY3Rpb24gaW52YWxpZGF0ZSgpIHsKICAgICAgICAgICAgdGhpcy5sYXN0Q2hlY2tlZCA9IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENhY2hlZFRhZzsKICAgIH0oUmV2aXNpb25UYWcpOwoKICAgIHZhciBUYWdzUGFpciA9IGZ1bmN0aW9uIChfQ2FjaGVkVGFnKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShUYWdzUGFpciwgX0NhY2hlZFRhZyk7CgogICAgICAgIFRhZ3NQYWlyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShmaXJzdCwgc2Vjb25kKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgVGFnV3JhcHBlcih0aGlzLmlkLCBuZXcgVGFnc1BhaXIoZmlyc3QsIHNlY29uZCkpOwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIFRhZ3NQYWlyKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUYWdzUGFpcik7CgogICAgICAgICAgICB2YXIgX3RoaXMzID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRUYWcuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczMuZmlyc3QgPSBmaXJzdDsKICAgICAgICAgICAgX3RoaXMzLnNlY29uZCA9IHNlY29uZDsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMzsKICAgICAgICB9CgogICAgICAgIFRhZ3NQYWlyLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KHRoaXMuZmlyc3QudmFsdWUoKSwgdGhpcy5zZWNvbmQudmFsdWUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFRhZ3NQYWlyOwogICAgfShDYWNoZWRUYWcpOwoKICAgIHJlZ2lzdGVyKFRhZ3NQYWlyKTsKCiAgICB2YXIgVGFnc0NvbWJpbmF0b3IgPSBmdW5jdGlvbiAoX0NhY2hlZFRhZzIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFRhZ3NDb21iaW5hdG9yLCBfQ2FjaGVkVGFnMik7CgogICAgICAgIFRhZ3NDb21iaW5hdG9yLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSh0YWdzKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgVGFnV3JhcHBlcih0aGlzLmlkLCBuZXcgVGFnc0NvbWJpbmF0b3IodGFncykpOwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIFRhZ3NDb21iaW5hdG9yKHRhZ3MpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUYWdzQ29tYmluYXRvcik7CgogICAgICAgICAgICB2YXIgX3RoaXM0ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRUYWcyLmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXM0LnRhZ3MgPSB0YWdzOwogICAgICAgICAgICByZXR1cm4gX3RoaXM0OwogICAgICAgIH0KCiAgICAgICAgVGFnc0NvbWJpbmF0b3IucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICAgICAgICB2YXIgdGFncyA9IHRoaXMudGFnczsKCiAgICAgICAgICAgIHZhciBtYXggPSAtMTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0YWdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB0YWdzW2ldLnZhbHVlKCk7CiAgICAgICAgICAgICAgICBtYXggPSBNYXRoLm1heCh2YWx1ZSwgbWF4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF4OwogICAgICAgIH07CgogICAgICAgIHJldHVybiBUYWdzQ29tYmluYXRvcjsKICAgIH0oQ2FjaGVkVGFnKTsKCiAgICByZWdpc3RlcihUYWdzQ29tYmluYXRvcik7CgogICAgdmFyIFVwZGF0YWJsZVRhZyA9IGZ1bmN0aW9uIChfQ2FjaGVkVGFnMykgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVXBkYXRhYmxlVGFnLCBfQ2FjaGVkVGFnMyk7CgogICAgICAgIFVwZGF0YWJsZVRhZy5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUodGFnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgVGFnV3JhcHBlcih0aGlzLmlkLCBuZXcgVXBkYXRhYmxlVGFnKHRhZykpOwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIFVwZGF0YWJsZVRhZyh0YWcpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBVcGRhdGFibGVUYWcpOwoKICAgICAgICAgICAgdmFyIF90aGlzNSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ2FjaGVkVGFnMy5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNS50YWcgPSB0YWc7CiAgICAgICAgICAgIF90aGlzNS5sYXN0VXBkYXRlZCA9IElOSVRJQUw7CiAgICAgICAgICAgIHJldHVybiBfdGhpczU7CiAgICAgICAgfQoKICAgICAgICBVcGRhdGFibGVUYWcucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgodGhpcy5sYXN0VXBkYXRlZCwgdGhpcy50YWcudmFsdWUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgVXBkYXRhYmxlVGFnLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodGFnKSB7CiAgICAgICAgICAgIGlmICh0YWcgIT09IHRoaXMudGFnKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFVwZGF0ZWQgPSAkUkVWSVNJT047CiAgICAgICAgICAgICAgICB0aGlzLmludmFsaWRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBVcGRhdGFibGVUYWc7CiAgICB9KENhY2hlZFRhZyk7CgogICAgcmVnaXN0ZXIoVXBkYXRhYmxlVGFnKTsKCiAgICB2YXIgQ2FjaGVkUmVmZXJlbmNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENhY2hlZFJlZmVyZW5jZSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDYWNoZWRSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSBudWxsOwogICAgICAgICAgICB0aGlzLmxhc3RWYWx1ZSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBDYWNoZWRSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciB0YWcgPSB0aGlzLnRhZywKICAgICAgICAgICAgICAgIGxhc3RSZXZpc2lvbiA9IHRoaXMubGFzdFJldmlzaW9uLAogICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gdGhpcy5sYXN0VmFsdWU7CgogICAgICAgICAgICBpZiAobGFzdFJldmlzaW9uID09PSBudWxsIHx8ICF0YWcudmFsaWRhdGUobGFzdFJldmlzaW9uKSkgewogICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gdGhpcy5sYXN0VmFsdWUgPSB0aGlzLmNvbXB1dGUoKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gdGFnLnZhbHVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhc3RWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBDYWNoZWRSZWZlcmVuY2UucHJvdG90eXBlLmludmFsaWRhdGUgPSBmdW5jdGlvbiBpbnZhbGlkYXRlKCkgewogICAgICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENhY2hlZFJlZmVyZW5jZTsKICAgIH0oKTsKCiAgICB2YXIgTWFwcGVyUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKE1hcHBlclJlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSk7CgogICAgICAgIGZ1bmN0aW9uIE1hcHBlclJlZmVyZW5jZShyZWZlcmVuY2UsIG1hcHBlcikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1hcHBlclJlZmVyZW5jZSk7CgogICAgICAgICAgICB2YXIgX3RoaXM2ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRSZWZlcmVuY2UuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczYudGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgICAgICAgX3RoaXM2LnJlZmVyZW5jZSA9IHJlZmVyZW5jZTsKICAgICAgICAgICAgX3RoaXM2Lm1hcHBlciA9IG1hcHBlcjsKICAgICAgICAgICAgcmV0dXJuIF90aGlzNjsKICAgICAgICB9CgogICAgICAgIE1hcHBlclJlZmVyZW5jZS5wcm90b3R5cGUuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgICAgICAgIHZhciByZWZlcmVuY2UgPSB0aGlzLnJlZmVyZW5jZSwKICAgICAgICAgICAgICAgIG1hcHBlciA9IHRoaXMubWFwcGVyOwoKICAgICAgICAgICAgcmV0dXJuIG1hcHBlcihyZWZlcmVuY2UudmFsdWUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE1hcHBlclJlZmVyZW5jZTsKICAgIH0oQ2FjaGVkUmVmZXJlbmNlKTsKCiAgICBmdW5jdGlvbiBtYXAocmVmZXJlbmNlLCBtYXBwZXIpIHsKICAgICAgICByZXR1cm4gbmV3IE1hcHBlclJlZmVyZW5jZShyZWZlcmVuY2UsIG1hcHBlcik7CiAgICB9CiAgICAvLy8vLy8vLy8vCgogICAgdmFyIFJlZmVyZW5jZUNhY2hlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlZmVyZW5jZUNhY2hlKHJlZmVyZW5jZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJlZmVyZW5jZUNhY2hlKTsKCiAgICAgICAgICAgIHRoaXMubGFzdFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSBudWxsOwogICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgICAgICAgdGhpcy5yZWZlcmVuY2UgPSByZWZlcmVuY2U7CiAgICAgICAgfQoKICAgICAgICBSZWZlcmVuY2VDYWNoZS5wcm90b3R5cGUucGVlayA9IGZ1bmN0aW9uIHBlZWsoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxhc3RWYWx1ZTsKICAgICAgICB9OwoKICAgICAgICBSZWZlcmVuY2VDYWNoZS5wcm90b3R5cGUucmV2YWxpZGF0ZSA9IGZ1bmN0aW9uIHJldmFsaWRhdGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZWZlcmVuY2UgPSB0aGlzLnJlZmVyZW5jZSwKICAgICAgICAgICAgICAgIGxhc3RSZXZpc2lvbiA9IHRoaXMubGFzdFJldmlzaW9uOwoKICAgICAgICAgICAgdmFyIHRhZyA9IHJlZmVyZW5jZS50YWc7CiAgICAgICAgICAgIGlmICh0YWcudmFsaWRhdGUobGFzdFJldmlzaW9uKSkgcmV0dXJuIE5PVF9NT0RJRklFRDsKICAgICAgICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSB0YWcudmFsdWUoKTsKICAgICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRoaXMubGFzdFZhbHVlOwoKICAgICAgICAgICAgdmFyIHZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbGFzdFZhbHVlKSByZXR1cm4gTk9UX01PRElGSUVEOwogICAgICAgICAgICB0aGlzLmxhc3RWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgUmVmZXJlbmNlQ2FjaGUucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbiBpbml0aWFsaXplKCkgewogICAgICAgICAgICB2YXIgcmVmZXJlbmNlID0gdGhpcy5yZWZlcmVuY2U7CgogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmxhc3RWYWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpOwogICAgICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IHJlZmVyZW5jZS50YWcudmFsdWUoKTsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUmVmZXJlbmNlQ2FjaGU7CiAgICB9KCk7CgogICAgdmFyIE5PVF9NT0RJRklFRCA9ICdhZGIzYjc4ZS0zZDIyLTRlNGItODc3YS02MzE3YzJjNWMxNDUnOwogICAgZnVuY3Rpb24gaXNNb2RpZmllZCh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAhPT0gTk9UX01PRElGSUVEOwogICAgfQoKICAgIHZhciBDb25zdFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb25zdFJlZmVyZW5jZShpbm5lcikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbnN0UmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHRoaXMuaW5uZXIgPSBpbm5lcjsKICAgICAgICAgICAgdGhpcy50YWcgPSBDT05TVEFOVF9UQUc7CiAgICAgICAgfQoKICAgICAgICBDb25zdFJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXI7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbnN0UmVmZXJlbmNlOwogICAgfSgpOwoKICAgIHZhciBMaXN0SXRlbSA9IGZ1bmN0aW9uIChfTGlzdE5vZGUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKExpc3RJdGVtLCBfTGlzdE5vZGUpOwoKICAgICAgICBmdW5jdGlvbiBMaXN0SXRlbShpdGVyYWJsZSwgcmVzdWx0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTGlzdEl0ZW0pOwoKICAgICAgICAgICAgdmFyIF90aGlzNyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfTGlzdE5vZGUuY2FsbCh0aGlzLCBpdGVyYWJsZS52YWx1ZVJlZmVyZW5jZUZvcihyZXN1bHQpKSk7CgogICAgICAgICAgICBfdGhpczcucmV0YWluZWQgPSBmYWxzZTsKICAgICAgICAgICAgX3RoaXM3LnNlZW4gPSBmYWxzZTsKICAgICAgICAgICAgX3RoaXM3LmtleSA9IHJlc3VsdC5rZXk7CiAgICAgICAgICAgIF90aGlzNy5pdGVyYWJsZSA9IGl0ZXJhYmxlOwogICAgICAgICAgICBfdGhpczcubWVtbyA9IGl0ZXJhYmxlLm1lbW9SZWZlcmVuY2VGb3IocmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzNzsKICAgICAgICB9CgogICAgICAgIExpc3RJdGVtLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoaXRlbSkgewogICAgICAgICAgICB0aGlzLnJldGFpbmVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pdGVyYWJsZS51cGRhdGVWYWx1ZVJlZmVyZW5jZSh0aGlzLnZhbHVlLCBpdGVtKTsKICAgICAgICAgICAgdGhpcy5pdGVyYWJsZS51cGRhdGVNZW1vUmVmZXJlbmNlKHRoaXMubWVtbywgaXRlbSk7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdEl0ZW0ucHJvdG90eXBlLnNob3VsZFJlbW92ZSA9IGZ1bmN0aW9uIHNob3VsZFJlbW92ZSgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aGlzLnJldGFpbmVkOwogICAgICAgIH07CgogICAgICAgIExpc3RJdGVtLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgICB0aGlzLnJldGFpbmVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc2VlbiA9IGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBMaXN0SXRlbTsKICAgIH0oX3V0aWwuTGlzdE5vZGUpOwoKICAgIHZhciBJdGVyYXRpb25BcnRpZmFjdHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gSXRlcmF0aW9uQXJ0aWZhY3RzKGl0ZXJhYmxlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSXRlcmF0aW9uQXJ0aWZhY3RzKTsKCiAgICAgICAgICAgIHRoaXMuaXRlcmF0b3IgPSBudWxsOwogICAgICAgICAgICB0aGlzLm1hcCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICB0aGlzLmxpc3QgPSBuZXcgX3V0aWwuTGlua2VkTGlzdCgpOwogICAgICAgICAgICB0aGlzLnRhZyA9IGl0ZXJhYmxlLnRhZzsKICAgICAgICAgICAgdGhpcy5pdGVyYWJsZSA9IGl0ZXJhYmxlOwogICAgICAgIH0KCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gdGhpcy5pdGVyYXRvciA9IHRoaXMuaXRlcmFibGUuaXRlcmF0ZSgpOwogICAgICAgICAgICByZXR1cm4gaXRlcmF0b3IuaXNFbXB0eSgpOwogICAgICAgIH07CgogICAgICAgIEl0ZXJhdGlvbkFydGlmYWN0cy5wcm90b3R5cGUuaXRlcmF0ZSA9IGZ1bmN0aW9uIGl0ZXJhdGUoKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKHRoaXMuaXRlcmF0b3IgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdG9yID0gdGhpcy5pdGVyYWJsZS5pdGVyYXRlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpdGVyYXRvciA9IHRoaXMuaXRlcmF0b3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pdGVyYXRvciA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBpdGVyYXRvcjsKICAgICAgICB9OwoKICAgICAgICBJdGVyYXRpb25BcnRpZmFjdHMucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5tYXBba2V5XTsKICAgICAgICB9OwoKICAgICAgICBJdGVyYXRpb25BcnRpZmFjdHMucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFwW2tleV07CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS53YXNTZWVuID0gZnVuY3Rpb24gd2FzU2VlbihrZXkpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm1hcFtrZXldOwogICAgICAgICAgICByZXR1cm4gbm9kZSAhPT0gdW5kZWZpbmVkICYmIG5vZGUuc2VlbjsKICAgICAgICB9OwoKICAgICAgICBJdGVyYXRpb25BcnRpZmFjdHMucHJvdG90eXBlLmFwcGVuZCA9IGZ1bmN0aW9uIGFwcGVuZChpdGVtKSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB0aGlzLm1hcCwKICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmxpc3QsCiAgICAgICAgICAgICAgICBpdGVyYWJsZSA9IHRoaXMuaXRlcmFibGU7CgogICAgICAgICAgICB2YXIgbm9kZSA9IG1hcFtpdGVtLmtleV0gPSBuZXcgTGlzdEl0ZW0oaXRlcmFibGUsIGl0ZW0pOwogICAgICAgICAgICBsaXN0LmFwcGVuZChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS5pbnNlcnRCZWZvcmUgPSBmdW5jdGlvbiBpbnNlcnRCZWZvcmUoaXRlbSwgcmVmZXJlbmNlKSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB0aGlzLm1hcCwKICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmxpc3QsCiAgICAgICAgICAgICAgICBpdGVyYWJsZSA9IHRoaXMuaXRlcmFibGU7CgogICAgICAgICAgICB2YXIgbm9kZSA9IG1hcFtpdGVtLmtleV0gPSBuZXcgTGlzdEl0ZW0oaXRlcmFibGUsIGl0ZW0pOwogICAgICAgICAgICBub2RlLnJldGFpbmVkID0gdHJ1ZTsKICAgICAgICAgICAgbGlzdC5pbnNlcnRCZWZvcmUobm9kZSwgcmVmZXJlbmNlKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS5tb3ZlID0gZnVuY3Rpb24gbW92ZShpdGVtLCByZWZlcmVuY2UpIHsKICAgICAgICAgICAgdmFyIGxpc3QgPSB0aGlzLmxpc3Q7CgogICAgICAgICAgICBpdGVtLnJldGFpbmVkID0gdHJ1ZTsKICAgICAgICAgICAgbGlzdC5yZW1vdmUoaXRlbSk7CiAgICAgICAgICAgIGxpc3QuaW5zZXJ0QmVmb3JlKGl0ZW0sIHJlZmVyZW5jZSk7CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiByZW1vdmUoaXRlbSkgewogICAgICAgICAgICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgICAgICAgICAgIGxpc3QucmVtb3ZlKGl0ZW0pOwogICAgICAgICAgICBkZWxldGUgdGhpcy5tYXBbaXRlbS5rZXldOwogICAgICAgIH07CgogICAgICAgIEl0ZXJhdGlvbkFydGlmYWN0cy5wcm90b3R5cGUubmV4dE5vZGUgPSBmdW5jdGlvbiBuZXh0Tm9kZShpdGVtKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3QubmV4dE5vZGUoaXRlbSk7CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0aW9uQXJ0aWZhY3RzLnByb3RvdHlwZS5oZWFkID0gZnVuY3Rpb24gaGVhZCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGlzdC5oZWFkKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEl0ZXJhdGlvbkFydGlmYWN0czsKICAgIH0oKTsKCiAgICB2YXIgUmVmZXJlbmNlSXRlcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gaWYgYW55b25lIG5lZWRzIHRvIGNvbnN0cnVjdCB0aGlzIG9iamVjdCB3aXRoIHNvbWV0aGluZyBvdGhlciB0aGFuCiAgICAgICAgLy8gYW4gaXRlcmFibGUsIGxldCBAd3ljYXRzIGtub3cuCiAgICAgICAgZnVuY3Rpb24gUmVmZXJlbmNlSXRlcmF0b3IoaXRlcmFibGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBSZWZlcmVuY2VJdGVyYXRvcik7CgogICAgICAgICAgICB0aGlzLml0ZXJhdG9yID0gbnVsbDsKICAgICAgICAgICAgdmFyIGFydGlmYWN0cyA9IG5ldyBJdGVyYXRpb25BcnRpZmFjdHMoaXRlcmFibGUpOwogICAgICAgICAgICB0aGlzLmFydGlmYWN0cyA9IGFydGlmYWN0czsKICAgICAgICB9CgogICAgICAgIFJlZmVyZW5jZUl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgdmFyIGFydGlmYWN0cyA9IHRoaXMuYXJ0aWZhY3RzOwoKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gdGhpcy5pdGVyYXRvciA9IHRoaXMuaXRlcmF0b3IgfHwgYXJ0aWZhY3RzLml0ZXJhdGUoKTsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgIGlmIChpdGVtID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGFydGlmYWN0cy5hcHBlbmQoaXRlbSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJlZmVyZW5jZUl0ZXJhdG9yOwogICAgfSgpOwoKICAgIHZhciBQaGFzZTsKICAgIChmdW5jdGlvbiAoUGhhc2UpIHsKICAgICAgICBQaGFzZVtQaGFzZVsiQXBwZW5kIl0gPSAwXSA9ICJBcHBlbmQiOwogICAgICAgIFBoYXNlW1BoYXNlWyJQcnVuZSJdID0gMV0gPSAiUHJ1bmUiOwogICAgICAgIFBoYXNlW1BoYXNlWyJEb25lIl0gPSAyXSA9ICJEb25lIjsKICAgIH0pKFBoYXNlIHx8IChQaGFzZSA9IHt9KSk7CgogICAgdmFyIEl0ZXJhdG9yU3luY2hyb25pemVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEl0ZXJhdG9yU3luY2hyb25pemVyKF9yZWYyKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBfcmVmMi50YXJnZXQsCiAgICAgICAgICAgICAgICBhcnRpZmFjdHMgPSBfcmVmMi5hcnRpZmFjdHM7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSXRlcmF0b3JTeW5jaHJvbml6ZXIpOwoKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwogICAgICAgICAgICB0aGlzLml0ZXJhdG9yID0gYXJ0aWZhY3RzLml0ZXJhdGUoKTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLmhlYWQoKTsKICAgICAgICB9CgogICAgICAgIEl0ZXJhdG9yU3luY2hyb25pemVyLnByb3RvdHlwZS5zeW5jID0gZnVuY3Rpb24gc3luYygpIHsKICAgICAgICAgICAgdmFyIHBoYXNlID0gUGhhc2UuQXBwZW5kOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgc3dpdGNoIChwaGFzZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgUGhhc2UuQXBwZW5kOgogICAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9IHRoaXMubmV4dEFwcGVuZCgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIFBoYXNlLlBydW5lOgogICAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9IHRoaXMubmV4dFBydW5lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUGhhc2UuRG9uZToKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXh0RG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBJdGVyYXRvclN5bmNocm9uaXplci5wcm90b3R5cGUuYWR2YW5jZVRvS2V5ID0gZnVuY3Rpb24gYWR2YW5jZVRvS2V5KGtleSkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuY3VycmVudCwKICAgICAgICAgICAgICAgIGFydGlmYWN0cyA9IHRoaXMuYXJ0aWZhY3RzOwoKICAgICAgICAgICAgdmFyIHNlZWsgPSBjdXJyZW50OwogICAgICAgICAgICB3aGlsZSAoc2VlayAhPT0gbnVsbCAmJiBzZWVrLmtleSAhPT0ga2V5KSB7CiAgICAgICAgICAgICAgICBzZWVrLnNlZW4gPSB0cnVlOwogICAgICAgICAgICAgICAgc2VlayA9IGFydGlmYWN0cy5uZXh0Tm9kZShzZWVrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2VlayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLm5leHROb2RlKHNlZWspOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0b3JTeW5jaHJvbml6ZXIucHJvdG90eXBlLm5leHRBcHBlbmQgPSBmdW5jdGlvbiBuZXh0QXBwZW5kKCkgewogICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSB0aGlzLml0ZXJhdG9yLAogICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMuY3VycmVudCwKICAgICAgICAgICAgICAgIGFydGlmYWN0cyA9IHRoaXMuYXJ0aWZhY3RzOwoKICAgICAgICAgICAgdmFyIGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgIGlmIChpdGVtID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydFBydW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGl0ZW0ua2V5OwoKICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwgJiYgY3VycmVudC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdGhpcy5uZXh0UmV0YWluKGl0ZW0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFydGlmYWN0cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgdGhpcy5uZXh0TW92ZShpdGVtKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubmV4dEluc2VydChpdGVtKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUGhhc2UuQXBwZW5kOwogICAgICAgIH07CgogICAgICAgIEl0ZXJhdG9yU3luY2hyb25pemVyLnByb3RvdHlwZS5uZXh0UmV0YWluID0gZnVuY3Rpb24gbmV4dFJldGFpbihpdGVtKSB7CiAgICAgICAgICAgIHZhciBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0cywKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CgogICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgY3VycmVudC51cGRhdGUoaXRlbSk7CiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5uZXh0Tm9kZShjdXJyZW50KTsKICAgICAgICAgICAgdGhpcy50YXJnZXQucmV0YWluKGl0ZW0ua2V5LCBjdXJyZW50LnZhbHVlLCBjdXJyZW50Lm1lbW8pOwogICAgICAgIH07CgogICAgICAgIEl0ZXJhdG9yU3luY2hyb25pemVyLnByb3RvdHlwZS5uZXh0TW92ZSA9IGZ1bmN0aW9uIG5leHRNb3ZlKGl0ZW0pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQsCiAgICAgICAgICAgICAgICBhcnRpZmFjdHMgPSB0aGlzLmFydGlmYWN0cywKICAgICAgICAgICAgICAgIHRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgICAgICB2YXIga2V5ID0gaXRlbS5rZXk7CgogICAgICAgICAgICB2YXIgZm91bmQgPSBhcnRpZmFjdHMuZ2V0KGl0ZW0ua2V5KTsKICAgICAgICAgICAgZm91bmQudXBkYXRlKGl0ZW0pOwogICAgICAgICAgICBpZiAoYXJ0aWZhY3RzLndhc1NlZW4oaXRlbS5rZXkpKSB7CiAgICAgICAgICAgICAgICBhcnRpZmFjdHMubW92ZShmb3VuZCwgY3VycmVudCk7CiAgICAgICAgICAgICAgICB0YXJnZXQubW92ZShmb3VuZC5rZXksIGZvdW5kLnZhbHVlLCBmb3VuZC5tZW1vLCBjdXJyZW50ID8gY3VycmVudC5rZXkgOiBudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYWR2YW5jZVRvS2V5KGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBJdGVyYXRvclN5bmNocm9uaXplci5wcm90b3R5cGUubmV4dEluc2VydCA9IGZ1bmN0aW9uIG5leHRJbnNlcnQoaXRlbSkgewogICAgICAgICAgICB2YXIgYXJ0aWZhY3RzID0gdGhpcy5hcnRpZmFjdHMsCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0aGlzLnRhcmdldCwKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CgogICAgICAgICAgICB2YXIgbm9kZSA9IGFydGlmYWN0cy5pbnNlcnRCZWZvcmUoaXRlbSwgY3VycmVudCk7CiAgICAgICAgICAgIHRhcmdldC5pbnNlcnQobm9kZS5rZXksIG5vZGUudmFsdWUsIG5vZGUubWVtbywgY3VycmVudCA/IGN1cnJlbnQua2V5IDogbnVsbCk7CiAgICAgICAgfTsKCiAgICAgICAgSXRlcmF0b3JTeW5jaHJvbml6ZXIucHJvdG90eXBlLnN0YXJ0UHJ1bmUgPSBmdW5jdGlvbiBzdGFydFBydW5lKCkgewogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmFydGlmYWN0cy5oZWFkKCk7CiAgICAgICAgICAgIHJldHVybiBQaGFzZS5QcnVuZTsKICAgICAgICB9OwoKICAgICAgICBJdGVyYXRvclN5bmNocm9uaXplci5wcm90b3R5cGUubmV4dFBydW5lID0gZnVuY3Rpb24gbmV4dFBydW5lKCkgewogICAgICAgICAgICB2YXIgYXJ0aWZhY3RzID0gdGhpcy5hcnRpZmFjdHMsCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0aGlzLnRhcmdldCwKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CgogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBoYXNlLkRvbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBjdXJyZW50OwogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBhcnRpZmFjdHMubmV4dE5vZGUobm9kZSk7CiAgICAgICAgICAgIGlmIChub2RlLnNob3VsZFJlbW92ZSgpKSB7CiAgICAgICAgICAgICAgICBhcnRpZmFjdHMucmVtb3ZlKG5vZGUpOwogICAgICAgICAgICAgICAgdGFyZ2V0LmRlbGV0ZShub2RlLmtleSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLnJlc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFBoYXNlLlBydW5lOwogICAgICAgIH07CgogICAgICAgIEl0ZXJhdG9yU3luY2hyb25pemVyLnByb3RvdHlwZS5uZXh0RG9uZSA9IGZ1bmN0aW9uIG5leHREb25lKCkgewogICAgICAgICAgICB0aGlzLnRhcmdldC5kb25lKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEl0ZXJhdG9yU3luY2hyb25pemVyOwogICAgfSgpOwoKICAgIGV4cG9ydHMuQ29uc3RSZWZlcmVuY2UgPSBDb25zdFJlZmVyZW5jZTsKICAgIGV4cG9ydHMuTGlzdEl0ZW0gPSBMaXN0SXRlbTsKICAgIGV4cG9ydHMuSXRlcmF0aW9uQXJ0aWZhY3RzID0gSXRlcmF0aW9uQXJ0aWZhY3RzOwogICAgZXhwb3J0cy5SZWZlcmVuY2VJdGVyYXRvciA9IFJlZmVyZW5jZUl0ZXJhdG9yOwogICAgZXhwb3J0cy5JdGVyYXRvclN5bmNocm9uaXplciA9IEl0ZXJhdG9yU3luY2hyb25pemVyOwogICAgZXhwb3J0cy5DT05TVEFOVCA9IENPTlNUQU5UOwogICAgZXhwb3J0cy5JTklUSUFMID0gSU5JVElBTDsKICAgIGV4cG9ydHMuVk9MQVRJTEUgPSBWT0xBVElMRTsKICAgIGV4cG9ydHMuUmV2aXNpb25UYWcgPSBSZXZpc2lvblRhZzsKICAgIGV4cG9ydHMuVGFnV3JhcHBlciA9IFRhZ1dyYXBwZXI7CiAgICBleHBvcnRzLkNPTlNUQU5UX1RBRyA9IENPTlNUQU5UX1RBRzsKICAgIGV4cG9ydHMuVk9MQVRJTEVfVEFHID0gVk9MQVRJTEVfVEFHOwogICAgZXhwb3J0cy5DVVJSRU5UX1RBRyA9IENVUlJFTlRfVEFHOwogICAgZXhwb3J0cy5pc0NvbnN0ID0gaXNDb25zdDsKICAgIGV4cG9ydHMuaXNDb25zdFRhZyA9IGlzQ29uc3RUYWc7CiAgICBleHBvcnRzLmJ1bXAgPSBidW1wOwogICAgZXhwb3J0cy5EaXJ0eWFibGVUYWcgPSBEaXJ0eWFibGVUYWc7CiAgICBleHBvcnRzLmNvbWJpbmVUYWdnZWQgPSBjb21iaW5lVGFnZ2VkOwogICAgZXhwb3J0cy5jb21iaW5lU2xpY2UgPSBjb21iaW5lU2xpY2U7CiAgICBleHBvcnRzLmNvbWJpbmUgPSBjb21iaW5lOwogICAgZXhwb3J0cy5DYWNoZWRUYWcgPSBDYWNoZWRUYWc7CiAgICBleHBvcnRzLlVwZGF0YWJsZVRhZyA9IFVwZGF0YWJsZVRhZzsKICAgIGV4cG9ydHMuQ2FjaGVkUmVmZXJlbmNlID0gQ2FjaGVkUmVmZXJlbmNlOwogICAgZXhwb3J0cy5tYXAgPSBtYXA7CiAgICBleHBvcnRzLlJlZmVyZW5jZUNhY2hlID0gUmVmZXJlbmNlQ2FjaGU7CiAgICBleHBvcnRzLmlzTW9kaWZpZWQgPSBpc01vZGlmaWVkOwp9KTsKZW5pZmVkKCdAZ2xpbW1lci9ydW50aW1lJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BnbGltbWVyL3V0aWwnLCAnQGdsaW1tZXIvcmVmZXJlbmNlJywgJ0BnbGltbWVyL3ZtJywgJ0BnbGltbWVyL2xvdy1sZXZlbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF91dGlsLCBfcmVmZXJlbmNlLCBfdm0yLCBfbG93TGV2ZWwpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLmhhc0NhcGFiaWxpdHkgPSBleHBvcnRzLmNhcGFiaWxpdHlGbGFnc0Zyb20gPSBleHBvcnRzLkN1cnNvciA9IGV4cG9ydHMuQ29uY3JldGVCb3VuZHMgPSBleHBvcnRzLlJlaHlkcmF0ZUJ1aWxkZXIgPSBleHBvcnRzLnJlaHlkcmF0aW9uQnVpbGRlciA9IGV4cG9ydHMuY2xpZW50QnVpbGRlciA9IGV4cG9ydHMuTmV3RWxlbWVudEJ1aWxkZXIgPSBleHBvcnRzLm5vcm1hbGl6ZVByb3BlcnR5ID0gZXhwb3J0cy5pbnNlcnRIVE1MQmVmb3JlID0gZXhwb3J0cy5pc1doaXRlc3BhY2UgPSBleHBvcnRzLkRPTVRyZWVDb25zdHJ1Y3Rpb24gPSBleHBvcnRzLklET01DaGFuZ2VzID0gZXhwb3J0cy5TVkdfTkFNRVNQQUNFID0gZXhwb3J0cy5ET01DaGFuZ2VzID0gZXhwb3J0cy5jdXJyeSA9IGV4cG9ydHMuaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbiA9IGV4cG9ydHMuQ3VycmllZENvbXBvbmVudERlZmluaXRpb24gPSBleHBvcnRzLk1JTklNQUxfQ0FQQUJJTElUSUVTID0gZXhwb3J0cy5ERUZBVUxUX0NBUEFCSUxJVElFUyA9IGV4cG9ydHMuRGVmYXVsdEVudmlyb25tZW50ID0gZXhwb3J0cy5FbnZpcm9ubWVudCA9IGV4cG9ydHMuU2NvcGUgPSBleHBvcnRzLkVNUFRZX0FSR1MgPSBleHBvcnRzLkR5bmFtaWNBdHRyaWJ1dGUgPSBleHBvcnRzLlNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUgPSBleHBvcnRzLlJlbmRlclJlc3VsdCA9IGV4cG9ydHMuVXBkYXRpbmdWTSA9IGV4cG9ydHMuTG93TGV2ZWxWTSA9IGV4cG9ydHMuZ2V0RHluYW1pY1ZhciA9IGV4cG9ydHMucmVzZXREZWJ1Z2dlckNhbGxiYWNrID0gZXhwb3J0cy5zZXREZWJ1Z2dlckNhbGxiYWNrID0gZXhwb3J0cy5Db25kaXRpb25hbFJlZmVyZW5jZSA9IGV4cG9ydHMuUHJpbWl0aXZlUmVmZXJlbmNlID0gZXhwb3J0cy5VTkRFRklORURfUkVGRVJFTkNFID0gZXhwb3J0cy5OVUxMX1JFRkVSRU5DRSA9IGV4cG9ydHMucmVuZGVyTWFpbiA9IHVuZGVmaW5lZDsKCiAgICB2YXIgQXBwZW5kT3Bjb2RlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBBcHBlbmRPcGNvZGVzKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFwcGVuZE9wY29kZXMpOwoKICAgICAgICAgICAgdGhpcy5ldmFsdWF0ZU9wY29kZSA9ICgwLCBfdXRpbC5maWxsTnVsbHMpKDk4IC8qIFNpemUgKi8pLnNsaWNlKCk7CiAgICAgICAgfQoKICAgICAgICBBcHBlbmRPcGNvZGVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQobmFtZSwgZXZhbHVhdGUpIHsKICAgICAgICAgICAgdmFyIGtpbmQgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6ICdzeXNjYWxsJzsKCiAgICAgICAgICAgIHRoaXMuZXZhbHVhdGVPcGNvZGVbbmFtZV0gPSB7IHN5c2NhbGw6IGtpbmQgPT09ICdzeXNjYWxsJywgZXZhbHVhdGU6IGV2YWx1YXRlIH07CiAgICAgICAgfTsKCiAgICAgICAgQXBwZW5kT3Bjb2Rlcy5wcm90b3R5cGUuZGVidWdCZWZvcmUgPSBmdW5jdGlvbiBkZWJ1Z0JlZm9yZSh2bSwgb3Bjb2RlLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciBzcCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHN0YXRlID0gdm9pZCAwOwoKICAgICAgICAgICAgcmV0dXJuIHsgc3A6IHNwLCBzdGF0ZTogc3RhdGUgfTsKICAgICAgICB9OwoKICAgICAgICBBcHBlbmRPcGNvZGVzLnByb3RvdHlwZS5kZWJ1Z0FmdGVyID0gZnVuY3Rpb24gZGVidWdBZnRlcih2bSwgb3Bjb2RlLCB0eXBlLCBwcmUpIHsKICAgICAgICAgICAgdmFyIGV4cGVjdGVkQ2hhbmdlID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgc3AgPSBwcmUuc3AsCiAgICAgICAgICAgICAgICBzdGF0ZSA9IHByZS5zdGF0ZTsKCiAgICAgICAgICAgIHZhciBtZXRhZGF0YSA9IG51bGw7CiAgICAgICAgICAgIGlmIChtZXRhZGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXRhZGF0YS5zdGFja0NoYW5nZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZENoYW5nZSA9IG1ldGFkYXRhLnN0YWNrQ2hhbmdlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBleHBlY3RlZENoYW5nZSA9IG1ldGFkYXRhLnN0YWNrQ2hhbmdlKHsgb3Bjb2RlOiBvcGNvZGUsIGNvbnN0YW50czogdm0uY29uc3RhbnRzLCBzdGF0ZTogc3RhdGUgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKGV4cGVjdGVkQ2hhbmdlKSkgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQXBwZW5kT3Bjb2Rlcy5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSwgb3Bjb2RlLCB0eXBlKSB7CiAgICAgICAgICAgIHZhciBvcGVyYXRpb24gPSB0aGlzLmV2YWx1YXRlT3Bjb2RlW3R5cGVdOwogICAgICAgICAgICBpZiAob3BlcmF0aW9uLnN5c2NhbGwpIHsKCiAgICAgICAgICAgICAgICBvcGVyYXRpb24uZXZhbHVhdGUodm0sIG9wY29kZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgb3BlcmF0aW9uLmV2YWx1YXRlKHZtLmlubmVyLCBvcGNvZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFwcGVuZE9wY29kZXM7CiAgICB9KCk7CgogICAgdmFyIEFQUEVORF9PUENPREVTID0gbmV3IEFwcGVuZE9wY29kZXMoKTsKCiAgICB2YXIgQWJzdHJhY3RPcGNvZGUgPSBmdW5jdGlvbiBBYnN0cmFjdE9wY29kZSgpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFic3RyYWN0T3Bjb2RlKTsKCiAgICAgICAgKDAsIF91dGlsLmluaXRpYWxpemVHdWlkKSh0aGlzKTsKICAgIH07CgogICAgdmFyIFVwZGF0aW5nT3Bjb2RlID0gZnVuY3Rpb24gKF9BYnN0cmFjdE9wY29kZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVXBkYXRpbmdPcGNvZGUsIF9BYnN0cmFjdE9wY29kZSk7CgogICAgICAgIGZ1bmN0aW9uIFVwZGF0aW5nT3Bjb2RlKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFVwZGF0aW5nT3Bjb2RlKTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQWJzdHJhY3RPcGNvZGUuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CgogICAgICAgICAgICBfdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgX3RoaXMucHJldiA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBfdGhpczsKICAgICAgICB9CgogICAgICAgIHJldHVybiBVcGRhdGluZ09wY29kZTsKICAgIH0oQWJzdHJhY3RPcGNvZGUpOwoKICAgIHZhciBQcmltaXRpdmVSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX0NvbnN0UmVmZXJlbmNlKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShQcmltaXRpdmVSZWZlcmVuY2UsIF9Db25zdFJlZmVyZW5jZSk7CgogICAgICAgIGZ1bmN0aW9uIFByaW1pdGl2ZVJlZmVyZW5jZSh2YWx1ZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFByaW1pdGl2ZVJlZmVyZW5jZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NvbnN0UmVmZXJlbmNlLmNhbGwodGhpcywgdmFsdWUpKTsKICAgICAgICB9CgogICAgICAgIFByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTlVMTF9SRUZFUkVOQ0U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBUUlVFX1JFRkVSRU5DRTsKICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiBGQUxTRV9SRUZFUkVOQ0U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBWYWx1ZVJlZmVyZW5jZSh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0cmluZ1JlZmVyZW5jZSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBQcmltaXRpdmVSZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChfa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBQcmltaXRpdmVSZWZlcmVuY2U7CiAgICB9KF9yZWZlcmVuY2UuQ29uc3RSZWZlcmVuY2UpOwoKICAgIHZhciBTdHJpbmdSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX1ByaW1pdGl2ZVJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoU3RyaW5nUmVmZXJlbmNlLCBfUHJpbWl0aXZlUmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gU3RyaW5nUmVmZXJlbmNlKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFN0cmluZ1JlZmVyZW5jZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMzID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9QcmltaXRpdmVSZWZlcmVuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CgogICAgICAgICAgICBfdGhpczMubGVuZ3RoUmVmZXJlbmNlID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMzsKICAgICAgICB9CgogICAgICAgIFN0cmluZ1JlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICBpZiAoa2V5ID09PSAnbGVuZ3RoJykgewogICAgICAgICAgICAgICAgdmFyIGxlbmd0aFJlZmVyZW5jZSA9IHRoaXMubGVuZ3RoUmVmZXJlbmNlOwoKICAgICAgICAgICAgICAgIGlmIChsZW5ndGhSZWZlcmVuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBsZW5ndGhSZWZlcmVuY2UgPSB0aGlzLmxlbmd0aFJlZmVyZW5jZSA9IG5ldyBWYWx1ZVJlZmVyZW5jZSh0aGlzLmlubmVyLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbGVuZ3RoUmVmZXJlbmNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIF9QcmltaXRpdmVSZWZlcmVuY2UucHJvdG90eXBlLmdldC5jYWxsKHRoaXMsIGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gU3RyaW5nUmVmZXJlbmNlOwogICAgfShQcmltaXRpdmVSZWZlcmVuY2UpOwoKICAgIHZhciBWYWx1ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfUHJpbWl0aXZlUmVmZXJlbmNlMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVmFsdWVSZWZlcmVuY2UsIF9QcmltaXRpdmVSZWZlcmVuY2UyKTsKCiAgICAgICAgZnVuY3Rpb24gVmFsdWVSZWZlcmVuY2UodmFsdWUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBWYWx1ZVJlZmVyZW5jZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1ByaW1pdGl2ZVJlZmVyZW5jZTIuY2FsbCh0aGlzLCB2YWx1ZSkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFZhbHVlUmVmZXJlbmNlOwogICAgfShQcmltaXRpdmVSZWZlcmVuY2UpOwoKICAgIHZhciBVTkRFRklORURfUkVGRVJFTkNFID0gbmV3IFZhbHVlUmVmZXJlbmNlKHVuZGVmaW5lZCk7CiAgICB2YXIgTlVMTF9SRUZFUkVOQ0UgPSBuZXcgVmFsdWVSZWZlcmVuY2UobnVsbCk7CiAgICB2YXIgVFJVRV9SRUZFUkVOQ0UgPSBuZXcgVmFsdWVSZWZlcmVuY2UodHJ1ZSk7CiAgICB2YXIgRkFMU0VfUkVGRVJFTkNFID0gbmV3IFZhbHVlUmVmZXJlbmNlKGZhbHNlKTsKCiAgICB2YXIgQ29uZGl0aW9uYWxSZWZlcmVuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29uZGl0aW9uYWxSZWZlcmVuY2UoaW5uZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb25kaXRpb25hbFJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIHRoaXMudGFnID0gaW5uZXIudGFnOwogICAgICAgIH0KCiAgICAgICAgQ29uZGl0aW9uYWxSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvQm9vbCh0aGlzLmlubmVyLnZhbHVlKCkpOwogICAgICAgIH07CgogICAgICAgIENvbmRpdGlvbmFsUmVmZXJlbmNlLnByb3RvdHlwZS50b0Jvb2wgPSBmdW5jdGlvbiB0b0Jvb2wodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuICEhdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbmRpdGlvbmFsUmVmZXJlbmNlOwogICAgfSgpOwoKICAgIHZhciBDb25jYXRSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQ29uY2F0UmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gQ29uY2F0UmVmZXJlbmNlKHBhcnRzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ29uY2F0UmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczUgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNS5wYXJ0cyA9IHBhcnRzOwogICAgICAgICAgICBfdGhpczUudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZVRhZ2dlZCkocGFydHMpOwogICAgICAgICAgICByZXR1cm4gX3RoaXM1OwogICAgICAgIH0KCiAgICAgICAgQ29uY2F0UmVmZXJlbmNlLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgdmFyIHBhcnRzID0gbmV3IEFycmF5KCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5wYXJ0c1tpXS52YWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0c1tpXSA9IGNhc3RUb1N0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ29uY2F0UmVmZXJlbmNlOwogICAgfShfcmVmZXJlbmNlLkNhY2hlZFJlZmVyZW5jZSk7CgogICAgZnVuY3Rpb24gY2FzdFRvU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgfQoKICAgIEFQUEVORF9PUENPREVTLmFkZCgxIC8qIEhlbHBlciAqLywgZnVuY3Rpb24gKHZtLCBfcmVmKSB7CiAgICAgICAgdmFyIGhhbmRsZSA9IF9yZWYub3AxOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgaGVscGVyID0gdm0uY29uc3RhbnRzLnJlc29sdmVIYW5kbGUoaGFuZGxlKTsKICAgICAgICB2YXIgYXJncyA9IHN0YWNrLnBvcCgpOwogICAgICAgIHZhciB2YWx1ZSA9IGhlbHBlcih2bSwgYXJncyk7CiAgICAgICAgdm0ubG9hZFZhbHVlKF92bTIuUmVnaXN0ZXIudjAsIHZhbHVlKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDYgLyogR2V0VmFyaWFibGUgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjIpIHsKICAgICAgICB2YXIgc3ltYm9sID0gX3JlZjIub3AxOwoKICAgICAgICB2YXIgZXhwciA9IHZtLnJlZmVyZW5jZUZvclN5bWJvbChzeW1ib2wpOwogICAgICAgIHZtLnN0YWNrLnB1c2goZXhwcik7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0IC8qIFNldFZhcmlhYmxlICovLCBmdW5jdGlvbiAodm0sIF9yZWYzKSB7CiAgICAgICAgdmFyIHN5bWJvbCA9IF9yZWYzLm9wMTsKCiAgICAgICAgdmFyIGV4cHIgPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2bS5zY29wZSgpLmJpbmRTeW1ib2woc3ltYm9sLCBleHByKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDUgLyogU2V0QmxvY2sgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjQpIHsKICAgICAgICB2YXIgc3ltYm9sID0gX3JlZjQub3AxOwoKICAgICAgICB2YXIgaGFuZGxlID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIHNjb3BlID0gdm0uc3RhY2sucG9wKCk7IC8vIEZJWE1FKG1tdW4pOiBzaG91bGRuJ3QgbmVlZCB0byBjYXN0IHRoaXMKICAgICAgICB2YXIgdGFibGUgPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2YXIgYmxvY2sgPSB0YWJsZSA/IFtoYW5kbGUsIHNjb3BlLCB0YWJsZV0gOiBudWxsOwogICAgICAgIHZtLnNjb3BlKCkuYmluZEJsb2NrKHN5bWJvbCwgYmxvY2spOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoOTYgLyogUmVzb2x2ZU1heWJlTG9jYWwgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjUpIHsKICAgICAgICB2YXIgX25hbWUgPSBfcmVmNS5vcDE7CgogICAgICAgIHZhciBuYW1lID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZSk7CiAgICAgICAgdmFyIGxvY2FscyA9IHZtLnNjb3BlKCkuZ2V0UGFydGlhbE1hcCgpOwogICAgICAgIHZhciByZWYgPSBsb2NhbHNbbmFtZV07CiAgICAgICAgaWYgKHJlZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlZiA9IHZtLmdldFNlbGYoKS5nZXQobmFtZSk7CiAgICAgICAgfQogICAgICAgIHZtLnN0YWNrLnB1c2gocmVmKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDIwIC8qIFJvb3RTY29wZSAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNikgewogICAgICAgIHZhciBzeW1ib2xzID0gX3JlZjYub3AxLAogICAgICAgICAgICBiaW5kQ2FsbGVyU2NvcGUgPSBfcmVmNi5vcDI7CgogICAgICAgIHZtLnB1c2hSb290U2NvcGUoc3ltYm9scywgISFiaW5kQ2FsbGVyU2NvcGUpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNyAvKiBHZXRQcm9wZXJ0eSAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNykgewogICAgICAgIHZhciBfa2V5ID0gX3JlZjcub3AxOwoKICAgICAgICB2YXIga2V5ID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfa2V5KTsKICAgICAgICB2YXIgZXhwciA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIHZtLnN0YWNrLnB1c2goZXhwci5nZXQoa2V5KSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg4IC8qIEdldEJsb2NrICovLCBmdW5jdGlvbiAodm0sIF9yZWY4KSB7CiAgICAgICAgdmFyIF9ibG9jayA9IF9yZWY4Lm9wMTsKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKCiAgICAgICAgdmFyIGJsb2NrID0gdm0uc2NvcGUoKS5nZXRCbG9jayhfYmxvY2spOwogICAgICAgIGlmIChibG9jaykgewogICAgICAgICAgICBzdGFjay5wdXNoKGJsb2NrWzJdKTsKICAgICAgICAgICAgc3RhY2sucHVzaChibG9ja1sxXSk7CiAgICAgICAgICAgIHN0YWNrLnB1c2goYmxvY2tbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgICAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgICAgICAgIHN0YWNrLnB1c2gobnVsbCk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoOSAvKiBIYXNCbG9jayAqLywgZnVuY3Rpb24gKHZtLCBfcmVmOSkgewogICAgICAgIHZhciBfYmxvY2sgPSBfcmVmOS5vcDE7CgogICAgICAgIHZhciBoYXNCbG9jayA9ICEhdm0uc2NvcGUoKS5nZXRCbG9jayhfYmxvY2spOwogICAgICAgIHZtLnN0YWNrLnB1c2goaGFzQmxvY2sgPyBUUlVFX1JFRkVSRU5DRSA6IEZBTFNFX1JFRkVSRU5DRSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgxMCAvKiBIYXNCbG9ja1BhcmFtcyAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgLy8gRklYTUUobW11bik6IHNob3VsZCBvbmx5IG5lZWQgdG8gcHVzaCB0aGUgc3ltYm9sIHRhYmxlCiAgICAgICAgdmFyIGJsb2NrID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIHNjb3BlID0gdm0uc3RhY2sucG9wKCk7CgogICAgICAgIHZhciB0YWJsZSA9IHZtLnN0YWNrLnBvcCgpOwoKICAgICAgICB2YXIgaGFzQmxvY2tQYXJhbXMgPSB0YWJsZSAmJiB0YWJsZS5wYXJhbWV0ZXJzLmxlbmd0aDsKICAgICAgICB2bS5zdGFjay5wdXNoKGhhc0Jsb2NrUGFyYW1zID8gVFJVRV9SRUZFUkVOQ0UgOiBGQUxTRV9SRUZFUkVOQ0UpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMTEgLyogQ29uY2F0ICovLCBmdW5jdGlvbiAodm0sIF9yZWYxMCkgewogICAgICAgIHZhciBjb3VudCA9IF9yZWYxMC5vcDE7CgogICAgICAgIHZhciBvdXQgPSBuZXcgQXJyYXkoY291bnQpOwogICAgICAgIGZvciAodmFyIGkgPSBjb3VudDsgaSA+IDA7IGktLSkgewogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gaSAtIDE7CiAgICAgICAgICAgIG91dFtvZmZzZXRdID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgfQogICAgICAgIHZtLnN0YWNrLnB1c2gobmV3IENvbmNhdFJlZmVyZW5jZShvdXQpKTsKICAgIH0pOwoKICAgIHZhciBDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EID0gJ0NVUlJJRUQgQ09NUE9ORU5UIERFRklOSVRJT04gW2lkPTZmMDBmZWI5LWEwZWYtNDU0Ny05OWVhLWFjMzI4ZjgwYWNlYV0nOwogICAgZnVuY3Rpb24gaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihkZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuICEhKGRlZmluaXRpb24gJiYgZGVmaW5pdGlvbltDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EXSk7CiAgICB9CiAgICBmdW5jdGlvbiBpc0NvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbikgewogICAgICAgIHJldHVybiBkZWZpbml0aW9uICYmIGRlZmluaXRpb25bQ1VSUklFRF9DT01QT05FTlRfREVGSU5JVElPTl9CUkFORF07CiAgICB9CgogICAgdmFyIEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8qKiBAaW50ZXJuYWwgKi8KICAgICAgICBmdW5jdGlvbiBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihpbm5lciwgYXJncykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKTsKCiAgICAgICAgICAgIHRoaXMuaW5uZXIgPSBpbm5lcjsKICAgICAgICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgICAgICAgdGhpc1tDVVJSSUVEX0NPTVBPTkVOVF9ERUZJTklUSU9OX0JSQU5EXSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbi5wcm90b3R5cGUudW53cmFwID0gZnVuY3Rpb24gdW53cmFwKGFyZ3MpIHsKICAgICAgICAgICAgYXJncy5yZWFsbG9jKHRoaXMub2Zmc2V0KTsKICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSB0aGlzOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgdmFyIF9kZWZpbml0aW9uID0gZGVmaW5pdGlvbiwKICAgICAgICAgICAgICAgICAgICBjdXJyaWVkQXJncyA9IF9kZWZpbml0aW9uLmFyZ3MsCiAgICAgICAgICAgICAgICAgICAgaW5uZXIgPSBfZGVmaW5pdGlvbi5pbm5lcjsKCiAgICAgICAgICAgICAgICBpZiAoY3VycmllZEFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnBvc2l0aW9uYWwucHJlcGVuZChjdXJyaWVkQXJncy5wb3NpdGlvbmFsKTsKICAgICAgICAgICAgICAgICAgICBhcmdzLm5hbWVkLm1lcmdlKGN1cnJpZWRBcmdzLm5hbWVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihpbm5lcikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5uZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gaW5uZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uLCBbewogICAgICAgICAgICBrZXk6ICdvZmZzZXQnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpbm5lciA9IHRoaXMuaW5uZXIsCiAgICAgICAgICAgICAgICAgICAgYXJncyA9IHRoaXMuYXJnczsKCiAgICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gYXJncyA/IGFyZ3MucG9zaXRpb25hbC5sZW5ndGggOiAwOwogICAgICAgICAgICAgICAgcmV0dXJuIGlzQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oaW5uZXIpID8gbGVuZ3RoICsgaW5uZXIub2Zmc2V0IDogbGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbjsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBjdXJyeShzcGVjKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CgogICAgICAgIHJldHVybiBuZXcgQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oc3BlYywgYXJncyk7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplU3RyaW5nVmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAoaXNFbXB0eSh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNob3VsZENvZXJjZSh2YWx1ZSkgewogICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgfHwgaXNFbXB0eSh2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT09ICdmdW5jdGlvbic7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NhZmVTdHJpbmcodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUudG9IVE1MID09PSAnZnVuY3Rpb24nOwogICAgfQogICAgZnVuY3Rpb24gaXNOb2RlKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLm5vZGVUeXBlID09PSAnbnVtYmVyJzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzRnJhZ21lbnQodmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNOb2RlKHZhbHVlKSAmJiB2YWx1ZS5ub2RlVHlwZSA9PT0gMTE7CiAgICB9CiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnOwogICAgfQoKICAgIHZhciBEeW5hbWljVGV4dENvbnRlbnQgPSBmdW5jdGlvbiAoX1VwZGF0aW5nT3Bjb2RlKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShEeW5hbWljVGV4dENvbnRlbnQsIF9VcGRhdGluZ09wY29kZSk7CgogICAgICAgIGZ1bmN0aW9uIER5bmFtaWNUZXh0Q29udGVudChub2RlLCByZWZlcmVuY2UsIGxhc3RWYWx1ZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIER5bmFtaWNUZXh0Q29udGVudCk7CgogICAgICAgICAgICB2YXIgX3RoaXM2ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9VcGRhdGluZ09wY29kZS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNi5ub2RlID0gbm9kZTsKICAgICAgICAgICAgX3RoaXM2LnJlZmVyZW5jZSA9IHJlZmVyZW5jZTsKICAgICAgICAgICAgX3RoaXM2Lmxhc3RWYWx1ZSA9IGxhc3RWYWx1ZTsKICAgICAgICAgICAgX3RoaXM2LnR5cGUgPSAnZHluYW1pYy10ZXh0JzsKICAgICAgICAgICAgX3RoaXM2LnRhZyA9IHJlZmVyZW5jZS50YWc7CiAgICAgICAgICAgIF90aGlzNi5sYXN0UmV2aXNpb24gPSBfdGhpczYudGFnLnZhbHVlKCk7CiAgICAgICAgICAgIHJldHVybiBfdGhpczY7CiAgICAgICAgfQoKICAgICAgICBEeW5hbWljVGV4dENvbnRlbnQucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUoKSB7CiAgICAgICAgICAgIHZhciByZWZlcmVuY2UgPSB0aGlzLnJlZmVyZW5jZSwKICAgICAgICAgICAgICAgIHRhZyA9IHRoaXMudGFnOwoKICAgICAgICAgICAgaWYgKCF0YWcudmFsaWRhdGUodGhpcy5sYXN0UmV2aXNpb24pKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IHRhZy52YWx1ZSgpOwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUocmVmZXJlbmNlLnZhbHVlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRHluYW1pY1RleHRDb250ZW50LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRoaXMubGFzdFZhbHVlOwoKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBsYXN0VmFsdWUpIHJldHVybjsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWQgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc0VtcHR5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgbm9ybWFsaXplZCA9ICcnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgbm9ybWFsaXplZCA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9ybWFsaXplZCA9IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWQgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHRleHROb2RlID0gdGhpcy5ub2RlOwogICAgICAgICAgICAgICAgdGV4dE5vZGUubm9kZVZhbHVlID0gdGhpcy5sYXN0VmFsdWUgPSBub3JtYWxpemVkOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIER5bmFtaWNUZXh0Q29udGVudDsKICAgIH0oVXBkYXRpbmdPcGNvZGUpOwoKICAgIHZhciBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9Db25kaXRpb25hbFJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoSXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvblJlZmVyZW5jZSwgX0NvbmRpdGlvbmFsUmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gSXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvblJlZmVyZW5jZSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ29uZGl0aW9uYWxSZWZlcmVuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBJc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShpbm5lcikgewogICAgICAgICAgICByZXR1cm4gbmV3IElzQ3VycmllZENvbXBvbmVudERlZmluaXRpb25SZWZlcmVuY2UoaW5uZXIpOwogICAgICAgIH07CgogICAgICAgIElzQ3VycmllZENvbXBvbmVudERlZmluaXRpb25SZWZlcmVuY2UucHJvdG90eXBlLnRvQm9vbCA9IGZ1bmN0aW9uIHRvQm9vbCh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbih2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIElzQ3VycmllZENvbXBvbmVudERlZmluaXRpb25SZWZlcmVuY2U7CiAgICB9KENvbmRpdGlvbmFsUmVmZXJlbmNlKTsKCiAgICB2YXIgQ29udGVudFR5cGVSZWZlcmVuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29udGVudFR5cGVSZWZlcmVuY2UoaW5uZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb250ZW50VHlwZVJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIHRoaXMudGFnID0gaW5uZXIudGFnOwogICAgICAgIH0KCiAgICAgICAgQ29udGVudFR5cGVSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuaW5uZXIudmFsdWUoKTsKICAgICAgICAgICAgaWYgKHNob3VsZENvZXJjZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAxIC8qIFN0cmluZyAqLzsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0NvbXBvbmVudERlZmluaXRpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMCAvKiBDb21wb25lbnQgKi87CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTYWZlU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIDMgLyogU2FmZVN0cmluZyAqLzsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0ZyYWdtZW50KHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIDQgLyogRnJhZ21lbnQgKi87CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOb2RlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIDUgLyogTm9kZSAqLzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMSAvKiBTdHJpbmcgKi87CiAgICAgICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbnRlbnRUeXBlUmVmZXJlbmNlOwogICAgfSgpOwoKICAgIEFQUEVORF9PUENPREVTLmFkZCgyOCAvKiBBcHBlbmRIVE1MICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIHJhd1ZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgdmFyIHZhbHVlID0gaXNFbXB0eShyYXdWYWx1ZSkgPyAnJyA6IFN0cmluZyhyYXdWYWx1ZSk7CiAgICAgICAgdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljSFRNTCh2YWx1ZSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgyOSAvKiBBcHBlbmRTYWZlSFRNTCAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIHZhciByYXdWYWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpLnRvSFRNTCgpOwogICAgICAgIHZhciB2YWx1ZSA9IGlzRW1wdHkocmF3VmFsdWUpID8gJycgOiByYXdWYWx1ZTsKICAgICAgICB2bS5lbGVtZW50cygpLmFwcGVuZER5bmFtaWNIVE1MKHZhbHVlKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDMyIC8qIEFwcGVuZFRleHQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciByZWZlcmVuY2UgPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2YXIgcmF3VmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgICAgICB2YXIgdmFsdWUgPSBpc0VtcHR5KHJhd1ZhbHVlKSA/ICcnIDogU3RyaW5nKHJhd1ZhbHVlKTsKICAgICAgICB2YXIgbm9kZSA9IHZtLmVsZW1lbnRzKCkuYXBwZW5kRHluYW1pY1RleHQodmFsdWUpOwogICAgICAgIGlmICghKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICAgICAgICB2bS51cGRhdGVXaXRoKG5ldyBEeW5hbWljVGV4dENvbnRlbnQobm9kZSwgcmVmZXJlbmNlLCB2YWx1ZSkpOwogICAgICAgIH0KICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDMwIC8qIEFwcGVuZERvY3VtZW50RnJhZ21lbnQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciByZWZlcmVuY2UgPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2YXIgdmFsdWUgPSByZWZlcmVuY2UudmFsdWUoKTsKICAgICAgICB2bS5lbGVtZW50cygpLmFwcGVuZER5bmFtaWNGcmFnbWVudCh2YWx1ZSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgzMSAvKiBBcHBlbmROb2RlICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIHZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljTm9kZSh2YWx1ZSk7CiAgICB9KTsKCiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMjIgLyogQ2hpbGRTY29wZSAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgcmV0dXJuIHZtLnB1c2hDaGlsZFNjb3BlKCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgyMyAvKiBQb3BTY29wZSAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgcmV0dXJuIHZtLnBvcFNjb3BlKCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0NCAvKiBQdXNoRHluYW1pY1Njb3BlICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICByZXR1cm4gdm0ucHVzaER5bmFtaWNTY29wZSgpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNDUgLyogUG9wRHluYW1pY1Njb3BlICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICByZXR1cm4gdm0ucG9wRHluYW1pY1Njb3BlKCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgxMiAvKiBDb25zdGFudCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMTEpIHsKICAgICAgICB2YXIgb3RoZXIgPSBfcmVmMTEub3AxOwoKICAgICAgICB2bS5zdGFjay5wdXNoKHZtLmNvbnN0YW50cy5nZXRPdGhlcihvdGhlcikpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMTMgLyogUHJpbWl0aXZlICovLCBmdW5jdGlvbiAodm0sIF9yZWYxMikgewogICAgICAgIHZhciBwcmltaXRpdmUgPSBfcmVmMTIub3AxOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgZmxhZyA9IHByaW1pdGl2ZSAmIDc7IC8vIDExMQogICAgICAgIHZhciB2YWx1ZSA9IHByaW1pdGl2ZSA+PiAzOwogICAgICAgIHN3aXRjaCAoZmxhZykgewogICAgICAgICAgICBjYXNlIDAgLyogTlVNQkVSICovOgogICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAxIC8qIEZMT0FUICovOgogICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2bS5jb25zdGFudHMuZ2V0TnVtYmVyKHZhbHVlKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAyIC8qIFNUUklORyAqLzoKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2godm0uY29uc3RhbnRzLmdldFN0cmluZyh2YWx1ZSkpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMyAvKiBCT09MRUFOX09SX1ZPSUQgKi86CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoRW5jb2RlZEltbWVkaWF0ZShwcmltaXRpdmUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNCAvKiBORUdBVElWRSAqLzoKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2godm0uY29uc3RhbnRzLmdldE51bWJlcih2YWx1ZSkpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNSAvKiBCSUdfTlVNICovOgogICAgICAgICAgICAgICAgc3RhY2sucHVzaCh2bS5jb25zdGFudHMuZ2V0TnVtYmVyKHZhbHVlKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgxNCAvKiBQcmltaXRpdmVSZWZlcmVuY2UgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHN0YWNrLnB1c2goUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShzdGFjay5wb3AoKSkpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMTUgLyogUmVpZnlVMzIgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHN0YWNrLnB1c2goc3RhY2sucGVlaygpLnZhbHVlKCkpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMTYgLyogRHVwICovLCBmdW5jdGlvbiAodm0sIF9yZWYxMykgewogICAgICAgIHZhciByZWdpc3RlciA9IF9yZWYxMy5vcDEsCiAgICAgICAgICAgIG9mZnNldCA9IF9yZWYxMy5vcDI7CgogICAgICAgIHZhciBwb3NpdGlvbiA9IHZtLmZldGNoVmFsdWUocmVnaXN0ZXIpIC0gb2Zmc2V0OwogICAgICAgIHZtLnN0YWNrLmR1cChwb3NpdGlvbik7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgxNyAvKiBQb3AgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjE0KSB7CiAgICAgICAgdmFyIGNvdW50ID0gX3JlZjE0Lm9wMTsKCiAgICAgICAgdm0uc3RhY2sucG9wKGNvdW50KTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDE4IC8qIExvYWQgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjE1KSB7CiAgICAgICAgdmFyIHJlZ2lzdGVyID0gX3JlZjE1Lm9wMTsKCiAgICAgICAgdm0ubG9hZChyZWdpc3Rlcik7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgxOSAvKiBGZXRjaCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMTYpIHsKICAgICAgICB2YXIgcmVnaXN0ZXIgPSBfcmVmMTYub3AxOwoKICAgICAgICB2bS5mZXRjaChyZWdpc3Rlcik7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0MyAvKiBCaW5kRHluYW1pY1Njb3BlICovLCBmdW5jdGlvbiAodm0sIF9yZWYxNykgewogICAgICAgIHZhciBfbmFtZXMgPSBfcmVmMTcub3AxOwoKICAgICAgICB2YXIgbmFtZXMgPSB2bS5jb25zdGFudHMuZ2V0QXJyYXkoX25hbWVzKTsKICAgICAgICB2bS5iaW5kRHluYW1pY1Njb3BlKG5hbWVzKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDYxIC8qIEVudGVyICovLCBmdW5jdGlvbiAodm0sIF9yZWYxOCkgewogICAgICAgIHZhciBhcmdzID0gX3JlZjE4Lm9wMTsKCiAgICAgICAgdm0uZW50ZXIoYXJncyk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg2MiAvKiBFeGl0ICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2bS5leGl0KCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0OCAvKiBQdXNoU3ltYm9sVGFibGUgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjE5KSB7CiAgICAgICAgdmFyIF90YWJsZSA9IF9yZWYxOS5vcDE7CgogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHN0YWNrLnB1c2godm0uY29uc3RhbnRzLmdldFNlcmlhbGl6YWJsZShfdGFibGUpKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDQ3IC8qIFB1c2hCbG9ja1Njb3BlICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICBzdGFjay5wdXNoKHZtLnNjb3BlKCkpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNDYgLyogQ29tcGlsZUJsb2NrICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgYmxvY2sgPSBzdGFjay5wb3AoKTsKICAgICAgICBpZiAoYmxvY2spIHsKICAgICAgICAgICAgc3RhY2sucHVzaFNtaShibG9jay5jb21waWxlKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YWNrLnB1c2hOdWxsKCk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNTEgLyogSW52b2tlWWllbGQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwoKICAgICAgICB2YXIgaGFuZGxlID0gc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIHNjb3BlID0gc3RhY2sucG9wKCk7IC8vIEZJWE1FKG1tdW4pOiBzaG91bGRuJ3QgbmVlZCB0byBjYXN0IHRoaXMKICAgICAgICB2YXIgdGFibGUgPSBzdGFjay5wb3AoKTsKCiAgICAgICAgdmFyIGFyZ3MgPSBzdGFjay5wb3AoKTsKICAgICAgICBpZiAodGFibGUgPT09IG51bGwpIHsKICAgICAgICAgICAgLy8gVG8gYmFsYW5jZSB0aGUgcG9we0ZyYW1lLFNjb3BlfQogICAgICAgICAgICB2bS5wdXNoRnJhbWUoKTsKICAgICAgICAgICAgdm0ucHVzaFNjb3BlKHNjb3BlKTsgLy8gQ291bGQgYmUgbnVsbCBidXQgaXQgZG9lc250IG1hdHRlciBhcyBpdCBpcyBpbW1lZGlhdGVsbHkgcG9wcGVkLgogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2luZ1Njb3BlID0gc2NvcGU7CiAgICAgICAgLy8gSWYgbmVjZXNzYXJ5LCBjcmVhdGUgYSBjaGlsZCBzY29wZQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvY2FscyA9IHRhYmxlLnBhcmFtZXRlcnM7CiAgICAgICAgICAgIHZhciBsb2NhbHNDb3VudCA9IGxvY2Fscy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChsb2NhbHNDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIGludm9raW5nU2NvcGUgPSBpbnZva2luZ1Njb3BlLmNoaWxkKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvY2Fsc0NvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpbnZva2luZ1Njb3BlLmJpbmRTeW1ib2wobG9jYWxzW2ldLCBhcmdzLmF0KGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2bS5wdXNoRnJhbWUoKTsKICAgICAgICB2bS5wdXNoU2NvcGUoaW52b2tpbmdTY29wZSk7CiAgICAgICAgdm0uY2FsbChoYW5kbGUpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNTMgLyogSnVtcElmICovLCBmdW5jdGlvbiAodm0sIF9yZWYyMCkgewogICAgICAgIHZhciB0YXJnZXQgPSBfcmVmMjAub3AxOwoKICAgICAgICB2YXIgcmVmZXJlbmNlID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHJlZmVyZW5jZSkpIHsKICAgICAgICAgICAgaWYgKHJlZmVyZW5jZS52YWx1ZSgpKSB7CiAgICAgICAgICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgY2FjaGUgPSBuZXcgX3JlZmVyZW5jZS5SZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpOwogICAgICAgICAgICBpZiAoY2FjaGUucGVlaygpKSB7CiAgICAgICAgICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNTQgLyogSnVtcFVubGVzcyAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMjEpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gX3JlZjIxLm9wMTsKCiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShyZWZlcmVuY2UpKSB7CiAgICAgICAgICAgIGlmICghcmVmZXJlbmNlLnZhbHVlKCkpIHsKICAgICAgICAgICAgICAgIHZtLmdvdG8odGFyZ2V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IG5ldyBfcmVmZXJlbmNlLlJlZmVyZW5jZUNhY2hlKHJlZmVyZW5jZSk7CiAgICAgICAgICAgIGlmICghY2FjaGUucGVlaygpKSB7CiAgICAgICAgICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNTUgLyogSnVtcEVxICovLCBmdW5jdGlvbiAodm0sIF9yZWYyMikgewogICAgICAgIHZhciB0YXJnZXQgPSBfcmVmMjIub3AxLAogICAgICAgICAgICBjb21wYXJpc29uID0gX3JlZjIyLm9wMjsKCiAgICAgICAgdmFyIG90aGVyID0gdm0uc3RhY2sucGVlaygpOwogICAgICAgIGlmIChvdGhlciA9PT0gY29tcGFyaXNvbikgewogICAgICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNTYgLyogQXNzZXJ0U2FtZSAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBlZWsoKTsKICAgICAgICBpZiAoISgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHJlZmVyZW5jZSkpIHsKICAgICAgICAgICAgdm0udXBkYXRlV2l0aChBc3NlcnQuaW5pdGlhbGl6ZShuZXcgX3JlZmVyZW5jZS5SZWZlcmVuY2VDYWNoZShyZWZlcmVuY2UpKSk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNjMgLyogVG9Cb29sZWFuICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgZW52ID0gdm0uZW52LAogICAgICAgICAgICBzdGFjayA9IHZtLnN0YWNrOwoKICAgICAgICBzdGFjay5wdXNoKGVudi50b0NvbmRpdGlvbmFsUmVmZXJlbmNlKHN0YWNrLnBvcCgpKSk7CiAgICB9KTsKCiAgICB2YXIgQXNzZXJ0ID0gZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEFzc2VydCwgX1VwZGF0aW5nT3Bjb2RlMik7CgogICAgICAgIGZ1bmN0aW9uIEFzc2VydChjYWNoZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFzc2VydCk7CgogICAgICAgICAgICB2YXIgX3RoaXM4ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9VcGRhdGluZ09wY29kZTIuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczgudHlwZSA9ICdhc3NlcnQnOwogICAgICAgICAgICBfdGhpczgudGFnID0gY2FjaGUudGFnOwogICAgICAgICAgICBfdGhpczguY2FjaGUgPSBjYWNoZTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzODsKICAgICAgICB9CgogICAgICAgIEFzc2VydC5pbml0aWFsaXplID0gZnVuY3Rpb24gaW5pdGlhbGl6ZShjYWNoZSkgewogICAgICAgICAgICB2YXIgYXNzZXJ0ID0gbmV3IEFzc2VydChjYWNoZSk7CiAgICAgICAgICAgIGNhY2hlLnBlZWsoKTsKICAgICAgICAgICAgcmV0dXJuIGFzc2VydDsKICAgICAgICB9OwoKICAgICAgICBBc3NlcnQucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUodm0pIHsKICAgICAgICAgICAgdmFyIGNhY2hlID0gdGhpcy5jYWNoZTsKCiAgICAgICAgICAgIGlmICgoMCwgX3JlZmVyZW5jZS5pc01vZGlmaWVkKShjYWNoZS5yZXZhbGlkYXRlKCkpKSB7CiAgICAgICAgICAgICAgICB2bS50aHJvdygpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFzc2VydDsKICAgIH0oVXBkYXRpbmdPcGNvZGUpOwoKICAgIHZhciBKdW1wSWZOb3RNb2RpZmllZE9wY29kZSA9IGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGUzKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShKdW1wSWZOb3RNb2RpZmllZE9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlMyk7CgogICAgICAgIGZ1bmN0aW9uIEp1bXBJZk5vdE1vZGlmaWVkT3Bjb2RlKHRhZywgdGFyZ2V0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSnVtcElmTm90TW9kaWZpZWRPcGNvZGUpOwoKICAgICAgICAgICAgdmFyIF90aGlzOSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfVXBkYXRpbmdPcGNvZGUzLmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXM5LnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgX3RoaXM5LnR5cGUgPSAnanVtcC1pZi1ub3QtbW9kaWZpZWQnOwogICAgICAgICAgICBfdGhpczkudGFnID0gdGFnOwogICAgICAgICAgICBfdGhpczkubGFzdFJldmlzaW9uID0gdGFnLnZhbHVlKCk7CiAgICAgICAgICAgIHJldHVybiBfdGhpczk7CiAgICAgICAgfQoKICAgICAgICBKdW1wSWZOb3RNb2RpZmllZE9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSkgewogICAgICAgICAgICB2YXIgdGFnID0gdGhpcy50YWcsCiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0aGlzLnRhcmdldCwKICAgICAgICAgICAgICAgIGxhc3RSZXZpc2lvbiA9IHRoaXMubGFzdFJldmlzaW9uOwoKICAgICAgICAgICAgaWYgKCF2bS5hbHdheXNSZXZhbGlkYXRlICYmIHRhZy52YWxpZGF0ZShsYXN0UmV2aXNpb24pKSB7CiAgICAgICAgICAgICAgICB2bS5nb3RvKHRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBKdW1wSWZOb3RNb2RpZmllZE9wY29kZS5wcm90b3R5cGUuZGlkTW9kaWZ5ID0gZnVuY3Rpb24gZGlkTW9kaWZ5KCkgewogICAgICAgICAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IHRoaXMudGFnLnZhbHVlKCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEp1bXBJZk5vdE1vZGlmaWVkT3Bjb2RlOwogICAgfShVcGRhdGluZ09wY29kZSk7CgogICAgdmFyIERpZE1vZGlmeU9wY29kZSA9IGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGU0KSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShEaWRNb2RpZnlPcGNvZGUsIF9VcGRhdGluZ09wY29kZTQpOwoKICAgICAgICBmdW5jdGlvbiBEaWRNb2RpZnlPcGNvZGUodGFyZ2V0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRGlkTW9kaWZ5T3Bjb2RlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczEwID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9VcGRhdGluZ09wY29kZTQuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczEwLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgX3RoaXMxMC50eXBlID0gJ2RpZC1tb2RpZnknOwogICAgICAgICAgICBfdGhpczEwLnRhZyA9IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICByZXR1cm4gX3RoaXMxMDsKICAgICAgICB9CgogICAgICAgIERpZE1vZGlmeU9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQuZGlkTW9kaWZ5KCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIERpZE1vZGlmeU9wY29kZTsKICAgIH0oVXBkYXRpbmdPcGNvZGUpOwoKICAgIHZhciBMYWJlbE9wY29kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBMYWJlbE9wY29kZShsYWJlbCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIExhYmVsT3Bjb2RlKTsKCiAgICAgICAgICAgIHRoaXMudGFnID0gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgICAgICAgIHRoaXMudHlwZSA9ICdsYWJlbCc7CiAgICAgICAgICAgIHRoaXMubGFiZWwgPSBudWxsOwogICAgICAgICAgICB0aGlzLnByZXYgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgICAgICAoMCwgX3V0aWwuaW5pdGlhbGl6ZUd1aWQpKHRoaXMpOwogICAgICAgICAgICB0aGlzLmxhYmVsID0gbGFiZWw7CiAgICAgICAgfQoKICAgICAgICBMYWJlbE9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSgpIHt9OwoKICAgICAgICBMYWJlbE9wY29kZS5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxhYmVsICsgJyBbJyArIHRoaXMuX2d1aWQgKyAnXSc7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIExhYmVsT3Bjb2RlOwogICAgfSgpOwoKICAgIEFQUEVORF9PUENPREVTLmFkZCgyNiAvKiBUZXh0ICovLCBmdW5jdGlvbiAodm0sIF9yZWYyMykgewogICAgICAgIHZhciB0ZXh0ID0gX3JlZjIzLm9wMTsKCiAgICAgICAgdm0uZWxlbWVudHMoKS5hcHBlbmRUZXh0KHZtLmNvbnN0YW50cy5nZXRTdHJpbmcodGV4dCkpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMjcgLyogQ29tbWVudCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMjQpIHsKICAgICAgICB2YXIgdGV4dCA9IF9yZWYyNC5vcDE7CgogICAgICAgIHZtLmVsZW1lbnRzKCkuYXBwZW5kQ29tbWVudCh2bS5jb25zdGFudHMuZ2V0U3RyaW5nKHRleHQpKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDMzIC8qIE9wZW5FbGVtZW50ICovLCBmdW5jdGlvbiAodm0sIF9yZWYyNSkgewogICAgICAgIHZhciB0YWcgPSBfcmVmMjUub3AxOwoKICAgICAgICB2bS5lbGVtZW50cygpLm9wZW5FbGVtZW50KHZtLmNvbnN0YW50cy5nZXRTdHJpbmcodGFnKSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgzNCAvKiBPcGVuRHluYW1pY0VsZW1lbnQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciB0YWdOYW1lID0gdm0uc3RhY2sucG9wKCkudmFsdWUoKTsKICAgICAgICB2bS5lbGVtZW50cygpLm9wZW5FbGVtZW50KHRhZ05hbWUpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNDEgLyogUHVzaFJlbW90ZUVsZW1lbnQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBlbGVtZW50UmVmID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIG5leHRTaWJsaW5nUmVmID0gdm0uc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIGd1aWRSZWYgPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2YXIgZWxlbWVudCA9IHZvaWQgMDsKICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSB2b2lkIDA7CiAgICAgICAgdmFyIGd1aWQgPSBndWlkUmVmLnZhbHVlKCk7CiAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKGVsZW1lbnRSZWYpKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50UmVmLnZhbHVlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNhY2hlID0gbmV3IF9yZWZlcmVuY2UuUmVmZXJlbmNlQ2FjaGUoZWxlbWVudFJlZik7CiAgICAgICAgICAgIGVsZW1lbnQgPSBjYWNoZS5wZWVrKCk7CiAgICAgICAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpOwogICAgICAgIH0KICAgICAgICBpZiAoKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkobmV4dFNpYmxpbmdSZWYpKSB7CiAgICAgICAgICAgIG5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmdSZWYudmFsdWUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX2NhY2hlID0gbmV3IF9yZWZlcmVuY2UuUmVmZXJlbmNlQ2FjaGUobmV4dFNpYmxpbmdSZWYpOwogICAgICAgICAgICBuZXh0U2libGluZyA9IF9jYWNoZS5wZWVrKCk7CiAgICAgICAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChfY2FjaGUpKTsKICAgICAgICB9CiAgICAgICAgdm0uZWxlbWVudHMoKS5wdXNoUmVtb3RlRWxlbWVudChlbGVtZW50LCBndWlkLCBuZXh0U2libGluZyk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0MiAvKiBQb3BSZW1vdGVFbGVtZW50ICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2bS5lbGVtZW50cygpLnBvcFJlbW90ZUVsZW1lbnQoKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDM4IC8qIEZsdXNoRWxlbWVudCAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdmFyIG9wZXJhdGlvbnMgPSB2bS5mZXRjaFZhbHVlKF92bTIuUmVnaXN0ZXIudDApOwogICAgICAgIGlmIChvcGVyYXRpb25zKSB7CiAgICAgICAgICAgIG9wZXJhdGlvbnMuZmx1c2godm0pOwogICAgICAgICAgICB2bS5sb2FkVmFsdWUoX3ZtMi5SZWdpc3Rlci50MCwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIHZtLmVsZW1lbnRzKCkuZmx1c2hFbGVtZW50KCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgzOSAvKiBDbG9zZUVsZW1lbnQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZtLmVsZW1lbnRzKCkuY2xvc2VFbGVtZW50KCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg0MCAvKiBNb2RpZmllciAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMjYpIHsKICAgICAgICB2YXIgaGFuZGxlID0gX3JlZjI2Lm9wMTsKCiAgICAgICAgdmFyIG1hbmFnZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZUhhbmRsZShoYW5kbGUpOwogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHZhciBhcmdzID0gc3RhY2sucG9wKCk7CgogICAgICAgIHZhciBfdm0kZWxlbWVudHMgPSB2bS5lbGVtZW50cygpLAogICAgICAgICAgICBlbGVtZW50ID0gX3ZtJGVsZW1lbnRzLmNvbnN0cnVjdGluZywKICAgICAgICAgICAgdXBkYXRlT3BlcmF0aW9ucyA9IF92bSRlbGVtZW50cy51cGRhdGVPcGVyYXRpb25zOwoKICAgICAgICB2YXIgZHluYW1pY1Njb3BlID0gdm0uZHluYW1pY1Njb3BlKCk7CiAgICAgICAgdmFyIG1vZGlmaWVyID0gbWFuYWdlci5jcmVhdGUoZWxlbWVudCwgYXJncywgZHluYW1pY1Njb3BlLCB1cGRhdGVPcGVyYXRpb25zKTsKICAgICAgICB2bS5lbnYuc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpOwogICAgICAgIHZhciBkZXN0cnVjdG9yID0gbWFuYWdlci5nZXREZXN0cnVjdG9yKG1vZGlmaWVyKTsKICAgICAgICBpZiAoZGVzdHJ1Y3RvcikgewogICAgICAgICAgICB2bS5uZXdEZXN0cm95YWJsZShkZXN0cnVjdG9yKTsKICAgICAgICB9CiAgICAgICAgdmFyIHRhZyA9IG1hbmFnZXIuZ2V0VGFnKG1vZGlmaWVyKTsKICAgICAgICBpZiAoISgwLCBfcmVmZXJlbmNlLmlzQ29uc3RUYWcpKHRhZykpIHsKICAgICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlTW9kaWZpZXJPcGNvZGUodGFnLCBtYW5hZ2VyLCBtb2RpZmllcikpOwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBVcGRhdGVNb2RpZmllck9wY29kZSA9IGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGU1KSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShVcGRhdGVNb2RpZmllck9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlNSk7CgogICAgICAgIGZ1bmN0aW9uIFVwZGF0ZU1vZGlmaWVyT3Bjb2RlKHRhZywgbWFuYWdlciwgbW9kaWZpZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBVcGRhdGVNb2RpZmllck9wY29kZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMxMSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfVXBkYXRpbmdPcGNvZGU1LmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXMxMS50YWcgPSB0YWc7CiAgICAgICAgICAgIF90aGlzMTEubWFuYWdlciA9IG1hbmFnZXI7CiAgICAgICAgICAgIF90aGlzMTEubW9kaWZpZXIgPSBtb2RpZmllcjsKICAgICAgICAgICAgX3RoaXMxMS50eXBlID0gJ3VwZGF0ZS1tb2RpZmllcic7CiAgICAgICAgICAgIF90aGlzMTEubGFzdFVwZGF0ZWQgPSB0YWcudmFsdWUoKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMTE7CiAgICAgICAgfQoKICAgICAgICBVcGRhdGVNb2RpZmllck9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSkgewogICAgICAgICAgICB2YXIgbWFuYWdlciA9IHRoaXMubWFuYWdlciwKICAgICAgICAgICAgICAgIG1vZGlmaWVyID0gdGhpcy5tb2RpZmllciwKICAgICAgICAgICAgICAgIHRhZyA9IHRoaXMudGFnLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZWQgPSB0aGlzLmxhc3RVcGRhdGVkOwoKICAgICAgICAgICAgaWYgKCF0YWcudmFsaWRhdGUobGFzdFVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB2bS5lbnYuc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RVcGRhdGVkID0gdGFnLnZhbHVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gVXBkYXRlTW9kaWZpZXJPcGNvZGU7CiAgICB9KFVwZGF0aW5nT3Bjb2RlKTsKCiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMzUgLyogU3RhdGljQXR0ciAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMjcpIHsKICAgICAgICB2YXIgX25hbWUgPSBfcmVmMjcub3AxLAogICAgICAgICAgICBfdmFsdWUgPSBfcmVmMjcub3AyLAogICAgICAgICAgICBfbmFtZXNwYWNlID0gX3JlZjI3Lm9wMzsKCiAgICAgICAgdmFyIG5hbWUgPSB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF9uYW1lKTsKICAgICAgICB2YXIgdmFsdWUgPSB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF92YWx1ZSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IF9uYW1lc3BhY2UgPyB2bS5jb25zdGFudHMuZ2V0U3RyaW5nKF9uYW1lc3BhY2UpIDogbnVsbDsKICAgICAgICB2bS5lbGVtZW50cygpLnNldFN0YXRpY0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDM2IC8qIER5bmFtaWNBdHRyICovLCBmdW5jdGlvbiAodm0sIF9yZWYyOCkgewogICAgICAgIHZhciBfbmFtZSA9IF9yZWYyOC5vcDEsCiAgICAgICAgICAgIHRydXN0aW5nID0gX3JlZjI4Lm9wMiwKICAgICAgICAgICAgX25hbWVzcGFjZSA9IF9yZWYyOC5vcDM7CgogICAgICAgIHZhciBuYW1lID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZSk7CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIHZhciB2YWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpOwogICAgICAgIHZhciBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZXNwYWNlKSA6IG51bGw7CiAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IHZtLmVsZW1lbnRzKCkuc2V0RHluYW1pY0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgISF0cnVzdGluZywgbmFtZXNwYWNlKTsKICAgICAgICBpZiAoISgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHJlZmVyZW5jZSkpIHsKICAgICAgICAgICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZShyZWZlcmVuY2UsIGF0dHJpYnV0ZSkpOwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlID0gZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTYpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFVwZGF0ZUR5bmFtaWNBdHRyaWJ1dGVPcGNvZGUsIF9VcGRhdGluZ09wY29kZTYpOwoKICAgICAgICBmdW5jdGlvbiBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlKHJlZmVyZW5jZSwgYXR0cmlidXRlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMxMiA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfVXBkYXRpbmdPcGNvZGU2LmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXMxMi5yZWZlcmVuY2UgPSByZWZlcmVuY2U7CiAgICAgICAgICAgIF90aGlzMTIuYXR0cmlidXRlID0gYXR0cmlidXRlOwogICAgICAgICAgICBfdGhpczEyLnR5cGUgPSAncGF0Y2gtZWxlbWVudCc7CiAgICAgICAgICAgIF90aGlzMTIudGFnID0gcmVmZXJlbmNlLnRhZzsKICAgICAgICAgICAgX3RoaXMxMi5sYXN0UmV2aXNpb24gPSBfdGhpczEyLnRhZy52YWx1ZSgpOwogICAgICAgICAgICByZXR1cm4gX3RoaXMxMjsKICAgICAgICB9CgogICAgICAgIFVwZGF0ZUR5bmFtaWNBdHRyaWJ1dGVPcGNvZGUucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUodm0pIHsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgICAgICAgcmVmZXJlbmNlID0gdGhpcy5yZWZlcmVuY2UsCiAgICAgICAgICAgICAgICB0YWcgPSB0aGlzLnRhZzsKCiAgICAgICAgICAgIGlmICghdGFnLnZhbGlkYXRlKHRoaXMubGFzdFJldmlzaW9uKSkgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0UmV2aXNpb24gPSB0YWcudmFsdWUoKTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZS51cGRhdGUocmVmZXJlbmNlLnZhbHVlKCksIHZtLmVudik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZTsKICAgIH0oVXBkYXRpbmdPcGNvZGUpOwoKICAgIGZ1bmN0aW9uIHJlc29sdmVDb21wb25lbnQocmVzb2x2ZXIsIG5hbWUsIG1ldGEpIHsKICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHJlc29sdmVyLmxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgbWV0YSk7CgogICAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgfQoKICAgIHZhciBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZShpbm5lciwgcmVzb2x2ZXIsIG1ldGEsIGFyZ3MpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIHRoaXMucmVzb2x2ZXIgPSByZXNvbHZlcjsKICAgICAgICAgICAgdGhpcy5tZXRhID0gbWV0YTsKICAgICAgICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgICAgICAgdGhpcy50YWcgPSBpbm5lci50YWc7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5sYXN0RGVmaW5pdGlvbiA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgdmFyIGlubmVyID0gdGhpcy5pbm5lciwKICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHRoaXMubGFzdFZhbHVlOwoKICAgICAgICAgICAgdmFyIHZhbHVlID0gaW5uZXIudmFsdWUoKTsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBsYXN0VmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxhc3REZWZpbml0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzQ3VycmllZENvbXBvbmVudERlZmluaXRpb24odmFsdWUpKSB7CiAgICAgICAgICAgICAgICBkZWZpbml0aW9uID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHJlc29sdmVyID0gdGhpcy5yZXNvbHZlciwKICAgICAgICAgICAgICAgICAgICBtZXRhID0gdGhpcy5tZXRhOwoKICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSByZXNvbHZlQ29tcG9uZW50KHJlc29sdmVyLCB2YWx1ZSwgbWV0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmaW5pdGlvbiA9IHRoaXMuY3VycnkoZGVmaW5pdGlvbik7CiAgICAgICAgICAgIHRoaXMubGFzdFZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMubGFzdERlZmluaXRpb24gPSBkZWZpbml0aW9uOwogICAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbjsKICAgICAgICB9OwoKICAgICAgICBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgICB9OwoKICAgICAgICBDdXJyeUNvbXBvbmVudFJlZmVyZW5jZS5wcm90b3R5cGUuY3VycnkgPSBmdW5jdGlvbiBjdXJyeShkZWZpbml0aW9uKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gdGhpcy5hcmdzOwoKICAgICAgICAgICAgaWYgKCFhcmdzICYmIGlzQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFkZWZpbml0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oZGVmaW5pdGlvbiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ3VycnlDb21wb25lbnRSZWZlcmVuY2U7CiAgICB9KCk7CgogICAgdmFyIENsYXNzTGlzdFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDbGFzc0xpc3RSZWZlcmVuY2UobGlzdCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENsYXNzTGlzdFJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLmxpc3QgPSBsaXN0OwogICAgICAgICAgICB0aGlzLnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmVUYWdnZWQpKGxpc3QpOwogICAgICAgICAgICB0aGlzLmxpc3QgPSBsaXN0OwogICAgICAgIH0KCiAgICAgICAgQ2xhc3NMaXN0UmVmZXJlbmNlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgICAgIHZhciBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBub3JtYWxpemVTdHJpbmdWYWx1ZShsaXN0W2ldLnZhbHVlKCkpOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlKSByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0LmpvaW4oJyAnKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ2xhc3NMaXN0UmVmZXJlbmNlOwogICAgfSgpOwoKICAgIC8qKgogICAgICogQ29udmVydHMgYSBDb21wb25lbnRDYXBhYmlsaXRpZXMgb2JqZWN0IGludG8gYSAzMi1iaXQgaW50ZWdlciByZXByZXNlbnRhdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY2FwYWJpbGl0eUZsYWdzRnJvbShjYXBhYmlsaXRpZXMpIHsKICAgICAgICByZXR1cm4gMCB8IChjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCA/IDEgLyogRHluYW1pY0xheW91dCAqLyA6IDApIHwgKGNhcGFiaWxpdGllcy5keW5hbWljVGFnID8gMiAvKiBEeW5hbWljVGFnICovIDogMCkgfCAoY2FwYWJpbGl0aWVzLnByZXBhcmVBcmdzID8gNCAvKiBQcmVwYXJlQXJncyAqLyA6IDApIHwgKGNhcGFiaWxpdGllcy5jcmVhdGVBcmdzID8gOCAvKiBDcmVhdGVBcmdzICovIDogMCkgfCAoY2FwYWJpbGl0aWVzLmF0dHJpYnV0ZUhvb2sgPyAxNiAvKiBBdHRyaWJ1dGVIb29rICovIDogMCkgfCAoY2FwYWJpbGl0aWVzLmVsZW1lbnRIb29rID8gMzIgLyogRWxlbWVudEhvb2sgKi8gOiAwKSB8IChjYXBhYmlsaXRpZXMuZHluYW1pY1Njb3BlID8gNjQgLyogRHluYW1pY1Njb3BlICovIDogMCkgfCAoY2FwYWJpbGl0aWVzLmNyZWF0ZUNhbGxlciA/IDEyOCAvKiBDcmVhdGVDYWxsZXIgKi8gOiAwKSB8IChjYXBhYmlsaXRpZXMudXBkYXRlSG9vayA/IDI1NiAvKiBVcGRhdGVIb29rICovIDogMCkgfCAoY2FwYWJpbGl0aWVzLmNyZWF0ZUluc3RhbmNlID8gNTEyIC8qIENyZWF0ZUluc3RhbmNlICovIDogMCk7CiAgICB9CiAgICBmdW5jdGlvbiBoYXNDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgY2FwYWJpbGl0eSkgewogICAgICAgIHJldHVybiAhIShjYXBhYmlsaXRpZXMgJiBjYXBhYmlsaXR5KTsKICAgIH0KCiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNjkgLyogSXNDb21wb25lbnQgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHZhciByZWYgPSBzdGFjay5wb3AoKTsKICAgICAgICBzdGFjay5wdXNoKElzQ3VycmllZENvbXBvbmVudERlZmluaXRpb25SZWZlcmVuY2UuY3JlYXRlKHJlZikpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNzAgLyogQ29udGVudFR5cGUgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHZhciByZWYgPSBzdGFjay5wZWVrKCk7CiAgICAgICAgc3RhY2sucHVzaChuZXcgQ29udGVudFR5cGVSZWZlcmVuY2UocmVmKSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg3MSAvKiBDdXJyeUNvbXBvbmVudCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMjkpIHsKICAgICAgICB2YXIgX21ldGEgPSBfcmVmMjkub3AxOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHN0YWNrLnBvcCgpOwogICAgICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBzdGFjay5wb3AoKTsKICAgICAgICB2YXIgbWV0YSA9IHZtLmNvbnN0YW50cy5nZXRTZXJpYWxpemFibGUoX21ldGEpOwogICAgICAgIHZhciByZXNvbHZlciA9IHZtLmNvbnN0YW50cy5yZXNvbHZlcjsKICAgICAgICB2bS5sb2FkVmFsdWUoX3ZtMi5SZWdpc3Rlci52MCwgbmV3IEN1cnJ5Q29tcG9uZW50UmVmZXJlbmNlKGRlZmluaXRpb24sIHJlc29sdmVyLCBtZXRhLCBjYXB0dXJlZEFyZ3MpKTsKICAgICAgICAvLyBleHBlY3RTdGFja0NoYW5nZSh2bS5zdGFjaywgLWFyZ3MubGVuZ3RoIC0gMSwgJ0N1cnJ5Q29tcG9uZW50Jyk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg3MiAvKiBQdXNoQ29tcG9uZW50RGVmaW5pdGlvbiAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMzApIHsKICAgICAgICB2YXIgaGFuZGxlID0gX3JlZjMwLm9wMTsKCiAgICAgICAgdmFyIGRlZmluaXRpb24gPSB2bS5jb25zdGFudHMucmVzb2x2ZUhhbmRsZShoYW5kbGUpOwoKICAgICAgICB2YXIgbWFuYWdlciA9IGRlZmluaXRpb24ubWFuYWdlcjsKCiAgICAgICAgdmFyIGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoZGVmaW5pdGlvbi5zdGF0ZSkpOwogICAgICAgIHZhciBpbnN0YW5jZSA9IHsKICAgICAgICAgICAgZGVmaW5pdGlvbjogZGVmaW5pdGlvbiwKICAgICAgICAgICAgbWFuYWdlcjogbWFuYWdlciwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBjYXBhYmlsaXRpZXMsCiAgICAgICAgICAgIHN0YXRlOiBudWxsLAogICAgICAgICAgICBoYW5kbGU6IG51bGwsCiAgICAgICAgICAgIHRhYmxlOiBudWxsLAogICAgICAgICAgICBsb29rdXA6IG51bGwKICAgICAgICB9OwogICAgICAgIHZtLnN0YWNrLnB1c2goaW5zdGFuY2UpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNzUgLyogUmVzb2x2ZUR5bmFtaWNDb21wb25lbnQgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjMxKSB7CiAgICAgICAgdmFyIF9tZXRhID0gX3JlZjMxLm9wMTsKCiAgICAgICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHN0YWNrLnBvcCgpLnZhbHVlKCk7CiAgICAgICAgdmFyIG1ldGEgPSB2bS5jb25zdGFudHMuZ2V0U2VyaWFsaXphYmxlKF9tZXRhKTsKICAgICAgICB2bS5sb2FkVmFsdWUoX3ZtMi5SZWdpc3Rlci50MSwgbnVsbCk7IC8vIENsZWFyIHRoZSB0ZW1wIHJlZ2lzdGVyCiAgICAgICAgdmFyIGRlZmluaXRpb24gPSB2b2lkIDA7CiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlciA9IHZtLmNvbnN0YW50cy5yZXNvbHZlcjsKCiAgICAgICAgICAgIHZhciByZXNvbHZlZERlZmluaXRpb24gPSByZXNvbHZlQ29tcG9uZW50KHJlc29sdmVyLCBjb21wb25lbnQsIG1ldGEpOwogICAgICAgICAgICBkZWZpbml0aW9uID0gcmVzb2x2ZWREZWZpbml0aW9uOwogICAgICAgIH0gZWxzZSBpZiAoaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihjb21wb25lbnQpKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSBjb21wb25lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgIH0KICAgICAgICBzdGFjay5wdXNoKGRlZmluaXRpb24pOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNzMgLyogUHVzaER5bmFtaWNDb21wb25lbnRJbnN0YW5jZSAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CgogICAgICAgIHZhciBkZWZpbml0aW9uID0gc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIGNhcGFiaWxpdGllcyA9IHZvaWQgMCwKICAgICAgICAgICAgbWFuYWdlciA9IHZvaWQgMDsKICAgICAgICBpZiAoaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbihkZWZpbml0aW9uKSkgewogICAgICAgICAgICBtYW5hZ2VyID0gY2FwYWJpbGl0aWVzID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyOwogICAgICAgICAgICBjYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXR5RmxhZ3NGcm9tKG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKGRlZmluaXRpb24uc3RhdGUpKTsKICAgICAgICB9CiAgICAgICAgc3RhY2sucHVzaCh7IGRlZmluaXRpb246IGRlZmluaXRpb24sIGNhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzLCBtYW5hZ2VyOiBtYW5hZ2VyLCBzdGF0ZTogbnVsbCwgaGFuZGxlOiBudWxsLCB0YWJsZTogbnVsbCB9KTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDc0IC8qIFB1c2hDdXJyaWVkQ29tcG9uZW50ICovLCBmdW5jdGlvbiAodm0sIF9yZWYzMikgewogICAgICAgIHZhciBfbWV0YSA9IF9yZWYzMi5vcDE7CgogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHZhciBjb21wb25lbnQgPSBzdGFjay5wb3AoKS52YWx1ZSgpOwogICAgICAgIHZhciBkZWZpbml0aW9uID0gdm9pZCAwOwogICAgICAgIGlmIChpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGNvbXBvbmVudCkpIHsKICAgICAgICAgICAgZGVmaW5pdGlvbiA9IGNvbXBvbmVudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyAoMCwgX3V0aWwudW5yZWFjaGFibGUpKCk7CiAgICAgICAgfQogICAgICAgIHN0YWNrLnB1c2goZGVmaW5pdGlvbik7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg3NiAvKiBQdXNoQXJncyAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMzMpIHsKICAgICAgICB2YXIgX25hbWVzID0gX3JlZjMzLm9wMSwKICAgICAgICAgICAgZmxhZ3MgPSBfcmVmMzMub3AyOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgbmFtZXMgPSB2bS5jb25zdGFudHMuZ2V0U3RyaW5nQXJyYXkoX25hbWVzKTsKICAgICAgICB2YXIgcG9zaXRpb25hbENvdW50ID0gZmxhZ3MgPj4gNDsKICAgICAgICB2YXIgc3ludGhldGljID0gZmxhZ3MgJiA4OwogICAgICAgIHZhciBibG9ja05hbWVzID0gW107CiAgICAgICAgaWYgKGZsYWdzICYgNCkgYmxvY2tOYW1lcy5wdXNoKCdtYWluJyk7CiAgICAgICAgaWYgKGZsYWdzICYgMikgYmxvY2tOYW1lcy5wdXNoKCdlbHNlJyk7CiAgICAgICAgaWYgKGZsYWdzICYgMSkgYmxvY2tOYW1lcy5wdXNoKCdhdHRycycpOwogICAgICAgIHZtLmFyZ3Muc2V0dXAoc3RhY2ssIG5hbWVzLCBibG9ja05hbWVzLCBwb3NpdGlvbmFsQ291bnQsICEhc3ludGhldGljKTsKICAgICAgICBzdGFjay5wdXNoKHZtLmFyZ3MpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNzcgLyogUHVzaEVtcHR5QXJncyAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CgogICAgICAgIHN0YWNrLnB1c2godm0uYXJncy5lbXB0eShzdGFjaykpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoODAgLyogQ2FwdHVyZUFyZ3MgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZhciBzdGFjayA9IHZtLnN0YWNrOwogICAgICAgIHZhciBhcmdzID0gc3RhY2sucG9wKCk7CiAgICAgICAgdmFyIGNhcHR1cmVkQXJncyA9IGFyZ3MuY2FwdHVyZSgpOwogICAgICAgIHN0YWNrLnB1c2goY2FwdHVyZWRBcmdzKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDc5IC8qIFByZXBhcmVBcmdzICovLCBmdW5jdGlvbiAodm0sIF9yZWYzNCkgewogICAgICAgIHZhciBfc3RhdGUgPSBfcmVmMzQub3AxOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgaW5zdGFuY2UgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICAgICAgdmFyIGFyZ3MgPSBzdGFjay5wb3AoKTsKICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IGluc3RhbmNlLmRlZmluaXRpb247CgogICAgICAgIGlmIChpc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGRlZmluaXRpb24pKSB7CgogICAgICAgICAgICBkZWZpbml0aW9uID0gcmVzb2x2ZUN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uKGluc3RhbmNlLCBkZWZpbml0aW9uLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgdmFyIF9kZWZpbml0aW9uMiA9IGRlZmluaXRpb24sCiAgICAgICAgICAgIG1hbmFnZXIgPSBfZGVmaW5pdGlvbjIubWFuYWdlciwKICAgICAgICAgICAgc3RhdGUgPSBfZGVmaW5pdGlvbjIuc3RhdGU7CgogICAgICAgIHZhciBjYXBhYmlsaXRpZXMgPSBpbnN0YW5jZS5jYXBhYmlsaXRpZXM7CiAgICAgICAgaWYgKGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCA0IC8qIFByZXBhcmVBcmdzICovKSAhPT0gdHJ1ZSkgewogICAgICAgICAgICBzdGFjay5wdXNoKGFyZ3MpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBibG9ja3MgPSBhcmdzLmJsb2Nrcy52YWx1ZXM7CiAgICAgICAgdmFyIGJsb2NrTmFtZXMgPSBhcmdzLmJsb2Nrcy5uYW1lczsKICAgICAgICB2YXIgcHJlcGFyZWRBcmdzID0gbWFuYWdlci5wcmVwYXJlQXJncyhzdGF0ZSwgYXJncyk7CiAgICAgICAgaWYgKHByZXBhcmVkQXJncykgewogICAgICAgICAgICBhcmdzLmNsZWFyKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGJsb2Nrc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSBwcmVwYXJlZEFyZ3MucG9zaXRpb25hbCwKICAgICAgICAgICAgICAgIG5hbWVkID0gcHJlcGFyZWRBcmdzLm5hbWVkOwoKICAgICAgICAgICAgdmFyIHBvc2l0aW9uYWxDb3VudCA9IHBvc2l0aW9uYWwubGVuZ3RoOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgcG9zaXRpb25hbENvdW50OyBfaSsrKSB7CiAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHBvc2l0aW9uYWxbX2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZXMgPSBPYmplY3Qua2V5cyhuYW1lZCk7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG5hbWVzLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobmFtZWRbbmFtZXNbX2kyXV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFyZ3Muc2V0dXAoc3RhY2ssIG5hbWVzLCBibG9ja05hbWVzLCBwb3NpdGlvbmFsQ291bnQsIHRydWUpOwogICAgICAgIH0KICAgICAgICBzdGFjay5wdXNoKGFyZ3MpOwogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VycmllZENvbXBvbmVudERlZmluaXRpb24oaW5zdGFuY2UsIGRlZmluaXRpb24sIGFyZ3MpIHsKICAgICAgICB2YXIgdW53cmFwcGVkRGVmaW5pdGlvbiA9IGluc3RhbmNlLmRlZmluaXRpb24gPSBkZWZpbml0aW9uLnVud3JhcChhcmdzKTsKICAgICAgICB2YXIgbWFuYWdlciA9IHVud3JhcHBlZERlZmluaXRpb24ubWFuYWdlciwKICAgICAgICAgICAgc3RhdGUgPSB1bndyYXBwZWREZWZpbml0aW9uLnN0YXRlOwoKCiAgICAgICAgaW5zdGFuY2UubWFuYWdlciA9IG1hbmFnZXI7CiAgICAgICAgaW5zdGFuY2UuY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhzdGF0ZSkpOwogICAgICAgIHJldHVybiB1bndyYXBwZWREZWZpbml0aW9uOwogICAgfQogICAgQVBQRU5EX09QQ09ERVMuYWRkKDgxIC8qIENyZWF0ZUNvbXBvbmVudCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMzUpIHsKICAgICAgICB2YXIgZmxhZ3MgPSBfcmVmMzUub3AxLAogICAgICAgICAgICBfc3RhdGUgPSBfcmVmMzUub3AyOwoKICAgICAgICB2YXIgaW5zdGFuY2UgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICAgICAgdmFyIGRlZmluaXRpb24gPSBpbnN0YW5jZS5kZWZpbml0aW9uLAogICAgICAgICAgICBtYW5hZ2VyID0gaW5zdGFuY2UubWFuYWdlcjsKCiAgICAgICAgdmFyIGNhcGFiaWxpdGllcyA9IGluc3RhbmNlLmNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoZGVmaW5pdGlvbi5zdGF0ZSkpOwogICAgICAgIHZhciBkeW5hbWljU2NvcGUgPSBudWxsOwogICAgICAgIGlmIChoYXNDYXBhYmlsaXR5KGNhcGFiaWxpdGllcywgNjQgLyogRHluYW1pY1Njb3BlICovKSkgewogICAgICAgICAgICBkeW5hbWljU2NvcGUgPSB2bS5keW5hbWljU2NvcGUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0RlZmF1bHRCbG9jayA9IGZsYWdzICYgMTsKICAgICAgICB2YXIgYXJncyA9IG51bGw7CiAgICAgICAgaWYgKGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCA4IC8qIENyZWF0ZUFyZ3MgKi8pKSB7CiAgICAgICAgICAgIGFyZ3MgPSB2bS5zdGFjay5wZWVrKCk7CiAgICAgICAgfQogICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICBpZiAoaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDEyOCAvKiBDcmVhdGVDYWxsZXIgKi8pKSB7CiAgICAgICAgICAgIHNlbGYgPSB2bS5nZXRTZWxmKCk7CiAgICAgICAgfQogICAgICAgIHZhciBzdGF0ZSA9IG1hbmFnZXIuY3JlYXRlKHZtLmVudiwgZGVmaW5pdGlvbi5zdGF0ZSwgYXJncywgZHluYW1pY1Njb3BlLCBzZWxmLCAhIWhhc0RlZmF1bHRCbG9jayk7CiAgICAgICAgLy8gV2Ugd2FudCB0byByZXVzZSB0aGUgYHN0YXRlYCBQT0pPIGhlcmUsIGJlY2F1c2Ugd2Uga25vdyB0aGF0IHRoZSBvcGNvZGVzCiAgICAgICAgLy8gb25seSB0cmFuc2l0aW9uIGF0IGV4YWN0bHkgb25lIHBsYWNlLgogICAgICAgIGluc3RhbmNlLnN0YXRlID0gc3RhdGU7CiAgICAgICAgdmFyIHRhZyA9IG1hbmFnZXIuZ2V0VGFnKHN0YXRlKTsKICAgICAgICBpZiAoaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDI1NiAvKiBVcGRhdGVIb29rICovKSAmJiAhKDAsIF9yZWZlcmVuY2UuaXNDb25zdFRhZykodGFnKSkgewogICAgICAgICAgICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVDb21wb25lbnRPcGNvZGUodGFnLCBzdGF0ZSwgbWFuYWdlciwgZHluYW1pY1Njb3BlKSk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoODIgLyogUmVnaXN0ZXJDb21wb25lbnREZXN0cnVjdG9yICovLCBmdW5jdGlvbiAodm0sIF9yZWYzNikgewogICAgICAgIHZhciBfc3RhdGUgPSBfcmVmMzYub3AxOwoKICAgICAgICB2YXIgX3ZtJGZldGNoVmFsdWUgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSksCiAgICAgICAgICAgIG1hbmFnZXIgPSBfdm0kZmV0Y2hWYWx1ZS5tYW5hZ2VyLAogICAgICAgICAgICBzdGF0ZSA9IF92bSRmZXRjaFZhbHVlLnN0YXRlOwoKICAgICAgICB2YXIgZGVzdHJ1Y3RvciA9IG1hbmFnZXIuZ2V0RGVzdHJ1Y3RvcihzdGF0ZSk7CiAgICAgICAgaWYgKGRlc3RydWN0b3IpIHZtLm5ld0Rlc3Ryb3lhYmxlKGRlc3RydWN0b3IpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoOTEgLyogQmVnaW5Db21wb25lbnRUcmFuc2FjdGlvbiAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdm0uYmVnaW5DYWNoZUdyb3VwKCk7CiAgICAgICAgdm0uZWxlbWVudHMoKS5wdXNoU2ltcGxlQmxvY2soKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDgzIC8qIFB1dENvbXBvbmVudE9wZXJhdGlvbnMgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZtLmxvYWRWYWx1ZShfdm0yLlJlZ2lzdGVyLnQwLCBuZXcgQ29tcG9uZW50RWxlbWVudE9wZXJhdGlvbnMoKSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgzNyAvKiBDb21wb25lbnRBdHRyICovLCBmdW5jdGlvbiAodm0sIF9yZWYzNykgewogICAgICAgIHZhciBfbmFtZSA9IF9yZWYzNy5vcDEsCiAgICAgICAgICAgIHRydXN0aW5nID0gX3JlZjM3Lm9wMiwKICAgICAgICAgICAgX25hbWVzcGFjZSA9IF9yZWYzNy5vcDM7CgogICAgICAgIHZhciBuYW1lID0gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZSk7CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIHZhciBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm0uY29uc3RhbnRzLmdldFN0cmluZyhfbmFtZXNwYWNlKSA6IG51bGw7CiAgICAgICAgdm0uZmV0Y2hWYWx1ZShfdm0yLlJlZ2lzdGVyLnQwKS5zZXRBdHRyaWJ1dGUobmFtZSwgcmVmZXJlbmNlLCAhIXRydXN0aW5nLCBuYW1lc3BhY2UpOwogICAgfSk7CgogICAgdmFyIENvbXBvbmVudEVsZW1lbnRPcGVyYXRpb25zID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudEVsZW1lbnRPcGVyYXRpb25zKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbXBvbmVudEVsZW1lbnRPcGVyYXRpb25zKTsKCiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlcyA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICB0aGlzLmNsYXNzZXMgPSBbXTsKICAgICAgICB9CgogICAgICAgIENvbXBvbmVudEVsZW1lbnRPcGVyYXRpb25zLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHRydXN0aW5nLCBuYW1lc3BhY2UpIHsKICAgICAgICAgICAgdmFyIGRlZmVycmVkID0geyB2YWx1ZTogdmFsdWUsIG5hbWVzcGFjZTogbmFtZXNwYWNlLCB0cnVzdGluZzogdHJ1c3RpbmcgfTsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xhc3Nlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0gPSBkZWZlcnJlZDsKICAgICAgICB9OwoKICAgICAgICBDb21wb25lbnRFbGVtZW50T3BlcmF0aW9ucy5wcm90b3R5cGUuZmx1c2ggPSBmdW5jdGlvbiBmbHVzaCh2bSkgewogICAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRoaXMuYXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgdmFyIGF0dHIgPSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlID0gYXR0ci52YWx1ZSwKICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBhdHRyLm5hbWVzcGFjZSwKICAgICAgICAgICAgICAgICAgICB0cnVzdGluZyA9IGF0dHIudHJ1c3Rpbmc7CgogICAgICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjbGFzcycpIHsKICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2UgPSBuZXcgQ2xhc3NMaXN0UmVmZXJlbmNlKHRoaXMuY2xhc3Nlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3R5cGUnKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlID0gdm0uZWxlbWVudHMoKS5zZXREeW5hbWljQXR0cmlidXRlKG5hbWUsIHJlZmVyZW5jZS52YWx1ZSgpLCB0cnVzdGluZywgbmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIGlmICghKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICAgICAgICAgICAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IFVwZGF0ZUR5bmFtaWNBdHRyaWJ1dGVPcGNvZGUocmVmZXJlbmNlLCBhdHRyaWJ1dGUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJ3R5cGUnIGluIHRoaXMuYXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSB0aGlzLmF0dHJpYnV0ZXMudHlwZTsKICAgICAgICAgICAgICAgIHZhciByZWZlcmVuY2UgPSB0eXBlLnZhbHVlLAogICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHR5cGUubmFtZXNwYWNlLAogICAgICAgICAgICAgICAgICAgIHRydXN0aW5nID0gdHlwZS50cnVzdGluZzsKCiAgICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZSA9IHZtLmVsZW1lbnRzKCkuc2V0RHluYW1pY0F0dHJpYnV0ZSgndHlwZScsIHJlZmVyZW5jZS52YWx1ZSgpLCB0cnVzdGluZywgbmFtZXNwYWNlKTsKICAgICAgICAgICAgICAgIGlmICghKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkocmVmZXJlbmNlKSkgewogICAgICAgICAgICAgICAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IFVwZGF0ZUR5bmFtaWNBdHRyaWJ1dGVPcGNvZGUocmVmZXJlbmNlLCBfYXR0cmlidXRlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ29tcG9uZW50RWxlbWVudE9wZXJhdGlvbnM7CiAgICB9KCk7CgogICAgQVBQRU5EX09QQ09ERVMuYWRkKDkzIC8qIERpZENyZWF0ZUVsZW1lbnQgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjM4KSB7CiAgICAgICAgdmFyIF9zdGF0ZSA9IF9yZWYzOC5vcDE7CgogICAgICAgIHZhciBfdm0kZmV0Y2hWYWx1ZTIgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSksCiAgICAgICAgICAgIGRlZmluaXRpb24gPSBfdm0kZmV0Y2hWYWx1ZTIuZGVmaW5pdGlvbiwKICAgICAgICAgICAgc3RhdGUgPSBfdm0kZmV0Y2hWYWx1ZTIuc3RhdGU7CgogICAgICAgIHZhciBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyOwoKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHZtLmZldGNoVmFsdWUoX3ZtMi5SZWdpc3Rlci50MCk7CiAgICAgICAgdmFyIGFjdGlvbiA9ICdEaWRDcmVhdGVFbGVtZW50T3Bjb2RlI2V2YWx1YXRlJzsKICAgICAgICBtYW5hZ2VyLmRpZENyZWF0ZUVsZW1lbnQoc3RhdGUsIHZtLmVsZW1lbnRzKCkuZXhwZWN0Q29uc3RydWN0aW5nKGFjdGlvbiksIG9wZXJhdGlvbnMpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoODQgLyogR2V0Q29tcG9uZW50U2VsZiAqLywgZnVuY3Rpb24gKHZtLCBfcmVmMzkpIHsKICAgICAgICB2YXIgX3N0YXRlID0gX3JlZjM5Lm9wMTsKCiAgICAgICAgdmFyIF92bSRmZXRjaFZhbHVlMyA9IHZtLmZldGNoVmFsdWUoX3N0YXRlKSwKICAgICAgICAgICAgZGVmaW5pdGlvbiA9IF92bSRmZXRjaFZhbHVlMy5kZWZpbml0aW9uLAogICAgICAgICAgICBzdGF0ZSA9IF92bSRmZXRjaFZhbHVlMy5zdGF0ZTsKCiAgICAgICAgdmFyIG1hbmFnZXIgPSBkZWZpbml0aW9uLm1hbmFnZXI7CgogICAgICAgIHZtLnN0YWNrLnB1c2gobWFuYWdlci5nZXRTZWxmKHN0YXRlKSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg4NSAvKiBHZXRDb21wb25lbnRUYWdOYW1lICovLCBmdW5jdGlvbiAodm0sIF9yZWY0MCkgewogICAgICAgIHZhciBfc3RhdGUgPSBfcmVmNDAub3AxOwoKICAgICAgICB2YXIgX3ZtJGZldGNoVmFsdWU0ID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpLAogICAgICAgICAgICBkZWZpbml0aW9uID0gX3ZtJGZldGNoVmFsdWU0LmRlZmluaXRpb24sCiAgICAgICAgICAgIHN0YXRlID0gX3ZtJGZldGNoVmFsdWU0LnN0YXRlOwoKICAgICAgICB2YXIgbWFuYWdlciA9IGRlZmluaXRpb24ubWFuYWdlcjsKCiAgICAgICAgdm0uc3RhY2sucHVzaChtYW5hZ2VyLmdldFRhZ05hbWUoc3RhdGUpKTsKICAgIH0pOwogICAgLy8gRHluYW1pYyBJbnZvY2F0aW9uIE9ubHkKICAgIEFQUEVORF9PUENPREVTLmFkZCg4NiAvKiBHZXRDb21wb25lbnRMYXlvdXQgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjQxKSB7CiAgICAgICAgdmFyIF9zdGF0ZSA9IF9yZWY0MS5vcDE7CgogICAgICAgIHZhciBpbnN0YW5jZSA9IHZtLmZldGNoVmFsdWUoX3N0YXRlKTsKICAgICAgICB2YXIgbWFuYWdlciA9IGluc3RhbmNlLm1hbmFnZXIsCiAgICAgICAgICAgIGRlZmluaXRpb24gPSBpbnN0YW5jZS5kZWZpbml0aW9uOwogICAgICAgIHZhciByZXNvbHZlciA9IHZtLmNvbnN0YW50cy5yZXNvbHZlciwKICAgICAgICAgICAgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgaW5zdGFuY2VTdGF0ZSA9IGluc3RhbmNlLnN0YXRlLAogICAgICAgICAgICBjYXBhYmlsaXRpZXMgPSBpbnN0YW5jZS5jYXBhYmlsaXRpZXM7CiAgICAgICAgdmFyIGRlZmluaXRpb25TdGF0ZSA9IGRlZmluaXRpb24uc3RhdGU7CgogICAgICAgIHZhciBpbnZva2UgPSB2b2lkIDA7CiAgICAgICAgaWYgKGhhc1N0YXRpY0xheW91dChjYXBhYmlsaXRpZXMsIG1hbmFnZXIpKSB7CiAgICAgICAgICAgIGludm9rZSA9IG1hbmFnZXIuZ2V0TGF5b3V0KGRlZmluaXRpb25TdGF0ZSwgcmVzb2x2ZXIpOwogICAgICAgIH0gZWxzZSBpZiAoaGFzRHluYW1pY0xheW91dChjYXBhYmlsaXRpZXMsIG1hbmFnZXIpKSB7CiAgICAgICAgICAgIGludm9rZSA9IG1hbmFnZXIuZ2V0RHluYW1pY0xheW91dChpbnN0YW5jZVN0YXRlLCByZXNvbHZlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgIH0KICAgICAgICBzdGFjay5wdXNoKGludm9rZS5zeW1ib2xUYWJsZSk7CiAgICAgICAgc3RhY2sucHVzaChpbnZva2UuaGFuZGxlKTsKICAgIH0pOwogICAgZnVuY3Rpb24gaGFzU3RhdGljTGF5b3V0KGNhcGFiaWxpdGllcywgX21hbmFnZXIpIHsKICAgICAgICByZXR1cm4gaGFzQ2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIDEgLyogRHluYW1pY0xheW91dCAqLykgPT09IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gaGFzRHluYW1pY0xheW91dChjYXBhYmlsaXRpZXMsIF9tYW5hZ2VyKSB7CiAgICAgICAgcmV0dXJuIGhhc0NhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCAxIC8qIER5bmFtaWNMYXlvdXQgKi8pID09PSB0cnVlOwogICAgfQogICAgQVBQRU5EX09QQ09ERVMuYWRkKDY4IC8qIE1haW4gKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjQyKSB7CiAgICAgICAgdmFyIHJlZ2lzdGVyID0gX3JlZjQyLm9wMTsKCiAgICAgICAgdmFyIGRlZmluaXRpb24gPSB2bS5zdGFjay5wb3AoKTsKICAgICAgICB2YXIgaW52b2NhdGlvbiA9IHZtLnN0YWNrLnBvcCgpOwogICAgICAgIHZhciBtYW5hZ2VyID0gZGVmaW5pdGlvbi5tYW5hZ2VyOwoKICAgICAgICB2YXIgY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhkZWZpbml0aW9uLnN0YXRlKSk7CiAgICAgICAgdmFyIHN0YXRlID0gewogICAgICAgICAgICBkZWZpbml0aW9uOiBkZWZpbml0aW9uLAogICAgICAgICAgICBtYW5hZ2VyOiBtYW5hZ2VyLAogICAgICAgICAgICBjYXBhYmlsaXRpZXM6IGNhcGFiaWxpdGllcywKICAgICAgICAgICAgc3RhdGU6IG51bGwsCiAgICAgICAgICAgIGhhbmRsZTogaW52b2NhdGlvbi5oYW5kbGUsCiAgICAgICAgICAgIHRhYmxlOiBpbnZvY2F0aW9uLnN5bWJvbFRhYmxlLAogICAgICAgICAgICBsb29rdXA6IG51bGwKICAgICAgICB9OwogICAgICAgIHZtLmxvYWRWYWx1ZShyZWdpc3Rlciwgc3RhdGUpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoODkgLyogUG9wdWxhdGVMYXlvdXQgKi8sIGZ1bmN0aW9uICh2bSwgX3JlZjQzKSB7CiAgICAgICAgdmFyIF9zdGF0ZSA9IF9yZWY0My5vcDE7CiAgICAgICAgdmFyIHN0YWNrID0gdm0uc3RhY2s7CgogICAgICAgIHZhciBoYW5kbGUgPSBzdGFjay5wb3AoKTsKICAgICAgICB2YXIgdGFibGUgPSBzdGFjay5wb3AoKTsKICAgICAgICB2YXIgc3RhdGUgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CiAgICAgICAgc3RhdGUuaGFuZGxlID0gaGFuZGxlOwogICAgICAgIHN0YXRlLnRhYmxlID0gdGFibGU7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCgyMSAvKiBWaXJ0dWFsUm9vdFNjb3BlICovLCBmdW5jdGlvbiAodm0sIF9yZWY0NCkgewogICAgICAgIHZhciBfc3RhdGUgPSBfcmVmNDQub3AxOwogICAgICAgIHZhciBzeW1ib2xzID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpLnRhYmxlLnN5bWJvbHM7CgogICAgICAgIHZtLnB1c2hSb290U2NvcGUoc3ltYm9scy5sZW5ndGggKyAxLCB0cnVlKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDg3IC8qIFNldHVwRm9yRXZhbCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNDUpIHsKICAgICAgICB2YXIgX3N0YXRlID0gX3JlZjQ1Lm9wMTsKCiAgICAgICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgICAgIGlmIChzdGF0ZS50YWJsZS5oYXNFdmFsKSB7CiAgICAgICAgICAgIHZhciBsb29rdXAgPSBzdGF0ZS5sb29rdXAgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgICAgICAgdm0uc2NvcGUoKS5iaW5kRXZhbFNjb3BlKGxvb2t1cCk7CiAgICAgICAgfQogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoMiAvKiBTZXROYW1lZFZhcmlhYmxlcyAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNDYpIHsKICAgICAgICB2YXIgX3N0YXRlID0gX3JlZjQ2Lm9wMTsKCiAgICAgICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgICAgIHZhciBzY29wZSA9IHZtLnNjb3BlKCk7CiAgICAgICAgdmFyIGFyZ3MgPSB2bS5zdGFjay5wZWVrKCk7CiAgICAgICAgdmFyIGNhbGxlck5hbWVzID0gYXJncy5uYW1lZC5hdE5hbWVzOwogICAgICAgIGZvciAodmFyIGkgPSBjYWxsZXJOYW1lcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICB2YXIgYXROYW1lID0gY2FsbGVyTmFtZXNbaV07CiAgICAgICAgICAgIHZhciBzeW1ib2wgPSBzdGF0ZS50YWJsZS5zeW1ib2xzLmluZGV4T2YoY2FsbGVyTmFtZXNbaV0pOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBhcmdzLm5hbWVkLmdldChhdE5hbWUsIGZhbHNlKTsKICAgICAgICAgICAgaWYgKHN5bWJvbCAhPT0gLTEpIHNjb3BlLmJpbmRTeW1ib2woc3ltYm9sICsgMSwgdmFsdWUpOwogICAgICAgICAgICBpZiAoc3RhdGUubG9va3VwKSBzdGF0ZS5sb29rdXBbYXROYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gYmluZEJsb2NrKHN5bWJvbE5hbWUsIGJsb2NrTmFtZSwgc3RhdGUsIGJsb2Nrcywgdm0pIHsKICAgICAgICB2YXIgc3ltYm9sID0gc3RhdGUudGFibGUuc3ltYm9scy5pbmRleE9mKHN5bWJvbE5hbWUpOwogICAgICAgIHZhciBibG9jayA9IGJsb2Nrcy5nZXQoYmxvY2tOYW1lKTsKICAgICAgICBpZiAoc3ltYm9sICE9PSAtMSkgewogICAgICAgICAgICB2bS5zY29wZSgpLmJpbmRCbG9jayhzeW1ib2wgKyAxLCBibG9jayk7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5sb29rdXApIHN0YXRlLmxvb2t1cFtzeW1ib2xOYW1lXSA9IGJsb2NrOwogICAgfQogICAgQVBQRU5EX09QQ09ERVMuYWRkKDMgLyogU2V0QmxvY2tzICovLCBmdW5jdGlvbiAodm0sIF9yZWY0NykgewogICAgICAgIHZhciBfc3RhdGUgPSBfcmVmNDcub3AxOwoKICAgICAgICB2YXIgc3RhdGUgPSB2bS5mZXRjaFZhbHVlKF9zdGF0ZSk7CgogICAgICAgIHZhciBfdm0kc3RhY2skcGVlayA9IHZtLnN0YWNrLnBlZWsoKSwKICAgICAgICAgICAgYmxvY2tzID0gX3ZtJHN0YWNrJHBlZWsuYmxvY2tzOwoKICAgICAgICBiaW5kQmxvY2soJyZhdHRycycsICdhdHRycycsIHN0YXRlLCBibG9ja3MsIHZtKTsKICAgICAgICBiaW5kQmxvY2soJyZpbnZlcnNlJywgJ2Vsc2UnLCBzdGF0ZSwgYmxvY2tzLCB2bSk7CiAgICAgICAgYmluZEJsb2NrKCcmZGVmYXVsdCcsICdtYWluJywgc3RhdGUsIGJsb2Nrcywgdm0pOwogICAgfSk7CiAgICAvLyBEeW5hbWljIEludm9jYXRpb24gT25seQogICAgQVBQRU5EX09QQ09ERVMuYWRkKDkwIC8qIEludm9rZUNvbXBvbmVudExheW91dCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNDgpIHsKICAgICAgICB2YXIgX3N0YXRlID0gX3JlZjQ4Lm9wMTsKCiAgICAgICAgdmFyIHN0YXRlID0gdm0uZmV0Y2hWYWx1ZShfc3RhdGUpOwogICAgICAgIHZtLmNhbGwoc3RhdGUuaGFuZGxlKTsKICAgIH0pOwogICAgQVBQRU5EX09QQ09ERVMuYWRkKDk0IC8qIERpZFJlbmRlckxheW91dCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNDkpIHsKICAgICAgICB2YXIgX3N0YXRlID0gX3JlZjQ5Lm9wMTsKCiAgICAgICAgdmFyIF92bSRmZXRjaFZhbHVlNSA9IHZtLmZldGNoVmFsdWUoX3N0YXRlKSwKICAgICAgICAgICAgbWFuYWdlciA9IF92bSRmZXRjaFZhbHVlNS5tYW5hZ2VyLAogICAgICAgICAgICBzdGF0ZSA9IF92bSRmZXRjaFZhbHVlNS5zdGF0ZTsKCiAgICAgICAgdmFyIGJvdW5kcyA9IHZtLmVsZW1lbnRzKCkucG9wQmxvY2soKTsKICAgICAgICB2YXIgbWdyID0gbWFuYWdlcjsKICAgICAgICBtZ3IuZGlkUmVuZGVyTGF5b3V0KHN0YXRlLCBib3VuZHMpOwogICAgICAgIHZtLmVudi5kaWRDcmVhdGUoc3RhdGUsIG1hbmFnZXIpOwogICAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IERpZFVwZGF0ZUxheW91dE9wY29kZShtYW5hZ2VyLCBzdGF0ZSwgYm91bmRzKSk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg5MiAvKiBDb21taXRDb21wb25lbnRUcmFuc2FjdGlvbiAqLywgZnVuY3Rpb24gKHZtKSB7CiAgICAgICAgdm0uY29tbWl0Q2FjaGVHcm91cCgpOwogICAgfSk7CgogICAgdmFyIFVwZGF0ZUNvbXBvbmVudE9wY29kZSA9IGZ1bmN0aW9uIChfVXBkYXRpbmdPcGNvZGU3KSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShVcGRhdGVDb21wb25lbnRPcGNvZGUsIF9VcGRhdGluZ09wY29kZTcpOwoKICAgICAgICBmdW5jdGlvbiBVcGRhdGVDb21wb25lbnRPcGNvZGUodGFnLCBjb21wb25lbnQsIG1hbmFnZXIsIGR5bmFtaWNTY29wZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFVwZGF0ZUNvbXBvbmVudE9wY29kZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMxMyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfVXBkYXRpbmdPcGNvZGU3LmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXMxMy50YWcgPSB0YWc7CiAgICAgICAgICAgIF90aGlzMTMuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgICAgICAgICBfdGhpczEzLm1hbmFnZXIgPSBtYW5hZ2VyOwogICAgICAgICAgICBfdGhpczEzLmR5bmFtaWNTY29wZSA9IGR5bmFtaWNTY29wZTsKICAgICAgICAgICAgX3RoaXMxMy50eXBlID0gJ3VwZGF0ZS1jb21wb25lbnQnOwogICAgICAgICAgICByZXR1cm4gX3RoaXMxMzsKICAgICAgICB9CgogICAgICAgIFVwZGF0ZUNvbXBvbmVudE9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZShfdm0pIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50LAogICAgICAgICAgICAgICAgbWFuYWdlciA9IHRoaXMubWFuYWdlciwKICAgICAgICAgICAgICAgIGR5bmFtaWNTY29wZSA9IHRoaXMuZHluYW1pY1Njb3BlOwoKICAgICAgICAgICAgbWFuYWdlci51cGRhdGUoY29tcG9uZW50LCBkeW5hbWljU2NvcGUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBVcGRhdGVDb21wb25lbnRPcGNvZGU7CiAgICB9KFVwZGF0aW5nT3Bjb2RlKTsKCiAgICB2YXIgRGlkVXBkYXRlTGF5b3V0T3Bjb2RlID0gZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTgpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKERpZFVwZGF0ZUxheW91dE9wY29kZSwgX1VwZGF0aW5nT3Bjb2RlOCk7CgogICAgICAgIGZ1bmN0aW9uIERpZFVwZGF0ZUxheW91dE9wY29kZShtYW5hZ2VyLCBjb21wb25lbnQsIGJvdW5kcykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERpZFVwZGF0ZUxheW91dE9wY29kZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMxNCA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfVXBkYXRpbmdPcGNvZGU4LmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXMxNC5tYW5hZ2VyID0gbWFuYWdlcjsKICAgICAgICAgICAgX3RoaXMxNC5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgICAgICAgIF90aGlzMTQuYm91bmRzID0gYm91bmRzOwogICAgICAgICAgICBfdGhpczE0LnR5cGUgPSAnZGlkLXVwZGF0ZS1sYXlvdXQnOwogICAgICAgICAgICBfdGhpczE0LnRhZyA9IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICByZXR1cm4gX3RoaXMxNDsKICAgICAgICB9CgogICAgICAgIERpZFVwZGF0ZUxheW91dE9wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSkgewogICAgICAgICAgICB2YXIgbWFuYWdlciA9IHRoaXMubWFuYWdlciwKICAgICAgICAgICAgICAgIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50LAogICAgICAgICAgICAgICAgYm91bmRzID0gdGhpcy5ib3VuZHM7CgogICAgICAgICAgICBtYW5hZ2VyLmRpZFVwZGF0ZUxheW91dChjb21wb25lbnQsIGJvdW5kcyk7CiAgICAgICAgICAgIHZtLmVudi5kaWRVcGRhdGUoY29tcG9uZW50LCBtYW5hZ2VyKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRGlkVXBkYXRlTGF5b3V0T3Bjb2RlOwogICAgfShVcGRhdGluZ09wY29kZSk7CgogICAgLyogdHNsaW50OmRpc2FibGUgKi8KICAgIGZ1bmN0aW9uIGRlYnVnQ2FsbGJhY2soY29udGV4dCwgZ2V0KSB7CiAgICAgICAgY29uc29sZS5pbmZvKCdVc2UgYGNvbnRleHRgLCBhbmQgYGdldCg8cGF0aD4pYCB0byBkZWJ1ZyB0aGlzIHRlbXBsYXRlLicpOwogICAgICAgIC8vIGZvciBleGFtcGxlLi4uCiAgICAgICAgY29udGV4dCA9PT0gZ2V0KCd0aGlzJyk7CiAgICAgICAgZGVidWdnZXI7CiAgICB9CiAgICAvKiB0c2xpbnQ6ZW5hYmxlICovCiAgICB2YXIgY2FsbGJhY2sgPSBkZWJ1Z0NhbGxiYWNrOwogICAgLy8gRm9yIHRlc3RpbmcgcHVycG9zZXMKICAgIGZ1bmN0aW9uIHNldERlYnVnZ2VyQ2FsbGJhY2soY2IpIHsKICAgICAgICBjYWxsYmFjayA9IGNiOwogICAgfQogICAgZnVuY3Rpb24gcmVzZXREZWJ1Z2dlckNhbGxiYWNrKCkgewogICAgICAgIGNhbGxiYWNrID0gZGVidWdDYWxsYmFjazsKICAgIH0KCiAgICB2YXIgU2NvcGVJbnNwZWN0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gU2NvcGVJbnNwZWN0b3Ioc2NvcGUsIHN5bWJvbHMsIGV2YWxJbmZvKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU2NvcGVJbnNwZWN0b3IpOwoKICAgICAgICAgICAgdGhpcy5zY29wZSA9IHNjb3BlOwogICAgICAgICAgICB0aGlzLmxvY2FscyA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2YWxJbmZvLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc2xvdCA9IGV2YWxJbmZvW2ldOwogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBzeW1ib2xzW3Nsb3QgLSAxXTsKICAgICAgICAgICAgICAgIHZhciByZWYgPSBzY29wZS5nZXRTeW1ib2woc2xvdCk7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2Fsc1tuYW1lXSA9IHJlZjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgU2NvcGVJbnNwZWN0b3IucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChwYXRoKSB7CiAgICAgICAgICAgIHZhciBzY29wZSA9IHRoaXMuc2NvcGUsCiAgICAgICAgICAgICAgICBsb2NhbHMgPSB0aGlzLmxvY2FsczsKCiAgICAgICAgICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICAgICAgICAgIHZhciBfcGF0aCRzcGxpdCA9IHBhdGguc3BsaXQoJy4nKSwKICAgICAgICAgICAgICAgIGhlYWQgPSBfcGF0aCRzcGxpdFswXSwKICAgICAgICAgICAgICAgIHRhaWwgPSBfcGF0aCRzcGxpdC5zbGljZSgxKTsKCiAgICAgICAgICAgIHZhciBldmFsU2NvcGUgPSBzY29wZS5nZXRFdmFsU2NvcGUoKTsKICAgICAgICAgICAgdmFyIHJlZiA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGhlYWQgPT09ICd0aGlzJykgewogICAgICAgICAgICAgICAgcmVmID0gc2NvcGUuZ2V0U2VsZigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvY2Fsc1toZWFkXSkgewogICAgICAgICAgICAgICAgcmVmID0gbG9jYWxzW2hlYWRdOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWQuaW5kZXhPZignQCcpID09PSAwICYmIGV2YWxTY29wZVtoZWFkXSkgewogICAgICAgICAgICAgICAgcmVmID0gZXZhbFNjb3BlW2hlYWRdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVmID0gdGhpcy5zY29wZS5nZXRTZWxmKCk7CiAgICAgICAgICAgICAgICB0YWlsID0gcGFydHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhaWwucmVkdWNlKGZ1bmN0aW9uIChyLCBwYXJ0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gci5nZXQocGFydCk7CiAgICAgICAgICAgIH0sIHJlZik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFNjb3BlSW5zcGVjdG9yOwogICAgfSgpOwoKICAgIEFQUEVORF9PUENPREVTLmFkZCg5NyAvKiBEZWJ1Z2dlciAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNTApIHsKICAgICAgICB2YXIgX3N5bWJvbHMgPSBfcmVmNTAub3AxLAogICAgICAgICAgICBfZXZhbEluZm8gPSBfcmVmNTAub3AyOwoKICAgICAgICB2YXIgc3ltYm9scyA9IHZtLmNvbnN0YW50cy5nZXRTdHJpbmdBcnJheShfc3ltYm9scyk7CiAgICAgICAgdmFyIGV2YWxJbmZvID0gdm0uY29uc3RhbnRzLmdldEFycmF5KF9ldmFsSW5mbyk7CiAgICAgICAgdmFyIGluc3BlY3RvciA9IG5ldyBTY29wZUluc3BlY3Rvcih2bS5zY29wZSgpLCBzeW1ib2xzLCBldmFsSW5mbyk7CiAgICAgICAgY2FsbGJhY2sodm0uZ2V0U2VsZigpLnZhbHVlKCksIGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgICAgICAgIHJldHVybiBpbnNwZWN0b3IuZ2V0KHBhdGgpLnZhbHVlKCk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoOTUgLyogSW52b2tlUGFydGlhbCAqLywgZnVuY3Rpb24gKHZtLCBfcmVmNTEpIHsKICAgICAgICB2YXIgX21ldGEgPSBfcmVmNTEub3AxLAogICAgICAgICAgICBfc3ltYm9scyA9IF9yZWY1MS5vcDIsCiAgICAgICAgICAgIF9ldmFsSW5mbyA9IF9yZWY1MS5vcDM7CiAgICAgICAgdmFyIGNvbnN0YW50cyA9IHZtLmNvbnN0YW50cywKICAgICAgICAgICAgcmVzb2x2ZXIgPSB2bS5jb25zdGFudHMucmVzb2x2ZXIsCiAgICAgICAgICAgIHN0YWNrID0gdm0uc3RhY2s7CgogICAgICAgIHZhciBuYW1lID0gc3RhY2sucG9wKCkudmFsdWUoKTsKCiAgICAgICAgdmFyIG1ldGEgPSBjb25zdGFudHMuZ2V0U2VyaWFsaXphYmxlKF9tZXRhKTsKICAgICAgICB2YXIgb3V0ZXJTeW1ib2xzID0gY29uc3RhbnRzLmdldFN0cmluZ0FycmF5KF9zeW1ib2xzKTsKICAgICAgICB2YXIgZXZhbEluZm8gPSBjb25zdGFudHMuZ2V0QXJyYXkoX2V2YWxJbmZvKTsKICAgICAgICB2YXIgaGFuZGxlID0gcmVzb2x2ZXIubG9va3VwUGFydGlhbChuYW1lLCBtZXRhKTsKCiAgICAgICAgdmFyIGRlZmluaXRpb24gPSByZXNvbHZlci5yZXNvbHZlKGhhbmRsZSk7CgogICAgICAgIHZhciBfZGVmaW5pdGlvbiRnZXRQYXJ0aWEgPSBkZWZpbml0aW9uLmdldFBhcnRpYWwoKSwKICAgICAgICAgICAgc3ltYm9sVGFibGUgPSBfZGVmaW5pdGlvbiRnZXRQYXJ0aWEuc3ltYm9sVGFibGUsCiAgICAgICAgICAgIHZtSGFuZGxlID0gX2RlZmluaXRpb24kZ2V0UGFydGlhLmhhbmRsZTsKCiAgICAgICAgewogICAgICAgICAgICB2YXIgcGFydGlhbFN5bWJvbHMgPSBzeW1ib2xUYWJsZS5zeW1ib2xzOwogICAgICAgICAgICB2YXIgb3V0ZXJTY29wZSA9IHZtLnNjb3BlKCk7CiAgICAgICAgICAgIHZhciBwYXJ0aWFsU2NvcGUgPSB2bS5wdXNoUm9vdFNjb3BlKHBhcnRpYWxTeW1ib2xzLmxlbmd0aCwgZmFsc2UpOwogICAgICAgICAgICB2YXIgZXZhbFNjb3BlID0gb3V0ZXJTY29wZS5nZXRFdmFsU2NvcGUoKTsKICAgICAgICAgICAgcGFydGlhbFNjb3BlLmJpbmRDYWxsZXJTY29wZShvdXRlclNjb3BlLmdldENhbGxlclNjb3BlKCkpOwogICAgICAgICAgICBwYXJ0aWFsU2NvcGUuYmluZEV2YWxTY29wZShldmFsU2NvcGUpOwogICAgICAgICAgICBwYXJ0aWFsU2NvcGUuYmluZFNlbGYob3V0ZXJTY29wZS5nZXRTZWxmKCkpOwogICAgICAgICAgICB2YXIgbG9jYWxzID0gT2JqZWN0LmNyZWF0ZShvdXRlclNjb3BlLmdldFBhcnRpYWxNYXAoKSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZhbEluZm8ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBzbG90ID0gZXZhbEluZm9baV07CiAgICAgICAgICAgICAgICB2YXIgX25hbWUyID0gb3V0ZXJTeW1ib2xzW3Nsb3QgLSAxXTsKICAgICAgICAgICAgICAgIHZhciByZWYgPSBvdXRlclNjb3BlLmdldFN5bWJvbChzbG90KTsKICAgICAgICAgICAgICAgIGxvY2Fsc1tfbmFtZTJdID0gcmVmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldmFsU2NvcGUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIF9pMyA9IDA7IF9pMyA8IHBhcnRpYWxTeW1ib2xzLmxlbmd0aDsgX2kzKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX25hbWUzID0gcGFydGlhbFN5bWJvbHNbX2kzXTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3ltYm9sID0gX2kzICsgMTsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBldmFsU2NvcGVbX25hbWUzXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgcGFydGlhbFNjb3BlLmJpbmQoc3ltYm9sLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFydGlhbFNjb3BlLmJpbmRQYXJ0aWFsTWFwKGxvY2Fscyk7CiAgICAgICAgICAgIHZtLnB1c2hGcmFtZSgpOyAvLyBzcCArPSAyCiAgICAgICAgICAgIHZtLmNhbGwodm1IYW5kbGUpOwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBJdGVyYWJsZVByZXNlbmNlUmVmZXJlbmNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEl0ZXJhYmxlUHJlc2VuY2VSZWZlcmVuY2UoYXJ0aWZhY3RzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSXRlcmFibGVQcmVzZW5jZVJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLnRhZyA9IGFydGlmYWN0cy50YWc7CiAgICAgICAgICAgIHRoaXMuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwogICAgICAgIH0KCiAgICAgICAgSXRlcmFibGVQcmVzZW5jZVJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuICF0aGlzLmFydGlmYWN0cy5pc0VtcHR5KCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEl0ZXJhYmxlUHJlc2VuY2VSZWZlcmVuY2U7CiAgICB9KCk7CgogICAgQVBQRU5EX09QQ09ERVMuYWRkKDY2IC8qIFB1dEl0ZXJhdG9yICovLCBmdW5jdGlvbiAodm0pIHsKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgbGlzdFJlZiA9IHN0YWNrLnBvcCgpOwogICAgICAgIHZhciBrZXkgPSBzdGFjay5wb3AoKTsKICAgICAgICB2YXIgaXRlcmFibGUgPSB2bS5lbnYuaXRlcmFibGVGb3IobGlzdFJlZiwga2V5LnZhbHVlKCkpOwogICAgICAgIHZhciBpdGVyYXRvciA9IG5ldyBfcmVmZXJlbmNlLlJlZmVyZW5jZUl0ZXJhdG9yKGl0ZXJhYmxlKTsKICAgICAgICBzdGFjay5wdXNoKGl0ZXJhdG9yKTsKICAgICAgICBzdGFjay5wdXNoKG5ldyBJdGVyYWJsZVByZXNlbmNlUmVmZXJlbmNlKGl0ZXJhdG9yLmFydGlmYWN0cykpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNjQgLyogRW50ZXJMaXN0ICovLCBmdW5jdGlvbiAodm0sIF9yZWY1MikgewogICAgICAgIHZhciByZWxhdGl2ZVN0YXJ0ID0gX3JlZjUyLm9wMTsKCiAgICAgICAgdm0uZW50ZXJMaXN0KHJlbGF0aXZlU3RhcnQpOwogICAgfSk7CiAgICBBUFBFTkRfT1BDT0RFUy5hZGQoNjUgLyogRXhpdExpc3QgKi8sIGZ1bmN0aW9uICh2bSkgewogICAgICAgIHZtLmV4aXRMaXN0KCk7CiAgICB9KTsKICAgIEFQUEVORF9PUENPREVTLmFkZCg2NyAvKiBJdGVyYXRlICovLCBmdW5jdGlvbiAodm0sIF9yZWY1MykgewogICAgICAgIHZhciBicmVha3MgPSBfcmVmNTMub3AxOwoKICAgICAgICB2YXIgc3RhY2sgPSB2bS5zdGFjazsKICAgICAgICB2YXIgaXRlbSA9IHN0YWNrLnBlZWsoKS5uZXh0KCk7CiAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgdmFyIHRyeU9wY29kZSA9IHZtLml0ZXJhdGUoaXRlbS5tZW1vLCBpdGVtLnZhbHVlKTsKICAgICAgICAgICAgdm0uZW50ZXJJdGVtKGl0ZW0ua2V5LCB0cnlPcGNvZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZtLmdvdG8oYnJlYWtzKTsKICAgICAgICB9CiAgICB9KTsKCiAgICB2YXIgQ3Vyc29yID0gZnVuY3Rpb24gQ3Vyc29yKGVsZW1lbnQsIG5leHRTaWJsaW5nKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDdXJzb3IpOwoKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKICAgIH07CgogICAgdmFyIENvbmNyZXRlQm91bmRzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENvbmNyZXRlQm91bmRzKHBhcmVudE5vZGUsIGZpcnN0LCBsYXN0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ29uY3JldGVCb3VuZHMpOwoKICAgICAgICAgICAgdGhpcy5wYXJlbnROb2RlID0gcGFyZW50Tm9kZTsKICAgICAgICAgICAgdGhpcy5maXJzdCA9IGZpcnN0OwogICAgICAgICAgICB0aGlzLmxhc3QgPSBsYXN0OwogICAgICAgIH0KCiAgICAgICAgQ29uY3JldGVCb3VuZHMucHJvdG90eXBlLnBhcmVudEVsZW1lbnQgPSBmdW5jdGlvbiBwYXJlbnRFbGVtZW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnROb2RlOwogICAgICAgIH07CgogICAgICAgIENvbmNyZXRlQm91bmRzLnByb3RvdHlwZS5maXJzdE5vZGUgPSBmdW5jdGlvbiBmaXJzdE5vZGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpcnN0OwogICAgICAgIH07CgogICAgICAgIENvbmNyZXRlQm91bmRzLnByb3RvdHlwZS5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0OwogICAgICAgIH07CgogICAgICAgIHJldHVybiBDb25jcmV0ZUJvdW5kczsKICAgIH0oKTsKCiAgICB2YXIgU2luZ2xlTm9kZUJvdW5kcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW5nbGVOb2RlQm91bmRzKHBhcmVudE5vZGUsIG5vZGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTaW5nbGVOb2RlQm91bmRzKTsKCiAgICAgICAgICAgIHRoaXMucGFyZW50Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICAgICAgfQoKICAgICAgICBTaW5nbGVOb2RlQm91bmRzLnByb3RvdHlwZS5wYXJlbnRFbGVtZW50ID0gZnVuY3Rpb24gcGFyZW50RWxlbWVudCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Tm9kZTsKICAgICAgICB9OwoKICAgICAgICBTaW5nbGVOb2RlQm91bmRzLnByb3RvdHlwZS5maXJzdE5vZGUgPSBmdW5jdGlvbiBmaXJzdE5vZGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgU2luZ2xlTm9kZUJvdW5kcy5wcm90b3R5cGUubGFzdE5vZGUgPSBmdW5jdGlvbiBsYXN0Tm9kZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gU2luZ2xlTm9kZUJvdW5kczsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBib3VuZHMocGFyZW50LCBmaXJzdCwgbGFzdCkgewogICAgICAgIHJldHVybiBuZXcgQ29uY3JldGVCb3VuZHMocGFyZW50LCBmaXJzdCwgbGFzdCk7CiAgICB9CiAgICBmdW5jdGlvbiBzaW5nbGUocGFyZW50LCBub2RlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaW5nbGVOb2RlQm91bmRzKHBhcmVudCwgbm9kZSk7CiAgICB9CiAgICBmdW5jdGlvbiBfbW92ZShib3VuZHMsIHJlZmVyZW5jZSkgewogICAgICAgIHZhciBwYXJlbnQgPSBib3VuZHMucGFyZW50RWxlbWVudCgpOwogICAgICAgIHZhciBmaXJzdCA9IGJvdW5kcy5maXJzdE5vZGUoKTsKICAgICAgICB2YXIgbGFzdCA9IGJvdW5kcy5sYXN0Tm9kZSgpOwogICAgICAgIHZhciBub2RlID0gZmlyc3Q7CiAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZmVyZW5jZSk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBsYXN0KSByZXR1cm4gbmV4dDsKICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gY2xlYXIoYm91bmRzKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IGJvdW5kcy5wYXJlbnRFbGVtZW50KCk7CiAgICAgICAgdmFyIGZpcnN0ID0gYm91bmRzLmZpcnN0Tm9kZSgpOwogICAgICAgIHZhciBsYXN0ID0gYm91bmRzLmxhc3ROb2RlKCk7CiAgICAgICAgdmFyIG5vZGUgPSBmaXJzdDsKICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICB2YXIgbmV4dCA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICAgICAgaWYgKG5vZGUgPT09IGxhc3QpIHJldHVybiBuZXh0OwogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnOwogICAgLy8gUGF0Y2g6ICAgIGluc2VydEFkamFjZW50SFRNTCBvbiBTVkcgRml4CiAgICAvLyBCcm93c2VyczogU2FmYXJpLCBJRSwgRWRnZSwgRmlyZWZveCB+MzMtMzQKICAgIC8vIFJlYXNvbjogICBpbnNlcnRBZGphY2VudEhUTUwgZG9lcyBub3QgZXhpc3Qgb24gU1ZHIGVsZW1lbnRzIGluIFNhZmFyaS4gSXQgaXMKICAgIC8vICAgICAgICAgICBwcmVzZW50IGJ1dCB0aHJvd3MgYW4gZXhjZXB0aW9uIG9uIElFIGFuZCBFZGdlLiBPbGQgdmVyc2lvbnMgb2YKICAgIC8vICAgICAgICAgICBGaXJlZm94IGNyZWF0ZSBub2RlcyBpbiB0aGUgaW5jb3JyZWN0IG5hbWVzcGFjZS4KICAgIC8vIEZpeDogICAgICBTaW5jZSBJRSBhbmQgRWRnZSBzaWxlbnRseSBmYWlsIHRvIGNyZWF0ZSBTVkcgbm9kZXMgdXNpbmcKICAgIC8vICAgICAgICAgICBpbm5lckhUTUwsIGFuZCBiZWNhdXNlIEZpcmVmb3ggbWF5IGNyZWF0ZSBub2RlcyBpbiB0aGUgaW5jb3JyZWN0CiAgICAvLyAgICAgICAgICAgbmFtZXNwYWNlIHVzaW5nIGlubmVySFRNTCBvbiBTVkcgZWxlbWVudHMsIGFuIEhUTUwtc3RyaW5nIHdyYXBwaW5nCiAgICAvLyAgICAgICAgICAgYXBwcm9hY2ggaXMgdXNlZC4gQSBwcmUvcG9zdCBTVkcgdGFnIGlzIGFkZGVkIHRvIHRoZSBzdHJpbmcsIHRoZW4KICAgIC8vICAgICAgICAgICB0aGF0IHdob2xlIHN0cmluZyBpcyBhZGRlZCB0byBhIGRpdi4gVGhlIGNyZWF0ZWQgbm9kZXMgYXJlIHBsdWNrZWQKICAgIC8vICAgICAgICAgICBvdXQgYW5kIGFwcGxpZWQgdG8gdGhlIHRhcmdldCBsb2NhdGlvbiBvbiBET00uCiAgICBmdW5jdGlvbiBhcHBseVNWR0lubmVySFRNTEZpeChkb2N1bWVudCwgRE9NQ2xhc3MsIHN2Z05hbWVzcGFjZSkgewogICAgICAgIGlmICghZG9jdW1lbnQpIHJldHVybiBET01DbGFzczsKICAgICAgICBpZiAoIXNob3VsZEFwcGx5Rml4KGRvY3VtZW50LCBzdmdOYW1lc3BhY2UpKSB7CiAgICAgICAgICAgIHJldHVybiBET01DbGFzczsKICAgICAgICB9CiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoX0RPTUNsYXNzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRE9NQ2hhbmdlc1dpdGhTVkdJbm5lckhUTUxGaXgsIF9ET01DbGFzcyk7CgogICAgICAgICAgICBmdW5jdGlvbiBET01DaGFuZ2VzV2l0aFNWR0lubmVySFRNTEZpeCgpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRE9NQ2hhbmdlc1dpdGhTVkdJbm5lckhUTUxGaXgpOwogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRE9NQ2xhc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERPTUNoYW5nZXNXaXRoU1ZHSW5uZXJIVE1MRml4LnByb3RvdHlwZS5pbnNlcnRIVE1MQmVmb3JlID0gZnVuY3Rpb24gaW5zZXJ0SFRNTEJlZm9yZShwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKSB7CiAgICAgICAgICAgICAgICBpZiAoaHRtbCA9PT0gbnVsbCB8fCBodG1sID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfRE9NQ2xhc3MucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQubmFtZXNwYWNlVVJJICE9PSBzdmdOYW1lc3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX0RPTUNsYXNzLnByb3RvdHlwZS5pbnNlcnRIVE1MQmVmb3JlLmNhbGwodGhpcywgcGFyZW50LCBuZXh0U2libGluZywgaHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZml4U1ZHKHBhcmVudCwgZGl2LCBodG1sLCBuZXh0U2libGluZyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gRE9NQ2hhbmdlc1dpdGhTVkdJbm5lckhUTUxGaXg7CiAgICAgICAgfShET01DbGFzcyk7CiAgICB9CiAgICBmdW5jdGlvbiBmaXhTVkcocGFyZW50LCBkaXYsIGh0bWwsIHJlZmVyZW5jZSkgewogICAgICAgIC8vIElFLCBFZGdlOiBhbHNvIGRvIG5vdCBjb3JyZWN0bHkgc3VwcG9ydCB1c2luZyBgaW5uZXJIVE1MYCBvbiBTVkcKICAgICAgICAvLyBuYW1lc3BhY2VkIGVsZW1lbnRzLiBTbyBoZXJlIGEgd3JhcHBlciBpcyB1c2VkLgogICAgICAgIHZhciB3cmFwcGVkSHRtbCA9ICc8c3ZnPicgKyBodG1sICsgJzwvc3ZnPic7CiAgICAgICAgZGl2LmlubmVySFRNTCA9IHdyYXBwZWRIdG1sOwoKICAgICAgICB2YXIgX21vdmVOb2Rlc0JlZm9yZSA9IG1vdmVOb2Rlc0JlZm9yZShkaXYuZmlyc3RDaGlsZCwgcGFyZW50LCByZWZlcmVuY2UpLAogICAgICAgICAgICBmaXJzdCA9IF9tb3ZlTm9kZXNCZWZvcmVbMF0sCiAgICAgICAgICAgIGxhc3QgPSBfbW92ZU5vZGVzQmVmb3JlWzFdOwoKICAgICAgICByZXR1cm4gbmV3IENvbmNyZXRlQm91bmRzKHBhcmVudCwgZmlyc3QsIGxhc3QpOwogICAgfQogICAgZnVuY3Rpb24gc2hvdWxkQXBwbHlGaXgoZG9jdW1lbnQsIHN2Z05hbWVzcGFjZSkgewogICAgICAgIHZhciBzdmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoc3ZnTmFtZXNwYWNlLCAnc3ZnJyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3ZnWydpbnNlcnRBZGphY2VudEhUTUwnXSgnYmVmb3JlZW5kJywgJzxjaXJjbGU+PC9jaXJjbGU+Jyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBJRSwgRWRnZTogV2lsbCB0aHJvdywgaW5zZXJ0QWRqYWNlbnRIVE1MIGlzIHVuc3VwcG9ydGVkIG9uIFNWRwogICAgICAgICAgICAvLyBTYWZhcmk6IFdpbGwgdGhyb3csIGluc2VydEFkamFjZW50SFRNTCBpcyBub3QgcHJlc2VudCBvbiBTVkcKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAvLyBGRjogT2xkIHZlcnNpb25zIHdpbGwgY3JlYXRlIGEgbm9kZSBpbiB0aGUgd3JvbmcgbmFtZXNwYWNlCiAgICAgICAgICAgIGlmIChzdmcuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEgJiYgc3ZnLmZpcnN0Q2hpbGQubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgdGVzdCB3b3JrZWQgYXMgZXhwZWN0ZWQsIG5vIGZpeCByZXF1aXJlZAogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBQYXRjaDogICAgQWRqYWNlbnQgdGV4dCBub2RlIG1lcmdpbmcgZml4CiAgICAvLyBCcm93c2VyczogSUUsIEVkZ2UsIEZpcmVmb3ggdy9vIGluc3BlY3RvciBvcGVuCiAgICAvLyBSZWFzb246ICAgVGhlc2UgYnJvd3NlcnMgd2lsbCBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzLiBGb3IgZXhtYXBsZSBnaXZlbgogICAgLy8gICAgICAgICAgIDxkaXY+SGVsbG88L2Rpdj4gd2l0aCBkaXYuaW5zZXJ0QWRqYWNlbnRIVE1MKCcgd29ybGQnKSBicm93c2VycwogICAgLy8gICAgICAgICAgIHdpdGggcHJvcGVyIGJlaGF2aW9yIHdpbGwgcG9wdWxhdGUgZGl2LmNoaWxkTm9kZXMgd2l0aCB0d28gaXRlbXMuCiAgICAvLyAgICAgICAgICAgVGhlc2UgYnJvd3NlcnMgd2lsbCBwb3B1bGF0ZSBpdCB3aXRoIG9uZSBtZXJnZWQgbm9kZSBpbnN0ZWFkLgogICAgLy8gRml4OiAgICAgIEFkZCB0aGVzZSBub2RlcyB0byBhIHdyYXBwZXIgZWxlbWVudCwgdGhlbiBpdGVyYXRlIHRoZSBjaGlsZE5vZGVzCiAgICAvLyAgICAgICAgICAgb2YgdGhhdCB3cmFwcGVyIGFuZCBtb3ZlIHRoZSBub2RlcyB0byB0aGVpciB0YXJnZXQgbG9jYXRpb24uIE5vdGUKICAgIC8vICAgICAgICAgICB0aGF0IHBvdGVudGlhbCBTVkcgYnVncyB3aWxsIGhhdmUgYmVlbiBoYW5kbGVkIGJlZm9yZSB0aGlzIGZpeC4KICAgIC8vICAgICAgICAgICBOb3RlIHRoYXQgdGhpcyBmaXggbXVzdCBvbmx5IGFwcGx5IHRvIHRoZSBwcmV2aW91cyB0ZXh0IG5vZGUsIGFzCiAgICAvLyAgICAgICAgICAgdGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYGluc2VydEhUTUxCZWZvcmVgIGFscmVhZHkgaGFuZGxlcwogICAgLy8gICAgICAgICAgIGZvbGxvd2luZyB0ZXh0IG5vZGVzIGNvcnJlY3RseS4KICAgIGZ1bmN0aW9uIGFwcGx5VGV4dE5vZGVNZXJnaW5nRml4KGRvY3VtZW50LCBET01DbGFzcykgewogICAgICAgIGlmICghZG9jdW1lbnQpIHJldHVybiBET01DbGFzczsKICAgICAgICBpZiAoIXNob3VsZEFwcGx5Rml4JDEoZG9jdW1lbnQpKSB7CiAgICAgICAgICAgIHJldHVybiBET01DbGFzczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfRE9NQ2xhc3MyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXgsIF9ET01DbGFzczIpOwoKICAgICAgICAgICAgZnVuY3Rpb24gRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXgoZG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXgpOwoKICAgICAgICAgICAgICAgIHZhciBfdGhpczE2ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9ET01DbGFzczIuY2FsbCh0aGlzLCBkb2N1bWVudCkpOwoKICAgICAgICAgICAgICAgIF90aGlzMTYudXNlbGVzc0NvbW1lbnQgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcnKTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczE2OwogICAgICAgICAgICB9CgogICAgICAgICAgICBET01DaGFuZ2VzV2l0aFRleHROb2RlTWVyZ2luZ0ZpeC5wcm90b3R5cGUuaW5zZXJ0SFRNTEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEhUTUxCZWZvcmUocGFyZW50LCBuZXh0U2libGluZywgaHRtbCkgewogICAgICAgICAgICAgICAgaWYgKGh0bWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX0RPTUNsYXNzMi5wcm90b3R5cGUuaW5zZXJ0SFRNTEJlZm9yZS5jYWxsKHRoaXMsIHBhcmVudCwgbmV4dFNpYmxpbmcsIGh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGRpZFNldFVzZWxlc3NDb21tZW50ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB2YXIgbmV4dFByZXZpb3VzID0gbmV4dFNpYmxpbmcgPyBuZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmcgOiBwYXJlbnQubGFzdENoaWxkOwogICAgICAgICAgICAgICAgaWYgKG5leHRQcmV2aW91cyAmJiBuZXh0UHJldmlvdXMgaW5zdGFuY2VvZiBUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZGlkU2V0VXNlbGVzc0NvbW1lbnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUodGhpcy51c2VsZXNzQ29tbWVudCwgbmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGJvdW5kcyA9IF9ET01DbGFzczIucHJvdG90eXBlLmluc2VydEhUTUxCZWZvcmUuY2FsbCh0aGlzLCBwYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICAgICAgICAgIGlmIChkaWRTZXRVc2VsZXNzQ29tbWVudCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZCh0aGlzLnVzZWxlc3NDb21tZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBib3VuZHM7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gRE9NQ2hhbmdlc1dpdGhUZXh0Tm9kZU1lcmdpbmdGaXg7CiAgICAgICAgfShET01DbGFzcyk7CiAgICB9CiAgICBmdW5jdGlvbiBzaG91bGRBcHBseUZpeCQxKGRvY3VtZW50KSB7CiAgICAgICAgdmFyIG1lcmdpbmdUZXh0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgbWVyZ2luZ1RleHREaXYuaW5uZXJIVE1MID0gJ2ZpcnN0JzsKICAgICAgICBtZXJnaW5nVGV4dERpdi5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsICdzZWNvbmQnKTsKICAgICAgICBpZiAobWVyZ2luZ1RleHREaXYuY2hpbGROb2Rlcy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgLy8gSXQgd29ya2VkIGFzIGV4cGVjdGVkLCBubyBmaXggcmVxdWlyZWQKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB2YXIgU1ZHX05BTUVTUEFDRSQxID0gJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJzsKICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWwvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgdmFyIFNWR19JTlRFR1JBVElPTl9QT0lOVFMgPSB7IGZvcmVpZ25PYmplY3Q6IDEsIGRlc2M6IDEsIHRpdGxlOiAxIH07CiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sL3N5bnRheC5odG1sI2FkanVzdC1zdmctYXR0cmlidXRlcwogICAgLy8gVE9ETzogQWRqdXN0IFNWRyBhdHRyaWJ1dGVzCiAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sL3N5bnRheC5odG1sI3BhcnNpbmctbWFpbi1pbmZvcmVpZ24KICAgIC8vIFRPRE86IEFkanVzdCBTVkcgZWxlbWVudHMKICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWwvc3ludGF4Lmh0bWwjcGFyc2luZy1tYWluLWluZm9yZWlnbgogICAgdmFyIEJMQUNLTElTVF9UQUJMRSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBbJ2InLCAnYmlnJywgJ2Jsb2NrcXVvdGUnLCAnYm9keScsICdicicsICdjZW50ZXInLCAnY29kZScsICdkZCcsICdkaXYnLCAnZGwnLCAnZHQnLCAnZW0nLCAnZW1iZWQnLCAnaDEnLCAnaDInLCAnaDMnLCAnaDQnLCAnaDUnLCAnaDYnLCAnaGVhZCcsICdocicsICdpJywgJ2ltZycsICdsaScsICdsaXN0aW5nJywgJ21haW4nLCAnbWV0YScsICdub2JyJywgJ29sJywgJ3AnLCAncHJlJywgJ3J1YnknLCAncycsICdzbWFsbCcsICdzcGFuJywgJ3N0cm9uZycsICdzdHJpa2UnLCAnc3ViJywgJ3N1cCcsICd0YWJsZScsICd0dCcsICd1JywgJ3VsJywgJ3ZhciddLmZvckVhY2goZnVuY3Rpb24gKHRhZykgewogICAgICAgIHJldHVybiBCTEFDS0xJU1RfVEFCTEVbdGFnXSA9IDE7CiAgICB9KTsKICAgIHZhciBXSElURVNQQUNFID0gL1tcdC1cciBceEEwXHUxNjgwXHUxODBFXHUyMDAwLVx1MjAwQVx1MjAyOFx1MjAyOVx1MjAyRlx1MjA1Rlx1MzAwMFx1RkVGRl0vOwogICAgdmFyIGRvYyA9IHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcgPyBudWxsIDogZG9jdW1lbnQ7CiAgICBmdW5jdGlvbiBpc1doaXRlc3BhY2Uoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIFdISVRFU1BBQ0UudGVzdChzdHJpbmcpOwogICAgfQogICAgZnVuY3Rpb24gbW92ZU5vZGVzQmVmb3JlKHNvdXJjZSwgdGFyZ2V0LCBuZXh0U2libGluZykgewogICAgICAgIHZhciBmaXJzdCA9IHNvdXJjZS5maXJzdENoaWxkOwogICAgICAgIHZhciBsYXN0ID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudCA9IGZpcnN0OwogICAgICAgIHdoaWxlIChjdXJyZW50KSB7CiAgICAgICAgICAgIGxhc3QgPSBjdXJyZW50OwogICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5uZXh0U2libGluZzsKICAgICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShsYXN0LCBuZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbZmlyc3QsIGxhc3RdOwogICAgfQoKICAgIHZhciBET01PcGVyYXRpb25zID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIERPTU9wZXJhdGlvbnMoZG9jdW1lbnQpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBET01PcGVyYXRpb25zKTsKCiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDsKICAgICAgICAgICAgdGhpcy5zZXR1cFVzZWxlc3NFbGVtZW50KCk7CiAgICAgICAgfQogICAgICAgIC8vIHNwbGl0IGludG8gc2VwZXJhdGUgbWV0aG9kIHNvIHRoYXQgTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb24KICAgICAgICAvLyBjYW4gb3ZlcnJpZGUgaXQuCgoKICAgICAgICBET01PcGVyYXRpb25zLnByb3RvdHlwZS5zZXR1cFVzZWxlc3NFbGVtZW50ID0gZnVuY3Rpb24gc2V0dXBVc2VsZXNzRWxlbWVudCgpIHsKICAgICAgICAgICAgdGhpcy51c2VsZXNzRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgfTsKCiAgICAgICAgRE9NT3BlcmF0aW9ucy5wcm90b3R5cGUuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodGFnLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBpc0VsZW1lbnRJblNWR05hbWVzcGFjZSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgIGlzSFRNTEludGVncmF0aW9uUG9pbnQgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChjb250ZXh0KSB7CiAgICAgICAgICAgICAgICBpc0VsZW1lbnRJblNWR05hbWVzcGFjZSA9IGNvbnRleHQubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFJDEgfHwgdGFnID09PSAnc3ZnJzsKICAgICAgICAgICAgICAgIGlzSFRNTEludGVncmF0aW9uUG9pbnQgPSBTVkdfSU5URUdSQVRJT05fUE9JTlRTW2NvbnRleHQudGFnTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpc0VsZW1lbnRJblNWR05hbWVzcGFjZSA9IHRhZyA9PT0gJ3N2Zyc7CiAgICAgICAgICAgICAgICBpc0hUTUxJbnRlZ3JhdGlvblBvaW50ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzRWxlbWVudEluU1ZHTmFtZXNwYWNlICYmICFpc0hUTUxJbnRlZ3JhdGlvblBvaW50KSB7CiAgICAgICAgICAgICAgICAvLyBGSVhNRTogVGhpcyBkb2VzIG5vdCBwcm9wZXJseSBoYW5kbGUgPGZvbnQ+IHdpdGggY29sb3IsIGZhY2UsIG9yCiAgICAgICAgICAgICAgICAvLyBzaXplIGF0dHJpYnV0ZXMsIHdoaWNoIGlzIGFsc28gZGlzYWxsb3dlZCBieSB0aGUgc3BlYy4gV2Ugc2hvdWxkIGZpeAogICAgICAgICAgICAgICAgLy8gdGhpcy4KICAgICAgICAgICAgICAgIGlmIChCTEFDS0xJU1RfVEFCTEVbdGFnXSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNyZWF0ZSBhICcgKyB0YWcgKyAnIGluc2lkZSBhbiBTVkcgY29udGV4dCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OQU1FU1BBQ0UkMSwgdGFnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIERPTU9wZXJhdGlvbnMucHJvdG90eXBlLmluc2VydEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnQsIG5vZGUsIHJlZmVyZW5jZSkgewogICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZmVyZW5jZSk7CiAgICAgICAgfTsKCiAgICAgICAgRE9NT3BlcmF0aW9ucy5wcm90b3R5cGUuaW5zZXJ0SFRNTEJlZm9yZSA9IGZ1bmN0aW9uIGluc2VydEhUTUxCZWZvcmUoX3BhcmVudCwgbmV4dFNpYmxpbmcsIGh0bWwpIHsKICAgICAgICAgICAgcmV0dXJuIF9pbnNlcnRIVE1MQmVmb3JlKHRoaXMudXNlbGVzc0VsZW1lbnQsIF9wYXJlbnQsIG5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICB9OwoKICAgICAgICBET01PcGVyYXRpb25zLnByb3RvdHlwZS5jcmVhdGVUZXh0Tm9kZSA9IGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgICAgICAgfTsKCiAgICAgICAgRE9NT3BlcmF0aW9ucy5wcm90b3R5cGUuY3JlYXRlQ29tbWVudCA9IGZ1bmN0aW9uIGNyZWF0ZUNvbW1lbnQoZGF0YSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5jcmVhdGVDb21tZW50KGRhdGEpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBET01PcGVyYXRpb25zOwogICAgfSgpOwoKICAgIHZhciBET007CiAgICAoZnVuY3Rpb24gKERPTSkgewogICAgICAgIHZhciBUcmVlQ29uc3RydWN0aW9uID0gZnVuY3Rpb24gKF9ET01PcGVyYXRpb25zKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVHJlZUNvbnN0cnVjdGlvbiwgX0RPTU9wZXJhdGlvbnMpOwoKICAgICAgICAgICAgZnVuY3Rpb24gVHJlZUNvbnN0cnVjdGlvbigpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVHJlZUNvbnN0cnVjdGlvbik7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9ET01PcGVyYXRpb25zLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBUcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZS5jcmVhdGVFbGVtZW50TlMgPSBmdW5jdGlvbiBjcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCB0YWcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIHRhZyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUcmVlQ29uc3RydWN0aW9uLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1szXSA6IG51bGw7CgogICAgICAgICAgICAgICAgaWYgKG5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlTlMobmFtZXNwYWNlLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBUcmVlQ29uc3RydWN0aW9uOwogICAgICAgIH0oRE9NT3BlcmF0aW9ucyk7CgogICAgICAgIERPTS5UcmVlQ29uc3RydWN0aW9uID0gVHJlZUNvbnN0cnVjdGlvbjsKICAgICAgICB2YXIgYXBwbGllZFRyZWVDb250cnVjdGlvbiA9IFRyZWVDb25zdHJ1Y3Rpb247CiAgICAgICAgYXBwbGllZFRyZWVDb250cnVjdGlvbiA9IGFwcGx5VGV4dE5vZGVNZXJnaW5nRml4KGRvYywgYXBwbGllZFRyZWVDb250cnVjdGlvbik7CiAgICAgICAgYXBwbGllZFRyZWVDb250cnVjdGlvbiA9IGFwcGx5U1ZHSW5uZXJIVE1MRml4KGRvYywgYXBwbGllZFRyZWVDb250cnVjdGlvbiwgU1ZHX05BTUVTUEFDRSQxKTsKICAgICAgICBET00uRE9NVHJlZUNvbnN0cnVjdGlvbiA9IGFwcGxpZWRUcmVlQ29udHJ1Y3Rpb247CiAgICB9KShET00gfHwgKERPTSA9IHt9KSk7CgogICAgdmFyIERPTUNoYW5nZXMgPSBmdW5jdGlvbiAoX0RPTU9wZXJhdGlvbnMyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShET01DaGFuZ2VzLCBfRE9NT3BlcmF0aW9uczIpOwoKICAgICAgICBmdW5jdGlvbiBET01DaGFuZ2VzKGRvY3VtZW50KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRE9NQ2hhbmdlcyk7CgogICAgICAgICAgICB2YXIgX3RoaXMxOCA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRE9NT3BlcmF0aW9uczIuY2FsbCh0aGlzLCBkb2N1bWVudCkpOwoKICAgICAgICAgICAgX3RoaXMxOC5kb2N1bWVudCA9IGRvY3VtZW50OwogICAgICAgICAgICBfdGhpczE4Lm5hbWVzcGFjZSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBfdGhpczE4OwogICAgICAgIH0KCiAgICAgICAgRE9NQ2hhbmdlcy5wcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gc2V0QXR0cmlidXRlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBET01DaGFuZ2VzLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiByZW1vdmVBdHRyaWJ1dGUoZWxlbWVudCwgbmFtZSkgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgICB9OwoKICAgICAgICBET01DaGFuZ2VzLnByb3RvdHlwZS5pbnNlcnRBZnRlciA9IGZ1bmN0aW9uIGluc2VydEFmdGVyKGVsZW1lbnQsIG5vZGUsIHJlZmVyZW5jZSkgewogICAgICAgICAgICB0aGlzLmluc2VydEJlZm9yZShlbGVtZW50LCBub2RlLCByZWZlcmVuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBET01DaGFuZ2VzOwogICAgfShET01PcGVyYXRpb25zKTsKCiAgICBmdW5jdGlvbiBfaW5zZXJ0SFRNTEJlZm9yZSh1c2VsZXNzLCBfcGFyZW50LCBfbmV4dFNpYmxpbmcsIGh0bWwpIHsKICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lCiAgICAgICAgLy8gVHlwZVNjcmlwdCB2ZW5kb3JlZCBhbiBvbGQgdmVyc2lvbiBvZiB0aGUgRE9NIHNwZWMgd2hlcmUgYGluc2VydEFkamFjZW50SFRNTGAKICAgICAgICAvLyBvbmx5IGV4aXN0cyBvbiBgSFRNTEVsZW1lbnRgIGJ1dCBub3Qgb24gYEVsZW1lbnRgLiBXZSBhY3R1YWxseSB3b3JrIHdpdGggdGhlCiAgICAgICAgLy8gbmV3ZXIgdmVyc2lvbiBvZiB0aGUgRE9NIEFQSSBoZXJlIChhbmQgbW9ua2V5LXBhdGNoIHRoaXMgbWV0aG9kIGluIGAuL2NvbXBhdGAKICAgICAgICAvLyB3aGVuIHdlIGRldGVjdCBvbGRlciBicm93c2VycykuIFRoaXMgaXMgYSBoYWNrIHRvIHdvcmsgYXJvdW5kIHRoaXMgbGltaXRhdGlvbi4KICAgICAgICB2YXIgcGFyZW50ID0gX3BhcmVudDsKICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBfbmV4dFNpYmxpbmc7CiAgICAgICAgdmFyIHByZXYgPSBuZXh0U2libGluZyA/IG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA6IHBhcmVudC5sYXN0Q2hpbGQ7CiAgICAgICAgdmFyIGxhc3QgPSB2b2lkIDA7CiAgICAgICAgaWYgKGh0bWwgPT09IG51bGwgfHwgaHRtbCA9PT0gJycpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBDb25jcmV0ZUJvdW5kcyhwYXJlbnQsIG51bGwsIG51bGwpOwogICAgICAgIH0KICAgICAgICBpZiAobmV4dFNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50Lmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgaHRtbCk7CiAgICAgICAgICAgIGxhc3QgPSBwYXJlbnQubGFzdENoaWxkOwogICAgICAgIH0gZWxzZSBpZiAobmV4dFNpYmxpbmcgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgICBuZXh0U2libGluZy5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWJlZ2luJywgaHRtbCk7CiAgICAgICAgICAgIGxhc3QgPSBuZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gTm9uLWVsZW1lbnQgbm9kZXMgZG8gbm90IHN1cHBvcnQgaW5zZXJ0QWRqYWNlbnRIVE1MLCBzbyBhZGQgYW4KICAgICAgICAgICAgLy8gZWxlbWVudCBhbmQgY2FsbCBpdCBvbiB0aGF0IGVsZW1lbnQuIFRoZW4gcmVtb3ZlIHRoZSBlbGVtZW50LgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBUaGlzIGFsc28gcHJvdGVjdHMgRWRnZSwgSUUgYW5kIEZpcmVmb3ggdy9vIHRoZSBpbnNwZWN0b3Igb3BlbgogICAgICAgICAgICAvLyBmcm9tIG1lcmdpbmcgYWRqYWNlbnQgdGV4dCBub2Rlcy4gU2VlIC4vY29tcGF0L3RleHQtbm9kZS1tZXJnaW5nLWZpeC50cwogICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKHVzZWxlc3MsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgdXNlbGVzcy5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWJlZ2luJywgaHRtbCk7CiAgICAgICAgICAgIGxhc3QgPSB1c2VsZXNzLnByZXZpb3VzU2libGluZzsKICAgICAgICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKHVzZWxlc3MpOwogICAgICAgIH0KICAgICAgICB2YXIgZmlyc3QgPSBwcmV2ID8gcHJldi5uZXh0U2libGluZyA6IHBhcmVudC5maXJzdENoaWxkOwogICAgICAgIHJldHVybiBuZXcgQ29uY3JldGVCb3VuZHMocGFyZW50LCBmaXJzdCwgbGFzdCk7CiAgICB9CiAgICB2YXIgaGVscGVyID0gRE9NQ2hhbmdlczsKICAgIGhlbHBlciA9IGFwcGx5VGV4dE5vZGVNZXJnaW5nRml4KGRvYywgaGVscGVyKTsKICAgIGhlbHBlciA9IGFwcGx5U1ZHSW5uZXJIVE1MRml4KGRvYywgaGVscGVyLCBTVkdfTkFNRVNQQUNFJDEpOwogICAgdmFyIGhlbHBlciQxID0gaGVscGVyOwogICAgdmFyIERPTVRyZWVDb25zdHJ1Y3Rpb24gPSBET00uRE9NVHJlZUNvbnN0cnVjdGlvbjsKCiAgICB2YXIgYmFkUHJvdG9jb2xzID0gWydqYXZhc2NyaXB0OicsICd2YnNjcmlwdDonXTsKICAgIHZhciBiYWRUYWdzID0gWydBJywgJ0JPRFknLCAnTElOSycsICdJTUcnLCAnSUZSQU1FJywgJ0JBU0UnLCAnRk9STSddOwogICAgdmFyIGJhZFRhZ3NGb3JEYXRhVVJJID0gWydFTUJFRCddOwogICAgdmFyIGJhZEF0dHJpYnV0ZXMgPSBbJ2hyZWYnLCAnc3JjJywgJ2JhY2tncm91bmQnLCAnYWN0aW9uJ107CiAgICB2YXIgYmFkQXR0cmlidXRlc0ZvckRhdGFVUkkgPSBbJ3NyYyddOwogICAgZnVuY3Rpb24gaGFzKGFycmF5LCBpdGVtKSB7CiAgICAgICAgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSkgIT09IC0xOwogICAgfQogICAgZnVuY3Rpb24gY2hlY2tVUkkodGFnTmFtZSwgYXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuICh0YWdOYW1lID09PSBudWxsIHx8IGhhcyhiYWRUYWdzLCB0YWdOYW1lKSkgJiYgaGFzKGJhZEF0dHJpYnV0ZXMsIGF0dHJpYnV0ZSk7CiAgICB9CiAgICBmdW5jdGlvbiBjaGVja0RhdGFVUkkodGFnTmFtZSwgYXR0cmlidXRlKSB7CiAgICAgICAgaWYgKHRhZ05hbWUgPT09IG51bGwpIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gaGFzKGJhZFRhZ3NGb3JEYXRhVVJJLCB0YWdOYW1lKSAmJiBoYXMoYmFkQXR0cmlidXRlc0ZvckRhdGFVUkksIGF0dHJpYnV0ZSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXF1aXJlc1Nhbml0aXphdGlvbih0YWdOYW1lLCBhdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm4gY2hlY2tVUkkodGFnTmFtZSwgYXR0cmlidXRlKSB8fCBjaGVja0RhdGFVUkkodGFnTmFtZSwgYXR0cmlidXRlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNhbml0aXplQXR0cmlidXRlVmFsdWUoZW52LCBlbGVtZW50LCBhdHRyaWJ1dGUsIHZhbHVlKSB7CiAgICAgICAgdmFyIHRhZ05hbWUgPSBudWxsOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzU2FmZVN0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvSFRNTCgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWVsZW1lbnQpIHsKICAgICAgICAgICAgdGFnTmFtZSA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFnTmFtZSA9IGVsZW1lbnQudGFnTmFtZS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICB2YXIgc3RyID0gbm9ybWFsaXplU3RyaW5nVmFsdWUodmFsdWUpOwogICAgICAgIGlmIChjaGVja1VSSSh0YWdOYW1lLCBhdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIHZhciBwcm90b2NvbCA9IGVudi5wcm90b2NvbEZvclVSTChzdHIpOwogICAgICAgICAgICBpZiAoaGFzKGJhZFByb3RvY29scywgcHJvdG9jb2wpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3Vuc2FmZTonICsgc3RyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjaGVja0RhdGFVUkkodGFnTmFtZSwgYXR0cmlidXRlKSkgewogICAgICAgICAgICByZXR1cm4gJ3Vuc2FmZTonICsgc3RyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfQoKICAgIC8qCiAgICAgKiBAbWV0aG9kIG5vcm1hbGl6ZVByb3BlcnR5CiAgICAgKiBAcGFyYW0gZWxlbWVudCB7SFRNTEVsZW1lbnR9CiAgICAgKiBAcGFyYW0gc2xvdE5hbWUge1N0cmluZ30KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHsgbmFtZSwgdHlwZSB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BlcnR5KGVsZW1lbnQsIHNsb3ROYW1lKSB7CiAgICAgICAgdmFyIHR5cGUgPSB2b2lkIDAsCiAgICAgICAgICAgIG5vcm1hbGl6ZWQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHNsb3ROYW1lIGluIGVsZW1lbnQpIHsKICAgICAgICAgICAgbm9ybWFsaXplZCA9IHNsb3ROYW1lOwogICAgICAgICAgICB0eXBlID0gJ3Byb3AnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsb3dlciA9IHNsb3ROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChsb3dlciBpbiBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICB0eXBlID0gJ3Byb3AnOwogICAgICAgICAgICAgICAgbm9ybWFsaXplZCA9IGxvd2VyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHlwZSA9ICdhdHRyJzsKICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWQgPSBzbG90TmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gJ3Byb3AnICYmIChub3JtYWxpemVkLnRvTG93ZXJDYXNlKCkgPT09ICdzdHlsZScgfHwgcHJlZmVyQXR0cihlbGVtZW50LnRhZ05hbWUsIG5vcm1hbGl6ZWQpKSkgewogICAgICAgICAgICB0eXBlID0gJ2F0dHInOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBub3JtYWxpemVkOiBub3JtYWxpemVkLCB0eXBlOiB0eXBlIH07CiAgICB9CiAgICAvLyBwcm9wZXJ0aWVzIHRoYXQgTVVTVCBiZSBzZXQgYXMgYXR0cmlidXRlcywgZHVlIHRvOgogICAgLy8gKiBicm93c2VyIGJ1ZwogICAgLy8gKiBzdHJhbmdlIHNwZWMgb3V0bGllcgogICAgdmFyIEFUVFJfT1ZFUlJJREVTID0gewogICAgICAgIElOUFVUOiB7CiAgICAgICAgICAgIGZvcm06IHRydWUsCiAgICAgICAgICAgIC8vIENocm9tZSA0Ni4wLjI0NjQuMDogJ2F1dG9jb3JyZWN0JyBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpID09PSBmYWxzZQogICAgICAgICAgICAvLyBTYWZhcmkgOC4wLjc6ICdhdXRvY29ycmVjdCcgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSA9PT0gZmFsc2UKICAgICAgICAgICAgLy8gTW9iaWxlIFNhZmFyaSAoaU9TIDguNCBzaW11bGF0b3IpOiAnYXV0b2NvcnJlY3QnIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JykgPT09IHRydWUKICAgICAgICAgICAgYXV0b2NvcnJlY3Q6IHRydWUsCiAgICAgICAgICAgIC8vIENocm9tZSA1NC4wLjI4NDAuOTg6ICdsaXN0JyBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpID09PSB0cnVlCiAgICAgICAgICAgIC8vIFNhZmFyaSA5LjEuMzogJ2xpc3QnIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0JykgPT09IGZhbHNlCiAgICAgICAgICAgIGxpc3Q6IHRydWUKICAgICAgICB9LAogICAgICAgIC8vIGVsZW1lbnQuZm9ybSBpcyBhY3R1YWxseSBhIGxlZ2l0aW1hdGUgcmVhZE9ubHkgcHJvcGVydHksIHRoYXQgaXMgdG8gYmUKICAgICAgICAvLyBtdXRhdGVkLCBidXQgbXVzdCBiZSBtdXRhdGVkIGJ5IHNldEF0dHJpYnV0ZS4uLgogICAgICAgIFNFTEVDVDogeyBmb3JtOiB0cnVlIH0sCiAgICAgICAgT1BUSU9OOiB7IGZvcm06IHRydWUgfSwKICAgICAgICBURVhUQVJFQTogeyBmb3JtOiB0cnVlIH0sCiAgICAgICAgTEFCRUw6IHsgZm9ybTogdHJ1ZSB9LAogICAgICAgIEZJRUxEU0VUOiB7IGZvcm06IHRydWUgfSwKICAgICAgICBMRUdFTkQ6IHsgZm9ybTogdHJ1ZSB9LAogICAgICAgIE9CSkVDVDogeyBmb3JtOiB0cnVlIH0sCiAgICAgICAgQlVUVE9OOiB7IGZvcm06IHRydWUgfQogICAgfTsKICAgIGZ1bmN0aW9uIHByZWZlckF0dHIodGFnTmFtZSwgcHJvcE5hbWUpIHsKICAgICAgICB2YXIgdGFnID0gQVRUUl9PVkVSUklERVNbdGFnTmFtZS50b1VwcGVyQ2FzZSgpXTsKICAgICAgICByZXR1cm4gdGFnICYmIHRhZ1twcm9wTmFtZS50b0xvd2VyQ2FzZSgpXSB8fCBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBkeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsIGF0dHIsIG5hbWVzcGFjZSkgewogICAgICAgIHZhciB0YWdOYW1lID0gZWxlbWVudC50YWdOYW1lLAogICAgICAgICAgICBuYW1lc3BhY2VVUkkgPSBlbGVtZW50Lm5hbWVzcGFjZVVSSTsKCiAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IHsgZWxlbWVudDogZWxlbWVudCwgbmFtZTogYXR0ciwgbmFtZXNwYWNlOiBuYW1lc3BhY2UgfTsKICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFJDEpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1aWxkRHluYW1pY0F0dHJpYnV0ZSh0YWdOYW1lLCBhdHRyLCBhdHRyaWJ1dGUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIF9ub3JtYWxpemVQcm9wZXJ0eSA9IG5vcm1hbGl6ZVByb3BlcnR5KGVsZW1lbnQsIGF0dHIpLAogICAgICAgICAgICB0eXBlID0gX25vcm1hbGl6ZVByb3BlcnR5LnR5cGUsCiAgICAgICAgICAgIG5vcm1hbGl6ZWQgPSBfbm9ybWFsaXplUHJvcGVydHkubm9ybWFsaXplZDsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdhdHRyJykgewogICAgICAgICAgICByZXR1cm4gYnVpbGREeW5hbWljQXR0cmlidXRlKHRhZ05hbWUsIG5vcm1hbGl6ZWQsIGF0dHJpYnV0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGJ1aWxkRHluYW1pY1Byb3BlcnR5KHRhZ05hbWUsIG5vcm1hbGl6ZWQsIGF0dHJpYnV0ZSk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGREeW5hbWljQXR0cmlidXRlKHRhZ05hbWUsIG5hbWUsIGF0dHJpYnV0ZSkgewogICAgICAgIGlmIChyZXF1aXJlc1Nhbml0aXphdGlvbih0YWdOYW1lLCBuYW1lKSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFNhZmVEeW5hbWljQXR0cmlidXRlKGF0dHJpYnV0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTaW1wbGVEeW5hbWljQXR0cmlidXRlKGF0dHJpYnV0ZSk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGREeW5hbWljUHJvcGVydHkodGFnTmFtZSwgbmFtZSwgYXR0cmlidXRlKSB7CiAgICAgICAgaWYgKHJlcXVpcmVzU2FuaXRpemF0aW9uKHRhZ05hbWUsIG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgU2FmZUR5bmFtaWNQcm9wZXJ0eShuYW1lLCBhdHRyaWJ1dGUpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVc2VySW5wdXRWYWx1ZSh0YWdOYW1lLCBuYW1lKSkgewogICAgICAgICAgICByZXR1cm4gbmV3IElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlKG5hbWUsIGF0dHJpYnV0ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc09wdGlvblNlbGVjdGVkKHRhZ05hbWUsIG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlKG5hbWUsIGF0dHJpYnV0ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgRGVmYXVsdER5bmFtaWNQcm9wZXJ0eShuYW1lLCBhdHRyaWJ1dGUpOwogICAgfQoKICAgIHZhciBEeW5hbWljQXR0cmlidXRlID0gZnVuY3Rpb24gRHluYW1pY0F0dHJpYnV0ZShhdHRyaWJ1dGUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIER5bmFtaWNBdHRyaWJ1dGUpOwoKICAgICAgICB0aGlzLmF0dHJpYnV0ZSA9IGF0dHJpYnV0ZTsKICAgIH07CgogICAgdmFyIFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUgPSBmdW5jdGlvbiAoX0R5bmFtaWNBdHRyaWJ1dGUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUsIF9EeW5hbWljQXR0cmlidXRlKTsKCiAgICAgICAgZnVuY3Rpb24gU2ltcGxlRHluYW1pY0F0dHJpYnV0ZSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTaW1wbGVEeW5hbWljQXR0cmlidXRlKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRHluYW1pY0F0dHJpYnV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIHNldChkb20sIHZhbHVlLCBfZW52KSB7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkVmFsdWUgPSBub3JtYWxpemVWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkVmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfYXR0cmlidXRlMiA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBfYXR0cmlidXRlMi5uYW1lLAogICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IF9hdHRyaWJ1dGUyLm5hbWVzcGFjZTsKCiAgICAgICAgICAgICAgICBkb20uX19zZXRBdHRyaWJ1dGUobmFtZSwgbm9ybWFsaXplZFZhbHVlLCBuYW1lc3BhY2UpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgU2ltcGxlRHluYW1pY0F0dHJpYnV0ZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlLCBfZW52KSB7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkVmFsdWUgPSBub3JtYWxpemVWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIHZhciBfYXR0cmlidXRlMyA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgICAgICAgZWxlbWVudCA9IF9hdHRyaWJ1dGUzLmVsZW1lbnQsCiAgICAgICAgICAgICAgICBuYW1lID0gX2F0dHJpYnV0ZTMubmFtZTsKCiAgICAgICAgICAgIGlmIChub3JtYWxpemVkVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbm9ybWFsaXplZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBTaW1wbGVEeW5hbWljQXR0cmlidXRlOwogICAgfShEeW5hbWljQXR0cmlidXRlKTsKCiAgICB2YXIgRGVmYXVsdER5bmFtaWNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChfRHluYW1pY0F0dHJpYnV0ZTIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKERlZmF1bHREeW5hbWljUHJvcGVydHksIF9EeW5hbWljQXR0cmlidXRlMik7CgogICAgICAgIGZ1bmN0aW9uIERlZmF1bHREeW5hbWljUHJvcGVydHkobm9ybWFsaXplZE5hbWUsIGF0dHJpYnV0ZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlZmF1bHREeW5hbWljUHJvcGVydHkpOwoKICAgICAgICAgICAgdmFyIF90aGlzMjAgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0R5bmFtaWNBdHRyaWJ1dGUyLmNhbGwodGhpcywgYXR0cmlidXRlKSk7CgogICAgICAgICAgICBfdGhpczIwLm5vcm1hbGl6ZWROYW1lID0gbm9ybWFsaXplZE5hbWU7CiAgICAgICAgICAgIHJldHVybiBfdGhpczIwOwogICAgICAgIH0KCiAgICAgICAgRGVmYXVsdER5bmFtaWNQcm9wZXJ0eS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KGRvbSwgdmFsdWUsIF9lbnYpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIGRvbS5fX3NldFByb3BlcnR5KHRoaXMubm9ybWFsaXplZE5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIERlZmF1bHREeW5hbWljUHJvcGVydHkucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSh2YWx1ZSwgX2VudikgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuYXR0cmlidXRlLmVsZW1lbnQ7CgogICAgICAgICAgICBpZiAodGhpcy52YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRbdGhpcy5ub3JtYWxpemVkTmFtZV0gPSB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBEZWZhdWx0RHluYW1pY1Byb3BlcnR5LnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiByZW1vdmVBdHRyaWJ1dGUoKSB7CiAgICAgICAgICAgIHZhciBfYXR0cmlidXRlNCA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgICAgICAgZWxlbWVudCA9IF9hdHRyaWJ1dGU0LmVsZW1lbnQsCiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBfYXR0cmlidXRlNC5uYW1lc3BhY2U7CgogICAgICAgICAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZU5TKG5hbWVzcGFjZSwgdGhpcy5ub3JtYWxpemVkTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSh0aGlzLm5vcm1hbGl6ZWROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBEZWZhdWx0RHluYW1pY1Byb3BlcnR5OwogICAgfShEeW5hbWljQXR0cmlidXRlKTsKCiAgICB2YXIgU2FmZUR5bmFtaWNQcm9wZXJ0eSA9IGZ1bmN0aW9uIChfRGVmYXVsdER5bmFtaWNQcm9wZXIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNhZmVEeW5hbWljUHJvcGVydHksIF9EZWZhdWx0RHluYW1pY1Byb3Blcik7CgogICAgICAgIGZ1bmN0aW9uIFNhZmVEeW5hbWljUHJvcGVydHkoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU2FmZUR5bmFtaWNQcm9wZXJ0eSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0RlZmF1bHREeW5hbWljUHJvcGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgIH0KCiAgICAgICAgU2FmZUR5bmFtaWNQcm9wZXJ0eS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KGRvbSwgdmFsdWUsIGVudikgewogICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZTUgPSB0aGlzLmF0dHJpYnV0ZSwKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBfYXR0cmlidXRlNS5lbGVtZW50LAogICAgICAgICAgICAgICAgbmFtZSA9IF9hdHRyaWJ1dGU1Lm5hbWU7CgogICAgICAgICAgICB2YXIgc2FuaXRpemVkID0gc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZShlbnYsIGVsZW1lbnQsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgX0RlZmF1bHREeW5hbWljUHJvcGVyLnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCBkb20sIHNhbml0aXplZCwgZW52KTsKICAgICAgICB9OwoKICAgICAgICBTYWZlRHluYW1pY1Byb3BlcnR5LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUsIGVudikgewogICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZTYgPSB0aGlzLmF0dHJpYnV0ZSwKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBfYXR0cmlidXRlNi5lbGVtZW50LAogICAgICAgICAgICAgICAgbmFtZSA9IF9hdHRyaWJ1dGU2Lm5hbWU7CgogICAgICAgICAgICB2YXIgc2FuaXRpemVkID0gc2FuaXRpemVBdHRyaWJ1dGVWYWx1ZShlbnYsIGVsZW1lbnQsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgX0RlZmF1bHREeW5hbWljUHJvcGVyLnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBzYW5pdGl6ZWQsIGVudik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFNhZmVEeW5hbWljUHJvcGVydHk7CiAgICB9KERlZmF1bHREeW5hbWljUHJvcGVydHkpOwoKICAgIHZhciBTYWZlRHluYW1pY0F0dHJpYnV0ZSA9IGZ1bmN0aW9uIChfU2ltcGxlRHluYW1pY0F0dHJpYnUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNhZmVEeW5hbWljQXR0cmlidXRlLCBfU2ltcGxlRHluYW1pY0F0dHJpYnUpOwoKICAgICAgICBmdW5jdGlvbiBTYWZlRHluYW1pY0F0dHJpYnV0ZSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTYWZlRHluYW1pY0F0dHJpYnV0ZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1NpbXBsZUR5bmFtaWNBdHRyaWJ1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgIH0KCiAgICAgICAgU2FmZUR5bmFtaWNBdHRyaWJ1dGUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIHNldChkb20sIHZhbHVlLCBlbnYpIHsKICAgICAgICAgICAgdmFyIF9hdHRyaWJ1dGU3ID0gdGhpcy5hdHRyaWJ1dGUsCiAgICAgICAgICAgICAgICBlbGVtZW50ID0gX2F0dHJpYnV0ZTcuZWxlbWVudCwKICAgICAgICAgICAgICAgIG5hbWUgPSBfYXR0cmlidXRlNy5uYW1lOwoKICAgICAgICAgICAgdmFyIHNhbml0aXplZCA9IHNhbml0aXplQXR0cmlidXRlVmFsdWUoZW52LCBlbGVtZW50LCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIF9TaW1wbGVEeW5hbWljQXR0cmlidS5wcm90b3R5cGUuc2V0LmNhbGwodGhpcywgZG9tLCBzYW5pdGl6ZWQsIGVudik7CiAgICAgICAgfTsKCiAgICAgICAgU2FmZUR5bmFtaWNBdHRyaWJ1dGUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSh2YWx1ZSwgZW52KSB7CiAgICAgICAgICAgIHZhciBfYXR0cmlidXRlOCA9IHRoaXMuYXR0cmlidXRlLAogICAgICAgICAgICAgICAgZWxlbWVudCA9IF9hdHRyaWJ1dGU4LmVsZW1lbnQsCiAgICAgICAgICAgICAgICBuYW1lID0gX2F0dHJpYnV0ZTgubmFtZTsKCiAgICAgICAgICAgIHZhciBzYW5pdGl6ZWQgPSBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlKGVudiwgZWxlbWVudCwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICBfU2ltcGxlRHluYW1pY0F0dHJpYnUucHJvdG90eXBlLnVwZGF0ZS5jYWxsKHRoaXMsIHNhbml0aXplZCwgZW52KTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gU2FmZUR5bmFtaWNBdHRyaWJ1dGU7CiAgICB9KFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGUpOwoKICAgIHZhciBJbnB1dFZhbHVlRHluYW1pY0F0dHJpYnV0ZSA9IGZ1bmN0aW9uIChfRGVmYXVsdER5bmFtaWNQcm9wZXIyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShJbnB1dFZhbHVlRHluYW1pY0F0dHJpYnV0ZSwgX0RlZmF1bHREeW5hbWljUHJvcGVyMik7CgogICAgICAgIGZ1bmN0aW9uIElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIElucHV0VmFsdWVEeW5hbWljQXR0cmlidXRlKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRGVmYXVsdER5bmFtaWNQcm9wZXIyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgIH0KCiAgICAgICAgSW5wdXRWYWx1ZUR5bmFtaWNBdHRyaWJ1dGUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIHNldChkb20sIHZhbHVlKSB7CiAgICAgICAgICAgIGRvbS5fX3NldFByb3BlcnR5KCd2YWx1ZScsIG5vcm1hbGl6ZVN0cmluZ1ZhbHVlKHZhbHVlKSk7CiAgICAgICAgfTsKCiAgICAgICAgSW5wdXRWYWx1ZUR5bmFtaWNBdHRyaWJ1dGUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSh2YWx1ZSkgewogICAgICAgICAgICB2YXIgaW5wdXQgPSB0aGlzLmF0dHJpYnV0ZS5lbGVtZW50OwogICAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gaW5wdXQudmFsdWU7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkVmFsdWUgPSBub3JtYWxpemVTdHJpbmdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgIT09IG5vcm1hbGl6ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBub3JtYWxpemVkVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gSW5wdXRWYWx1ZUR5bmFtaWNBdHRyaWJ1dGU7CiAgICB9KERlZmF1bHREeW5hbWljUHJvcGVydHkpOwoKICAgIHZhciBPcHRpb25TZWxlY3RlZER5bmFtaWNBdHRyaWJ1dGUgPSBmdW5jdGlvbiAoX0RlZmF1bHREeW5hbWljUHJvcGVyMykgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlLCBfRGVmYXVsdER5bmFtaWNQcm9wZXIzKTsKCiAgICAgICAgZnVuY3Rpb24gT3B0aW9uU2VsZWN0ZWREeW5hbWljQXR0cmlidXRlKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE9wdGlvblNlbGVjdGVkRHluYW1pY0F0dHJpYnV0ZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0RlZmF1bHREeW5hbWljUHJvcGVyMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIE9wdGlvblNlbGVjdGVkRHluYW1pY0F0dHJpYnV0ZS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KGRvbSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBkb20uX19zZXRQcm9wZXJ0eSgnc2VsZWN0ZWQnLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE9wdGlvblNlbGVjdGVkRHluYW1pY0F0dHJpYnV0ZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBvcHRpb24gPSB0aGlzLmF0dHJpYnV0ZS5lbGVtZW50OwogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBPcHRpb25TZWxlY3RlZER5bmFtaWNBdHRyaWJ1dGU7CiAgICB9KERlZmF1bHREeW5hbWljUHJvcGVydHkpOwoKICAgIGZ1bmN0aW9uIGlzT3B0aW9uU2VsZWN0ZWQodGFnTmFtZSwgYXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuIHRhZ05hbWUgPT09ICdPUFRJT04nICYmIGF0dHJpYnV0ZSA9PT0gJ3NlbGVjdGVkJzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzVXNlcklucHV0VmFsdWUodGFnTmFtZSwgYXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuICh0YWdOYW1lID09PSAnSU5QVVQnIHx8IHRhZ05hbWUgPT09ICdURVhUQVJFQScpICYmIGF0dHJpYnV0ZSA9PT0gJ3ZhbHVlJzsKICAgIH0KICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQogICAgICAgIC8vIG9uY2xpY2sgZnVuY3Rpb24gZXRjIGluIFNTUgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgfQoKICAgIHZhciBTY29wZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTY29wZSgKICAgICAgICAvLyB0aGUgMHRoIHNsb3QgaXMgYHNlbGZgCiAgICAgICAgc2xvdHMsIGNhbGxlclNjb3BlLAogICAgICAgIC8vIG5hbWVkIGFyZ3VtZW50cyBhbmQgYmxvY2tzIHBhc3NlZCB0byBhIGxheW91dCB0aGF0IHVzZXMgZXZhbAogICAgICAgIGV2YWxTY29wZSwKICAgICAgICAvLyBsb2NhbHMgaW4gc2NvcGUgd2hlbiB0aGUgcGFydGlhbCB3YXMgaW52b2tlZAogICAgICAgIHBhcnRpYWxNYXApIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTY29wZSk7CgogICAgICAgICAgICB0aGlzLnNsb3RzID0gc2xvdHM7CiAgICAgICAgICAgIHRoaXMuY2FsbGVyU2NvcGUgPSBjYWxsZXJTY29wZTsKICAgICAgICAgICAgdGhpcy5ldmFsU2NvcGUgPSBldmFsU2NvcGU7CiAgICAgICAgICAgIHRoaXMucGFydGlhbE1hcCA9IHBhcnRpYWxNYXA7CiAgICAgICAgfQoKICAgICAgICBTY29wZS5yb290ID0gZnVuY3Rpb24gcm9vdChzZWxmKSB7CiAgICAgICAgICAgIHZhciBzaXplID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAwOwoKICAgICAgICAgICAgdmFyIHJlZnMgPSBuZXcgQXJyYXkoc2l6ZSArIDEpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBzaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIHJlZnNbaV0gPSBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgU2NvcGUocmVmcywgbnVsbCwgbnVsbCwgbnVsbCkuaW5pdCh7IHNlbGY6IHNlbGYgfSk7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUuc2l6ZWQgPSBmdW5jdGlvbiBzaXplZCgpIHsKICAgICAgICAgICAgdmFyIHNpemUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDA7CgogICAgICAgICAgICB2YXIgcmVmcyA9IG5ldyBBcnJheShzaXplICsgMSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHNpemU7IGkrKykgewogICAgICAgICAgICAgICAgcmVmc1tpXSA9IFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBTY29wZShyZWZzLCBudWxsLCBudWxsLCBudWxsKTsKICAgICAgICB9OwoKICAgICAgICBTY29wZS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIGluaXQoX3JlZjU0KSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gX3JlZjU0LnNlbGY7CgogICAgICAgICAgICB0aGlzLnNsb3RzWzBdID0gc2VsZjsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmdldFNlbGYgPSBmdW5jdGlvbiBnZXRTZWxmKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoMCk7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmdldFN5bWJvbCA9IGZ1bmN0aW9uIGdldFN5bWJvbChzeW1ib2wpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KHN5bWJvbCk7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmdldEJsb2NrID0gZnVuY3Rpb24gZ2V0QmxvY2soc3ltYm9sKSB7CiAgICAgICAgICAgIHZhciBibG9jayA9IHRoaXMuZ2V0KHN5bWJvbCk7CiAgICAgICAgICAgIHJldHVybiBibG9jayA9PT0gVU5ERUZJTkVEX1JFRkVSRU5DRSA/IG51bGwgOiBibG9jazsKICAgICAgICB9OwoKICAgICAgICBTY29wZS5wcm90b3R5cGUuZ2V0RXZhbFNjb3BlID0gZnVuY3Rpb24gZ2V0RXZhbFNjb3BlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ldmFsU2NvcGU7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmdldFBhcnRpYWxNYXAgPSBmdW5jdGlvbiBnZXRQYXJ0aWFsTWFwKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJ0aWFsTWFwOwogICAgICAgIH07CgogICAgICAgIFNjb3BlLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24gYmluZChzeW1ib2wsIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0KHN5bWJvbCwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIFNjb3BlLnByb3RvdHlwZS5iaW5kU2VsZiA9IGZ1bmN0aW9uIGJpbmRTZWxmKHNlbGYpIHsKICAgICAgICAgICAgdGhpcy5zZXQoMCwgc2VsZik7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmJpbmRTeW1ib2wgPSBmdW5jdGlvbiBiaW5kU3ltYm9sKHN5bWJvbCwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zZXQoc3ltYm9sLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmJpbmRCbG9jayA9IGZ1bmN0aW9uIGJpbmRCbG9jayhzeW1ib2wsIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0KHN5bWJvbCwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIFNjb3BlLnByb3RvdHlwZS5iaW5kRXZhbFNjb3BlID0gZnVuY3Rpb24gYmluZEV2YWxTY29wZShtYXApIHsKICAgICAgICAgICAgdGhpcy5ldmFsU2NvcGUgPSBtYXA7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmJpbmRQYXJ0aWFsTWFwID0gZnVuY3Rpb24gYmluZFBhcnRpYWxNYXAobWFwKSB7CiAgICAgICAgICAgIHRoaXMucGFydGlhbE1hcCA9IG1hcDsKICAgICAgICB9OwoKICAgICAgICBTY29wZS5wcm90b3R5cGUuYmluZENhbGxlclNjb3BlID0gZnVuY3Rpb24gYmluZENhbGxlclNjb3BlKHNjb3BlKSB7CiAgICAgICAgICAgIHRoaXMuY2FsbGVyU2NvcGUgPSBzY29wZTsKICAgICAgICB9OwoKICAgICAgICBTY29wZS5wcm90b3R5cGUuZ2V0Q2FsbGVyU2NvcGUgPSBmdW5jdGlvbiBnZXRDYWxsZXJTY29wZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FsbGVyU2NvcGU7CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLmNoaWxkID0gZnVuY3Rpb24gY2hpbGQoKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgU2NvcGUodGhpcy5zbG90cy5zbGljZSgpLCB0aGlzLmNhbGxlclNjb3BlLCB0aGlzLmV2YWxTY29wZSwgdGhpcy5wYXJ0aWFsTWFwKTsKICAgICAgICB9OwoKICAgICAgICBTY29wZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGluZGV4KSB7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSB0aGlzLnNsb3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0JVRzogY2Fubm90IGdldCAkJyArIGluZGV4ICsgJyBmcm9tIHNjb3BlOyBsZW5ndGg9JyArIHRoaXMuc2xvdHMubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5zbG90c1tpbmRleF07CiAgICAgICAgfTsKCiAgICAgICAgU2NvcGUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIHNldChpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGluZGV4ID49IHRoaXMuc2xvdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQlVHOiBjYW5ub3QgZ2V0ICQnICsgaW5kZXggKyAnIGZyb20gc2NvcGU7IGxlbmd0aD0nICsgdGhpcy5zbG90cy5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2xvdHNbaW5kZXhdID0gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFNjb3BlOwogICAgfSgpOwoKICAgIHZhciBUcmFuc2FjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBUcmFuc2FjdGlvbigpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUcmFuc2FjdGlvbik7CgogICAgICAgICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2VycyA9IFtdOwogICAgICAgICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuY3JlYXRlZENvbXBvbmVudHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVkTWFuYWdlcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy51cGRhdGVkQ29tcG9uZW50cyA9IFtdOwogICAgICAgICAgICB0aGlzLnVwZGF0ZWRNYW5hZ2VycyA9IFtdOwogICAgICAgICAgICB0aGlzLmRlc3RydWN0b3JzID0gW107CiAgICAgICAgfQoKICAgICAgICBUcmFuc2FjdGlvbi5wcm90b3R5cGUuZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKGNvbXBvbmVudCwgbWFuYWdlcikgewogICAgICAgICAgICB0aGlzLmNyZWF0ZWRDb21wb25lbnRzLnB1c2goY29tcG9uZW50KTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVkTWFuYWdlcnMucHVzaChtYW5hZ2VyKTsKICAgICAgICB9OwoKICAgICAgICBUcmFuc2FjdGlvbi5wcm90b3R5cGUuZGlkVXBkYXRlID0gZnVuY3Rpb24gZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcikgewogICAgICAgICAgICB0aGlzLnVwZGF0ZWRDb21wb25lbnRzLnB1c2goY29tcG9uZW50KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVkTWFuYWdlcnMucHVzaChtYW5hZ2VyKTsKICAgICAgICB9OwoKICAgICAgICBUcmFuc2FjdGlvbi5wcm90b3R5cGUuc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcikgewogICAgICAgICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2Vycy5wdXNoKG1hbmFnZXIpOwogICAgICAgICAgICB0aGlzLnNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMucHVzaChtb2RpZmllcik7CiAgICAgICAgfTsKCiAgICAgICAgVHJhbnNhY3Rpb24ucHJvdG90eXBlLnNjaGVkdWxlVXBkYXRlTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZVVwZGF0ZU1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJNYW5hZ2Vycy5wdXNoKG1hbmFnZXIpOwogICAgICAgICAgICB0aGlzLnNjaGVkdWxlZFVwZGF0ZU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgICB9OwoKICAgICAgICBUcmFuc2FjdGlvbi5wcm90b3R5cGUuZGlkRGVzdHJveSA9IGZ1bmN0aW9uIGRpZERlc3Ryb3koZCkgewogICAgICAgICAgICB0aGlzLmRlc3RydWN0b3JzLnB1c2goZCk7CiAgICAgICAgfTsKCiAgICAgICAgVHJhbnNhY3Rpb24ucHJvdG90eXBlLmNvbW1pdCA9IGZ1bmN0aW9uIGNvbW1pdCgpIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZWRDb21wb25lbnRzID0gdGhpcy5jcmVhdGVkQ29tcG9uZW50cywKICAgICAgICAgICAgICAgIGNyZWF0ZWRNYW5hZ2VycyA9IHRoaXMuY3JlYXRlZE1hbmFnZXJzOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjcmVhdGVkQ29tcG9uZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IGNyZWF0ZWRDb21wb25lbnRzW2ldOwogICAgICAgICAgICAgICAgdmFyIG1hbmFnZXIgPSBjcmVhdGVkTWFuYWdlcnNbaV07CiAgICAgICAgICAgICAgICBtYW5hZ2VyLmRpZENyZWF0ZShjb21wb25lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1cGRhdGVkQ29tcG9uZW50cyA9IHRoaXMudXBkYXRlZENvbXBvbmVudHMsCiAgICAgICAgICAgICAgICB1cGRhdGVkTWFuYWdlcnMgPSB0aGlzLnVwZGF0ZWRNYW5hZ2VyczsKCiAgICAgICAgICAgIGZvciAodmFyIF9pNCA9IDA7IF9pNCA8IHVwZGF0ZWRDb21wb25lbnRzLmxlbmd0aDsgX2k0KyspIHsKICAgICAgICAgICAgICAgIHZhciBfY29tcG9uZW50ID0gdXBkYXRlZENvbXBvbmVudHNbX2k0XTsKICAgICAgICAgICAgICAgIHZhciBfbWFuYWdlcjIgPSB1cGRhdGVkTWFuYWdlcnNbX2k0XTsKICAgICAgICAgICAgICAgIF9tYW5hZ2VyMi5kaWRVcGRhdGUoX2NvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gdGhpcy5kZXN0cnVjdG9yczsKCiAgICAgICAgICAgIGZvciAodmFyIF9pNSA9IDA7IF9pNSA8IGRlc3RydWN0b3JzLmxlbmd0aDsgX2k1KyspIHsKICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzW19pNV0uZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMgPSB0aGlzLnNjaGVkdWxlZEluc3RhbGxNYW5hZ2VycywKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnMgPSB0aGlzLnNjaGVkdWxlZEluc3RhbGxNb2RpZmllcnM7CgogICAgICAgICAgICBmb3IgKHZhciBfaTYgPSAwOyBfaTYgPCBzY2hlZHVsZWRJbnN0YWxsTWFuYWdlcnMubGVuZ3RoOyBfaTYrKykgewogICAgICAgICAgICAgICAgdmFyIF9tYW5hZ2VyMyA9IHNjaGVkdWxlZEluc3RhbGxNYW5hZ2Vyc1tfaTZdOwogICAgICAgICAgICAgICAgdmFyIG1vZGlmaWVyID0gc2NoZWR1bGVkSW5zdGFsbE1vZGlmaWVyc1tfaTZdOwogICAgICAgICAgICAgICAgX21hbmFnZXIzLmluc3RhbGwobW9kaWZpZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzID0gdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLAogICAgICAgICAgICAgICAgc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJzID0gdGhpcy5zY2hlZHVsZWRVcGRhdGVNb2RpZmllcnM7CgogICAgICAgICAgICBmb3IgKHZhciBfaTcgPSAwOyBfaTcgPCBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzLmxlbmd0aDsgX2k3KyspIHsKICAgICAgICAgICAgICAgIHZhciBfbWFuYWdlcjQgPSBzY2hlZHVsZWRVcGRhdGVNb2RpZmllck1hbmFnZXJzW19pN107CiAgICAgICAgICAgICAgICB2YXIgX21vZGlmaWVyID0gc2NoZWR1bGVkVXBkYXRlTW9kaWZpZXJzW19pN107CiAgICAgICAgICAgICAgICBfbWFuYWdlcjQudXBkYXRlKF9tb2RpZmllcik7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gVHJhbnNhY3Rpb247CiAgICB9KCk7CgogICAgdmFyIEVudmlyb25tZW50ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEVudmlyb25tZW50KF9yZWY1NSkgewogICAgICAgICAgICB2YXIgYXBwZW5kT3BlcmF0aW9ucyA9IF9yZWY1NS5hcHBlbmRPcGVyYXRpb25zLAogICAgICAgICAgICAgICAgdXBkYXRlT3BlcmF0aW9ucyA9IF9yZWY1NS51cGRhdGVPcGVyYXRpb25zOwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEVudmlyb25tZW50KTsKCiAgICAgICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hcHBlbmRPcGVyYXRpb25zID0gYXBwZW5kT3BlcmF0aW9uczsKICAgICAgICAgICAgdGhpcy51cGRhdGVPcGVyYXRpb25zID0gdXBkYXRlT3BlcmF0aW9uczsKICAgICAgICB9CgogICAgICAgIEVudmlyb25tZW50LnByb3RvdHlwZS50b0NvbmRpdGlvbmFsUmVmZXJlbmNlID0gZnVuY3Rpb24gdG9Db25kaXRpb25hbFJlZmVyZW5jZShyZWZlcmVuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBDb25kaXRpb25hbFJlZmVyZW5jZShyZWZlcmVuY2UpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50LnByb3RvdHlwZS5nZXRBcHBlbmRPcGVyYXRpb25zID0gZnVuY3Rpb24gZ2V0QXBwZW5kT3BlcmF0aW9ucygpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kT3BlcmF0aW9uczsKICAgICAgICB9OwoKICAgICAgICBFbnZpcm9ubWVudC5wcm90b3R5cGUuZ2V0RE9NID0gZnVuY3Rpb24gZ2V0RE9NKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVPcGVyYXRpb25zOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50LnByb3RvdHlwZS5iZWdpbiA9IGZ1bmN0aW9uIGJlZ2luKCkgewoKICAgICAgICAgICAgdGhpcy5fdHJhbnNhY3Rpb24gPSBuZXcgVHJhbnNhY3Rpb24oKTsKICAgICAgICB9OwoKICAgICAgICBFbnZpcm9ubWVudC5wcm90b3R5cGUuZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKGNvbXBvbmVudCwgbWFuYWdlcikgewogICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uLmRpZENyZWF0ZShjb21wb25lbnQsIG1hbmFnZXIpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50LnByb3RvdHlwZS5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoY29tcG9uZW50LCBtYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24uZGlkVXBkYXRlKGNvbXBvbmVudCwgbWFuYWdlcik7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQucHJvdG90eXBlLnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyID0gZnVuY3Rpb24gc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpIHsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi5zY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQucHJvdG90eXBlLnNjaGVkdWxlVXBkYXRlTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZVVwZGF0ZU1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKSB7CiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24uc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQucHJvdG90eXBlLmRpZERlc3Ryb3kgPSBmdW5jdGlvbiBkaWREZXN0cm95KGQpIHsKICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi5kaWREZXN0cm95KGQpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50LnByb3RvdHlwZS5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoKSB7CiAgICAgICAgICAgIHZhciB0cmFuc2FjdGlvbiA9IHRoaXMudHJhbnNhY3Rpb247CiAgICAgICAgICAgIHRoaXMuX3RyYW5zYWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgdHJhbnNhY3Rpb24uY29tbWl0KCk7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQucHJvdG90eXBlLmF0dHJpYnV0ZUZvciA9IGZ1bmN0aW9uIGF0dHJpYnV0ZUZvcihlbGVtZW50LCBhdHRyLCBfaXNUcnVzdGluZykgewogICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBudWxsOwoKICAgICAgICAgICAgcmV0dXJuIGR5bmFtaWNBdHRyaWJ1dGUoZWxlbWVudCwgYXR0ciwgbmFtZXNwYWNlKTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEVudmlyb25tZW50LCBbewogICAgICAgICAgICBrZXk6ICd0cmFuc2FjdGlvbicsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBFbnZpcm9ubWVudDsKICAgIH0oKTsKCiAgICB2YXIgRGVmYXVsdEVudmlyb25tZW50ID0gZnVuY3Rpb24gKF9FbnZpcm9ubWVudCkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRGVmYXVsdEVudmlyb25tZW50LCBfRW52aXJvbm1lbnQpOwoKICAgICAgICBmdW5jdGlvbiBEZWZhdWx0RW52aXJvbm1lbnQob3B0aW9ucykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlZmF1bHRFbnZpcm9ubWVudCk7CgogICAgICAgICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciBfZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgICAgICAgICB2YXIgYXBwZW5kT3BlcmF0aW9ucyA9IG5ldyBET01UcmVlQ29uc3RydWN0aW9uKF9kb2N1bWVudCk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlT3BlcmF0aW9ucyA9IG5ldyBET01DaGFuZ2VzKF9kb2N1bWVudCk7CiAgICAgICAgICAgICAgICBvcHRpb25zID0geyBhcHBlbmRPcGVyYXRpb25zOiBhcHBlbmRPcGVyYXRpb25zLCB1cGRhdGVPcGVyYXRpb25zOiB1cGRhdGVPcGVyYXRpb25zIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRW52aXJvbm1lbnQuY2FsbCh0aGlzLCBvcHRpb25zKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gRGVmYXVsdEVudmlyb25tZW50OwogICAgfShFbnZpcm9ubWVudCk7CgogICAgdmFyIExvd0xldmVsVk0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTG93TGV2ZWxWTShzdGFjaywgaGVhcCwgcHJvZ3JhbSwgZXh0ZXJucykgewogICAgICAgICAgICB2YXIgcGMgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1s0XSA6IC0xOwogICAgICAgICAgICB2YXIgcmEgPSBhcmd1bWVudHMubGVuZ3RoID4gNSAmJiBhcmd1bWVudHNbNV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1s1XSA6IC0xOwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIExvd0xldmVsVk0pOwoKICAgICAgICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICAgICAgICB0aGlzLmhlYXAgPSBoZWFwOwogICAgICAgICAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwogICAgICAgICAgICB0aGlzLmV4dGVybnMgPSBleHRlcm5zOwogICAgICAgICAgICB0aGlzLnBjID0gcGM7CiAgICAgICAgICAgIHRoaXMucmEgPSByYTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50T3BTaXplID0gMDsKICAgICAgICB9CiAgICAgICAgLy8gU3RhcnQgYSBuZXcgZnJhbWUgYW5kIHNhdmUgJHJhIGFuZCAkZnAgb24gdGhlIHN0YWNrCgoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5wdXNoRnJhbWUgPSBmdW5jdGlvbiBwdXNoRnJhbWUoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sucHVzaFNtaSh0aGlzLnJhKTsKICAgICAgICAgICAgdGhpcy5zdGFjay5wdXNoU21pKHRoaXMuc3RhY2suZnApOwogICAgICAgICAgICB0aGlzLnN0YWNrLmZwID0gdGhpcy5zdGFjay5zcCAtIDE7CiAgICAgICAgfTsKCiAgICAgICAgTG93TGV2ZWxWTS5wcm90b3R5cGUucG9wRnJhbWUgPSBmdW5jdGlvbiBwb3BGcmFtZSgpIHsKICAgICAgICAgICAgdGhpcy5zdGFjay5zcCA9IHRoaXMuc3RhY2suZnAgLSAxOwogICAgICAgICAgICB0aGlzLnJhID0gdGhpcy5zdGFjay5nZXRTbWkoMCk7CiAgICAgICAgICAgIHRoaXMuc3RhY2suZnAgPSB0aGlzLnN0YWNrLmdldFNtaSgxKTsKICAgICAgICB9OwoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5wdXNoU21hbGxGcmFtZSA9IGZ1bmN0aW9uIHB1c2hTbWFsbEZyYW1lKCkgewogICAgICAgICAgICB0aGlzLnN0YWNrLnB1c2hTbWkodGhpcy5yYSk7CiAgICAgICAgfTsKCiAgICAgICAgTG93TGV2ZWxWTS5wcm90b3R5cGUucG9wU21hbGxGcmFtZSA9IGZ1bmN0aW9uIHBvcFNtYWxsRnJhbWUoKSB7CiAgICAgICAgICAgIHRoaXMucmEgPSB0aGlzLnN0YWNrLnBvcFNtaSgpOwogICAgICAgIH07CgogICAgICAgIExvd0xldmVsVk0ucHJvdG90eXBlLmdvdG8gPSBmdW5jdGlvbiBnb3RvKG9mZnNldCkgewogICAgICAgICAgICB2YXIgYWRkciA9IHRoaXMucGMgKyBvZmZzZXQgLSB0aGlzLmN1cnJlbnRPcFNpemU7CiAgICAgICAgICAgIHRoaXMucGMgPSBhZGRyOwogICAgICAgIH07CgogICAgICAgIExvd0xldmVsVk0ucHJvdG90eXBlLmNhbGwgPSBmdW5jdGlvbiBjYWxsKGhhbmRsZSkgewogICAgICAgICAgICB0aGlzLnJhID0gdGhpcy5wYzsKICAgICAgICAgICAgdGhpcy5wYyA9IHRoaXMuaGVhcC5nZXRhZGRyKGhhbmRsZSk7CiAgICAgICAgfTsKCiAgICAgICAgTG93TGV2ZWxWTS5wcm90b3R5cGUucmV0dXJuVG8gPSBmdW5jdGlvbiByZXR1cm5UbyhvZmZzZXQpIHsKICAgICAgICAgICAgdmFyIGFkZHIgPSB0aGlzLnBjICsgb2Zmc2V0IC0gdGhpcy5jdXJyZW50T3BTaXplOwogICAgICAgICAgICB0aGlzLnJhID0gYWRkcjsKICAgICAgICB9OwoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5yZXR1cm4gPSBmdW5jdGlvbiBfcmV0dXJuKCkgewogICAgICAgICAgICB0aGlzLnBjID0gdGhpcy5yYTsKICAgICAgICB9OwoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5uZXh0U3RhdGVtZW50ID0gZnVuY3Rpb24gbmV4dFN0YXRlbWVudCgpIHsKICAgICAgICAgICAgdmFyIHBjID0gdGhpcy5wYywKICAgICAgICAgICAgICAgIHByb2dyYW0gPSB0aGlzLnByb2dyYW07CgogICAgICAgICAgICBpZiAocGMgPT09IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBXZSBoYXZlIHRvIHNhdmUgb2ZmIHRoZSBjdXJyZW50IG9wZXJhdGlvbnMgc2l6ZSBzbyB0aGF0CiAgICAgICAgICAgIC8vIHdoZW4gd2UgZG8gYSBqdW1wIHdlIGNhbiBjYWxjdWxhdGUgdGhlIGNvcnJlY3Qgb2Zmc2V0CiAgICAgICAgICAgIC8vIHRvIHdoZXJlIHdlIGFyZSBnb2luZy4gV2UgY2FuJ3Qgc2ltcGx5IGFzayBmb3IgdGhlIHNpemUKICAgICAgICAgICAgLy8gaW4gYSBqdW1wIGJlY2F1c2Ugd2UgaGF2ZSBoYXZlIGFscmVhZHkgaW5jcmVtZW50ZWQgdGhlCiAgICAgICAgICAgIC8vIHByb2dyYW0gY291bnRlciB0byB0aGUgbmV4dCBpbnN0cnVjdGlvbiBwcmlvciB0byBleGVjdXRpbmcuCgogICAgICAgICAgICB2YXIgX3Byb2dyYW0kb3Bjb2RlID0gdGhpcy5wcm9ncmFtLm9wY29kZShwYyksCiAgICAgICAgICAgICAgICBzaXplID0gX3Byb2dyYW0kb3Bjb2RlLnNpemU7CgogICAgICAgICAgICB2YXIgb3BlcmF0aW9uU2l6ZSA9IHRoaXMuY3VycmVudE9wU2l6ZSA9IHNpemU7CiAgICAgICAgICAgIHRoaXMucGMgKz0gb3BlcmF0aW9uU2l6ZTsKICAgICAgICAgICAgcmV0dXJuIHByb2dyYW0ub3Bjb2RlKHBjKTsKICAgICAgICB9OwoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5ldmFsdWF0ZU91dGVyID0gZnVuY3Rpb24gZXZhbHVhdGVPdXRlcihvcGNvZGUsIHZtKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdGVJbm5lcihvcGNvZGUsIHZtKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIExvd0xldmVsVk0ucHJvdG90eXBlLmV2YWx1YXRlSW5uZXIgPSBmdW5jdGlvbiBldmFsdWF0ZUlubmVyKG9wY29kZSwgdm0pIHsKICAgICAgICAgICAgaWYgKG9wY29kZS5pc01hY2hpbmUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZhbHVhdGVNYWNoaW5lKG9wY29kZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmV2YWx1YXRlU3lzY2FsbChvcGNvZGUsIHZtKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIExvd0xldmVsVk0ucHJvdG90eXBlLmV2YWx1YXRlTWFjaGluZSA9IGZ1bmN0aW9uIGV2YWx1YXRlTWFjaGluZShvcGNvZGUpIHsKICAgICAgICAgICAgc3dpdGNoIChvcGNvZGUudHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSA1NyAvKiBQdXNoRnJhbWUgKi86CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaEZyYW1lKCk7CiAgICAgICAgICAgICAgICBjYXNlIDU4IC8qIFBvcEZyYW1lICovOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBvcEZyYW1lKCk7CiAgICAgICAgICAgICAgICBjYXNlIDU5IC8qIFB1c2hTbWFsbEZyYW1lICovOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hTbWFsbEZyYW1lKCk7CiAgICAgICAgICAgICAgICBjYXNlIDYwIC8qIFBvcFNtYWxsRnJhbWUgKi86CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9wU21hbGxGcmFtZSgpOwogICAgICAgICAgICAgICAgY2FzZSA1MCAvKiBJbnZva2VTdGF0aWMgKi86CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FsbChvcGNvZGUub3AxKTsKICAgICAgICAgICAgICAgIGNhc2UgNDkgLyogSW52b2tlVmlydHVhbCAqLzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYWxsKHRoaXMuc3RhY2sucG9wU21pKCkpOwogICAgICAgICAgICAgICAgY2FzZSA1MiAvKiBKdW1wICovOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdvdG8ob3Bjb2RlLm9wMSk7CiAgICAgICAgICAgICAgICBjYXNlIDI0IC8qIFJldHVybiAqLzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXR1cm4oKTsKICAgICAgICAgICAgICAgIGNhc2UgMjUgLyogUmV0dXJuVG8gKi86CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmV0dXJuVG8ob3Bjb2RlLm9wMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBMb3dMZXZlbFZNLnByb3RvdHlwZS5ldmFsdWF0ZVN5c2NhbGwgPSBmdW5jdGlvbiBldmFsdWF0ZVN5c2NhbGwob3Bjb2RlLCB2bSkgewogICAgICAgICAgICBBUFBFTkRfT1BDT0RFUy5ldmFsdWF0ZSh2bSwgb3Bjb2RlLCBvcGNvZGUudHlwZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIExvd0xldmVsVk07CiAgICB9KCk7CgogICAgdmFyIEZpcnN0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEZpcnN0KG5vZGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBGaXJzdCk7CgogICAgICAgICAgICB0aGlzLm5vZGUgPSBub2RlOwogICAgICAgIH0KCiAgICAgICAgRmlyc3QucHJvdG90eXBlLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRmlyc3Q7CiAgICB9KCk7CgogICAgdmFyIExhc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTGFzdChub2RlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTGFzdCk7CgogICAgICAgICAgICB0aGlzLm5vZGUgPSBub2RlOwogICAgICAgIH0KCiAgICAgICAgTGFzdC5wcm90b3R5cGUubGFzdE5vZGUgPSBmdW5jdGlvbiBsYXN0Tm9kZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9kZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGFzdDsKICAgIH0oKTsKCiAgICB2YXIgTmV3RWxlbWVudEJ1aWxkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTmV3RWxlbWVudEJ1aWxkZXIoZW52LCBwYXJlbnROb2RlLCBuZXh0U2libGluZykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE5ld0VsZW1lbnRCdWlsZGVyKTsKCiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0aW5nID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5vcGVyYXRpb25zID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jdXJzb3JTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICAgICAgICB0aGlzLmJsb2NrU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgICAgICAgdGhpcy5wdXNoRWxlbWVudChwYXJlbnROb2RlLCBuZXh0U2libGluZyk7CiAgICAgICAgICAgIHRoaXMuZW52ID0gZW52OwogICAgICAgICAgICB0aGlzLmRvbSA9IGVudi5nZXRBcHBlbmRPcGVyYXRpb25zKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlT3BlcmF0aW9ucyA9IGVudi5nZXRET00oKTsKICAgICAgICB9CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIgPSBmdW5jdGlvbiBmb3JJbml0aWFsUmVuZGVyKGVudiwgY3Vyc29yKSB7CiAgICAgICAgICAgIHZhciBidWlsZGVyID0gbmV3IHRoaXMoZW52LCBjdXJzb3IuZWxlbWVudCwgY3Vyc29yLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgYnVpbGRlci5wdXNoU2ltcGxlQmxvY2soKTsKICAgICAgICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucmVzdW1lID0gZnVuY3Rpb24gcmVzdW1lKGVudiwgdHJhY2tlciwgbmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0cmFja2VyLnBhcmVudEVsZW1lbnQoKTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gbmV3IHRoaXMoZW52LCBwYXJlbnROb2RlLCBuZXh0U2libGluZyk7CiAgICAgICAgICAgIHN0YWNrLnB1c2hTaW1wbGVCbG9jaygpOwogICAgICAgICAgICBzdGFjay5wdXNoQmxvY2tUcmFja2VyKHRyYWNrZXIpOwogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLmV4cGVjdENvbnN0cnVjdGluZyA9IGZ1bmN0aW9uIGV4cGVjdENvbnN0cnVjdGluZyhtZXRob2QpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0aW5nOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5ibG9jayA9IGZ1bmN0aW9uIGJsb2NrKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ibG9ja1N0YWNrLmN1cnJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLnBvcEVsZW1lbnQgPSBmdW5jdGlvbiBwb3BFbGVtZW50KCkgewogICAgICAgICAgICB0aGlzLmN1cnNvclN0YWNrLnBvcCgpOwogICAgICAgICAgICB0aGlzLmN1cnNvclN0YWNrLmN1cnJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLnB1c2hTaW1wbGVCbG9jayA9IGZ1bmN0aW9uIHB1c2hTaW1wbGVCbG9jaygpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHVzaEJsb2NrVHJhY2tlcihuZXcgU2ltcGxlQmxvY2tUcmFja2VyKHRoaXMuZWxlbWVudCkpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5wdXNoVXBkYXRhYmxlQmxvY2sgPSBmdW5jdGlvbiBwdXNoVXBkYXRhYmxlQmxvY2soKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnB1c2hCbG9ja1RyYWNrZXIobmV3IFVwZGF0YWJsZUJsb2NrVHJhY2tlcih0aGlzLmVsZW1lbnQpKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUucHVzaEJsb2NrTGlzdCA9IGZ1bmN0aW9uIHB1c2hCbG9ja0xpc3QobGlzdCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wdXNoQmxvY2tUcmFja2VyKG5ldyBCbG9ja0xpc3RUcmFja2VyKHRoaXMuZWxlbWVudCwgbGlzdCkpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5wdXNoQmxvY2tUcmFja2VyID0gZnVuY3Rpb24gcHVzaEJsb2NrVHJhY2tlcih0cmFja2VyKSB7CiAgICAgICAgICAgIHZhciBpc1JlbW90ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogZmFsc2U7CgogICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuYmxvY2tTdGFjay5jdXJyZW50OwogICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY3VycmVudC5uZXdEZXN0cm95YWJsZSh0cmFja2VyKTsKICAgICAgICAgICAgICAgIGlmICghaXNSZW1vdGUpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50LmRpZEFwcGVuZEJvdW5kcyh0cmFja2VyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9fb3BlbkJsb2NrKCk7CiAgICAgICAgICAgIHRoaXMuYmxvY2tTdGFjay5wdXNoKHRyYWNrZXIpOwogICAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUucG9wQmxvY2sgPSBmdW5jdGlvbiBwb3BCbG9jaygpIHsKICAgICAgICAgICAgdGhpcy5ibG9jaygpLmZpbmFsaXplKHRoaXMpOwogICAgICAgICAgICB0aGlzLl9fY2xvc2VCbG9jaygpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5ibG9ja1N0YWNrLnBvcCgpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX29wZW5CbG9jayA9IGZ1bmN0aW9uIF9fb3BlbkJsb2NrKCkge307CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2Nsb3NlQmxvY2sgPSBmdW5jdGlvbiBfX2Nsb3NlQmxvY2soKSB7fTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLm9wZW5FbGVtZW50ID0gZnVuY3Rpb24gb3BlbkVsZW1lbnQodGFnKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fX29wZW5FbGVtZW50KHRhZyk7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0aW5nID0gZWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fb3BlbkVsZW1lbnQgPSBmdW5jdGlvbiBfX29wZW5FbGVtZW50KHRhZykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb20uY3JlYXRlRWxlbWVudCh0YWcsIHRoaXMuZWxlbWVudCk7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLmZsdXNoRWxlbWVudCA9IGZ1bmN0aW9uIGZsdXNoRWxlbWVudCgpIHsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmNvbnN0cnVjdGluZzsKICAgICAgICAgICAgdGhpcy5fX2ZsdXNoRWxlbWVudChwYXJlbnQsIGVsZW1lbnQpOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdGluZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMub3BlcmF0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucHVzaEVsZW1lbnQoZWxlbWVudCwgbnVsbCk7CiAgICAgICAgICAgIHRoaXMuZGlkT3BlbkVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fZmx1c2hFbGVtZW50ID0gZnVuY3Rpb24gX19mbHVzaEVsZW1lbnQocGFyZW50LCBjb25zdHJ1Y3RpbmcpIHsKICAgICAgICAgICAgdGhpcy5kb20uaW5zZXJ0QmVmb3JlKHBhcmVudCwgY29uc3RydWN0aW5nLCB0aGlzLm5leHRTaWJsaW5nKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuY2xvc2VFbGVtZW50ID0gZnVuY3Rpb24gY2xvc2VFbGVtZW50KCkgewogICAgICAgICAgICB0aGlzLndpbGxDbG9zZUVsZW1lbnQoKTsKICAgICAgICAgICAgdGhpcy5wb3BFbGVtZW50KCk7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLnB1c2hSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gcHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgZ3VpZCkgewogICAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IG51bGw7CgogICAgICAgICAgICB0aGlzLl9fcHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgZ3VpZCwgbmV4dFNpYmxpbmcpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX3B1c2hSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gX19wdXNoUmVtb3RlRWxlbWVudChlbGVtZW50LCBfZ3VpZCwgbmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdGhpcy5wdXNoRWxlbWVudChlbGVtZW50LCBuZXh0U2libGluZyk7CiAgICAgICAgICAgIHZhciB0cmFja2VyID0gbmV3IFJlbW90ZUJsb2NrVHJhY2tlcihlbGVtZW50KTsKICAgICAgICAgICAgdGhpcy5wdXNoQmxvY2tUcmFja2VyKHRyYWNrZXIsIHRydWUpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5wb3BSZW1vdGVFbGVtZW50ID0gZnVuY3Rpb24gcG9wUmVtb3RlRWxlbWVudCgpIHsKICAgICAgICAgICAgdGhpcy5wb3BCbG9jaygpOwogICAgICAgICAgICB0aGlzLnBvcEVsZW1lbnQoKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUucHVzaEVsZW1lbnQgPSBmdW5jdGlvbiBwdXNoRWxlbWVudChlbGVtZW50LCBuZXh0U2libGluZykgewogICAgICAgICAgICB0aGlzLmN1cnNvclN0YWNrLnB1c2gobmV3IEN1cnNvcihlbGVtZW50LCBuZXh0U2libGluZykpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5kaWRBZGREZXN0cm95YWJsZSA9IGZ1bmN0aW9uIGRpZEFkZERlc3Ryb3lhYmxlKGQpIHsKICAgICAgICAgICAgdGhpcy5ibG9jaygpLm5ld0Rlc3Ryb3lhYmxlKGQpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5kaWRBcHBlbmRCb3VuZHMgPSBmdW5jdGlvbiBkaWRBcHBlbmRCb3VuZHMoYm91bmRzJCQxKSB7CiAgICAgICAgICAgIHRoaXMuYmxvY2soKS5kaWRBcHBlbmRCb3VuZHMoYm91bmRzJCQxKTsKICAgICAgICAgICAgcmV0dXJuIGJvdW5kcyQkMTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuZGlkQXBwZW5kTm9kZSA9IGZ1bmN0aW9uIGRpZEFwcGVuZE5vZGUobm9kZSkgewogICAgICAgICAgICB0aGlzLmJsb2NrKCkuZGlkQXBwZW5kTm9kZShub2RlKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLmRpZE9wZW5FbGVtZW50ID0gZnVuY3Rpb24gZGlkT3BlbkVsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgICB0aGlzLmJsb2NrKCkub3BlbkVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS53aWxsQ2xvc2VFbGVtZW50ID0gZnVuY3Rpb24gd2lsbENsb3NlRWxlbWVudCgpIHsKICAgICAgICAgICAgdGhpcy5ibG9jaygpLmNsb3NlRWxlbWVudCgpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5hcHBlbmRUZXh0ID0gZnVuY3Rpb24gYXBwZW5kVGV4dChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlkQXBwZW5kTm9kZSh0aGlzLl9fYXBwZW5kVGV4dChzdHJpbmcpKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRUZXh0ID0gZnVuY3Rpb24gX19hcHBlbmRUZXh0KHRleHQpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tLAogICAgICAgICAgICAgICAgZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKICAgICAgICAgICAgICAgIG5leHRTaWJsaW5nID0gdGhpcy5uZXh0U2libGluZzsKCiAgICAgICAgICAgIHZhciBub2RlID0gZG9tLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgICAgICBkb20uaW5zZXJ0QmVmb3JlKGVsZW1lbnQsIG5vZGUsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kTm9kZSA9IGZ1bmN0aW9uIF9fYXBwZW5kTm9kZShub2RlKSB7CiAgICAgICAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZSh0aGlzLmVsZW1lbnQsIG5vZGUsIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRGcmFnbWVudCA9IGZ1bmN0aW9uIF9fYXBwZW5kRnJhZ21lbnQoZnJhZ21lbnQpIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0KSB7CiAgICAgICAgICAgICAgICB2YXIgcmV0ID0gYm91bmRzKHRoaXMuZWxlbWVudCwgZmlyc3QsIGZyYWdtZW50Lmxhc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUodGhpcy5lbGVtZW50LCBmcmFnbWVudCwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHNpbmdsZSh0aGlzLmVsZW1lbnQsIHRoaXMuX19hcHBlbmRDb21tZW50KCcnKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRIVE1MID0gZnVuY3Rpb24gX19hcHBlbmRIVE1MKGh0bWwpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tLmluc2VydEhUTUxCZWZvcmUodGhpcy5lbGVtZW50LCB0aGlzLm5leHRTaWJsaW5nLCBodG1sKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuYXBwZW5kRHluYW1pY0hUTUwgPSBmdW5jdGlvbiBhcHBlbmREeW5hbWljSFRNTCh2YWx1ZSkgewogICAgICAgICAgICB2YXIgYm91bmRzJCQxID0gdGhpcy50cnVzdGVkQ29udGVudCh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuZGlkQXBwZW5kQm91bmRzKGJvdW5kcyQkMSk7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLmFwcGVuZER5bmFtaWNUZXh0ID0gZnVuY3Rpb24gYXBwZW5kRHluYW1pY1RleHQodmFsdWUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLnVudHJ1c3RlZENvbnRlbnQodmFsdWUpOwogICAgICAgICAgICB0aGlzLmRpZEFwcGVuZE5vZGUobm9kZSk7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5hcHBlbmREeW5hbWljRnJhZ21lbnQgPSBmdW5jdGlvbiBhcHBlbmREeW5hbWljRnJhZ21lbnQodmFsdWUpIHsKICAgICAgICAgICAgdmFyIGJvdW5kcyQkMSA9IHRoaXMuX19hcHBlbmRGcmFnbWVudCh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuZGlkQXBwZW5kQm91bmRzKGJvdW5kcyQkMSk7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLmFwcGVuZER5bmFtaWNOb2RlID0gZnVuY3Rpb24gYXBwZW5kRHluYW1pY05vZGUodmFsdWUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLl9fYXBwZW5kTm9kZSh2YWx1ZSk7CiAgICAgICAgICAgIHZhciBib3VuZHMkJDEgPSBzaW5nbGUodGhpcy5lbGVtZW50LCBub2RlKTsKICAgICAgICAgICAgdGhpcy5kaWRBcHBlbmRCb3VuZHMoYm91bmRzJCQxKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUudHJ1c3RlZENvbnRlbnQgPSBmdW5jdGlvbiB0cnVzdGVkQ29udGVudCh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2FwcGVuZEhUTUwodmFsdWUpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS51bnRydXN0ZWRDb250ZW50ID0gZnVuY3Rpb24gdW50cnVzdGVkQ29udGVudCh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX2FwcGVuZFRleHQodmFsdWUpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5hcHBlbmRDb21tZW50ID0gZnVuY3Rpb24gYXBwZW5kQ29tbWVudChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlkQXBwZW5kTm9kZSh0aGlzLl9fYXBwZW5kQ29tbWVudChzdHJpbmcpKTsKICAgICAgICB9OwoKICAgICAgICBOZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRDb21tZW50ID0gZnVuY3Rpb24gX19hcHBlbmRDb21tZW50KHN0cmluZykgewogICAgICAgICAgICB2YXIgZG9tID0gdGhpcy5kb20sCiAgICAgICAgICAgICAgICBlbGVtZW50ID0gdGhpcy5lbGVtZW50LAogICAgICAgICAgICAgICAgbmV4dFNpYmxpbmcgPSB0aGlzLm5leHRTaWJsaW5nOwoKICAgICAgICAgICAgdmFyIG5vZGUgPSBkb20uY3JlYXRlQ29tbWVudChzdHJpbmcpOwogICAgICAgICAgICBkb20uaW5zZXJ0QmVmb3JlKGVsZW1lbnQsIG5vZGUsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fc2V0QXR0cmlidXRlID0gZnVuY3Rpb24gX19zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG5hbWVzcGFjZSkgewogICAgICAgICAgICB0aGlzLmRvbS5zZXRBdHRyaWJ1dGUodGhpcy5jb25zdHJ1Y3RpbmcsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX3NldFByb3BlcnR5ID0gZnVuY3Rpb24gX19zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdGluZ1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5zZXRTdGF0aWNBdHRyaWJ1dGUgPSBmdW5jdGlvbiBzZXRTdGF0aWNBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG5hbWVzcGFjZSkgewogICAgICAgICAgICB0aGlzLl9fc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpOwogICAgICAgIH07CgogICAgICAgIE5ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5zZXREeW5hbWljQXR0cmlidXRlID0gZnVuY3Rpb24gc2V0RHluYW1pY0F0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgdHJ1c3RpbmcsIG5hbWVzcGFjZSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuY29uc3RydWN0aW5nOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlID0gdGhpcy5lbnYuYXR0cmlidXRlRm9yKGVsZW1lbnQsIG5hbWUsIHRydXN0aW5nLCBuYW1lc3BhY2UpOwogICAgICAgICAgICBhdHRyaWJ1dGUuc2V0KHRoaXMsIHZhbHVlLCB0aGlzLmVudik7CiAgICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGU7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShOZXdFbGVtZW50QnVpbGRlciwgW3sKICAgICAgICAgICAga2V5OiAnZWxlbWVudCcsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yU3RhY2suY3VycmVudC5lbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICduZXh0U2libGluZycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3Vyc29yU3RhY2suY3VycmVudC5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gTmV3RWxlbWVudEJ1aWxkZXI7CiAgICB9KCk7CgogICAgdmFyIFNpbXBsZUJsb2NrVHJhY2tlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBTaW1wbGVCbG9ja1RyYWNrZXIocGFyZW50KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU2ltcGxlQmxvY2tUcmFja2VyKTsKCiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLmZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kZXN0cm95YWJsZXMgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5lc3RpbmcgPSAwOwogICAgICAgIH0KCiAgICAgICAgU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgdmFyIGRlc3Ryb3lhYmxlcyA9IHRoaXMuZGVzdHJveWFibGVzOwoKICAgICAgICAgICAgaWYgKGRlc3Ryb3lhYmxlcyAmJiBkZXN0cm95YWJsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlc3Ryb3lhYmxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lhYmxlc1tpXS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBTaW1wbGVCbG9ja1RyYWNrZXIucHJvdG90eXBlLnBhcmVudEVsZW1lbnQgPSBmdW5jdGlvbiBwYXJlbnRFbGVtZW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZS5maXJzdE5vZGUgPSBmdW5jdGlvbiBmaXJzdE5vZGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpcnN0ICYmIHRoaXMuZmlyc3QuZmlyc3ROb2RlKCk7CiAgICAgICAgfTsKCiAgICAgICAgU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZS5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0ICYmIHRoaXMubGFzdC5sYXN0Tm9kZSgpOwogICAgICAgIH07CgogICAgICAgIFNpbXBsZUJsb2NrVHJhY2tlci5wcm90b3R5cGUub3BlbkVsZW1lbnQgPSBmdW5jdGlvbiBvcGVuRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICAgIHRoaXMuZGlkQXBwZW5kTm9kZShlbGVtZW50KTsKICAgICAgICAgICAgdGhpcy5uZXN0aW5nKys7CiAgICAgICAgfTsKCiAgICAgICAgU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZS5jbG9zZUVsZW1lbnQgPSBmdW5jdGlvbiBjbG9zZUVsZW1lbnQoKSB7CiAgICAgICAgICAgIHRoaXMubmVzdGluZy0tOwogICAgICAgIH07CgogICAgICAgIFNpbXBsZUJsb2NrVHJhY2tlci5wcm90b3R5cGUuZGlkQXBwZW5kTm9kZSA9IGZ1bmN0aW9uIGRpZEFwcGVuZE5vZGUobm9kZSkgewogICAgICAgICAgICBpZiAodGhpcy5uZXN0aW5nICE9PSAwKSByZXR1cm47CiAgICAgICAgICAgIGlmICghdGhpcy5maXJzdCkgewogICAgICAgICAgICAgICAgdGhpcy5maXJzdCA9IG5ldyBGaXJzdChub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxhc3QgPSBuZXcgTGFzdChub2RlKTsKICAgICAgICB9OwoKICAgICAgICBTaW1wbGVCbG9ja1RyYWNrZXIucHJvdG90eXBlLmRpZEFwcGVuZEJvdW5kcyA9IGZ1bmN0aW9uIGRpZEFwcGVuZEJvdW5kcyhib3VuZHMkJDEpIHsKICAgICAgICAgICAgaWYgKHRoaXMubmVzdGluZyAhPT0gMCkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIXRoaXMuZmlyc3QpIHsKICAgICAgICAgICAgICAgIHRoaXMuZmlyc3QgPSBib3VuZHMkJDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sYXN0ID0gYm91bmRzJCQxOwogICAgICAgIH07CgogICAgICAgIFNpbXBsZUJsb2NrVHJhY2tlci5wcm90b3R5cGUubmV3RGVzdHJveWFibGUgPSBmdW5jdGlvbiBuZXdEZXN0cm95YWJsZShkKSB7CiAgICAgICAgICAgIHRoaXMuZGVzdHJveWFibGVzID0gdGhpcy5kZXN0cm95YWJsZXMgfHwgW107CiAgICAgICAgICAgIHRoaXMuZGVzdHJveWFibGVzLnB1c2goZCk7CiAgICAgICAgfTsKCiAgICAgICAgU2ltcGxlQmxvY2tUcmFja2VyLnByb3RvdHlwZS5maW5hbGl6ZSA9IGZ1bmN0aW9uIGZpbmFsaXplKHN0YWNrKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5maXJzdCkgewogICAgICAgICAgICAgICAgc3RhY2suYXBwZW5kQ29tbWVudCgnJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gU2ltcGxlQmxvY2tUcmFja2VyOwogICAgfSgpOwoKICAgIHZhciBSZW1vdGVCbG9ja1RyYWNrZXIgPSBmdW5jdGlvbiAoX1NpbXBsZUJsb2NrVHJhY2tlcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUmVtb3RlQmxvY2tUcmFja2VyLCBfU2ltcGxlQmxvY2tUcmFja2VyKTsKCiAgICAgICAgZnVuY3Rpb24gUmVtb3RlQmxvY2tUcmFja2VyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJlbW90ZUJsb2NrVHJhY2tlcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1NpbXBsZUJsb2NrVHJhY2tlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIFJlbW90ZUJsb2NrVHJhY2tlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIF9TaW1wbGVCbG9ja1RyYWNrZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICAgICAgY2xlYXIodGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJlbW90ZUJsb2NrVHJhY2tlcjsKICAgIH0oU2ltcGxlQmxvY2tUcmFja2VyKTsKCiAgICB2YXIgVXBkYXRhYmxlQmxvY2tUcmFja2VyID0gZnVuY3Rpb24gKF9TaW1wbGVCbG9ja1RyYWNrZXIyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShVcGRhdGFibGVCbG9ja1RyYWNrZXIsIF9TaW1wbGVCbG9ja1RyYWNrZXIyKTsKCiAgICAgICAgZnVuY3Rpb24gVXBkYXRhYmxlQmxvY2tUcmFja2VyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFVwZGF0YWJsZUJsb2NrVHJhY2tlcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1NpbXBsZUJsb2NrVHJhY2tlcjIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBVcGRhdGFibGVCbG9ja1RyYWNrZXIucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoZW52KSB7CiAgICAgICAgICAgIHZhciBkZXN0cm95YWJsZXMgPSB0aGlzLmRlc3Ryb3lhYmxlczsKCiAgICAgICAgICAgIGlmIChkZXN0cm95YWJsZXMgJiYgZGVzdHJveWFibGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXN0cm95YWJsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBlbnYuZGlkRGVzdHJveShkZXN0cm95YWJsZXNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGNsZWFyKHRoaXMpOwogICAgICAgICAgICB0aGlzLmZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kZXN0cm95YWJsZXMgPSBudWxsOwogICAgICAgICAgICB0aGlzLm5lc3RpbmcgPSAwOwogICAgICAgICAgICByZXR1cm4gbmV4dFNpYmxpbmc7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFVwZGF0YWJsZUJsb2NrVHJhY2tlcjsKICAgIH0oU2ltcGxlQmxvY2tUcmFja2VyKTsKCiAgICB2YXIgQmxvY2tMaXN0VHJhY2tlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBCbG9ja0xpc3RUcmFja2VyKHBhcmVudCwgYm91bmRMaXN0KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQmxvY2tMaXN0VHJhY2tlcik7CgogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5ib3VuZExpc3QgPSBib3VuZExpc3Q7CiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLmJvdW5kTGlzdCA9IGJvdW5kTGlzdDsKICAgICAgICB9CgogICAgICAgIEJsb2NrTGlzdFRyYWNrZXIucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICB0aGlzLmJvdW5kTGlzdC5mb3JFYWNoTm9kZShmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuZGVzdHJveSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBCbG9ja0xpc3RUcmFja2VyLnByb3RvdHlwZS5wYXJlbnRFbGVtZW50ID0gZnVuY3Rpb24gcGFyZW50RWxlbWVudCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50OwogICAgICAgIH07CgogICAgICAgIEJsb2NrTGlzdFRyYWNrZXIucHJvdG90eXBlLmZpcnN0Tm9kZSA9IGZ1bmN0aW9uIGZpcnN0Tm9kZSgpIHsKICAgICAgICAgICAgdmFyIGhlYWQgPSB0aGlzLmJvdW5kTGlzdC5oZWFkKCk7CiAgICAgICAgICAgIHJldHVybiBoZWFkICYmIGhlYWQuZmlyc3ROb2RlKCk7CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tMaXN0VHJhY2tlci5wcm90b3R5cGUubGFzdE5vZGUgPSBmdW5jdGlvbiBsYXN0Tm9kZSgpIHsKICAgICAgICAgICAgdmFyIHRhaWwgPSB0aGlzLmJvdW5kTGlzdC50YWlsKCk7CiAgICAgICAgICAgIHJldHVybiB0YWlsICYmIHRhaWwubGFzdE5vZGUoKTsKICAgICAgICB9OwoKICAgICAgICBCbG9ja0xpc3RUcmFja2VyLnByb3RvdHlwZS5vcGVuRWxlbWVudCA9IGZ1bmN0aW9uIG9wZW5FbGVtZW50KF9lbGVtZW50KSB7fTsKCiAgICAgICAgQmxvY2tMaXN0VHJhY2tlci5wcm90b3R5cGUuY2xvc2VFbGVtZW50ID0gZnVuY3Rpb24gY2xvc2VFbGVtZW50KCkge307CgogICAgICAgIEJsb2NrTGlzdFRyYWNrZXIucHJvdG90eXBlLmRpZEFwcGVuZE5vZGUgPSBmdW5jdGlvbiBkaWRBcHBlbmROb2RlKF9ub2RlKSB7fTsKCiAgICAgICAgQmxvY2tMaXN0VHJhY2tlci5wcm90b3R5cGUuZGlkQXBwZW5kQm91bmRzID0gZnVuY3Rpb24gZGlkQXBwZW5kQm91bmRzKF9ib3VuZHMpIHt9OwoKICAgICAgICBCbG9ja0xpc3RUcmFja2VyLnByb3RvdHlwZS5uZXdEZXN0cm95YWJsZSA9IGZ1bmN0aW9uIG5ld0Rlc3Ryb3lhYmxlKF9kKSB7fTsKCiAgICAgICAgQmxvY2tMaXN0VHJhY2tlci5wcm90b3R5cGUuZmluYWxpemUgPSBmdW5jdGlvbiBmaW5hbGl6ZShfc3RhY2spIHt9OwoKICAgICAgICByZXR1cm4gQmxvY2tMaXN0VHJhY2tlcjsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBjbGllbnRCdWlsZGVyKGVudiwgY3Vyc29yKSB7CiAgICAgICAgcmV0dXJuIE5ld0VsZW1lbnRCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIoZW52LCBjdXJzb3IpOwogICAgfQoKICAgIHZhciBISSA9IDB4ODAwMDAwMDA7CiAgICB2YXIgTUFTSyA9IDB4N2ZmZmZmZmY7CgogICAgdmFyIElubmVyU3RhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gSW5uZXJTdGFjaygpIHsKICAgICAgICAgICAgdmFyIGlubmVyID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBuZXcgX2xvd0xldmVsLlN0YWNrKCk7CiAgICAgICAgICAgIHZhciBqcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogW107CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSW5uZXJTdGFjayk7CgogICAgICAgICAgICB0aGlzLmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIHRoaXMuanMgPSBqczsKICAgICAgICB9CgogICAgICAgIElubmVyU3RhY2sucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2Uoc3RhcnQsIGVuZCkgewogICAgICAgICAgICB2YXIgaW5uZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdudW1iZXInICYmIHR5cGVvZiBlbmQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICBpbm5lciA9IHRoaXMuaW5uZXIuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YXJ0ID09PSAnbnVtYmVyJyAmJiBlbmQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaW5uZXIgPSB0aGlzLmlubmVyLnNsaWNlRnJvbShzdGFydCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbm5lciA9IHRoaXMuaW5uZXIuY2xvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IElubmVyU3RhY2soaW5uZXIsIHRoaXMuanMuc2xpY2Uoc3RhcnQsIGVuZCkpOwogICAgICAgIH07CgogICAgICAgIElubmVyU3RhY2sucHJvdG90eXBlLnNsaWNlSW5uZXIgPSBmdW5jdGlvbiBzbGljZUlubmVyKHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgdmFyIG91dCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICAgICAgICAgICAgb3V0LnB1c2godGhpcy5nZXQoaSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfTsKCiAgICAgICAgSW5uZXJTdGFjay5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkoZnJvbSwgdG8pIHsKICAgICAgICAgICAgdGhpcy5pbm5lci5jb3B5KGZyb20sIHRvKTsKICAgICAgICB9OwoKICAgICAgICBJbm5lclN0YWNrLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKHBvcywgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGlzSW1tZWRpYXRlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5pbm5lci53cml0ZVJhdyhwb3MsIGVuY29kZUltbWVkaWF0ZSh2YWx1ZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGlkeCA9IHRoaXMuanMubGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy5qcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgIHRoaXMuaW5uZXIud3JpdGVSYXcocG9zLCBpZHggfCBISSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBJbm5lclN0YWNrLnByb3RvdHlwZS53cml0ZVNtaSA9IGZ1bmN0aW9uIHdyaXRlU21pKHBvcywgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci53cml0ZVNtaShwb3MsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBJbm5lclN0YWNrLnByb3RvdHlwZS53cml0ZUltbWVkaWF0ZSA9IGZ1bmN0aW9uIHdyaXRlSW1tZWRpYXRlKHBvcywgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci53cml0ZVJhdyhwb3MsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBJbm5lclN0YWNrLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQocG9zKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuaW5uZXIuZ2V0UmF3KHBvcyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmIEhJKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5qc1t2YWx1ZSAmIE1BU0tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlY29kZUltbWVkaWF0ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBJbm5lclN0YWNrLnByb3RvdHlwZS5nZXRTbWkgPSBmdW5jdGlvbiBnZXRTbWkocG9zKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlubmVyLmdldFNtaShwb3MpOwogICAgICAgIH07CgogICAgICAgIElubmVyU3RhY2sucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMuaW5uZXIucmVzZXQoKTsKICAgICAgICAgICAgdGhpcy5qcy5sZW5ndGggPSAwOwogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoSW5uZXJTdGFjaywgW3sKICAgICAgICAgICAga2V5OiAnbGVuZ3RoJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbm5lci5sZW4oKTsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gSW5uZXJTdGFjazsKICAgIH0oKTsKCiAgICB2YXIgRXZhbHVhdGlvblN0YWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEV2YWx1YXRpb25TdGFjayhzdGFjaywgZnAsIHNwKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRXZhbHVhdGlvblN0YWNrKTsKCiAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgICAgICAgdGhpcy5mcCA9IGZwOwogICAgICAgICAgICB0aGlzLnNwID0gc3A7CiAgICAgICAgfQoKICAgICAgICBFdmFsdWF0aW9uU3RhY2suZW1wdHkgPSBmdW5jdGlvbiBlbXB0eSgpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0aGlzKG5ldyBJbm5lclN0YWNrKCksIDAsIC0xKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucmVzdG9yZSA9IGZ1bmN0aW9uIHJlc3RvcmUoc25hcHNob3QpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gbmV3IElubmVyU3RhY2soKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbmFwc2hvdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgc3RhY2sud3JpdGUoaSwgc25hcHNob3RbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcyhzdGFjaywgMCwgc25hcHNob3QubGVuZ3RoIC0gMSk7CiAgICAgICAgfTsKCiAgICAgICAgRXZhbHVhdGlvblN0YWNrLnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24gcHVzaCh2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnN0YWNrLndyaXRlKCsrdGhpcy5zcCwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUucHVzaFNtaSA9IGZ1bmN0aW9uIHB1c2hTbWkodmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zdGFjay53cml0ZVNtaSgrK3RoaXMuc3AsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnB1c2hJbW1lZGlhdGUgPSBmdW5jdGlvbiBwdXNoSW1tZWRpYXRlKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sud3JpdGVJbW1lZGlhdGUoKyt0aGlzLnNwLCBlbmNvZGVJbW1lZGlhdGUodmFsdWUpKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnB1c2hFbmNvZGVkSW1tZWRpYXRlID0gZnVuY3Rpb24gcHVzaEVuY29kZWRJbW1lZGlhdGUodmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zdGFjay53cml0ZUltbWVkaWF0ZSgrK3RoaXMuc3AsIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnB1c2hOdWxsID0gZnVuY3Rpb24gcHVzaE51bGwoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sud3JpdGVJbW1lZGlhdGUoKyt0aGlzLnNwLCAxOSAvKiBOdWxsICovKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLmR1cCA9IGZ1bmN0aW9uIGR1cCgpIHsKICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB0aGlzLnNwOwoKICAgICAgICAgICAgdGhpcy5zdGFjay5jb3B5KHBvc2l0aW9uLCArK3RoaXMuc3ApOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkoZnJvbSwgdG8pIHsKICAgICAgICAgICAgdGhpcy5zdGFjay5jb3B5KGZyb20sIHRvKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uIHBvcCgpIHsKICAgICAgICAgICAgdmFyIG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IDE7CgogICAgICAgICAgICB2YXIgdG9wID0gdGhpcy5zdGFjay5nZXQodGhpcy5zcCk7CiAgICAgICAgICAgIHRoaXMuc3AgLT0gbjsKICAgICAgICAgICAgcmV0dXJuIHRvcDsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnBvcFNtaSA9IGZ1bmN0aW9uIHBvcFNtaSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suZ2V0U21pKHRoaXMuc3AtLSk7CiAgICAgICAgfTsKCiAgICAgICAgRXZhbHVhdGlvblN0YWNrLnByb3RvdHlwZS5wZWVrID0gZnVuY3Rpb24gcGVlaygpIHsKICAgICAgICAgICAgdmFyIG9mZnNldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogMDsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YWNrLmdldCh0aGlzLnNwIC0gb2Zmc2V0KTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnBlZWtTbWkgPSBmdW5jdGlvbiBwZWVrU21pKCkgewogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAwOwoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suZ2V0U21pKHRoaXMuc3AgLSBvZmZzZXQpOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KG9mZnNldCkgewogICAgICAgICAgICB2YXIgYmFzZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogdGhpcy5mcDsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YWNrLmdldChiYXNlICsgb2Zmc2V0KTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLmdldFNtaSA9IGZ1bmN0aW9uIGdldFNtaShvZmZzZXQpIHsKICAgICAgICAgICAgdmFyIGJhc2UgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHRoaXMuZnA7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5nZXRTbWkoYmFzZSArIG9mZnNldCk7CiAgICAgICAgfTsKCiAgICAgICAgRXZhbHVhdGlvblN0YWNrLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiBzZXQodmFsdWUsIG9mZnNldCkgewogICAgICAgICAgICB2YXIgYmFzZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogdGhpcy5mcDsKCiAgICAgICAgICAgIHRoaXMuc3RhY2sud3JpdGUoYmFzZSArIG9mZnNldCwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiBzbGljZShzdGFydCwgZW5kKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YWNrLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUuc2xpY2VBcnJheSA9IGZ1bmN0aW9uIHNsaWNlQXJyYXkoc3RhcnQsIGVuZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5zbGljZUlubmVyKHN0YXJ0LCBlbmQpOwogICAgICAgIH07CgogICAgICAgIEV2YWx1YXRpb25TdGFjay5wcm90b3R5cGUuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoaXRlbXMpIHsKICAgICAgICAgICAgdmFyIGVuZCA9IHRoaXMuc3AgKyAxOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBlbmQgLSBpdGVtczsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2VJbm5lcihzdGFydCwgZW5kKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sucmVzZXQoKTsKICAgICAgICB9OwoKICAgICAgICBFdmFsdWF0aW9uU3RhY2sucHJvdG90eXBlLnRvQXJyYXkgPSBmdW5jdGlvbiB0b0FycmF5KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5zbGljZUlubmVyKHRoaXMuZnAsIHRoaXMuc3AgKyAxKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRXZhbHVhdGlvblN0YWNrOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGlzSW1tZWRpYXRlKHZhbHVlKSB7CiAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiB0cnVlOwogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgICAgY2FzZSAndW5kZWZpbmVkJzoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgICAgICAgICAgLy8gbm90IGFuIGludGVnZXIKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAlIDEgIT09IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIHZhciBhYnMgPSBNYXRoLmFicyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAvLyB0b28gYmlnCiAgICAgICAgICAgICAgICBpZiAoYWJzID4gSEkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGVuY29kZVNtaShwcmltaXRpdmUpIHsKICAgICAgICBpZiAocHJpbWl0aXZlIDwgMCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5hYnMocHJpbWl0aXZlKSA8PCAzIHwgNCAvKiBORUdBVElWRSAqLzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJpbWl0aXZlIDw8IDMgfCAwIC8qIE5VTUJFUiAqLzsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBlbmNvZGVJbW1lZGlhdGUocHJpbWl0aXZlKSB7CiAgICAgICAgc3dpdGNoICh0eXBlb2YgcHJpbWl0aXZlKSB7CiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgICByZXR1cm4gZW5jb2RlU21pKHByaW1pdGl2ZSk7CiAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1pdGl2ZSA/IDExIC8qIFRydWUgKi8gOiAzIC8qIEZhbHNlICovOwogICAgICAgICAgICBjYXNlICdvYmplY3QnOgogICAgICAgICAgICAgICAgLy8gYXNzdW1lIG51bGwKICAgICAgICAgICAgICAgIHJldHVybiAxOSAvKiBOdWxsICovOwogICAgICAgICAgICBjYXNlICd1bmRlZmluZWQnOgogICAgICAgICAgICAgICAgcmV0dXJuIDI3IC8qIFVuZGVmICovOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZVNtaShzbWkpIHsKICAgICAgICBzd2l0Y2ggKHNtaSAmIDcpIHsKICAgICAgICAgICAgY2FzZSAwIC8qIE5VTUJFUiAqLzoKICAgICAgICAgICAgICAgIHJldHVybiBzbWkgPj4gMzsKICAgICAgICAgICAgY2FzZSA0IC8qIE5FR0FUSVZFICovOgogICAgICAgICAgICAgICAgcmV0dXJuIC0oc21pID4+IDMpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgKDAsIF91dGlsLnVucmVhY2hhYmxlKSgpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZUltbWVkaWF0ZShpbW1lZGlhdGUpIHsKICAgICAgICBzd2l0Y2ggKGltbWVkaWF0ZSkgewogICAgICAgICAgICBjYXNlIDMgLyogRmFsc2UgKi86CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGNhc2UgMTEgLyogVHJ1ZSAqLzoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlIDE5IC8qIE51bGwgKi86CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAyNyAvKiBVbmRlZiAqLzoKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVjb2RlU21pKGltbWVkaWF0ZSk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBVcGRhdGluZ1ZNID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFVwZGF0aW5nVk0oZW52LCBwcm9ncmFtLCBfcmVmNTYpIHsKICAgICAgICAgICAgdmFyIF9yZWY1NiRhbHdheXNSZXZhbGlkYSA9IF9yZWY1Ni5hbHdheXNSZXZhbGlkYXRlLAogICAgICAgICAgICAgICAgYWx3YXlzUmV2YWxpZGF0ZSA9IF9yZWY1NiRhbHdheXNSZXZhbGlkYSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBfcmVmNTYkYWx3YXlzUmV2YWxpZGE7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVXBkYXRpbmdWTSk7CgogICAgICAgICAgICB0aGlzLmZyYW1lU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgICAgICAgdGhpcy5lbnYgPSBlbnY7CiAgICAgICAgICAgIHRoaXMuY29uc3RhbnRzID0gcHJvZ3JhbS5jb25zdGFudHM7CiAgICAgICAgICAgIHRoaXMuZG9tID0gZW52LmdldERPTSgpOwogICAgICAgICAgICB0aGlzLmFsd2F5c1JldmFsaWRhdGUgPSBhbHdheXNSZXZhbGlkYXRlOwogICAgICAgIH0KCiAgICAgICAgVXBkYXRpbmdWTS5wcm90b3R5cGUuZXhlY3V0ZSA9IGZ1bmN0aW9uIGV4ZWN1dGUob3Bjb2RlcywgaGFuZGxlcikgewogICAgICAgICAgICB2YXIgZnJhbWVTdGFjayA9IHRoaXMuZnJhbWVTdGFjazsKCiAgICAgICAgICAgIHRoaXMudHJ5KG9wY29kZXMsIGhhbmRsZXIpOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKGZyYW1lU3RhY2suaXNFbXB0eSgpKSBicmVhazsKICAgICAgICAgICAgICAgIHZhciBvcGNvZGUgPSB0aGlzLmZyYW1lLm5leHRTdGF0ZW1lbnQoKTsKICAgICAgICAgICAgICAgIGlmIChvcGNvZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lU3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcGNvZGUuZXZhbHVhdGUodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBVcGRhdGluZ1ZNLnByb3RvdHlwZS5nb3RvID0gZnVuY3Rpb24gZ290byhvcCkgewogICAgICAgICAgICB0aGlzLmZyYW1lLmdvdG8ob3ApOwogICAgICAgIH07CgogICAgICAgIFVwZGF0aW5nVk0ucHJvdG90eXBlLnRyeSA9IGZ1bmN0aW9uIF90cnkob3BzLCBoYW5kbGVyKSB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVTdGFjay5wdXNoKG5ldyBVcGRhdGluZ1ZNRnJhbWUob3BzLCBoYW5kbGVyKSk7CiAgICAgICAgfTsKCiAgICAgICAgVXBkYXRpbmdWTS5wcm90b3R5cGUudGhyb3cgPSBmdW5jdGlvbiBfdGhyb3coKSB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUuaGFuZGxlRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIHRoaXMuZnJhbWVTdGFjay5wb3AoKTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFVwZGF0aW5nVk0sIFt7CiAgICAgICAgICAgIGtleTogJ2ZyYW1lJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mcmFtZVN0YWNrLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgcmV0dXJuIFVwZGF0aW5nVk07CiAgICB9KCk7CgogICAgdmFyIEJsb2NrT3Bjb2RlID0gZnVuY3Rpb24gKF9VcGRhdGluZ09wY29kZTkpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEJsb2NrT3Bjb2RlLCBfVXBkYXRpbmdPcGNvZGU5KTsKCiAgICAgICAgZnVuY3Rpb24gQmxvY2tPcGNvZGUoc3RhcnQsIHN0YXRlLCBydW50aW1lLCBib3VuZHMkJDEsIGNoaWxkcmVuKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQmxvY2tPcGNvZGUpOwoKICAgICAgICAgICAgdmFyIF90aGlzMjggPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1VwZGF0aW5nT3Bjb2RlOS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzMjguc3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgX3RoaXMyOC5zdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICBfdGhpczI4LnJ1bnRpbWUgPSBydW50aW1lOwogICAgICAgICAgICBfdGhpczI4LnR5cGUgPSAnYmxvY2snOwogICAgICAgICAgICBfdGhpczI4Lm5leHQgPSBudWxsOwogICAgICAgICAgICBfdGhpczI4LnByZXYgPSBudWxsOwogICAgICAgICAgICBfdGhpczI4LmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICAgIF90aGlzMjguYm91bmRzID0gYm91bmRzJCQxOwogICAgICAgICAgICByZXR1cm4gX3RoaXMyODsKICAgICAgICB9CgogICAgICAgIEJsb2NrT3Bjb2RlLnByb3RvdHlwZS5wYXJlbnRFbGVtZW50ID0gZnVuY3Rpb24gcGFyZW50RWxlbWVudCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLnBhcmVudEVsZW1lbnQoKTsKICAgICAgICB9OwoKICAgICAgICBCbG9ja09wY29kZS5wcm90b3R5cGUuZmlyc3ROb2RlID0gZnVuY3Rpb24gZmlyc3ROb2RlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuZmlyc3ROb2RlKCk7CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tPcGNvZGUucHJvdG90eXBlLmxhc3ROb2RlID0gZnVuY3Rpb24gbGFzdE5vZGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5sYXN0Tm9kZSgpOwogICAgICAgIH07CgogICAgICAgIEJsb2NrT3Bjb2RlLnByb3RvdHlwZS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgICAgICAgIHZtLnRyeSh0aGlzLmNoaWxkcmVuLCBudWxsKTsKICAgICAgICB9OwoKICAgICAgICBCbG9ja09wY29kZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIHRoaXMuYm91bmRzLmRlc3Ryb3koKTsKICAgICAgICB9OwoKICAgICAgICBCbG9ja09wY29kZS5wcm90b3R5cGUuZGlkRGVzdHJveSA9IGZ1bmN0aW9uIGRpZERlc3Ryb3koKSB7CiAgICAgICAgICAgIHRoaXMucnVudGltZS5lbnYuZGlkRGVzdHJveSh0aGlzLmJvdW5kcyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEJsb2NrT3Bjb2RlOwogICAgfShVcGRhdGluZ09wY29kZSk7CgogICAgdmFyIFRyeU9wY29kZSA9IGZ1bmN0aW9uIChfQmxvY2tPcGNvZGUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFRyeU9wY29kZSwgX0Jsb2NrT3Bjb2RlKTsKCiAgICAgICAgZnVuY3Rpb24gVHJ5T3Bjb2RlKHN0YXJ0LCBzdGF0ZSwgcnVudGltZSwgYm91bmRzJCQxLCBjaGlsZHJlbikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFRyeU9wY29kZSk7CgogICAgICAgICAgICB2YXIgX3RoaXMyOSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQmxvY2tPcGNvZGUuY2FsbCh0aGlzLCBzdGFydCwgc3RhdGUsIHJ1bnRpbWUsIGJvdW5kcyQkMSwgY2hpbGRyZW4pKTsKCiAgICAgICAgICAgIF90aGlzMjkudHlwZSA9ICd0cnknOwogICAgICAgICAgICBfdGhpczI5LnRhZyA9IF90aGlzMjkuX3RhZyA9IF9yZWZlcmVuY2UuVXBkYXRhYmxlVGFnLmNyZWF0ZShfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRyk7CiAgICAgICAgICAgIHJldHVybiBfdGhpczI5OwogICAgICAgIH0KCiAgICAgICAgVHJ5T3Bjb2RlLnByb3RvdHlwZS5kaWRJbml0aWFsaXplQ2hpbGRyZW4gPSBmdW5jdGlvbiBkaWRJbml0aWFsaXplQ2hpbGRyZW4oKSB7CiAgICAgICAgICAgIHRoaXMuX3RhZy5pbm5lci51cGRhdGUoKDAsIF9yZWZlcmVuY2UuY29tYmluZVNsaWNlKSh0aGlzLmNoaWxkcmVuKSk7CiAgICAgICAgfTsKCiAgICAgICAgVHJ5T3Bjb2RlLnByb3RvdHlwZS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKHZtKSB7CiAgICAgICAgICAgIHZtLnRyeSh0aGlzLmNoaWxkcmVuLCB0aGlzKTsKICAgICAgICB9OwoKICAgICAgICBUcnlPcGNvZGUucHJvdG90eXBlLmhhbmRsZUV4Y2VwdGlvbiA9IGZ1bmN0aW9uIGhhbmRsZUV4Y2VwdGlvbigpIHsKICAgICAgICAgICAgdmFyIF90aGlzMzAgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5zdGF0ZSwKICAgICAgICAgICAgICAgIGJvdW5kcyQkMSA9IHRoaXMuYm91bmRzLAogICAgICAgICAgICAgICAgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuLAogICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLnN0YXJ0LAogICAgICAgICAgICAgICAgcHJldiA9IHRoaXMucHJldiwKICAgICAgICAgICAgICAgIG5leHQgPSB0aGlzLm5leHQsCiAgICAgICAgICAgICAgICBydW50aW1lID0gdGhpcy5ydW50aW1lOwoKICAgICAgICAgICAgY2hpbGRyZW4uY2xlYXIoKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRTdGFjayA9IE5ld0VsZW1lbnRCdWlsZGVyLnJlc3VtZShydW50aW1lLmVudiwgYm91bmRzJCQxLCBib3VuZHMkJDEucmVzZXQocnVudGltZS5lbnYpKTsKICAgICAgICAgICAgdmFyIHZtID0gVk0ucmVzdW1lKHN0YXRlLCBydW50aW1lLCBlbGVtZW50U3RhY2spOwogICAgICAgICAgICB2YXIgdXBkYXRpbmcgPSBuZXcgX3V0aWwuTGlua2VkTGlzdCgpOwogICAgICAgICAgICB2bS5leGVjdXRlKHN0YXJ0LCBmdW5jdGlvbiAodm0pIHsKICAgICAgICAgICAgICAgIHZtLnN0YWNrID0gRXZhbHVhdGlvblN0YWNrLnJlc3RvcmUoc3RhdGUuc3RhY2spOwogICAgICAgICAgICAgICAgdm0udXBkYXRpbmdPcGNvZGVTdGFjay5wdXNoKHVwZGF0aW5nKTsKICAgICAgICAgICAgICAgIHZtLnVwZGF0ZVdpdGgoX3RoaXMzMCk7CiAgICAgICAgICAgICAgICB2bS51cGRhdGluZ09wY29kZVN0YWNrLnB1c2goY2hpbGRyZW4pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5wcmV2ID0gcHJldjsKICAgICAgICAgICAgdGhpcy5uZXh0ID0gbmV4dDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gVHJ5T3Bjb2RlOwogICAgfShCbG9ja09wY29kZSk7CgogICAgdmFyIExpc3RSZXZhbGlkYXRpb25EZWxlZ2F0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUob3Bjb2RlLCBtYXJrZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUpOwoKICAgICAgICAgICAgdGhpcy5vcGNvZGUgPSBvcGNvZGU7CiAgICAgICAgICAgIHRoaXMubWFya2VyID0gbWFya2VyOwogICAgICAgICAgICB0aGlzLmRpZEluc2VydCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmRpZERlbGV0ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm1hcCA9IG9wY29kZS5tYXA7CiAgICAgICAgICAgIHRoaXMudXBkYXRpbmcgPSBvcGNvZGVbJ2NoaWxkcmVuJ107CiAgICAgICAgfQoKICAgICAgICBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUucHJvdG90eXBlLmluc2VydCA9IGZ1bmN0aW9uIGluc2VydChrZXksIGl0ZW0sIG1lbW8sIGJlZm9yZSkgewogICAgICAgICAgICB2YXIgbWFwID0gdGhpcy5tYXAsCiAgICAgICAgICAgICAgICBvcGNvZGUgPSB0aGlzLm9wY29kZSwKICAgICAgICAgICAgICAgIHVwZGF0aW5nID0gdGhpcy51cGRhdGluZzsKCiAgICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciByZWZlcmVuY2UgPSBudWxsOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UgPSBtYXBbYmVmb3JlXTsKICAgICAgICAgICAgICAgIG5leHRTaWJsaW5nID0gcmVmZXJlbmNlWydib3VuZHMnXS5maXJzdE5vZGUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRTaWJsaW5nID0gdGhpcy5tYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZtID0gb3Bjb2RlLnZtRm9ySW5zZXJ0aW9uKG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgdmFyIHRyeU9wY29kZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBzdGFydCA9IG9wY29kZS5zdGFydDsKCiAgICAgICAgICAgIHZtLmV4ZWN1dGUoc3RhcnQsIGZ1bmN0aW9uICh2bSkgewogICAgICAgICAgICAgICAgbWFwW2tleV0gPSB0cnlPcGNvZGUgPSB2bS5pdGVyYXRlKG1lbW8sIGl0ZW0pOwogICAgICAgICAgICAgICAgdm0udXBkYXRpbmdPcGNvZGVTdGFjay5wdXNoKG5ldyBfdXRpbC5MaW5rZWRMaXN0KCkpOwogICAgICAgICAgICAgICAgdm0udXBkYXRlV2l0aCh0cnlPcGNvZGUpOwogICAgICAgICAgICAgICAgdm0udXBkYXRpbmdPcGNvZGVTdGFjay5wdXNoKHRyeU9wY29kZS5jaGlsZHJlbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1cGRhdGluZy5pbnNlcnRCZWZvcmUodHJ5T3Bjb2RlLCByZWZlcmVuY2UpOwogICAgICAgICAgICB0aGlzLmRpZEluc2VydCA9IHRydWU7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlLnByb3RvdHlwZS5yZXRhaW4gPSBmdW5jdGlvbiByZXRhaW4oX2tleSwgX2l0ZW0sIF9tZW1vKSB7fTsKCiAgICAgICAgTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlLnByb3RvdHlwZS5tb3ZlID0gZnVuY3Rpb24gbW92ZShrZXksIF9pdGVtLCBfbWVtbywgYmVmb3JlKSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB0aGlzLm1hcCwKICAgICAgICAgICAgICAgIHVwZGF0aW5nID0gdGhpcy51cGRhdGluZzsKCiAgICAgICAgICAgIHZhciBlbnRyeSA9IG1hcFtrZXldOwogICAgICAgICAgICB2YXIgcmVmZXJlbmNlID0gbWFwW2JlZm9yZV0gfHwgbnVsbDsKICAgICAgICAgICAgaWYgKGJlZm9yZSkgewogICAgICAgICAgICAgICAgX21vdmUoZW50cnksIHJlZmVyZW5jZS5maXJzdE5vZGUoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbW92ZShlbnRyeSwgdGhpcy5tYXJrZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0aW5nLnJlbW92ZShlbnRyeSk7CiAgICAgICAgICAgIHVwZGF0aW5nLmluc2VydEJlZm9yZShlbnRyeSwgcmVmZXJlbmNlKTsKICAgICAgICB9OwoKICAgICAgICBMaXN0UmV2YWxpZGF0aW9uRGVsZWdhdGUucHJvdG90eXBlLmRlbGV0ZSA9IGZ1bmN0aW9uIF9kZWxldGUoa2V5KSB7CiAgICAgICAgICAgIHZhciBtYXAgPSB0aGlzLm1hcDsKCiAgICAgICAgICAgIHZhciBvcGNvZGUgPSBtYXBba2V5XTsKICAgICAgICAgICAgb3Bjb2RlLmRpZERlc3Ryb3koKTsKICAgICAgICAgICAgY2xlYXIob3Bjb2RlKTsKICAgICAgICAgICAgdGhpcy51cGRhdGluZy5yZW1vdmUob3Bjb2RlKTsKICAgICAgICAgICAgZGVsZXRlIG1hcFtrZXldOwogICAgICAgICAgICB0aGlzLmRpZERlbGV0ZSA9IHRydWU7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlLnByb3RvdHlwZS5kb25lID0gZnVuY3Rpb24gZG9uZSgpIHsKICAgICAgICAgICAgdGhpcy5vcGNvZGUuZGlkSW5pdGlhbGl6ZUNoaWxkcmVuKHRoaXMuZGlkSW5zZXJ0IHx8IHRoaXMuZGlkRGVsZXRlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGlzdFJldmFsaWRhdGlvbkRlbGVnYXRlOwogICAgfSgpOwoKICAgIHZhciBMaXN0QmxvY2tPcGNvZGUgPSBmdW5jdGlvbiAoX0Jsb2NrT3Bjb2RlMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoTGlzdEJsb2NrT3Bjb2RlLCBfQmxvY2tPcGNvZGUyKTsKCiAgICAgICAgZnVuY3Rpb24gTGlzdEJsb2NrT3Bjb2RlKHN0YXJ0LCBzdGF0ZSwgcnVudGltZSwgYm91bmRzJCQxLCBjaGlsZHJlbiwgYXJ0aWZhY3RzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTGlzdEJsb2NrT3Bjb2RlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczMxID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9CbG9ja09wY29kZTIuY2FsbCh0aGlzLCBzdGFydCwgc3RhdGUsIHJ1bnRpbWUsIGJvdW5kcyQkMSwgY2hpbGRyZW4pKTsKCiAgICAgICAgICAgIF90aGlzMzEudHlwZSA9ICdsaXN0LWJsb2NrJzsKICAgICAgICAgICAgX3RoaXMzMS5tYXAgPSAoMCwgX3V0aWwuZGljdCkoKTsKICAgICAgICAgICAgX3RoaXMzMS5sYXN0SXRlcmF0ZWQgPSBfcmVmZXJlbmNlLklOSVRJQUw7CiAgICAgICAgICAgIF90aGlzMzEuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzOwogICAgICAgICAgICB2YXIgX3RhZyA9IF90aGlzMzEuX3RhZyA9IF9yZWZlcmVuY2UuVXBkYXRhYmxlVGFnLmNyZWF0ZShfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRyk7CiAgICAgICAgICAgIF90aGlzMzEudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2FydGlmYWN0cy50YWcsIF90YWddKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMzE7CiAgICAgICAgfQoKICAgICAgICBMaXN0QmxvY2tPcGNvZGUucHJvdG90eXBlLmRpZEluaXRpYWxpemVDaGlsZHJlbiA9IGZ1bmN0aW9uIGRpZEluaXRpYWxpemVDaGlsZHJlbigpIHsKICAgICAgICAgICAgdmFyIGxpc3REaWRDaGFuZ2UgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHRydWU7CgogICAgICAgICAgICB0aGlzLmxhc3RJdGVyYXRlZCA9IHRoaXMuYXJ0aWZhY3RzLnRhZy52YWx1ZSgpOwogICAgICAgICAgICBpZiAobGlzdERpZENoYW5nZSkgewogICAgICAgICAgICAgICAgdGhpcy5fdGFnLmlubmVyLnVwZGF0ZSgoMCwgX3JlZmVyZW5jZS5jb21iaW5lU2xpY2UpKHRoaXMuY2hpbGRyZW4pKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIExpc3RCbG9ja09wY29kZS5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSh2bSkgewogICAgICAgICAgICB2YXIgYXJ0aWZhY3RzID0gdGhpcy5hcnRpZmFjdHMsCiAgICAgICAgICAgICAgICBsYXN0SXRlcmF0ZWQgPSB0aGlzLmxhc3RJdGVyYXRlZDsKCiAgICAgICAgICAgIGlmICghYXJ0aWZhY3RzLnRhZy52YWxpZGF0ZShsYXN0SXRlcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICB2YXIgYm91bmRzJCQxID0gdGhpcy5ib3VuZHM7CiAgICAgICAgICAgICAgICB2YXIgZG9tID0gdm0uZG9tOwoKICAgICAgICAgICAgICAgIHZhciBtYXJrZXIgPSBkb20uY3JlYXRlQ29tbWVudCgnJyk7CiAgICAgICAgICAgICAgICBkb20uaW5zZXJ0QWZ0ZXIoYm91bmRzJCQxLnBhcmVudEVsZW1lbnQoKSwgbWFya2VyLCBib3VuZHMkJDEubGFzdE5vZGUoKSk7CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmV3IExpc3RSZXZhbGlkYXRpb25EZWxlZ2F0ZSh0aGlzLCBtYXJrZXIpOwogICAgICAgICAgICAgICAgdmFyIHN5bmNocm9uaXplciA9IG5ldyBfcmVmZXJlbmNlLkl0ZXJhdG9yU3luY2hyb25pemVyKHsgdGFyZ2V0OiB0YXJnZXQsIGFydGlmYWN0czogYXJ0aWZhY3RzIH0pOwogICAgICAgICAgICAgICAgc3luY2hyb25pemVyLnN5bmMoKTsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50RWxlbWVudCgpLnJlbW92ZUNoaWxkKG1hcmtlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUnVuIG5vdy11cGRhdGVkIHVwZGF0aW5nIG9wY29kZXMKICAgICAgICAgICAgX0Jsb2NrT3Bjb2RlMi5wcm90b3R5cGUuZXZhbHVhdGUuY2FsbCh0aGlzLCB2bSk7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdEJsb2NrT3Bjb2RlLnByb3RvdHlwZS52bUZvckluc2VydGlvbiA9IGZ1bmN0aW9uIHZtRm9ySW5zZXJ0aW9uKG5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIHZhciBib3VuZHMkJDEgPSB0aGlzLmJvdW5kcywKICAgICAgICAgICAgICAgIHN0YXRlID0gdGhpcy5zdGF0ZSwKICAgICAgICAgICAgICAgIHJ1bnRpbWUgPSB0aGlzLnJ1bnRpbWU7CgogICAgICAgICAgICB2YXIgZWxlbWVudFN0YWNrID0gTmV3RWxlbWVudEJ1aWxkZXIuZm9ySW5pdGlhbFJlbmRlcihydW50aW1lLmVudiwgewogICAgICAgICAgICAgICAgZWxlbWVudDogYm91bmRzJCQxLnBhcmVudEVsZW1lbnQoKSwKICAgICAgICAgICAgICAgIG5leHRTaWJsaW5nOiBuZXh0U2libGluZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIFZNLnJlc3VtZShzdGF0ZSwgcnVudGltZSwgZWxlbWVudFN0YWNrKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGlzdEJsb2NrT3Bjb2RlOwogICAgfShCbG9ja09wY29kZSk7CgogICAgdmFyIFVwZGF0aW5nVk1GcmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBVcGRhdGluZ1ZNRnJhbWUob3BzLCBleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVXBkYXRpbmdWTUZyYW1lKTsKCiAgICAgICAgICAgIHRoaXMub3BzID0gb3BzOwogICAgICAgICAgICB0aGlzLmV4Y2VwdGlvbkhhbmRsZXIgPSBleGNlcHRpb25IYW5kbGVyOwogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBvcHMuaGVhZCgpOwogICAgICAgIH0KCiAgICAgICAgVXBkYXRpbmdWTUZyYW1lLnByb3RvdHlwZS5nb3RvID0gZnVuY3Rpb24gZ290byhvcCkgewogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBvcDsKICAgICAgICB9OwoKICAgICAgICBVcGRhdGluZ1ZNRnJhbWUucHJvdG90eXBlLm5leHRTdGF0ZW1lbnQgPSBmdW5jdGlvbiBuZXh0U3RhdGVtZW50KCkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuY3VycmVudCwKICAgICAgICAgICAgICAgIG9wcyA9IHRoaXMub3BzOwoKICAgICAgICAgICAgaWYgKGN1cnJlbnQpIHRoaXMuY3VycmVudCA9IG9wcy5uZXh0Tm9kZShjdXJyZW50KTsKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgVXBkYXRpbmdWTUZyYW1lLnByb3RvdHlwZS5oYW5kbGVFeGNlcHRpb24gPSBmdW5jdGlvbiBoYW5kbGVFeGNlcHRpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXhjZXB0aW9uSGFuZGxlci5oYW5kbGVFeGNlcHRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBVcGRhdGluZ1ZNRnJhbWU7CiAgICB9KCk7CgogICAgdmFyIFJlbmRlclJlc3VsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBSZW5kZXJSZXN1bHQoZW52LCBwcm9ncmFtLCB1cGRhdGluZywgYm91bmRzJCQxKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVuZGVyUmVzdWx0KTsKCiAgICAgICAgICAgIHRoaXMuZW52ID0gZW52OwogICAgICAgICAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwogICAgICAgICAgICB0aGlzLnVwZGF0aW5nID0gdXBkYXRpbmc7CiAgICAgICAgICAgIHRoaXMuYm91bmRzID0gYm91bmRzJCQxOwogICAgICAgIH0KCiAgICAgICAgUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5yZXJlbmRlciA9IGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICAgICAgICB2YXIgX3JlZjU3ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7IGFsd2F5c1JldmFsaWRhdGU6IGZhbHNlIH0sCiAgICAgICAgICAgICAgICBfcmVmNTckYWx3YXlzUmV2YWxpZGEgPSBfcmVmNTcuYWx3YXlzUmV2YWxpZGF0ZSwKICAgICAgICAgICAgICAgIGFsd2F5c1JldmFsaWRhdGUgPSBfcmVmNTckYWx3YXlzUmV2YWxpZGEgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogX3JlZjU3JGFsd2F5c1JldmFsaWRhOwoKICAgICAgICAgICAgdmFyIGVudiA9IHRoaXMuZW52LAogICAgICAgICAgICAgICAgcHJvZ3JhbSA9IHRoaXMucHJvZ3JhbSwKICAgICAgICAgICAgICAgIHVwZGF0aW5nID0gdGhpcy51cGRhdGluZzsKCiAgICAgICAgICAgIHZhciB2bSA9IG5ldyBVcGRhdGluZ1ZNKGVudiwgcHJvZ3JhbSwgeyBhbHdheXNSZXZhbGlkYXRlOiBhbHdheXNSZXZhbGlkYXRlIH0pOwogICAgICAgICAgICB2bS5leGVjdXRlKHVwZGF0aW5nLCB0aGlzKTsKICAgICAgICB9OwoKICAgICAgICBSZW5kZXJSZXN1bHQucHJvdG90eXBlLnBhcmVudEVsZW1lbnQgPSBmdW5jdGlvbiBwYXJlbnRFbGVtZW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMucGFyZW50RWxlbWVudCgpOwogICAgICAgIH07CgogICAgICAgIFJlbmRlclJlc3VsdC5wcm90b3R5cGUuZmlyc3ROb2RlID0gZnVuY3Rpb24gZmlyc3ROb2RlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuZmlyc3ROb2RlKCk7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5sYXN0Tm9kZSA9IGZ1bmN0aW9uIGxhc3ROb2RlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMubGFzdE5vZGUoKTsKICAgICAgICB9OwoKICAgICAgICBSZW5kZXJSZXN1bHQucHJvdG90eXBlLmhhbmRsZUV4Y2VwdGlvbiA9IGZ1bmN0aW9uIGhhbmRsZUV4Y2VwdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgJ3RoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbic7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgdGhpcy5ib3VuZHMuZGVzdHJveSgpOwogICAgICAgICAgICBjbGVhcih0aGlzLmJvdW5kcyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJlbmRlclJlc3VsdDsKICAgIH0oKTsKCiAgICB2YXIgQXJndW1lbnRzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEFyZ3VtZW50cygpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBBcmd1bWVudHMpOwoKICAgICAgICAgICAgdGhpcy5zdGFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb25hbCA9IG5ldyBQb3NpdGlvbmFsQXJndW1lbnRzKCk7CiAgICAgICAgICAgIHRoaXMubmFtZWQgPSBuZXcgTmFtZWRBcmd1bWVudHMoKTsKICAgICAgICAgICAgdGhpcy5ibG9ja3MgPSBuZXcgQmxvY2tBcmd1bWVudHMoKTsKICAgICAgICB9CgogICAgICAgIEFyZ3VtZW50cy5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiBlbXB0eShzdGFjaykgewogICAgICAgICAgICB2YXIgYmFzZSA9IHN0YWNrLnNwICsgMTsKICAgICAgICAgICAgdGhpcy5uYW1lZC5lbXB0eShzdGFjaywgYmFzZSk7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb25hbC5lbXB0eShzdGFjaywgYmFzZSk7CiAgICAgICAgICAgIHRoaXMuYmxvY2tzLmVtcHR5KHN0YWNrLCBiYXNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgQXJndW1lbnRzLnByb3RvdHlwZS5zZXR1cCA9IGZ1bmN0aW9uIHNldHVwKHN0YWNrLCBuYW1lcywgYmxvY2tOYW1lcywgcG9zaXRpb25hbENvdW50LCBzeW50aGV0aWMpIHsKICAgICAgICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgfCAuLi4gfCBibG9ja3MgICAgICB8IHBvc2l0aW9uYWwgIHwgbmFtZWQgfAogICAgICAgICAgICAgICAgICAgfCAuLi4gfCBiMCAgICBiMSAgICB8IHAwIHAxIHAyIHAzIHwgbjAgbjEgfAogICAgICAgICAgICAgaW5kZXggfCAuLi4gfCA0LzUvNiA3LzgvOSB8IDEwIDExIDEyIDEzIHwgMTQgMTUgfAogICAgICAgICAgICAgICAgICAgICAgICAgICBeICAgICAgICAgICAgIF4gICAgICAgICAgICAgXiAgXgogICAgICAgICAgICAgICAgICAgICAgICAgYmJhc2UgICAgICAgICBwYmFzZSAgICAgICBuYmFzZSAgc3AKICAgICAgICAgICAgKi8KICAgICAgICAgICAgdmFyIG5hbWVkID0gdGhpcy5uYW1lZDsKICAgICAgICAgICAgdmFyIG5hbWVkQ291bnQgPSBuYW1lcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBuYW1lZEJhc2UgPSBzdGFjay5zcCAtIG5hbWVkQ291bnQgKyAxOwogICAgICAgICAgICBuYW1lZC5zZXR1cChzdGFjaywgbmFtZWRCYXNlLCBuYW1lZENvdW50LCBuYW1lcywgc3ludGhldGljKTsKICAgICAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSB0aGlzLnBvc2l0aW9uYWw7CiAgICAgICAgICAgIHZhciBwb3NpdGlvbmFsQmFzZSA9IG5hbWVkQmFzZSAtIHBvc2l0aW9uYWxDb3VudDsKICAgICAgICAgICAgcG9zaXRpb25hbC5zZXR1cChzdGFjaywgcG9zaXRpb25hbEJhc2UsIHBvc2l0aW9uYWxDb3VudCk7CiAgICAgICAgICAgIHZhciBibG9ja3MgPSB0aGlzLmJsb2NrczsKICAgICAgICAgICAgdmFyIGJsb2Nrc0NvdW50ID0gYmxvY2tOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBibG9ja3NCYXNlID0gcG9zaXRpb25hbEJhc2UgLSBibG9ja3NDb3VudCAqIDM7CiAgICAgICAgICAgIGJsb2Nrcy5zZXR1cChzdGFjaywgYmxvY2tzQmFzZSwgYmxvY2tzQ291bnQsIGJsb2NrTmFtZXMpOwogICAgICAgIH07CgogICAgICAgIEFyZ3VtZW50cy5wcm90b3R5cGUuYXQgPSBmdW5jdGlvbiBhdChwb3MpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25hbC5hdChwb3MpOwogICAgICAgIH07CgogICAgICAgIEFyZ3VtZW50cy5wcm90b3R5cGUucmVhbGxvYyA9IGZ1bmN0aW9uIHJlYWxsb2Mob2Zmc2V0KSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2s7CgogICAgICAgICAgICBpZiAob2Zmc2V0ID4gMCAmJiBzdGFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSB0aGlzLnBvc2l0aW9uYWwsCiAgICAgICAgICAgICAgICAgICAgbmFtZWQgPSB0aGlzLm5hbWVkOwoKICAgICAgICAgICAgICAgIHZhciBuZXdCYXNlID0gcG9zaXRpb25hbC5iYXNlICsgb2Zmc2V0OwogICAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IHBvc2l0aW9uYWwubGVuZ3RoICsgbmFtZWQubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2suY29weShpICsgcG9zaXRpb25hbC5iYXNlLCBpICsgbmV3QmFzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3NpdGlvbmFsLmJhc2UgKz0gb2Zmc2V0OwogICAgICAgICAgICAgICAgbmFtZWQuYmFzZSArPSBvZmZzZXQ7CiAgICAgICAgICAgICAgICBzdGFjay5zcCArPSBvZmZzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBBcmd1bWVudHMucHJvdG90eXBlLmNhcHR1cmUgPSBmdW5jdGlvbiBjYXB0dXJlKCkgewogICAgICAgICAgICB2YXIgcG9zaXRpb25hbCA9IHRoaXMucG9zaXRpb25hbC5sZW5ndGggPT09IDAgPyBFTVBUWV9QT1NJVElPTkFMIDogdGhpcy5wb3NpdGlvbmFsLmNhcHR1cmUoKTsKICAgICAgICAgICAgdmFyIG5hbWVkID0gdGhpcy5uYW1lZC5sZW5ndGggPT09IDAgPyBFTVBUWV9OQU1FRCA6IHRoaXMubmFtZWQuY2FwdHVyZSgpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdGFnOiB0aGlzLnRhZywKICAgICAgICAgICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgICBwb3NpdGlvbmFsOiBwb3NpdGlvbmFsLAogICAgICAgICAgICAgICAgbmFtZWQ6IG5hbWVkCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgQXJndW1lbnRzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgICAgICB2YXIgc3RhY2sgPSB0aGlzLnN0YWNrLAogICAgICAgICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgogICAgICAgICAgICBpZiAobGVuZ3RoID4gMCAmJiBzdGFjayAhPT0gbnVsbCkgc3RhY2sucG9wKGxlbmd0aCk7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShBcmd1bWVudHMsIFt7CiAgICAgICAgICAgIGtleTogJ3RhZycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfcmVmZXJlbmNlLmNvbWJpbmVUYWdnZWQpKFt0aGlzLnBvc2l0aW9uYWwsIHRoaXMubmFtZWRdKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnYmFzZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmxvY2tzLmJhc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ2xlbmd0aCcsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25hbC5sZW5ndGggKyB0aGlzLm5hbWVkLmxlbmd0aCArIHRoaXMuYmxvY2tzLmxlbmd0aCAqIDM7CiAgICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgcmV0dXJuIEFyZ3VtZW50czsKICAgIH0oKTsKCiAgICB2YXIgUG9zaXRpb25hbEFyZ3VtZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBQb3NpdGlvbmFsQXJndW1lbnRzKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFBvc2l0aW9uYWxBcmd1bWVudHMpOwoKICAgICAgICAgICAgdGhpcy5iYXNlID0gMDsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLnN0YWNrID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fdGFnID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBQb3NpdGlvbmFsQXJndW1lbnRzLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KHN0YWNrLCBiYXNlKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICAgICAgICAgICAgdGhpcy5iYXNlID0gYmFzZTsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLl90YWcgPSBfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRzsKICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgIH07CgogICAgICAgIFBvc2l0aW9uYWxBcmd1bWVudHMucHJvdG90eXBlLnNldHVwID0gZnVuY3Rpb24gc2V0dXAoc3RhY2ssIGJhc2UsIGxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl90YWcgPSBfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRzsKICAgICAgICAgICAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3RhZyA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFBvc2l0aW9uYWxBcmd1bWVudHMucHJvdG90eXBlLmF0ID0gZnVuY3Rpb24gYXQocG9zaXRpb24pIHsKICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aCwKICAgICAgICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjazsKCiAgICAgICAgICAgIGlmIChwb3NpdGlvbiA8IDAgfHwgcG9zaXRpb24gPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHBvc2l0aW9uLCBiYXNlKTsKICAgICAgICB9OwoKICAgICAgICBQb3NpdGlvbmFsQXJndW1lbnRzLnByb3RvdHlwZS5jYXB0dXJlID0gZnVuY3Rpb24gY2FwdHVyZSgpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBDYXB0dXJlZFBvc2l0aW9uYWxBcmd1bWVudHModGhpcy50YWcsIHRoaXMucmVmZXJlbmNlcyk7CiAgICAgICAgfTsKCiAgICAgICAgUG9zaXRpb25hbEFyZ3VtZW50cy5wcm90b3R5cGUucHJlcGVuZCA9IGZ1bmN0aW9uIHByZXBlbmQob3RoZXIpIHsKICAgICAgICAgICAgdmFyIGFkZGl0aW9ucyA9IG90aGVyLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGFkZGl0aW9ucyA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy5iYXNlLAogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjazsKCiAgICAgICAgICAgICAgICB0aGlzLmJhc2UgPSBiYXNlID0gYmFzZSAtIGFkZGl0aW9uczsKICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoICsgYWRkaXRpb25zOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhZGRpdGlvbnM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnNldChvdGhlci5hdChpKSwgaSwgYmFzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl90YWcgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFBvc2l0aW9uYWxBcmd1bWVudHMsIFt7CiAgICAgICAgICAgIGtleTogJ3RhZycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRhZyA9IHRoaXMuX3RhZzsKICAgICAgICAgICAgICAgIGlmICghdGFnKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnID0gdGhpcy5fdGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZVRhZ2dlZCkodGhpcy5yZWZlcmVuY2VzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0YWc7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ3JlZmVyZW5jZXMnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciByZWZlcmVuY2VzID0gdGhpcy5fcmVmZXJlbmNlczsKICAgICAgICAgICAgICAgIGlmICghcmVmZXJlbmNlcykgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2ssCiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoKICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2VzID0gdGhpcy5fcmVmZXJlbmNlcyA9IHN0YWNrLnNsaWNlQXJyYXkoYmFzZSwgYmFzZSArIGxlbmd0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVmZXJlbmNlczsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gUG9zaXRpb25hbEFyZ3VtZW50czsKICAgIH0oKTsKCiAgICB2YXIgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENhcHR1cmVkUG9zaXRpb25hbEFyZ3VtZW50cyh0YWcsIHJlZmVyZW5jZXMpIHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogcmVmZXJlbmNlcy5sZW5ndGg7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgICB0aGlzLnJlZmVyZW5jZXMgPSByZWZlcmVuY2VzOwogICAgICAgICAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CgogICAgICAgIENhcHR1cmVkUG9zaXRpb25hbEFyZ3VtZW50cy5lbXB0eSA9IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICAgICAgICByZXR1cm4gbmV3IENhcHR1cmVkUG9zaXRpb25hbEFyZ3VtZW50cyhfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRywgX3V0aWwuRU1QVFlfQVJSQVksIDApOwogICAgICAgIH07CgogICAgICAgIENhcHR1cmVkUG9zaXRpb25hbEFyZ3VtZW50cy5wcm90b3R5cGUuYXQgPSBmdW5jdGlvbiBhdChwb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZWZlcmVuY2VzW3Bvc2l0aW9uXTsKICAgICAgICB9OwoKICAgICAgICBDYXB0dXJlZFBvc2l0aW9uYWxBcmd1bWVudHMucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlZmVyZW5jZXMubWFwKHRoaXMudmFsdWVPZik7CiAgICAgICAgfTsKCiAgICAgICAgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQobmFtZSkgewogICAgICAgICAgICB2YXIgcmVmZXJlbmNlcyA9IHRoaXMucmVmZXJlbmNlcywKICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdsZW5ndGgnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShsZW5ndGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGlkeCA9IHBhcnNlSW50KG5hbWUsIDEwKTsKICAgICAgICAgICAgICAgIGlmIChpZHggPCAwIHx8IGlkeCA+PSBsZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZmVyZW5jZXNbaWR4XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENhcHR1cmVkUG9zaXRpb25hbEFyZ3VtZW50cy5wcm90b3R5cGUudmFsdWVPZiA9IGZ1bmN0aW9uIHZhbHVlT2YocmVmZXJlbmNlKSB7CiAgICAgICAgICAgIHJldHVybiByZWZlcmVuY2UudmFsdWUoKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzOwogICAgfSgpOwoKICAgIHZhciBOYW1lZEFyZ3VtZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBOYW1lZEFyZ3VtZW50cygpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBOYW1lZEFyZ3VtZW50cyk7CgogICAgICAgICAgICB0aGlzLmJhc2UgPSAwOwogICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHRoaXMuX3JlZmVyZW5jZXMgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgICAgICB0aGlzLl9hdE5hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgfQoKICAgICAgICBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiBlbXB0eShzdGFjaywgYmFzZSkgewogICAgICAgICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgICAgICB0aGlzLl9uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgICAgICB0aGlzLl9hdE5hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgfTsKCiAgICAgICAgTmFtZWRBcmd1bWVudHMucHJvdG90eXBlLnNldHVwID0gZnVuY3Rpb24gc2V0dXAoc3RhY2ssIGJhc2UsIGxlbmd0aCwgbmFtZXMsIHN5bnRoZXRpYykgewogICAgICAgICAgICB0aGlzLnN0YWNrID0gc3RhY2s7CiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZWZlcmVuY2VzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgICAgICAgICB0aGlzLl9uYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgICAgICAgICAgdGhpcy5fYXROYW1lcyA9IF91dGlsLkVNUFRZX0FSUkFZOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoc3ludGhldGljKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmFtZXMgPSBuYW1lczsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdE5hbWVzID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmFtZXMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2F0TmFtZXMgPSBuYW1lczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE5hbWVkQXJndW1lbnRzLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMobmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lcy5pbmRleE9mKG5hbWUpICE9PSAtMTsKICAgICAgICB9OwoKICAgICAgICBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KG5hbWUpIHsKICAgICAgICAgICAgdmFyIHN5bnRoZXRpYyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogdHJ1ZTsKICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgICBzdGFjayA9IHRoaXMuc3RhY2s7CgogICAgICAgICAgICB2YXIgbmFtZXMgPSBzeW50aGV0aWMgPyB0aGlzLm5hbWVzIDogdGhpcy5hdE5hbWVzOwogICAgICAgICAgICB2YXIgaWR4ID0gbmFtZXMuaW5kZXhPZihuYW1lKTsKICAgICAgICAgICAgaWYgKGlkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdGFjay5nZXQoaWR4LCBiYXNlKTsKICAgICAgICB9OwoKICAgICAgICBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cyh0aGlzLnRhZywgdGhpcy5uYW1lcywgdGhpcy5yZWZlcmVuY2VzKTsKICAgICAgICB9OwoKICAgICAgICBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUubWVyZ2UgPSBmdW5jdGlvbiBtZXJnZShvdGhlcikgewogICAgICAgICAgICB2YXIgZXh0cmFzID0gb3RoZXIubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGV4dHJhcyA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgICAgICAgICAgdmFyIGV4dHJhTmFtZXMgPSBvdGhlci5uYW1lczsKCiAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmlzRnJvemVuKG5hbWVzKSAmJiBuYW1lcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBleHRyYXM7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gZXh0cmFOYW1lc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gbmFtZXMuaW5kZXhPZihuYW1lKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG90aGVyLnJlZmVyZW5jZXNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzLl9uYW1lcyA9IG5hbWVzOwogICAgICAgICAgICAgICAgdGhpcy5fYXROYW1lcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBOYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUudG9TeW50aGV0aWNOYW1lID0gZnVuY3Rpb24gdG9TeW50aGV0aWNOYW1lKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIG5hbWUuc2xpY2UoMSk7CiAgICAgICAgfTsKCiAgICAgICAgTmFtZWRBcmd1bWVudHMucHJvdG90eXBlLnRvQXROYW1lID0gZnVuY3Rpb24gdG9BdE5hbWUobmFtZSkgewogICAgICAgICAgICByZXR1cm4gJ0AnICsgbmFtZTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKE5hbWVkQXJndW1lbnRzLCBbewogICAgICAgICAgICBrZXk6ICd0YWcnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX3JlZmVyZW5jZS5jb21iaW5lVGFnZ2VkKSh0aGlzLnJlZmVyZW5jZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICduYW1lcycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIG5hbWVzID0gdGhpcy5fbmFtZXM7CiAgICAgICAgICAgICAgICBpZiAoIW5hbWVzKSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZXMgPSB0aGlzLl9uYW1lcyA9IHRoaXMuX2F0TmFtZXMubWFwKHRoaXMudG9TeW50aGV0aWNOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuYW1lczsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnYXROYW1lcycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGF0TmFtZXMgPSB0aGlzLl9hdE5hbWVzOwogICAgICAgICAgICAgICAgaWYgKCFhdE5hbWVzKSB7CiAgICAgICAgICAgICAgICAgICAgYXROYW1lcyA9IHRoaXMuX2F0TmFtZXMgPSB0aGlzLl9uYW1lcy5tYXAodGhpcy50b0F0TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYXROYW1lczsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAncmVmZXJlbmNlcycsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZXMgPSB0aGlzLl9yZWZlcmVuY2VzOwogICAgICAgICAgICAgICAgaWYgKCFyZWZlcmVuY2VzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLmJhc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFjayA9IHRoaXMuc3RhY2s7CgogICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMgPSB0aGlzLl9yZWZlcmVuY2VzID0gc3RhY2suc2xpY2VBcnJheShiYXNlLCBiYXNlICsgbGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZWZlcmVuY2VzOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBOYW1lZEFyZ3VtZW50czsKICAgIH0oKTsKCiAgICB2YXIgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDYXB0dXJlZE5hbWVkQXJndW1lbnRzKHRhZywgbmFtZXMsIHJlZmVyZW5jZXMpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDYXB0dXJlZE5hbWVkQXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgICB0aGlzLm5hbWVzID0gbmFtZXM7CiAgICAgICAgICAgIHRoaXMucmVmZXJlbmNlcyA9IHJlZmVyZW5jZXM7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgICB0aGlzLl9tYXAgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZXMuaW5kZXhPZihuYW1lKSAhPT0gLTE7CiAgICAgICAgfTsKCiAgICAgICAgQ2FwdHVyZWROYW1lZEFyZ3VtZW50cy5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KG5hbWUpIHsKICAgICAgICAgICAgdmFyIG5hbWVzID0gdGhpcy5uYW1lcywKICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMgPSB0aGlzLnJlZmVyZW5jZXM7CgogICAgICAgICAgICB2YXIgaWR4ID0gbmFtZXMuaW5kZXhPZihuYW1lKTsKICAgICAgICAgICAgaWYgKGlkeCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZmVyZW5jZXNbaWR4XTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENhcHR1cmVkTmFtZWRBcmd1bWVudHMucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICAgICAgICAgICAgICByZWZlcmVuY2VzID0gdGhpcy5yZWZlcmVuY2VzOwoKICAgICAgICAgICAgdmFyIG91dCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gcmVmZXJlbmNlc1tpXS52YWx1ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDYXB0dXJlZE5hbWVkQXJndW1lbnRzLCBbewogICAgICAgICAgICBrZXk6ICdtYXAnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBtYXAgPSB0aGlzLl9tYXA7CiAgICAgICAgICAgICAgICBpZiAoIW1hcCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lcyA9IHRoaXMubmFtZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZXMgPSB0aGlzLnJlZmVyZW5jZXM7CgogICAgICAgICAgICAgICAgICAgIG1hcCA9IHRoaXMuX21hcCA9ICgwLCBfdXRpbC5kaWN0KSgpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwW25hbWVdID0gcmVmZXJlbmNlc1tpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBDYXB0dXJlZE5hbWVkQXJndW1lbnRzOwogICAgfSgpOwoKICAgIHZhciBCbG9ja0FyZ3VtZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBCbG9ja0FyZ3VtZW50cygpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBCbG9ja0FyZ3VtZW50cyk7CgogICAgICAgICAgICB0aGlzLmludGVybmFsVmFsdWVzID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFRhZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMubmFtZXMgPSBfdXRpbC5FTVBUWV9BUlJBWTsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLmJhc2UgPSAwOwogICAgICAgIH0KCiAgICAgICAgQmxvY2tBcmd1bWVudHMucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gZW1wdHkoc3RhY2ssIGJhc2UpIHsKICAgICAgICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICAgICAgICB0aGlzLm5hbWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFRhZyA9IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICB0aGlzLmludGVybmFsVmFsdWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tBcmd1bWVudHMucHJvdG90eXBlLnNldHVwID0gZnVuY3Rpb24gc2V0dXAoc3RhY2ssIGJhc2UsIGxlbmd0aCwgbmFtZXMpIHsKICAgICAgICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICAgICAgICB0aGlzLm5hbWVzID0gbmFtZXM7CiAgICAgICAgICAgIHRoaXMuYmFzZSA9IGJhc2U7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmludGVybmFsVGFnID0gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgICAgICAgICAgICB0aGlzLmludGVybmFsVmFsdWVzID0gX3V0aWwuRU1QVFlfQVJSQVk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmludGVybmFsVGFnID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQmxvY2tBcmd1bWVudHMucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWVzLmluZGV4T2YobmFtZSkgIT09IC0xOwogICAgICAgIH07CgogICAgICAgIEJsb2NrQXJndW1lbnRzLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQobmFtZSkgewogICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMuYmFzZSwKICAgICAgICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjaywKICAgICAgICAgICAgICAgIG5hbWVzID0gdGhpcy5uYW1lczsKCiAgICAgICAgICAgIHZhciBpZHggPSBuYW1lcy5pbmRleE9mKG5hbWUpOwogICAgICAgICAgICBpZiAobmFtZXMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWJsZSA9IHN0YWNrLmdldChpZHggKiAzLCBiYXNlKTsKICAgICAgICAgICAgdmFyIHNjb3BlID0gc3RhY2suZ2V0KGlkeCAqIDMgKyAxLCBiYXNlKTsgLy8gRklYTUUobW11bik6IHNob3VsZG4ndCBuZWVkIHRvIGNhc3QgdGhpcwogICAgICAgICAgICB2YXIgaGFuZGxlID0gc3RhY2suZ2V0KGlkeCAqIDMgKyAyLCBiYXNlKTsKICAgICAgICAgICAgcmV0dXJuIGhhbmRsZSA9PT0gbnVsbCA/IG51bGwgOiBbaGFuZGxlLCBzY29wZSwgdGFibGVdOwogICAgICAgIH07CgogICAgICAgIEJsb2NrQXJndW1lbnRzLnByb3RvdHlwZS5jYXB0dXJlID0gZnVuY3Rpb24gY2FwdHVyZSgpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBDYXB0dXJlZEJsb2NrQXJndW1lbnRzKHRoaXMubmFtZXMsIHRoaXMudmFsdWVzKTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEJsb2NrQXJndW1lbnRzLCBbewogICAgICAgICAgICBrZXk6ICd2YWx1ZXMnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSB0aGlzLmludGVybmFsVmFsdWVzOwogICAgICAgICAgICAgICAgaWYgKCF2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMuYmFzZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrID0gdGhpcy5zdGFjazsKCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gdGhpcy5pbnRlcm5hbFZhbHVlcyA9IHN0YWNrLnNsaWNlQXJyYXkoYmFzZSwgYmFzZSArIGxlbmd0aCAqIDMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gQmxvY2tBcmd1bWVudHM7CiAgICB9KCk7CgogICAgdmFyIENhcHR1cmVkQmxvY2tBcmd1bWVudHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ2FwdHVyZWRCbG9ja0FyZ3VtZW50cyhuYW1lcywgdmFsdWVzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ2FwdHVyZWRCbG9ja0FyZ3VtZW50cyk7CgogICAgICAgICAgICB0aGlzLm5hbWVzID0gbmFtZXM7CiAgICAgICAgICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgICAgICAgICB0aGlzLmxlbmd0aCA9IG5hbWVzLmxlbmd0aDsKICAgICAgICB9CgogICAgICAgIENhcHR1cmVkQmxvY2tBcmd1bWVudHMucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWVzLmluZGV4T2YobmFtZSkgIT09IC0xOwogICAgICAgIH07CgogICAgICAgIENhcHR1cmVkQmxvY2tBcmd1bWVudHMucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChuYW1lKSB7CiAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLm5hbWVzLmluZGV4T2YobmFtZSk7CiAgICAgICAgICAgIGlmIChpZHggPT09IC0xKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIFt0aGlzLnZhbHVlc1tpZHggKiAzICsgMl0sIHRoaXMudmFsdWVzW2lkeCAqIDMgKyAxXSwgdGhpcy52YWx1ZXNbaWR4ICogM11dOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBDYXB0dXJlZEJsb2NrQXJndW1lbnRzOwogICAgfSgpOwoKICAgIHZhciBFTVBUWV9OQU1FRCA9IG5ldyBDYXB0dXJlZE5hbWVkQXJndW1lbnRzKF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHLCBfdXRpbC5FTVBUWV9BUlJBWSwgX3V0aWwuRU1QVFlfQVJSQVkpOwogICAgdmFyIEVNUFRZX1BPU0lUSU9OQUwgPSBuZXcgQ2FwdHVyZWRQb3NpdGlvbmFsQXJndW1lbnRzKF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHLCBfdXRpbC5FTVBUWV9BUlJBWSk7CiAgICB2YXIgRU1QVFlfQVJHUyA9IHsKICAgICAgICB0YWc6IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHLAogICAgICAgIGxlbmd0aDogMCwKICAgICAgICBwb3NpdGlvbmFsOiBFTVBUWV9QT1NJVElPTkFMLAogICAgICAgIG5hbWVkOiBFTVBUWV9OQU1FRAogICAgfTsKCiAgICB2YXIgVk0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVk0ocnVudGltZSwgc2NvcGUsIGR5bmFtaWNTY29wZSwgZWxlbWVudFN0YWNrKSB7CiAgICAgICAgICAgIHZhciBfdGhpczMyID0gdGhpczsKCiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVk0pOwoKICAgICAgICAgICAgdGhpcy5ydW50aW1lID0gcnVudGltZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50U3RhY2sgPSBlbGVtZW50U3RhY2s7CiAgICAgICAgICAgIHRoaXMuZHluYW1pY1Njb3BlU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgICAgICAgdGhpcy5zY29wZVN0YWNrID0gbmV3IF91dGlsLlN0YWNrKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRpbmdPcGNvZGVTdGFjayA9IG5ldyBfdXRpbC5TdGFjaygpOwogICAgICAgICAgICB0aGlzLmNhY2hlR3JvdXBzID0gbmV3IF91dGlsLlN0YWNrKCk7CiAgICAgICAgICAgIHRoaXMubGlzdEJsb2NrU3RhY2sgPSBuZXcgX3V0aWwuU3RhY2soKTsKICAgICAgICAgICAgdGhpcy5zMCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuczEgPSBudWxsOwogICAgICAgICAgICB0aGlzLnQwID0gbnVsbDsKICAgICAgICAgICAgdGhpcy50MSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMudjAgPSBudWxsOwogICAgICAgICAgICB0aGlzLmhlYXAgPSB0aGlzLnByb2dyYW0uaGVhcDsKICAgICAgICAgICAgdGhpcy5jb25zdGFudHMgPSB0aGlzLnByb2dyYW0uY29uc3RhbnRzOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRTdGFjayA9IGVsZW1lbnRTdGFjazsKICAgICAgICAgICAgdGhpcy5zY29wZVN0YWNrLnB1c2goc2NvcGUpOwogICAgICAgICAgICB0aGlzLmR5bmFtaWNTY29wZVN0YWNrLnB1c2goZHluYW1pY1Njb3BlKTsKICAgICAgICAgICAgdGhpcy5hcmdzID0gbmV3IEFyZ3VtZW50cygpOwogICAgICAgICAgICB0aGlzLmlubmVyID0gbmV3IExvd0xldmVsVk0oRXZhbHVhdGlvblN0YWNrLmVtcHR5KCksIHRoaXMuaGVhcCwgcnVudGltZS5wcm9ncmFtLCB7CiAgICAgICAgICAgICAgICBkZWJ1Z0JlZm9yZTogZnVuY3Rpb24gKG9wY29kZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBBUFBFTkRfT1BDT0RFUy5kZWJ1Z0JlZm9yZShfdGhpczMyLCBvcGNvZGUsIG9wY29kZS50eXBlKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZWJ1Z0FmdGVyOiBmdW5jdGlvbiAob3Bjb2RlLCBzdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIEFQUEVORF9PUENPREVTLmRlYnVnQWZ0ZXIoX3RoaXMzMiwgb3Bjb2RlLCBvcGNvZGUudHlwZSwgc3RhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIFZNLnByb3RvdHlwZS5mZXRjaCA9IGZ1bmN0aW9uIGZldGNoKHJlZ2lzdGVyKSB7CiAgICAgICAgICAgIHRoaXMuc3RhY2sucHVzaCh0aGlzW192bTIuUmVnaXN0ZXJbcmVnaXN0ZXJdXSk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmxvYWQgPSBmdW5jdGlvbiBsb2FkKHJlZ2lzdGVyKSB7CiAgICAgICAgICAgIHRoaXNbX3ZtMi5SZWdpc3RlcltyZWdpc3Rlcl1dID0gdGhpcy5zdGFjay5wb3AoKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZmV0Y2hWYWx1ZSA9IGZ1bmN0aW9uIGZldGNoVmFsdWUocmVnaXN0ZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbX3ZtMi5SZWdpc3RlcltyZWdpc3Rlcl1dOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5sb2FkVmFsdWUgPSBmdW5jdGlvbiBsb2FkVmFsdWUocmVnaXN0ZXIsIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXNbX3ZtMi5SZWdpc3RlcltyZWdpc3Rlcl1dID0gdmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnB1c2hGcmFtZSA9IGZ1bmN0aW9uIHB1c2hGcmFtZSgpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci5wdXNoRnJhbWUoKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUucG9wRnJhbWUgPSBmdW5jdGlvbiBwb3BGcmFtZSgpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci5wb3BGcmFtZSgpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5nb3RvID0gZnVuY3Rpb24gZ290byhvZmZzZXQpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci5nb3RvKG9mZnNldCk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmNhbGwgPSBmdW5jdGlvbiBjYWxsKGhhbmRsZSkgewogICAgICAgICAgICB0aGlzLmlubmVyLmNhbGwoaGFuZGxlKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUucmV0dXJuVG8gPSBmdW5jdGlvbiByZXR1cm5UbyhvZmZzZXQpIHsKICAgICAgICAgICAgdGhpcy5pbm5lci5yZXR1cm5UbyhvZmZzZXQpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5yZXR1cm4gPSBmdW5jdGlvbiBfcmV0dXJuKCkgewogICAgICAgICAgICB0aGlzLmlubmVyLnJldHVybigpOwogICAgICAgIH07CgogICAgICAgIFZNLmluaXRpYWwgPSBmdW5jdGlvbiBpbml0aWFsKHByb2dyYW0sIGVudiwgc2VsZiwgZHluYW1pY1Njb3BlLCBlbGVtZW50U3RhY2ssIGhhbmRsZSkgewogICAgICAgICAgICB2YXIgc2NvcGVTaXplID0gcHJvZ3JhbS5oZWFwLnNjb3Blc2l6ZW9mKGhhbmRsZSk7CiAgICAgICAgICAgIHZhciBzY29wZSA9IFNjb3BlLnJvb3Qoc2VsZiwgc2NvcGVTaXplKTsKICAgICAgICAgICAgdmFyIHZtID0gbmV3IFZNKHsgcHJvZ3JhbTogcHJvZ3JhbSwgZW52OiBlbnYgfSwgc2NvcGUsIGR5bmFtaWNTY29wZSwgZWxlbWVudFN0YWNrKTsKICAgICAgICAgICAgdm0ucGMgPSB2bS5oZWFwLmdldGFkZHIoaGFuZGxlKTsKICAgICAgICAgICAgdm0udXBkYXRpbmdPcGNvZGVTdGFjay5wdXNoKG5ldyBfdXRpbC5MaW5rZWRMaXN0KCkpOwogICAgICAgICAgICByZXR1cm4gdm07CiAgICAgICAgfTsKCiAgICAgICAgVk0uZW1wdHkgPSBmdW5jdGlvbiBlbXB0eShwcm9ncmFtLCBlbnYsIGVsZW1lbnRTdGFjaykgewogICAgICAgICAgICB2YXIgZHluYW1pY1Njb3BlID0gewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2hpbGQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZHluYW1pY1Njb3BlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdm0gPSBuZXcgVk0oeyBwcm9ncmFtOiBwcm9ncmFtLCBlbnY6IGVudiB9LCBTY29wZS5yb290KFVOREVGSU5FRF9SRUZFUkVOQ0UsIDApLCBkeW5hbWljU2NvcGUsIGVsZW1lbnRTdGFjayk7CiAgICAgICAgICAgIHZtLnVwZGF0aW5nT3Bjb2RlU3RhY2sucHVzaChuZXcgX3V0aWwuTGlua2VkTGlzdCgpKTsKICAgICAgICAgICAgcmV0dXJuIHZtOwogICAgICAgIH07CgogICAgICAgIFZNLnJlc3VtZSA9IGZ1bmN0aW9uIHJlc3VtZShfcmVmNTgsIHJ1bnRpbWUsIHN0YWNrKSB7CiAgICAgICAgICAgIHZhciBzY29wZSA9IF9yZWY1OC5zY29wZSwKICAgICAgICAgICAgICAgIGR5bmFtaWNTY29wZSA9IF9yZWY1OC5keW5hbWljU2NvcGU7CgogICAgICAgICAgICByZXR1cm4gbmV3IFZNKHJ1bnRpbWUsIHNjb3BlLCBkeW5hbWljU2NvcGUsIHN0YWNrKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuY2FwdHVyZSA9IGZ1bmN0aW9uIGNhcHR1cmUoYXJncykgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZHluYW1pY1Njb3BlOiB0aGlzLmR5bmFtaWNTY29wZSgpLAogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMuc2NvcGUoKSwKICAgICAgICAgICAgICAgIHN0YWNrOiB0aGlzLnN0YWNrLmNhcHR1cmUoYXJncykKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuYmVnaW5DYWNoZUdyb3VwID0gZnVuY3Rpb24gYmVnaW5DYWNoZUdyb3VwKCkgewogICAgICAgICAgICB0aGlzLmNhY2hlR3JvdXBzLnB1c2godGhpcy51cGRhdGluZygpLnRhaWwoKSk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmNvbW1pdENhY2hlR3JvdXAgPSBmdW5jdGlvbiBjb21taXRDYWNoZUdyb3VwKCkgewogICAgICAgICAgICAvLyAgICAgICAgSnVtcElmTm90TW9kaWZpZWQoRU5EKQogICAgICAgICAgICAvLyAgICAgICAgKGhlYWQpCiAgICAgICAgICAgIC8vICAgICAgICAoLi4uLikKICAgICAgICAgICAgLy8gICAgICAgICh0YWlsKQogICAgICAgICAgICAvLyAgICAgICAgRGlkTW9kaWZ5CiAgICAgICAgICAgIC8vIEVORDogICBOb29wCiAgICAgICAgICAgIHZhciBFTkQgPSBuZXcgTGFiZWxPcGNvZGUoJ0VORCcpOwogICAgICAgICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMudXBkYXRpbmcoKTsKICAgICAgICAgICAgdmFyIG1hcmtlciA9IHRoaXMuY2FjaGVHcm91cHMucG9wKCk7CiAgICAgICAgICAgIHZhciBoZWFkID0gbWFya2VyID8gb3Bjb2Rlcy5uZXh0Tm9kZShtYXJrZXIpIDogb3Bjb2Rlcy5oZWFkKCk7CiAgICAgICAgICAgIHZhciB0YWlsID0gb3Bjb2Rlcy50YWlsKCk7CiAgICAgICAgICAgIHZhciB0YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lU2xpY2UpKG5ldyBfdXRpbC5MaXN0U2xpY2UoaGVhZCwgdGFpbCkpOwogICAgICAgICAgICB2YXIgZ3VhcmQgPSBuZXcgSnVtcElmTm90TW9kaWZpZWRPcGNvZGUodGFnLCBFTkQpOwogICAgICAgICAgICBvcGNvZGVzLmluc2VydEJlZm9yZShndWFyZCwgaGVhZCk7CiAgICAgICAgICAgIG9wY29kZXMuYXBwZW5kKG5ldyBEaWRNb2RpZnlPcGNvZGUoZ3VhcmQpKTsKICAgICAgICAgICAgb3Bjb2Rlcy5hcHBlbmQoRU5EKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZW50ZXIgPSBmdW5jdGlvbiBlbnRlcihhcmdzKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGluZyA9IG5ldyBfdXRpbC5MaW5rZWRMaXN0KCk7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuY2FwdHVyZShhcmdzKTsKICAgICAgICAgICAgdmFyIHRyYWNrZXIgPSB0aGlzLmVsZW1lbnRzKCkucHVzaFVwZGF0YWJsZUJsb2NrKCk7CiAgICAgICAgICAgIHZhciB0cnlPcGNvZGUgPSBuZXcgVHJ5T3Bjb2RlKHRoaXMuaGVhcC5nZXRoYW5kbGUodGhpcy5wYyksIHN0YXRlLCB0aGlzLnJ1bnRpbWUsIHRyYWNrZXIsIHVwZGF0aW5nKTsKICAgICAgICAgICAgdGhpcy5kaWRFbnRlcih0cnlPcGNvZGUpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5pdGVyYXRlID0gZnVuY3Rpb24gaXRlcmF0ZShtZW1vLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgICAgICBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgc3RhY2sucHVzaChtZW1vKTsKICAgICAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5jYXB0dXJlKDIpOwogICAgICAgICAgICB2YXIgdHJhY2tlciA9IHRoaXMuZWxlbWVudHMoKS5wdXNoVXBkYXRhYmxlQmxvY2soKTsKICAgICAgICAgICAgLy8gbGV0IGlwID0gdGhpcy5pcDsKICAgICAgICAgICAgLy8gdGhpcy5pcCA9IGVuZCArIDQ7CiAgICAgICAgICAgIC8vIHRoaXMuZnJhbWVzLnB1c2goaXApOwogICAgICAgICAgICByZXR1cm4gbmV3IFRyeU9wY29kZSh0aGlzLmhlYXAuZ2V0aGFuZGxlKHRoaXMucGMpLCBzdGF0ZSwgdGhpcy5ydW50aW1lLCB0cmFja2VyLCBuZXcgX3V0aWwuTGlua2VkTGlzdCgpKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZW50ZXJJdGVtID0gZnVuY3Rpb24gZW50ZXJJdGVtKGtleSwgb3Bjb2RlKSB7CiAgICAgICAgICAgIHRoaXMubGlzdEJsb2NrKCkubWFwW2tleV0gPSBvcGNvZGU7CiAgICAgICAgICAgIHRoaXMuZGlkRW50ZXIob3Bjb2RlKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZW50ZXJMaXN0ID0gZnVuY3Rpb24gZW50ZXJMaXN0KHJlbGF0aXZlU3RhcnQpIHsKICAgICAgICAgICAgdmFyIHVwZGF0aW5nID0gbmV3IF91dGlsLkxpbmtlZExpc3QoKTsKICAgICAgICAgICAgdmFyIHN0YXRlID0gdGhpcy5jYXB0dXJlKDApOwogICAgICAgICAgICB2YXIgdHJhY2tlciA9IHRoaXMuZWxlbWVudHMoKS5wdXNoQmxvY2tMaXN0KHVwZGF0aW5nKTsKICAgICAgICAgICAgdmFyIGFydGlmYWN0cyA9IHRoaXMuc3RhY2sucGVlaygpLmFydGlmYWN0czsKICAgICAgICAgICAgdmFyIGFkZHIgPSB0aGlzLnBjICsgcmVsYXRpdmVTdGFydCAtIHRoaXMuY3VycmVudE9wU2l6ZTsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5oZWFwLmdldGhhbmRsZShhZGRyKTsKICAgICAgICAgICAgdmFyIG9wY29kZSA9IG5ldyBMaXN0QmxvY2tPcGNvZGUoc3RhcnQsIHN0YXRlLCB0aGlzLnJ1bnRpbWUsIHRyYWNrZXIsIHVwZGF0aW5nLCBhcnRpZmFjdHMpOwogICAgICAgICAgICB0aGlzLmxpc3RCbG9ja1N0YWNrLnB1c2gob3Bjb2RlKTsKICAgICAgICAgICAgdGhpcy5kaWRFbnRlcihvcGNvZGUpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5kaWRFbnRlciA9IGZ1bmN0aW9uIGRpZEVudGVyKG9wY29kZSkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZVdpdGgob3Bjb2RlKTsKICAgICAgICAgICAgdGhpcy51cGRhdGluZ09wY29kZVN0YWNrLnB1c2gob3Bjb2RlLmNoaWxkcmVuKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZXhpdCA9IGZ1bmN0aW9uIGV4aXQoKSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMoKS5wb3BCbG9jaygpOwogICAgICAgICAgICB0aGlzLnVwZGF0aW5nT3Bjb2RlU3RhY2sucG9wKCk7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnVwZGF0aW5nKCkudGFpbCgpOwogICAgICAgICAgICBwYXJlbnQuZGlkSW5pdGlhbGl6ZUNoaWxkcmVuKCk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmV4aXRMaXN0ID0gZnVuY3Rpb24gZXhpdExpc3QoKSB7CiAgICAgICAgICAgIHRoaXMuZXhpdCgpOwogICAgICAgICAgICB0aGlzLmxpc3RCbG9ja1N0YWNrLnBvcCgpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS51cGRhdGVXaXRoID0gZnVuY3Rpb24gdXBkYXRlV2l0aChvcGNvZGUpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGluZygpLmFwcGVuZChvcGNvZGUpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5saXN0QmxvY2sgPSBmdW5jdGlvbiBsaXN0QmxvY2soKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpc3RCbG9ja1N0YWNrLmN1cnJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnVwZGF0aW5nID0gZnVuY3Rpb24gdXBkYXRpbmcoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0aW5nT3Bjb2RlU3RhY2suY3VycmVudDsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZWxlbWVudHMgPSBmdW5jdGlvbiBlbGVtZW50cygpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudFN0YWNrOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5zY29wZSA9IGZ1bmN0aW9uIHNjb3BlKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zY29wZVN0YWNrLmN1cnJlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmR5bmFtaWNTY29wZSA9IGZ1bmN0aW9uIGR5bmFtaWNTY29wZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZHluYW1pY1Njb3BlU3RhY2suY3VycmVudDsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUucHVzaENoaWxkU2NvcGUgPSBmdW5jdGlvbiBwdXNoQ2hpbGRTY29wZSgpIHsKICAgICAgICAgICAgdGhpcy5zY29wZVN0YWNrLnB1c2godGhpcy5zY29wZSgpLmNoaWxkKCkpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5wdXNoRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcHVzaER5bmFtaWNTY29wZSgpIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5keW5hbWljU2NvcGUoKS5jaGlsZCgpOwogICAgICAgICAgICB0aGlzLmR5bmFtaWNTY29wZVN0YWNrLnB1c2goY2hpbGQpOwogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnB1c2hSb290U2NvcGUgPSBmdW5jdGlvbiBwdXNoUm9vdFNjb3BlKHNpemUsIGJpbmRDYWxsZXIpIHsKICAgICAgICAgICAgdmFyIHNjb3BlID0gU2NvcGUuc2l6ZWQoc2l6ZSk7CiAgICAgICAgICAgIGlmIChiaW5kQ2FsbGVyKSBzY29wZS5iaW5kQ2FsbGVyU2NvcGUodGhpcy5zY29wZSgpKTsKICAgICAgICAgICAgdGhpcy5zY29wZVN0YWNrLnB1c2goc2NvcGUpOwogICAgICAgICAgICByZXR1cm4gc2NvcGU7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnB1c2hTY29wZSA9IGZ1bmN0aW9uIHB1c2hTY29wZShzY29wZSkgewogICAgICAgICAgICB0aGlzLnNjb3BlU3RhY2sucHVzaChzY29wZSk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnBvcFNjb3BlID0gZnVuY3Rpb24gcG9wU2NvcGUoKSB7CiAgICAgICAgICAgIHRoaXMuc2NvcGVTdGFjay5wb3AoKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUucG9wRHluYW1pY1Njb3BlID0gZnVuY3Rpb24gcG9wRHluYW1pY1Njb3BlKCkgewogICAgICAgICAgICB0aGlzLmR5bmFtaWNTY29wZVN0YWNrLnBvcCgpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5uZXdEZXN0cm95YWJsZSA9IGZ1bmN0aW9uIG5ld0Rlc3Ryb3lhYmxlKGQpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cygpLmRpZEFkZERlc3Ryb3lhYmxlKGQpOwogICAgICAgIH07CgogICAgICAgIFZNLnByb3RvdHlwZS5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NvcGUoKS5nZXRTZWxmKCk7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLnJlZmVyZW5jZUZvclN5bWJvbCA9IGZ1bmN0aW9uIHJlZmVyZW5jZUZvclN5bWJvbChzeW1ib2wpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NvcGUoKS5nZXRTeW1ib2woc3ltYm9sKTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUuZXhlY3V0ZSA9IGZ1bmN0aW9uIGV4ZWN1dGUoc3RhcnQsIGluaXRpYWxpemUpIHsKICAgICAgICAgICAgdGhpcy5wYyA9IHRoaXMuaGVhcC5nZXRhZGRyKHN0YXJ0KTsKICAgICAgICAgICAgaWYgKGluaXRpYWxpemUpIGluaXRpYWxpemUodGhpcyk7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLm5leHQoKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuZG9uZSkgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC52YWx1ZTsKICAgICAgICB9OwoKICAgICAgICBWTS5wcm90b3R5cGUubmV4dCA9IGZ1bmN0aW9uIG5leHQoKSB7CiAgICAgICAgICAgIHZhciBlbnYgPSB0aGlzLmVudiwKICAgICAgICAgICAgICAgIHByb2dyYW0gPSB0aGlzLnByb2dyYW0sCiAgICAgICAgICAgICAgICB1cGRhdGluZ09wY29kZVN0YWNrID0gdGhpcy51cGRhdGluZ09wY29kZVN0YWNrLAogICAgICAgICAgICAgICAgZWxlbWVudFN0YWNrID0gdGhpcy5lbGVtZW50U3RhY2s7CgogICAgICAgICAgICB2YXIgb3Bjb2RlID0gdGhpcy5pbm5lci5uZXh0U3RhdGVtZW50KCk7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChvcGNvZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5uZXIuZXZhbHVhdGVPdXRlcihvcGNvZGUsIHRoaXMpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0geyBkb25lOiBmYWxzZSwgdmFsdWU6IG51bGwgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFVubG9hZCB0aGUgc3RhY2sKICAgICAgICAgICAgICAgIHRoaXMuc3RhY2sucmVzZXQoKTsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICBkb25lOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgUmVuZGVyUmVzdWx0KGVudiwgcHJvZ3JhbSwgdXBkYXRpbmdPcGNvZGVTdGFjay5wb3AoKSwgZWxlbWVudFN0YWNrLnBvcEJsb2NrKCkpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKCiAgICAgICAgVk0ucHJvdG90eXBlLmJpbmREeW5hbWljU2NvcGUgPSBmdW5jdGlvbiBiaW5kRHluYW1pY1Njb3BlKG5hbWVzKSB7CiAgICAgICAgICAgIHZhciBzY29wZSA9IHRoaXMuZHluYW1pY1Njb3BlKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBuYW1lcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSB0aGlzLmNvbnN0YW50cy5nZXRTdHJpbmcobmFtZXNbaV0pOwogICAgICAgICAgICAgICAgc2NvcGUuc2V0KG5hbWUsIHRoaXMuc3RhY2sucG9wKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShWTSwgW3sKICAgICAgICAgICAga2V5OiAnc3RhY2snLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlubmVyLnN0YWNrOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5pbm5lci5zdGFjayA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICdjdXJyZW50T3BTaXplJywKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5uZXIuY3VycmVudE9wU2l6ZSA9IHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlubmVyLmN1cnJlbnRPcFNpemU7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ3BjJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbm5lci5wYzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgICAgICB0aGlzLmlubmVyLnBjID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ3JhJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbm5lci5yYTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5uZXIucmEgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnZnAnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YWNrLmZwOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChmcCkgewogICAgICAgICAgICAgICAgdGhpcy5zdGFjay5mcCA9IGZwOwogICAgICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgICBrZXk6ICdzcCcsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2suc3A7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHNwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YWNrLnNwID0gc3A7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ3Byb2dyYW0nLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bnRpbWUucHJvZ3JhbTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHsKICAgICAgICAgICAga2V5OiAnZW52JywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW50aW1lLmVudjsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gVk07CiAgICB9KCk7CgogICAgdmFyIFRlbXBsYXRlSXRlcmF0b3JJbXBsID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVGVtcGxhdGVJdGVyYXRvckltcGwpOwoKICAgICAgICAgICAgdGhpcy52bSA9IHZtOwogICAgICAgIH0KCiAgICAgICAgVGVtcGxhdGVJdGVyYXRvckltcGwucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52bS5uZXh0KCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFRlbXBsYXRlSXRlcmF0b3JJbXBsOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIHJlbmRlcihwcm9ncmFtLCBlbnYsIHNlbGYsIGR5bmFtaWNTY29wZSwgYnVpbGRlciwgaGFuZGxlKSB7CiAgICAgICAgdmFyIHZtID0gVk0uaW5pdGlhbChwcm9ncmFtLCBlbnYsIHNlbGYsIGR5bmFtaWNTY29wZSwgYnVpbGRlciwgaGFuZGxlKTsKICAgICAgICByZXR1cm4gbmV3IFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKTsKICAgIH0KCiAgICB2YXIgRHluYW1pY1ZhclJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBEeW5hbWljVmFyUmVmZXJlbmNlKHNjb3BlLCBuYW1lUmVmKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRHluYW1pY1ZhclJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLnNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgIHRoaXMubmFtZVJlZiA9IG5hbWVSZWY7CiAgICAgICAgICAgIHZhciB2YXJUYWcgPSB0aGlzLnZhclRhZyA9IF9yZWZlcmVuY2UuVXBkYXRhYmxlVGFnLmNyZWF0ZShfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRyk7CiAgICAgICAgICAgIHRoaXMudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW25hbWVSZWYudGFnLCB2YXJUYWddKTsKICAgICAgICB9CgogICAgICAgIER5bmFtaWNWYXJSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhcigpLnZhbHVlKCk7CiAgICAgICAgfTsKCiAgICAgICAgRHluYW1pY1ZhclJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYXIoKS5nZXQoa2V5KTsKICAgICAgICB9OwoKICAgICAgICBEeW5hbWljVmFyUmVmZXJlbmNlLnByb3RvdHlwZS5nZXRWYXIgPSBmdW5jdGlvbiBnZXRWYXIoKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gU3RyaW5nKHRoaXMubmFtZVJlZi52YWx1ZSgpKTsKICAgICAgICAgICAgdmFyIHJlZiA9IHRoaXMuc2NvcGUuZ2V0KG5hbWUpOwogICAgICAgICAgICB0aGlzLnZhclRhZy5pbm5lci51cGRhdGUocmVmLnRhZyk7CiAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIER5bmFtaWNWYXJSZWZlcmVuY2U7CiAgICB9KCk7CgogICAgZnVuY3Rpb24gZ2V0RHluYW1pY1Zhcih2bSwgYXJncykgewogICAgICAgIHZhciBzY29wZSA9IHZtLmR5bmFtaWNTY29wZSgpOwogICAgICAgIHZhciBuYW1lUmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgICAgIHJldHVybiBuZXcgRHluYW1pY1ZhclJlZmVyZW5jZShzY29wZSwgbmFtZVJlZik7CiAgICB9CgogICAgLyoqIEBpbnRlcm5hbCAqLwogICAgdmFyIERFRkFVTFRfQ0FQQUJJTElUSUVTID0gewogICAgICAgIGR5bmFtaWNMYXlvdXQ6IHRydWUsCiAgICAgICAgZHluYW1pY1RhZzogdHJ1ZSwKICAgICAgICBwcmVwYXJlQXJnczogdHJ1ZSwKICAgICAgICBjcmVhdGVBcmdzOiB0cnVlLAogICAgICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgICAgIGVsZW1lbnRIb29rOiBmYWxzZSwKICAgICAgICBkeW5hbWljU2NvcGU6IHRydWUsCiAgICAgICAgY3JlYXRlQ2FsbGVyOiBmYWxzZSwKICAgICAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiB0cnVlCiAgICB9OwogICAgdmFyIE1JTklNQUxfQ0FQQUJJTElUSUVTID0gewogICAgICAgIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLAogICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgIHByZXBhcmVBcmdzOiBmYWxzZSwKICAgICAgICBjcmVhdGVBcmdzOiBmYWxzZSwKICAgICAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgICAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICAgICAgZHluYW1pY1Njb3BlOiBmYWxzZSwKICAgICAgICBjcmVhdGVDYWxsZXI6IGZhbHNlLAogICAgICAgIHVwZGF0ZUhvb2s6IGZhbHNlLAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmYWxzZQogICAgfTsKCiAgICB2YXIgUmVoeWRyYXRpbmdDdXJzb3IgPSBmdW5jdGlvbiAoX0N1cnNvcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUmVoeWRyYXRpbmdDdXJzb3IsIF9DdXJzb3IpOwoKICAgICAgICBmdW5jdGlvbiBSZWh5ZHJhdGluZ0N1cnNvcihlbGVtZW50LCBuZXh0U2libGluZywgc3RhcnRpbmdCbG9ja0RlcHRoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVoeWRyYXRpbmdDdXJzb3IpOwoKICAgICAgICAgICAgdmFyIF90aGlzMzMgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0N1cnNvci5jYWxsKHRoaXMsIGVsZW1lbnQsIG5leHRTaWJsaW5nKSk7CgogICAgICAgICAgICBfdGhpczMzLnN0YXJ0aW5nQmxvY2tEZXB0aCA9IHN0YXJ0aW5nQmxvY2tEZXB0aDsKICAgICAgICAgICAgX3RoaXMzMy5jYW5kaWRhdGUgPSBudWxsOwogICAgICAgICAgICBfdGhpczMzLmluamVjdGVkT21pdHRlZE5vZGUgPSBmYWxzZTsKICAgICAgICAgICAgX3RoaXMzMy5vcGVuQmxvY2tEZXB0aCA9IHN0YXJ0aW5nQmxvY2tEZXB0aCAtIDE7CiAgICAgICAgICAgIHJldHVybiBfdGhpczMzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIFJlaHlkcmF0aW5nQ3Vyc29yOwogICAgfShDdXJzb3IpOwoKICAgIHZhciBSZWh5ZHJhdGVCdWlsZGVyID0gZnVuY3Rpb24gKF9OZXdFbGVtZW50QnVpbGRlcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUmVoeWRyYXRlQnVpbGRlciwgX05ld0VsZW1lbnRCdWlsZGVyKTsKCiAgICAgICAgLy8gcHJpdmF0ZSBjYW5kaWRhdGU6IE9wdGlvbjxTaW1wbGUuTm9kZT4gPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIFJlaHlkcmF0ZUJ1aWxkZXIoZW52LCBwYXJlbnROb2RlLCBuZXh0U2libGluZykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJlaHlkcmF0ZUJ1aWxkZXIpOwoKICAgICAgICAgICAgdmFyIF90aGlzMzQgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX05ld0VsZW1lbnRCdWlsZGVyLmNhbGwodGhpcywgZW52LCBwYXJlbnROb2RlLCBuZXh0U2libGluZykpOwoKICAgICAgICAgICAgX3RoaXMzNC51bm1hdGNoZWRBdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgICAgICAgX3RoaXMzNC5ibG9ja0RlcHRoID0gMDsKICAgICAgICAgICAgaWYgKG5leHRTaWJsaW5nKSB0aHJvdyBuZXcgRXJyb3IoJ1JlaHlkcmF0aW9uIHdpdGggbmV4dFNpYmxpbmcgbm90IHN1cHBvcnRlZCcpOwogICAgICAgICAgICB2YXIgbm9kZSA9IF90aGlzMzQuY3VycmVudEN1cnNvci5lbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNDb21tZW50KG5vZGUpICYmICgwLCBfdXRpbC5pc1NlcmlhbGl6YXRpb25GaXJzdE5vZGUpKG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RoaXMzNC5jYW5kaWRhdGUgPSBub2RlOwogICAgICAgICAgICByZXR1cm4gX3RoaXMzNDsKICAgICAgICB9CgogICAgICAgIFJlaHlkcmF0ZUJ1aWxkZXIucHJvdG90eXBlLnB1c2hFbGVtZW50ID0gZnVuY3Rpb24gcHVzaEVsZW1lbnQoZWxlbWVudCwgbmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdmFyIF9ibG9ja0RlcHRoID0gdGhpcy5ibG9ja0RlcHRoLAogICAgICAgICAgICAgICAgYmxvY2tEZXB0aCA9IF9ibG9ja0RlcHRoID09PSB1bmRlZmluZWQgPyAwIDogX2Jsb2NrRGVwdGg7CgogICAgICAgICAgICB2YXIgY3Vyc29yID0gbmV3IFJlaHlkcmF0aW5nQ3Vyc29yKGVsZW1lbnQsIG5leHRTaWJsaW5nLCBibG9ja0RlcHRoKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDdXJzb3IgPSB0aGlzLmN1cnJlbnRDdXJzb3I7CiAgICAgICAgICAgIGlmIChjdXJyZW50Q3Vyc29yKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEN1cnNvci5jYW5kaWRhdGUpIHsKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiA8ZGl2PiAgIDwtLS0tLS0tLS0tLS0tLS0gIGN1cnJlbnRDdXJzb3IuZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAqICAgPCEtLSUrYjoxJS0tPgogICAgICAgICAgICAgICAgICAgICAqICAgPGRpdj4gPC0tLS0tLS0tLS0tLS0tLSAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUgLT4gY3Vyc29yLmVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgKiAgICAgPCEtLSUrYjoyJS0tPiA8LSAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUuZmlyc3RDaGlsZCAtPiBjdXJzb3IuY2FuZGlkYXRlCiAgICAgICAgICAgICAgICAgICAgICogICAgIEZvbwogICAgICAgICAgICAgICAgICAgICAqICAgICA8IS0tJS1iOjIlLS0+CiAgICAgICAgICAgICAgICAgICAgICogICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgKiAgIDwhLS0lLWI6MSUtLT4gIDwtLSAgYmVjb21lcyBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZQogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIC8vIHdoZXJlIHRvIHJlaHlkcmF0ZSBmcm9tIGlmIHdlIGFyZSBpbiByZWh5ZHJhdGlvbiBtb2RlCiAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmNhbmRpZGF0ZSA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgICAgICAvLyB3aGVyZSB0byBjb250aW51ZSB3aGVuIHdlIHBvcAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnNvclN0YWNrLnB1c2goY3Vyc29yKTsKICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5jbGVhck1pc21hdGNoID0gZnVuY3Rpb24gY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBjYW5kaWRhdGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwogICAgICAgICAgICBpZiAoY3VycmVudEN1cnNvciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG9wZW5CbG9ja0RlcHRoID0gY3VycmVudEN1cnNvci5vcGVuQmxvY2tEZXB0aDsKICAgICAgICAgICAgICAgIGlmIChvcGVuQmxvY2tEZXB0aCA+PSBjdXJyZW50Q3Vyc29yLnN0YXJ0aW5nQmxvY2tEZXB0aCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICYmICEoaXNDb21tZW50KGN1cnJlbnQpICYmIGdldENsb3NlQmxvY2tEZXB0aChjdXJyZW50KSA9PT0gb3BlbkJsb2NrRGVwdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnJlbW92ZShjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnJlbW92ZShjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBjdXJyZW50IGN1cnNvciBwYXJlbnROb2RlIHNob3VsZCBiZSBvcGVuQ2FuZGlkYXRlIGlmIGVsZW1lbnQKICAgICAgICAgICAgICAgIC8vIG9yIG9wZW5DYW5kaWRhdGUucGFyZW50Tm9kZSBpZiBjb21tZW50CiAgICAgICAgICAgICAgICBjdXJyZW50Q3Vyc29yLm5leHRTaWJsaW5nID0gY3VycmVudDsKICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgcmVoeWRyYXRpb24gdW50aWwgd2UgcG9wRWxlbWVudCBvciBjbG9zZUJsb2NrIGZvciBvcGVuQmxvY2tEZXB0aAogICAgICAgICAgICAgICAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19vcGVuQmxvY2sgPSBmdW5jdGlvbiBfX29wZW5CbG9jaygpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDdXJzb3IgPSB0aGlzLmN1cnJlbnRDdXJzb3I7CgogICAgICAgICAgICBpZiAoY3VycmVudEN1cnNvciA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgICAgICB2YXIgYmxvY2tEZXB0aCA9IHRoaXMuYmxvY2tEZXB0aDsKICAgICAgICAgICAgdGhpcy5ibG9ja0RlcHRoKys7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZTsKCiAgICAgICAgICAgIGlmIChjYW5kaWRhdGUgPT09IG51bGwpIHJldHVybjsKICAgICAgICAgICAgaWYgKGlzQ29tbWVudChjYW5kaWRhdGUpICYmIGdldE9wZW5CbG9ja0RlcHRoKGNhbmRpZGF0ZSkgPT09IGJsb2NrRGVwdGgpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlID0gdGhpcy5yZW1vdmUoY2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRDdXJzb3Iub3BlbkJsb2NrRGVwdGggPSBibG9ja0RlcHRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKGNhbmRpZGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5fX2Nsb3NlQmxvY2sgPSBmdW5jdGlvbiBfX2Nsb3NlQmxvY2soKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q3Vyc29yID0gdGhpcy5jdXJyZW50Q3Vyc29yOwoKICAgICAgICAgICAgaWYgKGN1cnJlbnRDdXJzb3IgPT09IG51bGwpIHJldHVybjsKICAgICAgICAgICAgLy8gb3BlbkJsb2NrIGlzIHRoZSBsYXN0IHJlaHlkcmF0ZWQgb3BlbiBibG9jawogICAgICAgICAgICB2YXIgb3BlbkJsb2NrRGVwdGggPSBjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoOwogICAgICAgICAgICAvLyB0aGlzIGN1cnJlbnRseSBpcyB0aGUgZXhwZWN0ZWQgbmV4dCBvcGVuIGJsb2NrIGRlcHRoCiAgICAgICAgICAgIHRoaXMuYmxvY2tEZXB0aC0tOwogICAgICAgICAgICB2YXIgY2FuZGlkYXRlID0gY3VycmVudEN1cnNvci5jYW5kaWRhdGU7CgogICAgICAgICAgICAvLyByZWh5ZHJhdGluZwogICAgICAgICAgICBpZiAoY2FuZGlkYXRlICE9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgaWYgKGlzQ29tbWVudChjYW5kaWRhdGUpICYmIGdldENsb3NlQmxvY2tEZXB0aChjYW5kaWRhdGUpID09PSBvcGVuQmxvY2tEZXB0aCkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlID0gdGhpcy5yZW1vdmUoY2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoLS07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gaWYgdGhlIG9wZW5CbG9ja0RlcHRoIG1hdGNoZXMgdGhlIGJsb2NrRGVwdGggd2UganVzdCBjbG9zZWQgdG8KICAgICAgICAgICAgICAgIC8vIHRoZW4gcmVzdG9yZSByZWh5ZHJhdGlvbgogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50Q3Vyc29yLm9wZW5CbG9ja0RlcHRoID09PSB0aGlzLmJsb2NrRGVwdGgpIHsKCiAgICAgICAgICAgICAgICBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKGN1cnJlbnRDdXJzb3IubmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgY3VycmVudEN1cnNvci5vcGVuQmxvY2tEZXB0aC0tOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmROb2RlID0gZnVuY3Rpb24gX19hcHBlbmROb2RlKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZSA9IHRoaXMuY2FuZGlkYXRlOwoKICAgICAgICAgICAgLy8gVGhpcyBjb2RlIHBhdGggaXMgb25seSB1c2VkIHdoZW4gaW5zZXJ0aW5nIHByZWNpc2VseSBvbmUgbm9kZS4gSXQgbmVlZHMgbW9yZQogICAgICAgICAgICAvLyBjb21wYXJpc29uIGxvZ2ljLCBidXQgd2UgY2FuIHByb2JhYmx5IGxlYW4gb24gdGhlIGNhc2VzIHdoZXJlIHRoaXMgY29kZSBwYXRoCiAgICAgICAgICAgIC8vIGlzIGFjdHVhbGx5IHVzZWQuCiAgICAgICAgICAgIGlmIChjYW5kaWRhdGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZE5vZGUuY2FsbCh0aGlzLCBub2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFJlaHlkcmF0ZUJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kSFRNTCA9IGZ1bmN0aW9uIF9fYXBwZW5kSFRNTChodG1sKSB7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVCb3VuZHMgPSB0aGlzLm1hcmtlckJvdW5kcygpOwogICAgICAgICAgICBpZiAoY2FuZGlkYXRlQm91bmRzKSB7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBjYW5kaWRhdGVCb3VuZHMuZmlyc3ROb2RlKCk7CiAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IGNhbmRpZGF0ZUJvdW5kcy5sYXN0Tm9kZSgpOwogICAgICAgICAgICAgICAgdmFyIG5ld0JvdW5kcyA9IGJvdW5kcyh0aGlzLmVsZW1lbnQsIGZpcnN0Lm5leHRTaWJsaW5nLCBsYXN0LnByZXZpb3VzU2libGluZyk7CiAgICAgICAgICAgICAgICB2YXIgcG9zc2libGVFbXB0eU1hcmtlciA9IHRoaXMucmVtb3ZlKGZpcnN0KTsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGxhc3QpOwogICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlRW1wdHlNYXJrZXIgIT09IG51bGwgJiYgaXNFbXB0eSQxKHBvc3NpYmxlRW1wdHlNYXJrZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSB0aGlzLnJlbW92ZShwb3NzaWJsZUVtcHR5TWFya2VyKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKHRoaXMuY2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3Qm91bmRzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRIVE1MLmNhbGwodGhpcywgaHRtbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiByZW1vdmUobm9kZSkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgdmFyIG5leHQgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5tYXJrZXJCb3VuZHMgPSBmdW5jdGlvbiBtYXJrZXJCb3VuZHMoKSB7CiAgICAgICAgICAgIHZhciBfY2FuZGlkYXRlID0gdGhpcy5jYW5kaWRhdGU7CiAgICAgICAgICAgIGlmIChfY2FuZGlkYXRlICYmIGlzTWFya2VyKF9jYW5kaWRhdGUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBfY2FuZGlkYXRlOwogICAgICAgICAgICAgICAgdmFyIGxhc3QgPSBmaXJzdC5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgIHdoaWxlIChsYXN0ICYmICFpc01hcmtlcihsYXN0KSkgewogICAgICAgICAgICAgICAgICAgIGxhc3QgPSBsYXN0Lm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGJvdW5kcyh0aGlzLmVsZW1lbnQsIGZpcnN0LCBsYXN0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRUZXh0ID0gZnVuY3Rpb24gX19hcHBlbmRUZXh0KHN0cmluZykgewogICAgICAgICAgICB2YXIgY2FuZGlkYXRlID0gdGhpcy5jYW5kaWRhdGU7CgogICAgICAgICAgICBpZiAoY2FuZGlkYXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUZXh0Tm9kZShjYW5kaWRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZS5ub2RlVmFsdWUgIT09IHN0cmluZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYW5kaWRhdGUubm9kZVZhbHVlID0gc3RyaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmRpZGF0ZSA9IGNhbmRpZGF0ZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYW5kaWRhdGUgJiYgKGlzU2VwYXJhdG9yKGNhbmRpZGF0ZSkgfHwgaXNFbXB0eSQxKGNhbmRpZGF0ZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBjYW5kaWRhdGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoY2FuZGlkYXRlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fX2FwcGVuZFRleHQoc3RyaW5nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFbXB0eSQxKGNhbmRpZGF0ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHRoaXMucmVtb3ZlKGNhbmRpZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBuZXh0OwogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gdGhpcy5kb20uY3JlYXRlVGV4dE5vZGUoc3RyaW5nKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUodGhpcy5lbGVtZW50LCB0ZXh0LCBuZXh0KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhck1pc21hdGNoKGNhbmRpZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19hcHBlbmRUZXh0LmNhbGwodGhpcywgc3RyaW5nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fYXBwZW5kVGV4dC5jYWxsKHRoaXMsIHN0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZENvbW1lbnQgPSBmdW5jdGlvbiBfX2FwcGVuZENvbW1lbnQoc3RyaW5nKSB7CiAgICAgICAgICAgIHZhciBfY2FuZGlkYXRlID0gdGhpcy5jYW5kaWRhdGU7CiAgICAgICAgICAgIGlmIChfY2FuZGlkYXRlICYmIGlzQ29tbWVudChfY2FuZGlkYXRlKSkgewogICAgICAgICAgICAgICAgaWYgKF9jYW5kaWRhdGUubm9kZVZhbHVlICE9PSBzdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgICBfY2FuZGlkYXRlLm5vZGVWYWx1ZSA9IHN0cmluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2FuZGlkYXRlID0gX2NhbmRpZGF0ZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICAgIHJldHVybiBfY2FuZGlkYXRlOwogICAgICAgICAgICB9IGVsc2UgaWYgKF9jYW5kaWRhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChfY2FuZGlkYXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS5fX2FwcGVuZENvbW1lbnQuY2FsbCh0aGlzLCBzdHJpbmcpOwogICAgICAgIH07CgogICAgICAgIFJlaHlkcmF0ZUJ1aWxkZXIucHJvdG90eXBlLl9fb3BlbkVsZW1lbnQgPSBmdW5jdGlvbiBfX29wZW5FbGVtZW50KHRhZykgewogICAgICAgICAgICB2YXIgX2NhbmRpZGF0ZSA9IHRoaXMuY2FuZGlkYXRlOwogICAgICAgICAgICBpZiAoX2NhbmRpZGF0ZSAmJiBpc0VsZW1lbnQoX2NhbmRpZGF0ZSkgJiYgaXNTYW1lTm9kZVR5cGUoX2NhbmRpZGF0ZSwgdGFnKSkgewogICAgICAgICAgICAgICAgdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzID0gW10uc2xpY2UuY2FsbChfY2FuZGlkYXRlLmF0dHJpYnV0ZXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jYW5kaWRhdGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoX2NhbmRpZGF0ZSkgewogICAgICAgICAgICAgICAgaWYgKGlzRWxlbWVudChfY2FuZGlkYXRlKSAmJiBfY2FuZGlkYXRlLnRhZ05hbWUgPT09ICdUQk9EWScpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hFbGVtZW50KF9jYW5kaWRhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEN1cnNvci5pbmplY3RlZE9taXR0ZWROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fX29wZW5FbGVtZW50KHRhZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyTWlzbWF0Y2goX2NhbmRpZGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19vcGVuRWxlbWVudC5jYWxsKHRoaXMsIHRhZyk7CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBfX3NldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlKSB7CiAgICAgICAgICAgIHZhciB1bm1hdGNoZWQgPSB0aGlzLnVubWF0Y2hlZEF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGlmICh1bm1hdGNoZWQpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRyID0gZmluZEJ5TmFtZSh1bm1hdGNoZWQsIG5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci52YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1bm1hdGNoZWQuc3BsaWNlKHVubWF0Y2hlZC5pbmRleE9mKGF0dHIpLCAxKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19zZXRBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlKTsKICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5fX3NldFByb3BlcnR5ID0gZnVuY3Rpb24gX19zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgdW5tYXRjaGVkID0gdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzOwogICAgICAgICAgICBpZiAodW5tYXRjaGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGZpbmRCeU5hbWUodW5tYXRjaGVkLCBuYW1lKTsKICAgICAgICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdW5tYXRjaGVkLnNwbGljZSh1bm1hdGNoZWQuaW5kZXhPZihhdHRyKSwgMSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfTmV3RWxlbWVudEJ1aWxkZXIucHJvdG90eXBlLl9fc2V0UHJvcGVydHkuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19mbHVzaEVsZW1lbnQgPSBmdW5jdGlvbiBfX2ZsdXNoRWxlbWVudChwYXJlbnQsIGNvbnN0cnVjdGluZykgewogICAgICAgICAgICB2YXIgdW5tYXRjaGVkID0gdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzOwoKICAgICAgICAgICAgaWYgKHVubWF0Y2hlZCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1bm1hdGNoZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdGluZy5yZW1vdmVBdHRyaWJ1dGUodW5tYXRjaGVkW2ldLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy51bm1hdGNoZWRBdHRyaWJ1dGVzID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuX19mbHVzaEVsZW1lbnQuY2FsbCh0aGlzLCBwYXJlbnQsIGNvbnN0cnVjdGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS53aWxsQ2xvc2VFbGVtZW50ID0gZnVuY3Rpb24gd2lsbENsb3NlRWxlbWVudCgpIHsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZSA9IHRoaXMuY2FuZGlkYXRlLAogICAgICAgICAgICAgICAgY3VycmVudEN1cnNvciA9IHRoaXMuY3VycmVudEN1cnNvcjsKCiAgICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJNaXNtYXRjaChjYW5kaWRhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50Q3Vyc29yICYmIGN1cnJlbnRDdXJzb3IuaW5qZWN0ZWRPbWl0dGVkTm9kZSkgewogICAgICAgICAgICAgICAgdGhpcy5wb3BFbGVtZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX05ld0VsZW1lbnRCdWlsZGVyLnByb3RvdHlwZS53aWxsQ2xvc2VFbGVtZW50LmNhbGwodGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuZ2V0TWFya2VyID0gZnVuY3Rpb24gZ2V0TWFya2VyKGVsZW1lbnQsIGd1aWQpIHsKICAgICAgICAgICAgdmFyIG1hcmtlciA9IGVsZW1lbnQucXVlcnlTZWxlY3Rvcignc2NyaXB0W2dsbXI9IicgKyBndWlkICsgJyJdJyk7CiAgICAgICAgICAgIGlmIChtYXJrZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzZXJpYWxpemVkIGN1cnNvciBmb3IgYGluLWVsZW1lbnRgJyk7CiAgICAgICAgfTsKCiAgICAgICAgUmVoeWRyYXRlQnVpbGRlci5wcm90b3R5cGUuX19wdXNoUmVtb3RlRWxlbWVudCA9IGZ1bmN0aW9uIF9fcHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgY3Vyc29ySWQpIHsKICAgICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBudWxsOwoKICAgICAgICAgICAgdmFyIG1hcmtlciA9IHRoaXMuZ2V0TWFya2VyKGVsZW1lbnQsIGN1cnNvcklkKTsKICAgICAgICAgICAgaWYgKG1hcmtlci5wYXJlbnROb2RlID09PSBlbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEN1cnNvciA9IHRoaXMuY3VycmVudEN1cnNvcjsKICAgICAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBjdXJyZW50Q3Vyc29yLmNhbmRpZGF0ZTsKICAgICAgICAgICAgICAgIHRoaXMucHVzaEVsZW1lbnQoZWxlbWVudCwgbmV4dFNpYmxpbmcpOwogICAgICAgICAgICAgICAgY3VycmVudEN1cnNvci5jYW5kaWRhdGUgPSBjYW5kaWRhdGU7CiAgICAgICAgICAgICAgICB0aGlzLmNhbmRpZGF0ZSA9IHRoaXMucmVtb3ZlKG1hcmtlcik7CiAgICAgICAgICAgICAgICB2YXIgdHJhY2tlciA9IG5ldyBSZW1vdGVCbG9ja1RyYWNrZXIoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB0aGlzLnB1c2hCbG9ja1RyYWNrZXIodHJhY2tlciwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZWh5ZHJhdGVCdWlsZGVyLnByb3RvdHlwZS5kaWRBcHBlbmRCb3VuZHMgPSBmdW5jdGlvbiBkaWRBcHBlbmRCb3VuZHMoYm91bmRzJCQxKSB7CiAgICAgICAgICAgIF9OZXdFbGVtZW50QnVpbGRlci5wcm90b3R5cGUuZGlkQXBwZW5kQm91bmRzLmNhbGwodGhpcywgYm91bmRzJCQxKTsKICAgICAgICAgICAgaWYgKHRoaXMuY2FuZGlkYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IGJvdW5kcyQkMS5sYXN0Tm9kZSgpOwogICAgICAgICAgICAgICAgdGhpcy5jYW5kaWRhdGUgPSBsYXN0ICYmIGxhc3QubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJvdW5kcyQkMTsKICAgICAgICB9OwoKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKFJlaHlkcmF0ZUJ1aWxkZXIsIFt7CiAgICAgICAgICAgIGtleTogJ2N1cnJlbnRDdXJzb3InLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnNvclN0YWNrLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ2NhbmRpZGF0ZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEN1cnNvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRDdXJzb3IuY2FuZGlkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEN1cnNvci5jYW5kaWRhdGUgPSBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBSZWh5ZHJhdGVCdWlsZGVyOwogICAgfShOZXdFbGVtZW50QnVpbGRlcik7CgogICAgZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDM7CiAgICB9CiAgICBmdW5jdGlvbiBpc0NvbW1lbnQobm9kZSkgewogICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSA4OwogICAgfQogICAgZnVuY3Rpb24gZ2V0T3BlbkJsb2NrRGVwdGgobm9kZSkgewogICAgICAgIHZhciBib3VuZHNEZXB0aCA9IG5vZGUubm9kZVZhbHVlLm1hdGNoKC9eJVwrYjooXGQrKSUkLyk7CiAgICAgICAgaWYgKGJvdW5kc0RlcHRoICYmIGJvdW5kc0RlcHRoWzFdKSB7CiAgICAgICAgICAgIHJldHVybiBOdW1iZXIoYm91bmRzRGVwdGhbMV0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldENsb3NlQmxvY2tEZXB0aChub2RlKSB7CiAgICAgICAgdmFyIGJvdW5kc0RlcHRoID0gbm9kZS5ub2RlVmFsdWUubWF0Y2goL14lXC1iOihcZCspJSQvKTsKICAgICAgICBpZiAoYm91bmRzRGVwdGggJiYgYm91bmRzRGVwdGhbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIE51bWJlcihib3VuZHNEZXB0aFsxXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gMTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzTWFya2VyKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gOCAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gJyVnbG1yJSc7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NlcGFyYXRvcihub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVR5cGUgPT09IDggJiYgbm9kZS5ub2RlVmFsdWUgPT09ICclfCUnOwogICAgfQogICAgZnVuY3Rpb24gaXNFbXB0eSQxKG5vZGUpIHsKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gOCAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gJyUgJSc7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NhbWVOb2RlVHlwZShjYW5kaWRhdGUsIHRhZykgewogICAgICAgIGlmIChjYW5kaWRhdGUubmFtZXNwYWNlVVJJID09PSBTVkdfTkFNRVNQQUNFJDEpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZS50YWdOYW1lID09PSB0YWc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYW5kaWRhdGUudGFnTmFtZSA9PT0gdGFnLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBmaW5kQnlOYW1lKGFycmF5LCBuYW1lKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYXR0ciA9IGFycmF5W2ldOwogICAgICAgICAgICBpZiAoYXR0ci5uYW1lID09PSBuYW1lKSByZXR1cm4gYXR0cjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGZ1bmN0aW9uIHJlaHlkcmF0aW9uQnVpbGRlcihlbnYsIGN1cnNvcikgewogICAgICAgIHJldHVybiBSZWh5ZHJhdGVCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIoZW52LCBjdXJzb3IpOwogICAgfQoKICAgIGV4cG9ydHMucmVuZGVyTWFpbiA9IHJlbmRlcjsKICAgIGV4cG9ydHMuTlVMTF9SRUZFUkVOQ0UgPSBOVUxMX1JFRkVSRU5DRTsKICAgIGV4cG9ydHMuVU5ERUZJTkVEX1JFRkVSRU5DRSA9IFVOREVGSU5FRF9SRUZFUkVOQ0U7CiAgICBleHBvcnRzLlByaW1pdGl2ZVJlZmVyZW5jZSA9IFByaW1pdGl2ZVJlZmVyZW5jZTsKICAgIGV4cG9ydHMuQ29uZGl0aW9uYWxSZWZlcmVuY2UgPSBDb25kaXRpb25hbFJlZmVyZW5jZTsKICAgIGV4cG9ydHMuc2V0RGVidWdnZXJDYWxsYmFjayA9IHNldERlYnVnZ2VyQ2FsbGJhY2s7CiAgICBleHBvcnRzLnJlc2V0RGVidWdnZXJDYWxsYmFjayA9IHJlc2V0RGVidWdnZXJDYWxsYmFjazsKICAgIGV4cG9ydHMuZ2V0RHluYW1pY1ZhciA9IGdldER5bmFtaWNWYXI7CiAgICBleHBvcnRzLkxvd0xldmVsVk0gPSBWTTsKICAgIGV4cG9ydHMuVXBkYXRpbmdWTSA9IFVwZGF0aW5nVk07CiAgICBleHBvcnRzLlJlbmRlclJlc3VsdCA9IFJlbmRlclJlc3VsdDsKICAgIGV4cG9ydHMuU2ltcGxlRHluYW1pY0F0dHJpYnV0ZSA9IFNpbXBsZUR5bmFtaWNBdHRyaWJ1dGU7CiAgICBleHBvcnRzLkR5bmFtaWNBdHRyaWJ1dGUgPSBEeW5hbWljQXR0cmlidXRlOwogICAgZXhwb3J0cy5FTVBUWV9BUkdTID0gRU1QVFlfQVJHUzsKICAgIGV4cG9ydHMuU2NvcGUgPSBTY29wZTsKICAgIGV4cG9ydHMuRW52aXJvbm1lbnQgPSBFbnZpcm9ubWVudDsKICAgIGV4cG9ydHMuRGVmYXVsdEVudmlyb25tZW50ID0gRGVmYXVsdEVudmlyb25tZW50OwogICAgZXhwb3J0cy5ERUZBVUxUX0NBUEFCSUxJVElFUyA9IERFRkFVTFRfQ0FQQUJJTElUSUVTOwogICAgZXhwb3J0cy5NSU5JTUFMX0NBUEFCSUxJVElFUyA9IE1JTklNQUxfQ0FQQUJJTElUSUVTOwogICAgZXhwb3J0cy5DdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbiA9IEN1cnJpZWRDb21wb25lbnREZWZpbml0aW9uOwogICAgZXhwb3J0cy5pc0N1cnJpZWRDb21wb25lbnREZWZpbml0aW9uID0gaXNDdXJyaWVkQ29tcG9uZW50RGVmaW5pdGlvbjsKICAgIGV4cG9ydHMuY3VycnkgPSBjdXJyeTsKICAgIGV4cG9ydHMuRE9NQ2hhbmdlcyA9IGhlbHBlciQxOwogICAgZXhwb3J0cy5TVkdfTkFNRVNQQUNFID0gU1ZHX05BTUVTUEFDRSQxOwogICAgZXhwb3J0cy5JRE9NQ2hhbmdlcyA9IERPTUNoYW5nZXM7CiAgICBleHBvcnRzLkRPTVRyZWVDb25zdHJ1Y3Rpb24gPSBET01UcmVlQ29uc3RydWN0aW9uOwogICAgZXhwb3J0cy5pc1doaXRlc3BhY2UgPSBpc1doaXRlc3BhY2U7CiAgICBleHBvcnRzLmluc2VydEhUTUxCZWZvcmUgPSBfaW5zZXJ0SFRNTEJlZm9yZTsKICAgIGV4cG9ydHMubm9ybWFsaXplUHJvcGVydHkgPSBub3JtYWxpemVQcm9wZXJ0eTsKICAgIGV4cG9ydHMuTmV3RWxlbWVudEJ1aWxkZXIgPSBOZXdFbGVtZW50QnVpbGRlcjsKICAgIGV4cG9ydHMuY2xpZW50QnVpbGRlciA9IGNsaWVudEJ1aWxkZXI7CiAgICBleHBvcnRzLnJlaHlkcmF0aW9uQnVpbGRlciA9IHJlaHlkcmF0aW9uQnVpbGRlcjsKICAgIGV4cG9ydHMuUmVoeWRyYXRlQnVpbGRlciA9IFJlaHlkcmF0ZUJ1aWxkZXI7CiAgICBleHBvcnRzLkNvbmNyZXRlQm91bmRzID0gQ29uY3JldGVCb3VuZHM7CiAgICBleHBvcnRzLkN1cnNvciA9IEN1cnNvcjsKICAgIGV4cG9ydHMuY2FwYWJpbGl0eUZsYWdzRnJvbSA9IGNhcGFiaWxpdHlGbGFnc0Zyb207CiAgICBleHBvcnRzLmhhc0NhcGFiaWxpdHkgPSBoYXNDYXBhYmlsaXR5Owp9KTsKZW5pZmVkKCdAZ2xpbW1lci91dGlsJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMudW5yZWFjaGFibGUgPSBleHBvcnRzLmV4cGVjdCA9IGV4cG9ydHMudW53cmFwID0gZXhwb3J0cy5FTVBUWV9BUlJBWSA9IGV4cG9ydHMuTGlzdFNsaWNlID0gZXhwb3J0cy5MaXN0Tm9kZSA9IGV4cG9ydHMuTGlua2VkTGlzdCA9IGV4cG9ydHMuRU1QVFlfU0xJQ0UgPSBleHBvcnRzLmRpY3QgPSBleHBvcnRzLkRpY3RTZXQgPSBleHBvcnRzLlN0YWNrID0gZXhwb3J0cy5TRVJJQUxJWkFUSU9OX0ZJUlNUX05PREVfU1RSSU5HID0gZXhwb3J0cy5pc1NlcmlhbGl6YXRpb25GaXJzdE5vZGUgPSBleHBvcnRzLmluaXRpYWxpemVHdWlkID0gZXhwb3J0cy5lbnN1cmVHdWlkID0gZXhwb3J0cy5maWxsTnVsbHMgPSBleHBvcnRzLmFzc2lnbiA9IGV4cG9ydHMuYXNzZXJ0ID0gdW5kZWZpbmVkOwogICAgZnVuY3Rpb24gdW53cmFwKHZhbCkgewogICAgICAgIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgdmFsdWUgdG8gYmUgcHJlc2VudCcpOwogICAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgICBmdW5jdGlvbiBleHBlY3QodmFsLCBtZXNzYWdlKSB7CiAgICAgICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgICBmdW5jdGlvbiB1bnJlYWNoYWJsZSgpIHsKICAgICAgICB2YXIgbWVzc2FnZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogJ3VucmVhY2hhYmxlJzsKCiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcihtZXNzYWdlKTsKICAgIH0KCiAgICAvLyBpbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJzsKICAgIC8vIGxldCBhbHJlYWR5V2FybmVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBkZWJ1Z0Fzc2VydCh0ZXN0LCBtc2cpIHsKICAgICAgICAvLyBpZiAoIWFscmVhZHlXYXJuZWQpIHsKICAgICAgICAvLyAgIGFscmVhZHlXYXJuZWQgPSB0cnVlOwogICAgICAgIC8vICAgTG9nZ2VyLndhcm4oIkRvbid0IGxlYXZlIGRlYnVnIGFzc2VydGlvbnMgb24gaW4gcHVibGljIGJ1aWxkcyIpOwogICAgICAgIC8vIH0KICAgICAgICBpZiAoIXRlc3QpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyB8fCAnYXNzZXJ0aW9uIGZhaWx1cmUnKTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIG9iaktleXMgPSBPYmplY3Qua2V5czsKCiAgICBmdW5jdGlvbiBhc3NpZ24ob2JqKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGFzc2lnbm1lbnQgPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgIGlmIChhc3NpZ25tZW50ID09PSBudWxsIHx8IHR5cGVvZiBhc3NpZ25tZW50ICE9PSAnb2JqZWN0JykgY29udGludWU7CiAgICAgICAgICAgIHZhciBrZXlzID0gb2JqS2V5cyhhc3NpZ25tZW50KTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBrZXlzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tqXTsKICAgICAgICAgICAgICAgIG9ialtrZXldID0gYXNzaWdubWVudFtrZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICBmdW5jdGlvbiBmaWxsTnVsbHMoY291bnQpIHsKICAgICAgICB2YXIgYXJyID0gbmV3IEFycmF5KGNvdW50KTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgYXJyW2ldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycjsKICAgIH0KCiAgICB2YXIgR1VJRCA9IDA7CiAgICBmdW5jdGlvbiBpbml0aWFsaXplR3VpZChvYmplY3QpIHsKICAgICAgICByZXR1cm4gb2JqZWN0Ll9ndWlkID0gKytHVUlEOwogICAgfQogICAgZnVuY3Rpb24gZW5zdXJlR3VpZChvYmplY3QpIHsKICAgICAgICByZXR1cm4gb2JqZWN0Ll9ndWlkIHx8IGluaXRpYWxpemVHdWlkKG9iamVjdCk7CiAgICB9CgogICAgdmFyIFNFUklBTElaQVRJT05fRklSU1RfTk9ERV9TVFJJTkcgPSAnJStiOjAlJzsKICAgIGZ1bmN0aW9uIGlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZShub2RlKSB7CiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVZhbHVlID09PSBTRVJJQUxJWkFUSU9OX0ZJUlNUX05PREVfU1RSSU5HOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpY3QoKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CgogICAgdmFyIERpY3RTZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRGljdFNldCgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBEaWN0U2V0KTsKCiAgICAgICAgICAgIHRoaXMuZGljdCA9IGRpY3QoKTsKICAgICAgICB9CgogICAgICAgIERpY3RTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChvYmopIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICdzdHJpbmcnKSB0aGlzLmRpY3Rbb2JqXSA9IG9iajtlbHNlIHRoaXMuZGljdFtlbnN1cmVHdWlkKG9iaildID0gb2JqOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICBEaWN0U2V0LnByb3RvdHlwZS5kZWxldGUgPSBmdW5jdGlvbiBfZGVsZXRlKG9iaikgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIGRlbGV0ZSB0aGlzLmRpY3Rbb2JqXTtlbHNlIGlmIChvYmouX2d1aWQpIGRlbGV0ZSB0aGlzLmRpY3Rbb2JqLl9ndWlkXTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRGljdFNldDsKICAgIH0oKTsKCiAgICB2YXIgU3RhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gU3RhY2soKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU3RhY2spOwoKICAgICAgICAgICAgdGhpcy5zdGFjayA9IFtdOwogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgU3RhY2sucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKGl0ZW0pIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gaXRlbTsKICAgICAgICAgICAgdGhpcy5zdGFjay5wdXNoKGl0ZW0pOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS5wb3AgPSBmdW5jdGlvbiBwb3AoKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5zdGFjay5wb3AoKTsKICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMuc3RhY2subGVuZ3RoOwogICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSBsZW4gPT09IDAgPyBudWxsIDogdGhpcy5zdGFja1tsZW4gLSAxXTsKICAgICAgICAgICAgcmV0dXJuIGl0ZW0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBpdGVtOwogICAgICAgIH07CgogICAgICAgIFN0YWNrLnByb3RvdHlwZS5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2subGVuZ3RoID09PSAwOwogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoU3RhY2ssIFt7CiAgICAgICAgICAgIGtleTogJ3NpemUnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YWNrLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gU3RhY2s7CiAgICB9KCk7CgogICAgdmFyIExpc3ROb2RlID0gZnVuY3Rpb24gTGlzdE5vZGUodmFsdWUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIExpc3ROb2RlKTsKCiAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICB0aGlzLnByZXYgPSBudWxsOwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH07CgogICAgdmFyIExpbmtlZExpc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTGlua2VkTGlzdCgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBMaW5rZWRMaXN0KTsKCiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB9CgogICAgICAgIExpbmtlZExpc3QucHJvdG90eXBlLmhlYWQgPSBmdW5jdGlvbiBoZWFkKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGVhZDsKICAgICAgICB9OwoKICAgICAgICBMaW5rZWRMaXN0LnByb3RvdHlwZS50YWlsID0gZnVuY3Rpb24gdGFpbCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RhaWw7CiAgICAgICAgfTsKCiAgICAgICAgTGlua2VkTGlzdC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgICAgICAgdGhpcy5faGVhZCA9IHRoaXMuX3RhaWwgPSBudWxsOwogICAgICAgIH07CgogICAgICAgIExpbmtlZExpc3QucHJvdG90eXBlLnRvQXJyYXkgPSBmdW5jdGlvbiB0b0FycmF5KCkgewogICAgICAgICAgICB2YXIgb3V0ID0gW107CiAgICAgICAgICAgIHRoaXMuZm9yRWFjaE5vZGUoZnVuY3Rpb24gKG4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBvdXQucHVzaChuKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfTsKCiAgICAgICAgTGlua2VkTGlzdC5wcm90b3R5cGUubmV4dE5vZGUgPSBmdW5jdGlvbiBuZXh0Tm9kZShub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlLm5leHQ7CiAgICAgICAgfTsKCiAgICAgICAgTGlua2VkTGlzdC5wcm90b3R5cGUuZm9yRWFjaE5vZGUgPSBmdW5jdGlvbiBmb3JFYWNoTm9kZShjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuX2hlYWQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhub2RlKTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBMaW5rZWRMaXN0LnByb3RvdHlwZS5pbnNlcnRCZWZvcmUgPSBmdW5jdGlvbiBpbnNlcnRCZWZvcmUobm9kZSkgewogICAgICAgICAgICB2YXIgcmVmZXJlbmNlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwoKICAgICAgICAgICAgaWYgKHJlZmVyZW5jZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuYXBwZW5kKG5vZGUpOwogICAgICAgICAgICBpZiAocmVmZXJlbmNlLnByZXYpIHJlZmVyZW5jZS5wcmV2Lm5leHQgPSBub2RlO2Vsc2UgdGhpcy5faGVhZCA9IG5vZGU7CiAgICAgICAgICAgIG5vZGUucHJldiA9IHJlZmVyZW5jZS5wcmV2OwogICAgICAgICAgICBub2RlLm5leHQgPSByZWZlcmVuY2U7CiAgICAgICAgICAgIHJlZmVyZW5jZS5wcmV2ID0gbm9kZTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfTsKCiAgICAgICAgTGlua2VkTGlzdC5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gYXBwZW5kKG5vZGUpIHsKICAgICAgICAgICAgdmFyIHRhaWwgPSB0aGlzLl90YWlsOwogICAgICAgICAgICBpZiAodGFpbCkgewogICAgICAgICAgICAgICAgdGFpbC5uZXh0ID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUucHJldiA9IHRhaWw7CiAgICAgICAgICAgICAgICBub2RlLm5leHQgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5faGVhZCA9IG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RhaWwgPSBub2RlOwogICAgICAgIH07CgogICAgICAgIExpbmtlZExpc3QucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZShub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLnByZXYpIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0O2Vsc2UgdGhpcy5faGVhZCA9IG5vZGUubmV4dDsKICAgICAgICAgICAgaWYgKG5vZGUubmV4dCkgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7ZWxzZSB0aGlzLl90YWlsID0gbm9kZS5wcmV2OwogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGlua2VkTGlzdDsKICAgIH0oKTsKCiAgICB2YXIgTGlzdFNsaWNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIExpc3RTbGljZShoZWFkLCB0YWlsKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTGlzdFNsaWNlKTsKCiAgICAgICAgICAgIHRoaXMuX2hlYWQgPSBoZWFkOwogICAgICAgICAgICB0aGlzLl90YWlsID0gdGFpbDsKICAgICAgICB9CgogICAgICAgIExpc3RTbGljZS5wcm90b3R5cGUuZm9yRWFjaE5vZGUgPSBmdW5jdGlvbiBmb3JFYWNoTm9kZShjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuX2hlYWQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhub2RlKTsKICAgICAgICAgICAgICAgIG5vZGUgPSB0aGlzLm5leHROb2RlKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTGlzdFNsaWNlLnByb3RvdHlwZS5oZWFkID0gZnVuY3Rpb24gaGVhZCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hlYWQ7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdFNsaWNlLnByb3RvdHlwZS50YWlsID0gZnVuY3Rpb24gdGFpbCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RhaWw7CiAgICAgICAgfTsKCiAgICAgICAgTGlzdFNsaWNlLnByb3RvdHlwZS50b0FycmF5ID0gZnVuY3Rpb24gdG9BcnJheSgpIHsKICAgICAgICAgICAgdmFyIG91dCA9IFtdOwogICAgICAgICAgICB0aGlzLmZvckVhY2hOb2RlKGZ1bmN0aW9uIChuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0LnB1c2gobik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgIH07CgogICAgICAgIExpc3RTbGljZS5wcm90b3R5cGUubmV4dE5vZGUgPSBmdW5jdGlvbiBuZXh0Tm9kZShub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlID09PSB0aGlzLl90YWlsKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTGlzdFNsaWNlOwogICAgfSgpOwoKICAgIHZhciBFTVBUWV9TTElDRSA9IG5ldyBMaXN0U2xpY2UobnVsbCwgbnVsbCk7CgogICAgdmFyIEVNUFRZX0FSUkFZID0gT2JqZWN0LmZyZWV6ZShbXSk7CgogICAgZXhwb3J0cy5hc3NlcnQgPSBkZWJ1Z0Fzc2VydDsKICAgIGV4cG9ydHMuYXNzaWduID0gYXNzaWduOwogICAgZXhwb3J0cy5maWxsTnVsbHMgPSBmaWxsTnVsbHM7CiAgICBleHBvcnRzLmVuc3VyZUd1aWQgPSBlbnN1cmVHdWlkOwogICAgZXhwb3J0cy5pbml0aWFsaXplR3VpZCA9IGluaXRpYWxpemVHdWlkOwogICAgZXhwb3J0cy5pc1NlcmlhbGl6YXRpb25GaXJzdE5vZGUgPSBpc1NlcmlhbGl6YXRpb25GaXJzdE5vZGU7CiAgICBleHBvcnRzLlNFUklBTElaQVRJT05fRklSU1RfTk9ERV9TVFJJTkcgPSBTRVJJQUxJWkFUSU9OX0ZJUlNUX05PREVfU1RSSU5HOwogICAgZXhwb3J0cy5TdGFjayA9IFN0YWNrOwogICAgZXhwb3J0cy5EaWN0U2V0ID0gRGljdFNldDsKICAgIGV4cG9ydHMuZGljdCA9IGRpY3Q7CiAgICBleHBvcnRzLkVNUFRZX1NMSUNFID0gRU1QVFlfU0xJQ0U7CiAgICBleHBvcnRzLkxpbmtlZExpc3QgPSBMaW5rZWRMaXN0OwogICAgZXhwb3J0cy5MaXN0Tm9kZSA9IExpc3ROb2RlOwogICAgZXhwb3J0cy5MaXN0U2xpY2UgPSBMaXN0U2xpY2U7CiAgICBleHBvcnRzLkVNUFRZX0FSUkFZID0gRU1QVFlfQVJSQVk7CiAgICBleHBvcnRzLnVud3JhcCA9IHVud3JhcDsKICAgIGV4cG9ydHMuZXhwZWN0ID0gZXhwZWN0OwogICAgZXhwb3J0cy51bnJlYWNoYWJsZSA9IHVucmVhY2hhYmxlOwp9KTsKZW5pZmVkKCJAZ2xpbW1lci92bSIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogUmVnaXN0ZXJzCiAgICAgKgogICAgICogRm9yIHRoZSBtb3N0IHBhcnQsIHRoZXNlIGZvbGxvd3MgTUlQUyBuYW1pbmcgY29udmVudGlvbnMsIGhvd2V2ZXIgdGhlCiAgICAgKiByZWdpc3RlciBudW1iZXJzIGFyZSBkaWZmZXJlbnQuCiAgICAgKi8KICAgIHZhciBSZWdpc3RlcjsKICAgIChmdW5jdGlvbiAoUmVnaXN0ZXIpIHsKICAgICAgICAvLyAkMCBvciAkcGMgKHByb2dyYW0gY291bnRlcik6IHBvaW50ZXIgaW50byBgcHJvZ3JhbWAgZm9yIHRoZSBuZXh0IGluc3R1cmN0aW9uOyAtMSBtZWFucyBleGl0CiAgICAgICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInBjIl0gPSAwXSA9ICJwYyI7CiAgICAgICAgLy8gJDEgb3IgJHJhIChyZXR1cm4gYWRkcmVzcyk6IHBvaW50ZXIgaW50byBgcHJvZ3JhbWAgZm9yIHRoZSByZXR1cm4KICAgICAgICBSZWdpc3RlcltSZWdpc3RlclsicmEiXSA9IDFdID0gInJhIjsKICAgICAgICAvLyAkMiBvciAkZnAgKGZyYW1lIHBvaW50ZXIpOiBwb2ludGVyIGludG8gdGhlIGBldmFsU3RhY2tgIGZvciB0aGUgYmFzZSBvZiB0aGUgc3RhY2sKICAgICAgICBSZWdpc3RlcltSZWdpc3RlclsiZnAiXSA9IDJdID0gImZwIjsKICAgICAgICAvLyAkMyBvciAkc3AgKHN0YWNrIHBvaW50ZXIpOiBwb2ludGVyIGludG8gdGhlIGBldmFsU3RhY2tgIGZvciB0aGUgdG9wIG9mIHRoZSBzdGFjawogICAgICAgIFJlZ2lzdGVyW1JlZ2lzdGVyWyJzcCJdID0gM10gPSAic3AiOwogICAgICAgIC8vICQ0LSQ1IG9yICRzMC0kczEgKHNhdmVkKTogY2FsbGVlIHNhdmVkIGdlbmVyYWwtcHVycG9zZSByZWdpc3RlcnMKICAgICAgICBSZWdpc3RlcltSZWdpc3RlclsiczAiXSA9IDRdID0gInMwIjsKICAgICAgICBSZWdpc3RlcltSZWdpc3RlclsiczEiXSA9IDVdID0gInMxIjsKICAgICAgICAvLyAkNi0kNyBvciAkdDAtJHQxICh0ZW1wb3Jhcmllcyk6IGNhbGxlciBzYXZlZCBnZW5lcmFsLXB1cnBvc2UgcmVnaXN0ZXJzCiAgICAgICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInQwIl0gPSA2XSA9ICJ0MCI7CiAgICAgICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInQxIl0gPSA3XSA9ICJ0MSI7CiAgICAgICAgLy8gJDggb3IgJHYwIChyZXR1cm4gdmFsdWUpCiAgICAgICAgUmVnaXN0ZXJbUmVnaXN0ZXJbInYwIl0gPSA4XSA9ICJ2MCI7CiAgICB9KShSZWdpc3RlciB8fCAoZXhwb3J0cy5SZWdpc3RlciA9IFJlZ2lzdGVyID0ge30pKTsKCiAgICBleHBvcnRzLlJlZ2lzdGVyID0gUmVnaXN0ZXI7Cn0pOwplbmlmZWQoIkBnbGltbWVyL3dpcmUtZm9ybWF0IiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIE9wY29kZXM7CiAgICAoZnVuY3Rpb24gKE9wY29kZXMpIHsKICAgICAgICAvLyBTdGF0ZW1lbnRzCiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJUZXh0Il0gPSAwXSA9ICJUZXh0IjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkFwcGVuZCJdID0gMV0gPSAiQXBwZW5kIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkNvbW1lbnQiXSA9IDJdID0gIkNvbW1lbnQiOwogICAgICAgIE9wY29kZXNbT3Bjb2Rlc1siTW9kaWZpZXIiXSA9IDNdID0gIk1vZGlmaWVyIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkJsb2NrIl0gPSA0XSA9ICJCbG9jayI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJDb21wb25lbnQiXSA9IDVdID0gIkNvbXBvbmVudCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJEeW5hbWljQ29tcG9uZW50Il0gPSA2XSA9ICJEeW5hbWljQ29tcG9uZW50IjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIk9wZW5FbGVtZW50Il0gPSA3XSA9ICJPcGVuRWxlbWVudCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJPcGVuU3BsYXR0ZWRFbGVtZW50Il0gPSA4XSA9ICJPcGVuU3BsYXR0ZWRFbGVtZW50IjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkZsdXNoRWxlbWVudCJdID0gOV0gPSAiRmx1c2hFbGVtZW50IjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkNsb3NlRWxlbWVudCJdID0gMTBdID0gIkNsb3NlRWxlbWVudCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJTdGF0aWNBdHRyIl0gPSAxMV0gPSAiU3RhdGljQXR0ciI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJEeW5hbWljQXR0ciJdID0gMTJdID0gIkR5bmFtaWNBdHRyIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkF0dHJTcGxhdCJdID0gMTNdID0gIkF0dHJTcGxhdCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJZaWVsZCJdID0gMTRdID0gIllpZWxkIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIlBhcnRpYWwiXSA9IDE1XSA9ICJQYXJ0aWFsIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkR5bmFtaWNBcmciXSA9IDE2XSA9ICJEeW5hbWljQXJnIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIlN0YXRpY0FyZyJdID0gMTddID0gIlN0YXRpY0FyZyI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJUcnVzdGluZ0F0dHIiXSA9IDE4XSA9ICJUcnVzdGluZ0F0dHIiOwogICAgICAgIE9wY29kZXNbT3Bjb2Rlc1siRGVidWdnZXIiXSA9IDE5XSA9ICJEZWJ1Z2dlciI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJDbGllbnRTaWRlU3RhdGVtZW50Il0gPSAyMF0gPSAiQ2xpZW50U2lkZVN0YXRlbWVudCI7CiAgICAgICAgLy8gRXhwcmVzc2lvbnMKICAgICAgICBPcGNvZGVzW09wY29kZXNbIlVua25vd24iXSA9IDIxXSA9ICJVbmtub3duIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkdldCJdID0gMjJdID0gIkdldCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJNYXliZUxvY2FsIl0gPSAyM10gPSAiTWF5YmVMb2NhbCI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJIYXNCbG9jayJdID0gMjRdID0gIkhhc0Jsb2NrIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkhhc0Jsb2NrUGFyYW1zIl0gPSAyNV0gPSAiSGFzQmxvY2tQYXJhbXMiOwogICAgICAgIE9wY29kZXNbT3Bjb2Rlc1siVW5kZWZpbmVkIl0gPSAyNl0gPSAiVW5kZWZpbmVkIjsKICAgICAgICBPcGNvZGVzW09wY29kZXNbIkhlbHBlciJdID0gMjddID0gIkhlbHBlciI7CiAgICAgICAgT3Bjb2Rlc1tPcGNvZGVzWyJDb25jYXQiXSA9IDI4XSA9ICJDb25jYXQiOwogICAgICAgIE9wY29kZXNbT3Bjb2Rlc1siQ2xpZW50U2lkZUV4cHJlc3Npb24iXSA9IDI5XSA9ICJDbGllbnRTaWRlRXhwcmVzc2lvbiI7CiAgICB9KShPcGNvZGVzIHx8IChleHBvcnRzLk9wcyA9IE9wY29kZXMgPSB7fSkpOwoKICAgIGZ1bmN0aW9uIGlzKHZhcmlhbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB2YWx1ZVswXSA9PT0gdmFyaWFudDsKICAgICAgICB9OwogICAgfQogICAgLy8gU3RhdGVtZW50cwogICAgdmFyIGlzTW9kaWZpZXIgPSBpcyhPcGNvZGVzLk1vZGlmaWVyKTsKICAgIHZhciBpc0ZsdXNoRWxlbWVudCA9IGlzKE9wY29kZXMuRmx1c2hFbGVtZW50KTsKICAgIHZhciBpc0F0dHJTcGxhdCA9IGlzKE9wY29kZXMuQXR0clNwbGF0KTsKICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlKHZhbCkgewogICAgICAgIHJldHVybiB2YWxbMF0gPT09IE9wY29kZXMuU3RhdGljQXR0ciB8fCB2YWxbMF0gPT09IE9wY29kZXMuRHluYW1pY0F0dHIgfHwgdmFsWzBdID09PSBPcGNvZGVzLlRydXN0aW5nQXR0cjsKICAgIH0KICAgIGZ1bmN0aW9uIGlzQXJndW1lbnQodmFsKSB7CiAgICAgICAgcmV0dXJuIHZhbFswXSA9PT0gT3Bjb2Rlcy5TdGF0aWNBcmcgfHwgdmFsWzBdID09PSBPcGNvZGVzLkR5bmFtaWNBcmc7CiAgICB9CiAgICAvLyBFeHByZXNzaW9ucwogICAgdmFyIGlzR2V0ID0gaXMoT3Bjb2Rlcy5HZXQpOwogICAgdmFyIGlzTWF5YmVMb2NhbCA9IGlzKE9wY29kZXMuTWF5YmVMb2NhbCk7CgogICAgZXhwb3J0cy5pcyA9IGlzOwogICAgZXhwb3J0cy5pc01vZGlmaWVyID0gaXNNb2RpZmllcjsKICAgIGV4cG9ydHMuaXNGbHVzaEVsZW1lbnQgPSBpc0ZsdXNoRWxlbWVudDsKICAgIGV4cG9ydHMuaXNBdHRyU3BsYXQgPSBpc0F0dHJTcGxhdDsKICAgIGV4cG9ydHMuaXNBdHRyaWJ1dGUgPSBpc0F0dHJpYnV0ZTsKICAgIGV4cG9ydHMuaXNBcmd1bWVudCA9IGlzQXJndW1lbnQ7CiAgICBleHBvcnRzLmlzR2V0ID0gaXNHZXQ7CiAgICBleHBvcnRzLmlzTWF5YmVMb2NhbCA9IGlzTWF5YmVMb2NhbDsKICAgIGV4cG9ydHMuT3BzID0gT3Bjb2RlczsKfSk7CmVuaWZlZCgnYmFja2J1cm5lcicsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLmJ1aWxkUGxhdGZvcm0gPSB1bmRlZmluZWQ7CiAgICB2YXIgU0VUX1RJTUVPVVQgPSBzZXRUaW1lb3V0OwogICAgdmFyIE5PT1AgPSBmdW5jdGlvbiAoKSB7fTsKICAgIGZ1bmN0aW9uIGJ1aWxkUGxhdGZvcm0oZmx1c2gpIHsKICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICB2YXIgY2xlYXJOZXh0ID0gTk9PUDsKICAgICAgICBpZiAodHlwZW9mIE11dGF0aW9uT2JzZXJ2ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdGlvbnMgPSAwOwogICAgICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmbHVzaCk7CiAgICAgICAgICAgIHZhciBub2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpOwogICAgICAgICAgICBvYnNlcnZlci5vYnNlcnZlKG5vZGUsIHsgY2hhcmFjdGVyRGF0YTogdHJ1ZSB9KTsKICAgICAgICAgICAgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGl0ZXJhdGlvbnMgPSArK2l0ZXJhdGlvbnMgJSAyOwogICAgICAgICAgICAgICAgbm9kZS5kYXRhID0gJycgKyBpdGVyYXRpb25zOwogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZXJhdGlvbnM7CiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB2YXIgYXV0b3J1blByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgICAgICAgICAgbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhdXRvcnVuUHJvbWlzZS50aGVuKGZsdXNoKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFNFVF9USU1FT1VUKGZsdXNoLCAwKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc2V0VGltZW91dDogZnVuY3Rpb24gKGZuLCBtcykgewogICAgICAgICAgICAgICAgcmV0dXJuIFNFVF9USU1FT1VUKGZuLCBtcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFyVGltZW91dDogZnVuY3Rpb24gKHRpbWVySWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQodGltZXJJZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG5vdzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBuZXh0OiBuZXh0LAogICAgICAgICAgICBjbGVhck5leHQ6IGNsZWFyTmV4dAogICAgICAgIH07CiAgICB9CgogICAgdmFyIE5VTUJFUiA9IC9cZCsvOwogICAgZnVuY3Rpb24gaXNDb2VyY2FibGVOdW1iZXIoc3VzcGVjdCkgewogICAgICAgIHZhciB0eXBlID0gdHlwZW9mIHN1c3BlY3Q7CiAgICAgICAgcmV0dXJuIHR5cGUgPT09ICdudW1iZXInICYmIHN1c3BlY3QgPT09IHN1c3BlY3QgfHwgdHlwZSA9PT0gJ3N0cmluZycgJiYgTlVNQkVSLnRlc3Qoc3VzcGVjdCk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRPbkVycm9yKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gb3B0aW9ucy5vbkVycm9yIHx8IG9wdGlvbnMub25FcnJvclRhcmdldCAmJiBvcHRpb25zLm9uRXJyb3JUYXJnZXRbb3B0aW9ucy5vbkVycm9yTWV0aG9kXTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpbmRJdGVtKHRhcmdldCwgbWV0aG9kLCBjb2xsZWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjb2xsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkgKz0gNCkgewogICAgICAgICAgICBpZiAoY29sbGVjdGlvbltpXSA9PT0gdGFyZ2V0ICYmIGNvbGxlY3Rpb25baSArIDFdID09PSBtZXRob2QpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRleDsKICAgIH0KICAgIGZ1bmN0aW9uIGZpbmRUaW1lcih0aW1lciwgY29sbGVjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDwgY29sbGVjdGlvbi5sZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgICBpZiAoY29sbGVjdGlvbltpXSA9PT0gdGltZXIpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gaSAtIDM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5kZXg7CiAgICB9CgogICAgZnVuY3Rpb24gYmluYXJ5U2VhcmNoKHRpbWUsIHRpbWVycykgewogICAgICAgIHZhciBzdGFydCA9IDA7CiAgICAgICAgdmFyIGVuZCA9IHRpbWVycy5sZW5ndGggLSA2OwogICAgICAgIHZhciBtaWRkbGUgPSB2b2lkIDA7CiAgICAgICAgdmFyIGwgPSB2b2lkIDA7CiAgICAgICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgICAgICAgIC8vIHNpbmNlIHRpbWVycyBpcyBhbiBhcnJheSBvZiBwYWlycyAnbCcgd2lsbCBhbHdheXMKICAgICAgICAgICAgLy8gYmUgYW4gaW50ZWdlcgogICAgICAgICAgICBsID0gKGVuZCAtIHN0YXJ0KSAvIDY7CiAgICAgICAgICAgIC8vIGNvbXBlbnNhdGUgZm9yIHRoZSBpbmRleCBpbiBjYXNlIGV2ZW4gbnVtYmVyCiAgICAgICAgICAgIC8vIG9mIHBhaXJzIGluc2lkZSB0aW1lcnMKICAgICAgICAgICAgbWlkZGxlID0gc3RhcnQgKyBsIC0gbCAlIDY7CiAgICAgICAgICAgIGlmICh0aW1lID49IHRpbWVyc1ttaWRkbGVdKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IG1pZGRsZSArIDY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbmQgPSBtaWRkbGU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRpbWUgPj0gdGltZXJzW3N0YXJ0XSA/IHN0YXJ0ICsgNiA6IHN0YXJ0OwogICAgfQoKICAgIHZhciBRdWV1ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBRdWV1ZShuYW1lKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgICAgICAgICAgdmFyIGdsb2JhbE9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IHt9OwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFF1ZXVlKTsKCiAgICAgICAgICAgIHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkID0gW107CiAgICAgICAgICAgIHRoaXMudGFyZ2V0UXVldWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5fcXVldWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgICAgdGhpcy5nbG9iYWxPcHRpb25zID0gZ2xvYmFsT3B0aW9uczsKICAgICAgICB9CgogICAgICAgIFF1ZXVlLnByb3RvdHlwZS5zdGFja0ZvciA9IGZ1bmN0aW9uIHN0YWNrRm9yKGluZGV4KSB7CiAgICAgICAgICAgIGlmIChpbmRleCA8IHRoaXMuX3F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIGVudHJ5ID0gdGhpcy5fcXVldWVbaW5kZXggKiAzICsgNF07CiAgICAgICAgICAgICAgICBpZiAoZW50cnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW50cnkuc3RhY2s7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUXVldWUucHJvdG90eXBlLmZsdXNoID0gZnVuY3Rpb24gZmx1c2goc3luYykgewogICAgICAgICAgICB2YXIgX29wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCiAgICAgICAgICAgICAgICBiZWZvcmUgPSBfb3B0aW9ucy5iZWZvcmUsCiAgICAgICAgICAgICAgICBhZnRlciA9IF9vcHRpb25zLmFmdGVyOwoKICAgICAgICAgICAgdmFyIHRhcmdldCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIG1ldGhvZCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGFyZ3MgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBlcnJvclJlY29yZGVkRm9yU3RhY2sgPSB2b2lkIDA7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0UXVldWVzLmNsZWFyKCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkID0gdGhpcy5fcXVldWU7CiAgICAgICAgICAgICAgICB0aGlzLl9xdWV1ZSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChiZWZvcmUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgYmVmb3JlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGludm9rZSA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHF1ZXVlSXRlbXMgPSB0aGlzLl9xdWV1ZUJlaW5nRmx1c2hlZDsKICAgICAgICAgICAgaWYgKHF1ZXVlSXRlbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIG9uRXJyb3IgPSBnZXRPbkVycm9yKHRoaXMuZ2xvYmFsT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpbnZva2UgPSBvbkVycm9yID8gdGhpcy5pbnZva2VXaXRoT25FcnJvciA6IHRoaXMuaW52b2tlOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuaW5kZXg7IGkgPCBxdWV1ZUl0ZW1zLmxlbmd0aDsgaSArPSA0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRleCArPSA0OwogICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IHF1ZXVlSXRlbXNbaSArIDFdOwogICAgICAgICAgICAgICAgICAgIC8vIG1ldGhvZCBjb3VsZCBoYXZlIGJlZW4gbnVsbGlmaWVkIC8gY2FuY2VsZWQgZHVyaW5nIGZsdXNoCiAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAqKiBBdHRlbnRpb24gaW50cmVwaWQgZGV2ZWxvcGVyICoqCiAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgIFRvIGZpbmQgb3V0IHRoZSBzdGFjayBvZiB0aGlzIHRhc2sgd2hlbiBpdCB3YXMgc2NoZWR1bGVkIG9udG8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgdGhlIHJ1biBsb29wLCBhZGQgdGhlIGZvbGxvd2luZyB0byB5b3VyIGFwcC5qczoKICAgICAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgRW1iZXIucnVuLmJhY2tidXJuZXIuREVCVUcgPSB0cnVlOyAvLyBOT1RFOiBUaGlzIHNsb3dzIHlvdXIgYXBwLCBkb24ndCBsZWF2ZSBpdCBvbiBpbiBwcm9kdWN0aW9uLgogICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICBPbmNlIHRoYXQgaXMgaW4gcGxhY2UsIHdoZW4geW91IGFyZSBhdCBhIGJyZWFrcG9pbnQgYW5kIG5hdmlnYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgIGhlcmUgaW4gdGhlIHN0YWNrIGV4cGxvcmVyLCB5b3UgY2FuIGxvb2sgYXQgYGVycm9yUmVjb3JkZWRGb3JTdGFjay5zdGFja2AsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgIHdoaWNoIHdpbGwgYmUgdGhlIGNhcHR1cmVkIHN0YWNrIHdoZW4gdGhpcyBqb2Igd2FzIHNjaGVkdWxlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgT25lIHBvc3NpYmxlIGxvbmctdGVybSBzb2x1dGlvbiBpcyB0aGUgZm9sbG93aW5nIENocm9tZSBpc3N1ZToKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MzMyNjI0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IHF1ZXVlSXRlbXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBxdWV1ZUl0ZW1zW2kgKyAyXTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JSZWNvcmRlZEZvclN0YWNrID0gcXVldWVJdGVtc1tpICsgM107IC8vIERlYnVnZ2luZyBhc3Npc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgICAgIGludm9rZSh0YXJnZXQsIG1ldGhvZCwgYXJncywgb25FcnJvciwgZXJyb3JSZWNvcmRlZEZvclN0YWNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZXggIT09IHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkLmxlbmd0aCAmJiB0aGlzLmdsb2JhbE9wdGlvbnMubXVzdFlpZWxkICYmIHRoaXMuZ2xvYmFsT3B0aW9ucy5tdXN0WWllbGQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMSAvKiBQYXVzZSAqLzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFmdGVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGFmdGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcXVldWVCZWluZ0ZsdXNoZWQubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICAgIGlmIChzeW5jICE9PSBmYWxzZSAmJiB0aGlzLl9xdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBuZXcgaXRlbXMgaGF2ZSBiZWVuIGFkZGVkCiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUXVldWUucHJvdG90eXBlLmhhc1dvcmsgPSBmdW5jdGlvbiBoYXNXb3JrKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcXVldWVCZWluZ0ZsdXNoZWQubGVuZ3RoID4gMCB8fCB0aGlzLl9xdWV1ZS5sZW5ndGggPiAwOwogICAgICAgIH07CgogICAgICAgIFF1ZXVlLnByb3RvdHlwZS5jYW5jZWwgPSBmdW5jdGlvbiBjYW5jZWwoX3JlZikgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gX3JlZi50YXJnZXQsCiAgICAgICAgICAgICAgICBtZXRob2QgPSBfcmVmLm1ldGhvZDsKCiAgICAgICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuX3F1ZXVlOwogICAgICAgICAgICB2YXIgdGFyZ2V0UXVldWVNYXAgPSB0aGlzLnRhcmdldFF1ZXVlcy5nZXQodGFyZ2V0KTsKICAgICAgICAgICAgaWYgKHRhcmdldFF1ZXVlTWFwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRhcmdldFF1ZXVlTWFwLmRlbGV0ZShtZXRob2QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRJdGVtKHRhcmdldCwgbWV0aG9kLCBxdWV1ZSk7CiAgICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5zcGxpY2UoaW5kZXgsIDQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gaWYgbm90IGZvdW5kIGluIGN1cnJlbnQgcXVldWUKICAgICAgICAgICAgLy8gY291bGQgYmUgaW4gdGhlIHF1ZXVlIHRoYXQgaXMgYmVpbmcgZmx1c2hlZAogICAgICAgICAgICBxdWV1ZSA9IHRoaXMuX3F1ZXVlQmVpbmdGbHVzaGVkOwogICAgICAgICAgICBpbmRleCA9IGZpbmRJdGVtKHRhcmdldCwgbWV0aG9kLCBxdWV1ZSk7CiAgICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgICAgICBxdWV1ZVtpbmRleCArIDFdID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBRdWV1ZS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uIHB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKSB7CiAgICAgICAgICAgIHRoaXMuX3F1ZXVlLnB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHF1ZXVlOiB0aGlzLAogICAgICAgICAgICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZAogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgICAgIFF1ZXVlLnByb3RvdHlwZS5wdXNoVW5pcXVlID0gZnVuY3Rpb24gcHVzaFVuaXF1ZSh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spIHsKICAgICAgICAgICAgdmFyIGxvY2FsUXVldWVNYXAgPSB0aGlzLnRhcmdldFF1ZXVlcy5nZXQodGFyZ2V0KTsKICAgICAgICAgICAgaWYgKGxvY2FsUXVldWVNYXAgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgbG9jYWxRdWV1ZU1hcCA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0UXVldWVzLnNldCh0YXJnZXQsIGxvY2FsUXVldWVNYXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbmRleCA9IGxvY2FsUXVldWVNYXAuZ2V0KG1ldGhvZCk7CiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWVJbmRleCA9IHRoaXMuX3F1ZXVlLnB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKSAtIDQ7CiAgICAgICAgICAgICAgICBsb2NhbFF1ZXVlTWFwLnNldChtZXRob2QsIHF1ZXVlSW5kZXgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gdGhpcy5fcXVldWU7CiAgICAgICAgICAgICAgICBxdWV1ZVtpbmRleCArIDJdID0gYXJnczsgLy8gcmVwbGFjZSBhcmdzCiAgICAgICAgICAgICAgICBxdWV1ZVtpbmRleCArIDNdID0gc3RhY2s7IC8vIHJlcGxhY2Ugc3RhY2sKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcXVldWU6IHRoaXMsCiAgICAgICAgICAgICAgICB0YXJnZXQ6IHRhcmdldCwKICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgUXVldWUucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uIGludm9rZSh0YXJnZXQsIG1ldGhvZCwgYXJncyAvKiwgb25FcnJvciwgZXJyb3JSZWNvcmRlZEZvclN0YWNrICovKSB7CiAgICAgICAgICAgIGlmIChhcmdzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIG1ldGhvZC5jYWxsKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFF1ZXVlLnByb3RvdHlwZS5pbnZva2VXaXRoT25FcnJvciA9IGZ1bmN0aW9uIGludm9rZVdpdGhPbkVycm9yKHRhcmdldCwgbWV0aG9kLCBhcmdzLCBvbkVycm9yLCBlcnJvclJlY29yZGVkRm9yU3RhY2spIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChhcmdzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2QuY2FsbCh0YXJnZXQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2QuYXBwbHkodGFyZ2V0LCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIG9uRXJyb3IoZXJyb3IsIGVycm9yUmVjb3JkZWRGb3JTdGFjayk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUXVldWU7CiAgICB9KCk7CgogICAgdmFyIERlZmVycmVkQWN0aW9uUXVldWVzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIERlZmVycmVkQWN0aW9uUXVldWVzKCkgewogICAgICAgICAgICB2YXIgcXVldWVOYW1lcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogW107CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlZmVycmVkQWN0aW9uUXVldWVzKTsKCiAgICAgICAgICAgIHRoaXMucXVldWVzID0ge307CiAgICAgICAgICAgIHRoaXMucXVldWVOYW1lSW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLnF1ZXVlTmFtZXMgPSBxdWV1ZU5hbWVzOwogICAgICAgICAgICBxdWV1ZU5hbWVzLnJlZHVjZShmdW5jdGlvbiAocXVldWVzLCBxdWV1ZU5hbWUpIHsKICAgICAgICAgICAgICAgIHF1ZXVlc1txdWV1ZU5hbWVdID0gbmV3IFF1ZXVlKHF1ZXVlTmFtZSwgb3B0aW9uc1txdWV1ZU5hbWVdLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIHJldHVybiBxdWV1ZXM7CiAgICAgICAgICAgIH0sIHRoaXMucXVldWVzKTsKICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAgIEBtZXRob2Qgc2NoZWR1bGUKICAgICAgICAgIEBwYXJhbSB7U3RyaW5nfSBxdWV1ZU5hbWUKICAgICAgICAgIEBwYXJhbSB7QW55fSB0YXJnZXQKICAgICAgICAgIEBwYXJhbSB7QW55fSBtZXRob2QKICAgICAgICAgIEBwYXJhbSB7QW55fSBhcmdzCiAgICAgICAgICBAcGFyYW0ge0Jvb2xlYW59IG9uY2VGbGFnCiAgICAgICAgICBAcGFyYW0ge0FueX0gc3RhY2sKICAgICAgICAgIEByZXR1cm4gcXVldWUKICAgICAgICAqLwoKCiAgICAgICAgRGVmZXJyZWRBY3Rpb25RdWV1ZXMucHJvdG90eXBlLnNjaGVkdWxlID0gZnVuY3Rpb24gc2NoZWR1bGUocXVldWVOYW1lLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgb25jZUZsYWcsIHN0YWNrKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZXMgPSB0aGlzLnF1ZXVlczsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gcXVldWVzW3F1ZXVlTmFtZV07CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBhdHRlbXB0ZWQgdG8gc2NoZWR1bGUgYW4gYWN0aW9uIGluIGEgcXVldWUgKCcgKyBxdWV1ZU5hbWUgKyAnKSB0aGF0IGRvZXNuXCd0IGV4aXN0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gdW5kZWZpbmVkIHx8IG1ldGhvZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgYXR0ZW1wdGVkIHRvIHNjaGVkdWxlIGFuIGFjdGlvbiBpbiBhIHF1ZXVlICgnICsgcXVldWVOYW1lICsgJykgZm9yIGEgbWV0aG9kIHRoYXQgZG9lc25cJ3QgZXhpc3QnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnF1ZXVlTmFtZUluZGV4ID0gMDsKICAgICAgICAgICAgaWYgKG9uY2VGbGFnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcXVldWUucHVzaFVuaXF1ZSh0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHF1ZXVlLnB1c2godGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHN0YWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIERlZmVycmVkQWN0aW9uUXVldWVzLnByb3RvdHlwZS5mbHVzaCA9IGZ1bmN0aW9uIGZsdXNoKCkgewogICAgICAgICAgICB2YXIgZnJvbUF1dG9ydW4gPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlOwoKICAgICAgICAgICAgdmFyIHF1ZXVlID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgcXVldWVOYW1lID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgbnVtYmVyT2ZRdWV1ZXMgPSB0aGlzLnF1ZXVlTmFtZXMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAodGhpcy5xdWV1ZU5hbWVJbmRleCA8IG51bWJlck9mUXVldWVzKSB7CiAgICAgICAgICAgICAgICBxdWV1ZU5hbWUgPSB0aGlzLnF1ZXVlTmFtZXNbdGhpcy5xdWV1ZU5hbWVJbmRleF07CiAgICAgICAgICAgICAgICBxdWV1ZSA9IHRoaXMucXVldWVzW3F1ZXVlTmFtZV07CiAgICAgICAgICAgICAgICBpZiAocXVldWUuaGFzV29yaygpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucXVldWVOYW1lSW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoZnJvbUF1dG9ydW4gJiYgdGhpcy5xdWV1ZU5hbWVJbmRleCA8IG51bWJlck9mUXVldWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxIC8qIFBhdXNlICovOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmZsdXNoKGZhbHNlIC8qIGFzeW5jICovKSA9PT0gMSAvKiBQYXVzZSAqLykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgLyogUGF1c2UgKi87CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBEZWZlcnJlZEFjdGlvblF1ZXVlczsKICAgIH0oKTsKCiAgICB2YXIgaXRlcmF0b3JEcmFpbiA9IGZ1bmN0aW9uIChmbikgewogICAgICAgIHZhciBpdGVyYXRvciA9IGZuKCk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgICB3aGlsZSAocmVzdWx0LmRvbmUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJlc3VsdC52YWx1ZSgpOwogICAgICAgICAgICByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgbm9vcCA9IGZ1bmN0aW9uICgpIHt9OwogICAgZnVuY3Rpb24gcGFyc2VBcmdzKCkgewogICAgICAgIHZhciBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgIHZhciBhcmdzID0gdm9pZCAwOwogICAgICAgIHZhciBtZXRob2QgPSB2b2lkIDA7CiAgICAgICAgdmFyIHRhcmdldCA9IHZvaWQgMDsKICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7fSBlbHNlIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgbWV0aG9kID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBhcmdzSW5kZXggPSAyOwogICAgICAgICAgICB2YXIgbWV0aG9kT3JUYXJnZXQgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIHZhciBtZXRob2RPckFyZ3MgPSBhcmd1bWVudHNbMV07CiAgICAgICAgICAgIHZhciB0eXBlID0gdHlwZW9mIG1ldGhvZE9yQXJnczsKICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IG1ldGhvZE9yVGFyZ2V0OwogICAgICAgICAgICAgICAgbWV0aG9kID0gbWV0aG9kT3JBcmdzOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1ldGhvZE9yVGFyZ2V0ICE9PSBudWxsICYmIHR5cGUgPT09ICdzdHJpbmcnICYmIG1ldGhvZE9yQXJncyBpbiBtZXRob2RPclRhcmdldCkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gbWV0aG9kT3JUYXJnZXQ7CiAgICAgICAgICAgICAgICBtZXRob2QgPSB0YXJnZXRbbWV0aG9kT3JBcmdzXTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kT3JUYXJnZXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGFyZ3NJbmRleCA9IDE7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgbWV0aG9kID0gbWV0aG9kT3JUYXJnZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbmd0aCA+IGFyZ3NJbmRleCkgewogICAgICAgICAgICAgICAgdmFyIGxlbiA9IGxlbmd0aCAtIGFyZ3NJbmRleDsKICAgICAgICAgICAgICAgIGFyZ3MgPSBuZXcgQXJyYXkobGVuKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhcmdzW2ldID0gYXJndW1lbnRzW2kgKyBhcmdzSW5kZXhdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBbdGFyZ2V0LCBtZXRob2QsIGFyZ3NdOwogICAgfQogICAgZnVuY3Rpb24gcGFyc2VUaW1lckFyZ3MoKSB7CiAgICAgICAgdmFyIF9wYXJzZUFyZ3MgPSBwYXJzZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpLAogICAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VBcmdzWzBdLAogICAgICAgICAgICBtZXRob2QgPSBfcGFyc2VBcmdzWzFdLAogICAgICAgICAgICBhcmdzID0gX3BhcnNlQXJnc1syXTsKCiAgICAgICAgdmFyIHdhaXQgPSAwOwogICAgICAgIHZhciBsZW5ndGggPSBhcmdzICE9PSB1bmRlZmluZWQgPyBhcmdzLmxlbmd0aCA6IDA7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGxhc3QgPSBhcmdzW2xlbmd0aCAtIDFdOwogICAgICAgICAgICBpZiAoaXNDb2VyY2FibGVOdW1iZXIobGFzdCkpIHsKICAgICAgICAgICAgICAgIHdhaXQgPSBwYXJzZUludChhcmdzLnBvcCgpLCAxMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFt0YXJnZXQsIG1ldGhvZCwgYXJncywgd2FpdF07CiAgICB9CiAgICBmdW5jdGlvbiBwYXJzZURlYm91bmNlQXJncygpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdm9pZCAwOwogICAgICAgIHZhciBtZXRob2QgPSB2b2lkIDA7CiAgICAgICAgdmFyIGlzSW1tZWRpYXRlID0gdm9pZCAwOwogICAgICAgIHZhciBhcmdzID0gdm9pZCAwOwogICAgICAgIHZhciB3YWl0ID0gdm9pZCAwOwogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIG1ldGhvZCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgd2FpdCA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3BhcnNlQXJnczIgPSBwYXJzZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlQXJnczJbMF07CiAgICAgICAgICAgIG1ldGhvZCA9IF9wYXJzZUFyZ3MyWzFdOwogICAgICAgICAgICBhcmdzID0gX3BhcnNlQXJnczJbMl07CgogICAgICAgICAgICBpZiAoYXJncyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB3YWl0ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdhaXQgPSBhcmdzLnBvcCgpOwogICAgICAgICAgICAgICAgaWYgKCFpc0NvZXJjYWJsZU51bWJlcih3YWl0KSkgewogICAgICAgICAgICAgICAgICAgIGlzSW1tZWRpYXRlID0gd2FpdCA9PT0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB3YWl0ID0gYXJncy5wb3AoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3YWl0ID0gcGFyc2VJbnQod2FpdCwgMTApOwogICAgICAgIHJldHVybiBbdGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHdhaXQsIGlzSW1tZWRpYXRlXTsKICAgIH0KICAgIHZhciBVVUlEID0gMDsKICAgIHZhciBiZWdpbkNvdW50ID0gMDsKICAgIHZhciBlbmRDb3VudCA9IDA7CiAgICB2YXIgYmVnaW5FdmVudENvdW50ID0gMDsKICAgIHZhciBlbmRFdmVudENvdW50ID0gMDsKICAgIHZhciBydW5Db3VudCA9IDA7CiAgICB2YXIgam9pbkNvdW50ID0gMDsKICAgIHZhciBkZWZlckNvdW50ID0gMDsKICAgIHZhciBzY2hlZHVsZUNvdW50ID0gMDsKICAgIHZhciBzY2hlZHVsZUl0ZXJhYmxlQ291bnQgPSAwOwogICAgdmFyIGRlZmVyT25jZUNvdW50ID0gMDsKICAgIHZhciBzY2hlZHVsZU9uY2VDb3VudCA9IDA7CiAgICB2YXIgc2V0VGltZW91dENvdW50ID0gMDsKICAgIHZhciBsYXRlckNvdW50ID0gMDsKICAgIHZhciB0aHJvdHRsZUNvdW50ID0gMDsKICAgIHZhciBkZWJvdW5jZUNvdW50ID0gMDsKICAgIHZhciBjYW5jZWxUaW1lcnNDb3VudCA9IDA7CiAgICB2YXIgY2FuY2VsQ291bnQgPSAwOwogICAgdmFyIGF1dG9ydW5zQ3JlYXRlZENvdW50ID0gMDsKICAgIHZhciBhdXRvcnVuc0NvbXBsZXRlZENvdW50ID0gMDsKICAgIHZhciBkZWZlcnJlZEFjdGlvblF1ZXVlc0NyZWF0ZWRDb3VudCA9IDA7CiAgICB2YXIgbmVzdGVkRGVmZXJyZWRBY3Rpb25RdWV1ZXNDcmVhdGVkID0gMDsKCiAgICB2YXIgQmFja2J1cm5lciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBCYWNrYnVybmVyKHF1ZXVlTmFtZXMsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQmFja2J1cm5lcik7CgogICAgICAgICAgICB0aGlzLkRFQlVHID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5pbnN0YW5jZVN0YWNrID0gW107CiAgICAgICAgICAgIHRoaXMuX2RlYm91bmNlZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fdGhyb3R0bGVycyA9IFtdOwogICAgICAgICAgICB0aGlzLl9ldmVudENhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgIGVuZDogW10sCiAgICAgICAgICAgICAgICBiZWdpbjogW10KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5fdGltZXJUaW1lb3V0SWQgPSBudWxsOwogICAgICAgICAgICB0aGlzLl90aW1lcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fYXV0b3J1biA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucXVldWVOYW1lcyA9IHF1ZXVlTmFtZXM7CiAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5vcHRpb25zLmRlZmF1bHRRdWV1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlZmF1bHRRdWV1ZSA9IHRoaXMub3B0aW9ucy5kZWZhdWx0UXVldWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kZWZhdWx0UXVldWUgPSB0aGlzLnF1ZXVlTmFtZXNbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fb25CZWdpbiA9IHRoaXMub3B0aW9ucy5vbkJlZ2luIHx8IG5vb3A7CiAgICAgICAgICAgIHRoaXMuX29uRW5kID0gdGhpcy5vcHRpb25zLm9uRW5kIHx8IG5vb3A7CiAgICAgICAgICAgIHRoaXMuX2JvdW5kUnVuRXhwaXJlZFRpbWVycyA9IHRoaXMuX3J1bkV4cGlyZWRUaW1lcnMuYmluZCh0aGlzKTsKICAgICAgICAgICAgdGhpcy5fYm91bmRBdXRvcnVuRW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgYXV0b3J1bnNDb21wbGV0ZWRDb3VudCsrOwogICAgICAgICAgICAgICAgLy8gaWYgdGhlIGF1dG9ydW4gd2FzIGFscmVhZHkgZmx1c2hlZCwgZG8gbm90aGluZwogICAgICAgICAgICAgICAgaWYgKF90aGlzLl9hdXRvcnVuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RoaXMuX2F1dG9ydW4gPSBudWxsOwogICAgICAgICAgICAgICAgX3RoaXMuX2VuZCh0cnVlIC8qIGZyb21BdXRvcnVuICovKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGJ1aWxkZXIgPSB0aGlzLm9wdGlvbnMuX2J1aWxkUGxhdGZvcm0gfHwgYnVpbGRQbGF0Zm9ybTsKICAgICAgICAgICAgdGhpcy5fcGxhdGZvcm0gPSBidWlsZGVyKHRoaXMuX2JvdW5kQXV0b3J1bkVuZCk7CiAgICAgICAgfQoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5iZWdpbiA9IGZ1bmN0aW9uIGJlZ2luKCkgewogICAgICAgICAgICBiZWdpbkNvdW50Kys7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZSA9IHRoaXMuY3VycmVudEluc3RhbmNlOwogICAgICAgICAgICB2YXIgY3VycmVudCA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKHRoaXMuX2F1dG9ydW4gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBwcmV2aW91c0luc3RhbmNlOwogICAgICAgICAgICAgICAgdGhpcy5fY2FuY2VsQXV0b3J1bigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXN0ZWREZWZlcnJlZEFjdGlvblF1ZXVlc0NyZWF0ZWQrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RhbmNlU3RhY2sucHVzaChwcmV2aW91c0luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZENvdW50Kys7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBuZXcgRGVmZXJyZWRBY3Rpb25RdWV1ZXModGhpcy5xdWV1ZU5hbWVzLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIGJlZ2luRXZlbnRDb3VudCsrOwogICAgICAgICAgICAgICAgdGhpcy5fdHJpZ2dlcignYmVnaW4nLCBjdXJyZW50LCBwcmV2aW91c0luc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9vbkJlZ2luKGN1cnJlbnQsIHByZXZpb3VzSW5zdGFuY2UpOwogICAgICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiBlbmQoKSB7CiAgICAgICAgICAgIGVuZENvdW50Kys7CiAgICAgICAgICAgIHRoaXMuX2VuZChmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0NhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9ldmVudENhbGxiYWNrc1tldmVudE5hbWVdOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBvbigpIGV2ZW50ICcgKyBldmVudE5hbWUgKyAnIGJlY2F1c2UgaXQgZG9lcyBub3QgZXhpc3QnKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uIG9mZihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9ldmVudENhbGxiYWNrc1tldmVudE5hbWVdOwogICAgICAgICAgICBpZiAoIWV2ZW50TmFtZSB8fCBjYWxsYmFja3MgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IG9mZigpIGV2ZW50ICcgKyBldmVudE5hbWUgKyAnIGJlY2F1c2UgaXQgZG9lcyBub3QgZXhpc3QnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2tGb3VuZCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tpXSA9PT0gY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYWxsYmFja0ZvdW5kKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3Qgb2ZmKCkgY2FsbGJhY2sgdGhhdCBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gcnVuKCkgewogICAgICAgICAgICBydW5Db3VudCsrOwoKICAgICAgICAgICAgdmFyIF9wYXJzZUFyZ3MzID0gcGFyc2VBcmdzLmFwcGx5KHVuZGVmaW5lZCwgYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgIHRhcmdldCA9IF9wYXJzZUFyZ3MzWzBdLAogICAgICAgICAgICAgICAgbWV0aG9kID0gX3BhcnNlQXJnczNbMV0sCiAgICAgICAgICAgICAgICBhcmdzID0gX3BhcnNlQXJnczNbMl07CgogICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVuKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5qb2luID0gZnVuY3Rpb24gam9pbigpIHsKICAgICAgICAgICAgam9pbkNvdW50Kys7CgogICAgICAgICAgICB2YXIgX3BhcnNlQXJnczQgPSBwYXJzZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlQXJnczRbMF0sCiAgICAgICAgICAgICAgICBtZXRob2QgPSBfcGFyc2VBcmdzNFsxXSwKICAgICAgICAgICAgICAgIGFyZ3MgPSBfcGFyc2VBcmdzNFsyXTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9qb2luKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5kZWZlciA9IGZ1bmN0aW9uIGRlZmVyKHF1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgICAgICAgZGVmZXJDb3VudCsrOwoKICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuID4gMyA/IF9sZW4gLSAzIDogMCksIF9rZXkgPSAzOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAzXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZWR1bGUuYXBwbHkodGhpcywgW3F1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2RdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuc2NoZWR1bGUgPSBmdW5jdGlvbiBzY2hlZHVsZShxdWV1ZU5hbWUpIHsKICAgICAgICAgICAgc2NoZWR1bGVDb3VudCsrOwoKICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBfYXJncyA9IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIF9hcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX3BhcnNlQXJnczUgPSBwYXJzZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBfYXJncyksCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VBcmdzNVswXSwKICAgICAgICAgICAgICAgIG1ldGhvZCA9IF9wYXJzZUFyZ3M1WzFdLAogICAgICAgICAgICAgICAgYXJncyA9IF9wYXJzZUFyZ3M1WzJdOwoKICAgICAgICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5zdXJlSW5zdGFuY2UoKS5zY2hlZHVsZShxdWV1ZU5hbWUsIHRhcmdldCwgbWV0aG9kLCBhcmdzLCBmYWxzZSwgc3RhY2spOwogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLnNjaGVkdWxlSXRlcmFibGUgPSBmdW5jdGlvbiBzY2hlZHVsZUl0ZXJhYmxlKHF1ZXVlTmFtZSwgaXRlcmFibGUpIHsKICAgICAgICAgICAgc2NoZWR1bGVJdGVyYWJsZUNvdW50Kys7CiAgICAgICAgICAgIHZhciBzdGFjayA9IHRoaXMuREVCVUcgPyBuZXcgRXJyb3IoKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Vuc3VyZUluc3RhbmNlKCkuc2NoZWR1bGUocXVldWVOYW1lLCBudWxsLCBpdGVyYXRvckRyYWluLCBbaXRlcmFibGVdLCBmYWxzZSwgc3RhY2spOwogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLmRlZmVyT25jZSA9IGZ1bmN0aW9uIGRlZmVyT25jZShxdWV1ZU5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgICAgICAgIGRlZmVyT25jZUNvdW50Kys7CgogICAgICAgICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyA+IDMgPyBfbGVuMyAtIDMgOiAwKSwgX2tleTMgPSAzOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkzIC0gM10gPSBhcmd1bWVudHNbX2tleTNdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5zY2hlZHVsZU9uY2UuYXBwbHkodGhpcywgW3F1ZXVlTmFtZSwgdGFyZ2V0LCBtZXRob2RdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuc2NoZWR1bGVPbmNlID0gZnVuY3Rpb24gc2NoZWR1bGVPbmNlKHF1ZXVlTmFtZSkgewogICAgICAgICAgICBzY2hlZHVsZU9uY2VDb3VudCsrOwoKICAgICAgICAgICAgZm9yICh2YXIgX2xlbjQgPSBhcmd1bWVudHMubGVuZ3RoLCBfYXJncyA9IEFycmF5KF9sZW40ID4gMSA/IF9sZW40IC0gMSA6IDApLCBfa2V5NCA9IDE7IF9rZXk0IDwgX2xlbjQ7IF9rZXk0KyspIHsKICAgICAgICAgICAgICAgIF9hcmdzW19rZXk0IC0gMV0gPSBhcmd1bWVudHNbX2tleTRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX3BhcnNlQXJnczYgPSBwYXJzZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBfYXJncyksCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VBcmdzNlswXSwKICAgICAgICAgICAgICAgIG1ldGhvZCA9IF9wYXJzZUFyZ3M2WzFdLAogICAgICAgICAgICAgICAgYXJncyA9IF9wYXJzZUFyZ3M2WzJdOwoKICAgICAgICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW5zdXJlSW5zdGFuY2UoKS5zY2hlZHVsZShxdWV1ZU5hbWUsIHRhcmdldCwgbWV0aG9kLCBhcmdzLCB0cnVlLCBzdGFjayk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuc2V0VGltZW91dCA9IGZ1bmN0aW9uIHNldFRpbWVvdXQoKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXRDb3VudCsrOwogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLmxhdGVyID0gZnVuY3Rpb24gbGF0ZXIoKSB7CiAgICAgICAgICAgIGxhdGVyQ291bnQrKzsKCiAgICAgICAgICAgIHZhciBfcGFyc2VUaW1lckFyZ3MgPSBwYXJzZVRpbWVyQXJncy5hcHBseSh1bmRlZmluZWQsIGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBfcGFyc2VUaW1lckFyZ3NbMF0sCiAgICAgICAgICAgICAgICBtZXRob2QgPSBfcGFyc2VUaW1lckFyZ3NbMV0sCiAgICAgICAgICAgICAgICBhcmdzID0gX3BhcnNlVGltZXJBcmdzWzJdLAogICAgICAgICAgICAgICAgd2FpdCA9IF9wYXJzZVRpbWVyQXJnc1szXTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sYXRlcih0YXJnZXQsIG1ldGhvZCwgYXJncywgd2FpdCk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUudGhyb3R0bGUgPSBmdW5jdGlvbiB0aHJvdHRsZSgpIHsKICAgICAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgICAgICB0aHJvdHRsZUNvdW50Kys7CgogICAgICAgICAgICB2YXIgX3BhcnNlRGVib3VuY2VBcmdzID0gcGFyc2VEZWJvdW5jZUFyZ3MuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgdGFyZ2V0ID0gX3BhcnNlRGVib3VuY2VBcmdzWzBdLAogICAgICAgICAgICAgICAgbWV0aG9kID0gX3BhcnNlRGVib3VuY2VBcmdzWzFdLAogICAgICAgICAgICAgICAgYXJncyA9IF9wYXJzZURlYm91bmNlQXJnc1syXSwKICAgICAgICAgICAgICAgIHdhaXQgPSBfcGFyc2VEZWJvdW5jZUFyZ3NbM10sCiAgICAgICAgICAgICAgICBfcGFyc2VEZWJvdW5jZUFyZ3MkID0gX3BhcnNlRGVib3VuY2VBcmdzWzRdLAogICAgICAgICAgICAgICAgaXNJbW1lZGlhdGUgPSBfcGFyc2VEZWJvdW5jZUFyZ3MkID09PSB1bmRlZmluZWQgPyB0cnVlIDogX3BhcnNlRGVib3VuY2VBcmdzJDsKCiAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRJdGVtKHRhcmdldCwgbWV0aG9kLCB0aGlzLl90aHJvdHRsZXJzKTsKICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Rocm90dGxlcnNbaW5kZXggKyAyXSA9IGFyZ3M7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdGhyb3R0bGVyc1tpbmRleCArIDNdOwogICAgICAgICAgICB9IC8vIHRocm90dGxlZAogICAgICAgICAgICB2YXIgdGltZXIgPSB0aGlzLl9wbGF0Zm9ybS5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpID0gZmluZFRpbWVyKHRpbWVyLCBfdGhpczIuX3Rocm90dGxlcnMpOwoKICAgICAgICAgICAgICAgIHZhciBfdGhyb3R0bGVycyRzcGxpY2UgPSBfdGhpczIuX3Rocm90dGxlcnMuc3BsaWNlKGksIDQpLAogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBfdGhyb3R0bGVycyRzcGxpY2VbMF0sCiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IF90aHJvdHRsZXJzJHNwbGljZVsxXSwKICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBfdGhyb3R0bGVycyRzcGxpY2VbMl07CgogICAgICAgICAgICAgICAgaWYgKGlzSW1tZWRpYXRlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzMi5fcnVuKGNvbnRleHQsIGZ1bmMsIHBhcmFtcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHdhaXQpOwogICAgICAgICAgICBpZiAoaXNJbW1lZGlhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2pvaW4odGFyZ2V0LCBtZXRob2QsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3Rocm90dGxlcnMucHVzaCh0YXJnZXQsIG1ldGhvZCwgYXJncywgdGltZXIpOwogICAgICAgICAgICByZXR1cm4gdGltZXI7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuZGVib3VuY2UgPSBmdW5jdGlvbiBkZWJvdW5jZSgpIHsKICAgICAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgICAgICBkZWJvdW5jZUNvdW50Kys7CgogICAgICAgICAgICB2YXIgX3BhcnNlRGVib3VuY2VBcmdzMiA9IHBhcnNlRGVib3VuY2VBcmdzLmFwcGx5KHVuZGVmaW5lZCwgYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgIHRhcmdldCA9IF9wYXJzZURlYm91bmNlQXJnczJbMF0sCiAgICAgICAgICAgICAgICBtZXRob2QgPSBfcGFyc2VEZWJvdW5jZUFyZ3MyWzFdLAogICAgICAgICAgICAgICAgYXJncyA9IF9wYXJzZURlYm91bmNlQXJnczJbMl0sCiAgICAgICAgICAgICAgICB3YWl0ID0gX3BhcnNlRGVib3VuY2VBcmdzMlszXSwKICAgICAgICAgICAgICAgIF9wYXJzZURlYm91bmNlQXJnczIkID0gX3BhcnNlRGVib3VuY2VBcmdzMls0XSwKICAgICAgICAgICAgICAgIGlzSW1tZWRpYXRlID0gX3BhcnNlRGVib3VuY2VBcmdzMiQgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogX3BhcnNlRGVib3VuY2VBcmdzMiQ7CgogICAgICAgICAgICAvLyBSZW1vdmUgZGVib3VuY2VlCiAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRJdGVtKHRhcmdldCwgbWV0aG9kLCB0aGlzLl9kZWJvdW5jZWVzKTsKICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgICAgIHZhciB0aW1lcklkID0gdGhpcy5fZGVib3VuY2Vlc1tpbmRleCArIDNdOwogICAgICAgICAgICAgICAgdGhpcy5fcGxhdGZvcm0uY2xlYXJUaW1lb3V0KHRpbWVySWQpOwogICAgICAgICAgICAgICAgdGhpcy5fZGVib3VuY2Vlcy5zcGxpY2UoaW5kZXgsIDQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0aW1lciA9IHRoaXMuX3BsYXRmb3JtLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGkgPSBmaW5kVGltZXIodGltZXIsIF90aGlzMy5fZGVib3VuY2Vlcyk7CgogICAgICAgICAgICAgICAgdmFyIF9kZWJvdW5jZWVzJHNwbGljZSA9IF90aGlzMy5fZGVib3VuY2Vlcy5zcGxpY2UoaSwgNCksCiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IF9kZWJvdW5jZWVzJHNwbGljZVswXSwKICAgICAgICAgICAgICAgICAgICBmdW5jID0gX2RlYm91bmNlZXMkc3BsaWNlWzFdLAogICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IF9kZWJvdW5jZWVzJHNwbGljZVsyXTsKCiAgICAgICAgICAgICAgICBpZiAoaXNJbW1lZGlhdGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMzLl9ydW4oY29udGV4dCwgZnVuYywgcGFyYW1zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgd2FpdCk7CiAgICAgICAgICAgIGlmIChpc0ltbWVkaWF0ZSAmJiBpbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2pvaW4odGFyZ2V0LCBtZXRob2QsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2RlYm91bmNlZXMucHVzaCh0YXJnZXQsIG1ldGhvZCwgYXJncywgdGltZXIpOwogICAgICAgICAgICByZXR1cm4gdGltZXI7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuY2FuY2VsVGltZXJzID0gZnVuY3Rpb24gY2FuY2VsVGltZXJzKCkgewogICAgICAgICAgICBjYW5jZWxUaW1lcnNDb3VudCsrOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8IHRoaXMuX3Rocm90dGxlcnMubGVuZ3RoOyBpICs9IDQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BsYXRmb3JtLmNsZWFyVGltZW91dCh0aGlzLl90aHJvdHRsZXJzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl90aHJvdHRsZXJzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIHQgPSAzOyB0IDwgdGhpcy5fZGVib3VuY2Vlcy5sZW5ndGg7IHQgKz0gNCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGxhdGZvcm0uY2xlYXJUaW1lb3V0KHRoaXMuX2RlYm91bmNlZXNbdF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2RlYm91bmNlZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fY2xlYXJUaW1lclRpbWVvdXQoKTsKICAgICAgICAgICAgdGhpcy5fdGltZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuX2NhbmNlbEF1dG9ydW4oKTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5oYXNUaW1lcnMgPSBmdW5jdGlvbiBoYXNUaW1lcnMoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90aW1lcnMubGVuZ3RoID4gMCB8fCB0aGlzLl9kZWJvdW5jZWVzLmxlbmd0aCA+IDAgfHwgdGhpcy5fdGhyb3R0bGVycy5sZW5ndGggPiAwIHx8IHRoaXMuX2F1dG9ydW4gIT09IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24gY2FuY2VsKHRpbWVyKSB7CiAgICAgICAgICAgIGNhbmNlbENvdW50Kys7CiAgICAgICAgICAgIGlmICh0aW1lciA9PT0gdW5kZWZpbmVkIHx8IHRpbWVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRpbWVyVHlwZSA9IHR5cGVvZiB0aW1lcjsKICAgICAgICAgICAgaWYgKHRpbWVyVHlwZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYW5jZWxJdGVtKHRpbWVyLCB0aGlzLl90aHJvdHRsZXJzKSB8fCB0aGlzLl9jYW5jZWxJdGVtKHRpbWVyLCB0aGlzLl9kZWJvdW5jZWVzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lclR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FuY2VsTGF0ZXJUaW1lcih0aW1lcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGltZXJUeXBlID09PSAnb2JqZWN0JyAmJiB0aW1lci5xdWV1ZSAmJiB0aW1lci5tZXRob2QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aW1lci5xdWV1ZS5jYW5jZWwodGltZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5lbnN1cmVJbnN0YW5jZSA9IGZ1bmN0aW9uIGVuc3VyZUluc3RhbmNlKCkgewogICAgICAgICAgICB0aGlzLl9lbnN1cmVJbnN0YW5jZSgpOwogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLl9lbmQgPSBmdW5jdGlvbiBfZW5kKGZyb21BdXRvcnVuKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SW5zdGFuY2UgPSB0aGlzLmN1cnJlbnRJbnN0YW5jZTsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChjdXJyZW50SW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignZW5kIGNhbGxlZCB3aXRob3V0IGJlZ2luJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUHJldmVudCBkb3VibGUtZmluYWxseSBidWcgaW4gU2FmYXJpIDYuMC4yIGFuZCBpT1MgNgogICAgICAgICAgICAvLyBUaGlzIGJ1ZyBhcHBlYXJzIHRvIGJlIHJlc29sdmVkIGluIFNhZmFyaSA2LjAuNSBhbmQgaU9TIDcKICAgICAgICAgICAgdmFyIGZpbmFsbHlBbHJlYWR5Q2FsbGVkID0gZmFsc2U7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBjdXJyZW50SW5zdGFuY2UuZmx1c2goZnJvbUF1dG9ydW4pOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKCFmaW5hbGx5QWxyZWFkeUNhbGxlZCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsbHlBbHJlYWR5Q2FsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSAxIC8qIFBhdXNlICovKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zY2hlZHVsZUF1dG9ydW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnN0YW5jZVN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2VTdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyaWdnZXIoJ2VuZCcsIGN1cnJlbnRJbnN0YW5jZSwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb25FbmQoY3VycmVudEluc3RhbmNlLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLl9qb2luID0gZnVuY3Rpb24gX2pvaW4odGFyZ2V0LCBtZXRob2QsIGFyZ3MpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEluc3RhbmNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVuKHRhcmdldCwgbWV0aG9kLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFyZ2V0ID09PSB1bmRlZmluZWQgJiYgYXJncyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fcnVuID0gZnVuY3Rpb24gX3J1bih0YXJnZXQsIG1ldGhvZCwgYXJncykgewogICAgICAgICAgICB2YXIgb25FcnJvciA9IGdldE9uRXJyb3IodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5iZWdpbigpOwogICAgICAgICAgICBpZiAob25FcnJvcikgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIG9uRXJyb3IoZXJyb3IpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW5kKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fY2FuY2VsQXV0b3J1biA9IGZ1bmN0aW9uIF9jYW5jZWxBdXRvcnVuKCkgewogICAgICAgICAgICBpZiAodGhpcy5fYXV0b3J1biAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fcGxhdGZvcm0uY2xlYXJOZXh0KHRoaXMuX2F1dG9ydW4pOwogICAgICAgICAgICAgICAgdGhpcy5fYXV0b3J1biA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fbGF0ZXIgPSBmdW5jdGlvbiBfbGF0ZXIodGFyZ2V0LCBtZXRob2QsIGFyZ3MsIHdhaXQpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gdGhpcy5ERUJVRyA/IG5ldyBFcnJvcigpIDogdW5kZWZpbmVkOwogICAgICAgICAgICB2YXIgZXhlY3V0ZUF0ID0gdGhpcy5fcGxhdGZvcm0ubm93KCkgKyB3YWl0OwogICAgICAgICAgICB2YXIgaWQgPSBVVUlEKysgKyAnJzsKICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVycy5wdXNoKGV4ZWN1dGVBdCwgaWQsIHRhcmdldCwgbWV0aG9kLCBhcmdzLCBzdGFjayk7CiAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YWxsVGltZXJUaW1lb3V0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBmaW5kIHBvc2l0aW9uIHRvIGluc2VydAogICAgICAgICAgICAgICAgdmFyIGkgPSBiaW5hcnlTZWFyY2goZXhlY3V0ZUF0LCB0aGlzLl90aW1lcnMpOwogICAgICAgICAgICAgICAgdGhpcy5fdGltZXJzLnNwbGljZShpLCAwLCBleGVjdXRlQXQsIGlkLCB0YXJnZXQsIG1ldGhvZCwgYXJncywgc3RhY2spOwogICAgICAgICAgICAgICAgLy8gd2Ugc2hvdWxkIGJlIHRoZSBuZXcgZWFybGllc3QgdGltZXIgaWYgaSA9PSAwCiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlaW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fY2FuY2VsTGF0ZXJUaW1lciA9IGZ1bmN0aW9uIF9jYW5jZWxMYXRlclRpbWVyKHRpbWVyKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fdGltZXJzLmxlbmd0aDsgaSArPSA2KSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdGltZXJzW2ldID09PSB0aW1lcikgewogICAgICAgICAgICAgICAgICAgIGkgPSBpIC0gMTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90aW1lcnMuc3BsaWNlKGksIDYpOwogICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlaW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuX2NhbmNlbEl0ZW0gPSBmdW5jdGlvbiBfY2FuY2VsSXRlbSh0aW1lciwgYXJyYXkpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZFRpbWVyKHRpbWVyLCBhcnJheSk7CiAgICAgICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wbGF0Zm9ybS5jbGVhclRpbWVvdXQodGltZXIpOwogICAgICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCA0KTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fdHJpZ2dlciA9IGZ1bmN0aW9uIF90cmlnZ2VyKGV2ZW50TmFtZSwgYXJnMSwgYXJnMikgewogICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fZXZlbnRDYWxsYmFja3NbZXZlbnROYW1lXTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXShhcmcxLCBhcmcyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLl9ydW5FeHBpcmVkVGltZXJzID0gZnVuY3Rpb24gX3J1bkV4cGlyZWRUaW1lcnMoKSB7CiAgICAgICAgICAgIHRoaXMuX3RpbWVyVGltZW91dElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJlZ2luKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zY2hlZHVsZUV4cGlyZWRUaW1lcnMoKTsKICAgICAgICAgICAgICAgIHRoaXMuZW5kKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fc2NoZWR1bGVFeHBpcmVkVGltZXJzID0gZnVuY3Rpb24gX3NjaGVkdWxlRXhwaXJlZFRpbWVycygpIHsKICAgICAgICAgICAgdmFyIHRpbWVycyA9IHRoaXMuX3RpbWVyczsKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICB2YXIgbCA9IHRpbWVycy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UXVldWUgPSB0aGlzLl9kZWZhdWx0UXVldWU7CiAgICAgICAgICAgIHZhciBuID0gdGhpcy5fcGxhdGZvcm0ubm93KCk7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSArPSA2KSB7CiAgICAgICAgICAgICAgICB2YXIgZXhlY3V0ZUF0ID0gdGltZXJzW2ldOwogICAgICAgICAgICAgICAgaWYgKGV4ZWN1dGVBdCA+IG4pIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aW1lcnNbaSArIDJdOwogICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IHRpbWVyc1tpICsgM107CiAgICAgICAgICAgICAgICB2YXIgX2FyZ3MyID0gdGltZXJzW2kgKyA0XTsKICAgICAgICAgICAgICAgIHZhciBzdGFjayA9IHRpbWVyc1tpICsgNV07CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRJbnN0YW5jZS5zY2hlZHVsZShkZWZhdWx0UXVldWUsIHRhcmdldCwgbWV0aG9kLCBfYXJnczIsIGZhbHNlLCBzdGFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXJzLnNwbGljZSgwLCBpKTsKICAgICAgICAgICAgdGhpcy5faW5zdGFsbFRpbWVyVGltZW91dCgpOwogICAgICAgIH07CgogICAgICAgIEJhY2tidXJuZXIucHJvdG90eXBlLl9yZWluc3RhbGxUaW1lclRpbWVvdXQgPSBmdW5jdGlvbiBfcmVpbnN0YWxsVGltZXJUaW1lb3V0KCkgewogICAgICAgICAgICB0aGlzLl9jbGVhclRpbWVyVGltZW91dCgpOwogICAgICAgICAgICB0aGlzLl9pbnN0YWxsVGltZXJUaW1lb3V0KCk7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuX2NsZWFyVGltZXJUaW1lb3V0ID0gZnVuY3Rpb24gX2NsZWFyVGltZXJUaW1lb3V0KCkgewogICAgICAgICAgICBpZiAodGhpcy5fdGltZXJUaW1lb3V0SWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9wbGF0Zm9ybS5jbGVhclRpbWVvdXQodGhpcy5fdGltZXJUaW1lb3V0SWQpOwogICAgICAgICAgICB0aGlzLl90aW1lclRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgQmFja2J1cm5lci5wcm90b3R5cGUuX2luc3RhbGxUaW1lclRpbWVvdXQgPSBmdW5jdGlvbiBfaW5zdGFsbFRpbWVyVGltZW91dCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWluRXhwaXJlc0F0ID0gdGhpcy5fdGltZXJzWzBdOwogICAgICAgICAgICB2YXIgbiA9IHRoaXMuX3BsYXRmb3JtLm5vdygpOwogICAgICAgICAgICB2YXIgd2FpdCA9IE1hdGgubWF4KDAsIG1pbkV4cGlyZXNBdCAtIG4pOwogICAgICAgICAgICB0aGlzLl90aW1lclRpbWVvdXRJZCA9IHRoaXMuX3BsYXRmb3JtLnNldFRpbWVvdXQodGhpcy5fYm91bmRSdW5FeHBpcmVkVGltZXJzLCB3YWl0KTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fZW5zdXJlSW5zdGFuY2UgPSBmdW5jdGlvbiBfZW5zdXJlSW5zdGFuY2UoKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SW5zdGFuY2UgPSB0aGlzLmN1cnJlbnRJbnN0YW5jZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRJbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgY3VycmVudEluc3RhbmNlID0gdGhpcy5iZWdpbigpOwogICAgICAgICAgICAgICAgdGhpcy5fc2NoZWR1bGVBdXRvcnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRJbnN0YW5jZTsKICAgICAgICB9OwoKICAgICAgICBCYWNrYnVybmVyLnByb3RvdHlwZS5fc2NoZWR1bGVBdXRvcnVuID0gZnVuY3Rpb24gX3NjaGVkdWxlQXV0b3J1bigpIHsKICAgICAgICAgICAgYXV0b3J1bnNDcmVhdGVkQ291bnQrKzsKICAgICAgICAgICAgdmFyIG5leHQgPSB0aGlzLl9wbGF0Zm9ybS5uZXh0OwogICAgICAgICAgICB0aGlzLl9hdXRvcnVuID0gbmV4dCgpOwogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoQmFja2J1cm5lciwgW3sKICAgICAgICAgICAga2V5OiAnY291bnRlcnMnLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgYmVnaW46IGJlZ2luQ291bnQsCiAgICAgICAgICAgICAgICAgICAgZW5kOiBlbmRDb3VudCwKICAgICAgICAgICAgICAgICAgICBldmVudHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW46IGJlZ2luRXZlbnRDb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBlbmRFdmVudENvdW50CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBhdXRvcnVuczogewogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkOiBhdXRvcnVuc0NyZWF0ZWRDb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVkOiBhdXRvcnVuc0NvbXBsZXRlZENvdW50CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBydW46IHJ1bkNvdW50LAogICAgICAgICAgICAgICAgICAgIGpvaW46IGpvaW5Db3VudCwKICAgICAgICAgICAgICAgICAgICBkZWZlcjogZGVmZXJDb3VudCwKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZTogc2NoZWR1bGVDb3VudCwKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZUl0ZXJhYmxlOiBzY2hlZHVsZUl0ZXJhYmxlQ291bnQsCiAgICAgICAgICAgICAgICAgICAgZGVmZXJPbmNlOiBkZWZlck9uY2VDb3VudCwKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZU9uY2U6IHNjaGVkdWxlT25jZUNvdW50LAogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQ6IHNldFRpbWVvdXRDb3VudCwKICAgICAgICAgICAgICAgICAgICBsYXRlcjogbGF0ZXJDb3VudCwKICAgICAgICAgICAgICAgICAgICB0aHJvdHRsZTogdGhyb3R0bGVDb3VudCwKICAgICAgICAgICAgICAgICAgICBkZWJvdW5jZTogZGVib3VuY2VDb3VudCwKICAgICAgICAgICAgICAgICAgICBjYW5jZWxUaW1lcnM6IGNhbmNlbFRpbWVyc0NvdW50LAogICAgICAgICAgICAgICAgICAgIGNhbmNlbDogY2FuY2VsQ291bnQsCiAgICAgICAgICAgICAgICAgICAgbG9vcHM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWw6IGRlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZENvdW50LAogICAgICAgICAgICAgICAgICAgICAgICBuZXN0ZWQ6IG5lc3RlZERlZmVycmVkQWN0aW9uUXVldWVzQ3JlYXRlZAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogJ2RlZmF1bHRRdWV1ZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRRdWV1ZTsKICAgICAgICAgICAgfQogICAgICAgIH1dKTsKICAgICAgICByZXR1cm4gQmFja2J1cm5lcjsKICAgIH0oKTsKCiAgICBCYWNrYnVybmVyLlF1ZXVlID0gUXVldWU7CgogICAgZXhwb3J0cy5idWlsZFBsYXRmb3JtID0gYnVpbGRQbGF0Zm9ybTsKICAgIGV4cG9ydHMuZGVmYXVsdCA9IEJhY2tidXJuZXI7Cn0pOwplbmlmZWQoJ2NvbnRhaW5lcicsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdAZW1iZXIvZGVidWcnLCAnQGVtYmVyL3BvbHlmaWxscycsICdlbWJlci1vd25lcicsICdlbWJlci11dGlscycsICdAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcycsICdlbWJlci1lbnZpcm9ubWVudCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9kZWJ1ZywgX3BvbHlmaWxscywgX2VtYmVyT3duZXIsIF9lbWJlclV0aWxzLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfZW1iZXJFbnZpcm9ubWVudCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuRkFDVE9SWV9GT1IgPSBleHBvcnRzLkNvbnRhaW5lciA9IGV4cG9ydHMucHJpdmF0aXplID0gZXhwb3J0cy5SZWdpc3RyeSA9IHVuZGVmaW5lZDsKCgogICAgdmFyIGxlYWtUcmFja2luZyA9IHZvaWQgMDsKICAgIHZhciBjb250YWluZXJzID0gdm9pZCAwOwogICAgaWYgKHRydWUpIHsKICAgICAgICAvLyByZXF1aXJlcyB2OAogICAgICAgIC8vIGNocm9tZSAtLWpzLWZsYWdzPSItLWFsbG93LW5hdGl2ZXMtc3ludGF4IC0tZXhwb3NlLWdjIgogICAgICAgIC8vIG5vZGUgLS1hbGxvdy1uYXRpdmVzLXN5bnRheCAtLWV4cG9zZS1nYwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZ2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGxlYWtUcmFja2luZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBhdm9pZCBzeW50YXggZXJyb3JzIHdoZW4gLS1hbGxvdy1uYXRpdmVzLXN5bnRheCBub3QgcHJlc2VudAogICAgICAgICAgICAgICAgICAgIHZhciBHZXRXZWFrU2V0VmFsdWVzID0gbmV3IEZ1bmN0aW9uKCd3ZWFrU2V0JywgJ3JldHVybiAlR2V0V2Vha1NldFZhbHVlcyh3ZWFrU2V0LCAwKScpOwogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMgPSBuZXcgV2Vha1NldCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0NvbnRhaW5lcnM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdjKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gR2V0V2Vha1NldFZhbHVlcyhjb250YWluZXJzKS5sZW5ndGggPiAwOwogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICByZXNldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IEdldFdlYWtTZXRWYWx1ZXMoY29udGFpbmVycyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMuZGVsZXRlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBpZ25vcmUKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICBBIGNvbnRhaW5lciB1c2VkIHRvIGluc3RhbnRpYXRlIGFuZCBjYWNoZSBvYmplY3RzLgogICAgCiAgICAgRXZlcnkgYENvbnRhaW5lcmAgbXVzdCBiZSBhc3NvY2lhdGVkIHdpdGggYSBgUmVnaXN0cnlgLCB3aGljaCBpcyByZWZlcmVuY2VkCiAgICAgdG8gZGV0ZXJtaW5lIHRoZSBmYWN0b3J5IGFuZCBvcHRpb25zIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gaW5zdGFudGlhdGUKICAgICBvYmplY3RzLgogICAgCiAgICAgVGhlIHB1YmxpYyBBUEkgZm9yIGBDb250YWluZXJgIGlzIHN0aWxsIGluIGZsdXggYW5kIHNob3VsZCBub3QgYmUgY29uc2lkZXJlZAogICAgIHN0YWJsZS4KICAgIAogICAgIEBwcml2YXRlCiAgICAgQGNsYXNzIENvbnRhaW5lcgogICAgICovCgogICAgdmFyIENvbnRhaW5lciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDb250YWluZXIocmVnaXN0cnkpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbnRhaW5lcik7CgogICAgICAgICAgICB0aGlzLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CiAgICAgICAgICAgIHRoaXMub3duZXIgPSBvcHRpb25zLm93bmVyIHx8IG51bGw7CiAgICAgICAgICAgIHRoaXMuY2FjaGUgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkob3B0aW9ucy5jYWNoZSB8fCBudWxsKTsKICAgICAgICAgICAgdGhpcy5mYWN0b3J5TWFuYWdlckNhY2hlID0gKDAsIF9lbWJlclV0aWxzLmRpY3Rpb25hcnkpKG9wdGlvbnMuZmFjdG9yeU1hbmFnZXJDYWNoZSB8fCBudWxsKTsKICAgICAgICAgICAgdGhpcy5pc0Rlc3Ryb3llZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmlzRGVzdHJveWluZyA9IGZhbHNlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uQ2FjaGUgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkob3B0aW9ucy52YWxpZGF0aW9uQ2FjaGUgfHwgbnVsbCk7CiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVycy5hZGQodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLyoqCiAgICAgICAgIEBwcml2YXRlCiAgICAgICAgIEBwcm9wZXJ0eSByZWdpc3RyeQogICAgICAgICBAdHlwZSBSZWdpc3RyeQogICAgICAgICBAc2luY2UgMS4xMS4wCiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEBwcml2YXRlCiAgICAgICAgIEBwcm9wZXJ0eSBjYWNoZQogICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICBAcHJpdmF0ZQogICAgICAgICBAcHJvcGVydHkgdmFsaWRhdGlvbkNhY2hlCiAgICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEdpdmVuIGEgZnVsbE5hbWUgcmV0dXJuIGEgY29ycmVzcG9uZGluZyBpbnN0YW5jZS4KICAgICAgICAgIFRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIGZvciBsb29rdXAgdG8gcmV0dXJuIGEgc2luZ2xldG9uIGluc3RhbmNlLgogICAgICAgICBUaGUgc2luZ2xldG9uIGlzIHNjb3BlZCB0byB0aGUgY29udGFpbmVyLCBhbGxvd2luZyBtdWx0aXBsZSBjb250YWluZXJzCiAgICAgICAgIHRvIGFsbCBoYXZlIHRoZWlyIG93biBsb2NhbGx5IHNjb3BlZCBzaW5nbGV0b25zLgogICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICAgICAgbGV0IGNvbnRhaW5lciA9IHJlZ2lzdHJ5LmNvbnRhaW5lcigpOwogICAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2FwaTp0d2l0dGVyJywgVHdpdHRlcik7CiAgICAgICAgICBsZXQgdHdpdHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJyk7CiAgICAgICAgICB0d2l0dGVyIGluc3RhbmNlb2YgVHdpdHRlcjsgLy8gPT4gdHJ1ZQogICAgICAgICAgLy8gYnkgZGVmYXVsdCB0aGUgY29udGFpbmVyIHdpbGwgcmV0dXJuIHNpbmdsZXRvbnMKICAgICAgICAgbGV0IHR3aXR0ZXIyID0gY29udGFpbmVyLmxvb2t1cCgnYXBpOnR3aXR0ZXInKTsKICAgICAgICAgdHdpdHRlcjIgaW5zdGFuY2VvZiBUd2l0dGVyOyAvLyA9PiB0cnVlCiAgICAgICAgICB0d2l0dGVyID09PSB0d2l0dGVyMjsgLy89PiB0cnVlCiAgICAgICAgIGBgYAogICAgICAgICAgSWYgc2luZ2xldG9ucyBhcmUgbm90IHdhbnRlZCwgYW4gb3B0aW9uYWwgZmxhZyBjYW4gYmUgcHJvdmlkZWQgYXQgbG9va3VwLgogICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgICBsZXQgcmVnaXN0cnkgPSBuZXcgUmVnaXN0cnkoKTsKICAgICAgICAgbGV0IGNvbnRhaW5lciA9IHJlZ2lzdHJ5LmNvbnRhaW5lcigpOwogICAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2FwaTp0d2l0dGVyJywgVHdpdHRlcik7CiAgICAgICAgICBsZXQgdHdpdHRlciA9IGNvbnRhaW5lci5sb29rdXAoJ2FwaTp0d2l0dGVyJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgICAgICBsZXQgdHdpdHRlcjIgPSBjb250YWluZXIubG9va3VwKCdhcGk6dHdpdHRlcicsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgICAgICAgIHR3aXR0ZXIgPT09IHR3aXR0ZXIyOyAvLz0+IGZhbHNlCiAgICAgICAgIGBgYAogICAgICAgICAgQHByaXZhdGUKICAgICAgICAgQG1ldGhvZCBsb29rdXAKICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IGZ1bGxOYW1lCiAgICAgICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICAgICAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLnNvdXJjZV0gVGhlIGZ1bGxuYW1lIG9mIHRoZSByZXF1ZXN0IHNvdXJjZSAodXNlZCBmb3IgbG9jYWwgbG9va3VwKQogICAgICAgICBAcmV0dXJuIHthbnl9CiAgICAgICAgICovCgoKICAgICAgICBDb250YWluZXIucHJvdG90eXBlLmxvb2t1cCA9IGZ1bmN0aW9uIGxvb2t1cChmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzRGVzdHJveWVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2V4cGVjdGVkIGNvbnRhaW5lciBub3QgdG8gYmUgZGVzdHJveWVkJywgIXRoaXMuaXNEZXN0cm95ZWQpKTsKICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLnJlZ2lzdHJ5LmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLnJlZ2lzdHJ5LmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpKTsKCiAgICAgICAgICAgIHJldHVybiBfbG9va3VwKHRoaXMsIHRoaXMucmVnaXN0cnkubm9ybWFsaXplKGZ1bGxOYW1lKSwgb3B0aW9ucyk7CiAgICAgICAgfTsKCiAgICAgICAgQ29udGFpbmVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgZGVzdHJveURlc3Ryb3lhYmxlcyh0aGlzKTsKICAgICAgICAgICAgdGhpcy5pc0Rlc3Ryb3lpbmcgPSB0cnVlOwogICAgICAgIH07CgogICAgICAgIENvbnRhaW5lci5wcm90b3R5cGUuZmluYWxpemVEZXN0cm95ID0gZnVuY3Rpb24gZmluYWxpemVEZXN0cm95KCkgewogICAgICAgICAgICByZXNldENhY2hlKHRoaXMpOwogICAgICAgICAgICB0aGlzLmlzRGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICB9OwoKICAgICAgICBDb250YWluZXIucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoZnVsbE5hbWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHJldHVybjsKICAgICAgICAgICAgaWYgKGZ1bGxOYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3lEZXN0cm95YWJsZXModGhpcyk7CiAgICAgICAgICAgICAgICByZXNldENhY2hlKHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRNZW1iZXIodGhpcywgdGhpcy5yZWdpc3RyeS5ub3JtYWxpemUoZnVsbE5hbWUpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENvbnRhaW5lci5wcm90b3R5cGUub3duZXJJbmplY3Rpb24gPSBmdW5jdGlvbiBvd25lckluamVjdGlvbigpIHsKICAgICAgICAgICAgdmFyIF9yZWY7CgogICAgICAgICAgICByZXR1cm4gX3JlZiA9IHt9LCBfcmVmW19lbWJlck93bmVyLk9XTkVSXSA9IHRoaXMub3duZXIsIF9yZWY7CiAgICAgICAgfTsKCiAgICAgICAgQ29udGFpbmVyLnByb3RvdHlwZS5mYWN0b3J5Rm9yID0gZnVuY3Rpb24gZmFjdG9yeUZvcihmdWxsTmFtZSkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge307CiAgICAgICAgICAgICh0cnVlICYmICEoIXRoaXMuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZXhwZWN0ZWQgY29udGFpbmVyIG5vdCB0byBiZSBkZXN0cm95ZWQnLCAhdGhpcy5pc0Rlc3Ryb3llZCkpOwoKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gdGhpcy5yZWdpc3RyeS5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICAgICAgICAodHJ1ZSAmJiAhKHRoaXMucmVnaXN0cnkuaXNWYWxpZEZ1bGxOYW1lKG5vcm1hbGl6ZWROYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdmdWxsTmFtZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsIHRoaXMucmVnaXN0cnkuaXNWYWxpZEZ1bGxOYW1lKG5vcm1hbGl6ZWROYW1lKSkpOwogICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlIHx8ICFvcHRpb25zLm5hbWVzcGFjZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdFTUJFUl9NT0RVTEVfVU5JRklDQVRJT04gbXVzdCBiZSBlbmFibGVkIHRvIHBhc3MgYSBuYW1lc3BhY2Ugb3B0aW9uIHRvIGZhY3RvcnlGb3InLCBmYWxzZSB8fCAhb3B0aW9ucy5uYW1lc3BhY2UpKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLnNvdXJjZSB8fCBvcHRpb25zLm5hbWVzcGFjZSkgewogICAgICAgICAgICAgICAgbm9ybWFsaXplZE5hbWUgPSB0aGlzLnJlZ2lzdHJ5LmV4cGFuZExvY2FsTG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIGlmICghbm9ybWFsaXplZE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9mYWN0b3J5Rm9yKHRoaXMsIG5vcm1hbGl6ZWROYW1lLCBmdWxsTmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbnRhaW5lcjsKICAgIH0oKTsKCiAgICBpZiAodHJ1ZSkgewogICAgICAgIENvbnRhaW5lci5fbGVha1RyYWNraW5nID0gbGVha1RyYWNraW5nOwogICAgfQogICAgLyoKICAgICAqIFdyYXAgYSBmYWN0b3J5IG1hbmFnZXIgaW4gYSBwcm94eSB3aGljaCB3aWxsIG5vdCBwZXJtaXQgcHJvcGVydGllcyB0byBiZQogICAgICogc2V0IG9uIHRoZSBtYW5hZ2VyLgogICAgICovCiAgICBmdW5jdGlvbiB3cmFwTWFuYWdlckluRGVwcmVjYXRpb25Qcm94eShtYW5hZ2VyKSB7CiAgICAgICAgaWYgKF9lbWJlclV0aWxzLkhBU19OQVRJVkVfUFJPWFkpIHsKICAgICAgICAgICAgdmFyIHZhbGlkYXRvciA9IHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKF9vYmosIHByb3ApIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBhdHRlbXB0ZWQgdG8gc2V0ICInICsgcHJvcCArICciIG9uIGEgZmFjdG9yeSBtYW5hZ2VyIGNyZWF0ZWQgYnkgY29udGFpbmVyI2ZhY3RvcnlGb3IuIEEgZmFjdG9yeSBtYW5hZ2VyIGlzIGEgcmVhZC1vbmx5IGNvbnN0cnVjdC4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gTm90ZToKICAgICAgICAgICAgLy8gV2UgaGF2ZSB0byBwcm94eSBhY2Nlc3MgdG8gdGhlIG1hbmFnZXIgaGVyZSBzbyB0aGF0IHByaXZhdGUgcHJvcGVydHkKICAgICAgICAgICAgLy8gYWNjZXNzIGRvZXNuJ3QgY2F1c2UgdGhlIGFib3ZlIGVycm9ycyB0byBvY2N1ci4KICAgICAgICAgICAgdmFyIG0gPSBtYW5hZ2VyOwogICAgICAgICAgICB2YXIgcHJveGllZE1hbmFnZXIgPSB7CiAgICAgICAgICAgICAgICBjbGFzczogbS5jbGFzcywKICAgICAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gKHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG0uY3JlYXRlKHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHByb3h5ID0gbmV3IFByb3h5KHByb3hpZWRNYW5hZ2VyLCB2YWxpZGF0b3IpOwogICAgICAgICAgICBGQUNUT1JZX0ZPUi5zZXQocHJveHksIG1hbmFnZXIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFuYWdlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU2luZ2xldG9uKGNvbnRhaW5lciwgZnVsbE5hbWUpIHsKICAgICAgICByZXR1cm4gY29udGFpbmVyLnJlZ2lzdHJ5LmdldE9wdGlvbihmdWxsTmFtZSwgJ3NpbmdsZXRvbicpICE9PSBmYWxzZTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSkgewogICAgICAgIHJldHVybiBjb250YWluZXIucmVnaXN0cnkuZ2V0T3B0aW9uKGZ1bGxOYW1lLCAnaW5zdGFudGlhdGUnKSAhPT0gZmFsc2U7CiAgICB9CiAgICBmdW5jdGlvbiBfbG9va3VwKGNvbnRhaW5lciwgZnVsbE5hbWUpIHsKICAgICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDoge307CiAgICAgICAgKHRydWUgJiYgIShmYWxzZSB8fCAhb3B0aW9ucy5uYW1lc3BhY2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRU1CRVJfTU9EVUxFX1VOSUZJQ0FUSU9OIG11c3QgYmUgZW5hYmxlZCB0byBwYXNzIGEgbmFtZXNwYWNlIG9wdGlvbiB0byBsb29rdXAnLCBmYWxzZSB8fCAhb3B0aW9ucy5uYW1lc3BhY2UpKTsKCiAgICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gZnVsbE5hbWU7CiAgICAgICAgaWYgKG9wdGlvbnMuc291cmNlIHx8IG9wdGlvbnMubmFtZXNwYWNlKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZWROYW1lID0gY29udGFpbmVyLnJlZ2lzdHJ5LmV4cGFuZExvY2FsTG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKCFub3JtYWxpemVkTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLnNpbmdsZXRvbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgdmFyIGNhY2hlZCA9IGNvbnRhaW5lci5jYWNoZVtub3JtYWxpemVkTmFtZV07CiAgICAgICAgICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5zdGFudGlhdGVGYWN0b3J5KGNvbnRhaW5lciwgbm9ybWFsaXplZE5hbWUsIGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0KICAgIGZ1bmN0aW9uIF9mYWN0b3J5Rm9yKGNvbnRhaW5lciwgbm9ybWFsaXplZE5hbWUsIGZ1bGxOYW1lKSB7CiAgICAgICAgdmFyIGNhY2hlZCA9IGNvbnRhaW5lci5mYWN0b3J5TWFuYWdlckNhY2hlW25vcm1hbGl6ZWROYW1lXTsKICAgICAgICBpZiAoY2FjaGVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgICB9CiAgICAgICAgdmFyIGZhY3RvcnkgPSBjb250YWluZXIucmVnaXN0cnkucmVzb2x2ZShub3JtYWxpemVkTmFtZSk7CiAgICAgICAgaWYgKGZhY3RvcnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0cnVlICYmIGZhY3RvcnkgJiYgdHlwZW9mIGZhY3RvcnkuX29uTG9va3VwID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGZhY3RvcnkuX29uTG9va3VwKGZ1bGxOYW1lKTsKICAgICAgICB9CiAgICAgICAgdmFyIG1hbmFnZXIgPSBuZXcgRmFjdG9yeU1hbmFnZXIoY29udGFpbmVyLCBmYWN0b3J5LCBmdWxsTmFtZSwgbm9ybWFsaXplZE5hbWUpOwogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIG1hbmFnZXIgPSB3cmFwTWFuYWdlckluRGVwcmVjYXRpb25Qcm94eShtYW5hZ2VyKTsKICAgICAgICB9CiAgICAgICAgY29udGFpbmVyLmZhY3RvcnlNYW5hZ2VyQ2FjaGVbbm9ybWFsaXplZE5hbWVdID0gbWFuYWdlcjsKICAgICAgICByZXR1cm4gbWFuYWdlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU2luZ2xldG9uQ2xhc3MoY29udGFpbmVyLCBmdWxsTmFtZSwgX3JlZjIpIHsKICAgICAgICB2YXIgaW5zdGFudGlhdGUgPSBfcmVmMi5pbnN0YW50aWF0ZSwKICAgICAgICAgICAgc2luZ2xldG9uID0gX3JlZjIuc2luZ2xldG9uOwoKICAgICAgICByZXR1cm4gc2luZ2xldG9uICE9PSBmYWxzZSAmJiAhaW5zdGFudGlhdGUgJiYgaXNTaW5nbGV0b24oY29udGFpbmVyLCBmdWxsTmFtZSkgJiYgIWlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSk7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NpbmdsZXRvbkluc3RhbmNlKGNvbnRhaW5lciwgZnVsbE5hbWUsIF9yZWYzKSB7CiAgICAgICAgdmFyIGluc3RhbnRpYXRlID0gX3JlZjMuaW5zdGFudGlhdGUsCiAgICAgICAgICAgIHNpbmdsZXRvbiA9IF9yZWYzLnNpbmdsZXRvbjsKCiAgICAgICAgcmV0dXJuIHNpbmdsZXRvbiAhPT0gZmFsc2UgJiYgaW5zdGFudGlhdGUgIT09IGZhbHNlICYmIGlzU2luZ2xldG9uKGNvbnRhaW5lciwgZnVsbE5hbWUpICYmIGlzSW5zdGFudGlhdGFibGUoY29udGFpbmVyLCBmdWxsTmFtZSk7CiAgICB9CiAgICBmdW5jdGlvbiBpc0ZhY3RvcnlDbGFzcyhjb250YWluZXIsIGZ1bGxuYW1lLCBfcmVmNCkgewogICAgICAgIHZhciBpbnN0YW50aWF0ZSA9IF9yZWY0Lmluc3RhbnRpYXRlLAogICAgICAgICAgICBzaW5nbGV0b24gPSBfcmVmNC5zaW5nbGV0b247CgogICAgICAgIHJldHVybiBpbnN0YW50aWF0ZSA9PT0gZmFsc2UgJiYgKHNpbmdsZXRvbiA9PT0gZmFsc2UgfHwgIWlzU2luZ2xldG9uKGNvbnRhaW5lciwgZnVsbG5hbWUpKSAmJiAhaXNJbnN0YW50aWF0YWJsZShjb250YWluZXIsIGZ1bGxuYW1lKTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzRmFjdG9yeUluc3RhbmNlKGNvbnRhaW5lciwgZnVsbE5hbWUsIF9yZWY1KSB7CiAgICAgICAgdmFyIGluc3RhbnRpYXRlID0gX3JlZjUuaW5zdGFudGlhdGUsCiAgICAgICAgICAgIHNpbmdsZXRvbiA9IF9yZWY1LnNpbmdsZXRvbjsKCiAgICAgICAgcmV0dXJuIGluc3RhbnRpYXRlICE9PSBmYWxzZSAmJiAoc2luZ2xldG9uICE9PSBmYWxzZSB8fCBpc1NpbmdsZXRvbihjb250YWluZXIsIGZ1bGxOYW1lKSkgJiYgaXNJbnN0YW50aWF0YWJsZShjb250YWluZXIsIGZ1bGxOYW1lKTsKICAgIH0KICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlRmFjdG9yeShjb250YWluZXIsIG5vcm1hbGl6ZWROYW1lLCBmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICAgIHZhciBmYWN0b3J5TWFuYWdlciA9IF9mYWN0b3J5Rm9yKGNvbnRhaW5lciwgbm9ybWFsaXplZE5hbWUsIGZ1bGxOYW1lKTsKICAgICAgICBpZiAoZmFjdG9yeU1hbmFnZXIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIFNvbWVDbGFzcyB7IHNpbmdsZXRvbjogdHJ1ZSwgaW5zdGFudGlhdGU6IHRydWUgfSB8IHsgc2luZ2xldG9uOiB0cnVlIH0gfCB7IGluc3RhbnRpYXRlOiB0cnVlIH0gfCB7fQogICAgICAgIC8vIEJ5IGRlZmF1bHQgbWFqb3JpdHkgb2Ygb2JqZWN0cyBmYWxsIGludG8gdGhpcyBjYXNlCiAgICAgICAgaWYgKGlzU2luZ2xldG9uSW5zdGFuY2UoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lci5jYWNoZVtub3JtYWxpemVkTmFtZV0gPSBmYWN0b3J5TWFuYWdlci5jcmVhdGUoKTsKICAgICAgICB9CiAgICAgICAgLy8gU29tZUNsYXNzIHsgc2luZ2xldG9uOiBmYWxzZSwgaW5zdGFudGlhdGU6IHRydWUgfQogICAgICAgIGlmIChpc0ZhY3RvcnlJbnN0YW5jZShjb250YWluZXIsIGZ1bGxOYW1lLCBvcHRpb25zKSkgewogICAgICAgICAgICByZXR1cm4gZmFjdG9yeU1hbmFnZXIuY3JlYXRlKCk7CiAgICAgICAgfQogICAgICAgIC8vIFNvbWVDbGFzcyB7IHNpbmdsZXRvbjogdHJ1ZSwgaW5zdGFudGlhdGU6IGZhbHNlIH0gfCB7IGluc3RhbnRpYXRlOiBmYWxzZSB9IHwgeyBzaW5nbGV0b246IGZhbHNlLCBpbnN0YW50aWF0aW9uOiBmYWxzZSB9CiAgICAgICAgaWYgKGlzU2luZ2xldG9uQ2xhc3MoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykgfHwgaXNGYWN0b3J5Q2xhc3MoY29udGFpbmVyLCBmdWxsTmFtZSwgb3B0aW9ucykpIHsKICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnlNYW5hZ2VyLmNsYXNzOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBjcmVhdGUgZmFjdG9yeScpOwogICAgfQogICAgZnVuY3Rpb24gcHJvY2Vzc0luamVjdGlvbnMoY29udGFpbmVyLCBpbmplY3Rpb25zLCByZXN1bHQpIHsKICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICBjb250YWluZXIucmVnaXN0cnkudmFsaWRhdGVJbmplY3Rpb25zKGluamVjdGlvbnMpOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzaCA9IHJlc3VsdC5pbmplY3Rpb25zOwogICAgICAgIGlmIChoYXNoID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaGFzaCA9IHJlc3VsdC5pbmplY3Rpb25zID0ge307CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5qZWN0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX2luamVjdGlvbnMkaSA9IGluamVjdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwcm9wZXJ0eSA9IF9pbmplY3Rpb25zJGkucHJvcGVydHksCiAgICAgICAgICAgICAgICBzcGVjaWZpZXIgPSBfaW5qZWN0aW9ucyRpLnNwZWNpZmllciwKICAgICAgICAgICAgICAgIHNvdXJjZSA9IF9pbmplY3Rpb25zJGkuc291cmNlOwoKICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgICAgaGFzaFtwcm9wZXJ0eV0gPSBfbG9va3VwKGNvbnRhaW5lciwgc3BlY2lmaWVyLCB7IHNvdXJjZTogc291cmNlIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGFzaFtwcm9wZXJ0eV0gPSBfbG9va3VwKGNvbnRhaW5lciwgc3BlY2lmaWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXJlc3VsdC5pc0R5bmFtaWMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5pc0R5bmFtaWMgPSAhaXNTaW5nbGV0b24oY29udGFpbmVyLCBzcGVjaWZpZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGRJbmplY3Rpb25zKGNvbnRhaW5lciwgdHlwZUluamVjdGlvbnMsIGluamVjdGlvbnMpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICBpbmplY3Rpb25zOiB1bmRlZmluZWQsCiAgICAgICAgICAgIGlzRHluYW1pYzogZmFsc2UKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlSW5qZWN0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHByb2Nlc3NJbmplY3Rpb25zKGNvbnRhaW5lciwgdHlwZUluamVjdGlvbnMsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGlmIChpbmplY3Rpb25zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcHJvY2Vzc0luamVjdGlvbnMoY29udGFpbmVyLCBpbmplY3Rpb25zLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gaW5qZWN0aW9uc0Zvcihjb250YWluZXIsIGZ1bGxOYW1lKSB7CiAgICAgICAgdmFyIHJlZ2lzdHJ5ID0gY29udGFpbmVyLnJlZ2lzdHJ5OwoKICAgICAgICB2YXIgX2Z1bGxOYW1lJHNwbGl0ID0gZnVsbE5hbWUuc3BsaXQoJzonKSwKICAgICAgICAgICAgdHlwZSA9IF9mdWxsTmFtZSRzcGxpdFswXTsKCiAgICAgICAgdmFyIHR5cGVJbmplY3Rpb25zID0gcmVnaXN0cnkuZ2V0VHlwZUluamVjdGlvbnModHlwZSk7CiAgICAgICAgdmFyIGluamVjdGlvbnMgPSByZWdpc3RyeS5nZXRJbmplY3Rpb25zKGZ1bGxOYW1lKTsKICAgICAgICByZXR1cm4gYnVpbGRJbmplY3Rpb25zKGNvbnRhaW5lciwgdHlwZUluamVjdGlvbnMsIGluamVjdGlvbnMpOwogICAgfQogICAgZnVuY3Rpb24gZGVzdHJveURlc3Ryb3lhYmxlcyhjb250YWluZXIpIHsKICAgICAgICB2YXIgY2FjaGUgPSBjb250YWluZXIuY2FjaGU7CiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjYWNoZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBjYWNoZVtrZXldOwogICAgICAgICAgICBpZiAodmFsdWUuZGVzdHJveSkgewogICAgICAgICAgICAgICAgdmFsdWUuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcmVzZXRDYWNoZShjb250YWluZXIpIHsKICAgICAgICBjb250YWluZXIuY2FjaGUgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgICAgY29udGFpbmVyLmZhY3RvcnlNYW5hZ2VyQ2FjaGUgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICB9CiAgICBmdW5jdGlvbiByZXNldE1lbWJlcihjb250YWluZXIsIGZ1bGxOYW1lKSB7CiAgICAgICAgdmFyIG1lbWJlciA9IGNvbnRhaW5lci5jYWNoZVtmdWxsTmFtZV07CiAgICAgICAgZGVsZXRlIGNvbnRhaW5lci5mYWN0b3J5TWFuYWdlckNhY2hlW2Z1bGxOYW1lXTsKICAgICAgICBpZiAobWVtYmVyKSB7CiAgICAgICAgICAgIGRlbGV0ZSBjb250YWluZXIuY2FjaGVbZnVsbE5hbWVdOwogICAgICAgICAgICBpZiAobWVtYmVyLmRlc3Ryb3kpIHsKICAgICAgICAgICAgICAgIG1lbWJlci5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICB2YXIgRkFDVE9SWV9GT1IgPSBuZXcgV2Vha01hcCgpOwoKICAgIHZhciBGYWN0b3J5TWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBGYWN0b3J5TWFuYWdlcihjb250YWluZXIsIGZhY3RvcnksIGZ1bGxOYW1lLCBub3JtYWxpemVkTmFtZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEZhY3RvcnlNYW5hZ2VyKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwogICAgICAgICAgICB0aGlzLm93bmVyID0gY29udGFpbmVyLm93bmVyOwogICAgICAgICAgICB0aGlzLmNsYXNzID0gZmFjdG9yeTsKICAgICAgICAgICAgdGhpcy5mdWxsTmFtZSA9IGZ1bGxOYW1lOwogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZWROYW1lID0gbm9ybWFsaXplZE5hbWU7CiAgICAgICAgICAgIHRoaXMubWFkZVRvU3RyaW5nID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLmluamVjdGlvbnMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIEZBQ1RPUllfRk9SLnNldCh0aGlzLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIEZhY3RvcnlNYW5hZ2VyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICAgICAgICBpZiAodGhpcy5tYWRlVG9TdHJpbmcgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5tYWRlVG9TdHJpbmcgPSB0aGlzLmNvbnRhaW5lci5yZWdpc3RyeS5tYWtlVG9TdHJpbmcodGhpcy5jbGFzcywgdGhpcy5mdWxsTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFkZVRvU3RyaW5nOwogICAgICAgIH07CgogICAgICAgIEZhY3RvcnlNYW5hZ2VyLnByb3RvdHlwZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUob3B0aW9ucykgewogICAgICAgICAgICB2YXIgaW5qZWN0aW9uc0NhY2hlID0gdGhpcy5pbmplY3Rpb25zOwogICAgICAgICAgICBpZiAoaW5qZWN0aW9uc0NhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZhciBfaW5qZWN0aW9uc0ZvciA9IGluamVjdGlvbnNGb3IodGhpcy5jb250YWluZXIsIHRoaXMubm9ybWFsaXplZE5hbWUpLAogICAgICAgICAgICAgICAgICAgIGluamVjdGlvbnMgPSBfaW5qZWN0aW9uc0Zvci5pbmplY3Rpb25zLAogICAgICAgICAgICAgICAgICAgIGlzRHluYW1pYyA9IF9pbmplY3Rpb25zRm9yLmlzRHluYW1pYzsKCiAgICAgICAgICAgICAgICBpbmplY3Rpb25zQ2FjaGUgPSBpbmplY3Rpb25zOwogICAgICAgICAgICAgICAgaWYgKCFpc0R5bmFtaWMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluamVjdGlvbnMgPSBpbmplY3Rpb25zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGluamVjdGlvbnNDYWNoZTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcHJvcHMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBpbmplY3Rpb25zQ2FjaGUsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUluamVjdGlvbnMgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkNhY2hlID0gdGhpcy5jb250YWluZXIudmFsaWRhdGlvbkNhY2hlOwogICAgICAgICAgICAgICAgLy8gRW5zdXJlIHRoYXQgYWxsIGxhenkgaW5qZWN0aW9ucyBhcmUgdmFsaWQgYXQgaW5zdGFudGlhdGlvbiB0aW1lCiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRpb25DYWNoZVt0aGlzLmZ1bGxOYW1lXSAmJiB0aGlzLmNsYXNzICYmIHR5cGVvZiB0aGlzLmNsYXNzLl9sYXp5SW5qZWN0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIGxhenlJbmplY3Rpb25zID0gdGhpcy5jbGFzcy5fbGF6eUluamVjdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICBsYXp5SW5qZWN0aW9ucyA9IHRoaXMuY29udGFpbmVyLnJlZ2lzdHJ5Lm5vcm1hbGl6ZUluamVjdGlvbnNIYXNoKGxhenlJbmplY3Rpb25zKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZWdpc3RyeS52YWxpZGF0ZUluamVjdGlvbnMobGF6eUluamVjdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsaWRhdGlvbkNhY2hlW3RoaXMuZnVsbE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuY2xhc3MuY3JlYXRlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYW4gaW5zdGFuY2Ugb2YgXCcnICsgdGhpcy5ub3JtYWxpemVkTmFtZSArICdcJy4gTW9zdCBsaWtlbHkgYW4gaW1wcm9wZXJseSBkZWZpbmVkIGNsYXNzIG9yJyArICcgYW4gaW52YWxpZCBtb2R1bGUgZXhwb3J0LicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJlcXVpcmVkIHRvIGFsbG93IGFjY2VzcyB0byB0aGluZ3MgbGlrZQogICAgICAgICAgICAvLyB0aGUgY3VzdG9taXplZCB0b1N0cmluZywgX2RlYnVnQ29udGFpbmVyS2V5LAogICAgICAgICAgICAvLyBvd25lciwgZXRjLiB3aXRob3V0IGEgZG91YmxlIGV4dGVuZCBhbmQgd2l0aG91dAogICAgICAgICAgICAvLyBtb2RpZnlpbmcgdGhlIG9iamVjdHMgcHJvcGVydGllcwogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuY2xhc3MuX2luaXRGYWN0b3J5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsYXNzLl9pbml0RmFjdG9yeSh0aGlzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGluIHRoZSBub24tRW1iZXJPYmplY3QgY2FzZSB3ZSBuZWVkIHRvIHN0aWxsIHNldE93bmVyCiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHJlcXVpcmVkIGZvciBzdXBwb3J0aW5nIGdsaW1tZXIgZW52aXJvbm1lbnQgYW5kCiAgICAgICAgICAgICAgICAvLyB0ZW1wbGF0ZSBpbnN0YW50aWF0aW9uIHdoaWNoIHJlbHkgaGVhdmlseSBvbgogICAgICAgICAgICAgICAgLy8gYG9wdGlvbnNbT1dORVJdYCBiZWluZyBwYXNzZWQgaW50byBgY3JlYXRlYAogICAgICAgICAgICAgICAgLy8gVE9ETzogY2xlYW4gdGhpcyB1cCwgYW5kIHJlbW92ZSBpbiBmdXR1cmUgdmVyc2lvbnMKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQgfHwgcHJvcHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIC8vIGF2b2lkIG11dGF0aW5nIGBwcm9wc2AgaGVyZSBzaW5jZSB0aGV5IGFyZSB0aGUgY2FjaGVkIGluamVjdGlvbnMKICAgICAgICAgICAgICAgICAgICBwcm9wcyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICgwLCBfZW1iZXJPd25lci5zZXRPd25lcikocHJvcHMsIHRoaXMub3duZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuY2xhc3MuY3JlYXRlKHByb3BzKTsKICAgICAgICAgICAgRkFDVE9SWV9GT1Iuc2V0KGluc3RhbmNlLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBGYWN0b3J5TWFuYWdlcjsKICAgIH0oKTsKCiAgICB2YXIgVkFMSURfRlVMTF9OQU1FX1JFR0VYUCA9IC9eW146XSs6W146XSskLzsKICAgIHZhciBtaXNzaW5nUmVzb2x2ZXJGdW5jdGlvbnNEZXByZWNhdGlvbiA9ICdQYXNzaW5nIGEgYHJlc29sdmVyYCBmdW5jdGlvbiBpbnRvIGEgUmVnaXN0cnkgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHBhc3MgaW4gYSBSZXNvbHZlciBvYmplY3Qgd2l0aCBhIGByZXNvbHZlYCBtZXRob2QuJzsKICAgIC8qKgogICAgIEEgcmVnaXN0cnkgdXNlZCB0byBzdG9yZSBmYWN0b3J5IGFuZCBvcHRpb24gaW5mb3JtYXRpb24ga2V5ZWQKICAgICBieSB0eXBlLgogICAgCiAgICAgQSBgUmVnaXN0cnlgIHN0b3JlcyB0aGUgZmFjdG9yeSBhbmQgb3B0aW9uIGluZm9ybWF0aW9uIG5lZWRlZCBieSBhCiAgICAgYENvbnRhaW5lcmAgdG8gaW5zdGFudGlhdGUgYW5kIGNhY2hlIG9iamVjdHMuCiAgICAKICAgICBUaGUgQVBJIGZvciBgUmVnaXN0cnlgIGlzIHN0aWxsIGluIGZsdXggYW5kIHNob3VsZCBub3QgYmUgY29uc2lkZXJlZCBzdGFibGUuCiAgICAKICAgICBAcHJpdmF0ZQogICAgIEBjbGFzcyBSZWdpc3RyeQogICAgIEBzaW5jZSAxLjExLjAKICAgICovCgogICAgdmFyIFJlZ2lzdHJ5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJlZ2lzdHJ5KCkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDoge307CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVnaXN0cnkpOwoKICAgICAgICAgICAgdGhpcy5mYWxsYmFjayA9IG9wdGlvbnMuZmFsbGJhY2sgfHwgbnVsbDsKICAgICAgICAgICAgdGhpcy5yZXNvbHZlciA9IG9wdGlvbnMucmVzb2x2ZXIgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5fRU5BQkxFX1JFU09MVkVSX0ZVTkNUSU9OX1NVUFBPUlQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICEodHlwZW9mIHRoaXMucmVzb2x2ZXIgIT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KShtaXNzaW5nUmVzb2x2ZXJGdW5jdGlvbnNEZXByZWNhdGlvbiwgdHlwZW9mIHRoaXMucmVzb2x2ZXIgIT09ICdmdW5jdGlvbicpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5SRUdJU1RSWV9SRVNPTFZFUl9BU19GVU5DVElPTiAmJiB0eXBlb2YgdGhpcy5yZXNvbHZlciA9PT0gJ2Z1bmN0aW9uJyAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9SRVNPTFZFUl9GVU5DVElPTl9TVVBQT1JUID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkobWlzc2luZ1Jlc29sdmVyRnVuY3Rpb25zRGVwcmVjYXRpb24sIGZhbHNlLCB7CiAgICAgICAgICAgICAgICAgICAgaWQ6ICdlbWJlci1hcHBsaWNhdGlvbi5yZWdpc3RyeS1yZXNvbHZlci1hcy1mdW5jdGlvbicsCiAgICAgICAgICAgICAgICAgICAgdW50aWw6ICczLjAuMCcsCiAgICAgICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjIueCN0b2NfcmVnaXN0cnktcmVzb2x2ZXItYXMtZnVuY3Rpb24nCiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlciA9IHsgcmVzb2x2ZTogdGhpcy5yZXNvbHZlciB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVnaXN0cmF0aW9ucyA9ICgwLCBfZW1iZXJVdGlscy5kaWN0aW9uYXJ5KShvcHRpb25zLnJlZ2lzdHJhdGlvbnMgfHwgbnVsbCk7CiAgICAgICAgICAgIHRoaXMuX3R5cGVJbmplY3Rpb25zID0gKDAsIF9lbWJlclV0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgICAgICAgICB0aGlzLl9pbmplY3Rpb25zID0gKDAsIF9lbWJlclV0aWxzLmRpY3Rpb25hcnkpKG51bGwpOwogICAgICAgICAgICB0aGlzLl9sb2NhbExvb2t1cENhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgdGhpcy5fbm9ybWFsaXplQ2FjaGUgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVDYWNoZSA9ICgwLCBfZW1iZXJVdGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgICAgICAgICAgdGhpcy5fZmFpbFNldCA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgdGhpcy5fb3B0aW9ucyA9ICgwLCBfZW1iZXJVdGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgICAgICAgICAgdGhpcy5fdHlwZU9wdGlvbnMgPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgICAgfQogICAgICAgIC8qKgogICAgICAgICBBIGJhY2t1cCByZWdpc3RyeSBmb3IgcmVzb2x2aW5nIHJlZ2lzdHJhdGlvbnMgd2hlbiBubyBtYXRjaGVzIGNhbiBiZSBmb3VuZC4KICAgICAgICAgICAgQHByaXZhdGUKICAgICAgICAgQHByb3BlcnR5IGZhbGxiYWNrCiAgICAgICAgIEB0eXBlIFJlZ2lzdHJ5CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEFuIG9iamVjdCB0aGF0IGhhcyBhIGByZXNvbHZlYCBtZXRob2QgdGhhdCByZXNvbHZlcyBhIG5hbWUuCiAgICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgIEBwcm9wZXJ0eSByZXNvbHZlcgogICAgICAgICBAdHlwZSBSZXNvbHZlcgogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICBAcHJpdmF0ZQogICAgICAgICBAcHJvcGVydHkgcmVnaXN0cmF0aW9ucwogICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICBAcHJvcGVydHkgX3R5cGVJbmplY3Rpb25zCiAgICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEBwcml2YXRlCiAgICAgICAgICAgIEBwcm9wZXJ0eSBfaW5qZWN0aW9ucwogICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICBAcHJvcGVydHkgX25vcm1hbGl6ZUNhY2hlCiAgICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEBwcml2YXRlCiAgICAgICAgICAgIEBwcm9wZXJ0eSBfcmVzb2x2ZUNhY2hlCiAgICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIEBwcml2YXRlCiAgICAgICAgICAgIEBwcm9wZXJ0eSBfb3B0aW9ucwogICAgICAgICBAdHlwZSBJbmhlcml0aW5nRGljdAogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICBAcHJpdmF0ZQogICAgICAgICAgICBAcHJvcGVydHkgX3R5cGVPcHRpb25zCiAgICAgICAgIEB0eXBlIEluaGVyaXRpbmdEaWN0CiAgICAgICAgICovCiAgICAgICAgLyoqCiAgICAgICAgIENyZWF0ZXMgYSBjb250YWluZXIgYmFzZWQgb24gdGhpcyByZWdpc3RyeS4KICAgICAgICAgICAgQHByaXZhdGUKICAgICAgICAgQG1ldGhvZCBjb250YWluZXIKICAgICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgICAgQHJldHVybiB7Q29udGFpbmVyfSBjcmVhdGVkIGNvbnRhaW5lcgogICAgICAgICAqLwoKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLmNvbnRhaW5lciA9IGZ1bmN0aW9uIGNvbnRhaW5lcihvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udGFpbmVyKHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIHJlZ2lzdGVyKGZ1bGxOYW1lLCBmYWN0b3J5KSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiB7fTsKICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpKTsKICAgICAgICAgICAgKHRydWUgJiYgIShmYWN0b3J5ICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQXR0ZW1wdGluZyB0byByZWdpc3RlciBhbiB1bmtub3duIGZhY3Rvcnk6IFwnJyArIGZ1bGxOYW1lICsgJ1wnJywgZmFjdG9yeSAhPT0gdW5kZWZpbmVkKSk7CgogICAgICAgICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSk7CiAgICAgICAgICAgICh0cnVlICYmICEoIXRoaXMuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV0pICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IHJlLXJlZ2lzdGVyOiBcJycgKyBmdWxsTmFtZSArICdcJywgYXMgaXQgaGFzIGFscmVhZHkgYmVlbiByZXNvbHZlZC4nLCAhdGhpcy5fcmVzb2x2ZUNhY2hlW25vcm1hbGl6ZWROYW1lXSkpOwoKICAgICAgICAgICAgdGhpcy5fZmFpbFNldC5kZWxldGUobm9ybWFsaXplZE5hbWUpOwogICAgICAgICAgICB0aGlzLnJlZ2lzdHJhdGlvbnNbbm9ybWFsaXplZE5hbWVdID0gZmFjdG9yeTsKICAgICAgICAgICAgdGhpcy5fb3B0aW9uc1tub3JtYWxpemVkTmFtZV0gPSBvcHRpb25zOwogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS51bnJlZ2lzdGVyID0gZnVuY3Rpb24gdW5yZWdpc3RlcihmdWxsTmFtZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdmdWxsTmFtZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGZ1bGxOYW1lKSkpOwoKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICAgICAgICB0aGlzLl9sb2NhbExvb2t1cENhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVnaXN0cmF0aW9uc1tub3JtYWxpemVkTmFtZV07CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXNvbHZlQ2FjaGVbbm9ybWFsaXplZE5hbWVdOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fb3B0aW9uc1tub3JtYWxpemVkTmFtZV07CiAgICAgICAgICAgIHRoaXMuX2ZhaWxTZXQuZGVsZXRlKG5vcm1hbGl6ZWROYW1lKTsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGZhY3RvcnkgPSBfcmVzb2x2ZSh0aGlzLCB0aGlzLm5vcm1hbGl6ZShmdWxsTmFtZSksIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoZmFjdG9yeSA9PT0gdW5kZWZpbmVkICYmIHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfZmFsbGJhY2s7CgogICAgICAgICAgICAgICAgZmFjdG9yeSA9IChfZmFsbGJhY2sgPSB0aGlzLmZhbGxiYWNrKS5yZXNvbHZlLmFwcGx5KF9mYWxsYmFjaywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFjdG9yeTsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUuZGVzY3JpYmUgPSBmdW5jdGlvbiBkZXNjcmliZShmdWxsTmFtZSkgewogICAgICAgICAgICBpZiAodGhpcy5yZXNvbHZlciAhPT0gbnVsbCAmJiB0aGlzLnJlc29sdmVyLmxvb2t1cERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBEZXNjcmlwdGlvbihmdWxsTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2suZGVzY3JpYmUoZnVsbE5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLm5vcm1hbGl6ZUZ1bGxOYW1lID0gZnVuY3Rpb24gbm9ybWFsaXplRnVsbE5hbWUoZnVsbE5hbWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMucmVzb2x2ZXIgIT09IG51bGwgJiYgdGhpcy5yZXNvbHZlci5ub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc29sdmVyLm5vcm1hbGl6ZShmdWxsTmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2subm9ybWFsaXplRnVsbE5hbWUoZnVsbE5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bGxOYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uIG5vcm1hbGl6ZShmdWxsTmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbm9ybWFsaXplQ2FjaGVbZnVsbE5hbWVdIHx8ICh0aGlzLl9ub3JtYWxpemVDYWNoZVtmdWxsTmFtZV0gPSB0aGlzLm5vcm1hbGl6ZUZ1bGxOYW1lKGZ1bGxOYW1lKSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLm1ha2VUb1N0cmluZyA9IGZ1bmN0aW9uIG1ha2VUb1N0cmluZyhmYWN0b3J5LCBmdWxsTmFtZSkgewogICAgICAgICAgICBpZiAodGhpcy5yZXNvbHZlciAhPT0gbnVsbCAmJiB0aGlzLnJlc29sdmVyLm1ha2VUb1N0cmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubWFrZVRvU3RyaW5nKGZhY3RvcnksIGZ1bGxOYW1lKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mYWxsYmFjay5tYWtlVG9TdHJpbmcoZmFjdG9yeSwgZnVsbE5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhY3RvcnkudG9TdHJpbmcoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMoZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlID0gb3B0aW9ucyAmJiBvcHRpb25zLnNvdXJjZSAmJiB0aGlzLm5vcm1hbGl6ZShvcHRpb25zLnNvdXJjZSk7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZXNwYWNlIHx8IHVuZGVmaW5lZDsKICAgICAgICAgICAgcmV0dXJuIF9oYXModGhpcywgdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpLCBzb3VyY2UsIG5hbWVzcGFjZSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLm9wdGlvbnNGb3JUeXBlID0gZnVuY3Rpb24gb3B0aW9uc0ZvclR5cGUodHlwZSwgb3B0aW9ucykgewogICAgICAgICAgICB0aGlzLl90eXBlT3B0aW9uc1t0eXBlXSA9IG9wdGlvbnM7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLmdldE9wdGlvbnNGb3JUeXBlID0gZnVuY3Rpb24gZ2V0T3B0aW9uc0ZvclR5cGUodHlwZSkgewogICAgICAgICAgICB2YXIgb3B0aW9uc0ZvclR5cGUgPSB0aGlzLl90eXBlT3B0aW9uc1t0eXBlXTsKICAgICAgICAgICAgaWYgKG9wdGlvbnNGb3JUeXBlID09PSB1bmRlZmluZWQgJiYgdGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgb3B0aW9uc0ZvclR5cGUgPSB0aGlzLmZhbGxiYWNrLmdldE9wdGlvbnNGb3JUeXBlKHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zRm9yVHlwZTsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUub3B0aW9ucyA9IGZ1bmN0aW9uIG9wdGlvbnMoZnVsbE5hbWUsIF9vcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IHRoaXMubm9ybWFsaXplKGZ1bGxOYW1lKTsKICAgICAgICAgICAgdGhpcy5fb3B0aW9uc1tub3JtYWxpemVkTmFtZV0gPSBfb3B0aW9uczsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUuZ2V0T3B0aW9ucyA9IGZ1bmN0aW9uIGdldE9wdGlvbnMoZnVsbE5hbWUpIHsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHRoaXMuX29wdGlvbnNbbm9ybWFsaXplZE5hbWVdOwogICAgICAgICAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkICYmIHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLmZhbGxiYWNrLmdldE9wdGlvbnMoZnVsbE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvcHRpb25zOwogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS5nZXRPcHRpb24gPSBmdW5jdGlvbiBnZXRPcHRpb24oZnVsbE5hbWUsIG9wdGlvbk5hbWUpIHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLl9vcHRpb25zW2Z1bGxOYW1lXTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zW29wdGlvbk5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zW29wdGlvbk5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlID0gZnVsbE5hbWUuc3BsaXQoJzonKVswXTsKICAgICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3R5cGVPcHRpb25zW3R5cGVdOwogICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zW29wdGlvbk5hbWVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zW29wdGlvbk5hbWVdOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLmdldE9wdGlvbihmdWxsTmFtZSwgb3B0aW9uTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUudHlwZUluamVjdGlvbiA9IGZ1bmN0aW9uIHR5cGVJbmplY3Rpb24odHlwZSwgcHJvcGVydHksIGZ1bGxOYW1lKSB7CiAgICAgICAgICAgICh0cnVlICYmICEodGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2Z1bGxOYW1lIG11c3QgYmUgYSBwcm9wZXIgZnVsbCBuYW1lJywgdGhpcy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSk7CgogICAgICAgICAgICB2YXIgZnVsbE5hbWVUeXBlID0gZnVsbE5hbWUuc3BsaXQoJzonKVswXTsKICAgICAgICAgICAgKHRydWUgJiYgIShmdWxsTmFtZVR5cGUgIT09IHR5cGUpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGluamVjdCBhIFwnJyArIGZ1bGxOYW1lICsgJ1wnIG9uIG90aGVyICcgKyB0eXBlICsgJyhzKS4nLCBmdWxsTmFtZVR5cGUgIT09IHR5cGUpKTsKCiAgICAgICAgICAgIHZhciBpbmplY3Rpb25zID0gdGhpcy5fdHlwZUluamVjdGlvbnNbdHlwZV0gfHwgKHRoaXMuX3R5cGVJbmplY3Rpb25zW3R5cGVdID0gW10pOwogICAgICAgICAgICBpbmplY3Rpb25zLnB1c2goeyBwcm9wZXJ0eTogcHJvcGVydHksIHNwZWNpZmllcjogZnVsbE5hbWUgfSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLmluamVjdGlvbiA9IGZ1bmN0aW9uIGluamVjdGlvbihmdWxsTmFtZSwgcHJvcGVydHksIGluamVjdGlvbk5hbWUpIHsKICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmlzVmFsaWRGdWxsTmFtZShpbmplY3Rpb25OYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdJbnZhbGlkIGluamVjdGlvbk5hbWUsIGV4cGVjdGVkOiBcJ3R5cGU6bmFtZVwnIGdvdDogJyArIGluamVjdGlvbk5hbWUsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKGluamVjdGlvbk5hbWUpKSk7CgogICAgICAgICAgICB2YXIgbm9ybWFsaXplZEluamVjdGlvbk5hbWUgPSB0aGlzLm5vcm1hbGl6ZShpbmplY3Rpb25OYW1lKTsKICAgICAgICAgICAgaWYgKGZ1bGxOYW1lLmluZGV4T2YoJzonKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnR5cGVJbmplY3Rpb24oZnVsbE5hbWUsIHByb3BlcnR5LCBub3JtYWxpemVkSW5qZWN0aW9uTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpKTsKCiAgICAgICAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IHRoaXMubm9ybWFsaXplKGZ1bGxOYW1lKTsKICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSB0aGlzLl9pbmplY3Rpb25zW25vcm1hbGl6ZWROYW1lXSB8fCAodGhpcy5faW5qZWN0aW9uc1tub3JtYWxpemVkTmFtZV0gPSBbXSk7CiAgICAgICAgICAgIGluamVjdGlvbnMucHVzaCh7IHByb3BlcnR5OiBwcm9wZXJ0eSwgc3BlY2lmaWVyOiBub3JtYWxpemVkSW5qZWN0aW9uTmFtZSB9KTsKICAgICAgICB9OwoKICAgICAgICBSZWdpc3RyeS5wcm90b3R5cGUua25vd25Gb3JUeXBlID0gZnVuY3Rpb24ga25vd25Gb3JUeXBlKHR5cGUpIHsKICAgICAgICAgICAgdmFyIGxvY2FsS25vd24gPSAoMCwgX2VtYmVyVXRpbHMuZGljdGlvbmFyeSkobnVsbCk7CiAgICAgICAgICAgIHZhciByZWdpc3RlcmVkTmFtZXMgPSBPYmplY3Qua2V5cyh0aGlzLnJlZ2lzdHJhdGlvbnMpOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgcmVnaXN0ZXJlZE5hbWVzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgdmFyIGZ1bGxOYW1lID0gcmVnaXN0ZXJlZE5hbWVzW2luZGV4XTsKICAgICAgICAgICAgICAgIHZhciBpdGVtVHlwZSA9IGZ1bGxOYW1lLnNwbGl0KCc6JylbMF07CiAgICAgICAgICAgICAgICBpZiAoaXRlbVR5cGUgPT09IHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBsb2NhbEtub3duW2Z1bGxOYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbGxiYWNrS25vd24gPSB2b2lkIDAsCiAgICAgICAgICAgICAgICByZXNvbHZlcktub3duID0gdm9pZCAwOwogICAgICAgICAgICBpZiAodGhpcy5mYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmFsbGJhY2tLbm93biA9IHRoaXMuZmFsbGJhY2sua25vd25Gb3JUeXBlKHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnJlc29sdmVyICE9PSBudWxsICYmIHRoaXMucmVzb2x2ZXIua25vd25Gb3JUeXBlKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlcktub3duID0gdGhpcy5yZXNvbHZlci5rbm93bkZvclR5cGUodHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIGZhbGxiYWNrS25vd24sIGxvY2FsS25vd24sIHJlc29sdmVyS25vd24pOwogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS5pc1ZhbGlkRnVsbE5hbWUgPSBmdW5jdGlvbiBpc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIFZBTElEX0ZVTExfTkFNRV9SRUdFWFAudGVzdChmdWxsTmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLmdldEluamVjdGlvbnMgPSBmdW5jdGlvbiBnZXRJbmplY3Rpb25zKGZ1bGxOYW1lKSB7CiAgICAgICAgICAgIHZhciBpbmplY3Rpb25zID0gdGhpcy5faW5qZWN0aW9uc1tmdWxsTmFtZV07CiAgICAgICAgICAgIGlmICh0aGlzLmZhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tJbmplY3Rpb25zID0gdGhpcy5mYWxsYmFjay5nZXRJbmplY3Rpb25zKGZ1bGxOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChmYWxsYmFja0luamVjdGlvbnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGluamVjdGlvbnMgPSBpbmplY3Rpb25zID09PSB1bmRlZmluZWQgPyBmYWxsYmFja0luamVjdGlvbnMgOiBpbmplY3Rpb25zLmNvbmNhdChmYWxsYmFja0luamVjdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmplY3Rpb25zOwogICAgICAgIH07CgogICAgICAgIFJlZ2lzdHJ5LnByb3RvdHlwZS5nZXRUeXBlSW5qZWN0aW9ucyA9IGZ1bmN0aW9uIGdldFR5cGVJbmplY3Rpb25zKHR5cGUpIHsKICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSB0aGlzLl90eXBlSW5qZWN0aW9uc1t0eXBlXTsKICAgICAgICAgICAgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsYmFja0luamVjdGlvbnMgPSB0aGlzLmZhbGxiYWNrLmdldFR5cGVJbmplY3Rpb25zKHR5cGUpOwogICAgICAgICAgICAgICAgaWYgKGZhbGxiYWNrSW5qZWN0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgaW5qZWN0aW9ucyA9IGluamVjdGlvbnMgPT09IHVuZGVmaW5lZCA/IGZhbGxiYWNrSW5qZWN0aW9ucyA6IGluamVjdGlvbnMuY29uY2F0KGZhbGxiYWNrSW5qZWN0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGluamVjdGlvbnM7CiAgICAgICAgfTsKCiAgICAgICAgUmVnaXN0cnkucHJvdG90eXBlLmV4cGFuZExvY2FsTG9va3VwID0gZnVuY3Rpb24gZXhwYW5kTG9jYWxMb29rdXAoZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMucmVzb2x2ZXIgIT09IG51bGwgJiYgdGhpcy5yZXNvbHZlci5leHBhbmRMb2NhbExvb2t1cCkgewogICAgICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpKTsKICAgICAgICAgICAgICAgICh0cnVlICYmICEoIW9wdGlvbnMuc291cmNlIHx8IHRoaXMuaXNWYWxpZEZ1bGxOYW1lKG9wdGlvbnMuc291cmNlKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvcHRpb25zLnNvdXJjZSBtdXN0IGJlIGEgcHJvcGVyIGZ1bGwgbmFtZScsICFvcHRpb25zLnNvdXJjZSB8fCB0aGlzLmlzVmFsaWRGdWxsTmFtZShvcHRpb25zLnNvdXJjZSkpKTsKCiAgICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplZEZ1bGxOYW1lID0gdGhpcy5ub3JtYWxpemUoZnVsbE5hbWUpOwogICAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTb3VyY2UgPSB0aGlzLm5vcm1hbGl6ZShvcHRpb25zLnNvdXJjZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2V4cGFuZExvY2FsTG9va3VwKHRoaXMsIG5vcm1hbGl6ZWRGdWxsTmFtZSwgbm9ybWFsaXplZFNvdXJjZSwgb3B0aW9ucy5uYW1lc3BhY2UpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmFsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLmV4cGFuZExvY2FsTG9va3VwKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJlZ2lzdHJ5OwogICAgfSgpOwoKICAgIGlmICh0cnVlKSB7CiAgICAgICAgdmFyIHByb3RvID0gUmVnaXN0cnkucHJvdG90eXBlOwogICAgICAgIHByb3RvLm5vcm1hbGl6ZUluamVjdGlvbnNIYXNoID0gZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGhhc2gpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNoLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2hhc2gka2V5ID0gaGFzaFtrZXldLAogICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZpZXIgPSBfaGFzaCRrZXkuc3BlY2lmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBfaGFzaCRrZXkuc291cmNlLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBfaGFzaCRrZXkubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICAgICh0cnVlICYmICEodGhpcy5pc1ZhbGlkRnVsbE5hbWUoc3BlY2lmaWVyKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdFeHBlY3RlZCBhIHByb3BlciBmdWxsIG5hbWUsIGdpdmVuIFwnJyArIHNwZWNpZmllciArICdcJycsIHRoaXMuaXNWYWxpZEZ1bGxOYW1lKHNwZWNpZmllcikpKTsKCiAgICAgICAgICAgICAgICAgICAgaW5qZWN0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IGtleSwKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmaWVyOiBzcGVjaWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmplY3Rpb25zOwogICAgICAgIH07CiAgICAgICAgcHJvdG8udmFsaWRhdGVJbmplY3Rpb25zID0gZnVuY3Rpb24gKGluamVjdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCFpbmplY3Rpb25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmplY3Rpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX2luamVjdGlvbnMkaTIgPSBpbmplY3Rpb25zW2ldLAogICAgICAgICAgICAgICAgICAgIHNwZWNpZmllciA9IF9pbmplY3Rpb25zJGkyLnNwZWNpZmllciwKICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBfaW5qZWN0aW9ucyRpMi5zb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlID0gX2luamVjdGlvbnMkaTIubmFtZXNwYWNlOwogICAgICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmhhcyhzcGVjaWZpZXIsIHsgc291cmNlOiBzb3VyY2UsIG5hbWVzcGFjZTogbmFtZXNwYWNlIH0pKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0F0dGVtcHRpbmcgdG8gaW5qZWN0IGFuIHVua25vd24gaW5qZWN0aW9uOiBcJycgKyBzcGVjaWZpZXIgKyAnXCcnLCB0aGlzLmhhcyhzcGVjaWZpZXIsIHsgc291cmNlOiBzb3VyY2UsIG5hbWVzcGFjZTogbmFtZXNwYWNlIH0pKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gX2V4cGFuZExvY2FsTG9va3VwKHJlZ2lzdHJ5LCBub3JtYWxpemVkTmFtZSwgbm9ybWFsaXplZFNvdXJjZSwgbmFtZXNwYWNlKSB7CiAgICAgICAgdmFyIGNhY2hlID0gcmVnaXN0cnkuX2xvY2FsTG9va3VwQ2FjaGU7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWROYW1lQ2FjaGUgPSBjYWNoZVtub3JtYWxpemVkTmFtZV07CiAgICAgICAgaWYgKCFub3JtYWxpemVkTmFtZUNhY2hlKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZWROYW1lQ2FjaGUgPSBjYWNoZVtub3JtYWxpemVkTmFtZV0gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIH0KICAgICAgICB2YXIgY2FjaGVLZXkgPSBuYW1lc3BhY2UgfHwgbm9ybWFsaXplZFNvdXJjZTsKICAgICAgICB2YXIgY2FjaGVkID0gbm9ybWFsaXplZE5hbWVDYWNoZVtjYWNoZUtleV07CiAgICAgICAgaWYgKGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgICAgfQogICAgICAgIHZhciBleHBhbmRlZCA9IHJlZ2lzdHJ5LnJlc29sdmVyLmV4cGFuZExvY2FsTG9va3VwKG5vcm1hbGl6ZWROYW1lLCBub3JtYWxpemVkU291cmNlLCBuYW1lc3BhY2UpOwogICAgICAgIHJldHVybiBub3JtYWxpemVkTmFtZUNhY2hlW2NhY2hlS2V5XSA9IGV4cGFuZGVkOwogICAgfQogICAgZnVuY3Rpb24gX3Jlc29sdmUocmVnaXN0cnksIF9ub3JtYWxpemVkTmFtZSwgb3B0aW9ucykgewogICAgICAgIHZhciBub3JtYWxpemVkTmFtZSA9IF9ub3JtYWxpemVkTmFtZTsKICAgICAgICAvLyB3aGVuIGBzb3VyY2VgIGlzIHByb3ZpZGVkIGV4cGFuZCBub3JtYWxpemVkTmFtZQogICAgICAgIC8vIGFuZCBzb3VyY2UgaW50byB0aGUgZnVsbCBub3JtYWxpemVkTmFtZQogICAgICAgIGlmIChvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgKG9wdGlvbnMuc291cmNlIHx8IG9wdGlvbnMubmFtZXNwYWNlKSkgewogICAgICAgICAgICBub3JtYWxpemVkTmFtZSA9IHJlZ2lzdHJ5LmV4cGFuZExvY2FsTG9va3VwKF9ub3JtYWxpemVkTmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmICghbm9ybWFsaXplZE5hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2FjaGVkID0gcmVnaXN0cnkuX3Jlc29sdmVDYWNoZVtub3JtYWxpemVkTmFtZV07CiAgICAgICAgaWYgKGNhY2hlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBjYWNoZWQ7CiAgICAgICAgfQogICAgICAgIGlmIChyZWdpc3RyeS5fZmFpbFNldC5oYXMobm9ybWFsaXplZE5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVkID0gdm9pZCAwOwogICAgICAgIGlmIChyZWdpc3RyeS5yZXNvbHZlcikgewogICAgICAgICAgICByZXNvbHZlZCA9IHJlZ2lzdHJ5LnJlc29sdmVyLnJlc29sdmUobm9ybWFsaXplZE5hbWUpOwogICAgICAgIH0KICAgICAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXNvbHZlZCA9IHJlZ2lzdHJ5LnJlZ2lzdHJhdGlvbnNbbm9ybWFsaXplZE5hbWVdOwogICAgICAgIH0KICAgICAgICBpZiAocmVzb2x2ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZWdpc3RyeS5fZmFpbFNldC5hZGQobm9ybWFsaXplZE5hbWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlZ2lzdHJ5Ll9yZXNvbHZlQ2FjaGVbbm9ybWFsaXplZE5hbWVdID0gcmVzb2x2ZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgIH0KICAgIGZ1bmN0aW9uIF9oYXMocmVnaXN0cnksIGZ1bGxOYW1lLCBzb3VyY2UsIG5hbWVzcGFjZSkgewogICAgICAgIHJldHVybiByZWdpc3RyeS5yZXNvbHZlKGZ1bGxOYW1lLCB7IHNvdXJjZTogc291cmNlLCBuYW1lc3BhY2U6IG5hbWVzcGFjZSB9KSAhPT0gdW5kZWZpbmVkOwogICAgfQogICAgdmFyIHByaXZhdGVOYW1lcyA9ICgwLCBfZW1iZXJVdGlscy5kaWN0aW9uYXJ5KShudWxsKTsKICAgIHZhciBwcml2YXRlU3VmZml4ID0gKCcnICsgTWF0aC5yYW5kb20oKSArIERhdGUubm93KCkpLnJlcGxhY2UoJy4nLCAnJyk7CiAgICBmdW5jdGlvbiBwcml2YXRpemUoX3JlZjYpIHsKICAgICAgICB2YXIgZnVsbE5hbWUgPSBfcmVmNlswXTsKCiAgICAgICAgdmFyIG5hbWUgPSBwcml2YXRlTmFtZXNbZnVsbE5hbWVdOwogICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgIH0KCiAgICAgICAgdmFyIF9mdWxsTmFtZSRzcGxpdDIgPSBmdWxsTmFtZS5zcGxpdCgnOicpLAogICAgICAgICAgICB0eXBlID0gX2Z1bGxOYW1lJHNwbGl0MlswXSwKICAgICAgICAgICAgcmF3TmFtZSA9IF9mdWxsTmFtZSRzcGxpdDJbMV07CgogICAgICAgIHJldHVybiBwcml2YXRlTmFtZXNbZnVsbE5hbWVdID0gKDAsIF9lbWJlclV0aWxzLmludGVybikodHlwZSArICc6JyArIHJhd05hbWUgKyAnLScgKyBwcml2YXRlU3VmZml4KTsKICAgIH0KCiAgICAvKgogICAgUHVibGljIEFQSSBmb3IgdGhlIGNvbnRhaW5lciBpcyBzdGlsbCBpbiBmbHV4LgogICAgVGhlIHB1YmxpYyBBUEksIHNwZWNpZmllZCBvbiB0aGUgYXBwbGljYXRpb24gbmFtZXNwYWNlIHNob3VsZCBiZSBjb25zaWRlcmVkIHRoZSBzdGFibGUgQVBJLgogICAgLy8gQG1vZHVsZSBjb250YWluZXIKICAgICAgQHByaXZhdGUKICAgICovCgogICAgZXhwb3J0cy5SZWdpc3RyeSA9IFJlZ2lzdHJ5OwogICAgZXhwb3J0cy5wcml2YXRpemUgPSBwcml2YXRpemU7CiAgICBleHBvcnRzLkNvbnRhaW5lciA9IENvbnRhaW5lcjsKICAgIGV4cG9ydHMuRkFDVE9SWV9GT1IgPSBGQUNUT1JZX0ZPUjsKfSk7CmVuaWZlZCgiZGFnLW1hcCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIC8qKgogICAgICogQSB0b3BvbG9naWNhbGx5IG9yZGVyZWQgbWFwIG9mIGtleS92YWx1ZSBwYWlycyB3aXRoIGEgc2ltcGxlIEFQSSBmb3IgYWRkaW5nIGNvbnN0cmFpbnRzLgogICAgICoKICAgICAqIEVkZ2VzIGNhbiBmb3J3YXJkIHJlZmVyZW5jZSBrZXlzIHRoYXQgaGF2ZSBub3QgYmVlbiBhZGRlZCB5ZXQgKHRoZSBmb3J3YXJkIHJlZmVyZW5jZSB3aWxsCiAgICAgKiBtYXAgdGhlIGtleSB0byB1bmRlZmluZWQpLgogICAgICovCiAgICB2YXIgREFHID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIERBRygpIHsKICAgICAgICAgICAgdGhpcy5fdmVydGljZXMgPSBuZXcgVmVydGljZXMoKTsKICAgICAgICB9CiAgICAgICAgLyoqCiAgICAgICAgICogQWRkcyBhIGtleS92YWx1ZSBwYWlyIHdpdGggZGVwZW5kZW5jaWVzIG9uIG90aGVyIGtleS92YWx1ZSBwYWlycy4KICAgICAgICAgKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAcGFyYW0ga2V5ICAgIFRoZSBrZXkgb2YgdGhlIHZlcnRleCB0byBiZSBhZGRlZC4KICAgICAgICAgKiBAcGFyYW0gdmFsdWUgIFRoZSB2YWx1ZSBvZiB0aGF0IHZlcnRleC4KICAgICAgICAgKiBAcGFyYW0gYmVmb3JlIEEga2V5IG9yIGFycmF5IG9mIGtleXMgb2YgdGhlIHZlcnRpY2VzIHRoYXQgbXVzdAogICAgICAgICAqICAgICAgICAgICAgICAgYmUgdmlzaXRlZCBiZWZvcmUgdGhpcyB2ZXJ0ZXguCiAgICAgICAgICogQHBhcmFtIGFmdGVyICBBbiBzdHJpbmcgb3IgYXJyYXkgb2Ygc3RyaW5ncyB3aXRoIHRoZSBrZXlzIG9mIHRoZQogICAgICAgICAqICAgICAgICAgICAgICAgdmVydGljZXMgdGhhdCBtdXN0IGJlIGFmdGVyIHRoaXMgdmVydGV4IGlzIHZpc2l0ZWQuCiAgICAgICAgICovCiAgICAgICAgREFHLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgYmVmb3JlLCBhZnRlcikgewogICAgICAgICAgICBpZiAoIWtleSkgdGhyb3cgbmV3IEVycm9yKCdhcmd1bWVudCBga2V5YCBpcyByZXF1aXJlZCcpOwogICAgICAgICAgICB2YXIgdmVydGljZXMgPSB0aGlzLl92ZXJ0aWNlczsKICAgICAgICAgICAgdmFyIHYgPSB2ZXJ0aWNlcy5hZGQoa2V5KTsKICAgICAgICAgICAgdi52YWwgPSB2YWx1ZTsKICAgICAgICAgICAgaWYgKGJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBiZWZvcmUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmVydGljZXMuYWRkRWRnZSh2LCB2ZXJ0aWNlcy5hZGQoYmVmb3JlKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmVmb3JlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnRpY2VzLmFkZEVkZ2UodiwgdmVydGljZXMuYWRkKGJlZm9yZVtpXSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWZ0ZXIpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYWZ0ZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgdmVydGljZXMuYWRkRWRnZSh2ZXJ0aWNlcy5hZGQoYWZ0ZXIpLCB2KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhZnRlci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2ZXJ0aWNlcy5hZGRFZGdlKHZlcnRpY2VzLmFkZChhZnRlcltpXSksIHYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLyoqCiAgICAgICAgICogQGRlcHJlY2F0ZWQgcGxlYXNlIHVzZSBhZGQuCiAgICAgICAgICovCiAgICAgICAgREFHLnByb3RvdHlwZS5hZGRFZGdlcyA9IGZ1bmN0aW9uIChrZXksIHZhbHVlLCBiZWZvcmUsIGFmdGVyKSB7CiAgICAgICAgICAgIHRoaXMuYWRkKGtleSwgdmFsdWUsIGJlZm9yZSwgYWZ0ZXIpOwogICAgICAgIH07CiAgICAgICAgLyoqCiAgICAgICAgICogVmlzaXRzIGtleS92YWx1ZSBwYWlycyBpbiB0b3BvbG9naWNhbCBvcmRlci4KICAgICAgICAgKgogICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgd2l0aCBlYWNoIGtleS92YWx1ZS4KICAgICAgICAgKi8KICAgICAgICBEQUcucHJvdG90eXBlLmVhY2ggPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgdGhpcy5fdmVydGljZXMud2FsayhjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICAvKioKICAgICAgICAgKiBAZGVwcmVjYXRlZCBwbGVhc2UgdXNlIGVhY2guCiAgICAgICAgICovCiAgICAgICAgREFHLnByb3RvdHlwZS50b3Bzb3J0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHRoaXMuZWFjaChjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gREFHOwogICAgfSgpOwogICAgZXhwb3J0cy5kZWZhdWx0ID0gREFHOwoKICAgIC8qKiBAcHJpdmF0ZSAqLwogICAgdmFyIFZlcnRpY2VzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFZlcnRpY2VzKCkgewogICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBuZXcgSW50U3RhY2soKTsKICAgICAgICAgICAgdGhpcy5wYXRoID0gbmV3IEludFN0YWNrKCk7CiAgICAgICAgICAgIHRoaXMucmVzdWx0ID0gbmV3IEludFN0YWNrKCk7CiAgICAgICAgfQogICAgICAgIFZlcnRpY2VzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgIGlmICgha2V5KSB0aHJvdyBuZXcgRXJyb3IoIm1pc3Npbmcga2V5Iik7CiAgICAgICAgICAgIHZhciBsID0gdGhpcy5sZW5ndGggfCAwOwogICAgICAgICAgICB2YXIgdmVydGV4OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmVydGV4ID0gdGhpc1tpXTsKICAgICAgICAgICAgICAgIGlmICh2ZXJ0ZXgua2V5ID09PSBrZXkpIHJldHVybiB2ZXJ0ZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sZW5ndGggPSBsICsgMTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbbF0gPSB7CiAgICAgICAgICAgICAgICBpZHg6IGwsCiAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgIHZhbDogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgb3V0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGZsYWc6IGZhbHNlLAogICAgICAgICAgICAgICAgbGVuZ3RoOiAwCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBWZXJ0aWNlcy5wcm90b3R5cGUuYWRkRWRnZSA9IGZ1bmN0aW9uICh2LCB3KSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2sodiwgdy5rZXkpOwogICAgICAgICAgICB2YXIgbCA9IHcubGVuZ3RoIHwgMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh3W2ldID09PSB2LmlkeCkgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHcubGVuZ3RoID0gbCArIDE7CiAgICAgICAgICAgIHdbbF0gPSB2LmlkeDsKICAgICAgICAgICAgdi5vdXQgPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgVmVydGljZXMucHJvdG90eXBlLndhbGsgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB2ZXJ0ZXggPSB0aGlzW2ldOwogICAgICAgICAgICAgICAgaWYgKHZlcnRleC5vdXQpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgdGhpcy52aXNpdCh2ZXJ0ZXgsICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVhY2godGhpcy5yZXN1bHQsIGNiKTsKICAgICAgICB9OwogICAgICAgIFZlcnRpY2VzLnByb3RvdHlwZS5jaGVjayA9IGZ1bmN0aW9uICh2LCB3KSB7CiAgICAgICAgICAgIGlmICh2LmtleSA9PT0gdykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjeWNsZSBkZXRlY3RlZDogIiArIHcgKyAiIDwtICIgKyB3KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBxdWljayBjaGVjawogICAgICAgICAgICBpZiAodi5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgICAgLy8gc2hhbGxvdyBjaGVjawogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHYubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBrZXkgPSB0aGlzW3ZbaV1dLmtleTsKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHcpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImN5Y2xlIGRldGVjdGVkOiAiICsgdyArICIgPC0gIiArIHYua2V5ICsgIiA8LSAiICsgdyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZGVlcCBjaGVjawogICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgIHRoaXMudmlzaXQodiwgdyk7CiAgICAgICAgICAgIGlmICh0aGlzLnBhdGgubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIG1zZ18xID0gImN5Y2xlIGRldGVjdGVkOiAiICsgdzsKICAgICAgICAgICAgICAgIHRoaXMuZWFjaCh0aGlzLnBhdGgsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICBtc2dfMSArPSAiIDwtICIgKyBrZXk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2dfMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFZlcnRpY2VzLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5zdGFjay5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLnBhdGgubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5yZXN1bHQubGVuZ3RoID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdGhpc1tpXS5mbGFnID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFZlcnRpY2VzLnByb3RvdHlwZS52aXNpdCA9IGZ1bmN0aW9uIChzdGFydCwgc2VhcmNoKSB7CiAgICAgICAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgICAgICAgICBzdGFjayA9IF9hLnN0YWNrLAogICAgICAgICAgICAgICAgcGF0aCA9IF9hLnBhdGgsCiAgICAgICAgICAgICAgICByZXN1bHQgPSBfYS5yZXN1bHQ7CiAgICAgICAgICAgIHN0YWNrLnB1c2goc3RhcnQuaWR4KTsKICAgICAgICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gc3RhY2sucG9wKCkgfCAwOwogICAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBlbnRlcgogICAgICAgICAgICAgICAgICAgIHZhciB2ZXJ0ZXggPSB0aGlzW2luZGV4XTsKICAgICAgICAgICAgICAgICAgICBpZiAodmVydGV4LmZsYWcpIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIHZlcnRleC5mbGFnID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBwYXRoLnB1c2goaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2ggPT09IHZlcnRleC5rZXkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIC8vIHB1c2ggZXhpdAogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gofmluZGV4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1c2hJbmNvbWluZyh2ZXJ0ZXgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBleGl0CiAgICAgICAgICAgICAgICAgICAgcGF0aC5wb3AoKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh+aW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBWZXJ0aWNlcy5wcm90b3R5cGUucHVzaEluY29taW5nID0gZnVuY3Rpb24gKGluY29tbWluZykgewogICAgICAgICAgICB2YXIgc3RhY2sgPSB0aGlzLnN0YWNrOwogICAgICAgICAgICBmb3IgKHZhciBpID0gaW5jb21taW5nLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBpbmNvbW1pbmdbaV07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXNbaW5kZXhdLmZsYWcpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVmVydGljZXMucHJvdG90eXBlLmVhY2ggPSBmdW5jdGlvbiAoaW5kaWNlcywgY2IpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBpbmRpY2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIHZlcnRleCA9IHRoaXNbaW5kaWNlc1tpXV07CiAgICAgICAgICAgICAgICBjYih2ZXJ0ZXgua2V5LCB2ZXJ0ZXgudmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFZlcnRpY2VzOwogICAgfSgpOwogICAgLyoqIEBwcml2YXRlICovCiAgICB2YXIgSW50U3RhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gSW50U3RhY2soKSB7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgSW50U3RhY2sucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiAobikgewogICAgICAgICAgICB0aGlzW3RoaXMubGVuZ3RoKytdID0gbiB8IDA7CiAgICAgICAgfTsKICAgICAgICBJbnRTdGFjay5wcm90b3R5cGUucG9wID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpc1stLXRoaXMubGVuZ3RoXSB8IDA7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gSW50U3RhY2s7CiAgICB9KCk7Cn0pOwplbmlmZWQoJ2VtYmVyLWJhYmVsJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmNsYXNzQ2FsbENoZWNrID0gY2xhc3NDYWxsQ2hlY2s7CiAgZXhwb3J0cy5pbmhlcml0cyA9IGluaGVyaXRzOwogIGV4cG9ydHMudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UgPSB0YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZTsKICBleHBvcnRzLmNyZWF0ZUNsYXNzID0gY3JlYXRlQ2xhc3M7CiAgdmFyIGNyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIHNldFByb3RvdHlwZU9mID0gT2JqZWN0LnNldFByb3RvdHlwZU9mOwogIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKCiAgZnVuY3Rpb24gY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7CiAgICBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7CiAgICB9CiAgICBzdWJDbGFzcy5wcm90b3R5cGUgPSBjcmVhdGUoc3VwZXJDbGFzcyA9PT0gbnVsbCA/IG51bGwgOiBzdXBlckNsYXNzLnByb3RvdHlwZSwgewogICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgIHZhbHVlOiBzdWJDbGFzcywKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgICBpZiAoc3VwZXJDbGFzcyAhPT0gbnVsbCkgc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpOwogIH0KCiAgZnVuY3Rpb24gdGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2Uoc3RyaW5ncywgcmF3KSB7CiAgICBzdHJpbmdzLnJhdyA9IHJhdzsKICAgIHJldHVybiBzdHJpbmdzOwogIH0KCiAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07CiAgICAgIGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsKICAgICAgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOwogICAgICBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDbGFzcyhDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIGlmIChwcm90b1Byb3BzICE9PSB1bmRlZmluZWQpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKICAgIGlmIChzdGF0aWNQcm9wcyAhPT0gdW5kZWZpbmVkKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7CiAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgfQoKICB2YXIgcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiA9IGV4cG9ydHMucG9zc2libGVDb25zdHJ1Y3RvclJldHVybiA9IGZ1bmN0aW9uIChzZWxmLCBjYWxsKSB7CiAgICBpZiAoIXNlbGYpIHsKICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCd0aGlzIGhhc25cJ3QgYmVlbiBpbml0aWFsaXplZCAtIHN1cGVyKCkgaGFzblwndCBiZWVuIGNhbGxlZCcpOwogICAgfQogICAgcmV0dXJuIGNhbGwgIT09IG51bGwgJiYgdHlwZW9mIGNhbGwgPT09ICdvYmplY3QnIHx8IHR5cGVvZiBjYWxsID09PSAnZnVuY3Rpb24nID8gY2FsbCA6IHNlbGY7CiAgfTsKfSk7CmVuaWZlZCgnZW1iZXItYnJvd3Nlci1lbnZpcm9ubWVudCcsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8vIGNoZWNrIGlmIHdpbmRvdyBleGlzdHMgYW5kIGFjdHVhbGx5IGlzIHRoZSBnbG9iYWwKICAgIHZhciBoYXNEb20gPSB0eXBlb2Ygc2VsZiA9PT0gJ29iamVjdCcgJiYgc2VsZiAhPT0gbnVsbCAmJiBzZWxmLk9iamVjdCA9PT0gT2JqZWN0ICYmIHR5cGVvZiBXaW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHNlbGYuY29uc3RydWN0b3IgPT09IFdpbmRvdyAmJiB0eXBlb2YgZG9jdW1lbnQgPT09ICdvYmplY3QnICYmIGRvY3VtZW50ICE9PSBudWxsICYmIHNlbGYuZG9jdW1lbnQgPT09IGRvY3VtZW50ICYmIHR5cGVvZiBsb2NhdGlvbiA9PT0gJ29iamVjdCcgJiYgbG9jYXRpb24gIT09IG51bGwgJiYgc2VsZi5sb2NhdGlvbiA9PT0gbG9jYXRpb24gJiYgdHlwZW9mIGhpc3RvcnkgPT09ICdvYmplY3QnICYmIGhpc3RvcnkgIT09IG51bGwgJiYgc2VsZi5oaXN0b3J5ID09PSBoaXN0b3J5ICYmIHR5cGVvZiBuYXZpZ2F0b3IgPT09ICdvYmplY3QnICYmIG5hdmlnYXRvciAhPT0gbnVsbCAmJiBzZWxmLm5hdmlnYXRvciA9PT0gbmF2aWdhdG9yICYmIHR5cGVvZiBuYXZpZ2F0b3IudXNlckFnZW50ID09PSAnc3RyaW5nJzsKCiAgICB2YXIgd2luZG93ID0gaGFzRG9tID8gc2VsZiA6IG51bGw7CiAgICB2YXIgbG9jYXRpb24kMSA9IGhhc0RvbSA/IHNlbGYubG9jYXRpb24gOiBudWxsOwogICAgdmFyIGhpc3RvcnkkMSA9IGhhc0RvbSA/IHNlbGYuaGlzdG9yeSA6IG51bGw7CiAgICB2YXIgdXNlckFnZW50ID0gaGFzRG9tID8gc2VsZi5uYXZpZ2F0b3IudXNlckFnZW50IDogJ0x5bnggKHRleHRtb2RlKSc7CiAgICB2YXIgaXNDaHJvbWUgPSBoYXNEb20gPyAhIXdpbmRvdy5jaHJvbWUgJiYgIXdpbmRvdy5vcGVyYSA6IGZhbHNlOwogICAgdmFyIGlzRmlyZWZveCA9IGhhc0RvbSA/IHR5cGVvZiBJbnN0YWxsVHJpZ2dlciAhPT0gJ3VuZGVmaW5lZCcgOiBmYWxzZTsKCiAgICBleHBvcnRzLndpbmRvdyA9IHdpbmRvdzsKICAgIGV4cG9ydHMubG9jYXRpb24gPSBsb2NhdGlvbiQxOwogICAgZXhwb3J0cy5oaXN0b3J5ID0gaGlzdG9yeSQxOwogICAgZXhwb3J0cy51c2VyQWdlbnQgPSB1c2VyQWdlbnQ7CiAgICBleHBvcnRzLmlzQ2hyb21lID0gaXNDaHJvbWU7CiAgICBleHBvcnRzLmlzRmlyZWZveCA9IGlzRmlyZWZveDsKICAgIGV4cG9ydHMuaGFzRE9NID0gaGFzRG9tOwp9KTsKZW5pZmVkKCdlbWJlci1jb25zb2xlL2luZGV4JywgWydleHBvcnRzJywgJ0BlbWJlci9kZWJ1ZycsICdAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvLyBEZWxpdmVyIG1lc3NhZ2UgdGhhdCB0aGUgZnVuY3Rpb24gaXMgZGVwcmVjYXRlZAoKICB2YXIgREVQUkVDQVRJT05fTUVTU0FHRSA9ICdVc2Ugb2YgRW1iZXIuTG9nZ2VyIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgYGNvbnNvbGVgIGZvciBsb2dnaW5nLic7CiAgdmFyIERFUFJFQ0FUSU9OX0lEID0gJ2VtYmVyLWNvbnNvbGUuZGVwcmVjYXRlLWxvZ2dlcic7CiAgdmFyIERFUFJFQ0FUSU9OX1VSTCA9ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY191c2UtY29uc29sZS1yYXRoZXItdGhhbi1lbWJlci1sb2dnZXInOwogIC8qKgogICAgIEBtb2R1bGUgZW1iZXIKICAqLwoKICAvKioKICAgIEluc2lkZSBFbWJlci1NZXRhbCwgc2ltcGx5IHVzZXMgdGhlIG1ldGhvZHMgZnJvbSBgaW1wb3J0cy5jb25zb2xlYC4KICAgIE92ZXJyaWRlIHRoaXMgdG8gcHJvdmlkZSBtb3JlIHJvYnVzdCBsb2dnaW5nIGZ1bmN0aW9uYWxpdHkuCiAgCiAgICBAY2xhc3MgTG9nZ2VyCiAgICBAZGVwcmVjYXRlZCBVc2UgJ2NvbnNvbGUnIGluc3RlYWQKICAKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEBwdWJsaWMKICAqLwogIHZhciBERVBSRUNBVEVEX0xPR0dFUiA9IHZvaWQgMDsKCiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuTE9HR0VSKSB7CiAgICBERVBSRUNBVEVEX0xPR0dFUiA9IHsKICAgICAgbG9nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9jb25zb2xlOwoKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoREVQUkVDQVRJT05fTUVTU0FHRSwgZmFsc2UsIHsKICAgICAgICAgIGlkOiBERVBSRUNBVElPTl9JRCwKICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgdXJsOiBERVBSRUNBVElPTl9VUkwKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiAoX2NvbnNvbGUgPSBjb25zb2xlKS5sb2cuYXBwbHkoX2NvbnNvbGUsIGFyZ3VtZW50cyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZQogICAgICB9LAogICAgICB3YXJuOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9jb25zb2xlMjsKCiAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKERFUFJFQ0FUSU9OX01FU1NBR0UsIGZhbHNlLCB7CiAgICAgICAgICBpZDogREVQUkVDQVRJT05fSUQsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgIHVybDogREVQUkVDQVRJT05fVVJMCiAgICAgICAgfSkpOwoKICAgICAgICByZXR1cm4gKF9jb25zb2xlMiA9IGNvbnNvbGUpLndhcm4uYXBwbHkoX2NvbnNvbGUyLCBhcmd1bWVudHMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgICAgfSwKICAgICAgZXJyb3I6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX2NvbnNvbGUzOwoKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoREVQUkVDQVRJT05fTUVTU0FHRSwgZmFsc2UsIHsKICAgICAgICAgIGlkOiBERVBSRUNBVElPTl9JRCwKICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgdXJsOiBERVBSRUNBVElPTl9VUkwKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiAoX2NvbnNvbGUzID0gY29uc29sZSkuZXJyb3IuYXBwbHkoX2NvbnNvbGUzLCBhcmd1bWVudHMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgICAgfSwKICAgICAgaW5mbzogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfY29uc29sZTQ7CgogICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKShERVBSRUNBVElPTl9NRVNTQUdFLCBmYWxzZSwgewogICAgICAgICAgaWQ6IERFUFJFQ0FUSU9OX0lELAogICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICB1cmw6IERFUFJFQ0FUSU9OX1VSTAogICAgICAgIH0pKTsKCiAgICAgICAgcmV0dXJuIChfY29uc29sZTQgPSBjb25zb2xlKS5pbmZvLmFwcGx5KF9jb25zb2xlNCwgYXJndW1lbnRzKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgIH0sCiAgICAgIGRlYnVnOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9jb25zb2xlNjsKCiAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKERFUFJFQ0FUSU9OX01FU1NBR0UsIGZhbHNlLCB7CiAgICAgICAgICBpZDogREVQUkVDQVRJT05fSUQsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgICAgIHVybDogREVQUkVDQVRJT05fVVJMCiAgICAgICAgfSkpOwoKICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovCiAgICAgICAgaWYgKGNvbnNvbGUuZGVidWcpIHsKICAgICAgICAgIHZhciBfY29uc29sZTU7CgogICAgICAgICAgcmV0dXJuIChfY29uc29sZTUgPSBjb25zb2xlKS5kZWJ1Zy5hcHBseShfY29uc29sZTUsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoX2NvbnNvbGU2ID0gY29uc29sZSkuaW5mby5hcHBseShfY29uc29sZTYsIGFyZ3VtZW50cyk7CiAgICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1jb25zb2xlICovCiAgICAgIH0sCiAgICAgIGFzc2VydDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfY29uc29sZTc7CgogICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKShERVBSRUNBVElPTl9NRVNTQUdFLCBmYWxzZSwgewogICAgICAgICAgaWQ6IERFUFJFQ0FUSU9OX0lELAogICAgICAgICAgdW50aWw6ICc0LjAuMCcsCiAgICAgICAgICB1cmw6IERFUFJFQ0FUSU9OX1VSTAogICAgICAgIH0pKTsKCiAgICAgICAgcmV0dXJuIChfY29uc29sZTcgPSBjb25zb2xlKS5hc3NlcnQuYXBwbHkoX2NvbnNvbGU3LCBhcmd1bWVudHMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICAgICAgfQogICAgfTsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IERFUFJFQ0FURURfTE9HR0VSOwp9KTsKZW5pZmVkKCdlbWJlci1lbnZpcm9ubWVudCcsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8vIGZyb20gbG9kYXNoIHRvIGNhdGNoIGZha2UgZ2xvYmFscwogICAgZnVuY3Rpb24gY2hlY2tHbG9iYWwodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUuT2JqZWN0ID09PSBPYmplY3QgPyB2YWx1ZSA6IHVuZGVmaW5lZDsKICAgIH0KICAgIC8vIGVsZW1lbnQgaWRzIGNhbiBydWluIGdsb2JhbCBtaXNzIGNoZWNrcwogICAgZnVuY3Rpb24gY2hlY2tFbGVtZW50SWRTaGFkb3dpbmcodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUubm9kZVR5cGUgPT09IHVuZGVmaW5lZCA/IHZhbHVlIDogdW5kZWZpbmVkOwogICAgfQogICAgLy8gZXhwb3J0IHJlYWwgZ2xvYmFsCiAgICB2YXIgZ2xvYmFsJDEgPSBjaGVja0dsb2JhbChjaGVja0VsZW1lbnRJZFNoYWRvd2luZyh0eXBlb2YgZ2xvYmFsID09PSAnb2JqZWN0JyAmJiBnbG9iYWwpKSB8fCBjaGVja0dsb2JhbCh0eXBlb2Ygc2VsZiA9PT0gJ29iamVjdCcgJiYgc2VsZikgfHwgY2hlY2tHbG9iYWwodHlwZW9mIHdpbmRvdyA9PT0gJ29iamVjdCcgJiYgd2luZG93KSB8fCB0eXBlb2YgbWFpbkNvbnRleHQgIT09ICd1bmRlZmluZWQnICYmIG1haW5Db250ZXh0IHx8IC8vIHNldCBiZWZvcmUgc3RyaWN0IG1vZGUgaW4gRW1iZXIgbG9hZGVyL3dyYXBwZXIKICAgIG5ldyBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpOyAvLyBldmFsIG91dHNpZGUgb2Ygc3RyaWN0IG1vZGUKCiAgICAvLyBsZWdhY3kgaW1wb3J0cy9leHBvcnRzL2xvb2t1cCBzdHVmZiAoc2hvdWxkIHdlIGtlZXAgdGhpcz8/KQogICAgdmFyIGNvbnRleHQgPSBmdW5jdGlvbiAoZ2xvYmFsLCBFbWJlcikgewogICAgICAgIHJldHVybiBFbWJlciA9PT0gdW5kZWZpbmVkID8geyBpbXBvcnRzOiBnbG9iYWwsIGV4cG9ydHM6IGdsb2JhbCwgbG9va3VwOiBnbG9iYWwgfSA6IHsKICAgICAgICAgICAgLy8gaW1wb3J0IGpRdWVyeQogICAgICAgICAgICBpbXBvcnRzOiBFbWJlci5pbXBvcnRzIHx8IGdsb2JhbCwKICAgICAgICAgICAgLy8gZXhwb3J0IEVtYmVyCiAgICAgICAgICAgIGV4cG9ydHM6IEVtYmVyLmV4cG9ydHMgfHwgZ2xvYmFsLAogICAgICAgICAgICAvLyBzZWFyY2ggZm9yIE5hbWVzcGFjZXMKICAgICAgICAgICAgbG9va3VwOiBFbWJlci5sb29rdXAgfHwgZ2xvYmFsCiAgICAgICAgfTsKICAgIH0oZ2xvYmFsJDEsIGdsb2JhbCQxLkVtYmVyKTsKICAgIGZ1bmN0aW9uIGdldExvb2t1cCgpIHsKICAgICAgICByZXR1cm4gY29udGV4dC5sb29rdXA7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRMb29rdXAodmFsdWUpIHsKICAgICAgICBjb250ZXh0Lmxvb2t1cCA9IHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICBUaGUgaGFzaCBvZiBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdXNlZCB0byBjb250cm9sIHZhcmlvdXMgY29uZmlndXJhdGlvbgogICAgICBzZXR0aW5ncy4gVG8gc3BlY2lmeSB5b3VyIG93biBvciBvdmVycmlkZSBkZWZhdWx0IHNldHRpbmdzLCBhZGQgdGhlCiAgICAgIGRlc2lyZWQgcHJvcGVydGllcyB0byBhIGdsb2JhbCBoYXNoIG5hbWVkIGBFbWJlckVOVmAgKG9yIGBFTlZgIGZvcgogICAgICBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIGVhcmxpZXIgdmVyc2lvbnMgb2YgRW1iZXIpLiBUaGUgYEVtYmVyRU5WYAogICAgICBoYXNoIG11c3QgYmUgY3JlYXRlZCBiZWZvcmUgbG9hZGluZyBFbWJlci4KICAgIAogICAgICBAY2xhc3MgRW1iZXJFTlYKICAgICAgQHR5cGUgT2JqZWN0CiAgICAgIEBwdWJsaWMKICAgICovCiAgICB2YXIgRU5WID0gewogICAgICAgIEVOQUJMRV9PUFRJT05BTF9GRUFUVVJFUzogZmFsc2UsCiAgICAgICAgLyoqCiAgICAgICAgICBEZXRlcm1pbmVzIHdoZXRoZXIgRW1iZXIgc2hvdWxkIGFkZCB0byBgQXJyYXlgLCBgRnVuY3Rpb25gLCBhbmQgYFN0cmluZ2AKICAgICAgICAgIG5hdGl2ZSBvYmplY3QgcHJvdG90eXBlcywgYSBmZXcgZXh0cmEgbWV0aG9kcyBpbiBvcmRlciB0byBwcm92aWRlIGEgbW9yZQogICAgICAgICAgZnJpZW5kbHkgQVBJLgogICAgICAgICAgICAgV2UgZ2VuZXJhbGx5IHJlY29tbWVuZCBsZWF2aW5nIHRoaXMgb3B0aW9uIHNldCB0byB0cnVlIGhvd2V2ZXIsIGlmIHlvdSBuZWVkCiAgICAgICAgICB0byB0dXJuIGl0IG9mZiwgeW91IGNhbiBhZGQgdGhlIGNvbmZpZ3VyYXRpb24gcHJvcGVydHkKICAgICAgICAgIGBFWFRFTkRfUFJPVE9UWVBFU2AgdG8gYEVtYmVyRU5WYCBhbmQgc2V0IGl0IHRvIGBmYWxzZWAuCiAgICAgICAgICAgICBOb3RlLCB3aGVuIGRpc2FibGVkICh0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uIGZvciBFbWJlciBBZGRvbnMpLCB5b3Ugd2lsbAogICAgICAgICAgaW5zdGVhZCBoYXZlIHRvIGFjY2VzcyBhbGwgbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGZyb20gdGhlIEVtYmVyCiAgICAgICAgICBuYW1lc3BhY2UuCiAgICAgICAgICAgICBAcHJvcGVydHkgRVhURU5EX1BST1RPVFlQRVMKICAgICAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgICAgIEBkZWZhdWx0IHRydWUKICAgICAgICAgIEBmb3IgRW1iZXJFTlYKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAqLwogICAgICAgIEVYVEVORF9QUk9UT1RZUEVTOiB7CiAgICAgICAgICAgIEFycmF5OiB0cnVlLAogICAgICAgICAgICBGdW5jdGlvbjogdHJ1ZSwKICAgICAgICAgICAgU3RyaW5nOiB0cnVlCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgIFRoZSBgTE9HX1NUQUNLVFJBQ0VfT05fREVQUkVDQVRJT05gIHByb3BlcnR5LCB3aGVuIHRydWUsIHRlbGxzIEVtYmVyIHRvIGxvZwogICAgICAgICAgYSBmdWxsIHN0YWNrIHRyYWNlIGR1cmluZyBkZXByZWNhdGlvbiB3YXJuaW5ncy4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBMT0dfU1RBQ0tUUkFDRV9PTl9ERVBSRUNBVElPTgogICAgICAgICAgQHR5cGUgQm9vbGVhbgogICAgICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICAgICAgQGZvciBFbWJlckVOVgogICAgICAgICAgQHB1YmxpYwogICAgICAgICovCiAgICAgICAgTE9HX1NUQUNLVFJBQ0VfT05fREVQUkVDQVRJT046IHRydWUsCiAgICAgICAgLyoqCiAgICAgICAgICBUaGUgYExPR19WRVJTSU9OYCBwcm9wZXJ0eSwgd2hlbiB0cnVlLCB0ZWxscyBFbWJlciB0byBsb2cgdmVyc2lvbnMgb2YgYWxsCiAgICAgICAgICBkZXBlbmRlbnQgbGlicmFyaWVzIGluIHVzZS4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBMT0dfVkVSU0lPTgogICAgICAgICAgQHR5cGUgQm9vbGVhbgogICAgICAgICAgQGRlZmF1bHQgdHJ1ZQogICAgICAgICAgQGZvciBFbWJlckVOVgogICAgICAgICAgQHB1YmxpYwogICAgICAgICovCiAgICAgICAgTE9HX1ZFUlNJT046IHRydWUsCiAgICAgICAgUkFJU0VfT05fREVQUkVDQVRJT046IGZhbHNlLAogICAgICAgIFNUUlVDVFVSRURfUFJPRklMRTogZmFsc2UsCiAgICAgICAgLyoqCiAgICAgICAgICBXaGV0aGVyIHRvIGluc2VydCBhIGA8ZGl2IGNsYXNzPSJlbWJlci12aWV3IiAvPmAgd3JhcHBlciBhcm91bmQgdGhlCiAgICAgICAgICBhcHBsaWNhdGlvbiB0ZW1wbGF0ZS4gU2VlIFJGQyAjMjgwLgogICAgICAgICAgICAgVGhpcyBpcyBub3QgaW50ZW5kZWQgdG8gYmUgc2V0IGRpcmVjdGx5LCBhcyB0aGUgaW1wbGVtZW50YXRpb24gbWF5IGNoYW5nZSBpbgogICAgICAgICAgdGhlIGZ1dHVyZS4gVXNlIGBAZW1iZXIvb3B0aW9uYWwtZmVhdHVyZXNgIGluc3RlYWQuCiAgICAgICAgICAgICBAcHJvcGVydHkgX0FQUExJQ0FUSU9OX1RFTVBMQVRFX1dSQVBQRVIKICAgICAgICAgIEBmb3IgRW1iZXJFTlYKICAgICAgICAgIEB0eXBlIEJvb2xlYW4KICAgICAgICAgIEBkZWZhdWx0IHRydWUKICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgKi8KICAgICAgICBfQVBQTElDQVRJT05fVEVNUExBVEVfV1JBUFBFUjogdHJ1ZSwKICAgICAgICAvKioKICAgICAgICAgIFdoZXRoZXIgdG8gdXNlIEdsaW1tZXIgQ29tcG9uZW50IHNlbWFudGljcyAoYXMgb3Bwb3NlZCB0byB0aGUgY2xhc3NpYyAiQ3VybHkiCiAgICAgICAgICBjb21wb25lbnRzIHNlbWFudGljcykgZm9yIHRlbXBsYXRlLW9ubHkgY29tcG9uZW50cy4gU2VlIFJGQyAjMjc4LgogICAgICAgICAgICAgVGhpcyBpcyBub3QgaW50ZW5kZWQgdG8gYmUgc2V0IGRpcmVjdGx5LCBhcyB0aGUgaW1wbGVtZW50YXRpb24gbWF5IGNoYW5nZSBpbgogICAgICAgICAgdGhlIGZ1dHVyZS4gVXNlIGBAZW1iZXIvb3B0aW9uYWwtZmVhdHVyZXNgIGluc3RlYWQuCiAgICAgICAgICAgICBAcHJvcGVydHkgX1RFTVBMQVRFX09OTFlfR0xJTU1FUl9DT01QT05FTlRTCiAgICAgICAgICBAZm9yIEVtYmVyRU5WCiAgICAgICAgICBAdHlwZSBCb29sZWFuCiAgICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICAgQHByaXZhdGUKICAgICAgICAqLwogICAgICAgIF9URU1QTEFURV9PTkxZX0dMSU1NRVJfQ09NUE9ORU5UUzogZmFsc2UsCiAgICAgICAgLyoqCiAgICAgICAgICBXaGV0aGVyIHRoZSBhcHAgaXMgdXNpbmcgalF1ZXJ5LiBTZWUgUkZDICMyOTQuCiAgICAgICAgICAgICBUaGlzIGlzIG5vdCBpbnRlbmRlZCB0byBiZSBzZXQgZGlyZWN0bHksIGFzIHRoZSBpbXBsZW1lbnRhdGlvbiBtYXkgY2hhbmdlIGluCiAgICAgICAgICB0aGUgZnV0dXJlLiBVc2UgYEBlbWJlci9vcHRpb25hbC1mZWF0dXJlc2AgaW5zdGVhZC4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBfSlFVRVJZX0lOVEVHUkFUSU9OCiAgICAgICAgICBAZm9yIEVtYmVyRU5WCiAgICAgICAgICBAdHlwZSBCb29sZWFuCiAgICAgICAgICBAZGVmYXVsdCB0cnVlCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICovCiAgICAgICAgX0pRVUVSWV9JTlRFR1JBVElPTjogdHJ1ZSwKICAgICAgICAvLyB0aGUgZm9sbG93aW5nIGZvciBhZGRvbiBzdXBwb3J0CiAgICAgICAgX0VOQUJMRV9FTUJFUl9LX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfU0FGRV9TVFJJTkdfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9FTlVNRVJBQkxFX0NPTlRBSU5TX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfVU5ERVJTQ09SRV9BQ1RJT05TX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfUkVWRVJTRURfT0JTRVJWRVJfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9JTklUSUFMSVpFUl9BUkdVTUVOVFNfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9ST1VURVJfUkVTT1VSQ0U6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfQ1VSUkVOVF9XSEVOX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfQ09OVFJPTExFUl9XUkFQUEVEX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfREVQUkVDQVRFRF9SRUdJU1RSWV9TVVBQT1JUOiBmYWxzZSwKICAgICAgICBfRU5BQkxFX0lNTUVESUFURV9PQlNFUlZFUl9TVVBQT1JUOiBmYWxzZSwKICAgICAgICBfRU5BQkxFX1NUUklOR19GTVRfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9GUkVFWkFCTEVfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9DT01QT05FTlRfREVGQVVMVExBWU9VVF9TVVBQT1JUOiBmYWxzZSwKICAgICAgICBfRU5BQkxFX0JJTkRJTkdfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9JTlBVVF9UUkFOU0ZPUk1fU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9ERVBSRUNBVElPTl9PUFRJT05TX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfT1JQSEFORURfT1VUTEVUU19TVVBQT1JUOiBmYWxzZSwKICAgICAgICBfRU5BQkxFX1dBUk5fT1BUSU9OU19TVVBQT1JUOiBmYWxzZSwKICAgICAgICBfRU5BQkxFX1JFU09MVkVSX0ZVTkNUSU9OX1NVUFBPUlQ6IGZhbHNlLAogICAgICAgIF9FTkFCTEVfRElEX0lOSVRfQVRUUlNfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9SRU5ERVJfU1VQUE9SVDogZmFsc2UsCiAgICAgICAgX0VOQUJMRV9QUk9QRVJUWV9SRVFVSVJFRF9TVVBQT1JUOiBmYWxzZSwKICAgICAgICBFTUJFUl9MT0FEX0hPT0tTOiB7fSwKICAgICAgICBGRUFUVVJFUzoge30KICAgIH07CiAgICAoZnVuY3Rpb24gKEVtYmVyRU5WKSB7CiAgICAgICAgaWYgKHR5cGVvZiBFbWJlckVOViAhPT0gJ29iamVjdCcgfHwgRW1iZXJFTlYgPT09IG51bGwpIHJldHVybjsKICAgICAgICBmb3IgKHZhciBmbGFnIGluIEVtYmVyRU5WKSB7CiAgICAgICAgICAgIGlmICghRW1iZXJFTlYuaGFzT3duUHJvcGVydHkoZmxhZykgfHwgZmxhZyA9PT0gJ0VYVEVORF9QUk9UT1RZUEVTJyB8fCBmbGFnID09PSAnRU1CRVJfTE9BRF9IT09LUycpIGNvbnRpbnVlOwogICAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gRU5WW2ZsYWddOwogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBFTlZbZmxhZ10gPSBFbWJlckVOVltmbGFnXSAhPT0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgRU5WW2ZsYWddID0gRW1iZXJFTlZbZmxhZ10gPT09IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIEVYVEVORF9QUk9UT1RZUEVTID0gRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVM7CgogICAgICAgIGlmIChFWFRFTkRfUFJPVE9UWVBFUyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgRVhURU5EX1BST1RPVFlQRVMgPT09ICdvYmplY3QnICYmIEVYVEVORF9QUk9UT1RZUEVTICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBFTlYuRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nID0gRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nICE9PSBmYWxzZTsKICAgICAgICAgICAgICAgIEVOVi5FWFRFTkRfUFJPVE9UWVBFUy5GdW5jdGlvbiA9IEVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uICE9PSBmYWxzZTsKICAgICAgICAgICAgICAgIEVOVi5FWFRFTkRfUFJPVE9UWVBFUy5BcnJheSA9IEVYVEVORF9QUk9UT1RZUEVTLkFycmF5ICE9PSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBpc0VuYWJsZWQgPSBFWFRFTkRfUFJPVE9UWVBFUyAhPT0gZmFsc2U7CiAgICAgICAgICAgICAgICBFTlYuRVhURU5EX1BST1RPVFlQRVMuU3RyaW5nID0gaXNFbmFibGVkOwogICAgICAgICAgICAgICAgRU5WLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uID0gaXNFbmFibGVkOwogICAgICAgICAgICAgICAgRU5WLkVYVEVORF9QUk9UT1RZUEVTLkFycmF5ID0gaXNFbmFibGVkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIFRPRE8gdGhpcyBkb2VzIG5vdCBzZWVtIHRvIGJlIHVzZWQgYnkgYW55dGhpbmcsCiAgICAgICAgLy8gICAgICBjYW4gd2UgcmVtb3ZlIGl0PyBkbyB3ZSBuZWVkIHRvIGRlcHJlY2F0ZSBpdD8KICAgICAgICB2YXIgRU1CRVJfTE9BRF9IT09LUyA9IEVtYmVyRU5WLkVNQkVSX0xPQURfSE9PS1M7CgogICAgICAgIGlmICh0eXBlb2YgRU1CRVJfTE9BRF9IT09LUyA9PT0gJ29iamVjdCcgJiYgRU1CRVJfTE9BRF9IT09LUyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBob29rTmFtZSBpbiBFTUJFUl9MT0FEX0hPT0tTKSB7CiAgICAgICAgICAgICAgICBpZiAoIUVNQkVSX0xPQURfSE9PS1MuaGFzT3duUHJvcGVydHkoaG9va05hbWUpKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIHZhciBob29rcyA9IEVNQkVSX0xPQURfSE9PS1NbaG9va05hbWVdOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaG9va3MpKSB7CiAgICAgICAgICAgICAgICAgICAgRU5WLkVNQkVSX0xPQURfSE9PS1NbaG9va05hbWVdID0gaG9va3MuZmlsdGVyKGZ1bmN0aW9uIChob29rKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaG9vayA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRkVBVFVSRVMgPSBFbWJlckVOVi5GRUFUVVJFUzsKCiAgICAgICAgaWYgKHR5cGVvZiBGRUFUVVJFUyA9PT0gJ29iamVjdCcgJiYgRkVBVFVSRVMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgZmVhdHVyZSBpbiBGRUFUVVJFUykgewogICAgICAgICAgICAgICAgaWYgKCFGRUFUVVJFUy5oYXNPd25Qcm9wZXJ0eShmZWF0dXJlKSkgY29udGludWU7CiAgICAgICAgICAgICAgICBFTlYuRkVBVFVSRVNbZmVhdHVyZV0gPSBGRUFUVVJFU1tmZWF0dXJlXSA9PT0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pKGdsb2JhbCQxLkVtYmVyRU5WIHx8IGdsb2JhbCQxLkVOVik7CiAgICBmdW5jdGlvbiBnZXRFTlYoKSB7CiAgICAgICAgcmV0dXJuIEVOVjsKICAgIH0KCiAgICBleHBvcnRzLmdsb2JhbCA9IGdsb2JhbCQxOwogICAgZXhwb3J0cy5jb250ZXh0ID0gY29udGV4dDsKICAgIGV4cG9ydHMuZ2V0TG9va3VwID0gZ2V0TG9va3VwOwogICAgZXhwb3J0cy5zZXRMb29rdXAgPSBzZXRMb29rdXA7CiAgICBleHBvcnRzLkVOViA9IEVOVjsKICAgIGV4cG9ydHMuZ2V0RU5WID0gZ2V0RU5WOwp9KTsKZW5pZmVkKCJlbWJlci1lcnJvci1oYW5kbGluZy9pbmRleCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwoKICAgIGV4cG9ydHMuZ2V0T25lcnJvciA9IGdldE9uZXJyb3I7CiAgICBleHBvcnRzLnNldE9uZXJyb3IgPSBzZXRPbmVycm9yOwogICAgZXhwb3J0cy5nZXREaXNwYXRjaE92ZXJyaWRlID0gZ2V0RGlzcGF0Y2hPdmVycmlkZTsKICAgIGV4cG9ydHMuc2V0RGlzcGF0Y2hPdmVycmlkZSA9IHNldERpc3BhdGNoT3ZlcnJpZGU7CiAgICB2YXIgb25lcnJvciA9IHZvaWQgMDsKICAgIHZhciBvbkVycm9yVGFyZ2V0ID0gZXhwb3J0cy5vbkVycm9yVGFyZ2V0ID0gewogICAgICAgIGdldCBvbmVycm9yKCkgewogICAgICAgICAgICByZXR1cm4gb25lcnJvcjsKICAgICAgICB9CiAgICB9OwogICAgLy8gRW1iZXIub25lcnJvciBnZXR0ZXIKICAgIGZ1bmN0aW9uIGdldE9uZXJyb3IoKSB7CiAgICAgICAgcmV0dXJuIG9uZXJyb3I7CiAgICB9CiAgICAvLyBFbWJlci5vbmVycm9yIHNldHRlcgogICAgZnVuY3Rpb24gc2V0T25lcnJvcihoYW5kbGVyKSB7CiAgICAgICAgb25lcnJvciA9IGhhbmRsZXI7CiAgICB9CiAgICB2YXIgZGlzcGF0Y2hPdmVycmlkZSA9IHZvaWQgMDsKICAgIC8vIGFsbG93cyB0ZXN0aW5nIGFkYXB0ZXIgdG8gb3ZlcnJpZGUgZGlzcGF0Y2gKICAgIGZ1bmN0aW9uIGdldERpc3BhdGNoT3ZlcnJpZGUoKSB7CiAgICAgICAgcmV0dXJuIGRpc3BhdGNoT3ZlcnJpZGU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXREaXNwYXRjaE92ZXJyaWRlKGhhbmRsZXIpIHsKICAgICAgICBkaXNwYXRjaE92ZXJyaWRlID0gaGFuZGxlcjsKICAgIH0KICAgIC8vIyBzb3VyY2VNYXBwaW5nVVJMPWluZGV4LmpzLm1hcAp9KTsKZW5pZmVkKCdlbWJlci1leHRlbnNpb24tc3VwcG9ydC9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1leHRlbnNpb24tc3VwcG9ydC9saWIvZGF0YV9hZGFwdGVyJywgJ2VtYmVyLWV4dGVuc2lvbi1zdXBwb3J0L2xpYi9jb250YWluZXJfZGVidWdfYWRhcHRlciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RhdGFfYWRhcHRlciwgX2NvbnRhaW5lcl9kZWJ1Z19hZGFwdGVyKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0RhdGFBZGFwdGVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2RhdGFfYWRhcHRlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQ29udGFpbmVyRGVidWdBZGFwdGVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbnRhaW5lcl9kZWJ1Z19hZGFwdGVyLmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLWV4dGVuc2lvbi1zdXBwb3J0L2xpYi9jb250YWluZXJfZGVidWdfYWRhcHRlcicsIFsnZXhwb3J0cycsICdAZW1iZXIvc3RyaW5nJywgJ2VtYmVyLXJ1bnRpbWUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9zdHJpbmcsIF9lbWJlclJ1bnRpbWUpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICAvKioKICAgICAgVGhlIHJlc29sdmVyIGluc3RhbmNlIG9mIHRoZSBhcHBsaWNhdGlvbgogICAgICBiZWluZyBkZWJ1Z2dlZC4gVGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGluamVjdGVkCiAgICAgIG9uIGNyZWF0aW9uLgogICAgICAgQHByb3BlcnR5IHJlc29sdmVyCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJlc29sdmVyOiBudWxsLAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRydWUgaWYgaXQgaXMgcG9zc2libGUgdG8gY2F0YWxvZyBhIGxpc3Qgb2YgYXZhaWxhYmxlCiAgICAgIGNsYXNzZXMgaW4gdGhlIHJlc29sdmVyIGZvciBhIGdpdmVuIHR5cGUuCiAgICAgICBAbWV0aG9kIGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSB0eXBlLiBlLmcuICJtb2RlbCIsICJjb250cm9sbGVyIiwgInJvdXRlIi4KICAgICAgQHJldHVybiB7Ym9vbGVhbn0gd2hldGhlciBhIGxpc3QgaXMgYXZhaWxhYmxlIGZvciB0aGlzIHR5cGUuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBjYW5DYXRhbG9nRW50cmllc0J5VHlwZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT09ICdtb2RlbCcgfHwgdHlwZSA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgYXZhaWxhYmxlIGNsYXNzZXMgYSBnaXZlbiB0eXBlLgogICAgICAgQG1ldGhvZCBjYXRhbG9nRW50cmllc0J5VHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZS4gZS5nLiAibW9kZWwiLCAiY29udHJvbGxlciIsICJyb3V0ZSIuCiAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBzdHJpbmdzLgogICAgICBAcHVibGljCiAgICAqLwogICAgY2F0YWxvZ0VudHJpZXNCeVR5cGU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIHZhciBuYW1lc3BhY2VzID0gKDAsIF9lbWJlclJ1bnRpbWUuQSkoX2VtYmVyUnVudGltZS5OYW1lc3BhY2UuTkFNRVNQQUNFUyk7CiAgICAgIHZhciB0eXBlcyA9ICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICAgIHZhciB0eXBlU3VmZml4UmVnZXggPSBuZXcgUmVnRXhwKCgwLCBfc3RyaW5nLmNsYXNzaWZ5KSh0eXBlKSArICckJyk7CgogICAgICBuYW1lc3BhY2VzLmZvckVhY2goZnVuY3Rpb24gKG5hbWVzcGFjZSkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lc3BhY2UpIHsKICAgICAgICAgIGlmICghbmFtZXNwYWNlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZVN1ZmZpeFJlZ2V4LnRlc3Qoa2V5KSkgewogICAgICAgICAgICB2YXIga2xhc3MgPSBuYW1lc3BhY2Vba2V5XTsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJSdW50aW1lLnR5cGVPZikoa2xhc3MpID09PSAnY2xhc3MnKSB7CiAgICAgICAgICAgICAgdHlwZXMucHVzaCgoMCwgX3N0cmluZy5kYXNoZXJpemUpKGtleS5yZXBsYWNlKHR5cGVTdWZmaXhSZWdleCwgJycpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gdHlwZXM7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLWV4dGVuc2lvbi1zdXBwb3J0L2xpYi9kYXRhX2FkYXB0ZXInLCBbJ2V4cG9ydHMnLCAnZW1iZXItb3duZXInLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL3N0cmluZycsICdlbWJlci1ydW50aW1lJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJPd25lciwgX3J1bmxvb3AsIF9lbWJlck1ldGFsLCBfc3RyaW5nLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoewogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLnJlbGVhc2VNZXRob2RzID0gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBUaGUgY29udGFpbmVyLWRlYnVnLWFkYXB0ZXIgd2hpY2ggaXMgdXNlZAogICAgICB0byBsaXN0IGFsbCBtb2RlbHMuCiAgICAgICBAcHJvcGVydHkgY29udGFpbmVyRGVidWdBZGFwdGVyCiAgICAgIEBkZWZhdWx0IHVuZGVmaW5lZAogICAgICBAc2luY2UgMS41LjAKICAgICAgQHB1YmxpYwogICAgKiovCiAgICBjb250YWluZXJEZWJ1Z0FkYXB0ZXI6IHVuZGVmaW5lZCwKCiAgICAvKioKICAgICAgVGhlIG51bWJlciBvZiBhdHRyaWJ1dGVzIHRvIHNlbmQKICAgICAgYXMgY29sdW1ucy4gKEVub3VnaCB0byBtYWtlIHRoZSByZWNvcmQKICAgICAgaWRlbnRpZmlhYmxlKS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSBhdHRyaWJ1dGVMaW1pdAogICAgICBAZGVmYXVsdCAzCiAgICAgIEBzaW5jZSAxLjMuMAogICAgKi8KICAgIGF0dHJpYnV0ZUxpbWl0OiAzLAoKICAgIC8qKgogICAgICAgRW1iZXIgRGF0YSA+IHYxLjAuMC1iZXRhLjE4CiAgICAgICByZXF1aXJlcyBzdHJpbmcgbW9kZWwgbmFtZXMgdG8gYmUgcGFzc2VkCiAgICAgICBhcm91bmQgaW5zdGVhZCBvZiB0aGUgYWN0dWFsIGZhY3Rvcmllcy4KICAgICAgICBUaGlzIGlzIGEgc3RhbXAgZm9yIHRoZSBFbWJlciBJbnNwZWN0b3IKICAgICAgIHRvIGRpZmZlcmVudGlhdGUgYmV0d2VlbiB0aGUgdmVyc2lvbnMKICAgICAgIHRvIGJlIGFibGUgdG8gc3VwcG9ydCBvbGRlciB2ZXJzaW9ucyB0b28uCiAgICAgICAgQHB1YmxpYwogICAgICAgQHByb3BlcnR5IGFjY2VwdHNNb2RlbE5hbWUKICAgICAqLwogICAgYWNjZXB0c01vZGVsTmFtZTogdHJ1ZSwKCiAgICAvKioKICAgICAgU3RvcmVzIGFsbCBtZXRob2RzIHRoYXQgY2xlYXIgb2JzZXJ2ZXJzLgogICAgICBUaGVzZSBtZXRob2RzIHdpbGwgYmUgY2FsbGVkIG9uIGRlc3RydWN0aW9uLgogICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5IHJlbGVhc2VNZXRob2RzCiAgICAgIEBzaW5jZSAxLjMuMAogICAgKi8KICAgIHJlbGVhc2VNZXRob2RzOiAoMCwgX2VtYmVyUnVudGltZS5BKSgpLAoKICAgIC8qKgogICAgICBTcGVjaWZpZXMgaG93IHJlY29yZHMgY2FuIGJlIGZpbHRlcmVkLgogICAgICBSZWNvcmRzIHJldHVybmVkIHdpbGwgbmVlZCB0byBoYXZlIGEgYGZpbHRlclZhbHVlc2AKICAgICAgcHJvcGVydHkgd2l0aCBhIGtleSBmb3IgZXZlcnkgbmFtZSBpbiB0aGUgcmV0dXJuZWQgYXJyYXkuCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgZ2V0RmlsdGVycwogICAgICBAcmV0dXJuIHtBcnJheX0gTGlzdCBvZiBvYmplY3RzIGRlZmluaW5nIGZpbHRlcnMuCiAgICAgICBUaGUgb2JqZWN0IHNob3VsZCBoYXZlIGEgYG5hbWVgIGFuZCBgZGVzY2AgcHJvcGVydHkuCiAgICAqLwogICAgZ2V0RmlsdGVyczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBGZXRjaCB0aGUgbW9kZWwgdHlwZXMgYW5kIG9ic2VydmUgdGhlbSBmb3IgY2hhbmdlcy4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCB3YXRjaE1vZGVsVHlwZXMKICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHR5cGVzQWRkZWQgQ2FsbGJhY2sgdG8gY2FsbCB0byBhZGQgdHlwZXMuCiAgICAgIFRha2VzIGFuIGFycmF5IG9mIG9iamVjdHMgY29udGFpbmluZyB3cmFwcGVkIHR5cGVzIChyZXR1cm5lZCBmcm9tIGB3cmFwTW9kZWxUeXBlYCkuCiAgICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlc1VwZGF0ZWQgQ2FsbGJhY2sgdG8gY2FsbCB3aGVuIGEgdHlwZSBoYXMgY2hhbmdlZC4KICAgICAgVGFrZXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBjb250YWluaW5nIHdyYXBwZWQgdHlwZXMuCiAgICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gTWV0aG9kIHRvIGNhbGwgdG8gcmVtb3ZlIGFsbCBvYnNlcnZlcnMKICAgICovCiAgICB3YXRjaE1vZGVsVHlwZXM6IGZ1bmN0aW9uICh0eXBlc0FkZGVkLCB0eXBlc1VwZGF0ZWQpIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHZhciBtb2RlbFR5cGVzID0gdGhpcy5nZXRNb2RlbFR5cGVzKCk7CiAgICAgIHZhciByZWxlYXNlTWV0aG9kcyA9ICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICAgIHZhciB0eXBlc1RvU2VuZCA9IHZvaWQgMDsKCiAgICAgIHR5cGVzVG9TZW5kID0gbW9kZWxUeXBlcy5tYXAoZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICB2YXIga2xhc3MgPSB0eXBlLmtsYXNzOwogICAgICAgIHZhciB3cmFwcGVkID0gX3RoaXMud3JhcE1vZGVsVHlwZShrbGFzcywgdHlwZS5uYW1lKTsKICAgICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKF90aGlzLm9ic2VydmVNb2RlbFR5cGUodHlwZS5uYW1lLCB0eXBlc1VwZGF0ZWQpKTsKICAgICAgICByZXR1cm4gd3JhcHBlZDsKICAgICAgfSk7CgogICAgICB0eXBlc0FkZGVkKHR5cGVzVG9TZW5kKTsKCiAgICAgIHZhciByZWxlYXNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlbGVhc2VNZXRob2RzLmZvckVhY2goZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICB9KTsKICAgICAgICBfdGhpcy5yZWxlYXNlTWV0aG9kcy5yZW1vdmVPYmplY3QocmVsZWFzZSk7CiAgICAgIH07CiAgICAgIHRoaXMucmVsZWFzZU1ldGhvZHMucHVzaE9iamVjdChyZWxlYXNlKTsKICAgICAgcmV0dXJuIHJlbGVhc2U7CiAgICB9LAogICAgX25hbWVUb0NsYXNzOiBmdW5jdGlvbiAodHlwZSkgewogICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgICB2YXIgRmFjdG9yeSA9IG93bmVyLmZhY3RvcnlGb3IoJ21vZGVsOicgKyB0eXBlKTsKICAgICAgICB0eXBlID0gRmFjdG9yeSAmJiBGYWN0b3J5LmNsYXNzOwogICAgICB9CiAgICAgIHJldHVybiB0eXBlOwogICAgfSwKCgogICAgLyoqCiAgICAgIEZldGNoIHRoZSByZWNvcmRzIG9mIGEgZ2l2ZW4gdHlwZSBhbmQgb2JzZXJ2ZSB0aGVtIGZvciBjaGFuZ2VzLgogICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIHdhdGNoUmVjb3JkcwogICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZSBUaGUgbW9kZWwgbmFtZS4KICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHJlY29yZHNBZGRlZCBDYWxsYmFjayB0byBjYWxsIHRvIGFkZCByZWNvcmRzLgogICAgICBUYWtlcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgd3JhcHBlZCByZWNvcmRzLgogICAgICBUaGUgb2JqZWN0IHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICBjb2x1bW5WYWx1ZXM6IHtPYmplY3R9IFRoZSBrZXkgYW5kIHZhbHVlIG9mIGEgdGFibGUgY2VsbC4KICAgICAgICBvYmplY3Q6IHtPYmplY3R9IFRoZSBhY3R1YWwgcmVjb3JkIG9iamVjdC4KICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHJlY29yZHNVcGRhdGVkIENhbGxiYWNrIHRvIGNhbGwgd2hlbiBhIHJlY29yZCBoYXMgY2hhbmdlZC4KICAgICAgVGFrZXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBjb250YWluaW5nIHdyYXBwZWQgcmVjb3Jkcy4KICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHJlY29yZHNSZW1vdmVkIENhbGxiYWNrIHRvIGNhbGwgd2hlbiBhIHJlY29yZCBoYXMgcmVtb3ZlZC4KICAgICAgVGFrZXMgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICAgIGluZGV4OiBUaGUgYXJyYXkgaW5kZXggd2hlcmUgdGhlIHJlY29yZHMgd2VyZSByZW1vdmVkLgogICAgICAgIGNvdW50OiBUaGUgbnVtYmVyIG9mIHJlY29yZHMgcmVtb3ZlZC4KICAgICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBNZXRob2QgdG8gY2FsbCB0byByZW1vdmUgYWxsIG9ic2VydmVycy4KICAgICovCiAgICB3YXRjaFJlY29yZHM6IGZ1bmN0aW9uIChtb2RlbE5hbWUsIHJlY29yZHNBZGRlZCwgcmVjb3Jkc1VwZGF0ZWQsIHJlY29yZHNSZW1vdmVkKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIHJlbGVhc2VNZXRob2RzID0gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgICAgdmFyIGtsYXNzID0gdGhpcy5fbmFtZVRvQ2xhc3MobW9kZWxOYW1lKTsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmdldFJlY29yZHMoa2xhc3MsIG1vZGVsTmFtZSk7CiAgICAgIHZhciByZWxlYXNlID0gdm9pZCAwOwoKICAgICAgZnVuY3Rpb24gcmVjb3JkVXBkYXRlZCh1cGRhdGVkUmVjb3JkKSB7CiAgICAgICAgcmVjb3Jkc1VwZGF0ZWQoW3VwZGF0ZWRSZWNvcmRdKTsKICAgICAgfQoKICAgICAgdmFyIHJlY29yZHNUb1NlbmQgPSByZWNvcmRzLm1hcChmdW5jdGlvbiAocmVjb3JkKSB7CiAgICAgICAgcmVsZWFzZU1ldGhvZHMucHVzaChfdGhpczIub2JzZXJ2ZVJlY29yZChyZWNvcmQsIHJlY29yZFVwZGF0ZWQpKTsKICAgICAgICByZXR1cm4gX3RoaXMyLndyYXBSZWNvcmQocmVjb3JkKTsKICAgICAgfSk7CgogICAgICB2YXIgY29udGVudERpZENoYW5nZSA9IGZ1bmN0aW9uIChhcnJheSwgaWR4LCByZW1vdmVkQ291bnQsIGFkZGVkQ291bnQpIHsKICAgICAgICBmb3IgKHZhciBpID0gaWR4OyBpIDwgaWR4ICsgYWRkZWRDb3VudDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVjb3JkID0gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KShhcnJheSwgaSk7CiAgICAgICAgICB2YXIgd3JhcHBlZCA9IF90aGlzMi53cmFwUmVjb3JkKHJlY29yZCk7CiAgICAgICAgICByZWxlYXNlTWV0aG9kcy5wdXNoKF90aGlzMi5vYnNlcnZlUmVjb3JkKHJlY29yZCwgcmVjb3JkVXBkYXRlZCkpOwogICAgICAgICAgcmVjb3Jkc0FkZGVkKFt3cmFwcGVkXSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVtb3ZlZENvdW50KSB7CiAgICAgICAgICByZWNvcmRzUmVtb3ZlZChpZHgsIHJlbW92ZWRDb3VudCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIG9ic2VydmVyID0gewogICAgICAgIGRpZENoYW5nZTogY29udGVudERpZENoYW5nZSwKICAgICAgICB3aWxsQ2hhbmdlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH07CiAgICAgICgwLCBfZW1iZXJNZXRhbC5hZGRBcnJheU9ic2VydmVyKShyZWNvcmRzLCB0aGlzLCBvYnNlcnZlcik7CgogICAgICByZWxlYXNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlbGVhc2VNZXRob2RzLmZvckVhY2goZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICB9KTsKICAgICAgICAoMCwgX2VtYmVyTWV0YWwucmVtb3ZlQXJyYXlPYnNlcnZlcikocmVjb3JkcywgX3RoaXMyLCBvYnNlcnZlcik7CiAgICAgICAgX3RoaXMyLnJlbGVhc2VNZXRob2RzLnJlbW92ZU9iamVjdChyZWxlYXNlKTsKICAgICAgfTsKCiAgICAgIHJlY29yZHNBZGRlZChyZWNvcmRzVG9TZW5kKTsKCiAgICAgIHRoaXMucmVsZWFzZU1ldGhvZHMucHVzaE9iamVjdChyZWxlYXNlKTsKICAgICAgcmV0dXJuIHJlbGVhc2U7CiAgICB9LAoKCiAgICAvKioKICAgICAgQ2xlYXIgYWxsIG9ic2VydmVycyBiZWZvcmUgZGVzdHJ1Y3Rpb24KICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3aWxsRGVzdHJveQogICAgKi8KICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMucmVsZWFzZU1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgfSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgRGV0ZWN0IHdoZXRoZXIgYSBjbGFzcyBpcyBhIG1vZGVsLgogICAgICAgVGVzdCB0aGF0IGFnYWluc3QgdGhlIG1vZGVsIGNsYXNzCiAgICAgIG9mIHlvdXIgcGVyc2lzdGVuY2UgbGlicmFyeS4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZGV0ZWN0CiAgICAgIEByZXR1cm4gYm9vbGVhbiBXaGV0aGVyIHRoZSBjbGFzcyBpcyBhIG1vZGVsIGNsYXNzIG9yIG5vdC4KICAgICovCiAgICBkZXRlY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCgogICAgLyoqCiAgICAgIEdldCB0aGUgY29sdW1ucyBmb3IgYSBnaXZlbiBtb2RlbCB0eXBlLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBjb2x1bW5zRm9yVHlwZQogICAgICBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgY29sdW1ucyBvZiB0aGUgZm9sbG93aW5nIGZvcm1hdDoKICAgICAgIG5hbWU6IHtTdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSBjb2x1bW4uCiAgICAgICBkZXNjOiB7U3RyaW5nfSBIdW1hbml6ZWQgZGVzY3JpcHRpb24gKHdoYXQgd291bGQgc2hvdyBpbiBhIHRhYmxlIGNvbHVtbiBuYW1lKS4KICAgICovCiAgICBjb2x1bW5zRm9yVHlwZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBBZGRzIG9ic2VydmVycyB0byBhIG1vZGVsIHR5cGUgY2xhc3MuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIG9ic2VydmVNb2RlbFR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZSBUaGUgbW9kZWwgdHlwZSBuYW1lLgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSB0eXBlc1VwZGF0ZWQgQ2FsbGVkIHdoZW4gYSB0eXBlIGlzIG1vZGlmaWVkLgogICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgdG8gcmVtb3ZlIG9ic2VydmVycy4KICAgICovCgogICAgb2JzZXJ2ZU1vZGVsVHlwZTogZnVuY3Rpb24gKG1vZGVsTmFtZSwgdHlwZXNVcGRhdGVkKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIGtsYXNzID0gdGhpcy5fbmFtZVRvQ2xhc3MobW9kZWxOYW1lKTsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmdldFJlY29yZHMoa2xhc3MsIG1vZGVsTmFtZSk7CgogICAgICBmdW5jdGlvbiBvbkNoYW5nZSgpIHsKICAgICAgICB0eXBlc1VwZGF0ZWQoW3RoaXMud3JhcE1vZGVsVHlwZShrbGFzcywgbW9kZWxOYW1lKV0pOwogICAgICB9CgogICAgICB2YXIgb2JzZXJ2ZXIgPSB7CiAgICAgICAgZGlkQ2hhbmdlOiBmdW5jdGlvbiAoYXJyYXksIGlkeCwgcmVtb3ZlZENvdW50LCBhZGRlZENvdW50KSB7CiAgICAgICAgICAvLyBPbmx5IHJlLWZldGNoIHJlY29yZHMgaWYgdGhlIHJlY29yZCBjb3VudCBjaGFuZ2VkCiAgICAgICAgICAvLyAod2hpY2ggaXMgYWxsIHdlIGNhcmUgYWJvdXQgYXMgZmFyIGFzIG1vZGVsIHR5cGVzIGFyZSBjb25jZXJuZWQpLgogICAgICAgICAgaWYgKHJlbW92ZWRDb3VudCA+IDAgfHwgYWRkZWRDb3VudCA+IDApIHsKICAgICAgICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlT25jZSkoJ2FjdGlvbnMnLCB0aGlzLCBvbkNoYW5nZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB3aWxsQ2hhbmdlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH07CgogICAgICAoMCwgX2VtYmVyTWV0YWwuYWRkQXJyYXlPYnNlcnZlcikocmVjb3JkcywgdGhpcywgb2JzZXJ2ZXIpOwoKICAgICAgdmFyIHJlbGVhc2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5yZW1vdmVBcnJheU9ic2VydmVyKShyZWNvcmRzLCBfdGhpczMsIG9ic2VydmVyKTsKICAgICAgfTsKCiAgICAgIHJldHVybiByZWxlYXNlOwogICAgfSwKCgogICAgLyoqCiAgICAgIFdyYXBzIGEgZ2l2ZW4gbW9kZWwgdHlwZSBhbmQgb2JzZXJ2ZXMgY2hhbmdlcyB0byBpdC4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2Qgd3JhcE1vZGVsVHlwZQogICAgICBAcGFyYW0ge0NsYXNzfSBrbGFzcyBBIG1vZGVsIGNsYXNzLgogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIE5hbWUgb2YgdGhlIGNsYXNzLgogICAgICBAcmV0dXJuIHtPYmplY3R9IENvbnRhaW5zIHRoZSB3cmFwcGVkIHR5cGUgYW5kIHRoZSBmdW5jdGlvbiB0byByZW1vdmUgb2JzZXJ2ZXJzCiAgICAgIEZvcm1hdDoKICAgICAgICB0eXBlOiB7T2JqZWN0fSBUaGUgd3JhcHBlZCB0eXBlLgogICAgICAgICAgVGhlIHdyYXBwZWQgdHlwZSBoYXMgdGhlIGZvbGxvd2luZyBmb3JtYXQ6CiAgICAgICAgICAgIG5hbWU6IHtTdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSB0eXBlLgogICAgICAgICAgICBjb3VudDoge0ludGVnZXJ9IFRoZSBudW1iZXIgb2YgcmVjb3JkcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGNvbHVtbnM6IHtDb2x1bW5zfSBBbiBhcnJheSBvZiBjb2x1bW5zIHRvIGRlc2NyaWJlIHRoZSByZWNvcmQuCiAgICAgICAgICAgIG9iamVjdDoge0NsYXNzfSBUaGUgYWN0dWFsIE1vZGVsIHR5cGUgY2xhc3MuCiAgICAgICAgcmVsZWFzZToge0Z1bmN0aW9ufSBUaGUgZnVuY3Rpb24gdG8gcmVtb3ZlIG9ic2VydmVycy4KICAgICovCiAgICB3cmFwTW9kZWxUeXBlOiBmdW5jdGlvbiAoa2xhc3MsIG5hbWUpIHsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmdldFJlY29yZHMoa2xhc3MsIG5hbWUpOwogICAgICB2YXIgdHlwZVRvU2VuZCA9IHZvaWQgMDsKCiAgICAgIHR5cGVUb1NlbmQgPSB7CiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBjb3VudDogKDAsIF9lbWJlck1ldGFsLmdldCkocmVjb3JkcywgJ2xlbmd0aCcpLAogICAgICAgIGNvbHVtbnM6IHRoaXMuY29sdW1uc0ZvclR5cGUoa2xhc3MpLAogICAgICAgIG9iamVjdDoga2xhc3MKICAgICAgfTsKCiAgICAgIHJldHVybiB0eXBlVG9TZW5kOwogICAgfSwKCgogICAgLyoqCiAgICAgIEZldGNoZXMgYWxsIG1vZGVscyBkZWZpbmVkIGluIHRoZSBhcHBsaWNhdGlvbi4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0TW9kZWxUeXBlcwogICAgICBAcmV0dXJuIHtBcnJheX0gQXJyYXkgb2YgbW9kZWwgdHlwZXMuCiAgICAqLwogICAgZ2V0TW9kZWxUeXBlczogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIHZhciBjb250YWluZXJEZWJ1Z0FkYXB0ZXIgPSB0aGlzLmdldCgnY29udGFpbmVyRGVidWdBZGFwdGVyJyk7CiAgICAgIHZhciB0eXBlcyA9IHZvaWQgMDsKCiAgICAgIGlmIChjb250YWluZXJEZWJ1Z0FkYXB0ZXIuY2FuQ2F0YWxvZ0VudHJpZXNCeVR5cGUoJ21vZGVsJykpIHsKICAgICAgICB0eXBlcyA9IGNvbnRhaW5lckRlYnVnQWRhcHRlci5jYXRhbG9nRW50cmllc0J5VHlwZSgnbW9kZWwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlcyA9IHRoaXMuX2dldE9iamVjdHNPbk5hbWVzcGFjZXMoKTsKICAgICAgfQoKICAgICAgLy8gTmV3IGFkYXB0ZXJzIHJldHVybiBzdHJpbmdzIGluc3RlYWQgb2YgY2xhc3Nlcy4KICAgICAgdHlwZXMgPSAoMCwgX2VtYmVyUnVudGltZS5BKSh0eXBlcykubWFwKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGtsYXNzOiBfdGhpczQuX25hbWVUb0NsYXNzKG5hbWUpLAogICAgICAgICAgbmFtZTogbmFtZQogICAgICAgIH07CiAgICAgIH0pOwogICAgICB0eXBlcyA9ICgwLCBfZW1iZXJSdW50aW1lLkEpKHR5cGVzKS5maWx0ZXIoZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICByZXR1cm4gX3RoaXM0LmRldGVjdCh0eXBlLmtsYXNzKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gKDAsIF9lbWJlclJ1bnRpbWUuQSkodHlwZXMpOwogICAgfSwKCgogICAgLyoqCiAgICAgIExvb3BzIG92ZXIgYWxsIG5hbWVzcGFjZXMgYW5kIGFsbCBvYmplY3RzCiAgICAgIGF0dGFjaGVkIHRvIHRoZW0uCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9nZXRPYmplY3RzT25OYW1lc3BhY2VzCiAgICAgIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBtb2RlbCB0eXBlIHN0cmluZ3MuCiAgICAqLwogICAgX2dldE9iamVjdHNPbk5hbWVzcGFjZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICB2YXIgbmFtZXNwYWNlcyA9ICgwLCBfZW1iZXJSdW50aW1lLkEpKF9lbWJlclJ1bnRpbWUuTmFtZXNwYWNlLk5BTUVTUEFDRVMpOwogICAgICB2YXIgdHlwZXMgPSAoMCwgX2VtYmVyUnVudGltZS5BKSgpOwoKICAgICAgbmFtZXNwYWNlcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lc3BhY2UpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZXNwYWNlKSB7CiAgICAgICAgICBpZiAoIW5hbWVzcGFjZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgLy8gRXZlbiB0aG91Z2ggd2Ugd2lsbCBmaWx0ZXIgYWdhaW4gaW4gYGdldE1vZGVsVHlwZXNgLAogICAgICAgICAgLy8gd2Ugc2hvdWxkIG5vdCBjYWxsIGBsb29rdXBGYWN0b3J5YCBvbiBub24tbW9kZWxzCiAgICAgICAgICBpZiAoIV90aGlzNS5kZXRlY3QobmFtZXNwYWNlW2tleV0pKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSAoMCwgX3N0cmluZy5kYXNoZXJpemUpKGtleSk7CiAgICAgICAgICB0eXBlcy5wdXNoKG5hbWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB0eXBlczsKICAgIH0sCgoKICAgIC8qKgogICAgICBGZXRjaGVzIGFsbCBsb2FkZWQgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRzCiAgICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiByZWNvcmRzLgogICAgICAgVGhpcyBhcnJheSB3aWxsIGJlIG9ic2VydmVkIGZvciBjaGFuZ2VzLAogICAgICAgc28gaXQgc2hvdWxkIHVwZGF0ZSB3aGVuIG5ldyByZWNvcmRzIGFyZSBhZGRlZC9yZW1vdmVkLgogICAgKi8KICAgIGdldFJlY29yZHM6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJSdW50aW1lLkEpKCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgV3JhcHMgYSByZWNvcmQgYW5kIG9ic2VydmVycyBjaGFuZ2VzIHRvIGl0LgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3cmFwUmVjb3JkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWNvcmQgVGhlIHJlY29yZCBpbnN0YW5jZS4KICAgICAgQHJldHVybiB7T2JqZWN0fSBUaGUgd3JhcHBlZCByZWNvcmQuIEZvcm1hdDoKICAgICAgY29sdW1uVmFsdWVzOiB7QXJyYXl9CiAgICAgIHNlYXJjaEtleXdvcmRzOiB7QXJyYXl9CiAgICAqLwogICAgd3JhcFJlY29yZDogZnVuY3Rpb24gKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkVG9TZW5kID0geyBvYmplY3Q6IHJlY29yZCB9OwoKICAgICAgcmVjb3JkVG9TZW5kLmNvbHVtblZhbHVlcyA9IHRoaXMuZ2V0UmVjb3JkQ29sdW1uVmFsdWVzKHJlY29yZCk7CiAgICAgIHJlY29yZFRvU2VuZC5zZWFyY2hLZXl3b3JkcyA9IHRoaXMuZ2V0UmVjb3JkS2V5d29yZHMocmVjb3JkKTsKICAgICAgcmVjb3JkVG9TZW5kLmZpbHRlclZhbHVlcyA9IHRoaXMuZ2V0UmVjb3JkRmlsdGVyVmFsdWVzKHJlY29yZCk7CiAgICAgIHJlY29yZFRvU2VuZC5jb2xvciA9IHRoaXMuZ2V0UmVjb3JkQ29sb3IocmVjb3JkKTsKCiAgICAgIHJldHVybiByZWNvcmRUb1NlbmQ7CiAgICB9LAoKCiAgICAvKioKICAgICAgR2V0cyB0aGUgdmFsdWVzIGZvciBlYWNoIGNvbHVtbi4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0UmVjb3JkQ29sdW1uVmFsdWVzCiAgICAgIEByZXR1cm4ge09iamVjdH0gS2V5cyBzaG91bGQgbWF0Y2ggY29sdW1uIG5hbWVzIGRlZmluZWQKICAgICAgYnkgdGhlIG1vZGVsIHR5cGUuCiAgICAqLwogICAgZ2V0UmVjb3JkQ29sdW1uVmFsdWVzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0sCgoKICAgIC8qKgogICAgICBSZXR1cm5zIGtleXdvcmRzIHRvIG1hdGNoIHdoZW4gc2VhcmNoaW5nIHJlY29yZHMuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldFJlY29yZEtleXdvcmRzCiAgICAgIEByZXR1cm4ge0FycmF5fSBSZWxldmFudCBrZXl3b3JkcyBmb3Igc2VhcmNoLgogICAgKi8KICAgIGdldFJlY29yZEtleXdvcmRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKSgpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIHZhbHVlcyBvZiBmaWx0ZXJzIGRlZmluZWQgYnkgYGdldEZpbHRlcnNgLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRGaWx0ZXJWYWx1ZXMKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlY29yZCBUaGUgcmVjb3JkIGluc3RhbmNlLgogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBmaWx0ZXIgdmFsdWVzLgogICAgKi8KICAgIGdldFJlY29yZEZpbHRlclZhbHVlczogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4ge307CiAgICB9LAoKCiAgICAvKioKICAgICAgRWFjaCByZWNvcmQgY2FuIGhhdmUgYSBjb2xvciB0aGF0IHJlcHJlc2VudHMgaXRzIHN0YXRlLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRSZWNvcmRDb2xvcgogICAgICBAcGFyYW0ge09iamVjdH0gcmVjb3JkIFRoZSByZWNvcmQgaW5zdGFuY2UKICAgICAgQHJldHVybiB7U3RyaW5nfSBUaGUgcmVjb3JkcyBjb2xvci4KICAgICAgICBQb3NzaWJsZSBvcHRpb25zOiBibGFjaywgcmVkLCBibHVlLCBncmVlbi4KICAgICovCiAgICBnZXRSZWNvcmRDb2xvcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgoKICAgIC8qKgogICAgICBPYnNlcnZlcyBhbGwgcmVsZXZhbnQgcHJvcGVydGllcyBhbmQgcmUtc2VuZHMgdGhlIHdyYXBwZWQgcmVjb3JkCiAgICAgIHdoZW4gYSBjaGFuZ2Ugb2NjdXJzLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvYnNlcnZlclJlY29yZAogICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgdG8gcmVtb3ZlIGFsbCBvYnNlcnZlcnMuCiAgICAqLwogICAgb2JzZXJ2ZVJlY29yZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkge307CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLWdsaW1tZXInLCBbJ2V4cG9ydHMnLCAnQGdsaW1tZXIvcnVudGltZScsICdAZ2xpbW1lci91dGlsJywgJ0BnbGltbWVyL25vZGUnLCAnZW1iZXItYmFiZWwnLCAnQGdsaW1tZXIvb3Bjb2RlLWNvbXBpbGVyJywgJ2VtYmVyLW93bmVyJywgJ0BnbGltbWVyL3JlZmVyZW5jZScsICdlbWJlci1ydW50aW1lJywgJ2VtYmVyLXV0aWxzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci12aWV3cycsICdlbWJlci1icm93c2VyLWVudmlyb25tZW50JywgJ0BlbWJlci9pbnN0cnVtZW50YXRpb24nLCAnQGVtYmVyL3NlcnZpY2UnLCAnbm9kZS1tb2R1bGUnLCAnQGVtYmVyL3BvbHlmaWxscycsICdlbWJlci1lbnZpcm9ubWVudCcsICdAZW1iZXIvc3RyaW5nJywgJ0BnbGltbWVyL3dpcmUtZm9ybWF0JywgJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzJywgJ2NvbnRhaW5lcicsICdAZW1iZXIvcnVubG9vcCcsICdyc3ZwJywgJ2VtYmVyLXJvdXRpbmcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9ydW50aW1lLCBfdXRpbCwgX25vZGUsIF9lbWJlckJhYmVsLCBfb3Bjb2RlQ29tcGlsZXIsIF9lbWJlck93bmVyLCBfcmVmZXJlbmNlLCBfZW1iZXJSdW50aW1lLCBfZW1iZXJVdGlscywgX2VtYmVyTWV0YWwsIF9kZWJ1ZywgX2VtYmVyVmlld3MsIF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudCwgX2luc3RydW1lbnRhdGlvbiwgX3NlcnZpY2UsIF9ub2RlTW9kdWxlLCBfcG9seWZpbGxzLCBfZW1iZXJFbnZpcm9ubWVudCwgX3N0cmluZywgX3dpcmVGb3JtYXQsIF9kZXByZWNhdGVkRmVhdHVyZXMsIF9jb250YWluZXIsIF9ydW5sb29wLCBfcnN2cCwgX2VtYmVyUm91dGluZykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuY29tcG9uZW50TWFuYWdlciA9IGV4cG9ydHMuQ09NUE9ORU5UX01BTkFHRVIgPSBleHBvcnRzLkN1c3RvbUNvbXBvbmVudE1hbmFnZXIgPSBleHBvcnRzLk91dGxldFZpZXcgPSBleHBvcnRzLkRlYnVnU3RhY2sgPSBleHBvcnRzLml0ZXJhYmxlRm9yID0gZXhwb3J0cy5JTlZPS0UgPSBleHBvcnRzLlVwZGF0YWJsZVJlZmVyZW5jZSA9IGV4cG9ydHMuQWJzdHJhY3RDb21wb25lbnRNYW5hZ2VyID0gZXhwb3J0cy5fZXhwZXJpbWVudGFsTWFjcm9zID0gZXhwb3J0cy5fcmVnaXN0ZXJNYWNyb3MgPSBleHBvcnRzLnNldHVwQXBwbGljYXRpb25SZWdpc3RyeSA9IGV4cG9ydHMuc2V0dXBFbmdpbmVSZWdpc3RyeSA9IGV4cG9ydHMuc2V0VGVtcGxhdGVzID0gZXhwb3J0cy5nZXRUZW1wbGF0ZXMgPSBleHBvcnRzLmhhc1RlbXBsYXRlID0gZXhwb3J0cy5zZXRUZW1wbGF0ZSA9IGV4cG9ydHMuZ2V0VGVtcGxhdGUgPSBleHBvcnRzLnJlbmRlclNldHRsZWQgPSBleHBvcnRzLl9yZXNldFJlbmRlcmVycyA9IGV4cG9ydHMuSW50ZXJhY3RpdmVSZW5kZXJlciA9IGV4cG9ydHMuSW5lcnRSZW5kZXJlciA9IGV4cG9ydHMuUmVuZGVyZXIgPSBleHBvcnRzLmlzSFRNTFNhZmUgPSBleHBvcnRzLmh0bWxTYWZlID0gZXhwb3J0cy5lc2NhcGVFeHByZXNzaW9uID0gZXhwb3J0cy5TYWZlU3RyaW5nID0gZXhwb3J0cy5FbnZpcm9ubWVudCA9IGV4cG9ydHMuaGVscGVyID0gZXhwb3J0cy5IZWxwZXIgPSBleHBvcnRzLlJPT1RfUkVGID0gZXhwb3J0cy5Db21wb25lbnQgPSBleHBvcnRzLkxpbmtDb21wb25lbnQgPSBleHBvcnRzLlRleHRBcmVhID0gZXhwb3J0cy5UZXh0RmllbGQgPSBleHBvcnRzLkNoZWNrYm94ID0gZXhwb3J0cy50ZW1wbGF0ZSA9IGV4cG9ydHMuUm9vdFRlbXBsYXRlID0gZXhwb3J0cy5Ob2RlRE9NVHJlZUNvbnN0cnVjdGlvbiA9IGV4cG9ydHMuaXNTZXJpYWxpemF0aW9uRmlyc3ROb2RlID0gZXhwb3J0cy5ET01UcmVlQ29uc3RydWN0aW9uID0gZXhwb3J0cy5ET01DaGFuZ2VzID0gdW5kZWZpbmVkOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdET01DaGFuZ2VzJywgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBfcnVudGltZS5ET01DaGFuZ2VzOwogICAgICAgIH0KICAgIH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdET01UcmVlQ29uc3RydWN0aW9uJywgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBfcnVudGltZS5ET01UcmVlQ29uc3RydWN0aW9uOwogICAgICAgIH0KICAgIH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdpc1NlcmlhbGl6YXRpb25GaXJzdE5vZGUnLCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIF91dGlsLmlzU2VyaWFsaXphdGlvbkZpcnN0Tm9kZTsKICAgICAgICB9CiAgICB9KTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTm9kZURPTVRyZWVDb25zdHJ1Y3Rpb24nLCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIF9ub2RlLk5vZGVET01UcmVlQ29uc3RydWN0aW9uOwogICAgICAgIH0KICAgIH0pOwoKICAgIHZhciBfdGVtcGxhdGVPYmplY3QgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsndGVtcGxhdGU6Y29tcG9uZW50cy8tZGVmYXVsdCddLCBbJ3RlbXBsYXRlOmNvbXBvbmVudHMvLWRlZmF1bHQnXSksCiAgICAgICAgX3RlbXBsYXRlT2JqZWN0MiA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWydjb21wb25lbnQ6LWRlZmF1bHQnXSwgWydjb21wb25lbnQ6LWRlZmF1bHQnXSksCiAgICAgICAgX3RlbXBsYXRlT2JqZWN0MyA9ICgwLCBfZW1iZXJCYWJlbC50YWdnZWRUZW1wbGF0ZUxpdGVyYWxMb29zZSkoWyd0ZW1wbGF0ZTotcm9vdCddLCBbJ3RlbXBsYXRlOi1yb290J10pLAogICAgICAgIF90ZW1wbGF0ZU9iamVjdDQgPSAoMCwgX2VtYmVyQmFiZWwudGFnZ2VkVGVtcGxhdGVMaXRlcmFsTG9vc2UpKFsndGVtcGxhdGUtY29tcGlsZXI6bWFpbiddLCBbJ3RlbXBsYXRlLWNvbXBpbGVyOm1haW4nXSk7CgogICAgdmFyIF9Db3JlVmlldyRleHRlbmQ7CgogICAgZnVuY3Rpb24gdGVtcGxhdGUoanNvbikgewogICAgICAgIHJldHVybiBuZXcgRmFjdG9yeVdyYXBwZXIoKDAsIF9vcGNvZGVDb21waWxlci50ZW1wbGF0ZUZhY3RvcnkpKGpzb24pKTsKICAgIH0KCiAgICB2YXIgRmFjdG9yeVdyYXBwZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRmFjdG9yeVdyYXBwZXIoZmFjdG9yeSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEZhY3RvcnlXcmFwcGVyKTsKCiAgICAgICAgICAgIHRoaXMuZmFjdG9yeSA9IGZhY3Rvcnk7CiAgICAgICAgICAgIHRoaXMuaWQgPSBmYWN0b3J5LmlkOwogICAgICAgICAgICB0aGlzLm1ldGEgPSBmYWN0b3J5Lm1ldGE7CiAgICAgICAgfQoKICAgICAgICBGYWN0b3J5V3JhcHBlci5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGluamVjdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKShpbmplY3Rpb25zKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmFjdG9yeS5jcmVhdGUoaW5qZWN0aW9ucy5jb21waWxlciwgeyBvd25lcjogb3duZXIgfSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEZhY3RvcnlXcmFwcGVyOwogICAgfSgpOwoKICAgIHZhciBSb290VGVtcGxhdGUgPSB0ZW1wbGF0ZSh7ICJpZCI6ICJaaTBDQlZ0YyIsICJibG9jayI6ICJ7XCJzeW1ib2xzXCI6W10sXCJzdGF0ZW1lbnRzXCI6W1sxLFsyNyxcImNvbXBvbmVudFwiLFtbMjIsMCxbXV1dLG51bGxdLGZhbHNlXV0sXCJoYXNFdmFsXCI6ZmFsc2V9IiwgIm1ldGEiOiB7ICJtb2R1bGVOYW1lIjogInBhY2thZ2VzL2VtYmVyLWdsaW1tZXIvbGliL3RlbXBsYXRlcy9yb290LmhicyIgfSB9KTsKCiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudAogICAgKi8KICAgIHZhciBSRUNPTVBVVEVfVEFHID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ1JFQ09NUFVURV9UQUcnKTsKICAgIGZ1bmN0aW9uIGlzSGVscGVyRmFjdG9yeShoZWxwZXIpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIGhlbHBlciA9PT0gJ29iamVjdCcgJiYgaGVscGVyICE9PSBudWxsICYmIGhlbHBlci5jbGFzcyAmJiBoZWxwZXIuY2xhc3MuaXNIZWxwZXJGYWN0b3J5OwogICAgfQogICAgZnVuY3Rpb24gaXNTaW1wbGVIZWxwZXIoaGVscGVyKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlci5kZXN0cm95ID09PSB1bmRlZmluZWQ7CiAgICB9CiAgICAvKioKICAgICAgRW1iZXIgSGVscGVycyBhcmUgZnVuY3Rpb25zIHRoYXQgY2FuIGNvbXB1dGUgdmFsdWVzLCBhbmQgYXJlIHVzZWQgaW4gdGVtcGxhdGVzLgogICAgICBGb3IgZXhhbXBsZSwgdGhpcyBjb2RlIGNhbGxzIGEgaGVscGVyIG5hbWVkIGBmb3JtYXQtY3VycmVuY3lgOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPGRpdj57e2Zvcm1hdC1jdXJyZW5jeSBjZW50cyBjdXJyZW5jeT0iJCJ9fTwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBBZGRpdGlvbmFsbHkgYSBoZWxwZXIgY2FuIGJlIGNhbGxlZCBhcyBhIG5lc3RlZCBoZWxwZXIgKHNvbWV0aW1lcyBjYWxsZWQgYQogICAgICBzdWJleHByZXNzaW9uKS4gSW4gdGhpcyBleGFtcGxlLCB0aGUgY29tcHV0ZWQgdmFsdWUgb2YgYSBoZWxwZXIgaXMgcGFzc2VkCiAgICAgIHRvIGEgY29tcG9uZW50IG5hbWVkIGBzaG93LW1vbmV5YDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7c2hvdy1tb25leSBhbW91bnQ9KGZvcm1hdC1jdXJyZW5jeSBjZW50cyBjdXJyZW5jeT0iJCIpfX0KICAgICAgYGBgCiAgICAKICAgICAgSGVscGVycyBkZWZpbmVkIHVzaW5nIGEgY2xhc3MgbXVzdCBwcm92aWRlIGEgYGNvbXB1dGVgIGZ1bmN0aW9uLiBGb3IgZXhhbXBsZToKICAgIAogICAgICBgYGBhcHAvaGVscGVycy9mb3JtYXQtY3VycmVuY3kuanMKICAgICAgaW1wb3J0IEhlbHBlciBmcm9tICdAZW1iZXIvY29tcG9uZW50L2hlbHBlcic7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgSGVscGVyLmV4dGVuZCh7CiAgICAgICAgY29tcHV0ZShbY2VudHNdLCB7IGN1cnJlbmN5IH0pIHsKICAgICAgICAgIHJldHVybiBgJHtjdXJyZW5jeX0ke2NlbnRzICogMC4wMX1gOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIEVhY2ggdGltZSB0aGUgaW5wdXQgdG8gYSBoZWxwZXIgY2hhbmdlcywgdGhlIGBjb21wdXRlYCBmdW5jdGlvbiB3aWxsIGJlCiAgICAgIGNhbGxlZCBhZ2Fpbi4KICAgIAogICAgICBBcyBpbnN0YW5jZXMsIHRoZXNlIGhlbHBlcnMgYWxzbyBoYXZlIGFjY2VzcyB0byB0aGUgY29udGFpbmVyIGFuIHdpbGwgYWNjZXB0CiAgICAgIGluamVjdGVkIGRlcGVuZGVuY2llcy4KICAgIAogICAgICBBZGRpdGlvbmFsbHksIGNsYXNzIGhlbHBlcnMgY2FuIGNhbGwgYHJlY29tcHV0ZWAgdG8gZm9yY2UgYSBuZXcgY29tcHV0YXRpb24uCiAgICAKICAgICAgQGNsYXNzIEhlbHBlcgogICAgICBAcHVibGljCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICovCiAgICB2YXIgSGVscGVyID0gX2VtYmVyUnVudGltZS5GcmFtZXdvcmtPYmplY3QuZXh0ZW5kKHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXNbUkVDT01QVVRFX1RBR10gPSBfcmVmZXJlbmNlLkRpcnR5YWJsZVRhZy5jcmVhdGUoKTsKICAgICAgICB9LAogICAgICAgIHJlY29tcHV0ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzW1JFQ09NUFVURV9UQUddLmlubmVyLmRpcnR5KCk7CiAgICAgICAgfQogICAgfSk7CiAgICBIZWxwZXIuaXNIZWxwZXJGYWN0b3J5ID0gdHJ1ZTsKCiAgICB2YXIgV3JhcHBlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBXcmFwcGVyKGNvbXB1dGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBXcmFwcGVyKTsKCiAgICAgICAgICAgIHRoaXMuY29tcHV0ZSA9IGNvbXB1dGU7CiAgICAgICAgICAgIHRoaXMuaXNIZWxwZXJGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIFdyYXBwZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgICAgICAgLy8gbmVlZHMgbmV3IGluc3RhbmNlIG9yIHdpbGwgbGVhayBjb250YWluZXJzCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBjb21wdXRlOiB0aGlzLmNvbXB1dGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gV3JhcHBlcjsKICAgIH0oKTsKCiAgICAvKioKICAgICAgSW4gbWFueSBjYXNlcywgdGhlIGNlcmVtb255IG9mIGEgZnVsbCBgSGVscGVyYCBjbGFzcyBpcyBub3QgcmVxdWlyZWQuCiAgICAgIFRoZSBgaGVscGVyYCBtZXRob2QgY3JlYXRlIHB1cmUtZnVuY3Rpb24gaGVscGVycyB3aXRob3V0IGluc3RhbmNlcy4gRm9yCiAgICAgIGV4YW1wbGU6CiAgICAKICAgICAgYGBgYXBwL2hlbHBlcnMvZm9ybWF0LWN1cnJlbmN5LmpzCiAgICAgIGltcG9ydCB7IGhlbHBlciB9IGZyb20gJ0BlbWJlci9jb21wb25lbnQvaGVscGVyJzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBoZWxwZXIoZnVuY3Rpb24ocGFyYW1zLCBoYXNoKSB7CiAgICAgICAgbGV0IGNlbnRzID0gcGFyYW1zWzBdOwogICAgICAgIGxldCBjdXJyZW5jeSA9IGhhc2guY3VycmVuY3k7CiAgICAgICAgcmV0dXJuIGAke2N1cnJlbmN5fSR7Y2VudHMgKiAwLjAxfWA7CiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBAc3RhdGljCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGhlbHBlciBUaGUgaGVscGVyIGZ1bmN0aW9uCiAgICAgIEBtZXRob2QgaGVscGVyCiAgICAgIEBmb3IgQGVtYmVyL2NvbXBvbmVudC9oZWxwZXIKICAgICAgQHB1YmxpYwogICAgICBAc2luY2UgMS4xMy4wCiAgICAqLwogICAgZnVuY3Rpb24gaGVscGVyKGhlbHBlckZuKSB7CiAgICAgICAgcmV0dXJuIG5ldyBXcmFwcGVyKGhlbHBlckZuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBfdG9Cb29sKHByZWRpY2F0ZSkgewogICAgICAgIGlmICghcHJlZGljYXRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWRpY2F0ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCgwLCBfZW1iZXJSdW50aW1lLmlzQXJyYXkpKHByZWRpY2F0ZSkpIHsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHByZWRpY2F0ZSwgJ2xlbmd0aCcpICE9PSAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICB2YXIgVVBEQVRFID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ1VQREFURScpOwogICAgdmFyIElOVk9LRSA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdJTlZPS0UnKTsKICAgIHZhciBBQ1RJT04gPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnQUNUSU9OJyk7CiAgICB2YXIgbWF5YmVGcmVlemUgPSB2b2lkIDA7CiAgICBpZiAodHJ1ZSkgewogICAgICAgIC8vIGdhdXJkaW5nIHRoaXMgaW4gYSBERUJVRyBnYXVyZCAoYXMgd2VsbCBhcyBhbGwgaW52b2NhdGlvbnMpCiAgICAgICAgLy8gc28gdGhhdCBpdCBpcyBwcm9wZXJseSBzdHJpcHBlZCBkdXJpbmcgdGhlIG1pbmlmaWNhdGlvbidzCiAgICAgICAgLy8gZGVhZCBjb2RlIGVsaW1pbmF0aW9uCiAgICAgICAgbWF5YmVGcmVlemUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgIC8vIHJlLWZyZWV6aW5nIGFuIGFscmVhZHkgZnJvemVuIG9iamVjdCBpbnRyb2R1Y2VzIGEgc2lnbmlmaWNhbnQKICAgICAgICAgICAgLy8gcGVyZm9ybWFuY2UgcGVuYWx0eSBvbiBDaHJvbWUgKHRlc3RlZCB0aHJvdWdoIDU5KS4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gU2VlOiBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvdjgvaXNzdWVzL2RldGFpbD9pZD02NDUwCiAgICAgICAgICAgIGlmICghT2JqZWN0LmlzRnJvemVuKG9iaikpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUob2JqKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgdmFyIEVtYmVyUGF0aFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBFbWJlclBhdGhSZWZlcmVuY2UoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRW1iZXJQYXRoUmVmZXJlbmNlKTsKICAgICAgICB9CgogICAgICAgIEVtYmVyUGF0aFJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gUHJvcGVydHlSZWZlcmVuY2UuY3JlYXRlKHRoaXMsIGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEVtYmVyUGF0aFJlZmVyZW5jZTsKICAgIH0oKTsKCiAgICB2YXIgQ2FjaGVkUmVmZXJlbmNlJDEgPSBmdW5jdGlvbiAoX0VtYmVyUGF0aFJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQ2FjaGVkUmVmZXJlbmNlJDEsIF9FbWJlclBhdGhSZWZlcmVuY2UpOwoKICAgICAgICBmdW5jdGlvbiBDYWNoZWRSZWZlcmVuY2UkMSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDYWNoZWRSZWZlcmVuY2UkMSk7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0VtYmVyUGF0aFJlZmVyZW5jZS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzLl9sYXN0UmV2aXNpb24gPSBudWxsOwogICAgICAgICAgICBfdGhpcy5fbGFzdFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIF90aGlzOwogICAgICAgIH0KCiAgICAgICAgQ2FjaGVkUmVmZXJlbmNlJDEucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciB0YWcgPSB0aGlzLnRhZywKICAgICAgICAgICAgICAgIF9sYXN0UmV2aXNpb24gPSB0aGlzLl9sYXN0UmV2aXNpb24sCiAgICAgICAgICAgICAgICBfbGFzdFZhbHVlID0gdGhpcy5fbGFzdFZhbHVlOwoKICAgICAgICAgICAgaWYgKF9sYXN0UmV2aXNpb24gPT09IG51bGwgfHwgIXRhZy52YWxpZGF0ZShfbGFzdFJldmlzaW9uKSkgewogICAgICAgICAgICAgICAgX2xhc3RWYWx1ZSA9IHRoaXMuX2xhc3RWYWx1ZSA9IHRoaXMuY29tcHV0ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fbGFzdFJldmlzaW9uID0gdGFnLnZhbHVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9sYXN0VmFsdWU7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENhY2hlZFJlZmVyZW5jZSQxOwogICAgfShFbWJlclBhdGhSZWZlcmVuY2UpOwoKICAgIHZhciBSb290UmVmZXJlbmNlID0gZnVuY3Rpb24gKF9Db25zdFJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUm9vdFJlZmVyZW5jZSwgX0NvbnN0UmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gUm9vdFJlZmVyZW5jZSh2YWx1ZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJvb3RSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzMiA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ29uc3RSZWZlcmVuY2UuY2FsbCh0aGlzLCB2YWx1ZSkpOwoKICAgICAgICAgICAgX3RoaXMyLmNoaWxkcmVuID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMjsKICAgICAgICB9CgogICAgICAgIFJvb3RSZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChwcm9wZXJ0eUtleSkgewogICAgICAgICAgICB2YXIgcmVmID0gdGhpcy5jaGlsZHJlbltwcm9wZXJ0eUtleV07CiAgICAgICAgICAgIGlmIChyZWYgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmVmID0gdGhpcy5jaGlsZHJlbltwcm9wZXJ0eUtleV0gPSBuZXcgUm9vdFByb3BlcnR5UmVmZXJlbmNlKHRoaXMuaW5uZXIsIHByb3BlcnR5S2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBSb290UmVmZXJlbmNlOwogICAgfShfcmVmZXJlbmNlLkNvbnN0UmVmZXJlbmNlKTsKCiAgICB2YXIgX1R3b1dheUZsdXNoRGV0ZWN0aW9uVGFnID0gdm9pZCAwOwogICAgaWYgKHRydWUpIHsKICAgICAgICBfVHdvV2F5Rmx1c2hEZXRlY3Rpb25UYWcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSh0YWcsIGtleSwgcmVmKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IF9yZWZlcmVuY2UuVGFnV3JhcHBlcih0YWcudHlwZSwgbmV3IF9Ud29XYXlGbHVzaERldGVjdGlvblRhZyh0YWcsIGtleSwgcmVmKSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBUd29XYXlGbHVzaERldGVjdGlvblRhZyh0YWcsIGtleSwgcmVmKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnKTsKCiAgICAgICAgICAgICAgICB0aGlzLnRhZyA9IHRhZzsKICAgICAgICAgICAgICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgICAgICAgdGhpcy5yZWYgPSByZWY7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFR3b1dheUZsdXNoRGV0ZWN0aW9uVGFnLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudGFnLnZhbHVlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUd29XYXlGbHVzaERldGVjdGlvblRhZy5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbiB2YWxpZGF0ZSh0aWNrZXQpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudCwKICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleTsKCiAgICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHRoaXMudGFnLnZhbGlkYXRlKHRpY2tldCk7CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCAmJiBwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwuZGlkUmVuZGVyKShwYXJlbnQsIGtleSwgdGhpcy5yZWYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUd29XYXlGbHVzaERldGVjdGlvblRhZy5wcm90b3R5cGUuZGlkQ29tcHV0ZSA9IGZ1bmN0aW9uIGRpZENvbXB1dGUocGFyZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5kaWRSZW5kZXIpKHBhcmVudCwgdGhpcy5rZXksIHRoaXMucmVmKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBUd29XYXlGbHVzaERldGVjdGlvblRhZzsKICAgICAgICB9KCk7CiAgICB9CgogICAgdmFyIFByb3BlcnR5UmVmZXJlbmNlID0gZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UkKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShQcm9wZXJ0eVJlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSQpOwoKICAgICAgICBmdW5jdGlvbiBQcm9wZXJ0eVJlZmVyZW5jZSgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBQcm9wZXJ0eVJlZmVyZW5jZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZSQuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBQcm9wZXJ0eVJlZmVyZW5jZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUocGFyZW50UmVmZXJlbmNlLCBwcm9wZXJ0eUtleSkgewogICAgICAgICAgICBpZiAoKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkocGFyZW50UmVmZXJlbmNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSb290UHJvcGVydHlSZWZlcmVuY2UocGFyZW50UmVmZXJlbmNlLnZhbHVlKCksIHByb3BlcnR5S2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgTmVzdGVkUHJvcGVydHlSZWZlcmVuY2UocGFyZW50UmVmZXJlbmNlLCBwcm9wZXJ0eUtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBQcm9wZXJ0eVJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gbmV3IE5lc3RlZFByb3BlcnR5UmVmZXJlbmNlKHRoaXMsIGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFByb3BlcnR5UmVmZXJlbmNlOwogICAgfShDYWNoZWRSZWZlcmVuY2UkMSk7CgogICAgdmFyIFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfUHJvcGVydHlSZWZlcmVuY2UpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSwgX1Byb3BlcnR5UmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gUm9vdFByb3BlcnR5UmVmZXJlbmNlKHBhcmVudFZhbHVlLCBwcm9wZXJ0eUtleSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSk7CgogICAgICAgICAgICB2YXIgX3RoaXM0ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9Qcm9wZXJ0eVJlZmVyZW5jZS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNC5fcGFyZW50VmFsdWUgPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgX3RoaXM0Ll9wcm9wZXJ0eUtleSA9IHByb3BlcnR5S2V5OwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgX3RoaXM0LnRhZyA9IF9Ud29XYXlGbHVzaERldGVjdGlvblRhZy5jcmVhdGUoKDAsIF9lbWJlck1ldGFsLnRhZ0ZvclByb3BlcnR5KShwYXJlbnRWYWx1ZSwgcHJvcGVydHlLZXkpLCBwcm9wZXJ0eUtleSwgX3RoaXM0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF90aGlzNC50YWcgPSAoMCwgX2VtYmVyTWV0YWwudGFnRm9yUHJvcGVydHkpKHBhcmVudFZhbHVlLCBwcm9wZXJ0eUtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC53YXRjaEtleSkocGFyZW50VmFsdWUsIHByb3BlcnR5S2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX3RoaXM0OwogICAgICAgIH0KCiAgICAgICAgUm9vdFByb3BlcnR5UmVmZXJlbmNlLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgdmFyIF9wYXJlbnRWYWx1ZSA9IHRoaXMuX3BhcmVudFZhbHVlLAogICAgICAgICAgICAgICAgX3Byb3BlcnR5S2V5ID0gdGhpcy5fcHJvcGVydHlLZXk7CgogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy50YWcuaW5uZXIuZGlkQ29tcHV0ZShfcGFyZW50VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShfcGFyZW50VmFsdWUsIF9wcm9wZXJ0eUtleSk7CiAgICAgICAgfTsKCiAgICAgICAgUm9vdFByb3BlcnR5UmVmZXJlbmNlLnByb3RvdHlwZVtVUERBVEVdID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMuX3BhcmVudFZhbHVlLCB0aGlzLl9wcm9wZXJ0eUtleSwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBSb290UHJvcGVydHlSZWZlcmVuY2U7CiAgICB9KFByb3BlcnR5UmVmZXJlbmNlKTsKCiAgICB2YXIgTmVzdGVkUHJvcGVydHlSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX1Byb3BlcnR5UmVmZXJlbmNlMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoTmVzdGVkUHJvcGVydHlSZWZlcmVuY2UsIF9Qcm9wZXJ0eVJlZmVyZW5jZTIpOwoKICAgICAgICBmdW5jdGlvbiBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZShwYXJlbnRSZWZlcmVuY2UsIHByb3BlcnR5S2V5KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTmVzdGVkUHJvcGVydHlSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzNSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfUHJvcGVydHlSZWZlcmVuY2UyLmNhbGwodGhpcykpOwoKICAgICAgICAgICAgdmFyIHBhcmVudFJlZmVyZW5jZVRhZyA9IHBhcmVudFJlZmVyZW5jZS50YWc7CiAgICAgICAgICAgIHZhciBwYXJlbnRPYmplY3RUYWcgPSBfcmVmZXJlbmNlLlVwZGF0YWJsZVRhZy5jcmVhdGUoX3JlZmVyZW5jZS5DT05TVEFOVF9UQUcpOwogICAgICAgICAgICBfdGhpczUuX3BhcmVudFJlZmVyZW5jZSA9IHBhcmVudFJlZmVyZW5jZTsKICAgICAgICAgICAgX3RoaXM1Ll9wYXJlbnRPYmplY3RUYWcgPSBwYXJlbnRPYmplY3RUYWc7CiAgICAgICAgICAgIF90aGlzNS5fcHJvcGVydHlLZXkgPSBwcm9wZXJ0eUtleTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciB0YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbcGFyZW50UmVmZXJlbmNlVGFnLCBwYXJlbnRPYmplY3RUYWddKTsKICAgICAgICAgICAgICAgIF90aGlzNS50YWcgPSBfVHdvV2F5Rmx1c2hEZXRlY3Rpb25UYWcuY3JlYXRlKHRhZywgcHJvcGVydHlLZXksIF90aGlzNSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfdGhpczUudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW3BhcmVudFJlZmVyZW5jZVRhZywgcGFyZW50T2JqZWN0VGFnXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF90aGlzNTsKICAgICAgICB9CgogICAgICAgIE5lc3RlZFByb3BlcnR5UmVmZXJlbmNlLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgdmFyIF9wYXJlbnRSZWZlcmVuY2UgPSB0aGlzLl9wYXJlbnRSZWZlcmVuY2UsCiAgICAgICAgICAgICAgICBfcGFyZW50T2JqZWN0VGFnID0gdGhpcy5fcGFyZW50T2JqZWN0VGFnLAogICAgICAgICAgICAgICAgX3Byb3BlcnR5S2V5ID0gdGhpcy5fcHJvcGVydHlLZXk7CgogICAgICAgICAgICB2YXIgcGFyZW50VmFsdWUgPSBfcGFyZW50UmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgICAgIF9wYXJlbnRPYmplY3RUYWcuaW5uZXIudXBkYXRlKCgwLCBfZW1iZXJNZXRhbC50YWdGb3JQcm9wZXJ0eSkocGFyZW50VmFsdWUsIF9wcm9wZXJ0eUtleSkpOwogICAgICAgICAgICB2YXIgcGFyZW50VmFsdWVUeXBlID0gdHlwZW9mIHBhcmVudFZhbHVlOwogICAgICAgICAgICBpZiAocGFyZW50VmFsdWVUeXBlID09PSAnc3RyaW5nJyAmJiBfcHJvcGVydHlLZXkgPT09ICdsZW5ndGgnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50VmFsdWUubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZVR5cGUgPT09ICdvYmplY3QnICYmIHBhcmVudFZhbHVlICE9PSBudWxsIHx8IHBhcmVudFZhbHVlVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwud2F0Y2hLZXkpKHBhcmVudFZhbHVlLCBfcHJvcGVydHlLZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhZy5pbm5lci5kaWRDb21wdXRlKHBhcmVudFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShwYXJlbnRWYWx1ZSwgX3Byb3BlcnR5S2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBOZXN0ZWRQcm9wZXJ0eVJlZmVyZW5jZS5wcm90b3R5cGVbVVBEQVRFXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50UmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHBhcmVudCwgdGhpcy5fcHJvcGVydHlLZXksIHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTmVzdGVkUHJvcGVydHlSZWZlcmVuY2U7CiAgICB9KFByb3BlcnR5UmVmZXJlbmNlKTsKCiAgICB2YXIgVXBkYXRhYmxlUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9FbWJlclBhdGhSZWZlcmVuY2UyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShVcGRhdGFibGVSZWZlcmVuY2UsIF9FbWJlclBhdGhSZWZlcmVuY2UyKTsKCiAgICAgICAgZnVuY3Rpb24gVXBkYXRhYmxlUmVmZXJlbmNlKHZhbHVlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVXBkYXRhYmxlUmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczYgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0VtYmVyUGF0aFJlZmVyZW5jZTIuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczYudGFnID0gX3JlZmVyZW5jZS5EaXJ0eWFibGVUYWcuY3JlYXRlKCk7CiAgICAgICAgICAgIF90aGlzNi5fdmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzNjsKICAgICAgICB9CgogICAgICAgIFVwZGF0YWJsZVJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlOwogICAgICAgIH07CgogICAgICAgIFVwZGF0YWJsZVJlZmVyZW5jZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBfdmFsdWUgPSB0aGlzLl92YWx1ZTsKCiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gX3ZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRhZy5pbm5lci5kaXJ0eSgpOwogICAgICAgICAgICAgICAgdGhpcy5fdmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBVcGRhdGFibGVSZWZlcmVuY2U7CiAgICB9KEVtYmVyUGF0aFJlZmVyZW5jZSk7CgogICAgdmFyIENvbmRpdGlvbmFsUmVmZXJlbmNlJDEgPSBmdW5jdGlvbiAoX0NvbmRpdGlvbmFsUmVmZXJlbmNlKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShDb25kaXRpb25hbFJlZmVyZW5jZSQxLCBfQ29uZGl0aW9uYWxSZWZlcmVuY2UpOwoKICAgICAgICBDb25kaXRpb25hbFJlZmVyZW5jZSQxLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShyZWZlcmVuY2UpIHsKICAgICAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHJlZmVyZW5jZSkpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJlZmVyZW5jZS52YWx1ZSgpOwogICAgICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJVdGlscy5pc1Byb3h5KSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFJvb3RQcm9wZXJ0eVJlZmVyZW5jZSh2YWx1ZSwgJ2lzVHJ1dGh5Jyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcnVudGltZS5QcmltaXRpdmVSZWZlcmVuY2UuY3JlYXRlKF90b0Jvb2wodmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IENvbmRpdGlvbmFsUmVmZXJlbmNlJDEocmVmZXJlbmNlKTsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBDb25kaXRpb25hbFJlZmVyZW5jZSQxKHJlZmVyZW5jZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbmRpdGlvbmFsUmVmZXJlbmNlJDEpOwoKICAgICAgICAgICAgdmFyIF90aGlzNyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ29uZGl0aW9uYWxSZWZlcmVuY2UuY2FsbCh0aGlzLCByZWZlcmVuY2UpKTsKCiAgICAgICAgICAgIF90aGlzNy5vYmplY3RUYWcgPSBfcmVmZXJlbmNlLlVwZGF0YWJsZVRhZy5jcmVhdGUoX3JlZmVyZW5jZS5DT05TVEFOVF9UQUcpOwogICAgICAgICAgICBfdGhpczcudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW3JlZmVyZW5jZS50YWcsIF90aGlzNy5vYmplY3RUYWddKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzNzsKICAgICAgICB9CgogICAgICAgIENvbmRpdGlvbmFsUmVmZXJlbmNlJDEucHJvdG90eXBlLnRvQm9vbCA9IGZ1bmN0aW9uIHRvQm9vbChwcmVkaWNhdGUpIHsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJVdGlscy5pc1Byb3h5KShwcmVkaWNhdGUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9iamVjdFRhZy5pbm5lci51cGRhdGUoKDAsIF9lbWJlck1ldGFsLnRhZ0ZvclByb3BlcnR5KShwcmVkaWNhdGUsICdpc1RydXRoeScpKTsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShwcmVkaWNhdGUsICdpc1RydXRoeScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5vYmplY3RUYWcuaW5uZXIudXBkYXRlKCgwLCBfZW1iZXJNZXRhbC50YWdGb3IpKHByZWRpY2F0ZSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIF90b0Jvb2wocHJlZGljYXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBDb25kaXRpb25hbFJlZmVyZW5jZSQxOwogICAgfShfcnVudGltZS5Db25kaXRpb25hbFJlZmVyZW5jZSk7CgogICAgdmFyIFNpbXBsZUhlbHBlclJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlJDIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNpbXBsZUhlbHBlclJlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSQyKTsKCiAgICAgICAgU2ltcGxlSGVscGVyUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShoZWxwZXIkJDEsIGFyZ3MpIHsKICAgICAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKGFyZ3MpKSB7CiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25hbCA9IGFyZ3MucG9zaXRpb25hbCwKICAgICAgICAgICAgICAgICAgICBuYW1lZCA9IGFyZ3MubmFtZWQ7CgogICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uYWxWYWx1ZSA9IHBvc2l0aW9uYWwudmFsdWUoKTsKICAgICAgICAgICAgICAgIHZhciBuYW1lZFZhbHVlID0gbmFtZWQudmFsdWUoKTsKICAgICAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgbWF5YmVGcmVlemUocG9zaXRpb25hbFZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBtYXliZUZyZWV6ZShuYW1lZFZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBoZWxwZXIkJDEocG9zaXRpb25hbFZhbHVlLCBuYW1lZFZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZVRvUmVmKHJlc3VsdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFNpbXBsZUhlbHBlclJlZmVyZW5jZShoZWxwZXIkJDEsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gU2ltcGxlSGVscGVyUmVmZXJlbmNlKGhlbHBlciQkMSwgYXJncykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFNpbXBsZUhlbHBlclJlZmVyZW5jZSk7CgogICAgICAgICAgICB2YXIgX3RoaXM4ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRSZWZlcmVuY2UkMi5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzOC50YWcgPSBhcmdzLnRhZzsKICAgICAgICAgICAgX3RoaXM4LmhlbHBlciA9IGhlbHBlciQkMTsKICAgICAgICAgICAgX3RoaXM4LmFyZ3MgPSBhcmdzOwogICAgICAgICAgICByZXR1cm4gX3RoaXM4OwogICAgICAgIH0KCiAgICAgICAgU2ltcGxlSGVscGVyUmVmZXJlbmNlLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciQkMSA9IHRoaXMuaGVscGVyLAogICAgICAgICAgICAgICAgX2FyZ3MyID0gdGhpcy5hcmdzLAogICAgICAgICAgICAgICAgcG9zaXRpb25hbCA9IF9hcmdzMi5wb3NpdGlvbmFsLAogICAgICAgICAgICAgICAgbmFtZWQgPSBfYXJnczIubmFtZWQ7CgogICAgICAgICAgICB2YXIgcG9zaXRpb25hbFZhbHVlID0gcG9zaXRpb25hbC52YWx1ZSgpOwogICAgICAgICAgICB2YXIgbmFtZWRWYWx1ZSA9IG5hbWVkLnZhbHVlKCk7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICBtYXliZUZyZWV6ZShwb3NpdGlvbmFsVmFsdWUpOwogICAgICAgICAgICAgICAgbWF5YmVGcmVlemUobmFtZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhlbHBlciQkMShwb3NpdGlvbmFsVmFsdWUsIG5hbWVkVmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBTaW1wbGVIZWxwZXJSZWZlcmVuY2U7CiAgICB9KENhY2hlZFJlZmVyZW5jZSQxKTsKCiAgICB2YXIgQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlJDMpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkMyk7CgogICAgICAgIENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKGluc3RhbmNlLCBhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZShpbnN0YW5jZSwgYXJncyk7CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZShpbnN0YW5jZSwgYXJncykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENsYXNzQmFzZWRIZWxwZXJSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzOSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ2FjaGVkUmVmZXJlbmNlJDMuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczkudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2luc3RhbmNlW1JFQ09NUFVURV9UQUddLCBhcmdzLnRhZ10pOwogICAgICAgICAgICBfdGhpczkuaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgX3RoaXM5LmFyZ3MgPSBhcmdzOwogICAgICAgICAgICByZXR1cm4gX3RoaXM5OwogICAgICAgIH0KCiAgICAgICAgQ2xhc3NCYXNlZEhlbHBlclJlZmVyZW5jZS5wcm90b3R5cGUuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2UsCiAgICAgICAgICAgICAgICBfYXJnczMgPSB0aGlzLmFyZ3MsCiAgICAgICAgICAgICAgICBwb3NpdGlvbmFsID0gX2FyZ3MzLnBvc2l0aW9uYWwsCiAgICAgICAgICAgICAgICBuYW1lZCA9IF9hcmdzMy5uYW1lZDsKCiAgICAgICAgICAgIHZhciBwb3NpdGlvbmFsVmFsdWUgPSBwb3NpdGlvbmFsLnZhbHVlKCk7CiAgICAgICAgICAgIHZhciBuYW1lZFZhbHVlID0gbmFtZWQudmFsdWUoKTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIG1heWJlRnJlZXplKHBvc2l0aW9uYWxWYWx1ZSk7CiAgICAgICAgICAgICAgICBtYXliZUZyZWV6ZShuYW1lZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuY29tcHV0ZShwb3NpdGlvbmFsVmFsdWUsIG5hbWVkVmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBDbGFzc0Jhc2VkSGVscGVyUmVmZXJlbmNlOwogICAgfShDYWNoZWRSZWZlcmVuY2UkMSk7CgogICAgdmFyIEludGVybmFsSGVscGVyUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UkNCkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkNCk7CgogICAgICAgIGZ1bmN0aW9uIEludGVybmFsSGVscGVyUmVmZXJlbmNlKGhlbHBlciQkMSwgYXJncykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEludGVybmFsSGVscGVyUmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczEwID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRSZWZlcmVuY2UkNC5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzMTAudGFnID0gYXJncy50YWc7CiAgICAgICAgICAgIF90aGlzMTAuaGVscGVyID0gaGVscGVyJCQxOwogICAgICAgICAgICBfdGhpczEwLmFyZ3MgPSBhcmdzOwogICAgICAgICAgICByZXR1cm4gX3RoaXMxMDsKICAgICAgICB9CgogICAgICAgIEludGVybmFsSGVscGVyUmVmZXJlbmNlLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24gY29tcHV0ZSgpIHsKICAgICAgICAgICAgdmFyIGhlbHBlciQkMSA9IHRoaXMuaGVscGVyLAogICAgICAgICAgICAgICAgYXJncyA9IHRoaXMuYXJnczsKCiAgICAgICAgICAgIHJldHVybiBoZWxwZXIkJDEoYXJncyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEludGVybmFsSGVscGVyUmVmZXJlbmNlOwogICAgfShDYWNoZWRSZWZlcmVuY2UkMSk7CgogICAgdmFyIFVuYm91bmRSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX0NvbnN0UmVmZXJlbmNlMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVW5ib3VuZFJlZmVyZW5jZSwgX0NvbnN0UmVmZXJlbmNlMik7CgogICAgICAgIGZ1bmN0aW9uIFVuYm91bmRSZWZlcmVuY2UoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVW5ib3VuZFJlZmVyZW5jZSk7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NvbnN0UmVmZXJlbmNlMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIFVuYm91bmRSZWZlcmVuY2UuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZVRvUmVmKHZhbHVlLCBmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgVW5ib3VuZFJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWVUb1JlZigoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLmlubmVyLCBrZXkpLCBmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFVuYm91bmRSZWZlcmVuY2U7CiAgICB9KF9yZWZlcmVuY2UuQ29uc3RSZWZlcmVuY2UpOwoKICAgIHZhciBSZWFkb25seVJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlJDUpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFJlYWRvbmx5UmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlJDUpOwoKICAgICAgICBmdW5jdGlvbiBSZWFkb25seVJlZmVyZW5jZShpbm5lcikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJlYWRvbmx5UmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczEyID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRSZWZlcmVuY2UkNS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzMTIuaW5uZXIgPSBpbm5lcjsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMTI7CiAgICAgICAgfQoKICAgICAgICBSZWFkb25seVJlZmVyZW5jZS5wcm90b3R5cGUuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlubmVyLnZhbHVlKCk7CiAgICAgICAgfTsKCiAgICAgICAgUmVhZG9ubHlSZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXIuZ2V0KGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShSZWFkb25seVJlZmVyZW5jZSwgW3sKICAgICAgICAgICAga2V5OiAndGFnJywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbm5lci50YWc7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICAgIGtleTogSU5WT0tFLAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlubmVyW0lOVk9LRV07CiAgICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgICAgcmV0dXJuIFJlYWRvbmx5UmVmZXJlbmNlOwogICAgfShDYWNoZWRSZWZlcmVuY2UkMSk7CgogICAgZnVuY3Rpb24gcmVmZXJlbmNlRnJvbVBhcnRzKHJvb3QsIHBhcnRzKSB7CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IHJvb3Q7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICByZWZlcmVuY2UgPSByZWZlcmVuY2UuZ2V0KHBhcnRzW2ldKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlZmVyZW5jZTsKICAgIH0KICAgIGZ1bmN0aW9uIHZhbHVlVG9SZWYodmFsdWUpIHsKICAgICAgICB2YXIgYm91bmQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHRydWU7CgogICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIC8vIHJvb3Qgb2YgaW50ZXJvcCB3aXRoIGVtYmVyIG9iamVjdHMKICAgICAgICAgICAgcmV0dXJuIGJvdW5kID8gbmV3IFJvb3RSZWZlcmVuY2UodmFsdWUpIDogbmV3IFVuYm91bmRSZWZlcmVuY2UodmFsdWUpOwogICAgICAgIH0KICAgICAgICAvLyBlbWJlciBkb2Vzbid0IGRvIG9ic2VydmluZyB3aXRoIGZ1bmN0aW9ucwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVbmJvdW5kUmVmZXJlbmNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9ydW50aW1lLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUodmFsdWUpOwogICAgfQoKICAgIHZhciBESVJUWV9UQUcgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnRElSVFlfVEFHJyk7CiAgICB2YXIgQVJHUyA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdBUkdTJyk7CiAgICB2YXIgUk9PVF9SRUYgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnUk9PVF9SRUYnKTsKICAgIHZhciBJU19ESVNQQVRDSElOR19BVFRSUyA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdJU19ESVNQQVRDSElOR19BVFRSUycpOwogICAgdmFyIEhBU19CTE9DSyA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdIQVNfQkxPQ0snKTsKICAgIHZhciBCT1VORFMgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnQk9VTkRTJyk7CiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudAogICAgKi8KICAgIC8qKgogICAgICBBIGBDb21wb25lbnRgIGlzIGEgdmlldyB0aGF0IGlzIGNvbXBsZXRlbHkKICAgICAgaXNvbGF0ZWQuIFByb3BlcnRpZXMgYWNjZXNzZWQgaW4gaXRzIHRlbXBsYXRlcyBnbwogICAgICB0byB0aGUgdmlldyBvYmplY3QgYW5kIGFjdGlvbnMgYXJlIHRhcmdldGVkIGF0CiAgICAgIHRoZSB2aWV3IG9iamVjdC4gVGhlcmUgaXMgbm8gYWNjZXNzIHRvIHRoZQogICAgICBzdXJyb3VuZGluZyBjb250ZXh0IG9yIG91dGVyIGNvbnRyb2xsZXI7IGFsbAogICAgICBjb250ZXh0dWFsIGluZm9ybWF0aW9uIG11c3QgYmUgcGFzc2VkIGluLgogICAgCiAgICAgIFRoZSBlYXNpZXN0IHdheSB0byBjcmVhdGUgYSBgQ29tcG9uZW50YCBpcyB2aWEKICAgICAgYSB0ZW1wbGF0ZS4gSWYgeW91IG5hbWUgYSB0ZW1wbGF0ZQogICAgICBgYXBwL2NvbXBvbmVudHMvbXktZm9vLmhic2AsIHlvdSB3aWxsIGJlIGFibGUgdG8gdXNlCiAgICAgIGB7e215LWZvb319YCBpbiBvdGhlciB0ZW1wbGF0ZXMsIHdoaWNoIHdpbGwgbWFrZQogICAgICBhbiBpbnN0YW5jZSBvZiB0aGUgaXNvbGF0ZWQgY29tcG9uZW50LgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWZvby5oYnMKICAgICAge3twZXJzb24tcHJvZmlsZSBwZXJzb249Y3VycmVudFVzZXJ9fQogICAgICBgYGAKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5oYnMKICAgICAgPGgxPnt7cGVyc29uLnRpdGxlfX08L2gxPgogICAgICA8aW1nIHNyYz17e3BlcnNvbi5hdmF0YXJ9fT4KICAgICAgPHAgY2xhc3M9J3NpZ25hdHVyZSc+e3twZXJzb24uc2lnbmF0dXJlfX08L3A+CiAgICAgIGBgYAogICAgCiAgICAgIFlvdSBjYW4gdXNlIGB5aWVsZGAgaW5zaWRlIGEgdGVtcGxhdGUgdG8KICAgICAgaW5jbHVkZSB0aGUgKipjb250ZW50cyoqIG9mIGFueSBibG9jayBhdHRhY2hlZCB0bwogICAgICB0aGUgY29tcG9uZW50LiBUaGUgYmxvY2sgd2lsbCBiZSBleGVjdXRlZCBpbiB0aGUKICAgICAgY29udGV4dCBvZiB0aGUgc3Vycm91bmRpbmcgY29udGV4dCBvciBvdXRlciBjb250cm9sbGVyOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjcGVyc29uLXByb2ZpbGUgcGVyc29uPWN1cnJlbnRVc2VyfX0KICAgICAgICA8cD5BZG1pbiBtb2RlPC9wPgogICAgICAgIHt7ISBFeGVjdXRlZCBpbiB0aGUgY29udHJvbGxlcidzIGNvbnRleHQuIH19CiAgICAgIHt7L3BlcnNvbi1wcm9maWxlfX0KICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuaGJzCiAgICAgIDxoMT57e3BlcnNvbi50aXRsZX19PC9oMT4KICAgICAge3shIEV4ZWN1dGVkIGluIHRoZSBjb21wb25lbnQncyBjb250ZXh0LiB9fQogICAgICB7e3lpZWxkfX0ge3shIGJsb2NrIGNvbnRlbnRzIH19CiAgICAgIGBgYAogICAgCiAgICAgIElmIHlvdSB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgY29tcG9uZW50LCBpbiBvcmRlciB0bwogICAgICBoYW5kbGUgZXZlbnRzIG9yIGFjdGlvbnMsIHlvdSBpbXBsZW1lbnQgYSBzdWJjbGFzcwogICAgICBvZiBgQ29tcG9uZW50YCBuYW1lZCBhZnRlciB0aGUgbmFtZSBvZiB0aGUKICAgICAgY29tcG9uZW50LgogICAgCiAgICAgIEZvciBleGFtcGxlLCB5b3UgY291bGQgaW1wbGVtZW50IHRoZSBhY3Rpb24KICAgICAgYGhlbGxvYCBmb3IgdGhlIGBwZXJzb24tcHJvZmlsZWAgY29tcG9uZW50OgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL3BlcnNvbi1wcm9maWxlLmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgaGVsbG8obmFtZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygiSGVsbG8iLCBuYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBBbmQgdGhlbiB1c2UgaXQgaW4gdGhlIGNvbXBvbmVudCdzIHRlbXBsYXRlOgogICAgCiAgICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5oYnMKICAgICAgPGgxPnt7cGVyc29uLnRpdGxlfX08L2gxPgogICAgICB7e3lpZWxkfX0gPCEtLSBibG9jayBjb250ZW50cyAtLT4KICAgICAgPGJ1dHRvbiB7e2FjdGlvbiAnaGVsbG8nIHBlcnNvbi5uYW1lfX0+CiAgICAgICAgU2F5IEhlbGxvIHRvIHt7cGVyc29uLm5hbWV9fQogICAgICA8L2J1dHRvbj4KICAgICAgYGBgCiAgICAKICAgICAgQ29tcG9uZW50cyBtdXN0IGhhdmUgYSBgLWAgaW4gdGhlaXIgbmFtZSB0byBhdm9pZAogICAgICBjb25mbGljdHMgd2l0aCBidWlsdC1pbiBjb250cm9scyB0aGF0IHdyYXAgSFRNTAogICAgICBlbGVtZW50cy4gVGhpcyBpcyBjb25zaXN0ZW50IHdpdGggdGhlIHNhbWUKICAgICAgcmVxdWlyZW1lbnQgaW4gd2ViIGNvbXBvbmVudHMuCiAgICAKICAgICAgIyMgSFRNTCBUYWcKICAgIAogICAgICBUaGUgZGVmYXVsdCBIVE1MIHRhZyBuYW1lIHVzZWQgZm9yIGEgY29tcG9uZW50J3MgRE9NIHJlcHJlc2VudGF0aW9uIGlzIGBkaXZgLgogICAgICBUaGlzIGNhbiBiZSBjdXN0b21pemVkIGJ5IHNldHRpbmcgdGhlIGB0YWdOYW1lYCBwcm9wZXJ0eS4KICAgICAgVGhlIGZvbGxvd2luZyBjb21wb25lbnQgY2xhc3M6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvZW1waGFzaXplZC1wYXJhZ3JhcGguanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICB0YWdOYW1lOiAnZW0nCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBXb3VsZCByZXN1bHQgaW4gaW5zdGFuY2VzIHdpdGggdGhlIGZvbGxvd2luZyBIVE1MOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGVtIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij48L2VtPgogICAgICBgYGAKICAgIAogICAgICAjIyBIVE1MIGBjbGFzc2AgQXR0cmlidXRlCiAgICAKICAgICAgVGhlIEhUTUwgYGNsYXNzYCBhdHRyaWJ1dGUgb2YgYSBjb21wb25lbnQncyB0YWcgY2FuIGJlIHNldCBieSBwcm92aWRpbmcgYQogICAgICBgY2xhc3NOYW1lc2AgcHJvcGVydHkgdGhhdCBpcyBzZXQgdG8gYW4gYXJyYXkgb2Ygc3RyaW5nczoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGFzc05hbWVzOiBbJ215LWNsYXNzJywgJ215LW90aGVyLWNsYXNzJ10KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVzdWx0IGluIGNvbXBvbmVudCBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBteS1jbGFzcyBteS1vdGhlci1jbGFzcyI+PC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIGBjbGFzc2AgYXR0cmlidXRlIHZhbHVlcyBjYW4gYWxzbyBiZSBzZXQgYnkgcHJvdmlkaW5nIGEgYGNsYXNzTmFtZUJpbmRpbmdzYAogICAgICBwcm9wZXJ0eSBzZXQgdG8gYW4gYXJyYXkgb2YgcHJvcGVydGllcyBuYW1lcyBmb3IgdGhlIGNvbXBvbmVudC4gVGhlIHJldHVybiB2YWx1ZQogICAgICBvZiB0aGVzZSBwcm9wZXJ0aWVzIHdpbGwgYmUgYWRkZWQgYXMgcGFydCBvZiB0aGUgdmFsdWUgZm9yIHRoZSBjb21wb25lbnRzJ3MgYGNsYXNzYAogICAgICBhdHRyaWJ1dGUuIFRoZXNlIHByb3BlcnRpZXMgY2FuIGJlIGNvbXB1dGVkIHByb3BlcnRpZXM6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgIGltcG9ydCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsncHJvcGVydHlBJywgJ3Byb3BlcnR5QiddLAogICAgCiAgICAgICAgcHJvcGVydHlBOiAnZnJvbS1hJywKICAgICAgICBwcm9wZXJ0eUI6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNvbWVMb2dpYykgeyByZXR1cm4gJ2Zyb20tYic7IH0KICAgICAgICB9KQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgV2lsbCByZXN1bHQgaW4gY29tcG9uZW50IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CiAgICAKICAgICAgYGBgaHRtbAogICAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGZyb20tYSBmcm9tLWIiPjwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBJZiB0aGUgdmFsdWUgb2YgYSBjbGFzcyBuYW1lIGJpbmRpbmcgcmV0dXJucyBhIGJvb2xlYW4gdGhlIHByb3BlcnR5IG5hbWUKICAgICAgaXRzZWxmIHdpbGwgYmUgdXNlZCBhcyB0aGUgY2xhc3MgbmFtZSBpZiB0aGUgcHJvcGVydHkgaXMgdHJ1ZS4KICAgICAgVGhlIGNsYXNzIG5hbWUgd2lsbCBub3QgYmUgYWRkZWQgaWYgdGhlIHZhbHVlIGlzIGBmYWxzZWAgb3IgYHVuZGVmaW5lZGAuCiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaG92ZXJlZCddLAogICAgCiAgICAgICAgaG92ZXJlZDogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgV2lsbCByZXN1bHQgaW4gY29tcG9uZW50IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CiAgICAKICAgICAgYGBgaHRtbAogICAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGhvdmVyZWQiPjwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBXaGVuIHVzaW5nIGJvb2xlYW4gY2xhc3MgbmFtZSBiaW5kaW5ncyB5b3UgY2FuIHN1cHBseSBhIHN0cmluZyB2YWx1ZSBvdGhlcgogICAgICB0aGFuIHRoZSBwcm9wZXJ0eSBuYW1lIGZvciB1c2UgYXMgdGhlIGBjbGFzc2AgSFRNTCBhdHRyaWJ1dGUgYnkgYXBwZW5kaW5nIHRoZQogICAgICBwcmVmZXJyZWQgdmFsdWUgYWZ0ZXIgYSAiOiIgY2hhcmFjdGVyIHdoZW4gZGVmaW5pbmcgdGhlIGJpbmRpbmc6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnYXdlc29tZTpzby12ZXJ5LWNvb2wnXSwKICAgIAogICAgICAgIGF3ZXNvbWU6IHRydWUKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVzdWx0IGluIGNvbXBvbmVudCBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBzby12ZXJ5LWNvb2wiPjwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBCb29sZWFuIHZhbHVlIGNsYXNzIG5hbWUgYmluZGluZ3Mgd2hvc2UgcHJvcGVydHkgbmFtZXMgYXJlIGluIGEKICAgICAgY2FtZWxDYXNlLXN0eWxlIGZvcm1hdCB3aWxsIGJlIGNvbnZlcnRlZCB0byBhIGRhc2hlcml6ZWQgZm9ybWF0OgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LXdpZGdldC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzVXJnZW50J10sCiAgICAKICAgICAgICBpc1VyZ2VudDogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgV2lsbCByZXN1bHQgaW4gY29tcG9uZW50IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CiAgICAKICAgICAgYGBgaHRtbAogICAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGlzLXVyZ2VudCI+PC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIENsYXNzIG5hbWUgYmluZGluZ3MgY2FuIGFsc28gcmVmZXIgdG8gb2JqZWN0IHZhbHVlcyB0aGF0IGFyZSBmb3VuZCBieQogICAgICB0cmF2ZXJzaW5nIGEgcGF0aCByZWxhdGl2ZSB0byB0aGUgY29tcG9uZW50IGl0c2VsZjoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ21lc3NhZ2VzLmVtcHR5J10sCiAgICAKICAgICAgICBtZXNzYWdlczogRW1iZXJPYmplY3QuY3JlYXRlKHsKICAgICAgICAgIGVtcHR5OiB0cnVlCiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVzdWx0IGluIGNvbXBvbmVudCBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBlbXB0eSI+PC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIElmIHlvdSB3YW50IHRvIGFkZCBhIGNsYXNzIG5hbWUgZm9yIGEgcHJvcGVydHkgd2hpY2ggZXZhbHVhdGVzIHRvIHRydWUgYW5kCiAgICAgIGFuZCBhIGRpZmZlcmVudCBjbGFzcyBuYW1lIGlmIGl0IGV2YWx1YXRlcyB0byBmYWxzZSwgeW91IGNhbiBwYXNzIGEgYmluZGluZwogICAgICBsaWtlIHRoaXM6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktd2lkZ2V0LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNFbmFibGVkOmVuYWJsZWQ6ZGlzYWJsZWQnXSwKICAgICAgICBpc0VuYWJsZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVzdWx0IGluIGNvbXBvbmVudCBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGRpdiBpZD0iZW1iZXIxIiBjbGFzcz0iZW1iZXItdmlldyBlbmFibGVkIj48L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgV2hlbiBpc0VuYWJsZWQgaXMgYGZhbHNlYCwgdGhlIHJlc3VsdGluZyBIVE1MIHJlcHJlc2VudGF0aW9uIGxvb2tzIGxpa2UKICAgICAgdGhpczoKICAgIAogICAgICBgYGBodG1sCiAgICAgIDxkaXYgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXcgZGlzYWJsZWQiPjwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBUaGlzIHN5bnRheCBvZmZlcnMgdGhlIGNvbnZlbmllbmNlIHRvIGFkZCBhIGNsYXNzIGlmIGEgcHJvcGVydHkgaXMgYGZhbHNlYDoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIAogICAgICAvLyBBcHBsaWVzIG5vIGNsYXNzIHdoZW4gaXNFbmFibGVkIGlzIHRydWUgYW5kIGNsYXNzICdkaXNhYmxlZCcgd2hlbiBpc0VuYWJsZWQgaXMgZmFsc2UKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNFbmFibGVkOjpkaXNhYmxlZCddLAogICAgICAgIGlzRW5hYmxlZDogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgV2lsbCByZXN1bHQgaW4gY29tcG9uZW50IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CiAgICAKICAgICAgYGBgaHRtbAogICAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3Ij48L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgV2hlbiB0aGUgYGlzRW5hYmxlZGAgcHJvcGVydHkgb24gdGhlIGNvbXBvbmVudCBpcyBzZXQgdG8gYGZhbHNlYCwgaXQgd2lsbCByZXN1bHQKICAgICAgaW4gY29tcG9uZW50IGluc3RhbmNlcyB3aXRoIGFuIEhUTUwgcmVwcmVzZW50YXRpb24gb2Y6CiAgICAKICAgICAgYGBgaHRtbAogICAgICA8ZGl2IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IGRpc2FibGVkIj48L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgVXBkYXRlcyB0byB0aGUgdmFsdWUgb2YgYSBjbGFzcyBuYW1lIGJpbmRpbmcgd2lsbCByZXN1bHQgaW4gYXV0b21hdGljCiAgICAgIHVwZGF0ZSBvZiB0aGUgIEhUTUwgYGNsYXNzYCBhdHRyaWJ1dGUgaW4gdGhlIGNvbXBvbmVudCdzIHJlbmRlcmVkIEhUTUwKICAgICAgcmVwcmVzZW50YXRpb24uIElmIHRoZSB2YWx1ZSBiZWNvbWVzIGBmYWxzZWAgb3IgYHVuZGVmaW5lZGAgdGhlIGNsYXNzIG5hbWUKICAgICAgd2lsbCBiZSByZW1vdmVkLgogICAgICBCb3RoIGBjbGFzc05hbWVzYCBhbmQgYGNsYXNzTmFtZUJpbmRpbmdzYCBhcmUgY29uY2F0ZW5hdGVkIHByb3BlcnRpZXMuIFNlZQogICAgICBbRW1iZXJPYmplY3RdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyT2JqZWN0KSBkb2N1bWVudGF0aW9uIGZvciBtb3JlCiAgICAgIGluZm9ybWF0aW9uIGFib3V0IGNvbmNhdGVuYXRlZCBwcm9wZXJ0aWVzLgogICAgCiAgICAgICMjIEhUTUwgQXR0cmlidXRlcwogICAgCiAgICAgIFRoZSBIVE1MIGF0dHJpYnV0ZSBzZWN0aW9uIG9mIGEgY29tcG9uZW50J3MgdGFnIGNhbiBiZSBzZXQgYnkgcHJvdmlkaW5nIGFuCiAgICAgIGBhdHRyaWJ1dGVCaW5kaW5nc2AgcHJvcGVydHkgc2V0IHRvIGFuIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzIG9uIHRoZSBjb21wb25lbnQuCiAgICAgIFRoZSByZXR1cm4gdmFsdWUgb2YgdGhlc2UgcHJvcGVydGllcyB3aWxsIGJlIHVzZWQgYXMgdGhlIHZhbHVlIG9mIHRoZSBjb21wb25lbnQncwogICAgICBIVE1MIGFzc29jaWF0ZWQgYXR0cmlidXRlOgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWFuY2hvci5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIHRhZ05hbWU6ICdhJywKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydocmVmJ10sCiAgICAKICAgICAgICBocmVmOiAnaHR0cDovL2dvb2dsZS5jb20nCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBXaWxsIHJlc3VsdCBpbiBjb21wb25lbnQgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKICAgIAogICAgICBgYGBodG1sCiAgICAgIDxhIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IiBocmVmPSJodHRwOi8vZ29vZ2xlLmNvbSI+PC9hPgogICAgICBgYGAKICAgIAogICAgICBPbmUgcHJvcGVydHkgY2FuIGJlIG1hcHBlZCBvbiB0byBhbm90aGVyIGJ5IHBsYWNpbmcgYSAiOiIgYmV0d2VlbgogICAgICB0aGUgc291cmNlIHByb3BlcnR5IGFuZCB0aGUgZGVzdGluYXRpb24gcHJvcGVydHk6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktYW5jaG9yLmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgdGFnTmFtZTogJ2EnLAogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3VybDpocmVmJ10sCiAgICAKICAgICAgICB1cmw6ICdodHRwOi8vZ29vZ2xlLmNvbScKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVzdWx0IGluIGNvbXBvbmVudCBpbnN0YW5jZXMgd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGEgaWQ9ImVtYmVyMSIgY2xhc3M9ImVtYmVyLXZpZXciIGhyZWY9Imh0dHA6Ly9nb29nbGUuY29tIj48L2E+CiAgICAgIGBgYAogICAgCiAgICAgIE5hbWVzcGFjZWQgYXR0cmlidXRlcyAoZS5nLiBgeGxpbms6aHJlZmApIGFyZSBzdXBwb3J0ZWQsIGJ1dCBoYXZlIHRvIGJlCiAgICAgIG1hcHBlZCwgc2luY2UgYDpgIGlzIG5vdCBhIHZhbGlkIGNoYXJhY3RlciBmb3IgcHJvcGVydGllcyBpbiBKYXZhc2NyaXB0OgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LXVzZS5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIHRhZ05hbWU6ICd1c2UnLAogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3hsaW5rSHJlZjp4bGluazpocmVmJ10sCiAgICAKICAgICAgICB4bGlua0hyZWY6ICcjdHJpYW5nbGUnCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBXaWxsIHJlc3VsdCBpbiBjb21wb25lbnQgaW5zdGFuY2VzIHdpdGggYW4gSFRNTCByZXByZXNlbnRhdGlvbiBvZjoKICAgIAogICAgICBgYGBodG1sCiAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3RyaWFuZ2xlIj48L3VzZT4KICAgICAgYGBgCiAgICAKICAgICAgSWYgdGhlIHJldHVybiB2YWx1ZSBvZiBhbiBgYXR0cmlidXRlQmluZGluZ3NgIG1vbml0b3JlZCBwcm9wZXJ0eSBpcyBhIGJvb2xlYW4KICAgICAgdGhlIGF0dHJpYnV0ZSB3aWxsIGJlIHByZXNlbnQgb3IgYWJzZW50IGRlcGVuZGluZyBvbiB0aGUgdmFsdWU6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktdGV4dC1pbnB1dC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIHRhZ05hbWU6ICdpbnB1dCcsCiAgICAgICAgYXR0cmlidXRlQmluZGluZ3M6IFsnZGlzYWJsZWQnXSwKICAgIAogICAgICAgIGRpc2FibGVkOiBmYWxzZQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgV2lsbCByZXN1bHQgaW4gYSBjb21wb25lbnQgaW5zdGFuY2Ugd2l0aCBhbiBIVE1MIHJlcHJlc2VudGF0aW9uIG9mOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGlucHV0IGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci12aWV3IiAvPgogICAgICBgYGAKICAgIAogICAgICBgYXR0cmlidXRlQmluZGluZ3NgIGNhbiByZWZlciB0byBjb21wdXRlZCBwcm9wZXJ0aWVzOgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LXRleHQtaW5wdXQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICB0YWdOYW1lOiAnaW5wdXQnLAogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2Rpc2FibGVkJ10sCiAgICAKICAgICAgICBkaXNhYmxlZDogY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc29tZUxvZ2ljKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBUbyBwcmV2ZW50IHNldHRpbmcgYW4gYXR0cmlidXRlIGFsdG9nZXRoZXIsIHVzZSBgbnVsbGAgb3IgYHVuZGVmaW5lZGAgYXMgdGhlCiAgICAgIHJldHVybiB2YWx1ZSBvZiB0aGUgYGF0dHJpYnV0ZUJpbmRpbmdzYCBtb25pdG9yZWQgcHJvcGVydHk6CiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktdGV4dC1pbnB1dC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIHRhZ05hbWU6ICdmb3JtJywKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydub3ZhbGlkYXRlJ10sCiAgICAgICAgbm92YWxpZGF0ZTogbnVsbAogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgVXBkYXRlcyB0byB0aGUgcHJvcGVydHkgb2YgYW4gYXR0cmlidXRlIGJpbmRpbmcgd2lsbCByZXN1bHQgaW4gYXV0b21hdGljCiAgICAgIHVwZGF0ZSBvZiB0aGUgIEhUTUwgYXR0cmlidXRlIGluIHRoZSBjb21wb25lbnQncyByZW5kZXJlZCBIVE1MIHJlcHJlc2VudGF0aW9uLgogICAgICBgYXR0cmlidXRlQmluZGluZ3NgIGlzIGEgY29uY2F0ZW5hdGVkIHByb3BlcnR5LiBTZWUgW0VtYmVyT2JqZWN0XSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9FbWJlck9iamVjdCkKICAgICAgZG9jdW1lbnRhdGlvbiBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBjb25jYXRlbmF0ZWQgcHJvcGVydGllcy4KICAgIAogICAgICAjIyBMYXlvdXRzCiAgICAKICAgICAgU2VlIFtFbWJlci5UZW1wbGF0ZXMuaGVscGVycy55aWVsZF0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMvbWV0aG9kcy95aWVsZD9hbmNob3I9eWllbGQpCiAgICAgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgCiAgICAgIExheW91dCBjYW4gYmUgdXNlZCB0byB3cmFwIGNvbnRlbnQgaW4gYSBjb21wb25lbnQuIEluIGFkZGl0aW9uCiAgICAgIHRvIHdyYXBwaW5nIGNvbnRlbnQgaW4gYSBDb21wb25lbnQncyB0ZW1wbGF0ZSwgeW91IGNhbiBhbHNvIHVzZQogICAgICB0aGUgcHVibGljIGxheW91dCBBUEkgaW4geW91ciBDb21wb25lbnQgSmF2YVNjcmlwdC4KICAgIAogICAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuaGJzCiAgICAgICAgPGgxPlBlcnNvbidzIFRpdGxlPC9oMT4KICAgICAgICA8ZGl2IGNsYXNzPSdkZXRhaWxzJz57e3lpZWxkfX08L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuanMKICAgICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICAgIGltcG9ydCBsYXlvdXQgZnJvbSAnLi4vdGVtcGxhdGVzL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUnOwogICAgCiAgICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgICBsYXlvdXQKICAgICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgVGhlIGFib3ZlIHdpbGwgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTCBvdXRwdXQ6CiAgICAKICAgICAgYGBgaHRtbAogICAgICAgIDxoMT5QZXJzb24ncyBUaXRsZTwvaDE+CiAgICAgICAgPGRpdiBjbGFzcz0iZGV0YWlscyI+CiAgICAgICAgICA8aDI+Q2hpZWYgQmFza2V0IFdlYXZlcjwvaDI+CiAgICAgICAgICA8aDM+RmlzaGVybWFuIEluZHVzdHJpZXM8L2gzPgogICAgICAgIDwvZGl2PgogICAgICBgYGAKICAgIAogICAgICAjIyBSZXNwb25kaW5nIHRvIEJyb3dzZXIgRXZlbnRzCiAgICAKICAgICAgQ29tcG9uZW50cyBjYW4gcmVzcG9uZCB0byB1c2VyLWluaXRpYXRlZCBldmVudHMgaW4gb25lIG9mIHRocmVlIHdheXM6IG1ldGhvZAogICAgICBpbXBsZW1lbnRhdGlvbiwgdGhyb3VnaCBhbiBldmVudCBtYW5hZ2VyLCBhbmQgdGhyb3VnaCBge3thY3Rpb259fWAgaGVscGVyIHVzZQogICAgICBpbiB0aGVpciB0ZW1wbGF0ZSBvciBsYXlvdXQuCiAgICAKICAgICAgIyMjIE1ldGhvZCBJbXBsZW1lbnRhdGlvbgogICAgCiAgICAgIENvbXBvbmVudHMgY2FuIHJlc3BvbmQgdG8gdXNlci1pbml0aWF0ZWQgZXZlbnRzIGJ5IGltcGxlbWVudGluZyBhIG1ldGhvZCB0aGF0CiAgICAgIG1hdGNoZXMgdGhlIGV2ZW50IG5hbWUuIEEgYGpRdWVyeS5FdmVudGAgb2JqZWN0IHdpbGwgYmUgcGFzc2VkIGFzIHRoZQogICAgICBhcmd1bWVudCB0byB0aGlzIG1ldGhvZC4KICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS13aWRnZXQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGljayhldmVudCkgewogICAgICAgICAgLy8gd2lsbCBiZSBjYWxsZWQgd2hlbiBhbiBpbnN0YW5jZSdzCiAgICAgICAgICAvLyByZW5kZXJlZCBlbGVtZW50IGlzIGNsaWNrZWQKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICAjIyMgYHt7YWN0aW9ufX1gIEhlbHBlcgogICAgCiAgICAgIFNlZSBbRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMuYWN0aW9uXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9FbWJlci5UZW1wbGF0ZXMuaGVscGVycy9tZXRob2RzL3lpZWxkP2FuY2hvcj15aWVsZCkuCiAgICAKICAgICAgIyMjIEV2ZW50IE5hbWVzCiAgICAKICAgICAgQWxsIG9mIHRoZSBldmVudCBoYW5kbGluZyBhcHByb2FjaGVzIGRlc2NyaWJlZCBhYm92ZSByZXNwb25kIHRvIHRoZSBzYW1lIHNldAogICAgICBvZiBldmVudHMuIFRoZSBuYW1lcyBvZiB0aGUgYnVpbHQtaW4gZXZlbnRzIGFyZSBsaXN0ZWQgYmVsb3cuIChUaGUgaGFzaCBvZgogICAgICBidWlsdC1pbiBldmVudHMgZXhpc3RzIGluIGBFbWJlci5FdmVudERpc3BhdGNoZXJgLikgQWRkaXRpb25hbCwgY3VzdG9tIGV2ZW50cwogICAgICBjYW4gYmUgcmVnaXN0ZXJlZCBieSB1c2luZyBgQXBwbGljYXRpb24uY3VzdG9tRXZlbnRzYC4KICAgIAogICAgICBUb3VjaCBldmVudHM6CiAgICAKICAgICAgKiBgdG91Y2hTdGFydGAKICAgICAgKiBgdG91Y2hNb3ZlYAogICAgICAqIGB0b3VjaEVuZGAKICAgICAgKiBgdG91Y2hDYW5jZWxgCiAgICAKICAgICAgS2V5Ym9hcmQgZXZlbnRzOgogICAgCiAgICAgICogYGtleURvd25gCiAgICAgICogYGtleVVwYAogICAgICAqIGBrZXlQcmVzc2AKICAgIAogICAgICBNb3VzZSBldmVudHM6CiAgICAKICAgICAgKiBgbW91c2VEb3duYAogICAgICAqIGBtb3VzZVVwYAogICAgICAqIGBjb250ZXh0TWVudWAKICAgICAgKiBgY2xpY2tgCiAgICAgICogYGRvdWJsZUNsaWNrYAogICAgICAqIGBtb3VzZU1vdmVgCiAgICAgICogYGZvY3VzSW5gCiAgICAgICogYGZvY3VzT3V0YAogICAgICAqIGBtb3VzZUVudGVyYAogICAgICAqIGBtb3VzZUxlYXZlYAogICAgCiAgICAgIEZvcm0gZXZlbnRzOgogICAgCiAgICAgICogYHN1Ym1pdGAKICAgICAgKiBgY2hhbmdlYAogICAgICAqIGBmb2N1c0luYAogICAgICAqIGBmb2N1c091dGAKICAgICAgKiBgaW5wdXRgCiAgICAKICAgICAgSFRNTDUgZHJhZyBhbmQgZHJvcCBldmVudHM6CiAgICAKICAgICAgKiBgZHJhZ1N0YXJ0YAogICAgICAqIGBkcmFnYAogICAgICAqIGBkcmFnRW50ZXJgCiAgICAgICogYGRyYWdMZWF2ZWAKICAgICAgKiBgZHJhZ092ZXJgCiAgICAgICogYGRyYWdFbmRgCiAgICAgICogYGRyb3BgCiAgICAKICAgICAgQGNsYXNzIENvbXBvbmVudAogICAgICBAZXh0ZW5kcyBFbWJlci5Db3JlVmlldwogICAgICBAdXNlcyBFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0CiAgICAgIEB1c2VzIEVtYmVyLkNsYXNzTmFtZXNTdXBwb3J0CiAgICAgIEB1c2VzIEVtYmVyLkFjdGlvblN1cHBvcnQKICAgICAgQHVzZXMgRW1iZXIuVmlld01peGluCiAgICAgIEB1c2VzIEVtYmVyLlZpZXdTdGF0ZVN1cHBvcnQKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHZhciBDb21wb25lbnQgPSBfZW1iZXJWaWV3cy5Db3JlVmlldy5leHRlbmQoX2VtYmVyVmlld3MuQ2hpbGRWaWV3c1N1cHBvcnQsIF9lbWJlclZpZXdzLlZpZXdTdGF0ZVN1cHBvcnQsIF9lbWJlclZpZXdzLkNsYXNzTmFtZXNTdXBwb3J0LCBfZW1iZXJSdW50aW1lLlRhcmdldEFjdGlvblN1cHBvcnQsIF9lbWJlclZpZXdzLkFjdGlvblN1cHBvcnQsIF9lbWJlclZpZXdzLlZpZXdNaXhpbiwgKF9Db3JlVmlldyRleHRlbmQgPSB7CiAgICAgICAgaXNDb21wb25lbnQ6IHRydWUsCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgX3RoaXMxMyA9IHRoaXM7CgogICAgICAgICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzW0lTX0RJU1BBVENISU5HX0FUVFJTXSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzW0RJUlRZX1RBR10gPSBfcmVmZXJlbmNlLkRpcnR5YWJsZVRhZy5jcmVhdGUoKTsKICAgICAgICAgICAgdGhpc1tST09UX1JFRl0gPSBuZXcgUm9vdFJlZmVyZW5jZSh0aGlzKTsKICAgICAgICAgICAgdGhpc1tCT1VORFNdID0gbnVsbDsKICAgICAgICAgICAgLy8gSWYgaW4gYSB0YWdsZXNzIGNvbXBvbmVudCwgYXNzZXJ0IHRoYXQgbm8gZXZlbnQgaGFuZGxlcnMgYXJlIGRlZmluZWQKICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLnRhZ05hbWUgIT09ICcnIHx8ICF0aGlzLnJlbmRlcmVyLl9kZXN0aW5lZEZvckRPTSB8fCAhZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50RGlzcGF0Y2hlciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikoX3RoaXMxMykubG9va3VwKCdldmVudF9kaXNwYXRjaGVyOm1haW4nKTsKICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBldmVudERpc3BhdGNoZXIgJiYgZXZlbnREaXNwYXRjaGVyLl9maW5hbEV2ZW50cyB8fCB7fTsKICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmb3JpbgogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gZXZlbnRzW2tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfdGhpczEzW21ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBpbmRpY2F0ZSB0aGF0IHRoZSBhc3NlcnRpb24gc2hvdWxkIGJlIHRyaWdnZXJlZAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW4gbm90IGRlZmluZSBhIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBET00gZXZlbnRzIGluIHRoZSBgJyArIHRoaXMgKyAnYCB0YWdsZXNzIGNvbXBvbmVudCBzaW5jZSBpdCBkb2VzblwndCBoYXZlIGFueSBET00gZWxlbWVudC4nLCB0aGlzLnRhZ05hbWUgIT09ICcnIHx8ICF0aGlzLnJlbmRlcmVyLl9kZXN0aW5lZEZvckRPTSB8fCAhZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGV2ZW50RGlzcGF0Y2hlciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikoX3RoaXMxMykubG9va3VwKCdldmVudF9kaXNwYXRjaGVyOm1haW4nKTt2YXIgZXZlbnRzID0gZXZlbnREaXNwYXRjaGVyICYmIGV2ZW50RGlzcGF0Y2hlci5fZmluYWxFdmVudHMgfHwge307Zm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2ROYW1lID0gZXZlbnRzW2tleV07aWYgKHR5cGVvZiBfdGhpczEzW21ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1yZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0oKSkpOwogICAgICAgIH0sCiAgICAgICAgcmVyZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpc1tESVJUWV9UQUddLmlubmVyLmRpcnR5KCk7CiAgICAgICAgICAgIHRoaXMuX3N1cGVyKCk7CiAgICAgICAgfQogICAgfSwgX0NvcmVWaWV3JGV4dGVuZFtfZW1iZXJNZXRhbC5QUk9QRVJUWV9ESURfQ0hBTkdFXSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAodGhpc1tJU19ESVNQQVRDSElOR19BVFRSU10pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgYXJncyA9IHRoaXNbQVJHU107CiAgICAgICAgdmFyIHJlZmVyZW5jZSA9IGFyZ3MgIT09IHVuZGVmaW5lZCA/IGFyZ3Nba2V5XSA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAocmVmZXJlbmNlICE9PSB1bmRlZmluZWQgJiYgcmVmZXJlbmNlW1VQREFURV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZWZlcmVuY2VbVVBEQVRFXSgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBrZXkpKTsKICAgICAgICB9CiAgICB9LCBfQ29yZVZpZXckZXh0ZW5kLmdldEF0dHIgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgLy8gVE9ETyBJbnRpbWF0ZSBBUEkgc2hvdWxkIGJlIGRlcHJlY2F0ZWQKICAgICAgICByZXR1cm4gdGhpcy5nZXQoa2V5KTsKICAgIH0sIF9Db3JlVmlldyRleHRlbmQucmVhZERPTUF0dHIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIC8vIFRPRE8gcmV2aXNpdCB0aGlzCiAgICAgICAgdmFyIGVsZW1lbnQgPSAoMCwgX2VtYmVyVmlld3MuZ2V0Vmlld0VsZW1lbnQpKHRoaXMpOwogICAgICAgIHZhciBpc1NWRyA9IGVsZW1lbnQubmFtZXNwYWNlVVJJID09PSBfcnVudGltZS5TVkdfTkFNRVNQQUNFOwoKICAgICAgICB2YXIgX25vcm1hbGl6ZVByb3BlcnR5ID0gKDAsIF9ydW50aW1lLm5vcm1hbGl6ZVByb3BlcnR5KShlbGVtZW50LCBuYW1lKSwKICAgICAgICAgICAgdHlwZSA9IF9ub3JtYWxpemVQcm9wZXJ0eS50eXBlLAogICAgICAgICAgICBub3JtYWxpemVkID0gX25vcm1hbGl6ZVByb3BlcnR5Lm5vcm1hbGl6ZWQ7CgogICAgICAgIGlmIChpc1NWRyB8fCB0eXBlID09PSAnYXR0cicpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5vcm1hbGl6ZWQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWxlbWVudFtub3JtYWxpemVkXTsKICAgIH0sIF9Db3JlVmlldyRleHRlbmQpKTsKICAgIENvbXBvbmVudC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJ0BlbWJlci9jb21wb25lbnQnOwogICAgfTsKICAgIENvbXBvbmVudC5yZW9wZW5DbGFzcyh7CiAgICAgICAgaXNDb21wb25lbnRGYWN0b3J5OiB0cnVlLAogICAgICAgIHBvc2l0aW9uYWxQYXJhbXM6IFtdCiAgICB9KTsKCiAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUoeyAiaWQiOiAiNWpwMm9PK28iLCAiYmxvY2siOiAie1wic3ltYm9sc1wiOltdLFwic3RhdGVtZW50c1wiOltdLFwiaGFzRXZhbFwiOmZhbHNlfSIsICJtZXRhIjogeyAibW9kdWxlTmFtZSI6ICJwYWNrYWdlcy9lbWJlci1nbGltbWVyL2xpYi90ZW1wbGF0ZXMvZW1wdHkuaGJzIiB9IH0pOwoKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvY29tcG9uZW50CiAgICAqLwogICAgLyoqCiAgICAgIFRoZSBpbnRlcm5hbCBjbGFzcyB1c2VkIHRvIGNyZWF0ZSB0ZXh0IGlucHV0cyB3aGVuIHRoZSBge3tpbnB1dH19YAogICAgICBoZWxwZXIgaXMgdXNlZCB3aXRoIGB0eXBlYCBvZiBgY2hlY2tib3hgLgogICAgCiAgICAgIFNlZSBbRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMuaW5wdXRdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzL21ldGhvZHMvaW5wdXQ/YW5jaG9yPWlucHV0KSAgZm9yIHVzYWdlIGRldGFpbHMuCiAgICAKICAgICAgIyMgRGlyZWN0IG1hbmlwdWxhdGlvbiBvZiBgY2hlY2tlZGAKICAgIAogICAgICBUaGUgYGNoZWNrZWRgIGF0dHJpYnV0ZSBvZiBhbiBgQ2hlY2tib3hgIG9iamVjdCBzaG91bGQgYWx3YXlzIGJlIHNldAogICAgICB0aHJvdWdoIHRoZSBFbWJlciBvYmplY3Qgb3IgYnkgaW50ZXJhY3Rpbmcgd2l0aCBpdHMgcmVuZGVyZWQgZWxlbWVudAogICAgICByZXByZXNlbnRhdGlvbiB2aWEgdGhlIG1vdXNlLCBrZXlib2FyZCwgb3IgdG91Y2guIFVwZGF0aW5nIHRoZSB2YWx1ZSBvZiB0aGUKICAgICAgY2hlY2tib3ggdmlhIGpRdWVyeSB3aWxsIHJlc3VsdCBpbiB0aGUgY2hlY2tlZCB2YWx1ZSBvZiB0aGUgb2JqZWN0IGFuZCBpdHMKICAgICAgZWxlbWVudCBsb3Npbmcgc3luY2hyb25pemF0aW9uLgogICAgCiAgICAgICMjIExheW91dCBhbmQgTGF5b3V0TmFtZSBwcm9wZXJ0aWVzCiAgICAKICAgICAgQmVjYXVzZSBIVE1MIGBpbnB1dGAgZWxlbWVudHMgYXJlIHNlbGYgY2xvc2luZyBgbGF5b3V0YCBhbmQgYGxheW91dE5hbWVgCiAgICAgIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgYXBwbGllZC4KICAgIAogICAgICBAY2xhc3MgQ2hlY2tib3gKICAgICAgQGV4dGVuZHMgQ29tcG9uZW50CiAgICAgIEBwdWJsaWMKICAgICovCiAgICB2YXIgQ2hlY2tib3ggPSBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBsYXlvdXQ6IGxheW91dCwKICAgICAgICBjbGFzc05hbWVzOiBbJ2VtYmVyLWNoZWNrYm94J10sCiAgICAgICAgdGFnTmFtZTogJ2lucHV0JywKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWyd0eXBlJywgJ2NoZWNrZWQnLCAnaW5kZXRlcm1pbmF0ZScsICdkaXNhYmxlZCcsICd0YWJpbmRleCcsICduYW1lJywgJ2F1dG9mb2N1cycsICdyZXF1aXJlZCcsICdmb3JtJ10sCiAgICAgICAgdHlwZTogJ2NoZWNrYm94JywKICAgICAgICBkaXNhYmxlZDogZmFsc2UsCiAgICAgICAgaW5kZXRlcm1pbmF0ZTogZmFsc2UsCiAgICAgICAgZGlkSW5zZXJ0RWxlbWVudDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnZWxlbWVudCcpLmluZGV0ZXJtaW5hdGUgPSAhISgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdpbmRldGVybWluYXRlJyk7CiAgICAgICAgfSwKICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2NoZWNrZWQnLCB0aGlzLmVsZW1lbnQuY2hlY2tlZCk7CiAgICAgICAgfQogICAgfSk7CiAgICBDaGVja2JveC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJ0BlbWJlci9jb21wb25lbnQvY2hlY2tib3gnOwogICAgfTsKCiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL2NvbXBvbmVudAogICAgKi8KICAgIHZhciBpbnB1dFR5cGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGZ1bmN0aW9uIGNhblNldFR5cGVPZklucHV0KHR5cGUpIHsKICAgICAgICBpZiAodHlwZSBpbiBpbnB1dFR5cGVzKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dFR5cGVzW3R5cGVdOwogICAgICAgIH0KICAgICAgICAvLyBpZiBydW5uaW5nIGluIG91dHNpZGUgb2YgYSBicm93c2VyIGFsd2F5cyByZXR1cm4gdGhlCiAgICAgICAgLy8gb3JpZ2luYWwgdHlwZQogICAgICAgIGlmICghX2VtYmVyQnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSkgewogICAgICAgICAgICBpbnB1dFR5cGVzW3R5cGVdID0gdHlwZTsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBpbnB1dFR5cGVUZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5wdXRUeXBlVGVzdEVsZW1lbnQudHlwZSA9IHR5cGU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBpZ25vcmVkCiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnB1dFR5cGVzW3R5cGVdID0gaW5wdXRUeXBlVGVzdEVsZW1lbnQudHlwZSA9PT0gdHlwZTsKICAgIH0KICAgIC8qKgogICAgCiAgICAgIFRoZSBpbnRlcm5hbCBjbGFzcyB1c2VkIHRvIGNyZWF0ZSB0ZXh0IGlucHV0cyB3aGVuIHRoZSBge3tpbnB1dH19YAogICAgICBoZWxwZXIgaXMgdXNlZCB3aXRoIGB0eXBlYCBvZiBgdGV4dGAuCiAgICAKICAgICAgU2VlIFtFbWJlci5UZW1wbGF0ZXMuaGVscGVycy5pbnB1dF0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMvbWV0aG9kcy9pbnB1dD9hbmNob3I9aW5wdXQpICBmb3IgdXNhZ2UgZGV0YWlscy4KICAgIAogICAgICAjIyBMYXlvdXQgYW5kIExheW91dE5hbWUgcHJvcGVydGllcwogICAgCiAgICAgIEJlY2F1c2UgSFRNTCBgaW5wdXRgIGVsZW1lbnRzIGFyZSBzZWxmIGNsb3NpbmcgYGxheW91dGAgYW5kIGBsYXlvdXROYW1lYAogICAgICBwcm9wZXJ0aWVzIHdpbGwgbm90IGJlIGFwcGxpZWQuCiAgICAKICAgICAgQGNsYXNzIFRleHRGaWVsZAogICAgICBAZXh0ZW5kcyBDb21wb25lbnQKICAgICAgQHVzZXMgRW1iZXIuVGV4dFN1cHBvcnQKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHZhciBUZXh0RmllbGQgPSBDb21wb25lbnQuZXh0ZW5kKF9lbWJlclZpZXdzLlRleHRTdXBwb3J0LCB7CiAgICAgICAgbGF5b3V0OiBsYXlvdXQsCiAgICAgICAgY2xhc3NOYW1lczogWydlbWJlci10ZXh0LWZpZWxkJ10sCiAgICAgICAgdGFnTmFtZTogJ2lucHV0JywKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydhY2NlcHQnLCAnYXV0b2NvbXBsZXRlJywgJ2F1dG9zYXZlJywgJ2RpcicsICdmb3JtYWN0aW9uJywgJ2Zvcm1lbmN0eXBlJywgJ2Zvcm1tZXRob2QnLCAnZm9ybW5vdmFsaWRhdGUnLCAnZm9ybXRhcmdldCcsICdoZWlnaHQnLCAnaW5wdXRtb2RlJywgJ2xhbmcnLCAnbGlzdCcsICd0eXBlJywgJ21heCcsICdtaW4nLCAnbXVsdGlwbGUnLCAnbmFtZScsICdwYXR0ZXJuJywgJ3NpemUnLCAnc3RlcCcsICd2YWx1ZScsICd3aWR0aCddLAogICAgICAgIC8qKgogICAgICAgICAgVGhlIGB2YWx1ZWAgYXR0cmlidXRlIG9mIHRoZSBpbnB1dCBlbGVtZW50LiBBcyB0aGUgdXNlciBpbnB1dHMgdGV4dCwgdGhpcwogICAgICAgICAgcHJvcGVydHkgaXMgdXBkYXRlZCBsaXZlLgogICAgICAgICAgICAgQHByb3BlcnR5IHZhbHVlCiAgICAgICAgICBAdHlwZSBTdHJpbmcKICAgICAgICAgIEBkZWZhdWx0ICIiCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICB2YWx1ZTogJycsCiAgICAgICAgLyoqCiAgICAgICAgICBUaGUgYHR5cGVgIGF0dHJpYnV0ZSBvZiB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAgICAgICAgIEBwcm9wZXJ0eSB0eXBlCiAgICAgICAgICBAdHlwZSBTdHJpbmcKICAgICAgICAgIEBkZWZhdWx0ICJ0ZXh0IgogICAgICAgICAgQHB1YmxpYwogICAgICAgICovCiAgICAgICAgdHlwZTogKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKSh7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICd0ZXh0JzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAoX2tleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlID0gJ3RleHQnOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFR5cGVPZklucHV0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgLyoqCiAgICAgICAgICBUaGUgYHNpemVgIG9mIHRoZSB0ZXh0IGZpZWxkIGluIGNoYXJhY3RlcnMuCiAgICAgICAgICAgICBAcHJvcGVydHkgc2l6ZQogICAgICAgICAgQHR5cGUgU3RyaW5nCiAgICAgICAgICBAZGVmYXVsdCBudWxsCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICBzaXplOiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAgVGhlIGBwYXR0ZXJuYCBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudC4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBwYXR0ZXJuCiAgICAgICAgICBAdHlwZSBTdHJpbmcKICAgICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAqLwogICAgICAgIHBhdHRlcm46IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICBUaGUgYG1pbmAgYXR0cmlidXRlIG9mIGlucHV0IGVsZW1lbnQgdXNlZCB3aXRoIGB0eXBlPSJudW1iZXIiYCBvciBgdHlwZT0icmFuZ2UiYC4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBtaW4KICAgICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgICAgQHNpbmNlIDEuNC4wCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICBtaW46IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICBUaGUgYG1heGAgYXR0cmlidXRlIG9mIGlucHV0IGVsZW1lbnQgdXNlZCB3aXRoIGB0eXBlPSJudW1iZXIiYCBvciBgdHlwZT0icmFuZ2UiYC4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBtYXgKICAgICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgICAgQHNpbmNlIDEuNC4wCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICBtYXg6IG51bGwKICAgIH0pOwogICAgVGV4dEZpZWxkLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnQGVtYmVyL2NvbXBvbmVudC90ZXh0LWZpZWxkJzsKICAgIH07CgogICAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9jb21wb25lbnQKICAgICovCiAgICAvKioKICAgICAgYHt7dGV4dGFyZWF9fWAgaW5zZXJ0cyBhIG5ldyBpbnN0YW5jZSBvZiBgPHRleHRhcmVhPmAgdGFnIGludG8gdGhlIHRlbXBsYXRlLgogICAgICBUaGUgYXR0cmlidXRlcyBvZiBge3t0ZXh0YXJlYX19YCBtYXRjaCB0aG9zZSBvZiB0aGUgbmF0aXZlIEhUTUwgdGFncyBhcwogICAgICBjbG9zZWx5IGFzIHBvc3NpYmxlLgogICAgCiAgICAgIFRoZSBmb2xsb3dpbmcgSFRNTCBhdHRyaWJ1dGVzIGNhbiBiZSBzZXQ6CiAgICAKICAgICAgICAqIGB2YWx1ZWAKICAgICAgICAqIGBuYW1lYAogICAgICAgICogYHJvd3NgCiAgICAgICAgKiBgY29sc2AKICAgICAgICAqIGBwbGFjZWhvbGRlcmAKICAgICAgICAqIGBkaXNhYmxlZGAKICAgICAgICAqIGBtYXhsZW5ndGhgCiAgICAgICAgKiBgdGFiaW5kZXhgCiAgICAgICAgKiBgc2VsZWN0aW9uRW5kYAogICAgICAgICogYHNlbGVjdGlvblN0YXJ0YAogICAgICAgICogYGF1dG9jb21wbGV0ZWAKICAgICAgICAqIGBzZWxlY3Rpb25EaXJlY3Rpb25gCiAgICAgICAgKiBgd3JhcGAKICAgICAgICAqIGByZWFkb25seWAKICAgICAgICAqIGBhdXRvZm9jdXNgCiAgICAgICAgKiBgZm9ybWAKICAgICAgICAqIGBzcGVsbGNoZWNrYAogICAgICAgICogYHJlcXVpcmVkYAogICAgCiAgICAgIFdoZW4gc2V0IHRvIGEgcXVvdGVkIHN0cmluZywgdGhlc2UgdmFsdWUgd2lsbCBiZSBkaXJlY3RseSBhcHBsaWVkIHRvIHRoZSBIVE1MCiAgICAgIGVsZW1lbnQuIFdoZW4gbGVmdCB1bnF1b3RlZCwgdGhlc2UgdmFsdWVzIHdpbGwgYmUgYm91bmQgdG8gYSBwcm9wZXJ0eSBvbiB0aGUKICAgICAgdGVtcGxhdGUncyBjdXJyZW50IHJlbmRlcmluZyBjb250ZXh0IChtb3N0IHR5cGljYWxseSBhIGNvbnRyb2xsZXIgaW5zdGFuY2UpLgogICAgCiAgICAgIFVuYm91bmQ6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e3RleHRhcmVhIHZhbHVlPSJMb3RzIG9mIHN0YXRpYyB0ZXh0IHRoYXQgSVNOJ1QgYm91bmQifX0KICAgICAgYGBgCiAgICAKICAgICAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTDoKICAgIAogICAgICBgYGBodG1sCiAgICAgIDx0ZXh0YXJlYSBjbGFzcz0iZW1iZXItdGV4dC1hcmVhIj4KICAgICAgICBMb3RzIG9mIHN0YXRpYyB0ZXh0IHRoYXQgSVNOJ1QgYm91bmQKICAgICAgPC90ZXh0YXJlYT4KICAgICAgYGBgCiAgICAKICAgICAgQm91bmQ6CiAgICAKICAgICAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlLCB0aGUgYHdyaXR0ZW5Xb3Jkc2AgcHJvcGVydHkgb24gdGhlIGFwcGxpY2F0aW9uCiAgICAgIENvbnRyb2xsZXIgd2lsbCBiZSB1cGRhdGVkIGxpdmUgYXMgdGhlIHVzZXIgdHlwZXMgJ0xvdHMgb2YgdGV4dCB0aGF0IElTCiAgICAgIGJvdW5kJyBpbnRvIHRoZSB0ZXh0IGFyZWEgb2YgdGhlaXIgYnJvd3NlcidzIHdpbmRvdy4KICAgIAogICAgICBgYGBhcHAvY29udHJvbGxlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgICB3cml0dGVuV29yZHM6ICJMb3RzIG9mIHRleHQgdGhhdCBJUyBib3VuZCIKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3t0ZXh0YXJlYSB2YWx1ZT13cml0dGVuV29yZHN9fQogICAgICBgYGAKICAgIAogICAgICBXb3VsZCByZXN1bHQgaW4gdGhlIGZvbGxvd2luZyBIVE1MOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPHRleHRhcmVhIGNsYXNzPSJlbWJlci10ZXh0LWFyZWEiPgogICAgICAgIExvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kCiAgICAgIDwvdGV4dGFyZWE+CiAgICAgIGBgYAogICAgCiAgICAgIElmIHlvdSB3YW50ZWQgYSBvbmUgd2F5IGJpbmRpbmcgYmV0d2VlbiB0aGUgdGV4dCBhcmVhIGFuZCBhIGRpdiB0YWcKICAgICAgc29tZXdoZXJlIGVsc2Ugb24geW91ciBzY3JlZW4sIHlvdSBjb3VsZCB1c2UgYG9uZVdheWA6CiAgICAKICAgICAgYGBgYXBwL2NvbnRyb2xsZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBDb250cm9sbGVyIGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAgICAgaW1wb3J0IHsgb25lV2F5IH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29udHJvbGxlci5leHRlbmQoewogICAgICAgIHdyaXR0ZW5Xb3JkczogIkxvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kIiwKICAgIAogICAgICAgIG91dHB1dFdyaXR0ZW5Xb3Jkczogb25lV2F5KCJ3cml0dGVuV29yZHMiKQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e3RleHRhcmVhIHZhbHVlPXdyaXR0ZW5Xb3Jkc319CiAgICAgIDxkaXY+CiAgICAgICAge3tvdXRwdXRXcml0dGVuV29yZHN9fQogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgV291bGQgcmVzdWx0IGluIHRoZSBmb2xsb3dpbmcgSFRNTDoKICAgIAogICAgICBgYGBodG1sCiAgICAgIDx0ZXh0YXJlYSBjbGFzcz0iZW1iZXItdGV4dC1hcmVhIj4KICAgICAgICBMb3RzIG9mIHRleHQgdGhhdCBJUyBib3VuZAogICAgICA8L3RleHRhcmVhPgogICAgICA8LS0gdGhlIGZvbGxvd2luZyBkaXYgd2lsbCBiZSB1cGRhdGVkIGluIHJlYWwgdGltZSBhcyB5b3UgdHlwZSAtLT4KICAgICAgPGRpdj4KICAgICAgICBMb3RzIG9mIHRleHQgdGhhdCBJUyBib3VuZAogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgRmluYWxseSwgdGhpcyBleGFtcGxlIHJlYWxseSBzaG93cyB0aGUgcG93ZXIgYW5kIGVhc2Ugb2YgRW1iZXIgd2hlbiB0d28KICAgICAgcHJvcGVydGllcyBhcmUgYm91bmQgdG8gZWFjaG90aGVyIHZpYSBgYWxpYXNgLiBUeXBlIGludG8KICAgICAgZWl0aGVyIHRleHQgYXJlYSBib3ggYW5kIHRoZXknbGwgYm90aCBzdGF5IGluIHN5bmMuIE5vdGUgdGhhdAogICAgICBgYWxpYXNgIGNvc3RzIG1vcmUgaW4gdGVybXMgb2YgcGVyZm9ybWFuY2UsIHNvIG9ubHkgdXNlIGl0IHdoZW4KICAgICAgeW91ciByZWFsbHkgYmluZGluZyBpbiBib3RoIGRpcmVjdGlvbnM6CiAgICAKICAgICAgYGBgYXBwL2NvbnRyb2xsZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBDb250cm9sbGVyIGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAgICAgaW1wb3J0IHsgYWxpYXMgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb250cm9sbGVyLmV4dGVuZCh7CiAgICAgICAgd3JpdHRlbldvcmRzOiAiTG90cyBvZiB0ZXh0IHRoYXQgSVMgYm91bmQiLAogICAgCiAgICAgICAgdHdvV2F5V3JpdHRlbldvcmRzOiBhbGlhcygid3JpdHRlbldvcmRzIikKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3t0ZXh0YXJlYSB2YWx1ZT13cml0dGVuV29yZHN9fQogICAgICB7e3RleHRhcmVhIHZhbHVlPXR3b1dheVdyaXR0ZW5Xb3Jkc319CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPHRleHRhcmVhIGlkPSJlbWJlcjEiIGNsYXNzPSJlbWJlci10ZXh0LWFyZWEiPgogICAgICAgIExvdHMgb2YgdGV4dCB0aGF0IElTIGJvdW5kCiAgICAgIDwvdGV4dGFyZWE+CiAgICAgIDwtLSBib3RoIHVwZGF0ZWQgaW4gcmVhbCB0aW1lIC0tPgogICAgICA8dGV4dGFyZWEgaWQ9ImVtYmVyMiIgY2xhc3M9ImVtYmVyLXRleHQtYXJlYSI+CiAgICAgICAgTG90cyBvZiB0ZXh0IHRoYXQgSVMgYm91bmQKICAgICAgPC90ZXh0YXJlYT4KICAgICAgYGBgCiAgICAKICAgICAgIyMjIEFjdGlvbnMKICAgIAogICAgICBUaGUgaGVscGVyIGNhbiBzZW5kIG11bHRpcGxlIGFjdGlvbnMgYmFzZWQgb24gdXNlciBldmVudHMuCiAgICAgIFRoZSBhY3Rpb24gcHJvcGVydHkgZGVmaW5lcyB0aGUgYWN0aW9uIHdoaWNoIGlzIHNlbmQgd2hlbgogICAgICB0aGUgdXNlciBwcmVzc2VzIHRoZSByZXR1cm4ga2V5LgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3tpbnB1dCBhY3Rpb249InN1Ym1pdCJ9fQogICAgICBgYGAKICAgIAogICAgICBUaGUgaGVscGVyIGFsbG93cyBzb21lIHVzZXIgZXZlbnRzIHRvIHNlbmQgYWN0aW9ucy4KICAgIAogICAgICAqIGBlbnRlcmAKICAgICAgKiBgaW5zZXJ0LW5ld2xpbmVgCiAgICAgICogYGVzY2FwZS1wcmVzc2AKICAgICAgKiBgZm9jdXMtaW5gCiAgICAgICogYGZvY3VzLW91dGAKICAgICAgKiBga2V5LXByZXNzYAogICAgCiAgICAgIEZvciBleGFtcGxlLCBpZiB5b3UgZGVzaXJlIGFuIGFjdGlvbiB0byBiZSBzZW50IHdoZW4gdGhlIGlucHV0IGlzIGJsdXJyZWQsCiAgICAgIHlvdSBvbmx5IG5lZWQgdG8gc2V0dXAgdGhlIGFjdGlvbiBuYW1lIHRvIHRoZSBldmVudCBuYW1lIHByb3BlcnR5LgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3t0ZXh0YXJlYSBmb2N1cy1vdXQ9ImFsZXJ0TWVzc2FnZSJ9fQogICAgICBgYGAKICAgIAogICAgICBTZWUgbW9yZSBhYm91dCBbVGV4dCBTdXBwb3J0IEFjdGlvbnNdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1RleHRBcmVhKQogICAgCiAgICAgICMjIyBFeHRlbnNpb24KICAgIAogICAgICBJbnRlcm5hbGx5LCBge3t0ZXh0YXJlYX19YCBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIGBUZXh0QXJlYWAsIHBhc3NpbmcKICAgICAgYXJndW1lbnRzIGZyb20gdGhlIGhlbHBlciB0byBgVGV4dEFyZWFgJ3MgYGNyZWF0ZWAgbWV0aG9kLiBZb3UgY2FuCiAgICAgIGV4dGVuZCB0aGUgY2FwYWJpbGl0aWVzIG9mIHRleHQgYXJlYXMgaW4geW91ciBhcHBsaWNhdGlvbiBieSByZW9wZW5pbmcgdGhpcwogICAgICBjbGFzcy4gRm9yIGV4YW1wbGUsIGlmIHlvdSBhcmUgYnVpbGRpbmcgYSBCb290c3RyYXAgcHJvamVjdCB3aGVyZSBgZGF0YS0qYAogICAgICBhdHRyaWJ1dGVzIGFyZSB1c2VkLCB5b3UgY2FuIGdsb2JhbGx5IGFkZCBzdXBwb3J0IGZvciBhIGBkYXRhLSpgIGF0dHJpYnV0ZQogICAgICBvbiBhbGwgYHt7dGV4dGFyZWF9fWBzJyBpbiB5b3VyIGFwcCBieSByZW9wZW5pbmcgYFRleHRBcmVhYCBvcgogICAgICBgVGV4dFN1cHBvcnRgIGFuZCBhZGRpbmcgaXQgdG8gdGhlIGBhdHRyaWJ1dGVCaW5kaW5nc2AgY29uY2F0ZW5hdGVkCiAgICAgIHByb3BlcnR5OgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IFRleHRBcmVhIGZyb20gJ0BlbWJlci9jb21wb25lbnQvdGV4dC1hcmVhJzsKICAgIAogICAgICBUZXh0QXJlYS5yZW9wZW4oewogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2RhdGEtZXJyb3InXQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgS2VlcCBpbiBtaW5kIHdoZW4gd3JpdGluZyBgVGV4dEFyZWFgIHN1YmNsYXNzZXMgdGhhdCBgVGV4dEFyZWFgCiAgICAgIGl0c2VsZiBleHRlbmRzIGBDb21wb25lbnRgLiBFeHBlY3QgaXNvbGF0ZWQgY29tcG9uZW50IHNlbWFudGljcywgbm90CiAgICAgIGxlZ2FjeSAxLnggdmlldyBzZW1hbnRpY3MgKGxpa2UgYGNvbnRyb2xsZXJgIGJlaW5nIHByZXNlbnQpLgogICAgCiAgICAgIFNlZSBtb3JlIGFib3V0IFtFbWJlciBjb21wb25lbnRzXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Db21wb25lbnQpCiAgICAKICAgICAgQG1ldGhvZCB0ZXh0YXJlYQogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwYXJhbSB7SGFzaH0gb3B0aW9ucwogICAgICBAcHVibGljCiAgICAqLwogICAgLyoqCiAgICAgIFRoZSBpbnRlcm5hbCBjbGFzcyB1c2VkIHRvIGNyZWF0ZSB0ZXh0YXJlYSBlbGVtZW50IHdoZW4gdGhlIGB7e3RleHRhcmVhfX1gCiAgICAgIGhlbHBlciBpcyB1c2VkLgogICAgCiAgICAgIFNlZSBbRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMudGV4dGFyZWFdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzL21ldGhvZHMvdGV4dGFyZWE/YW5jaG9yPXRleHRhcmVhKSAgZm9yIHVzYWdlIGRldGFpbHMuCiAgICAKICAgICAgIyMgTGF5b3V0IGFuZCBMYXlvdXROYW1lIHByb3BlcnRpZXMKICAgIAogICAgICBCZWNhdXNlIEhUTUwgYHRleHRhcmVhYCBlbGVtZW50cyBkbyBub3QgY29udGFpbiBpbm5lciBIVE1MIHRoZSBgbGF5b3V0YCBhbmQKICAgICAgYGxheW91dE5hbWVgIHByb3BlcnRpZXMgd2lsbCBub3QgYmUgYXBwbGllZC4KICAgIAogICAgICBAY2xhc3MgVGV4dEFyZWEKICAgICAgQGV4dGVuZHMgQ29tcG9uZW50CiAgICAgIEB1c2VzIEVtYmVyLlRleHRTdXBwb3J0CiAgICAgIEBwdWJsaWMKICAgICovCiAgICB2YXIgVGV4dEFyZWEgPSBDb21wb25lbnQuZXh0ZW5kKF9lbWJlclZpZXdzLlRleHRTdXBwb3J0LCB7CiAgICAgICAgY2xhc3NOYW1lczogWydlbWJlci10ZXh0LWFyZWEnXSwKICAgICAgICBsYXlvdXQ6IGxheW91dCwKICAgICAgICB0YWdOYW1lOiAndGV4dGFyZWEnLAogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ3Jvd3MnLCAnY29scycsICduYW1lJywgJ3NlbGVjdGlvbkVuZCcsICdzZWxlY3Rpb25TdGFydCcsICdhdXRvY29tcGxldGUnLCAnd3JhcCcsICdsYW5nJywgJ2RpcicsICd2YWx1ZSddLAogICAgICAgIHJvd3M6IG51bGwsCiAgICAgICAgY29sczogbnVsbAogICAgfSk7CiAgICBUZXh0QXJlYS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJ0BlbWJlci9jb21wb25lbnQvdGV4dC1hcmVhJzsKICAgIH07CgogICAgdmFyIGxheW91dCQxID0gdGVtcGxhdGUoeyAiaWQiOiAiL3RUOE1qQzQiLCAiYmxvY2siOiAie1wic3ltYm9sc1wiOltcIiZkZWZhdWx0XCJdLFwic3RhdGVtZW50c1wiOltbNCxcImlmXCIsW1syMyxbXCJsaW5rVGl0bGVcIl1dXSxudWxsLHtcInN0YXRlbWVudHNcIjpbWzEsWzIxLFwibGlua1RpdGxlXCJdLGZhbHNlXV0sXCJwYXJhbWV0ZXJzXCI6W119LHtcInN0YXRlbWVudHNcIjpbWzE0LDFdXSxcInBhcmFtZXRlcnNcIjpbXX1dXSxcImhhc0V2YWxcIjpmYWxzZX0iLCAibWV0YSI6IHsgIm1vZHVsZU5hbWUiOiAicGFja2FnZXMvZW1iZXItZ2xpbW1lci9saWIvdGVtcGxhdGVzL2xpbmstdG8uaGJzIiB9IH0pOwoKICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBAbW9kdWxlIEBlbWJlci9yb3V0aW5nCiAgICAqLwogICAgLyoqCiAgICAgIGBMaW5rQ29tcG9uZW50YCByZW5kZXJzIGFuIGVsZW1lbnQgd2hvc2UgYGNsaWNrYCBldmVudCB0cmlnZ2VycyBhCiAgICAgIHRyYW5zaXRpb24gb2YgdGhlIGFwcGxpY2F0aW9uJ3MgaW5zdGFuY2Ugb2YgYFJvdXRlcmAgdG8KICAgICAgYSBzdXBwbGllZCByb3V0ZSBieSBuYW1lLgogICAgCiAgICAgIGBMaW5rQ29tcG9uZW50YCBjb21wb25lbnRzIGFyZSBpbnZva2VkIHdpdGgge3sjbGluay10b319LiBQcm9wZXJ0aWVzCiAgICAgIG9mIHRoaXMgY2xhc3MgY2FuIGJlIG92ZXJyaWRkZW4gd2l0aCBgcmVvcGVuYCB0byBjdXN0b21pemUgYXBwbGljYXRpb24td2lkZQogICAgICBiZWhhdmlvci4KICAgIAogICAgICBAY2xhc3MgTGlua0NvbXBvbmVudAogICAgICBAZXh0ZW5kcyBDb21wb25lbnQKICAgICAgQHNlZSB7RW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMubGluay10b30KICAgICAgQHB1YmxpYwogICAgKiovCiAgICB2YXIgTGlua0NvbXBvbmVudCA9IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGxheW91dDogbGF5b3V0JDEsCiAgICAgICAgdGFnTmFtZTogJ2EnLAogICAgICAgIC8qKgogICAgICAgICAgVXNlZCB0byBkZXRlcm1pbmUgd2hlbiB0aGlzIGBMaW5rQ29tcG9uZW50YCBpcyBhY3RpdmUuCiAgICAgICAgICAgICBAcHJvcGVydHkgY3VycmVudC13aGVuCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICAnY3VycmVudC13aGVuJzogbnVsbCwKICAgICAgICAvKioKICAgICAgICAgIFNldHMgdGhlIGB0aXRsZWAgYXR0cmlidXRlIG9mIHRoZSBgTGlua0NvbXBvbmVudGAncyBIVE1MIGVsZW1lbnQuCiAgICAgICAgICAgICBAcHJvcGVydHkgdGl0bGUKICAgICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAqKi8KICAgICAgICB0aXRsZTogbnVsbCwKICAgICAgICAvKioKICAgICAgICAgIFNldHMgdGhlIGByZWxgIGF0dHJpYnV0ZSBvZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgSFRNTCBlbGVtZW50LgogICAgICAgICAgICAgQHByb3BlcnR5IHJlbAogICAgICAgICAgQGRlZmF1bHQgbnVsbAogICAgICAgICAgQHB1YmxpYwogICAgICAgICoqLwogICAgICAgIHJlbDogbnVsbCwKICAgICAgICAvKioKICAgICAgICAgIFNldHMgdGhlIGB0YWJpbmRleGAgYXR0cmlidXRlIG9mIHRoZSBgTGlua0NvbXBvbmVudGAncyBIVE1MIGVsZW1lbnQuCiAgICAgICAgICAgICBAcHJvcGVydHkgdGFiaW5kZXgKICAgICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICAgIEBwdWJsaWMKICAgICAgICAqKi8KICAgICAgICB0YWJpbmRleDogbnVsbCwKICAgICAgICAvKioKICAgICAgICAgIFNldHMgdGhlIGB0YXJnZXRgIGF0dHJpYnV0ZSBvZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgSFRNTCBlbGVtZW50LgogICAgICAgICAgICAgQHNpbmNlIDEuOC4wCiAgICAgICAgICBAcHJvcGVydHkgdGFyZ2V0CiAgICAgICAgICBAZGVmYXVsdCBudWxsCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKiovCiAgICAgICAgdGFyZ2V0OiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAgVGhlIENTUyBjbGFzcyB0byBhcHBseSB0byBgTGlua0NvbXBvbmVudGAncyBlbGVtZW50IHdoZW4gaXRzIGBhY3RpdmVgCiAgICAgICAgICBwcm9wZXJ0eSBpcyBgdHJ1ZWAuCiAgICAgICAgICAgICBAcHJvcGVydHkgYWN0aXZlQ2xhc3MKICAgICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgICAgQGRlZmF1bHQgYWN0aXZlCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKiovCiAgICAgICAgYWN0aXZlQ2xhc3M6ICdhY3RpdmUnLAogICAgICAgIC8qKgogICAgICAgICAgVGhlIENTUyBjbGFzcyB0byBhcHBseSB0byBgTGlua0NvbXBvbmVudGAncyBlbGVtZW50IHdoZW4gaXRzIGBsb2FkaW5nYAogICAgICAgICAgcHJvcGVydHkgaXMgYHRydWVgLgogICAgICAgICAgICAgQHByb3BlcnR5IGxvYWRpbmdDbGFzcwogICAgICAgICAgQHR5cGUgU3RyaW5nCiAgICAgICAgICBAZGVmYXVsdCBsb2FkaW5nCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgIGxvYWRpbmdDbGFzczogJ2xvYWRpbmcnLAogICAgICAgIC8qKgogICAgICAgICAgVGhlIENTUyBjbGFzcyB0byBhcHBseSB0byBhIGBMaW5rQ29tcG9uZW50YCdzIGVsZW1lbnQgd2hlbiBpdHMgYGRpc2FibGVkYAogICAgICAgICAgcHJvcGVydHkgaXMgYHRydWVgLgogICAgICAgICAgICAgQHByb3BlcnR5IGRpc2FibGVkQ2xhc3MKICAgICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgICAgQGRlZmF1bHQgZGlzYWJsZWQKICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgZGlzYWJsZWRDbGFzczogJ2Rpc2FibGVkJywKICAgICAgICAvKioKICAgICAgICAgIERldGVybWluZXMgd2hldGhlciB0aGUgYExpbmtDb21wb25lbnRgIHdpbGwgdHJpZ2dlciByb3V0aW5nIHZpYQogICAgICAgICAgdGhlIGByZXBsYWNlV2l0aGAgcm91dGluZyBzdHJhdGVneS4KICAgICAgICAgICAgIEBwcm9wZXJ0eSByZXBsYWNlCiAgICAgICAgICBAdHlwZSBCb29sZWFuCiAgICAgICAgICBAZGVmYXVsdCBmYWxzZQogICAgICAgICAgQHB1YmxpYwogICAgICAgICoqLwogICAgICAgIHJlcGxhY2U6IGZhbHNlLAogICAgICAgIC8qKgogICAgICAgICAgQnkgZGVmYXVsdCB0aGUgYHt7bGluay10b319YCBjb21wb25lbnQgd2lsbCBiaW5kIHRvIHRoZSBgaHJlZmAgYW5kCiAgICAgICAgICBgdGl0bGVgIGF0dHJpYnV0ZXMuIEl0J3MgZGlzY291cmFnZWQgdGhhdCB5b3Ugb3ZlcnJpZGUgdGhlc2UgZGVmYXVsdHMsCiAgICAgICAgICBob3dldmVyIHlvdSBjYW4gcHVzaCBvbnRvIHRoZSBhcnJheSBpZiBuZWVkZWQuCiAgICAgICAgICAgICBAcHJvcGVydHkgYXR0cmlidXRlQmluZGluZ3MKICAgICAgICAgIEB0eXBlIEFycmF5IHwgU3RyaW5nCiAgICAgICAgICBAZGVmYXVsdCBbJ3RpdGxlJywgJ3JlbCcsICd0YWJpbmRleCcsICd0YXJnZXQnXQogICAgICAgICAgQHB1YmxpYwogICAgICAgICovCiAgICAgICAgYXR0cmlidXRlQmluZGluZ3M6IFsnaHJlZicsICd0aXRsZScsICdyZWwnLCAndGFiaW5kZXgnLCAndGFyZ2V0J10sCiAgICAgICAgLyoqCiAgICAgICAgICBCeSBkZWZhdWx0IHRoZSBge3tsaW5rLXRvfX1gIGNvbXBvbmVudCB3aWxsIGJpbmQgdG8gdGhlIGBhY3RpdmVgLCBgbG9hZGluZ2AsCiAgICAgICAgICBhbmQgYGRpc2FibGVkYCBjbGFzc2VzLiBJdCBpcyBkaXNjb3VyYWdlZCB0byBvdmVycmlkZSB0aGVzZSBkaXJlY3RseS4KICAgICAgICAgICAgIEBwcm9wZXJ0eSBjbGFzc05hbWVCaW5kaW5ncwogICAgICAgICAgQHR5cGUgQXJyYXkKICAgICAgICAgIEBkZWZhdWx0IFsnYWN0aXZlJywgJ2xvYWRpbmcnLCAnZGlzYWJsZWQnLCAnZW1iZXItdHJhbnNpdGlvbmluZy1pbicsICdlbWJlci10cmFuc2l0aW9uaW5nLW91dCddCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KICAgICAgICBjbGFzc05hbWVCaW5kaW5nczogWydhY3RpdmUnLCAnbG9hZGluZycsICdkaXNhYmxlZCcsICd0cmFuc2l0aW9uaW5nSW4nLCAndHJhbnNpdGlvbmluZ091dCddLAogICAgICAgIC8qKgogICAgICAgICAgQnkgZGVmYXVsdCB0aGUgYHt7bGluay10b319YCBjb21wb25lbnQgcmVzcG9uZHMgdG8gdGhlIGBjbGlja2AgZXZlbnQuIFlvdQogICAgICAgICAgY2FuIG92ZXJyaWRlIHRoaXMgZ2xvYmFsbHkgYnkgc2V0dGluZyB0aGlzIHByb3BlcnR5IHRvIHlvdXIgY3VzdG9tCiAgICAgICAgICBldmVudCBuYW1lLgogICAgICAgICAgICAgVGhpcyBpcyBwYXJ0aWN1bGFybHkgdXNlZnVsIG9uIG1vYmlsZSB3aGVuIG9uZSB3YW50cyB0byBhdm9pZCB0aGUgMzAwbXMKICAgICAgICAgIGNsaWNrIGRlbGF5IHVzaW5nIHNvbWUgc29ydCBvZiBjdXN0b20gYHRhcGAgZXZlbnQuCiAgICAgICAgICAgICBAcHJvcGVydHkgZXZlbnROYW1lCiAgICAgICAgICBAdHlwZSBTdHJpbmcKICAgICAgICAgIEBkZWZhdWx0IGNsaWNrCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICovCiAgICAgICAgZXZlbnROYW1lOiAnY2xpY2snLAogICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgLy8gTWFwIGRlc2lyZWQgZXZlbnQgbmFtZSB0byBpbnZva2UgZnVuY3Rpb24KICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdldmVudE5hbWUnKTsKICAgICAgICAgICAgdGhpcy5vbihldmVudE5hbWUsIHRoaXMsIHRoaXMuX2ludm9rZSk7CiAgICAgICAgfSwKCiAgICAgICAgX3JvdXRpbmc6ICgwLCBfc2VydmljZS5pbmplY3QpKCctcm91dGluZycpLAogICAgICAgIC8qKgogICAgICAgICAgQWNjZXNzZWQgYXMgYSBjbGFzc25hbWUgYmluZGluZyB0byBhcHBseSB0aGUgYExpbmtDb21wb25lbnRgJ3MgYGRpc2FibGVkQ2xhc3NgCiAgICAgICAgICBDU1MgYGNsYXNzYCB0byB0aGUgZWxlbWVudCB3aGVuIHRoZSBsaW5rIGlzIGRpc2FibGVkLgogICAgICAgICAgICAgV2hlbiBgdHJ1ZWAgaW50ZXJhY3Rpb25zIHdpdGggdGhlIGVsZW1lbnQgd2lsbCBub3QgdHJpZ2dlciByb3V0ZSBjaGFuZ2VzLgogICAgICAgICAgQHByb3BlcnR5IGRpc2FibGVkCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICovCiAgICAgICAgZGlzYWJsZWQ6ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChfa2V5KSB7CiAgICAgICAgICAgICAgICAvLyBhbHdheXMgcmV0dXJucyBmYWxzZSBmb3IgYGdldGAgYmVjYXVzZSAoZHVlIHRvIHRoZSBgc2V0YCBqdXN0IGJlbG93KQogICAgICAgICAgICAgICAgLy8gdGhlIGNhY2hlZCByZXR1cm4gdmFsdWUgZnJvbSB0aGUgc2V0IHdpbGwgcHJldmVudCB0aGlzIGdldHRlciBmcm9tIF9ldmVyXwogICAgICAgICAgICAgICAgLy8gYmVpbmcgY2FsbGVkIGFmdGVyIGEgc2V0IGhhcyBvY2N1cmVkCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKF9rZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pc0Rpc2FibGVkID0gdmFsdWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPyAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnZGlzYWJsZWRDbGFzcycpIDogZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBfaXNBY3RpdmU6IGZ1bmN0aW9uIChyb3V0ZXJTdGF0ZSkgewogICAgICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xvYWRpbmcnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50V2hlbiA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdjdXJyZW50LXdoZW4nKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50V2hlbiA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFdoZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzQ3VycmVudFdoZW5TcGVjaWZpZWQgPSAhIWN1cnJlbnRXaGVuOwogICAgICAgICAgICBjdXJyZW50V2hlbiA9IGN1cnJlbnRXaGVuIHx8ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdxdWFsaWZpZWRSb3V0ZU5hbWUnKTsKICAgICAgICAgICAgY3VycmVudFdoZW4gPSBjdXJyZW50V2hlbi5zcGxpdCgnICcpOwogICAgICAgICAgICB2YXIgcm91dGluZyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdfcm91dGluZycpOwogICAgICAgICAgICB2YXIgbW9kZWxzID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ21vZGVscycpOwogICAgICAgICAgICB2YXIgcmVzb2x2ZWRRdWVyeVBhcmFtcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyZXNvbHZlZFF1ZXJ5UGFyYW1zJyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3VycmVudFdoZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChyb3V0aW5nLmlzQWN0aXZlRm9yUm91dGUobW9kZWxzLCByZXNvbHZlZFF1ZXJ5UGFyYW1zLCBjdXJyZW50V2hlbltpXSwgcm91dGVyU3RhdGUsIGlzQ3VycmVudFdoZW5TcGVjaWZpZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAgQWNjZXNzZWQgYXMgYSBjbGFzc25hbWUgYmluZGluZyB0byBhcHBseSB0aGUgYExpbmtDb21wb25lbnRgJ3MgYGFjdGl2ZUNsYXNzYAogICAgICAgICAgQ1NTIGBjbGFzc2AgdG8gdGhlIGVsZW1lbnQgd2hlbiB0aGUgbGluayBpcyBhY3RpdmUuCiAgICAgICAgICAgICBBIGBMaW5rQ29tcG9uZW50YCBpcyBjb25zaWRlcmVkIGFjdGl2ZSB3aGVuIGl0cyBgY3VycmVudFdoZW5gIHByb3BlcnR5IGlzIGB0cnVlYAogICAgICAgICAgb3IgdGhlIGFwcGxpY2F0aW9uJ3MgY3VycmVudCByb3V0ZSBpcyB0aGUgcm91dGUgdGhlIGBMaW5rQ29tcG9uZW50YCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICB0cmFuc2l0aW9ucyBpbnRvLgogICAgICAgICAgICAgVGhlIGBjdXJyZW50V2hlbmAgcHJvcGVydHkgY2FuIG1hdGNoIGFnYWluc3QgbXVsdGlwbGUgcm91dGVzIGJ5IHNlcGFyYXRpbmcKICAgICAgICAgIHJvdXRlIG5hbWVzIHVzaW5nIHRoZSBgIGAgKHNwYWNlKSBjaGFyYWN0ZXIuCiAgICAgICAgICAgICBAcHJvcGVydHkgYWN0aXZlCiAgICAgICAgICBAcHJpdmF0ZQogICAgICAgICovCiAgICAgICAgYWN0aXZlOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdhY3RpdmVDbGFzcycsICdfYWN0aXZlJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudEFjdGl2ZUNsYXNzKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ19hY3RpdmUnKSA/ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdhY3RpdmVDbGFzcycpIDogZmFsc2U7CiAgICAgICAgfSksCiAgICAgICAgX2FjdGl2ZTogKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKSgnX3JvdXRpbmcuY3VycmVudFN0YXRlJywgJ2F0dHJzLnBhcmFtcycsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRBY3RpdmUoKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnX3JvdXRpbmcuY3VycmVudFN0YXRlJyk7CiAgICAgICAgICAgIGlmICghY3VycmVudFN0YXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzQWN0aXZlKGN1cnJlbnRTdGF0ZSk7CiAgICAgICAgfSksCiAgICAgICAgd2lsbEJlQWN0aXZlOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdfcm91dGluZy50YXJnZXRTdGF0ZScsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRXaWxsQmVBY3RpdmUoKSB7CiAgICAgICAgICAgIHZhciByb3V0aW5nID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19yb3V0aW5nJyk7CiAgICAgICAgICAgIHZhciB0YXJnZXRTdGF0ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHJvdXRpbmcsICd0YXJnZXRTdGF0ZScpOwogICAgICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkocm91dGluZywgJ2N1cnJlbnRTdGF0ZScpID09PSB0YXJnZXRTdGF0ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pc0FjdGl2ZSh0YXJnZXRTdGF0ZSk7CiAgICAgICAgfSksCiAgICAgICAgdHJhbnNpdGlvbmluZ0luOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdhY3RpdmUnLCAnd2lsbEJlQWN0aXZlJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudFRyYW5zaXRpb25pbmdJbigpIHsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd3aWxsQmVBY3RpdmUnKSA9PT0gdHJ1ZSAmJiAhKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19hY3RpdmUnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICdlbWJlci10cmFuc2l0aW9uaW5nLWluJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0pLAogICAgICAgIHRyYW5zaXRpb25pbmdPdXQ6ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoJ2FjdGl2ZScsICd3aWxsQmVBY3RpdmUnLCBmdW5jdGlvbiBjb21wdXRlTGlua1RvQ29tcG9uZW50VHJhbnNpdGlvbmluZ091dCgpIHsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd3aWxsQmVBY3RpdmUnKSA9PT0gZmFsc2UgJiYgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19hY3RpdmUnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICdlbWJlci10cmFuc2l0aW9uaW5nLW91dCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KSwKICAgICAgICBfaW52b2tlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCEoMCwgX2VtYmVyVmlld3MuaXNTaW1wbGVDbGljaykoZXZlbnQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncHJldmVudERlZmF1bHQnKTsKICAgICAgICAgICAgdmFyIHRhcmdldEF0dHJpYnV0ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd0YXJnZXQnKTsKICAgICAgICAgICAgaWYgKHByZXZlbnREZWZhdWx0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRBdHRyaWJ1dGUgfHwgdGFyZ2V0QXR0cmlidXRlID09PSAnX3NlbGYnKSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2J1YmJsZXMnKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2FkaW5nJykpIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICgwLCBfZGVidWcud2FybikoJ1RoaXMgbGluay10byBpcyBpbiBhbiBpbmFjdGl2ZSBsb2FkaW5nIHN0YXRlIGJlY2F1c2UgYXQgbGVhc3Qgb25lIG9mIGl0cyBwYXJhbWV0ZXJzIHByZXNlbnRseSBoYXMgYSBudWxsL3VuZGVmaW5lZCB2YWx1ZSwgb3IgdGhlIHByb3ZpZGVkIHJvdXRlIG5hbWUgaXMgaW52YWxpZC4nLCBmYWxzZSwgewogICAgICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItZ2xpbW1lci5saW5rLXRvLmluYWN0aXZlLWxvYWRpbmctc3RhdGUnCiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YXJnZXRBdHRyaWJ1dGUgJiYgdGFyZ2V0QXR0cmlidXRlICE9PSAnX3NlbGYnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHF1YWxpZmllZFJvdXRlTmFtZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdxdWFsaWZpZWRSb3V0ZU5hbWUnKTsKICAgICAgICAgICAgdmFyIG1vZGVscyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdtb2RlbHMnKTsKICAgICAgICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3F1ZXJ5UGFyYW1zLnZhbHVlcycpOwogICAgICAgICAgICB2YXIgc2hvdWxkUmVwbGFjZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyZXBsYWNlJyk7CiAgICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgcXVlcnlQYXJhbXM6IHF1ZXJ5UGFyYW1zLAogICAgICAgICAgICAgICAgcm91dGVOYW1lOiBxdWFsaWZpZWRSb3V0ZU5hbWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgICAgICAoMCwgX2luc3RydW1lbnRhdGlvbi5mbGFnZ2VkSW5zdHJ1bWVudCkoJ2ludGVyYWN0aW9uLmxpbmstdG8nLCBwYXlsb2FkLCB0aGlzLl9nZW5lcmF0ZVRyYW5zaXRpb24ocGF5bG9hZCwgcXVhbGlmaWVkUm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCBzaG91bGRSZXBsYWNlKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIF9nZW5lcmF0ZVRyYW5zaXRpb246IGZ1bmN0aW9uIChwYXlsb2FkLCBxdWFsaWZpZWRSb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHNob3VsZFJlcGxhY2UpIHsKICAgICAgICAgICAgdmFyIHJvdXRpbmcgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnX3JvdXRpbmcnKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHBheWxvYWQudHJhbnNpdGlvbiA9IHJvdXRpbmcudHJhbnNpdGlvblRvKHF1YWxpZmllZFJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcywgc2hvdWxkUmVwbGFjZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgcXVlcnlQYXJhbXM6IG51bGwsCiAgICAgICAgcXVhbGlmaWVkUm91dGVOYW1lOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCd0YXJnZXRSb3V0ZU5hbWUnLCAnX3JvdXRpbmcuY3VycmVudFN0YXRlJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudFF1YWxpZmllZFJvdXRlTmFtZSgpIHsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdwYXJhbXMnKTsKICAgICAgICAgICAgdmFyIHBhcmFtc0xlbmd0aCA9IHBhcmFtcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBsYXN0UGFyYW0gPSBwYXJhbXNbcGFyYW1zTGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGlmIChsYXN0UGFyYW0gJiYgbGFzdFBhcmFtLmlzUXVlcnlQYXJhbXMpIHsKICAgICAgICAgICAgICAgIHBhcmFtc0xlbmd0aC0tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvbmx5UXVlcnlQYXJhbXNTdXBwbGllZCA9IHRoaXNbSEFTX0JMT0NLXSA/IHBhcmFtc0xlbmd0aCA9PT0gMCA6IHBhcmFtc0xlbmd0aCA9PT0gMTsKICAgICAgICAgICAgaWYgKG9ubHlRdWVyeVBhcmFtc1N1cHBsaWVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19yb3V0aW5nLmN1cnJlbnRSb3V0ZU5hbWUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3RhcmdldFJvdXRlTmFtZScpOwogICAgICAgIH0pLAogICAgICAgIHJlc29sdmVkUXVlcnlQYXJhbXM6ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoJ3F1ZXJ5UGFyYW1zJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudFJlc29sdmVkUXVlcnlQYXJhbXMoKSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlZFF1ZXJ5UGFyYW1zID0ge307CiAgICAgICAgICAgIHZhciBxdWVyeVBhcmFtcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdxdWVyeVBhcmFtcycpOwogICAgICAgICAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRRdWVyeVBhcmFtczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWVzID0gcXVlcnlQYXJhbXMudmFsdWVzOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWVzKSB7CiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNvbHZlZFF1ZXJ5UGFyYW1zW2tleV0gPSB2YWx1ZXNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRRdWVyeVBhcmFtczsKICAgICAgICB9KSwKICAgICAgICAvKioKICAgICAgICAgIFNldHMgdGhlIGVsZW1lbnQncyBgaHJlZmAgYXR0cmlidXRlIHRvIHRoZSB1cmwgZm9yCiAgICAgICAgICB0aGUgYExpbmtDb21wb25lbnRgJ3MgdGFyZ2V0ZWQgcm91dGUuCiAgICAgICAgICAgICBJZiB0aGUgYExpbmtDb21wb25lbnRgJ3MgYHRhZ05hbWVgIGlzIGNoYW5nZWQgdG8gYSB2YWx1ZSBvdGhlcgogICAgICAgICAgdGhhbiBgYWAsIHRoaXMgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLgogICAgICAgICAgICAgQHByb3BlcnR5IGhyZWYKICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgKi8KICAgICAgICBocmVmOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdtb2RlbHMnLCAncXVhbGlmaWVkUm91dGVOYW1lJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudEhyZWYoKSB7CiAgICAgICAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAndGFnTmFtZScpICE9PSAnYScpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcXVhbGlmaWVkUm91dGVOYW1lID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3F1YWxpZmllZFJvdXRlTmFtZScpOwogICAgICAgICAgICB2YXIgbW9kZWxzID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ21vZGVscycpOwogICAgICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xvYWRpbmcnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2FkaW5nSHJlZicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb3V0aW5nID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19yb3V0aW5nJyk7CiAgICAgICAgICAgIHZhciBxdWVyeVBhcmFtcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdxdWVyeVBhcmFtcy52YWx1ZXMnKTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgKiBVbmZvcnR1bmF0ZWx5LCB0byBnZXQgZGVjZW50IGVycm9yIG1lc3NhZ2VzLCB3ZSBuZWVkIHRvIGRvIHRoaXMuCiAgICAgICAgICAgICAgICAgKiBJbiBzb21lIGZ1dHVyZSBzdGF0ZSB3ZSBzaG91bGQgYmUgYWJsZSB0byB1c2UgYSAiZmVhdHVyZSBmbGFnIgogICAgICAgICAgICAgICAgICogd2hpY2ggYWxsb3dzIHVzIHRvIHN0cmlwIHRoaXMgd2l0aG91dCBuZWVkaW5nIHRvIGNhbGwgaXQgdHdpY2UuCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogaWYgKGlzRGVidWdCdWlsZCgpKSB7CiAgICAgICAgICAgICAgICAgKiAgIC8vIERvIHRoZSB1c2VmdWwgZGVidWcgdGhpbmcsIHByb2JhYmx5IGluY2x1ZGluZyB0cnkvY2F0Y2guCiAgICAgICAgICAgICAgICAgKiB9IGVsc2UgewogICAgICAgICAgICAgICAgICogICAvLyBEbyB0aGUgcGVyZm9ybWFudCB0aGluZy4KICAgICAgICAgICAgICAgICAqIH0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByb3V0aW5nLmdlbmVyYXRlVVJMKHF1YWxpZmllZFJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgYXR0ZW1wdGVkIHRvIGRlZmluZSBhIGB7e2xpbmstdG8gIicgKyBxdWFsaWZpZWRSb3V0ZU5hbWUgKyAnIn19YCBidXQgZGlkIG5vdCBwYXNzIHRoZSBwYXJhbWV0ZXJzIHJlcXVpcmVkIGZvciBnZW5lcmF0aW5nIGl0cyBkeW5hbWljIHNlZ21lbnRzLiAnICsgZS5tZXNzYWdlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJvdXRpbmcuZ2VuZXJhdGVVUkwocXVhbGlmaWVkUm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zKTsKICAgICAgICB9KSwKICAgICAgICBsb2FkaW5nOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdfbW9kZWxzQXJlTG9hZGVkJywgJ3F1YWxpZmllZFJvdXRlTmFtZScsIGZ1bmN0aW9uIGNvbXB1dGVMaW5rVG9Db21wb25lbnRMb2FkaW5nKCkgewogICAgICAgICAgICB2YXIgcXVhbGlmaWVkUm91dGVOYW1lID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3F1YWxpZmllZFJvdXRlTmFtZScpOwogICAgICAgICAgICB2YXIgbW9kZWxzQXJlTG9hZGVkID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19tb2RlbHNBcmVMb2FkZWQnKTsKICAgICAgICAgICAgaWYgKCFtb2RlbHNBcmVMb2FkZWQgfHwgcXVhbGlmaWVkUm91dGVOYW1lID09PSBudWxsIHx8IHF1YWxpZmllZFJvdXRlTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xvYWRpbmdDbGFzcycpOwogICAgICAgICAgICB9CiAgICAgICAgfSksCiAgICAgICAgX21vZGVsc0FyZUxvYWRlZDogKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKSgnbW9kZWxzJywgZnVuY3Rpb24gY29tcHV0ZUxpbmtUb0NvbXBvbmVudE1vZGVsc0FyZUxvYWRlZCgpIHsKICAgICAgICAgICAgdmFyIG1vZGVscyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdtb2RlbHMnKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9IG1vZGVsc1tpXTsKICAgICAgICAgICAgICAgIGlmIChtb2RlbCA9PT0gbnVsbCB8fCBtb2RlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0pLAogICAgICAgIF9nZXRNb2RlbHM6IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgICAgICAgdmFyIG1vZGVsQ291bnQgPSBwYXJhbXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgdmFyIG1vZGVscyA9IG5ldyBBcnJheShtb2RlbENvdW50KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtb2RlbENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1tpICsgMV07CiAgICAgICAgICAgICAgICBtb2RlbHNbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kZWxzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAgVGhlIGRlZmF1bHQgaHJlZiB2YWx1ZSB0byB1c2Ugd2hpbGUgYSBsaW5rLXRvIGlzIGxvYWRpbmcuCiAgICAgICAgICBPbmx5IGFwcGxpZXMgd2hlbiB0YWdOYW1lIGlzICdhJwogICAgICAgICAgICAgQHByb3BlcnR5IGxvYWRpbmdIcmVmCiAgICAgICAgICBAdHlwZSBTdHJpbmcKICAgICAgICAgIEBkZWZhdWx0ICMKICAgICAgICAgIEBwcml2YXRlCiAgICAgICAgKi8KICAgICAgICBsb2FkaW5nSHJlZjogJyMnLAogICAgICAgIGRpZFJlY2VpdmVBdHRyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcXVlcnlQYXJhbXMgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBwYXJhbXMgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncGFyYW1zJyk7CiAgICAgICAgICAgIGlmIChwYXJhbXMpIHsKICAgICAgICAgICAgICAgIC8vIERvIG5vdCBtdXRhdGUgcGFyYW1zIGluIHBsYWNlCiAgICAgICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMuc2xpY2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAodHJ1ZSAmJiAhKHBhcmFtcyAmJiBwYXJhbXMubGVuZ3RoKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IHByb3ZpZGUgb25lIG9yIG1vcmUgcGFyYW1ldGVycyB0byB0aGUgbGluay10byBjb21wb25lbnQuJywgcGFyYW1zICYmIHBhcmFtcy5sZW5ndGgpKTsKCiAgICAgICAgICAgIHZhciBkaXNhYmxlZFdoZW4gPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnZGlzYWJsZWRXaGVuJyk7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZFdoZW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZXQoJ2Rpc2FibGVkJywgZGlzYWJsZWRXaGVuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBQcm9jZXNzIHRoZSBwb3NpdGlvbmFsIGFyZ3VtZW50cywgaW4gb3JkZXIuCiAgICAgICAgICAgIC8vIDEuIElubGluZSBsaW5rIHRpdGxlIGNvbWVzIGZpcnN0LCBpZiBwcmVzZW50LgogICAgICAgICAgICBpZiAoIXRoaXNbSEFTX0JMT0NLXSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXQoJ2xpbmtUaXRsZScsIHBhcmFtcy5zaGlmdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAyLiBgdGFyZ2V0Um91dGVOYW1lYCBpcyBub3cgYWx3YXlzIGF0IGluZGV4IDAuCiAgICAgICAgICAgIHRoaXMuc2V0KCd0YXJnZXRSb3V0ZU5hbWUnLCBwYXJhbXNbMF0pOwogICAgICAgICAgICAvLyAzLiBUaGUgbGFzdCBhcmd1bWVudCAoaWYgc3RpbGwgcmVtYWluaW5nKSBpcyB0aGUgYHF1ZXJ5UGFyYW1zYCBvYmplY3QuCiAgICAgICAgICAgIHZhciBsYXN0UGFyYW0gPSBwYXJhbXNbcGFyYW1zLmxlbmd0aCAtIDFdOwogICAgICAgICAgICBpZiAobGFzdFBhcmFtICYmIGxhc3RQYXJhbS5pc1F1ZXJ5UGFyYW1zKSB7CiAgICAgICAgICAgICAgICBxdWVyeVBhcmFtcyA9IHBhcmFtcy5wb3AoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zID0geyB2YWx1ZXM6IHt9IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXQoJ3F1ZXJ5UGFyYW1zJywgcXVlcnlQYXJhbXMpOwogICAgICAgICAgICAvLyA0LiBBbnkgcmVtYWluaW5nIGluZGljZXMgKGV4Y2VwdGluZyBgdGFyZ2V0Um91dGVOYW1lYCBhdCAwKSBhcmUgYG1vZGVsc2AuCiAgICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgdGhpcy5zZXQoJ21vZGVscycsIHRoaXMuX2dldE1vZGVscyhwYXJhbXMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0KCdtb2RlbHMnLCBbXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKICAgIExpbmtDb21wb25lbnQudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICdAZW1iZXIvcm91dGluZy9saW5rLWNvbXBvbmVudCc7CiAgICB9OwogICAgTGlua0NvbXBvbmVudC5yZW9wZW5DbGFzcyh7CiAgICAgICAgcG9zaXRpb25hbFBhcmFtczogJ3BhcmFtcycKICAgIH0pOwoKICAgIC8vIEB0cy1jaGVjawogICAgdmFyIERlYnVnU3RhY2sgPSB2b2lkIDA7CiAgICBpZiAodHJ1ZSkgewogICAgICAgIHZhciBFbGVtZW50ID0gZnVuY3Rpb24gRWxlbWVudChuYW1lKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRWxlbWVudCk7CgogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIH07CgogICAgICAgIHZhciBUZW1wbGF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoX0VsZW1lbnQpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShUZW1wbGF0ZUVsZW1lbnQsIF9FbGVtZW50KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVGVtcGxhdGVFbGVtZW50KTsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0VsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBUZW1wbGF0ZUVsZW1lbnQ7CiAgICAgICAgfShFbGVtZW50KTsKCiAgICAgICAgdmFyIEVuZ2luZUVsZW1lbnQgPSBmdW5jdGlvbiAoX0VsZW1lbnQyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRW5naW5lRWxlbWVudCwgX0VsZW1lbnQyKTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIEVuZ2luZUVsZW1lbnQoKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEVuZ2luZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRWxlbWVudDIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBFbmdpbmVFbGVtZW50OwogICAgICAgIH0oRWxlbWVudCk7CgogICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZQogICAgICAgIERlYnVnU3RhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIERlYnVnU3RhY2soKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlYnVnU3RhY2spOwoKICAgICAgICAgICAgICAgIHRoaXMuX3N0YWNrID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERlYnVnU3RhY2sucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKG5hbWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YWNrLnB1c2gobmV3IFRlbXBsYXRlRWxlbWVudChuYW1lKSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBEZWJ1Z1N0YWNrLnByb3RvdHlwZS5wdXNoRW5naW5lID0gZnVuY3Rpb24gcHVzaEVuZ2luZShuYW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGFjay5wdXNoKG5ldyBFbmdpbmVFbGVtZW50KG5hbWUpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIERlYnVnU3RhY2sucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uIHBvcCgpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50Lm5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBEZWJ1Z1N0YWNrLnByb3RvdHlwZS5wZWVrID0gZnVuY3Rpb24gcGVlaygpIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMuX2N1cnJlbnRUZW1wbGF0ZSgpOwogICAgICAgICAgICAgICAgdmFyIGVuZ2luZSA9IHRoaXMuX2N1cnJlbnRFbmdpbmUoKTsKICAgICAgICAgICAgICAgIGlmIChlbmdpbmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyInICsgdGVtcGxhdGUgKyAnIiAoaW4gIicgKyBlbmdpbmUgKyAnIiknOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnIicgKyB0ZW1wbGF0ZSArICciJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIERlYnVnU3RhY2sucHJvdG90eXBlLl9jdXJyZW50VGVtcGxhdGUgPSBmdW5jdGlvbiBfY3VycmVudFRlbXBsYXRlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldEN1cnJlbnRCeVR5cGUoVGVtcGxhdGVFbGVtZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIERlYnVnU3RhY2sucHJvdG90eXBlLl9jdXJyZW50RW5naW5lID0gZnVuY3Rpb24gX2N1cnJlbnRFbmdpbmUoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudEJ5VHlwZShFbmdpbmVFbGVtZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIERlYnVnU3RhY2sucHJvdG90eXBlLl9nZXRDdXJyZW50QnlUeXBlID0gZnVuY3Rpb24gX2dldEN1cnJlbnRCeVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX3N0YWNrLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX3N0YWNrW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgdHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudC5uYW1lOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBEZWJ1Z1N0YWNrOwogICAgICAgIH0oKTsKICAgIH0KICAgIHZhciBEZWJ1Z1N0YWNrJDEgPSBEZWJ1Z1N0YWNrOwoKICAgIC8qKgogICAgICBUaGUgYHt7I2VhY2h9fWAgaGVscGVyIGxvb3BzIG92ZXIgZWxlbWVudHMgaW4gYSBjb2xsZWN0aW9uLiBJdCBpcyBhbiBleHRlbnNpb24KICAgICAgb2YgdGhlIGJhc2UgSGFuZGxlYmFycyBge3sjZWFjaH19YCBoZWxwZXIuCiAgICAgIFRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGB7eyNlYWNofX1gIGlzIHRvIHlpZWxkIGl0cyBpbm5lciBibG9jayBvbmNlIGZvciBldmVyeQogICAgICBpdGVtIGluIGFuIGFycmF5IHBhc3NpbmcgdGhlIGl0ZW0gYXMgdGhlIGZpcnN0IGJsb2NrIHBhcmFtZXRlci4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHZhciBkZXZlbG9wZXJzID0gW3sgbmFtZTogJ1llaHVkYScgfSx7IG5hbWU6ICdUb20nIH0sIHsgbmFtZTogJ1BhdWwnIH1dOwogICAgICBgYGAKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7I2VhY2ggZGV2ZWxvcGVycyBrZXk9Im5hbWUiIGFzIHxwZXJzb258fX0KICAgICAgICB7e3BlcnNvbi5uYW1lfX0KICAgICAgICB7eyEgYHRoaXNgIGlzIHdoYXRldmVyIGl0IHdhcyBvdXRzaWRlIHRoZSAjZWFjaCB9fQogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAKICAgICAgVGhlIHNhbWUgcnVsZXMgYXBwbHkgdG8gYXJyYXlzIG9mIHByaW1pdGl2ZXMuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB2YXIgZGV2ZWxvcGVyTmFtZXMgPSBbJ1llaHVkYScsICdUb20nLCAnUGF1bCddCiAgICAgIGBgYAogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjZWFjaCBkZXZlbG9wZXJOYW1lcyBrZXk9IkBpbmRleCIgYXMgfG5hbWV8fX0KICAgICAgICB7e25hbWV9fQogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAKICAgICAgRHVyaW5nIGl0ZXJhdGlvbiwgdGhlIGluZGV4IG9mIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkgaXMgcHJvdmlkZWQgYXMgYSBzZWNvbmQgYmxvY2sgcGFyYW1ldGVyLgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPHVsPgogICAgICAgIHt7I2VhY2ggcGVvcGxlIGFzIHxwZXJzb24gaW5kZXh8fX0KICAgICAgICAgIDxsaT5IZWxsbywge3twZXJzb24ubmFtZX19ISBZb3UncmUgbnVtYmVyIHt7aW5kZXh9fSBpbiBsaW5lPC9saT4KICAgICAgICB7ey9lYWNofX0KICAgICAgPC91bD4KICAgICAgYGBgCiAgICAKICAgICAgIyMjIFNwZWNpZnlpbmcgS2V5cwogICAgCiAgICAgIFRoZSBga2V5YCBvcHRpb24gaXMgdXNlZCB0byB0ZWxsIEVtYmVyIGhvdyB0byBkZXRlcm1pbmUgaWYgdGhlIGFycmF5IGJlaW5nCiAgICAgIGl0ZXJhdGVkIG92ZXIgd2l0aCBge3sjZWFjaH19YCBoYXMgY2hhbmdlZCBiZXR3ZWVuIHJlbmRlcnMuIEJ5IGhlbHBpbmcgRW1iZXIKICAgICAgZGV0ZWN0IHRoYXQgc29tZSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYXJlIHRoZSBzYW1lLCBET00gZWxlbWVudHMgY2FuIGJlCiAgICAgIHJlLXVzZWQsIHNpZ25pZmljYW50bHkgaW1wcm92aW5nIHJlbmRlcmluZyBzcGVlZC4KICAgIAogICAgICBGb3IgZXhhbXBsZSwgaGVyZSdzIHRoZSBge3sjZWFjaH19YCBoZWxwZXIgd2l0aCBpdHMgYGtleWAgc2V0IHRvIGBpZGA6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyNlYWNoIG1vZGVsIGtleT0iaWQiIGFzIHxpdGVtfH19CiAgICAgIHt7L2VhY2h9fQogICAgICBgYGAKICAgIAogICAgICBXaGVuIHRoaXMgYHt7I2VhY2h9fWAgcmUtcmVuZGVycywgRW1iZXIgd2lsbCBtYXRjaCB1cCB0aGUgcHJldmlvdXNseSByZW5kZXJlZAogICAgICBpdGVtcyAoYW5kIHJlb3JkZXIgdGhlIGdlbmVyYXRlZCBET00gZWxlbWVudHMpIGJhc2VkIG9uIGVhY2ggaXRlbSdzIGBpZGAKICAgICAgcHJvcGVydHkuCiAgICAgIEJ5IGRlZmF1bHQgdGhlIGl0ZW0ncyBvd24gcmVmZXJlbmNlIGlzIHVzZWQuCiAgICAKICAgICAgIyMjIHt7ZWxzZX19IGNvbmRpdGlvbgogICAgCiAgICAgIGB7eyNlYWNofX1gIGNhbiBoYXZlIGEgbWF0Y2hpbmcgYHt7ZWxzZX19YC4gVGhlIGNvbnRlbnRzIG9mIHRoaXMgYmxvY2sgd2lsbCByZW5kZXIKICAgICAgaWYgdGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkuCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyNlYWNoIGRldmVsb3BlcnMgYXMgfHBlcnNvbnx9fQogICAgICAgIHt7cGVyc29uLm5hbWV9fQogICAgICB7e2Vsc2V9fQogICAgICAgIDxwPlNvcnJ5LCBub2JvZHkgaXMgYXZhaWxhYmxlIGZvciB0aGlzIHRhc2suPC9wPgogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBlYWNoCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHB1YmxpYwogICAgICovCiAgICAvKioKICAgICAgVGhlIGB7e2VhY2gtaW59fWAgaGVscGVyIGxvb3BzIG92ZXIgcHJvcGVydGllcyBvbiBhbiBvYmplY3QuCiAgICAKICAgICAgRm9yIGV4YW1wbGUsIGdpdmVuIGEgYHVzZXJgIG9iamVjdCB0aGF0IGxvb2tzIGxpa2U6CiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICB7CiAgICAgICAgIm5hbWUiOiAiU2hlbGx5IFNhaWxzIiwKICAgICAgICAiYWdlIjogNDIKICAgICAgfQogICAgICBgYGAKICAgIAogICAgICBUaGlzIHRlbXBsYXRlIHdvdWxkIGRpc3BsYXkgYWxsIHByb3BlcnRpZXMgb24gdGhlIGB1c2VyYAogICAgICBvYmplY3QgaW4gYSBsaXN0OgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPHVsPgogICAgICB7eyNlYWNoLWluIHVzZXIgYXMgfGtleSB2YWx1ZXx9fQogICAgICAgIDxsaT57e2tleX19OiB7e3ZhbHVlfX08L2xpPgogICAgICB7ey9lYWNoLWlufX0KICAgICAgPC91bD4KICAgICAgYGBgCiAgICAKICAgICAgT3V0cHV0dGluZyB0aGVpciBuYW1lIGFuZCBhZ2UuCiAgICAKICAgICAgQG1ldGhvZCBlYWNoLWluCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHB1YmxpYwogICAgICBAc2luY2UgMi4xLjAKICAgICovCiAgICB2YXIgRUFDSF9JTl9SRUZFUkVOQ0UgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnRUFDSF9JTicpOwoKICAgIHZhciBFYWNoSW5SZWZlcmVuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRWFjaEluUmVmZXJlbmNlKGlubmVyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRWFjaEluUmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHRoaXMuaW5uZXIgPSBpbm5lcjsKICAgICAgICAgICAgdGhpcy50YWcgPSBpbm5lci50YWc7CiAgICAgICAgICAgIHRoaXNbRUFDSF9JTl9SRUZFUkVOQ0VdID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIEVhY2hJblJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXIudmFsdWUoKTsKICAgICAgICB9OwoKICAgICAgICBFYWNoSW5SZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXIuZ2V0KGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEVhY2hJblJlZmVyZW5jZTsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBpc0VhY2hJbihyZWYpIHsKICAgICAgICByZXR1cm4gcmVmICE9PSBudWxsICYmIHR5cGVvZiByZWYgPT09ICdvYmplY3QnICYmIHJlZltFQUNIX0lOX1JFRkVSRU5DRV07CiAgICB9CiAgICBmdW5jdGlvbiBlYWNoSW4oX3ZtLCBhcmdzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBFYWNoSW5SZWZlcmVuY2UoYXJncy5wb3NpdGlvbmFsLmF0KDApKTsKICAgIH0KCiAgICB2YXIgSVRFUkFUT1JfS0VZX0dVSUQgPSAnYmUyNzc3NTctYmJiZS00NjIwLTlmY2ItMjEzZWY0MzNjY2EyJzsKICAgIGZ1bmN0aW9uIF9pdGVyYWJsZUZvcihyZWYsIGtleVBhdGgpIHsKICAgICAgICBpZiAoaXNFYWNoSW4ocmVmKSkgewogICAgICAgICAgICByZXR1cm4gbmV3IEVhY2hJbkl0ZXJhYmxlKHJlZiwga2V5UGF0aCB8fCAnQGtleScpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRWFjaEl0ZXJhYmxlKHJlZiwga2V5UGF0aCB8fCAnQGlkZW50aXR5Jyk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBCb3VuZGVkSXRlcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQm91bmRlZEl0ZXJhdG9yKGxlbmd0aCwga2V5Rm9yKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQm91bmRlZEl0ZXJhdG9yKTsKCiAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgICB0aGlzLmtleUZvciA9IGtleUZvcjsKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IDA7CiAgICAgICAgfQoKICAgICAgICBCb3VuZGVkSXRlcmF0b3IucHJvdG90eXBlLmlzRW1wdHkgPSBmdW5jdGlvbiBpc0VtcHR5KCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgQm91bmRlZEl0ZXJhdG9yLnByb3RvdHlwZS5tZW1vRm9yID0gZnVuY3Rpb24gbWVtb0Zvcihwb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gcG9zaXRpb247CiAgICAgICAgfTsKCiAgICAgICAgQm91bmRlZEl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoLAogICAgICAgICAgICAgICAga2V5Rm9yID0gdGhpcy5rZXlGb3IsCiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHRoaXMucG9zaXRpb247CgogICAgICAgICAgICBpZiAocG9zaXRpb24gPj0gbGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLnZhbHVlRm9yKHBvc2l0aW9uKTsKICAgICAgICAgICAgdmFyIG1lbW8gPSB0aGlzLm1lbW9Gb3IocG9zaXRpb24pOwogICAgICAgICAgICB2YXIga2V5ID0ga2V5Rm9yKHZhbHVlLCBtZW1vLCBwb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb24rKzsKICAgICAgICAgICAgcmV0dXJuIHsga2V5OiBrZXksIHZhbHVlOiB2YWx1ZSwgbWVtbzogbWVtbyB9OwogICAgICAgIH07CgogICAgICAgIHJldHVybiBCb3VuZGVkSXRlcmF0b3I7CiAgICB9KCk7CgogICAgdmFyIEFycmF5SXRlcmF0b3IgPSBmdW5jdGlvbiAoX0JvdW5kZWRJdGVyYXRvcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQXJyYXlJdGVyYXRvciwgX0JvdW5kZWRJdGVyYXRvcik7CgogICAgICAgIGZ1bmN0aW9uIEFycmF5SXRlcmF0b3IoYXJyYXksIGxlbmd0aCwga2V5Rm9yKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQXJyYXlJdGVyYXRvcik7CgogICAgICAgICAgICB2YXIgX3RoaXMxNiA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQm91bmRlZEl0ZXJhdG9yLmNhbGwodGhpcywgbGVuZ3RoLCBrZXlGb3IpKTsKCiAgICAgICAgICAgIF90aGlzMTYuYXJyYXkgPSBhcnJheTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMTY7CiAgICAgICAgfQoKICAgICAgICBBcnJheUl0ZXJhdG9yLmZyb20gPSBmdW5jdGlvbiBmcm9tKGFycmF5LCBrZXlGb3IpIHsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWV9JVEVSQVRPUjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcyhhcnJheSwgbGVuZ3RoLCBrZXlGb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQXJyYXlJdGVyYXRvci5mcm9tRm9yRWFjaGFibGUgPSBmdW5jdGlvbiBmcm9tRm9yRWFjaGFibGUob2JqZWN0LCBrZXlGb3IpIHsKICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgIG9iamVjdC5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXJyYXkucHVzaChpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZyb20oYXJyYXksIGtleUZvcik7CiAgICAgICAgfTsKCiAgICAgICAgQXJyYXlJdGVyYXRvci5wcm90b3R5cGUudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihwb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVtwb3NpdGlvbl07CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFycmF5SXRlcmF0b3I7CiAgICB9KEJvdW5kZWRJdGVyYXRvcik7CgogICAgdmFyIEVtYmVyQXJyYXlJdGVyYXRvciA9IGZ1bmN0aW9uIChfQm91bmRlZEl0ZXJhdG9yMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRW1iZXJBcnJheUl0ZXJhdG9yLCBfQm91bmRlZEl0ZXJhdG9yMik7CgogICAgICAgIGZ1bmN0aW9uIEVtYmVyQXJyYXlJdGVyYXRvcihhcnJheSwgbGVuZ3RoLCBrZXlGb3IpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBFbWJlckFycmF5SXRlcmF0b3IpOwoKICAgICAgICAgICAgdmFyIF90aGlzMTcgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0JvdW5kZWRJdGVyYXRvcjIuY2FsbCh0aGlzLCBsZW5ndGgsIGtleUZvcikpOwoKICAgICAgICAgICAgX3RoaXMxNy5hcnJheSA9IGFycmF5OwogICAgICAgICAgICByZXR1cm4gX3RoaXMxNzsKICAgICAgICB9CgogICAgICAgIEVtYmVyQXJyYXlJdGVyYXRvci5mcm9tID0gZnVuY3Rpb24gZnJvbShhcnJheSwga2V5Rm9yKSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgogICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMoYXJyYXksIGxlbmd0aCwga2V5Rm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEVtYmVyQXJyYXlJdGVyYXRvci5wcm90b3R5cGUudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihwb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KSh0aGlzLmFycmF5LCBwb3NpdGlvbik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEVtYmVyQXJyYXlJdGVyYXRvcjsKICAgIH0oQm91bmRlZEl0ZXJhdG9yKTsKCiAgICB2YXIgT2JqZWN0SXRlcmF0b3IgPSBmdW5jdGlvbiAoX0JvdW5kZWRJdGVyYXRvcjMpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKE9iamVjdEl0ZXJhdG9yLCBfQm91bmRlZEl0ZXJhdG9yMyk7CgogICAgICAgIGZ1bmN0aW9uIE9iamVjdEl0ZXJhdG9yKGtleXMsIHZhbHVlcywgbGVuZ3RoLCBrZXlGb3IpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBPYmplY3RJdGVyYXRvcik7CgogICAgICAgICAgICB2YXIgX3RoaXMxOCA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQm91bmRlZEl0ZXJhdG9yMy5jYWxsKHRoaXMsIGxlbmd0aCwga2V5Rm9yKSk7CgogICAgICAgICAgICBfdGhpczE4LmtleXMgPSBrZXlzOwogICAgICAgICAgICBfdGhpczE4LnZhbHVlcyA9IHZhbHVlczsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMTg7CiAgICAgICAgfQoKICAgICAgICBPYmplY3RJdGVyYXRvci5mcm9tSW5kZXhhYmxlID0gZnVuY3Rpb24gZnJvbUluZGV4YWJsZShvYmosIGtleUZvcikgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goKDAsIF9lbWJlck1ldGFsLmdldCkob2JqLCBrZXlzW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyB0aGlzKGtleXMsIHZhbHVlcywgbGVuZ3RoLCBrZXlGb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgT2JqZWN0SXRlcmF0b3IuZnJvbUZvckVhY2hhYmxlID0gZnVuY3Rpb24gZnJvbUZvckVhY2hhYmxlKG9iaiwga2V5Rm9yKSB7CiAgICAgICAgICAgIHZhciBfYXJndW1lbnRzID0gYXJndW1lbnRzOwoKICAgICAgICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgICAgdmFyIGlzTWFwTGlrZSA9IGZhbHNlOwogICAgICAgICAgICBvYmouZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICAgICAgaXNNYXBMaWtlID0gaXNNYXBMaWtlIHx8IF9hcmd1bWVudHMubGVuZ3RoID49IDI7CiAgICAgICAgICAgICAgICBpZiAoaXNNYXBMaWtlKSB7CiAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWV9JVEVSQVRPUjsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc01hcExpa2UpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcyhrZXlzLCB2YWx1ZXMsIGxlbmd0aCwga2V5Rm9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXlJdGVyYXRvcih2YWx1ZXMsIGxlbmd0aCwga2V5Rm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE9iamVjdEl0ZXJhdG9yLnByb3RvdHlwZS52YWx1ZUZvciA9IGZ1bmN0aW9uIHZhbHVlRm9yKHBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlc1twb3NpdGlvbl07CiAgICAgICAgfTsKCiAgICAgICAgT2JqZWN0SXRlcmF0b3IucHJvdG90eXBlLm1lbW9Gb3IgPSBmdW5jdGlvbiBtZW1vRm9yKHBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmtleXNbcG9zaXRpb25dOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBPYmplY3RJdGVyYXRvcjsKICAgIH0oQm91bmRlZEl0ZXJhdG9yKTsKCiAgICB2YXIgTmF0aXZlSXRlcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTmF0aXZlSXRlcmF0b3IoaXRlcmFibGUsIHJlc3VsdCwga2V5Rm9yKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTmF0aXZlSXRlcmF0b3IpOwoKICAgICAgICAgICAgdGhpcy5pdGVyYWJsZSA9IGl0ZXJhYmxlOwogICAgICAgICAgICB0aGlzLnJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgICAgdGhpcy5rZXlGb3IgPSBrZXlGb3I7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgTmF0aXZlSXRlcmF0b3IuZnJvbSA9IGZ1bmN0aW9uIGZyb20oaXRlcmFibGUsIGtleUZvcikgewogICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYWJsZVtTeW1ib2wuaXRlcmF0b3JdKCk7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZSwKICAgICAgICAgICAgICAgIGRvbmUgPSByZXN1bHQuZG9uZTsKCiAgICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMoaXRlcmF0b3IsIHJlc3VsdCwga2V5Rm9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IoaXRlcmF0b3IsIHJlc3VsdCwga2V5Rm9yKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE5hdGl2ZUl0ZXJhdG9yLnByb3RvdHlwZS5pc0VtcHR5ID0gZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgIE5hdGl2ZUl0ZXJhdG9yLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhYmxlID0gdGhpcy5pdGVyYWJsZSwKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMucmVzdWx0LAogICAgICAgICAgICAgICAgcG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLAogICAgICAgICAgICAgICAga2V5Rm9yID0gdGhpcy5rZXlGb3I7CgogICAgICAgICAgICBpZiAocmVzdWx0LmRvbmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMudmFsdWVGb3IocmVzdWx0LCBwb3NpdGlvbik7CiAgICAgICAgICAgIHZhciBtZW1vID0gdGhpcy5tZW1vRm9yKHJlc3VsdCwgcG9zaXRpb24pOwogICAgICAgICAgICB2YXIga2V5ID0ga2V5Rm9yKHZhbHVlLCBtZW1vLCBwb3NpdGlvbik7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb24rKzsKICAgICAgICAgICAgdGhpcy5yZXN1bHQgPSBpdGVyYWJsZS5uZXh0KCk7CiAgICAgICAgICAgIHJldHVybiB7IGtleToga2V5LCB2YWx1ZTogdmFsdWUsIG1lbW86IG1lbW8gfTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gTmF0aXZlSXRlcmF0b3I7CiAgICB9KCk7CgogICAgdmFyIEFycmF5TGlrZU5hdGl2ZUl0ZXJhdG9yID0gZnVuY3Rpb24gKF9OYXRpdmVJdGVyYXRvcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IsIF9OYXRpdmVJdGVyYXRvcik7CgogICAgICAgIGZ1bmN0aW9uIEFycmF5TGlrZU5hdGl2ZUl0ZXJhdG9yKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFycmF5TGlrZU5hdGl2ZUl0ZXJhdG9yKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfTmF0aXZlSXRlcmF0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBBcnJheUxpa2VOYXRpdmVJdGVyYXRvci5wcm90b3R5cGUudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihyZXN1bHQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC52YWx1ZTsKICAgICAgICB9OwoKICAgICAgICBBcnJheUxpa2VOYXRpdmVJdGVyYXRvci5wcm90b3R5cGUubWVtb0ZvciA9IGZ1bmN0aW9uIG1lbW9Gb3IoX3Jlc3VsdCwgcG9zaXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuIHBvc2l0aW9uOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBBcnJheUxpa2VOYXRpdmVJdGVyYXRvcjsKICAgIH0oTmF0aXZlSXRlcmF0b3IpOwoKICAgIHZhciBNYXBMaWtlTmF0aXZlSXRlcmF0b3IgPSBmdW5jdGlvbiAoX05hdGl2ZUl0ZXJhdG9yMikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoTWFwTGlrZU5hdGl2ZUl0ZXJhdG9yLCBfTmF0aXZlSXRlcmF0b3IyKTsKCiAgICAgICAgZnVuY3Rpb24gTWFwTGlrZU5hdGl2ZUl0ZXJhdG9yKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1hcExpa2VOYXRpdmVJdGVyYXRvcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX05hdGl2ZUl0ZXJhdG9yMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIE1hcExpa2VOYXRpdmVJdGVyYXRvci5wcm90b3R5cGUudmFsdWVGb3IgPSBmdW5jdGlvbiB2YWx1ZUZvcihyZXN1bHQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC52YWx1ZVsxXTsKICAgICAgICB9OwoKICAgICAgICBNYXBMaWtlTmF0aXZlSXRlcmF0b3IucHJvdG90eXBlLm1lbW9Gb3IgPSBmdW5jdGlvbiBtZW1vRm9yKHJlc3VsdCkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnZhbHVlWzBdOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBNYXBMaWtlTmF0aXZlSXRlcmF0b3I7CiAgICB9KE5hdGl2ZUl0ZXJhdG9yKTsKCiAgICB2YXIgRU1QVFlfSVRFUkFUT1IgPSB7CiAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIG5leHQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBuZXh0KCkgb24gYW4gZW1wdHkgaXRlcmF0b3InKSk7CgogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBFYWNoSW5JdGVyYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBFYWNoSW5JdGVyYWJsZShyZWYsIGtleVBhdGgpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBFYWNoSW5JdGVyYWJsZSk7CgogICAgICAgICAgICB0aGlzLnJlZiA9IHJlZjsKICAgICAgICAgICAgdGhpcy5rZXlQYXRoID0ga2V5UGF0aDsKICAgICAgICAgICAgdGhpcy52YWx1ZVRhZyA9IF9yZWZlcmVuY2UuVXBkYXRhYmxlVGFnLmNyZWF0ZShfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRyk7CiAgICAgICAgICAgIHRoaXMudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW3JlZi50YWcsIHRoaXMudmFsdWVUYWddKTsKICAgICAgICB9CgogICAgICAgIEVhY2hJbkl0ZXJhYmxlLnByb3RvdHlwZS5pdGVyYXRlID0gZnVuY3Rpb24gaXRlcmF0ZSgpIHsKICAgICAgICAgICAgdmFyIHJlZiA9IHRoaXMucmVmLAogICAgICAgICAgICAgICAgdmFsdWVUYWcgPSB0aGlzLnZhbHVlVGFnOwoKICAgICAgICAgICAgdmFyIGl0ZXJhYmxlID0gcmVmLnZhbHVlKCk7CiAgICAgICAgICAgIHZhciB0YWcgPSAoMCwgX2VtYmVyTWV0YWwudGFnRm9yKShpdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICgoMCwgX2VtYmVyVXRpbHMuaXNQcm94eSkoaXRlcmFibGUpKSB7CiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIGJlY2F1c2UgdGhlIGVhY2gtaW4gZG9lc24ndCBhY3R1YWxseSBnZXQocHJveHksICdrZXknKSBidXQgYnlwYXNzZXMgaXQKICAgICAgICAgICAgICAgIC8vIGFuZCB0aGUgcHJveHkncyB0YWcgaXMgbGF6eSB1cGRhdGVkIG9uIGFjY2VzcwogICAgICAgICAgICAgICAgaXRlcmFibGUgPSAoMCwgX2VtYmVyUnVudGltZS5fY29udGVudEZvcikoaXRlcmFibGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlVGFnLmlubmVyLnVwZGF0ZSh0YWcpOwogICAgICAgICAgICBpZiAoIWlzSW5kZXhhYmxlKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZXJhYmxlKSB8fCAoMCwgX2VtYmVyUnVudGltZS5pc0VtYmVyQXJyYXkpKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yLmZyb21JbmRleGFibGUoaXRlcmFibGUsIHRoaXMua2V5Rm9yKHRydWUpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChfZW1iZXJVdGlscy5IQVNfTkFUSVZFX1NZTUJPTCAmJiBpc05hdGl2ZUl0ZXJhYmxlKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIE1hcExpa2VOYXRpdmVJdGVyYXRvci5mcm9tKGl0ZXJhYmxlLCB0aGlzLmtleUZvcigpKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNGb3JFYWNoKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdEl0ZXJhdG9yLmZyb21Gb3JFYWNoYWJsZShpdGVyYWJsZSwgdGhpcy5rZXlGb3IoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0SXRlcmF0b3IuZnJvbUluZGV4YWJsZShpdGVyYWJsZSwgdGhpcy5rZXlGb3IodHJ1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRWFjaEluSXRlcmFibGUucHJvdG90eXBlLnZhbHVlUmVmZXJlbmNlRm9yID0gZnVuY3Rpb24gdmFsdWVSZWZlcmVuY2VGb3IoaXRlbSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLnZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBFYWNoSW5JdGVyYWJsZS5wcm90b3R5cGUudXBkYXRlVmFsdWVSZWZlcmVuY2UgPSBmdW5jdGlvbiB1cGRhdGVWYWx1ZVJlZmVyZW5jZShyZWYsIGl0ZW0pIHsKICAgICAgICAgICAgcmVmLnVwZGF0ZShpdGVtLnZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICBFYWNoSW5JdGVyYWJsZS5wcm90b3R5cGUubWVtb1JlZmVyZW5jZUZvciA9IGZ1bmN0aW9uIG1lbW9SZWZlcmVuY2VGb3IoaXRlbSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLm1lbW8pOwogICAgICAgIH07CgogICAgICAgIEVhY2hJbkl0ZXJhYmxlLnByb3RvdHlwZS51cGRhdGVNZW1vUmVmZXJlbmNlID0gZnVuY3Rpb24gdXBkYXRlTWVtb1JlZmVyZW5jZShyZWYsIGl0ZW0pIHsKICAgICAgICAgICAgcmVmLnVwZGF0ZShpdGVtLm1lbW8pOwogICAgICAgIH07CgogICAgICAgIEVhY2hJbkl0ZXJhYmxlLnByb3RvdHlwZS5rZXlGb3IgPSBmdW5jdGlvbiBrZXlGb3IoKSB7CiAgICAgICAgICAgIHZhciBoYXNVbmlxdWVLZXlzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTsKICAgICAgICAgICAgdmFyIGtleVBhdGggPSB0aGlzLmtleVBhdGg7CgogICAgICAgICAgICBzd2l0Y2ggKGtleVBhdGgpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ0BrZXknOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNVbmlxdWVLZXlzID8gT2JqZWN0S2V5IDogVW5pcXVlKE1hcEtleSk7CiAgICAgICAgICAgICAgICBjYXNlICdAaW5kZXgnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBJbmRleDsKICAgICAgICAgICAgICAgIGNhc2UgJ0BpZGVudGl0eSc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFVuaXF1ZShJZGVudGl0eSk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICh0cnVlICYmICEoa2V5UGF0aFswXSAhPT0gJ0AnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0ludmFsaWQga2V5OiAnICsga2V5UGF0aCwga2V5UGF0aFswXSAhPT0gJ0AnKSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBVbmlxdWUoS2V5UGF0aChrZXlQYXRoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRWFjaEluSXRlcmFibGU7CiAgICB9KCk7CgogICAgdmFyIEVhY2hJdGVyYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBFYWNoSXRlcmFibGUocmVmLCBrZXlQYXRoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRWFjaEl0ZXJhYmxlKTsKCiAgICAgICAgICAgIHRoaXMucmVmID0gcmVmOwogICAgICAgICAgICB0aGlzLmtleVBhdGggPSBrZXlQYXRoOwogICAgICAgICAgICB0aGlzLnZhbHVlVGFnID0gX3JlZmVyZW5jZS5VcGRhdGFibGVUYWcuY3JlYXRlKF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHKTsKICAgICAgICAgICAgdGhpcy50YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbcmVmLnRhZywgdGhpcy52YWx1ZVRhZ10pOwogICAgICAgIH0KCiAgICAgICAgRWFjaEl0ZXJhYmxlLnByb3RvdHlwZS5pdGVyYXRlID0gZnVuY3Rpb24gaXRlcmF0ZSgpIHsKICAgICAgICAgICAgdmFyIHJlZiA9IHRoaXMucmVmLAogICAgICAgICAgICAgICAgdmFsdWVUYWcgPSB0aGlzLnZhbHVlVGFnOwoKICAgICAgICAgICAgdmFyIGl0ZXJhYmxlID0gcmVmLnZhbHVlKCk7CiAgICAgICAgICAgIHZhbHVlVGFnLmlubmVyLnVwZGF0ZSgoMCwgX2VtYmVyTWV0YWwudGFnRm9yUHJvcGVydHkpKGl0ZXJhYmxlLCAnW10nKSk7CiAgICAgICAgICAgIGlmIChpdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgaXRlcmFibGUgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFlfSVRFUkFUT1I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleUZvciA9IHRoaXMua2V5Rm9yKCk7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5SXRlcmF0b3IuZnJvbShpdGVyYWJsZSwga2V5Rm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgoMCwgX2VtYmVyUnVudGltZS5pc0VtYmVyQXJyYXkpKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEVtYmVyQXJyYXlJdGVyYXRvci5mcm9tKGl0ZXJhYmxlLCBrZXlGb3IpOwogICAgICAgICAgICB9IGVsc2UgaWYgKF9lbWJlclV0aWxzLkhBU19OQVRJVkVfU1lNQk9MICYmIGlzTmF0aXZlSXRlcmFibGUoaXRlcmFibGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXlMaWtlTmF0aXZlSXRlcmF0b3IuZnJvbShpdGVyYWJsZSwga2V5Rm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNGb3JFYWNoKGl0ZXJhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5SXRlcmF0b3IuZnJvbUZvckVhY2hhYmxlKGl0ZXJhYmxlLCBrZXlGb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZX0lURVJBVE9SOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRWFjaEl0ZXJhYmxlLnByb3RvdHlwZS52YWx1ZVJlZmVyZW5jZUZvciA9IGZ1bmN0aW9uIHZhbHVlUmVmZXJlbmNlRm9yKGl0ZW0pIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVcGRhdGFibGVSZWZlcmVuY2UoaXRlbS52YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgRWFjaEl0ZXJhYmxlLnByb3RvdHlwZS51cGRhdGVWYWx1ZVJlZmVyZW5jZSA9IGZ1bmN0aW9uIHVwZGF0ZVZhbHVlUmVmZXJlbmNlKHJlZiwgaXRlbSkgewogICAgICAgICAgICByZWYudXBkYXRlKGl0ZW0udmFsdWUpOwogICAgICAgIH07CgogICAgICAgIEVhY2hJdGVyYWJsZS5wcm90b3R5cGUubWVtb1JlZmVyZW5jZUZvciA9IGZ1bmN0aW9uIG1lbW9SZWZlcmVuY2VGb3IoaXRlbSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFVwZGF0YWJsZVJlZmVyZW5jZShpdGVtLm1lbW8pOwogICAgICAgIH07CgogICAgICAgIEVhY2hJdGVyYWJsZS5wcm90b3R5cGUudXBkYXRlTWVtb1JlZmVyZW5jZSA9IGZ1bmN0aW9uIHVwZGF0ZU1lbW9SZWZlcmVuY2UocmVmLCBpdGVtKSB7CiAgICAgICAgICAgIHJlZi51cGRhdGUoaXRlbS5tZW1vKTsKICAgICAgICB9OwoKICAgICAgICBFYWNoSXRlcmFibGUucHJvdG90eXBlLmtleUZvciA9IGZ1bmN0aW9uIGtleUZvcigpIHsKICAgICAgICAgICAgdmFyIGtleVBhdGggPSB0aGlzLmtleVBhdGg7CgogICAgICAgICAgICBzd2l0Y2ggKGtleVBhdGgpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ0BpbmRleCc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEluZGV4OwogICAgICAgICAgICAgICAgY2FzZSAnQGlkZW50aXR5JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVW5pcXVlKElkZW50aXR5KTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgKHRydWUgJiYgIShrZXlQYXRoWzBdICE9PSAnQCcpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnSW52YWxpZCBrZXk6ICcgKyBrZXlQYXRoLCBrZXlQYXRoWzBdICE9PSAnQCcpKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFVuaXF1ZShLZXlQYXRoKGtleVBhdGgpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBFYWNoSXRlcmFibGU7CiAgICB9KCk7CgogICAgZnVuY3Rpb24gaGFzRm9yRWFjaCh2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWVbJ2ZvckVhY2gnXSA9PT0gJ2Z1bmN0aW9uJzsKICAgIH0KICAgIGZ1bmN0aW9uIGlzTmF0aXZlSXRlcmFibGUodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlW1N5bWJvbC5pdGVyYXRvcl0gPT09ICdmdW5jdGlvbic7CiAgICB9CiAgICBmdW5jdGlvbiBpc0luZGV4YWJsZSh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpOwogICAgfQogICAgLy8gUG9zaXRpb24gaW4gYW4gYXJyYXkgaXMgZ3VhcmVudGVlZCB0byBiZSB1bmlxdWUKICAgIGZ1bmN0aW9uIEluZGV4KF92YWx1ZSwgX21lbW8sIHBvc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZyhwb3NpdGlvbik7CiAgICB9CiAgICAvLyBPYmplY3Qua2V5cyguLi4pIGlzIGd1YXJlbnRlZWQgdG8gYmUgc3RyaW5ncyBhbmQgdW5pcXVlCiAgICBmdW5jdGlvbiBPYmplY3RLZXkoX3ZhbHVlLCBtZW1vKSB7CiAgICAgICAgcmV0dXJuIG1lbW87CiAgICB9CiAgICAvLyBNYXAga2V5cyBjYW4gYmUgYW55IG9iamVjdHMKICAgIGZ1bmN0aW9uIE1hcEtleShfdmFsdWUsIG1lbW8pIHsKICAgICAgICByZXR1cm4gSWRlbnRpdHkobWVtbyk7CiAgICB9CiAgICBmdW5jdGlvbiBJZGVudGl0eSh2YWx1ZSkgewogICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyVXRpbHMuZ3VpZEZvcikodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIEtleVBhdGgoa2V5UGF0aCkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZygoMCwgX2VtYmVyTWV0YWwuZ2V0KSh2YWx1ZSwga2V5UGF0aCkpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBVbmlxdWUoZnVuYykgewogICAgICAgIHZhciBzZWVuID0ge307CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSwgbWVtbywgcG9zaXRpb24pIHsKICAgICAgICAgICAgdmFyIGtleSA9IGZ1bmModmFsdWUsIG1lbW8sIHBvc2l0aW9uKTsKICAgICAgICAgICAgdmFyIGNvdW50ID0gc2VlbltrZXldOwogICAgICAgICAgICBpZiAoY291bnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgc2VlbltrZXldID0gMDsKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZWVuW2tleV0gPSArK2NvdW50OwogICAgICAgICAgICAgICAgcmV0dXJuICcnICsga2V5ICsgSVRFUkFUT1JfS0VZX0dVSUQgKyBjb3VudDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9zdHJpbmcKICAgICovCgogICAgdmFyIFNhZmVTdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gU2FmZVN0cmluZyhzdHJpbmcpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTYWZlU3RyaW5nKTsKCiAgICAgICAgICAgIHRoaXMuc3RyaW5nID0gc3RyaW5nOwogICAgICAgIH0KCiAgICAgICAgU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgICAgICAgcmV0dXJuICcnICsgdGhpcy5zdHJpbmc7CiAgICAgICAgfTsKCiAgICAgICAgU2FmZVN0cmluZy5wcm90b3R5cGUudG9IVE1MID0gZnVuY3Rpb24gdG9IVE1MKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b1N0cmluZygpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBTYWZlU3RyaW5nOwogICAgfSgpOwoKICAgIHZhciBlc2NhcGUgPSB7CiAgICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAgICc8JzogJyZsdDsnLAogICAgICAgICc+JzogJyZndDsnLAogICAgICAgICciJzogJyZxdW90OycsCiAgICAgICAgIiciOiAnJiN4Mjc7JywKICAgICAgICAnYCc6ICcmI3g2MDsnLAogICAgICAgICc9JzogJyYjeDNEOycKICAgIH07CiAgICB2YXIgcG9zc2libGUgPSAvWyY8PiInYD1dLzsKICAgIHZhciBiYWRDaGFycyA9IC9bJjw+IidgPV0vZzsKICAgIGZ1bmN0aW9uIGVzY2FwZUNoYXIoY2hyKSB7CiAgICAgICAgcmV0dXJuIGVzY2FwZVtjaHJdOwogICAgfQogICAgZnVuY3Rpb24gZXNjYXBlRXhwcmVzc2lvbihzdHJpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgLy8gZG9uJ3QgZXNjYXBlIFNhZmVTdHJpbmdzLCBzaW5jZSB0aGV5J3JlIGFscmVhZHkgc2FmZQogICAgICAgICAgICBpZiAoc3RyaW5nICYmIHN0cmluZy50b0hUTUwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmcudG9IVE1MKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXN0cmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZyArICcnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEZvcmNlIGEgc3RyaW5nIGNvbnZlcnNpb24gYXMgdGhpcyB3aWxsIGJlIGRvbmUgYnkgdGhlIGFwcGVuZCByZWdhcmRsZXNzIGFuZAogICAgICAgICAgICAvLyB0aGUgcmVnZXggdGVzdCB3aWxsIGRvIHRoaXMgdHJhbnNwYXJlbnRseSBiZWhpbmQgdGhlIHNjZW5lcywgY2F1c2luZyBpc3N1ZXMgaWYKICAgICAgICAgICAgLy8gYW4gb2JqZWN0J3MgdG8gc3RyaW5nIGhhcyBlc2NhcGVkIGNoYXJhY3RlcnMgaW4gaXQuCiAgICAgICAgICAgIHN0cmluZyA9ICcnICsgc3RyaW5nOwogICAgICAgIH0KICAgICAgICBpZiAoIXBvc3NpYmxlLnRlc3Qoc3RyaW5nKSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoYmFkQ2hhcnMsIGVzY2FwZUNoYXIpOwogICAgfQogICAgLyoqCiAgICAgIE1hcmsgYSBzdHJpbmcgYXMgc2FmZSBmb3IgdW5lc2NhcGVkIG91dHB1dCB3aXRoIEVtYmVyIHRlbXBsYXRlcy4gSWYgeW91CiAgICAgIHJldHVybiBIVE1MIGZyb20gYSBoZWxwZXIsIHVzZSB0aGlzIGZ1bmN0aW9uIHRvCiAgICAgIGVuc3VyZSBFbWJlcidzIHJlbmRlcmluZyBsYXllciBkb2VzIG5vdCBlc2NhcGUgdGhlIEhUTUwuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBodG1sU2FmZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgCiAgICAgIGh0bWxTYWZlKCc8ZGl2PnNvbWVTdHJpbmc8L2Rpdj4nKQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGh0bWxTYWZlCiAgICAgIEBmb3IgQGVtYmVyL3RlbXBsYXRlCiAgICAgIEBzdGF0aWMKICAgICAgQHJldHVybiB7SGFuZGxlYmFycy5TYWZlU3RyaW5nfSBBIHN0cmluZyB0aGF0IHdpbGwgbm90IGJlIEhUTUwgZXNjYXBlZCBieSBIYW5kbGViYXJzLgogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gaHRtbFNhZmUoc3RyKSB7CiAgICAgICAgaWYgKHN0ciA9PT0gbnVsbCB8fCBzdHIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBzdHIgPSAnJzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHN0ciA9ICcnICsgc3RyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFNhZmVTdHJpbmcoc3RyKTsKICAgIH0KICAgIC8qKgogICAgICBEZXRlY3RzIGlmIGEgc3RyaW5nIHdhcyBkZWNvcmF0ZWQgdXNpbmcgYGh0bWxTYWZlYC4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGh0bWxTYWZlLCBpc0hUTUxTYWZlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAKICAgICAgdmFyIHBsYWluU3RyaW5nID0gJ3BsYWluIHN0cmluZycsCiAgICAgICAgICBzYWZlU3RyaW5nID0gaHRtbFNhZmUoJzxkaXY+c29tZVZhbHVlPC9kaXY+Jyk7CiAgICAKICAgICAgaXNIVE1MU2FmZShwbGFpblN0cmluZyk7IC8vIGZhbHNlCiAgICAgIGlzSFRNTFNhZmUoc2FmZVN0cmluZyk7ICAvLyB0cnVlCiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgaXNIVE1MU2FmZQogICAgICBAZm9yIEBlbWJlci90ZW1wbGF0ZQogICAgICBAc3RhdGljCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgc3RyaW5nIHdhcyBkZWNvcmF0ZWQgd2l0aCBgaHRtbFNhZmVgLCBgZmFsc2VgIG90aGVyd2lzZS4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGlzSFRNTFNhZmUoc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ciAhPT0gbnVsbCAmJiB0eXBlb2Ygc3RyID09PSAnb2JqZWN0JyAmJiB0eXBlb2Ygc3RyLnRvSFRNTCA9PT0gJ2Z1bmN0aW9uJzsKICAgIH0KCiAgICAvKiBnbG9iYWxzIG1vZHVsZSwgVVJMICovCiAgICB2YXIgbm9kZVVSTCA9IHZvaWQgMDsKICAgIHZhciBwYXJzaW5nTm9kZSA9IHZvaWQgMDsKICAgIGZ1bmN0aW9uIGluc3RhbGxQcm90b2NvbEZvclVSTChlbnZpcm9ubWVudCkgewogICAgICAgIHZhciBwcm90b2NvbCA9IHZvaWQgMDsKICAgICAgICBpZiAoX2VtYmVyQnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSkgewogICAgICAgICAgICBwcm90b2NvbCA9IGJyb3dzZXJQcm90b2NvbEZvclVSTC5jYWxsKGVudmlyb25tZW50LCAnZm9vYmFyOmJheicpOwogICAgICAgIH0KICAgICAgICAvLyBUZXN0IHRvIHNlZSBpZiBvdXIgRE9NIGltcGxlbWVudGF0aW9uIHBhcnNlcwogICAgICAgIC8vIGFuZCBub3JtYWxpemVzIFVSTHMuCiAgICAgICAgaWYgKHByb3RvY29sID09PSAnZm9vYmFyOicpIHsKICAgICAgICAgICAgLy8gU3dhcCBpbiB0aGUgbWV0aG9kIHRoYXQgZG9lc24ndCBkbyB0aGlzIHRlc3Qgbm93IHRoYXQKICAgICAgICAgICAgLy8gd2Uga25vdyBpdCB3b3Jrcy4KICAgICAgICAgICAgZW52aXJvbm1lbnQucHJvdG9jb2xGb3JVUkwgPSBicm93c2VyUHJvdG9jb2xGb3JVUkw7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgVVJMID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAvLyBVUkwgZ2xvYmFsbHkgcHJvdmlkZWQsIGxpa2VseSBmcm9tIEZhc3RCb290J3Mgc2FuZGJveAogICAgICAgICAgICBub2RlVVJMID0gVVJMOwogICAgICAgICAgICBlbnZpcm9ubWVudC5wcm90b2NvbEZvclVSTCA9IG5vZGVQcm90b2NvbEZvclVSTDsKICAgICAgICB9IGVsc2UgaWYgKF9ub2RlTW9kdWxlLklTX05PREUpIHsKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIGZhbGwgYmFjayB0byBvdXIgb3duIFVSTCBwYXJzaW5nLgogICAgICAgICAgICAvLyBHbG9iYWwgYHJlcXVpcmVgIGlzIHNoYWRvd2VkIGJ5IEVtYmVyJ3MgbG9hZGVyIHNvIHdlIGhhdmUgdG8gdXNlIHRoZSBmdWxseQogICAgICAgICAgICAvLyBxdWFsaWZpZWQgYG1vZHVsZS5yZXF1aXJlYC4KICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXJlcXVpcmUtaW1wb3J0cwogICAgICAgICAgICBub2RlVVJMID0gKDAsIF9ub2RlTW9kdWxlLnJlcXVpcmUpKCd1cmwnKTsKICAgICAgICAgICAgZW52aXJvbm1lbnQucHJvdG9jb2xGb3JVUkwgPSBub2RlUHJvdG9jb2xGb3JVUkw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCB2YWxpZCBVUkwgcGFyc2luZyBtZWNoYW5pc20gZm9yIFVSTCBTYW5pdGl6YXRpb24nKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBicm93c2VyUHJvdG9jb2xGb3JVUkwodXJsKSB7CiAgICAgICAgaWYgKCFwYXJzaW5nTm9kZSkgewogICAgICAgICAgICBwYXJzaW5nTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICB9CiAgICAgICAgcGFyc2luZ05vZGUuaHJlZiA9IHVybDsKICAgICAgICByZXR1cm4gcGFyc2luZ05vZGUucHJvdG9jb2w7CiAgICB9CiAgICBmdW5jdGlvbiBub2RlUHJvdG9jb2xGb3JVUkwodXJsKSB7CiAgICAgICAgdmFyIHByb3RvY29sID0gbnVsbDsKICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcHJvdG9jb2wgPSBub2RlVVJMLnBhcnNlKHVybCkucHJvdG9jb2w7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm90b2NvbCA9PT0gbnVsbCA/ICc6JyA6IHByb3RvY29sOwogICAgfQoKICAgIHZhciBFbnZpcm9ubWVudCQxID0gZnVuY3Rpb24gKF9FbnZpcm9ubWVudCkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRW52aXJvbm1lbnQkMSwgX0Vudmlyb25tZW50KTsKCiAgICAgICAgZnVuY3Rpb24gRW52aXJvbm1lbnQkMShpbmplY3Rpb25zKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRW52aXJvbm1lbnQkMSk7CgogICAgICAgICAgICB2YXIgX3RoaXMyMSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRW52aXJvbm1lbnQuY2FsbCh0aGlzLCBpbmplY3Rpb25zKSk7CgogICAgICAgICAgICBfdGhpczIxLmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgX3RoaXMyMS5vd25lciA9IGluamVjdGlvbnNbX2VtYmVyT3duZXIuT1dORVJdOwogICAgICAgICAgICBfdGhpczIxLmlzSW50ZXJhY3RpdmUgPSBfdGhpczIxLm93bmVyLmxvb2t1cCgnLWVudmlyb25tZW50Om1haW4nKS5pc0ludGVyYWN0aXZlOwogICAgICAgICAgICAvLyBjYW4gYmUgcmVtb3ZlZCBvbmNlIGh0dHBzOi8vZ2l0aHViLmNvbS90aWxkZWlvL2dsaW1tZXIvcHVsbC8zMDUgbGFuZHMKICAgICAgICAgICAgX3RoaXMyMS5kZXN0cm95ZWRDb21wb25lbnRzID0gW107CiAgICAgICAgICAgIGluc3RhbGxQcm90b2NvbEZvclVSTChfdGhpczIxKTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIF90aGlzMjEuZGVidWdTdGFjayA9IG5ldyBEZWJ1Z1N0YWNrJDEoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX3RoaXMyMTsKICAgICAgICB9CgogICAgICAgIEVudmlyb25tZW50JDEuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyB0aGlzKG9wdGlvbnMpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50JDEucHJvdG90eXBlLnByb3RvY29sRm9yVVJMID0gZnVuY3Rpb24gcHJvdG9jb2xGb3JVUkwocykgewogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9OwoKICAgICAgICBFbnZpcm9ubWVudCQxLnByb3RvdHlwZS5sb29rdXBDb21wb25lbnQgPSBmdW5jdGlvbiBsb29rdXBDb21wb25lbnQobmFtZSwgbWV0YSkgewogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlclZpZXdzLmxvb2t1cENvbXBvbmVudCkobWV0YS5vd25lciwgbmFtZSwgbWV0YSk7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQkMS5wcm90b3R5cGUudG9Db25kaXRpb25hbFJlZmVyZW5jZSA9IGZ1bmN0aW9uIHRvQ29uZGl0aW9uYWxSZWZlcmVuY2UocmVmZXJlbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBDb25kaXRpb25hbFJlZmVyZW5jZSQxLmNyZWF0ZShyZWZlcmVuY2UpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50JDEucHJvdG90eXBlLml0ZXJhYmxlRm9yID0gZnVuY3Rpb24gaXRlcmFibGVGb3IocmVmLCBrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIF9pdGVyYWJsZUZvcihyZWYsIGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQkMS5wcm90b3R5cGUuc2NoZWR1bGVJbnN0YWxsTW9kaWZpZXIgPSBmdW5jdGlvbiBzY2hlZHVsZUluc3RhbGxNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcikgewogICAgICAgICAgICBpZiAodGhpcy5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICAgICAgICBfRW52aXJvbm1lbnQucHJvdG90eXBlLnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyLmNhbGwodGhpcywgbW9kaWZpZXIsIG1hbmFnZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQkMS5wcm90b3R5cGUuc2NoZWR1bGVVcGRhdGVNb2RpZmllciA9IGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlTW9kaWZpZXIobW9kaWZpZXIsIG1hbmFnZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgICAgICAgICAgX0Vudmlyb25tZW50LnByb3RvdHlwZS5zY2hlZHVsZVVwZGF0ZU1vZGlmaWVyLmNhbGwodGhpcywgbW9kaWZpZXIsIG1hbmFnZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRW52aXJvbm1lbnQkMS5wcm90b3R5cGUuZGlkRGVzdHJveSA9IGZ1bmN0aW9uIGRpZERlc3Ryb3koZGVzdHJveWFibGUpIHsKICAgICAgICAgICAgZGVzdHJveWFibGUuZGVzdHJveSgpOwogICAgICAgIH07CgogICAgICAgIEVudmlyb25tZW50JDEucHJvdG90eXBlLmJlZ2luID0gZnVuY3Rpb24gYmVnaW4oKSB7CiAgICAgICAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7CiAgICAgICAgICAgIF9FbnZpcm9ubWVudC5wcm90b3R5cGUuYmVnaW4uY2FsbCh0aGlzKTsKICAgICAgICB9OwoKICAgICAgICBFbnZpcm9ubWVudCQxLnByb3RvdHlwZS5jb21taXQgPSBmdW5jdGlvbiBjb21taXQoKSB7CiAgICAgICAgICAgIHZhciBkZXN0cm95ZWRDb21wb25lbnRzID0gdGhpcy5kZXN0cm95ZWRDb21wb25lbnRzOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3llZENvbXBvbmVudHMgPSBbXTsKICAgICAgICAgICAgLy8gY29tcG9uZW50cyBxdWV1ZWQgZm9yIGRlc3RydWN0aW9uIG11c3QgYmUgZGVzdHJveWVkIGJlZm9yZSBmaXJpbmcKICAgICAgICAgICAgLy8gYGRpZENyZWF0ZWAgdG8gcHJldmVudCBlcnJvcnMgd2hlbiByZW1vdmluZyBhbmQgYWRkaW5nIGEgY29tcG9uZW50CiAgICAgICAgICAgIC8vIHdpdGggdGhlIHNhbWUgbmFtZSAod291bGQgdGhyb3cgYW4gZXJyb3Igd2hlbiBhZGRlZCB0byB2aWV3IHJlZ2lzdHJ5KQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlc3Ryb3llZENvbXBvbmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3llZENvbXBvbmVudHNbaV0uZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBfRW52aXJvbm1lbnQucHJvdG90eXBlLmNvbW1pdC5jYWxsKHRoaXMpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgdGhpcy5pblRyYW5zYWN0aW9uID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRW52aXJvbm1lbnQkMTsKICAgIH0oX3J1bnRpbWUuRW52aXJvbm1lbnQpOwoKICAgIGlmICh0cnVlKSB7CiAgICAgICAgdmFyIFN0eWxlQXR0cmlidXRlTWFuYWdlciA9IGZ1bmN0aW9uIChfU2ltcGxlRHluYW1pY0F0dHJpYnUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShTdHlsZUF0dHJpYnV0ZU1hbmFnZXIsIF9TaW1wbGVEeW5hbWljQXR0cmlidSk7CgogICAgICAgICAgICBmdW5jdGlvbiBTdHlsZUF0dHJpYnV0ZU1hbmFnZXIoKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFN0eWxlQXR0cmlidXRlTWFuYWdlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9TaW1wbGVEeW5hbWljQXR0cmlidS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgU3R5bGVBdHRyaWJ1dGVNYW5hZ2VyLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiBzZXQoZG9tLCB2YWx1ZSwgZW52KSB7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAoMCwgX2RlYnVnLndhcm4pKCgwLCBfZW1iZXJWaWV3cy5jb25zdHJ1Y3RTdHlsZURlcHJlY2F0aW9uTWVzc2FnZSkodmFsdWUpLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgaXNIVE1MU2FmZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0oKSwgeyBpZDogJ2VtYmVyLWh0bWxiYXJzLnN0eWxlLXhzcy13YXJuaW5nJyB9KSk7CgogICAgICAgICAgICAgICAgX1NpbXBsZUR5bmFtaWNBdHRyaWJ1LnByb3RvdHlwZS5zZXQuY2FsbCh0aGlzLCBkb20sIHZhbHVlLCBlbnYpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgU3R5bGVBdHRyaWJ1dGVNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsdWUsIGVudikgewogICAgICAgICAgICAgICAgKHRydWUgJiYgKDAsIF9kZWJ1Zy53YXJuKSgoMCwgX2VtYmVyVmlld3MuY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2UpKHZhbHVlKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IGlzSFRNTFNhZmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9KCksIHsgaWQ6ICdlbWJlci1odG1sYmFycy5zdHlsZS14c3Mtd2FybmluZycgfSkpOwoKICAgICAgICAgICAgICAgIF9TaW1wbGVEeW5hbWljQXR0cmlidS5wcm90b3R5cGUudXBkYXRlLmNhbGwodGhpcywgdmFsdWUsIGVudik7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gU3R5bGVBdHRyaWJ1dGVNYW5hZ2VyOwogICAgICAgIH0oX3J1bnRpbWUuU2ltcGxlRHluYW1pY0F0dHJpYnV0ZSk7CgogICAgICAgIEVudmlyb25tZW50JDEucHJvdG90eXBlLmF0dHJpYnV0ZUZvciA9IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyaWJ1dGUsIGlzVHJ1c3RpbmcsIG5hbWVzcGFjZSkgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlID09PSAnc3R5bGUnICYmICFpc1RydXN0aW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0eWxlQXR0cmlidXRlTWFuYWdlcih7IGVsZW1lbnQ6IGVsZW1lbnQsIG5hbWU6IGF0dHJpYnV0ZSwgbmFtZXNwYWNlOiBuYW1lc3BhY2UgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9ydW50aW1lLkVudmlyb25tZW50LnByb3RvdHlwZS5hdHRyaWJ1dGVGb3IuY2FsbCh0aGlzLCBlbGVtZW50LCBhdHRyaWJ1dGUsIGlzVHJ1c3RpbmcsIG5hbWVzcGFjZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvLyBpbXBsZW1lbnRzIHRoZSBDb21wb25lbnRNYW5hZ2VyIGludGVyZmFjZSBhcyBkZWZpbmVkIGluIGdsaW1tZXI6CiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZ2xpbW1lcmpzL2dsaW1tZXItdm0vYmxvYi92MC4yNC4wLWJldGEuNC9wYWNrYWdlcy8lNDBnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBvbmVudC9pbnRlcmZhY2VzLnRzI0wyMQoKICAgIHZhciBBYnN0cmFjdE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQWJzdHJhY3RNYW5hZ2VyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFic3RyYWN0TWFuYWdlcik7CgogICAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sgPSB1bmRlZmluZWQ7CiAgICAgICAgfQoKICAgICAgICBBYnN0cmFjdE1hbmFnZXIucHJvdG90eXBlLnByZXBhcmVBcmdzID0gZnVuY3Rpb24gcHJlcGFyZUFyZ3MoX3N0YXRlLCBfYXJncykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICBBYnN0cmFjdE1hbmFnZXIucHJvdG90eXBlLmRpZENyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiBkaWRDcmVhdGVFbGVtZW50KF9jb21wb25lbnQsIF9lbGVtZW50LCBfb3BlcmF0aW9ucykge30KICAgICAgICAvLyBub29wCgogICAgICAgIC8vIGluaGVyaXRvcnMgc2hvdWxkIGFsc28gY2FsbCBgdGhpcy5kZWJ1Z1N0YWNrLnBvcCgpYCB0bwogICAgICAgIC8vIGVuc3VyZSB0aGUgcmVyZW5kZXJpbmcgYXNzZXJ0aW9uIG1lc3NhZ2VzIGFyZSBwcm9wZXJseQogICAgICAgIC8vIG1haW50YWluZWQKICAgICAgICA7CgogICAgICAgIEFic3RyYWN0TWFuYWdlci5wcm90b3R5cGUuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KF9jb21wb25lbnQsIF9ib3VuZHMpIHsKICAgICAgICAgICAgLy8gbm9vcAogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0TWFuYWdlci5wcm90b3R5cGUuZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKF9idWNrZXQpIHt9CiAgICAgICAgLy8gbm9vcAoKICAgICAgICAvLyBpbmhlcml0b3JzIHNob3VsZCBhbHNvIGNhbGwgYHRoaXMuX3B1c2hUb0RlYnVnU3RhY2tgCiAgICAgICAgLy8gdG8gZW5zdXJlIHRoZSByZXJlbmRlcmluZyBhc3NlcnRpb24gbWVzc2FnZXMgYXJlCiAgICAgICAgLy8gcHJvcGVybHkgbWFpbnRhaW5lZAogICAgICAgIDsKCiAgICAgICAgQWJzdHJhY3RNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoX2J1Y2tldCwgX2R5bmFtaWNTY29wZSkge30KICAgICAgICAvLyBub29wCgogICAgICAgIC8vIGluaGVyaXRvcnMgc2hvdWxkIGFsc28gY2FsbCBgdGhpcy5kZWJ1Z1N0YWNrLnBvcCgpYCB0bwogICAgICAgIC8vIGVuc3VyZSB0aGUgcmVyZW5kZXJpbmcgYXNzZXJ0aW9uIG1lc3NhZ2VzIGFyZSBwcm9wZXJseQogICAgICAgIC8vIG1haW50YWluZWQKICAgICAgICA7CgogICAgICAgIEFic3RyYWN0TWFuYWdlci5wcm90b3R5cGUuZGlkVXBkYXRlTGF5b3V0ID0gZnVuY3Rpb24gZGlkVXBkYXRlTGF5b3V0KF9idWNrZXQsIF9ib3VuZHMpIHsKICAgICAgICAgICAgLy8gbm9vcAogICAgICAgIH07CgogICAgICAgIEFic3RyYWN0TWFuYWdlci5wcm90b3R5cGUuZGlkVXBkYXRlID0gZnVuY3Rpb24gZGlkVXBkYXRlKF9idWNrZXQpIHsKICAgICAgICAgICAgLy8gbm9vcAogICAgICAgIH07CgogICAgICAgIHJldHVybiBBYnN0cmFjdE1hbmFnZXI7CiAgICB9KCk7CgogICAgaWYgKHRydWUpIHsKICAgICAgICBBYnN0cmFjdE1hbmFnZXIucHJvdG90eXBlLl9wdXNoVG9EZWJ1Z1N0YWNrID0gZnVuY3Rpb24gKG5hbWUsIGVudmlyb25tZW50KSB7CiAgICAgICAgICAgIHRoaXMuZGVidWdTdGFjayA9IGVudmlyb25tZW50LmRlYnVnU3RhY2s7CiAgICAgICAgICAgIHRoaXMuZGVidWdTdGFjay5wdXNoKG5hbWUpOwogICAgICAgIH07CiAgICAgICAgQWJzdHJhY3RNYW5hZ2VyLnByb3RvdHlwZS5fcHVzaEVuZ2luZVRvRGVidWdTdGFjayA9IGZ1bmN0aW9uIChuYW1lLCBlbnZpcm9ubWVudCkgewogICAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sgPSBlbnZpcm9ubWVudC5kZWJ1Z1N0YWNrOwogICAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sucHVzaEVuZ2luZShuYW1lKTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RydW1lbnRhdGlvblBheWxvYWQoZGVmKSB7CiAgICAgICAgcmV0dXJuIHsgb2JqZWN0OiBkZWYubmFtZSArICc6JyArIGRlZi5vdXRsZXQgfTsKICAgIH0KICAgIHZhciBDQVBBQklMSVRJRVMgPSB7CiAgICAgICAgZHluYW1pY0xheW91dDogZmFsc2UsCiAgICAgICAgZHluYW1pY1RhZzogZmFsc2UsCiAgICAgICAgcHJlcGFyZUFyZ3M6IGZhbHNlLAogICAgICAgIGNyZWF0ZUFyZ3M6IGZhbHNlLAogICAgICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgICAgIGVsZW1lbnRIb29rOiBmYWxzZSwKICAgICAgICBjcmVhdGVDYWxsZXI6IHRydWUsCiAgICAgICAgZHluYW1pY1Njb3BlOiB0cnVlLAogICAgICAgIHVwZGF0ZUhvb2s6IHRydWUsCiAgICAgICAgY3JlYXRlSW5zdGFuY2U6IHRydWUKICAgIH07CgogICAgdmFyIE91dGxldENvbXBvbmVudE1hbmFnZXIgPSBmdW5jdGlvbiAoX0Fic3RyYWN0TWFuYWdlcikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoT3V0bGV0Q29tcG9uZW50TWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcik7CgogICAgICAgIGZ1bmN0aW9uIE91dGxldENvbXBvbmVudE1hbmFnZXIoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgT3V0bGV0Q29tcG9uZW50TWFuYWdlcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0Fic3RyYWN0TWFuYWdlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIE91dGxldENvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnZpcm9ubWVudCwgZGVmaW5pdGlvbiwgX2FyZ3MsIGR5bmFtaWNTY29wZSkgewogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fcHVzaFRvRGVidWdTdGFjaygndGVtcGxhdGU6JyArIGRlZmluaXRpb24udGVtcGxhdGUucmVmZXJyZXIubW9kdWxlTmFtZSwgZW52aXJvbm1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGR5bmFtaWNTY29wZS5vdXRsZXRTdGF0ZSA9IGRlZmluaXRpb24ucmVmOwogICAgICAgICAgICAvLyB0aGlzIGlzIG9ubHkgdXNlZCBmb3IgcmVuZGVyIGhlbHBlciB3aGljaCBpcyBsZWdhY3kKICAgICAgICAgICAgaWYgKGR5bmFtaWNTY29wZS5yb290T3V0bGV0U3RhdGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZHluYW1pY1Njb3BlLnJvb3RPdXRsZXRTdGF0ZSA9IGR5bmFtaWNTY29wZS5vdXRsZXRTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IGRlZmluaXRpb24uY29udHJvbGxlcjsKICAgICAgICAgICAgdmFyIHNlbGYgPSBjb250cm9sbGVyID09PSB1bmRlZmluZWQgPyBfcnVudGltZS5VTkRFRklORURfUkVGRVJFTkNFIDogbmV3IFJvb3RSZWZlcmVuY2UoY29udHJvbGxlcik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBzZWxmOiBzZWxmLAogICAgICAgICAgICAgICAgZmluYWxpemU6ICgwLCBfaW5zdHJ1bWVudGF0aW9uLl9pbnN0cnVtZW50U3RhcnQpKCdyZW5kZXIub3V0bGV0JywgaW5zdHJ1bWVudGF0aW9uUGF5bG9hZCwgZGVmaW5pdGlvbikKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBPdXRsZXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5sYXlvdXRGb3IgPSBmdW5jdGlvbiBsYXlvdXRGb3IoX3N0YXRlLCBfY29tcG9uZW50LCBfZW52KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC4nKTsKICAgICAgICB9OwoKICAgICAgICBPdXRsZXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoX3JlZiwgX3Jlc29sdmVyKSB7CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IF9yZWYudGVtcGxhdGU7CgogICAgICAgICAgICAvLyBUaGUgcm91dGVyIGhhcyBhbHJlYWR5IHJlc29sdmVkIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUuYXNMYXlvdXQoKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICAgICAgICAgIHN5bWJvbFRhYmxlOiBsYXlvdXQuc3ltYm9sVGFibGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBPdXRsZXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgICAgICAgICAgIHJldHVybiBDQVBBQklMSVRJRVM7CiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0U2VsZiA9IGZ1bmN0aW9uIGdldFNlbGYoX3JlZjIpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSBfcmVmMi5zZWxmOwoKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKCkgewogICAgICAgICAgICAvLyBhbiBvdXRsZXQgaGFzIG5vIGhvb2tzCiAgICAgICAgICAgIHJldHVybiBfcmVmZXJlbmNlLkNPTlNUQU5UX1RBRzsKICAgICAgICB9OwoKICAgICAgICBPdXRsZXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5kaWRSZW5kZXJMYXlvdXQgPSBmdW5jdGlvbiBkaWRSZW5kZXJMYXlvdXQoc3RhdGUpIHsKICAgICAgICAgICAgc3RhdGUuZmluYWxpemUoKTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVidWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE91dGxldENvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gT3V0bGV0Q29tcG9uZW50TWFuYWdlcjsKICAgIH0oQWJzdHJhY3RNYW5hZ2VyKTsKCiAgICB2YXIgT1VUTEVUX01BTkFHRVIgPSBuZXcgT3V0bGV0Q29tcG9uZW50TWFuYWdlcigpOwoKICAgIHZhciBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uID0gZnVuY3Rpb24gT3V0bGV0Q29tcG9uZW50RGVmaW5pdGlvbihzdGF0ZSkgewogICAgICAgIHZhciBtYW5hZ2VyID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBPVVRMRVRfTUFOQUdFUjsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE91dGxldENvbXBvbmVudERlZmluaXRpb24pOwoKICAgICAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICAgICAgdGhpcy5tYW5hZ2VyID0gbWFuYWdlcjsKICAgIH07CgogICAgZnVuY3Rpb24gY3JlYXRlUm9vdE91dGxldChvdXRsZXRWaWV3KSB7CiAgICAgICAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5fQVBQTElDQVRJT05fVEVNUExBVEVfV1JBUFBFUikgewogICAgICAgICAgICB2YXIgV1JBUFBFRF9DQVBBQklMSVRJRVMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBDQVBBQklMSVRJRVMsIHsKICAgICAgICAgICAgICAgIGR5bmFtaWNUYWc6IHRydWUsCiAgICAgICAgICAgICAgICBlbGVtZW50SG9vazogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyID0gZnVuY3Rpb24gKF9PdXRsZXRDb21wb25lbnRNYW5hZykgewogICAgICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShXcmFwcGVkT3V0bGV0Q29tcG9uZW50TWFuYWdlciwgX091dGxldENvbXBvbmVudE1hbmFnKTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBXcmFwcGVkT3V0bGV0Q29tcG9uZW50TWFuYWdlcigpIHsKICAgICAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9PdXRsZXRDb21wb25lbnRNYW5hZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBXcmFwcGVkT3V0bGV0Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0VGFnTmFtZSA9IGZ1bmN0aW9uIGdldFRhZ05hbWUoX2NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnZGl2JzsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgV3JhcHBlZE91dGxldENvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldExheW91dCA9IGZ1bmN0aW9uIGdldExheW91dChzdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFRoZSByb3V0ZXIgaGFzIGFscmVhZHkgcmVzb2x2ZWQgdGhlIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gc3RhdGUudGVtcGxhdGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzV3JhcHBlZExheW91dCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgc3ltYm9sVGFibGU6IGxheW91dC5zeW1ib2xUYWJsZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFdSQVBQRURfQ0FQQUJJTElUSUVTOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBXcmFwcGVkT3V0bGV0Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZGlkQ3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIGRpZENyZWF0ZUVsZW1lbnQoY29tcG9uZW50LCBlbGVtZW50LCBfb3BlcmF0aW9ucykgewogICAgICAgICAgICAgICAgICAgIC8vIHRvIGFkZCBHVUlEIGlkIGFuZCBjbGFzcwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsICdlbWJlci12aWV3Jyk7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lkJywgKDAsIF9lbWJlclV0aWxzLmd1aWRGb3IpKGNvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4gV3JhcHBlZE91dGxldENvbXBvbmVudE1hbmFnZXI7CiAgICAgICAgICAgIH0oT3V0bGV0Q29tcG9uZW50TWFuYWdlcik7CiAgICAgICAgICAgIHZhciBXUkFQUEVEX09VVExFVF9NQU5BR0VSID0gbmV3IFdyYXBwZWRPdXRsZXRDb21wb25lbnRNYW5hZ2VyKCk7CiAgICAgICAgICAgIHJldHVybiBuZXcgT3V0bGV0Q29tcG9uZW50RGVmaW5pdGlvbihvdXRsZXRWaWV3LnN0YXRlLCBXUkFQUEVEX09VVExFVF9NQU5BR0VSKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbmV3IE91dGxldENvbXBvbmVudERlZmluaXRpb24ob3V0bGV0Vmlldy5zdGF0ZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1lbXB0eQogICAgZnVuY3Rpb24gTk9PUCgpIHt9CiAgICAvKioKICAgICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBSZXByZXNlbnRzIHRoZSBpbnRlcm5hbCBzdGF0ZSBvZiB0aGUgY29tcG9uZW50LgogICAgCiAgICAgIEBjbGFzcyBDb21wb25lbnRTdGF0ZUJ1Y2tldAogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICB2YXIgQ29tcG9uZW50U3RhdGVCdWNrZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50U3RhdGVCdWNrZXQoZW52aXJvbm1lbnQsIGNvbXBvbmVudCwgYXJncywgZmluYWxpemVyLCBoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbXBvbmVudFN0YXRlQnVja2V0KTsKCiAgICAgICAgICAgIHRoaXMuZW52aXJvbm1lbnQgPSBlbnZpcm9ubWVudDsKICAgICAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgICAgICAgIHRoaXMuYXJncyA9IGFyZ3M7CiAgICAgICAgICAgIHRoaXMuZmluYWxpemVyID0gZmluYWxpemVyOwogICAgICAgICAgICB0aGlzLmhhc1dyYXBwZWRFbGVtZW50ID0gaGFzV3JhcHBlZEVsZW1lbnQ7CiAgICAgICAgICAgIHRoaXMuY2xhc3NSZWYgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNsYXNzUmVmID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5hcmdzUmV2aXNpb24gPSBhcmdzID09PSBudWxsID8gMCA6IGFyZ3MudGFnLnZhbHVlKCk7CiAgICAgICAgfQoKICAgICAgICBDb21wb25lbnRTdGF0ZUJ1Y2tldC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudCwKICAgICAgICAgICAgICAgIGVudmlyb25tZW50ID0gdGhpcy5lbnZpcm9ubWVudDsKCiAgICAgICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbERlc3Ryb3lFbGVtZW50Jyk7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbENsZWFyUmVuZGVyJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW52aXJvbm1lbnQuZGVzdHJveWVkQ29tcG9uZW50cy5wdXNoKGNvbXBvbmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcG9uZW50U3RhdGVCdWNrZXQucHJvdG90eXBlLmZpbmFsaXplID0gZnVuY3Rpb24gZmluYWxpemUoKSB7CiAgICAgICAgICAgIHZhciBmaW5hbGl6ZXIgPSB0aGlzLmZpbmFsaXplcjsKCiAgICAgICAgICAgIGZpbmFsaXplcigpOwogICAgICAgICAgICB0aGlzLmZpbmFsaXplciA9IE5PT1A7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbXBvbmVudFN0YXRlQnVja2V0OwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIHJlZmVyZW5jZUZvcktleShjb21wb25lbnQsIGtleSkgewogICAgICAgIHJldHVybiBjb21wb25lbnRbUk9PVF9SRUZdLmdldChrZXkpOwogICAgfQogICAgZnVuY3Rpb24gcmVmZXJlbmNlRm9yUGFydHMoY29tcG9uZW50LCBwYXJ0cykgewogICAgICAgIHZhciBpc0F0dHJzID0gcGFydHNbMF0gPT09ICdhdHRycyc7CiAgICAgICAgLy8gVE9ETyBkZXByZWNhdGUgdGhpcwogICAgICAgIGlmIChpc0F0dHJzKSB7CiAgICAgICAgICAgIHBhcnRzLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWZlcmVuY2VGb3JLZXkoY29tcG9uZW50LCBwYXJ0c1swXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlZmVyZW5jZUZyb21QYXJ0cyhjb21wb25lbnRbUk9PVF9SRUZdLCBwYXJ0cyk7CiAgICB9CiAgICAvLyBUT0RPIHdlIHNob3VsZCBwcm9iYWJseSBkbyB0aGlzIHRyYW5zZm9ybSBhdCBidWlsZCB0aW1lCiAgICBmdW5jdGlvbiB3cmFwQ29tcG9uZW50Q2xhc3NBdHRyaWJ1dGUoaGFzaCkgewogICAgICAgIGlmIChoYXNoID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGtleXMgPSBoYXNoWzBdLAogICAgICAgICAgICB2YWx1ZXMgPSBoYXNoWzFdOwoKICAgICAgICB2YXIgaW5kZXggPSBrZXlzID09PSBudWxsID8gLTEgOiBrZXlzLmluZGV4T2YoJ2NsYXNzJyk7CiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZXNbaW5kZXhdOwogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGUgPSB2YWx1ZVswXTsKCiAgICAgICAgICAgIGlmICh0eXBlID09PSBfd2lyZUZvcm1hdC5PcHMuR2V0IHx8IHR5cGUgPT09IF93aXJlRm9ybWF0Lk9wcy5NYXliZUxvY2FsKSB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHZhbHVlW3ZhbHVlLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gcGF0aFtwYXRoLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgdmFsdWVzW2luZGV4XSA9IFtfd2lyZUZvcm1hdC5PcHMuSGVscGVyLCAnLWNsYXNzJywgW3ZhbHVlLCBwcm9wTmFtZV0sIG51bGxdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgdmFyIEF0dHJpYnV0ZUJpbmRpbmcgPSB7CiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uIChtaWNyb3N5bnRheCkgewogICAgICAgICAgICB2YXIgY29sb25JbmRleCA9IG1pY3Jvc3ludGF4LmluZGV4T2YoJzonKTsKICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKG1pY3Jvc3ludGF4ICE9PSAnY2xhc3MnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgdXNlIGNsYXNzIGFzIGFuIGF0dHJpYnV0ZUJpbmRpbmcsIHVzZSBjbGFzc05hbWVCaW5kaW5ncyBpbnN0ZWFkLicsIG1pY3Jvc3ludGF4ICE9PSAnY2xhc3MnKSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIFttaWNyb3N5bnRheCwgbWljcm9zeW50YXgsIHRydWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHByb3AgPSBtaWNyb3N5bnRheC5zdWJzdHJpbmcoMCwgY29sb25JbmRleCk7CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlID0gbWljcm9zeW50YXguc3Vic3RyaW5nKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICh0cnVlICYmICEoYXR0cmlidXRlICE9PSAnY2xhc3MnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgdXNlIGNsYXNzIGFzIGFuIGF0dHJpYnV0ZUJpbmRpbmcsIHVzZSBjbGFzc05hbWVCaW5kaW5ncyBpbnN0ZWFkLicsIGF0dHJpYnV0ZSAhPT0gJ2NsYXNzJykpOwoKICAgICAgICAgICAgICAgIHJldHVybiBbcHJvcCwgYXR0cmlidXRlLCBmYWxzZV07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGluc3RhbGw6IGZ1bmN0aW9uIChfZWxlbWVudCwgY29tcG9uZW50LCBwYXJzZWQsIG9wZXJhdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBwYXJzZWRbMF0sCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgPSBwYXJzZWRbMV0sCiAgICAgICAgICAgICAgICBpc1NpbXBsZSA9IHBhcnNlZFsyXTsKCiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGUgPT09ICdpZCcpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50SWQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShjb21wb25lbnQsIHByb3ApOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRJZCA9PT0gdW5kZWZpbmVkIHx8IGVsZW1lbnRJZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRJZCA9IGNvbXBvbmVudC5lbGVtZW50SWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGVtZW50SWQgPSBfcnVudGltZS5QcmltaXRpdmVSZWZlcmVuY2UuY3JlYXRlKGVsZW1lbnRJZCk7CiAgICAgICAgICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgnaWQnLCBlbGVtZW50SWQsIHRydWUsIG51bGwpOwogICAgICAgICAgICAgICAgLy8gb3BlcmF0aW9ucy5hZGRTdGF0aWNBdHRyaWJ1dGUoZWxlbWVudCwgJ2lkJywgZWxlbWVudElkKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNQYXRoID0gcHJvcC5pbmRleE9mKCcuJykgPiAtMTsKICAgICAgICAgICAgdmFyIHJlZmVyZW5jZSA9IGlzUGF0aCA/IHJlZmVyZW5jZUZvclBhcnRzKGNvbXBvbmVudCwgcHJvcC5zcGxpdCgnLicpKSA6IHJlZmVyZW5jZUZvcktleShjb21wb25lbnQsIHByb3ApOwogICAgICAgICAgICAodHJ1ZSAmJiAhKCEoaXNTaW1wbGUgJiYgaXNQYXRoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdJbGxlZ2FsIGF0dHJpYnV0ZUJpbmRpbmc6IFwnJyArIHByb3AgKyAnXCcgaXMgbm90IGEgdmFsaWQgYXR0cmlidXRlIG5hbWUuJywgIShpc1NpbXBsZSAmJiBpc1BhdGgpKSk7CgogICAgICAgICAgICBpZiAoYXR0cmlidXRlID09PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UgPSBuZXcgU3R5bGVCaW5kaW5nUmVmZXJlbmNlKHJlZmVyZW5jZSwgcmVmZXJlbmNlRm9yS2V5KGNvbXBvbmVudCwgJ2lzVmlzaWJsZScpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsIHJlZmVyZW5jZSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAvLyBvcGVyYXRpb25zLmFkZER5bmFtaWNBdHRyaWJ1dGUoZWxlbWVudCwgYXR0cmlidXRlLCByZWZlcmVuY2UsIGZhbHNlKTsKICAgICAgICB9CiAgICB9OwogICAgdmFyIERJU1BMQVlfTk9ORSA9ICdkaXNwbGF5OiBub25lOyc7CiAgICB2YXIgU0FGRV9ESVNQTEFZX05PTkUgPSBodG1sU2FmZShESVNQTEFZX05PTkUpOwoKICAgIHZhciBTdHlsZUJpbmRpbmdSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoU3R5bGVCaW5kaW5nUmVmZXJlbmNlLCBfQ2FjaGVkUmVmZXJlbmNlKTsKCiAgICAgICAgZnVuY3Rpb24gU3R5bGVCaW5kaW5nUmVmZXJlbmNlKGlubmVyLCBpc1Zpc2libGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBTdHlsZUJpbmRpbmdSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzMjUgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZS5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzMjUuaW5uZXIgPSBpbm5lcjsKICAgICAgICAgICAgX3RoaXMyNS5pc1Zpc2libGUgPSBpc1Zpc2libGU7CiAgICAgICAgICAgIF90aGlzMjUudGFnID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW2lubmVyLnRhZywgaXNWaXNpYmxlLnRhZ10pOwogICAgICAgICAgICByZXR1cm4gX3RoaXMyNTsKICAgICAgICB9CgogICAgICAgIFN0eWxlQmluZGluZ1JlZmVyZW5jZS5wcm90b3R5cGUuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuaW5uZXIudmFsdWUoKTsKICAgICAgICAgICAgdmFyIGlzVmlzaWJsZSA9IHRoaXMuaXNWaXNpYmxlLnZhbHVlKCk7CiAgICAgICAgICAgIGlmIChpc1Zpc2libGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU0FGRV9ESVNQTEFZX05PTkU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGUgPSB2YWx1ZSArICcgJyArIERJU1BMQVlfTk9ORTsKICAgICAgICAgICAgICAgIHJldHVybiBpc0hUTUxTYWZlKHZhbHVlKSA/IGh0bWxTYWZlKHN0eWxlKSA6IHN0eWxlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFN0eWxlQmluZGluZ1JlZmVyZW5jZTsKICAgIH0oX3JlZmVyZW5jZS5DYWNoZWRSZWZlcmVuY2UpOwoKICAgIHZhciBJc1Zpc2libGVCaW5kaW5nID0gewogICAgICAgIGluc3RhbGw6IGZ1bmN0aW9uIChfZWxlbWVudCwgY29tcG9uZW50LCBvcGVyYXRpb25zKSB7CiAgICAgICAgICAgIG9wZXJhdGlvbnMuc2V0QXR0cmlidXRlKCdzdHlsZScsICgwLCBfcmVmZXJlbmNlLm1hcCkocmVmZXJlbmNlRm9yS2V5KGNvbXBvbmVudCwgJ2lzVmlzaWJsZScpLCB0aGlzLm1hcFN0eWxlVmFsdWUpLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgIC8vIC8vIHRoZSB1cHN0cmVhbSB0eXBlIGZvciBhZGREeW5hbWljQXR0cmlidXRlJ3MgYHZhbHVlYCBhcmd1bWVudAogICAgICAgICAgICAvLyAvLyBhcHBlYXJzIHRvIGJlIGluY29ycmVjdC4gSXQgaXMgY3VycmVudGx5IGEgUmVmZXJlbmNlPHN0cmluZz4sIEkKICAgICAgICAgICAgLy8gLy8gdGhpbmsgaXQgc2hvdWxkIGJlIGEgUmVmZXJlbmNlPHN0cmluZ3xudWxsPi4KICAgICAgICAgICAgLy8gb3BlcmF0aW9ucy5hZGREeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsICdzdHlsZScsIHJlZiBhcyBhbnkgYXMgUmVmZXJlbmNlPHN0cmluZz4sIGZhbHNlKTsKICAgICAgICB9LAogICAgICAgIG1hcFN0eWxlVmFsdWU6IGZ1bmN0aW9uIChpc1Zpc2libGUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzVmlzaWJsZSA9PT0gZmFsc2UgPyBTQUZFX0RJU1BMQVlfTk9ORSA6IG51bGw7CiAgICAgICAgfQogICAgfTsKICAgIHZhciBDbGFzc05hbWVCaW5kaW5nID0gewogICAgICAgIGluc3RhbGw6IGZ1bmN0aW9uIChfZWxlbWVudCwgY29tcG9uZW50LCBtaWNyb3N5bnRheCwgb3BlcmF0aW9ucykgewogICAgICAgICAgICB2YXIgX21pY3Jvc3ludGF4JHNwbGl0ID0gbWljcm9zeW50YXguc3BsaXQoJzonKSwKICAgICAgICAgICAgICAgIHByb3AgPSBfbWljcm9zeW50YXgkc3BsaXRbMF0sCiAgICAgICAgICAgICAgICB0cnV0aHkgPSBfbWljcm9zeW50YXgkc3BsaXRbMV0sCiAgICAgICAgICAgICAgICBmYWxzeSA9IF9taWNyb3N5bnRheCRzcGxpdFsyXTsKCiAgICAgICAgICAgIHZhciBpc1N0YXRpYyA9IHByb3AgPT09ICcnOwogICAgICAgICAgICBpZiAoaXNTdGF0aWMpIHsKICAgICAgICAgICAgICAgIG9wZXJhdGlvbnMuc2V0QXR0cmlidXRlKCdjbGFzcycsIF9ydW50aW1lLlByaW1pdGl2ZVJlZmVyZW5jZS5jcmVhdGUodHJ1dGh5KSwgdHJ1ZSwgbnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXNQYXRoID0gcHJvcC5pbmRleE9mKCcuJykgPiAtMTsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGlzUGF0aCA/IHByb3Auc3BsaXQoJy4nKSA6IFtdOwogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gaXNQYXRoID8gcmVmZXJlbmNlRm9yUGFydHMoY29tcG9uZW50LCBwYXJ0cykgOiByZWZlcmVuY2VGb3JLZXkoY29tcG9uZW50LCBwcm9wKTsKICAgICAgICAgICAgICAgIHZhciByZWYgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAodHJ1dGh5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZWYgPSBuZXcgU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZSh2YWx1ZSwgaXNQYXRoID8gcGFydHNbcGFydHMubGVuZ3RoIC0gMV0gOiBwcm9wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVmID0gbmV3IENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZSh2YWx1ZSwgdHJ1dGh5LCBmYWxzeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCByZWYsIGZhbHNlLCBudWxsKTsKICAgICAgICAgICAgICAgIC8vIC8vIHRoZSB1cHN0cmVhbSB0eXBlIGZvciBhZGREeW5hbWljQXR0cmlidXRlJ3MgYHZhbHVlYCBhcmd1bWVudAogICAgICAgICAgICAgICAgLy8gLy8gYXBwZWFycyB0byBiZSBpbmNvcnJlY3QuIEl0IGlzIGN1cnJlbnRseSBhIFJlZmVyZW5jZTxzdHJpbmc+LCBJCiAgICAgICAgICAgICAgICAvLyAvLyB0aGluayBpdCBzaG91bGQgYmUgYSBSZWZlcmVuY2U8c3RyaW5nfG51bGw+LgogICAgICAgICAgICAgICAgLy8gb3BlcmF0aW9ucy5hZGREeW5hbWljQXR0cmlidXRlKGVsZW1lbnQsICdjbGFzcycsIHJlZiBhcyBhbnkgYXMgUmVmZXJlbmNlPHN0cmluZz4sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgdmFyIFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UgPSBmdW5jdGlvbiAoX0NhY2hlZFJlZmVyZW5jZTIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UyKTsKCiAgICAgICAgZnVuY3Rpb24gU2ltcGxlQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZShpbm5lciwgcGF0aCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzMjYgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZTIuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczI2LmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIF90aGlzMjYucGF0aCA9IHBhdGg7CiAgICAgICAgICAgIF90aGlzMjYudGFnID0gaW5uZXIudGFnOwogICAgICAgICAgICBfdGhpczI2LmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIF90aGlzMjYucGF0aCA9IHBhdGg7CiAgICAgICAgICAgIF90aGlzMjYuZGFzaGVyaXplZFBhdGggPSBudWxsOwogICAgICAgICAgICByZXR1cm4gX3RoaXMyNjsKICAgICAgICB9CgogICAgICAgIFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmlubmVyLnZhbHVlKCk7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgdmFyIHBhdGggPSB0aGlzLnBhdGgsCiAgICAgICAgICAgICAgICAgICAgZGFzaGVyaXplZFBhdGggPSB0aGlzLmRhc2hlcml6ZWRQYXRoOwoKICAgICAgICAgICAgICAgIHJldHVybiBkYXNoZXJpemVkUGF0aCB8fCAodGhpcy5kYXNoZXJpemVkUGF0aCA9ICgwLCBfc3RyaW5nLmRhc2hlcml6ZSkocGF0aCkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIHx8IHZhbHVlID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2U7CiAgICB9KF9yZWZlcmVuY2UuQ2FjaGVkUmVmZXJlbmNlKTsKCiAgICB2YXIgQ29sb25DbGFzc05hbWVCaW5kaW5nUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UzKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShDb2xvbkNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UzKTsKCiAgICAgICAgZnVuY3Rpb24gQ29sb25DbGFzc05hbWVCaW5kaW5nUmVmZXJlbmNlKGlubmVyKSB7CiAgICAgICAgICAgIHZhciB0cnV0aHkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAgICAgICAgIHZhciBmYWxzeSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb2xvbkNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzMjcgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZTMuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczI3LmlubmVyID0gaW5uZXI7CiAgICAgICAgICAgIF90aGlzMjcudHJ1dGh5ID0gdHJ1dGh5OwogICAgICAgICAgICBfdGhpczI3LmZhbHN5ID0gZmFsc3k7CiAgICAgICAgICAgIF90aGlzMjcudGFnID0gaW5uZXIudGFnOwogICAgICAgICAgICByZXR1cm4gX3RoaXMyNzsKICAgICAgICB9CgogICAgICAgIENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZS5wcm90b3R5cGUuY29tcHV0ZSA9IGZ1bmN0aW9uIGNvbXB1dGUoKSB7CiAgICAgICAgICAgIHZhciBpbm5lciA9IHRoaXMuaW5uZXIsCiAgICAgICAgICAgICAgICB0cnV0aHkgPSB0aGlzLnRydXRoeSwKICAgICAgICAgICAgICAgIGZhbHN5ID0gdGhpcy5mYWxzeTsKCiAgICAgICAgICAgIHJldHVybiBpbm5lci52YWx1ZSgpID8gdHJ1dGh5IDogZmFsc3k7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbG9uQ2xhc3NOYW1lQmluZGluZ1JlZmVyZW5jZTsKICAgIH0oX3JlZmVyZW5jZS5DYWNoZWRSZWZlcmVuY2UpOwoKICAgIC8vIENvbXBvbmVudEFyZ3MgdGFrZXMgRXZhbHVhdGVkTmFtZWRBcmdzIGFuZCBjb252ZXJ0cyB0aGVtIGludG8gdGhlCiAgICAvLyBpbnB1dHMgbmVlZGVkIGJ5IEN1cmx5Q29tcG9uZW50cyAoYXR0cnMgYW5kIHByb3BzLCB3aXRoIG11dGFibGUKICAgIC8vIGNlbGxzLCBldGMpLgogICAgZnVuY3Rpb24gcHJvY2Vzc0NvbXBvbmVudEFyZ3MobmFtZWRBcmdzKSB7CiAgICAgICAgdmFyIGtleXMgPSBuYW1lZEFyZ3MubmFtZXM7CiAgICAgICAgdmFyIGF0dHJzID0gbmFtZWRBcmdzLnZhbHVlKCk7CiAgICAgICAgdmFyIHByb3BzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB2YXIgYXJncyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgcHJvcHNbQVJHU10gPSBhcmdzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgbmFtZSA9IGtleXNbaV07CiAgICAgICAgICAgIHZhciByZWYgPSBuYW1lZEFyZ3MuZ2V0KG5hbWUpOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBhdHRyc1tuYW1lXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiB2YWx1ZVtBQ1RJT05dKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZltVUERBVEVdKSB7CiAgICAgICAgICAgICAgICBhdHRyc1tuYW1lXSA9IG5ldyBNdXRhYmxlQ2VsbChyZWYsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhcmdzW25hbWVdID0gcmVmOwogICAgICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBwcm9wcy5hdHRycyA9IGF0dHJzOwogICAgICAgIHJldHVybiBwcm9wczsKICAgIH0KICAgIHZhciBSRUYgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnUkVGJyk7CgogICAgdmFyIE11dGFibGVDZWxsID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIE11dGFibGVDZWxsKHJlZiwgdmFsdWUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBNdXRhYmxlQ2VsbCk7CgogICAgICAgICAgICB0aGlzW19lbWJlclZpZXdzLk1VVEFCTEVfQ0VMTF0gPSB0cnVlOwogICAgICAgICAgICB0aGlzW1JFRl0gPSByZWY7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIE11dGFibGVDZWxsLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUodmFsKSB7CiAgICAgICAgICAgIHRoaXNbUkVGXVtVUERBVEVdKHZhbCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE11dGFibGVDZWxsOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGFsaWFzSWRUb0VsZW1lbnRJZChhcmdzLCBwcm9wcykgewogICAgICAgIGlmIChhcmdzLm5hbWVkLmhhcygnaWQnKSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCFhcmdzLm5hbWVkLmhhcygnZWxlbWVudElkJykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBpbnZva2UgYSBjb21wb25lbnQgd2l0aCBib3RoIFwnaWRcJyBhbmQgXCdlbGVtZW50SWRcJyBhdCB0aGUgc2FtZSB0aW1lLicsICFhcmdzLm5hbWVkLmhhcygnZWxlbWVudElkJykpKTsKCiAgICAgICAgICAgIHByb3BzLmVsZW1lbnRJZCA9IHByb3BzLmlkOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzVGVtcGxhdGVGYWN0b3J5KHRlbXBsYXRlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB0ZW1wbGF0ZS5jcmVhdGUgPT09ICdmdW5jdGlvbic7CiAgICB9CiAgICAvLyBXZSBtdXN0IHRyYXZlcnNlIHRoZSBhdHRyaWJ1dGVCaW5kaW5ncyBpbiByZXZlcnNlIGtlZXBpbmcgdHJhY2sgb2YKICAgIC8vIHdoYXQgaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkLiBUaGlzIGlzIGVzc2VudGlhbGx5IHJlZmluaW5nIHRoZSBjb25jYXRlbmF0ZWQKICAgIC8vIHByb3BlcnRpZXMgYXBwbHlpbmcgcmlnaHQgdG8gbGVmdC4KICAgIGZ1bmN0aW9uIGFwcGx5QXR0cmlidXRlQmluZGluZ3MoZWxlbWVudCwgYXR0cmlidXRlQmluZGluZ3MsIGNvbXBvbmVudCwgb3BlcmF0aW9ucykgewogICAgICAgIHZhciBzZWVuID0gW107CiAgICAgICAgdmFyIGkgPSBhdHRyaWJ1dGVCaW5kaW5ncy5sZW5ndGggLSAxOwogICAgICAgIHdoaWxlIChpICE9PSAtMSkgewogICAgICAgICAgICB2YXIgYmluZGluZyA9IGF0dHJpYnV0ZUJpbmRpbmdzW2ldOwogICAgICAgICAgICB2YXIgcGFyc2VkID0gQXR0cmlidXRlQmluZGluZy5wYXJzZShiaW5kaW5nKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IHBhcnNlZFsxXTsKICAgICAgICAgICAgaWYgKHNlZW4uaW5kZXhPZihhdHRyaWJ1dGUpID09PSAtMSkgewogICAgICAgICAgICAgICAgc2Vlbi5wdXNoKGF0dHJpYnV0ZSk7CiAgICAgICAgICAgICAgICBBdHRyaWJ1dGVCaW5kaW5nLmluc3RhbGwoZWxlbWVudCwgY29tcG9uZW50LCBwYXJzZWQsIG9wZXJhdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGktLTsKICAgICAgICB9CiAgICAgICAgaWYgKHNlZW4uaW5kZXhPZignaWQnKSA9PT0gLTEpIHsKICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2lkJywgX3J1bnRpbWUuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShjb21wb25lbnQuZWxlbWVudElkKSwgdHJ1ZSwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIGlmIChzZWVuLmluZGV4T2YoJ3N0eWxlJykgPT09IC0xKSB7CiAgICAgICAgICAgIElzVmlzaWJsZUJpbmRpbmcuaW5zdGFsbChlbGVtZW50LCBjb21wb25lbnQsIG9wZXJhdGlvbnMpOwogICAgICAgIH0KICAgIH0KICAgIHZhciBERUZBVUxUX0xBWU9VVCA9ICgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0KTsKCiAgICB2YXIgQ3VybHlDb21wb25lbnRNYW5hZ2VyID0gZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXIyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShDdXJseUNvbXBvbmVudE1hbmFnZXIsIF9BYnN0cmFjdE1hbmFnZXIyKTsKCiAgICAgICAgZnVuY3Rpb24gQ3VybHlDb21wb25lbnRNYW5hZ2VyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEN1cmx5Q29tcG9uZW50TWFuYWdlcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0Fic3RyYWN0TWFuYWdlcjIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldExheW91dCA9IGZ1bmN0aW9uIGdldExheW91dChzdGF0ZSwgX3Jlc29sdmVyKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAvLyBUT0RPIGZpeAogICAgICAgICAgICAgICAgaGFuZGxlOiBzdGF0ZS5oYW5kbGUsCiAgICAgICAgICAgICAgICBzeW1ib2xUYWJsZTogc3RhdGUuc3ltYm9sVGFibGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLnRlbXBsYXRlRm9yID0gZnVuY3Rpb24gdGVtcGxhdGVGb3IoY29tcG9uZW50LCByZXNvbHZlcikgewogICAgICAgICAgICB2YXIgbGF5b3V0ID0gKDAsIF9lbWJlck1ldGFsLmdldCkoY29tcG9uZW50LCAnbGF5b3V0Jyk7CiAgICAgICAgICAgIGlmIChsYXlvdXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBjYWNoZWQgYnkgdGVtcGxhdGUuaWQKICAgICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlRmFjdG9yeShsYXlvdXQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVyLmNyZWF0ZVRlbXBsYXRlKGxheW91dCwgKDAsIF9lbWJlck93bmVyLmdldE93bmVyKShjb21wb25lbnQpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugd2VyZSBwcm92aWRlZCBhbiBpbnN0YW5jZSBhbHJlYWR5CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxheW91dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKGNvbXBvbmVudCk7CiAgICAgICAgICAgIHZhciBsYXlvdXROYW1lID0gKDAsIF9lbWJlck1ldGFsLmdldCkoY29tcG9uZW50LCAnbGF5b3V0TmFtZScpOwogICAgICAgICAgICBpZiAobGF5b3V0TmFtZSkgewogICAgICAgICAgICAgICAgdmFyIF90ZW1wbGF0ZSA9IG93bmVyLmxvb2t1cCgndGVtcGxhdGU6JyArIGxheW91dE5hbWUpOwogICAgICAgICAgICAgICAgaWYgKF90ZW1wbGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGVtcGxhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG93bmVyLmxvb2t1cChERUZBVUxUX0xBWU9VVCk7CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXREeW5hbWljTGF5b3V0ID0gZnVuY3Rpb24gZ2V0RHluYW1pY0xheW91dChfcmVmMywgcmVzb2x2ZXIpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IF9yZWYzLmNvbXBvbmVudDsKCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVGb3IoY29tcG9uZW50LCByZXNvbHZlcik7CiAgICAgICAgICAgIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZS5hc1dyYXBwZWRMYXlvdXQoKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICAgICAgICAgIHN5bWJvbFRhYmxlOiBsYXlvdXQuc3ltYm9sVGFibGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldFRhZ05hbWUgPSBmdW5jdGlvbiBnZXRUYWdOYW1lKHN0YXRlKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBzdGF0ZS5jb21wb25lbnQsCiAgICAgICAgICAgICAgICBoYXNXcmFwcGVkRWxlbWVudCA9IHN0YXRlLmhhc1dyYXBwZWRFbGVtZW50OwoKICAgICAgICAgICAgaWYgKCFoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudCAmJiBjb21wb25lbnQudGFnTmFtZSB8fCAnZGl2JzsKICAgICAgICB9OwoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uIGdldENhcGFiaWxpdGllcyhzdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gc3RhdGUuY2FwYWJpbGl0aWVzOwogICAgICAgIH07CgogICAgICAgIEN1cmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUucHJlcGFyZUFyZ3MgPSBmdW5jdGlvbiBwcmVwYXJlQXJncyhzdGF0ZSwgYXJncykgewogICAgICAgICAgICB2YXIgcG9zaXRpb25hbFBhcmFtcyA9IHN0YXRlLkNvbXBvbmVudENsYXNzLmNsYXNzLnBvc2l0aW9uYWxQYXJhbXM7CgogICAgICAgICAgICAvLyBlYXJseSBleGl0cwogICAgICAgICAgICBpZiAocG9zaXRpb25hbFBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBvc2l0aW9uYWxQYXJhbXMgPT09IG51bGwgfHwgYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5hbWVkID0gdm9pZCAwOwogICAgICAgICAgICBpZiAodHlwZW9mIHBvc2l0aW9uYWxQYXJhbXMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICB2YXIgX25hbWVkOwoKICAgICAgICAgICAgICAgICh0cnVlICYmICEoIWFyZ3MubmFtZWQuaGFzKHBvc2l0aW9uYWxQYXJhbXMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3Qgc3BlY2lmeSBwb3NpdGlvbmFsIHBhcmFtZXRlcnMgYW5kIHRoZSBoYXNoIGFyZ3VtZW50IGAnICsgcG9zaXRpb25hbFBhcmFtcyArICdgLicsICFhcmdzLm5hbWVkLmhhcyhwb3NpdGlvbmFsUGFyYW1zKSkpOwoKICAgICAgICAgICAgICAgIG5hbWVkID0gKF9uYW1lZCA9IHt9LCBfbmFtZWRbcG9zaXRpb25hbFBhcmFtc10gPSBhcmdzLnBvc2l0aW9uYWwuY2FwdHVyZSgpLCBfbmFtZWQpOwogICAgICAgICAgICAgICAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShuYW1lZCwgYXJncy5uYW1lZC5jYXB0dXJlKCkubWFwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHBvc2l0aW9uYWxQYXJhbXMpICYmIHBvc2l0aW9uYWxQYXJhbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGNvdW50ID0gTWF0aC5taW4ocG9zaXRpb25hbFBhcmFtcy5sZW5ndGgsIGFyZ3MucG9zaXRpb25hbC5sZW5ndGgpOwogICAgICAgICAgICAgICAgbmFtZWQgPSB7fTsKICAgICAgICAgICAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikobmFtZWQsIGFyZ3MubmFtZWQuY2FwdHVyZSgpLm1hcCk7CiAgICAgICAgICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5QT1NJVElPTkFMX1BBUkFNX0NPTkZMSUNUKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcG9zaXRpb25hbFBhcmFtc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgKHRydWUgJiYgISghYXJncy5uYW1lZC5oYXMobmFtZSkpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnWW91IGNhbm5vdCBzcGVjaWZ5IGJvdGggYSBwb3NpdGlvbmFsIHBhcmFtIChhdCBwb3NpdGlvbiAnICsgaSArICcpIGFuZCB0aGUgaGFzaCBhcmd1bWVudCBgJyArIG5hbWUgKyAnYC4nLCAhYXJncy5uYW1lZC5oYXMobmFtZSksIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItZ2xpbW1lci5wb3NpdGlvbmFsLXBhcmFtLWNvbmZsaWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVudGlsOiAnMy41LjAnCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVkW25hbWVdID0gYXJncy5wb3NpdGlvbmFsLmF0KGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7IHBvc2l0aW9uYWw6IF91dGlsLkVNUFRZX0FSUkFZLCBuYW1lZDogbmFtZWQgfTsKICAgICAgICB9OwoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnZpcm9ubWVudCwgc3RhdGUsIGFyZ3MsIGR5bmFtaWNTY29wZSwgY2FsbGVyU2VsZlJlZiwgaGFzQmxvY2spIHsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3B1c2hUb0RlYnVnU3RhY2soJ2NvbXBvbmVudDonICsgc3RhdGUubmFtZSwgZW52aXJvbm1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEdldCB0aGUgbmVhcmVzdCBjb25jcmV0ZSBjb21wb25lbnQgaW5zdGFuY2UgZnJvbSB0aGUgc2NvcGUuICJWaXJ0dWFsIgogICAgICAgICAgICAvLyBjb21wb25lbnRzIHdpbGwgYmUgc2tpcHBlZC4KICAgICAgICAgICAgdmFyIHBhcmVudFZpZXcgPSBkeW5hbWljU2NvcGUudmlldzsKICAgICAgICAgICAgLy8gR2V0IHRoZSBFbWJlci5Db21wb25lbnQgc3ViY2xhc3MgdG8gaW5zdGFudGlhdGUgZm9yIHRoaXMgY29tcG9uZW50LgogICAgICAgICAgICB2YXIgZmFjdG9yeSA9IHN0YXRlLkNvbXBvbmVudENsYXNzOwogICAgICAgICAgICAvLyBDYXB0dXJlIHRoZSBhcmd1bWVudHMsIHdoaWNoIHRlbGxzIEdsaW1tZXIgdG8gZ2l2ZSB1cyBvdXIgb3duLCBzdGFibGUKICAgICAgICAgICAgLy8gY29weSBvZiB0aGUgQXJndW1lbnRzIG9iamVjdCB0aGF0IGlzIHNhZmUgdG8gaG9sZCBvbiB0byBiZXR3ZWVuIHJlbmRlcnMuCiAgICAgICAgICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBhcmdzLm5hbWVkLmNhcHR1cmUoKTsKICAgICAgICAgICAgdmFyIHByb3BzID0gcHJvY2Vzc0NvbXBvbmVudEFyZ3MoY2FwdHVyZWRBcmdzKTsKICAgICAgICAgICAgLy8gQWxpYXMgYGlkYCBhcmd1bWVudCB0byBgZWxlbWVudElkYCBwcm9wZXJ0eSBvbiB0aGUgY29tcG9uZW50IGluc3RhbmNlLgogICAgICAgICAgICBhbGlhc0lkVG9FbGVtZW50SWQoYXJncywgcHJvcHMpOwogICAgICAgICAgICAvLyBTZXQgY29tcG9uZW50IGluc3RhbmNlJ3MgcGFyZW50VmlldyBwcm9wZXJ0eSB0byBwb2ludCB0byBuZWFyZXN0IGNvbmNyZXRlCiAgICAgICAgICAgIC8vIGNvbXBvbmVudC4KICAgICAgICAgICAgcHJvcHMucGFyZW50VmlldyA9IHBhcmVudFZpZXc7CiAgICAgICAgICAgIC8vIFNldCB3aGV0aGVyIHRoaXMgY29tcG9uZW50IHdhcyBpbnZva2VkIHdpdGggYSBibG9jawogICAgICAgICAgICAvLyAoYHt7I215LWNvbXBvbmVudH19e3svbXktY29tcG9uZW50fX1gKSBvciB3aXRob3V0IG9uZQogICAgICAgICAgICAvLyAoYHt7bXktY29tcG9uZW50fX1gKS4KICAgICAgICAgICAgcHJvcHNbSEFTX0JMT0NLXSA9IGhhc0Jsb2NrOwogICAgICAgICAgICAvLyBTYXZlIHRoZSBjdXJyZW50IGB0aGlzYCBjb250ZXh0IG9mIHRoZSB0ZW1wbGF0ZSBhcyB0aGUgY29tcG9uZW50J3MKICAgICAgICAgICAgLy8gYF90YXJnZXRPYmplY3RgLCBzbyBidWJibGVkIGFjdGlvbnMgYXJlIHJvdXRlZCB0byB0aGUgcmlnaHQgcGxhY2UuCiAgICAgICAgICAgIHByb3BzLl90YXJnZXRPYmplY3QgPSBjYWxsZXJTZWxmUmVmLnZhbHVlKCk7CiAgICAgICAgICAgIC8vIHN0YXRpYyBsYXlvdXQgYXNzZXJ0cyBDdXJyaWVkRGVmaW5pdGlvbgogICAgICAgICAgICBpZiAoc3RhdGUudGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgIHByb3BzLmxheW91dCA9IHN0YXRlLnRlbXBsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vdyB0aGF0IHdlJ3ZlIGJ1aWx0IHVwIGFsbCBvZiB0aGUgcHJvcGVydGllcyB0byBzZXQgb24gdGhlIGNvbXBvbmVudCBpbnN0YW5jZSwKICAgICAgICAgICAgLy8gYWN0dWFsbHkgY3JlYXRlIGl0LgogICAgICAgICAgICB2YXIgY29tcG9uZW50ID0gZmFjdG9yeS5jcmVhdGUocHJvcHMpOwogICAgICAgICAgICB2YXIgZmluYWxpemVyID0gKDAsIF9pbnN0cnVtZW50YXRpb24uX2luc3RydW1lbnRTdGFydCkoJ3JlbmRlci5jb21wb25lbnQnLCBpbml0aWFsUmVuZGVySW5zdHJ1bWVudERldGFpbHMsIGNvbXBvbmVudCk7CiAgICAgICAgICAgIC8vIFdlIGJlY29tZSB0aGUgbmV3IHBhcmVudFZpZXcgZm9yIGRvd25zdHJlYW0gY29tcG9uZW50cywgc28gc2F2ZSBvdXIKICAgICAgICAgICAgLy8gY29tcG9uZW50IG9mZiBvbiB0aGUgZHluYW1pYyBzY29wZS4KICAgICAgICAgICAgZHluYW1pY1Njb3BlLnZpZXcgPSBjb21wb25lbnQ7CiAgICAgICAgICAgIC8vIFVubGVzcyB3ZSdyZSB0aGUgcm9vdCBjb21wb25lbnQsIHdlIG5lZWQgdG8gYWRkIG91cnNlbHZlcyB0byBvdXIgcGFyZW50CiAgICAgICAgICAgIC8vIGNvbXBvbmVudCdzIGNoaWxkVmlld3MgYXJyYXkuCiAgICAgICAgICAgIGlmIChwYXJlbnRWaWV3ICE9PSBudWxsICYmIHBhcmVudFZpZXcgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgKDAsIF9lbWJlclZpZXdzLmFkZENoaWxkVmlldykocGFyZW50VmlldywgY29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfRElEX0lOSVRfQVRUUlNfU1VQUE9SVCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZEluaXRBdHRycycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCdkaWRSZWNlaXZlQXR0cnMnKTsKICAgICAgICAgICAgdmFyIGhhc1dyYXBwZWRFbGVtZW50ID0gY29tcG9uZW50LnRhZ05hbWUgIT09ICcnOwogICAgICAgICAgICAvLyBXZSB1c3VhbGx5IGRvIHRoaXMgaW4gdGhlIGBkaWRDcmVhdGVFbGVtZW50YCwgYnV0IHRoYXQgaG9vayBkb2Vzbid0IGZpcmUgZm9yIHRhZ2xlc3MgY29tcG9uZW50cwogICAgICAgICAgICBpZiAoIWhhc1dyYXBwZWRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsUmVuZGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb21wb25lbnQuX3RyYW5zaXRpb25UbygnaGFzRWxlbWVudCcpOwogICAgICAgICAgICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbEluc2VydEVsZW1lbnQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBUcmFjayBhZGRpdGlvbmFsIGxpZmVjeWNsZSBtZXRhZGF0YSBhYm91dCB0aGlzIGNvbXBvbmVudCBpbiBhIHN0YXRlIGJ1Y2tldC4KICAgICAgICAgICAgLy8gRXNzZW50aWFsbHkgd2UncmUgc2F2aW5nIG9mZiBhbGwgdGhlIHN0YXRlIHdlJ2xsIG5lZWQgaW4gdGhlIGZ1dHVyZS4KICAgICAgICAgICAgdmFyIGJ1Y2tldCA9IG5ldyBDb21wb25lbnRTdGF0ZUJ1Y2tldChlbnZpcm9ubWVudCwgY29tcG9uZW50LCBjYXB0dXJlZEFyZ3MsIGZpbmFsaXplciwgaGFzV3JhcHBlZEVsZW1lbnQpOwogICAgICAgICAgICBpZiAoYXJncy5uYW1lZC5oYXMoJ2NsYXNzJykpIHsKICAgICAgICAgICAgICAgIGJ1Y2tldC5jbGFzc1JlZiA9IGFyZ3MubmFtZWQuZ2V0KCdjbGFzcycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICBwcm9jZXNzQ29tcG9uZW50SW5pdGlhbGl6YXRpb25Bc3NlcnRpb25zKGNvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlICYmIGhhc1dyYXBwZWRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbFJlbmRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBidWNrZXQ7CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZihfcmVmNCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjQuY29tcG9uZW50OwoKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudFtST09UX1JFRl07CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5kaWRDcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gZGlkQ3JlYXRlRWxlbWVudChfcmVmNSwgZWxlbWVudCwgb3BlcmF0aW9ucykgewogICAgICAgICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjUuY29tcG9uZW50LAogICAgICAgICAgICAgICAgY2xhc3NSZWYgPSBfcmVmNS5jbGFzc1JlZiwKICAgICAgICAgICAgICAgIGVudmlyb25tZW50ID0gX3JlZjUuZW52aXJvbm1lbnQ7CgogICAgICAgICAgICAoMCwgX2VtYmVyVmlld3Muc2V0Vmlld0VsZW1lbnQpKGNvbXBvbmVudCwgZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVCaW5kaW5ncyA9IGNvbXBvbmVudC5hdHRyaWJ1dGVCaW5kaW5ncywKICAgICAgICAgICAgICAgIGNsYXNzTmFtZXMgPSBjb21wb25lbnQuY2xhc3NOYW1lcywKICAgICAgICAgICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwoKICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2lkJywgX3J1bnRpbWUuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZSgoMCwgX2VtYmVyVXRpbHMuZ3VpZEZvcikoY29tcG9uZW50KSksIGZhbHNlLCBudWxsKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZUJpbmRpbmdzICYmIGF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYXBwbHlBdHRyaWJ1dGVCaW5kaW5ncyhlbGVtZW50LCBhdHRyaWJ1dGVCaW5kaW5ncywgY29tcG9uZW50LCBvcGVyYXRpb25zKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnQuZWxlbWVudElkKSB7CiAgICAgICAgICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2lkJywgX3J1bnRpbWUuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShjb21wb25lbnQuZWxlbWVudElkKSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgSXNWaXNpYmxlQmluZGluZy5pbnN0YWxsKGVsZW1lbnQsIGNvbXBvbmVudCwgb3BlcmF0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNsYXNzUmVmKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmID0gbmV3IFNpbXBsZUNsYXNzTmFtZUJpbmRpbmdSZWZlcmVuY2UoY2xhc3NSZWYsIGNsYXNzUmVmWydfcHJvcGVydHlLZXknXSk7CiAgICAgICAgICAgICAgICBvcGVyYXRpb25zLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCByZWYsIGZhbHNlLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2xhc3NOYW1lcyAmJiBjbGFzc05hbWVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgX3J1bnRpbWUuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZShuYW1lKSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNsYXNzTmFtZUJpbmRpbmdzICYmIGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lQmluZGluZ3MuZm9yRWFjaChmdW5jdGlvbiAoYmluZGluZykgewogICAgICAgICAgICAgICAgICAgIENsYXNzTmFtZUJpbmRpbmcuaW5zdGFsbChlbGVtZW50LCBjb21wb25lbnQsIGJpbmRpbmcsIG9wZXJhdGlvbnMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgX3J1bnRpbWUuUHJpbWl0aXZlUmVmZXJlbmNlLmNyZWF0ZSgnZW1iZXItdmlldycpLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgIGlmICgnYXJpYVJvbGUnIGluIGNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgb3BlcmF0aW9ucy5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCByZWZlcmVuY2VGb3JLZXkoY29tcG9uZW50LCAnYXJpYVJvbGUnKSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBvbmVudC5fdHJhbnNpdGlvblRvKCdoYXNFbGVtZW50Jyk7CiAgICAgICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbEluc2VydEVsZW1lbnQnKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEN1cmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KGJ1Y2tldCwgYm91bmRzKSB7CiAgICAgICAgICAgIGJ1Y2tldC5jb21wb25lbnRbQk9VTkRTXSA9IGJvdW5kczsKICAgICAgICAgICAgYnVja2V0LmZpbmFsaXplKCk7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnU3RhY2sucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBDdXJseUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyhfcmVmNikgewogICAgICAgICAgICB2YXIgYXJncyA9IF9yZWY2LmFyZ3MsCiAgICAgICAgICAgICAgICBjb21wb25lbnQgPSBfcmVmNi5jb21wb25lbnQ7CgogICAgICAgICAgICByZXR1cm4gYXJncyA/ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFthcmdzLnRhZywgY29tcG9uZW50W0RJUlRZX1RBR11dKSA6IGNvbXBvbmVudFtESVJUWV9UQUddOwogICAgICAgIH07CgogICAgICAgIEN1cmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZGlkQ3JlYXRlID0gZnVuY3Rpb24gZGlkQ3JlYXRlKF9yZWY3KSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmNy5jb21wb25lbnQsCiAgICAgICAgICAgICAgICBlbnZpcm9ubWVudCA9IF9yZWY3LmVudmlyb25tZW50OwoKICAgICAgICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudC5fdHJhbnNpdGlvblRvKCdpbkRPTScpOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZEluc2VydEVsZW1lbnQnKTsKICAgICAgICAgICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCdkaWRSZW5kZXInKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEN1cmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKGJ1Y2tldCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50ID0gYnVja2V0LmNvbXBvbmVudCwKICAgICAgICAgICAgICAgIGFyZ3MgPSBidWNrZXQuYXJncywKICAgICAgICAgICAgICAgIGFyZ3NSZXZpc2lvbiA9IGJ1Y2tldC5hcmdzUmV2aXNpb24sCiAgICAgICAgICAgICAgICBlbnZpcm9ubWVudCA9IGJ1Y2tldC5lbnZpcm9ubWVudDsKCiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wdXNoVG9EZWJ1Z1N0YWNrKGNvbXBvbmVudC5fZGVidWdDb250YWluZXJLZXksIGVudmlyb25tZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWNrZXQuZmluYWxpemVyID0gKDAsIF9pbnN0cnVtZW50YXRpb24uX2luc3RydW1lbnRTdGFydCkoJ3JlbmRlci5jb21wb25lbnQnLCByZXJlbmRlckluc3RydW1lbnREZXRhaWxzLCBjb21wb25lbnQpOwogICAgICAgICAgICBpZiAoYXJncyAmJiAhYXJncy50YWcudmFsaWRhdGUoYXJnc1JldmlzaW9uKSkgewogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gcHJvY2Vzc0NvbXBvbmVudEFyZ3MoYXJncyk7CiAgICAgICAgICAgICAgICBidWNrZXQuYXJnc1JldmlzaW9uID0gYXJncy50YWcudmFsdWUoKTsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFtJU19ESVNQQVRDSElOR19BVFRSU10gPSB0cnVlOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnNldFByb3BlcnRpZXMocHJvcHMpOwogICAgICAgICAgICAgICAgY29tcG9uZW50W0lTX0RJU1BBVENISU5HX0FUVFJTXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFVwZGF0ZUF0dHJzJyk7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignZGlkUmVjZWl2ZUF0dHJzJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudC50cmlnZ2VyKCd3aWxsVXBkYXRlJyk7CiAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbFJlbmRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5kaWRVcGRhdGVMYXlvdXQgPSBmdW5jdGlvbiBkaWRVcGRhdGVMYXlvdXQoYnVja2V0KSB7CiAgICAgICAgICAgIGJ1Y2tldC5maW5hbGl6ZSgpOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrLnBvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5kaWRVcGRhdGUgPSBmdW5jdGlvbiBkaWRVcGRhdGUoX3JlZjgpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IF9yZWY4LmNvbXBvbmVudCwKICAgICAgICAgICAgICAgIGVudmlyb25tZW50ID0gX3JlZjguZW52aXJvbm1lbnQ7CgogICAgICAgICAgICBpZiAoZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZSkgewogICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFVwZGF0ZScpOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ2RpZFJlbmRlcicpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ3VybHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXREZXN0cnVjdG9yID0gZnVuY3Rpb24gZ2V0RGVzdHJ1Y3RvcihzdGF0ZUJ1Y2tldCkgewogICAgICAgICAgICByZXR1cm4gc3RhdGVCdWNrZXQ7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEN1cmx5Q29tcG9uZW50TWFuYWdlcjsKICAgIH0oQWJzdHJhY3RNYW5hZ2VyKTsKCiAgICBmdW5jdGlvbiBwcm9jZXNzQ29tcG9uZW50SW5pdGlhbGl6YXRpb25Bc3NlcnRpb25zKGNvbXBvbmVudCwgcHJvcHMpIHsKICAgICAgICAodHJ1ZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbGFzc05hbWVCaW5kaW5ncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBjbGFzc05hbWVCaW5kaW5nc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYmluZGluZyAhPT0gJ3N0cmluZycgfHwgYmluZGluZy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2NsYXNzTmFtZUJpbmRpbmdzIG11c3QgYmUgbm9uLWVtcHR5IHN0cmluZ3M6ICcgKyBjb21wb25lbnQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzTmFtZUJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGNsYXNzTmFtZUJpbmRpbmdzW2ldO2lmICh0eXBlb2YgYmluZGluZyAhPT0gJ3N0cmluZycgfHwgYmluZGluZy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1yZXR1cm4gdHJ1ZTsKICAgICAgICB9KCkpKTsKICAgICAgICAodHJ1ZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZUJpbmRpbmdzID0gY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbGFzc05hbWVCaW5kaW5ncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBjbGFzc05hbWVCaW5kaW5nc1tpXTsKICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nLnNwbGl0KCcgJykubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnY2xhc3NOYW1lQmluZGluZ3MgbXVzdCBub3QgaGF2ZSBzcGFjZXMgaW4gdGhlbTogJyArIGNvbXBvbmVudCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY2xhc3NOYW1lQmluZGluZ3MgPSBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3M7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xhc3NOYW1lQmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gY2xhc3NOYW1lQmluZGluZ3NbaV07aWYgKGJpbmRpbmcuc3BsaXQoJyAnKS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9cmV0dXJuIHRydWU7CiAgICAgICAgfSgpKSk7CiAgICAgICAgKHRydWUgJiYgIShjb21wb25lbnQudGFnTmFtZSAhPT0gJycgfHwgIWNvbXBvbmVudC5jbGFzc05hbWVCaW5kaW5ncyB8fCBjb21wb25lbnQuY2xhc3NOYW1lQmluZGluZ3MubGVuZ3RoID09PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgdXNlIGBjbGFzc05hbWVCaW5kaW5nc2Agb24gYSB0YWctbGVzcyBjb21wb25lbnQ6ICcgKyBjb21wb25lbnQsIGNvbXBvbmVudC50YWdOYW1lICE9PSAnJyB8fCAhY29tcG9uZW50LmNsYXNzTmFtZUJpbmRpbmdzIHx8IGNvbXBvbmVudC5jbGFzc05hbWVCaW5kaW5ncy5sZW5ndGggPT09IDApKTsKICAgICAgICAodHJ1ZSAmJiAhKGNvbXBvbmVudC50YWdOYW1lICE9PSAnJyB8fCBwcm9wcy5pZCA9PT0gY29tcG9uZW50LmVsZW1lbnRJZCB8fCAhY29tcG9uZW50LmVsZW1lbnRJZCAmJiBjb21wb25lbnQuZWxlbWVudElkICE9PSAnJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSBgZWxlbWVudElkYCBvbiBhIHRhZy1sZXNzIGNvbXBvbmVudDogJyArIGNvbXBvbmVudCwgY29tcG9uZW50LnRhZ05hbWUgIT09ICcnIHx8IHByb3BzLmlkID09PSBjb21wb25lbnQuZWxlbWVudElkIHx8ICFjb21wb25lbnQuZWxlbWVudElkICYmIGNvbXBvbmVudC5lbGVtZW50SWQgIT09ICcnKSk7CiAgICAgICAgKHRydWUgJiYgIShjb21wb25lbnQudGFnTmFtZSAhPT0gJycgfHwgIWNvbXBvbmVudC5hdHRyaWJ1dGVCaW5kaW5ncyB8fCBjb21wb25lbnQuYXR0cmlidXRlQmluZGluZ3MubGVuZ3RoID09PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgdXNlIGBhdHRyaWJ1dGVCaW5kaW5nc2Agb24gYSB0YWctbGVzcyBjb21wb25lbnQ6ICcgKyBjb21wb25lbnQsIGNvbXBvbmVudC50YWdOYW1lICE9PSAnJyB8fCAhY29tcG9uZW50LmF0dHJpYnV0ZUJpbmRpbmdzIHx8IGNvbXBvbmVudC5hdHRyaWJ1dGVCaW5kaW5ncy5sZW5ndGggPT09IDApKTsKICAgIH0KICAgIGZ1bmN0aW9uIGluaXRpYWxSZW5kZXJJbnN0cnVtZW50RGV0YWlscyhjb21wb25lbnQpIHsKICAgICAgICByZXR1cm4gY29tcG9uZW50Lmluc3RydW1lbnREZXRhaWxzKHsgaW5pdGlhbFJlbmRlcjogdHJ1ZSB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlcmVuZGVySW5zdHJ1bWVudERldGFpbHMoY29tcG9uZW50KSB7CiAgICAgICAgcmV0dXJuIGNvbXBvbmVudC5pbnN0cnVtZW50RGV0YWlscyh7IGluaXRpYWxSZW5kZXI6IGZhbHNlIH0pOwogICAgfQogICAgdmFyIENVUkxZX0NBUEFCSUxJVElFUyA9IHsKICAgICAgICBkeW5hbWljTGF5b3V0OiB0cnVlLAogICAgICAgIGR5bmFtaWNUYWc6IHRydWUsCiAgICAgICAgcHJlcGFyZUFyZ3M6IHRydWUsCiAgICAgICAgY3JlYXRlQXJnczogdHJ1ZSwKICAgICAgICBhdHRyaWJ1dGVIb29rOiB0cnVlLAogICAgICAgIGVsZW1lbnRIb29rOiB0cnVlLAogICAgICAgIGNyZWF0ZUNhbGxlcjogdHJ1ZSwKICAgICAgICBkeW5hbWljU2NvcGU6IHRydWUsCiAgICAgICAgdXBkYXRlSG9vazogdHJ1ZSwKICAgICAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogICAgfTsKICAgIHZhciBDVVJMWV9DT01QT05FTlRfTUFOQUdFUiA9IG5ldyBDdXJseUNvbXBvbmVudE1hbmFnZXIoKTsKCiAgICB2YXIgQ3VybHlDb21wb25lbnREZWZpbml0aW9uID0KICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZQogICAgZnVuY3Rpb24gQ3VybHlDb21wb25lbnREZWZpbml0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbWFuYWdlciA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogQ1VSTFlfQ09NUE9ORU5UX01BTkFHRVI7CiAgICAgICAgdmFyIENvbXBvbmVudENsYXNzID0gYXJndW1lbnRzWzJdOwogICAgICAgIHZhciBoYW5kbGUgPSBhcmd1bWVudHNbM107CiAgICAgICAgdmFyIHRlbXBsYXRlID0gYXJndW1lbnRzWzRdOwogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzWzVdOwogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ3VybHlDb21wb25lbnREZWZpbml0aW9uKTsKCiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLm1hbmFnZXIgPSBtYW5hZ2VyOwogICAgICAgIHRoaXMuQ29tcG9uZW50Q2xhc3MgPSBDb21wb25lbnRDbGFzczsKICAgICAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgICAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUgJiYgdGVtcGxhdGUuYXNMYXlvdXQoKTsKICAgICAgICB2YXIgc3ltYm9sVGFibGUgPSBsYXlvdXQgPyBsYXlvdXQuc3ltYm9sVGFibGUgOiB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5zeW1ib2xUYWJsZSA9IHN5bWJvbFRhYmxlOwogICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB0aGlzLmFyZ3MgPSBhcmdzOwogICAgICAgIHRoaXMuc3RhdGUgPSB7CiAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgIENvbXBvbmVudENsYXNzOiBDb21wb25lbnRDbGFzcywKICAgICAgICAgICAgaGFuZGxlOiBoYW5kbGUsCiAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZSwKICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBDVVJMWV9DQVBBQklMSVRJRVMsCiAgICAgICAgICAgIHN5bWJvbFRhYmxlOiBzeW1ib2xUYWJsZQogICAgICAgIH07CiAgICB9OwoKICAgIHZhciBSb290Q29tcG9uZW50TWFuYWdlciA9IGZ1bmN0aW9uIChfQ3VybHlDb21wb25lbnRNYW5hZ2UpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFJvb3RDb21wb25lbnRNYW5hZ2VyLCBfQ3VybHlDb21wb25lbnRNYW5hZ2UpOwoKICAgICAgICBmdW5jdGlvbiBSb290Q29tcG9uZW50TWFuYWdlcihjb21wb25lbnQpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBSb290Q29tcG9uZW50TWFuYWdlcik7CgogICAgICAgICAgICB2YXIgX3RoaXMyOSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQ3VybHlDb21wb25lbnRNYW5hZ2UuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczI5LmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMjk7CiAgICAgICAgfQoKICAgICAgICBSb290Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KF9zdGF0ZSwgcmVzb2x2ZXIpIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZUZvcih0aGlzLmNvbXBvbmVudCwgcmVzb2x2ZXIpOwogICAgICAgICAgICB2YXIgbGF5b3V0ID0gdGVtcGxhdGUuYXNXcmFwcGVkTGF5b3V0KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBoYW5kbGU6IGxheW91dC5jb21waWxlKCksCiAgICAgICAgICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgUm9vdENvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnZpcm9ubWVudCwgX3N0YXRlLCBfYXJncywgZHluYW1pY1Njb3BlKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudDsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3B1c2hUb0RlYnVnU3RhY2soY29tcG9uZW50Ll9kZWJ1Z0NvbnRhaW5lcktleSwgZW52aXJvbm1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmaW5hbGl6ZXIgPSAoMCwgX2luc3RydW1lbnRhdGlvbi5faW5zdHJ1bWVudFN0YXJ0KSgncmVuZGVyLmNvbXBvbmVudCcsIGluaXRpYWxSZW5kZXJJbnN0cnVtZW50RGV0YWlscywgY29tcG9uZW50KTsKICAgICAgICAgICAgZHluYW1pY1Njb3BlLnZpZXcgPSBjb21wb25lbnQ7CiAgICAgICAgICAgIHZhciBoYXNXcmFwcGVkRWxlbWVudCA9IGNvbXBvbmVudC50YWdOYW1lICE9PSAnJzsKICAgICAgICAgICAgLy8gV2UgdXN1YWxseSBkbyB0aGlzIGluIHRoZSBgZGlkQ3JlYXRlRWxlbWVudGAsIGJ1dCB0aGF0IGhvb2sgZG9lc24ndCBmaXJlIGZvciB0YWdsZXNzIGNvbXBvbmVudHMKICAgICAgICAgICAgaWYgKCFoYXNXcmFwcGVkRWxlbWVudCkgewogICAgICAgICAgICAgICAgaWYgKGVudmlyb25tZW50LmlzSW50ZXJhY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQudHJpZ2dlcignd2lsbFJlbmRlcicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcG9uZW50Ll90cmFuc2l0aW9uVG8oJ2hhc0VsZW1lbnQnKTsKICAgICAgICAgICAgICAgIGlmIChlbnZpcm9ubWVudC5pc0ludGVyYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50LnRyaWdnZXIoJ3dpbGxJbnNlcnRFbGVtZW50Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHByb2Nlc3NDb21wb25lbnRJbml0aWFsaXphdGlvbkFzc2VydGlvbnMoY29tcG9uZW50LCB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBDb21wb25lbnRTdGF0ZUJ1Y2tldChlbnZpcm9ubWVudCwgY29tcG9uZW50LCBudWxsLCBmaW5hbGl6ZXIsIGhhc1dyYXBwZWRFbGVtZW50KTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUm9vdENvbXBvbmVudE1hbmFnZXI7CiAgICB9KEN1cmx5Q29tcG9uZW50TWFuYWdlcik7CgogICAgLy8gUk9PVCBpcyB0aGUgdG9wLWxldmVsIHRlbXBsYXRlIGl0IGhhcyBub3RoaW5nIGJ1dCBvbmUgeWllbGQuCiAgICAvLyBpdCBpcyBzdXBwb3NlZCB0byBoYXZlIGEgZHVtbXkgZWxlbWVudAogICAgdmFyIFJPT1RfQ0FQQUJJTElUSUVTID0gewogICAgICAgIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLAogICAgICAgIGR5bmFtaWNUYWc6IHRydWUsCiAgICAgICAgcHJlcGFyZUFyZ3M6IGZhbHNlLAogICAgICAgIGNyZWF0ZUFyZ3M6IGZhbHNlLAogICAgICAgIGF0dHJpYnV0ZUhvb2s6IHRydWUsCiAgICAgICAgZWxlbWVudEhvb2s6IHRydWUsCiAgICAgICAgY3JlYXRlQ2FsbGVyOiB0cnVlLAogICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmYWxzZQogICAgfTsKCiAgICB2YXIgUm9vdENvbXBvbmVudERlZmluaXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gUm9vdENvbXBvbmVudERlZmluaXRpb24oY29tcG9uZW50KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUm9vdENvbXBvbmVudERlZmluaXRpb24pOwoKICAgICAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICAgICAgICAgIHZhciBtYW5hZ2VyID0gbmV3IFJvb3RDb21wb25lbnRNYW5hZ2VyKGNvbXBvbmVudCk7CiAgICAgICAgICAgIHRoaXMubWFuYWdlciA9IG1hbmFnZXI7CiAgICAgICAgICAgIHZhciBmYWN0b3J5ID0gX2NvbnRhaW5lci5GQUNUT1JZX0ZPUi5nZXQoY29tcG9uZW50KTsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IGZhY3RvcnkuZnVsbE5hbWUuc2xpY2UoMTApLAogICAgICAgICAgICAgICAgY2FwYWJpbGl0aWVzOiBST09UX0NBUEFCSUxJVElFUywKICAgICAgICAgICAgICAgIENvbXBvbmVudENsYXNzOiBmYWN0b3J5LAogICAgICAgICAgICAgICAgaGFuZGxlOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBSb290Q29tcG9uZW50RGVmaW5pdGlvbi5wcm90b3R5cGUuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKF9yZWY5KSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmOS5jb21wb25lbnQ7CgogICAgICAgICAgICByZXR1cm4gY29tcG9uZW50W0RJUlRZX1RBR107CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJvb3RDb21wb25lbnREZWZpbml0aW9uOwogICAgfSgpOwoKICAgIHZhciBEeW5hbWljU2NvcGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRHluYW1pY1Njb3BlKHZpZXcsIG91dGxldFN0YXRlLCByb290T3V0bGV0U3RhdGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBEeW5hbWljU2NvcGUpOwoKICAgICAgICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgICAgICAgdGhpcy5vdXRsZXRTdGF0ZSA9IG91dGxldFN0YXRlOwogICAgICAgICAgICB0aGlzLnJvb3RPdXRsZXRTdGF0ZSA9IHJvb3RPdXRsZXRTdGF0ZTsKICAgICAgICB9CgogICAgICAgIER5bmFtaWNTY29wZS5wcm90b3R5cGUuY2hpbGQgPSBmdW5jdGlvbiBjaGlsZCgpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBEeW5hbWljU2NvcGUodGhpcy52aWV3LCB0aGlzLm91dGxldFN0YXRlLCB0aGlzLnJvb3RPdXRsZXRTdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgRHluYW1pY1Njb3BlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgICAgICAgICh0cnVlICYmICEoa2V5ID09PSAnb3V0bGV0U3RhdGUnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1VzaW5nIGAtZ2V0LWR5bmFtaWMtc2NvcGVgIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBgb3V0bGV0U3RhdGVgICh5b3UgdXNlZCBgJyArIGtleSArICdgKS4nLCBrZXkgPT09ICdvdXRsZXRTdGF0ZScpKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzLm91dGxldFN0YXRlOwogICAgICAgIH07CgogICAgICAgIER5bmFtaWNTY29wZS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgKHRydWUgJiYgIShrZXkgPT09ICdvdXRsZXRTdGF0ZScpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVXNpbmcgYC13aXRoLWR5bmFtaWMtc2NvcGVgIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBgb3V0bGV0U3RhdGVgICh5b3UgdXNlZCBgJyArIGtleSArICdgKS4nLCBrZXkgPT09ICdvdXRsZXRTdGF0ZScpKTsKCiAgICAgICAgICAgIHRoaXMub3V0bGV0U3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBEeW5hbWljU2NvcGU7CiAgICB9KCk7CgogICAgdmFyIFJvb3RTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBSb290U3RhdGUocm9vdCwgZW52LCB0ZW1wbGF0ZSwgc2VsZiwgcGFyZW50RWxlbWVudCwgZHluYW1pY1Njb3BlLCBidWlsZGVyKSB7CiAgICAgICAgICAgIHZhciBfdGhpczMwID0gdGhpczsKCiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUm9vdFN0YXRlKTsKICAgICAgICAgICAgKHRydWUgJiYgISh0ZW1wbGF0ZSAhPT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgcmVuZGVyIGAnICsgc2VsZi52YWx1ZSgpICsgJ2Agd2l0aG91dCBhIHRlbXBsYXRlLicsIHRlbXBsYXRlICE9PSB1bmRlZmluZWQpKTsKCiAgICAgICAgICAgIHRoaXMuaWQgPSAoMCwgX2VtYmVyVmlld3MuZ2V0Vmlld0lkKShyb290KTsKICAgICAgICAgICAgdGhpcy5lbnYgPSBlbnY7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IHJvb3Q7CiAgICAgICAgICAgIHRoaXMucmVzdWx0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLnNob3VsZFJlZmx1c2ggPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICBhbHdheXNSZXZhbGlkYXRlOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnJlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBsYXlvdXQgPSB0ZW1wbGF0ZS5hc0xheW91dCgpOwogICAgICAgICAgICAgICAgdmFyIGhhbmRsZSA9IGxheW91dC5jb21waWxlKCk7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSAoMCwgX3J1bnRpbWUucmVuZGVyTWFpbikobGF5b3V0Wydjb21waWxlciddLnByb2dyYW0sIGVudiwgc2VsZiwgZHluYW1pY1Njb3BlLCBidWlsZGVyKGVudiwgeyBlbGVtZW50OiBwYXJlbnRFbGVtZW50LCBuZXh0U2libGluZzogbnVsbCB9KSwgaGFuZGxlKTsKICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvclJlc3VsdCA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvclJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKCFpdGVyYXRvclJlc3VsdC5kb25lKTsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBfdGhpczMwLnJlc3VsdCA9IGl0ZXJhdG9yUmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgLy8gb3ZlcnJpZGUgLnJlbmRlciBmdW5jdGlvbiBhZnRlciBpbml0aWFsIHJlbmRlcgogICAgICAgICAgICAgICAgX3RoaXMzMC5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5yZXJlbmRlcihvcHRpb25zKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBSb290U3RhdGUucHJvdG90eXBlLmlzRm9yID0gZnVuY3Rpb24gaXNGb3IocG9zc2libGVSb290KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJvb3QgPT09IHBvc3NpYmxlUm9vdDsKICAgICAgICB9OwoKICAgICAgICBSb290U3RhdGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5yZXN1bHQsCiAgICAgICAgICAgICAgICBlbnYgPSB0aGlzLmVudjsKCiAgICAgICAgICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5lbnYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMucm9vdCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucmVzdWx0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLnJlbmRlciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICBIYW5kbGVzIHRoZXNlIHNjZW5hcmlvczoKICAgICAgICAgICAgICAgICAgICAgICAgKiBXaGVuIHJvb3RzIGFyZSByZW1vdmVkIGR1cmluZyBzdGFuZGFyZCByZW5kZXJpbmcgcHJvY2VzcywgYSB0cmFuc2FjdGlvbiBleGlzdHMgYWxyZWFkeQogICAgICAgICAgICAgICAgICAgYC5iZWdpbigpYCAvIGAuY29tbWl0KClgIGFyZSBub3QgbmVlZGVkLgogICAgICAgICAgICAgICAgICogV2hlbiByb290cyBhcmUgYmVpbmcgZGVzdHJveWVkIG1hbnVhbGx5IChgY29tcG9uZW50LmFwcGVuZCgpOyBjb21wb25lbnQuZGVzdHJveSgpIGNhc2UpLCBubwogICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24gZXhpc3RzIGFscmVhZHkuCiAgICAgICAgICAgICAgICAgKiBXaGVuIHJvb3RzIGFyZSBiZWluZyBkZXN0cm95ZWQgZHVyaW5nIGBSZW5kZXJlciNkZXN0cm95YCwgbm8gdHJhbnNhY3Rpb24gZXhpc3RzCiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgbmVlZHNUcmFuc2FjdGlvbiA9ICFlbnYuaW5UcmFuc2FjdGlvbjsKICAgICAgICAgICAgICAgIGlmIChuZWVkc1RyYW5zYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgZW52LmJlZ2luKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIGlmIChuZWVkc1RyYW5zYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21taXQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUm9vdFN0YXRlOwogICAgfSgpOwoKICAgIHZhciByZW5kZXJlcnMgPSBbXTsKICAgIGZ1bmN0aW9uIF9yZXNldFJlbmRlcmVycygpIHsKICAgICAgICByZW5kZXJlcnMubGVuZ3RoID0gMDsKICAgIH0KICAgICgwLCBfZW1iZXJNZXRhbC5zZXRIYXNWaWV3cykoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiByZW5kZXJlcnMubGVuZ3RoID4gMDsKICAgIH0pOwogICAgZnVuY3Rpb24gcmVnaXN0ZXIocmVuZGVyZXIpIHsKICAgICAgICAodHJ1ZSAmJiAhKHJlbmRlcmVycy5pbmRleE9mKHJlbmRlcmVyKSA9PT0gLTEpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IHJlZ2lzdGVyIHRoZSBzYW1lIHJlbmRlcmVyIHR3aWNlJywgcmVuZGVyZXJzLmluZGV4T2YocmVuZGVyZXIpID09PSAtMSkpOwoKICAgICAgICByZW5kZXJlcnMucHVzaChyZW5kZXJlcik7CiAgICB9CiAgICBmdW5jdGlvbiBkZXJlZ2lzdGVyKHJlbmRlcmVyKSB7CiAgICAgICAgdmFyIGluZGV4ID0gcmVuZGVyZXJzLmluZGV4T2YocmVuZGVyZXIpOwogICAgICAgICh0cnVlICYmICEoaW5kZXggIT09IC0xKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBkZXJlZ2lzdGVyIHVua25vd24gdW5yZWdpc3RlcmVkIHJlbmRlcmVyJywgaW5kZXggIT09IC0xKSk7CgogICAgICAgIHJlbmRlcmVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogICAgZnVuY3Rpb24gbG9vcEJlZ2luKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVuZGVyZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJlbmRlcmVyc1tpXS5fc2NoZWR1bGVSZXZhbGlkYXRlKCk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gSygpIHsKICAgICAgICAvKiBub29wICovCiAgICB9CiAgICB2YXIgcmVuZGVyU2V0dGxlZERlZmVycmVkID0gbnVsbDsKICAgIC8qCiAgICAgIFJldHVybnMgYSBwcm9taXNlIHdoaWNoIHdpbGwgcmVzb2x2ZSB3aGVuIHJlbmRlcmluZyBoYXMgc2V0dGxlZC4gU2V0dGxlZCBpbgogICAgICB0aGlzIGNvbnRleHQgaXMgZGVmaW5lZCBhcyB3aGVuIGFsbCBvZiB0aGUgdGFncyBpbiB1c2UgYXJlICJjdXJyZW50IiAoZS5nLgogICAgICBgcmVuZGVyZXJzLmV2ZXJ5KHIgPT4gci5faXNWYWxpZCgpKWApLiBXaGVuIHRoaXMgaXMgY2hlY2tlZCBhdCB0aGUgX2VuZF8gb2YKICAgICAgdGhlIHJ1biBsb29wLCB0aGlzIGVzc2VudGlhbGx5IGd1YXJhbnRlZXMgdGhhdCBhbGwgcmVuZGVyaW5nIGlzIGNvbXBsZXRlZC4KICAgIAogICAgICBAbWV0aG9kIHJlbmRlclNldHRsZWQKICAgICAgQHJldHVybnMge1Byb21pc2U8dm9pZD59IGEgcHJvbWlzZSB3aGljaCBmdWxmaWxscyB3aGVuIHJlbmRlcmluZyBoYXMgc2V0dGxlZAogICAgKi8KICAgIGZ1bmN0aW9uIHJlbmRlclNldHRsZWQoKSB7CiAgICAgICAgaWYgKHJlbmRlclNldHRsZWREZWZlcnJlZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZW5kZXJTZXR0bGVkRGVmZXJyZWQgPSBfcnN2cC5kZWZhdWx0LmRlZmVyKCk7CiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGN1cnJlbnQgcnVubG9vcCwgdGhlIHByb21pc2UgY3JlYXRlZCBhYm92ZSB3aWxsIG5vdCBoYXZlCiAgICAgICAgICAgIC8vIGEgY2hhbmNlIHRvIHJlc29sdmUgKGJlY2F1c2UgaXRzIHJlc29sdmVkIGluIGJhY2tidXJuZXIncyAiZW5kIiBldmVudCkKICAgICAgICAgICAgaWYgKCEoMCwgX3J1bmxvb3AuZ2V0Q3VycmVudFJ1bkxvb3ApKCkpIHsKICAgICAgICAgICAgICAgIC8vIGVuc3VyZSBhIHJ1bmxvb3AgaGFzIGJlZW4ga2lja2VkIG9mZgogICAgICAgICAgICAgICAgX3J1bmxvb3AuYmFja2J1cm5lci5zY2hlZHVsZSgnYWN0aW9ucycsIG51bGwsIEspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZW5kZXJTZXR0bGVkRGVmZXJyZWQucHJvbWlzZTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc29sdmVSZW5kZXJQcm9taXNlKCkgewogICAgICAgIGlmIChyZW5kZXJTZXR0bGVkRGVmZXJyZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlc29sdmUgPSByZW5kZXJTZXR0bGVkRGVmZXJyZWQucmVzb2x2ZTsKICAgICAgICAgICAgcmVuZGVyU2V0dGxlZERlZmVycmVkID0gbnVsbDsKICAgICAgICAgICAgX3J1bmxvb3AuYmFja2J1cm5lci5qb2luKG51bGwsIHJlc29sdmUpOwogICAgICAgIH0KICAgIH0KICAgIHZhciBsb29wcyA9IDA7CiAgICBmdW5jdGlvbiBsb29wRW5kKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVuZGVyZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghcmVuZGVyZXJzW2ldLl9pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgICAgIGlmIChsb29wcyA+IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgbG9vcHMgPSAwOwogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGRvIHNvbWV0aGluZyBiZXR0ZXIKICAgICAgICAgICAgICAgICAgICByZW5kZXJlcnNbaV0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignaW5maW5pdGUgcmVuZGVyaW5nIGludmFsaWRhdGlvbiBkZXRlY3RlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbG9vcHMrKzsKICAgICAgICAgICAgICAgIHJldHVybiBfcnVubG9vcC5iYWNrYnVybmVyLmpvaW4obnVsbCwgSyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbG9vcHMgPSAwOwogICAgICAgIHJlc29sdmVSZW5kZXJQcm9taXNlKCk7CiAgICB9CiAgICBfcnVubG9vcC5iYWNrYnVybmVyLm9uKCdiZWdpbicsIGxvb3BCZWdpbik7CiAgICBfcnVubG9vcC5iYWNrYnVybmVyLm9uKCdlbmQnLCBsb29wRW5kKTsKCiAgICB2YXIgUmVuZGVyZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gUmVuZGVyZXIoZW52LCByb290VGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIF92aWV3UmVnaXN0cnkgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IF9lbWJlclZpZXdzLmZhbGxiYWNrVmlld1JlZ2lzdHJ5OwoKICAgICAgICAgICAgdmFyIGRlc3RpbmVkRm9yRE9NID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICAgICAgICAgICAgdmFyIGJ1aWxkZXIgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1s0XSA6IF9ydW50aW1lLmNsaWVudEJ1aWxkZXI7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVuZGVyZXIpOwoKICAgICAgICAgICAgdGhpcy5fZW52ID0gZW52OwogICAgICAgICAgICB0aGlzLl9yb290VGVtcGxhdGUgPSByb290VGVtcGxhdGU7CiAgICAgICAgICAgIHRoaXMuX3ZpZXdSZWdpc3RyeSA9IF92aWV3UmVnaXN0cnk7CiAgICAgICAgICAgIHRoaXMuX2Rlc3RpbmVkRm9yRE9NID0gZGVzdGluZWRGb3JET007CiAgICAgICAgICAgIHRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9yb290cyA9IFtdOwogICAgICAgICAgICB0aGlzLl9sYXN0UmV2aXNpb24gPSAtMTsKICAgICAgICAgICAgdGhpcy5faXNSZW5kZXJpbmdSb290cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9yZW1vdmVkUm9vdHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fYnVpbGRlciA9IGJ1aWxkZXI7CiAgICAgICAgfQogICAgICAgIC8vIHJlbmRlcmVyIEhPT0tTCgoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuYXBwZW5kT3V0bGV0VmlldyA9IGZ1bmN0aW9uIGFwcGVuZE91dGxldFZpZXcodmlldywgdGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciBkZWZpbml0aW9uID0gY3JlYXRlUm9vdE91dGxldCh2aWV3KTsKICAgICAgICAgICAgdGhpcy5fYXBwZW5kRGVmaW5pdGlvbih2aWV3LCAoMCwgX3J1bnRpbWUuY3VycnkpKGRlZmluaXRpb24pLCB0YXJnZXQpOwogICAgICAgIH07CgogICAgICAgIFJlbmRlcmVyLnByb3RvdHlwZS5hcHBlbmRUbyA9IGZ1bmN0aW9uIGFwcGVuZFRvKHZpZXcsIHRhcmdldCkgewogICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IG5ldyBSb290Q29tcG9uZW50RGVmaW5pdGlvbih2aWV3KTsKICAgICAgICAgICAgdGhpcy5fYXBwZW5kRGVmaW5pdGlvbih2aWV3LCAoMCwgX3J1bnRpbWUuY3VycnkpKGRlZmluaXRpb24pLCB0YXJnZXQpOwogICAgICAgIH07CgogICAgICAgIFJlbmRlcmVyLnByb3RvdHlwZS5fYXBwZW5kRGVmaW5pdGlvbiA9IGZ1bmN0aW9uIF9hcHBlbmREZWZpbml0aW9uKHJvb3QsIGRlZmluaXRpb24sIHRhcmdldCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IG5ldyBVbmJvdW5kUmVmZXJlbmNlKGRlZmluaXRpb24pOwogICAgICAgICAgICB2YXIgZHluYW1pY1Njb3BlID0gbmV3IER5bmFtaWNTY29wZShudWxsLCBfcnVudGltZS5VTkRFRklORURfUkVGRVJFTkNFKTsKICAgICAgICAgICAgdmFyIHJvb3RTdGF0ZSA9IG5ldyBSb290U3RhdGUocm9vdCwgdGhpcy5fZW52LCB0aGlzLl9yb290VGVtcGxhdGUsIHNlbGYsIHRhcmdldCwgZHluYW1pY1Njb3BlLCB0aGlzLl9idWlsZGVyKTsKICAgICAgICAgICAgdGhpcy5fcmVuZGVyUm9vdChyb290U3RhdGUpOwogICAgICAgIH07CgogICAgICAgIFJlbmRlcmVyLnByb3RvdHlwZS5yZXJlbmRlciA9IGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICAgICAgICB0aGlzLl9zY2hlZHVsZVJldmFsaWRhdGUoKTsKICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUucmVnaXN0ZXIgPSBmdW5jdGlvbiByZWdpc3Rlcih2aWV3KSB7CiAgICAgICAgICAgIHZhciBpZCA9ICgwLCBfZW1iZXJWaWV3cy5nZXRWaWV3SWQpKHZpZXcpOwogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLl92aWV3UmVnaXN0cnlbaWRdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0F0dGVtcHRlZCB0byByZWdpc3RlciBhIHZpZXcgd2l0aCBhbiBpZCBhbHJlYWR5IGluIHVzZTogJyArIGlkLCAhdGhpcy5fdmlld1JlZ2lzdHJ5W2lkXSkpOwoKICAgICAgICAgICAgdGhpcy5fdmlld1JlZ2lzdHJ5W2lkXSA9IHZpZXc7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLnVucmVnaXN0ZXIgPSBmdW5jdGlvbiB1bnJlZ2lzdGVyKHZpZXcpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3ZpZXdSZWdpc3RyeVsoMCwgX2VtYmVyVmlld3MuZ2V0Vmlld0lkKSh2aWV3KV07CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZSh2aWV3KSB7CiAgICAgICAgICAgIHZpZXcuX3RyYW5zaXRpb25UbygnZGVzdHJveWluZycpOwogICAgICAgICAgICB0aGlzLmNsZWFudXBSb290Rm9yKHZpZXcpOwogICAgICAgICAgICAoMCwgX2VtYmVyVmlld3Muc2V0Vmlld0VsZW1lbnQpKHZpZXcsIG51bGwpOwogICAgICAgICAgICBpZiAodGhpcy5fZGVzdGluZWRGb3JET00pIHsKICAgICAgICAgICAgICAgIHZpZXcudHJpZ2dlcignZGlkRGVzdHJveUVsZW1lbnQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXZpZXcuaXNEZXN0cm95aW5nKSB7CiAgICAgICAgICAgICAgICB2aWV3LmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFJlbmRlcmVyLnByb3RvdHlwZS5jbGVhbnVwUm9vdEZvciA9IGZ1bmN0aW9uIGNsZWFudXBSb290Rm9yKHZpZXcpIHsKICAgICAgICAgICAgLy8gbm8gbmVlZCB0byBjbGVhbnVwIHJvb3RzIGlmIHdlIGhhdmUgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZAogICAgICAgICAgICBpZiAodGhpcy5fZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHM7CiAgICAgICAgICAgIC8vIHRyYXZlcnNlIGluIHJldmVyc2Ugc28gd2UgY2FuIHJlbW92ZSBpdGVtcwogICAgICAgICAgICAvLyB3aXRob3V0IG11Y2tpbmcgdXAgdGhlIGluZGV4CiAgICAgICAgICAgIHZhciBpID0gdGhpcy5fcm9vdHMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdCA9IHJvb3RzW2ldOwogICAgICAgICAgICAgICAgaWYgKHJvb3QuaXNGb3IodmlldykpIHsKICAgICAgICAgICAgICAgICAgICByb290LmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICByb290cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9kZXN0cm95ZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9kZXN0cm95ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9jbGVhckFsbFJvb3RzKCk7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLmdldEJvdW5kcyA9IGZ1bmN0aW9uIGdldEJvdW5kcyh2aWV3KSB7CiAgICAgICAgICAgIHZhciBib3VuZHMgPSB2aWV3W0JPVU5EU107CiAgICAgICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gYm91bmRzLnBhcmVudEVsZW1lbnQoKTsKICAgICAgICAgICAgdmFyIGZpcnN0Tm9kZSA9IGJvdW5kcy5maXJzdE5vZGUoKTsKICAgICAgICAgICAgdmFyIGxhc3ROb2RlID0gYm91bmRzLmxhc3ROb2RlKCk7CiAgICAgICAgICAgIHJldHVybiB7IHBhcmVudEVsZW1lbnQ6IHBhcmVudEVsZW1lbnQsIGZpcnN0Tm9kZTogZmlyc3ROb2RlLCBsYXN0Tm9kZTogbGFzdE5vZGUgfTsKICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQodGFnTmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZW52LmdldEFwcGVuZE9wZXJhdGlvbnMoKS5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICAgIH07CgogICAgICAgIFJlbmRlcmVyLnByb3RvdHlwZS5fcmVuZGVyUm9vdCA9IGZ1bmN0aW9uIF9yZW5kZXJSb290KHJvb3QpIHsKICAgICAgICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHM7CgogICAgICAgICAgICByb290cy5wdXNoKHJvb3QpOwogICAgICAgICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICByZWdpc3Rlcih0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9yZW5kZXJSb290c1RyYW5zYWN0aW9uKCk7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLl9yZW5kZXJSb290cyA9IGZ1bmN0aW9uIF9yZW5kZXJSb290cygpIHsKICAgICAgICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHMsCiAgICAgICAgICAgICAgICBlbnYgPSB0aGlzLl9lbnYsCiAgICAgICAgICAgICAgICByZW1vdmVkUm9vdHMgPSB0aGlzLl9yZW1vdmVkUm9vdHM7CgogICAgICAgICAgICB2YXIgZ2xvYmFsU2hvdWxkUmVmbHVzaCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGluaXRpYWxSb290c0xlbmd0aCA9IHZvaWQgMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgZW52LmJlZ2luKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IGZvciB0aGUgZmlyc3QgaXRlcmF0aW9uIG9mIHRoZSBsb29wCiAgICAgICAgICAgICAgICAgICAgLy8gZWFjaCByb290IGlzIHByb2Nlc3NlZAogICAgICAgICAgICAgICAgICAgIGluaXRpYWxSb290c0xlbmd0aCA9IHJvb3RzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBnbG9iYWxTaG91bGRSZWZsdXNoID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdCA9IHJvb3RzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocm9vdC5kZXN0cm95ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCB0byB0aGUgbGlzdCBvZiByb290cyB0byBiZSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGV5IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGB0aGlzLl9yb290c2AgbGF0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZWRSb290cy5wdXNoKHJvb3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2tpcCBvdmVyIHJvb3RzIHRoYXQgaGF2ZSBiZWVuIG1hcmtlZCBhcyBkZXN0cm95ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaG91bGRSZWZsdXNoID0gcm9vdC5zaG91bGRSZWZsdXNoOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBwcm9jZXNzaW5nIG5vbi1pbml0aWFsIHJlZmx1c2ggbG9vcHMsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIG5vdCBwcm9jZXNzIG1vcmUgcm9vdHMgdGhhbiBuZWVkZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPj0gaW5pdGlhbFJvb3RzTGVuZ3RoICYmICFzaG91bGRSZWZsdXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByb290Lm9wdGlvbnMuYWx3YXlzUmV2YWxpZGF0ZSA9IHNob3VsZFJlZmx1c2g7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyYWNrIHNob3VsZFJlZmx1c2ggYmFzZWQgb24gdGhpcyByb290cyByZW5kZXIgcmVzdWx0CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZFJlZmx1c2ggPSByb290LnNob3VsZFJlZmx1c2ggPSAoMCwgX2VtYmVyTWV0YWwucnVuSW5UcmFuc2FjdGlvbikocm9vdCwgJ3JlbmRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBnbG9iYWxTaG91bGRSZWZsdXNoIHNob3VsZCBiZSBgdHJ1ZWAgaWYgKmFueSogb2YKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHJvb3RzIG5lZWQgdG8gcmVmbHVzaAogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxTaG91bGRSZWZsdXNoID0gZ2xvYmFsU2hvdWxkUmVmbHVzaCB8fCBzaG91bGRSZWZsdXNoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9sYXN0UmV2aXNpb24gPSBfcmVmZXJlbmNlLkNVUlJFTlRfVEFHLnZhbHVlKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIGVudi5jb21taXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoZ2xvYmFsU2hvdWxkUmVmbHVzaCB8fCByb290cy5sZW5ndGggPiBpbml0aWFsUm9vdHNMZW5ndGgpOwogICAgICAgICAgICAvLyByZW1vdmUgYW55IHJvb3RzIHRoYXQgd2VyZSBkZXN0cm95ZWQgZHVyaW5nIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgICAgICAgd2hpbGUgKHJlbW92ZWRSb290cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciBfcm9vdCA9IHJlbW92ZWRSb290cy5wb3AoKTsKICAgICAgICAgICAgICAgIHZhciByb290SW5kZXggPSByb290cy5pbmRleE9mKF9yb290KTsKICAgICAgICAgICAgICAgIHJvb3RzLnNwbGljZShyb290SW5kZXgsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9yb290cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGRlcmVnaXN0ZXIodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuX3JlbmRlclJvb3RzVHJhbnNhY3Rpb24gPSBmdW5jdGlvbiBfcmVuZGVyUm9vdHNUcmFuc2FjdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2lzUmVuZGVyaW5nUm9vdHMpIHsKICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSByZW5kZXJpbmcgcm9vdHMsIGEgbmV3IHJvb3Qgd2FzIGFkZGVkIGFuZCB3aWxsCiAgICAgICAgICAgICAgICAvLyBiZSBwcm9jZXNzZWQgYnkgdGhlIGV4aXN0aW5nIF9yZW5kZXJSb290cyBpbnZvY2F0aW9uCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gdXNlZCB0byBwcmV2ZW50IGNhbGxpbmcgX3JlbmRlclJvb3RzIGFnYWluIChzZWUgYWJvdmUpCiAgICAgICAgICAgIC8vIHdoaWxlIHdlIGFyZSBhY3RpdmVseSByZW5kZXJpbmcgcm9vdHMKICAgICAgICAgICAgdGhpcy5faXNSZW5kZXJpbmdSb290cyA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wbGV0ZWRXaXRob3V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlclJvb3RzKCk7CiAgICAgICAgICAgICAgICBjb21wbGV0ZWRXaXRob3V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKCFjb21wbGV0ZWRXaXRob3V0RXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9sYXN0UmV2aXNpb24gPSBfcmVmZXJlbmNlLkNVUlJFTlRfVEFHLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2Vudi5pblRyYW5zYWN0aW9uID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Vudi5jb21taXQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9pc1JlbmRlcmluZ1Jvb3RzID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuX2NsZWFyQWxsUm9vdHMgPSBmdW5jdGlvbiBfY2xlYXJBbGxSb290cygpIHsKICAgICAgICAgICAgdmFyIHJvb3RzID0gdGhpcy5fcm9vdHM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciByb290ID0gcm9vdHNbaV07CiAgICAgICAgICAgICAgICByb290LmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9yZW1vdmVkUm9vdHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5fcm9vdHMgPSBbXTsKICAgICAgICAgICAgLy8gaWYgcm9vdHMgd2VyZSBwcmVzZW50IGJlZm9yZSBkZXN0cm95aW5nCiAgICAgICAgICAgIC8vIGRlcmVnaXN0ZXIgdGhpcyByZW5kZXJlciBpbnN0YW5jZQogICAgICAgICAgICBpZiAocm9vdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBkZXJlZ2lzdGVyKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLl9zY2hlZHVsZVJldmFsaWRhdGUgPSBmdW5jdGlvbiBfc2NoZWR1bGVSZXZhbGlkYXRlKCkgewogICAgICAgICAgICBfcnVubG9vcC5iYWNrYnVybmVyLnNjaGVkdWxlT25jZSgncmVuZGVyJywgdGhpcywgdGhpcy5fcmV2YWxpZGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgUmVuZGVyZXIucHJvdG90eXBlLl9pc1ZhbGlkID0gZnVuY3Rpb24gX2lzVmFsaWQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kZXN0cm95ZWQgfHwgdGhpcy5fcm9vdHMubGVuZ3RoID09PSAwIHx8IF9yZWZlcmVuY2UuQ1VSUkVOVF9UQUcudmFsaWRhdGUodGhpcy5fbGFzdFJldmlzaW9uKTsKICAgICAgICB9OwoKICAgICAgICBSZW5kZXJlci5wcm90b3R5cGUuX3JldmFsaWRhdGUgPSBmdW5jdGlvbiBfcmV2YWxpZGF0ZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2lzVmFsaWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3JlbmRlclJvb3RzVHJhbnNhY3Rpb24oKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUmVuZGVyZXI7CiAgICB9KCk7CgogICAgdmFyIEluZXJ0UmVuZGVyZXIgPSBmdW5jdGlvbiAoX1JlbmRlcmVyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShJbmVydFJlbmRlcmVyLCBfUmVuZGVyZXIpOwoKICAgICAgICBmdW5jdGlvbiBJbmVydFJlbmRlcmVyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEluZXJ0UmVuZGVyZXIpOwogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9SZW5kZXJlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIEluZXJ0UmVuZGVyZXIuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKF9yZWYxMCkgewogICAgICAgICAgICB2YXIgZW52ID0gX3JlZjEwLmVudiwKICAgICAgICAgICAgICAgIHJvb3RUZW1wbGF0ZSA9IF9yZWYxMC5yb290VGVtcGxhdGUsCiAgICAgICAgICAgICAgICBfdmlld1JlZ2lzdHJ5ID0gX3JlZjEwLl92aWV3UmVnaXN0cnksCiAgICAgICAgICAgICAgICBidWlsZGVyID0gX3JlZjEwLmJ1aWxkZXI7CgogICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMoZW52LCByb290VGVtcGxhdGUsIF92aWV3UmVnaXN0cnksIGZhbHNlLCBidWlsZGVyKTsKICAgICAgICB9OwoKICAgICAgICBJbmVydFJlbmRlcmVyLnByb3RvdHlwZS5nZXRFbGVtZW50ID0gZnVuY3Rpb24gZ2V0RWxlbWVudChfdmlldykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FjY2Vzc2luZyBgdGhpcy5lbGVtZW50YCBpcyBub3QgYWxsb3dlZCBpbiBub24taW50ZXJhY3RpdmUgZW52aXJvbm1lbnRzIChzdWNoIGFzIEZhc3RCb290KS4nKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gSW5lcnRSZW5kZXJlcjsKICAgIH0oUmVuZGVyZXIpOwoKICAgIHZhciBJbnRlcmFjdGl2ZVJlbmRlcmVyID0gZnVuY3Rpb24gKF9SZW5kZXJlcjIpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEludGVyYWN0aXZlUmVuZGVyZXIsIF9SZW5kZXJlcjIpOwoKICAgICAgICBmdW5jdGlvbiBJbnRlcmFjdGl2ZVJlbmRlcmVyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEludGVyYWN0aXZlUmVuZGVyZXIpOwogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9SZW5kZXJlcjIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBJbnRlcmFjdGl2ZVJlbmRlcmVyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShfcmVmMTEpIHsKICAgICAgICAgICAgdmFyIGVudiA9IF9yZWYxMS5lbnYsCiAgICAgICAgICAgICAgICByb290VGVtcGxhdGUgPSBfcmVmMTEucm9vdFRlbXBsYXRlLAogICAgICAgICAgICAgICAgX3ZpZXdSZWdpc3RyeSA9IF9yZWYxMS5fdmlld1JlZ2lzdHJ5LAogICAgICAgICAgICAgICAgYnVpbGRlciA9IF9yZWYxMS5idWlsZGVyOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyB0aGlzKGVudiwgcm9vdFRlbXBsYXRlLCBfdmlld1JlZ2lzdHJ5LCB0cnVlLCBidWlsZGVyKTsKICAgICAgICB9OwoKICAgICAgICBJbnRlcmFjdGl2ZVJlbmRlcmVyLnByb3RvdHlwZS5nZXRFbGVtZW50ID0gZnVuY3Rpb24gZ2V0RWxlbWVudCh2aWV3KSB7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyVmlld3MuZ2V0Vmlld0VsZW1lbnQpKHZpZXcpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBJbnRlcmFjdGl2ZVJlbmRlcmVyOwogICAgfShSZW5kZXJlcik7CgogICAgdmFyIFRFTVBMQVRFUyA9IHt9OwogICAgZnVuY3Rpb24gc2V0VGVtcGxhdGVzKHRlbXBsYXRlcykgewogICAgICAgIFRFTVBMQVRFUyA9IHRlbXBsYXRlczsKICAgIH0KICAgIGZ1bmN0aW9uIGdldFRlbXBsYXRlcygpIHsKICAgICAgICByZXR1cm4gVEVNUExBVEVTOwogICAgfQogICAgZnVuY3Rpb24gZ2V0VGVtcGxhdGUobmFtZSkgewogICAgICAgIGlmIChURU1QTEFURVMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIFRFTVBMQVRFU1tuYW1lXTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBoYXNUZW1wbGF0ZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIFRFTVBMQVRFUy5oYXNPd25Qcm9wZXJ0eShuYW1lKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldFRlbXBsYXRlKG5hbWUsIHRlbXBsYXRlKSB7CiAgICAgICAgcmV0dXJuIFRFTVBMQVRFU1tuYW1lXSA9IHRlbXBsYXRlOwogICAgfQoKICAgIC8vLzxyZWZlcmVuY2UgcGF0aD0iLi9zaW1wbGUtZG9tLmQudHMiIC8+CgogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgLyoqCiAgICAgIENhbGxzIFtsb2NdKC9hcGkvY2xhc3Nlcy9FbWJlci5TdHJpbmcuaHRtbCNtZXRob2RfbG9jKSB3aXRoIHRoZQogICAgICBwcm92aWRlZCBzdHJpbmcuIFRoaXMgaXMgYSBjb252ZW5pZW50IHdheSB0byBsb2NhbGl6ZSB0ZXh0IHdpdGhpbiBhIHRlbXBsYXRlLgogICAgICBGb3IgZXhhbXBsZToKICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIEVtYmVyLlNUUklOR1MgPSB7CiAgICAgICAgJ193ZWxjb21lXyc6ICdCb25qb3VyJwogICAgICB9OwogICAgICBgYGAKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxkaXYgY2xhc3M9J21lc3NhZ2UnPgogICAgICAgIHt7bG9jICdfd2VsY29tZV8nfX0KICAgICAgPC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGRpdiBjbGFzcz0nbWVzc2FnZSc+CiAgICAgICAgQm9uam91cgogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgU2VlIFtTdHJpbmcubG9jXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9TdHJpbmcvbWV0aG9kcy9sb2M/YW5jaG9yPWxvYykgZm9yIGhvdyB0bwogICAgICBzZXQgdXAgbG9jYWxpemVkIHN0cmluZyByZWZlcmVuY2VzLgogICAgCiAgICAgIEBtZXRob2QgbG9jCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3RyaW5nIHRvIGZvcm1hdC4KICAgICAgQHNlZSB7U3RyaW5nI2xvY30KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHZhciBsb2MkMSA9IGhlbHBlcihmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgICAgcmV0dXJuIF9zdHJpbmcubG9jLmFwcGx5KG51bGwsIHBhcmFtcyk7CiAgICB9KTsKCiAgICB2YXIgQ29tcGlsZVRpbWVMb29rdXAgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQ29tcGlsZVRpbWVMb29rdXAocmVzb2x2ZXIpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb21waWxlVGltZUxvb2t1cCk7CgogICAgICAgICAgICB0aGlzLnJlc29sdmVyID0gcmVzb2x2ZXI7CiAgICAgICAgfQoKICAgICAgICBDb21waWxlVGltZUxvb2t1cC5wcm90b3R5cGUuZ2V0Q2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKGhhbmRsZSkgewogICAgICAgICAgICB2YXIgZGVmaW5pdGlvbiA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZShoYW5kbGUpOwogICAgICAgICAgICB2YXIgbWFuYWdlciA9IGRlZmluaXRpb24ubWFuYWdlciwKICAgICAgICAgICAgICAgIHN0YXRlID0gZGVmaW5pdGlvbi5zdGF0ZTsKCiAgICAgICAgICAgIHJldHVybiBtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhzdGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcGlsZVRpbWVMb29rdXAucHJvdG90eXBlLmdldExheW91dCA9IGZ1bmN0aW9uIGdldExheW91dChoYW5kbGUpIHsKICAgICAgICAgICAgdmFyIF9yZXNvbHZlciRyZXNvbHZlID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlKGhhbmRsZSksCiAgICAgICAgICAgICAgICBtYW5hZ2VyID0gX3Jlc29sdmVyJHJlc29sdmUubWFuYWdlciwKICAgICAgICAgICAgICAgIHN0YXRlID0gX3Jlc29sdmVyJHJlc29sdmUuc3RhdGU7CgogICAgICAgICAgICB2YXIgY2FwYWJpbGl0aWVzID0gbWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpOwogICAgICAgICAgICBpZiAoY2FwYWJpbGl0aWVzLmR5bmFtaWNMYXlvdXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZvY2F0aW9uID0gbWFuYWdlci5nZXRMYXlvdXQoc3RhdGUsIHRoaXMucmVzb2x2ZXIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnZvY2F0aW9uLmhhbmRsZTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgc3ltYm9sVGFibGU6IGludm9jYXRpb24uc3ltYm9sVGFibGUKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBDb21waWxlVGltZUxvb2t1cC5wcm90b3R5cGUubG9va3VwSGVscGVyID0gZnVuY3Rpb24gbG9va3VwSGVscGVyKG5hbWUsIHJlZmVycmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc29sdmVyLmxvb2t1cEhlbHBlcihuYW1lLCByZWZlcnJlcik7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcGlsZVRpbWVMb29rdXAucHJvdG90eXBlLmxvb2t1cE1vZGlmaWVyID0gZnVuY3Rpb24gbG9va3VwTW9kaWZpZXIobmFtZSwgcmVmZXJyZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzb2x2ZXIubG9va3VwTW9kaWZpZXIobmFtZSwgcmVmZXJyZXIpOwogICAgICAgIH07CgogICAgICAgIENvbXBpbGVUaW1lTG9va3VwLnByb3RvdHlwZS5sb29rdXBDb21wb25lbnREZWZpbml0aW9uID0gZnVuY3Rpb24gbG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCByZWZlcnJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBDb21wb25lbnRIYW5kbGUobmFtZSwgcmVmZXJyZXIpOwogICAgICAgIH07CgogICAgICAgIENvbXBpbGVUaW1lTG9va3VwLnByb3RvdHlwZS5sb29rdXBQYXJ0aWFsID0gZnVuY3Rpb24gbG9va3VwUGFydGlhbChuYW1lLCByZWZlcnJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBQYXJ0aWFsKG5hbWUsIHJlZmVycmVyKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ29tcGlsZVRpbWVMb29rdXA7CiAgICB9KCk7CgogICAgdmFyIENBUEFCSUxJVElFUyQxID0gewogICAgICAgIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLAogICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgIHByZXBhcmVBcmdzOiBmYWxzZSwKICAgICAgICBjcmVhdGVBcmdzOiBmYWxzZSwKICAgICAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgICAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICAgICAgY3JlYXRlQ2FsbGVyOiB0cnVlLAogICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiB0cnVlCiAgICB9OwoKICAgIHZhciBUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyID0gZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXIzKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyLCBfQWJzdHJhY3RNYW5hZ2VyMyk7CgogICAgICAgIGZ1bmN0aW9uIFRlbXBsYXRlT25seUNvbXBvbmVudE1hbmFnZXIoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlcik7CiAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0Fic3RyYWN0TWFuYWdlcjMuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgfQoKICAgICAgICBUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQodGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzTGF5b3V0KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBoYW5kbGU6IGxheW91dC5jb21waWxlKCksCiAgICAgICAgICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0Q2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKCkgewogICAgICAgICAgICByZXR1cm4gQ0FQQUJJTElUSUVTJDE7CiAgICAgICAgfTsKCiAgICAgICAgVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICBUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZigpIHsKICAgICAgICAgICAgcmV0dXJuIF9ydW50aW1lLk5VTExfUkVGRVJFTkNFOwogICAgICAgIH07CgogICAgICAgIFRlbXBsYXRlT25seUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZygpIHsKICAgICAgICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgIH07CgogICAgICAgIFRlbXBsYXRlT25seUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gVGVtcGxhdGVPbmx5Q29tcG9uZW50TWFuYWdlcjsKICAgIH0oQWJzdHJhY3RNYW5hZ2VyKTsKCiAgICB2YXIgTUFOQUdFUiA9IG5ldyBUZW1wbGF0ZU9ubHlDb21wb25lbnRNYW5hZ2VyKCk7CgogICAgdmFyIFRlbXBsYXRlT25seUNvbXBvbmVudERlZmluaXRpb24gPSBmdW5jdGlvbiBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWZpbml0aW9uKHN0YXRlKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUZW1wbGF0ZU9ubHlDb21wb25lbnREZWZpbml0aW9uKTsKCiAgICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgICAgIHRoaXMubWFuYWdlciA9IE1BTkFHRVI7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGNsYXNzSGVscGVyKF9yZWYxMikgewogICAgICAgIHZhciBwb3NpdGlvbmFsID0gX3JlZjEyLnBvc2l0aW9uYWw7CgogICAgICAgIHZhciBwYXRoID0gcG9zaXRpb25hbC5hdCgwKTsKICAgICAgICB2YXIgYXJncyA9IHBvc2l0aW9uYWwubGVuZ3RoOwogICAgICAgIHZhciB2YWx1ZSA9IHBhdGgudmFsdWUoKTsKICAgICAgICBpZiAodmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgaWYgKGFyZ3MgPiAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9zdHJpbmcuZGFzaGVyaXplKShwb3NpdGlvbmFsLmF0KDEpLnZhbHVlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGlmIChhcmdzID4gMikgewogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfc3RyaW5nLmRhc2hlcml6ZSkocG9zaXRpb25hbC5hdCgyKS52YWx1ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgZnVuY3Rpb24gY2xhc3NIZWxwZXIkMShfdm0sIGFyZ3MpIHsKICAgICAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKGNsYXNzSGVscGVyLCBhcmdzLmNhcHR1cmUoKSk7CiAgICB9CgogICAgZnVuY3Rpb24gaHRtbFNhZmUkMShfcmVmMTMpIHsKICAgICAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYxMy5wb3NpdGlvbmFsOwoKICAgICAgICB2YXIgcGF0aCA9IHBvc2l0aW9uYWwuYXQoMCk7CiAgICAgICAgcmV0dXJuIG5ldyBTYWZlU3RyaW5nKHBhdGgudmFsdWUoKSk7CiAgICB9CiAgICBmdW5jdGlvbiBodG1sU2FmZUhlbHBlcihfdm0sIGFyZ3MpIHsKICAgICAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKGh0bWxTYWZlJDEsIGFyZ3MuY2FwdHVyZSgpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbnB1dFR5cGVIZWxwZXIoX3JlZjE0KSB7CiAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSBfcmVmMTQucG9zaXRpb25hbDsKCiAgICAgICAgdmFyIHR5cGUgPSBwb3NpdGlvbmFsLmF0KDApLnZhbHVlKCk7CiAgICAgICAgaWYgKHR5cGUgPT09ICdjaGVja2JveCcpIHsKICAgICAgICAgICAgcmV0dXJuICctY2hlY2tib3gnOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJy10ZXh0LWZpZWxkJzsKICAgIH0KICAgIGZ1bmN0aW9uIGlucHV0VHlwZUhlbHBlciQxKF92bSwgYXJncykgewogICAgICAgIHJldHVybiBuZXcgSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UoaW5wdXRUeXBlSGVscGVyLCBhcmdzLmNhcHR1cmUoKSk7CiAgICB9CgogICAgZnVuY3Rpb24gbm9ybWFsaXplQ2xhc3MoX3JlZjE1KSB7CiAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSBfcmVmMTUucG9zaXRpb25hbDsKCiAgICAgICAgdmFyIGNsYXNzTmFtZVBhcnRzID0gcG9zaXRpb25hbC5hdCgwKS52YWx1ZSgpLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9IGNsYXNzTmFtZVBhcnRzW2NsYXNzTmFtZVBhcnRzLmxlbmd0aCAtIDFdOwogICAgICAgIHZhciB2YWx1ZSA9IHBvc2l0aW9uYWwuYXQoMSkudmFsdWUoKTsKICAgICAgICBpZiAodmFsdWUgPT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuICgwLCBfc3RyaW5nLmRhc2hlcml6ZSkoY2xhc3NOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKCF2YWx1ZSAmJiB2YWx1ZSAhPT0gMCkgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gbm9ybWFsaXplQ2xhc3NIZWxwZXIoX3ZtLCBhcmdzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZShub3JtYWxpemVDbGFzcywgYXJncy5jYXB0dXJlKCkpOwogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBUaGUgYHt7YWN0aW9ufX1gIGhlbHBlciBwcm92aWRlcyBhIHdheSB0byBwYXNzIHRyaWdnZXJzIGZvciBiZWhhdmlvciAodXN1YWxseQogICAgICBqdXN0IGEgZnVuY3Rpb24pIGJldHdlZW4gY29tcG9uZW50cywgYW5kIGludG8gY29tcG9uZW50cyBmcm9tIGNvbnRyb2xsZXJzLgogICAgCiAgICAgICMjIyBQYXNzaW5nIGZ1bmN0aW9ucyB3aXRoIHRoZSBhY3Rpb24gaGVscGVyCiAgICAKICAgICAgVGhlcmUgYXJlIHRocmVlIGNvbnRleHRzIGFuIGFjdGlvbiBoZWxwZXIgY2FuIGJlIHVzZWQgaW4uIFRoZSBmaXJzdCB0d28KICAgICAgY29udGV4dHMgdG8gZGlzY3VzcyBhcmUgYXR0cmlidXRlIGNvbnRleHQsIGFuZCBIYW5kbGViYXJzIHZhbHVlIGNvbnRleHQuCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgQW4gZXhhbXBsZSBvZiBhdHRyaWJ1dGUgY29udGV4dCB9fQogICAgICA8ZGl2IG9uY2xpY2s9e3thY3Rpb24gInNhdmUifX0+PC9kaXY+CiAgICAgIHt7ISBFeGFtcGxlcyBvZiBIYW5kbGViYXJzIHZhbHVlIGNvbnRleHQgfX0KICAgICAge3tpbnB1dCBvbi1pbnB1dD0oYWN0aW9uICJzYXZlIil9fQogICAgICB7e3lpZWxkIChhY3Rpb24gInJlZnJlc2hEYXRhIikgYW5kQW5vdGhlclBhcmFtfX0KICAgICAgYGBgCiAgICAKICAgICAgSW4gdGhlc2UgY29udGV4dHMsCiAgICAgIHRoZSBoZWxwZXIgaXMgY2FsbGVkIGEgImNsb3N1cmUgYWN0aW9uIiBoZWxwZXIuIEl0cyBiZWhhdmlvciBpcyBzaW1wbGU6CiAgICAgIElmIHBhc3NlZCBhIGZ1bmN0aW9uIG5hbWUsIHJlYWQgdGhhdCBmdW5jdGlvbiBvZmYgdGhlIGBhY3Rpb25zYCBwcm9wZXJ0eQogICAgICBvZiB0aGUgY3VycmVudCBjb250ZXh0LiBPbmNlIHRoYXQgZnVuY3Rpb24gaXMgcmVhZCwgb3IgaW1tZWRpYXRlbHkgaWYgYSBmdW5jdGlvbiB3YXMKICAgICAgcGFzc2VkLCBjcmVhdGUgYSBjbG9zdXJlIG92ZXIgdGhhdCBmdW5jdGlvbiBhbmQgYW55IGFyZ3VtZW50cy4KICAgICAgVGhlIHJlc3VsdGluZyB2YWx1ZSBvZiBhbiBhY3Rpb24gaGVscGVyIHVzZWQgdGhpcyB3YXkgaXMgc2ltcGx5IGEgZnVuY3Rpb24uCiAgICAKICAgICAgRm9yIGV4YW1wbGUsIGluIHRoZSBhdHRyaWJ1dGUgY29udGV4dDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7ISBBbiBleGFtcGxlIG9mIGF0dHJpYnV0ZSBjb250ZXh0IH19CiAgICAgIDxkaXYgb25jbGljaz17e2FjdGlvbiAic2F2ZSJ9fT48L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgVGhlIHJlc3VsdGluZyB0ZW1wbGF0ZSByZW5kZXIgbG9naWMgd291bGQgYmU6CiAgICAKICAgICAgYGBganMKICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICB2YXIgYWN0aW9uRnVuY3Rpb24gPSAoZnVuY3Rpb24oY29udGV4dCl7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQuYWN0aW9ucy5zYXZlLmFwcGx5KGNvbnRleHQsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgfSkoY29udGV4dCk7CiAgICAgIGRpdi5vbmNsaWNrID0gYWN0aW9uRnVuY3Rpb247CiAgICAgIGBgYAogICAgCiAgICAgIFRodXMgd2hlbiB0aGUgZGl2IGlzIGNsaWNrZWQsIHRoZSBhY3Rpb24gb24gdGhhdCBjb250ZXh0IGlzIGNhbGxlZC4KICAgICAgQmVjYXVzZSB0aGUgYGFjdGlvbkZ1bmN0aW9uYCBpcyBqdXN0IGEgZnVuY3Rpb24sIGNsb3N1cmUgYWN0aW9ucyBjYW4gYmUKICAgICAgcGFzc2VkIGJldHdlZW4gY29tcG9uZW50cyBhbmQgc3RpbGwgZXhlY3V0ZSBpbiB0aGUgY29ycmVjdCBjb250ZXh0LgogICAgCiAgICAgIEhlcmUgaXMgYW4gZXhhbXBsZSBhY3Rpb24gaGFuZGxlciBvbiBhIGNvbXBvbmVudDoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBzYXZlKCkgewogICAgICAgICAgICB0aGlzLmdldCgnbW9kZWwnKS5zYXZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgQWN0aW9ucyBhcmUgYWx3YXlzIGxvb2tlZCB1cCBvbiB0aGUgYGFjdGlvbnNgIHByb3BlcnR5IG9mIHRoZSBjdXJyZW50IGNvbnRleHQuCiAgICAgIFRoaXMgYXZvaWRzIGNvbGxpc2lvbnMgaW4gdGhlIG5hbWluZyBvZiBjb21tb24gYWN0aW9ucywgc3VjaCBhcyBgZGVzdHJveWAuCiAgICAgIFR3byBvcHRpb25zIGNhbiBiZSBwYXNzZWQgdG8gdGhlIGBhY3Rpb25gIGhlbHBlciB3aGVuIGl0IGlzIHVzZWQgaW4gdGhpcyB3YXkuCiAgICAKICAgICAgKiBgdGFyZ2V0PXNvbWVQcm9wZXJ0eWAgd2lsbCBsb29rIHRvIGBzb21lUHJvcGVydHlgIGluc3RlYWQgb2YgdGhlIGN1cnJlbnQKICAgICAgICBjb250ZXh0IGZvciB0aGUgYGFjdGlvbnNgIGhhc2guIFRoaXMgY2FuIGJlIHVzZWZ1bCB3aGVuIHRhcmdldGluZyBhCiAgICAgICAgc2VydmljZSBmb3IgYWN0aW9ucy4KICAgICAgKiBgdmFsdWU9InRhcmdldC52YWx1ZSJgIHdpbGwgcmVhZCB0aGUgcGF0aCBgdGFyZ2V0LnZhbHVlYCBvZmYgdGhlIGZpcnN0CiAgICAgICAgYXJndW1lbnQgdG8gdGhlIGFjdGlvbiB3aGVuIGl0IGlzIGNhbGxlZCBhbmQgcmV3cml0ZSB0aGUgZmlyc3QgYXJndW1lbnQKICAgICAgICB0byBiZSB0aGF0IHZhbHVlLiBUaGlzIGlzIHVzZWZ1bCB3aGVuIGF0dGFjaGluZyBhY3Rpb25zIHRvIGV2ZW50IGxpc3RlbmVycy4KICAgIAogICAgICAjIyMgSW52b2tpbmcgYW4gYWN0aW9uCiAgICAKICAgICAgQ2xvc3VyZSBhY3Rpb25zIGN1cnJ5IGJvdGggdGhlaXIgc2NvcGUgYW5kIGFueSBhcmd1bWVudHMuIFdoZW4gaW52b2tlZCwgYW55CiAgICAgIGFkZGl0aW9uYWwgYXJndW1lbnRzIGFyZSBhZGRlZCB0byB0aGUgYWxyZWFkeSBjdXJyaWVkIGxpc3QuCiAgICAgIEFjdGlvbnMgc2hvdWxkIGJlIGludm9rZWQgdXNpbmcgdGhlIFtzZW5kQWN0aW9uXSgvYXBpL2VtYmVyL3JlbGVhc2UvY2xhc3Nlcy9Db21wb25lbnQvbWV0aG9kcy9zZW5kQWN0aW9uP2FuY2hvcj1zZW5kQWN0aW9uKQogICAgICBtZXRob2QuIFRoZSBmaXJzdCBhcmd1bWVudCB0byBgc2VuZEFjdGlvbmAgaXMgdGhlIGFjdGlvbiB0byBiZSBjYWxsZWQsIGFuZAogICAgICBhZGRpdGlvbmFsIGFyZ3VtZW50cyBhcmUgcGFzc2VkIHRvIHRoZSBhY3Rpb24gZnVuY3Rpb24uIFRoaXMgaGFzIGludGVyZXN0aW5nCiAgICAgIHByb3BlcnRpZXMgY29tYmluZWQgd2l0aCBjdXJyeWluZyBvZiBhcmd1bWVudHMuIEZvciBleGFtcGxlOgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIC8vIFVzYWdlIHt7aW5wdXQgb24taW5wdXQ9KGFjdGlvbiAoYWN0aW9uICdzZXROYW1lJyBtb2RlbCkgdmFsdWU9InRhcmdldC52YWx1ZSIpfX0KICAgICAgICAgIHNldE5hbWUobW9kZWwsIG5hbWUpIHsKICAgICAgICAgICAgbW9kZWwuc2V0KCduYW1lJywgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgVGhlIGZpcnN0IGFyZ3VtZW50IChgbW9kZWxgKSB3YXMgY3VycmllZCBvdmVyLCBhbmQgdGhlIHJ1bi10aW1lIGFyZ3VtZW50IChgZXZlbnRgKQogICAgICBiZWNvbWVzIGEgc2Vjb25kIGFyZ3VtZW50LiBBY3Rpb24gY2FsbHMgY2FuIGJlIG5lc3RlZCB0aGlzIHdheSBiZWNhdXNlIGVhY2ggc2ltcGx5CiAgICAgIHJldHVybnMgYSBmdW5jdGlvbi4gQW55IGZ1bmN0aW9uIGNhbiBiZSBwYXNzZWQgdG8gdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIsIGluY2x1ZGluZwogICAgICBvdGhlciBhY3Rpb25zLgogICAgCiAgICAgIEFjdGlvbnMgaW52b2tlZCB3aXRoIGBzZW5kQWN0aW9uYCBoYXZlIHRoZSBzYW1lIGN1cnJ5aW5nIGJlaGF2aW9yIGFzIGRlbW9uc3RyYXRlZAogICAgICB3aXRoIGBvbi1pbnB1dGAgYWJvdmUuIEZvciBleGFtcGxlOgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWlucHV0LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgc2V0TmFtZShtb2RlbCwgbmFtZSkgewogICAgICAgICAgICBtb2RlbC5zZXQoJ25hbWUnLCBuYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7bXktaW5wdXQgc3VibWl0PShhY3Rpb24gJ3NldE5hbWUnIG1vZGVsKX19CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LWNvbXBvbmVudC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsaWNrKCkgewogICAgICAgICAgLy8gTm90ZSB0aGF0IG1vZGVsIGlzIG5vdCBwYXNzZWQsIGl0IHdhcyBjdXJyaWVkIGluIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgdGhpcy5zZW5kQWN0aW9uKCdzdWJtaXQnLCAnYm9iJyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgIyMjIEF0dGFjaGluZyBhY3Rpb25zIHRvIERPTSBlbGVtZW50cwogICAgCiAgICAgIFRoZSB0aGlyZCBjb250ZXh0IG9mIHRoZSBge3thY3Rpb259fWAgaGVscGVyIGNhbiBiZSBjYWxsZWQgImVsZW1lbnQgc3BhY2UiLgogICAgICBGb3IgZXhhbXBsZToKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7ISBBbiBleGFtcGxlIG9mIGVsZW1lbnQgc3BhY2UgfX0KICAgICAgPGRpdiB7e2FjdGlvbiAic2F2ZSJ9fT48L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgVXNlZCB0aGlzIHdheSwgdGhlIGB7e2FjdGlvbn19YCBoZWxwZXIgcHJvdmlkZXMgYSB1c2VmdWwgc2hvcnRjdXQgZm9yCiAgICAgIHJlZ2lzdGVyaW5nIGFuIEhUTUwgZWxlbWVudCBpbiBhIHRlbXBsYXRlIGZvciBhIHNpbmdsZSBET00gZXZlbnQgYW5kCiAgICAgIGZvcndhcmRpbmcgdGhhdCBpbnRlcmFjdGlvbiB0byB0aGUgdGVtcGxhdGUncyBjb250ZXh0IChjb250cm9sbGVyIG9yIGNvbXBvbmVudCkuCiAgICAgIElmIHRoZSBjb250ZXh0IG9mIGEgdGVtcGxhdGUgaXMgYSBjb250cm9sbGVyLCBhY3Rpb25zIHVzZWQgdGhpcyB3YXkgd2lsbAogICAgICBidWJibGUgdG8gcm91dGVzIHdoZW4gdGhlIGNvbnRyb2xsZXIgZG9lcyBub3QgaW1wbGVtZW50IHRoZSBzcGVjaWZpZWQgYWN0aW9uLgogICAgICBPbmNlIGFuIGFjdGlvbiBoaXRzIGEgcm91dGUsIGl0IHdpbGwgYnViYmxlIHRocm91Z2ggdGhlIHJvdXRlIGhpZXJhcmNoeS4KICAgIAogICAgICAjIyMgRXZlbnQgUHJvcGFnYXRpb24KICAgIAogICAgICBge3thY3Rpb259fWAgaGVscGVycyBjYWxsZWQgaW4gZWxlbWVudCBzcGFjZSBjYW4gY29udHJvbCBldmVudCBidWJibGluZy4gTm90ZQogICAgICB0aGF0IHRoZSBjbG9zdXJlIHN0eWxlIGFjdGlvbnMgY2Fubm90LgogICAgCiAgICAgIEV2ZW50cyB0cmlnZ2VyZWQgdGhyb3VnaCB0aGUgYWN0aW9uIGhlbHBlciB3aWxsIGF1dG9tYXRpY2FsbHkgaGF2ZQogICAgICBgLnByZXZlbnREZWZhdWx0KClgIGNhbGxlZCBvbiB0aGVtLiBZb3UgZG8gbm90IG5lZWQgdG8gZG8gc28gaW4geW91ciBldmVudAogICAgICBoYW5kbGVycy4gSWYgeW91IG5lZWQgdG8gYWxsb3cgZXZlbnQgcHJvcGFnYXRpb24gKHRvIGhhbmRsZSBmaWxlIGlucHV0cyBmb3IKICAgICAgZXhhbXBsZSkgeW91IGNhbiBzdXBwbHkgdGhlIGBwcmV2ZW50RGVmYXVsdD1mYWxzZWAgb3B0aW9uIHRvIHRoZSBge3thY3Rpb259fWAgaGVscGVyOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPGRpdiB7e2FjdGlvbiAic2F5SGVsbG8iIHByZXZlbnREZWZhdWx0PWZhbHNlfX0+CiAgICAgICAgPGlucHV0IHR5cGU9ImZpbGUiIC8+CiAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiAvPgogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgVG8gZGlzYWJsZSBidWJibGluZywgcGFzcyBgYnViYmxlcz1mYWxzZWAgdG8gdGhlIGhlbHBlcjoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxidXR0b24ge3thY3Rpb24gJ2VkaXQnIHBvc3QgYnViYmxlcz1mYWxzZX19PkVkaXQ8L2J1dHRvbj4KICAgICAgYGBgCiAgICAKICAgICAgVG8gZGlzYWJsZSBidWJibGluZyB3aXRoIGNsb3N1cmUgc3R5bGUgYWN0aW9ucyB5b3UgbXVzdCBjcmVhdGUgeW91ciBvd24KICAgICAgd3JhcHBlciBoZWxwZXIgdGhhdCBtYWtlcyB1c2Ugb2YgYGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpYDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxkaXYgb25jbGljaz17e2Rpc2FibGUtYnViYmxpbmcgKGFjdGlvbiAic2F5SGVsbG8iKX19PkhlbGxvPC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGFwcC9oZWxwZXJzL2Rpc2FibGUtYnViYmxpbmcuanMKICAgICAgaW1wb3J0IHsgaGVscGVyIH0gZnJvbSAnQGVtYmVyL2NvbXBvbmVudC9oZWxwZXInOwogICAgCiAgICAgIGV4cG9ydCBmdW5jdGlvbiBkaXNhYmxlQnViYmxpbmcoW2FjdGlvbl0pIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgcmV0dXJuIGFjdGlvbihldmVudCk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBleHBvcnQgZGVmYXVsdCBoZWxwZXIoZGlzYWJsZUJ1YmJsaW5nKTsKICAgICAgYGBgCiAgICAKICAgICAgSWYgeW91IG5lZWQgdGhlIGRlZmF1bHQgaGFuZGxlciB0byB0cmlnZ2VyIHlvdSBzaG91bGQgZWl0aGVyIHJlZ2lzdGVyIHlvdXIKICAgICAgb3duIGV2ZW50IGhhbmRsZXIsIG9yIHVzZSBldmVudCBtZXRob2RzIG9uIHlvdXIgdmlldyBjbGFzcy4gU2VlCiAgICAgIFsiUmVzcG9uZGluZyB0byBCcm93c2VyIEV2ZW50cyJdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NvbXBvbmVudCkKICAgICAgaW4gdGhlIGRvY3VtZW50YXRpb24gZm9yIGBDb21wb25lbnRgIGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgCiAgICAgICMjIyBTcGVjaWZ5aW5nIERPTSBldmVudCB0eXBlCiAgICAKICAgICAgYHt7YWN0aW9ufX1gIGhlbHBlcnMgY2FsbGVkIGluIGVsZW1lbnQgc3BhY2UgY2FuIHNwZWNpZnkgYW4gZXZlbnQgdHlwZS4KICAgICAgQnkgZGVmYXVsdCB0aGUgYHt7YWN0aW9ufX1gIGhlbHBlciByZWdpc3RlcnMgZm9yIERPTSBgY2xpY2tgIGV2ZW50cy4gWW91IGNhbgogICAgICBzdXBwbHkgYW4gYG9uYCBvcHRpb24gdG8gdGhlIGhlbHBlciB0byBzcGVjaWZ5IGEgZGlmZmVyZW50IERPTSBldmVudCBuYW1lOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPGRpdiB7e2FjdGlvbiAiYW5BY3Rpb25OYW1lIiBvbj0iZG91YmxlQ2xpY2sifX0+CiAgICAgICAgY2xpY2sgbWUKICAgICAgPC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIFNlZSBbIkV2ZW50IE5hbWVzIl0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQ29tcG9uZW50KSBmb3IgYSBsaXN0IG9mCiAgICAgIGFjY2VwdGFibGUgRE9NIGV2ZW50IG5hbWVzLgogICAgCiAgICAgICMjIyBTcGVjaWZ5aW5nIHdoaXRlbGlzdGVkIG1vZGlmaWVyIGtleXMKICAgIAogICAgICBge3thY3Rpb259fWAgaGVscGVycyBjYWxsZWQgaW4gZWxlbWVudCBzcGFjZSBjYW4gc3BlY2lmeSBtb2RpZmllciBrZXlzLgogICAgICBCeSBkZWZhdWx0IHRoZSBge3thY3Rpb259fWAgaGVscGVyIHdpbGwgaWdub3JlIGNsaWNrIGV2ZW50cyB3aXRoIHByZXNzZWQgbW9kaWZpZXIKICAgICAga2V5cy4gWW91IGNhbiBzdXBwbHkgYW4gYGFsbG93ZWRLZXlzYCBvcHRpb24gdG8gc3BlY2lmeSB3aGljaCBrZXlzIHNob3VsZCBub3QgYmUgaWdub3JlZC4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxkaXYge3thY3Rpb24gImFuQWN0aW9uTmFtZSIgYWxsb3dlZEtleXM9ImFsdCJ9fT4KICAgICAgICBjbGljayBtZQogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgVGhpcyB3YXkgdGhlIGFjdGlvbiB3aWxsIGZpcmUgd2hlbiBjbGlja2luZyB3aXRoIHRoZSBhbHQga2V5IHByZXNzZWQgZG93bi4KICAgICAgQWx0ZXJuYXRpdmVseSwgc3VwcGx5ICJhbnkiIHRvIHRoZSBgYWxsb3dlZEtleXNgIG9wdGlvbiB0byBhY2NlcHQgYW55IGNvbWJpbmF0aW9uIG9mIG1vZGlmaWVyIGtleXMuCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICA8ZGl2IHt7YWN0aW9uICJhbkFjdGlvbk5hbWUiIGFsbG93ZWRLZXlzPSJhbnkifX0+CiAgICAgICAgY2xpY2sgbWUgd2l0aCBhbnkga2V5IHByZXNzZWQKICAgICAgPC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgICMjIyBTcGVjaWZ5aW5nIGEgVGFyZ2V0CiAgICAKICAgICAgQSBgdGFyZ2V0YCBvcHRpb24gY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBoZWxwZXIgdG8gY2hhbmdlCiAgICAgIHdoaWNoIG9iamVjdCB3aWxsIHJlY2VpdmUgdGhlIG1ldGhvZCBjYWxsLiBUaGlzIG9wdGlvbiBtdXN0IGJlIGEgcGF0aAogICAgICB0byBhbiBvYmplY3QsIGFjY2Vzc2libGUgaW4gdGhlIGN1cnJlbnQgY29udGV4dDoKICAgIAogICAgICBgYGBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicwogICAgICA8ZGl2IHt7YWN0aW9uICJhbkFjdGlvbk5hbWUiIHRhcmdldD1zb21lU2VydmljZX19PgogICAgICAgIGNsaWNrIG1lCiAgICAgIDwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBgYGBhcHAvY29udHJvbGxlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgICBpbXBvcnQgeyBpbmplY3QgYXMgc2VydmljZSB9IGZyb20gJ0BlbWJlci9zZXJ2aWNlJzsKICAgIAogICAgICBleHBvcnQgZGVmYXVsdCBDb250cm9sbGVyLmV4dGVuZCh7CiAgICAgICAgc29tZVNlcnZpY2U6IHNlcnZpY2UoKQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBhY3Rpb24KICAgICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gYWN0aW9uKF92bSwgYXJncykgewogICAgICAgIHZhciBuYW1lZCA9IGFyZ3MubmFtZWQsCiAgICAgICAgICAgIHBvc2l0aW9uYWwgPSBhcmdzLnBvc2l0aW9uYWw7CgogICAgICAgIHZhciBjYXB0dXJlZEFyZ3MgPSBwb3NpdGlvbmFsLmNhcHR1cmUoKTsKICAgICAgICAvLyBUaGUgZmlyc3QgdHdvIGFyZ3VtZW50IHNsb3RzIGFyZSByZXNlcnZlZC4KICAgICAgICAvLyBwb3NbMF0gaXMgdGhlIGNvbnRleHQgKG9yIGB0aGlzYCkKICAgICAgICAvLyBwb3NbMV0gaXMgdGhlIGFjdGlvbiBuYW1lIG9yIGZ1bmN0aW9uCiAgICAgICAgLy8gQW55dGhpbmcgZWxzZSBpcyBhbiBhY3Rpb24gYXJndW1lbnQuCgogICAgICAgIHZhciBfY2FwdHVyZWRBcmdzJHJlZmVyZW4gPSBjYXB0dXJlZEFyZ3MucmVmZXJlbmNlcywKICAgICAgICAgICAgY29udGV4dCA9IF9jYXB0dXJlZEFyZ3MkcmVmZXJlblswXSwKICAgICAgICAgICAgYWN0aW9uID0gX2NhcHR1cmVkQXJncyRyZWZlcmVuWzFdLAogICAgICAgICAgICByZXN0QXJncyA9IF9jYXB0dXJlZEFyZ3MkcmVmZXJlbi5zbGljZSgyKTsKCiAgICAgICAgLy8gVE9ETzogSXMgdGhlcmUgYSBiZXR0ZXIgd2F5IG9mIGRvaW5nIHRoaXM/CiAgICAgICAgdmFyIGRlYnVnS2V5ID0gYWN0aW9uLl9wcm9wZXJ0eUtleTsKICAgICAgICB2YXIgdGFyZ2V0ID0gbmFtZWQuaGFzKCd0YXJnZXQnKSA/IG5hbWVkLmdldCgndGFyZ2V0JykgOiBjb250ZXh0OwogICAgICAgIHZhciBwcm9jZXNzQXJncyA9IG1ha2VBcmdzUHJvY2Vzc29yKG5hbWVkLmhhcygndmFsdWUnKSAmJiBuYW1lZC5nZXQoJ3ZhbHVlJyksIHJlc3RBcmdzKTsKICAgICAgICB2YXIgZm4gPSB2b2lkIDA7CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb25bSU5WT0tFXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmbiA9IG1ha2VDbG9zdXJlQWN0aW9uKGFjdGlvbiwgYWN0aW9uLCBhY3Rpb25bSU5WT0tFXSwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KTsKICAgICAgICB9IGVsc2UgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHRhcmdldCkgJiYgKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkoYWN0aW9uKSkgewogICAgICAgICAgICBmbiA9IG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQudmFsdWUoKSwgdGFyZ2V0LnZhbHVlKCksIGFjdGlvbi52YWx1ZSgpLCBwcm9jZXNzQXJncywgZGVidWdLZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZuID0gbWFrZUR5bmFtaWNDbG9zdXJlQWN0aW9uKGNvbnRleHQudmFsdWUoKSwgdGFyZ2V0LCBhY3Rpb24sIHByb2Nlc3NBcmdzLCBkZWJ1Z0tleSk7CiAgICAgICAgfQogICAgICAgIGZuW0FDVElPTl0gPSB0cnVlOwogICAgICAgIHJldHVybiBuZXcgVW5ib3VuZFJlZmVyZW5jZShmbik7CiAgICB9CiAgICBmdW5jdGlvbiBOT09QJDEoYXJncykgewogICAgICAgIHJldHVybiBhcmdzOwogICAgfQogICAgZnVuY3Rpb24gbWFrZUFyZ3NQcm9jZXNzb3IodmFsdWVQYXRoUmVmLCBhY3Rpb25BcmdzUmVmKSB7CiAgICAgICAgdmFyIG1lcmdlQXJncyA9IHZvaWQgMDsKICAgICAgICBpZiAoYWN0aW9uQXJnc1JlZi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIG1lcmdlQXJncyA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aW9uQXJnc1JlZi5tYXAoZnVuY3Rpb24gKHJlZikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWYudmFsdWUoKTsKICAgICAgICAgICAgICAgIH0pLmNvbmNhdChhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlYWRWYWx1ZSA9IHZvaWQgMDsKICAgICAgICBpZiAodmFsdWVQYXRoUmVmKSB7CiAgICAgICAgICAgIHJlYWRWYWx1ZSA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVQYXRoID0gdmFsdWVQYXRoUmVmLnZhbHVlKCk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWVQYXRoICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbMF0gPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShhcmdzWzBdLCB2YWx1ZVBhdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChtZXJnZUFyZ3MgJiYgcmVhZFZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlYWRWYWx1ZShtZXJnZUFyZ3MoYXJncykpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtZXJnZUFyZ3MgfHwgcmVhZFZhbHVlIHx8IE5PT1AkMTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBtYWtlRHluYW1pY0Nsb3N1cmVBY3Rpb24oY29udGV4dCwgdGFyZ2V0UmVmLCBhY3Rpb25SZWYsIHByb2Nlc3NBcmdzLCBkZWJ1Z0tleSkgewogICAgICAgIC8vIFdlIGRvbid0IGFsbG93IHVuZGVmaW5lZC9udWxsIHZhbHVlcywgc28gdGhpcyBjcmVhdGVzIGEgdGhyb3ctYXdheSBhY3Rpb24gdG8gdHJpZ2dlciB0aGUgYXNzZXJ0aW9ucwogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQsIHRhcmdldFJlZi52YWx1ZSgpLCBhY3Rpb25SZWYudmFsdWUoKSwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQsIHRhcmdldFJlZi52YWx1ZSgpLCBhY3Rpb25SZWYudmFsdWUoKSwgcHJvY2Vzc0FyZ3MsIGRlYnVnS2V5KS5hcHBseSh1bmRlZmluZWQsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VDbG9zdXJlQWN0aW9uKGNvbnRleHQsIHRhcmdldCwgYWN0aW9uLCBwcm9jZXNzQXJncywgZGVidWdLZXkpIHsKICAgICAgICB2YXIgc2VsZiA9IHZvaWQgMDsKICAgICAgICB2YXIgZm4gPSB2b2lkIDA7CiAgICAgICAgKHRydWUgJiYgIShhY3Rpb24gIT09IHVuZGVmaW5lZCAmJiBhY3Rpb24gIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQWN0aW9uIHBhc3NlZCBpcyBudWxsIG9yIHVuZGVmaW5lZCBpbiAoYWN0aW9uKSBmcm9tICcgKyB0YXJnZXQgKyAnLicsIGFjdGlvbiAhPT0gdW5kZWZpbmVkICYmIGFjdGlvbiAhPT0gbnVsbCkpOwoKICAgICAgICBpZiAodHlwZW9mIGFjdGlvbltJTlZPS0VdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHNlbGYgPSBhY3Rpb247CiAgICAgICAgICAgIGZuID0gYWN0aW9uW0lOVk9LRV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHR5cGVvZkFjdGlvbiA9IHR5cGVvZiBhY3Rpb247CiAgICAgICAgICAgIGlmICh0eXBlb2ZBY3Rpb24gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBzZWxmID0gdGFyZ2V0OwogICAgICAgICAgICAgICAgZm4gPSB0YXJnZXQuYWN0aW9ucyAmJiB0YXJnZXQuYWN0aW9uc1thY3Rpb25dOwogICAgICAgICAgICAgICAgKHRydWUgJiYgIShmbikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdBbiBhY3Rpb24gbmFtZWQgXCcnICsgYWN0aW9uICsgJ1wnIHdhcyBub3QgZm91bmQgaW4gJyArIHRhcmdldCwgZm4pKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2ZBY3Rpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHNlbGYgPSBjb250ZXh0OwogICAgICAgICAgICAgICAgZm4gPSBhY3Rpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0FuIGFjdGlvbiBjb3VsZCBub3QgYmUgbWFkZSBmb3IgYCcgKyAoZGVidWdLZXkgfHwgYWN0aW9uKSArICdgIGluICcgKyB0YXJnZXQgKyAnLiBQbGVhc2UgY29uZmlybSB0aGF0IHlvdSBhcmUgdXNpbmcgZWl0aGVyIGEgcXVvdGVkIGFjdGlvbiBuYW1lIChpLmUuIGAoYWN0aW9uIFwnJyArIChkZWJ1Z0tleSB8fCAnbXlBY3Rpb24nKSArICdcJylgKSBvciBhIGZ1bmN0aW9uIGF2YWlsYWJsZSBpbiAnICsgdGFyZ2V0ICsgJy4nLCBmYWxzZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwYXlsb2FkID0geyB0YXJnZXQ6IHNlbGYsIGFyZ3M6IGFyZ3MsIGxhYmVsOiAnQGdsaW1tZXIvY2xvc3VyZS1hY3Rpb24nIH07CiAgICAgICAgICAgIHJldHVybiAoMCwgX2luc3RydW1lbnRhdGlvbi5mbGFnZ2VkSW5zdHJ1bWVudCkoJ2ludGVyYWN0aW9uLmVtYmVyLWFjdGlvbicsIHBheWxvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfcnVubG9vcC5qb2luLmFwcGx5KHVuZGVmaW5lZCwgW3NlbGYsIGZuXS5jb25jYXQocHJvY2Vzc0FyZ3MoYXJncykpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0KCiAgICB2YXIgaXNFbXB0eSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJzsKICAgIH07CiAgICB2YXIgbm9ybWFsaXplVGV4dFZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKGlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CiAgICB9OwogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgLyoqCiAgICAgIENvbmNhdGVuYXRlcyB0aGUgZ2l2ZW4gYXJndW1lbnRzIGludG8gYSBzdHJpbmcuCiAgICAKICAgICAgRXhhbXBsZToKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7c29tZS1jb21wb25lbnQgbmFtZT0oY29uY2F0IGZpcnN0TmFtZSAiICIgbGFzdE5hbWUpfX0KICAgIAogICAgICB7eyEgd291bGQgcGFzcyBuYW1lPSI8Zmlyc3QgbmFtZSB2YWx1ZT4gPGxhc3QgbmFtZSB2YWx1ZT4iIHRvIHRoZSBjb21wb25lbnR9fQogICAgICBgYGAKICAgIAogICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgY29uY2F0CiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHNpbmNlIDEuMTMuMAogICAgKi8KICAgIGZ1bmN0aW9uIGNvbmNhdChfcmVmMTYpIHsKICAgICAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYxNi5wb3NpdGlvbmFsOwoKICAgICAgICByZXR1cm4gcG9zaXRpb25hbC52YWx1ZSgpLm1hcChub3JtYWxpemVUZXh0VmFsdWUpLmpvaW4oJycpOwogICAgfQogICAgZnVuY3Rpb24gY29uY2F0JDEoX3ZtLCBhcmdzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBJbnRlcm5hbEhlbHBlclJlZmVyZW5jZShjb25jYXQsIGFyZ3MuY2FwdHVyZSgpKTsKICAgIH0KCiAgICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAgICovCiAgICAvKioKICAgICAgRHluYW1pY2FsbHkgbG9vayB1cCBhIHByb3BlcnR5IG9uIGFuIG9iamVjdC4gVGhlIHNlY29uZCBhcmd1bWVudCB0byBge3tnZXR9fWAKICAgICAgc2hvdWxkIGhhdmUgYSBzdHJpbmcgdmFsdWUsIGFsdGhvdWdoIGl0IGNhbiBiZSBib3VuZC4KICAgIAogICAgICBGb3IgZXhhbXBsZSwgdGhlc2UgdHdvIHVzYWdlcyBhcmUgZXF1aXZhbGVudDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7cGVyc29uLmhlaWdodH19CiAgICAgIHt7Z2V0IHBlcnNvbiAiaGVpZ2h0In19CiAgICAgIGBgYAogICAgCiAgICAgIElmIHRoZXJlIHdlcmUgc2V2ZXJhbCBmYWN0cyBhYm91dCBhIHBlcnNvbiwgdGhlIGB7e2dldH19YCBoZWxwZXIgY2FuIGR5bmFtaWNhbGx5CiAgICAgIHBpY2sgb25lOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3tnZXQgcGVyc29uIGZhY3ROYW1lfX0KICAgICAgYGBgCiAgICAKICAgICAgRm9yIGEgbW9yZSBjb21wbGV4IGV4YW1wbGUsIHRoaXMgdGVtcGxhdGUgd291bGQgYWxsb3cgdGhlIHVzZXIgdG8gc3dpdGNoCiAgICAgIGJldHdlZW4gc2hvd2luZyB0aGUgdXNlcidzIGhlaWdodCBhbmQgd2VpZ2h0IHdpdGggYSBjbGljazoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7Z2V0IHBlcnNvbiBmYWN0TmFtZX19CiAgICAgIDxidXR0b24ge3thY3Rpb24gKGFjdGlvbiAobXV0IGZhY3ROYW1lKSkgImhlaWdodCJ9fT5TaG93IGhlaWdodDwvYnV0dG9uPgogICAgICA8YnV0dG9uIHt7YWN0aW9uIChhY3Rpb24gKG11dCBmYWN0TmFtZSkpICJ3ZWlnaHQifX0+U2hvdyB3ZWlnaHQ8L2J1dHRvbj4KICAgICAgYGBgCiAgICAKICAgICAgVGhlIGB7e2dldH19YCBoZWxwZXIgY2FuIGFsc28gcmVzcGVjdCBtdXRhYmxlIHZhbHVlcyBpdHNlbGYuIEZvciBleGFtcGxlOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3tpbnB1dCB2YWx1ZT0obXV0IChnZXQgcGVyc29uIGZhY3ROYW1lKSkgdHlwZT0idGV4dCJ9fQogICAgICA8YnV0dG9uIHt7YWN0aW9uIChhY3Rpb24gKG11dCBmYWN0TmFtZSkpICJoZWlnaHQifX0+U2hvdyBoZWlnaHQ8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiB7e2FjdGlvbiAoYWN0aW9uIChtdXQgZmFjdE5hbWUpKSAid2VpZ2h0In19PlNob3cgd2VpZ2h0PC9idXR0b24+CiAgICAgIGBgYAogICAgCiAgICAgIFdvdWxkIGFsbG93IHRoZSB1c2VyIHRvIHN3YXAgd2hhdCBmYWN0IGlzIGJlaW5nIGRpc3BsYXllZCwgYW5kIGFsc28gZWRpdAogICAgICB0aGF0IGZhY3QgdmlhIGEgdHdvLXdheSBtdXRhYmxlIGJpbmRpbmcuCiAgICAKICAgICAgQHB1YmxpYwogICAgICBAbWV0aG9kIGdldAogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBzaW5jZSAyLjEuMAogICAgICovCiAgICBmdW5jdGlvbiBnZXQkMShfdm0sIGFyZ3MpIHsKICAgICAgICByZXR1cm4gR2V0SGVscGVyUmVmZXJlbmNlLmNyZWF0ZShhcmdzLnBvc2l0aW9uYWwuYXQoMCksIGFyZ3MucG9zaXRpb25hbC5hdCgxKSk7CiAgICB9CiAgICBmdW5jdGlvbiByZWZlcmVuY2VGcm9tUGF0aChzb3VyY2UsIHBhdGgpIHsKICAgICAgICB2YXIgaW5uZXJSZWZlcmVuY2UgPSB2b2lkIDA7CiAgICAgICAgaWYgKHBhdGggPT09IHVuZGVmaW5lZCB8fCBwYXRoID09PSBudWxsIHx8IHBhdGggPT09ICcnKSB7CiAgICAgICAgICAgIGlubmVyUmVmZXJlbmNlID0gX3J1bnRpbWUuTlVMTF9SRUZFUkVOQ0U7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGF0aCA9PT0gJ3N0cmluZycgJiYgcGF0aC5pbmRleE9mKCcuJykgPiAtMSkgewogICAgICAgICAgICBpbm5lclJlZmVyZW5jZSA9IHJlZmVyZW5jZUZyb21QYXJ0cyhzb3VyY2UsIHBhdGguc3BsaXQoJy4nKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5uZXJSZWZlcmVuY2UgPSBzb3VyY2UuZ2V0KHBhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5uZXJSZWZlcmVuY2U7CiAgICB9CgogICAgdmFyIEdldEhlbHBlclJlZmVyZW5jZSA9IGZ1bmN0aW9uIChfQ2FjaGVkUmVmZXJlbmNlJDYpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEdldEhlbHBlclJlZmVyZW5jZSwgX0NhY2hlZFJlZmVyZW5jZSQ2KTsKCiAgICAgICAgR2V0SGVscGVyUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzb3VyY2VSZWZlcmVuY2UsIHBhdGhSZWZlcmVuY2UpIHsKICAgICAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKHBhdGhSZWZlcmVuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHBhdGhSZWZlcmVuY2UudmFsdWUoKTsKICAgICAgICAgICAgICAgIHJldHVybiByZWZlcmVuY2VGcm9tUGF0aChzb3VyY2VSZWZlcmVuY2UsIHBhdGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBHZXRIZWxwZXJSZWZlcmVuY2Uoc291cmNlUmVmZXJlbmNlLCBwYXRoUmVmZXJlbmNlKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIEdldEhlbHBlclJlZmVyZW5jZShzb3VyY2VSZWZlcmVuY2UsIHBhdGhSZWZlcmVuY2UpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBHZXRIZWxwZXJSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdmFyIF90aGlzMzQgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NhY2hlZFJlZmVyZW5jZSQ2LmNhbGwodGhpcykpOwoKICAgICAgICAgICAgX3RoaXMzNC5zb3VyY2VSZWZlcmVuY2UgPSBzb3VyY2VSZWZlcmVuY2U7CiAgICAgICAgICAgIF90aGlzMzQucGF0aFJlZmVyZW5jZSA9IHBhdGhSZWZlcmVuY2U7CiAgICAgICAgICAgIF90aGlzMzQubGFzdFBhdGggPSBudWxsOwogICAgICAgICAgICBfdGhpczM0LmlubmVyUmVmZXJlbmNlID0gX3J1bnRpbWUuTlVMTF9SRUZFUkVOQ0U7CiAgICAgICAgICAgIHZhciBpbm5lclRhZyA9IF90aGlzMzQuaW5uZXJUYWcgPSBfcmVmZXJlbmNlLlVwZGF0YWJsZVRhZy5jcmVhdGUoX3JlZmVyZW5jZS5DT05TVEFOVF9UQUcpOwogICAgICAgICAgICBfdGhpczM0LnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFtzb3VyY2VSZWZlcmVuY2UudGFnLCBwYXRoUmVmZXJlbmNlLnRhZywgaW5uZXJUYWddKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMzQ7CiAgICAgICAgfQoKICAgICAgICBHZXRIZWxwZXJSZWZlcmVuY2UucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICAgICAgICB2YXIgbGFzdFBhdGggPSB0aGlzLmxhc3RQYXRoLAogICAgICAgICAgICAgICAgaW5uZXJSZWZlcmVuY2UgPSB0aGlzLmlubmVyUmVmZXJlbmNlLAogICAgICAgICAgICAgICAgaW5uZXJUYWcgPSB0aGlzLmlubmVyVGFnOwoKICAgICAgICAgICAgdmFyIHBhdGggPSB0aGlzLnBhdGhSZWZlcmVuY2UudmFsdWUoKTsKICAgICAgICAgICAgaWYgKHBhdGggIT09IGxhc3RQYXRoKSB7CiAgICAgICAgICAgICAgICBpbm5lclJlZmVyZW5jZSA9IHJlZmVyZW5jZUZyb21QYXRoKHRoaXMuc291cmNlUmVmZXJlbmNlLCBwYXRoKTsKICAgICAgICAgICAgICAgIGlubmVyVGFnLmlubmVyLnVwZGF0ZShpbm5lclJlZmVyZW5jZS50YWcpOwogICAgICAgICAgICAgICAgdGhpcy5pbm5lclJlZmVyZW5jZSA9IGlubmVyUmVmZXJlbmNlOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0UGF0aCA9IHBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlubmVyUmVmZXJlbmNlLnZhbHVlKCk7CiAgICAgICAgfTsKCiAgICAgICAgR2V0SGVscGVyUmVmZXJlbmNlLnByb3RvdHlwZVtVUERBVEVdID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMuc291cmNlUmVmZXJlbmNlLnZhbHVlKCksIHRoaXMucGF0aFJlZmVyZW5jZS52YWx1ZSgpLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEdldEhlbHBlclJlZmVyZW5jZTsKICAgIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwoKICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICAgVXNlIHRoZSBge3toYXNofX1gIGhlbHBlciB0byBjcmVhdGUgYSBoYXNoIHRvIHBhc3MgYXMgYW4gb3B0aW9uIHRvIHlvdXIKICAgICAgIGNvbXBvbmVudHMuIFRoaXMgaXMgc3BlY2lhbGx5IHVzZWZ1bCBmb3IgY29udGV4dHVhbCBjb21wb25lbnRzIHdoZXJlIHlvdSBjYW4KICAgICAgIGp1c3QgeWllbGQgYSBoYXNoOgogICAgCiAgICAgICBgYGBoYW5kbGViYXJzCiAgICAgICB7e3lpZWxkIChoYXNoCiAgICAgICAgICBuYW1lPSdTYXJhaCcKICAgICAgICAgIHRpdGxlPW9mZmljZQogICAgICAgKX19CiAgICAgICBgYGAKICAgIAogICAgICAgV291bGQgcmVzdWx0IGluIGFuIG9iamVjdCBzdWNoIGFzOgogICAgCiAgICAgICBgYGBqcwogICAgICAgeyBuYW1lOiAnU2FyYWgnLCB0aXRsZTogdGhpcy5nZXQoJ29mZmljZScpIH0KICAgICAgIGBgYAogICAgCiAgICAgICBXaGVyZSB0aGUgYHRpdGxlYCBpcyBib3VuZCB0byB1cGRhdGVzIG9mIHRoZSBgb2ZmaWNlYCBwcm9wZXJ0eS4KICAgIAogICAgICAgTm90ZSB0aGF0IHRoZSBoYXNoIGlzIGFuIGVtcHR5IG9iamVjdCB3aXRoIG5vIHByb3RvdHlwZSBjaGFpbiwgdGhlcmVmb3JlCiAgICAgICBjb21tb24gbWV0aG9kcyBsaWtlIGB0b1N0cmluZ2AgYXJlIG5vdCBhdmFpbGFibGUgaW4gdGhlIHJlc3VsdGluZyBoYXNoLgogICAgICAgSWYgeW91IG5lZWQgdG8gdXNlIHN1Y2ggYSBtZXRob2QsIHlvdSBjYW4gdXNlIHRoZSBgY2FsbGAgb3IgYGFwcGx5YAogICAgICAgYXBwcm9hY2g6CiAgICAKICAgICAgIGBgYGpzCiAgICAgICBmdW5jdGlvbiB0b1N0cmluZyhvYmopIHsKICAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkob2JqKTsKICAgICAgIH0KICAgICAgIGBgYAogICAgCiAgICAgICBAbWV0aG9kIGhhc2gKICAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgICBAcmV0dXJuIHtPYmplY3R9IEhhc2gKICAgICAgIEBzaW5jZSAyLjMuMAogICAgICAgQHB1YmxpYwogICAgICovCiAgICBmdW5jdGlvbiBoYXNoKF92bSwgYXJncykgewogICAgICAgIHJldHVybiBhcmdzLm5hbWVkLmNhcHR1cmUoKTsKICAgIH0KCiAgICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAgICovCgogICAgdmFyIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlID0gZnVuY3Rpb24gKF9DYWNoZWRSZWZlcmVuY2UkNykgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQ29uZGl0aW9uYWxIZWxwZXJSZWZlcmVuY2UsIF9DYWNoZWRSZWZlcmVuY2UkNyk7CgogICAgICAgIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShfY29uZFJlZiwgdHJ1dGh5UmVmLCBmYWxzeVJlZikgewogICAgICAgICAgICB2YXIgY29uZFJlZiA9IENvbmRpdGlvbmFsUmVmZXJlbmNlJDEuY3JlYXRlKF9jb25kUmVmKTsKICAgICAgICAgICAgaWYgKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKGNvbmRSZWYpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29uZFJlZi52YWx1ZSgpID8gdHJ1dGh5UmVmIDogZmFsc3lSZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlKGNvbmRSZWYsIHRydXRoeVJlZiwgZmFsc3lSZWYpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gQ29uZGl0aW9uYWxIZWxwZXJSZWZlcmVuY2UoY29uZCwgdHJ1dGh5LCBmYWxzeSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHZhciBfdGhpczM1ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9DYWNoZWRSZWZlcmVuY2UkNy5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzMzUuYnJhbmNoVGFnID0gX3JlZmVyZW5jZS5VcGRhdGFibGVUYWcuY3JlYXRlKF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHKTsKICAgICAgICAgICAgX3RoaXMzNS50YWcgPSAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKShbY29uZC50YWcsIF90aGlzMzUuYnJhbmNoVGFnXSk7CiAgICAgICAgICAgIF90aGlzMzUuY29uZCA9IGNvbmQ7CiAgICAgICAgICAgIF90aGlzMzUudHJ1dGh5ID0gdHJ1dGh5OwogICAgICAgICAgICBfdGhpczM1LmZhbHN5ID0gZmFsc3k7CiAgICAgICAgICAgIHJldHVybiBfdGhpczM1OwogICAgICAgIH0KCiAgICAgICAgQ29uZGl0aW9uYWxIZWxwZXJSZWZlcmVuY2UucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiBjb21wdXRlKCkgewogICAgICAgICAgICB2YXIgYnJhbmNoID0gdGhpcy5jb25kLnZhbHVlKCkgPyB0aGlzLnRydXRoeSA6IHRoaXMuZmFsc3k7CiAgICAgICAgICAgIHRoaXMuYnJhbmNoVGFnLmlubmVyLnVwZGF0ZShicmFuY2gudGFnKTsKICAgICAgICAgICAgcmV0dXJuIGJyYW5jaC52YWx1ZSgpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBDb25kaXRpb25hbEhlbHBlclJlZmVyZW5jZTsKICAgIH0oQ2FjaGVkUmVmZXJlbmNlJDEpOwoKICAgIC8qKgogICAgICBUaGUgYGlmYCBoZWxwZXIgYWxsb3dzIHlvdSB0byBjb25kaXRpb25hbGx5IHJlbmRlciBvbmUgb2YgdHdvIGJyYW5jaGVzLAogICAgICBkZXBlbmRpbmcgb24gdGhlICJ0cnV0aGluZXNzIiBvZiBhIHByb3BlcnR5LgogICAgICBGb3IgZXhhbXBsZSB0aGUgZm9sbG93aW5nIHZhbHVlcyBhcmUgYWxsIGZhbHNleTogYGZhbHNlYCwgYHVuZGVmaW5lZGAsIGBudWxsYCwgYCIiYCwgYDBgLCBgTmFOYCBvciBhbiBlbXB0eSBhcnJheS4KICAgIAogICAgICBUaGlzIGhlbHBlciBoYXMgdHdvIGZvcm1zLCBibG9jayBhbmQgaW5saW5lLgogICAgCiAgICAgICMjIEJsb2NrIGZvcm0KICAgIAogICAgICBZb3UgY2FuIHVzZSB0aGUgYmxvY2sgZm9ybSBvZiBgaWZgIHRvIGNvbmRpdGlvbmFsbHkgcmVuZGVyIGEgc2VjdGlvbiBvZiB0aGUgdGVtcGxhdGUuCiAgICAKICAgICAgVG8gdXNlIGl0LCBwYXNzIHRoZSBjb25kaXRpb25hbCB2YWx1ZSB0byB0aGUgYGlmYCBoZWxwZXIsCiAgICAgIHVzaW5nIHRoZSBibG9jayBmb3JtIHRvIHdyYXAgdGhlIHNlY3Rpb24gb2YgdGVtcGxhdGUgeW91IHdhbnQgdG8gY29uZGl0aW9uYWxseSByZW5kZXIuCiAgICAgIExpa2Ugc286CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgd2lsbCBub3QgcmVuZGVyIGlmIGZvbyBpcyBmYWxzZXl9fQogICAgICB7eyNpZiBmb299fQogICAgICAgIFdlbGNvbWUgdG8gdGhlIHt7Zm9vLmJhcn19CiAgICAgIHt7L2lmfX0KICAgICAgYGBgCiAgICAKICAgICAgWW91IGNhbiBhbHNvIHNwZWNpZnkgYSB0ZW1wbGF0ZSB0byBzaG93IGlmIHRoZSBwcm9wZXJ0eSBpcyBmYWxzZXkgYnkgdXNpbmcKICAgICAgdGhlIGBlbHNlYCBoZWxwZXIuCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgaXMgaXQgcmFpbmluZyBvdXRzaWRlP319CiAgICAgIHt7I2lmIGlzUmFpbmluZ319CiAgICAgICAgWWVzLCBncmFiIGFuIHVtYnJlbGxhIQogICAgICB7e2Vsc2V9fQogICAgICAgIE5vLCBpdCdzIGxvdmVseSBvdXRzaWRlIQogICAgICB7ey9pZn19CiAgICAgIGBgYAogICAgCiAgICAgIFlvdSBhcmUgYWxzbyBhYmxlIHRvIGNvbWJpbmUgYGVsc2VgIGFuZCBgaWZgIGhlbHBlcnMgdG8gY3JlYXRlIG1vcmUgY29tcGxleAogICAgICBjb25kaXRpb25hbCBsb2dpYy4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7I2lmIGlzTW9ybmluZ319CiAgICAgICAgR29vZCBtb3JuaW5nCiAgICAgIHt7ZWxzZSBpZiBpc0FmdGVybm9vbn19CiAgICAgICAgR29vZCBhZnRlcm5vb24KICAgICAge3tlbHNlfX0KICAgICAgICBHb29kIG5pZ2h0CiAgICAgIHt7L2lmfX0KICAgICAgYGBgCiAgICAKICAgICAgIyMgSW5saW5lIGZvcm0KICAgIAogICAgICBUaGUgaW5saW5lIGBpZmAgaGVscGVyIGNvbmRpdGlvbmFsbHkgcmVuZGVycyBhIHNpbmdsZSBwcm9wZXJ0eSBvciBzdHJpbmcuCiAgICAKICAgICAgSW4gdGhpcyBmb3JtLCB0aGUgYGlmYCBoZWxwZXIgcmVjZWl2ZXMgdGhyZWUgYXJndW1lbnRzLCB0aGUgY29uZGl0aW9uYWwgdmFsdWUsCiAgICAgIHRoZSB2YWx1ZSB0byByZW5kZXIgd2hlbiB0cnV0aHksIGFuZCB0aGUgdmFsdWUgdG8gcmVuZGVyIHdoZW4gZmFsc2V5LgogICAgCiAgICAgIEZvciBleGFtcGxlLCBpZiBgdXNlTG9uZ0dyZWV0aW5nYCBpcyB0cnV0aHksIHRoZSBmb2xsb3dpbmc6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e2lmIHVzZUxvbmdHcmVldGluZyAiSGVsbG8iICJIaSJ9fSBBbGV4CiAgICAgIGBgYAogICAgCiAgICAgIFdpbGwgcmVuZGVyOgogICAgCiAgICAgIGBgYGh0bWwKICAgICAgSGVsbG8gQWxleAogICAgICBgYGAKICAgIAogICAgICAjIyMgTmVzdGVkIGBpZmAKICAgIAogICAgICBZb3UgY2FuIHVzZSB0aGUgYGlmYCBoZWxwZXIgaW5zaWRlIGFub3RoZXIgaGVscGVyIGFzIGEgbmVzdGVkIGhlbHBlcjoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7c29tZS1jb21wb25lbnQgaGVpZ2h0PShpZiBpc0JpZyAiMTAwIiAiMTAiKX19CiAgICAgIGBgYAogICAgCiAgICAgIE9uZSBkZXRhaWwgdG8ga2VlcCBpbiBtaW5kIGlzIHRoYXQgYm90aCBicmFuY2hlcyBvZiB0aGUgYGlmYCBoZWxwZXIgd2lsbCBiZSBldmFsdWF0ZWQsCiAgICAgIHNvIGlmIHlvdSBoYXZlIGB7e2lmIGNvbmRpdGlvbiAiZm9vIiAoZXhwZW5zaXZlLW9wZXJhdGlvbiAiYmFyIilgLAogICAgICBgZXhwZW5zaXZlLW9wZXJhdGlvbmAgd2lsbCBhbHdheXMgY2FsY3VsYXRlLgogICAgCiAgICAgIEBtZXRob2QgaWYKICAgICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gaW5saW5lSWYoX3ZtLCBfcmVmMTcpIHsKICAgICAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYxNy5wb3NpdGlvbmFsOwogICAgICAgICh0cnVlICYmICEocG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGlubGluZSBmb3JtIG9mIHRoZSBgaWZgIGhlbHBlciBleHBlY3RzIHR3byBvciB0aHJlZSBhcmd1bWVudHMsIGUuZy4gJyArICdge3tpZiB0cmlhbEV4cGlyZWQgIkV4cGlyZWQiIGV4cGlyeURhdGV9fWAuJywgcG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpKTsKCiAgICAgICAgcmV0dXJuIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLmNyZWF0ZShwb3NpdGlvbmFsLmF0KDApLCBwb3NpdGlvbmFsLmF0KDEpLCBwb3NpdGlvbmFsLmF0KDIpKTsKICAgIH0KICAgIC8qKgogICAgICBUaGUgaW5saW5lIGB1bmxlc3NgIGhlbHBlciBjb25kaXRpb25hbGx5IHJlbmRlcnMgYSBzaW5nbGUgcHJvcGVydHkgb3Igc3RyaW5nLgogICAgICBUaGlzIGhlbHBlciBhY3RzIGxpa2UgYSB0ZXJuYXJ5IG9wZXJhdG9yLiBJZiB0aGUgZmlyc3QgcHJvcGVydHkgaXMgZmFsc3ksCiAgICAgIHRoZSBzZWNvbmQgYXJndW1lbnQgd2lsbCBiZSBkaXNwbGF5ZWQsIG90aGVyd2lzZSwgdGhlIHRoaXJkIGFyZ3VtZW50IHdpbGwgYmUKICAgICAgZGlzcGxheWVkCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e3VubGVzcyB1c2VMb25nR3JlZXRpbmcgIkhpIiAiSGVsbG8ifX0gQmVuCiAgICAgIGBgYAogICAgCiAgICAgIFlvdSBjYW4gdXNlIHRoZSBgdW5sZXNzYCBoZWxwZXIgaW5zaWRlIGFub3RoZXIgaGVscGVyIGFzIGEgc3ViZXhwcmVzc2lvbi4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7c29tZS1jb21wb25lbnQgaGVpZ2h0PSh1bmxlc3MgaXNCaWcgIjEwIiAiMTAwIil9fQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIHVubGVzcwogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBpbmxpbmVVbmxlc3MoX3ZtLCBfcmVmMTgpIHsKICAgICAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYxOC5wb3NpdGlvbmFsOwogICAgICAgICh0cnVlICYmICEocG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGlubGluZSBmb3JtIG9mIHRoZSBgdW5sZXNzYCBoZWxwZXIgZXhwZWN0cyB0d28gb3IgdGhyZWUgYXJndW1lbnRzLCBlLmcuICcgKyAnYHt7dW5sZXNzIGlzRmlyc3RMb2dpbiAiV2VsY29tZSBiYWNrISJ9fWAuJywgcG9zaXRpb25hbC5sZW5ndGggPT09IDMgfHwgcG9zaXRpb25hbC5sZW5ndGggPT09IDIpKTsKCiAgICAgICAgcmV0dXJuIENvbmRpdGlvbmFsSGVscGVyUmVmZXJlbmNlLmNyZWF0ZShwb3NpdGlvbmFsLmF0KDApLCBwb3NpdGlvbmFsLmF0KDIpLCBwb3NpdGlvbmFsLmF0KDEpKTsKICAgIH0KCiAgICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAgICovCiAgICAvKioKICAgICAgYGxvZ2AgYWxsb3dzIHlvdSB0byBvdXRwdXQgdGhlIHZhbHVlIG9mIHZhcmlhYmxlcyBpbiB0aGUgY3VycmVudCByZW5kZXJpbmcKICAgICAgY29udGV4dC4gYGxvZ2AgYWxzbyBhY2NlcHRzIHByaW1pdGl2ZSB0eXBlcyBzdWNoIGFzIHN0cmluZ3Mgb3IgbnVtYmVycy4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7bG9nICJteVZhcmlhYmxlOiIgbXlWYXJpYWJsZSB9fQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGxvZwogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwYXJhbSB7QXJyYXl9IHBhcmFtcwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gbG9nKF9yZWYxOSkgewogICAgICAgIHZhciBfY29uc29sZTsKCiAgICAgICAgdmFyIHBvc2l0aW9uYWwgPSBfcmVmMTkucG9zaXRpb25hbDsKCiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqLwogICAgICAgIChfY29uc29sZSA9IGNvbnNvbGUpLmxvZy5hcHBseShfY29uc29sZSwgcG9zaXRpb25hbC52YWx1ZSgpKTsKICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbnNvbGUgKi8KICAgIH0KICAgIGZ1bmN0aW9uIGxvZyQxKF92bSwgYXJncykgewogICAgICAgIHJldHVybiBuZXcgSW50ZXJuYWxIZWxwZXJSZWZlcmVuY2UobG9nLCBhcmdzLmNhcHR1cmUoKSk7CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgLyoqCiAgICAgIFRoZSBgbXV0YCBoZWxwZXIgbGV0cyB5b3UgX19jbGVhcmx5IHNwZWNpZnlfXyB0aGF0IGEgY2hpbGQgYENvbXBvbmVudGAgY2FuIHVwZGF0ZSB0aGUKICAgICAgKG11dGFibGUpIHZhbHVlIHBhc3NlZCB0byBpdCwgd2hpY2ggd2lsbCBfX2NoYW5nZSB0aGUgdmFsdWUgb2YgdGhlIHBhcmVudCBjb21wb25lbnRfXy4KICAgIAogICAgICBUbyBzcGVjaWZ5IHRoYXQgYSBwYXJhbWV0ZXIgaXMgbXV0YWJsZSwgd2hlbiBpbnZva2luZyB0aGUgY2hpbGQgYENvbXBvbmVudGA6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e215LWNoaWxkIGNoaWxkQ2xpY2tDb3VudD0obXV0IHRvdGFsQ2xpY2tzKX19CiAgICAgIGBgYAogICAgCiAgICAgIFRoZSBjaGlsZCBgQ29tcG9uZW50YCBjYW4gdGhlbiBtb2RpZnkgdGhlIHBhcmVudCdzIHZhbHVlIGp1c3QgYnkgbW9kaWZ5aW5nIGl0cyBvd24KICAgICAgcHJvcGVydHk6CiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBteS1jaGlsZC5qcwogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGljaygpIHsKICAgICAgICAgIHRoaXMuaW5jcmVtZW50UHJvcGVydHkoJ2NoaWxkQ2xpY2tDb3VudCcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIE5vdGUgdGhhdCBmb3IgY3VybHkgY29tcG9uZW50cyAoYHt7bXktY29tcG9uZW50fX1gKSB0aGUgYmluZGluZ3MgYXJlIGFscmVhZHkgbXV0YWJsZSwKICAgICAgbWFraW5nIHRoZSBgbXV0YCB1bm5lY2Vzc2FyeS4KICAgIAogICAgICBBZGRpdGlvbmFsbHksIHRoZSBgbXV0YCBoZWxwZXIgY2FuIGJlIGNvbWJpbmVkIHdpdGggdGhlIGBhY3Rpb25gIGhlbHBlciB0bwogICAgICBtdXRhdGUgYSB2YWx1ZS4gRm9yIGV4YW1wbGU6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e215LWNoaWxkIGNoaWxkQ2xpY2tDb3VudD10b3RhbENsaWNrcyBjbGljay1jb3VudC1jaGFuZ2U9KGFjdGlvbiAobXV0IHRvdGFsQ2xpY2tzKSl9fQogICAgICBgYGAKICAgIAogICAgICBUaGUgY2hpbGQgYENvbXBvbmVudGAgd291bGQgaW52b2tlIHRoZSBhY3Rpb24gd2l0aCB0aGUgbmV3IGNsaWNrIHZhbHVlOgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gbXktY2hpbGQuanMKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xpY2soKSB7CiAgICAgICAgICB0aGlzLmdldCgnY2xpY2stY291bnQtY2hhbmdlJykodGhpcy5nZXQoJ2NoaWxkQ2xpY2tDb3VudCcpICsgMSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgVGhlIGBtdXRgIGhlbHBlciBjaGFuZ2VzIHRoZSBgdG90YWxDbGlja3NgIHZhbHVlIHRvIHdoYXQgd2FzIHByb3ZpZGVkIGFzIHRoZSBhY3Rpb24gYXJndW1lbnQuCiAgICAKICAgICAgVGhlIGBtdXRgIGhlbHBlciwgd2hlbiB1c2VkIHdpdGggYGFjdGlvbmAsIHdpbGwgcmV0dXJuIGEgZnVuY3Rpb24gdGhhdAogICAgICBzZXRzIHRoZSB2YWx1ZSBwYXNzZWQgdG8gYG11dGAgdG8gaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIHdvcmtzIGxpa2UgYW55IG90aGVyCiAgICAgIGNsb3N1cmUgYWN0aW9uIGFuZCBpbnRlcmFjdHMgd2l0aCB0aGUgb3RoZXIgZmVhdHVyZXMgYGFjdGlvbmAgcHJvdmlkZXMuCiAgICAgIEFzIGFuIGV4YW1wbGUsIHdlIGNhbiBjcmVhdGUgYSBidXR0b24gdGhhdCBpbmNyZW1lbnRzIGEgdmFsdWUgcGFzc2luZyB0aGUgdmFsdWUKICAgICAgZGlyZWN0bHkgdG8gdGhlIGBhY3Rpb25gOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3shIGluYyBoZWxwZXIgaXMgbm90IHByb3ZpZGVkIGJ5IEVtYmVyIH19CiAgICAgIDxidXR0b24gb25jbGljaz17e2FjdGlvbiAobXV0IGNvdW50KSAoaW5jIGNvdW50KX19PgogICAgICAgIEluY3JlbWVudCBjb3VudAogICAgICA8L2J1dHRvbj4KICAgICAgYGBgCiAgICAKICAgICAgWW91IGNhbiBhbHNvIHVzZSB0aGUgYHZhbHVlYCBvcHRpb246CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICA8aW5wdXQgdmFsdWU9e3tuYW1lfX0gb25pbnB1dD17e2FjdGlvbiAobXV0IG5hbWUpIHZhbHVlPSJ0YXJnZXQudmFsdWUifX0+CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgbXV0CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbYXR0cl0gdGhlICJ0d28td2F5IiBhdHRyaWJ1dGUgdGhhdCBjYW4gYmUgbW9kaWZpZWQuCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHZhciBNVVRfUkVGRVJFTkNFID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ01VVCcpOwogICAgdmFyIFNPVVJDRSA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdTT1VSQ0UnKTsKICAgIGZ1bmN0aW9uIGlzTXV0KHJlZikgewogICAgICAgIHJldHVybiByZWYgJiYgcmVmW01VVF9SRUZFUkVOQ0VdOwogICAgfQogICAgZnVuY3Rpb24gdW5NdXQocmVmKSB7CiAgICAgICAgcmV0dXJuIHJlZltTT1VSQ0VdIHx8IHJlZjsKICAgIH0KICAgIGZ1bmN0aW9uIG11dChfdm0sIGFyZ3MpIHsKICAgICAgICB2YXIgcmF3UmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgICAgIGlmIChpc011dChyYXdSZWYpKSB7CiAgICAgICAgICAgIHJldHVybiByYXdSZWY7CiAgICAgICAgfQogICAgICAgIC8vIFRPRE86IEltcHJvdmUgdGhpcyBlcnJvciBtZXNzYWdlLiBUaGlzIGNvdmVycyBhdCBsZWFzdCB0d28gZGlzdGluY3QKICAgICAgICAvLyBjYXNlczoKICAgICAgICAvLwogICAgICAgIC8vIDEuIChtdXQgIm5vdCBhIHBhdGgiKSDigJMgcGFzc2luZyBhIGxpdGVyYWwsIHJlc3VsdCBmcm9tIGEgaGVscGVyCiAgICAgICAgLy8gICAgaW52b2NhdGlvbiwgZXRjCiAgICAgICAgLy8KICAgICAgICAvLyAyLiAobXV0IHJlY2VpdmVkVmFsdWUpIOKAkyBwYXNzaW5nIGEgdmFsdWUgcmVjZWl2ZWQgZnJvbSB0aGUgY2FsbGVyCiAgICAgICAgLy8gICAgdGhhdCB3YXMgb3JpZ2luYWxseSBkZXJpdmVkIGZyb20gYSBsaXRlcmFsLCByZXN1bHQgZnJvbSBhIGhlbHBlcgogICAgICAgIC8vICAgIGludm9jYXRpb24sIGV0YwogICAgICAgIC8vCiAgICAgICAgLy8gVGhpcyBtZXNzYWdlIGlzIGFscmlnaHQgZm9yIHRoZSBmaXJzdCBjYXNlLCBidXQgY291bGQgYmUgcXVpdGUKICAgICAgICAvLyBjb25mdXNpbmcgZm9yIHRoZSBzZWNvbmQgY2FzZS4KICAgICAgICAodHJ1ZSAmJiAhKHJhd1JlZltVUERBVEVdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW4gb25seSBwYXNzIGEgcGF0aCB0byBtdXQnLCByYXdSZWZbVVBEQVRFXSkpOwoKICAgICAgICB2YXIgd3JhcHBlZFJlZiA9IE9iamVjdC5jcmVhdGUocmF3UmVmKTsKICAgICAgICB3cmFwcGVkUmVmW1NPVVJDRV0gPSByYXdSZWY7CiAgICAgICAgd3JhcHBlZFJlZltJTlZPS0VdID0gcmF3UmVmW1VQREFURV07CiAgICAgICAgd3JhcHBlZFJlZltNVVRfUkVGRVJFTkNFXSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHdyYXBwZWRSZWY7CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgLyoqCiAgICAgIFRoaXMgaXMgYSBoZWxwZXIgdG8gYmUgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBsaW5rLXRvIGhlbHBlci4KICAgICAgSXQgd2lsbCBzdXBwbHkgdXJsIHF1ZXJ5IHBhcmFtZXRlcnMgdG8gdGhlIHRhcmdldCByb3V0ZS4KICAgIAogICAgICBFeGFtcGxlCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyNsaW5rLXRvICdwb3N0cycgKHF1ZXJ5LXBhcmFtcyBkaXJlY3Rpb249ImFzYyIpfX1Tb3J0e3svbGluay10b319CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgcXVlcnktcGFyYW1zCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQHBhcmFtIHtPYmplY3R9IGhhc2ggdGFrZXMgYSBoYXNoIG9mIHF1ZXJ5IHBhcmFtZXRlcnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBBIGBRdWVyeVBhcmFtc2Agb2JqZWN0IGZvciBge3tsaW5rLXRvfX1gCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBxdWVyeVBhcmFtcyhfcmVmMjApIHsKICAgICAgICB2YXIgcG9zaXRpb25hbCA9IF9yZWYyMC5wb3NpdGlvbmFsLAogICAgICAgICAgICBuYW1lZCA9IF9yZWYyMC5uYW1lZDsKICAgICAgICAodHJ1ZSAmJiAhKHBvc2l0aW9uYWwudmFsdWUoKS5sZW5ndGggPT09IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiVGhlIGBxdWVyeS1wYXJhbXNgIGhlbHBlciBvbmx5IGFjY2VwdHMgaGFzaCBwYXJhbWV0ZXJzLCBlLmcuIChxdWVyeS1wYXJhbXMgcXVlcnlQYXJhbVByb3BlcnR5TmFtZT0nZm9vJykgYXMgb3Bwb3NlZCB0byBqdXN0IChxdWVyeS1wYXJhbXMgJ2ZvbycpIiwgcG9zaXRpb25hbC52YWx1ZSgpLmxlbmd0aCA9PT0gMCkpOwoKICAgICAgICByZXR1cm4gbmV3IF9lbWJlclJvdXRpbmcuUXVlcnlQYXJhbXMoKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgbmFtZWQudmFsdWUoKSkpOwogICAgfQogICAgZnVuY3Rpb24gcXVlcnlQYXJhbXMkMShfdm0sIGFyZ3MpIHsKICAgICAgICByZXR1cm4gbmV3IEludGVybmFsSGVscGVyUmVmZXJlbmNlKHF1ZXJ5UGFyYW1zLCBhcmdzLmNhcHR1cmUoKSk7CiAgICB9CgogICAgLyoqCiAgICAgIFRoZSBgcmVhZG9ubHlgIGhlbHBlciBsZXQncyB5b3Ugc3BlY2lmeSB0aGF0IGEgYmluZGluZyBpcyBvbmUtd2F5IG9ubHksCiAgICAgIGluc3RlYWQgb2YgdHdvLXdheS4KICAgICAgV2hlbiB5b3UgcGFzcyBhIGByZWFkb25seWAgYmluZGluZyBmcm9tIGFuIG91dGVyIGNvbnRleHQgKGUuZy4gcGFyZW50IGNvbXBvbmVudCksCiAgICAgIHRvIHRvIGFuIGlubmVyIGNvbnRleHQgKGUuZy4gY2hpbGQgY29tcG9uZW50KSwgeW91IGFyZSBzYXlpbmcgdGhhdCBjaGFuZ2luZyB0aGF0CiAgICAgIHByb3BlcnR5IGluIHRoZSBpbm5lciBjb250ZXh0IGRvZXMgbm90IGNoYW5nZSB0aGUgdmFsdWUgaW4gdGhlIG91dGVyIGNvbnRleHQuCiAgICAKICAgICAgVG8gc3BlY2lmeSB0aGF0IGEgYmluZGluZyBpcyByZWFkLW9ubHksIHdoZW4gaW52b2tpbmcgdGhlIGNoaWxkIGBDb21wb25lbnRgOgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LXBhcmVudC5qcwogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICB0b3RhbENsaWNrczogMwogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgICAge3tsb2cgdG90YWxDbGlja3N9fSAvLyAtPiAzCiAgICAgIHt7bXktY2hpbGQgY2hpbGRDbGlja0NvdW50PShyZWFkb25seSB0b3RhbENsaWNrcyl9fQogICAgICBgYGAKICAgIAogICAgICBOb3csIHdoZW4geW91IHVwZGF0ZSBgY2hpbGRDbGlja0NvdW50YDoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jaGlsZC5qcwogICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGljaygpIHsKICAgICAgICAgIHRoaXMuaW5jcmVtZW50UHJvcGVydHkoJ2NoaWxkQ2xpY2tDb3VudCcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFRoZSB2YWx1ZSB1cGRhdGVzIGluIHRoZSBjaGlsZCBjb21wb25lbnQsIGJ1dCBub3QgdGhlIHBhcmVudCBjb21wb25lbnQ6CiAgICAKICAgICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LWNoaWxkLmhicwogICAgICB7e2xvZyBjaGlsZENsaWNrQ291bnR9fSAvLy0+IDQKICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgICAge3tsb2cgdG90YWxDbGlja3N9fSAvLy0+IDMKICAgICAge3tteS1jaGlsZCBjaGlsZENsaWNrQ291bnQ9KHJlYWRvbmx5IHRvdGFsQ2xpY2tzKX19CiAgICAgIGBgYAogICAgCiAgICAgICMjIyBPYmplY3RzIGFuZCBBcnJheXMKICAgIAogICAgICBXaGVuIHBhc3NpbmcgYSBwcm9wZXJ0eSB0aGF0IGlzIGEgY29tcGxleCBvYmplY3QgKGUuZy4gb2JqZWN0LCBhcnJheSkgaW5zdGVhZCBvZiBhIHByaW1pdGl2ZSBvYmplY3QgKGUuZy4gbnVtYmVyLCBzdHJpbmcpLAogICAgICBvbmx5IHRoZSByZWZlcmVuY2UgdG8gdGhlIG9iamVjdCBpcyBwcm90ZWN0ZWQgdXNpbmcgdGhlIHJlYWRvbmx5IGhlbHBlci4KICAgICAgVGhpcyBtZWFucyB0aGF0IHlvdSBjYW4gY2hhbmdlIHByb3BlcnRpZXMgb2YgdGhlIG9iamVjdCBib3RoIG9uIHRoZSBwYXJlbnQgY29tcG9uZW50LCBhcyB3ZWxsIGFzIHRoZSBjaGlsZCBjb21wb25lbnQuCiAgICAgIFRoZSBgcmVhZG9ubHlgIGJpbmRpbmcgYmVoYXZlcyBzaW1pbGFyIHRvIHRoZSBgY29uc3RgIGtleXdvcmQgaW4gSmF2YVNjcmlwdC4KICAgIAogICAgICBMZXQncyBsb29rIGF0IGFuIGV4YW1wbGU6CiAgICAKICAgICAgRmlyc3QgbGV0J3Mgc2V0IHVwIHRoZSBwYXJlbnQgY29tcG9uZW50OgogICAgCiAgICAgIGBgYGFwcC9jb21wb25lbnRzL215LXBhcmVudC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsaWNrczogbnVsbCwKICAgIAogICAgICAgIGluaXQoKSB7CiAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICAgdGhpcy5zZXQoJ2NsaWNrcycsIHsgdG90YWw6IDMgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL3RlbXBsYXRlcy9jb21wb25lbnRzL215LXBhcmVudC5oYnMKICAgICAge3tsb2cgY2xpY2tzLnRvdGFsfX0gLy8tPiAzCiAgICAgIHt7bXktY2hpbGQgY2hpbGRDbGlja3M9KHJlYWRvbmx5IGNsaWNrcyl9fQogICAgICBgYGAKICAgIAogICAgICBOb3csIGlmIHlvdSB1cGRhdGUgdGhlIGB0b3RhbGAgcHJvcGVydHkgb2YgYGNoaWxkQ2xpY2tzYDoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jaGlsZC5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsaWNrKCkgewogICAgICAgICAgdGhpcy5nZXQoJ2NsaWNrcycpLmluY3JlbWVudFByb3BlcnR5KCd0b3RhbCcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFlvdSB3aWxsIHNlZSB0aGUgZm9sbG93aW5nIGhhcHBlbjoKICAgIAogICAgICBgYGBhcHAvdGVtcGxhdGVzL2NvbXBvbmVudHMvbXktcGFyZW50LmhicwogICAgICB7e2xvZyBjbGlja3MudG90YWx9fSAvLy0+IDQKICAgICAge3tteS1jaGlsZCBjaGlsZENsaWNrcz0ocmVhZG9ubHkgY2xpY2tzKX19CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGFwcC90ZW1wbGF0ZXMvY29tcG9uZW50cy9teS1jaGlsZC5oYnMKICAgICAge3tsb2cgY2hpbGRDbGlja3MudG90YWx9fSAvLy0+IDQKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCByZWFkb25seQogICAgICBAcGFyYW0ge09iamVjdH0gW2F0dHJdIHRoZSByZWFkLW9ubHkgYXR0cmlidXRlLgogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gcmVhZG9ubHkoX3ZtLCBhcmdzKSB7CiAgICAgICAgdmFyIHJlZiA9IHVuTXV0KGFyZ3MucG9zaXRpb25hbC5hdCgwKSk7CiAgICAgICAgcmV0dXJuIG5ldyBSZWFkb25seVJlZmVyZW5jZShyZWYpOwogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBUaGUgYHt7dW5ib3VuZH19YCBoZWxwZXIgZGlzY29ubmVjdHMgdGhlIG9uZS13YXkgYmluZGluZyBvZiBhIHByb3BlcnR5LAogICAgICBlc3NlbnRpYWxseSBmcmVlemluZyBpdHMgdmFsdWUgYXQgdGhlIG1vbWVudCBvZiByZW5kZXJpbmcuIEZvciBleGFtcGxlLAogICAgICBpbiB0aGlzIGV4YW1wbGUgdGhlIGRpc3BsYXkgb2YgdGhlIHZhcmlhYmxlIGBuYW1lYCB3aWxsIG5vdCBjaGFuZ2UgZXZlbgogICAgICBpZiBpdCBpcyBzZXQgd2l0aCBhIG5ldyB2YWx1ZToKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7dW5ib3VuZCBuYW1lfX0KICAgICAgYGBgCiAgICAKICAgICAgTGlrZSBhbnkgaGVscGVyLCB0aGUgYHVuYm91bmRgIGhlbHBlciBjYW4gYWNjZXB0IGEgbmVzdGVkIGhlbHBlciBleHByZXNzaW9uLgogICAgICBUaGlzIGFsbG93cyBmb3IgY3VzdG9tIGhlbHBlcnMgdG8gYmUgcmVuZGVyZWQgdW5ib3VuZDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7dW5ib3VuZCAoc29tZS1jdXN0b20taGVscGVyKX19CiAgICAgIHt7dW5ib3VuZCAoY2FwaXRhbGl6ZSBuYW1lKX19CiAgICAgIHt7ISBZb3UgY2FuIHVzZSBhbnkgaGVscGVyLCBpbmNsdWRpbmcgdW5ib3VuZCwgaW4gYSBuZXN0ZWQgZXhwcmVzc2lvbiB9fQogICAgICB7e2NhcGl0YWxpemUgKHVuYm91bmQgbmFtZSl9fQogICAgICBgYGAKICAgIAogICAgICBUaGUgYHVuYm91bmRgIGhlbHBlciBvbmx5IGFjY2VwdHMgYSBzaW5nbGUgYXJndW1lbnQsIGFuZCBpdCByZXR1cm4gYW4KICAgICAgdW5ib3VuZCB2YWx1ZS4KICAgIAogICAgICBAbWV0aG9kIHVuYm91bmQKICAgICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gdW5ib3VuZChfdm0sIGFyZ3MpIHsKICAgICAgICAodHJ1ZSAmJiAhKGFyZ3MucG9zaXRpb25hbC5sZW5ndGggPT09IDEgJiYgYXJncy5uYW1lZC5sZW5ndGggPT09IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgndW5ib3VuZCBoZWxwZXIgY2Fubm90IGJlIGNhbGxlZCB3aXRoIG11bHRpcGxlIHBhcmFtcyBvciBoYXNoIHBhcmFtcycsIGFyZ3MucG9zaXRpb25hbC5sZW5ndGggPT09IDEgJiYgYXJncy5uYW1lZC5sZW5ndGggPT09IDApKTsKCiAgICAgICAgcmV0dXJuIFVuYm91bmRSZWZlcmVuY2UuY3JlYXRlKGFyZ3MucG9zaXRpb25hbC5hdCgwKS52YWx1ZSgpKTsKICAgIH0KCiAgICB2YXIgTU9ESUZJRVJTID0gWydhbHQnLCAnc2hpZnQnLCAnbWV0YScsICdjdHJsJ107CiAgICB2YXIgUE9JTlRFUl9FVkVOVF9UWVBFX1JFR0VYID0gL15jbGlja3xtb3VzZXx0b3VjaC87CiAgICBmdW5jdGlvbiBpc0FsbG93ZWRFdmVudChldmVudCwgYWxsb3dlZEtleXMpIHsKICAgICAgICBpZiAoYWxsb3dlZEtleXMgPT09IG51bGwgfHwgYWxsb3dlZEtleXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAoUE9JTlRFUl9FVkVOVF9UWVBFX1JFR0VYLnRlc3QoZXZlbnQudHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyVmlld3MuaXNTaW1wbGVDbGljaykoZXZlbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWxsb3dlZEtleXMgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYWxsb3dlZEtleXMuaW5kZXhPZignYW55JykgPj0gMCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBNT0RJRklFUlMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGV2ZW50W01PRElGSUVSU1tpXSArICdLZXknXSAmJiBhbGxvd2VkS2V5cy5pbmRleE9mKE1PRElGSUVSU1tpXSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB2YXIgQWN0aW9uSGVscGVyID0gewogICAgICAgIC8vIHJlZ2lzdGVyZWRBY3Rpb25zIGlzIHJlLWV4cG9ydGVkIGZvciBjb21wYXRpYmlsaXR5IHdpdGggb2xkZXIgcGx1Z2lucwogICAgICAgIC8vIHRoYXQgd2VyZSB1c2luZyB0aGlzIHVuZG9jdW1lbnRlZCBBUEkuCiAgICAgICAgcmVnaXN0ZXJlZEFjdGlvbnM6IF9lbWJlclZpZXdzLkFjdGlvbk1hbmFnZXIucmVnaXN0ZXJlZEFjdGlvbnMsCiAgICAgICAgcmVnaXN0ZXJBY3Rpb246IGZ1bmN0aW9uIChhY3Rpb25TdGF0ZSkgewogICAgICAgICAgICB2YXIgYWN0aW9uSWQgPSBhY3Rpb25TdGF0ZS5hY3Rpb25JZDsKCiAgICAgICAgICAgIF9lbWJlclZpZXdzLkFjdGlvbk1hbmFnZXIucmVnaXN0ZXJlZEFjdGlvbnNbYWN0aW9uSWRdID0gYWN0aW9uU3RhdGU7CiAgICAgICAgICAgIHJldHVybiBhY3Rpb25JZDsKICAgICAgICB9LAogICAgICAgIHVucmVnaXN0ZXJBY3Rpb246IGZ1bmN0aW9uIChhY3Rpb25TdGF0ZSkgewogICAgICAgICAgICB2YXIgYWN0aW9uSWQgPSBhY3Rpb25TdGF0ZS5hY3Rpb25JZDsKCiAgICAgICAgICAgIGRlbGV0ZSBfZW1iZXJWaWV3cy5BY3Rpb25NYW5hZ2VyLnJlZ2lzdGVyZWRBY3Rpb25zW2FjdGlvbklkXTsKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBBY3Rpb25TdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBBY3Rpb25TdGF0ZShlbGVtZW50LCBhY3Rpb25JZCwgYWN0aW9uTmFtZSwgYWN0aW9uQXJncywgbmFtZWRBcmdzLCBwb3NpdGlvbmFsQXJncywgaW1wbGljaXRUYXJnZXQsIGRvbSwgdGFnKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQWN0aW9uU3RhdGUpOwoKICAgICAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgdGhpcy5hY3Rpb25JZCA9IGFjdGlvbklkOwogICAgICAgICAgICB0aGlzLmFjdGlvbk5hbWUgPSBhY3Rpb25OYW1lOwogICAgICAgICAgICB0aGlzLmFjdGlvbkFyZ3MgPSBhY3Rpb25BcmdzOwogICAgICAgICAgICB0aGlzLm5hbWVkQXJncyA9IG5hbWVkQXJnczsKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbmFsID0gcG9zaXRpb25hbEFyZ3M7CiAgICAgICAgICAgIHRoaXMuaW1wbGljaXRUYXJnZXQgPSBpbXBsaWNpdFRhcmdldDsKICAgICAgICAgICAgdGhpcy5kb20gPSBkb207CiAgICAgICAgICAgIHRoaXMuZXZlbnROYW1lID0gdGhpcy5nZXRFdmVudE5hbWUoKTsKICAgICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgfQoKICAgICAgICBBY3Rpb25TdGF0ZS5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gZ2V0RXZlbnROYW1lKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lZEFyZ3MuZ2V0KCdvbicpLnZhbHVlKCkgfHwgJ2NsaWNrJzsKICAgICAgICB9OwoKICAgICAgICBBY3Rpb25TdGF0ZS5wcm90b3R5cGUuZ2V0QWN0aW9uQXJncyA9IGZ1bmN0aW9uIGdldEFjdGlvbkFyZ3MoKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkodGhpcy5hY3Rpb25BcmdzLmxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5hY3Rpb25BcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmFjdGlvbkFyZ3NbaV0udmFsdWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CgogICAgICAgIEFjdGlvblN0YXRlLnByb3RvdHlwZS5nZXRUYXJnZXQgPSBmdW5jdGlvbiBnZXRUYXJnZXQoKSB7CiAgICAgICAgICAgIHZhciBpbXBsaWNpdFRhcmdldCA9IHRoaXMuaW1wbGljaXRUYXJnZXQsCiAgICAgICAgICAgICAgICBuYW1lZEFyZ3MgPSB0aGlzLm5hbWVkQXJnczsKCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChuYW1lZEFyZ3MuaGFzKCd0YXJnZXQnKSkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gbmFtZWRBcmdzLmdldCgndGFyZ2V0JykudmFsdWUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IGltcGxpY2l0VGFyZ2V0LnZhbHVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9OwoKICAgICAgICBBY3Rpb25TdGF0ZS5wcm90b3R5cGUuaGFuZGxlciA9IGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQpIHsKICAgICAgICAgICAgdmFyIF90aGlzMzYgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGFjdGlvbk5hbWUgPSB0aGlzLmFjdGlvbk5hbWUsCiAgICAgICAgICAgICAgICBuYW1lZEFyZ3MgPSB0aGlzLm5hbWVkQXJnczsKCiAgICAgICAgICAgIHZhciBidWJibGVzID0gbmFtZWRBcmdzLmdldCgnYnViYmxlcycpOwogICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHQgPSBuYW1lZEFyZ3MuZ2V0KCdwcmV2ZW50RGVmYXVsdCcpOwogICAgICAgICAgICB2YXIgYWxsb3dlZEtleXMgPSBuYW1lZEFyZ3MuZ2V0KCdhbGxvd2VkS2V5cycpOwogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5nZXRUYXJnZXQoKTsKICAgICAgICAgICAgdmFyIHNob3VsZEJ1YmJsZSA9IGJ1YmJsZXMudmFsdWUoKSAhPT0gZmFsc2U7CiAgICAgICAgICAgIGlmICghaXNBbGxvd2VkRXZlbnQoZXZlbnQsIGFsbG93ZWRLZXlzLnZhbHVlKCkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJldmVudERlZmF1bHQudmFsdWUoKSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFzaG91bGRCdWJibGUpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICgwLCBfcnVubG9vcC5qb2luKShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IF90aGlzMzYuZ2V0QWN0aW9uQXJncygpOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAgICAgYXJnczogYXJncywKICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IHRhcmdldCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb25OYW1lW0lOVk9LRV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAoMCwgX2luc3RydW1lbnRhdGlvbi5mbGFnZ2VkSW5zdHJ1bWVudCkoJ2ludGVyYWN0aW9uLmVtYmVyLWFjdGlvbicsIHBheWxvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uTmFtZVtJTlZPS0VdLmFwcGx5KGFjdGlvbk5hbWUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICgwLCBfaW5zdHJ1bWVudGF0aW9uLmZsYWdnZWRJbnN0cnVtZW50KSgnaW50ZXJhY3Rpb24uZW1iZXItYWN0aW9uJywgcGF5bG9hZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25OYW1lLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGF5bG9hZC5uYW1lID0gYWN0aW9uTmFtZTsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuc2VuZCkgewogICAgICAgICAgICAgICAgICAgICgwLCBfaW5zdHJ1bWVudGF0aW9uLmZsYWdnZWRJbnN0cnVtZW50KSgnaW50ZXJhY3Rpb24uZW1iZXItYWN0aW9uJywgcGF5bG9hZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuc2VuZC5hcHBseSh0YXJnZXQsIFthY3Rpb25OYW1lXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiB0YXJnZXRbYWN0aW9uTmFtZV0gPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGFjdGlvbiBcJycgKyBhY3Rpb25OYW1lICsgJ1wnIGRpZCBub3QgZXhpc3Qgb24gJyArIHRhcmdldCwgdHlwZW9mIHRhcmdldFthY3Rpb25OYW1lXSA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgICAgICAgICAgICAgICAgICAoMCwgX2luc3RydW1lbnRhdGlvbi5mbGFnZ2VkSW5zdHJ1bWVudCkoJ2ludGVyYWN0aW9uLmVtYmVyLWFjdGlvbicsIHBheWxvYWQsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2FjdGlvbk5hbWVdLmFwcGx5KHRhcmdldCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gc2hvdWxkQnViYmxlOwogICAgICAgIH07CgogICAgICAgIEFjdGlvblN0YXRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgQWN0aW9uSGVscGVyLnVucmVnaXN0ZXJBY3Rpb24odGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFjdGlvblN0YXRlOwogICAgfSgpOwoKICAgIHZhciBBY3Rpb25Nb2RpZmllck1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gQWN0aW9uTW9kaWZpZXJNYW5hZ2VyKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFjdGlvbk1vZGlmaWVyTWFuYWdlcik7CiAgICAgICAgfQoKICAgICAgICBBY3Rpb25Nb2RpZmllck1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbGVtZW50LCBhcmdzLCBfZHluYW1pY1Njb3BlLCBkb20pIHsKICAgICAgICAgICAgdmFyIF9hcmdzJGNhcHR1cmUgPSBhcmdzLmNhcHR1cmUoKSwKICAgICAgICAgICAgICAgIG5hbWVkID0gX2FyZ3MkY2FwdHVyZS5uYW1lZCwKICAgICAgICAgICAgICAgIHBvc2l0aW9uYWwgPSBfYXJncyRjYXB0dXJlLnBvc2l0aW9uYWwsCiAgICAgICAgICAgICAgICB0YWcgPSBfYXJncyRjYXB0dXJlLnRhZzsKCiAgICAgICAgICAgIHZhciBpbXBsaWNpdFRhcmdldCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGFjdGlvbk5hbWUgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBhY3Rpb25OYW1lUmVmID0gdm9pZCAwOwogICAgICAgICAgICBpZiAocG9zaXRpb25hbC5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICBpbXBsaWNpdFRhcmdldCA9IHBvc2l0aW9uYWwuYXQoMCk7CiAgICAgICAgICAgICAgICBhY3Rpb25OYW1lUmVmID0gcG9zaXRpb25hbC5hdCgxKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25OYW1lUmVmW0lOVk9LRV0pIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25OYW1lID0gYWN0aW9uTmFtZVJlZjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkxhYmVsID0gYWN0aW9uTmFtZVJlZi5fcHJvcGVydHlLZXk7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uTmFtZSA9IGFjdGlvbk5hbWVSZWYudmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBhY3Rpb25OYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3Ugc3BlY2lmaWVkIGEgcXVvdGVsZXNzIHBhdGgsIGAnICsgYWN0aW9uTGFiZWwgKyAnYCwgdG8gdGhlICcgKyAne3thY3Rpb259fSBoZWxwZXIgd2hpY2ggZGlkIG5vdCByZXNvbHZlIHRvIGFuIGFjdGlvbiBuYW1lIChhICcgKyAnc3RyaW5nKS4gUGVyaGFwcyB5b3UgbWVhbnQgdG8gdXNlIGEgcXVvdGVkIGFjdGlvbk5hbWU/IChlLmcuICcgKyAne3thY3Rpb24gIicgKyBhY3Rpb25MYWJlbCArICcifX0pLicsIHR5cGVvZiBhY3Rpb25OYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ2Z1bmN0aW9uJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhY3Rpb25BcmdzID0gW107CiAgICAgICAgICAgIC8vIFRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSAoMSkgYHRoaXNgIGFuZCAoMikgdGhlIGFjdGlvbiBuYW1lLgogICAgICAgICAgICAvLyBFdmVyeXRoaW5nIGVsc2UgaXMgYSBwYXJhbS4KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBwb3NpdGlvbmFsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhY3Rpb25BcmdzLnB1c2gocG9zaXRpb25hbC5hdChpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFjdGlvbklkID0gKDAsIF9lbWJlclV0aWxzLnV1aWQpKCk7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aW9uU3RhdGUoZWxlbWVudCwgYWN0aW9uSWQsIGFjdGlvbk5hbWUsIGFjdGlvbkFyZ3MsIG5hbWVkLCBwb3NpdGlvbmFsLCBpbXBsaWNpdFRhcmdldCwgZG9tLCB0YWcpOwogICAgICAgIH07CgogICAgICAgIEFjdGlvbk1vZGlmaWVyTWFuYWdlci5wcm90b3R5cGUuaW5zdGFsbCA9IGZ1bmN0aW9uIGluc3RhbGwoYWN0aW9uU3RhdGUpIHsKICAgICAgICAgICAgdmFyIGRvbSA9IGFjdGlvblN0YXRlLmRvbSwKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBhY3Rpb25TdGF0ZS5lbGVtZW50LAogICAgICAgICAgICAgICAgYWN0aW9uSWQgPSBhY3Rpb25TdGF0ZS5hY3Rpb25JZDsKCiAgICAgICAgICAgIEFjdGlvbkhlbHBlci5yZWdpc3RlckFjdGlvbihhY3Rpb25TdGF0ZSk7CiAgICAgICAgICAgIGRvbS5zZXRBdHRyaWJ1dGUoZWxlbWVudCwgJ2RhdGEtZW1iZXItYWN0aW9uJywgJycpOwogICAgICAgICAgICBkb20uc2V0QXR0cmlidXRlKGVsZW1lbnQsICdkYXRhLWVtYmVyLWFjdGlvbi0nICsgYWN0aW9uSWQsIGFjdGlvbklkKTsKICAgICAgICB9OwoKICAgICAgICBBY3Rpb25Nb2RpZmllck1hbmFnZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShhY3Rpb25TdGF0ZSkgewogICAgICAgICAgICB2YXIgcG9zaXRpb25hbCA9IGFjdGlvblN0YXRlLnBvc2l0aW9uYWw7CgogICAgICAgICAgICB2YXIgYWN0aW9uTmFtZVJlZiA9IHBvc2l0aW9uYWwuYXQoMSk7CiAgICAgICAgICAgIGlmICghYWN0aW9uTmFtZVJlZltJTlZPS0VdKSB7CiAgICAgICAgICAgICAgICBhY3Rpb25TdGF0ZS5hY3Rpb25OYW1lID0gYWN0aW9uTmFtZVJlZi52YWx1ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvblN0YXRlLmV2ZW50TmFtZSA9IGFjdGlvblN0YXRlLmdldEV2ZW50TmFtZSgpOwogICAgICAgIH07CgogICAgICAgIEFjdGlvbk1vZGlmaWVyTWFuYWdlci5wcm90b3R5cGUuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKGFjdGlvblN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBhY3Rpb25TdGF0ZS50YWc7CiAgICAgICAgfTsKCiAgICAgICAgQWN0aW9uTW9kaWZpZXJNYW5hZ2VyLnByb3RvdHlwZS5nZXREZXN0cnVjdG9yID0gZnVuY3Rpb24gZ2V0RGVzdHJ1Y3Rvcihtb2RpZmllcikgewogICAgICAgICAgICByZXR1cm4gbW9kaWZpZXI7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFjdGlvbk1vZGlmaWVyTWFuYWdlcjsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBoYXNoVG9BcmdzKGhhc2gpIHsKICAgICAgICBpZiAoaGFzaCA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIG5hbWVzID0gaGFzaFswXS5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gJ0AnICsga2V5OwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBbbmFtZXMsIGhhc2hbMV1dOwogICAgfQoKICAgIGZ1bmN0aW9uIHRleHRBcmVhTWFjcm8oX25hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcikgewogICAgICAgIHZhciBkZWZpbml0aW9uID0gYnVpbGRlci5jb21waWxlclsncmVzb2x2ZXInXS5sb29rdXBDb21wb25lbnREZWZpbml0aW9uKCctdGV4dC1hcmVhJywgYnVpbGRlci5yZWZlcnJlcik7CiAgICAgICAgd3JhcENvbXBvbmVudENsYXNzQXR0cmlidXRlKGhhc2gpOwogICAgICAgIGJ1aWxkZXIuY29tcG9uZW50LnN0YXRpYyhkZWZpbml0aW9uLCBbcGFyYW1zIHx8IFtdLCBoYXNoVG9BcmdzKGhhc2gpLCBudWxsLCBudWxsXSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgZnVuY3Rpb24gYnVpbGRTeW50YXgodHlwZSwgcGFyYW1zLCBoYXNoLCBidWlsZGVyKSB7CiAgICAgICAgdmFyIGRlZmluaXRpb24gPSBidWlsZGVyLmNvbXBpbGVyWydyZXNvbHZlciddLmxvb2t1cENvbXBvbmVudERlZmluaXRpb24odHlwZSwgYnVpbGRlci5yZWZlcnJlcik7CiAgICAgICAgYnVpbGRlci5jb21wb25lbnQuc3RhdGljKGRlZmluaXRpb24sIFtwYXJhbXMsIGhhc2hUb0FyZ3MoaGFzaCksIG51bGwsIG51bGxdKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICBUaGUgYHt7aW5wdXR9fWAgaGVscGVyIGxldHMgeW91IGNyZWF0ZSBhbiBIVE1MIGA8aW5wdXQgLz5gIGNvbXBvbmVudC4KICAgICAgSXQgY2F1c2VzIGFuIGBUZXh0RmllbGRgIGNvbXBvbmVudCB0byBiZSByZW5kZXJlZC4gIEZvciBtb3JlIGluZm8sCiAgICAgIHNlZSB0aGUgW1RleHRGaWVsZF0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvVGV4dEZpZWxkKSBkb2NzIGFuZAogICAgICB0aGUgW3RlbXBsYXRlcyBndWlkZV0oaHR0cHM6Ly9lbWJlcmpzLmNvbS9ndWlkZXMvdGVtcGxhdGVzL2lucHV0LWhlbHBlcnMvKS4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7aW5wdXQgdmFsdWU9Ijk4NyJ9fQogICAgICBgYGAKICAgIAogICAgICByZW5kZXJzIGFzOgogICAgCiAgICAgIGBgYEhUTUwKICAgICAgPGlucHV0IHR5cGU9InRleHQiIHZhbHVlPSI5ODciIC8+CiAgICAgIGBgYAogICAgCiAgICAgICMjIyBUZXh0IGZpZWxkCiAgICAKICAgICAgSWYgbm8gYHR5cGVgIG9wdGlvbiBpcyBzcGVjaWZpZWQsIGEgZGVmYXVsdCBvZiB0eXBlICd0ZXh0JyBpcyB1c2VkLgogICAgICBNYW55IG9mIHRoZSBzdGFuZGFyZCBIVE1MIGF0dHJpYnV0ZXMgbWF5IGJlIHBhc3NlZCB0byB0aGlzIGhlbHBlci4KICAgICAgPHRhYmxlPgogICAgICAgIDx0cj48dGQ+YHJlYWRvbmx5YDwvdGQ+PHRkPmByZXF1aXJlZGA8L3RkPjx0ZD5gYXV0b2ZvY3VzYDwvdGQ+PC90cj4KICAgICAgICA8dHI+PHRkPmB2YWx1ZWA8L3RkPjx0ZD5gcGxhY2Vob2xkZXJgPC90ZD48dGQ+YGRpc2FibGVkYDwvdGQ+PC90cj4KICAgICAgICA8dHI+PHRkPmBzaXplYDwvdGQ+PHRkPmB0YWJpbmRleGA8L3RkPjx0ZD5gbWF4bGVuZ3RoYDwvdGQ+PC90cj4KICAgICAgICA8dHI+PHRkPmBuYW1lYDwvdGQ+PHRkPmBtaW5gPC90ZD48dGQ+YG1heGA8L3RkPjwvdHI+CiAgICAgICAgPHRyPjx0ZD5gcGF0dGVybmA8L3RkPjx0ZD5gYWNjZXB0YDwvdGQ+PHRkPmBhdXRvY29tcGxldGVgPC90ZD48L3RyPgogICAgICAgIDx0cj48dGQ+YGF1dG9zYXZlYDwvdGQ+PHRkPmBmb3JtYWN0aW9uYDwvdGQ+PHRkPmBmb3JtZW5jdHlwZWA8L3RkPjwvdHI+CiAgICAgICAgPHRyPjx0ZD5gZm9ybW1ldGhvZGA8L3RkPjx0ZD5gZm9ybW5vdmFsaWRhdGVgPC90ZD48dGQ+YGZvcm10YXJnZXRgPC90ZD48L3RyPgogICAgICAgIDx0cj48dGQ+YGhlaWdodGA8L3RkPjx0ZD5gaW5wdXRtb2RlYDwvdGQ+PHRkPmBtdWx0aXBsZWA8L3RkPjwvdHI+CiAgICAgICAgPHRyPjx0ZD5gc3RlcGA8L3RkPjx0ZD5gd2lkdGhgPC90ZD48dGQ+YGZvcm1gPC90ZD48L3RyPgogICAgICAgIDx0cj48dGQ+YHNlbGVjdGlvbkRpcmVjdGlvbmA8L3RkPjx0ZD5gc3BlbGxjaGVja2A8L3RkPjx0ZD4mbmJzcDs8L3RkPjwvdHI+CiAgICAgIDwvdGFibGU+CiAgICAgIFdoZW4gc2V0IHRvIGEgcXVvdGVkIHN0cmluZywgdGhlc2UgdmFsdWVzIHdpbGwgYmUgZGlyZWN0bHkgYXBwbGllZCB0byB0aGUgSFRNTAogICAgICBlbGVtZW50LiBXaGVuIGxlZnQgdW5xdW90ZWQsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGJvdW5kIHRvIGEgcHJvcGVydHkgb24gdGhlCiAgICAgIHRlbXBsYXRlJ3MgY3VycmVudCByZW5kZXJpbmcgY29udGV4dCAobW9zdCB0eXBpY2FsbHkgYSBjb250cm9sbGVyIGluc3RhbmNlKS4KICAgICAgQSB2ZXJ5IGNvbW1vbiB1c2Ugb2YgdGhpcyBoZWxwZXIgaXMgdG8gYmluZCB0aGUgYHZhbHVlYCBvZiBhbiBpbnB1dCB0byBhbiBPYmplY3QncyBhdHRyaWJ1dGU6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICBTZWFyY2g6CiAgICAgIHt7aW5wdXQgdmFsdWU9c2VhcmNoV29yZH19CiAgICAgIGBgYAogICAgCiAgICAgIEluIHRoaXMgZXhhbXBsZSwgdGhlIGluaXRpYWwgdmFsdWUgaW4gdGhlIGA8aW5wdXQgLz5gIHdpbGwgYmUgc2V0IHRvIHRoZSB2YWx1ZSBvZiBgc2VhcmNoV29yZGAuCiAgICAgIElmIHRoZSB1c2VyIGNoYW5nZXMgdGhlIHRleHQsIHRoZSB2YWx1ZSBvZiBgc2VhcmNoV29yZGAgd2lsbCBhbHNvIGJlIHVwZGF0ZWQuCiAgICAKICAgICAgIyMjIEFjdGlvbnMKICAgIAogICAgICBUaGUgaGVscGVyIGNhbiBzZW5kIG11bHRpcGxlIGFjdGlvbnMgYmFzZWQgb24gdXNlciBldmVudHMuCiAgICAgIFRoZSBhY3Rpb24gcHJvcGVydHkgZGVmaW5lcyB0aGUgYWN0aW9uIHdoaWNoIGlzIHNlbnQgd2hlbgogICAgICB0aGUgdXNlciBwcmVzc2VzIHRoZSByZXR1cm4ga2V5LgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3tpbnB1dCBhY3Rpb249InN1Ym1pdCJ9fQogICAgICBgYGAKICAgIAogICAgICBUaGUgaGVscGVyIGFsbG93cyBzb21lIHVzZXIgZXZlbnRzIHRvIHNlbmQgYWN0aW9ucy4KICAgIAogICAgICAqIGBlbnRlcmAKICAgICAgKiBgaW5zZXJ0LW5ld2xpbmVgCiAgICAgICogYGVzY2FwZS1wcmVzc2AKICAgICAgKiBgZm9jdXMtaW5gCiAgICAgICogYGZvY3VzLW91dGAKICAgICAgKiBga2V5LXByZXNzYAogICAgICAqIGBrZXktdXBgCiAgICAKICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBkZXNpcmUgYW4gYWN0aW9uIHRvIGJlIHNlbnQgd2hlbiB0aGUgaW5wdXQgaXMgYmx1cnJlZCwKICAgICAgeW91IG9ubHkgbmVlZCB0byBzZXR1cCB0aGUgYWN0aW9uIG5hbWUgdG8gdGhlIGV2ZW50IG5hbWUgcHJvcGVydHkuCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e2lucHV0IGZvY3VzLW91dD0iYWxlcnRNZXNzYWdlIn19CiAgICAgIGBgYAogICAgICBTZWUgbW9yZSBhYm91dCBbVGV4dCBTdXBwb3J0IEFjdGlvbnNdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL1RleHRGaWVsZCkKICAgIAogICAgICAjIyMgRXh0ZW5kaW5nIGBUZXh0RmllbGRgCiAgICAKICAgICAgSW50ZXJuYWxseSwgYHt7aW5wdXQgdHlwZT0idGV4dCJ9fWAgY3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBgVGV4dEZpZWxkYCwgcGFzc2luZwogICAgICBhcmd1bWVudHMgZnJvbSB0aGUgaGVscGVyIHRvIGBUZXh0RmllbGRgJ3MgYGNyZWF0ZWAgbWV0aG9kLiBZb3UgY2FuIGV4dGVuZCB0aGUKICAgICAgY2FwYWJpbGl0aWVzIG9mIHRleHQgaW5wdXRzIGluIHlvdXIgYXBwbGljYXRpb25zIGJ5IHJlb3BlbmluZyB0aGlzIGNsYXNzLiBGb3IgZXhhbXBsZSwKICAgICAgaWYgeW91IGFyZSBidWlsZGluZyBhIEJvb3RzdHJhcCBwcm9qZWN0IHdoZXJlIGBkYXRhLSpgIGF0dHJpYnV0ZXMgYXJlIHVzZWQsIHlvdQogICAgICBjYW4gYWRkIG9uZSB0byB0aGUgYFRleHRGaWVsZGAncyBgYXR0cmlidXRlQmluZGluZ3NgIHByb3BlcnR5OgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IFRleHRGaWVsZCBmcm9tICdAZW1iZXIvY29tcG9uZW50L3RleHQtZmllbGQnOwogICAgICBUZXh0RmllbGQucmVvcGVuKHsKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydkYXRhLWVycm9yJ10KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIEtlZXAgaW4gbWluZCB3aGVuIHdyaXRpbmcgYFRleHRGaWVsZGAgc3ViY2xhc3NlcyB0aGF0IGBUZXh0RmllbGRgCiAgICAgIGl0c2VsZiBleHRlbmRzIGBDb21wb25lbnRgLiBFeHBlY3QgaXNvbGF0ZWQgY29tcG9uZW50IHNlbWFudGljcywgbm90CiAgICAgIGxlZ2FjeSAxLnggdmlldyBzZW1hbnRpY3MgKGxpa2UgYGNvbnRyb2xsZXJgIGJlaW5nIHByZXNlbnQpLgogICAgICBTZWUgbW9yZSBhYm91dCBbRW1iZXIgY29tcG9uZW50c10oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQ29tcG9uZW50KQogICAgCiAgICAgICMjIyBDaGVja2JveAogICAgCiAgICAgIENoZWNrYm94ZXMgYXJlIHNwZWNpYWwgZm9ybXMgb2YgdGhlIGB7e2lucHV0fX1gIGhlbHBlci4gIFRvIGNyZWF0ZSBhIGA8Y2hlY2tib3ggLz5gOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgRW1iZXJpemUgRXZlcnl0aGluZzoKICAgICAge3tpbnB1dCB0eXBlPSJjaGVja2JveCIgbmFtZT0iaXNFbWJlcml6ZWQiIGNoZWNrZWQ9aXNFbWJlcml6ZWR9fQogICAgICBgYGAKICAgIAogICAgICBUaGlzIHdpbGwgYmluZCBjaGVja2VkIHN0YXRlIG9mIHRoaXMgY2hlY2tib3ggdG8gdGhlIHZhbHVlIG9mIGBpc0VtYmVyaXplZGAgIC0tIGlmIGVpdGhlciBvbmUgY2hhbmdlcywKICAgICAgaXQgd2lsbCBiZSByZWZsZWN0ZWQgaW4gdGhlIG90aGVyLgogICAgCiAgICAgIFRoZSBmb2xsb3dpbmcgSFRNTCBhdHRyaWJ1dGVzIGNhbiBiZSBzZXQgdmlhIHRoZSBoZWxwZXI6CiAgICAKICAgICAgKiBgY2hlY2tlZGAKICAgICAgKiBgZGlzYWJsZWRgCiAgICAgICogYHRhYmluZGV4YAogICAgICAqIGBpbmRldGVybWluYXRlYAogICAgICAqIGBuYW1lYAogICAgICAqIGBhdXRvZm9jdXNgCiAgICAgICogYGZvcm1gCiAgICAKICAgICAgIyMjIEV4dGVuZGluZyBgQ2hlY2tib3hgCiAgICAKICAgICAgSW50ZXJuYWxseSwgYHt7aW5wdXQgdHlwZT0iY2hlY2tib3gifX1gIGNyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgYENoZWNrYm94YCwgcGFzc2luZwogICAgICBhcmd1bWVudHMgZnJvbSB0aGUgaGVscGVyIHRvIGBDaGVja2JveGAncyBgY3JlYXRlYCBtZXRob2QuIFlvdSBjYW4gZXh0ZW5kIHRoZQogICAgICBjYXBhYmxpbHRpZXMgb2YgY2hlY2tib3ggaW5wdXRzIGluIHlvdXIgYXBwbGljYXRpb25zIGJ5IHJlb3BlbmluZyB0aGlzIGNsYXNzLiBGb3IgZXhhbXBsZSwKICAgICAgaWYgeW91IHdhbnRlZCB0byBhZGQgYSBjc3MgY2xhc3MgdG8gYWxsIGNoZWNrYm94ZXMgaW4geW91ciBhcHBsaWNhdGlvbjoKICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBDaGVja2JveCBmcm9tICdAZW1iZXIvY29tcG9uZW50L2NoZWNrYm94JzsKICAgIAogICAgICBDaGVja2JveC5yZW9wZW4oewogICAgICAgIGNsYXNzTmFtZXM6IFsnbXktYXBwLWNoZWNrYm94J10KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgaW5wdXQKICAgICAgQGZvciBFbWJlci5UZW1wbGF0ZXMuaGVscGVycwogICAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGlucHV0TWFjcm8oX25hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcikgewogICAgICAgIGlmIChwYXJhbXMgPT09IG51bGwpIHsKICAgICAgICAgICAgcGFyYW1zID0gW107CiAgICAgICAgfQogICAgICAgIGlmIChoYXNoICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBrZXlzID0gaGFzaFswXTsKICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGhhc2hbMV07CiAgICAgICAgICAgIHZhciB0eXBlSW5kZXggPSBrZXlzLmluZGV4T2YoJ3R5cGUnKTsKICAgICAgICAgICAgaWYgKHR5cGVJbmRleCA+IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZUFyZyA9IHZhbHVlc1t0eXBlSW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodHlwZUFyZykpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGVyZSBpcyBhbiBBU1QgcGx1Z2luIHRoYXQgY29udmVydHMgdGhpcyB0byBhbiBleHByZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgLy8gaXQgcmVhbGx5IHNob3VsZCBqdXN0IGNvbXBpbGUgaW4gdGhlIGNvbXBvbmVudCBjYWxsIHRvby4KICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXRUeXBlRXhwciA9IHBhcmFtc1swXTsKICAgICAgICAgICAgICAgICAgICBidWlsZGVyLmR5bmFtaWNDb21wb25lbnQoaW5wdXRUeXBlRXhwciwgbnVsbCwgcGFyYW1zLnNsaWNlKDEpLCBoYXNoLCB0cnVlLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0eXBlQXJnID09PSAnY2hlY2tib3gnKSB7CiAgICAgICAgICAgICAgICAgICAgKHRydWUgJiYgIShrZXlzLmluZGV4T2YoJ3ZhbHVlJykgPT09IC0xKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoInt7aW5wdXQgdHlwZT0nY2hlY2tib3gnfX0gZG9lcyBub3Qgc3VwcG9ydCBzZXR0aW5nIGB2YWx1ZT1zb21lQm9vbGVhblZhbHVlYDsgIiArICd5b3UgbXVzdCB1c2UgYGNoZWNrZWQ9c29tZUJvb2xlYW5WYWx1ZWAgaW5zdGVhZC4nLCBrZXlzLmluZGV4T2YoJ3ZhbHVlJykgPT09IC0xKSk7CgogICAgICAgICAgICAgICAgICAgIHdyYXBDb21wb25lbnRDbGFzc0F0dHJpYnV0ZShoYXNoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnVpbGRTeW50YXgoJy1jaGVja2JveCcsIHBhcmFtcywgaGFzaCwgYnVpbGRlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1aWxkU3ludGF4KCctdGV4dC1maWVsZCcsIHBhcmFtcywgaGFzaCwgYnVpbGRlcik7CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwogICAgLyoqCiAgICAgICAgVGhlIGBsZXRgIGhlbHBlciByZWNlaXZlcyBvbmUgb3IgbW9yZSBwb3NpdGlvbmFsIGFyZ3VtZW50cyBhbmQgeWllbGRzCiAgICAgICAgdGhlbSBvdXQgYXMgYmxvY2sgcGFyYW1zLgogICAgCiAgICAgICAgVGhpcyBhbGxvd3MgdGhlIGRldmVsb3BlciB0byBpbnRyb2R1Y2Ugc2hvcnRlciBuYW1lcyBmb3IgY2VydGFpbiBjb21wdXRhdGlvbnMKICAgICAgICBpbiB0aGUgdGVtcGxhdGUuCiAgICAKICAgICAgICBUaGlzIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGlmIHlvdSBhcmUgcGFzc2luZyBwcm9wZXJ0aWVzIHRvIGEgY29tcG9uZW50CiAgICAgICAgdGhhdCByZWNlaXZlcyBhIGxvdCBvZiBvcHRpb25zIGFuZCB5b3Ugd2FudCB0byBjbGVhbiB1cCB0aGUgaW52b2NhdGlvbi4KICAgIAogICAgICAgIEZvciB0aGUgZm9sbG93aW5nIGV4YW1wbGUsIHRoZSB0ZW1wbGF0ZSByZWNlaXZlcyBhIGBwb3N0YCBvYmplY3Qgd2l0aAogICAgICAgIGBjb250ZW50YCBhbmQgYHRpdGxlYCBwcm9wZXJ0aWVzLgogICAgCiAgICAgICAgV2UgYXJlIGdvaW5nIHRvIGNhbGwgdGhlIGBteS1wb3N0YCBjb21wb25lbnQsIHBhc3NpbmcgYSB0aXRsZSB3aGljaCBpcwogICAgICAgIHRoZSB0aXRsZSBvZiB0aGUgcG9zdCBzdWZmaXhlZCB3aXRoIHRoZSBuYW1lIG9mIHRoZSBibG9nLCB0aGUgY29udGVudAogICAgICAgIG9mIHRoZSBwb3N0LCBhbmQgYSBzZXJpZXMgb2Ygb3B0aW9ucyBkZWZpbmVkIGluLXBsYWNlLgogICAgCiAgICAgICAgYGBgaGFuZGxlYmFycwogICAgICAgIHt7I2xldAogICAgICAgICAgICAoY29uY2F0IHBvc3QudGl0bGUgJyB8IFRoZSBFbWJlci5qcyBCbG9nJykKICAgICAgICAgICAgcG9zdC5jb250ZW50CiAgICAgICAgICAgIChoYXNoCiAgICAgICAgICAgICAgdGhlbWU9ImhpZ2gtY29udHJhc3QiCiAgICAgICAgICAgICAgZW5hYmxlQ29tbWVudHM9dHJ1ZQogICAgICAgICAgICApCiAgICAgICAgICAgIGFzIHx0aXRsZSBjb250ZW50IG9wdGlvbnN8CiAgICAgICAgfX0KICAgICAgICAgIHt7bXktcG9zdCB0aXRsZT10aXRsZSBjb250ZW50PWNvbnRlbnQgb3B0aW9ucz1vcHRpb25zfX0KICAgICAgICB7ey9sZXR9fQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGxldAogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBibG9ja0xldE1hY3JvKHBhcmFtcywgX2hhc2gsIHRlbXBsYXRlLCBfaW52ZXJzZSwgYnVpbGRlcikgewogICAgICAgIGlmICh0ZW1wbGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAocGFyYW1zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWlsZGVyLmNvbXBpbGVQYXJhbXMocGFyYW1zKTsKICAgICAgICAgICAgICAgIGJ1aWxkZXIuaW52b2tlU3RhdGljQmxvY2sodGVtcGxhdGUsIHBhcmFtcy5sZW5ndGgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnVpbGRlci5pbnZva2VTdGF0aWModGVtcGxhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciBDQVBBQklMSVRJRVMkMiA9IHsKICAgICAgICBkeW5hbWljTGF5b3V0OiB0cnVlLAogICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgIHByZXBhcmVBcmdzOiBmYWxzZSwKICAgICAgICBjcmVhdGVBcmdzOiBmYWxzZSwKICAgICAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgICAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICAgICAgY3JlYXRlQ2FsbGVyOiB0cnVlLAogICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICB1cGRhdGVIb29rOiB0cnVlLAogICAgICAgIGNyZWF0ZUluc3RhbmNlOiB0cnVlCiAgICB9OwoKICAgIHZhciBNb3VudE1hbmFnZXIgPSBmdW5jdGlvbiAoX0Fic3RyYWN0TWFuYWdlcjQpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKE1vdW50TWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcjQpOwoKICAgICAgICBmdW5jdGlvbiBNb3VudE1hbmFnZXIoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgTW91bnRNYW5hZ2VyKTsKICAgICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQWJzdHJhY3RNYW5hZ2VyNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICB9CgogICAgICAgIE1vdW50TWFuYWdlci5wcm90b3R5cGUuZ2V0RHluYW1pY0xheW91dCA9IGZ1bmN0aW9uIGdldER5bmFtaWNMYXlvdXQoc3RhdGUsIF8pIHsKICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gc3RhdGUuZW5naW5lLmxvb2t1cCgndGVtcGxhdGU6YXBwbGljYXRpb24nKTsKICAgICAgICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzTGF5b3V0KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBoYW5kbGU6IGxheW91dC5jb21waWxlKCksCiAgICAgICAgICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgTW91bnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgICAgICAgICAgIHJldHVybiBDQVBBQklMSVRJRVMkMjsKICAgICAgICB9OwoKICAgICAgICBNb3VudE1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnZpcm9ubWVudCwgc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3B1c2hFbmdpbmVUb0RlYnVnU3RhY2soJ2VuZ2luZTonICsgc3RhdGUubmFtZSwgZW52aXJvbm1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFRPRE8KICAgICAgICAgICAgLy8gbW91bnQgaXMgYSBydW50aW1lIGhlbHBlciwgdGhpcyBzaG91bGRuJ3QgdXNlIGR5bmFtaWMgbGF5b3V0CiAgICAgICAgICAgIC8vIHdlIHNob3VsZCByZXNvbHZlIHRoZSBlbmdpbmUgYXBwIHRlbXBsYXRlIGluIHRoZSBoZWxwZXIKICAgICAgICAgICAgLy8gaXQgYWxzbyBzaG91bGQgdXNlIHRoZSBvd25lciB0aGF0IGxvb2tlZCB1cCB0aGUgbW91bnQgaGVscGVyLgogICAgICAgICAgICB2YXIgZW5naW5lID0gZW52aXJvbm1lbnQub3duZXIuYnVpbGRDaGlsZEVuZ2luZUluc3RhbmNlKHN0YXRlLm5hbWUpOwogICAgICAgICAgICBlbmdpbmUuYm9vdCgpOwogICAgICAgICAgICB2YXIgYXBwbGljYXRpb25GYWN0b3J5ID0gZW5naW5lLmZhY3RvcnlGb3IoJ2NvbnRyb2xsZXI6YXBwbGljYXRpb24nKTsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXJGYWN0b3J5ID0gYXBwbGljYXRpb25GYWN0b3J5IHx8ICgwLCBfZW1iZXJSb3V0aW5nLmdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkpKGVuZ2luZSwgJ2FwcGxpY2F0aW9uJyk7CiAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgc2VsZiA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGJ1Y2tldCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHRhZyA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciBtb2RlbFJlZiA9IHN0YXRlLm1vZGVsUmVmOwogICAgICAgICAgICAgICAgaWYgKG1vZGVsUmVmID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gY29udHJvbGxlckZhY3RvcnkuY3JlYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgc2VsZiA9IG5ldyBSb290UmVmZXJlbmNlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgICAgIHRhZyA9IF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICAgICAgICAgIGJ1Y2tldCA9IHsgZW5naW5lOiBlbmdpbmUsIGNvbnRyb2xsZXI6IGNvbnRyb2xsZXIsIHNlbGY6IHNlbGYsIHRhZzogdGFnIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9IG1vZGVsUmVmLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsUmV2ID0gbW9kZWxSZWYudGFnLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGNvbnRyb2xsZXJGYWN0b3J5LmNyZWF0ZSh7IG1vZGVsOiBtb2RlbCB9KTsKICAgICAgICAgICAgICAgICAgICBzZWxmID0gbmV3IFJvb3RSZWZlcmVuY2UoY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgICAgdGFnID0gbW9kZWxSZWYudGFnOwogICAgICAgICAgICAgICAgICAgIGJ1Y2tldCA9IHsgZW5naW5lOiBlbmdpbmUsIGNvbnRyb2xsZXI6IGNvbnRyb2xsZXIsIHNlbGY6IHNlbGYsIHRhZzogdGFnLCBtb2RlbFJlZjogbW9kZWxSZWYsIG1vZGVsUmV2OiBtb2RlbFJldiB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGNvbnRyb2xsZXJGYWN0b3J5LmNyZWF0ZSgpOwogICAgICAgICAgICAgICAgc2VsZiA9IG5ldyBSb290UmVmZXJlbmNlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgdGFnID0gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgICAgICAgICAgICBidWNrZXQgPSB7IGVuZ2luZTogZW5naW5lLCBjb250cm9sbGVyOiBjb250cm9sbGVyLCBzZWxmOiBzZWxmLCB0YWc6IHRhZyB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBidWNrZXQ7CiAgICAgICAgfTsKCiAgICAgICAgTW91bnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZihfcmVmMjEpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSBfcmVmMjEuc2VsZjsKCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIH07CgogICAgICAgIE1vdW50TWFuYWdlci5wcm90b3R5cGUuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKHN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZS50YWc7CiAgICAgICAgfTsKCiAgICAgICAgTW91bnRNYW5hZ2VyLnByb3RvdHlwZS5nZXREZXN0cnVjdG9yID0gZnVuY3Rpb24gZ2V0RGVzdHJ1Y3RvcihfcmVmMjIpIHsKICAgICAgICAgICAgdmFyIGVuZ2luZSA9IF9yZWYyMi5lbmdpbmU7CgogICAgICAgICAgICByZXR1cm4gZW5naW5lOwogICAgICAgIH07CgogICAgICAgIE1vdW50TWFuYWdlci5wcm90b3R5cGUuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gZGlkUmVuZGVyTGF5b3V0KCkgewogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrLnBvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTW91bnRNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoYnVja2V0KSB7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IGJ1Y2tldC5jb250cm9sbGVyLAogICAgICAgICAgICAgICAgICAgIG1vZGVsUmVmID0gYnVja2V0Lm1vZGVsUmVmLAogICAgICAgICAgICAgICAgICAgIG1vZGVsUmV2ID0gYnVja2V0Lm1vZGVsUmV2OwoKICAgICAgICAgICAgICAgIGlmICghbW9kZWxSZWYudGFnLnZhbGlkYXRlKG1vZGVsUmV2KSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtb2RlbCA9IG1vZGVsUmVmLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgYnVja2V0Lm1vZGVsUmV2ID0gbW9kZWxSZWYudGFnLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlci5zZXQoJ21vZGVsJywgbW9kZWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE1vdW50TWFuYWdlcjsKICAgIH0oQWJzdHJhY3RNYW5hZ2VyKTsKCiAgICB2YXIgTU9VTlRfTUFOQUdFUiA9IG5ldyBNb3VudE1hbmFnZXIoKTsKCiAgICB2YXIgTW91bnREZWZpbml0aW9uID0gZnVuY3Rpb24gTW91bnREZWZpbml0aW9uKG5hbWUsIG1vZGVsUmVmKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBNb3VudERlZmluaXRpb24pOwoKICAgICAgICB0aGlzLm1hbmFnZXIgPSBNT1VOVF9NQU5BR0VSOwogICAgICAgIHRoaXMuc3RhdGUgPSB7IG5hbWU6IG5hbWUsIG1vZGVsUmVmOiBtb2RlbFJlZiB9OwogICAgfTsKCiAgICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAgICovCiAgICBmdW5jdGlvbiBtb3VudEhlbHBlcih2bSwgYXJncykgewogICAgICAgIHZhciBlbnYgPSB2bS5lbnY7CiAgICAgICAgdmFyIG5hbWVSZWYgPSBhcmdzLnBvc2l0aW9uYWwuYXQoMCk7CiAgICAgICAgdmFyIG1vZGVsUmVmID0gYXJncy5uYW1lZC5oYXMoJ21vZGVsJykgPyBhcmdzLm5hbWVkLmdldCgnbW9kZWwnKSA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gbmV3IER5bmFtaWNFbmdpbmVSZWZlcmVuY2UobmFtZVJlZiwgZW52LCBtb2RlbFJlZik7CiAgICB9CiAgICAvKioKICAgICAgVGhlIGB7e21vdW50fX1gIGhlbHBlciBsZXRzIHlvdSBlbWJlZCBhIHJvdXRlbGVzcyBlbmdpbmUgaW4gYSB0ZW1wbGF0ZS4KICAgICAgTW91bnRpbmcgYW4gZW5naW5lIHdpbGwgY2F1c2UgYW4gaW5zdGFuY2UgdG8gYmUgYm9vdGVkIGFuZCBpdHMgYGFwcGxpY2F0aW9uYAogICAgICB0ZW1wbGF0ZSB0byBiZSByZW5kZXJlZC4KICAgIAogICAgICBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyB0ZW1wbGF0ZSBtb3VudHMgdGhlIGBlbWJlci1jaGF0YCBlbmdpbmU6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgYXBwbGljYXRpb24uaGJzIH19CiAgICAgIHt7bW91bnQgImVtYmVyLWNoYXQifX0KICAgICAgYGBgCiAgICAKICAgICAgQWRkaXRpb25hbGx5LCB5b3UgY2FuIGFsc28gcGFzcyBpbiBhIGBtb2RlbGAgYXJndW1lbnQgdGhhdCB3aWxsIGJlCiAgICAgIHNldCBhcyB0aGUgZW5naW5lcyBtb2RlbC4gVGhpcyBjYW4gYmUgYW4gZXhpc3Rpbmcgb2JqZWN0OgogICAgCiAgICAgIGBgYAogICAgICA8ZGl2PgogICAgICAgIHt7bW91bnQgJ2FkbWluJyBtb2RlbD11c2VyU2V0dGluZ3N9fQogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgT3IgYW4gaW5saW5lIGBoYXNoYCwgYW5kIHlvdSBjYW4gZXZlbiBwYXNzIGNvbXBvbmVudHM6CiAgICAKICAgICAgYGBgCiAgICAgIDxkaXY+CiAgICAgICAgPGgxPkFwcGxpY2F0aW9uIHRlbXBsYXRlITwvaDE+CiAgICAgICAge3ttb3VudCAnYWRtaW4nIG1vZGVsPShoYXNoCiAgICAgICAgICAgIHRpdGxlPSdTZWNyZXQgQWRtaW4nCiAgICAgICAgICAgIHNpZ25JbkJ1dHRvbj0oY29tcG9uZW50ICdzaWduLWluLWJ1dHRvbicpCiAgICAgICAgKX19CiAgICAgIDwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIG1vdW50CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGVuZ2luZSB0byBtb3VudC4KICAgICAgQHBhcmFtIHtPYmplY3R9IFttb2RlbF0gT2JqZWN0IHRoYXQgd2lsbCBiZSBzZXQgYXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIG1vZGVsIG9mIHRoZSBlbmdpbmUuCiAgICAgIEBmb3IgRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnMKICAgICAgQGNhdGVnb3J5IGVtYmVyLWFwcGxpY2F0aW9uLWVuZ2luZXMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIG1vdW50TWFjcm8oX25hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcikgewogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICh0cnVlICYmICEocGFyYW1zLmxlbmd0aCA9PT0gMSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2FuIG9ubHkgcGFzcyBhIHNpbmdsZSBwb3NpdGlvbmFsIGFyZ3VtZW50IHRvIHRoZSB7e21vdW50fX0gaGVscGVyLCBlLmcuIHt7bW91bnQgImNoYXQtZW5naW5lIn19LicsIHBhcmFtcy5sZW5ndGggPT09IDEpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAodHJ1ZSAmJiAhKHBhcmFtcy5sZW5ndGggPT09IDEgJiYgaGFzaCA9PT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2FuIG9ubHkgcGFzcyBhIHNpbmdsZSBhcmd1bWVudCB0byB0aGUge3ttb3VudH19IGhlbHBlciwgZS5nLiB7e21vdW50ICJjaGF0LWVuZ2luZSJ9fS4nLCBwYXJhbXMubGVuZ3RoID09PSAxICYmIGhhc2ggPT09IG51bGwpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGV4cHIgPSBbX3dpcmVGb3JtYXQuT3BzLkhlbHBlciwgJy1tb3VudCcsIHBhcmFtcyB8fCBbXSwgaGFzaF07CiAgICAgICAgYnVpbGRlci5keW5hbWljQ29tcG9uZW50KGV4cHIsIG51bGwsIFtdLCBudWxsLCBmYWxzZSwgbnVsbCwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgdmFyIER5bmFtaWNFbmdpbmVSZWZlcmVuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gRHluYW1pY0VuZ2luZVJlZmVyZW5jZShuYW1lUmVmLCBlbnYsIG1vZGVsUmVmKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRHluYW1pY0VuZ2luZVJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLnRhZyA9IG5hbWVSZWYudGFnOwogICAgICAgICAgICB0aGlzLm5hbWVSZWYgPSBuYW1lUmVmOwogICAgICAgICAgICB0aGlzLm1vZGVsUmVmID0gbW9kZWxSZWY7CiAgICAgICAgICAgIHRoaXMuZW52ID0gZW52OwogICAgICAgICAgICB0aGlzLl9sYXN0TmFtZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2xhc3REZWYgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgRHluYW1pY0VuZ2luZVJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgdmFyIGVudiA9IHRoaXMuZW52LAogICAgICAgICAgICAgICAgbmFtZVJlZiA9IHRoaXMubmFtZVJlZiwKICAgICAgICAgICAgICAgIG1vZGVsUmVmID0gdGhpcy5tb2RlbFJlZjsKCiAgICAgICAgICAgIHZhciBuYW1lID0gbmFtZVJlZi52YWx1ZSgpOwogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbGFzdE5hbWUgPT09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fbGFzdERlZjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICh0cnVlICYmICEoZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbignZW5naW5lOicgKyBuYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgdXNlZCBge3ttb3VudCBcJycgKyBuYW1lICsgJ1wnfX1gLCBidXQgdGhlIGVuZ2luZSBcJycgKyBuYW1lICsgJ1wnIGNhbiBub3QgYmUgZm91bmQuJywgZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbignZW5naW5lOicgKyBuYW1lKSkpOwoKICAgICAgICAgICAgICAgIGlmICghZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbignZW5naW5lOicgKyBuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fbGFzdE5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgdGhpcy5fbGFzdERlZiA9ICgwLCBfcnVudGltZS5jdXJyeSkobmV3IE1vdW50RGVmaW5pdGlvbihuYW1lLCBtb2RlbFJlZikpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhc3REZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKG5hbWUgPT09IG51bGwgfHwgbmFtZSA9PT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0ludmFsaWQgZW5naW5lIG5hbWUgXCcnICsgbmFtZSArICdcJyBzcGVjaWZpZWQsIGVuZ2luZSBuYW1lIG11c3QgYmUgZWl0aGVyIGEgc3RyaW5nLCBudWxsIG9yIHVuZGVmaW5lZC4nLCBuYW1lID09PSBudWxsIHx8IG5hbWUgPT09IHVuZGVmaW5lZCkpOwoKICAgICAgICAgICAgICAgIHRoaXMuX2xhc3REZWYgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5fbGFzdE5hbWUgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBEeW5hbWljRW5naW5lUmVmZXJlbmNlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiBfcnVudGltZS5VTkRFRklORURfUkVGRVJFTkNFOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBEeW5hbWljRW5naW5lUmVmZXJlbmNlOwogICAgfSgpOwoKICAgIHZhciBSb290T3V0bGV0UmVmZXJlbmNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJvb3RPdXRsZXRSZWZlcmVuY2Uob3V0bGV0U3RhdGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBSb290T3V0bGV0UmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHRoaXMub3V0bGV0U3RhdGUgPSBvdXRsZXRTdGF0ZTsKICAgICAgICAgICAgdGhpcy50YWcgPSBfcmVmZXJlbmNlLkRpcnR5YWJsZVRhZy5jcmVhdGUoKTsKICAgICAgICB9CgogICAgICAgIFJvb3RPdXRsZXRSZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQYXRoUmVmZXJlbmNlKHRoaXMsIGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgUm9vdE91dGxldFJlZmVyZW5jZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub3V0bGV0U3RhdGU7CiAgICAgICAgfTsKCiAgICAgICAgUm9vdE91dGxldFJlZmVyZW5jZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKHN0YXRlKSB7CiAgICAgICAgICAgIHRoaXMub3V0bGV0U3RhdGUub3V0bGV0cy5tYWluID0gc3RhdGU7CiAgICAgICAgICAgIHRoaXMudGFnLmlubmVyLmRpcnR5KCk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIFJvb3RPdXRsZXRSZWZlcmVuY2U7CiAgICB9KCk7CgogICAgdmFyIE91dGxldFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBPdXRsZXRSZWZlcmVuY2UocGFyZW50U3RhdGVSZWYsIG91dGxldE5hbWVSZWYpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBPdXRsZXRSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdGhpcy5wYXJlbnRTdGF0ZVJlZiA9IHBhcmVudFN0YXRlUmVmOwogICAgICAgICAgICB0aGlzLm91dGxldE5hbWVSZWYgPSBvdXRsZXROYW1lUmVmOwogICAgICAgICAgICB0aGlzLnRhZyA9ICgwLCBfcmVmZXJlbmNlLmNvbWJpbmUpKFtwYXJlbnRTdGF0ZVJlZi50YWcsIG91dGxldE5hbWVSZWYudGFnXSk7CiAgICAgICAgfQoKICAgICAgICBPdXRsZXRSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciBvdXRsZXRTdGF0ZSA9IHRoaXMucGFyZW50U3RhdGVSZWYudmFsdWUoKTsKICAgICAgICAgICAgdmFyIG91dGxldHMgPSBvdXRsZXRTdGF0ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3V0bGV0U3RhdGUub3V0bGV0czsKICAgICAgICAgICAgcmV0dXJuIG91dGxldHMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG91dGxldHNbdGhpcy5vdXRsZXROYW1lUmVmLnZhbHVlKCldOwogICAgICAgIH07CgogICAgICAgIE91dGxldFJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhdGhSZWZlcmVuY2UodGhpcywga2V5KTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gT3V0bGV0UmVmZXJlbmNlOwogICAgfSgpOwoKICAgIHZhciBQYXRoUmVmZXJlbmNlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFBhdGhSZWZlcmVuY2UocGFyZW50LCBrZXkpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBQYXRoUmVmZXJlbmNlKTsKCiAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgICAgdGhpcy50YWcgPSBwYXJlbnQudGFnOwogICAgICAgIH0KCiAgICAgICAgUGF0aFJlZmVyZW5jZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhdGhSZWZlcmVuY2UodGhpcywga2V5KTsKICAgICAgICB9OwoKICAgICAgICBQYXRoUmVmZXJlbmNlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnQudmFsdWUoKTsKICAgICAgICAgICAgcmV0dXJuIHBhcmVudCAmJiBwYXJlbnRbdGhpcy5rZXldOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBQYXRoUmVmZXJlbmNlOwogICAgfSgpOwoKICAgIHZhciBPcnBoYW5lZE91dGxldFJlZmVyZW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBPcnBoYW5lZE91dGxldFJlZmVyZW5jZShyb290LCBuYW1lKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgT3JwaGFuZWRPdXRsZXRSZWZlcmVuY2UpOwoKICAgICAgICAgICAgdGhpcy5yb290ID0gcm9vdDsKICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgdGhpcy50YWcgPSByb290LnRhZzsKICAgICAgICB9CgogICAgICAgIE9ycGhhbmVkT3V0bGV0UmVmZXJlbmNlLnByb3RvdHlwZS52YWx1ZSA9IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgICB2YXIgcm9vdFN0YXRlID0gdGhpcy5yb290LnZhbHVlKCk7CiAgICAgICAgICAgIHZhciBvdXRsZXRTdGF0ZSA9IHJvb3RTdGF0ZSAmJiByb290U3RhdGUub3V0bGV0cy5tYWluOwogICAgICAgICAgICB2YXIgb3V0bGV0cyA9IG91dGxldFN0YXRlICYmIG91dGxldFN0YXRlLm91dGxldHM7CiAgICAgICAgICAgIG91dGxldFN0YXRlID0gb3V0bGV0cyAmJiBvdXRsZXRzLl9fZW1iZXJfb3JwaGFuc19fOwogICAgICAgICAgICBvdXRsZXRzID0gb3V0bGV0U3RhdGUgJiYgb3V0bGV0U3RhdGUub3V0bGV0czsKICAgICAgICAgICAgaWYgKG91dGxldHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtYXRjaGVkID0gb3V0bGV0c1t0aGlzLm5hbWVdOwogICAgICAgICAgICBpZiAobWF0Y2hlZCA9PT0gdW5kZWZpbmVkIHx8IG1hdGNoZWQucmVuZGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhdGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgICBzdGF0ZVttYXRjaGVkLnJlbmRlci5vdXRsZXRdID0gbWF0Y2hlZDsKICAgICAgICAgICAgbWF0Y2hlZC53YXNVc2VkID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHsgb3V0bGV0czogc3RhdGUsIHJlbmRlcjogdW5kZWZpbmVkIH07CiAgICAgICAgfTsKCiAgICAgICAgT3JwaGFuZWRPdXRsZXRSZWZlcmVuY2UucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQYXRoUmVmZXJlbmNlKHRoaXMsIGtleSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE9ycGhhbmVkT3V0bGV0UmVmZXJlbmNlOwogICAgfSgpOwoKICAgIC8qKgogICAgICBUaGUgYHt7b3V0bGV0fX1gIGhlbHBlciBsZXRzIHlvdSBzcGVjaWZ5IHdoZXJlIGEgY2hpbGQgcm91dGUgd2lsbCByZW5kZXIgaW4KICAgICAgeW91ciB0ZW1wbGF0ZS4gQW4gaW1wb3J0YW50IHVzZSBvZiB0aGUgYHt7b3V0bGV0fX1gIGhlbHBlciBpcyBpbiB5b3VyCiAgICAgIGFwcGxpY2F0aW9uJ3MgYGFwcGxpY2F0aW9uLmhic2AgZmlsZToKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7ISBhcHAvdGVtcGxhdGVzL2FwcGxpY2F0aW9uLmhicyB9fQogICAgICA8IS0tIGhlYWRlciBjb250ZW50IGdvZXMgaGVyZSwgYW5kIHdpbGwgYWx3YXlzIGRpc3BsYXkgLS0+CiAgICAgIHt7bXktaGVhZGVyfX0KICAgICAgPGRpdiBjbGFzcz0ibXktZHluYW1pYy1jb250ZW50Ij4KICAgICAgICA8IS0tIHRoaXMgY29udGVudCB3aWxsIGNoYW5nZSBiYXNlZCBvbiB0aGUgY3VycmVudCByb3V0ZSwgd2hpY2ggZGVwZW5kcyBvbiB0aGUgY3VycmVudCBVUkwgLS0+CiAgICAgICAge3tvdXRsZXR9fQogICAgICA8L2Rpdj4KICAgICAgPCEtLSBmb290ZXIgY29udGVudCBnb2VzIGhlcmUsIGFuZCB3aWxsIGFsd2F5cyBkaXNwbGF5IC0tPgogICAgICB7e215LWZvb3Rlcn19CiAgICAgIGBgYAogICAgCiAgICAgIFlvdSBtYXkgYWxzbyBzcGVjaWZ5IGEgbmFtZSBmb3IgdGhlIGB7e291dGxldH19YCwgd2hpY2ggaXMgdXNlZnVsIHdoZW4gdXNpbmcgbW9yZSB0aGFuIG9uZQogICAgICBge3tvdXRsZXR9fWAgaW4gYSB0ZW1wbGF0ZToKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7b3V0bGV0ICJtZW51In19CiAgICAgIHt7b3V0bGV0ICJzaWRlYmFyIn19CiAgICAgIHt7b3V0bGV0ICJtYWluIn19CiAgICAgIGBgYAogICAgCiAgICAgIFlvdXIgcm91dGVzIGNhbiB0aGVuIHJlbmRlciBpbnRvIGEgc3BlY2lmaWMgb25lIG9mIHRoZXNlIGBvdXRsZXRgcyBieSBzcGVjaWZ5aW5nIHRoZSBgb3V0bGV0YAogICAgICBhdHRyaWJ1dGUgaW4geW91ciBgcmVuZGVyVGVtcGxhdGVgIGZ1bmN0aW9uOgogICAgCiAgICAgIGBgYGFwcC9yb3V0ZXMvbWVudS5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgcmVuZGVyVGVtcGxhdGUoKSB7CiAgICAgICAgICB0aGlzLnJlbmRlcih7IG91dGxldDogJ21lbnUnIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIFNlZSB0aGUgW3JvdXRpbmcgZ3VpZGVdKGh0dHBzOi8vZ3VpZGVzLmVtYmVyanMuY29tL3JlbGVhc2Uvcm91dGluZy9yZW5kZXJpbmctYS10ZW1wbGF0ZS8pIGZvciBtb3JlCiAgICAgIGluZm9ybWF0aW9uIG9uIGhvdyB5b3VyIGByb3V0ZWAgaW50ZXJhY3RzIHdpdGggdGhlIGB7e291dGxldH19YCBoZWxwZXIuCiAgICAgIE5vdGU6IFlvdXIgY29udGVudCBfX3dpbGwgbm90IHJlbmRlcl9fIGlmIHRoZXJlIGlzbid0IGFuIGB7e291dGxldH19YCBmb3IgaXQuCiAgICAKICAgICAgQG1ldGhvZCBvdXRsZXQKICAgICAgQHBhcmFtIHtTdHJpbmd9IFtuYW1lXQogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBvdXRsZXRIZWxwZXIodm0sIGFyZ3MpIHsKICAgICAgICB2YXIgc2NvcGUgPSB2bS5keW5hbWljU2NvcGUoKTsKICAgICAgICB2YXIgbmFtZVJlZiA9IHZvaWQgMDsKICAgICAgICBpZiAoYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBuYW1lUmVmID0gbmV3IF9yZWZlcmVuY2UuQ29uc3RSZWZlcmVuY2UoJ21haW4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuYW1lUmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IE91dGxldENvbXBvbmVudFJlZmVyZW5jZShuZXcgT3V0bGV0UmVmZXJlbmNlKHNjb3BlLm91dGxldFN0YXRlLCBuYW1lUmVmKSk7CiAgICB9CiAgICBmdW5jdGlvbiBvdXRsZXRNYWNybyhfbmFtZSwgcGFyYW1zLCBoYXNoLCBidWlsZGVyKSB7CiAgICAgICAgdmFyIGV4cHIgPSBbX3dpcmVGb3JtYXQuT3BzLkhlbHBlciwgJy1vdXRsZXQnLCBwYXJhbXMgfHwgW10sIGhhc2hdOwogICAgICAgIGJ1aWxkZXIuZHluYW1pY0NvbXBvbmVudChleHByLCBudWxsLCBbXSwgbnVsbCwgZmFsc2UsIG51bGwsIG51bGwpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciBPdXRsZXRDb21wb25lbnRSZWZlcmVuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlKG91dGxldFJlZikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE91dGxldENvbXBvbmVudFJlZmVyZW5jZSk7CgogICAgICAgICAgICB0aGlzLm91dGxldFJlZiA9IG91dGxldFJlZjsKICAgICAgICAgICAgdGhpcy5kZWZpbml0aW9uID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5sYXN0U3RhdGUgPSBudWxsOwogICAgICAgICAgICAvLyBUaGUgcm91dGVyIGFsd2F5cyBkaXJ0aWVzIHRoZSByb290IHN0YXRlLgogICAgICAgICAgICB0aGlzLnRhZyA9IG91dGxldFJlZi50YWc7CiAgICAgICAgfQoKICAgICAgICBPdXRsZXRDb21wb25lbnRSZWZlcmVuY2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgIHZhciBzdGF0ZSA9IHN0YXRlRm9yKHRoaXMub3V0bGV0UmVmKTsKICAgICAgICAgICAgaWYgKHZhbGlkYXRlKHN0YXRlLCB0aGlzLmxhc3RTdGF0ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRlZmluaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sYXN0U3RhdGUgPSBzdGF0ZTsKICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSBudWxsOwogICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlZmluaXRpb24gPSAoMCwgX3J1bnRpbWUuY3VycnkpKG5ldyBPdXRsZXRDb21wb25lbnREZWZpbml0aW9uKHN0YXRlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVmaW5pdGlvbiA9IGRlZmluaXRpb247CiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoX2tleSkgewogICAgICAgICAgICByZXR1cm4gX3J1bnRpbWUuVU5ERUZJTkVEX1JFRkVSRU5DRTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gT3V0bGV0Q29tcG9uZW50UmVmZXJlbmNlOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIHN0YXRlRm9yKHJlZikgewogICAgICAgIHZhciBvdXRsZXQgPSByZWYudmFsdWUoKTsKICAgICAgICBpZiAob3V0bGV0ID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICAgIHZhciByZW5kZXIgPSBvdXRsZXQucmVuZGVyOwogICAgICAgIGlmIChyZW5kZXIgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIHRlbXBsYXRlID0gcmVuZGVyLnRlbXBsYXRlOwogICAgICAgIGlmICh0ZW1wbGF0ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICByZWY6IHJlZiwKICAgICAgICAgICAgbmFtZTogcmVuZGVyLm5hbWUsCiAgICAgICAgICAgIG91dGxldDogcmVuZGVyLm91dGxldCwKICAgICAgICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlLAogICAgICAgICAgICBjb250cm9sbGVyOiByZW5kZXIuY29udHJvbGxlcgogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB2YWxpZGF0ZShzdGF0ZSwgbGFzdFN0YXRlKSB7CiAgICAgICAgaWYgKHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBsYXN0U3RhdGUgPT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmIChsYXN0U3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhdGUudGVtcGxhdGUgPT09IGxhc3RTdGF0ZS50ZW1wbGF0ZSAmJiBzdGF0ZS5jb250cm9sbGVyID09PSBsYXN0U3RhdGUuY29udHJvbGxlcjsKICAgIH0KCiAgICB2YXIgTk9OX1NJTkdMRVRPTl9SRU5ERVJfTUFOQUdFUiA9IHZvaWQgMDsKICAgIHZhciBTSU5HTEVUT05fUkVOREVSX01BTkFHRVIgPSB2b2lkIDA7CiAgICB2YXIgUmVuZGVyRGVmaW5pdGlvbiA9IHZvaWQgMDsKICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLlJFTkRFUl9IRUxQRVIpIHsKICAgICAgICB2YXIgQWJzdHJhY3RSZW5kZXJNYW5hZ2VyID0gZnVuY3Rpb24gKF9BYnN0cmFjdE1hbmFnZXI1KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQWJzdHJhY3RSZW5kZXJNYW5hZ2VyLCBfQWJzdHJhY3RNYW5hZ2VyNSk7CgogICAgICAgICAgICBmdW5jdGlvbiBBYnN0cmFjdFJlbmRlck1hbmFnZXIoKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFic3RyYWN0UmVuZGVyTWFuYWdlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9BYnN0cmFjdE1hbmFnZXI1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBBYnN0cmFjdFJlbmRlck1hbmFnZXIucHJvdG90eXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShlbnYsIGRlZmluaXRpb24sIGFyZ3MsIGR5bmFtaWNTY29wZSkgewogICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBkZWZpbml0aW9uLm5hbWU7CgogICAgICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wdXNoVG9EZWJ1Z1N0YWNrKCdjb250cm9sbGVyOicgKyBuYW1lICsgJyAod2l0aCB0aGUgcmVuZGVyIGhlbHBlciknLCBlbnYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNTY29wZS5yb290T3V0bGV0U3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICBkeW5hbWljU2NvcGUub3V0bGV0U3RhdGUgPSBuZXcgT3JwaGFuZWRPdXRsZXRSZWZlcmVuY2UoZHluYW1pY1Njb3BlLnJvb3RPdXRsZXRTdGF0ZSwgbmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVSZW5kZXJTdGF0ZShhcmdzLCBlbnYub3duZXIsIG5hbWUpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgQWJzdHJhY3RSZW5kZXJNYW5hZ2VyLnByb3RvdHlwZS5nZXRMYXlvdXQgPSBmdW5jdGlvbiBnZXRMYXlvdXQoX3JlZjIzKSB7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBfcmVmMjMudGVtcGxhdGU7CgogICAgICAgICAgICAgICAgdmFyIGxheW91dCA9IHRlbXBsYXRlLmFzTGF5b3V0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoKSwKICAgICAgICAgICAgICAgICAgICBzeW1ib2xUYWJsZTogbGF5b3V0LnN5bWJvbFRhYmxlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgQWJzdHJhY3RSZW5kZXJNYW5hZ2VyLnByb3RvdHlwZS5nZXRTZWxmID0gZnVuY3Rpb24gZ2V0U2VsZihfcmVmMjQpIHsKICAgICAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gX3JlZjI0LmNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSb290UmVmZXJlbmNlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIEFic3RyYWN0UmVuZGVyTWFuYWdlcjsKICAgICAgICB9KEFic3RyYWN0TWFuYWdlcik7CgogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIEFic3RyYWN0UmVuZGVyTWFuYWdlci5wcm90b3R5cGUuZGlkUmVuZGVyTGF5b3V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrLnBvcCgpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgX0NBUEFCSUxJVElFUyA9IHsKICAgICAgICAgICAgZHluYW1pY0xheW91dDogZmFsc2UsCiAgICAgICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgICAgICBwcmVwYXJlQXJnczogZmFsc2UsCiAgICAgICAgICAgIGNyZWF0ZUFyZ3M6IGZhbHNlLAogICAgICAgICAgICBhdHRyaWJ1dGVIb29rOiBmYWxzZSwKICAgICAgICAgICAgZWxlbWVudEhvb2s6IGZhbHNlLAogICAgICAgICAgICBjcmVhdGVDYWxsZXI6IHRydWUsCiAgICAgICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICAgICAgdXBkYXRlSG9vazogdHJ1ZSwKICAgICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IHRydWUKICAgICAgICB9OwoKICAgICAgICB2YXIgU2luZ2xldG9uUmVuZGVyTWFuYWdlciA9IGZ1bmN0aW9uIChfQWJzdHJhY3RSZW5kZXJNYW5hZ2UpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShTaW5nbGV0b25SZW5kZXJNYW5hZ2VyLCBfQWJzdHJhY3RSZW5kZXJNYW5hZ2UpOwoKICAgICAgICAgICAgZnVuY3Rpb24gU2luZ2xldG9uUmVuZGVyTWFuYWdlcigpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgU2luZ2xldG9uUmVuZGVyTWFuYWdlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9BYnN0cmFjdFJlbmRlck1hbmFnZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgU2luZ2xldG9uUmVuZGVyTWFuYWdlci5wcm90b3R5cGUuY3JlYXRlUmVuZGVyU3RhdGUgPSBmdW5jdGlvbiBjcmVhdGVSZW5kZXJTdGF0ZShfYXJncywgb3duZXIsIG5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gb3duZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBuYW1lKSB8fCAoMCwgX2VtYmVyUm91dGluZy5nZW5lcmF0ZUNvbnRyb2xsZXIpKG93bmVyLCBuYW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiB7IGNvbnRyb2xsZXI6IGNvbnRyb2xsZXIgfTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFNpbmdsZXRvblJlbmRlck1hbmFnZXIucHJvdG90eXBlLmdldENhcGFiaWxpdGllcyA9IGZ1bmN0aW9uIGdldENhcGFiaWxpdGllcyhfKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX0NBUEFCSUxJVElFUzsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFNpbmdsZXRvblJlbmRlck1hbmFnZXIucHJvdG90eXBlLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZygpIHsKICAgICAgICAgICAgICAgIC8vIHRvZG8gdGhpcyBzaG91bGQgYmUgdGhlIHRhZyBvZiB0aGUgc3RhdGUgYXJncwogICAgICAgICAgICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgU2luZ2xldG9uUmVuZGVyTWFuYWdlci5wcm90b3R5cGUuZ2V0RGVzdHJ1Y3RvciA9IGZ1bmN0aW9uIGdldERlc3RydWN0b3IoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBTaW5nbGV0b25SZW5kZXJNYW5hZ2VyOwogICAgICAgIH0oQWJzdHJhY3RSZW5kZXJNYW5hZ2VyKTsKCiAgICAgICAgU0lOR0xFVE9OX1JFTkRFUl9NQU5BR0VSID0gbmV3IFNpbmdsZXRvblJlbmRlck1hbmFnZXIoKTsKICAgICAgICB2YXIgTk9OU0lOR0xFVE9OX0NBUEFCSUxJVElFUyA9IHsKICAgICAgICAgICAgZHluYW1pY0xheW91dDogZmFsc2UsCiAgICAgICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgICAgICBwcmVwYXJlQXJnczogZmFsc2UsCiAgICAgICAgICAgIGNyZWF0ZUFyZ3M6IHRydWUsCiAgICAgICAgICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgICAgICAgICBlbGVtZW50SG9vazogZmFsc2UsCiAgICAgICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICAgICAgY3JlYXRlQ2FsbGVyOiBmYWxzZSwKICAgICAgICAgICAgdXBkYXRlSG9vazogdHJ1ZSwKICAgICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IHRydWUKICAgICAgICB9OwoKICAgICAgICB2YXIgTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlciA9IGZ1bmN0aW9uIChfQWJzdHJhY3RSZW5kZXJNYW5hZ2UyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlciwgX0Fic3RyYWN0UmVuZGVyTWFuYWdlMik7CgogICAgICAgICAgICBmdW5jdGlvbiBOb25TaW5nbGV0b25SZW5kZXJNYW5hZ2VyKCkgewogICAgICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBOb25TaW5nbGV0b25SZW5kZXJNYW5hZ2VyKTsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0Fic3RyYWN0UmVuZGVyTWFuYWdlMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlci5wcm90b3R5cGUuY3JlYXRlUmVuZGVyU3RhdGUgPSBmdW5jdGlvbiBjcmVhdGVSZW5kZXJTdGF0ZShhcmdzLCBvd25lciwgbmFtZSkgewogICAgICAgICAgICAgICAgdmFyIG1vZGVsID0gYXJncy5wb3NpdGlvbmFsLmF0KDEpOwogICAgICAgICAgICAgICAgdmFyIGZhY3RvcnkgPSBvd25lci5mYWN0b3J5Rm9yKCdjb250cm9sbGVyOicgKyBuYW1lKSB8fCAoMCwgX2VtYmVyUm91dGluZy5nZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5KShvd25lciwgJ2NvbnRyb2xsZXI6JyArIG5hbWUpOwogICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSBmYWN0b3J5LmNyZWF0ZSh7IG1vZGVsOiBtb2RlbC52YWx1ZSgpIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHsgY29udHJvbGxlcjogY29udHJvbGxlciwgbW9kZWw6IG1vZGVsIH07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBOb25TaW5nbGV0b25SZW5kZXJNYW5hZ2VyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoX3JlZjI1KSB7CiAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9IF9yZWYyNS5jb250cm9sbGVyLAogICAgICAgICAgICAgICAgICAgIG1vZGVsID0gX3JlZjI1Lm1vZGVsOwoKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuc2V0KCdtb2RlbCcsIG1vZGVsLnZhbHVlKCkpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlci5wcm90b3R5cGUuZ2V0Q2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKF8pIHsKICAgICAgICAgICAgICAgIHJldHVybiBOT05TSU5HTEVUT05fQ0FQQUJJTElUSUVTOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlci5wcm90b3R5cGUuZ2V0VGFnID0gZnVuY3Rpb24gZ2V0VGFnKF9yZWYyNikgewogICAgICAgICAgICAgICAgdmFyIG1vZGVsID0gX3JlZjI2Lm1vZGVsOwoKICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbC50YWc7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBOb25TaW5nbGV0b25SZW5kZXJNYW5hZ2VyLnByb3RvdHlwZS5nZXREZXN0cnVjdG9yID0gZnVuY3Rpb24gZ2V0RGVzdHJ1Y3RvcihfcmVmMjcpIHsKICAgICAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gX3JlZjI3LmNvbnRyb2xsZXI7CgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlcjsKICAgICAgICB9KEFic3RyYWN0UmVuZGVyTWFuYWdlcik7CgogICAgICAgIE5PTl9TSU5HTEVUT05fUkVOREVSX01BTkFHRVIgPSBuZXcgTm9uU2luZ2xldG9uUmVuZGVyTWFuYWdlcigpOwogICAgICAgIFJlbmRlckRlZmluaXRpb24gPSBmdW5jdGlvbiBSZW5kZXJEZWZpbml0aW9uKG5hbWUsIHRlbXBsYXRlLCBtYW5hZ2VyKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVuZGVyRGVmaW5pdGlvbik7CgogICAgICAgICAgICB0aGlzLm1hbmFnZXIgPSBtYW5hZ2VyOwogICAgICAgICAgICB0aGlzLnN0YXRlID0gewogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIHZhciByZW5kZXJIZWxwZXIgPSB2b2lkIDA7CiAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5SRU5ERVJfSEVMUEVSKSB7CiAgICAgICAgcmVuZGVySGVscGVyID0gZnVuY3Rpb24gcmVuZGVySGVscGVyKHZtLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBlbnYgPSB2bS5lbnY7CiAgICAgICAgICAgIHZhciBuYW1lUmVmID0gYXJncy5wb3NpdGlvbmFsLmF0KDApOwogICAgICAgICAgICAodHJ1ZSAmJiAhKCgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKG5hbWVSZWYpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBmaXJzdCBhcmd1bWVudCBvZiB7e3JlbmRlcn19IG11c3QgYmUgcXVvdGVkLCBlLmcuIHt7cmVuZGVyICJzaWRlYmFyIn19LicsICgwLCBfcmVmZXJlbmNlLmlzQ29uc3QpKG5hbWVSZWYpKSk7CiAgICAgICAgICAgICh0cnVlICYmICEoYXJncy5wb3NpdGlvbmFsLmxlbmd0aCA9PT0gMSB8fCAhKDAsIF9yZWZlcmVuY2UuaXNDb25zdCkoYXJncy5wb3NpdGlvbmFsLmF0KDEpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgc2Vjb25kIGFyZ3VtZW50IG9mIHt7cmVuZGVyfX0gbXVzdCBiZSBhIHBhdGgsIGUuZy4ge3tyZW5kZXIgInBvc3QiIHBvc3R9fS4nLCBhcmdzLnBvc2l0aW9uYWwubGVuZ3RoID09PSAxIHx8ICEoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShhcmdzLnBvc2l0aW9uYWwuYXQoMSkpKSk7CgogICAgICAgICAgICB2YXIgdGVtcGxhdGVOYW1lID0gbmFtZVJlZi52YWx1ZSgpOwogICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAgICAgICAgICh0cnVlICYmICEoZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbigndGVtcGxhdGU6JyArIHRlbXBsYXRlTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHVzZWQgYHt7cmVuZGVyIFwnJyArIHRlbXBsYXRlTmFtZSArICdcJ319YCwgYnV0IFwnJyArIHRlbXBsYXRlTmFtZSArICdcJyBjYW4gbm90IGJlIGZvdW5kIGFzIGEgdGVtcGxhdGUuJywgZW52Lm93bmVyLmhhc1JlZ2lzdHJhdGlvbigndGVtcGxhdGU6JyArIHRlbXBsYXRlTmFtZSkpKTsKCiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGVudi5vd25lci5sb29rdXAoJ3RlbXBsYXRlOicgKyB0ZW1wbGF0ZU5hbWUpOwogICAgICAgICAgICB2YXIgY29udHJvbGxlck5hbWUgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChhcmdzLm5hbWVkLmhhcygnY29udHJvbGxlcicpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlck5hbWVSZWYgPSBhcmdzLm5hbWVkLmdldCgnY29udHJvbGxlcicpOwogICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aAogICAgICAgICAgICAgICAgKHRydWUgJiYgISgoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShjb250cm9sbGVyTmFtZVJlZikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGNvbnRyb2xsZXIgYXJndW1lbnQgZm9yIHt7cmVuZGVyfX0gbXVzdCBiZSBxdW90ZWQsIGUuZy4ge3tyZW5kZXIgInNpZGViYXIiIGNvbnRyb2xsZXI9ImZvbyJ9fS4nLCAoMCwgX3JlZmVyZW5jZS5pc0NvbnN0KShjb250cm9sbGVyTmFtZVJlZikpKTsKCiAgICAgICAgICAgICAgICAvLyBUT0RPIHNob3VsZCBiZSBlbnN1cmluZyB0aGlzIHRvIHN0cmluZyBoZXJlCiAgICAgICAgICAgICAgICBjb250cm9sbGVyTmFtZSA9IGNvbnRyb2xsZXJOYW1lUmVmLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGVudi5vd25lci5oYXNSZWdpc3RyYXRpb24oJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgY29udHJvbGxlciBuYW1lIHlvdSBzdXBwbGllZCBcJycgKyBjb250cm9sbGVyTmFtZSArICdcJyBkaWQgbm90IHJlc29sdmUgdG8gYSBjb250cm9sbGVyLicsIGVudi5vd25lci5oYXNSZWdpc3RyYXRpb24oJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lKSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udHJvbGxlck5hbWUgPSB0ZW1wbGF0ZU5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFyZ3MucG9zaXRpb25hbC5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciBkZWYgPSBuZXcgUmVuZGVyRGVmaW5pdGlvbihjb250cm9sbGVyTmFtZSwgdGVtcGxhdGUsIFNJTkdMRVRPTl9SRU5ERVJfTUFOQUdFUik7CiAgICAgICAgICAgICAgICByZXR1cm4gVW5ib3VuZFJlZmVyZW5jZS5jcmVhdGUoKDAsIF9ydW50aW1lLmN1cnJ5KShkZWYpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfZGVmID0gbmV3IFJlbmRlckRlZmluaXRpb24oY29udHJvbGxlck5hbWUsIHRlbXBsYXRlLCBOT05fU0lOR0xFVE9OX1JFTkRFUl9NQU5BR0VSKTsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlZCA9IGFyZ3MuY2FwdHVyZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIFVuYm91bmRSZWZlcmVuY2UuY3JlYXRlKCgwLCBfcnVudGltZS5jdXJyeSkoX2RlZiwgY2FwdHVyZWQpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAgQ2FsbGluZyBgYHt7cmVuZGVyfX1gYCBmcm9tIHdpdGhpbiBhIHRlbXBsYXRlIHdpbGwgaW5zZXJ0IGFub3RoZXIKICAgICAgdGVtcGxhdGUgdGhhdCBtYXRjaGVzIHRoZSBwcm92aWRlZCBuYW1lLiBUaGUgaW5zZXJ0ZWQgdGVtcGxhdGUgd2lsbAogICAgICBhY2Nlc3MgaXRzIHByb3BlcnRpZXMgb24gaXRzIG93biBjb250cm9sbGVyIChyYXRoZXIgdGhhbiB0aGUgY29udHJvbGxlcgogICAgICBvZiB0aGUgcGFyZW50IHRlbXBsYXRlKS4KICAgIAogICAgICBJZiBhIHZpZXcgY2xhc3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGV4aXN0cywgdGhlIHZpZXcgY2xhc3MgYWxzbyB3aWxsIGJlIHVzZWQuCiAgICAgIE5vdGU6IEEgZ2l2ZW4gY29udHJvbGxlciBtYXkgb25seSBiZSB1c2VkICpvbmNlKiBpbiB5b3VyIGFwcCBpbiB0aGlzIG1hbm5lci4KICAgICAgQSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhlIGNvbnRyb2xsZXIgd2lsbCBiZSBjcmVhdGVkIGZvciB5b3UuCiAgICAKICAgICAgRXhhbXBsZToKICAgIAogICAgICBgYGBhcHAvY29udHJvbGxlcnMvbmF2aWdhdGlvbi5qcwogICAgICBpbXBvcnQgQ29udHJvbGxlciBmcm9tICdAZW1iZXIvY29udHJvbGxlcic7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgQ29udHJvbGxlci5leHRlbmQoewogICAgICAgIHdobzogIndvcmxkIgogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICA8IS0tIG5hdmlnYXRpb24uaGJzIC0tPgogICAgICBIZWxsbywge3t3aG99fS4KICAgICAgYGBgCiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICA8IS0tIGFwcGxpY2F0aW9uLmhicyAtLT4KICAgICAgPGgxPk15IGdyZWF0IGFwcDwvaDE+CiAgICAgIHt7cmVuZGVyICJuYXZpZ2F0aW9uIn19CiAgICAgIGBgYAogICAgCiAgICAgIGBgYGh0bWwKICAgICAgPGgxPk15IGdyZWF0IGFwcDwvaDE+CiAgICAgIDxkaXYgY2xhc3M9J2VtYmVyLXZpZXcnPgogICAgICAgIEhlbGxvLCB3b3JsZC4KICAgICAgPC9kaXY+CiAgICAgIGBgYAogICAgCiAgICAgIE9wdGlvbmFsbHkgeW91IG1heSBwcm92aWRlIGEgc2Vjb25kIGFyZ3VtZW50OiBhIHByb3BlcnR5IHBhdGgKICAgICAgdGhhdCB3aWxsIGJlIGJvdW5kIHRvIHRoZSBgbW9kZWxgIHByb3BlcnR5IG9mIHRoZSBjb250cm9sbGVyLgogICAgICBJZiBhIGBtb2RlbGAgcHJvcGVydHkgcGF0aCBpcyBzcGVjaWZpZWQsIHRoZW4gYSBuZXcgaW5zdGFuY2Ugb2YgdGhlCiAgICAgIGNvbnRyb2xsZXIgd2lsbCBiZSBjcmVhdGVkIGFuZCBge3tyZW5kZXJ9fWAgY2FuIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMKICAgICAgd2l0aCB0aGUgc2FtZSBuYW1lLgogICAgCiAgICAgIEZvciBleGFtcGxlIGlmIHlvdSBoYWQgdGhpcyBgYXV0aG9yYCB0ZW1wbGF0ZS4KICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIDxkaXYgY2xhc3M9ImF1dGhvciI+CiAgICAgICAgV3JpdHRlbiBieSB7e2ZpcnN0TmFtZX19IHt7bGFzdE5hbWV9fS4KICAgICAgICBUb3RhbCBQb3N0czoge3twb3N0Q291bnR9fQogICAgICA8L2Rpdj4KICAgICAgYGBgCiAgICAKICAgICAgWW91IGNvdWxkIHJlbmRlciBpdCBpbnNpZGUgdGhlIGBwb3N0YCB0ZW1wbGF0ZSB1c2luZyB0aGUgYHJlbmRlcmAgaGVscGVyLgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgPGRpdiBjbGFzcz0icG9zdCI+CiAgICAgICAgPGgxPnt7dGl0bGV9fTwvaDE+CiAgICAgICAgPGRpdj57e2JvZHl9fTwvZGl2PgogICAgICAgIHt7cmVuZGVyICJhdXRob3IiIGF1dGhvcn19CiAgICAgIDwvZGl2PgogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIHJlbmRlcgogICAgICBAZm9yIEVtYmVyLlRlbXBsYXRlcy5oZWxwZXJzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgICAgIEBwYXJhbSB7T2JqZWN0P30gY29udGV4dAogICAgICBAcGFyYW0ge0hhc2h9IG9wdGlvbnMKICAgICAgQHJldHVybiB7U3RyaW5nfSBIVE1MIHN0cmluZwogICAgICBAcHVibGljCiAgICAgIEBkZXByZWNhdGVkIFVzZSBhIGNvbXBvbmVudCBpbnN0ZWFkCiAgICAqLwogICAgdmFyIHJlbmRlck1hY3JvID0gdm9pZCAwOwogICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUkVOREVSX0hFTFBFUikgewogICAgICAgIHJlbmRlck1hY3JvID0gZnVuY3Rpb24gcmVuZGVyTWFjcm8oX25hbWUsIHBhcmFtcywgaGFzaCwgYnVpbGRlcikgewogICAgICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5SRU5ERVJfSEVMUEVSICYmIF9lbWJlckVudmlyb25tZW50LkVOVi5fRU5BQkxFX1JFTkRFUl9TVVBQT1JUID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAvLyBUT0RPIG5lZWRzIG1ha2VDb21wb25lbnREZWZpbml0aW9uIGEgaGVscGVyIHRoYXQgcmV0dXJucyBhIGN1cnJpZWQgZGVmaW5pdGlvbgogICAgICAgICAgICAgICAgLy8gVE9ETyBub3Qgc3VyZSBhbGwgYXJncyBhcmUgZm9yIGRlZmluaXRpb24gb3IgY29tcG9uZW50CiAgICAgICAgICAgICAgICAvLyBsaWtlbHkgdGhlIGNvbnRyb2xsZXIgbmFtZSBzaG91bGQgYmUgYSBhcmcgdG8gY3JlYXRlPwogICAgICAgICAgICAgICAgdmFyIGV4cHIgPSBbX3dpcmVGb3JtYXQuT3BzLkhlbHBlciwgJy1yZW5kZXInLCBwYXJhbXMgfHwgW10sIGhhc2hdOwogICAgICAgICAgICAgICAgYnVpbGRlci5keW5hbWljQ29tcG9uZW50KGV4cHIsIG51bGwsIG51bGwsIG51bGwsIGZhbHNlLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZmluZUlubGluZVN5bnRheChuYW1lLCBwYXJhbXMsIGhhc2gsIGJ1aWxkZXIpIHsKICAgICAgICAodHJ1ZSAmJiAhKCEoYnVpbGRlci5jb21waWxlclsncmVzb2x2ZXInXVsncmVzb2x2ZXInXVsnYnVpbHRJbkhlbHBlcnMnXVtuYW1lXSAmJiBidWlsZGVyLnJlZmVycmVyLm93bmVyLmhhc1JlZ2lzdHJhdGlvbignaGVscGVyOicgKyBuYW1lKSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byBvdmVyd3JpdGUgdGhlIGJ1aWx0LWluIGhlbHBlciAiJyArIG5hbWUgKyAnIiB3aGljaCBpcyBub3QgYWxsb3dlZC4gUGxlYXNlIHJlbmFtZSB0aGUgaGVscGVyLicsICEoYnVpbGRlci5jb21waWxlclsncmVzb2x2ZXInXVsncmVzb2x2ZXInXVsnYnVpbHRJbkhlbHBlcnMnXVtuYW1lXSAmJiBidWlsZGVyLnJlZmVycmVyLm93bmVyLmhhc1JlZ2lzdHJhdGlvbignaGVscGVyOicgKyBuYW1lKSkpKTsKCiAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignLScpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYW5kbGUgPSBidWlsZGVyLmNvbXBpbGVyWydyZXNvbHZlciddLmxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgYnVpbGRlci5yZWZlcnJlcik7CiAgICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkgewogICAgICAgICAgICBidWlsZGVyLmNvbXBvbmVudC5zdGF0aWMoaGFuZGxlLCBbcGFyYW1zID09PSBudWxsID8gW10gOiBwYXJhbXMsIGhhc2hUb0FyZ3MoaGFzaCksIG51bGwsIG51bGxdKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlZmluZUJsb2NrU3ludGF4KG5hbWUsIHBhcmFtcywgaGFzaCwgdGVtcGxhdGUsIGludmVyc2UsIGJ1aWxkZXIpIHsKICAgICAgICBpZiAobmFtZS5pbmRleE9mKCctJykgPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhbmRsZSA9IGJ1aWxkZXIuY29tcGlsZXJbJ3Jlc29sdmVyJ10ubG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBidWlsZGVyLnJlZmVycmVyKTsKICAgICAgICBpZiAoaGFuZGxlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHdyYXBDb21wb25lbnRDbGFzc0F0dHJpYnV0ZShoYXNoKTsKICAgICAgICAgICAgYnVpbGRlci5jb21wb25lbnQuc3RhdGljKGhhbmRsZSwgW3BhcmFtcywgaGFzaFRvQXJncyhoYXNoKSwgdGVtcGxhdGUsIGludmVyc2VdKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgICh0cnVlICYmICEoYnVpbGRlci5yZWZlcnJlci5vd25lci5oYXNSZWdpc3RyYXRpb24oJ2hlbHBlcjonICsgbmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQSBjb21wb25lbnQgb3IgaGVscGVyIG5hbWVkICInICsgbmFtZSArICciIGNvdWxkIG5vdCBiZSBmb3VuZCcsIGJ1aWxkZXIucmVmZXJyZXIub3duZXIuaGFzUmVnaXN0cmF0aW9uKCdoZWxwZXI6JyArIG5hbWUpKSk7CiAgICAgICAgKHRydWUgJiYgISghZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcmVzb2x2ZXIgPSBidWlsZGVyLmNvbXBpbGVyWydyZXNvbHZlciddWydyZXNvbHZlciddOwogICAgICAgICAgICB2YXIgX2J1aWxkZXIkcmVmZXJyZXIgPSBidWlsZGVyLnJlZmVycmVyLAogICAgICAgICAgICAgICAgb3duZXIgPSBfYnVpbGRlciRyZWZlcnJlci5vd25lciwKICAgICAgICAgICAgICAgIG1vZHVsZU5hbWUgPSBfYnVpbGRlciRyZWZlcnJlci5tb2R1bGVOYW1lOwoKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjb21wb25lbnQnIHx8IHJlc29sdmVyWydidWlsdEluSGVscGVycyddW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHsgc291cmNlOiAndGVtcGxhdGU6JyArIG1vZHVsZU5hbWUgfTsKICAgICAgICAgICAgcmV0dXJuIG93bmVyLmhhc1JlZ2lzdHJhdGlvbignaGVscGVyOicgKyBuYW1lLCBvcHRpb25zKSB8fCBvd25lci5oYXNSZWdpc3RyYXRpb24oJ2hlbHBlcjonICsgbmFtZSk7CiAgICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0hlbHBlcnMgbWF5IG5vdCBiZSB1c2VkIGluIHRoZSBibG9jayBmb3JtLCBmb3IgZXhhbXBsZSB7eyMnICsgbmFtZSArICd9fXt7LycgKyBuYW1lICsgJ319LiBQbGVhc2UgdXNlIGEgY29tcG9uZW50LCBvciBhbHRlcm5hdGl2ZWx5IHVzZSB0aGUgaGVscGVyIGluIGNvbWJpbmF0aW9uIHdpdGggYSBidWlsdC1pbiBFbWJlciBoZWxwZXIsIGZvciBleGFtcGxlIHt7I2lmICgnICsgbmFtZSArICcpfX17ey9pZn19LicsICFmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciByZXNvbHZlciA9IGJ1aWxkZXIuY29tcGlsZXJbJ3Jlc29sdmVyJ11bJ3Jlc29sdmVyJ107dmFyIF9idWlsZGVyJHJlZmVycmVyID0gYnVpbGRlci5yZWZlcnJlciwKICAgICAgICAgICAgICAgIG93bmVyID0gX2J1aWxkZXIkcmVmZXJyZXIub3duZXIsCiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gX2J1aWxkZXIkcmVmZXJyZXIubW9kdWxlTmFtZTsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdjb21wb25lbnQnIHx8IHJlc29sdmVyWydidWlsdEluSGVscGVycyddW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfXZhciBvcHRpb25zID0geyBzb3VyY2U6ICd0ZW1wbGF0ZTonICsgbW9kdWxlTmFtZSB9O3JldHVybiBvd25lci5oYXNSZWdpc3RyYXRpb24oJ2hlbHBlcjonICsgbmFtZSwgb3B0aW9ucykgfHwgb3duZXIuaGFzUmVnaXN0cmF0aW9uKCdoZWxwZXI6JyArIG5hbWUpOwogICAgICAgIH0oKSkpOwoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgZXhwZXJpbWVudGFsTWFjcm9zID0gW107CiAgICAvLyBUaGlzIGlzIGEgcHJpdmF0ZSBBUEkgdG8gYWxsb3cgZm9yIGV4cGVyaW1lbnRhbCBtYWNyb3MKICAgIC8vIHRvIGJlIGNyZWF0ZWQgaW4gdXNlciBzcGFjZS4gUmVnaXN0ZXJpbmcgYSBtYWNybyBzaG91bGQKICAgIC8vIHNob3VsZCBiZSBkb25lIGluIGFuIGluaXRpYWxpemVyLgogICAgZnVuY3Rpb24gcmVnaXN0ZXJNYWNyb3MobWFjcm8pIHsKICAgICAgICBleHBlcmltZW50YWxNYWNyb3MucHVzaChtYWNybyk7CiAgICB9CiAgICBmdW5jdGlvbiBwb3B1bGF0ZU1hY3JvcyhtYWNyb3MpIHsKICAgICAgICB2YXIgaW5saW5lcyA9IG1hY3Jvcy5pbmxpbmVzLAogICAgICAgICAgICBibG9ja3MgPSBtYWNyb3MuYmxvY2tzOwoKICAgICAgICBpbmxpbmVzLmFkZCgnb3V0bGV0Jywgb3V0bGV0TWFjcm8pOwogICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLlJFTkRFUl9IRUxQRVIpIHsKICAgICAgICAgICAgaW5saW5lcy5hZGQoJ3JlbmRlcicsIHJlbmRlck1hY3JvKTsKICAgICAgICB9CiAgICAgICAgaW5saW5lcy5hZGQoJ21vdW50JywgbW91bnRNYWNybyk7CiAgICAgICAgaW5saW5lcy5hZGQoJ2lucHV0JywgaW5wdXRNYWNybyk7CiAgICAgICAgaW5saW5lcy5hZGQoJ3RleHRhcmVhJywgdGV4dEFyZWFNYWNybyk7CiAgICAgICAgaW5saW5lcy5hZGRNaXNzaW5nKHJlZmluZUlubGluZVN5bnRheCk7CiAgICAgICAgaWYgKHRydWUgPT09IHRydWUpIHsKICAgICAgICAgICAgYmxvY2tzLmFkZCgnbGV0JywgYmxvY2tMZXRNYWNybyk7CiAgICAgICAgfQogICAgICAgIGJsb2Nrcy5hZGRNaXNzaW5nKHJlZmluZUJsb2NrU3ludGF4KTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV4cGVyaW1lbnRhbE1hY3Jvcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgbWFjcm8gPSBleHBlcmltZW50YWxNYWNyb3NbaV07CiAgICAgICAgICAgIG1hY3JvKGJsb2NrcywgaW5saW5lcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7IGJsb2NrczogYmxvY2tzLCBpbmxpbmVzOiBpbmxpbmVzIH07CiAgICB9CgogICAgLyoqCiAgICAgIFRoZSBDdXN0b21Db21wb25lbnRNYW5hZ2VyIGFsbG93cyBhZGRvbnMgdG8gcHJvdmlkZSBjdXN0b20gY29tcG9uZW50CiAgICAgIGltcGxlbWVudGF0aW9ucyB0aGF0IGludGVncmF0ZSBzZWFtbGVzc2x5IGludG8gRW1iZXIuIFRoaXMgaXMgYWNjb21wbGlzaGVkCiAgICAgIHRocm91Z2ggYSBkZWxlZ2F0ZSwgcmVnaXN0ZXJlZCB3aXRoIHRoZSBjdXN0b20gY29tcG9uZW50IG1hbmFnZXIsIHdoaWNoCiAgICAgIGltcGxlbWVudHMgYSBzZXQgb2YgaG9va3MgdGhhdCBkZXRlcm1pbmUgY29tcG9uZW50IGJlaGF2aW9yLgogICAgCiAgICAgIFRvIGNyZWF0ZSBhIGN1c3RvbSBjb21wb25lbnQgbWFuYWdlciwgaW5zdGFudGlhdGUgYSBuZXcgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcgogICAgICBjbGFzcyBhbmQgcGFzcyB0aGUgZGVsZWdhdGUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50OgogICAgCiAgICAgIGBgYGpzCiAgICAgIGxldCBtYW5hZ2VyID0gbmV3IEN1c3RvbUNvbXBvbmVudE1hbmFnZXIoewogICAgICAgIC8vIC4uLmRlbGVnYXRlIGltcGxlbWVudGF0aW9uLi4uCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICAjIyBEZWxlZ2F0ZSBIb29rcwogICAgCiAgICAgIFRocm91Z2hvdXQgdGhlIGxpZmVjeWNsZSBvZiBhIGNvbXBvbmVudCwgdGhlIGNvbXBvbmVudCBtYW5hZ2VyIHdpbGwgaW52b2tlCiAgICAgIGRlbGVnYXRlIGhvb2tzIHRoYXQgYXJlIHJlc3BvbnNpYmxlIGZvciBzdXJmYWNpbmcgdGhvc2UgbGlmZWN5Y2xlIGNoYW5nZXMgdG8KICAgICAgdGhlIGVuZCBkZXZlbG9wZXIuCiAgICAKICAgICAgKiBgY3JlYXRlKClgIC0gaW52b2tlZCB3aGVuIGEgbmV3IGluc3RhbmNlIG9mIGEgY29tcG9uZW50IHNob3VsZCBiZSBjcmVhdGVkCiAgICAgICogYHVwZGF0ZSgpYCAtIGludm9rZWQgd2hlbiB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byBhIGNvbXBvbmVudCBjaGFuZ2UKICAgICAgKiBgZ2V0Q29udGV4dCgpYCAtIHJldHVybnMgdGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZQogICAgKi8KCiAgICB2YXIgQ3VzdG9tQ29tcG9uZW50TWFuYWdlciA9IGZ1bmN0aW9uIChfQWJzdHJhY3RNYW5hZ2VyNikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQ3VzdG9tQ29tcG9uZW50TWFuYWdlciwgX0Fic3RyYWN0TWFuYWdlcjYpOwoKICAgICAgICBmdW5jdGlvbiBDdXN0b21Db21wb25lbnRNYW5hZ2VyKGRlbGVnYXRlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcik7CgogICAgICAgICAgICB2YXIgX3RoaXM0MSA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfQWJzdHJhY3RNYW5hZ2VyNi5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNDEuZGVsZWdhdGUgPSBkZWxlZ2F0ZTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzNDE7CiAgICAgICAgfQoKICAgICAgICBDdXN0b21Db21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoX2VudiwgZGVmaW5pdGlvbiwgYXJncywgZHluYW1pY1Njb3BlKSB7CiAgICAgICAgICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXMuZGVsZWdhdGU7CgogICAgICAgICAgICB2YXIgY2FwdHVyZWRBcmdzID0gYXJncy5uYW1lZC5jYXB0dXJlKCk7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBkZWxlZ2F0ZS5jcmVhdGUoewogICAgICAgICAgICAgICAgYXJnczogY2FwdHVyZWRBcmdzLnZhbHVlKCksCiAgICAgICAgICAgICAgICBDb21wb25lbnRDbGFzczogZGVmaW5pdGlvbi5Db21wb25lbnRDbGFzcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHBhcmVudFZpZXcgPSBkeW5hbWljU2NvcGUudmlldzsKCiAgICAgICAgICAgIGlmIChwYXJlbnRWaWV3ICE9PSBudWxsICYmIHBhcmVudFZpZXcgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgKDAsIF9lbWJlclZpZXdzLmFkZENoaWxkVmlldykocGFyZW50VmlldywgY29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkeW5hbWljU2NvcGUudmlldyA9IGNvbXBvbmVudDsKICAgICAgICAgICAgcmV0dXJuIG5ldyBDdXN0b21Db21wb25lbnRTdGF0ZShkZWxlZ2F0ZSwgY29tcG9uZW50LCBjYXB0dXJlZEFyZ3MpOwogICAgICAgIH07CgogICAgICAgIEN1c3RvbUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZShfcmVmMjgpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudCA9IF9yZWYyOC5jb21wb25lbnQsCiAgICAgICAgICAgICAgICBhcmdzID0gX3JlZjI4LmFyZ3M7CgogICAgICAgICAgICB0aGlzLmRlbGVnYXRlLnVwZGF0ZShjb21wb25lbnQsIGFyZ3MudmFsdWUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgQ3VzdG9tQ29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZGlkVXBkYXRlID0gZnVuY3Rpb24gZGlkVXBkYXRlKF9yZWYyOSkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50ID0gX3JlZjI5LmNvbXBvbmVudDsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5kZWxlZ2F0ZS5kaWRVcGRhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVsZWdhdGUuZGlkVXBkYXRlKGNvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBDdXN0b21Db21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRDb250ZXh0ID0gZnVuY3Rpb24gZ2V0Q29udGV4dChjb21wb25lbnQpIHsKICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZS5nZXRDb250ZXh0KGNvbXBvbmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgQ3VzdG9tQ29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0TGF5b3V0ID0gZnVuY3Rpb24gZ2V0TGF5b3V0KHN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBoYW5kbGU6IHN0YXRlLnRlbXBsYXRlLmFzTGF5b3V0KCkuY29tcGlsZSgpLAogICAgICAgICAgICAgICAgc3ltYm9sVGFibGU6IHN0YXRlLnN5bWJvbFRhYmxlCiAgICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgQ3VzdG9tQ29tcG9uZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0U2VsZiA9IGZ1bmN0aW9uIGdldFNlbGYoX3JlZjMwKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmMzAuY29tcG9uZW50OwoKICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLmRlbGVnYXRlLmdldENvbnRleHQoY29tcG9uZW50KTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBSb290UmVmZXJlbmNlKGNvbnRleHQpOwogICAgICAgIH07CgogICAgICAgIEN1c3RvbUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldERlc3RydWN0b3IgPSBmdW5jdGlvbiBnZXREZXN0cnVjdG9yKHN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9OwoKICAgICAgICBDdXN0b21Db21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRDYXBhYmlsaXRpZXMgPSBmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoX3N0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkeW5hbWljTGF5b3V0OiBmYWxzZSwKICAgICAgICAgICAgICAgIGR5bmFtaWNUYWc6IGZhbHNlLAogICAgICAgICAgICAgICAgcHJlcGFyZUFyZ3M6IGZhbHNlLAogICAgICAgICAgICAgICAgY3JlYXRlQXJnczogdHJ1ZSwKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLAogICAgICAgICAgICAgICAgZWxlbWVudEhvb2s6IGZhbHNlLAogICAgICAgICAgICAgICAgY3JlYXRlQ2FsbGVyOiBmYWxzZSwKICAgICAgICAgICAgICAgIGR5bmFtaWNTY29wZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUhvb2s6IHRydWUsCiAgICAgICAgICAgICAgICBjcmVhdGVJbnN0YW5jZTogdHJ1ZQogICAgICAgICAgICB9OwogICAgICAgIH07CgogICAgICAgIEN1c3RvbUNvbXBvbmVudE1hbmFnZXIucHJvdG90eXBlLmdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyhfcmVmMzEpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBfcmVmMzEuYXJnczsKCiAgICAgICAgICAgIHJldHVybiBhcmdzLnRhZzsKICAgICAgICB9OwoKICAgICAgICBDdXN0b21Db21wb25lbnRNYW5hZ2VyLnByb3RvdHlwZS5kaWRSZW5kZXJMYXlvdXQgPSBmdW5jdGlvbiBkaWRSZW5kZXJMYXlvdXQoX3JlZjMyLCBfYm91bmRzKSB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnQgPSBfcmVmMzIuY29tcG9uZW50OwoKICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIoY29tcG9uZW50KTsKICAgICAgICAgICAgcmVuZGVyZXIucmVnaXN0ZXIoY29tcG9uZW50KTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmRlbGVnYXRlLmRpZENyZWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZS5kaWRDcmVhdGUoY29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBDdXN0b21Db21wb25lbnRNYW5hZ2VyOwogICAgfShBYnN0cmFjdE1hbmFnZXIpOwoKICAgIHZhciBDdXN0b21Db21wb25lbnRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDdXN0b21Db21wb25lbnRTdGF0ZShkZWxlZ2F0ZSwgY29tcG9uZW50LCBhcmdzKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ3VzdG9tQ29tcG9uZW50U3RhdGUpOwoKICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZSA9IGRlbGVnYXRlOwogICAgICAgICAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgICAgICAgICAgdGhpcy5hcmdzID0gYXJnczsKICAgICAgICB9CgogICAgICAgIEN1c3RvbUNvbXBvbmVudFN0YXRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZSwKICAgICAgICAgICAgICAgIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50OwoKICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIoY29tcG9uZW50KTsKICAgICAgICAgICAgcmVuZGVyZXIudW5yZWdpc3Rlcihjb21wb25lbnQpOwogICAgICAgICAgICBpZiAoZGVsZWdhdGUuZGVzdHJveSkgewogICAgICAgICAgICAgICAgZGVsZWdhdGUuZGVzdHJveShjb21wb25lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEN1c3RvbUNvbXBvbmVudFN0YXRlOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGdldFJlbmRlcmVyKGNvbXBvbmVudCkgewogICAgICAgIHZhciByZW5kZXJlciA9IGNvbXBvbmVudFsncmVuZGVyZXInXTsKICAgICAgICBpZiAoIXJlbmRlcmVyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbWlzc2luZyByZW5kZXJlciBmb3IgY29tcG9uZW50ICcgKyBjb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVuZGVyZXI7CiAgICB9CgogICAgdmFyIENPTVBPTkVOVF9NQU5BR0VSID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ0NPTVBPTkVOVF9NQU5BR0VSJyk7CiAgICBmdW5jdGlvbiBjb21wb25lbnRNYW5hZ2VyKG9iaiwgbWFuYWdlcklkKSB7CiAgICAgICAgaWYgKCdyZW9wZW5DbGFzcycgaW4gb2JqKSB7CiAgICAgICAgICAgIHZhciBfb2JqJHJlb3BlbkNsYXNzOwoKICAgICAgICAgICAgcmV0dXJuIG9iai5yZW9wZW5DbGFzcygoX29iaiRyZW9wZW5DbGFzcyA9IHt9LCBfb2JqJHJlb3BlbkNsYXNzW0NPTVBPTkVOVF9NQU5BR0VSXSA9IG1hbmFnZXJJZCwgX29iaiRyZW9wZW5DbGFzcykpOwogICAgICAgIH0KICAgICAgICBvYmpbQ09NUE9ORU5UX01BTkFHRVJdID0gbWFuYWdlcklkOwogICAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdXN0b21Db21wb25lbnRNYW5hZ2VyKG93bmVyLCBvYmopIHsKICAgICAgICBpZiAoIWZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgbWFuYWdlcklkID0gb2JqW0NPTVBPTkVOVF9NQU5BR0VSXTsKICAgICAgICBpZiAoIW1hbmFnZXJJZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBtYW5hZ2VyID0gbmV3IEN1c3RvbUNvbXBvbmVudE1hbmFnZXIob3duZXIubG9va3VwKCdjb21wb25lbnQtbWFuYWdlcjonICsgbWFuYWdlcklkKSk7CiAgICAgICAgKHRydWUgJiYgISghIW1hbmFnZXIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ291bGQgbm90IGZpbmQgY3VzdG9tIGNvbXBvbmVudCBtYW5hZ2VyIFwnJyArIG1hbmFnZXJJZCArICdcJyBmb3IgJyArIG9iaiwgISFtYW5hZ2VyKSk7CgogICAgICAgIHJldHVybiBtYW5hZ2VyOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RydW1lbnRhdGlvblBheWxvYWQkMShuYW1lKSB7CiAgICAgICAgcmV0dXJuIHsgb2JqZWN0OiAnY29tcG9uZW50OicgKyBuYW1lIH07CiAgICB9CiAgICBmdW5jdGlvbiBtYWtlT3B0aW9ucyhtb2R1bGVOYW1lLCBuYW1lc3BhY2UpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzb3VyY2U6IG1vZHVsZU5hbWUgIT09IHVuZGVmaW5lZCA/ICd0ZW1wbGF0ZTonICsgbW9kdWxlTmFtZSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2UKICAgICAgICB9OwogICAgfQogICAgdmFyIEJVSUxUSU5TX0hFTFBFUlMgPSB7CiAgICAgICAgaWY6IGlubGluZUlmLAogICAgICAgIGFjdGlvbjogYWN0aW9uLAogICAgICAgIGNvbmNhdDogY29uY2F0JDEsCiAgICAgICAgZ2V0OiBnZXQkMSwKICAgICAgICBoYXNoOiBoYXNoLAogICAgICAgIGxvZzogbG9nJDEsCiAgICAgICAgbXV0OiBtdXQsCiAgICAgICAgJ3F1ZXJ5LXBhcmFtcyc6IHF1ZXJ5UGFyYW1zJDEsCiAgICAgICAgcmVhZG9ubHk6IHJlYWRvbmx5LAogICAgICAgIHVuYm91bmQ6IHVuYm91bmQsCiAgICAgICAgdW5sZXNzOiBpbmxpbmVVbmxlc3MsCiAgICAgICAgJy1jbGFzcyc6IGNsYXNzSGVscGVyJDEsCiAgICAgICAgJy1lYWNoLWluJzogZWFjaEluLAogICAgICAgICctaW5wdXQtdHlwZSc6IGlucHV0VHlwZUhlbHBlciQxLAogICAgICAgICctbm9ybWFsaXplLWNsYXNzJzogbm9ybWFsaXplQ2xhc3NIZWxwZXIsCiAgICAgICAgJy1odG1sLXNhZmUnOiBodG1sU2FmZUhlbHBlciwKICAgICAgICAnLWdldC1keW5hbWljLXZhcic6IF9ydW50aW1lLmdldER5bmFtaWNWYXIsCiAgICAgICAgJy1tb3VudCc6IG1vdW50SGVscGVyLAogICAgICAgICctb3V0bGV0Jzogb3V0bGV0SGVscGVyCiAgICB9OwogICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUkVOREVSX0hFTFBFUikgewogICAgICAgIEJVSUxUSU5TX0hFTFBFUlNbJy1yZW5kZXInXSA9IHJlbmRlckhlbHBlcjsKICAgIH0KICAgIHZhciBCVUlMVElOX01PRElGSUVSUyA9IHsKICAgICAgICBhY3Rpb246IG5ldyBBY3Rpb25Nb2RpZmllck1hbmFnZXIoKQogICAgfTsKCiAgICB2YXIgUnVudGltZVJlc29sdmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIFJ1bnRpbWVSZXNvbHZlcigpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBSdW50aW1lUmVzb2x2ZXIpOwoKICAgICAgICAgICAgdGhpcy5oYW5kbGVzID0gW3VuZGVmaW5lZF07CiAgICAgICAgICAgIHRoaXMub2JqVG9IYW5kbGUgPSBuZXcgV2Vha01hcCgpOwogICAgICAgICAgICB0aGlzLmJ1aWx0SW5IZWxwZXJzID0gQlVJTFRJTlNfSEVMUEVSUzsKICAgICAgICAgICAgdGhpcy5idWlsdEluTW9kaWZpZXJzID0gQlVJTFRJTl9NT0RJRklFUlM7CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIGRpcmVjdGx5IGltcG9ydGVkIGxhdGUgYm91bmQgbGF5b3V0cyBvbiBjb21wb25lbnQucHJvdG90eXBlLmxheW91dAogICAgICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGUgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlID0gbmV3IE1hcCgpOwogICAgICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGVIaXRzID0gMDsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlTWlzc2VzID0gMDsKICAgICAgICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ291bnQgPSAwOwogICAgICAgICAgICB0aGlzLmhlbHBlckRlZmluaXRpb25Db3VudCA9IDA7CiAgICAgICAgICAgIHZhciBtYWNyb3MgPSBuZXcgX29wY29kZUNvbXBpbGVyLk1hY3JvcygpOwogICAgICAgICAgICBwb3B1bGF0ZU1hY3JvcyhtYWNyb3MpOwogICAgICAgICAgICB0aGlzLmNvbXBpbGVyID0gbmV3IF9vcGNvZGVDb21waWxlci5MYXp5Q29tcGlsZXIobmV3IENvbXBpbGVUaW1lTG9va3VwKHRoaXMpLCB0aGlzLCBtYWNyb3MpOwogICAgICAgIH0KICAgICAgICAvKioqICBJUnVudGltZVJlc29sdmVyICoqKi8KICAgICAgICAvKioKICAgICAgICAgKiBwdWJsaWMgY29tcG9uZW50RGVmSGFuZGxlQ291bnQgPSAwOwogICAgICAgICAqIENhbGxlZCB3aGlsZSBleGVjdXRpbmcgQXBwZW5kIE9wLlB1c2hEeW5hbWljQ29tcG9uZW50TWFuYWdlciBpZiBzdHJpbmcKICAgICAgICAgKi8KCgogICAgICAgIFJ1bnRpbWVSZXNvbHZlci5wcm90b3R5cGUubG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbiA9IGZ1bmN0aW9uIGxvb2t1cENvbXBvbmVudERlZmluaXRpb24obmFtZSwgbWV0YSkgewogICAgICAgICAgICB2YXIgaGFuZGxlID0gdGhpcy5sb29rdXBDb21wb25lbnRIYW5kbGUobmFtZSwgbWV0YSk7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ291bGQgbm90IGZpbmQgY29tcG9uZW50IG5hbWVkICInICsgbmFtZSArICciIChubyBjb21wb25lbnQgb3IgdGVtcGxhdGUgd2l0aCB0aGF0IG5hbWUgd2FzIGZvdW5kKScpKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlKGhhbmRsZSk7CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZVJlc29sdmVyLnByb3RvdHlwZS5sb29rdXBDb21wb25lbnRIYW5kbGUgPSBmdW5jdGlvbiBsb29rdXBDb21wb25lbnRIYW5kbGUobmFtZSwgbWV0YSkgewogICAgICAgICAgICB2YXIgbmV4dEhhbmRsZSA9IHRoaXMuaGFuZGxlcy5sZW5ndGg7CiAgICAgICAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZSh0aGlzLl9sb29rdXBDb21wb25lbnREZWZpbml0aW9uKG5hbWUsIG1ldGEpKTsKICAgICAgICAgICAgaWYgKG5leHRIYW5kbGUgPT09IGhhbmRsZSkgewogICAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgICAgIH07CgogICAgICAgIFJ1bnRpbWVSZXNvbHZlci5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoaGFuZGxlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZXNbaGFuZGxlXTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lUmVzb2x2ZXIucHJvdG90eXBlLmxvb2t1cEhlbHBlciA9IGZ1bmN0aW9uIGxvb2t1cEhlbHBlcihuYW1lLCBtZXRhKSB7CiAgICAgICAgICAgIHZhciBuZXh0SGFuZGxlID0gdGhpcy5oYW5kbGVzLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGhlbHBlciQkMSA9IHRoaXMuX2xvb2t1cEhlbHBlcihuYW1lLCBtZXRhKTsKICAgICAgICAgICAgaWYgKGhlbHBlciQkMSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMuaGFuZGxlKGhlbHBlciQkMSk7CiAgICAgICAgICAgICAgICBpZiAobmV4dEhhbmRsZSA9PT0gaGFuZGxlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oZWxwZXJEZWZpbml0aW9uQ291bnQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZVJlc29sdmVyLnByb3RvdHlwZS5sb29rdXBNb2RpZmllciA9IGZ1bmN0aW9uIGxvb2t1cE1vZGlmaWVyKG5hbWUsIF9tZXRhKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZSh0aGlzLl9sb29rdXBNb2RpZmllcihuYW1lKSk7CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZVJlc29sdmVyLnByb3RvdHlwZS5sb29rdXBQYXJ0aWFsID0gZnVuY3Rpb24gbG9va3VwUGFydGlhbChuYW1lLCBtZXRhKSB7CiAgICAgICAgICAgIHZhciBwYXJ0aWFsID0gdGhpcy5fbG9va3VwUGFydGlhbChuYW1lLCBtZXRhKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlKHBhcnRpYWwpOwogICAgICAgIH07CgogICAgICAgIFJ1bnRpbWVSZXNvbHZlci5wcm90b3R5cGUuY3JlYXRlVGVtcGxhdGUgPSBmdW5jdGlvbiBjcmVhdGVUZW1wbGF0ZShmYWN0b3J5LCBvd25lcikgewogICAgICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLnRlbXBsYXRlQ2FjaGUuZ2V0KG93bmVyKTsKICAgICAgICAgICAgaWYgKGNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNhY2hlID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlLnNldChvd25lciwgY2FjaGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGNhY2hlLmdldChmYWN0b3J5KTsKICAgICAgICAgICAgaWYgKHRlbXBsYXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZhciBjb21waWxlciA9IHRoaXMuY29tcGlsZXI7CgogICAgICAgICAgICAgICAgdmFyIGluamVjdGlvbnMgPSB7IGNvbXBpbGVyOiBjb21waWxlciB9OwogICAgICAgICAgICAgICAgKDAsIF9lbWJlck93bmVyLnNldE93bmVyKShpbmplY3Rpb25zLCBvd25lcik7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IGZhY3RvcnkuY3JlYXRlKGluamVjdGlvbnMpOwogICAgICAgICAgICAgICAgY2FjaGUuc2V0KGZhY3RvcnksIHRlbXBsYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMudGVtcGxhdGVDYWNoZU1pc3NlcysrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZUNhY2hlSGl0cysrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lUmVzb2x2ZXIucHJvdG90eXBlLmhhbmRsZSA9IGZ1bmN0aW9uIGhhbmRsZShvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiA9PT0gdW5kZWZpbmVkIHx8IG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMub2JqVG9IYW5kbGUuZ2V0KG9iaik7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaGFuZGxlID0gdGhpcy5oYW5kbGVzLnB1c2gob2JqKSAtIDE7CiAgICAgICAgICAgICAgICB0aGlzLm9ialRvSGFuZGxlLnNldChvYmosIGhhbmRsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lUmVzb2x2ZXIucHJvdG90eXBlLl9sb29rdXBIZWxwZXIgPSBmdW5jdGlvbiBfbG9va3VwSGVscGVyKF9uYW1lLCBtZXRhKSB7CiAgICAgICAgICAgIHZhciBoZWxwZXIkJDEgPSB0aGlzLmJ1aWx0SW5IZWxwZXJzW19uYW1lXTsKICAgICAgICAgICAgaWYgKGhlbHBlciQkMSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGVscGVyJCQxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvd25lciA9IG1ldGEub3duZXIsCiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gbWV0YS5tb2R1bGVOYW1lOwoKICAgICAgICAgICAgdmFyIG5hbWUgPSBfbmFtZTsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gdGhpcy5fcGFyc2VOYW1lRm9yTmFtZXNwYWNlKF9uYW1lKTsKICAgICAgICAgICAgICAgIG5hbWUgPSBwYXJzZWQubmFtZTsKICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHBhcnNlZC5uYW1lc3BhY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBtYWtlT3B0aW9ucyhtb2R1bGVOYW1lLCBuYW1lc3BhY2UpOwogICAgICAgICAgICB2YXIgZmFjdG9yeSA9IG93bmVyLmZhY3RvcnlGb3IoJ2hlbHBlcjonICsgbmFtZSwgb3B0aW9ucykgfHwgb3duZXIuZmFjdG9yeUZvcignaGVscGVyOicgKyBuYW1lKTsKICAgICAgICAgICAgaWYgKCFpc0hlbHBlckZhY3RvcnkoZmFjdG9yeSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodm0sIGFyZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBoZWxwZXIkJDEgPSBmYWN0b3J5LmNyZWF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKGlzU2ltcGxlSGVscGVyKGhlbHBlciQkMSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFNpbXBsZUhlbHBlclJlZmVyZW5jZShoZWxwZXIkJDEuY29tcHV0ZSwgYXJncy5jYXB0dXJlKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdm0ubmV3RGVzdHJveWFibGUoaGVscGVyJCQxKTsKICAgICAgICAgICAgICAgIHJldHVybiBDbGFzc0Jhc2VkSGVscGVyUmVmZXJlbmNlLmNyZWF0ZShoZWxwZXIkJDEsIGFyZ3MuY2FwdHVyZSgpKTsKICAgICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICBSdW50aW1lUmVzb2x2ZXIucHJvdG90eXBlLl9sb29rdXBQYXJ0aWFsID0gZnVuY3Rpb24gX2xvb2t1cFBhcnRpYWwobmFtZSwgbWV0YSkgewogICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSAoMCwgX2VtYmVyVmlld3MubG9va3VwUGFydGlhbCkobmFtZSwgbWV0YS5vd25lcik7CiAgICAgICAgICAgIHZhciBwYXJ0aWFsID0gbmV3IF9vcGNvZGVDb21waWxlci5QYXJ0aWFsRGVmaW5pdGlvbihuYW1lLCAoMCwgX2VtYmVyVmlld3MubG9va3VwUGFydGlhbCkobmFtZSwgbWV0YS5vd25lcikpOwogICAgICAgICAgICBpZiAodGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0aWFsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG5hbWUgKyAnIGlzIG5vdCBhIHBhcnRpYWwnKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIFJ1bnRpbWVSZXNvbHZlci5wcm90b3R5cGUuX2xvb2t1cE1vZGlmaWVyID0gZnVuY3Rpb24gX2xvb2t1cE1vZGlmaWVyKG5hbWUpIHsKICAgICAgICAgICAgdmFyIG1vZGlmaWVyID0gdGhpcy5idWlsdEluTW9kaWZpZXJzW25hbWVdOwogICAgICAgICAgICBpZiAobW9kaWZpZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CgogICAgICAgIFJ1bnRpbWVSZXNvbHZlci5wcm90b3R5cGUuX3BhcnNlTmFtZUZvck5hbWVzcGFjZSA9IGZ1bmN0aW9uIF9wYXJzZU5hbWVGb3JOYW1lc3BhY2UoX25hbWUpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBfbmFtZTsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZURlbGltaXRlck9mZnNldCA9IF9uYW1lLmluZGV4T2YoJzo6Jyk7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VEZWxpbWl0ZXJPZmZzZXQgIT09IC0xKSB7CiAgICAgICAgICAgICAgICBuYW1lID0gX25hbWUuc2xpY2UobmFtZXNwYWNlRGVsaW1pdGVyT2Zmc2V0ICsgMik7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBfbmFtZS5zbGljZSgwLCBuYW1lc3BhY2VEZWxpbWl0ZXJPZmZzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7IG5hbWU6IG5hbWUsIG5hbWVzcGFjZTogbmFtZXNwYWNlIH07CiAgICAgICAgfTsKCiAgICAgICAgUnVudGltZVJlc29sdmVyLnByb3RvdHlwZS5fbG9va3VwQ29tcG9uZW50RGVmaW5pdGlvbiA9IGZ1bmN0aW9uIF9sb29rdXBDb21wb25lbnREZWZpbml0aW9uKF9uYW1lLCBtZXRhKSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gX25hbWU7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmIChmYWxzZSkgewogICAgICAgICAgICAgICAgdmFyIHBhcnNlZCA9IHRoaXMuX3BhcnNlTmFtZUZvck5hbWVzcGFjZShfbmFtZSk7CiAgICAgICAgICAgICAgICBuYW1lID0gcGFyc2VkLm5hbWU7CiAgICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBwYXJzZWQubmFtZXNwYWNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX2xvb2t1cENvbXBvbmVudDIgPSAoMCwgX2VtYmVyVmlld3MubG9va3VwQ29tcG9uZW50KShtZXRhLm93bmVyLCBuYW1lLCBtYWtlT3B0aW9ucyhtZXRhLm1vZHVsZU5hbWUsIG5hbWVzcGFjZSkpLAogICAgICAgICAgICAgICAgbGF5b3V0ID0gX2xvb2t1cENvbXBvbmVudDIubGF5b3V0LAogICAgICAgICAgICAgICAgY29tcG9uZW50ID0gX2xvb2t1cENvbXBvbmVudDIuY29tcG9uZW50OwoKICAgICAgICAgICAgdmFyIGtleSA9IGNvbXBvbmVudCA9PT0gdW5kZWZpbmVkID8gbGF5b3V0IDogY29tcG9uZW50OwogICAgICAgICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWNoZWRDb21wb25lbnREZWZpbml0aW9uID0gdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuZ2V0KGtleSk7CiAgICAgICAgICAgIGlmIChjYWNoZWRDb21wb25lbnREZWZpbml0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDb21wb25lbnREZWZpbml0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYXlvdXQgJiYgIWNvbXBvbmVudCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX1RFTVBMQVRFX09OTFlfR0xJTU1FUl9DT01QT05FTlRTKSB7CiAgICAgICAgICAgICAgICB2YXIgX2RlZmluaXRpb24gPSBuZXcgVGVtcGxhdGVPbmx5Q29tcG9uZW50RGVmaW5pdGlvbihsYXlvdXQpOwogICAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuc2V0KGtleSwgX2RlZmluaXRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuIF9kZWZpbml0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtYW5hZ2VyID0gdm9pZCAwOwogICAgICAgICAgICBpZiAoZmFsc2UgJiYgY29tcG9uZW50ICYmIGNvbXBvbmVudC5jbGFzcykgewogICAgICAgICAgICAgICAgbWFuYWdlciA9IGdldEN1c3RvbUNvbXBvbmVudE1hbmFnZXIobWV0YS5vd25lciwgY29tcG9uZW50LmNsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmluYWxpemVyID0gKDAsIF9pbnN0cnVtZW50YXRpb24uX2luc3RydW1lbnRTdGFydCkoJ3JlbmRlci5nZXRDb21wb25lbnREZWZpbml0aW9uJywgaW5zdHJ1bWVudGF0aW9uUGF5bG9hZCQxLCBuYW1lKTsKICAgICAgICAgICAgdmFyIGRlZmluaXRpb24gPSBsYXlvdXQgfHwgY29tcG9uZW50ID8gbmV3IEN1cmx5Q29tcG9uZW50RGVmaW5pdGlvbihuYW1lLCBtYW5hZ2VyLCBjb21wb25lbnQgfHwgbWV0YS5vd25lci5mYWN0b3J5Rm9yKCgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0MikpLCBudWxsLCBsYXlvdXQgLy8gVE9ETyBmaXggdHlwZQogICAgICAgICAgICApIDogbnVsbDsKICAgICAgICAgICAgZmluYWxpemVyKCk7CiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLnNldChrZXksIGRlZmluaXRpb24pOwogICAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbjsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gUnVudGltZVJlc29sdmVyOwogICAgfSgpOwoKICAgIC8vIGZhY3RvcnkgZm9yIERJCiAgICB2YXIgVGVtcGxhdGVDb21waWxlciA9IHsKICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBSdW50aW1lUmVzb2x2ZXIoKS5jb21waWxlcjsKICAgICAgICB9CiAgICB9OwoKICAgIHZhciBDb21wb25lbnRUZW1wbGF0ZSA9IHRlbXBsYXRlKHsgImlkIjogIjlRbE1uZDRjIiwgImJsb2NrIjogIntcInN5bWJvbHNcIjpbXCImZGVmYXVsdFwiXSxcInN0YXRlbWVudHNcIjpbWzE0LDFdXSxcImhhc0V2YWxcIjpmYWxzZX0iLCAibWV0YSI6IHsgIm1vZHVsZU5hbWUiOiAicGFja2FnZXMvZW1iZXItZ2xpbW1lci9saWIvdGVtcGxhdGVzL2NvbXBvbmVudC5oYnMiIH0gfSk7CgogICAgdmFyIE91dGxldFRlbXBsYXRlID0gdGVtcGxhdGUoeyAiaWQiOiAicUFzWjFMNVUiLCAiYmxvY2siOiAie1wic3ltYm9sc1wiOltdLFwic3RhdGVtZW50c1wiOltbMSxbMjEsXCJvdXRsZXRcIl0sZmFsc2VdXSxcImhhc0V2YWxcIjpmYWxzZX0iLCAibWV0YSI6IHsgIm1vZHVsZU5hbWUiOiAicGFja2FnZXMvZW1iZXItZ2xpbW1lci9saWIvdGVtcGxhdGVzL291dGxldC5oYnMiIH0gfSk7CgogICAgdmFyIFRPUF9MRVZFTF9OQU1FID0gJy10b3AtbGV2ZWwnOwogICAgdmFyIFRPUF9MRVZFTF9PVVRMRVQgPSAnbWFpbic7CgogICAgdmFyIE91dGxldFZpZXcgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gT3V0bGV0VmlldyhfZW52aXJvbm1lbnQsIHJlbmRlcmVyLCBvd25lciwgdGVtcGxhdGUpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBPdXRsZXRWaWV3KTsKCiAgICAgICAgICAgIHRoaXMuX2Vudmlyb25tZW50ID0gX2Vudmlyb25tZW50OwogICAgICAgICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyZXI7CiAgICAgICAgICAgIHRoaXMub3duZXIgPSBvd25lcjsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgICAgICB2YXIgcmVmID0gdGhpcy5yZWYgPSBuZXcgUm9vdE91dGxldFJlZmVyZW5jZSh7CiAgICAgICAgICAgICAgICBvdXRsZXRzOiB7IG1haW46IHVuZGVmaW5lZCB9LAogICAgICAgICAgICAgICAgcmVuZGVyOiB7CiAgICAgICAgICAgICAgICAgICAgb3duZXI6IG93bmVyLAogICAgICAgICAgICAgICAgICAgIGludG86IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICBvdXRsZXQ6IFRPUF9MRVZFTF9PVVRMRVQsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogVE9QX0xFVkVMX05BTUUsCiAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHsKICAgICAgICAgICAgICAgIHJlZjogcmVmLAogICAgICAgICAgICAgICAgbmFtZTogVE9QX0xFVkVMX05BTUUsCiAgICAgICAgICAgICAgICBvdXRsZXQ6IFRPUF9MRVZFTF9PVVRMRVQsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogdGVtcGxhdGUsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiB1bmRlZmluZWQKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIE91dGxldFZpZXcuZXh0ZW5kID0gZnVuY3Rpb24gZXh0ZW5kKGluamVjdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfT3V0bGV0VmlldykgewogICAgICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShfY2xhc3MsIF9PdXRsZXRWaWV3KTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBfY2xhc3MoKSB7CiAgICAgICAgICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBfY2xhc3MpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX091dGxldFZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX2NsYXNzLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9PdXRsZXRWaWV3LmNyZWF0ZS5jYWxsKHRoaXMsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIGluamVjdGlvbnMsIG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX091dGxldFZpZXcuY3JlYXRlLmNhbGwodGhpcywgaW5qZWN0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4gX2NsYXNzOwogICAgICAgICAgICB9KE91dGxldFZpZXcpOwogICAgICAgIH07CgogICAgICAgIE91dGxldFZpZXcucmVvcGVuQ2xhc3MgPSBmdW5jdGlvbiByZW9wZW5DbGFzcyhpbmplY3Rpb25zKSB7CiAgICAgICAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikodGhpcywgaW5qZWN0aW9ucyk7CiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Vmlldy5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUob3B0aW9ucykgewogICAgICAgICAgICB2YXIgX2Vudmlyb25tZW50ID0gb3B0aW9ucy5fZW52aXJvbm1lbnQsCiAgICAgICAgICAgICAgICByZW5kZXJlciA9IG9wdGlvbnMucmVuZGVyZXIsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CgogICAgICAgICAgICB2YXIgb3duZXIgPSBvcHRpb25zW19lbWJlck93bmVyLk9XTkVSXTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBPdXRsZXRWaWV3KF9lbnZpcm9ubWVudCwgcmVuZGVyZXIsIG93bmVyLCB0ZW1wbGF0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Vmlldy5wcm90b3R5cGUuYXBwZW5kVG8gPSBmdW5jdGlvbiBhcHBlbmRUbyhzZWxlY3RvcikgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdm9pZCAwOwogICAgICAgICAgICBpZiAodGhpcy5fZW52aXJvbm1lbnQuaGFzRE9NKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnID8gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikgOiBzZWxlY3RvcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IHNlbGVjdG9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ3JlbmRlcicsIHRoaXMucmVuZGVyZXIsICdhcHBlbmRPdXRsZXRWaWV3JywgdGhpcywgdGFyZ2V0KTsKICAgICAgICB9OwoKICAgICAgICBPdXRsZXRWaWV3LnByb3RvdHlwZS5yZXJlbmRlciA9IGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICAgICAgICAvKiovCiAgICAgICAgfTsKCiAgICAgICAgT3V0bGV0Vmlldy5wcm90b3R5cGUuc2V0T3V0bGV0U3RhdGUgPSBmdW5jdGlvbiBzZXRPdXRsZXRTdGF0ZShzdGF0ZSkgewogICAgICAgICAgICB0aGlzLnJlZi51cGRhdGUoc3RhdGUpOwogICAgICAgIH07CgogICAgICAgIE91dGxldFZpZXcucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAvKiovCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE91dGxldFZpZXc7CiAgICB9KCk7CgogICAgZnVuY3Rpb24gc2V0dXBBcHBsaWNhdGlvblJlZ2lzdHJ5KHJlZ2lzdHJ5KSB7CiAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOi1nbGltbWVyLWVudmlyb25tZW50JywgJ2FwcGVuZE9wZXJhdGlvbnMnLCAnc2VydmljZTotZG9tLXRyZWUtY29uc3RydWN0aW9uJyk7CiAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdyZW5kZXJlcicsICdlbnYnLCAnc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCcpOwogICAgICAgIC8vIGJlY2F1c2Ugd2UgYXJlIHVzaW5nIGluamVjdGlvbnMgd2UgY2FuJ3QgdXNlIGluc3RhbnRpYXRlIGZhbHNlCiAgICAgICAgLy8gd2UgbmVlZCB0byB1c2UgYmluZCgpIHRvIGNvcHkgdGhlIGZ1bmN0aW9uIHNvIGZhY3RvcnkgZm9yCiAgICAgICAgLy8gYXNzb2NpYXRpb24gd29uJ3QgbGVhawogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJ2aWNlOi1kb20tYnVpbGRlcicsIHsKICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiAoX3JlZjMzKSB7CiAgICAgICAgICAgICAgICB2YXIgYm9vdE9wdGlvbnMgPSBfcmVmMzMuYm9vdE9wdGlvbnM7CiAgICAgICAgICAgICAgICB2YXIgX3JlbmRlck1vZGUgPSBib290T3B0aW9ucy5fcmVuZGVyTW9kZTsKCiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9yZW5kZXJNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2VyaWFsaXplJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9ub2RlLnNlcmlhbGl6ZUJ1aWxkZXIuYmluZChudWxsKTsKICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWh5ZHJhdGUnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3J1bnRpbWUucmVoeWRyYXRpb25CdWlsZGVyLmJpbmQobnVsbCk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9ydW50aW1lLmNsaWVudEJ1aWxkZXIuYmluZChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbignc2VydmljZTotZG9tLWJ1aWxkZXInLCAnYm9vdE9wdGlvbnMnLCAnLWVudmlyb25tZW50Om1haW4nKTsKICAgICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3JlbmRlcmVyJywgJ2J1aWxkZXInLCAnc2VydmljZTotZG9tLWJ1aWxkZXInKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3RlcigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDMpLCBSb290VGVtcGxhdGUpOwogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigncmVuZGVyZXInLCAncm9vdFRlbXBsYXRlJywgKDAsIF9jb250YWluZXIucHJpdmF0aXplKShfdGVtcGxhdGVPYmplY3QzKSk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3JlbmRlcmVyOi1kb20nLCBJbnRlcmFjdGl2ZVJlbmRlcmVyKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3RlcigncmVuZGVyZXI6LWluZXJ0JywgSW5lcnRSZW5kZXJlcik7CiAgICAgICAgaWYgKF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC5oYXNET00pIHsKICAgICAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOi1nbGltbWVyLWVudmlyb25tZW50JywgJ3VwZGF0ZU9wZXJhdGlvbnMnLCAnc2VydmljZTotZG9tLWNoYW5nZXMnKTsKICAgICAgICB9CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6LWRvbS1jaGFuZ2VzJywgewogICAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uIChfcmVmMzQpIHsKICAgICAgICAgICAgICAgIHZhciBkb2N1bWVudCA9IF9yZWYzNC5kb2N1bWVudDsKCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IF9ydW50aW1lLkRPTUNoYW5nZXMoZG9jdW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcnZpY2U6LWRvbS10cmVlLWNvbnN0cnVjdGlvbicsIHsKICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiAoX3JlZjM1KSB7CiAgICAgICAgICAgICAgICB2YXIgZG9jdW1lbnQgPSBfcmVmMzUuZG9jdW1lbnQ7CgogICAgICAgICAgICAgICAgdmFyIEltcGxlbWVudGF0aW9uID0gX2VtYmVyQnJvd3NlckVudmlyb25tZW50Lmhhc0RPTSA/IF9ydW50aW1lLkRPTVRyZWVDb25zdHJ1Y3Rpb24gOiBfbm9kZS5Ob2RlRE9NVHJlZUNvbnN0cnVjdGlvbjsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW1wbGVtZW50YXRpb24oZG9jdW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBzZXR1cEVuZ2luZVJlZ2lzdHJ5KHJlZ2lzdHJ5KSB7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3ZpZXc6LW91dGxldCcsIE91dGxldFZpZXcpOwogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCd0ZW1wbGF0ZTotb3V0bGV0JywgT3V0bGV0VGVtcGxhdGUpOwogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigndmlldzotb3V0bGV0JywgJ3RlbXBsYXRlJywgJ3RlbXBsYXRlOi1vdXRsZXQnKTsKICAgICAgICByZWdpc3RyeS5pbmplY3Rpb24oJ3NlcnZpY2U6LWRvbS1jaGFuZ2VzJywgJ2RvY3VtZW50JywgJ3NlcnZpY2U6LWRvY3VtZW50Jyk7CiAgICAgICAgcmVnaXN0cnkuaW5qZWN0aW9uKCdzZXJ2aWNlOi1kb20tdHJlZS1jb25zdHJ1Y3Rpb24nLCAnZG9jdW1lbnQnLCAnc2VydmljZTotZG9jdW1lbnQnKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3RlcigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdCksIENvbXBvbmVudFRlbXBsYXRlKTsKICAgICAgICByZWdpc3RyeS5yZWdpc3Rlcignc2VydmljZTotZ2xpbW1lci1lbnZpcm9ubWVudCcsIEVudmlyb25tZW50JDEpOwogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCgwLCBfY29udGFpbmVyLnByaXZhdGl6ZSkoX3RlbXBsYXRlT2JqZWN0NCksIFRlbXBsYXRlQ29tcGlsZXIpOwogICAgICAgIHJlZ2lzdHJ5LmluamVjdGlvbigndGVtcGxhdGUnLCAnY29tcGlsZXInLCAoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDQpKTsKICAgICAgICByZWdpc3RyeS5vcHRpb25zRm9yVHlwZSgnaGVscGVyJywgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2hlbHBlcjpsb2MnLCBsb2MkMSk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbXBvbmVudDotdGV4dC1maWVsZCcsIFRleHRGaWVsZCk7CiAgICAgICAgcmVnaXN0cnkucmVnaXN0ZXIoJ2NvbXBvbmVudDotdGV4dC1hcmVhJywgVGV4dEFyZWEpOwogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb21wb25lbnQ6LWNoZWNrYm94JywgQ2hlY2tib3gpOwogICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdjb21wb25lbnQ6bGluay10bycsIExpbmtDb21wb25lbnQpOwogICAgICAgIGlmICghX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9URU1QTEFURV9PTkxZX0dMSU1NRVJfQ09NUE9ORU5UUykgewogICAgICAgICAgICByZWdpc3RyeS5yZWdpc3RlcigoMCwgX2NvbnRhaW5lci5wcml2YXRpemUpKF90ZW1wbGF0ZU9iamVjdDIpLCBDb21wb25lbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAgW0dsaW1tZXJdKGh0dHBzOi8vZ2l0aHViLmNvbS90aWxkZWlvL2dsaW1tZXIpIGlzIGEgdGVtcGxhdGluZyBlbmdpbmUgdXNlZCBieSBFbWJlci5qcyB0aGF0IGlzIGNvbXBhdGlibGUgd2l0aCBhIHN1YnNldCBvZiB0aGUgW0hhbmRsZWJhcnNdKGh0dHA6Ly9oYW5kbGViYXJzanMuY29tLykgc3ludGF4LgogICAgCiAgICAgICMjIyBTaG93aW5nIGEgcHJvcGVydHkKICAgIAogICAgICBUZW1wbGF0ZXMgbWFuYWdlIHRoZSBmbG93IG9mIGFuIGFwcGxpY2F0aW9uJ3MgVUksIGFuZCBkaXNwbGF5IHN0YXRlICh0aHJvdWdoCiAgICAgIHRoZSBET00pIHRvIGEgdXNlci4gRm9yIGV4YW1wbGUsIGdpdmVuIGEgY29tcG9uZW50IHdpdGggdGhlIHByb3BlcnR5ICJuYW1lIiwKICAgICAgdGhhdCBjb21wb25lbnQncyB0ZW1wbGF0ZSBjYW4gdXNlIHRoZSBuYW1lIGluIHNldmVyYWwgd2F5czoKICAgIAogICAgICBgYGBhcHAvY29tcG9uZW50cy9wZXJzb24tcHJvZmlsZS5qcwogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIG5hbWU6ICdKaWxsJwogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgYXBwL2NvbXBvbmVudHMvcGVyc29uLXByb2ZpbGUuaGJzCiAgICAgIHt7bmFtZX19CiAgICAgIDxkaXY+e3tuYW1lfX08L2Rpdj4KICAgICAgPHNwYW4gZGF0YS1uYW1lPXt7bmFtZX19Pjwvc3Bhbj4KICAgICAgYGBgCiAgICAKICAgICAgQW55IHRpbWUgdGhlICJuYW1lIiBwcm9wZXJ0eSBvbiB0aGUgY29tcG9uZW50IGNoYW5nZXMsIHRoZSBET00gd2lsbCBiZQogICAgICB1cGRhdGVkLgogICAgCiAgICAgIFByb3BlcnRpZXMgY2FuIGJlIGNoYWluZWQgYXMgd2VsbDoKICAgIAogICAgICBgYGBoYW5kbGViYXJzCiAgICAgIHt7YVVzZXJNb2RlbC5uYW1lfX0KICAgICAgPGRpdj57e2xpc3RPZlVzZXJzLmZpcnN0T2JqZWN0Lm5hbWV9fTwvZGl2PgogICAgICBgYGAKICAgIAogICAgICAjIyMgVXNpbmcgRW1iZXIgaGVscGVycwogICAgCiAgICAgIFdoZW4gY29udGVudCBpcyBwYXNzZWQgaW4gbXVzdGFjaGVzIGB7e319YCwgRW1iZXIgd2lsbCBmaXJzdCB0cnkgdG8gZmluZCBhIGhlbHBlcgogICAgICBvciBjb21wb25lbnQgd2l0aCB0aGF0IG5hbWUuIEZvciBleGFtcGxlLCB0aGUgYGlmYCBoZWxwZXI6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7e2lmIG5hbWUgIkkgaGF2ZSBhIG5hbWUiICJJIGhhdmUgbm8gbmFtZSJ9fQogICAgICA8c3BhbiBkYXRhLWhhcy1uYW1lPXt7aWYgbmFtZSB0cnVlfX0+PC9zcGFuPgogICAgICBgYGAKICAgIAogICAgICBUaGUgcmV0dXJuZWQgdmFsdWUgaXMgcGxhY2VkIHdoZXJlIHRoZSBge3t9fWAgaXMgY2FsbGVkLiBUaGUgYWJvdmUgc3R5bGUgaXMKICAgICAgY2FsbGVkICJpbmxpbmUiLiBBIHNlY29uZCBzdHlsZSBvZiBoZWxwZXIgdXNhZ2UgaXMgY2FsbGVkICJibG9jayIuIEZvciBleGFtcGxlOgogICAgCiAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjaWYgbmFtZX19CiAgICAgIEkgaGF2ZSBhIG5hbWUKICAgICAge3tlbHNlfX0KICAgICAgSSBoYXZlIG5vIG5hbWUKICAgICAge3svaWZ9fQogICAgICBgYGAKICAgIAogICAgICBUaGUgYmxvY2sgZm9ybSBvZiBoZWxwZXJzIGFsbG93cyB5b3UgdG8gY29udHJvbCBob3cgdGhlIFVJIGlzIGNyZWF0ZWQgYmFzZWQKICAgICAgb24gdGhlIHZhbHVlcyBvZiBwcm9wZXJ0aWVzLgogICAgICBBIHRoaXJkIGZvcm0gb2YgaGVscGVyIGlzIGNhbGxlZCAibmVzdGVkIi4gRm9yIGV4YW1wbGUgaGVyZSB0aGUgY29uY2F0CiAgICAgIGhlbHBlciB3aWxsIGFkZCAiIERvZSIgdG8gYSBkaXNwbGF5ZWQgbmFtZSBpZiB0aGUgcGVyc29uIGhhcyBubyBsYXN0IG5hbWU6CiAgICAKICAgICAgYGBgaGFuZGxlYmFycwogICAgICA8c3BhbiBkYXRhLW5hbWU9e3tjb25jYXQgZmlyc3ROYW1lICgKICAgICAgaWYgbGFzdE5hbWUgKGNvbmNhdCAiICIgbGFzdE5hbWUpICJEb2UiCiAgICAgICl9fT48L3NwYW4+CiAgICAgIGBgYAogICAgCiAgICAgIEVtYmVyJ3MgYnVpbHQtaW4gaGVscGVycyBhcmUgZGVzY3JpYmVkIHVuZGVyIHRoZSBbRW1iZXIuVGVtcGxhdGVzLmhlbHBlcnNdKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0VtYmVyLlRlbXBsYXRlcy5oZWxwZXJzKQogICAgICBuYW1lc3BhY2UuIERvY3VtZW50YXRpb24gb24gY3JlYXRpbmcgY3VzdG9tIGhlbHBlcnMgY2FuIGJlIGZvdW5kIHVuZGVyCiAgICAgIFtIZWxwZXJdKC9hcGkvY2xhc3Nlcy9FbWJlci5IZWxwZXIuaHRtbCkuCiAgICAKICAgICAgIyMjIEludm9raW5nIGEgQ29tcG9uZW50CiAgICAKICAgICAgRW1iZXIgY29tcG9uZW50cyByZXByZXNlbnQgc3RhdGUgdG8gdGhlIFVJIG9mIGFuIGFwcGxpY2F0aW9uLiBGdXJ0aGVyCiAgICAgIHJlYWRpbmcgb24gY29tcG9uZW50cyBjYW4gYmUgZm91bmQgdW5kZXIgW0NvbXBvbmVudF0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQ29tcG9uZW50KS4KICAgIAogICAgICBAbW9kdWxlIEBlbWJlci9jb21wb25lbnQKICAgICAgQG1haW4gQGVtYmVyL2NvbXBvbmVudAogICAgICBAcHVibGljCiAgICAgKi8KCiAgICBleHBvcnRzLlJvb3RUZW1wbGF0ZSA9IFJvb3RUZW1wbGF0ZTsKICAgIGV4cG9ydHMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgIGV4cG9ydHMuQ2hlY2tib3ggPSBDaGVja2JveDsKICAgIGV4cG9ydHMuVGV4dEZpZWxkID0gVGV4dEZpZWxkOwogICAgZXhwb3J0cy5UZXh0QXJlYSA9IFRleHRBcmVhOwogICAgZXhwb3J0cy5MaW5rQ29tcG9uZW50ID0gTGlua0NvbXBvbmVudDsKICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgZXhwb3J0cy5ST09UX1JFRiA9IFJPT1RfUkVGOwogICAgZXhwb3J0cy5IZWxwZXIgPSBIZWxwZXI7CiAgICBleHBvcnRzLmhlbHBlciA9IGhlbHBlcjsKICAgIGV4cG9ydHMuRW52aXJvbm1lbnQgPSBFbnZpcm9ubWVudCQxOwogICAgZXhwb3J0cy5TYWZlU3RyaW5nID0gU2FmZVN0cmluZzsKICAgIGV4cG9ydHMuZXNjYXBlRXhwcmVzc2lvbiA9IGVzY2FwZUV4cHJlc3Npb247CiAgICBleHBvcnRzLmh0bWxTYWZlID0gaHRtbFNhZmU7CiAgICBleHBvcnRzLmlzSFRNTFNhZmUgPSBpc0hUTUxTYWZlOwogICAgZXhwb3J0cy5SZW5kZXJlciA9IFJlbmRlcmVyOwogICAgZXhwb3J0cy5JbmVydFJlbmRlcmVyID0gSW5lcnRSZW5kZXJlcjsKICAgIGV4cG9ydHMuSW50ZXJhY3RpdmVSZW5kZXJlciA9IEludGVyYWN0aXZlUmVuZGVyZXI7CiAgICBleHBvcnRzLl9yZXNldFJlbmRlcmVycyA9IF9yZXNldFJlbmRlcmVyczsKICAgIGV4cG9ydHMucmVuZGVyU2V0dGxlZCA9IHJlbmRlclNldHRsZWQ7CiAgICBleHBvcnRzLmdldFRlbXBsYXRlID0gZ2V0VGVtcGxhdGU7CiAgICBleHBvcnRzLnNldFRlbXBsYXRlID0gc2V0VGVtcGxhdGU7CiAgICBleHBvcnRzLmhhc1RlbXBsYXRlID0gaGFzVGVtcGxhdGU7CiAgICBleHBvcnRzLmdldFRlbXBsYXRlcyA9IGdldFRlbXBsYXRlczsKICAgIGV4cG9ydHMuc2V0VGVtcGxhdGVzID0gc2V0VGVtcGxhdGVzOwogICAgZXhwb3J0cy5zZXR1cEVuZ2luZVJlZ2lzdHJ5ID0gc2V0dXBFbmdpbmVSZWdpc3RyeTsKICAgIGV4cG9ydHMuc2V0dXBBcHBsaWNhdGlvblJlZ2lzdHJ5ID0gc2V0dXBBcHBsaWNhdGlvblJlZ2lzdHJ5OwogICAgZXhwb3J0cy5fcmVnaXN0ZXJNYWNyb3MgPSByZWdpc3Rlck1hY3JvczsKICAgIGV4cG9ydHMuX2V4cGVyaW1lbnRhbE1hY3JvcyA9IGV4cGVyaW1lbnRhbE1hY3JvczsKICAgIGV4cG9ydHMuQWJzdHJhY3RDb21wb25lbnRNYW5hZ2VyID0gQWJzdHJhY3RNYW5hZ2VyOwogICAgZXhwb3J0cy5VcGRhdGFibGVSZWZlcmVuY2UgPSBVcGRhdGFibGVSZWZlcmVuY2U7CiAgICBleHBvcnRzLklOVk9LRSA9IElOVk9LRTsKICAgIGV4cG9ydHMuaXRlcmFibGVGb3IgPSBfaXRlcmFibGVGb3I7CiAgICBleHBvcnRzLkRlYnVnU3RhY2sgPSBEZWJ1Z1N0YWNrJDE7CiAgICBleHBvcnRzLk91dGxldFZpZXcgPSBPdXRsZXRWaWV3OwogICAgZXhwb3J0cy5DdXN0b21Db21wb25lbnRNYW5hZ2VyID0gQ3VzdG9tQ29tcG9uZW50TWFuYWdlcjsKICAgIGV4cG9ydHMuQ09NUE9ORU5UX01BTkFHRVIgPSBDT01QT05FTlRfTUFOQUdFUjsKICAgIGV4cG9ydHMuY29tcG9uZW50TWFuYWdlciA9IGNvbXBvbmVudE1hbmFnZXI7Cn0pOwplbmlmZWQoJ2VtYmVyLW1ldGEvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YS9saWIvbWV0YSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX21ldGEpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnY291bnRlcnMnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5jb3VudGVyczsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2RlbGV0ZU1ldGEnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5kZWxldGVNZXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZGVzY3JpcHRvckZvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9tZXRhLmRlc2NyaXB0b3JGb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdpc0Rlc2NyaXB0b3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5pc0Rlc2NyaXB0b3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdNZXRhJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX21ldGEuTWV0YTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ21ldGEnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5tZXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAncGVla01ldGEnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5wZWVrTWV0YTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ3NldE1ldGEnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbWV0YS5zZXRNZXRhOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnVU5ERUZJTkVEJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX21ldGEuVU5ERUZJTkVEOwogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1tZXRhL2xpYi9tZXRhJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BlbWJlci9kZWJ1ZycsICdAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcycsICdlbWJlci1lbnZpcm9ubWVudCcsICdlbWJlci11dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9kZWJ1ZywgX2RlcHJlY2F0ZWRGZWF0dXJlcywgX2VtYmVyRW52aXJvbm1lbnQsIF9lbWJlclV0aWxzKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgZXhwb3J0cy5jb3VudGVycyA9IGV4cG9ydHMubWV0YSA9IGV4cG9ydHMuTWV0YSA9IGV4cG9ydHMuVU5ERUZJTkVEID0gdW5kZWZpbmVkOwogICAgZXhwb3J0cy5zZXRNZXRhID0gc2V0TWV0YTsKICAgIGV4cG9ydHMucGVla01ldGEgPSBwZWVrTWV0YTsKICAgIGV4cG9ydHMuZGVsZXRlTWV0YSA9IGRlbGV0ZU1ldGE7CiAgICBleHBvcnRzLmRlc2NyaXB0b3JGb3IgPSBkZXNjcmlwdG9yRm9yOwogICAgZXhwb3J0cy5pc0Rlc2NyaXB0b3IgPSBpc0Rlc2NyaXB0b3I7CgogICAgdmFyIG9iamVjdFByb3RvdHlwZSA9IE9iamVjdC5wcm90b3R5cGU7CiAgICB2YXIgY291bnRlcnMgPSB2b2lkIDA7CiAgICBpZiAodHJ1ZSkgewogICAgICAgIGV4cG9ydHMuY291bnRlcnMgPSBjb3VudGVycyA9IHsKICAgICAgICAgICAgcGVla0NhbGxzOiAwLAogICAgICAgICAgICBwZWVrUHJvdG90eXBlV2Fsa3M6IDAsCiAgICAgICAgICAgIHNldENhbGxzOiAwLAogICAgICAgICAgICBkZWxldGVDYWxsczogMCwKICAgICAgICAgICAgbWV0YUNhbGxzOiAwLAogICAgICAgICAgICBtZXRhSW5zdGFudGlhdGVkOiAwCiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIHZhciBVTkRFRklORUQgPSBleHBvcnRzLlVOREVGSU5FRCA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCd1bmRlZmluZWQnKTsKICAgIC8vIEZMQUdTCiAgICB2YXIgU09VUkNFX0RFU1RST1lJTkcgPSAxIDw8IDE7CiAgICB2YXIgU09VUkNFX0RFU1RST1lFRCA9IDEgPDwgMjsKICAgIHZhciBNRVRBX0RFU1RST1lFRCA9IDEgPDwgMzsKCiAgICB2YXIgTWV0YSA9IGV4cG9ydHMuTWV0YSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBNZXRhKG9iaikgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1ldGEpOwoKICAgICAgICAgICAgaWYgKHRydWUgLyogREVCVUcgKi8pIHsKICAgICAgICAgICAgICAgIGNvdW50ZXJzLm1ldGFJbnN0YW50aWF0ZWQrKzsKICAgICAgICAgICAgICAgIHRoaXMuX3ZhbHVlcyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuX2Rlc2NyaXB0b3JzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLl93YXRjaGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5fbWl4aW5zID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5CSU5ESU5HX1NVUFBPUlQgJiYgX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfQklORElOR19TVVBQT1JUKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9iaW5kaW5ncyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9kZXBzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLl9jaGFpbldhdGNoZXJzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0aGlzLl9jaGFpbnMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuX3RhZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5fdGFncyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgLy8gaW5pdGlhbCB2YWx1ZSBmb3IgYWxsIGZsYWdzIHJpZ2h0IG5vdyBpcyBmYWxzZQogICAgICAgICAgICAvLyBzZWUgRkxBR1MgY29uc3QgZm9yIGRldGFpbGVkIGxpc3Qgb2YgZmxhZ3MgdXNlZAogICAgICAgICAgICB0aGlzLl9mbGFncyA9IDA7CiAgICAgICAgICAgIC8vIHVzZWQgb25seSBpbnRlcm5hbGx5CiAgICAgICAgICAgIHRoaXMuc291cmNlID0gb2JqOwogICAgICAgICAgICAvLyB3aGVuIG1ldGEob2JqKS5wcm90byA9PT0gb2JqLCB0aGUgb2JqZWN0IGlzIGludGVuZGVkIHRvIGJlIG9ubHkgYQogICAgICAgICAgICAvLyBwcm90b3R5cGUgYW5kIGRvZXNuJ3QgbmVlZCB0byBhY3R1YWxseSBiZSBvYnNlcnZhYmxlIGl0c2VsZgogICAgICAgICAgICB0aGlzLnByb3RvID0gb2JqLmNvbnN0cnVjdG9yID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvYmouY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuX2xpc3RlbmVyc0ZpbmFsaXplZCA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgTWV0YS5wcm90b3R5cGUuaXNJbml0aWFsaXplZCA9IGZ1bmN0aW9uIGlzSW5pdGlhbGl6ZWQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3RvICE9PSBvYmo7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRNZXRhRGVzdHJveWVkKCk7CiAgICAgICAgICAgIC8vIHJlbW92ZSBjaGFpbldhdGNoZXJzIHRvIHJlbW92ZSBjaXJjdWxhciByZWZlcmVuY2VzIHRoYXQgd291bGQgcHJldmVudCBHQwogICAgICAgICAgICB2YXIgY2hhaW5zID0gdGhpcy5yZWFkYWJsZUNoYWlucygpOwogICAgICAgICAgICBpZiAoY2hhaW5zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNoYWlucy5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5pc1NvdXJjZURlc3Ryb3lpbmcgPSBmdW5jdGlvbiBpc1NvdXJjZURlc3Ryb3lpbmcoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oYXNGbGFnKFNPVVJDRV9ERVNUUk9ZSU5HKTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5zZXRTb3VyY2VEZXN0cm95aW5nID0gZnVuY3Rpb24gc2V0U291cmNlRGVzdHJveWluZygpIHsKICAgICAgICAgICAgdGhpcy5fZmxhZ3MgfD0gU09VUkNFX0RFU1RST1lJTkc7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuaXNTb3VyY2VEZXN0cm95ZWQgPSBmdW5jdGlvbiBpc1NvdXJjZURlc3Ryb3llZCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhc0ZsYWcoU09VUkNFX0RFU1RST1lFRCk7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuc2V0U291cmNlRGVzdHJveWVkID0gZnVuY3Rpb24gc2V0U291cmNlRGVzdHJveWVkKCkgewogICAgICAgICAgICB0aGlzLl9mbGFncyB8PSBTT1VSQ0VfREVTVFJPWUVEOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLmlzTWV0YURlc3Ryb3llZCA9IGZ1bmN0aW9uIGlzTWV0YURlc3Ryb3llZCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhc0ZsYWcoTUVUQV9ERVNUUk9ZRUQpOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLnNldE1ldGFEZXN0cm95ZWQgPSBmdW5jdGlvbiBzZXRNZXRhRGVzdHJveWVkKCkgewogICAgICAgICAgICB0aGlzLl9mbGFncyB8PSBNRVRBX0RFU1RST1lFRDsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5faGFzRmxhZyA9IGZ1bmN0aW9uIF9oYXNGbGFnKGZsYWcpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLl9mbGFncyAmIGZsYWcpID09PSBmbGFnOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLl9nZXRPckNyZWF0ZU93bk1hcCA9IGZ1bmN0aW9uIF9nZXRPckNyZWF0ZU93bk1hcChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNba2V5XSB8fCAodGhpc1trZXldID0gT2JqZWN0LmNyZWF0ZShudWxsKSk7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuX2dldE9yQ3JlYXRlT3duU2V0ID0gZnVuY3Rpb24gX2dldE9yQ3JlYXRlT3duU2V0KGtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpc1trZXldIHx8ICh0aGlzW2tleV0gPSBuZXcgU2V0KCkpOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLl9nZXRJbmhlcml0ZWQgPSBmdW5jdGlvbiBfZ2V0SW5oZXJpdGVkKGtleSkgewogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwID0gcG9pbnRlcltrZXldOwogICAgICAgICAgICAgICAgaWYgKG1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLl9maW5kSW5oZXJpdGVkID0gZnVuY3Rpb24gX2ZpbmRJbmhlcml0ZWQoa2V5LCBzdWJrZXkpIHsKICAgICAgICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwogICAgICAgICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG1hcCA9IHBvaW50ZXJba2V5XTsKICAgICAgICAgICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG1hcFtzdWJrZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5faGFzSW5Jbmhlcml0ZWRTZXQgPSBmdW5jdGlvbiBfaGFzSW5Jbmhlcml0ZWRTZXQoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc2V0ID0gcG9pbnRlcltrZXldOwogICAgICAgICAgICAgICAgaWYgKHNldCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNldC5oYXModmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgICAgICAvLyBJbXBsZW1lbnRzIGEgbWVtYmVyIHRoYXQgcHJvdmlkZXMgYSBsYXppbHkgY3JlYXRlZCBtYXAgb2YgbWFwcywKICAgICAgICAvLyB3aXRoIGluaGVyaXRhbmNlIGF0IGJvdGggbGV2ZWxzLgoKCiAgICAgICAgTWV0YS5wcm90b3R5cGUud3JpdGVEZXBzID0gZnVuY3Rpb24gd3JpdGVEZXBzKHN1YmtleSwgaXRlbWtleSwgY291bnQpIHsKICAgICAgICAgICAgKHRydWUgJiYgISghdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKHRoaXMuaXNNZXRhRGVzdHJveWVkKCkgPyAnQ2Fubm90IG1vZGlmeSBkZXBlbmRlbnQga2V5cyBmb3IgYCcgKyBpdGVta2V5ICsgJ2Agb24gYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgb3V0ZXJNYXAgPSB0aGlzLl9nZXRPckNyZWF0ZU93bk1hcCgnX2RlcHMnKTsKICAgICAgICAgICAgdmFyIGlubmVyTWFwID0gb3V0ZXJNYXBbc3Via2V5XTsKICAgICAgICAgICAgaWYgKGlubmVyTWFwID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlubmVyTWFwID0gb3V0ZXJNYXBbc3Via2V5XSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5uZXJNYXBbaXRlbWtleV0gPSBjb3VudDsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5wZWVrRGVwcyA9IGZ1bmN0aW9uIHBlZWtEZXBzKHN1YmtleSwgaXRlbWtleSkgewogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwID0gcG9pbnRlci5fZGVwczsKICAgICAgICAgICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG1hcFtzdWJrZXldOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtdmFsdWUgPSB2YWx1ZVtpdGVta2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW12YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXRlbXZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLmhhc0RlcHMgPSBmdW5jdGlvbiBoYXNEZXBzKHN1YmtleSkgewogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVwcyA9IHBvaW50ZXIuX2RlcHM7CiAgICAgICAgICAgICAgICBpZiAoZGVwcyAhPT0gdW5kZWZpbmVkICYmIGRlcHNbc3Via2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLmZvckVhY2hJbkRlcHMgPSBmdW5jdGlvbiBmb3JFYWNoSW5EZXBzKHN1YmtleSwgZm4pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZvckVhY2hJbignX2RlcHMnLCBzdWJrZXksIGZuKTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5fZm9yRWFjaEluID0gZnVuY3Rpb24gX2ZvckVhY2hJbihrZXksIHN1YmtleSwgZm4pIHsKICAgICAgICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwogICAgICAgICAgICB2YXIgc2VlbiA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGNhbGxzID0gdm9pZCAwOwogICAgICAgICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG1hcCA9IHBvaW50ZXJba2V5XTsKICAgICAgICAgICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbm5lck1hcCA9IG1hcFtzdWJrZXldOwogICAgICAgICAgICAgICAgICAgIGlmIChpbm5lck1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGlubmVyS2V5IGluIGlubmVyTWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVuID0gc2VlbiA9PT0gdW5kZWZpbmVkID8gbmV3IFNldCgpIDogc2VlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2Vlbi5oYXMoaW5uZXJLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vlbi5hZGQoaW5uZXJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxzID0gY2FsbHMgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbHMucHVzaChpbm5lcktleSwgaW5uZXJNYXBbaW5uZXJLZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FsbHMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxscy5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICAgICAgICAgIGZuKGNhbGxzW2ldLCBjYWxsc1tpICsgMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUud3JpdGFibGVUYWdzID0gZnVuY3Rpb24gd3JpdGFibGVUYWdzKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0T3JDcmVhdGVPd25NYXAoJ190YWdzJyk7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUucmVhZGFibGVUYWdzID0gZnVuY3Rpb24gcmVhZGFibGVUYWdzKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGFnczsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS53cml0YWJsZVRhZyA9IGZ1bmN0aW9uIHdyaXRhYmxlVGFnKGNyZWF0ZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICdDYW5ub3QgY3JlYXRlIGEgbmV3IHRhZyBmb3IgYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5fdGFnOwogICAgICAgICAgICBpZiAocmV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldCA9IHRoaXMuX3RhZyA9IGNyZWF0ZSh0aGlzLnNvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5yZWFkYWJsZVRhZyA9IGZ1bmN0aW9uIHJlYWRhYmxlVGFnKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGFnOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLndyaXRhYmxlQ2hhaW5XYXRjaGVycyA9IGZ1bmN0aW9uIHdyaXRhYmxlQ2hhaW5XYXRjaGVycyhjcmVhdGUpIHsKICAgICAgICAgICAgKHRydWUgJiYgISghdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKHRoaXMuaXNNZXRhRGVzdHJveWVkKCkgPyAnQ2Fubm90IGNyZWF0ZSBhIG5ldyBjaGFpbiB3YXRjaGVyIGZvciBgJyArICgwLCBfZW1iZXJVdGlscy50b1N0cmluZykodGhpcy5zb3VyY2UpICsgJ2AgYWZ0ZXIgaXQgaGFzIGJlZW4gZGVzdHJveWVkLicgOiAnJywgIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpKTsKCiAgICAgICAgICAgIHZhciByZXQgPSB0aGlzLl9jaGFpbldhdGNoZXJzOwogICAgICAgICAgICBpZiAocmV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldCA9IHRoaXMuX2NoYWluV2F0Y2hlcnMgPSBjcmVhdGUodGhpcy5zb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUucmVhZGFibGVDaGFpbldhdGNoZXJzID0gZnVuY3Rpb24gcmVhZGFibGVDaGFpbldhdGNoZXJzKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY2hhaW5XYXRjaGVyczsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS53cml0YWJsZUNoYWlucyA9IGZ1bmN0aW9uIHdyaXRhYmxlQ2hhaW5zKGNyZWF0ZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICdDYW5ub3QgY3JlYXRlIGEgbmV3IGNoYWlucyBmb3IgYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5fY2hhaW5zOwogICAgICAgICAgICBpZiAocmV0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldCA9IGNyZWF0ZSh0aGlzLnNvdXJjZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldCA9IHRoaXMucGFyZW50LndyaXRhYmxlQ2hhaW5zKGNyZWF0ZSkuY29weSh0aGlzLnNvdXJjZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jaGFpbnMgPSByZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5yZWFkYWJsZUNoYWlucyA9IGZ1bmN0aW9uIHJlYWRhYmxlQ2hhaW5zKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0SW5oZXJpdGVkKCdfY2hhaW5zJyk7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUud3JpdGVXYXRjaGluZyA9IGZ1bmN0aW9uIHdyaXRlV2F0Y2hpbmcoc3Via2V5LCB2YWx1ZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICdDYW5ub3QgdXBkYXRlIHdhdGNoZXJzIGZvciBgJyArIHN1YmtleSArICdgIG9uIGAnICsgKDAsIF9lbWJlclV0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAnYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuJyA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwoKICAgICAgICAgICAgdmFyIG1hcCA9IHRoaXMuX2dldE9yQ3JlYXRlT3duTWFwKCdfd2F0Y2hpbmcnKTsKICAgICAgICAgICAgbWFwW3N1YmtleV0gPSB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5wZWVrV2F0Y2hpbmcgPSBmdW5jdGlvbiBwZWVrV2F0Y2hpbmcoc3Via2V5KSB7CiAgICAgICAgICAgIHZhciBjb3VudCA9IHRoaXMuX2ZpbmRJbmhlcml0ZWQoJ193YXRjaGluZycsIHN1YmtleSk7CiAgICAgICAgICAgIHJldHVybiBjb3VudCA9PT0gdW5kZWZpbmVkID8gMCA6IGNvdW50OwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLmFkZE1peGluID0gZnVuY3Rpb24gYWRkTWl4aW4obWl4aW4pIHsKICAgICAgICAgICAgKHRydWUgJiYgISghdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKHRoaXMuaXNNZXRhRGVzdHJveWVkKCkgPyAnQ2Fubm90IGFkZCBtaXhpbnMgb2YgYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKG1peGluKSArICdgIG9uIGAnICsgKDAsIF9lbWJlclV0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAnYCBjYWxsIGFkZE1peGluIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgc2V0ID0gdGhpcy5fZ2V0T3JDcmVhdGVPd25TZXQoJ19taXhpbnMnKTsKICAgICAgICAgICAgc2V0LmFkZChtaXhpbik7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuaGFzTWl4aW4gPSBmdW5jdGlvbiBoYXNNaXhpbihtaXhpbikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGFzSW5Jbmhlcml0ZWRTZXQoJ19taXhpbnMnLCBtaXhpbik7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUuZm9yRWFjaE1peGlucyA9IGZ1bmN0aW9uIGZvckVhY2hNaXhpbnMoZm4pIHsKICAgICAgICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwogICAgICAgICAgICB2YXIgc2VlbiA9IHZvaWQgMDsKICAgICAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzZXQgPSBwb2ludGVyLl9taXhpbnM7CiAgICAgICAgICAgICAgICBpZiAoc2V0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBzZWVuID0gc2VlbiA9PT0gdW5kZWZpbmVkID8gbmV3IFNldCgpIDogc2VlbjsKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGNsZWFudXAgdHlwaW5nIGhlcmUKICAgICAgICAgICAgICAgICAgICBzZXQuZm9yRWFjaChmdW5jdGlvbiAobWl4aW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWVuLmhhcyhtaXhpbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZW4uYWRkKG1peGluKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKG1peGluKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUud3JpdGVEZXNjcmlwdG9ycyA9IGZ1bmN0aW9uIHdyaXRlRGVzY3JpcHRvcnMoc3Via2V5LCB2YWx1ZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICdDYW5ub3QgdXBkYXRlIGRlc2NyaXB0b3JzIGZvciBgJyArIHN1YmtleSArICdgIG9uIGAnICsgKDAsIF9lbWJlclV0aWxzLnRvU3RyaW5nKSh0aGlzLnNvdXJjZSkgKyAnYCBhZnRlciBpdCBoYXMgYmVlbiBkZXN0cm95ZWQuJyA6ICcnLCAhdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkpOwoKICAgICAgICAgICAgdmFyIG1hcCA9IHRoaXMuX2dldE9yQ3JlYXRlT3duTWFwKCdfZGVzY3JpcHRvcnMnKTsKICAgICAgICAgICAgbWFwW3N1YmtleV0gPSB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5wZWVrRGVzY3JpcHRvcnMgPSBmdW5jdGlvbiBwZWVrRGVzY3JpcHRvcnMoc3Via2V5KSB7CiAgICAgICAgICAgIHZhciBwb3NzaWJsZURlc2MgPSB0aGlzLl9maW5kSW5oZXJpdGVkKCdfZGVzY3JpcHRvcnMnLCBzdWJrZXkpOwogICAgICAgICAgICByZXR1cm4gcG9zc2libGVEZXNjID09PSBVTkRFRklORUQgPyB1bmRlZmluZWQgOiBwb3NzaWJsZURlc2M7CiAgICAgICAgfTsKCiAgICAgICAgTWV0YS5wcm90b3R5cGUucmVtb3ZlRGVzY3JpcHRvcnMgPSBmdW5jdGlvbiByZW1vdmVEZXNjcmlwdG9ycyhzdWJrZXkpIHsKICAgICAgICAgICAgdGhpcy53cml0ZURlc2NyaXB0b3JzKHN1YmtleSwgVU5ERUZJTkVEKTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5mb3JFYWNoRGVzY3JpcHRvcnMgPSBmdW5jdGlvbiBmb3JFYWNoRGVzY3JpcHRvcnMoZm4pIHsKICAgICAgICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzOwogICAgICAgICAgICB2YXIgc2VlbiA9IHZvaWQgMDsKICAgICAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBtYXAgPSBwb2ludGVyLl9kZXNjcmlwdG9yczsKICAgICAgICAgICAgICAgIGlmIChtYXAgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBtYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VlbiA9IHNlZW4gPT09IHVuZGVmaW5lZCA/IG5ldyBTZXQoKSA6IHNlZW47CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2Vlbi5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vlbi5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG1hcFtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBVTkRFRklORUQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbihrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLmFkZFRvTGlzdGVuZXJzID0gZnVuY3Rpb24gYWRkVG9MaXN0ZW5lcnMoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCwgb25jZSkgewogICAgICAgICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX2xpc3RlbmVycy5wdXNoKGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QsIG9uY2UpOwogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLl9maW5hbGl6ZUxpc3RlbmVycyA9IGZ1bmN0aW9uIF9maW5hbGl6ZUxpc3RlbmVycygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2xpc3RlbmVyc0ZpbmFsaXplZCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBvaW50ZXIgPSB0aGlzLnBhcmVudDsKICAgICAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBwb2ludGVyLl9saXN0ZW5lcnM7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMuY29uY2F0KGxpc3RlbmVycyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocG9pbnRlci5fbGlzdGVuZXJzRmluYWxpemVkKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbGlzdGVuZXJzRmluYWxpemVkID0gdHJ1ZTsKICAgICAgICB9OwoKICAgICAgICBNZXRhLnByb3RvdHlwZS5yZW1vdmVGcm9tTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlRnJvbUxpc3RlbmVycyhldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgICAgICAgIHZhciBwb2ludGVyID0gdGhpczsKICAgICAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBwb2ludGVyLl9saXN0ZW5lcnM7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IGxpc3RlbmVycy5sZW5ndGggLSA0OyBpbmRleCA+PSAwOyBpbmRleCAtPSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaW5kZXhdID09PSBldmVudE5hbWUgJiYgKCFtZXRob2QgfHwgbGlzdGVuZXJzW2luZGV4ICsgMV0gPT09IHRhcmdldCAmJiBsaXN0ZW5lcnNbaW5kZXggKyAyXSA9PT0gbWV0aG9kKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvaW50ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCA0KTsgLy8gd2UgYXJlIG1vZGlmeWluZyBvdXIgb3duIGxpc3QsIHNvIHdlIGVkaXQgZGlyZWN0bHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyeWluZyB0byByZW1vdmUgYW4gaW5oZXJpdGVkIGxpc3RlbmVyLCBzbyB3ZSBkbwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGp1c3QtaW4tdGltZSBjb3B5aW5nIHRvIGRldGFjaCBvdXIgb3duIGxpc3RlbmVycyBmcm9tCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3VyIGluaGVyaXRhbmNlIGNoYWluLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2ZpbmFsaXplTGlzdGVuZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlRnJvbUxpc3RlbmVycyhldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwb2ludGVyLl9saXN0ZW5lcnNGaW5hbGl6ZWQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE1ldGEucHJvdG90eXBlLm1hdGNoaW5nTGlzdGVuZXJzID0gZnVuY3Rpb24gbWF0Y2hpbmdMaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgICAgICAgIHZhciBwb2ludGVyID0gdGhpczsKICAgICAgICAgICAgLy8gZml4IHR5cGUKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBwb2ludGVyLl9saXN0ZW5lcnM7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgbGlzdGVuZXJzLmxlbmd0aDsgaW5kZXggKz0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXJzW2luZGV4XSA9PT0gZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQgfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoVW5pcXVlTGlzdGVuZXIocmVzdWx0LCBsaXN0ZW5lcnMsIGluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwb2ludGVyLl9saXN0ZW5lcnNGaW5hbGl6ZWQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBwb2ludGVyLnBhcmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoTWV0YSwgW3sKICAgICAgICAgICAga2V5OiAncGFyZW50JywKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5fcGFyZW50OwogICAgICAgICAgICAgICAgaWYgKHBhcmVudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3RvID0gZ2V0UHJvdG90eXBlT2YodGhpcy5zb3VyY2UpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudCA9IHByb3RvID09PSBudWxsIHx8IHByb3RvID09PSBvYmplY3RQcm90b3R5cGUgPyBudWxsIDogbWV0YShwcm90byk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBNZXRhOwogICAgfSgpOwoKICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkJJTkRJTkdfU1VQUE9SVCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9CSU5ESU5HX1NVUFBPUlQpIHsKICAgICAgICBNZXRhLnByb3RvdHlwZS53cml0ZUJpbmRpbmdzID0gZnVuY3Rpb24gKHN1YmtleSwgdmFsdWUpIHsKICAgICAgICAgICAgKHRydWUgJiYgISghdGhpcy5pc01ldGFEZXN0cm95ZWQoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKHRoaXMuaXNNZXRhRGVzdHJveWVkKCkgPyAnQ2Fubm90IGFkZCBhIGJpbmRpbmcgZm9yIGAnICsgc3Via2V5ICsgJ2Agb24gYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgbWFwID0gdGhpcy5fZ2V0T3JDcmVhdGVPd25NYXAoJ19iaW5kaW5ncycpOwogICAgICAgICAgICBtYXBbc3Via2V5XSA9IHZhbHVlOwogICAgICAgIH07CiAgICAgICAgTWV0YS5wcm90b3R5cGUucGVla0JpbmRpbmdzID0gZnVuY3Rpb24gKHN1YmtleSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZmluZEluaGVyaXRlZCgnX2JpbmRpbmdzJywgc3Via2V5KTsKICAgICAgICB9OwogICAgICAgIE1ldGEucHJvdG90eXBlLmZvckVhY2hCaW5kaW5ncyA9IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHZhciBzZWVuID0gdm9pZCAwOwogICAgICAgICAgICB3aGlsZSAocG9pbnRlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG1hcCA9IHBvaW50ZXIuX2JpbmRpbmdzOwogICAgICAgICAgICAgICAgaWYgKG1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbnVwIHR5cGluZwogICAgICAgICAgICAgICAgICAgICAgICBzZWVuID0gc2VlbiA9PT0gdW5kZWZpbmVkID8gT2JqZWN0LmNyZWF0ZShudWxsKSA6IHNlZW47CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWVuW2tleV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VlbltrZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKGtleSwgbWFwW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBNZXRhLnByb3RvdHlwZS5jbGVhckJpbmRpbmdzID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkodGhpcy5pc01ldGFEZXN0cm95ZWQoKSA/ICdDYW5ub3QgY2xlYXIgYmluZGluZ3Mgb24gYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB0aGlzLl9iaW5kaW5ncyA9IHVuZGVmaW5lZDsKICAgICAgICB9OwogICAgfQogICAgaWYgKHRydWUpIHsKICAgICAgICBNZXRhLnByb3RvdHlwZS53cml0ZVZhbHVlcyA9IGZ1bmN0aW9uIChzdWJrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICh0cnVlICYmICEoIXRoaXMuaXNNZXRhRGVzdHJveWVkKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSh0aGlzLmlzTWV0YURlc3Ryb3llZCgpID8gJ0Nhbm5vdCBzZXQgdGhlIHZhbHVlIG9mIGAnICsgc3Via2V5ICsgJ2Agb24gYCcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMuc291cmNlKSArICdgIGFmdGVyIGl0IGhhcyBiZWVuIGRlc3Ryb3llZC4nIDogJycsICF0aGlzLmlzTWV0YURlc3Ryb3llZCgpKSk7CgogICAgICAgICAgICB2YXIgbWFwID0gdGhpcy5fZ2V0T3JDcmVhdGVPd25NYXAoJ192YWx1ZXMnKTsKICAgICAgICAgICAgbWFwW3N1YmtleV0gPSB2YWx1ZTsKICAgICAgICB9OwogICAgICAgIE1ldGEucHJvdG90eXBlLnBlZWtWYWx1ZXMgPSBmdW5jdGlvbiAoc3Via2V5KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5kSW5oZXJpdGVkKCdfdmFsdWVzJywgc3Via2V5KTsKICAgICAgICB9OwogICAgICAgIE1ldGEucHJvdG90eXBlLmRlbGV0ZUZyb21WYWx1ZXMgPSBmdW5jdGlvbiAoc3Via2V5KSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9nZXRPckNyZWF0ZU93bk1hcCgnX3ZhbHVlcycpW3N1YmtleV07CiAgICAgICAgfTsKICAgICAgICBNZXRhLnByb3RvdHlwZS5yZWFkSW5oZXJpdGVkVmFsdWUgPSBmdW5jdGlvbiAoa2V5LCBzdWJrZXkpIHsKICAgICAgICAgICAgdmFyIGludGVybmFsS2V5ID0gJ18nICsga2V5OwogICAgICAgICAgICB2YXIgcG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlIChwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwID0gcG9pbnRlcltpbnRlcm5hbEtleV07CiAgICAgICAgICAgICAgICBpZiAobWFwICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBtYXBbc3Via2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCB8fCBzdWJrZXkgaW4gbWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb2ludGVyID0gcG9pbnRlci5wYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFVOREVGSU5FRDsKICAgICAgICB9OwogICAgICAgIE1ldGEucHJvdG90eXBlLndyaXRlVmFsdWUgPSBmdW5jdGlvbiAob2JqLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gKDAsIF9lbWJlclV0aWxzLmxvb2t1cERlc2NyaXB0b3IpKG9iaiwga2V5KTsKICAgICAgICAgICAgdmFyIGlzTWFuZGF0b3J5U2V0dGVyID0gZGVzY3JpcHRvciAhPT0gbnVsbCAmJiBkZXNjcmlwdG9yLnNldCAmJiBkZXNjcmlwdG9yLnNldC5pc01hbmRhdG9yeVNldHRlcjsKICAgICAgICAgICAgaWYgKGlzTWFuZGF0b3J5U2V0dGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzLndyaXRlVmFsdWVzKGtleSwgdmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb2JqW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICB2YXIgZ2V0UHJvdG90eXBlT2YgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CiAgICB2YXIgbWV0YVN0b3JlID0gbmV3IFdlYWtNYXAoKTsKICAgIGZ1bmN0aW9uIHNldE1ldGEob2JqLCBtZXRhKSB7CiAgICAgICAgKHRydWUgJiYgIShvYmogIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYHNldE1ldGFgIG9uIG51bGwnLCBvYmogIT09IG51bGwpKTsKICAgICAgICAodHJ1ZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBzZXRNZXRhYCBvbiB1bmRlZmluZWQnLCBvYmogIT09IHVuZGVmaW5lZCkpOwogICAgICAgICh0cnVlICYmICEodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgc2V0TWV0YWAgb24gJyArIHR5cGVvZiBvYmosIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKCiAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgY291bnRlcnMuc2V0Q2FsbHMrKzsKICAgICAgICB9CiAgICAgICAgbWV0YVN0b3JlLnNldChvYmosIG1ldGEpOwogICAgfQogICAgZnVuY3Rpb24gcGVla01ldGEob2JqKSB7CiAgICAgICAgKHRydWUgJiYgIShvYmogIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYHBlZWtNZXRhYCBvbiBudWxsJywgb2JqICE9PSBudWxsKSk7CiAgICAgICAgKHRydWUgJiYgIShvYmogIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgcGVla01ldGFgIG9uIHVuZGVmaW5lZCcsIG9iaiAhPT0gdW5kZWZpbmVkKSk7CiAgICAgICAgKHRydWUgJiYgISh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBwZWVrTWV0YWAgb24gJyArIHR5cGVvZiBvYmosIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKCiAgICAgICAgdmFyIHBvaW50ZXIgPSBvYmo7CiAgICAgICAgdmFyIG1ldGEgPSB2b2lkIDA7CiAgICAgICAgd2hpbGUgKHBvaW50ZXIgIT09IHVuZGVmaW5lZCAmJiBwb2ludGVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1ldGEgPSBtZXRhU3RvcmUuZ2V0KHBvaW50ZXIpOwogICAgICAgICAgICAvLyBqc2hpbnQgbG9vcGZ1bmM6dHJ1ZQogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgY291bnRlcnMucGVla0NhbGxzKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1ldGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9pbnRlciA9IGdldFByb3RvdHlwZU9mKHBvaW50ZXIpOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgY291bnRlcnMucGVla1Byb3RvdHlwZVdhbGtzKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICAgVGVhcnMgZG93biB0aGUgbWV0YSBvbiBhbiBvYmplY3Qgc28gdGhhdCBpdCBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQuCiAgICAgIE11bHRpcGxlIGNhbGxzIHdpbGwgaGF2ZSBubyBlZmZlY3QuCiAgICAKICAgICAgQG1ldGhvZCBkZWxldGVNZXRhCiAgICAgIEBmb3IgRW1iZXIKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iaiAgdGhlIG9iamVjdCB0byBkZXN0cm95CiAgICAgIEByZXR1cm4ge3ZvaWR9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gZGVsZXRlTWV0YShvYmopIHsKICAgICAgICAodHJ1ZSAmJiAhKG9iaiAhPT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgZGVsZXRlTWV0YWAgb24gbnVsbCcsIG9iaiAhPT0gbnVsbCkpOwogICAgICAgICh0cnVlICYmICEob2JqICE9PSB1bmRlZmluZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYGRlbGV0ZU1ldGFgIG9uIHVuZGVmaW5lZCcsIG9iaiAhPT0gdW5kZWZpbmVkKSk7CiAgICAgICAgKHRydWUgJiYgISh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBkZWxldGVNZXRhYCBvbiAnICsgdHlwZW9mIG9iaiwgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICBjb3VudGVycy5kZWxldGVDYWxscysrOwogICAgICAgIH0KICAgICAgICB2YXIgbWV0YSA9IHBlZWtNZXRhKG9iaik7CiAgICAgICAgaWYgKG1ldGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBtZXRhLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICAgUmV0cmlldmVzIHRoZSBtZXRhIGhhc2ggZm9yIGFuIG9iamVjdC4gSWYgYHdyaXRhYmxlYCBpcyB0cnVlIGVuc3VyZXMgdGhlCiAgICAgIGhhc2ggaXMgd3JpdGFibGUgZm9yIHRoaXMgb2JqZWN0IGFzIHdlbGwuCiAgICAKICAgICAgVGhlIG1ldGEgb2JqZWN0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IGNvbXB1dGVkIHByb3BlcnR5IGRlc2NyaXB0b3JzIGFzCiAgICAgIHdlbGwgYXMgYW55IHdhdGNoZWQgcHJvcGVydGllcyBhbmQgb3RoZXIgaW5mb3JtYXRpb24uIFlvdSBnZW5lcmFsbHkgd2lsbAogICAgICBub3QgYWNjZXNzIHRoaXMgaW5mb3JtYXRpb24gZGlyZWN0bHkgYnV0IGluc3RlYWQgd29yayB3aXRoIGhpZ2hlciBsZXZlbAogICAgICBtZXRob2RzIHRoYXQgbWFuaXB1bGF0ZSB0aGlzIGhhc2ggaW5kaXJlY3RseS4KICAgIAogICAgICBAbWV0aG9kIG1ldGEKICAgICAgQGZvciBFbWJlcgogICAgICBAcHJpdmF0ZQogICAgCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byByZXRyaWV2ZSBtZXRhIGZvcgogICAgICBAcGFyYW0ge0Jvb2xlYW59IFt3cml0YWJsZT10cnVlXSBQYXNzIGBmYWxzZWAgaWYgeW91IGRvIG5vdCBpbnRlbmQgdG8gbW9kaWZ5CiAgICAgICAgdGhlIG1ldGEgaGFzaCwgYWxsb3dpbmcgdGhlIG1ldGhvZCB0byBhdm9pZCBtYWtpbmcgYW4gdW5uZWNlc3NhcnkgY29weS4KICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgbWV0YSBoYXNoIGZvciBhbiBvYmplY3QKICAgICovCiAgICB2YXIgbWV0YSA9IGV4cG9ydHMubWV0YSA9IGZ1bmN0aW9uIG1ldGEob2JqKSB7CiAgICAgICAgKHRydWUgJiYgIShvYmogIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYG1ldGFgIG9uIG51bGwnLCBvYmogIT09IG51bGwpKTsKICAgICAgICAodHJ1ZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBtZXRhYCBvbiB1bmRlZmluZWQnLCBvYmogIT09IHVuZGVmaW5lZCkpOwogICAgICAgICh0cnVlICYmICEodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgbWV0YWAgb24gJyArIHR5cGVvZiBvYmosIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpKTsKCiAgICAgICAgaWYgKHRydWUgLyogREVCVUcgKi8pIHsKICAgICAgICAgICAgY291bnRlcnMubWV0YUNhbGxzKys7CiAgICAgICAgfQogICAgICAgIHZhciBtYXliZU1ldGEgPSBwZWVrTWV0YShvYmopOwogICAgICAgIC8vIHJlbW92ZSB0aGlzIGNvZGUsIGluLWZhdm9yIG9mIGV4cGxpY2l0IHBhcmVudAogICAgICAgIGlmIChtYXliZU1ldGEgIT09IHVuZGVmaW5lZCAmJiBtYXliZU1ldGEuc291cmNlID09PSBvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlTWV0YTsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld01ldGEgPSBuZXcgTWV0YShvYmopOwogICAgICAgIHNldE1ldGEob2JqLCBuZXdNZXRhKTsKICAgICAgICByZXR1cm4gbmV3TWV0YTsKICAgIH07CiAgICBpZiAodHJ1ZSkgewogICAgICAgIG1ldGEuX2NvdW50ZXJzID0gY291bnRlcnM7CiAgICB9CiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgQ1AgZGVzY3JpcHRvciBhc3NvY2FpdGVkIHdpdGggYG9iamAgYW5kIGBrZXlOYW1lYCwgaWYgYW55LgogICAgCiAgICAgIEBtZXRob2QgZGVzY3JpcHRvckZvcgogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIHRoZSBvYmplY3QgdG8gY2hlY2sKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgdGhlIGtleSB0byBjaGVjawogICAgICBAcmV0dXJuIHtEZXNjcmlwdG9yfQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGRlc2NyaXB0b3JGb3Iob2JqLCBrZXlOYW1lLCBfbWV0YSkgewogICAgICAgICh0cnVlICYmICEob2JqICE9PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIGBkZXNjcmlwdG9yRm9yYCBvbiBudWxsJywgb2JqICE9PSBudWxsKSk7CiAgICAgICAgKHRydWUgJiYgIShvYmogIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBgZGVzY3JpcHRvckZvcmAgb24gdW5kZWZpbmVkJywgb2JqICE9PSB1bmRlZmluZWQpKTsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYGRlc2NyaXB0b3JGb3JgIG9uICcgKyB0eXBlb2Ygb2JqLCB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSk7CgogICAgICAgIHZhciBtZXRhID0gX21ldGEgPT09IHVuZGVmaW5lZCA/IHBlZWtNZXRhKG9iaikgOiBfbWV0YTsKICAgICAgICBpZiAobWV0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBtZXRhLnBlZWtEZXNjcmlwdG9ycyhrZXlOYW1lKTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICAgQ2hlY2sgd2hldGhlciBhIHZhbHVlIGlzIGEgQ1AgZGVzY3JpcHRvci4KICAgIAogICAgICBAbWV0aG9kIGRlc2NyaXB0b3JGb3IKICAgICAgQHBhcmFtIHthbnl9IHBvc3NpYmxlRGVzYyB0aGUgdmFsdWUgdG8gY2hlY2sKICAgICAgQHJldHVybiB7Ym9vbGVhbn0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBmdW5jdGlvbiBpc0Rlc2NyaXB0b3IocG9zc2libGVEZXNjKSB7CiAgICAgICAgLy8gVE9ETyBtYWtlIHRoaXMgcmV0dXJuIGBwb3NzaWJsZURlc2MgaXMgRGVzY3JpcHRvcmAKICAgICAgICByZXR1cm4gcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQgJiYgcG9zc2libGVEZXNjICE9PSBudWxsICYmIHR5cGVvZiBwb3NzaWJsZURlc2MgPT09ICdvYmplY3QnICYmIHBvc3NpYmxlRGVzYy5pc0Rlc2NyaXB0b3IgPT09IHRydWU7CiAgICB9CiAgICBleHBvcnRzLmNvdW50ZXJzID0gY291bnRlcnM7CgogICAgLyoKICAgICBXaGVuIHdlIHJlbmRlciBhIHJpY2ggdGVtcGxhdGUgaGllcmFyY2h5LCB0aGUgc2V0IG9mIGV2ZW50cyB0aGF0CiAgICAgKm1pZ2h0KiBoYXBwZW4gdGVuZHMgdG8gYmUgbXVjaCBsYXJnZXIgdGhhbiB0aGUgc2V0IG9mIGV2ZW50cyB0aGF0CiAgICAgYWN0dWFsbHkgaGFwcGVuLiBUaGlzIGltcGxpZXMgdGhhdCB3ZSBzaG91bGQgbWFrZSBsaXN0ZW5lciBjcmVhdGlvbiAmCiAgICAgZGVzdHJ1Y3Rpb24gY2hlYXAsIGV2ZW4gYXQgdGhlIGNvc3Qgb2YgbWFraW5nIGV2ZW50IGRpc3BhdGNoIG1vcmUKICAgICBleHBlbnNpdmUuCiAgICAKICAgICBUaHVzIHdlIHN0b3JlIGEgbmV3IGxpc3RlbmVyIHdpdGggYSBzaW5nbGUgcHVzaCBhbmQgbm8gbmV3CiAgICAgYWxsb2NhdGlvbnMsIHdpdGhvdXQgZXZlbiBib3RoZXJpbmcgdG8gZG8gZGVkdXBsaWNhdGlvbiAtLSB3ZSBjYW4KICAgICBzYXZlIHRoYXQgZm9yIGRpc3BhdGNoIHRpbWUsIGlmIGFuIGV2ZW50IGFjdHVhbGx5IGhhcHBlbnMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHB1c2hVbmlxdWVMaXN0ZW5lcihkZXN0aW5hdGlvbiwgc291cmNlLCBpbmRleCkgewogICAgICAgIHZhciB0YXJnZXQgPSBzb3VyY2VbaW5kZXggKyAxXTsKICAgICAgICB2YXIgbWV0aG9kID0gc291cmNlW2luZGV4ICsgMl07CiAgICAgICAgZm9yICh2YXIgZGVzdGluYXRpb25JbmRleCA9IDA7IGRlc3RpbmF0aW9uSW5kZXggPCBkZXN0aW5hdGlvbi5sZW5ndGg7IGRlc3RpbmF0aW9uSW5kZXggKz0gMykgewogICAgICAgICAgICBpZiAoZGVzdGluYXRpb25bZGVzdGluYXRpb25JbmRleF0gPT09IHRhcmdldCAmJiBkZXN0aW5hdGlvbltkZXN0aW5hdGlvbkluZGV4ICsgMV0gPT09IG1ldGhvZCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRlc3RpbmF0aW9uLnB1c2godGFyZ2V0LCBtZXRob2QsIHNvdXJjZVtpbmRleCArIDNdKTsKICAgIH0KICAgIC8vIyBzb3VyY2VNYXBwaW5nVVJMPW1ldGEuanMubWFwCn0pOwplbmlmZWQoJ2VtYmVyLW1ldGFsJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnZW1iZXItdXRpbHMnLCAnQGVtYmVyL2RlYnVnJywgJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzJywgJ2VtYmVyLWVudmlyb25tZW50JywgJ2VtYmVyLW1ldGEnLCAnQGVtYmVyL3J1bmxvb3AnLCAnQGdsaW1tZXIvcmVmZXJlbmNlJywgJ0BlbWJlci9lcnJvcicsICdlbWJlci92ZXJzaW9uJywgJ2VtYmVyLW93bmVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX3BvbHlmaWxscywgX2VtYmVyVXRpbHMsIF9kZWJ1ZywgX2RlcHJlY2F0ZWRGZWF0dXJlcywgX2VtYmVyRW52aXJvbm1lbnQsIF9lbWJlck1ldGEsIF9ydW5sb29wLCBfcmVmZXJlbmNlLCBfZXJyb3IsIF92ZXJzaW9uLCBfZW1iZXJPd25lcikgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGV4cG9ydHMuc2V0TmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQgPSBleHBvcnRzLmlzTmFtZXNwYWNlU2VhcmNoRGlzYWJsZWQgPSBleHBvcnRzLnJlbW92ZU5hbWVzcGFjZSA9IGV4cG9ydHMucHJvY2Vzc0FsbE5hbWVzcGFjZXMgPSBleHBvcnRzLnByb2Nlc3NOYW1lc3BhY2UgPSBleHBvcnRzLmZpbmROYW1lc3BhY2VzID0gZXhwb3J0cy5maW5kTmFtZXNwYWNlID0gZXhwb3J0cy5jbGFzc1RvU3RyaW5nID0gZXhwb3J0cy5hZGROYW1lc3BhY2UgPSBleHBvcnRzLk5BTUVTUEFDRVNfQllfSUQgPSBleHBvcnRzLk5BTUVTUEFDRVMgPSBleHBvcnRzLnRyYWNrZWQgPSBleHBvcnRzLmRlc2NyaXB0b3IgPSBleHBvcnRzLmFzc2VydE5vdFJlbmRlcmVkID0gZXhwb3J0cy5kaWRSZW5kZXIgPSBleHBvcnRzLnJ1bkluVHJhbnNhY3Rpb24gPSBleHBvcnRzLm1hcmtPYmplY3RBc0RpcnR5ID0gZXhwb3J0cy50YWdGb3IgPSBleHBvcnRzLnRhZ0ZvclByb3BlcnR5ID0gZXhwb3J0cy5zZXRIYXNWaWV3cyA9IGV4cG9ydHMuSW5qZWN0ZWRQcm9wZXJ0eSA9IGV4cG9ydHMub2JzZXJ2ZXIgPSBleHBvcnRzLm1peGluID0gZXhwb3J0cy5hbGlhc01ldGhvZCA9IGV4cG9ydHMuTWl4aW4gPSBleHBvcnRzLnJlbW92ZU9ic2VydmVyID0gZXhwb3J0cy5hZGRPYnNlcnZlciA9IGV4cG9ydHMuZXhwYW5kUHJvcGVydGllcyA9IGV4cG9ydHMuc2V0UHJvcGVydGllcyA9IGV4cG9ydHMuZ2V0UHJvcGVydGllcyA9IGV4cG9ydHMuTGlicmFyaWVzID0gZXhwb3J0cy5saWJyYXJpZXMgPSBleHBvcnRzLndhdGNoZXJDb3VudCA9IGV4cG9ydHMud2F0Y2ggPSBleHBvcnRzLnVud2F0Y2ggPSBleHBvcnRzLmlzV2F0Y2hpbmcgPSBleHBvcnRzLnVud2F0Y2hQYXRoID0gZXhwb3J0cy53YXRjaFBhdGggPSBleHBvcnRzLnJlbW92ZUNoYWluV2F0Y2hlciA9IGV4cG9ydHMuZmluaXNoQ2hhaW5zID0gZXhwb3J0cy5DaGFpbk5vZGUgPSBleHBvcnRzLnVud2F0Y2hLZXkgPSBleHBvcnRzLndhdGNoS2V5ID0gZXhwb3J0cy5EZXNjcmlwdG9yID0gZXhwb3J0cy5kZWZpbmVQcm9wZXJ0eSA9IGV4cG9ydHMuUFJPUEVSVFlfRElEX0NIQU5HRSA9IGV4cG9ydHMucHJvcGVydHlXaWxsQ2hhbmdlID0gZXhwb3J0cy5wcm9wZXJ0eURpZENoYW5nZSA9IGV4cG9ydHMub3ZlcnJpZGVDaGFpbnMgPSBleHBvcnRzLm5vdGlmeVByb3BlcnR5Q2hhbmdlID0gZXhwb3J0cy5lbmRQcm9wZXJ0eUNoYW5nZXMgPSBleHBvcnRzLmNoYW5nZVByb3BlcnRpZXMgPSBleHBvcnRzLmJlZ2luUHJvcGVydHlDaGFuZ2VzID0gZXhwb3J0cy5pc1ByZXNlbnQgPSBleHBvcnRzLmlzQmxhbmsgPSBleHBvcnRzLmlzRW1wdHkgPSBleHBvcnRzLmlzTm9uZSA9IGV4cG9ydHMuc2VuZEV2ZW50ID0gZXhwb3J0cy5yZW1vdmVMaXN0ZW5lciA9IGV4cG9ydHMub24gPSBleHBvcnRzLmhhc0xpc3RlbmVycyA9IGV4cG9ydHMuYWRkTGlzdGVuZXIgPSBleHBvcnRzLmVhY2hQcm94eUFycmF5RGlkQ2hhbmdlID0gZXhwb3J0cy5lYWNoUHJveHlBcnJheVdpbGxDaGFuZ2UgPSBleHBvcnRzLmVhY2hQcm94eUZvciA9IGV4cG9ydHMuYXJyYXlDb250ZW50RGlkQ2hhbmdlID0gZXhwb3J0cy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlID0gZXhwb3J0cy5yZW1vdmVBcnJheU9ic2VydmVyID0gZXhwb3J0cy5hZGRBcnJheU9ic2VydmVyID0gZXhwb3J0cy5yZXBsYWNlSW5OYXRpdmVBcnJheSA9IGV4cG9ydHMucmVwbGFjZSA9IGV4cG9ydHMub2JqZWN0QXQgPSBleHBvcnRzLnRyeVNldCA9IGV4cG9ydHMuc2V0ID0gZXhwb3J0cy5nZXRXaXRoRGVmYXVsdCA9IGV4cG9ydHMuZ2V0ID0gZXhwb3J0cy5fZ2V0UGF0aCA9IGV4cG9ydHMuUFJPWFlfQ09OVEVOVCA9IGV4cG9ydHMuZGVwcmVjYXRlUHJvcGVydHkgPSBleHBvcnRzLmFsaWFzID0gZXhwb3J0cy5wZWVrQ2FjaGVGb3IgPSBleHBvcnRzLmdldENhY2hlZFZhbHVlRm9yID0gZXhwb3J0cy5nZXRDYWNoZUZvciA9IGV4cG9ydHMuX2dsb2JhbHNDb21wdXRlZCA9IGV4cG9ydHMuQ29tcHV0ZWRQcm9wZXJ0eSA9IGV4cG9ydHMuY29tcHV0ZWQgPSB1bmRlZmluZWQ7CgoKICAgIHZhciBDT01QVVRFRF9QUk9QRVJUWV9DQUNIRURfVkFMVUVTID0gbmV3IFdlYWtNYXAoKTsKICAgIHZhciBDT01QVVRFRF9QUk9QRVJUWV9MQVNUX1JFVklTSU9OID0gZmFsc2UgPyBuZXcgV2Vha01hcCgpIDogdW5kZWZpbmVkOwogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGNhY2hlZCB2YWx1ZSBmb3IgYSBwcm9wZXJ0eSwgaWYgb25lIGV4aXN0cy4KICAgICAgVGhpcyBjYW4gYmUgdXNlZnVsIGZvciBwZWVraW5nIGF0IHRoZSB2YWx1ZSBvZiBhIGNvbXB1dGVkCiAgICAgIHByb3BlcnR5IHRoYXQgaXMgZ2VuZXJhdGVkIGxhemlseSwgd2l0aG91dCBhY2NpZGVudGFsbHkgY2F1c2luZwogICAgICBpdCB0byBiZSBjcmVhdGVkLgogICAgCiAgICAgIEBtZXRob2QgY2FjaGVGb3IKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci9vYmplY3QvaW50ZXJuYWxzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogdGhlIG9iamVjdCB3aG9zZSBwcm9wZXJ0eSB5b3Ugd2FudCB0byBjaGVjawogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5IHRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB3aG9zZSBjYWNoZWQgdmFsdWUgeW91IHdhbnQKICAgICAgICB0byByZXR1cm4KICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgY2FjaGVkIHZhbHVlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBnZXRDYWNoZUZvcihvYmopIHsKICAgICAgICB2YXIgY2FjaGUgPSBDT01QVVRFRF9QUk9QRVJUWV9DQUNIRURfVkFMVUVTLmdldChvYmopOwogICAgICAgIGlmIChjYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNhY2hlID0gbmV3IE1hcCgpOwogICAgICAgICAgICBpZiAoZmFsc2UpIHsKICAgICAgICAgICAgICAgIENPTVBVVEVEX1BST1BFUlRZX0xBU1RfUkVWSVNJT04uc2V0KG9iaiwgbmV3IE1hcCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBDT01QVVRFRF9QUk9QRVJUWV9DQUNIRURfVkFMVUVTLnNldChvYmosIGNhY2hlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlOwogICAgfQogICAgZnVuY3Rpb24gZ2V0Q2FjaGVkVmFsdWVGb3Iob2JqLCBrZXkpIHsKICAgICAgICB2YXIgY2FjaGUgPSBDT01QVVRFRF9QUk9QRVJUWV9DQUNIRURfVkFMVUVTLmdldChvYmopOwogICAgICAgIGlmIChjYWNoZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBjYWNoZS5nZXQoa2V5KTsKICAgICAgICB9CiAgICB9CiAgICB2YXIgc2V0TGFzdFJldmlzaW9uRm9yID0gdm9pZCAwOwogICAgdmFyIGdldExhc3RSZXZpc2lvbkZvciA9IHZvaWQgMDsKICAgIGlmIChmYWxzZSkgewogICAgICAgIHNldExhc3RSZXZpc2lvbkZvciA9IGZ1bmN0aW9uIChvYmosIGtleSwgcmV2aXNpb24pIHsKICAgICAgICAgICAgdmFyIGxhc3RSZXZpc2lvbiA9IENPTVBVVEVEX1BST1BFUlRZX0xBU1RfUkVWSVNJT04uZ2V0KG9iaik7CiAgICAgICAgICAgIGxhc3RSZXZpc2lvbi5zZXQoa2V5LCByZXZpc2lvbik7CiAgICAgICAgfTsKICAgICAgICBnZXRMYXN0UmV2aXNpb25Gb3IgPSBmdW5jdGlvbiAob2JqLCBrZXkpIHsKICAgICAgICAgICAgdmFyIGNhY2hlID0gQ09NUFVURURfUFJPUEVSVFlfTEFTVF9SRVZJU0lPTi5nZXQob2JqKTsKICAgICAgICAgICAgaWYgKGNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHJldmlzaW9uID0gY2FjaGUuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV2aXNpb24gPT09IHVuZGVmaW5lZCA/IDAgOiByZXZpc2lvbjsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBwZWVrQ2FjaGVGb3Iob2JqKSB7CiAgICAgICAgcmV0dXJuIENPTVBVVEVEX1BST1BFUlRZX0NBQ0hFRF9WQUxVRVMuZ2V0KG9iaik7CiAgICB9CgogICAgdmFyIGZpcnN0RG90SW5kZXhDYWNoZSA9IG5ldyBfZW1iZXJVdGlscy5DYWNoZSgxMDAwLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleS5pbmRleE9mKCcuJyk7CiAgICB9KTsKICAgIGZ1bmN0aW9uIGlzUGF0aChwYXRoKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBwYXRoID09PSAnc3RyaW5nJyAmJiBmaXJzdERvdEluZGV4Q2FjaGUuZ2V0KHBhdGgpICE9PSAtMTsKICAgIH0KCiAgICB2YXIgQUZURVJfT0JTRVJWRVJTID0gJzpjaGFuZ2UnOwogICAgZnVuY3Rpb24gY2hhbmdlRXZlbnQoa2V5TmFtZSkgewogICAgICAgIHJldHVybiBrZXlOYW1lICsgQUZURVJfT0JTRVJWRVJTOwogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgICAqLwogICAgLyoKICAgICAgVGhlIGV2ZW50IHN5c3RlbSB1c2VzIGEgc2VyaWVzIG9mIG5lc3RlZCBoYXNoZXMgdG8gc3RvcmUgbGlzdGVuZXJzIG9uIGFuCiAgICAgIG9iamVjdC4gV2hlbiBhIGxpc3RlbmVyIGlzIHJlZ2lzdGVyZWQsIG9yIHdoZW4gYW4gZXZlbnQgYXJyaXZlcywgdGhlc2UKICAgICAgaGFzaGVzIGFyZSBjb25zdWx0ZWQgdG8gZGV0ZXJtaW5lIHdoaWNoIHRhcmdldCBhbmQgYWN0aW9uIHBhaXIgdG8gaW52b2tlLgogICAgCiAgICAgIFRoZSBoYXNoZXMgYXJlIHN0b3JlZCBpbiB0aGUgb2JqZWN0J3MgbWV0YSBoYXNoLCBhbmQgbG9vayBsaWtlIHRoaXM6CiAgICAKICAgICAgICAgIC8vIE9iamVjdCdzIG1ldGEgaGFzaAogICAgICAgICAgewogICAgICAgICAgICBsaXN0ZW5lcnM6IHsgICAgICAgLy8gdmFyaWFibGUgbmFtZTogYGxpc3RlbmVyU2V0YAogICAgICAgICAgICAgICJmb286Y2hhbmdlIjogWyAvLyB2YXJpYWJsZSBuYW1lOiBgYWN0aW9uc2AKICAgICAgICAgICAgICAgIHRhcmdldCwgbWV0aG9kLCBvbmNlCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAKICAgICovCiAgICAvKioKICAgICAgQWRkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAKICAgICAgQG1ldGhvZCBhZGRMaXN0ZW5lcgogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9ldmVudHMKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICAgIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXQgQSB0YXJnZXQgb2JqZWN0IG9yIGEgZnVuY3Rpb24KICAgICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IG1ldGhvZCBBIGZ1bmN0aW9uIG9yIHRoZSBuYW1lIG9mIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGB0YXJnZXRgCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gb25jZSBBIGZsYWcgd2hldGhlciBhIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbmNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBhZGRMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QsIG9uY2UpIHsKICAgICAgICAodHJ1ZSAmJiAhKCEhb2JqICYmICEhZXZlbnROYW1lKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IHBhc3MgYXQgbGVhc3QgYW4gb2JqZWN0IGFuZCBldmVudCBuYW1lIHRvIGFkZExpc3RlbmVyJywgISFvYmogJiYgISFldmVudE5hbWUpKTsKCiAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuRElEX0lOSVRfQVRUUlMgJiYgX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfRElEX0lOSVRfQVRUUlNfU1VQUE9SVCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKGV2ZW50TmFtZSAhPT0gJ2RpZEluaXRBdHRycycpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnZGlkSW5pdEF0dHJzIGNhbGxlZCBpbiAnICsgKG9iaiAmJiBvYmoudG9TdHJpbmcgJiYgb2JqLnRvU3RyaW5nKCkpICsgJy4nLCBldmVudE5hbWUgIT09ICdkaWRJbml0QXR0cnMnLCB7CiAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLXZpZXdzLmRpZC1pbml0LWF0dHJzJywKICAgICAgICAgICAgICAgIHVudGlsOiAnMy4wLjAnLAogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjIueCN0b2NfZW1iZXItY29tcG9uZW50LWRpZGluaXRhdHRycycKICAgICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICh0cnVlICYmICEoZXZlbnROYW1lICE9PSAnZGlkSW5pdEF0dHJzJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdkaWRJbml0QXR0cnMgY2FsbGVkIGluICcgKyAob2JqICYmIG9iai50b1N0cmluZyAmJiBvYmoudG9TdHJpbmcoKSkgKyAnIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuJywgZXZlbnROYW1lICE9PSAnZGlkSW5pdEF0dHJzJykpOwogICAgICAgIH0KICAgICAgICBpZiAoIW1ldGhvZCAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgdGFyZ2V0KSB7CiAgICAgICAgICAgIG1ldGhvZCA9IHRhcmdldDsKICAgICAgICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKS5hZGRUb0xpc3RlbmVycyhldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kLCBvbmNlID09PSB0cnVlKTsKICAgIH0KICAgIC8qKgogICAgICBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIKICAgIAogICAgICBBcmd1bWVudHMgc2hvdWxkIG1hdGNoIHRob3NlIHBhc3NlZCB0byBgYWRkTGlzdGVuZXJgLgogICAgCiAgICAgIEBtZXRob2QgcmVtb3ZlTGlzdGVuZXIKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci9vYmplY3QvZXZlbnRzCiAgICAgIEBwYXJhbSBvYmoKICAgICAgQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogICAgICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0IEEgdGFyZ2V0IG9iamVjdCBvciBhIGZ1bmN0aW9uCiAgICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBtZXRob2QgQSBmdW5jdGlvbiBvciB0aGUgbmFtZSBvZiBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBgdGFyZ2V0YAogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIob2JqLCBldmVudE5hbWUsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgICAgKHRydWUgJiYgISghIW9iaiAmJiAhIWV2ZW50TmFtZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgbXVzdCBwYXNzIGF0IGxlYXN0IGFuIG9iamVjdCBhbmQgZXZlbnQgbmFtZSB0byByZW1vdmVMaXN0ZW5lcicsICEhb2JqICYmICEhZXZlbnROYW1lKSk7CgogICAgICAgIGlmICghbWV0aG9kICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiB0YXJnZXQpIHsKICAgICAgICAgICAgbWV0aG9kID0gdGFyZ2V0OwogICAgICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICAoMCwgX2VtYmVyTWV0YS5tZXRhKShvYmopLnJlbW92ZUZyb21MaXN0ZW5lcnMoZXZlbnROYW1lLCB0YXJnZXQsIG1ldGhvZCk7CiAgICB9CiAgICAvKioKICAgICAgU2VuZCBhbiBldmVudC4gVGhlIGV4ZWN1dGlvbiBvZiBzdXNwZW5kZWQgbGlzdGVuZXJzCiAgICAgIGlzIHNraXBwZWQsIGFuZCBvbmNlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZC4gQSBsaXN0ZW5lciB3aXRob3V0CiAgICAgIGEgdGFyZ2V0IGlzIGV4ZWN1dGVkIG9uIHRoZSBwYXNzZWQgb2JqZWN0LiBJZiBhbiBhcnJheSBvZiBhY3Rpb25zCiAgICAgIGlzIG5vdCBwYXNzZWQsIHRoZSBhY3Rpb25zIHN0b3JlZCBvbiB0aGUgcGFzc2VkIG9iamVjdCBhcmUgaW52b2tlZC4KICAgIAogICAgICBAbWV0aG9kIHNlbmRFdmVudAogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9ldmVudHMKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICAgIEBwYXJhbSB7QXJyYXl9IHBhcmFtcyBPcHRpb25hbCBwYXJhbWV0ZXJzIGZvciBlYWNoIGxpc3RlbmVyLgogICAgICBAcmV0dXJuIHRydWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIHNlbmRFdmVudChvYmosIGV2ZW50TmFtZSwgcGFyYW1zLCBhY3Rpb25zLCBfbWV0YSkgewogICAgICAgIGlmIChhY3Rpb25zID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKG9iaikgOiBfbWV0YTsKICAgICAgICAgICAgYWN0aW9ucyA9IHR5cGVvZiBtZXRhJCQxID09PSAnb2JqZWN0JyAmJiBtZXRhJCQxICE9PSBudWxsICYmIG1ldGEkJDEubWF0Y2hpbmdMaXN0ZW5lcnMoZXZlbnROYW1lKTsKICAgICAgICB9CiAgICAgICAgaWYgKGFjdGlvbnMgPT09IHVuZGVmaW5lZCB8fCBhY3Rpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSBhY3Rpb25zLmxlbmd0aCAtIDM7IGkgPj0gMDsgaSAtPSAzKSB7CiAgICAgICAgICAgIC8vIGxvb3BpbmcgaW4gcmV2ZXJzZSBmb3Igb25jZSBsaXN0ZW5lcnMKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGFjdGlvbnNbaV07CiAgICAgICAgICAgIHZhciBtZXRob2QgPSBhY3Rpb25zW2kgKyAxXTsKICAgICAgICAgICAgdmFyIG9uY2UgPSBhY3Rpb25zW2kgKyAyXTsKICAgICAgICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbmNlKSB7CiAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihvYmosIGV2ZW50TmFtZSwgdGFyZ2V0LCBtZXRob2QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBvYmo7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgbWV0aG9kKSB7CiAgICAgICAgICAgICAgICBtZXRob2QgPSB0YXJnZXRbbWV0aG9kXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtZXRob2QuYXBwbHkodGFyZ2V0LCBwYXJhbXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGhhc0xpc3RlbmVycwogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9ldmVudHMKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICAqLwogICAgZnVuY3Rpb24gaGFzTGlzdGVuZXJzKG9iaiwgZXZlbnROYW1lKSB7CiAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkob2JqKTsKICAgICAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIG1hdGNoZWQgPSBtZXRhJCQxLm1hdGNoaW5nTGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICAgICAgcmV0dXJuIG1hdGNoZWQgIT09IHVuZGVmaW5lZCAmJiBtYXRjaGVkLmxlbmd0aCA+IDA7CiAgICB9CiAgICAvKioKICAgICAgRGVmaW5lIGEgcHJvcGVydHkgYXMgYSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBleGVjdXRlZCB3aGVuCiAgICAgIGEgc3BlY2lmaWVkIGV2ZW50IG9yIGV2ZW50cyBhcmUgdHJpZ2dlcmVkLgogICAgCiAgICAgIGBgYCBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgaW1wb3J0IHsgb24gfSBmcm9tICdAZW1iZXIvb2JqZWN0L2V2ZW50ZWQnOwogICAgICBpbXBvcnQgeyBzZW5kRXZlbnQgfSBmcm9tICdAZW1iZXIvb2JqZWN0L2V2ZW50cyc7CiAgICAKICAgICAgbGV0IEpvYiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgbG9nQ29tcGxldGVkOiBvbignY29tcGxldGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnSm9iIGNvbXBsZXRlZCEnKTsKICAgICAgICB9KQogICAgICB9KTsKICAgIAogICAgICBsZXQgam9iID0gSm9iLmNyZWF0ZSgpOwogICAgCiAgICAgIHNlbmRFdmVudChqb2IsICdjb21wbGV0ZWQnKTsgLy8gTG9ncyAnSm9iIGNvbXBsZXRlZCEnCiAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBvbgogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9ldmVudGVkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudE5hbWVzKgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCiAgICAgIEByZXR1cm4gZnVuYwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gb24oKSB7CiAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICB9CgogICAgICAgIHZhciBmdW5jID0gYXJncy5wb3AoKTsKICAgICAgICB2YXIgZXZlbnRzID0gYXJnczsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBmdW5jID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ29uIGV4cGVjdHMgZnVuY3Rpb24gYXMgbGFzdCBhcmd1bWVudCcsIHR5cGVvZiBmdW5jID09PSAnZnVuY3Rpb24nKSk7CiAgICAgICAgKHRydWUgJiYgIShldmVudHMubGVuZ3RoID4gMCAmJiBldmVudHMuZXZlcnkoZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwID09PSAnc3RyaW5nJyAmJiBwLmxlbmd0aCA+IDA7CiAgICAgICAgfSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnb24gY2FsbGVkIHdpdGhvdXQgdmFsaWQgZXZlbnQgbmFtZXMnLCBldmVudHMubGVuZ3RoID4gMCAmJiBldmVudHMuZXZlcnkoZnVuY3Rpb24gKHApIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwID09PSAnc3RyaW5nJyAmJiBwLmxlbmd0aCA+IDA7CiAgICAgICAgfSkpKTsKCiAgICAgICAgKDAsIF9lbWJlclV0aWxzLnNldExpc3RlbmVycykoZnVuYywgZXZlbnRzKTsKICAgICAgICByZXR1cm4gZnVuYzsKICAgIH0KCiAgICAvKioKICAgICAgT2JzZXJ2ZXJTZXQgaXMgYSBkYXRhIHN0cnVjdHVyZSB1c2VkIHRvIGtlZXAgdHJhY2sgb2Ygb2JzZXJ2ZXJzCiAgICAgIHRoYXQgaGF2ZSBiZWVuIGRlZmVycmVkLgogICAgCiAgICAgIEl0IGVuc3VyZXMgdGhhdCBvYnNlcnZlcnMgYXJlIGNhbGxlZCBpbiB0aGUgc2FtZSBvcmRlciB0aGF0IHRoZXkKICAgICAgd2VyZSBpbml0aWFsbHkgdHJpZ2dlcmVkLgogICAgCiAgICAgIEl0IGFsc28gZW5zdXJlcyB0aGF0IG9ic2VydmVycyBmb3IgYW55IG9iamVjdC1rZXkgcGFpcnMgYXJlIGNhbGxlZAogICAgICBvbmx5IG9uY2UsIGV2ZW4gaWYgdGhleSB3ZXJlIHRyaWdnZXJlZCBtdWx0aXBsZSB0aW1lcyB3aGlsZQogICAgICBkZWZlcnJlZC4gSW4gdGhpcyBjYXNlLCB0aGUgb3JkZXIgdGhhdCB0aGUgb2JzZXJ2ZXIgaXMgY2FsbGVkIGluCiAgICAgIHdpbGwgZGVwZW5kIG9uIHRoZSBmaXJzdCB0aW1lIHRoZSBvYnNlcnZlciB3YXMgdHJpZ2dlcmVkLgogICAgCiAgICAgIEBwcml2YXRlCiAgICAgIEBjbGFzcyBPYnNlcnZlclNldAogICAgKi8KCiAgICB2YXIgT2JzZXJ2ZXJTZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gT2JzZXJ2ZXJTZXQoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgT2JzZXJ2ZXJTZXQpOwoKICAgICAgICAgICAgdGhpcy5hZGRlZCA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgICAgIH0KCiAgICAgICAgT2JzZXJ2ZXJTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChvYmplY3QsIGtleSwgZXZlbnQpIHsKICAgICAgICAgICAgdmFyIGtleXMgPSB0aGlzLmFkZGVkLmdldChvYmplY3QpOwogICAgICAgICAgICBpZiAoa2V5cyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBrZXlzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgdGhpcy5hZGRlZC5zZXQob2JqZWN0LCBrZXlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWtleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgIHRoaXMucXVldWUucHVzaChvYmplY3QsIGtleSwgZXZlbnQpOwogICAgICAgICAgICAgICAga2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIE9ic2VydmVyU2V0LnByb3RvdHlwZS5mbHVzaCA9IGZ1bmN0aW9uIGZsdXNoKCkgewogICAgICAgICAgICAvLyBUaGUgcXVldWUgaXMgc2F2ZWQgb2ZmIHRvIHN1cHBvcnQgbmVzdGVkIGZsdXNoZXMuCiAgICAgICAgICAgIHZhciBxdWV1ZSA9IHRoaXMucXVldWU7CiAgICAgICAgICAgIHRoaXMuYWRkZWQuY2xlYXIoKTsKICAgICAgICAgICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0ID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gcXVldWVbaSArIDFdOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gcXVldWVbaSArIDJdOwogICAgICAgICAgICAgICAgaWYgKG9iamVjdC5pc0Rlc3Ryb3lpbmcgfHwgb2JqZWN0LmlzRGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZW5kRXZlbnQob2JqZWN0LCBldmVudCwgW29iamVjdCwga2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gT2JzZXJ2ZXJTZXQ7CiAgICB9KCk7CgogICAgdmFyIGhhc1ZpZXdzID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICBmdW5jdGlvbiBzZXRIYXNWaWV3cyhmbikgewogICAgICAgIGhhc1ZpZXdzID0gZm47CiAgICB9CiAgICBmdW5jdGlvbiBtYWtlVGFnKCkgewogICAgICAgIHJldHVybiBfcmVmZXJlbmNlLkRpcnR5YWJsZVRhZy5jcmVhdGUoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHRhZ0ZvclByb3BlcnR5KG9iamVjdCwgcHJvcGVydHlLZXksIF9tZXRhKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgICAgfQogICAgICAgIHZhciBtZXRhJCQxID0gX21ldGEgPT09IHVuZGVmaW5lZCA/ICgwLCBfZW1iZXJNZXRhLm1ldGEpKG9iamVjdCkgOiBfbWV0YTsKICAgICAgICBpZiAoKDAsIF9lbWJlclV0aWxzLmlzUHJveHkpKG9iamVjdCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRhZ0ZvcihvYmplY3QsIG1ldGEkJDEpOwogICAgICAgIH0KICAgICAgICB2YXIgdGFncyA9IG1ldGEkJDEud3JpdGFibGVUYWdzKCk7CiAgICAgICAgdmFyIHRhZyA9IHRhZ3NbcHJvcGVydHlLZXldOwogICAgICAgIGlmICh0YWcpIHsKICAgICAgICAgICAgcmV0dXJuIHRhZzsKICAgICAgICB9CiAgICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgICAgIHZhciBwYWlyID0gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW21ha2VUYWcoKSwgX3JlZmVyZW5jZS5VcGRhdGFibGVUYWcuY3JlYXRlKF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHKV0pOwogICAgICAgICAgICByZXR1cm4gdGFnc1twcm9wZXJ0eUtleV0gPSBwYWlyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0YWdzW3Byb3BlcnR5S2V5XSA9IG1ha2VUYWcoKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiB0YWdGb3Iob2JqZWN0LCBfbWV0YSkgewogICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiBvYmplY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9lbWJlck1ldGEubWV0YSkob2JqZWN0KSA6IF9tZXRhOwogICAgICAgICAgICByZXR1cm4gbWV0YSQkMS53cml0YWJsZVRhZyhtYWtlVGFnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gX3JlZmVyZW5jZS5DT05TVEFOVF9UQUc7CiAgICAgICAgfQogICAgfQogICAgdmFyIGRpcnR5ID0gdm9pZCAwOwogICAgdmFyIHVwZGF0ZSA9IHZvaWQgMDsKICAgIGlmIChmYWxzZSkgewogICAgICAgIGRpcnR5ID0gZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgICB0YWcuaW5uZXIuZmlyc3QuaW5uZXIuZGlydHkoKTsKICAgICAgICB9OwogICAgICAgIHVwZGF0ZSA9IGZ1bmN0aW9uIChvdXRlciwgaW5uZXIpIHsKICAgICAgICAgICAgb3V0ZXIuaW5uZXIuc2Vjb25kLmlubmVyLnVwZGF0ZShpbm5lcik7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgZGlydHkgPSBmdW5jdGlvbiAodGFnKSB7CiAgICAgICAgICAgIHRhZy5pbm5lci5kaXJ0eSgpOwogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBtYXJrT2JqZWN0QXNEaXJ0eShvYmosIHByb3BlcnR5S2V5LCBtZXRhJCQxKSB7CiAgICAgICAgdmFyIG9iamVjdFRhZyA9IG1ldGEkJDEucmVhZGFibGVUYWcoKTsKICAgICAgICBpZiAob2JqZWN0VGFnICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJVdGlscy5pc1Byb3h5KShvYmopKSB7CiAgICAgICAgICAgICAgICBvYmplY3RUYWcuaW5uZXIuZmlyc3QuaW5uZXIuZGlydHkoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9iamVjdFRhZy5pbm5lci5kaXJ0eSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0YWdzID0gbWV0YSQkMS5yZWFkYWJsZVRhZ3MoKTsKICAgICAgICB2YXIgcHJvcGVydHlUYWcgPSB0YWdzICE9PSB1bmRlZmluZWQgPyB0YWdzW3Byb3BlcnR5S2V5XSA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAocHJvcGVydHlUYWcgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBkaXJ0eShwcm9wZXJ0eVRhZyk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3RUYWcgIT09IHVuZGVmaW5lZCB8fCBwcm9wZXJ0eVRhZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGVuc3VyZVJ1bmxvb3AoKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBlbnN1cmVSdW5sb29wKCkgewogICAgICAgIGlmIChoYXNWaWV3cygpKSB7CiAgICAgICAgICAgIF9ydW5sb29wLmJhY2tidXJuZXIuZW5zdXJlSW5zdGFuY2UoKTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIHJ1bkluVHJhbnNhY3Rpb24gPSB2b2lkIDA7CiAgICB2YXIgZGlkUmVuZGVyID0gdm9pZCAwOwogICAgdmFyIGFzc2VydE5vdFJlbmRlcmVkID0gdm9pZCAwOwogICAgLy8gZGV0ZWN0LWJhY2t0cmFja2luZy1yZXJlbmRlciBieSBkZWZhdWx0IGlzIGRlYnVnIGJ1aWxkIG9ubHkKICAgIGlmICh0cnVlKSB7CiAgICAgICAgdmFyIFRyYW5zYWN0aW9uUnVubmVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiBUcmFuc2FjdGlvblJ1bm5lcigpIHsKICAgICAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVHJhbnNhY3Rpb25SdW5uZXIpOwoKICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb25JZCA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2hvdWxkUmVmbHVzaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy53ZWFrTWFwID0gbmV3IFdlYWtNYXAoKTsKICAgICAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdHJhY2sgdGVtcGxhdGVzCiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBUcmFuc2FjdGlvblJ1bm5lci5wcm90b3R5cGUucnVuSW5UcmFuc2FjdGlvbiA9IGZ1bmN0aW9uIHJ1bkluVHJhbnNhY3Rpb24oY29udGV4dCQkMSwgbWV0aG9kTmFtZSkgewogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmUoY29udGV4dCQkMSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnRleHQkJDFbbWV0aG9kTmFtZV0oKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZnRlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvdWxkUmVmbHVzaDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFRyYW5zYWN0aW9uUnVubmVyLnByb3RvdHlwZS5kaWRSZW5kZXIgPSBmdW5jdGlvbiBkaWRSZW5kZXIob2JqZWN0LCBrZXksIHJlZmVyZW5jZSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluVHJhbnNhY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0S2V5KG9iamVjdCwga2V5LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RSZWY6IHJlZmVyZW5jZSwKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFJlbmRlcmVkSW46IHRoaXMuZGVidWdTdGFjay5wZWVrKCkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRLZXkob2JqZWN0LCBrZXksIHRoaXMudHJhbnNhY3Rpb25JZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUcmFuc2FjdGlvblJ1bm5lci5wcm90b3R5cGUuYXNzZXJ0Tm90UmVuZGVyZWQgPSBmdW5jdGlvbiBhc3NlcnROb3RSZW5kZXJlZChvYmplY3QsIGtleSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluVHJhbnNhY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNSZW5kZXJlZChvYmplY3QsIGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2dldEtleSA9IHRoaXMuZ2V0S2V5KG9iamVjdCwga2V5KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RSZWYgPSBfZ2V0S2V5Lmxhc3RSZWYsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0UmVuZGVyZWRJbiA9IF9nZXRLZXkubGFzdFJlbmRlcmVkSW47CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudGx5SW4gPSB0aGlzLmRlYnVnU3RhY2sucGVlaygpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxhYmVsID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFJlZiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGFzdFJlZiAmJiBsYXN0UmVmLl9wcm9wZXJ0eUtleSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzLnVuc2hpZnQobGFzdFJlZi5fcHJvcGVydHlLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RSZWYgPSBsYXN0UmVmLl9wYXJlbnRSZWZlcmVuY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gJ3RoZSBzYW1lIHZhbHVlJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtb2RpZmllZCAiJyArIGxhYmVsICsgJyIgdHdpY2Ugb24gJyArIG9iamVjdCArICcgaW4gYSBzaW5nbGUgcmVuZGVyLiBJdCB3YXMgcmVuZGVyZWQgaW4gJyArIGxhc3RSZW5kZXJlZEluICsgJyBhbmQgbW9kaWZpZWQgaW4gJyArIGN1cnJlbnRseUluICsgJy4gVGhpcyB3YXMgdW5yZWxpYWJsZSBhbmQgc2xvdyBpbiBFbWJlciAxLnggYW5kIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9lbWJlci5qcy9pc3N1ZXMvMTM5NDggZm9yIG1vcmUgZGV0YWlscy4nLCBmYWxzZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3VsZFJlZmx1c2ggPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgVHJhbnNhY3Rpb25SdW5uZXIucHJvdG90eXBlLmhhc1JlbmRlcmVkID0gZnVuY3Rpb24gaGFzUmVuZGVyZWQob2JqZWN0LCBrZXkpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRLZXkob2JqZWN0LCBrZXkpICE9PSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRLZXkob2JqZWN0LCBrZXkpID09PSB0aGlzLnRyYW5zYWN0aW9uSWQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUcmFuc2FjdGlvblJ1bm5lci5wcm90b3R5cGUuYmVmb3JlID0gZnVuY3Rpb24gYmVmb3JlKGNvbnRleHQkJDEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLnNob3VsZFJlZmx1c2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrID0gY29udGV4dCQkMS5lbnYuZGVidWdTdGFjazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIFRyYW5zYWN0aW9uUnVubmVyLnByb3RvdHlwZS5hZnRlciA9IGZ1bmN0aW9uIGFmdGVyKCkgewogICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbklkKys7CiAgICAgICAgICAgICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1N0YWNrID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jbGVhck9iamVjdE1hcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgVHJhbnNhY3Rpb25SdW5uZXIucHJvdG90eXBlLmNyZWF0ZU1hcCA9IGZ1bmN0aW9uIGNyZWF0ZU1hcChvYmplY3QpIHsKICAgICAgICAgICAgICAgIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgICAgICAgdGhpcy53ZWFrTWFwLnNldChvYmplY3QsIG1hcCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgVHJhbnNhY3Rpb25SdW5uZXIucHJvdG90eXBlLmdldE9yQ3JlYXRlTWFwID0gZnVuY3Rpb24gZ2V0T3JDcmVhdGVNYXAob2JqZWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwID0gdGhpcy53ZWFrTWFwLmdldChvYmplY3QpOwogICAgICAgICAgICAgICAgaWYgKG1hcCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwID0gdGhpcy5jcmVhdGVNYXAob2JqZWN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUcmFuc2FjdGlvblJ1bm5lci5wcm90b3R5cGUuc2V0S2V5ID0gZnVuY3Rpb24gc2V0S2V5KG9iamVjdCwga2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIG1hcCA9IHRoaXMuZ2V0T3JDcmVhdGVNYXAob2JqZWN0KTsKICAgICAgICAgICAgICAgIG1hcFtrZXldID0gdmFsdWU7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBUcmFuc2FjdGlvblJ1bm5lci5wcm90b3R5cGUuZ2V0S2V5ID0gZnVuY3Rpb24gZ2V0S2V5KG9iamVjdCwga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwID0gdGhpcy53ZWFrTWFwLmdldChvYmplY3QpOwogICAgICAgICAgICAgICAgaWYgKG1hcCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hcFtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgVHJhbnNhY3Rpb25SdW5uZXIucHJvdG90eXBlLmNsZWFyT2JqZWN0TWFwID0gZnVuY3Rpb24gY2xlYXJPYmplY3RNYXAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLndlYWtNYXAgPSBuZXcgV2Vha01hcCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgcmV0dXJuIFRyYW5zYWN0aW9uUnVubmVyOwogICAgICAgIH0oKTsKCiAgICAgICAgdmFyIHJ1bm5lciA9IG5ldyBUcmFuc2FjdGlvblJ1bm5lcigpOwogICAgICAgIGV4cG9ydHMucnVuSW5UcmFuc2FjdGlvbiA9IHJ1bkluVHJhbnNhY3Rpb24gPSBydW5uZXIucnVuSW5UcmFuc2FjdGlvbi5iaW5kKHJ1bm5lcik7CiAgICAgICAgZXhwb3J0cy5kaWRSZW5kZXIgPSBkaWRSZW5kZXIgPSBydW5uZXIuZGlkUmVuZGVyLmJpbmQocnVubmVyKTsKICAgICAgICBleHBvcnRzLmFzc2VydE5vdFJlbmRlcmVkID0gYXNzZXJ0Tm90UmVuZGVyZWQgPSBydW5uZXIuYXNzZXJ0Tm90UmVuZGVyZWQuYmluZChydW5uZXIpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBpbiBwcm9kdWN0aW9uIGRvIG5vdGhpbmcgdG8gZGV0ZWN0IHJlZmx1c2hlcwogICAgICAgIGV4cG9ydHMucnVuSW5UcmFuc2FjdGlvbiA9IHJ1bkluVHJhbnNhY3Rpb24gPSBmdW5jdGlvbiAoY29udGV4dCQkMSwgbWV0aG9kTmFtZSkgewogICAgICAgICAgICBjb250ZXh0JCQxW21ldGhvZE5hbWVdKCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQoKICAgIC8qKgogICAgIEBtb2R1bGUgZW1iZXIKICAgICBAcHJpdmF0ZQogICAgICovCiAgICB2YXIgUFJPUEVSVFlfRElEX0NIQU5HRSQxID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ1BST1BFUlRZX0RJRF9DSEFOR0UnKTsKICAgIHZhciBvYnNlcnZlclNldCA9IG5ldyBPYnNlcnZlclNldCgpOwogICAgdmFyIGRlZmVycmVkID0gMDsKICAgIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAgIC8vIFBST1BFUlRZIENIQU5HRVMKICAgIC8vCiAgICAvKioKICAgICAgQG1ldGhvZCBwcm9wZXJ0eVdpbGxDaGFuZ2UKICAgICAgQGZvciBFbWJlcgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHZhciBwcm9wZXJ0eVdpbGxDaGFuZ2UgPSB2b2lkIDA7CiAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5QUk9QRVJUWV9XSUxMX0NIQU5HRSkgewogICAgICAgIGV4cG9ydHMucHJvcGVydHlXaWxsQ2hhbmdlID0gcHJvcGVydHlXaWxsQ2hhbmdlID0gZnVuY3Rpb24gcHJvcGVydHlXaWxsQ2hhbmdlKCkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1wncHJvcGVydHlXaWxsQ2hhbmdlXCcgaXMgZGVwcmVjYXRlZCBhbmQgaGFzIG5vIGVmZmVjdC4gSXQgaXMgc2FmZSB0byByZW1vdmUgdGhpcyBjYWxsLicsIGZhbHNlLCB7CiAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLW1ldGFsLmRlcHJlY2F0ZS1wcm9wZXJ0eVdpbGxDaGFuZ2UnLAogICAgICAgICAgICAgICAgdW50aWw6ICczLjUuMCcsCiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54LyN0b2NfdXNlLW5vdGlmeXByb3BlcnR5Y2hhbmdlLWluc3RlYWQtb2YtcHJvcGVydHl3aWxsY2hhbmdlLWFuZC1wcm9wZXJ0eWRpZGNoYW5nZScKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBwcm9wZXJ0eURpZENoYW5nZQogICAgICBAZm9yIEVtYmVyCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgdmFyIHByb3BlcnR5RGlkQ2hhbmdlID0gdm9pZCAwOwogICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUFJPUEVSVFlfRElEX0NIQU5HRSkgewogICAgICAgIGV4cG9ydHMucHJvcGVydHlEaWRDaGFuZ2UgPSBwcm9wZXJ0eURpZENoYW5nZSA9IGZ1bmN0aW9uIHByb3BlcnR5RGlkQ2hhbmdlKG9iaiwga2V5TmFtZSwgX21ldGEpIHsKICAgICAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdcJ3Byb3BlcnR5RGlkQ2hhbmdlXCcgaXMgZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBcJ25vdGlmeVByb3BlcnR5Q2hhbmdlXCcuIEl0IGlzIHNhZmUgdG8gY2hhbmdlIHRoaXMgY2FsbCB0byBcJ25vdGlmeVByb3BlcnR5Q2hhbmdlXCcuJywgZmFsc2UsIHsKICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItbWV0YWwuZGVwcmVjYXRlLXByb3BlcnR5RGlkQ2hhbmdlJywKICAgICAgICAgICAgICAgIHVudGlsOiAnMy41LjAnLAogICAgICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueC8jdG9jX3VzZS1ub3RpZnlwcm9wZXJ0eWNoYW5nZS1pbnN0ZWFkLW9mLXByb3BlcnR5d2lsbGNoYW5nZS1hbmQtcHJvcGVydHlkaWRjaGFuZ2UnCiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKG9iaiwga2V5TmFtZSwgX21ldGEpOwogICAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAgVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQganVzdCBhZnRlciBhbiBvYmplY3QgcHJvcGVydHkgaGFzIGNoYW5nZWQuCiAgICAgIEl0IHdpbGwgbm90aWZ5IGFueSBvYnNlcnZlcnMgYW5kIGNsZWFyIGNhY2hlcyBhbW9uZyBvdGhlciB0aGluZ3MuCiAgICAKICAgICAgTm9ybWFsbHkgeW91IHdpbGwgbm90IG5lZWQgdG8gY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBidXQgaWYgZm9yIHNvbWUKICAgICAgcmVhc29uIHlvdSBjYW4ndCBkaXJlY3RseSB3YXRjaCBhIHByb3BlcnR5IHlvdSBjYW4gaW52b2tlIHRoaXMgbWV0aG9kCiAgICAgIG1hbnVhbGx5LgogICAgCiAgICAgIEBtZXRob2Qgbm90aWZ5UHJvcGVydHlDaGFuZ2UKICAgICAgQGZvciBFbWJlcgogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3Qgd2l0aCB0aGUgcHJvcGVydHkgdGhhdCB3aWxsIGNoYW5nZQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IChvciBwYXRoKSB0aGF0IHdpbGwgY2hhbmdlLgogICAgICBAcGFyYW0ge01ldGF9IG1ldGEgVGhlIG9iamVjdHMgbWV0YS4KICAgICAgQHJldHVybiB7dm9pZH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBmdW5jdGlvbiBub3RpZnlQcm9wZXJ0eUNoYW5nZShvYmosIGtleU5hbWUsIF9tZXRhKSB7CiAgICAgICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKG9iaikgOiBfbWV0YTsKICAgICAgICB2YXIgaGFzTWV0YSA9IG1ldGEkJDEgIT09IHVuZGVmaW5lZDsKICAgICAgICBpZiAoaGFzTWV0YSAmJiAhbWV0YSQkMS5pc0luaXRpYWxpemVkKG9iaikpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcG9zc2libGVEZXNjID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICBpZiAocG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHBvc3NpYmxlRGVzYy5kaWRDaGFuZ2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcG9zc2libGVEZXNjLmRpZENoYW5nZShvYmosIGtleU5hbWUpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzTWV0YSAmJiBtZXRhJCQxLnBlZWtXYXRjaGluZyhrZXlOYW1lKSA+IDApIHsKICAgICAgICAgICAgZGVwZW5kZW50S2V5c0RpZENoYW5nZShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgICAgICBjaGFpbnNEaWRDaGFuZ2Uob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgbm90aWZ5T2JzZXJ2ZXJzKG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgfQogICAgICAgIGlmIChQUk9QRVJUWV9ESURfQ0hBTkdFJDEgaW4gb2JqKSB7CiAgICAgICAgICAgIG9ialtQUk9QRVJUWV9ESURfQ0hBTkdFJDFdKGtleU5hbWUpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzTWV0YSkgewogICAgICAgICAgICBpZiAobWV0YSQkMS5pc1NvdXJjZURlc3Ryb3lpbmcoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcmtPYmplY3RBc0RpcnR5KG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgfQogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIGFzc2VydE5vdFJlbmRlcmVkKG9iaiwga2V5TmFtZSk7CiAgICAgICAgfQogICAgfQogICAgdmFyIFNFRU5fTUFQID0gbmV3IE1hcCgpOwogICAgdmFyIElTX1RPUF9TRUVOX01BUCA9IHRydWU7CiAgICAvLyBjYWxsZWQgd2hlbmV2ZXIgYSBwcm9wZXJ0eSBoYXMganVzdCBjaGFuZ2VkIHRvIHVwZGF0ZSBkZXBlbmRlbnQga2V5cwogICAgZnVuY3Rpb24gZGVwZW5kZW50S2V5c0RpZENoYW5nZShvYmosIGRlcEtleSwgbWV0YSQkMSkgewogICAgICAgIGlmIChtZXRhJCQxLmlzU291cmNlRGVzdHJveWluZygpIHx8ICFtZXRhJCQxLmhhc0RlcHMoZGVwS2V5KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBzZWVuID0gU0VFTl9NQVA7CiAgICAgICAgdmFyIGlzVG9wID0gSVNfVE9QX1NFRU5fTUFQOwogICAgICAgIGlmIChpc1RvcCkgewogICAgICAgICAgICBJU19UT1BfU0VFTl9NQVAgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaXRlckRlcHMobm90aWZ5UHJvcGVydHlDaGFuZ2UsIG9iaiwgZGVwS2V5LCBzZWVuLCBtZXRhJCQxKTsKICAgICAgICBpZiAoaXNUb3ApIHsKICAgICAgICAgICAgU0VFTl9NQVAuY2xlYXIoKTsKICAgICAgICAgICAgSVNfVE9QX1NFRU5fTUFQID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpdGVyRGVwcyhtZXRob2QsIG9iaiwgZGVwS2V5LCBzZWVuLCBtZXRhJCQxKSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBzZWVuLmdldChvYmopOwogICAgICAgIGlmIChjdXJyZW50ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY3VycmVudCA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgc2Vlbi5zZXQob2JqLCBjdXJyZW50KTsKICAgICAgICB9CiAgICAgICAgaWYgKGN1cnJlbnQuaGFzKGRlcEtleSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcG9zc2libGVEZXNjID0gdm9pZCAwOwogICAgICAgIG1ldGEkJDEuZm9yRWFjaEluRGVwcyhkZXBLZXksIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NzaWJsZURlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleSwgbWV0YSQkMSk7CiAgICAgICAgICAgIGlmIChwb3NzaWJsZURlc2MgIT09IHVuZGVmaW5lZCAmJiBwb3NzaWJsZURlc2MuX3N1c3BlbmRlZCA9PT0gb2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWV0aG9kKG9iaiwga2V5LCBtZXRhJCQxKTsKICAgICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYWluc0RpZENoYW5nZShfb2JqLCBrZXlOYW1lLCBtZXRhJCQxKSB7CiAgICAgICAgdmFyIGNoYWluV2F0Y2hlcnMgPSBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpOwogICAgICAgIGlmIChjaGFpbldhdGNoZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY2hhaW5XYXRjaGVycy5ub3RpZnkoa2V5TmFtZSwgdHJ1ZSwgbm90aWZ5UHJvcGVydHlDaGFuZ2UpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG92ZXJyaWRlQ2hhaW5zKF9vYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgICAgICB2YXIgY2hhaW5XYXRjaGVycyA9IG1ldGEkJDEucmVhZGFibGVDaGFpbldhdGNoZXJzKCk7CiAgICAgICAgaWYgKGNoYWluV2F0Y2hlcnMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjaGFpbldhdGNoZXJzLnJldmFsaWRhdGUoa2V5TmFtZSk7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEBtZXRob2QgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMKICAgICAgQGNoYWluYWJsZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGJlZ2luUHJvcGVydHlDaGFuZ2VzKCkgewogICAgICAgIGRlZmVycmVkKys7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBlbmRQcm9wZXJ0eUNoYW5nZXMKICAgICAgQHByaXZhdGUKICAgICovCiAgICBmdW5jdGlvbiBlbmRQcm9wZXJ0eUNoYW5nZXMoKSB7CiAgICAgICAgZGVmZXJyZWQtLTsKICAgICAgICBpZiAoZGVmZXJyZWQgPD0gMCkgewogICAgICAgICAgICBvYnNlcnZlclNldC5mbHVzaCgpOwogICAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICBNYWtlIGEgc2VyaWVzIG9mIHByb3BlcnR5IGNoYW5nZXMgdG9nZXRoZXIgaW4gYW4KICAgICAgZXhjZXB0aW9uLXNhZmUgd2F5LgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgRW1iZXIuY2hhbmdlUHJvcGVydGllcyhmdW5jdGlvbigpIHsKICAgICAgICBvYmoxLnNldCgnZm9vJywgbWF5Qmxvd1VwV2hlblNldCk7CiAgICAgICAgb2JqMi5zZXQoJ2JhcicsIGJheik7CiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGNoYW5nZVByb3BlcnRpZXMKICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICAgQHByaXZhdGUKICAgICovCiAgICBmdW5jdGlvbiBjaGFuZ2VQcm9wZXJ0aWVzKGNhbGxiYWNrKSB7CiAgICAgICAgYmVnaW5Qcm9wZXJ0eUNoYW5nZXMoKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGVuZFByb3BlcnR5Q2hhbmdlcygpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG5vdGlmeU9ic2VydmVycyhvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgICAgICBpZiAobWV0YSQkMS5pc1NvdXJjZURlc3Ryb3lpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBldmVudE5hbWUgPSBjaGFuZ2VFdmVudChrZXlOYW1lKTsKICAgICAgICBpZiAoZGVmZXJyZWQgPiAwKSB7CiAgICAgICAgICAgIG9ic2VydmVyU2V0LmFkZChvYmosIGtleU5hbWUsIGV2ZW50TmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VuZEV2ZW50KG9iaiwgZXZlbnROYW1lLCBbb2JqLCBrZXlOYW1lXSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgICAqLwogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gREVTQ1JJUFRPUgogICAgLy8KICAgIC8qKgogICAgICBPYmplY3RzIG9mIHRoaXMgdHlwZSBjYW4gaW1wbGVtZW50IGFuIGludGVyZmFjZSB0byByZXNwb25kIHRvIHJlcXVlc3RzIHRvCiAgICAgIGdldCBhbmQgc2V0LiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBoYW5kbGVzIHNpbXBsZSBwcm9wZXJ0aWVzLgogICAgCiAgICAgIEBjbGFzcyBEZXNjcmlwdG9yCiAgICAgIEBwcml2YXRlCiAgICAqLwoKICAgIHZhciBEZXNjcmlwdG9yID0gZnVuY3Rpb24gRGVzY3JpcHRvcigpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlc2NyaXB0b3IpOwoKICAgICAgICB0aGlzLmlzRGVzY3JpcHRvciA9IHRydWU7CiAgICAgICAgdGhpcy5lbnVtZXJhYmxlID0gdHJ1ZTsKICAgIH07CgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gREVGSU5JTkcgUFJPUEVSVElFUyBBUEkKICAgIC8vCiAgICBmdW5jdGlvbiBNQU5EQVRPUllfU0VUVEVSX0ZVTkNUSU9OKG5hbWUpIHsKICAgICAgICBmdW5jdGlvbiBTRVRURVJfRlVOQ1RJT04odmFsdWUpIHsKICAgICAgICAgICAgdmFyIG0gPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkodGhpcyk7CiAgICAgICAgICAgIGlmICghbS5pc0luaXRpYWxpemVkKHRoaXMpKSB7CiAgICAgICAgICAgICAgICBtLndyaXRlVmFsdWVzKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IG11c3QgdXNlIHNldCgpIHRvIHNldCB0aGUgYCcgKyBuYW1lICsgJ2AgcHJvcGVydHkgKG9mICcgKyB0aGlzICsgJykgdG8gYCcgKyB2YWx1ZSArICdgLicsIGZhbHNlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikoU0VUVEVSX0ZVTkNUSU9OLCB7IGlzTWFuZGF0b3J5U2V0dGVyOiB0cnVlIH0pOwogICAgfQogICAgZnVuY3Rpb24gREVGQVVMVF9HRVRURVJfRlVOQ1RJT04obmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiBHRVRURVJfRlVOQ1RJT04oKSB7CiAgICAgICAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKHRoaXMpOwogICAgICAgICAgICBpZiAobWV0YSQkMSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWV0YSQkMS5wZWVrVmFsdWVzKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIElOSEVSSVRJTkdfR0VUVEVSX0ZVTkNUSU9OKG5hbWUpIHsKICAgICAgICBmdW5jdGlvbiBJR0VUVEVSX0ZVTkNUSU9OKCkgewogICAgICAgICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfZW1iZXJNZXRhLnBlZWtNZXRhKSh0aGlzKTsKICAgICAgICAgICAgdmFyIHZhbCA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKG1ldGEkJDEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdmFsID0gbWV0YSQkMS5yZWFkSW5oZXJpdGVkVmFsdWUoJ3ZhbHVlcycsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWwgPT09IF9lbWJlck1ldGEuVU5ERUZJTkVEKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG8gJiYgcHJvdG9bbmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKElHRVRURVJfRlVOQ1RJT04sIHsKICAgICAgICAgICAgaXNJbmhlcml0aW5nR2V0dGVyOiB0cnVlCiAgICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBERVNDUklQVE9SX0dFVFRFUl9GVU5DVElPTihuYW1lLCBkZXNjcmlwdG9yKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIENQR0VUVEVSX0ZVTkNUSU9OKCkgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpcHRvci5nZXQodGhpcywgbmFtZSk7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICBOT1RFOiBUaGlzIGlzIGEgbG93LWxldmVsIG1ldGhvZCB1c2VkIGJ5IG90aGVyIHBhcnRzIG9mIHRoZSBBUEkuIFlvdSBhbG1vc3QKICAgICAgbmV2ZXIgd2FudCB0byBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5LiBJbnN0ZWFkIHlvdSBzaG91bGQgdXNlCiAgICAgIGBtaXhpbigpYCB0byBkZWZpbmUgbmV3IHByb3BlcnRpZXMuCiAgICAKICAgICAgRGVmaW5lcyBhIHByb3BlcnR5IG9uIGFuIG9iamVjdC4gVGhpcyBtZXRob2Qgd29ya3MgbXVjaCBsaWtlIHRoZSBFUzUKICAgICAgYE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpYCBtZXRob2QgZXhjZXB0IHRoYXQgaXQgY2FuIGFsc28gYWNjZXB0IGNvbXB1dGVkCiAgICAgIHByb3BlcnRpZXMgYW5kIG90aGVyIHNwZWNpYWwgZGVzY3JpcHRvcnMuCiAgICAKICAgICAgTm9ybWFsbHkgdGhpcyBtZXRob2QgdGFrZXMgb25seSB0aHJlZSBwYXJhbWV0ZXJzLiBIb3dldmVyIGlmIHlvdSBwYXNzIGFuCiAgICAgIGluc3RhbmNlIG9mIGBEZXNjcmlwdG9yYCBhcyB0aGUgdGhpcmQgcGFyYW0gdGhlbiB5b3UgY2FuIHBhc3MgYW4KICAgICAgb3B0aW9uYWwgdmFsdWUgYXMgdGhlIGZvdXJ0aCBwYXJhbWV0ZXIuIFRoaXMgaXMgb2Z0ZW4gbW9yZSBlZmZpY2llbnQgdGhhbgogICAgICBjcmVhdGluZyBuZXcgZGVzY3JpcHRvciBoYXNoZXMgZm9yIGVhY2ggcHJvcGVydHkuCiAgICAKICAgICAgIyMgRXhhbXBsZXMKICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGRlZmluZVByb3BlcnR5LCBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIC8vIEVTNSBjb21wYXRpYmxlIG1vZGUKICAgICAgZGVmaW5lUHJvcGVydHkoY29udGFjdCwgJ2ZpcnN0TmFtZScsIHsKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6ICdDaGFybGVzJwogICAgICB9KTsKICAgIAogICAgICAvLyBkZWZpbmUgYSBzaW1wbGUgcHJvcGVydHkKICAgICAgZGVmaW5lUHJvcGVydHkoY29udGFjdCwgJ2xhc3ROYW1lJywgdW5kZWZpbmVkLCAnSm9sbGV5Jyk7CiAgICAKICAgICAgLy8gZGVmaW5lIGEgY29tcHV0ZWQgcHJvcGVydHkKICAgICAgZGVmaW5lUHJvcGVydHkoY29udGFjdCwgJ2Z1bGxOYW1lJywgY29tcHV0ZWQoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZpcnN0TmFtZSsnICcrdGhpcy5sYXN0TmFtZTsKICAgICAgfSkpOwogICAgICBgYGAKICAgIAogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGRlZmluZVByb3BlcnR5CiAgICAgIEBmb3IgQGVtYmVyL29iamVjdAogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIHRoZSBvYmplY3QgdG8gZGVmaW5lIHRoaXMgcHJvcGVydHkgb24uIFRoaXMgbWF5IGJlIGEgcHJvdG90eXBlLgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkKICAgICAgQHBhcmFtIHtEZXNjcmlwdG9yfSBbZGVzY10gYW4gaW5zdGFuY2Ugb2YgYERlc2NyaXB0b3JgICh0eXBpY2FsbHkgYQogICAgICAgIGNvbXB1dGVkIHByb3BlcnR5KSBvciBhbiBFUzUgZGVzY3JpcHRvci4KICAgICAgICBZb3UgbXVzdCBwcm92aWRlIHRoaXMgb3IgYGRhdGFgIGJ1dCBub3QgYm90aC4KICAgICAgQHBhcmFtIHsqfSBbZGF0YV0gc29tZXRoaW5nIG90aGVyIHRoYW4gYSBkZXNjcmlwdG9yLCB0aGF0IHdpbGwKICAgICAgICBiZWNvbWUgdGhlIGV4cGxpY2l0IHZhbHVlIG9mIHRoaXMgcHJvcGVydHkuCiAgICAqLwogICAgZnVuY3Rpb24gZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBkZXNjLCBkYXRhLCBtZXRhJCQxKSB7CiAgICAgICAgaWYgKG1ldGEkJDEgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKTsKICAgICAgICB9CiAgICAgICAgdmFyIHdhdGNoaW5nID0gbWV0YSQkMS5wZWVrV2F0Y2hpbmcoa2V5TmFtZSkgPiAwOwogICAgICAgIHZhciBwcmV2aW91c0Rlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgIHZhciB3YXNEZXNjcmlwdG9yID0gcHJldmlvdXNEZXNjICE9PSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHdhc0Rlc2NyaXB0b3IpIHsKICAgICAgICAgICAgcHJldmlvdXNEZXNjLnRlYXJkb3duKG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgICAgIG1ldGEkJDEucmVtb3ZlRGVzY3JpcHRvcnMoa2V5TmFtZSk7CiAgICAgICAgfQogICAgICAgIC8vIHVzZWQgdG8gdHJhY2sgaWYgdGhlIHRoZSBwcm9wZXJ0eSBiZWluZyBkZWZpbmVkIGJlIGVudW1lcmFibGUKICAgICAgICB2YXIgZW51bWVyYWJsZSA9IHRydWU7CiAgICAgICAgLy8gRW1iZXIuTmF0aXZlQXJyYXkgaXMgYSBub3JtYWwgRW1iZXIuTWl4aW4gdGhhdCB3ZSBtaXggaW50byBgQXJyYXkucHJvdG90eXBlYCB3aGVuIHByb3RvdHlwZSBleHRlbnNpb25zIGFyZSBlbmFibGVkCiAgICAgICAgLy8gbXV0YXRpbmcgYSBuYXRpdmUgb2JqZWN0IHByb3RvdHlwZSBsaWtlIHRoaXMgc2hvdWxkIF9ub3RfIHJlc3VsdCBpbiBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYmVpbmcgYWRkZWQgKG9yIHdlIGhhdmUgc2lnbmlmaWNhbnQKICAgICAgICAvLyBpc3N1ZXMgd2l0aCB0aGluZ3MgbGlrZSBkZWVwIGVxdWFsaXR5IGNoZWNrcyBmcm9tIHRlc3QgZnJhbWV3b3Jrcywgb3IgdGhpbmdzIGxpa2UgalF1ZXJ5LmV4dGVuZCh0cnVlLCBbXSwgW10pKS4KICAgICAgICAvLwogICAgICAgIC8vIHRoaXMgaXMgYSBoYWNrLCBhbmQgd2Ugc2hvdWxkIHN0b3AgbXV0YXRpbmcgdGhlIGFycmF5IHByb3RvdHlwZSBieSBkZWZhdWx0IPCfmKsKICAgICAgICBpZiAob2JqID09PSBBcnJheS5wcm90b3R5cGUpIHsKICAgICAgICAgICAgZW51bWVyYWJsZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKGRlc2MgaW5zdGFuY2VvZiBEZXNjcmlwdG9yKSB7CiAgICAgICAgICAgIHZhbHVlID0gZGVzYzsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSwKICAgICAgICAgICAgICAgIGdldDogREVTQ1JJUFRPUl9HRVRURVJfRlVOQ1RJT04oa2V5TmFtZSwgdmFsdWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBtZXRhJCQxLndyaXRlRGVzY3JpcHRvcnMoa2V5TmFtZSwgdmFsdWUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGRlc2Muc2V0dXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGRlc2Muc2V0dXAob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkIHx8IGRlc2MgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFsdWUgPSBkYXRhOwogICAgICAgICAgICBpZiAodHJ1ZSAmJiB3YXRjaGluZykgewogICAgICAgICAgICAgICAgbWV0YSQkMS53cml0ZVZhbHVlcyhrZXlOYW1lLCBkYXRhKTsKICAgICAgICAgICAgICAgIHZhciBkZWZhdWx0RGVzY3JpcHRvciA9IHsKICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IE1BTkRBVE9SWV9TRVRURVJfRlVOQ1RJT04oa2V5TmFtZSksCiAgICAgICAgICAgICAgICAgICAgZ2V0OiBERUZBVUxUX0dFVFRFUl9GVU5DVElPTihrZXlOYW1lKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleU5hbWUsIGRlZmF1bHREZXNjcmlwdG9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh3YXNEZXNjcmlwdG9yIHx8IGVudW1lcmFibGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUsCiAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9ialtrZXlOYW1lXSA9IGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IGRlc2M7CiAgICAgICAgICAgIC8vIGZhbGxiYWNrIHRvIEVTNQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBkZXNjKTsKICAgICAgICB9CiAgICAgICAgLy8gaWYga2V5IGlzIGJlaW5nIHdhdGNoZWQsIG92ZXJyaWRlIGNoYWlucyB0aGF0CiAgICAgICAgLy8gd2VyZSBpbml0aWFsaXplZCB3aXRoIHRoZSBwcm90b3R5cGUKICAgICAgICBpZiAod2F0Y2hpbmcpIHsKICAgICAgICAgICAgb3ZlcnJpZGVDaGFpbnMob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICB9CiAgICAgICAgLy8gVGhlIGB2YWx1ZWAgcGFzc2VkIHRvIHRoZSBgZGlkRGVmaW5lUHJvcGVydHlgIGhvb2sgaXMKICAgICAgICAvLyBlaXRoZXIgdGhlIGRlc2NyaXB0b3Igb3IgZGF0YSwgd2hpY2hldmVyIHdhcyBwYXNzZWQuCiAgICAgICAgaWYgKHR5cGVvZiBvYmouZGlkRGVmaW5lUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgb2JqLmRpZERlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgaGFuZGxlTWFuZGF0b3J5U2V0dGVyID0gdm9pZCAwOwogICAgZnVuY3Rpb24gd2F0Y2hLZXkob2JqLCBrZXlOYW1lLCBfbWV0YSkgewogICAgICAgIHZhciBtZXRhJCQxID0gX21ldGEgPT09IHVuZGVmaW5lZCA/ICgwLCBfZW1iZXJNZXRhLm1ldGEpKG9iaikgOiBfbWV0YTsKICAgICAgICB2YXIgY291bnQgPSBtZXRhJCQxLnBlZWtXYXRjaGluZyhrZXlOYW1lKTsKICAgICAgICBtZXRhJCQxLndyaXRlV2F0Y2hpbmcoa2V5TmFtZSwgY291bnQgKyAxKTsKICAgICAgICBpZiAoY291bnQgPT09IDApIHsKICAgICAgICAgICAgLy8gYWN0aXZhdGUgd2F0Y2hpbmcgZmlyc3QgdGltZQogICAgICAgICAgICB2YXIgcG9zc2libGVEZXNjID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgaWYgKHBvc3NpYmxlRGVzYyAhPT0gdW5kZWZpbmVkICYmIHBvc3NpYmxlRGVzYy53aWxsV2F0Y2gpIHsKICAgICAgICAgICAgICAgIHBvc3NpYmxlRGVzYy53aWxsV2F0Y2gob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG9iai53aWxsV2F0Y2hQcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgb2JqLndpbGxXYXRjaFByb3BlcnR5KGtleU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAvLyBOT1RFOiB0aGlzIGlzIGRyb3BwZWQgZm9yIHByb2QgKyBtaW5pZmllZCBidWlsZHMKICAgICAgICAgICAgICAgIGhhbmRsZU1hbmRhdG9yeVNldHRlcihtZXRhJCQxLCBvYmosIGtleU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgaWYgKHRydWUpIHsKICAgICAgICB2YXIgX2hhc093blByb3BlcnR5ID0gZnVuY3Rpb24gKG9iaiwga2V5KSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogICAgICAgIH07CiAgICAgICAgdmFyIF9wcm9wZXJ0eUlzRW51bWVyYWJsZSA9IGZ1bmN0aW9uIChvYmosIGtleSkgewogICAgICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iaiwga2V5KTsKICAgICAgICB9OwogICAgICAgIC8vIEZ1dHVyZSB0cmF2ZWxlciwgYWx0aG91Z2ggdGhpcyBjb2RlIGxvb2tzIHNjYXJ5LiBJdCBtZXJlbHkgZXhpc3RzIGluCiAgICAgICAgLy8gZGV2ZWxvcG1lbnQgdG8gYWlkIGluIGRldmVsb3BtZW50IGFzZXJ0aW9ucy4gUHJvZHVjdGlvbiBidWlsZHMgb2YKICAgICAgICAvLyBlbWJlciBzdHJpcCB0aGlzIGVudGlyZSBibG9jayBvdXQKICAgICAgICBoYW5kbGVNYW5kYXRvcnlTZXR0ZXIgPSBmdW5jdGlvbiBoYW5kbGVNYW5kYXRvcnlTZXR0ZXIobSwgb2JqLCBrZXlOYW1lKSB7CiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gKDAsIF9lbWJlclV0aWxzLmxvb2t1cERlc2NyaXB0b3IpKG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgIHZhciBoYXNEZXNjcmlwdG9yID0gZGVzY3JpcHRvciAhPT0gbnVsbDsKICAgICAgICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IGhhc0Rlc2NyaXB0b3IgJiYgZGVzY3JpcHRvci52YWx1ZTsKICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJNZXRhLmlzRGVzY3JpcHRvcikocG9zc2libGVEZXNjKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb25maWd1cmFibGUgPSBoYXNEZXNjcmlwdG9yID8gZGVzY3JpcHRvci5jb25maWd1cmFibGUgOiB0cnVlOwogICAgICAgICAgICB2YXIgaXNXcml0YWJsZSA9IGhhc0Rlc2NyaXB0b3IgPyBkZXNjcmlwdG9yLndyaXRhYmxlIDogdHJ1ZTsKICAgICAgICAgICAgdmFyIGhhc1ZhbHVlID0gaGFzRGVzY3JpcHRvciA/ICd2YWx1ZScgaW4gZGVzY3JpcHRvciA6IHRydWU7CiAgICAgICAgICAgIC8vIHRoaXMgeCBpbiBZIGRlb3B0cywgc28ga2VlcGluZyBpdCBpbiB0aGlzIGZ1bmN0aW9uIGlzIGJldHRlcjsKICAgICAgICAgICAgaWYgKGNvbmZpZ3VyYWJsZSAmJiBpc1dyaXRhYmxlICYmIGhhc1ZhbHVlICYmIGtleU5hbWUgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVzYyA9IHsKICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc2V0OiBNQU5EQVRPUllfU0VUVEVSX0ZVTkNUSU9OKGtleU5hbWUpLAogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IF9wcm9wZXJ0eUlzRW51bWVyYWJsZShvYmosIGtleU5hbWUpLAogICAgICAgICAgICAgICAgICAgIGdldDogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKF9oYXNPd25Qcm9wZXJ0eShvYmosIGtleU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbS53cml0ZVZhbHVlcyhrZXlOYW1lLCBvYmpba2V5TmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGRlc2MuZ2V0ID0gREVGQVVMVF9HRVRURVJfRlVOQ1RJT04oa2V5TmFtZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlc2MuZ2V0ID0gSU5IRVJJVElOR19HRVRURVJfRlVOQ1RJT04oa2V5TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBkZXNjKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB1bndhdGNoS2V5KG9iaiwga2V5TmFtZSwgX21ldGEpIHsKICAgICAgICB2YXIgbWV0YSQkMSA9IF9tZXRhID09PSB1bmRlZmluZWQgPyAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkob2JqKSA6IF9tZXRhOwogICAgICAgIC8vIGRvIG5vdGhpbmcgb2YgdGhpcyBvYmplY3QgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWQKICAgICAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkIHx8IG1ldGEkJDEuaXNTb3VyY2VEZXN0cm95ZWQoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBjb3VudCA9IG1ldGEkJDEucGVla1dhdGNoaW5nKGtleU5hbWUpOwogICAgICAgIGlmIChjb3VudCA9PT0gMSkgewogICAgICAgICAgICBtZXRhJCQxLndyaXRlV2F0Y2hpbmcoa2V5TmFtZSwgMCk7CiAgICAgICAgICAgIHZhciBwb3NzaWJsZURlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgICAgICB2YXIgaXNEZXNjcmlwdG9yJCQxID0gcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmIChpc0Rlc2NyaXB0b3IkJDEgJiYgcG9zc2libGVEZXNjLmRpZFVud2F0Y2gpIHsKICAgICAgICAgICAgICAgIHBvc3NpYmxlRGVzYy5kaWRVbndhdGNoKG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmouZGlkVW53YXRjaFByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBvYmouZGlkVW53YXRjaFByb3BlcnR5KGtleU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICAvLyBJdCBpcyB0cnVlLCB0aGUgZm9sbG93aW5nIGNvZGUgbG9va3MgcXVpdGUgV0FULiBCdXQgaGF2ZSBubyBmZWFyLCBJdAogICAgICAgICAgICAgICAgLy8gZXhpc3RzIHB1cmVseSB0byBpbXByb3ZlIGRldmVsb3BtZW50IGVyZ29ub21pY3MgYW5kIGlzIHJlbW92ZWQgZnJvbQogICAgICAgICAgICAgICAgLy8gZW1iZXIubWluLmpzIGFuZCBlbWJlci5wcm9kLmpzIGJ1aWxkcy4KICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBTb21lIGZ1cnRoZXIgY29udGV4dDogT25jZSBhIHByb3BlcnR5IGlzIHdhdGNoZWQgYnkgZW1iZXIsIGJ5cGFzc2luZyBgc2V0YAogICAgICAgICAgICAgICAgLy8gZm9yIG11dGF0aW9uLCB3aWxsIGJ5cGFzcyBvYnNlcnZhdGlvbi4gVGhpcyBjb2RlIGV4aXN0cyB0byBhc3NlcnQgd2hlbgogICAgICAgICAgICAgICAgLy8gdGhhdCBvY2N1cnMsIGFuZCBhdHRlbXB0IHRvIHByb3ZpZGUgbW9yZSBoZWxwZnVsIGZlZWRiYWNrLiBUaGUgYWx0ZXJuYXRpdmUKICAgICAgICAgICAgICAgIC8vIGlzIHRyaWNreSB0byBkZWJ1ZyBwYXJ0aWFsbHkgb2JzZXJ2YWJsZSBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgaWYgKCFpc0Rlc2NyaXB0b3IkJDEgJiYga2V5TmFtZSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF5YmVNYW5kYXRvcnlEZXNjcmlwdG9yID0gKDAsIF9lbWJlclV0aWxzLmxvb2t1cERlc2NyaXB0b3IpKG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvciAmJiBtYXliZU1hbmRhdG9yeURlc2NyaXB0b3Iuc2V0ICYmIG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvci5zZXQuaXNNYW5kYXRvcnlTZXR0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1heWJlTWFuZGF0b3J5RGVzY3JpcHRvci5nZXQgJiYgbWF5YmVNYW5kYXRvcnlEZXNjcmlwdG9yLmdldC5pc0luaGVyaXRpbmdHZXR0ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3NzaWJsZVZhbHVlID0gbWV0YSQkMS5yZWFkSW5oZXJpdGVkVmFsdWUoJ3ZhbHVlcycsIGtleU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlVmFsdWUgPT09IF9lbWJlck1ldGEuVU5ERUZJTkVEKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9ialtrZXlOYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKG9iaiwga2V5TmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBtZXRhJCQxLnBlZWtWYWx1ZXMoa2V5TmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGEkJDEuZGVsZXRlRnJvbVZhbHVlcyhrZXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvdW50ID4gMSkgewogICAgICAgICAgICBtZXRhJCQxLndyaXRlV2F0Y2hpbmcoa2V5TmFtZSwgY291bnQgLSAxKTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIEVBQ0hfUFJPWElFUyA9IG5ldyBXZWFrTWFwKCk7CiAgICBmdW5jdGlvbiBlYWNoUHJveHlBcnJheVdpbGxDaGFuZ2UoYXJyYXksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgICAgICB2YXIgZWFjaFByb3h5ID0gRUFDSF9QUk9YSUVTLmdldChhcnJheSk7CiAgICAgICAgaWYgKGVhY2hQcm94eSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGVhY2hQcm94eS5hcnJheVdpbGxDaGFuZ2UoYXJyYXksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGVhY2hQcm94eUFycmF5RGlkQ2hhbmdlKGFycmF5LCBpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KSB7CiAgICAgICAgdmFyIGVhY2hQcm94eSA9IEVBQ0hfUFJPWElFUy5nZXQoYXJyYXkpOwogICAgICAgIGlmIChlYWNoUHJveHkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBlYWNoUHJveHkuYXJyYXlEaWRDaGFuZ2UoYXJyYXksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGFycmF5LCBzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXQpIHsKICAgICAgICAvLyBpZiBubyBhcmdzIGFyZSBwYXNzZWQgYXNzdW1lIGV2ZXJ5dGhpbmcgY2hhbmdlcwogICAgICAgIGlmIChzdGFydElkeCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHN0YXJ0SWR4ID0gMDsKICAgICAgICAgICAgcmVtb3ZlQW10ID0gYWRkQW10ID0gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHJlbW92ZUFtdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZW1vdmVBbXQgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWRkQW10ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGFkZEFtdCA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVhY2hQcm94eUFycmF5V2lsbENoYW5nZShhcnJheSwgc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KTsKICAgICAgICBzZW5kRXZlbnQoYXJyYXksICdAYXJyYXk6YmVmb3JlJywgW2FycmF5LCBzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXRdKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICB9CiAgICBmdW5jdGlvbiBhcnJheUNvbnRlbnREaWRDaGFuZ2UoYXJyYXksIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdCkgewogICAgICAgIC8vIGlmIG5vIGFyZ3MgYXJlIHBhc3NlZCBhc3N1bWUgZXZlcnl0aGluZyBjaGFuZ2VzCiAgICAgICAgaWYgKHN0YXJ0SWR4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgc3RhcnRJZHggPSAwOwogICAgICAgICAgICByZW1vdmVBbXQgPSBhZGRBbXQgPSAtMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVtb3ZlQW10ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJlbW92ZUFtdCA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhZGRBbXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgYWRkQW10ID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkoYXJyYXkpOwogICAgICAgIGlmIChhZGRBbXQgPCAwIHx8IHJlbW92ZUFtdCA8IDAgfHwgYWRkQW10IC0gcmVtb3ZlQW10ICE9PSAwKSB7CiAgICAgICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnbGVuZ3RoJywgbWV0YSQkMSk7CiAgICAgICAgfQogICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnW10nLCBtZXRhJCQxKTsKICAgICAgICBlYWNoUHJveHlBcnJheURpZENoYW5nZShhcnJheSwgc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KTsKICAgICAgICBzZW5kRXZlbnQoYXJyYXksICdAYXJyYXk6Y2hhbmdlJywgW2FycmF5LCBzdGFydElkeCwgcmVtb3ZlQW10LCBhZGRBbXRdKTsKICAgICAgICB2YXIgY2FjaGUgPSBwZWVrQ2FjaGVGb3IoYXJyYXkpOwogICAgICAgIGlmIChjYWNoZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBhZGRlZEFtb3VudCA9IGFkZEFtdCA9PT0gLTEgPyAwIDogYWRkQW10OwogICAgICAgICAgICB2YXIgcmVtb3ZlZEFtb3VudCA9IHJlbW92ZUFtdCA9PT0gLTEgPyAwIDogcmVtb3ZlQW10OwogICAgICAgICAgICB2YXIgZGVsdGEgPSBhZGRlZEFtb3VudCAtIHJlbW92ZWRBbW91bnQ7CiAgICAgICAgICAgIHZhciBwcmV2aW91c0xlbmd0aCA9IGxlbmd0aCAtIGRlbHRhOwogICAgICAgICAgICB2YXIgbm9ybWFsU3RhcnRJZHggPSBzdGFydElkeCA8IDAgPyBwcmV2aW91c0xlbmd0aCArIHN0YXJ0SWR4IDogc3RhcnRJZHg7CiAgICAgICAgICAgIGlmIChjYWNoZS5oYXMoJ2ZpcnN0T2JqZWN0JykgJiYgbm9ybWFsU3RhcnRJZHggPT09IDApIHsKICAgICAgICAgICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGFycmF5LCAnZmlyc3RPYmplY3QnLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FjaGUuaGFzKCdsYXN0T2JqZWN0JykpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0xhc3RJbmRleCA9IHByZXZpb3VzTGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgIHZhciBsYXN0QWZmZWN0ZWRJbmRleCA9IG5vcm1hbFN0YXJ0SWR4ICsgcmVtb3ZlZEFtb3VudDsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0xhc3RJbmRleCA8IGxhc3RBZmZlY3RlZEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgbm90aWZ5UHJvcGVydHlDaGFuZ2UoYXJyYXksICdsYXN0T2JqZWN0JywgbWV0YSQkMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgfQoKICAgIC8qKgogICAgICBBbiBvYmplY3QgdGhhdCB0aGF0IHRyYWNrcyBAdHJhY2tlZCBwcm9wZXJ0aWVzIHRoYXQgd2VyZSBjb25zdW1lZC4KICAgIAogICAgICBAcHJpdmF0ZQogICAgICovCgogICAgdmFyIFRyYWNrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gVHJhY2tlcigpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUcmFja2VyKTsKCiAgICAgICAgICAgIHRoaXMudGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIFRyYWNrZXIucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZCh0YWcpIHsKICAgICAgICAgICAgdGhpcy50YWdzLmFkZCh0YWcpOwogICAgICAgICAgICB0aGlzLmxhc3QgPSB0YWc7CiAgICAgICAgfTsKCiAgICAgICAgVHJhY2tlci5wcm90b3R5cGUuY29tYmluZSA9IGZ1bmN0aW9uIGNvbWJpbmUoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRhZ3Muc2l6ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9yZWZlcmVuY2UuQ09OU1RBTlRfVEFHOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFncy5zaXplID09PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYXN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHRhZ3MgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMudGFncy5mb3JFYWNoKGZ1bmN0aW9uICh0YWcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFncy5wdXNoKHRhZyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiAoMCwgX3JlZmVyZW5jZS5jb21iaW5lKSh0YWdzKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgICgwLCBfZW1iZXJCYWJlbC5jcmVhdGVDbGFzcykoVHJhY2tlciwgW3sKICAgICAgICAgICAga2V5OiAnc2l6ZScsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudGFncy5zaXplOwogICAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICAgIHJldHVybiBUcmFja2VyOwogICAgfSgpOwoKICAgIC8qKgogICAgICBAZGVjb3JhdG9yCiAgICAgIEBwcml2YXRlCiAgICAKICAgICAgTWFya3MgYSBwcm9wZXJ0eSBhcyB0cmFja2VkLgogICAgCiAgICAgIEJ5IGRlZmF1bHQsIGEgY29tcG9uZW50J3MgcHJvcGVydGllcyBhcmUgZXhwZWN0ZWQgdG8gYmUgc3RhdGljLAogICAgICBtZWFuaW5nIHlvdSBhcmUgbm90IGFibGUgdG8gdXBkYXRlIHRoZW0gYW5kIGhhdmUgdGhlIHRlbXBsYXRlIHVwZGF0ZSBhY2NvcmRpbmdseS4KICAgICAgTWFya2luZyBhIHByb3BlcnR5IGFzIHRyYWNrZWQgbWVhbnMgdGhhdCB3aGVuIHRoYXQgcHJvcGVydHkgY2hhbmdlcywKICAgICAgYSByZXJlbmRlciBvZiB0aGUgY29tcG9uZW50IGlzIHNjaGVkdWxlZCBzbyB0aGUgdGVtcGxhdGUgaXMga2VwdCB1cCB0byBkYXRlLgogICAgCiAgICAgIFRoZXJlIGFyZSB0d28gdXNhZ2VzIGZvciB0aGUgYEB0cmFja2VkYCBkZWNvcmF0b3IsIHNob3duIGJlbG93LgogICAgCiAgICAgIEBleGFtcGxlIE5vIGRlcGVuZGVuY2llcwogICAgCiAgICAgIElmIHlvdSBkb24ndCBwYXNzIGFuIGFyZ3VtZW50IHRvIGBAdHJhY2tlZGAsIG9ubHkgY2hhbmdlcyB0byB0aGF0IHByb3BlcnR5CiAgICAgIHdpbGwgYmUgdHJhY2tlZDoKICAgIAogICAgICBgYGB0eXBlc2NyaXB0CiAgICAgIGltcG9ydCBDb21wb25lbnQsIHsgdHJhY2tlZCB9IGZyb20gJ0BnbGltbWVyL2NvbXBvbmVudCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgY2xhc3MgTXlDb21wb25lbnQgZXh0ZW5kcyBDb21wb25lbnQgewogICAgICAgIEB0cmFja2VkCiAgICAgICAgcmVtYWluaW5nQXBwbGVzID0gMTAKICAgICAgfQogICAgICBgYGAKICAgIAogICAgICBXaGVuIHNvbWV0aGluZyBjaGFuZ2VzIHRoZSBjb21wb25lbnQncyBgcmVtYWluaW5nQXBwbGVzYCBwcm9wZXJ0eSwgdGhlIHJlcmVuZGVyCiAgICAgIHdpbGwgYmUgc2NoZWR1bGVkLgogICAgCiAgICAgIEBleGFtcGxlIERlcGVuZGVudHMKICAgIAogICAgICBJbiB0aGUgY2FzZSB0aGF0IHlvdSBoYXZlIGEgY29tcHV0ZWQgcHJvcGVydHkgdGhhdCBkZXBlbmRzIG90aGVyCiAgICAgIHByb3BlcnRpZXMsIHlvdSB3YW50IHRvIHRyYWNrIGJvdGggc28gdGhhdCB3aGVuIG9uZSBvZiB0aGUKICAgICAgZGVwZW5kZW50cyBjaGFuZ2UsIGEgcmVyZW5kZXIgaXMgc2NoZWR1bGVkLgogICAgCiAgICAgIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSB3ZSBoYXZlIHR3byBwcm9wZXJ0aWVzLAogICAgICBgZWF0ZW5BcHBsZXNgLCBhbmQgYHJlbWFpbmluZ0FwcGxlc2AuCiAgICAKICAgICAgYGBgdHlwZXNjcmlwdAogICAgICBpbXBvcnQgQ29tcG9uZW50LCB7IHRyYWNrZWQgfSBmcm9tICdAZ2xpbW1lci9jb21wb25lbnQnOwogICAgCiAgICAgIGNvbnN0IHRvdGFsQXBwbGVzID0gMTAwOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IGNsYXNzIE15Q29tcG9uZW50IGV4dGVuZHMgQ29tcG9uZW50IHsKICAgICAgICBAdHJhY2tlZAogICAgICAgIGVhdGVuQXBwbGVzID0gMAogICAgCiAgICAgICAgQHRyYWNrZWQoJ2VhdGVuQXBwbGVzJykKICAgICAgICBnZXQgcmVtYWluaW5nQXBwbGVzKCkgewogICAgICAgICAgcmV0dXJuIHRvdGFsQXBwbGVzIC0gdGhpcy5lYXRlbkFwcGxlczsKICAgICAgICB9CiAgICAKICAgICAgICBpbmNyZW1lbnQoKSB7CiAgICAgICAgICB0aGlzLmVhdGVuQXBwbGVzID0gdGhpcy5lYXRlbkFwcGxlcyArIDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgCiAgICAgIEBwYXJhbSBkZXBlbmRlbmNpZXMgT3B0aW9uYWwgZGVwZW5kZW50cyB0byBiZSB0cmFja2VkLgogICAgICovCiAgICBmdW5jdGlvbiB0cmFja2VkKF90YXJnZXQsIGtleSwgZGVzY3JpcHRvcikgewogICAgICAgIGlmICgndmFsdWUnIGluIGRlc2NyaXB0b3IpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3JGb3JEYXRhUHJvcGVydHkoa2V5LCBkZXNjcmlwdG9yKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpcHRvckZvckFjY2Vzc29yKGtleSwgZGVzY3JpcHRvcik7CiAgICAgICAgfQogICAgfQogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAKICAgICAgV2hlbmV2ZXIgYSB0cmFja2VkIGNvbXB1dGVkIHByb3BlcnR5IGlzIGVudGVyZWQsIHRoZSBjdXJyZW50IHRyYWNrZXIgaXMKICAgICAgc2F2ZWQgb2ZmIGFuZCBhIG5ldyB0cmFja2VyIGlzIHJlcGxhY2VkLgogICAgCiAgICAgIEFueSB0cmFja2VkIHByb3BlcnRpZXMgY29uc3VtZWQgYXJlIGFkZGVkIHRvIHRoZSBjdXJyZW50IHRyYWNrZXIuCiAgICAKICAgICAgV2hlbiBhIHRyYWNrZWQgY29tcHV0ZWQgcHJvcGVydHkgaXMgZXhpdGVkLCB0aGUgdHJhY2tlcidzIHRhZ3MgYXJlCiAgICAgIGNvbWJpbmVkIGFuZCBhZGRlZCB0byB0aGUgcGFyZW50IHRyYWNrZXIuCiAgICAKICAgICAgVGhlIGNvbnNlcXVlbmNlIGlzIHRoYXQgZWFjaCB0cmFja2VkIGNvbXB1dGVkIHByb3BlcnR5IGhhcyBhIHRhZwogICAgICB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSB0cmFja2VkIHByb3BlcnRpZXMgY29uc3VtZWQgaW5zaWRlIG9mCiAgICAgIGl0c2VsZiwgaW5jbHVkaW5nIGNoaWxkIHRyYWNrZWQgY29tcHV0ZWQgcHJvcGVydGllcy4KICAgICAqLwogICAgdmFyIENVUlJFTlRfVFJBQ0tFUiA9IG51bGw7CiAgICBmdW5jdGlvbiBnZXRDdXJyZW50VHJhY2tlcigpIHsKICAgICAgICByZXR1cm4gQ1VSUkVOVF9UUkFDS0VSOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VycmVudFRyYWNrZXIoKSB7CiAgICAgICAgdmFyIHRyYWNrZXIgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IG5ldyBUcmFja2VyKCk7CgogICAgICAgIHJldHVybiBDVVJSRU5UX1RSQUNLRVIgPSB0cmFja2VyOwogICAgfQogICAgZnVuY3Rpb24gZGVzY3JpcHRvckZvckFjY2Vzc29yKGtleSwgZGVzY3JpcHRvcikgewogICAgICAgIHZhciBnZXQgPSBkZXNjcmlwdG9yLmdldDsKICAgICAgICB2YXIgc2V0ID0gZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgZnVuY3Rpb24gZ2V0dGVyKCkgewogICAgICAgICAgICAvLyBTd2FwIHRoZSBwYXJlbnQgdHJhY2tlciBmb3IgYSBuZXcgdHJhY2tlcgogICAgICAgICAgICB2YXIgb2xkID0gQ1VSUkVOVF9UUkFDS0VSOwogICAgICAgICAgICB2YXIgdHJhY2tlciA9IENVUlJFTlRfVFJBQ0tFUiA9IG5ldyBUcmFja2VyKCk7CiAgICAgICAgICAgIC8vIENhbGwgdGhlIGdldHRlcgogICAgICAgICAgICB2YXIgcmV0ID0gZ2V0LmNhbGwodGhpcyk7CiAgICAgICAgICAgIC8vIFN3YXAgYmFjayB0aGUgcGFyZW50IHRyYWNrZXIKICAgICAgICAgICAgQ1VSUkVOVF9UUkFDS0VSID0gb2xkOwogICAgICAgICAgICAvLyBDb21iaW5lIHRoZSB0YWdzIGluIHRoZSBuZXcgdHJhY2tlciBhbmQgYWRkIHRoZW0gdG8gdGhlIHBhcmVudCB0cmFja2VyCiAgICAgICAgICAgIHZhciB0YWcgPSB0cmFja2VyLmNvbWJpbmUoKTsKICAgICAgICAgICAgaWYgKENVUlJFTlRfVFJBQ0tFUikgQ1VSUkVOVF9UUkFDS0VSLmFkZCh0YWcpOwogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIFVwZGF0YWJsZVRhZyBmb3IgdGhpcyBwcm9wZXJ0eSB3aXRoIHRoZSB0YWcgZm9yIGFsbCBvZiB0aGUKICAgICAgICAgICAgLy8gY29uc3VtZWQgZGVwZW5kZW5jaWVzLgogICAgICAgICAgICB1cGRhdGUodGFnRm9yUHJvcGVydHkodGhpcywga2V5KSwgdGFnKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0dGVyKCkgewogICAgICAgICAgICBkaXJ0eSh0YWdGb3JQcm9wZXJ0eSh0aGlzLCBrZXkpKTsKICAgICAgICAgICAgc2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIGdldDogZ2V0ICYmIGdldHRlciwKICAgICAgICAgICAgc2V0OiBzZXQgJiYgc2V0dGVyCiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgCiAgICAgIEEgZ2V0dGVyL3NldHRlciBmb3IgY2hhbmdlIHRyYWNraW5nIGZvciBhIHBhcnRpY3VsYXIga2V5LiBUaGUgYWNjZXNzb3IKICAgICAgYWN0cyBqdXN0IGxpa2UgYSBub3JtYWwgcHJvcGVydHksIGJ1dCBpdCB0cmlnZ2VycyB0aGUgYHByb3BlcnR5RGlkQ2hhbmdlYAogICAgICBob29rIHdoZW4gd3JpdHRlbiB0by4KICAgIAogICAgICBWYWx1ZXMgYXJlIHNhdmVkIG9uIHRoZSBvYmplY3QgdXNpbmcgYSAic2hhZG93IGtleSwiIG9yIGEgc3ltYm9sIGJhc2VkIG9uIHRoZQogICAgICB0cmFja2VkIHByb3BlcnR5IG5hbWUuIFNldHMgd3JpdGUgdGhlIHZhbHVlIHRvIHRoZSBzaGFkb3cga2V5LCBhbmQgZ2V0cyByZWFkCiAgICAgIGZyb20gaXQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlc2NyaXB0b3JGb3JEYXRhUHJvcGVydHkoa2V5LCBkZXNjcmlwdG9yKSB7CiAgICAgICAgdmFyIHNoYWRvd0tleSA9IFN5bWJvbChrZXkpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoQ1VSUkVOVF9UUkFDS0VSKSBDVVJSRU5UX1RSQUNLRVIuYWRkKHRhZ0ZvclByb3BlcnR5KHRoaXMsIGtleSkpOwogICAgICAgICAgICAgICAgaWYgKCEoc2hhZG93S2V5IGluIHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpc1tzaGFkb3dLZXldID0gZGVzY3JpcHRvci52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW3NoYWRvd0tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICB0YWdGb3IodGhpcykuaW5uZXJbJ2RpcnR5J10oKTsKICAgICAgICAgICAgICAgIGRpcnR5KHRhZ0ZvclByb3BlcnR5KHRoaXMsIGtleSkpOwogICAgICAgICAgICAgICAgdGhpc1tzaGFkb3dLZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICBwcm9wZXJ0eURpZENoYW5nZSQxKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQogICAgdmFyIHByb3BlcnR5RGlkQ2hhbmdlJDEgPSBmdW5jdGlvbiAoKSB7fTsKCiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICAgKi8KICAgIHZhciBBTExPV0FCTEVfVFlQRVMgPSB7CiAgICAgICAgb2JqZWN0OiB0cnVlLAogICAgICAgIGZ1bmN0aW9uOiB0cnVlLAogICAgICAgIHN0cmluZzogdHJ1ZQogICAgfTsKICAgIHZhciBQUk9YWV9DT05URU5UID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ1BST1hZX0NPTlRFTlQnKTsKICAgIHZhciBnZXRQb3NzaWJsZU1hbmRhdG9yeVByb3h5VmFsdWUgPSB2b2lkIDA7CiAgICBpZiAodHJ1ZSAmJiBfZW1iZXJVdGlscy5IQVNfTkFUSVZFX1BST1hZKSB7CiAgICAgICAgZ2V0UG9zc2libGVNYW5kYXRvcnlQcm94eVZhbHVlID0gZnVuY3Rpb24gZ2V0UG9zc2libGVNYW5kYXRvcnlQcm94eVZhbHVlKG9iaiwga2V5TmFtZSkgewogICAgICAgICAgICB2YXIgY29udGVudCA9IG9ialtQUk9YWV9DT05URU5UXTsKICAgICAgICAgICAgaWYgKGNvbnRlbnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9ialtrZXlOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8qIGdsb2JhbCBSZWZsZWN0ICovCiAgICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQoY29udGVudCwga2V5TmFtZSwgb2JqKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBHRVQgQU5EIFNFVAogICAgLy8KICAgIC8vIElmIHdlIGFyZSBvbiBhIHBsYXRmb3JtIHRoYXQgc3VwcG9ydHMgYWNjZXNzb3JzIHdlIGNhbiB1c2UgdGhvc2UuCiAgICAvLyBPdGhlcndpc2Ugc2ltdWxhdGUgYWNjZXNzb3JzIGJ5IGxvb2tpbmcgdXAgdGhlIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZQogICAgLy8gb2JqZWN0LgogICAgLyoqCiAgICAgIEdldHMgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBJZiB0aGUgcHJvcGVydHkgaXMgY29tcHV0ZWQsCiAgICAgIHRoZSBmdW5jdGlvbiB3aWxsIGJlIGludm9rZWQuIElmIHRoZSBwcm9wZXJ0eSBpcyBub3QgZGVmaW5lZCBidXQgdGhlCiAgICAgIG9iamVjdCBpbXBsZW1lbnRzIHRoZSBgdW5rbm93blByb3BlcnR5YCBtZXRob2QgdGhlbiB0aGF0IHdpbGwgYmUgaW52b2tlZC4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGdldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICBnZXQob2JqLCAibmFtZSIpOwogICAgICBgYGAKICAgIAogICAgICBJZiB5b3UgcGxhbiB0byBydW4gb24gSUU4IGFuZCBvbGRlciBicm93c2VycyB0aGVuIHlvdSBzaG91bGQgdXNlIHRoaXMKICAgICAgbWV0aG9kIGFueXRpbWUgeW91IHdhbnQgdG8gcmV0cmlldmUgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QgdGhhdCB5b3UgZG9uJ3QKICAgICAga25vdyBmb3Igc3VyZSBpcyBwcml2YXRlLiAoUHJvcGVydGllcyBiZWdpbm5pbmcgd2l0aCBhbiB1bmRlcnNjb3JlICdfJwogICAgICBhcmUgY29uc2lkZXJlZCBwcml2YXRlLikKICAgIAogICAgICBPbiBhbGwgbmV3ZXIgYnJvd3NlcnMsIHlvdSBvbmx5IG5lZWQgdG8gdXNlIHRoaXMgbWV0aG9kIHRvIHJldHJpZXZlCiAgICAgIHByb3BlcnRpZXMgaWYgdGhlIHByb3BlcnR5IG1pZ2h0IG5vdCBiZSBkZWZpbmVkIG9uIHRoZSBvYmplY3QgYW5kIHlvdSB3YW50CiAgICAgIHRvIHJlc3BlY3QgdGhlIGB1bmtub3duUHJvcGVydHlgIGhhbmRsZXIuIE90aGVyd2lzZSB5b3UgY2FuIGlnbm9yZSB0aGlzCiAgICAgIG1ldGhvZC4KICAgIAogICAgICBOb3RlIHRoYXQgaWYgdGhlIG9iamVjdCBpdHNlbGYgaXMgYHVuZGVmaW5lZGAsIHRoaXMgbWV0aG9kIHdpbGwgdGhyb3cKICAgICAgYW4gZXJyb3IuCiAgICAKICAgICAgQG1ldGhvZCBnZXQKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICAgIEBzdGF0aWMKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHJldHJpZXZlIGZyb20uCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSBrZXkgdG8gcmV0cmlldmUKICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgcHJvcGVydHkgdmFsdWUgb3IgYG51bGxgLgogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gX2dldChvYmosIGtleU5hbWUpIHsKICAgICAgICAodHJ1ZSAmJiAhKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnR2V0IG11c3QgYmUgY2FsbGVkIHdpdGggdHdvIGFyZ3VtZW50czsgYW4gb2JqZWN0IGFuZCBhIHByb3BlcnR5IGtleScsIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpKTsKICAgICAgICAodHJ1ZSAmJiAhKG9iaiAhPT0gdW5kZWZpbmVkICYmIG9iaiAhPT0gbnVsbCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2FsbCBnZXQgd2l0aCBcJycgKyBrZXlOYW1lICsgJ1wnIG9uIGFuIHVuZGVmaW5lZCBvYmplY3QuJywgb2JqICE9PSB1bmRlZmluZWQgJiYgb2JqICE9PSBudWxsKSk7CiAgICAgICAgKHRydWUgJiYgISh0eXBlb2Yga2V5TmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGtleU5hbWUgPT09ICdudW1iZXInICYmICFpc05hTihrZXlOYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUga2V5IHByb3ZpZGVkIHRvIGdldCBtdXN0IGJlIGEgc3RyaW5nIG9yIG51bWJlciwgeW91IHBhc3NlZCAnICsga2V5TmFtZSwgdHlwZW9mIGtleU5hbWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBrZXlOYW1lID09PSAnbnVtYmVyJyAmJiAhaXNOYU4oa2V5TmFtZSkpKTsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBrZXlOYW1lICE9PSAnc3RyaW5nJyB8fCBrZXlOYW1lLmxhc3RJbmRleE9mKCd0aGlzLicsIDApICE9PSAwKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1wndGhpc1wnIGluIHBhdGhzIGlzIG5vdCBzdXBwb3J0ZWQnLCB0eXBlb2Yga2V5TmFtZSAhPT0gJ3N0cmluZycgfHwga2V5TmFtZS5sYXN0SW5kZXhPZigndGhpcy4nLCAwKSAhPT0gMCkpOwogICAgICAgICh0cnVlICYmICEoa2V5TmFtZSAhPT0gJycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGNhbGwgYGdldGAgd2l0aCBhbiBlbXB0eSBzdHJpbmcnLCBrZXlOYW1lICE9PSAnJykpOwoKICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBvYmo7CiAgICAgICAgdmFyIGlzT2JqZWN0ID0gdHlwZSA9PT0gJ29iamVjdCc7CiAgICAgICAgdmFyIGlzRnVuY3Rpb24gPSB0eXBlID09PSAnZnVuY3Rpb24nOwogICAgICAgIHZhciBpc09iamVjdExpa2UgPSBpc09iamVjdCB8fCBpc0Z1bmN0aW9uOwogICAgICAgIHZhciBkZXNjcmlwdG9yID0gdm9pZCAwOwogICAgICAgIHZhciB2YWx1ZSA9IHZvaWQgMDsKICAgICAgICBpZiAoaXNPYmplY3RMaWtlKSB7CiAgICAgICAgICAgIGlmIChmYWxzZSkgewogICAgICAgICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRDdXJyZW50VHJhY2tlcigpOwogICAgICAgICAgICAgICAgaWYgKHRyYWNrZXIpIHRyYWNrZXIuYWRkKHRhZ0ZvclByb3BlcnR5KG9iaiwga2V5TmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlc2NyaXB0b3IgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleU5hbWUpOwogICAgICAgICAgICBpZiAoZGVzY3JpcHRvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpcHRvci5nZXQob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHJ1ZSAmJiBfZW1iZXJVdGlscy5IQVNfTkFUSVZFX1BST1hZKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGdldFBvc3NpYmxlTWFuZGF0b3J5UHJveHlWYWx1ZShvYmosIGtleU5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSBvYmpba2V5TmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUFJPUEVSVFlfQkFTRURfREVTQ1JJUFRPUlMgJiYgKDAsIF9lbWJlck1ldGEuaXNEZXNjcmlwdG9yKSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnW0RFUFJFQ0FURURdIGNvbXB1dGVkIHByb3BlcnR5IFwnJyArIGtleU5hbWUgKyAnXCcgd2FzIG5vdCBzZXQgb24gb2JqZWN0IFwnJyArICgwLCBfZW1iZXJVdGlscy50b1N0cmluZykob2JqKSArICdcJyB2aWEgXCdkZWZpbmVQcm9wZXJ0eVwnJywgZmFsc2UsIHsKICAgICAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLW1ldGEuZGVzY3JpcHRvci1vbi1vYmplY3QnLAogICAgICAgICAgICAgICAgICAgIHVudGlsOiAnMy41LjAnLAogICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX3VzZS1kZWZpbmVQcm9wZXJ0eS10by1kZWZpbmUtY29tcHV0ZWQtcHJvcGVydGllcycKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHZhbHVlLmVudW1lcmFibGUgPT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUuZ2V0KHRoaXMsIGtleU5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKS53cml0ZURlc2NyaXB0b3JzKGtleU5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUuc2V0dXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zZXR1cChvYmosIGtleU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmdldChvYmosIGtleU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBvYmpba2V5TmFtZV07CiAgICAgICAgfQogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmIChpc1BhdGgoa2V5TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfZ2V0UGF0aChvYmosIGtleU5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc09iamVjdCAmJiAhKGtleU5hbWUgaW4gb2JqKSAmJiB0eXBlb2Ygb2JqLnVua25vd25Qcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iai51bmtub3duUHJvcGVydHkoa2V5TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgZnVuY3Rpb24gX2dldFBhdGgocm9vdCwgcGF0aCkgewogICAgICAgIHZhciBvYmogPSByb290OwogICAgICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNHZXR0YWJsZShvYmopKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9iaiA9IF9nZXQob2JqLCBwYXJ0c1tpXSk7CiAgICAgICAgICAgIGlmIChvYmogJiYgb2JqLmlzRGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICBmdW5jdGlvbiBpc0dldHRhYmxlKG9iaikgewogICAgICAgIHJldHVybiBvYmogIT09IHVuZGVmaW5lZCAmJiBvYmogIT09IG51bGwgJiYgQUxMT1dBQkxFX1RZUEVTW3R5cGVvZiBvYmpdOwogICAgfQogICAgLyoqCiAgICAgIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSBmcm9tIGFuIE9iamVjdCwgb3IgYSBkZWZhdWx0IHZhbHVlIGluIHRoZQogICAgICBjYXNlIHRoYXQgdGhlIHByb3BlcnR5IHJldHVybnMgYHVuZGVmaW5lZGAuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBnZXRXaXRoRGVmYXVsdCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICBnZXRXaXRoRGVmYXVsdChwZXJzb24sICdsYXN0TmFtZScsICdEb2UnKTsKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBnZXRXaXRoRGVmYXVsdAogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHN0YXRpYwogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gcmV0cmlldmUgZnJvbS4KICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleU5hbWUgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIHJldHJpZXZlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBkZWZhdWx0VmFsdWUgVGhlIHZhbHVlIHRvIHJldHVybiBpZiB0aGUgcHJvcGVydHkgdmFsdWUgaXMgdW5kZWZpbmVkCiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIHByb3BlcnR5IHZhbHVlIG9yIHRoZSBkZWZhdWx0VmFsdWUuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBnZXRXaXRoRGVmYXVsdChyb290LCBrZXksIGRlZmF1bHRWYWx1ZSkgewogICAgICAgIHZhciB2YWx1ZSA9IF9nZXQocm9vdCwga2V5KTsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgdmFyIEVNUFRZX0FSUkFZID0gT2JqZWN0LmZyZWV6ZShbXSk7CiAgICBmdW5jdGlvbiBvYmplY3RBdChhcnJheSwgaW5kZXgpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcnJheSkpIHsKICAgICAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYXJyYXkub2JqZWN0QXQoaW5kZXgpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlcGxhY2UoYXJyYXksIHN0YXJ0LCBkZWxldGVDb3VudCkgewogICAgICAgIHZhciBpdGVtcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzNdIDogRU1QVFlfQVJSQVk7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFycmF5KSkgewogICAgICAgICAgICByZXBsYWNlSW5OYXRpdmVBcnJheShhcnJheSwgc3RhcnQsIGRlbGV0ZUNvdW50LCBpdGVtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyYXkucmVwbGFjZShzdGFydCwgZGVsZXRlQ291bnQsIGl0ZW1zKTsKICAgICAgICB9CiAgICB9CiAgICB2YXIgQ0hVTktfU0laRSA9IDYwMDAwOwogICAgLy8gVG8gYXZvaWQgb3ZlcmZsb3dpbmcgdGhlIHN0YWNrLCB3ZSBzcGxpY2UgdXAgdG8gQ0hVTktfU0laRSBpdGVtcyBhdCBhIHRpbWUuCiAgICAvLyBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTU2NTg4IGZvciBtb3JlIGRldGFpbHMuCiAgICBmdW5jdGlvbiByZXBsYWNlSW5OYXRpdmVBcnJheShhcnJheSwgc3RhcnQsIGRlbGV0ZUNvdW50LCBpdGVtcykgewogICAgICAgIGFycmF5Q29udGVudFdpbGxDaGFuZ2UoYXJyYXksIHN0YXJ0LCBkZWxldGVDb3VudCwgaXRlbXMubGVuZ3RoKTsKICAgICAgICBpZiAoaXRlbXMubGVuZ3RoIDw9IENIVU5LX1NJWkUpIHsKICAgICAgICAgICAgYXJyYXkuc3BsaWNlLmFwcGx5KGFycmF5LCBbc3RhcnQsIGRlbGV0ZUNvdW50XS5jb25jYXQoaXRlbXMpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhcnJheS5zcGxpY2Uoc3RhcnQsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkgKz0gQ0hVTktfU0laRSkgewogICAgICAgICAgICAgICAgdmFyIGNodW5rID0gaXRlbXMuc2xpY2UoaSwgaSArIENIVU5LX1NJWkUpOwogICAgICAgICAgICAgICAgYXJyYXkuc3BsaWNlLmFwcGx5KGFycmF5LCBbc3RhcnQgKyBpLCAwXS5jb25jYXQoY2h1bmspKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhcnJheUNvbnRlbnREaWRDaGFuZ2UoYXJyYXksIHN0YXJ0LCBkZWxldGVDb3VudCwgaXRlbXMubGVuZ3RoKTsKICAgIH0KICAgIGZ1bmN0aW9uIGFycmF5T2JzZXJ2ZXJzSGVscGVyKG9iaiwgdGFyZ2V0LCBvcHRzLCBvcGVyYXRpb24sIG5vdGlmeSkgewogICAgICAgIHZhciB3aWxsQ2hhbmdlID0gb3B0cyAmJiBvcHRzLndpbGxDaGFuZ2UgfHwgJ2FycmF5V2lsbENoYW5nZSc7CiAgICAgICAgdmFyIGRpZENoYW5nZSA9IG9wdHMgJiYgb3B0cy5kaWRDaGFuZ2UgfHwgJ2FycmF5RGlkQ2hhbmdlJzsKICAgICAgICB2YXIgaGFzT2JzZXJ2ZXJzID0gX2dldChvYmosICdoYXNBcnJheU9ic2VydmVycycpOwogICAgICAgIG9wZXJhdGlvbihvYmosICdAYXJyYXk6YmVmb3JlJywgdGFyZ2V0LCB3aWxsQ2hhbmdlKTsKICAgICAgICBvcGVyYXRpb24ob2JqLCAnQGFycmF5OmNoYW5nZScsIHRhcmdldCwgZGlkQ2hhbmdlKTsKICAgICAgICBpZiAoaGFzT2JzZXJ2ZXJzID09PSBub3RpZnkpIHsKICAgICAgICAgICAgbm90aWZ5UHJvcGVydHlDaGFuZ2Uob2JqLCAnaGFzQXJyYXlPYnNlcnZlcnMnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZEFycmF5T2JzZXJ2ZXIoYXJyYXksIHRhcmdldCwgb3B0cykgewogICAgICAgIHJldHVybiBhcnJheU9ic2VydmVyc0hlbHBlcihhcnJheSwgdGFyZ2V0LCBvcHRzLCBhZGRMaXN0ZW5lciwgZmFsc2UpOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlQXJyYXlPYnNlcnZlcihhcnJheSwgdGFyZ2V0LCBvcHRzKSB7CiAgICAgICAgcmV0dXJuIGFycmF5T2JzZXJ2ZXJzSGVscGVyKGFycmF5LCB0YXJnZXQsIG9wdHMsIHJlbW92ZUxpc3RlbmVyLCB0cnVlKTsKICAgIH0KCiAgICAvKioKICAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICAgKi8KICAgIC8qKgogICAgICBAbWV0aG9kIGFkZE9ic2VydmVyCiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0L29ic2VydmVycwogICAgICBAcGFyYW0gb2JqCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICAgIEBwYXJhbSB7T2JqZWN0fEZ1bmN0aW9ufSB0YXJnZXQKICAgICAgQHBhcmFtIHtGdW5jdGlvbnxTdHJpbmd9IFttZXRob2RdCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBhZGRPYnNlcnZlcihvYmosIHBhdGgsIHRhcmdldCwgbWV0aG9kKSB7CiAgICAgICAgYWRkTGlzdGVuZXIob2JqLCBjaGFuZ2VFdmVudChwYXRoKSwgdGFyZ2V0LCBtZXRob2QpOwogICAgICAgIHdhdGNoKG9iaiwgcGF0aCk7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCByZW1vdmVPYnNlcnZlcgogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9vYnNlcnZlcnMKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAgICBAcGFyYW0ge09iamVjdHxGdW5jdGlvbn0gdGFyZ2V0CiAgICAgIEBwYXJhbSB7RnVuY3Rpb258U3RyaW5nfSBbbWV0aG9kXQogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlT2JzZXJ2ZXIob2JqLCBwYXRoLCB0YXJnZXQsIG1ldGhvZCkgewogICAgICAgIHVud2F0Y2gob2JqLCBwYXRoKTsKICAgICAgICByZW1vdmVMaXN0ZW5lcihvYmosIGNoYW5nZUV2ZW50KHBhdGgpLCB0YXJnZXQsIG1ldGhvZCk7CiAgICB9CgogICAgZnVuY3Rpb24gZWFjaFByb3h5Rm9yKGFycmF5KSB7CiAgICAgICAgdmFyIGVhY2hQcm94eSA9IEVBQ0hfUFJPWElFUy5nZXQoYXJyYXkpOwogICAgICAgIGlmIChlYWNoUHJveHkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBlYWNoUHJveHkgPSBuZXcgRWFjaFByb3h5KGFycmF5KTsKICAgICAgICAgICAgRUFDSF9QUk9YSUVTLnNldChhcnJheSwgZWFjaFByb3h5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVhY2hQcm94eTsKICAgIH0KCiAgICB2YXIgRWFjaFByb3h5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEVhY2hQcm94eShjb250ZW50KSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgRWFjaFByb3h5KTsKCiAgICAgICAgICAgIHRoaXMuX2NvbnRlbnQgPSBjb250ZW50OwogICAgICAgICAgICB0aGlzLl9rZXlzID0gdW5kZWZpbmVkOwogICAgICAgICAgICAoMCwgX2VtYmVyTWV0YS5tZXRhKSh0aGlzKTsKICAgICAgICB9CiAgICAgICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgICAgIC8vIEFSUkFZIENIQU5HRVMKICAgICAgICAvLyBJbnZva2VzIHdoZW5ldmVyIHRoZSBjb250ZW50IGFycmF5IGl0c2VsZiBjaGFuZ2VzLgoKCiAgICAgICAgRWFjaFByb3h5LnByb3RvdHlwZS5hcnJheVdpbGxDaGFuZ2UgPSBmdW5jdGlvbiBhcnJheVdpbGxDaGFuZ2UoY29udGVudCwgaWR4LCByZW1vdmVkQ250IC8qLCBhZGRlZENudCAqLykgewogICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgICAgICAgIHZhciBrZXlzID0gdGhpcy5fa2V5czsKICAgICAgICAgICAgaWYgKCFrZXlzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxpbSA9IHJlbW92ZWRDbnQgPiAwID8gaWR4ICsgcmVtb3ZlZENudCA6IC0xOwogICAgICAgICAgICBpZiAobGltID4gMCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGtleXMpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVPYnNlcnZlckZvckNvbnRlbnRLZXkoY29udGVudCwga2V5LCB0aGlzLCBpZHgsIGxpbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBFYWNoUHJveHkucHJvdG90eXBlLmFycmF5RGlkQ2hhbmdlID0gZnVuY3Rpb24gYXJyYXlEaWRDaGFuZ2UoY29udGVudCwgaWR4LCBfcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgICAgICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwogICAgICAgICAgICBpZiAoIWtleXMpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGltID0gYWRkZWRDbnQgPiAwID8gaWR4ICsgYWRkZWRDbnQgOiAtMTsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkodGhpcyk7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSB7CiAgICAgICAgICAgICAgICBpZiAobGltID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXksIHRoaXMsIGlkeCwgbGltKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vdGlmeVByb3BlcnR5Q2hhbmdlKHRoaXMsIGtleSwgbWV0YSQkMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBFYWNoUHJveHkucHJvdG90eXBlLndpbGxXYXRjaFByb3BlcnR5ID0gZnVuY3Rpb24gd2lsbFdhdGNoUHJvcGVydHkocHJvcGVydHkpIHsKICAgICAgICAgICAgdGhpcy5iZWdpbk9ic2VydmluZ0NvbnRlbnRLZXkocHJvcGVydHkpOwogICAgICAgIH07CgogICAgICAgIEVhY2hQcm94eS5wcm90b3R5cGUuZGlkVW53YXRjaFByb3BlcnR5ID0gZnVuY3Rpb24gZGlkVW53YXRjaFByb3BlcnR5KHByb3BlcnR5KSB7CiAgICAgICAgICAgIHRoaXMuc3RvcE9ic2VydmluZ0NvbnRlbnRLZXkocHJvcGVydHkpOwogICAgICAgIH07CgogICAgICAgIEVhY2hQcm94eS5wcm90b3R5cGUuYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5ID0gZnVuY3Rpb24gYmVnaW5PYnNlcnZpbmdDb250ZW50S2V5KGtleU5hbWUpIHsKICAgICAgICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwogICAgICAgICAgICBpZiAoa2V5cyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBrZXlzID0gdGhpcy5fa2V5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFrZXlzW2tleU5hbWVdKSB7CiAgICAgICAgICAgICAgICBrZXlzW2tleU5hbWVdID0gMTsKICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gdGhpcy5fY29udGVudDsKICAgICAgICAgICAgICAgIHZhciBsZW4gPSBjb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXlOYW1lLCB0aGlzLCAwLCBsZW4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAga2V5c1trZXlOYW1lXSsrOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgRWFjaFByb3h5LnByb3RvdHlwZS5zdG9wT2JzZXJ2aW5nQ29udGVudEtleSA9IGZ1bmN0aW9uIHN0b3BPYnNlcnZpbmdDb250ZW50S2V5KGtleU5hbWUpIHsKICAgICAgICAgICAgdmFyIGtleXMgPSB0aGlzLl9rZXlzOwogICAgICAgICAgICBpZiAoa2V5cyAhPT0gdW5kZWZpbmVkICYmIGtleXNba2V5TmFtZV0gPiAwICYmIC0ta2V5c1trZXlOYW1lXSA8PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHRoaXMuX2NvbnRlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbGVuID0gY29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgICByZW1vdmVPYnNlcnZlckZvckNvbnRlbnRLZXkoY29udGVudCwga2V5TmFtZSwgdGhpcywgMCwgbGVuKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEVhY2hQcm94eS5wcm90b3R5cGUuY29udGVudEtleURpZENoYW5nZSA9IGZ1bmN0aW9uIGNvbnRlbnRLZXlEaWRDaGFuZ2UoX29iaiwga2V5TmFtZSkgewogICAgICAgICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZSh0aGlzLCBrZXlOYW1lKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gRWFjaFByb3h5OwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGFkZE9ic2VydmVyRm9yQ29udGVudEtleShjb250ZW50LCBrZXlOYW1lLCBwcm94eSwgaWR4LCBsb2MpIHsKICAgICAgICB3aGlsZSAoLS1sb2MgPj0gaWR4KSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gb2JqZWN0QXQoY29udGVudCwgbG9jKTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgICh0cnVlICYmICEodHlwZW9mIGl0ZW0gPT09ICdvYmplY3QnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1doZW4gdXNpbmcgQGVhY2ggdG8gb2JzZXJ2ZSB0aGUgYXJyYXkgYCcgKyBjb250ZW50LnRvU3RyaW5nKCkgKyAnYCwgdGhlIGFycmF5IG11c3QgcmV0dXJuIGFuIG9iamVjdCcsIHR5cGVvZiBpdGVtID09PSAnb2JqZWN0JykpOwoKICAgICAgICAgICAgICAgIGFkZE9ic2VydmVyKGl0ZW0sIGtleU5hbWUsIHByb3h5LCAnY29udGVudEtleURpZENoYW5nZScpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlT2JzZXJ2ZXJGb3JDb250ZW50S2V5KGNvbnRlbnQsIGtleU5hbWUsIHByb3h5LCBpZHgsIGxvYykgewogICAgICAgIHdoaWxlICgtLWxvYyA+PSBpZHgpIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBvYmplY3RBdChjb250ZW50LCBsb2MpOwogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgcmVtb3ZlT2JzZXJ2ZXIoaXRlbSwga2V5TmFtZSwgcHJveHksICdjb250ZW50S2V5RGlkQ2hhbmdlJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbDsKICAgIH0KICAgIGZ1bmN0aW9uIGlzVm9sYXRpbGUob2JqLCBrZXlOYW1lLCBtZXRhJCQxKSB7CiAgICAgICAgdmFyIGRlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgIHJldHVybiAhKGRlc2MgIT09IHVuZGVmaW5lZCAmJiBkZXNjLl92b2xhdGlsZSA9PT0gZmFsc2UpOwogICAgfQoKICAgIHZhciBDaGFpbldhdGNoZXJzID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENoYWluV2F0Y2hlcnMoKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ2hhaW5XYXRjaGVycyk7CgogICAgICAgICAgICAvLyBjaGFpbiBub2RlcyB0aGF0IHJlZmVyZW5jZSBhIGtleSBpbiB0aGlzIG9iaiBieSBrZXkKICAgICAgICAgICAgLy8gd2Ugb25seSBjcmVhdGUgQ2hhaW5XYXRjaGVycyB3aGVuIHdlIGFyZSBnb2luZyB0byBhZGQgdGhlbQogICAgICAgICAgICAvLyBzbyBjcmVhdGUgdGhpcyB1cGZyb250CiAgICAgICAgICAgIHRoaXMuY2hhaW5zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB9CgogICAgICAgIENoYWluV2F0Y2hlcnMucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChrZXksIG5vZGUpIHsKICAgICAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5jaGFpbnNba2V5XTsKICAgICAgICAgICAgaWYgKG5vZGVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hhaW5zW2tleV0gPSBbbm9kZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ2hhaW5XYXRjaGVycy5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gcmVtb3ZlKGtleSwgbm9kZSkgewogICAgICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLmNoYWluc1trZXldOwogICAgICAgICAgICBpZiAobm9kZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChub2Rlc1tpXSA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENoYWluV2F0Y2hlcnMucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhrZXksIG5vZGUpIHsKICAgICAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5jaGFpbnNba2V5XTsKICAgICAgICAgICAgaWYgKG5vZGVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZXNbaV0gPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICBDaGFpbldhdGNoZXJzLnByb3RvdHlwZS5yZXZhbGlkYXRlQWxsID0gZnVuY3Rpb24gcmV2YWxpZGF0ZUFsbCgpIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY2hhaW5zKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeShrZXksIHRydWUsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBDaGFpbldhdGNoZXJzLnByb3RvdHlwZS5yZXZhbGlkYXRlID0gZnVuY3Rpb24gcmV2YWxpZGF0ZShrZXkpIHsKICAgICAgICAgICAgdGhpcy5ub3RpZnkoa2V5LCB0cnVlLCB1bmRlZmluZWQpOwogICAgICAgIH07CgogICAgICAgIENoYWluV2F0Y2hlcnMucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIG5vdGlmeShrZXksIHJldmFsaWRhdGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBub2RlcyA9IHRoaXMuY2hhaW5zW2tleV07CiAgICAgICAgICAgIGlmIChub2RlcyA9PT0gdW5kZWZpbmVkIHx8IG5vZGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhZmZlY3RlZCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBhZmZlY3RlZCA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIG5vZGVzW2ldLm5vdGlmeShyZXZhbGlkYXRlLCBhZmZlY3RlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3ZSBnYXRoZXIgY2FsbGJhY2tzIHNvIHdlIGRvbid0IG5vdGlmeSB0aGVtIGR1cmluZyByZXZhbGlkYXRpb24KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFmZmVjdGVkLmxlbmd0aDsgX2kgKz0gMikgewogICAgICAgICAgICAgICAgdmFyIG9iaiA9IGFmZmVjdGVkW19pXTsKICAgICAgICAgICAgICAgIHZhciBwYXRoID0gYWZmZWN0ZWRbX2kgKyAxXTsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKG9iaiwgcGF0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ2hhaW5XYXRjaGVyczsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBtYWtlQ2hhaW5XYXRjaGVyKCkgewogICAgICAgIHJldHVybiBuZXcgQ2hhaW5XYXRjaGVycygpOwogICAgfQogICAgZnVuY3Rpb24gbWFrZUNoYWluTm9kZShvYmopIHsKICAgICAgICByZXR1cm4gbmV3IENoYWluTm9kZShudWxsLCBudWxsLCBvYmopOwogICAgfQogICAgZnVuY3Rpb24gYWRkQ2hhaW5XYXRjaGVyKG9iaiwga2V5TmFtZSwgbm9kZSkgewogICAgICAgIHZhciBtID0gKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKTsKICAgICAgICBtLndyaXRhYmxlQ2hhaW5XYXRjaGVycyhtYWtlQ2hhaW5XYXRjaGVyKS5hZGQoa2V5TmFtZSwgbm9kZSk7CiAgICAgICAgd2F0Y2hLZXkob2JqLCBrZXlOYW1lLCBtKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZUNoYWluV2F0Y2hlcihvYmosIGtleU5hbWUsIG5vZGUsIF9tZXRhKSB7CiAgICAgICAgaWYgKCFpc09iamVjdChvYmopKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG1ldGEkJDEgPSBfbWV0YSA9PT0gdW5kZWZpbmVkID8gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKG9iaikgOiBfbWV0YTsKICAgICAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkIHx8IG1ldGEkJDEuaXNTb3VyY2VEZXN0cm95aW5nKCkgfHwgbWV0YSQkMS5pc01ldGFEZXN0cm95ZWQoKSB8fCBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvLyBtYWtlIG1ldGEgd3JpdGFibGUKICAgICAgICBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKTsKICAgICAgICBtZXRhJCQxLnJlYWRhYmxlQ2hhaW5XYXRjaGVycygpLnJlbW92ZShrZXlOYW1lLCBub2RlKTsKICAgICAgICB1bndhdGNoS2V5KG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICB9CiAgICB2YXIgTk9ERV9TVEFDSyA9IFtdOwogICAgZnVuY3Rpb24gZGVzdHJveVJvb3Qocm9vdCkgewogICAgICAgIHB1c2hDaGlsZHJlbihyb290KTsKICAgICAgICB3aGlsZSAoTk9ERV9TVEFDSy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gTk9ERV9TVEFDSy5wb3AoKTsKICAgICAgICAgICAgcHVzaENoaWxkcmVuKG5vZGUpOwogICAgICAgICAgICBkZXN0cm95T25lKG5vZGUpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRlc3Ryb3lPbmUobm9kZSkgewogICAgICAgIGlmIChub2RlLmlzV2F0Y2hpbmcpIHsKICAgICAgICAgICAgcmVtb3ZlQ2hhaW5XYXRjaGVyKG5vZGUub2JqZWN0LCBub2RlLmtleSwgbm9kZSk7CiAgICAgICAgICAgIG5vZGUuaXNXYXRjaGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHB1c2hDaGlsZHJlbihub2RlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gbm9kZS5jaGFpbnM7CiAgICAgICAgaWYgKG5vZGVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5vZGVzKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZXNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgTk9ERV9TVEFDSy5wdXNoKG5vZGVzW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgLy8gQSBDaGFpbk5vZGUgd2F0Y2hlcyBhIHNpbmdsZSBrZXkgb24gYW4gb2JqZWN0LiBJZiB5b3UgcHJvdmlkZSBhIHN0YXJ0aW5nCiAgICAvLyB2YWx1ZSBmb3IgdGhlIGtleSB0aGVuIHRoZSBub2RlIHdvbid0IGFjdHVhbGx5IHdhdGNoIGl0LiBGb3IgYSByb290IG5vZGUKICAgIC8vIHBhc3MgbnVsbCBmb3IgcGFyZW50IGFuZCBrZXkgYW5kIG9iamVjdCBmb3IgdmFsdWUuCgogICAgdmFyIENoYWluTm9kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBDaGFpbk5vZGUocGFyZW50LCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ2hhaW5Ob2RlKTsKCiAgICAgICAgICAgIHRoaXMucGF0aHMgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuaXNXYXRjaGluZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNoYWlucyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5vYmplY3QgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuY291bnQgPSAwOwogICAgICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICAgIHRoaXMuY29udGVudCA9IHZhbHVlOwogICAgICAgICAgICAvLyBJdCBpcyBmYWxzZSBmb3IgdGhlIHJvb3Qgb2YgYSBjaGFpbiAoYmVjYXVzZSB3ZSBoYXZlIG5vIHBhcmVudCkKICAgICAgICAgICAgdmFyIGlzV2F0Y2hpbmcgPSBwYXJlbnQgIT09IG51bGw7CiAgICAgICAgICAgIHZhciBvYmplY3QgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc1dhdGNoaW5nKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VmFsdWUgPSBwYXJlbnQudmFsdWUoKTsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChwYXJlbnRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBvYmplY3QgPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzV2F0Y2hpbmcgPSBpc1dhdGNoaW5nOwogICAgICAgICAgICB0aGlzLm9iamVjdCA9IG9iamVjdDsKICAgICAgICAgICAgaWYgKGlzV2F0Y2hpbmcgJiYgb2JqZWN0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGFkZENoYWluV2F0Y2hlcihvYmplY3QsIGtleSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIENoYWluTm9kZS5wcm90b3R5cGUudmFsdWUgPSBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udGVudCA9PT0gdW5kZWZpbmVkICYmIHRoaXMuaXNXYXRjaGluZykgewogICAgICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMucGFyZW50LnZhbHVlKCk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnQgPSBsYXp5R2V0KG9iaiwgdGhpcy5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgQ2hhaW5Ob2RlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgLy8gY2hlY2sgaWYgcm9vdAogICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3lSb290KHRoaXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVzdHJveU9uZSh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENoYWluTm9kZS5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkob2JqKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBtYWtlQ2hhaW5Ob2RlKG9iaik7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHRoaXMucGF0aHM7CiAgICAgICAgICAgIGlmIChwYXRocyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcGF0aCA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGZvciAocGF0aCBpbiBwYXRocykgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXRoc1twYXRoXSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0LmFkZChwYXRoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwoKICAgICAgICBDaGFpbk5vZGUucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChwYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHRoaXMucGF0aHMgfHwgKHRoaXMucGF0aHMgPSB7fSk7CiAgICAgICAgICAgIHBhdGhzW3BhdGhdID0gKHBhdGhzW3BhdGhdIHx8IDApICsgMTsKICAgICAgICAgICAgdmFyIHRhaWxzID0gcGF0aC5zcGxpdCgnLicpOwogICAgICAgICAgICB0aGlzLmNoYWluKHRhaWxzLnNoaWZ0KCksIHRhaWxzKTsKICAgICAgICB9OwoKICAgICAgICBDaGFpbk5vZGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIHJlbW92ZShwYXRoKSB7CiAgICAgICAgICAgIHZhciBwYXRocyA9IHRoaXMucGF0aHM7CiAgICAgICAgICAgIGlmIChwYXRocyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhdGhzW3BhdGhdID4gMCkgewogICAgICAgICAgICAgICAgcGF0aHNbcGF0aF0tLTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGFpbHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgICAgIHRoaXMudW5jaGFpbih0YWlscy5zaGlmdCgpLCB0YWlscyk7CiAgICAgICAgfTsKCiAgICAgICAgQ2hhaW5Ob2RlLnByb3RvdHlwZS5jaGFpbiA9IGZ1bmN0aW9uIGNoYWluKGtleSwgdGFpbHMpIHsKICAgICAgICAgICAgdmFyIGNoYWlucyA9IHZvaWQgMDsKICAgICAgICAgICAgaWYgKHRoaXMuY2hhaW5zID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNoYWlucyA9IHRoaXMuY2hhaW5zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNoYWlucyA9IHRoaXMuY2hhaW5zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gY2hhaW5zW2tleV07CiAgICAgICAgICAgIGlmIChub2RlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIG5vZGUgPSBjaGFpbnNba2V5XSA9IG5ldyBDaGFpbk5vZGUodGhpcywga2V5LCB1bmRlZmluZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuY291bnQrKzsgLy8gY291bnQgY2hhaW5zLi4uCiAgICAgICAgICAgIC8vIGNoYWluIHJlc3Qgb2YgcGF0aCBpZiB0aGVyZSBpcyBvbmUKICAgICAgICAgICAgaWYgKHRhaWxzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hhaW4odGFpbHMuc2hpZnQoKSwgdGFpbHMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ2hhaW5Ob2RlLnByb3RvdHlwZS51bmNoYWluID0gZnVuY3Rpb24gdW5jaGFpbihrZXksIHRhaWxzKSB7CiAgICAgICAgICAgIHZhciBjaGFpbnMgPSB0aGlzLmNoYWluczsKICAgICAgICAgICAgdmFyIG5vZGUgPSBjaGFpbnNba2V5XTsKICAgICAgICAgICAgLy8gdW5jaGFpbiByZXN0IG9mIHBhdGggZmlyc3QuLi4KICAgICAgICAgICAgaWYgKHRhaWxzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIG5vZGUudW5jaGFpbih0YWlscy5zaGlmdCgpLCB0YWlscyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZGVsZXRlIG5vZGUgaWYgbmVlZGVkLgogICAgICAgICAgICBub2RlLmNvdW50LS07CiAgICAgICAgICAgIGlmIChub2RlLmNvdW50IDw9IDApIHsKICAgICAgICAgICAgICAgIGNoYWluc1tub2RlLmtleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBub2RlLmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENoYWluTm9kZS5wcm90b3R5cGUubm90aWZ5ID0gZnVuY3Rpb24gbm90aWZ5KHJldmFsaWRhdGUsIGFmZmVjdGVkKSB7CiAgICAgICAgICAgIGlmIChyZXZhbGlkYXRlICYmIHRoaXMuaXNXYXRjaGluZykgewogICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gdGhpcy5wYXJlbnQudmFsdWUoKTsKICAgICAgICAgICAgICAgIGlmIChwYXJlbnRWYWx1ZSAhPT0gdGhpcy5vYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGFpbldhdGNoZXIodGhpcy5vYmplY3QsIHRoaXMua2V5LCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QocGFyZW50VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2JqZWN0ID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZENoYWluV2F0Y2hlcihwYXJlbnRWYWx1ZSwgdGhpcy5rZXksIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2JqZWN0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY29udGVudCA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB0aGVuIG5vdGlmeSBjaGFpbnMuLi4KICAgICAgICAgICAgdmFyIGNoYWlucyA9IHRoaXMuY2hhaW5zOwogICAgICAgICAgICBpZiAoY2hhaW5zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gdm9pZCAwOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGNoYWlucykgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBjaGFpbnNba2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubm90aWZ5KHJldmFsaWRhdGUsIGFmZmVjdGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFmZmVjdGVkICYmIHRoaXMucGFyZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC5wb3B1bGF0ZUFmZmVjdGVkKHRoaXMua2V5LCAxLCBhZmZlY3RlZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBDaGFpbk5vZGUucHJvdG90eXBlLnBvcHVsYXRlQWZmZWN0ZWQgPSBmdW5jdGlvbiBwb3B1bGF0ZUFmZmVjdGVkKHBhdGgsIGRlcHRoLCBhZmZlY3RlZCkgewogICAgICAgICAgICBpZiAodGhpcy5rZXkpIHsKICAgICAgICAgICAgICAgIHBhdGggPSB0aGlzLmtleSArICcuJyArIHBhdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcmVudC5wb3B1bGF0ZUFmZmVjdGVkKHBhdGgsIGRlcHRoICsgMSwgYWZmZWN0ZWQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRlcHRoID4gMSkgewogICAgICAgICAgICAgICAgYWZmZWN0ZWQucHVzaCh0aGlzLnZhbHVlKCksIHBhdGgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENoYWluTm9kZTsKICAgIH0oKTsKCiAgICBmdW5jdGlvbiBsYXp5R2V0KG9iaiwga2V5KSB7CiAgICAgICAgaWYgKCFpc09iamVjdChvYmopKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkob2JqKTsKICAgICAgICAvLyBjaGVjayBpZiBvYmplY3QgbWVhbnQgb25seSB0byBiZSBhIHByb3RvdHlwZQogICAgICAgIGlmIChtZXRhJCQxICE9PSB1bmRlZmluZWQgJiYgbWV0YSQkMS5wcm90byA9PT0gb2JqKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gVXNlIGBnZXRgIGlmIHRoZSByZXR1cm4gdmFsdWUgaXMgYW4gRWFjaFByb3h5IG9yIGFuIHVuY2FjaGVhYmxlIHZhbHVlLgogICAgICAgIGlmIChrZXkgPT09ICdAZWFjaCcpIHsKICAgICAgICAgICAgcmV0dXJuIGVhY2hQcm94eUZvcihvYmopOwogICAgICAgIH0gZWxzZSBpZiAoaXNWb2xhdGlsZShvYmosIGtleSwgbWV0YSQkMSkpIHsKICAgICAgICAgICAgcmV0dXJuIF9nZXQob2JqLCBrZXkpOwogICAgICAgICAgICAvLyBPdGhlcndpc2UgYXR0ZW1wdCB0byBnZXQgdGhlIGNhY2hlZCB2YWx1ZSBvZiB0aGUgY29tcHV0ZWQgcHJvcGVydHkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0Q2FjaGVkVmFsdWVGb3Iob2JqLCBrZXkpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGZpbmlzaENoYWlucyhtZXRhJCQxKSB7CiAgICAgICAgLy8gZmluaXNoIGFueSBjdXJyZW50IGNoYWlucyBub2RlIHdhdGNoZXJzIHRoYXQgcmVmZXJlbmNlIG9iagogICAgICAgIHZhciBjaGFpbldhdGNoZXJzID0gbWV0YSQkMS5yZWFkYWJsZUNoYWluV2F0Y2hlcnMoKTsKICAgICAgICBpZiAoY2hhaW5XYXRjaGVycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNoYWluV2F0Y2hlcnMucmV2YWxpZGF0ZUFsbCgpOwogICAgICAgIH0KICAgICAgICAvLyBlbnN1cmUgdGhhdCBpZiB3ZSBoYXZlIGluaGVyaXRlZCBhbnkgY2hhaW5zIHRoZXkgaGF2ZSBiZWVuCiAgICAgICAgLy8gY29waWVkIG9udG8gb3VyIG93biBtZXRhLgogICAgICAgIGlmIChtZXRhJCQxLnJlYWRhYmxlQ2hhaW5zKCkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBtZXRhJCQxLndyaXRhYmxlQ2hhaW5zKG1ha2VDaGFpbk5vZGUpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB3YXRjaFBhdGgob2JqLCBrZXlQYXRoLCBtZXRhJCQxKSB7CiAgICAgICAgdmFyIG0gPSBtZXRhJCQxID09PSB1bmRlZmluZWQgPyAoMCwgX2VtYmVyTWV0YS5tZXRhKShvYmopIDogbWV0YSQkMTsKICAgICAgICB2YXIgY291bnRlciA9IG0ucGVla1dhdGNoaW5nKGtleVBhdGgpOwogICAgICAgIG0ud3JpdGVXYXRjaGluZyhrZXlQYXRoLCBjb3VudGVyICsgMSk7CiAgICAgICAgaWYgKGNvdW50ZXIgPT09IDApIHsKICAgICAgICAgICAgLy8gYWN0aXZhdGUgd2F0Y2hpbmcgZmlyc3QgdGltZQogICAgICAgICAgICBtLndyaXRhYmxlQ2hhaW5zKG1ha2VDaGFpbk5vZGUpLmFkZChrZXlQYXRoKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiB1bndhdGNoUGF0aChvYmosIGtleVBhdGgsIG1ldGEkJDEpIHsKICAgICAgICB2YXIgbSA9IG1ldGEkJDEgPT09IHVuZGVmaW5lZCA/ICgwLCBfZW1iZXJNZXRhLnBlZWtNZXRhKShvYmopIDogbWV0YSQkMTsKICAgICAgICBpZiAobSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGNvdW50ZXIgPSBtLnBlZWtXYXRjaGluZyhrZXlQYXRoKTsKICAgICAgICBpZiAoY291bnRlciA+IDApIHsKICAgICAgICAgICAgbS53cml0ZVdhdGNoaW5nKGtleVBhdGgsIGNvdW50ZXIgLSAxKTsKICAgICAgICAgICAgaWYgKGNvdW50ZXIgPT09IDEpIHsKICAgICAgICAgICAgICAgIG0ud3JpdGFibGVDaGFpbnMobWFrZUNoYWluTm9kZSkucmVtb3ZlKGtleVBhdGgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBTdGFydHMgd2F0Y2hpbmcgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIFdoZW5ldmVyIHRoZSBwcm9wZXJ0eSBjaGFuZ2VzLAogICAgICBpbnZva2VzIGBFbWJlci5ub3RpZnlQcm9wZXJ0eUNoYW5nZWAuIFRoaXMgaXMgdGhlIHByaW1pdGl2ZSB1c2VkIGJ5IG9ic2VydmVycwogICAgICBhbmQgZGVwZW5kZW50IGtleXM7IHVzdWFsbHkgeW91IHdpbGwgbmV2ZXIgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBidXQgaW5zdGVhZAogICAgICB1c2UgaGlnaGVyIGxldmVsIG1ldGhvZHMgbGlrZSBgYWRkT2JzZXJ2ZXIoKWAuCiAgICAKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3YXRjaAogICAgICBAZm9yIEVtYmVyCiAgICAgIEBwYXJhbSBvYmoKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleVBhdGgKICAgICAgQHBhcmFtIHtPYmplY3R9IG1ldGEKICAgICovCiAgICBmdW5jdGlvbiB3YXRjaChvYmosIGtleVBhdGgsIG1ldGEkJDEpIHsKICAgICAgICBpZiAoaXNQYXRoKGtleVBhdGgpKSB7CiAgICAgICAgICAgIHdhdGNoUGF0aChvYmosIGtleVBhdGgsIG1ldGEkJDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhdGNoS2V5KG9iaiwga2V5UGF0aCwgbWV0YSQkMSk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNXYXRjaGluZyhvYmosIGtleSkgewogICAgICAgIHJldHVybiB3YXRjaGVyQ291bnQob2JqLCBrZXkpID4gMDsKICAgIH0KICAgIGZ1bmN0aW9uIHdhdGNoZXJDb3VudChvYmosIGtleSkgewogICAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKG9iaik7CiAgICAgICAgcmV0dXJuIG1ldGEkJDEgIT09IHVuZGVmaW5lZCAmJiBtZXRhJCQxLnBlZWtXYXRjaGluZyhrZXkpIHx8IDA7CiAgICB9CiAgICAvKioKICAgICAgU3RvcHMgd2F0Y2hpbmcgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIFVzdWFsbHkgeW91IHdpbGwgbmV2ZXIgY2FsbCB0aGlzIG1ldGhvZCBkaXJlY3RseSBidXQgaW5zdGVhZAogICAgICB1c2UgaGlnaGVyIGxldmVsIG1ldGhvZHMgbGlrZSBgcmVtb3ZlT2JzZXJ2ZXIoKWAuCiAgICAKICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB1bndhdGNoCiAgICAgIEBmb3IgRW1iZXIKICAgICAgQHBhcmFtIG9iagogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5UGF0aAogICAgICBAcGFyYW0ge09iamVjdH0gbWV0YQogICAgKi8KICAgIGZ1bmN0aW9uIHVud2F0Y2gob2JqLCBrZXlQYXRoLCBtZXRhJCQxKSB7CiAgICAgICAgaWYgKGlzUGF0aChrZXlQYXRoKSkgewogICAgICAgICAgICB1bndhdGNoUGF0aChvYmosIGtleVBhdGgsIG1ldGEkJDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVud2F0Y2hLZXkob2JqLCBrZXlQYXRoLCBtZXRhJCQxKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gREVQRU5ERU5UIEtFWVMKICAgIC8vCiAgICBmdW5jdGlvbiBhZGREZXBlbmRlbnRLZXlzKGRlc2MsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICAgIC8vIHRoZSBkZXNjcmlwdG9yIGhhcyBhIGxpc3Qgb2YgZGVwZW5kZW50IGtleXMsIHNvCiAgICAgICAgLy8gYWRkIGFsbCBvZiBpdHMgZGVwZW5kZW50IGtleXMuCiAgICAgICAgdmFyIGRlcEtleXMgPSBkZXNjLl9kZXBlbmRlbnRLZXlzOwogICAgICAgIGlmIChkZXBLZXlzID09PSBudWxsIHx8IGRlcEtleXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGRlcEtleXMubGVuZ3RoOyBpZHgrKykgewogICAgICAgICAgICB2YXIgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOwogICAgICAgICAgICAvLyBJbmNyZW1lbnQgdGhlIG51bWJlciBvZiB0aW1lcyBkZXBLZXkgZGVwZW5kcyBvbiBrZXlOYW1lLgogICAgICAgICAgICBtZXRhJCQxLndyaXRlRGVwcyhkZXBLZXksIGtleU5hbWUsIG1ldGEkJDEucGVla0RlcHMoZGVwS2V5LCBrZXlOYW1lKSArIDEpOwogICAgICAgICAgICAvLyBXYXRjaCB0aGUgZGVwS2V5CiAgICAgICAgICAgIHdhdGNoKG9iaiwgZGVwS2V5LCBtZXRhJCQxKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVEZXBlbmRlbnRLZXlzKGRlc2MsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICAgIC8vIHRoZSBkZXNjcmlwdG9yIGhhcyBhIGxpc3Qgb2YgZGVwZW5kZW50IGtleXMsIHNvCiAgICAgICAgLy8gcmVtb3ZlIGFsbCBvZiBpdHMgZGVwZW5kZW50IGtleXMuCiAgICAgICAgdmFyIGRlcEtleXMgPSBkZXNjLl9kZXBlbmRlbnRLZXlzOwogICAgICAgIGlmIChkZXBLZXlzID09PSBudWxsIHx8IGRlcEtleXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGlkeCA9IDA7IGlkeCA8IGRlcEtleXMubGVuZ3RoOyBpZHgrKykgewogICAgICAgICAgICB2YXIgZGVwS2V5ID0gZGVwS2V5c1tpZHhdOwogICAgICAgICAgICAvLyBEZWNyZW1lbnQgdGhlIG51bWJlciBvZiB0aW1lcyBkZXBLZXkgZGVwZW5kcyBvbiBrZXlOYW1lLgogICAgICAgICAgICBtZXRhJCQxLndyaXRlRGVwcyhkZXBLZXksIGtleU5hbWUsIG1ldGEkJDEucGVla0RlcHMoZGVwS2V5LCBrZXlOYW1lKSAtIDEpOwogICAgICAgICAgICAvLyBVbndhdGNoIHRoZSBkZXBLZXkKICAgICAgICAgICAgdW53YXRjaChvYmosIGRlcEtleSwgbWV0YSQkMSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgICAqLwogICAgdmFyIEVORF9XSVRIX0VBQ0hfUkVHRVggPSAvXC5AZWFjaCQvOwogICAgLyoqCiAgICAgIEV4cGFuZHMgYHBhdHRlcm5gLCBpbnZva2luZyBgY2FsbGJhY2tgIGZvciBlYWNoIGV4cGFuc2lvbi4KICAgIAogICAgICBUaGUgb25seSBwYXR0ZXJuIHN1cHBvcnRlZCBpcyBicmFjZS1leHBhbnNpb24sIGFueXRoaW5nIGVsc2Ugd2lsbCBiZSBwYXNzZWQKICAgICAgb25jZSB0byBgY2FsbGJhY2tgIGRpcmVjdGx5LgogICAgCiAgICAgIEV4YW1wbGUKICAgIAogICAgICBgYGBqcwogICAgICBpbXBvcnQgeyBleHBhbmRQcm9wZXJ0aWVzIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICAKICAgICAgZnVuY3Rpb24gZWNobyhhcmcpeyBjb25zb2xlLmxvZyhhcmcpOyB9CiAgICAKICAgICAgZXhwYW5kUHJvcGVydGllcygnZm9vLmJhcicsIGVjaG8pOyAgICAgICAgICAgICAgLy89PiAnZm9vLmJhcicKICAgICAgZXhwYW5kUHJvcGVydGllcygne2ZvbyxiYXJ9JywgZWNobyk7ICAgICAgICAgICAgLy89PiAnZm9vJywgJ2JhcicKICAgICAgZXhwYW5kUHJvcGVydGllcygnZm9vLntiYXIsYmF6fScsIGVjaG8pOyAgICAgICAgLy89PiAnZm9vLmJhcicsICdmb28uYmF6JwogICAgICBleHBhbmRQcm9wZXJ0aWVzKCd7Zm9vLGJhcn0uYmF6JywgZWNobyk7ICAgICAgICAvLz0+ICdmb28uYmF6JywgJ2Jhci5iYXonCiAgICAgIGV4cGFuZFByb3BlcnRpZXMoJ2Zvby57YmFyLGJhen0uW10nLCBlY2hvKSAgICAgIC8vPT4gJ2Zvby5iYXIuW10nLCAnZm9vLmJhei5bXScKICAgICAgZXhwYW5kUHJvcGVydGllcygne2ZvbyxiYXJ9LntzcGFtLGVnZ3N9JywgZWNobykgLy89PiAnZm9vLnNwYW0nLCAnZm9vLmVnZ3MnLCAnYmFyLnNwYW0nLCAnYmFyLmVnZ3MnCiAgICAgIGV4cGFuZFByb3BlcnRpZXMoJ3tmb299LmJhci57YmF6fScpICAgICAgICAgICAgIC8vPT4gJ2Zvby5iYXIuYmF6JwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGV4cGFuZFByb3BlcnRpZXMKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci9vYmplY3QvY29tcHV0ZWQKICAgICAgQHB1YmxpYwogICAgICBAcGFyYW0ge1N0cmluZ30gcGF0dGVybiBUaGUgcHJvcGVydHkgcGF0dGVybiB0byBleHBhbmQuCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBpbnZva2UuICBJdCBpcyBpbnZva2VkIG9uY2UgcGVyCiAgICAgIGV4cGFuc2lvbiwgYW5kIGlzIHBhc3NlZCB0aGUgZXhwYW5zaW9uLgogICAgKi8KICAgIGZ1bmN0aW9uIGV4cGFuZFByb3BlcnRpZXMocGF0dGVybiwgY2FsbGJhY2spIHsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBwYXR0ZXJuID09PSAnc3RyaW5nJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdBIGNvbXB1dGVkIHByb3BlcnR5IGtleSBtdXN0IGJlIGEgc3RyaW5nLCB5b3UgcGFzc2VkICcgKyB0eXBlb2YgcGF0dGVybiArICcgJyArIHBhdHRlcm4sIHR5cGVvZiBwYXR0ZXJuID09PSAnc3RyaW5nJykpOwogICAgICAgICh0cnVlICYmICEocGF0dGVybi5pbmRleE9mKCcgJykgPT09IC0xKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0JyYWNlIGV4cGFuZGVkIHByb3BlcnRpZXMgY2Fubm90IGNvbnRhaW4gc3BhY2VzLCBlLmcuICJ1c2VyLntmaXJzdE5hbWUsIGxhc3ROYW1lfSIgc2hvdWxkIGJlICJ1c2VyLntmaXJzdE5hbWUsbGFzdE5hbWV9IicsIHBhdHRlcm4uaW5kZXhPZignICcpID09PSAtMSkpOwogICAgICAgICh0cnVlICYmICEocGF0dGVybi5tYXRjaCgvXHtbXn17XSpce3xcfVtefXtdKlx9fFx7W159XSokL2cpID09PSBudWxsKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0JyYWNlIGV4cGFuZGVkIHByb3BlcnRpZXMgaGF2ZSB0byBiZSBiYWxhbmNlZCBhbmQgY2Fubm90IGJlIG5lc3RlZCwgcGF0dGVybjogJyArIHBhdHRlcm4sIHBhdHRlcm4ubWF0Y2goL1x7W159e10qXHt8XH1bXn17XSpcfXxce1tefV0qJC9nKSA9PT0gbnVsbCkpOwoKICAgICAgICB2YXIgc3RhcnQgPSBwYXR0ZXJuLmluZGV4T2YoJ3snKTsKICAgICAgICBpZiAoc3RhcnQgPCAwKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKHBhdHRlcm4ucmVwbGFjZShFTkRfV0lUSF9FQUNIX1JFR0VYLCAnLltdJykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpdmUoJycsIHBhdHRlcm4sIHN0YXJ0LCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZGl2ZShwcmVmaXgsIHBhdHRlcm4sIHN0YXJ0LCBjYWxsYmFjaykgewogICAgICAgIHZhciBlbmQgPSBwYXR0ZXJuLmluZGV4T2YoJ30nKSwKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIG5ld1N0YXJ0ID0gdm9pZCAwLAogICAgICAgICAgICBhcnJheUxlbmd0aCA9IHZvaWQgMDsKICAgICAgICB2YXIgdGVtcEFyciA9IHBhdHRlcm4uc3Vic3RyaW5nKHN0YXJ0ICsgMSwgZW5kKS5zcGxpdCgnLCcpOwogICAgICAgIHZhciBhZnRlciA9IHBhdHRlcm4uc3Vic3RyaW5nKGVuZCArIDEpOwogICAgICAgIHByZWZpeCA9IHByZWZpeCArIHBhdHRlcm4uc3Vic3RyaW5nKDAsIHN0YXJ0KTsKICAgICAgICBhcnJheUxlbmd0aCA9IHRlbXBBcnIubGVuZ3RoOwogICAgICAgIHdoaWxlIChpIDwgYXJyYXlMZW5ndGgpIHsKICAgICAgICAgICAgbmV3U3RhcnQgPSBhZnRlci5pbmRleE9mKCd7Jyk7CiAgICAgICAgICAgIGlmIChuZXdTdGFydCA8IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKChwcmVmaXggKyB0ZW1wQXJyW2krK10gKyBhZnRlcikucmVwbGFjZShFTkRfV0lUSF9FQUNIX1JFR0VYLCAnLltdJykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGl2ZShwcmVmaXggKyB0ZW1wQXJyW2krK10sIGFmdGVyLCBuZXdTdGFydCwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHZhciBzZXRXaXRoTWFuZGF0b3J5U2V0dGVyID0gdm9pZCAwOwogICAgdmFyIG1ha2VFbnVtZXJhYmxlID0gdm9pZCAwOwogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgICAqLwogICAgLyoqCiAgICAgIFNldHMgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LCByZXNwZWN0aW5nIGNvbXB1dGVkIHByb3BlcnRpZXMKICAgICAgYW5kIG5vdGlmeWluZyBvYnNlcnZlcnMgYW5kIG90aGVyIGxpc3RlbmVycyBvZiB0aGUgY2hhbmdlLgogICAgICBJZiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5IGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBvYmplY3QgYW5kIHRoZSBvYmplY3QKICAgICAgaW1wbGVtZW50cyB0aGUgYHNldFVua25vd25Qcm9wZXJ0eWAgbWV0aG9kLCB0aGVuIGluc3RlYWQgb2Ygc2V0dGluZyB0aGUKICAgICAgdmFsdWUgb2YgdGhlIHByb3BlcnR5IG9uIHRoZSBvYmplY3QsIGl0cyBgc2V0VW5rbm93blByb3BlcnR5YCBoYW5kbGVyCiAgICAgIHdpbGwgYmUgaW52b2tlZCB3aXRoIHRoZSB0d28gcGFyYW1ldGVycyBga2V5TmFtZWAgYW5kIGB2YWx1ZWAuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBzZXQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgc2V0KG9iaiwgIm5hbWUiLCB2YWx1ZSk7CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2Qgc2V0CiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBtb2RpZnkuCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSBrZXkgdG8gc2V0CiAgICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0CiAgICAgIEByZXR1cm4ge09iamVjdH0gdGhlIHBhc3NlZCB2YWx1ZS4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIF9zZXQyKG9iaiwga2V5TmFtZSwgdmFsdWUsIHRvbGVyYW50KSB7CiAgICAgICAgKHRydWUgJiYgIShhcmd1bWVudHMubGVuZ3RoID09PSAzIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnU2V0IG11c3QgYmUgY2FsbGVkIHdpdGggdGhyZWUgb3IgZm91ciBhcmd1bWVudHM7IGFuIG9iamVjdCwgYSBwcm9wZXJ0eSBrZXksIGEgdmFsdWUgYW5kIHRvbGVyYW50IHRydWUvZmFsc2UnLCBhcmd1bWVudHMubGVuZ3RoID09PSAzIHx8IGFyZ3VtZW50cy5sZW5ndGggPT09IDQpKTsKICAgICAgICAodHJ1ZSAmJiAhKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyB8fCB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0Nhbm5vdCBjYWxsIHNldCB3aXRoIFwnJyArIGtleU5hbWUgKyAnXCcgb24gYW4gdW5kZWZpbmVkIG9iamVjdC4nLCBvYmogJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG9iaiA9PT0gJ2Z1bmN0aW9uJykpOwogICAgICAgICh0cnVlICYmICEodHlwZW9mIGtleU5hbWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBrZXlOYW1lID09PSAnbnVtYmVyJyAmJiAhaXNOYU4oa2V5TmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGtleSBwcm92aWRlZCB0byBzZXQgbXVzdCBiZSBhIHN0cmluZyBvciBudW1iZXIsIHlvdSBwYXNzZWQgJyArIGtleU5hbWUsIHR5cGVvZiBrZXlOYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2Yga2V5TmFtZSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKGtleU5hbWUpKSk7CiAgICAgICAgKHRydWUgJiYgISh0eXBlb2Yga2V5TmFtZSAhPT0gJ3N0cmluZycgfHwga2V5TmFtZS5sYXN0SW5kZXhPZigndGhpcy4nLCAwKSAhPT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdcJ3RoaXNcJyBpbiBwYXRocyBpcyBub3Qgc3VwcG9ydGVkJywgdHlwZW9mIGtleU5hbWUgIT09ICdzdHJpbmcnIHx8IGtleU5hbWUubGFzdEluZGV4T2YoJ3RoaXMuJywgMCkgIT09IDApKTsKCiAgICAgICAgaWYgKG9iai5pc0Rlc3Ryb3llZCkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKHRvbGVyYW50KSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2NhbGxpbmcgc2V0IG9uIGRlc3Ryb3llZCBvYmplY3Q6ICcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKG9iaikgKyAnLicgKyBrZXlOYW1lICsgJyA9ICcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHZhbHVlKSwgdG9sZXJhbnQpKTsKCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUGF0aChrZXlOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gc2V0UGF0aChvYmosIGtleU5hbWUsIHZhbHVlLCB0b2xlcmFudCk7CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZURlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGtleU5hbWUpOwogICAgICAgIGlmIChwb3NzaWJsZURlc2MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAvKiBjb21wdXRlZCBwcm9wZXJ0eSAqLwogICAgICAgICAgICBwb3NzaWJsZURlc2Muc2V0KG9iaiwga2V5TmFtZSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRydWUgJiYgX2VtYmVyVXRpbHMuSEFTX05BVElWRV9QUk9YWSkgewogICAgICAgICAgICBjdXJyZW50VmFsdWUgPSBnZXRQb3NzaWJsZU1hbmRhdG9yeVByb3h5VmFsdWUob2JqLCBrZXlOYW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdXJyZW50VmFsdWUgPSBvYmpba2V5TmFtZV07CiAgICAgICAgfQogICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLlBST1BFUlRZX0JBU0VEX0RFU0NSSVBUT1JTICYmICgwLCBfZW1iZXJNZXRhLmlzRGVzY3JpcHRvcikoY3VycmVudFZhbHVlKSkgewogICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1tERVBSRUNBVEVEXSBjb21wdXRlZCBwcm9wZXJ0eSBcJycgKyBrZXlOYW1lICsgJ1wnIHdhcyBub3Qgc2V0IG9uIG9iamVjdCBcJycgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKG9iaikgKyAnXCcgdmlhIFwnZGVmaW5lUHJvcGVydHlcJycsIGZhbHNlLCB7CiAgICAgICAgICAgICAgICBpZDogJ2VtYmVyLW1ldGEuZGVzY3JpcHRvci1vbi1vYmplY3QnLAogICAgICAgICAgICAgICAgdW50aWw6ICczLjUuMCcsCiAgICAgICAgICAgICAgICB1cmw6ICdodHRwczovL2VtYmVyanMuY29tL2RlcHJlY2F0aW9ucy92My54I3RvY191c2UtZGVmaW5lUHJvcGVydHktdG8tZGVmaW5lLWNvbXB1dGVkLXByb3BlcnRpZXMnCiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHZhciBjdiA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogY3YuZW51bWVyYWJsZSA9PT0gZmFsc2UsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3YuZ2V0KHRoaXMsIGtleU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKS53cml0ZURlc2NyaXB0b3JzKGtleU5hbWUsIGN2KTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdi5zZXR1cCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY3Yuc2V0dXAob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdi5zZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gdW5kZWZpbmVkICYmICdvYmplY3QnID09PSB0eXBlb2Ygb2JqICYmICEoa2V5TmFtZSBpbiBvYmopICYmIHR5cGVvZiBvYmouc2V0VW5rbm93blByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIC8qIHVua25vd24gcHJvcGVydHkgKi8KICAgICAgICAgICAgb2JqLnNldFVua25vd25Qcm9wZXJ0eShrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkob2JqKTsKICAgICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgICAgIHNldFdpdGhNYW5kYXRvcnlTZXR0ZXIobWV0YSQkMSwgb2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvYmpba2V5TmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgbm90aWZ5UHJvcGVydHlDaGFuZ2Uob2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodHJ1ZSkgewogICAgICAgIHNldFdpdGhNYW5kYXRvcnlTZXR0ZXIgPSBmdW5jdGlvbiAobWV0YSQkMSwgb2JqLCBrZXlOYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobWV0YSQkMSAhPT0gdW5kZWZpbmVkICYmIG1ldGEkJDEucGVla1dhdGNoaW5nKGtleU5hbWUpID4gMCkgewogICAgICAgICAgICAgICAgbWFrZUVudW1lcmFibGUob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgICAgIG1ldGEkJDEud3JpdGVWYWx1ZShvYmosIGtleU5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9ialtrZXlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBtYWtlRW51bWVyYWJsZSA9IGZ1bmN0aW9uIChvYmosIGtleSkgewogICAgICAgICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwogICAgICAgICAgICBpZiAoZGVzYyAmJiBkZXNjLnNldCAmJiBkZXNjLnNldC5pc01hbmRhdG9yeVNldHRlcikgewogICAgICAgICAgICAgICAgZGVzYy5lbnVtZXJhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgZGVzYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gc2V0UGF0aChyb290LCBwYXRoLCB2YWx1ZSwgdG9sZXJhbnQpIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIGtleU5hbWUgPSBwYXJ0cy5wb3AoKTsKICAgICAgICAodHJ1ZSAmJiAhKGtleU5hbWUudHJpbSgpLmxlbmd0aCA+IDApICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnUHJvcGVydHkgc2V0IGZhaWxlZDogWW91IHBhc3NlZCBhbiBlbXB0eSBwYXRoJywga2V5TmFtZS50cmltKCkubGVuZ3RoID4gMCkpOwoKICAgICAgICB2YXIgbmV3UGF0aCA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICB2YXIgbmV3Um9vdCA9IF9nZXRQYXRoKHJvb3QsIG5ld1BhdGgpOwogICAgICAgIGlmIChuZXdSb290KSB7CiAgICAgICAgICAgIHJldHVybiBfc2V0MihuZXdSb290LCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICghdG9sZXJhbnQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCdQcm9wZXJ0eSBzZXQgZmFpbGVkOiBvYmplY3QgaW4gcGF0aCAiJyArIG5ld1BhdGggKyAnIiBjb3VsZCBub3QgYmUgZm91bmQgb3Igd2FzIGRlc3Ryb3llZC4nKTsKICAgICAgICB9CiAgICB9CiAgICAvKioKICAgICAgRXJyb3ItdG9sZXJhbnQgZm9ybSBvZiBgc2V0YC4gV2lsbCBub3QgYmxvdyB1cCBpZiBhbnkgcGFydCBvZiB0aGUKICAgICAgY2hhaW4gaXMgYHVuZGVmaW5lZGAsIGBudWxsYCwgb3IgZGVzdHJveWVkLgogICAgCiAgICAgIFRoaXMgaXMgcHJpbWFyaWx5IHVzZWQgd2hlbiBzeW5jaW5nIGJpbmRpbmdzLCB3aGljaCBtYXkgdHJ5IHRvIHVwZGF0ZSBhZnRlcgogICAgICBhbiBvYmplY3QgaGFzIGJlZW4gZGVzdHJveWVkLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgdHJ5U2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgbGV0IG9iaiA9IHsgbmFtZTogIlpvZXkiIH07CiAgICAgIHRyeVNldChvYmosICJjb250YWN0cy50d2l0dGVyIiwgIkBlbWJlcmpzIik7CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgdHJ5U2V0CiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICAgIEBwYXJhbSB7T2JqZWN0fSByb290IFRoZSBvYmplY3QgdG8gbW9kaWZ5LgogICAgICBAcGFyYW0ge1N0cmluZ30gcGF0aCBUaGUgcHJvcGVydHkgcGF0aCB0byBzZXQKICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIHRyeVNldChyb290LCBwYXRoLCB2YWx1ZSkgewogICAgICAgIHJldHVybiBfc2V0Mihyb290LCBwYXRoLCB2YWx1ZSwgdHJ1ZSk7CiAgICB9CgogICAgLyoqCiAgICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAgICovCiAgICB2YXIgREVFUF9FQUNIX1JFR0VYID0gL1wuQGVhY2hcLlteLl0rXC4vOwogICAgZnVuY3Rpb24gbm9vcCgpIHt9CiAgICAvKioKICAgICAgQSBjb21wdXRlZCBwcm9wZXJ0eSB0cmFuc2Zvcm1zIGFuIG9iamVjdCBsaXRlcmFsIHdpdGggb2JqZWN0J3MgYWNjZXNzb3IgZnVuY3Rpb24ocykgaW50byBhIHByb3BlcnR5LgogICAgCiAgICAgIEJ5IGRlZmF1bHQgdGhlIGZ1bmN0aW9uIGJhY2tpbmcgdGhlIGNvbXB1dGVkIHByb3BlcnR5IHdpbGwgb25seSBiZSBjYWxsZWQKICAgICAgb25jZSBhbmQgdGhlIHJlc3VsdCB3aWxsIGJlIGNhY2hlZC4gWW91IGNhbiBzcGVjaWZ5IHZhcmlvdXMgcHJvcGVydGllcwogICAgICB0aGF0IHlvdXIgY29tcHV0ZWQgcHJvcGVydHkgZGVwZW5kcyBvbi4gVGhpcyB3aWxsIGZvcmNlIHRoZSBjYWNoZWQKICAgICAgcmVzdWx0IHRvIGJlIHJlY29tcHV0ZWQgaWYgdGhlIGRlcGVuZGVuY2llcyBhcmUgbW9kaWZpZWQuCiAgICAKICAgICAgSW4gdGhlIGZvbGxvd2luZyBleGFtcGxlIHdlIGRlY2xhcmUgYSBjb21wdXRlZCBwcm9wZXJ0eSAtIGBmdWxsTmFtZWAgLSBieSBjYWxsaW5nCiAgICAgIGBjb21wdXRlZGAgd2l0aCBwcm9wZXJ0eSBkZXBlbmRlbmNpZXMgKGBmaXJzdE5hbWVgIGFuZCBgbGFzdE5hbWVgKSBhcyBsZWFkaW5nIGFyZ3VtZW50cyBhbmQgZ2V0dGVyIGFjY2Vzc29yIGZ1bmN0aW9uLiBUaGUgYGZ1bGxOYW1lYCBnZXR0ZXIgZnVuY3Rpb24KICAgICAgd2lsbCBiZSBjYWxsZWQgb25jZSAocmVnYXJkbGVzcyBvZiBob3cgbWFueSB0aW1lcyBpdCBpcyBhY2Nlc3NlZCkgYXMgbG9uZwogICAgICBhcyBpdHMgZGVwZW5kZW5jaWVzIGhhdmUgbm90IGNoYW5nZWQuIE9uY2UgYGZpcnN0TmFtZWAgb3IgYGxhc3ROYW1lYCBhcmUgdXBkYXRlZAogICAgICBhbnkgZnV0dXJlIGNhbGxzIChvciBhbnl0aGluZyBib3VuZCkgdG8gYGZ1bGxOYW1lYCB3aWxsIGluY29ycG9yYXRlIHRoZSBuZXcKICAgICAgdmFsdWVzLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgLy8gdGhlc2Ugd2lsbCBiZSBzdXBwbGllZCBieSBgY3JlYXRlYAogICAgICAgIGZpcnN0TmFtZTogbnVsbCwKICAgICAgICBsYXN0TmFtZTogbnVsbCwKICAgIAogICAgICAgIGZ1bGxOYW1lOiBjb21wdXRlZCgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBsZXQgZmlyc3ROYW1lID0gdGhpcy5nZXQoJ2ZpcnN0TmFtZScpLAogICAgICAgICAgICAgIGxhc3ROYW1lICA9IHRoaXMuZ2V0KCdsYXN0TmFtZScpOwogICAgCiAgICAgICAgICByZXR1cm4gYCR7Zmlyc3ROYW1lfSAke2xhc3ROYW1lfWA7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAKICAgICAgbGV0IHRvbSA9IFBlcnNvbi5jcmVhdGUoewogICAgICAgIGZpcnN0TmFtZTogJ1RvbScsCiAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICB9KTsKICAgIAogICAgICB0b20uZ2V0KCdmdWxsTmFtZScpIC8vICdUb20gRGFsZScKICAgICAgYGBgCiAgICAKICAgICAgWW91IGNhbiBhbHNvIGRlZmluZSB3aGF0IEVtYmVyIHNob3VsZCBkbyB3aGVuIHNldHRpbmcgYSBjb21wdXRlZCBwcm9wZXJ0eSBieSBwcm92aWRpbmcgYWRkaXRpb25hbCBmdW5jdGlvbiAoYHNldGApIGluIGhhc2ggYXJndW1lbnQuCiAgICAgIElmIHlvdSB0cnkgdG8gc2V0IGEgY29tcHV0ZWQgcHJvcGVydHksIGl0IHdpbGwgdHJ5IHRvIGludm9rZSBzZXR0ZXIgYWNjZXNzb3IgZnVuY3Rpb24gd2l0aCB0aGUga2V5IGFuZAogICAgICB2YWx1ZSB5b3Ugd2FudCB0byBzZXQgaXQgdG8gYXMgYXJndW1lbnRzLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgLy8gdGhlc2Ugd2lsbCBiZSBzdXBwbGllZCBieSBgY3JlYXRlYAogICAgICAgIGZpcnN0TmFtZTogbnVsbCwKICAgICAgICBsYXN0TmFtZTogbnVsbCwKICAgIAogICAgICAgIGZ1bGxOYW1lOiBjb21wdXRlZCgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgewogICAgICAgICAgZ2V0KGtleSkgewogICAgICAgICAgICBsZXQgZmlyc3ROYW1lID0gdGhpcy5nZXQoJ2ZpcnN0TmFtZScpLAogICAgICAgICAgICAgICAgbGFzdE5hbWUgID0gdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIGZpcnN0TmFtZSArICcgJyArIGxhc3ROYW1lOwogICAgICAgICAgfSwKICAgICAgICAgIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGxldCBbZmlyc3ROYW1lLCBsYXN0TmFtZV0gPSB2YWx1ZS5zcGxpdCgnICcpOwogICAgCiAgICAgICAgICAgIHRoaXMuc2V0KCdmaXJzdE5hbWUnLCBmaXJzdE5hbWUpOwogICAgICAgICAgICB0aGlzLnNldCgnbGFzdE5hbWUnLCBsYXN0TmFtZSk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pOwogICAgCiAgICAgIGxldCBwZXJzb24gPSBQZXJzb24uY3JlYXRlKCk7CiAgICAKICAgICAgcGVyc29uLnNldCgnZnVsbE5hbWUnLCAnUGV0ZXIgV2FnZW5ldCcpOwogICAgICBwZXJzb24uZ2V0KCdmaXJzdE5hbWUnKTsgLy8gJ1BldGVyJwogICAgICBwZXJzb24uZ2V0KCdsYXN0TmFtZScpOyAgLy8gJ1dhZ2VuZXQnCiAgICAgIGBgYAogICAgCiAgICAgIFlvdSBjYW4gb3ZlcndyaXRlIGNvbXB1dGVkIHByb3BlcnR5IHdpdGggbm9ybWFsIHByb3BlcnR5IChubyBsb25nZXIgY29tcHV0ZWQpLCB0aGF0IHdvbid0IGNoYW5nZSBpZiBkZXBlbmRlbmNpZXMgY2hhbmdlLCBpZiB5b3Ugc2V0IGNvbXB1dGVkIHByb3BlcnR5IGFuZCBpdCB3b24ndCBoYXZlIHNldHRlciBhY2Nlc3NvciBmdW5jdGlvbiBkZWZpbmVkLgogICAgCiAgICAgIFlvdSBjYW4gYWxzbyBtYXJrIGNvbXB1dGVkIHByb3BlcnR5IGFzIGAucmVhZE9ubHkoKWAgYW5kIGJsb2NrIGFsbCBhdHRlbXB0cyB0byBzZXQgaXQuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgIAogICAgICBsZXQgUGVyc29uID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICAvLyB0aGVzZSB3aWxsIGJlIHN1cHBsaWVkIGJ5IGBjcmVhdGVgCiAgICAgICAgZmlyc3ROYW1lOiBudWxsLAogICAgICAgIGxhc3ROYW1lOiBudWxsLAogICAgCiAgICAgICAgZnVsbE5hbWU6IGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCB7CiAgICAgICAgICBnZXQoa2V5KSB7CiAgICAgICAgICAgIGxldCBmaXJzdE5hbWUgPSB0aGlzLmdldCgnZmlyc3ROYW1lJyk7CiAgICAgICAgICAgIGxldCBsYXN0TmFtZSAgPSB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgIAogICAgICAgICAgICByZXR1cm4gZmlyc3ROYW1lICsgJyAnICsgbGFzdE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfSkucmVhZE9ubHkoKQogICAgICB9KTsKICAgIAogICAgICBsZXQgcGVyc29uID0gUGVyc29uLmNyZWF0ZSgpOwogICAgICBwZXJzb24uc2V0KCdmdWxsTmFtZScsICdQZXRlciBXYWdlbmV0Jyk7IC8vIFVuY2F1Z2h0IEVycm9yOiBDYW5ub3Qgc2V0IHJlYWQtb25seSBwcm9wZXJ0eSAiZnVsbE5hbWUiIG9uIG9iamVjdDogPCguLi4pOmVtYmVyWFhYPgogICAgICBgYGAKICAgIAogICAgICBBZGRpdGlvbmFsIHJlc291cmNlczoKICAgICAgLSBbTmV3IENQIHN5bnRheCBSRkNdKGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL3JmY3MvYmxvYi9tYXN0ZXIvdGV4dC8wMDExLWltcHJvdmVkLWNwLXN5bnRheC5tZCkKICAgICAgLSBbTmV3IGNvbXB1dGVkIHN5bnRheCBleHBsYWluZWQgaW4gIkVtYmVyIDEuMTIgcmVsZWFzZWQiIF0oaHR0cHM6Ly9lbWJlcmpzLmNvbS9ibG9nLzIwMTUvMDUvMTMvZW1iZXItMS0xMi1yZWxlYXNlZC5odG1sI3RvY19uZXctY29tcHV0ZWQtc3ludGF4KQogICAgCiAgICAgIEBjbGFzcyBDb21wdXRlZFByb3BlcnR5CiAgICAgIEBwdWJsaWMKICAgICovCgogICAgdmFyIENvbXB1dGVkUHJvcGVydHkgPSBmdW5jdGlvbiAoX0Rlc2NyaXB0b3IpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKENvbXB1dGVkUHJvcGVydHksIF9EZXNjcmlwdG9yKTsKCiAgICAgICAgZnVuY3Rpb24gQ29tcHV0ZWRQcm9wZXJ0eShjb25maWcsIG9wdHMpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBDb21wdXRlZFByb3BlcnR5KTsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRGVzY3JpcHRvci5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIHZhciBoYXNHZXR0ZXJPbmx5ID0gdHlwZW9mIGNvbmZpZyA9PT0gJ2Z1bmN0aW9uJzsKICAgICAgICAgICAgaWYgKGhhc0dldHRlck9ubHkpIHsKICAgICAgICAgICAgICAgIF90aGlzLl9nZXR0ZXIgPSBjb25maWc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0Q29uZmlnID0gY29uZmlnOwogICAgICAgICAgICAgICAgKHRydWUgJiYgISh0eXBlb2Ygb2JqZWN0Q29uZmlnID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShvYmplY3RDb25maWcpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2NvbXB1dGVkIGV4cGVjdHMgYSBmdW5jdGlvbiBvciBhbiBvYmplY3QgYXMgbGFzdCBhcmd1bWVudC4nLCB0eXBlb2Ygb2JqZWN0Q29uZmlnID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShvYmplY3RDb25maWcpKSk7CiAgICAgICAgICAgICAgICAodHJ1ZSAmJiAhKE9iamVjdC5rZXlzKG9iamVjdENvbmZpZykuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXkgPT09ICdnZXQnIHx8IGtleSA9PT0gJ3NldCc7CiAgICAgICAgICAgICAgICB9KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb25maWcgb2JqZWN0IHBhc3NlZCB0byBjb21wdXRlZCBjYW4gb25seSBjb250YWluIGBnZXRgIGFuZCBgc2V0YCBrZXlzLicsIE9iamVjdC5rZXlzKG9iamVjdENvbmZpZykuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBrZXkgPT09ICdnZXQnIHx8IGtleSA9PT0gJ3NldCc7CiAgICAgICAgICAgICAgICB9KSkpOwogICAgICAgICAgICAgICAgKHRydWUgJiYgISghIW9iamVjdENvbmZpZy5nZXQgfHwgISFvYmplY3RDb25maWcuc2V0KSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0NvbXB1dGVkIHByb3BlcnRpZXMgbXVzdCByZWNlaXZlIGEgZ2V0dGVyIG9yIGEgc2V0dGVyLCB5b3UgcGFzc2VkIG5vbmUuJywgISFvYmplY3RDb25maWcuZ2V0IHx8ICEhb2JqZWN0Q29uZmlnLnNldCkpOwoKICAgICAgICAgICAgICAgIF90aGlzLl9nZXR0ZXIgPSBvYmplY3RDb25maWcuZ2V0IHx8IG5vb3A7CiAgICAgICAgICAgICAgICBfdGhpcy5fc2V0dGVyID0gb2JqZWN0Q29uZmlnLnNldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdGhpcy5fc3VzcGVuZGVkID0gdW5kZWZpbmVkOwogICAgICAgICAgICBfdGhpcy5fbWV0YSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgX3RoaXMuX3ZvbGF0aWxlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChmYWxzZSkgewogICAgICAgICAgICAgICAgX3RoaXMuX2F1dG8gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfdGhpcy5fZGVwZW5kZW50S2V5cyA9IG9wdHMgJiYgb3B0cy5kZXBlbmRlbnRLZXlzOwogICAgICAgICAgICBfdGhpcy5fcmVhZE9ubHkgPSAhIW9wdHMgJiYgaGFzR2V0dGVyT25seSAmJiBvcHRzLnJlYWRPbmx5ID09PSB0cnVlOwogICAgICAgICAgICByZXR1cm4gX3RoaXM7CiAgICAgICAgfQogICAgICAgIC8qKgogICAgICAgICAgQ2FsbCBvbiBhIGNvbXB1dGVkIHByb3BlcnR5IHRvIHNldCBpdCBpbnRvIG5vbi1jYWNoZWQgbW9kZS4gV2hlbiBpbiB0aGlzCiAgICAgICAgICBtb2RlIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSB3aWxsIG5vdCBhdXRvbWF0aWNhbGx5IGNhY2hlIHRoZSByZXR1cm4gdmFsdWUuCiAgICAgICAgICAgICBJdCBhbHNvIGRvZXMgbm90IGF1dG9tYXRpY2FsbHkgZmlyZSBhbnkgY2hhbmdlIGV2ZW50cy4gWW91IG11c3QgbWFudWFsbHkgbm90aWZ5CiAgICAgICAgICBhbnkgY2hhbmdlcyBpZiB5b3Ugd2FudCB0byBvYnNlcnZlIHRoaXMgcHJvcGVydHkuCiAgICAgICAgICAgICBEZXBlbmRlbmN5IGtleXMgaGF2ZSBubyBlZmZlY3Qgb24gdm9sYXRpbGUgcHJvcGVydGllcyBhcyB0aGV5IGFyZSBmb3IgY2FjaGUKICAgICAgICAgIGludmFsaWRhdGlvbiBhbmQgbm90aWZpY2F0aW9uIHdoZW4gY2FjaGVkIHZhbHVlIGlzIGludmFsaWRhdGVkLgogICAgICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgICAgICBsZXQgb3V0c2lkZVNlcnZpY2UgPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgICAgICB2YWx1ZTogY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE91dHNpZGVTZXJ2aWNlLmdldFZhbHVlKCk7CiAgICAgICAgICAgIH0pLnZvbGF0aWxlKCkKICAgICAgICAgIH0pLmNyZWF0ZSgpOwogICAgICAgICAgYGBgCiAgICAgICAgICAgICBAbWV0aG9kIHZvbGF0aWxlCiAgICAgICAgICBAcmV0dXJuIHtDb21wdXRlZFByb3BlcnR5fSB0aGlzCiAgICAgICAgICBAY2hhaW5hYmxlCiAgICAgICAgICBAcHVibGljCiAgICAgICAgKi8KCgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnZvbGF0aWxlID0gZnVuY3Rpb24gdm9sYXRpbGUoKSB7CiAgICAgICAgICAgIHRoaXMuX3ZvbGF0aWxlID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUucmVhZE9ubHkgPSBmdW5jdGlvbiByZWFkT25seSgpIHsKICAgICAgICAgICAgdGhpcy5fcmVhZE9ubHkgPSB0cnVlOwogICAgICAgICAgICAodHJ1ZSAmJiAhKCEodGhpcy5fcmVhZE9ubHkgJiYgdGhpcy5fc2V0dGVyICYmIHRoaXMuX3NldHRlciAhPT0gdGhpcy5fZ2V0dGVyKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDb21wdXRlZCBwcm9wZXJ0aWVzIHRoYXQgZGVmaW5lIGEgc2V0dGVyIHVzaW5nIHRoZSBuZXcgc3ludGF4IGNhbm5vdCBiZSByZWFkLW9ubHknLCAhKHRoaXMuX3JlYWRPbmx5ICYmIHRoaXMuX3NldHRlciAmJiB0aGlzLl9zZXR0ZXIgIT09IHRoaXMuX2dldHRlcikpKTsKCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnByb3BlcnR5ID0gZnVuY3Rpb24gcHJvcGVydHkoKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZEFyZyhwcm9wZXJ0eSkgewogICAgICAgICAgICAgICAgKHRydWUgJiYgKDAsIF9kZWJ1Zy53YXJuKSgnRGVwZW5kZW50IGtleXMgY29udGFpbmluZyBAZWFjaCBvbmx5IHdvcmsgb25lIGxldmVsIGRlZXAuICcgKyAoJ1lvdSB1c2VkIHRoZSBrZXkgIicgKyBwcm9wZXJ0eSArICciIHdoaWNoIGlzIGludmFsaWQuICcpICsgJ1BsZWFzZSBjcmVhdGUgYW4gaW50ZXJtZWRpYXJ5IGNvbXB1dGVkIHByb3BlcnR5LicsIERFRVBfRUFDSF9SRUdFWC50ZXN0KHByb3BlcnR5KSA9PT0gZmFsc2UsIHsgaWQ6ICdlbWJlci1tZXRhbC5jb21wdXRlZC1kZWVwLWVhY2gnIH0pKTsKCiAgICAgICAgICAgICAgICBhcmdzLnB1c2gocHJvcGVydHkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIHBhc3NlZEFyZ3MgPSBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgcGFzc2VkQXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhc3NlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGV4cGFuZFByb3BlcnRpZXMocGFzc2VkQXJnc1tpXSwgYWRkQXJnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9kZXBlbmRlbnRLZXlzID0gYXJnczsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUubWV0YSA9IGZ1bmN0aW9uIG1ldGEobWV0YSQkMSkgewogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21ldGEgfHwge307CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tZXRhID0gbWV0YSQkMTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUuZGlkQ2hhbmdlID0gZnVuY3Rpb24gZGlkQ2hhbmdlKG9iaiwga2V5TmFtZSkgewogICAgICAgICAgICAvLyBfc3VzcGVuZGVkIGlzIHNldCB2aWEgYSBDUC5zZXQgdG8gZW5zdXJlIHdlIGRvbid0IGNsZWFyCiAgICAgICAgICAgIC8vIHRoZSBjYWNoZWQgdmFsdWUgc2V0IGJ5IHRoZSBzZXR0ZXIKICAgICAgICAgICAgaWYgKHRoaXMuX3ZvbGF0aWxlIHx8IHRoaXMuX3N1c3BlbmRlZCA9PT0gb2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gZG9uJ3QgY3JlYXRlIG9iamVjdHMganVzdCB0byBpbnZhbGlkYXRlCiAgICAgICAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEucGVla01ldGEpKG9iaik7CiAgICAgICAgICAgIGlmIChtZXRhJCQxID09PSB1bmRlZmluZWQgfHwgbWV0YSQkMS5zb3VyY2UgIT09IG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHBlZWtDYWNoZUZvcihvYmopOwogICAgICAgICAgICBpZiAoY2FjaGUgIT09IHVuZGVmaW5lZCAmJiBjYWNoZS5kZWxldGUoa2V5TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJlbW92ZURlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChvYmosIGtleU5hbWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3ZvbGF0aWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0dGVyLmNhbGwob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FjaGUgPSBnZXRDYWNoZUZvcihvYmopOwogICAgICAgICAgICB2YXIgcHJvcGVydHlUYWcgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChmYWxzZSkgewogICAgICAgICAgICAgICAgcHJvcGVydHlUYWcgPSB0YWdGb3JQcm9wZXJ0eShvYmosIGtleU5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhY2hlLmhhcyhrZXlOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIC8vIHNwZWNpYWwtY2FzZSBmb3IgY29tcHV0ZWQgd2l0aCBubyBkZXBlbmRlbnQga2V5cyB1c2VkIHRvCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciBjYWNoZWFibGUgYmVoYXZpb3IuCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9hdXRvICYmICghdGhpcy5fZGVwZW5kZW50S2V5cyB8fCB0aGlzLl9kZXBlbmRlbnRLZXlzLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlLmdldChrZXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RSZXZpc2lvbiA9IGdldExhc3RSZXZpc2lvbkZvcihvYmosIGtleU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eVRhZy52YWxpZGF0ZShsYXN0UmV2aXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZS5nZXQoa2V5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGNhY2hlLmhhcyhrZXlOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZS5nZXQoa2V5TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudCA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIHRyYWNrZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChmYWxzZSkgewogICAgICAgICAgICAgICAgcGFyZW50ID0gZ2V0Q3VycmVudFRyYWNrZXIoKTsKICAgICAgICAgICAgICAgIHRyYWNrZXIgPSBzZXRDdXJyZW50VHJhY2tlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXQgPSB0aGlzLl9nZXR0ZXIuY2FsbChvYmosIGtleU5hbWUpOwogICAgICAgICAgICBpZiAoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRUcmFja2VyKHBhcmVudCk7CiAgICAgICAgICAgICAgICB2YXIgdGFnID0gdHJhY2tlci5jb21iaW5lKCk7CiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQuYWRkKHRhZyk7CiAgICAgICAgICAgICAgICB1cGRhdGUocHJvcGVydHlUYWcsIHRhZyk7CiAgICAgICAgICAgICAgICBzZXRMYXN0UmV2aXNpb25Gb3Iob2JqLCBrZXlOYW1lLCBwcm9wZXJ0eVRhZy52YWx1ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWNoZS5zZXQoa2V5TmFtZSwgcmV0KTsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5tZXRhKShvYmopOwogICAgICAgICAgICB2YXIgY2hhaW5XYXRjaGVycyA9IG1ldGEkJDEucmVhZGFibGVDaGFpbldhdGNoZXJzKCk7CiAgICAgICAgICAgIGlmIChjaGFpbldhdGNoZXJzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNoYWluV2F0Y2hlcnMucmV2YWxpZGF0ZShrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZGREZXBlbmRlbnRLZXlzKHRoaXMsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KG9iaiwga2V5TmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3JlYWRPbmx5KSB7CiAgICAgICAgICAgICAgICB0aGlzLl90aHJvd1JlYWRPbmx5RXJyb3Iob2JqLCBrZXlOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuX3NldHRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvYmJlclNldChvYmosIGtleU5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5fdm9sYXRpbGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZvbGF0aWxlU2V0KG9iaiwga2V5TmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFdpdGhTdXNwZW5kKG9iaiwga2V5TmFtZSwgdmFsdWUpOwogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLl90aHJvd1JlYWRPbmx5RXJyb3IgPSBmdW5jdGlvbiBfdGhyb3dSZWFkT25seUVycm9yKG9iaiwga2V5TmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoJ0Nhbm5vdCBzZXQgcmVhZC1vbmx5IHByb3BlcnR5ICInICsga2V5TmFtZSArICciIG9uIG9iamVjdDogJyArICgwLCBfZW1iZXJVdGlscy5pbnNwZWN0KShvYmopKTsKICAgICAgICB9OwoKICAgICAgICBDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZS5jbG9iYmVyU2V0ID0gZnVuY3Rpb24gY2xvYmJlclNldChvYmosIGtleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IGdldENhY2hlZFZhbHVlRm9yKG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KG9iaiwga2V5TmFtZSwgbnVsbCwgY2FjaGVkVmFsdWUpOwogICAgICAgICAgICBfc2V0MihvYmosIGtleU5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnZvbGF0aWxlU2V0ID0gZnVuY3Rpb24gdm9sYXRpbGVTZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc2V0dGVyLmNhbGwob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUuc2V0V2l0aFN1c3BlbmQgPSBmdW5jdGlvbiBzZXRXaXRoU3VzcGVuZChvYmosIGtleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBvbGRTdXNwZW5kZWQgPSB0aGlzLl9zdXNwZW5kZWQ7CiAgICAgICAgICAgIHRoaXMuX3N1c3BlbmRlZCA9IG9iajsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zZXQob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdXNwZW5kZWQgPSBvbGRTdXNwZW5kZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZS5fc2V0ID0gZnVuY3Rpb24gX3NldChvYmosIGtleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IGdldENhY2hlRm9yKG9iaik7CiAgICAgICAgICAgIHZhciBoYWRDYWNoZWRWYWx1ZSA9IGNhY2hlLmhhcyhrZXlOYW1lKTsKICAgICAgICAgICAgdmFyIGNhY2hlZFZhbHVlID0gY2FjaGUuZ2V0KGtleU5hbWUpOwogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5fc2V0dGVyLmNhbGwob2JqLCBrZXlOYW1lLCB2YWx1ZSwgY2FjaGVkVmFsdWUpOwogICAgICAgICAgICAvLyBhbGxvd3Mgc2V0dGVyIHRvIHJldHVybiB0aGUgc2FtZSB2YWx1ZSB0aGF0IGlzIGNhY2hlZCBhbHJlYWR5CiAgICAgICAgICAgIGlmIChoYWRDYWNoZWRWYWx1ZSAmJiBjYWNoZWRWYWx1ZSA9PT0gcmV0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBtZXRhJCQxID0gKDAsIF9lbWJlck1ldGEubWV0YSkob2JqKTsKICAgICAgICAgICAgaWYgKCFoYWRDYWNoZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgYWRkRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhY2hlLnNldChrZXlOYW1lLCByZXQpOwogICAgICAgICAgICBub3RpZnlQcm9wZXJ0eUNoYW5nZShvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgICAgICBpZiAoZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eVRhZyA9IHRhZ0ZvclByb3BlcnR5KG9iaiwga2V5TmFtZSk7CiAgICAgICAgICAgICAgICBzZXRMYXN0UmV2aXNpb25Gb3Iob2JqLCBrZXlOYW1lLCBwcm9wZXJ0eVRhZy52YWx1ZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CgogICAgICAgIENvbXB1dGVkUHJvcGVydHkucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gdGVhcmRvd24ob2JqLCBrZXlOYW1lLCBtZXRhJCQxKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl92b2xhdGlsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHBlZWtDYWNoZUZvcihvYmopOwogICAgICAgICAgICBpZiAoY2FjaGUgIT09IHVuZGVmaW5lZCAmJiBjYWNoZS5kZWxldGUoa2V5TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJlbW92ZURlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBDb21wdXRlZFByb3BlcnR5OwogICAgfShEZXNjcmlwdG9yKTsKCiAgICBpZiAoZmFsc2UpIHsKICAgICAgICBDb21wdXRlZFByb3BlcnR5LnByb3RvdHlwZS5hdXRvID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLl9hdXRvID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICBUaGlzIGhlbHBlciByZXR1cm5zIGEgbmV3IHByb3BlcnR5IGRlc2NyaXB0b3IgdGhhdCB3cmFwcyB0aGUgcGFzc2VkCiAgICAgIGNvbXB1dGVkIHByb3BlcnR5IGZ1bmN0aW9uLiBZb3UgY2FuIHVzZSB0aGlzIGhlbHBlciB0byBkZWZpbmUgcHJvcGVydGllcwogICAgICB3aXRoIG1peGlucyBvciB2aWEgYGRlZmluZVByb3BlcnR5KClgLgogICAgCiAgICAgIElmIHlvdSBwYXNzIGEgZnVuY3Rpb24gYXMgYW4gYXJndW1lbnQsIGl0IHdpbGwgYmUgdXNlZCBhcyBhIGdldHRlci4gQSBjb21wdXRlZAogICAgICBwcm9wZXJ0eSBkZWZpbmVkIGluIHRoaXMgd2F5IG1pZ2h0IGxvb2sgbGlrZSB0aGlzOgogICAgCiAgICAgIGBgYGpzCiAgICAgIGltcG9ydCBFbWJlck9iamVjdCwgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIGxldCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICAgIGluaXQoKSB7CiAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgCiAgICAgICAgICB0aGlzLmZpcnN0TmFtZSA9ICdCZXR0eSc7CiAgICAgICAgICB0aGlzLmxhc3ROYW1lID0gJ0pvbmVzJzsKICAgICAgICB9LAogICAgCiAgICAgICAgZnVsbE5hbWU6IGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBgJHt0aGlzLmdldCgnZmlyc3ROYW1lJyl9ICR7dGhpcy5nZXQoJ2xhc3ROYW1lJyl9YDsKICAgICAgICB9KQogICAgICB9KTsKICAgIAogICAgICBsZXQgY2xpZW50ID0gUGVyc29uLmNyZWF0ZSgpOwogICAgCiAgICAgIGNsaWVudC5nZXQoJ2Z1bGxOYW1lJyk7IC8vICdCZXR0eSBKb25lcycKICAgIAogICAgICBjbGllbnQuc2V0KCdsYXN0TmFtZScsICdGdWxsZXInKTsKICAgICAgY2xpZW50LmdldCgnZnVsbE5hbWUnKTsgLy8gJ0JldHR5IEZ1bGxlcicKICAgICAgYGBgCiAgICAKICAgICAgWW91IGNhbiBwYXNzIGEgaGFzaCB3aXRoIHR3byBmdW5jdGlvbnMsIGBnZXRgIGFuZCBgc2V0YCwgYXMgYW4KICAgICAgYXJndW1lbnQgdG8gcHJvdmlkZSBib3RoIGEgZ2V0dGVyIGFuZCBzZXR0ZXI6CiAgICAKICAgICAgYGBganMKICAgICAgaW1wb3J0IEVtYmVyT2JqZWN0LCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgbGV0IFBlcnNvbiA9IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgaW5pdCgpIHsKICAgICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAKICAgICAgICAgIHRoaXMuZmlyc3ROYW1lID0gJ0JldHR5JzsKICAgICAgICAgIHRoaXMubGFzdE5hbWUgPSAnSm9uZXMnOwogICAgICAgIH0sCiAgICAKICAgICAgICBmdWxsTmFtZTogY29tcHV0ZWQoJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsIHsKICAgICAgICAgIGdldChrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGAke3RoaXMuZ2V0KCdmaXJzdE5hbWUnKX0gJHt0aGlzLmdldCgnbGFzdE5hbWUnKX1gOwogICAgICAgICAgfSwKICAgICAgICAgIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGxldCBbZmlyc3ROYW1lLCBsYXN0TmFtZV0gPSB2YWx1ZS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgIHRoaXMuc2V0UHJvcGVydGllcyh7IGZpcnN0TmFtZSwgbGFzdE5hbWUgfSk7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KTsKICAgIAogICAgICBsZXQgY2xpZW50ID0gUGVyc29uLmNyZWF0ZSgpOwogICAgICBjbGllbnQuZ2V0KCdmaXJzdE5hbWUnKTsgLy8gJ0JldHR5JwogICAgCiAgICAgIGNsaWVudC5zZXQoJ2Z1bGxOYW1lJywgJ0NhcnJvbGwgRnVsbGVyJyk7CiAgICAgIGNsaWVudC5nZXQoJ2ZpcnN0TmFtZScpOyAvLyAnQ2Fycm9sbCcKICAgICAgYGBgCiAgICAKICAgICAgVGhlIGBzZXRgIGZ1bmN0aW9uIHNob3VsZCBhY2NlcHQgdHdvIHBhcmFtZXRlcnMsIGBrZXlgIGFuZCBgdmFsdWVgLiBUaGUgdmFsdWUKICAgICAgcmV0dXJuZWQgZnJvbSBgc2V0YCB3aWxsIGJlIHRoZSBuZXcgdmFsdWUgb2YgdGhlIHByb3BlcnR5LgogICAgCiAgICAgIF9Ob3RlOiBUaGlzIGlzIHRoZSBwcmVmZXJyZWQgd2F5IHRvIGRlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIHdoZW4gd3JpdGluZyB0aGlyZC1wYXJ0eQogICAgICBsaWJyYXJpZXMgdGhhdCBkZXBlbmQgb24gb3IgdXNlIEVtYmVyLCBzaW5jZSB0aGVyZSBpcyBubyBndWFyYW50ZWUgdGhhdCB0aGUgdXNlcgogICAgICB3aWxsIGhhdmUgW3Byb3RvdHlwZSBFeHRlbnNpb25zXShodHRwczovL2VtYmVyanMuY29tL2d1aWRlcy9jb25maWd1cmluZy1lbWJlci9kaXNhYmxpbmctcHJvdG90eXBlLWV4dGVuc2lvbnMvKSBlbmFibGVkLl8KICAgIAogICAgICBUaGUgYWx0ZXJuYXRpdmUgc3ludGF4LCB3aXRoIHByb3RvdHlwZSBleHRlbnNpb25zLCBtaWdodCBsb29rIGxpa2U6CiAgICAKICAgICAgYGBganMKICAgICAgZnVsbE5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgICAgfS5wcm9wZXJ0eSgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJykKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBjb21wdXRlZAogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHN0YXRpYwogICAgICBAcGFyYW0ge1N0cmluZ30gW2RlcGVuZGVudEtleXMqXSBPcHRpb25hbCBkZXBlbmRlbnQga2V5cyB0aGF0IHRyaWdnZXIgdGhpcyBjb21wdXRlZCBwcm9wZXJ0eS4KICAgICAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgY29tcHV0ZWQgcHJvcGVydHkgZnVuY3Rpb24uCiAgICAgIEByZXR1cm4ge0NvbXB1dGVkUHJvcGVydHl9IHByb3BlcnR5IGRlc2NyaXB0b3IgaW5zdGFuY2UKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGNvbXB1dGVkKCkgewogICAgICAgIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4zKSwgX2tleTMgPSAwOyBfa2V5MyA8IF9sZW4zOyBfa2V5MysrKSB7CiAgICAgICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgICB9CgogICAgICAgIHZhciBmdW5jID0gYXJncy5wb3AoKTsKICAgICAgICB2YXIgY3AgPSBuZXcgQ29tcHV0ZWRQcm9wZXJ0eShmdW5jKTsKICAgICAgICBpZiAoYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNwLnByb3BlcnR5LmFwcGx5KGNwLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNwOwogICAgfQogICAgLy8gdXNlZCBmb3IgdGhlIEVtYmVyLmNvbXB1dGVkIGdsb2JhbCBvbmx5CiAgICB2YXIgX2dsb2JhbHNDb21wdXRlZCA9IGNvbXB1dGVkLmJpbmQobnVsbCk7CgogICAgdmFyIENPTlNVTUVEID0gT2JqZWN0LmZyZWV6ZSh7fSk7CiAgICBmdW5jdGlvbiBhbGlhcyhhbHRLZXkpIHsKICAgICAgICByZXR1cm4gbmV3IEFsaWFzZWRQcm9wZXJ0eShhbHRLZXkpOwogICAgfQoKICAgIHZhciBBbGlhc2VkUHJvcGVydHkgPSBmdW5jdGlvbiAoX0Rlc2NyaXB0b3IyKSB7CiAgICAgICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShBbGlhc2VkUHJvcGVydHksIF9EZXNjcmlwdG9yMik7CgogICAgICAgIGZ1bmN0aW9uIEFsaWFzZWRQcm9wZXJ0eShhbHRLZXkpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBBbGlhc2VkUHJvcGVydHkpOwoKICAgICAgICAgICAgdmFyIF90aGlzMiA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRGVzY3JpcHRvcjIuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczIuYWx0S2V5ID0gYWx0S2V5OwogICAgICAgICAgICBfdGhpczIuX2RlcGVuZGVudEtleXMgPSBbYWx0S2V5XTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzMjsKICAgICAgICB9CgogICAgICAgIEFsaWFzZWRQcm9wZXJ0eS5wcm90b3R5cGUuc2V0dXAgPSBmdW5jdGlvbiBzZXR1cChvYmosIGtleU5hbWUpIHsKICAgICAgICAgICAgKHRydWUgJiYgISh0aGlzLmFsdEtleSAhPT0ga2V5TmFtZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdTZXR0aW5nIGFsaWFzIFwnJyArIGtleU5hbWUgKyAnXCcgb24gc2VsZicsIHRoaXMuYWx0S2V5ICE9PSBrZXlOYW1lKSk7CgogICAgICAgICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfZW1iZXJNZXRhLm1ldGEpKG9iaik7CiAgICAgICAgICAgIGlmIChtZXRhJCQxLnBlZWtXYXRjaGluZyhrZXlOYW1lKSA+IDApIHsKICAgICAgICAgICAgICAgIGFkZERlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIEFsaWFzZWRQcm9wZXJ0eS5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiB0ZWFyZG93bihvYmosIGtleU5hbWUsIG1ldGEkJDEpIHsKICAgICAgICAgICAgaWYgKG1ldGEkJDEucGVla1dhdGNoaW5nKGtleU5hbWUpID4gMCkgewogICAgICAgICAgICAgICAgcmVtb3ZlRGVwZW5kZW50S2V5cyh0aGlzLCBvYmosIGtleU5hbWUsIG1ldGEkJDEpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgQWxpYXNlZFByb3BlcnR5LnByb3RvdHlwZS53aWxsV2F0Y2ggPSBmdW5jdGlvbiB3aWxsV2F0Y2gob2JqLCBrZXlOYW1lLCBtZXRhJCQxKSB7CiAgICAgICAgICAgIGFkZERlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICB9OwoKICAgICAgICBBbGlhc2VkUHJvcGVydHkucHJvdG90eXBlLmRpZFVud2F0Y2ggPSBmdW5jdGlvbiBkaWRVbndhdGNoKG9iaiwga2V5TmFtZSwgbWV0YSQkMSkgewogICAgICAgICAgICByZW1vdmVEZXBlbmRlbnRLZXlzKHRoaXMsIG9iaiwga2V5TmFtZSwgbWV0YSQkMSk7CiAgICAgICAgfTsKCiAgICAgICAgQWxpYXNlZFByb3BlcnR5LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQob2JqLCBrZXlOYW1lKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBfZ2V0KG9iaiwgdGhpcy5hbHRLZXkpOwogICAgICAgICAgICB2YXIgY2FjaGUgPSBnZXRDYWNoZUZvcihvYmopOwogICAgICAgICAgICBpZiAoY2FjaGUuZ2V0KGtleU5hbWUpICE9PSBDT05TVU1FRCkgewogICAgICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5tZXRhKShvYmopOwogICAgICAgICAgICAgICAgY2FjaGUuc2V0KGtleU5hbWUsIENPTlNVTUVEKTsKICAgICAgICAgICAgICAgIGFkZERlcGVuZGVudEtleXModGhpcywgb2JqLCBrZXlOYW1lLCBtZXRhJCQxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CgogICAgICAgIEFsaWFzZWRQcm9wZXJ0eS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KG9iaiwgX2tleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBfc2V0MihvYmosIHRoaXMuYWx0S2V5LCB2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgQWxpYXNlZFByb3BlcnR5LnByb3RvdHlwZS5yZWFkT25seSA9IGZ1bmN0aW9uIHJlYWRPbmx5KCkgewogICAgICAgICAgICB0aGlzLnNldCA9IEFsaWFzZWRQcm9wZXJ0eV9yZWFkT25seVNldDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgQWxpYXNlZFByb3BlcnR5LnByb3RvdHlwZS5vbmVXYXkgPSBmdW5jdGlvbiBvbmVXYXkoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0ID0gQWxpYXNlZFByb3BlcnR5X29uZVdheVNldDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFsaWFzZWRQcm9wZXJ0eTsKICAgIH0oRGVzY3JpcHRvcik7CgogICAgZnVuY3Rpb24gQWxpYXNlZFByb3BlcnR5X3JlYWRPbmx5U2V0KG9iaiwga2V5TmFtZSkgewogICAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnMKICAgICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoJ0Nhbm5vdCBzZXQgcmVhZC1vbmx5IHByb3BlcnR5IFwnJyArIGtleU5hbWUgKyAnXCcgb24gb2JqZWN0OiAnICsgKDAsIF9lbWJlclV0aWxzLmluc3BlY3QpKG9iaikpOwogICAgfQogICAgZnVuY3Rpb24gQWxpYXNlZFByb3BlcnR5X29uZVdheVNldChvYmosIGtleU5hbWUsIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkob2JqLCBrZXlOYW1lLCBudWxsKTsKICAgICAgICByZXR1cm4gX3NldDIob2JqLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICB9CiAgICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIEVtYmVyIERhdGEuCiAgICBBbGlhc2VkUHJvcGVydHkucHJvdG90eXBlLl9tZXRhID0gdW5kZWZpbmVkOwogICAgQWxpYXNlZFByb3BlcnR5LnByb3RvdHlwZS5tZXRhID0gQ29tcHV0ZWRQcm9wZXJ0eS5wcm90b3R5cGUubWV0YTsKCiAgICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAgICovCiAgICAvKioKICAgICAgVXNlZCBpbnRlcm5hbGx5IHRvIGFsbG93IGNoYW5naW5nIHByb3BlcnRpZXMgaW4gYSBiYWNrd2FyZHMgY29tcGF0aWJsZSB3YXksIGFuZCBwcmludCBhIGhlbHBmdWwKICAgICAgZGVwcmVjYXRpb24gd2FybmluZy4KICAgIAogICAgICBAbWV0aG9kIGRlcHJlY2F0ZVByb3BlcnR5CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBhZGQgdGhlIGRlcHJlY2F0ZWQgcHJvcGVydHkgdG8uCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBkZXByZWNhdGVkS2V5IFRoZSBwcm9wZXJ0eSB0byBhZGQgKGFuZCBwcmludCBkZXByZWNhdGlvbiB3YXJuaW5ncyB1cG9uIGFjY2Vzc2luZykuCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuZXdLZXkgVGhlIHByb3BlcnR5IHRoYXQgd2lsbCBiZSBhbGlhc2VkLgogICAgICBAcHJpdmF0ZQogICAgICBAc2luY2UgMS43LjAKICAgICovCiAgICBmdW5jdGlvbiBkZXByZWNhdGVQcm9wZXJ0eShvYmplY3QsIGRlcHJlY2F0ZWRLZXksIG5ld0tleSwgb3B0aW9ucykgewogICAgICAgIGZ1bmN0aW9uIF9kZXByZWNhdGUoKSB7CiAgICAgICAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnVXNhZ2Ugb2YgYCcgKyBkZXByZWNhdGVkS2V5ICsgJ2AgaXMgZGVwcmVjYXRlZCwgdXNlIGAnICsgbmV3S2V5ICsgJ2AgaW5zdGVhZC4nLCBmYWxzZSwgb3B0aW9ucykpOwogICAgICAgIH0KICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqZWN0LCBkZXByZWNhdGVkS2V5LCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBfZGVwcmVjYXRlKCk7CiAgICAgICAgICAgICAgICBfc2V0Mih0aGlzLCBuZXdLZXksIHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBfZGVwcmVjYXRlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2dldCh0aGlzLCBuZXdLZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvdXRpbHMKICAgICovCiAgICAvKioKICAgICAgUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWQuIFRoaXMgYXZvaWRzIGVycm9ycwogICAgICBmcm9tIEpTTGludCBjb21wbGFpbmluZyBhYm91dCB1c2Ugb2YgPT0sIHdoaWNoIGNhbiBiZSB0ZWNobmljYWxseQogICAgICBjb25mdXNpbmcuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpc05vbmUoKTsgICAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNOb25lKG51bGwpOyAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzTm9uZSh1bmRlZmluZWQpOyAgICAgLy8gdHJ1ZQogICAgICBpc05vbmUoJycpOyAgICAgICAgICAgIC8vIGZhbHNlCiAgICAgIGlzTm9uZShbXSk7ICAgICAgICAgICAgLy8gZmFsc2UKICAgICAgaXNOb25lKGZ1bmN0aW9uKCkge30pOyAvLyBmYWxzZQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGlzTm9uZQogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVmFsdWUgdG8gdGVzdAogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gaXNOb25lKG9iaikgewogICAgICAgIHJldHVybiBvYmogPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQ7CiAgICB9CgogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvdXRpbHMKICAgICovCiAgICAvKioKICAgICAgVmVyaWZpZXMgdGhhdCBhIHZhbHVlIGlzIGBudWxsYCBvciBgdW5kZWZpbmVkYCwgYW4gZW1wdHkgc3RyaW5nLCBvciBhbiBlbXB0eQogICAgICBhcnJheS4KICAgIAogICAgICBDb25zdHJhaW5zIHRoZSBydWxlcyBvbiBgaXNOb25lYCBieSByZXR1cm5pbmcgdHJ1ZSBmb3IgZW1wdHkgc3RyaW5ncyBhbmQKICAgICAgZW1wdHkgYXJyYXlzLgogICAgCiAgICAgIElmIHRoZSB2YWx1ZSBpcyBhbiBvYmplY3Qgd2l0aCBhIGBzaXplYCBwcm9wZXJ0eSBvZiB0eXBlIG51bWJlciwgaXQgaXMgdXNlZAogICAgICB0byBjaGVjayBlbXB0aW5lc3MuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpc0VtcHR5KCk7ICAgICAgICAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzRW1wdHkobnVsbCk7ICAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNFbXB0eSh1bmRlZmluZWQpOyAgICAgICAgLy8gdHJ1ZQogICAgICBpc0VtcHR5KCcnKTsgICAgICAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzRW1wdHkoW10pOyAgICAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNFbXB0eSh7IHNpemU6IDB9KTsgICAgICAgLy8gdHJ1ZQogICAgICBpc0VtcHR5KHt9KTsgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KCdBZGFtIEhhd2tpbnMnKTsgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KFswLDEsMl0pOyAgICAgICAgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KCdcblx0Jyk7ICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KCcgICcpOyAgICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KHsgc2l6ZTogMSB9KSAgICAgICAvLyBmYWxzZQogICAgICBpc0VtcHR5KHsgc2l6ZTogKCkgPT4gMCB9KSAvLyBmYWxzZQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGlzRW1wdHkKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci91dGlscwogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICAgICAgdmFyIG5vbmUgPSBvYmogPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKG5vbmUpIHsKICAgICAgICAgICAgcmV0dXJuIG5vbmU7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb2JqLnNpemUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiAhb2JqLnNpemU7CiAgICAgICAgfQogICAgICAgIHZhciBvYmplY3RUeXBlID0gdHlwZW9mIG9iajsKICAgICAgICBpZiAob2JqZWN0VHlwZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgdmFyIHNpemUgPSBfZ2V0KG9iaiwgJ3NpemUnKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzaXplID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgcmV0dXJuICFzaXplOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb2JqLmxlbmd0aCA9PT0gJ251bWJlcicgJiYgb2JqZWN0VHlwZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gIW9iai5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3RUeXBlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICB2YXIgbGVuZ3RoID0gX2dldChvYmosICdsZW5ndGgnKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIWxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvdXRpbHMKICAgICovCiAgICAvKioKICAgICAgQSB2YWx1ZSBpcyBibGFuayBpZiBpdCBpcyBlbXB0eSBvciBhIHdoaXRlc3BhY2Ugc3RyaW5nLgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgaXNCbGFuayB9IGZyb20gJ0BlbWJlci91dGlscyc7CiAgICAKICAgICAgaXNCbGFuaygpOyAgICAgICAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzQmxhbmsobnVsbCk7ICAgICAgICAgICAgLy8gdHJ1ZQogICAgICBpc0JsYW5rKHVuZGVmaW5lZCk7ICAgICAgIC8vIHRydWUKICAgICAgaXNCbGFuaygnJyk7ICAgICAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzQmxhbmsoW10pOyAgICAgICAgICAgICAgLy8gdHJ1ZQogICAgICBpc0JsYW5rKCdcblx0Jyk7ICAgICAgICAgIC8vIHRydWUKICAgICAgaXNCbGFuaygnICAnKTsgICAgICAgICAgICAvLyB0cnVlCiAgICAgIGlzQmxhbmsoe30pOyAgICAgICAgICAgICAgLy8gZmFsc2UKICAgICAgaXNCbGFuaygnXG5cdCBIZWxsbycpOyAgICAvLyBmYWxzZQogICAgICBpc0JsYW5rKCdIZWxsbyB3b3JsZCcpOyAgIC8vIGZhbHNlCiAgICAgIGlzQmxhbmsoWzEsMiwzXSk7ICAgICAgICAgLy8gZmFsc2UKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBpc0JsYW5rCiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvdXRpbHMKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iaiBWYWx1ZSB0byB0ZXN0CiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgIEBzaW5jZSAxLjUuMAogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gaXNCbGFuayhvYmopIHsKICAgICAgICByZXR1cm4gaXNFbXB0eShvYmopIHx8IHR5cGVvZiBvYmogPT09ICdzdHJpbmcnICYmIC9cUy8udGVzdChvYmopID09PSBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICBAbW9kdWxlIEBlbWJlci91dGlscwogICAgKi8KICAgIC8qKgogICAgICBBIHZhbHVlIGlzIHByZXNlbnQgaWYgaXQgbm90IGBpc0JsYW5rYC4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGlzUHJlc2VudCgpOyAgICAgICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc1ByZXNlbnQobnVsbCk7ICAgICAgICAgICAgLy8gZmFsc2UKICAgICAgaXNQcmVzZW50KHVuZGVmaW5lZCk7ICAgICAgIC8vIGZhbHNlCiAgICAgIGlzUHJlc2VudCgnJyk7ICAgICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc1ByZXNlbnQoJyAgJyk7ICAgICAgICAgICAgLy8gZmFsc2UKICAgICAgaXNQcmVzZW50KCdcblx0Jyk7ICAgICAgICAgIC8vIGZhbHNlCiAgICAgIGlzUHJlc2VudChbXSk7ICAgICAgICAgICAgICAvLyBmYWxzZQogICAgICBpc1ByZXNlbnQoeyBsZW5ndGg6IDAgfSkgICAgLy8gZmFsc2UKICAgICAgaXNQcmVzZW50KGZhbHNlKTsgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KHRydWUpOyAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KCdzdHJpbmcnKTsgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KDApOyAgICAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KGZ1bmN0aW9uKCkge30pICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KHt9KTsgICAgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KGZhbHNlKTsgICAgICAgICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KCdcblx0IEhlbGxvJyk7ICAgIC8vIHRydWUKICAgICAgaXNQcmVzZW50KFsxLDIsM10pOyAgICAgICAgIC8vIHRydWUKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBpc1ByZXNlbnQKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci91dGlscwogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIFZhbHVlIHRvIHRlc3QKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgQHNpbmNlIDEuOC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBpc1ByZXNlbnQob2JqKSB7CiAgICAgICAgcmV0dXJuICFpc0JsYW5rKG9iaik7CiAgICB9CgogICAgLyoqCiAgICAgQG1vZHVsZSBlbWJlcgogICAgKi8KICAgIC8qKgogICAgICBIZWxwZXIgY2xhc3MgdGhhdCBhbGxvd3MgeW91IHRvIHJlZ2lzdGVyIHlvdXIgbGlicmFyeSB3aXRoIEVtYmVyLgogICAgCiAgICAgIFNpbmdsZXRvbiBjcmVhdGVkIGF0IGBFbWJlci5saWJyYXJpZXNgLgogICAgCiAgICAgIEBjbGFzcyBMaWJyYXJpZXMKICAgICAgQGNvbnN0cnVjdG9yCiAgICAgIEBwcml2YXRlCiAgICAqLwoKICAgIHZhciBMaWJyYXJpZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gTGlicmFyaWVzKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIExpYnJhcmllcyk7CgogICAgICAgICAgICB0aGlzLl9yZWdpc3RyeSA9IFtdOwogICAgICAgICAgICB0aGlzLl9jb3JlTGliSW5kZXggPSAwOwogICAgICAgIH0KCiAgICAgICAgTGlicmFyaWVzLnByb3RvdHlwZS5fZ2V0TGlicmFyeUJ5TmFtZSA9IGZ1bmN0aW9uIF9nZXRMaWJyYXJ5QnlOYW1lKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGxpYnMgPSB0aGlzLl9yZWdpc3RyeTsKICAgICAgICAgICAgdmFyIGNvdW50ID0gbGlicy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGxpYnNbaV0ubmFtZSA9PT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBsaWJzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfTsKCiAgICAgICAgTGlicmFyaWVzLnByb3RvdHlwZS5yZWdpc3RlciA9IGZ1bmN0aW9uIHJlZ2lzdGVyKG5hbWUsIHZlcnNpb24sIGlzQ29yZUxpYnJhcnkpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5fcmVnaXN0cnkubGVuZ3RoOwogICAgICAgICAgICBpZiAoIXRoaXMuX2dldExpYnJhcnlCeU5hbWUobmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc0NvcmVMaWJyYXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSB0aGlzLl9jb3JlTGliSW5kZXgrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lzdHJ5LnNwbGljZShpbmRleCwgMCwgeyBuYW1lOiBuYW1lLCB2ZXJzaW9uOiB2ZXJzaW9uIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgKHRydWUgJiYgKDAsIF9kZWJ1Zy53YXJuKSgnTGlicmFyeSAiJyArIG5hbWUgKyAnIiBpcyBhbHJlYWR5IHJlZ2lzdGVyZWQgd2l0aCBFbWJlci4nLCBmYWxzZSwgewogICAgICAgICAgICAgICAgICAgIGlkOiAnZW1iZXItbWV0YWwubGlicmFyaWVzLXJlZ2lzdGVyJwogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgTGlicmFyaWVzLnByb3RvdHlwZS5yZWdpc3RlckNvcmVMaWJyYXJ5ID0gZnVuY3Rpb24gcmVnaXN0ZXJDb3JlTGlicmFyeShuYW1lLCB2ZXJzaW9uKSB7CiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXIobmFtZSwgdmVyc2lvbiwgdHJ1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgTGlicmFyaWVzLnByb3RvdHlwZS5kZVJlZ2lzdGVyID0gZnVuY3Rpb24gZGVSZWdpc3RlcihuYW1lKSB7CiAgICAgICAgICAgIHZhciBsaWIgPSB0aGlzLl9nZXRMaWJyYXJ5QnlOYW1lKG5hbWUpOwogICAgICAgICAgICB2YXIgaW5kZXggPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChsaWIpIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gdGhpcy5fcmVnaXN0cnkuaW5kZXhPZihsaWIpOwogICAgICAgICAgICAgICAgdGhpcy5fcmVnaXN0cnkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHJldHVybiBMaWJyYXJpZXM7CiAgICB9KCk7CgogICAgaWYgKGZhbHNlKSB7CiAgICAgICAgTGlicmFyaWVzLnByb3RvdHlwZS5pc1JlZ2lzdGVyZWQgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICByZXR1cm4gISF0aGlzLl9nZXRMaWJyYXJ5QnlOYW1lKG5hbWUpOwogICAgICAgIH07CiAgICB9CiAgICBpZiAodHJ1ZSkgewogICAgICAgIExpYnJhcmllcy5wcm90b3R5cGUubG9nVmVyc2lvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBsaWJzID0gdGhpcy5fcmVnaXN0cnk7CiAgICAgICAgICAgIHZhciBuYW1lTGVuZ3RocyA9IGxpYnMubWFwKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX2dldChpdGVtLCAnbmFtZS5sZW5ndGgnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBtYXhOYW1lTGVuZ3RoID0gTWF0aC5tYXguYXBwbHkobnVsbCwgbmFtZUxlbmd0aHMpOwogICAgICAgICAgICAoMCwgX2RlYnVnLmRlYnVnKSgnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBsaWIgPSBsaWJzW2ldOwogICAgICAgICAgICAgICAgdmFyIHNwYWNlcyA9IG5ldyBBcnJheShtYXhOYW1lTGVuZ3RoIC0gbGliLm5hbWUubGVuZ3RoICsgMSkuam9pbignICcpOwogICAgICAgICAgICAgICAgKDAsIF9kZWJ1Zy5kZWJ1ZykoW2xpYi5uYW1lLCBzcGFjZXMsICcgOiAnLCBsaWIudmVyc2lvbl0uam9pbignJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICgwLCBfZGVidWcuZGVidWcpKCctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyk7CiAgICAgICAgfTsKICAgIH0KICAgIHZhciBMSUJSQVJJRVMgPSBuZXcgTGlicmFyaWVzKCk7CiAgICBMSUJSQVJJRVMucmVnaXN0ZXJDb3JlTGlicmFyeSgnRW1iZXInLCBfdmVyc2lvbi5kZWZhdWx0KTsKCiAgICAvKioKICAgICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAgICovCiAgICAvKioKICAgICAgVG8gZ2V0IG11bHRpcGxlIHByb3BlcnRpZXMgYXQgb25jZSwgY2FsbCBgZ2V0UHJvcGVydGllc2AKICAgICAgd2l0aCBhbiBvYmplY3QgZm9sbG93ZWQgYnkgYSBsaXN0IG9mIHN0cmluZ3Mgb3IgYW4gYXJyYXk6CiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBnZXRQcm9wZXJ0aWVzIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgZ2V0UHJvcGVydGllcyhyZWNvcmQsICdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCAnemlwQ29kZScpOwogICAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgICBgYGAKICAgIAogICAgICBpcyBlcXVpdmFsZW50IHRvOgogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IHsgZ2V0UHJvcGVydGllcyB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIGdldFByb3BlcnRpZXMocmVjb3JkLCBbJ2ZpcnN0TmFtZScsICdsYXN0TmFtZScsICd6aXBDb2RlJ10pOwogICAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGdldFByb3BlcnRpZXMKICAgICAgQHN0YXRpYwogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iagogICAgICBAcGFyYW0ge1N0cmluZy4uLnxBcnJheX0gbGlzdCBvZiBrZXlzIHRvIGdldAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG9iaikgewogICAgICAgIHZhciByZXQgPSB7fTsKICAgICAgICB2YXIgcHJvcGVydHlOYW1lcyA9IGFyZ3VtZW50czsKICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgQXJyYXkuaXNBcnJheShhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICBwcm9wZXJ0eU5hbWVzID0gYXJndW1lbnRzWzFdOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgaSA8IHByb3BlcnR5TmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmV0W3Byb3BlcnR5TmFtZXNbaV1dID0gX2dldChvYmosIHByb3BlcnR5TmFtZXNbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIC8qKgogICAgIEBtb2R1bGUgQGVtYmVyL29iamVjdAogICAgKi8KICAgIC8qKgogICAgICBTZXQgYSBsaXN0IG9mIHByb3BlcnRpZXMgb24gYW4gb2JqZWN0LiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBzZXQgaW5zaWRlCiAgICAgIGEgc2luZ2xlIGBiZWdpblByb3BlcnR5Q2hhbmdlc2AgYW5kIGBlbmRQcm9wZXJ0eUNoYW5nZXNgIGJhdGNoLCBzbwogICAgICBvYnNlcnZlcnMgd2lsbCBiZSBidWZmZXJlZC4KICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgbGV0IGFuT2JqZWN0ID0gRW1iZXJPYmplY3QuY3JlYXRlKCk7CiAgICAKICAgICAgYW5PYmplY3Quc2V0UHJvcGVydGllcyh7CiAgICAgICAgZmlyc3ROYW1lOiAnU3RhbmxleScsCiAgICAgICAgbGFzdE5hbWU6ICdTdHVhcnQnLAogICAgICAgIGFnZTogMjEKICAgICAgfSk7CiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2Qgc2V0UHJvcGVydGllcwogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdAogICAgICBAcGFyYW0gb2JqCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwcm9wZXJ0aWVzCiAgICAgIEByZXR1cm4gcHJvcGVydGllcwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gc2V0UHJvcGVydGllcyhvYmosIHByb3BlcnRpZXMpIHsKICAgICAgICBpZiAocHJvcGVydGllcyA9PT0gbnVsbCB8fCB0eXBlb2YgcHJvcGVydGllcyAhPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgcmV0dXJuIHByb3BlcnRpZXM7CiAgICAgICAgfQogICAgICAgIGNoYW5nZVByb3BlcnRpZXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcHJvcHMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lID0gcHJvcHNbaV07CiAgICAgICAgICAgICAgICBfc2V0MihvYmosIHByb3BlcnR5TmFtZSwgcHJvcGVydGllc1twcm9wZXJ0eU5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwcm9wZXJ0aWVzOwogICAgfQoKICAgIC8vIFRPRE8sIHRoaXMgb25seSBkZXBlbmRzIG9uIGNvbnRleHQsIG90aGVyd2lzZSBpdCBjb3VsZCBiZSBpbiB1dGlscwogICAgLy8gbW92ZSBpbnRvIGl0cyBvd24gcGFja2FnZQogICAgLy8gaXQgaXMgbmVlZGVkIGJ5IE1peGluIGZvciBjbGFzc1RvU3RyaW5nCiAgICAvLyBtYXliZSBtb3ZlIGl0IGludG8gZW52aXJvbm1lbnQKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgc2VhcmNoRGlzYWJsZWQgPSBmYWxzZTsKICAgIHZhciBmbGFncyA9IHsKICAgICAgICBfc2V0OiAwLAogICAgICAgIF91bnByb2Nlc3NlZE5hbWVzcGFjZXM6IGZhbHNlLAogICAgICAgIGdldCB1bnByb2Nlc3NlZE5hbWVzcGFjZXMoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl91bnByb2Nlc3NlZE5hbWVzcGFjZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQgdW5wcm9jZXNzZWROYW1lc3BhY2VzKHYpIHsKICAgICAgICAgICAgdGhpcy5fc2V0Kys7CiAgICAgICAgICAgIHRoaXMuX3VucHJvY2Vzc2VkTmFtZXNwYWNlcyA9IHY7CiAgICAgICAgfQogICAgfTsKICAgIHZhciB1bnByb2Nlc3NlZE1peGlucyA9IGZhbHNlOwogICAgdmFyIE5BTUVTUEFDRVMgPSBbXTsKICAgIHZhciBOQU1FU1BBQ0VTX0JZX0lEID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGZ1bmN0aW9uIGFkZE5hbWVzcGFjZShuYW1lc3BhY2UpIHsKICAgICAgICBmbGFncy51bnByb2Nlc3NlZE5hbWVzcGFjZXMgPSB0cnVlOwogICAgICAgIE5BTUVTUEFDRVMucHVzaChuYW1lc3BhY2UpOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlTmFtZXNwYWNlKG5hbWVzcGFjZSkgewogICAgICAgIHZhciBuYW1lID0gKDAsIF9lbWJlclV0aWxzLmdldE5hbWUpKG5hbWVzcGFjZSk7CiAgICAgICAgZGVsZXRlIE5BTUVTUEFDRVNfQllfSURbbmFtZV07CiAgICAgICAgTkFNRVNQQUNFUy5zcGxpY2UoTkFNRVNQQUNFUy5pbmRleE9mKG5hbWVzcGFjZSksIDEpOwogICAgICAgIGlmIChuYW1lIGluIF9lbWJlckVudmlyb25tZW50LmNvbnRleHQubG9va3VwICYmIG5hbWVzcGFjZSA9PT0gX2VtYmVyRW52aXJvbm1lbnQuY29udGV4dC5sb29rdXBbbmFtZV0pIHsKICAgICAgICAgICAgX2VtYmVyRW52aXJvbm1lbnQuY29udGV4dC5sb29rdXBbbmFtZV0gPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmluZE5hbWVzcGFjZXMoKSB7CiAgICAgICAgaWYgKCFmbGFncy51bnByb2Nlc3NlZE5hbWVzcGFjZXMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgbG9va3VwID0gX2VtYmVyRW52aXJvbm1lbnQuY29udGV4dC5sb29rdXA7CiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhsb29rdXApOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgLy8gT25seSBwcm9jZXNzIGVudGl0aWVzIHRoYXQgc3RhcnQgd2l0aCB1cHBlcmNhc2UgQS1aCiAgICAgICAgICAgIGlmICghaXNVcHBlcmNhc2Uoa2V5LmNoYXJDb2RlQXQoMCkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb2JqID0gdHJ5SXNOYW1lc3BhY2UobG9va3VwLCBrZXkpOwogICAgICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyVXRpbHMuc2V0TmFtZSkob2JqLCBrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmluZE5hbWVzcGFjZShuYW1lKSB7CiAgICAgICAgaWYgKCFzZWFyY2hEaXNhYmxlZCkgewogICAgICAgICAgICBwcm9jZXNzQWxsTmFtZXNwYWNlcygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTkFNRVNQQUNFU19CWV9JRFtuYW1lXTsKICAgIH0KICAgIGZ1bmN0aW9uIHByb2Nlc3NOYW1lc3BhY2UobmFtZXNwYWNlKSB7CiAgICAgICAgX3Byb2Nlc3NOYW1lc3BhY2UoW25hbWVzcGFjZS50b1N0cmluZygpXSwgbmFtZXNwYWNlLCBuZXcgU2V0KCkpOwogICAgfQogICAgZnVuY3Rpb24gcHJvY2Vzc0FsbE5hbWVzcGFjZXMoKSB7CiAgICAgICAgdmFyIHVucHJvY2Vzc2VkTmFtZXNwYWNlcyA9IGZsYWdzLnVucHJvY2Vzc2VkTmFtZXNwYWNlczsKICAgICAgICBpZiAodW5wcm9jZXNzZWROYW1lc3BhY2VzKSB7CiAgICAgICAgICAgIGZpbmROYW1lc3BhY2VzKCk7CiAgICAgICAgICAgIGZsYWdzLnVucHJvY2Vzc2VkTmFtZXNwYWNlcyA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAodW5wcm9jZXNzZWROYW1lc3BhY2VzIHx8IHVucHJvY2Vzc2VkTWl4aW5zKSB7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2VzID0gTkFNRVNQQUNFUzsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lc3BhY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBwcm9jZXNzTmFtZXNwYWNlKG5hbWVzcGFjZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVucHJvY2Vzc2VkTWl4aW5zID0gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gY2xhc3NUb1N0cmluZygpIHsKICAgICAgICB2YXIgbmFtZSA9ICgwLCBfZW1iZXJVdGlscy5nZXROYW1lKSh0aGlzKTsKICAgICAgICBpZiAobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgIH0KICAgICAgICBuYW1lID0gY2FsY3VsYXRlVG9TdHJpbmcodGhpcyk7CiAgICAgICAgKDAsIF9lbWJlclV0aWxzLnNldE5hbWUpKHRoaXMsIG5hbWUpOwogICAgICAgIHJldHVybiBuYW1lOwogICAgfQogICAgZnVuY3Rpb24gaXNTZWFyY2hEaXNhYmxlZCgpIHsKICAgICAgICByZXR1cm4gc2VhcmNoRGlzYWJsZWQ7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRTZWFyY2hEaXNhYmxlZChmbGFnKSB7CiAgICAgICAgc2VhcmNoRGlzYWJsZWQgPSAhIWZsYWc7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRVbnByb2Nlc3NlZE1peGlucygpIHsKICAgICAgICB1bnByb2Nlc3NlZE1peGlucyA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBfcHJvY2Vzc05hbWVzcGFjZShwYXRocywgcm9vdCwgc2VlbikgewogICAgICAgIHZhciBpZHggPSBwYXRocy5sZW5ndGg7CiAgICAgICAgdmFyIGlkID0gcGF0aHMuam9pbignLicpOwogICAgICAgIE5BTUVTUEFDRVNfQllfSURbaWRdID0gcm9vdDsKICAgICAgICAoMCwgX2VtYmVyVXRpbHMuc2V0TmFtZSkocm9vdCwgaWQpOwogICAgICAgIC8vIExvb3Agb3ZlciBhbGwgb2YgdGhlIGtleXMgaW4gdGhlIG5hbWVzcGFjZSwgbG9va2luZyBmb3IgY2xhc3NlcwogICAgICAgIGZvciAodmFyIGtleSBpbiByb290KSB7CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChyb290LCBrZXkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb2JqID0gcm9vdFtrZXldOwogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcHJvY2Vzc2luZyB0aGUgYEVtYmVyYCBuYW1lc3BhY2UsIGZvciBleGFtcGxlLCB0aGUKICAgICAgICAgICAgLy8gYHBhdGhzYCB3aWxsIHN0YXJ0IHdpdGggYFsiRW1iZXIiXWAuIEV2ZXJ5IGl0ZXJhdGlvbiB0aHJvdWdoCiAgICAgICAgICAgIC8vIHRoZSBsb29wIHdpbGwgdXBkYXRlIHRoZSAqKnNlY29uZCoqIGVsZW1lbnQgb2YgdGhpcyBsaXN0IHdpdGgKICAgICAgICAgICAgLy8gdGhlIGtleSwgc28gcHJvY2Vzc2luZyBgRW1iZXIuVmlld2Agd2lsbCBtYWtlIHRoZSBBcnJheQogICAgICAgICAgICAvLyBgWydFbWJlcicsICdWaWV3J11gLgogICAgICAgICAgICBwYXRoc1tpZHhdID0ga2V5OwogICAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGZvdW5kIGFuIHVucHJvY2Vzc2VkIGNsYXNzCiAgICAgICAgICAgIGlmIChvYmogJiYgb2JqLnRvU3RyaW5nID09PSBjbGFzc1RvU3RyaW5nICYmICgwLCBfZW1iZXJVdGlscy5nZXROYW1lKShvYmopID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNsYXNzJyBgdG9TdHJpbmdgIHdpdGggdGhlIGRvdC1zZXBhcmF0ZWQgcGF0aAogICAgICAgICAgICAgICAgKDAsIF9lbWJlclV0aWxzLnNldE5hbWUpKG9iaiwgcGF0aHMuam9pbignLicpKTsKICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQgbmVzdGVkIG5hbWVzcGFjZXMKICAgICAgICAgICAgfSBlbHNlIGlmIChvYmogJiYgb2JqLmlzTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAvLyBTa2lwIGFsaWFzZWQgbmFtZXNwYWNlcwogICAgICAgICAgICAgICAgaWYgKHNlZW4uaGFzKG9iaikpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlZW4uYWRkKG9iaik7CiAgICAgICAgICAgICAgICAvLyBQcm9jZXNzIHRoZSBjaGlsZCBuYW1lc3BhY2UKICAgICAgICAgICAgICAgIF9wcm9jZXNzTmFtZXNwYWNlKHBhdGhzLCBvYmosIHNlZW4pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBhdGhzLmxlbmd0aCA9IGlkeDsgLy8gY3V0IG91dCBsYXN0IGl0ZW0KICAgIH0KICAgIGZ1bmN0aW9uIGlzVXBwZXJjYXNlKGNvZGUpIHsKICAgICAgICByZXR1cm4gY29kZSA+PSA2NSAmJiBjb2RlIDw9IDkwIC8vIEEKICAgICAgICA7IC8vIFoKICAgIH0KICAgIGZ1bmN0aW9uIHRyeUlzTmFtZXNwYWNlKGxvb2t1cCwgcHJvcCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBvYmogPSBsb29rdXBbcHJvcF07CiAgICAgICAgICAgIHJldHVybiAob2JqICE9PSBudWxsICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmIG9iai5pc05hbWVzcGFjZSAmJiBvYmo7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBjb250aW51ZQogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVRvU3RyaW5nKHRhcmdldCkgewogICAgICAgIHZhciBzdHIgPSB2b2lkIDA7CiAgICAgICAgaWYgKCFzZWFyY2hEaXNhYmxlZCkgewogICAgICAgICAgICBwcm9jZXNzQWxsTmFtZXNwYWNlcygpOwogICAgICAgICAgICBzdHIgPSAoMCwgX2VtYmVyVXRpbHMuZ2V0TmFtZSkodGFyZ2V0KTsKICAgICAgICAgICAgaWYgKHN0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXBlcmNsYXNzID0gdGFyZ2V0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBzdXBlcmNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHN1cGVyY2xhc3MpOwogICAgICAgICAgICAgICAgaWYgKHN1cGVyY2xhc3MgPT09IEZ1bmN0aW9uLnByb3RvdHlwZSB8fCBzdXBlcmNsYXNzID09PSBPYmplY3QucHJvdG90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHIgPSAoMCwgX2VtYmVyVXRpbHMuZ2V0TmFtZSkodGFyZ2V0KTsKICAgICAgICAgICAgICAgIGlmIChzdHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN0ciA9ICcoc3ViY2xhc3Mgb2YgJyArIHN0ciArICcpJzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoc3RyID09PSB2b2lkIDApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyIHx8ICcodW5rbm93biknOwogICAgfQoKICAgIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgICAqLwogICAgdmFyIGFfY29uY2F0ID0gQXJyYXkucHJvdG90eXBlLmNvbmNhdDsKICAgIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKCiAgICBmdW5jdGlvbiBpc01ldGhvZChvYmopIHsKICAgICAgICByZXR1cm4gJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIG9iaiAmJiBvYmouaXNNZXRob2QgIT09IGZhbHNlICYmIG9iaiAhPT0gQm9vbGVhbiAmJiBvYmogIT09IE9iamVjdCAmJiBvYmogIT09IE51bWJlciAmJiBvYmogIT09IEFycmF5ICYmIG9iaiAhPT0gRGF0ZSAmJiBvYmogIT09IFN0cmluZzsKICAgIH0KICAgIHZhciBDT05USU5VRSA9IHt9OwogICAgZnVuY3Rpb24gbWl4aW5Qcm9wZXJ0aWVzKG1peGluc01ldGEsIG1peGluKSB7CiAgICAgICAgaWYgKG1peGluIGluc3RhbmNlb2YgTWl4aW4pIHsKICAgICAgICAgICAgaWYgKG1peGluc01ldGEuaGFzTWl4aW4obWl4aW4pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gQ09OVElOVUU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWl4aW5zTWV0YS5hZGRNaXhpbihtaXhpbik7CiAgICAgICAgICAgIHJldHVybiBtaXhpbi5wcm9wZXJ0aWVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBtaXhpbjsgLy8gYXBwbHkgYW5vbnltb3VzIG1peGluIHByb3BlcnRpZXMKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjb25jYXRlbmF0ZWRNaXhpblByb3BlcnRpZXMoY29uY2F0UHJvcCwgcHJvcHMsIHZhbHVlcywgYmFzZSkgewogICAgICAgIC8vIHJlc2V0IGJlZm9yZSBhZGRpbmcgZWFjaCBuZXcgbWl4aW4gdG8gcGlja3VwIGNvbmNhdHMgZnJvbSBwcmV2aW91cwogICAgICAgIHZhciBjb25jYXRzID0gdmFsdWVzW2NvbmNhdFByb3BdIHx8IGJhc2VbY29uY2F0UHJvcF07CiAgICAgICAgaWYgKHByb3BzW2NvbmNhdFByb3BdKSB7CiAgICAgICAgICAgIGNvbmNhdHMgPSBjb25jYXRzID8gYV9jb25jYXQuY2FsbChjb25jYXRzLCBwcm9wc1tjb25jYXRQcm9wXSkgOiBwcm9wc1tjb25jYXRQcm9wXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbmNhdHM7CiAgICB9CiAgICBmdW5jdGlvbiBnaXZlRGVzY3JpcHRvclN1cGVyKG1ldGEkJDEsIGtleSwgcHJvcGVydHksIHZhbHVlcywgZGVzY3MsIGJhc2UpIHsKICAgICAgICB2YXIgc3VwZXJQcm9wZXJ0eSA9IHZvaWQgMDsKICAgICAgICAvLyBDb21wdXRlZCBwcm9wZXJ0aWVzIG92ZXJyaWRlIG1ldGhvZHMsIGFuZCBkbyBub3QgY2FsbCBzdXBlciB0byB0aGVtCiAgICAgICAgaWYgKHZhbHVlc1trZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgLy8gRmluZCB0aGUgb3JpZ2luYWwgZGVzY3JpcHRvciBpbiBhIHBhcmVudCBtaXhpbgogICAgICAgICAgICBzdXBlclByb3BlcnR5ID0gZGVzY3Nba2V5XTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgd2UgZGlkbid0IGZpbmQgdGhlIG9yaWdpbmFsIGRlc2NyaXB0b3IgaW4gYSBwYXJlbnQgbWl4aW4sIGZpbmQKICAgICAgICAvLyBpdCBvbiB0aGUgb3JpZ2luYWwgb2JqZWN0LgogICAgICAgIGlmICghc3VwZXJQcm9wZXJ0eSkgewogICAgICAgICAgICBzdXBlclByb3BlcnR5ID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikoYmFzZSwga2V5LCBtZXRhJCQxKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1cGVyUHJvcGVydHkgPT09IHVuZGVmaW5lZCB8fCAhKHN1cGVyUHJvcGVydHkgaW5zdGFuY2VvZiBDb21wdXRlZFByb3BlcnR5KSkgewogICAgICAgICAgICByZXR1cm4gcHJvcGVydHk7CiAgICAgICAgfQogICAgICAgIC8vIFNpbmNlIG11bHRpcGxlIG1peGlucyBtYXkgaW5oZXJpdCBmcm9tIHRoZSBzYW1lIHBhcmVudCwgd2UgbmVlZAogICAgICAgIC8vIHRvIGNsb25lIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBzbyB0aGF0IG90aGVyIG1peGlucyBkbyBub3QgcmVjZWl2ZQogICAgICAgIC8vIHRoZSB3cmFwcGVkIHZlcnNpb24uCiAgICAgICAgcHJvcGVydHkgPSBPYmplY3QuY3JlYXRlKHByb3BlcnR5KTsKICAgICAgICBwcm9wZXJ0eS5fZ2V0dGVyID0gKDAsIF9lbWJlclV0aWxzLndyYXApKHByb3BlcnR5Ll9nZXR0ZXIsIHN1cGVyUHJvcGVydHkuX2dldHRlcik7CiAgICAgICAgaWYgKHN1cGVyUHJvcGVydHkuX3NldHRlcikgewogICAgICAgICAgICBpZiAocHJvcGVydHkuX3NldHRlcikgewogICAgICAgICAgICAgICAgcHJvcGVydHkuX3NldHRlciA9ICgwLCBfZW1iZXJVdGlscy53cmFwKShwcm9wZXJ0eS5fc2V0dGVyLCBzdXBlclByb3BlcnR5Ll9zZXR0ZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJvcGVydHkuX3NldHRlciA9IHN1cGVyUHJvcGVydHkuX3NldHRlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJvcGVydHk7CiAgICB9CiAgICBmdW5jdGlvbiBnaXZlTWV0aG9kU3VwZXIob2JqLCBrZXksIG1ldGhvZCwgdmFsdWVzLCBkZXNjcykgewogICAgICAgIC8vIE1ldGhvZHMgb3ZlcndyaXRlIGNvbXB1dGVkIHByb3BlcnRpZXMsIGFuZCBkbyBub3QgY2FsbCBzdXBlciB0byB0aGVtLgogICAgICAgIGlmIChkZXNjc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZDsKICAgICAgICB9CiAgICAgICAgLy8gRmluZCB0aGUgb3JpZ2luYWwgbWV0aG9kIGluIGEgcGFyZW50IG1peGluCiAgICAgICAgdmFyIHN1cGVyTWV0aG9kID0gdmFsdWVzW2tleV07CiAgICAgICAgLy8gSWYgd2UgZGlkbid0IGZpbmQgdGhlIG9yaWdpbmFsIHZhbHVlIGluIGEgcGFyZW50IG1peGluLCBmaW5kIGl0IGluCiAgICAgICAgLy8gdGhlIG9yaWdpbmFsIG9iamVjdAogICAgICAgIGlmIChzdXBlck1ldGhvZCA9PT0gdW5kZWZpbmVkICYmICgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKG9iaiwga2V5KSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHN1cGVyTWV0aG9kID0gb2JqW2tleV07CiAgICAgICAgfQogICAgICAgIC8vIE9ubHkgd3JhcCB0aGUgbmV3IG1ldGhvZCBpZiB0aGUgb3JpZ2luYWwgbWV0aG9kIHdhcyBhIGZ1bmN0aW9uCiAgICAgICAgaWYgKHR5cGVvZiBzdXBlck1ldGhvZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gKDAsIF9lbWJlclV0aWxzLndyYXApKG1ldGhvZCwgc3VwZXJNZXRob2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWV0aG9kOwogICAgfQogICAgZnVuY3Rpb24gYXBwbHlDb25jYXRlbmF0ZWRQcm9wZXJ0aWVzKG9iaiwga2V5LCB2YWx1ZSwgdmFsdWVzKSB7CiAgICAgICAgdmFyIGJhc2VWYWx1ZSA9IHZhbHVlc1trZXldIHx8IG9ialtrZXldOwogICAgICAgIHZhciByZXQgPSAoMCwgX2VtYmVyVXRpbHMubWFrZUFycmF5KShiYXNlVmFsdWUpLmNvbmNhdCgoMCwgX2VtYmVyVXRpbHMubWFrZUFycmF5KSh2YWx1ZSkpOwogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIC8vIGl0IGlzIHBvc3NpYmxlIHRvIHVzZSBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzIHdpdGggc3RyaW5ncyAod2hpY2ggY2Fubm90IGJlIGZyb3plbikKICAgICAgICAgICAgLy8gb25seSBmcmVlemUgb2JqZWN0cy4uLgogICAgICAgICAgICBpZiAodHlwZW9mIHJldCA9PT0gJ29iamVjdCcgJiYgcmV0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IG11dGF0aW5nIGBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzYCBhcnJheSBhZnRlciBpdCBpcyBhcHBsaWVkCiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKHJldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5TWVyZ2VkUHJvcGVydGllcyhvYmosIGtleSwgdmFsdWUsIHZhbHVlcykgewogICAgICAgIHZhciBiYXNlVmFsdWUgPSB2YWx1ZXNba2V5XSB8fCBvYmpba2V5XTsKICAgICAgICAodHJ1ZSAmJiAhKCFpc0FycmF5KHZhbHVlKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgcGFzc2VkIGluIGAnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpICsgJ2AgYXMgdGhlIHZhbHVlIGZvciBgJyArIGtleSArICdgIGJ1dCBgJyArIGtleSArICdgIGNhbm5vdCBiZSBhbiBBcnJheScsICFpc0FycmF5KHZhbHVlKSkpOwoKICAgICAgICBpZiAoIWJhc2VWYWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdCYXNlID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgYmFzZVZhbHVlKTsKICAgICAgICB2YXIgaGFzRnVuY3Rpb24gPSBmYWxzZTsKICAgICAgICBmb3IgKHZhciBwcm9wIGluIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVmFsdWUgPSB2YWx1ZVtwcm9wXTsKICAgICAgICAgICAgaWYgKGlzTWV0aG9kKHByb3BWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIC8vIFRPRE86IHN1cHBvcnQgZm9yIENvbXB1dGVkIFByb3BlcnRpZXMsIGV0Yz8KICAgICAgICAgICAgICAgIGhhc0Z1bmN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIG5ld0Jhc2VbcHJvcF0gPSBnaXZlTWV0aG9kU3VwZXIob2JqLCBwcm9wLCBwcm9wVmFsdWUsIGJhc2VWYWx1ZSwge30pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3QmFzZVtwcm9wXSA9IHByb3BWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzRnVuY3Rpb24pIHsKICAgICAgICAgICAgbmV3QmFzZS5fc3VwZXIgPSBfZW1iZXJVdGlscy5ST09UOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3QmFzZTsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZE5vcm1hbGl6ZWRQcm9wZXJ0eShiYXNlLCBrZXksIHZhbHVlLCBtZXRhJCQxLCBkZXNjcywgdmFsdWVzLCBjb25jYXRzLCBtZXJnaW5ncykgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERlc2NyaXB0b3IpIHsKICAgICAgICAgICAgLy8gV3JhcCBkZXNjcmlwdG9yIGZ1bmN0aW9uIHRvIGltcGxlbWVudAogICAgICAgICAgICAvLyBfc3VwZXIoKSBpZiBuZWVkZWQKICAgICAgICAgICAgaWYgKHZhbHVlLl9nZXR0ZXIpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gZ2l2ZURlc2NyaXB0b3JTdXBlcihtZXRhJCQxLCBrZXksIHZhbHVlLCB2YWx1ZXMsIGRlc2NzLCBiYXNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXNjc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgIHZhbHVlc1trZXldID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjb25jYXRzICYmIGNvbmNhdHMuaW5kZXhPZihrZXkpID49IDAgfHwga2V5ID09PSAnY29uY2F0ZW5hdGVkUHJvcGVydGllcycgfHwga2V5ID09PSAnbWVyZ2VkUHJvcGVydGllcycpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gYXBwbHlDb25jYXRlbmF0ZWRQcm9wZXJ0aWVzKGJhc2UsIGtleSwgdmFsdWUsIHZhbHVlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWVyZ2luZ3MgJiYgbWVyZ2luZ3MuaW5kZXhPZihrZXkpID4gLTEpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gYXBwbHlNZXJnZWRQcm9wZXJ0aWVzKGJhc2UsIGtleSwgdmFsdWUsIHZhbHVlcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNNZXRob2QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGdpdmVNZXRob2RTdXBlcihiYXNlLCBrZXksIHZhbHVlLCB2YWx1ZXMsIGRlc2NzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXNjc1trZXldID0gdW5kZWZpbmVkOwogICAgICAgICAgICB2YWx1ZXNba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG1lcmdlTWl4aW5zKG1peGlucywgbWV0YSQkMSwgZGVzY3MsIHZhbHVlcywgYmFzZSwga2V5cykgewogICAgICAgIHZhciBjdXJyZW50TWl4aW4gPSB2b2lkIDAsCiAgICAgICAgICAgIHByb3BzID0gdm9pZCAwLAogICAgICAgICAgICBrZXkgPSB2b2lkIDAsCiAgICAgICAgICAgIGNvbmNhdHMgPSB2b2lkIDAsCiAgICAgICAgICAgIG1lcmdpbmdzID0gdm9pZCAwOwogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUtleXMoa2V5TmFtZSkgewogICAgICAgICAgICBkZWxldGUgZGVzY3Nba2V5TmFtZV07CiAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZXNba2V5TmFtZV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWl4aW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGN1cnJlbnRNaXhpbiA9IG1peGluc1tpXTsKICAgICAgICAgICAgKHRydWUgJiYgISh0eXBlb2YgY3VycmVudE1peGluID09PSAnb2JqZWN0JyAmJiBjdXJyZW50TWl4aW4gIT09IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGN1cnJlbnRNaXhpbikgIT09ICdbb2JqZWN0IEFycmF5XScpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRXhwZWN0ZWQgaGFzaCBvciBNaXhpbiBpbnN0YW5jZSwgZ290ICcgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoY3VycmVudE1peGluKSwgdHlwZW9mIGN1cnJlbnRNaXhpbiA9PT0gJ29iamVjdCcgJiYgY3VycmVudE1peGluICE9PSBudWxsICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChjdXJyZW50TWl4aW4pICE9PSAnW29iamVjdCBBcnJheV0nKSk7CgogICAgICAgICAgICBwcm9wcyA9IG1peGluUHJvcGVydGllcyhtZXRhJCQxLCBjdXJyZW50TWl4aW4pOwogICAgICAgICAgICBpZiAocHJvcHMgPT09IENPTlRJTlVFKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMpIHsKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB3aWxsTWVyZ2VNaXhpbiBhZnRlciAzLjQgYXMgaXQgd2FzIHVzZWQgZm9yIF9hY3Rpb25zCiAgICAgICAgICAgICAgICBpZiAoYmFzZS53aWxsTWVyZ2VNaXhpbikgewogICAgICAgICAgICAgICAgICAgIGJhc2Uud2lsbE1lcmdlTWl4aW4ocHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uY2F0cyA9IGNvbmNhdGVuYXRlZE1peGluUHJvcGVydGllcygnY29uY2F0ZW5hdGVkUHJvcGVydGllcycsIHByb3BzLCB2YWx1ZXMsIGJhc2UpOwogICAgICAgICAgICAgICAgbWVyZ2luZ3MgPSBjb25jYXRlbmF0ZWRNaXhpblByb3BlcnRpZXMoJ21lcmdlZFByb3BlcnRpZXMnLCBwcm9wcywgdmFsdWVzLCBiYXNlKTsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIHByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcm9wcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICBhZGROb3JtYWxpemVkUHJvcGVydHkoYmFzZSwga2V5LCBwcm9wc1trZXldLCBtZXRhJCQxLCBkZXNjcywgdmFsdWVzLCBjb25jYXRzLCBtZXJnaW5ncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBtYW51YWxseSBjb3B5IHRvU3RyaW5nKCkgYmVjYXVzZSBzb21lIEpTIGVuZ2luZXMgZG8gbm90IGVudW1lcmF0ZSBpdAogICAgICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpKSB7CiAgICAgICAgICAgICAgICAgICAgYmFzZS50b1N0cmluZyA9IHByb3BzLnRvU3RyaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRNaXhpbi5taXhpbnMpIHsKICAgICAgICAgICAgICAgIG1lcmdlTWl4aW5zKGN1cnJlbnRNaXhpbi5taXhpbnMsIG1ldGEkJDEsIGRlc2NzLCB2YWx1ZXMsIGJhc2UsIGtleXMpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRNaXhpbi5fd2l0aG91dCkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNaXhpbi5fd2l0aG91dC5mb3JFYWNoKHJlbW92ZUtleXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZm9sbG93QWxpYXMob2JqLCBkZXNjLCBkZXNjcywgdmFsdWVzKSB7CiAgICAgICAgdmFyIGFsdEtleSA9IGRlc2MubWV0aG9kTmFtZTsKICAgICAgICB2YXIgdmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9IHZvaWQgMDsKICAgICAgICBpZiAoZGVzY3NbYWx0S2V5XSB8fCB2YWx1ZXNbYWx0S2V5XSkgewogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlc1thbHRLZXldOwogICAgICAgICAgICBkZXNjID0gZGVzY3NbYWx0S2V5XTsKICAgICAgICB9IGVsc2UgaWYgKChwb3NzaWJsZURlc2MgPSAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKShvYmosIGFsdEtleSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGVzYyA9IHBvc3NpYmxlRGVzYzsKICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVzYyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdmFsdWUgPSBvYmpbYWx0S2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsgZGVzYzogZGVzYywgdmFsdWU6IHZhbHVlIH07CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksIHBhdGhzLCB1cGRhdGVNZXRob2QpIHsKICAgICAgICBpZiAocGF0aHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdXBkYXRlTWV0aG9kKG9iaiwgcGF0aHNbaV0sIG51bGwsIGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiByZXBsYWNlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBwcmV2LCBuZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBwcmV2ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHVwZGF0ZU9ic2VydmVyc0FuZExpc3RlbmVycyhvYmosIGtleSwgKDAsIF9lbWJlclV0aWxzLmdldE9ic2VydmVycykocHJldiksIHJlbW92ZU9ic2VydmVyKTsKICAgICAgICAgICAgdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCAoMCwgX2VtYmVyVXRpbHMuZ2V0TGlzdGVuZXJzKShwcmV2KSwgcmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG5leHQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdXBkYXRlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCAoMCwgX2VtYmVyVXRpbHMuZ2V0T2JzZXJ2ZXJzKShuZXh0KSwgYWRkT2JzZXJ2ZXIpOwogICAgICAgICAgICB1cGRhdGVPYnNlcnZlcnNBbmRMaXN0ZW5lcnMob2JqLCBrZXksICgwLCBfZW1iZXJVdGlscy5nZXRMaXN0ZW5lcnMpKG5leHQpLCBhZGRMaXN0ZW5lcik7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYXBwbHlNaXhpbihvYmosIG1peGlucywgcGFydGlhbCkgewogICAgICAgIHZhciBkZXNjcyA9IHt9OwogICAgICAgIHZhciB2YWx1ZXMgPSB7fTsKICAgICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfZW1iZXJNZXRhLm1ldGEpKG9iaik7CiAgICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgICB2YXIga2V5ID0gdm9pZCAwLAogICAgICAgICAgICB2YWx1ZSA9IHZvaWQgMCwKICAgICAgICAgICAgZGVzYyA9IHZvaWQgMDsKICAgICAgICBvYmouX3N1cGVyID0gX2VtYmVyVXRpbHMuUk9PVDsKICAgICAgICAvLyBHbyB0aHJvdWdoIGFsbCBtaXhpbnMgYW5kIGhhc2hlcyBwYXNzZWQgaW4sIGFuZDoKICAgICAgICAvLwogICAgICAgIC8vICogSGFuZGxlIGNvbmNhdGVuYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgLy8gKiBIYW5kbGUgbWVyZ2VkIHByb3BlcnRpZXMKICAgICAgICAvLyAqIFNldCB1cCBfc3VwZXIgd3JhcHBpbmcgaWYgbmVjZXNzYXJ5CiAgICAgICAgLy8gKiBTZXQgdXAgY29tcHV0ZWQgcHJvcGVydHkgZGVzY3JpcHRvcnMKICAgICAgICAvLyAqIENvcHlpbmcgYHRvU3RyaW5nYCBpbiBicm9rZW4gYnJvd3NlcnMKICAgICAgICBtZXJnZU1peGlucyhtaXhpbnMsIG1ldGEkJDEsIGRlc2NzLCB2YWx1ZXMsIG9iaiwga2V5cyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgIGlmIChrZXkgPT09ICdjb25zdHJ1Y3RvcicgfHwgIXZhbHVlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXNjID0gZGVzY3Nba2V5XTsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZXNba2V5XTsKICAgICAgICAgICAgd2hpbGUgKGRlc2MgJiYgZGVzYyBpbnN0YW5jZW9mIEFsaWFzKSB7CiAgICAgICAgICAgICAgICB2YXIgZm9sbG93ZWQgPSBmb2xsb3dBbGlhcyhvYmosIGRlc2MsIGRlc2NzLCB2YWx1ZXMpOwogICAgICAgICAgICAgICAgZGVzYyA9IGZvbGxvd2VkLmRlc2M7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGZvbGxvd2VkLnZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZXNjID09PSB1bmRlZmluZWQgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKG9iaiwga2V5KSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXBsYWNlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBudWxsLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXBsYWNlT2JzZXJ2ZXJzQW5kTGlzdGVuZXJzKG9iaiwga2V5LCBvYmpba2V5XSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkJJTkRJTkdfU1VQUE9SVCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9CSU5ESU5HX1NVUFBPUlQgJiYgdHlwZW9mIE1peGluLmRldGVjdEJpbmRpbmcgPT09ICdmdW5jdGlvbicgJiYgTWl4aW4uZGV0ZWN0QmluZGluZyhrZXkpKSB7CiAgICAgICAgICAgICAgICBtZXRhJCQxLndyaXRlQmluZGluZ3Moa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIGRlc2MsIHZhbHVlLCBtZXRhJCQxKTsKICAgICAgICB9CiAgICAgICAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuQklORElOR19TVVBQT1JUICYmIF9lbWJlckVudmlyb25tZW50LkVOVi5fRU5BQkxFX0JJTkRJTkdfU1VQUE9SVCAmJiAhcGFydGlhbCAmJiB0eXBlb2YgTWl4aW4uZmluaXNoUGFydGlhbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBNaXhpbi5maW5pc2hQYXJ0aWFsKG9iaiwgbWV0YSQkMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgICAvKioKICAgICAgQG1ldGhvZCBtaXhpbgogICAgICBAcGFyYW0gb2JqCiAgICAgIEBwYXJhbSBtaXhpbnMqCiAgICAgIEByZXR1cm4gb2JqCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZnVuY3Rpb24gbWl4aW4ob2JqKSB7CiAgICAgICAgZm9yICh2YXIgX2xlbjQgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbjQgPiAxID8gX2xlbjQgLSAxIDogMCksIF9rZXk0ID0gMTsgX2tleTQgPCBfbGVuNDsgX2tleTQrKykgewogICAgICAgICAgICBhcmdzW19rZXk0IC0gMV0gPSBhcmd1bWVudHNbX2tleTRdOwogICAgICAgIH0KCiAgICAgICAgYXBwbHlNaXhpbihvYmosIGFyZ3MsIGZhbHNlKTsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQogICAgLyoqCiAgICAgIFRoZSBgTWl4aW5gIGNsYXNzIGFsbG93cyB5b3UgdG8gY3JlYXRlIG1peGlucywgd2hvc2UgcHJvcGVydGllcyBjYW4gYmUKICAgICAgYWRkZWQgdG8gb3RoZXIgY2xhc3Nlcy4gRm9yIGluc3RhbmNlLAogICAgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IE1peGluIGZyb20gJ0BlbWJlci9vYmplY3QvbWl4aW4nOwogICAgCiAgICAgIGNvbnN0IEVkaXRhYmxlTWl4aW4gPSBNaXhpbi5jcmVhdGUoewogICAgICAgIGVkaXQoKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnc3RhcnRpbmcgdG8gZWRpdCcpOwogICAgICAgICAgdGhpcy5zZXQoJ2lzRWRpdGluZycsIHRydWUpOwogICAgICAgIH0sCiAgICAgICAgaXNFZGl0aW5nOiBmYWxzZQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgIGltcG9ydCBFZGl0YWJsZU1peGluIGZyb20gJy4uL21peGlucy9lZGl0YWJsZSc7CiAgICAKICAgICAgLy8gTWl4IG1peGlucyBpbnRvIGNsYXNzZXMgYnkgcGFzc2luZyB0aGVtIGFzIHRoZSBmaXJzdCBhcmd1bWVudHMgdG8KICAgICAgLy8gYC5leHRlbmQuYAogICAgICBjb25zdCBDb21tZW50ID0gRW1iZXJPYmplY3QuZXh0ZW5kKEVkaXRhYmxlTWl4aW4sIHsKICAgICAgICBwb3N0OiBudWxsCiAgICAgIH0pOwogICAgCiAgICAgIGxldCBjb21tZW50ID0gQ29tbWVudC5jcmVhdGUoewogICAgICAgIHBvc3Q6IHNvbWVQb3N0CiAgICAgIH0pOwogICAgCiAgICAgIGNvbW1lbnQuZWRpdCgpOyAvLyBvdXRwdXRzICdzdGFydGluZyB0byBlZGl0JwogICAgICBgYGAKICAgIAogICAgICBOb3RlIHRoYXQgTWl4aW5zIGFyZSBjcmVhdGVkIHdpdGggYE1peGluLmNyZWF0ZWAsIG5vdAogICAgICBgTWl4aW4uZXh0ZW5kYC4KICAgIAogICAgICBOb3RlIHRoYXQgbWl4aW5zIGV4dGVuZCBhIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlIHNvIGFycmF5cyBhbmQgb2JqZWN0IGxpdGVyYWxzCiAgICAgIGRlZmluZWQgYXMgcHJvcGVydGllcyB3aWxsIGJlIHNoYXJlZCBhbW9uZ3N0IG9iamVjdHMgdGhhdCBpbXBsZW1lbnQgdGhlIG1peGluLgogICAgICBJZiB5b3Ugd2FudCB0byBkZWZpbmUgYSBwcm9wZXJ0eSBpbiBhIG1peGluIHRoYXQgaXMgbm90IHNoYXJlZCwgeW91IGNhbiBkZWZpbmUKICAgICAgaXQgZWl0aGVyIGFzIGEgY29tcHV0ZWQgcHJvcGVydHkgb3IgaGF2ZSBpdCBiZSBjcmVhdGVkIG9uIGluaXRpYWxpemF0aW9uIG9mIHRoZSBvYmplY3QuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBmaWx0ZXJzIGFycmF5IHdpbGwgYmUgc2hhcmVkIGFtb25nc3QgYW55IG9iamVjdCBpbXBsZW1lbnRpbmcgbWl4aW4KICAgICAgaW1wb3J0IE1peGluIGZyb20gJ0BlbWJlci9vYmplY3QvbWl4aW4nOwogICAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAgIAogICAgICBjb25zdCBGaWx0ZXJhYmxlTWl4aW4gPSBNaXhpbi5jcmVhdGUoewogICAgICAgIGZpbHRlcnM6IEEoKQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9taXhpbic7CiAgICAgIGltcG9ydCB7IEEgfSBmcm9tICdAZW1iZXIvYXJyYXknOwogICAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIC8vIGZpbHRlcnMgd2lsbCBiZSBhIHNlcGFyYXRlIGFycmF5IGZvciBldmVyeSBvYmplY3QgaW1wbGVtZW50aW5nIHRoZSBtaXhpbgogICAgICBjb25zdCBGaWx0ZXJhYmxlTWl4aW4gPSBNaXhpbi5jcmVhdGUoewogICAgICAgIGZpbHRlcnM6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIEEoKTsKICAgICAgICB9KQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgTWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9taXhpbic7CiAgICAgIGltcG9ydCB7IEEgfSBmcm9tICdAZW1iZXIvYXJyYXknOwogICAgCiAgICAgIC8vIGZpbHRlcnMgd2lsbCBiZSBjcmVhdGVkIGFzIGEgc2VwYXJhdGUgYXJyYXkgZHVyaW5nIHRoZSBvYmplY3QncyBpbml0aWFsaXphdGlvbgogICAgICBjb25zdCBGaWx0ZXJhYmxlID0gTWl4aW4uY3JlYXRlKHsKICAgICAgICBmaWx0ZXJzOiBudWxsLAogICAgCiAgICAgICAgaW5pdCgpIHsKICAgICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICB0aGlzLnNldCgiZmlsdGVycyIsIEEoKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgQGNsYXNzIE1peGluCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgdmFyIE1peGluID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIE1peGluKG1peGlucywgcHJvcGVydGllcykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1peGluKTsKCiAgICAgICAgICAgIHRoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7CiAgICAgICAgICAgIHRoaXMubWl4aW5zID0gYnVpbGRNaXhpbnNBcnJheShtaXhpbnMpOwogICAgICAgICAgICB0aGlzLm93bmVyQ29uc3RydWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHRoaXMuX3dpdGhvdXQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgICB0aGlzW19lbWJlclV0aWxzLk5BTUVfS0VZXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgIEluIGRlYnVnIGJ1aWxkcywgd2Ugc2VhbCBtaXhpbnMgdG8gaGVscCBhdm9pZCBwZXJmb3JtYW5jZSBwaXRmYWxscy4KICAgICAgICAgICAgICAgICAgICAgICAgIEluIElFMTEgdGhlcmUgaXMgYSBxdWlyayB0aGF0IHByZXZlbnRzIHNlYWxlZCBvYmplY3RzIGZyb20gYmVpbmcgYWRkZWQKICAgICAgICAgICAgICAgICAgdG8gYSBXZWFrTWFwLiBVbmZvcnR1bmF0ZWx5LCB0aGUgbWl4aW4gc3lzdGVtIGN1cnJlbnRseSByZWxpZXMgb24KICAgICAgICAgICAgICAgICAgd2VhayBtYXBzIGluIGBndWlkRm9yYCwgc28gd2UgbmVlZCB0byBwcmltZSB0aGUgZ3VpZCBjYWNoZSB3ZWFrIG1hcC4KICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAoMCwgX2VtYmVyVXRpbHMuZ3VpZEZvcikodGhpcyk7CiAgICAgICAgICAgICAgICBPYmplY3Quc2VhbCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgTWl4aW4uX2FwcGx5ID0gZnVuY3Rpb24gX2FwcGx5KCkgewogICAgICAgICAgICByZXR1cm4gYXBwbHlNaXhpbi5hcHBseSh1bmRlZmluZWQsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKCiAgICAgICAgTWl4aW4uYXBwbHlQYXJ0aWFsID0gZnVuY3Rpb24gYXBwbHlQYXJ0aWFsKG9iaikgewogICAgICAgICAgICBmb3IgKHZhciBfbGVuNSA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuNSA+IDEgPyBfbGVuNSAtIDEgOiAwKSwgX2tleTUgPSAxOyBfa2V5NSA8IF9sZW41OyBfa2V5NSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXk1IC0gMV0gPSBhcmd1bWVudHNbX2tleTVdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYXBwbHlNaXhpbihvYmosIGFyZ3MsIHRydWUpOwogICAgICAgIH07CgogICAgICAgIE1peGluLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgICAgICAgICAgLy8gRVM2VE9ETzogdGhpcyByZWxpZXMgb24gYSBnbG9iYWwgc3RhdGU/CiAgICAgICAgICAgIHNldFVucHJvY2Vzc2VkTWl4aW5zKCk7CiAgICAgICAgICAgIHZhciBNID0gdGhpczsKCiAgICAgICAgICAgIGZvciAodmFyIF9sZW42ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW42KSwgX2tleTYgPSAwOyBfa2V5NiA8IF9sZW42OyBfa2V5NisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXk2XSA9IGFyZ3VtZW50c1tfa2V5Nl07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBuZXcgTShhcmdzLCB1bmRlZmluZWQpOwogICAgICAgIH07CgogICAgICAgIE1peGluLm1peGlucyA9IGZ1bmN0aW9uIG1peGlucyhvYmopIHsKICAgICAgICAgICAgdmFyIG1ldGEkJDEgPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkob2JqKTsKICAgICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1ldGEkJDEuZm9yRWFjaE1peGlucyhmdW5jdGlvbiAoY3VycmVudE1peGluKSB7CiAgICAgICAgICAgICAgICAvLyBza2lwIHByaW1pdGl2ZSBtaXhpbnMgc2luY2UgdGhlc2UgYXJlIGFsd2F5cyBhbm9ueW1vdXMKICAgICAgICAgICAgICAgIGlmICghY3VycmVudE1peGluLnByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgICByZXQucHVzaChjdXJyZW50TWl4aW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwoKICAgICAgICBNaXhpbi5wcm90b3R5cGUucmVvcGVuID0gZnVuY3Rpb24gcmVvcGVuKCkgewogICAgICAgICAgICBmb3IgKHZhciBfbGVuNyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuNyksIF9rZXk3ID0gMDsgX2tleTcgPCBfbGVuNzsgX2tleTcrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5N10gPSBhcmd1bWVudHNbX2tleTddOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5wcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudE1peGluID0gbmV3IE1peGluKHVuZGVmaW5lZCwgdGhpcy5wcm9wZXJ0aWVzKTsKICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydGllcyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIHRoaXMubWl4aW5zID0gW2N1cnJlbnRNaXhpbl07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMubWl4aW5zKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1peGlucyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubWl4aW5zID0gdGhpcy5taXhpbnMuY29uY2F0KGJ1aWxkTWl4aW5zQXJyYXkoYXJncykpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICBNaXhpbi5wcm90b3R5cGUuYXBwbHkgPSBmdW5jdGlvbiBhcHBseShvYmopIHsKICAgICAgICAgICAgcmV0dXJuIGFwcGx5TWl4aW4ob2JqLCBbdGhpc10sIGZhbHNlKTsKICAgICAgICB9OwoKICAgICAgICBNaXhpbi5wcm90b3R5cGUuYXBwbHlQYXJ0aWFsID0gZnVuY3Rpb24gYXBwbHlQYXJ0aWFsKG9iaikgewogICAgICAgICAgICByZXR1cm4gYXBwbHlNaXhpbihvYmosIFt0aGlzXSwgdHJ1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgTWl4aW4ucHJvdG90eXBlLmRldGVjdCA9IGZ1bmN0aW9uIGRldGVjdChvYmopIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnIHx8IG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvYmogaW5zdGFuY2VvZiBNaXhpbikgewogICAgICAgICAgICAgICAgcmV0dXJuIF9kZXRlY3Qob2JqLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbWV0YSQkMSA9ICgwLCBfZW1iZXJNZXRhLnBlZWtNZXRhKShvYmopOwogICAgICAgICAgICBpZiAobWV0YSQkMSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1ldGEkJDEuaGFzTWl4aW4odGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgTWl4aW4ucHJvdG90eXBlLndpdGhvdXQgPSBmdW5jdGlvbiB3aXRob3V0KCkgewogICAgICAgICAgICB2YXIgcmV0ID0gbmV3IE1peGluKFt0aGlzXSk7CgogICAgICAgICAgICBmb3IgKHZhciBfbGVuOCA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuOCksIF9rZXk4ID0gMDsgX2tleTggPCBfbGVuODsgX2tleTgrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5OF0gPSBhcmd1bWVudHNbX2tleThdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXQuX3dpdGhvdXQgPSBhcmdzOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH07CgogICAgICAgIE1peGluLnByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24ga2V5cygpIHsKICAgICAgICAgICAgcmV0dXJuIF9rZXlzKHRoaXMpOwogICAgICAgIH07CgogICAgICAgIE1peGluLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKCkgewogICAgICAgICAgICByZXR1cm4gJyh1bmtub3duIG1peGluKSc7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIE1peGluOwogICAgfSgpOwoKICAgIGZ1bmN0aW9uIGJ1aWxkTWl4aW5zQXJyYXkobWl4aW5zKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IG1peGlucyAmJiBtaXhpbnMubGVuZ3RoIHx8IDA7CiAgICAgICAgdmFyIG0gPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgICAgbSA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgeCA9IG1peGluc1tpXTsKICAgICAgICAgICAgICAgICh0cnVlICYmICEodHlwZW9mIHggPT09ICdvYmplY3QnICYmIHggIT09IG51bGwgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHgpICE9PSAnW29iamVjdCBBcnJheV0nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0V4cGVjdGVkIGhhc2ggb3IgTWl4aW4gaW5zdGFuY2UsIGdvdCAnICsgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHgpLCB0eXBlb2YgeCA9PT0gJ29iamVjdCcgJiYgeCAhPT0gbnVsbCAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeCkgIT09ICdbb2JqZWN0IEFycmF5XScpKTsKCiAgICAgICAgICAgICAgICBpZiAoeCBpbnN0YW5jZW9mIE1peGluKSB7CiAgICAgICAgICAgICAgICAgICAgbVtpXSA9IHg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1baV0gPSBuZXcgTWl4aW4odW5kZWZpbmVkLCB4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbTsKICAgIH0KICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkJJTkRJTkdfU1VQUE9SVCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9CSU5ESU5HX1NVUFBPUlQpIHsKICAgICAgICAvLyBzbG90dGluZyB0aGlzIHNvIHRoYXQgdGhlIGxlZ2FjeSBhZGRvbiBjYW4gYWRkIHRoZSBmdW5jdGlvbiBoZXJlCiAgICAgICAgLy8gd2l0aG91dCB0cmlnZ2VyaW5nIGFuIGVycm9yIGR1ZSB0byB0aGUgT2JqZWN0LnNlYWwgZG9uZSBiZWxvdwogICAgICAgIE1peGluLmZpbmlzaFBhcnRpYWwgPSBudWxsOwogICAgICAgIE1peGluLmRldGVjdEJpbmRpbmcgPSBudWxsOwogICAgfQogICAgTWl4aW4ucHJvdG90eXBlLnRvU3RyaW5nID0gY2xhc3NUb1N0cmluZzsKICAgIGlmICh0cnVlKSB7CiAgICAgICAgTWl4aW4ucHJvdG90eXBlW19lbWJlclV0aWxzLk5BTUVfS0VZXSA9IHVuZGVmaW5lZDsKICAgICAgICBPYmplY3Quc2VhbChNaXhpbi5wcm90b3R5cGUpOwogICAgfQogICAgZnVuY3Rpb24gX2RldGVjdChjdXJNaXhpbiwgdGFyZ2V0TWl4aW4pIHsKICAgICAgICB2YXIgc2VlbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbmV3IFNldCgpOwoKICAgICAgICBpZiAoc2Vlbi5oYXMoY3VyTWl4aW4pKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc2Vlbi5hZGQoY3VyTWl4aW4pOwogICAgICAgIGlmIChjdXJNaXhpbiA9PT0gdGFyZ2V0TWl4aW4pIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciBtaXhpbnMgPSBjdXJNaXhpbi5taXhpbnM7CiAgICAgICAgaWYgKG1peGlucykgewogICAgICAgICAgICByZXR1cm4gbWl4aW5zLnNvbWUoZnVuY3Rpb24gKG1peGluKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX2RldGVjdChtaXhpbiwgdGFyZ2V0TWl4aW4sIHNlZW4pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gX2tleXMobWl4aW4pIHsKICAgICAgICB2YXIgcmV0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBuZXcgU2V0KCk7CiAgICAgICAgdmFyIHNlZW4gPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IG5ldyBTZXQoKTsKCiAgICAgICAgaWYgKHNlZW4uaGFzKG1peGluKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHNlZW4uYWRkKG1peGluKTsKICAgICAgICBpZiAobWl4aW4ucHJvcGVydGllcykgewogICAgICAgICAgICB2YXIgcHJvcHMgPSBPYmplY3Qua2V5cyhtaXhpbi5wcm9wZXJ0aWVzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgcmV0LmFkZChwcm9wc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG1peGluLm1peGlucykgewogICAgICAgICAgICBtaXhpbi5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9rZXlzKHgsIHJldCwgc2Vlbik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHZhciBBbGlhcyA9IGZ1bmN0aW9uIChfRGVzY3JpcHRvcjMpIHsKICAgICAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEFsaWFzLCBfRGVzY3JpcHRvcjMpOwoKICAgICAgICBmdW5jdGlvbiBBbGlhcyhtZXRob2ROYW1lKSB7CiAgICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQWxpYXMpOwoKICAgICAgICAgICAgdmFyIF90aGlzMyA9ICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfRGVzY3JpcHRvcjMuY2FsbCh0aGlzKSk7CgogICAgICAgICAgICBfdGhpczMubWV0aG9kTmFtZSA9IG1ldGhvZE5hbWU7CiAgICAgICAgICAgIHJldHVybiBfdGhpczM7CiAgICAgICAgfQoKICAgICAgICBBbGlhcy5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiB0ZWFyZG93bihfb2JqLCBfa2V5TmFtZSwgX21ldGEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpOwogICAgICAgIH07CgogICAgICAgIEFsaWFzLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoX29iaiwgX2tleU5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpOwogICAgICAgIH07CgogICAgICAgIEFsaWFzLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiBzZXQoX29iaiwgX2tleU5hbWUsIF92YWx1ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBub3QgaW1wbGVtZW50ZWQuJyk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIEFsaWFzOwogICAgfShEZXNjcmlwdG9yKTsKCiAgICAvKioKICAgICAgTWFrZXMgYSBtZXRob2QgYXZhaWxhYmxlIHZpYSBhbiBhZGRpdGlvbmFsIG5hbWUuCiAgICAKICAgICAgYGBgYXBwL3V0aWxzL3BlcnNvbi5qcwogICAgICBpbXBvcnQgRW1iZXJPYmplY3QsIHsKICAgICAgICBhbGlhc01ldGhvZAogICAgICB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgCiAgICAgIGV4cG9ydCBkZWZhdWx0IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgbmFtZSgpIHsKICAgICAgICAgIHJldHVybiAnVG9taHVkYSBLYXR6ZGFsZSc7CiAgICAgICAgfSwKICAgICAgICBtb25pa2VyOiBhbGlhc01ldGhvZCgnbmFtZScpCiAgICAgIH0pOwogICAgICBgYGAKICAgIAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGxldCBnb29kR3V5ID0gUGVyc29uLmNyZWF0ZSgpOwogICAgCiAgICAgIGdvb2RHdXkubmFtZSgpOyAgICAvLyAnVG9taHVkYSBLYXR6ZGFsZScKICAgICAgZ29vZEd1eS5tb25pa2VyKCk7IC8vICdUb21odWRhIEthdHpkYWxlJwogICAgICBgYGAKICAgIAogICAgICBAbWV0aG9kIGFsaWFzTWV0aG9kCiAgICAgIEBzdGF0aWMKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBhbGlhcwogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gYWxpYXNNZXRob2QobWV0aG9kTmFtZSkgewogICAgICAgIHJldHVybiBuZXcgQWxpYXMobWV0aG9kTmFtZSk7CiAgICB9CiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBPQlNFUlZFUiBIRUxQRVIKICAgIC8vCiAgICAvKioKICAgICAgU3BlY2lmeSBhIG1ldGhvZCB0aGF0IG9ic2VydmVzIHByb3BlcnR5IGNoYW5nZXMuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgIGltcG9ydCB7IG9ic2VydmVyIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAKICAgICAgZXhwb3J0IGRlZmF1bHQgRW1iZXJPYmplY3QuZXh0ZW5kKHsKICAgICAgICB2YWx1ZU9ic2VydmVyOiBvYnNlcnZlcigndmFsdWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIEV4ZWN1dGVzIHdoZW5ldmVyIHRoZSAidmFsdWUiIHByb3BlcnR5IGNoYW5nZXMKICAgICAgICB9KQogICAgICB9KTsKICAgICAgYGBgCiAgICAKICAgICAgQWxzbyBhdmFpbGFibGUgYXMgYEZ1bmN0aW9uLnByb3RvdHlwZS5vYnNlcnZlc2AgaWYgcHJvdG90eXBlIGV4dGVuc2lvbnMgYXJlCiAgICAgIGVuYWJsZWQuCiAgICAKICAgICAgQG1ldGhvZCBvYnNlcnZlcgogICAgICBAZm9yIEBlbWJlci9vYmplY3QKICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3BlcnR5TmFtZXMqCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMKICAgICAgQHJldHVybiBmdW5jCiAgICAgIEBwdWJsaWMKICAgICAgQHN0YXRpYwogICAgKi8KICAgIGZ1bmN0aW9uIG9ic2VydmVyKCkgewogICAgICAgIGZvciAodmFyIF9sZW45ID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW45KSwgX2tleTkgPSAwOyBfa2V5OSA8IF9sZW45OyBfa2V5OSsrKSB7CiAgICAgICAgICAgIGFyZ3NbX2tleTldID0gYXJndW1lbnRzW19rZXk5XTsKICAgICAgICB9CgogICAgICAgIHZhciBmdW5jID0gYXJncy5wb3AoKTsKICAgICAgICB2YXIgX3BhdGhzID0gYXJnczsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBmdW5jID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ29ic2VydmVyIGNhbGxlZCB3aXRob3V0IGEgZnVuY3Rpb24nLCB0eXBlb2YgZnVuYyA9PT0gJ2Z1bmN0aW9uJykpOwogICAgICAgICh0cnVlICYmICEoX3BhdGhzLmxlbmd0aCA+IDAgJiYgX3BhdGhzLmV2ZXJ5KGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcCA9PT0gJ3N0cmluZycgJiYgISFwLmxlbmd0aDsKICAgICAgICB9KSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdvYnNlcnZlciBjYWxsZWQgd2l0aG91dCB2YWxpZCBwYXRoJywgX3BhdGhzLmxlbmd0aCA+IDAgJiYgX3BhdGhzLmV2ZXJ5KGZ1bmN0aW9uIChwKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgcCA9PT0gJ3N0cmluZycgJiYgISFwLmxlbmd0aDsKICAgICAgICB9KSkpOwoKICAgICAgICB2YXIgcGF0aHMgPSBbXTsKICAgICAgICB2YXIgYWRkV2F0Y2hlZFByb3BlcnR5ID0gZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhdGhzLnB1c2gocGF0aCk7CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9wYXRocy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBleHBhbmRQcm9wZXJ0aWVzKF9wYXRoc1tpXSwgYWRkV2F0Y2hlZFByb3BlcnR5KTsKICAgICAgICB9CiAgICAgICAgKDAsIF9lbWJlclV0aWxzLnNldE9ic2VydmVycykoZnVuYywgcGF0aHMpOwogICAgICAgIHJldHVybiBmdW5jOwogICAgfQoKICAgIC8qKgogICAgIEBtb2R1bGUgZW1iZXIKICAgICBAcHJpdmF0ZQogICAgICovCiAgICAvKioKICAgICAgUmVhZC1vbmx5IHByb3BlcnR5IHRoYXQgcmV0dXJucyB0aGUgcmVzdWx0IG9mIGEgY29udGFpbmVyIGxvb2t1cC4KICAgIAogICAgICBAY2xhc3MgSW5qZWN0ZWRQcm9wZXJ0eQogICAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICAgIEBjb25zdHJ1Y3RvcgogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgY29udGFpbmVyIHR5cGUgdGhlIHByb3BlcnR5IHdpbGwgbG9va3VwCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIChvcHRpb25hbCkgVGhlIG5hbWUgdGhlIHByb3BlcnR5IHdpbGwgbG9va3VwLCBkZWZhdWx0cwogICAgICAgICAgICAgdG8gdGhlIHByb3BlcnR5J3MgbmFtZQogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICB2YXIgSW5qZWN0ZWRQcm9wZXJ0eSA9IGZ1bmN0aW9uIChfQ29tcHV0ZWRQcm9wZXJ0eSkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoSW5qZWN0ZWRQcm9wZXJ0eSwgX0NvbXB1dGVkUHJvcGVydHkpOwoKICAgICAgICBmdW5jdGlvbiBJbmplY3RlZFByb3BlcnR5KHR5cGUsIG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBJbmplY3RlZFByb3BlcnR5KTsKCiAgICAgICAgICAgIHZhciBfdGhpczQgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0NvbXB1dGVkUHJvcGVydHkuY2FsbCh0aGlzLCBpbmplY3RlZFByb3BlcnR5R2V0KSk7CgogICAgICAgICAgICBfdGhpczQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIF90aGlzNC5uYW1lID0gbmFtZTsKICAgICAgICAgICAgaWYgKGZhbHNlKSB7CiAgICAgICAgICAgICAgICBfdGhpczQuc291cmNlID0gb3B0aW9ucyA/IG9wdGlvbnMuc291cmNlIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgX3RoaXM0Lm5hbWVzcGFjZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWVzcGFjZURlbGltaXRlck9mZnNldCA9IG5hbWUuaW5kZXhPZignOjonKTsKICAgICAgICAgICAgICAgICAgICBpZiAobmFtZXNwYWNlRGVsaW1pdGVyT2Zmc2V0ID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpczQubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzNC5uYW1lc3BhY2UgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXM0Lm5hbWUgPSBuYW1lLnNsaWNlKG5hbWVzcGFjZURlbGltaXRlck9mZnNldCArIDIpOwogICAgICAgICAgICAgICAgICAgICAgICBfdGhpczQubmFtZXNwYWNlID0gbmFtZS5zbGljZSgwLCBuYW1lc3BhY2VEZWxpbWl0ZXJPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gX3RoaXM0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIEluamVjdGVkUHJvcGVydHk7CiAgICB9KENvbXB1dGVkUHJvcGVydHkpOwoKICAgIGZ1bmN0aW9uIGluamVjdGVkUHJvcGVydHlHZXQoa2V5TmFtZSkgewogICAgICAgIHZhciBkZXNjID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikodGhpcywga2V5TmFtZSk7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKSB8fCB0aGlzLmNvbnRhaW5lcjsgLy8gZmFsbGJhY2sgdG8gYGNvbnRhaW5lcmAgZm9yIGJhY2t3YXJkcyBjb21wYXQKICAgICAgICAodHJ1ZSAmJiAhKGRlc2MgJiYgZGVzYy50eXBlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0luamVjdGVkUHJvcGVydGllcyBzaG91bGQgYmUgZGVmaW5lZCB3aXRoIHRoZSBpbmplY3QgY29tcHV0ZWQgcHJvcGVydHkgbWFjcm9zLicsIGRlc2MgJiYgZGVzYy50eXBlKSk7CiAgICAgICAgKHRydWUgJiYgISghIW93bmVyKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0F0dGVtcHRpbmcgdG8gbG9va3VwIGFuIGluamVjdGVkIHByb3BlcnR5IG9uIGFuIG9iamVjdCB3aXRob3V0IGEgY29udGFpbmVyLCBlbnN1cmUgdGhhdCB0aGUgb2JqZWN0IHdhcyBpbnN0YW50aWF0ZWQgdmlhIGEgY29udGFpbmVyLicsICEhb3duZXIpKTsKCiAgICAgICAgdmFyIHNwZWNpZmllciA9IGRlc2MudHlwZSArICc6JyArIChkZXNjLm5hbWUgfHwga2V5TmFtZSk7CiAgICAgICAgcmV0dXJuIG93bmVyLmxvb2t1cChzcGVjaWZpZXIsIHsKICAgICAgICAgICAgc291cmNlOiBkZXNjLnNvdXJjZSwKICAgICAgICAgICAgbmFtZXNwYWNlOiBkZXNjLm5hbWVzcGFjZQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlc2NyaXB0b3IoZGVzYykgewogICAgICAgIHJldHVybiBuZXcgRGVzY3JpcHRvciQxKGRlc2MpOwogICAgfQogICAgLyoqCiAgICAgIEEgd3JhcHBlciBmb3IgYSBuYXRpdmUgRVM1IGRlc2NyaXB0b3IuIEluIGFuIGlkZWFsIHdvcmxkLCB3ZSB3b3VsZG4ndCBuZWVkCiAgICAgIHRoaXMgYXQgYWxsLCBob3dldmVyLCB0aGUgd2F5IHdlIGN1cnJlbnRseSBmbGF0dGVuL21lcmdlIG91ciBtaXhpbnMgcmVxdWlyZQogICAgICBhIHNwZWNpYWwgdmFsdWUgdG8gZGVub3RlIGEgZGVzY3JpcHRvci4KICAgIAogICAgICBAY2xhc3MgRGVzY3JpcHRvcgogICAgICBAcHJpdmF0ZQogICAgKi8KCiAgICB2YXIgRGVzY3JpcHRvciQxID0gZnVuY3Rpb24gKF9EZXNjcmlwdG9yNCkgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoRGVzY3JpcHRvciQxLCBfRGVzY3JpcHRvcjQpOwoKICAgICAgICBmdW5jdGlvbiBEZXNjcmlwdG9yJDEoZGVzYykgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERlc2NyaXB0b3IkMSk7CgogICAgICAgICAgICB2YXIgX3RoaXM1ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9EZXNjcmlwdG9yNC5jYWxsKHRoaXMpKTsKCiAgICAgICAgICAgIF90aGlzNS5kZXNjID0gZGVzYzsKICAgICAgICAgICAgX3RoaXM1LmVudW1lcmFibGUgPSBkZXNjLmVudW1lcmFibGUgIT09IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gX3RoaXM1OwogICAgICAgIH0KCiAgICAgICAgRGVzY3JpcHRvciQxLnByb3RvdHlwZS5zZXR1cCA9IGZ1bmN0aW9uIHNldHVwKG9iaiwga2V5KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdGhpcy5kZXNjKTsKICAgICAgICB9OwoKICAgICAgICBEZXNjcmlwdG9yJDEucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChvYmosIGtleSkgewogICAgICAgICAgICByZXR1cm4gb2JqW2tleV07CiAgICAgICAgfTsKCiAgICAgICAgRGVzY3JpcHRvciQxLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiBzZXQob2JqLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBvYmpba2V5XSA9IHZhbHVlOwogICAgICAgIH07CgogICAgICAgIERlc2NyaXB0b3IkMS5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiB0ZWFyZG93bigpIHt9OwoKICAgICAgICByZXR1cm4gRGVzY3JpcHRvciQxOwogICAgfShEZXNjcmlwdG9yKTsKCiAgICBleHBvcnRzLmNvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICBleHBvcnRzLkNvbXB1dGVkUHJvcGVydHkgPSBDb21wdXRlZFByb3BlcnR5OwogICAgZXhwb3J0cy5fZ2xvYmFsc0NvbXB1dGVkID0gX2dsb2JhbHNDb21wdXRlZDsKICAgIGV4cG9ydHMuZ2V0Q2FjaGVGb3IgPSBnZXRDYWNoZUZvcjsKICAgIGV4cG9ydHMuZ2V0Q2FjaGVkVmFsdWVGb3IgPSBnZXRDYWNoZWRWYWx1ZUZvcjsKICAgIGV4cG9ydHMucGVla0NhY2hlRm9yID0gcGVla0NhY2hlRm9yOwogICAgZXhwb3J0cy5hbGlhcyA9IGFsaWFzOwogICAgZXhwb3J0cy5kZXByZWNhdGVQcm9wZXJ0eSA9IGRlcHJlY2F0ZVByb3BlcnR5OwogICAgZXhwb3J0cy5QUk9YWV9DT05URU5UID0gUFJPWFlfQ09OVEVOVDsKICAgIGV4cG9ydHMuX2dldFBhdGggPSBfZ2V0UGF0aDsKICAgIGV4cG9ydHMuZ2V0ID0gX2dldDsKICAgIGV4cG9ydHMuZ2V0V2l0aERlZmF1bHQgPSBnZXRXaXRoRGVmYXVsdDsKICAgIGV4cG9ydHMuc2V0ID0gX3NldDI7CiAgICBleHBvcnRzLnRyeVNldCA9IHRyeVNldDsKICAgIGV4cG9ydHMub2JqZWN0QXQgPSBvYmplY3RBdDsKICAgIGV4cG9ydHMucmVwbGFjZSA9IHJlcGxhY2U7CiAgICBleHBvcnRzLnJlcGxhY2VJbk5hdGl2ZUFycmF5ID0gcmVwbGFjZUluTmF0aXZlQXJyYXk7CiAgICBleHBvcnRzLmFkZEFycmF5T2JzZXJ2ZXIgPSBhZGRBcnJheU9ic2VydmVyOwogICAgZXhwb3J0cy5yZW1vdmVBcnJheU9ic2VydmVyID0gcmVtb3ZlQXJyYXlPYnNlcnZlcjsKICAgIGV4cG9ydHMuYXJyYXlDb250ZW50V2lsbENoYW5nZSA9IGFycmF5Q29udGVudFdpbGxDaGFuZ2U7CiAgICBleHBvcnRzLmFycmF5Q29udGVudERpZENoYW5nZSA9IGFycmF5Q29udGVudERpZENoYW5nZTsKICAgIGV4cG9ydHMuZWFjaFByb3h5Rm9yID0gZWFjaFByb3h5Rm9yOwogICAgZXhwb3J0cy5lYWNoUHJveHlBcnJheVdpbGxDaGFuZ2UgPSBlYWNoUHJveHlBcnJheVdpbGxDaGFuZ2U7CiAgICBleHBvcnRzLmVhY2hQcm94eUFycmF5RGlkQ2hhbmdlID0gZWFjaFByb3h5QXJyYXlEaWRDaGFuZ2U7CiAgICBleHBvcnRzLmFkZExpc3RlbmVyID0gYWRkTGlzdGVuZXI7CiAgICBleHBvcnRzLmhhc0xpc3RlbmVycyA9IGhhc0xpc3RlbmVyczsKICAgIGV4cG9ydHMub24gPSBvbjsKICAgIGV4cG9ydHMucmVtb3ZlTGlzdGVuZXIgPSByZW1vdmVMaXN0ZW5lcjsKICAgIGV4cG9ydHMuc2VuZEV2ZW50ID0gc2VuZEV2ZW50OwogICAgZXhwb3J0cy5pc05vbmUgPSBpc05vbmU7CiAgICBleHBvcnRzLmlzRW1wdHkgPSBpc0VtcHR5OwogICAgZXhwb3J0cy5pc0JsYW5rID0gaXNCbGFuazsKICAgIGV4cG9ydHMuaXNQcmVzZW50ID0gaXNQcmVzZW50OwogICAgZXhwb3J0cy5iZWdpblByb3BlcnR5Q2hhbmdlcyA9IGJlZ2luUHJvcGVydHlDaGFuZ2VzOwogICAgZXhwb3J0cy5jaGFuZ2VQcm9wZXJ0aWVzID0gY2hhbmdlUHJvcGVydGllczsKICAgIGV4cG9ydHMuZW5kUHJvcGVydHlDaGFuZ2VzID0gZW5kUHJvcGVydHlDaGFuZ2VzOwogICAgZXhwb3J0cy5ub3RpZnlQcm9wZXJ0eUNoYW5nZSA9IG5vdGlmeVByb3BlcnR5Q2hhbmdlOwogICAgZXhwb3J0cy5vdmVycmlkZUNoYWlucyA9IG92ZXJyaWRlQ2hhaW5zOwogICAgZXhwb3J0cy5wcm9wZXJ0eURpZENoYW5nZSA9IHByb3BlcnR5RGlkQ2hhbmdlOwogICAgZXhwb3J0cy5wcm9wZXJ0eVdpbGxDaGFuZ2UgPSBwcm9wZXJ0eVdpbGxDaGFuZ2U7CiAgICBleHBvcnRzLlBST1BFUlRZX0RJRF9DSEFOR0UgPSBQUk9QRVJUWV9ESURfQ0hBTkdFJDE7CiAgICBleHBvcnRzLmRlZmluZVByb3BlcnR5ID0gZGVmaW5lUHJvcGVydHk7CiAgICBleHBvcnRzLkRlc2NyaXB0b3IgPSBEZXNjcmlwdG9yOwogICAgZXhwb3J0cy53YXRjaEtleSA9IHdhdGNoS2V5OwogICAgZXhwb3J0cy51bndhdGNoS2V5ID0gdW53YXRjaEtleTsKICAgIGV4cG9ydHMuQ2hhaW5Ob2RlID0gQ2hhaW5Ob2RlOwogICAgZXhwb3J0cy5maW5pc2hDaGFpbnMgPSBmaW5pc2hDaGFpbnM7CiAgICBleHBvcnRzLnJlbW92ZUNoYWluV2F0Y2hlciA9IHJlbW92ZUNoYWluV2F0Y2hlcjsKICAgIGV4cG9ydHMud2F0Y2hQYXRoID0gd2F0Y2hQYXRoOwogICAgZXhwb3J0cy51bndhdGNoUGF0aCA9IHVud2F0Y2hQYXRoOwogICAgZXhwb3J0cy5pc1dhdGNoaW5nID0gaXNXYXRjaGluZzsKICAgIGV4cG9ydHMudW53YXRjaCA9IHVud2F0Y2g7CiAgICBleHBvcnRzLndhdGNoID0gd2F0Y2g7CiAgICBleHBvcnRzLndhdGNoZXJDb3VudCA9IHdhdGNoZXJDb3VudDsKICAgIGV4cG9ydHMubGlicmFyaWVzID0gTElCUkFSSUVTOwogICAgZXhwb3J0cy5MaWJyYXJpZXMgPSBMaWJyYXJpZXM7CiAgICBleHBvcnRzLmdldFByb3BlcnRpZXMgPSBnZXRQcm9wZXJ0aWVzOwogICAgZXhwb3J0cy5zZXRQcm9wZXJ0aWVzID0gc2V0UHJvcGVydGllczsKICAgIGV4cG9ydHMuZXhwYW5kUHJvcGVydGllcyA9IGV4cGFuZFByb3BlcnRpZXM7CiAgICBleHBvcnRzLmFkZE9ic2VydmVyID0gYWRkT2JzZXJ2ZXI7CiAgICBleHBvcnRzLnJlbW92ZU9ic2VydmVyID0gcmVtb3ZlT2JzZXJ2ZXI7CiAgICBleHBvcnRzLk1peGluID0gTWl4aW47CiAgICBleHBvcnRzLmFsaWFzTWV0aG9kID0gYWxpYXNNZXRob2Q7CiAgICBleHBvcnRzLm1peGluID0gbWl4aW47CiAgICBleHBvcnRzLm9ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICBleHBvcnRzLkluamVjdGVkUHJvcGVydHkgPSBJbmplY3RlZFByb3BlcnR5OwogICAgZXhwb3J0cy5zZXRIYXNWaWV3cyA9IHNldEhhc1ZpZXdzOwogICAgZXhwb3J0cy50YWdGb3JQcm9wZXJ0eSA9IHRhZ0ZvclByb3BlcnR5OwogICAgZXhwb3J0cy50YWdGb3IgPSB0YWdGb3I7CiAgICBleHBvcnRzLm1hcmtPYmplY3RBc0RpcnR5ID0gbWFya09iamVjdEFzRGlydHk7CiAgICBleHBvcnRzLnJ1bkluVHJhbnNhY3Rpb24gPSBydW5JblRyYW5zYWN0aW9uOwogICAgZXhwb3J0cy5kaWRSZW5kZXIgPSBkaWRSZW5kZXI7CiAgICBleHBvcnRzLmFzc2VydE5vdFJlbmRlcmVkID0gYXNzZXJ0Tm90UmVuZGVyZWQ7CiAgICBleHBvcnRzLmRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yOwogICAgZXhwb3J0cy50cmFja2VkID0gdHJhY2tlZDsKICAgIGV4cG9ydHMuTkFNRVNQQUNFUyA9IE5BTUVTUEFDRVM7CiAgICBleHBvcnRzLk5BTUVTUEFDRVNfQllfSUQgPSBOQU1FU1BBQ0VTX0JZX0lEOwogICAgZXhwb3J0cy5hZGROYW1lc3BhY2UgPSBhZGROYW1lc3BhY2U7CiAgICBleHBvcnRzLmNsYXNzVG9TdHJpbmcgPSBjbGFzc1RvU3RyaW5nOwogICAgZXhwb3J0cy5maW5kTmFtZXNwYWNlID0gZmluZE5hbWVzcGFjZTsKICAgIGV4cG9ydHMuZmluZE5hbWVzcGFjZXMgPSBmaW5kTmFtZXNwYWNlczsKICAgIGV4cG9ydHMucHJvY2Vzc05hbWVzcGFjZSA9IHByb2Nlc3NOYW1lc3BhY2U7CiAgICBleHBvcnRzLnByb2Nlc3NBbGxOYW1lc3BhY2VzID0gcHJvY2Vzc0FsbE5hbWVzcGFjZXM7CiAgICBleHBvcnRzLnJlbW92ZU5hbWVzcGFjZSA9IHJlbW92ZU5hbWVzcGFjZTsKICAgIGV4cG9ydHMuaXNOYW1lc3BhY2VTZWFyY2hEaXNhYmxlZCA9IGlzU2VhcmNoRGlzYWJsZWQ7CiAgICBleHBvcnRzLnNldE5hbWVzcGFjZVNlYXJjaERpc2FibGVkID0gc2V0U2VhcmNoRGlzYWJsZWQ7Cn0pOwplbmlmZWQoJ2VtYmVyLW93bmVyL2luZGV4JywgWydleHBvcnRzJywgJ2VtYmVyLXV0aWxzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJVdGlscykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5PV05FUiA9IHVuZGVmaW5lZDsKICBleHBvcnRzLmdldE93bmVyID0gZ2V0T3duZXI7CiAgZXhwb3J0cy5zZXRPd25lciA9IHNldE93bmVyOwogIHZhciBPV05FUiA9IGV4cG9ydHMuT1dORVIgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnT1dORVInKTsKICAvKioKICAgIEZyYW1ld29yayBvYmplY3RzIGluIGFuIEVtYmVyIGFwcGxpY2F0aW9uIChjb21wb25lbnRzLCBzZXJ2aWNlcywgcm91dGVzLCBldGMuKQogICAgYXJlIGNyZWF0ZWQgdmlhIGEgZmFjdG9yeSBhbmQgZGVwZW5kZW5jeSBpbmplY3Rpb24gc3lzdGVtLiBFYWNoIG9mIHRoZXNlCiAgICBvYmplY3RzIGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiBhbiAib3duZXIiLCB3aGljaCBoYW5kbGVkIGl0cwogICAgaW5zdGFudGlhdGlvbiBhbmQgbWFuYWdlcyBpdHMgbGlmZXRpbWUuCiAgCiAgICBgZ2V0T3duZXJgIGZldGNoZXMgdGhlIG93bmVyIG9iamVjdCByZXNwb25zaWJsZSBmb3IgYW4gaW5zdGFuY2UuIFRoaXMgY2FuCiAgICBiZSB1c2VkIHRvIGxvb2t1cCBvciByZXNvbHZlIG90aGVyIGNsYXNzIGluc3RhbmNlcywgb3IgcmVnaXN0ZXIgbmV3IGZhY3RvcmllcwogICAgaW50byB0aGUgb3duZXIuCiAgCiAgICBGb3IgZXhhbXBsZSwgdGhpcyBjb21wb25lbnQgZHluYW1pY2FsbHkgbG9va3MgdXAgYSBzZXJ2aWNlIGJhc2VkIG9uIHRoZQogICAgYGF1ZGlvVHlwZWAgcGFzc2VkIGFzIGFuIGF0dHJpYnV0ZToKICAKICAgIGBgYGFwcC9jb21wb25lbnRzL3BsYXktYXVkaW8uanMKICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgaW1wb3J0IHsgZ2V0T3duZXIgfSBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogIAogICAgLy8gVXNhZ2U6CiAgICAvLwogICAgLy8gICB7e3BsYXktYXVkaW8gYXVkaW9UeXBlPW1vZGVsLmF1ZGlvVHlwZSBhdWRpb0ZpbGU9bW9kZWwuZmlsZX19CiAgICAvLwogICAgZXhwb3J0IGRlZmF1bHQgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgIGF1ZGlvU2VydmljZTogY29tcHV0ZWQoJ2F1ZGlvVHlwZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBvd25lciA9IGdldE93bmVyKHRoaXMpOwogICAgICAgIHJldHVybiBvd25lci5sb29rdXAoYHNlcnZpY2U6JHt0aGlzLmdldCgnYXVkaW9UeXBlJyl9YCk7CiAgICAgIH0pLAogIAogICAgICBjbGljaygpIHsKICAgICAgICBsZXQgcGxheWVyID0gdGhpcy5nZXQoJ2F1ZGlvU2VydmljZScpOwogICAgICAgIHBsYXllci5wbGF5KHRoaXMuZ2V0KCdhdWRpb0ZpbGUnKSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGdldE93bmVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9hcHBsaWNhdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCBBbiBvYmplY3Qgd2l0aCBhbiBvd25lci4KICAgIEByZXR1cm4ge09iamVjdH0gQW4gb3duZXIgb2JqZWN0LgogICAgQHNpbmNlIDIuMy4wCiAgICBAcHVibGljCiAgKi8KICAvKioKICBAbW9kdWxlIEBlbWJlci9hcHBsaWNhdGlvbgogICovCiAgZnVuY3Rpb24gZ2V0T3duZXIob2JqZWN0KSB7CiAgICByZXR1cm4gb2JqZWN0W09XTkVSXTsKICB9CiAgLyoqCiAgICBgc2V0T3duZXJgIGZvcmNlcyBhIG5ldyBvd25lciBvbiBhIGdpdmVuIG9iamVjdCBpbnN0YW5jZS4gVGhpcyBpcyBwcmltYXJpbHkKICAgIHVzZWZ1bCBpbiBzb21lIHRlc3RpbmcgY2FzZXMuCiAgCiAgICBAbWV0aG9kIHNldE93bmVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci9hcHBsaWNhdGlvbgogICAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCBBbiBvYmplY3QgaW5zdGFuY2UuCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBuZXcgb3duZXIgb2JqZWN0IG9mIHRoZSBvYmplY3QgaW5zdGFuY2UuCiAgICBAc2luY2UgMi4zLjAKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIHNldE93bmVyKG9iamVjdCwgb3duZXIpIHsKICAgIG9iamVjdFtPV05FUl0gPSBvd25lcjsKICB9CiAgLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5kZXguanMubWFwCn0pOwplbmlmZWQoJ2VtYmVyLXJvdXRpbmcvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vYXBpJywgJ2VtYmVyLXJvdXRpbmcvbGliL2xvY2F0aW9uL25vbmVfbG9jYXRpb24nLCAnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vaGFzaF9sb2NhdGlvbicsICdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9oaXN0b3J5X2xvY2F0aW9uJywgJ2VtYmVyLXJvdXRpbmcvbGliL2xvY2F0aW9uL2F1dG9fbG9jYXRpb24nLCAnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL2dlbmVyYXRlX2NvbnRyb2xsZXInLCAnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL2NvbnRyb2xsZXJfZm9yJywgJ2VtYmVyLXJvdXRpbmcvbGliL3N5c3RlbS9kc2wnLCAnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL3JvdXRlcicsICdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vcm91dGUnLCAnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL3F1ZXJ5X3BhcmFtcycsICdlbWJlci1yb3V0aW5nL2xpYi9zZXJ2aWNlcy9yb3V0aW5nJywgJ2VtYmVyLXJvdXRpbmcvbGliL3NlcnZpY2VzL3JvdXRlcicsICdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vY2FjaGUnLCAnZW1iZXItcm91dGluZy9saWIvZXh0L2NvbnRyb2xsZXInXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9hcGksIF9ub25lX2xvY2F0aW9uLCBfaGFzaF9sb2NhdGlvbiwgX2hpc3RvcnlfbG9jYXRpb24sIF9hdXRvX2xvY2F0aW9uLCBfZ2VuZXJhdGVfY29udHJvbGxlciwgX2NvbnRyb2xsZXJfZm9yLCBfZHNsLCBfcm91dGVyLCBfcm91dGUsIF9xdWVyeV9wYXJhbXMsIF9yb3V0aW5nLCBfcm91dGVyMiwgX2NhY2hlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLkJ1Y2tldENhY2hlID0gZXhwb3J0cy5Sb3V0ZXJTZXJ2aWNlID0gZXhwb3J0cy5Sb3V0aW5nU2VydmljZSA9IGV4cG9ydHMuUXVlcnlQYXJhbXMgPSBleHBvcnRzLlJvdXRlID0gZXhwb3J0cy5Sb3V0ZXIgPSBleHBvcnRzLlJvdXRlckRTTCA9IGV4cG9ydHMuY29udHJvbGxlckZvciA9IGV4cG9ydHMuZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeSA9IGV4cG9ydHMuZ2VuZXJhdGVDb250cm9sbGVyID0gZXhwb3J0cy5BdXRvTG9jYXRpb24gPSBleHBvcnRzLkhpc3RvcnlMb2NhdGlvbiA9IGV4cG9ydHMuSGFzaExvY2F0aW9uID0gZXhwb3J0cy5Ob25lTG9jYXRpb24gPSBleHBvcnRzLkxvY2F0aW9uID0gdW5kZWZpbmVkOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTG9jYXRpb24nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfYXBpLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdOb25lTG9jYXRpb24nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbm9uZV9sb2NhdGlvbi5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnSGFzaExvY2F0aW9uJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2hhc2hfbG9jYXRpb24uZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0hpc3RvcnlMb2NhdGlvbicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9oaXN0b3J5X2xvY2F0aW9uLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdBdXRvTG9jYXRpb24nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfYXV0b19sb2NhdGlvbi5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZ2VuZXJhdGVDb250cm9sbGVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2dlbmVyYXRlX2NvbnRyb2xsZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2dlbmVyYXRlQ29udHJvbGxlckZhY3RvcnknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfZ2VuZXJhdGVfY29udHJvbGxlci5nZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnY29udHJvbGxlckZvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb250cm9sbGVyX2Zvci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm91dGVyRFNMJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2RzbC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm91dGVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JvdXRlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm91dGUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcm91dGUuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ1F1ZXJ5UGFyYW1zJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3F1ZXJ5X3BhcmFtcy5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm91dGluZ1NlcnZpY2UnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcm91dGluZy5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnUm91dGVyU2VydmljZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yb3V0ZXIyLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdCdWNrZXRDYWNoZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jYWNoZS5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9leHQvY29udHJvbGxlcicsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvY29udHJvbGxlci9saWIvY29udHJvbGxlcl9taXhpbicsICdlbWJlci1yb3V0aW5nL2xpYi91dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YWwsIF9jb250cm9sbGVyX21peGluLCBfdXRpbHMpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICBfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0LnJlb3Blbih7CiAgICBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOiBbJ3F1ZXJ5UGFyYW1zJ10sCgogICAgLyoqCiAgICAgIERlZmluZXMgd2hpY2ggcXVlcnkgcGFyYW1ldGVycyB0aGUgY29udHJvbGxlciBhY2NlcHRzLgogICAgICBJZiB5b3UgZ2l2ZSB0aGUgbmFtZXMgYFsnY2F0ZWdvcnknLCdwYWdlJ11gIGl0IHdpbGwgYmluZAogICAgICB0aGUgdmFsdWVzIG9mIHRoZXNlIHF1ZXJ5IHBhcmFtZXRlcnMgdG8gdGhlIHZhcmlhYmxlcwogICAgICBgdGhpcy5jYXRlZ29yeWAgYW5kIGB0aGlzLnBhZ2VgLgogICAgICBCeSBkZWZhdWx0LCBFbWJlciBjb2VyY2VzIHF1ZXJ5IHBhcmFtZXRlciB2YWx1ZXMgdXNpbmcgYHRvZ2dsZVByb3BlcnR5YC4KICAgICAgVGhpcyBiZWhhdmlvciBtYXkgbGVhZCB0byB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICAgIFRvIGV4cGxpY2l0bHkgY29uZmlndXJlIGEgcXVlcnkgcGFyYW1ldGVyIHByb3BlcnR5IHNvIGl0IGNvZXJjZXMgYXMgZXhwZWN0ZWQsIHlvdSBtdXN0IGRlZmluZSBhIHR5cGUgcHJvcGVydHk6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBxdWVyeVBhcmFtczogW3sKICAgICAgICAgIGNhdGVnb3J5OiB7CiAgICAgICAgICAgIHR5cGU6ICdib29sZWFuJwogICAgICAgICAgfQogICAgICAgIH1dCiAgICAgIGBgYAogICAgICBAZm9yIEVtYmVyLkNvbnRyb2xsZXJNaXhpbgogICAgICBAcHJvcGVydHkgcXVlcnlQYXJhbXMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHF1ZXJ5UGFyYW1zOiBudWxsLAoKICAgIC8qKgogICAgIFRoaXMgcHJvcGVydHkgaXMgdXBkYXRlZCB0byB2YXJpb3VzIGRpZmZlcmVudCBjYWxsYmFjayBmdW5jdGlvbnMgZGVwZW5kaW5nIG9uCiAgICAgdGhlIGN1cnJlbnQgInN0YXRlIiBvZiB0aGUgYmFja2luZyByb3V0ZS4gSXQgaXMgdXNlZCBieQogICAgIGBDb250cm9sbGVyLnByb3RvdHlwZS5fcXBDaGFuZ2VkYC4KICAgICAgVGhlIG1ldGhvZHMgYmFja2luZyBlYWNoIHN0YXRlIGNhbiBiZSBmb3VuZCBpbiB0aGUgYFJvdXRlLnByb3RvdHlwZS5fcXBgIGNvbXB1dGVkCiAgICAgcHJvcGVydHkgcmV0dXJuIHZhbHVlICh0aGUgYC5zdGF0ZXNgIHByb3BlcnR5KS4gVGhlIGN1cnJlbnQgdmFsdWVzIGFyZSBsaXN0ZWQgaGVyZSBmb3IKICAgICB0aGUgc2FuaXR5IG9mIGZ1dHVyZSB0cmF2ZWxlcnM6CiAgICAgICogYGluYWN0aXZlYCAtIFRoaXMgc3RhdGUgaXMgdXNlZCB3aGVuIHRoaXMgY29udHJvbGxlciBpbnN0YW5jZSBpcyBub3QgcGFydCBvZiB0aGUgYWN0aXZlCiAgICAgICByb3V0ZSBoaWVyYXJjaHkuIFNldCBpbiBgUm91dGUucHJvdG90eXBlLl9yZXNldGAgKGEgYHJvdXRlci5qc2AgbWljcm9saWIgaG9vaykgYW5kCiAgICAgICBgUm91dGUucHJvdG90eXBlLmFjdGlvbnMuZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlYC4KICAgICAqIGBhY3RpdmVgIC0gVGhpcyBzdGF0ZSBpcyB1c2VkIHdoZW4gdGhpcyBjb250cm9sbGVyIGluc3RhbmNlIGlzIHBhcnQgb2YgdGhlIGFjdGl2ZQogICAgICAgcm91dGUgaGllcmFyY2h5LiBTZXQgaW4gYFJvdXRlLnByb3RvdHlwZS5hY3Rpb25zLmZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZWAuCiAgICAgKiBgYWxsb3dPdmVycmlkZXNgIC0gVGhpcyBzdGF0ZSBpcyB1c2VkIGluIGBSb3V0ZS5wcm90b3R5cGUuc2V0dXBgIChgcm91dGUuanNgIG1pY3JvbGliIGhvb2spLgogICAgICAgQG1ldGhvZCBfcXBEZWxlZ2F0ZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9xcERlbGVnYXRlOiBudWxsLCBfcXBDaGFuZ2VkOiBmdW5jdGlvbiAoY29udHJvbGxlciwgX3Byb3ApIHsKICAgICAgdmFyIHByb3AgPSBfcHJvcC5zdWJzdHIoMCwgX3Byb3AubGVuZ3RoIC0gMyk7CgogICAgICB2YXIgZGVsZWdhdGUgPSBjb250cm9sbGVyLl9xcERlbGVnYXRlOwogICAgICB2YXIgdmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShjb250cm9sbGVyLCBwcm9wKTsKICAgICAgZGVsZWdhdGUocHJvcCwgdmFsdWUpOwogICAgfSwKICAgIHRyYW5zaXRpb25Ub1JvdXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIHRhcmdldCBtYXkgYmUgZWl0aGVyIGFub3RoZXIgY29udHJvbGxlciBvciBhIHJvdXRlcgogICAgICB2YXIgdGFyZ2V0ID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3RhcmdldCcpOwogICAgICB2YXIgbWV0aG9kID0gdGFyZ2V0LnRyYW5zaXRpb25Ub1JvdXRlIHx8IHRhcmdldC50cmFuc2l0aW9uVG87CgogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJncykpOwogICAgfSwKICAgIHJlcGxhY2VSb3V0ZTogZnVuY3Rpb24gKCkgewogICAgICAvLyB0YXJnZXQgbWF5IGJlIGVpdGhlciBhbm90aGVyIGNvbnRyb2xsZXIgb3IgYSByb3V0ZXIKICAgICAgdmFyIHRhcmdldCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd0YXJnZXQnKTsKICAgICAgdmFyIG1ldGhvZCA9IHRhcmdldC5yZXBsYWNlUm91dGUgfHwgdGFyZ2V0LnJlcGxhY2VXaXRoOwoKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbjIpLCBfa2V5MiA9IDA7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KCiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGFyZ2V0LCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJncykpOwogICAgfQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0Owp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9hcGknLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLWJyb3dzZXItZW52aXJvbm1lbnQnLCAnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vdXRpbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnLCBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQsIF91dGlsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSB7CiAgICAvKioKICAgICBUaGlzIGlzIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgdXNpbmcgdGhlIGNvbnRhaW5lciB0byBsb29rdXAgdGhlIGxvY2F0aW9uCiAgICAgaW1wbGVtZW50YXRpb24gYXMgZGVzaXJlZC4KICAgICAgRm9yIGV4YW1wbGU6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICAvLyBHaXZlbiBhIGxvY2F0aW9uIHJlZ2lzdGVyZWQgYXMgZm9sbG93czoKICAgICBjb250YWluZXIucmVnaXN0ZXIoJ2xvY2F0aW9uOmhpc3RvcnktdGVzdCcsIEhpc3RvcnlUZXN0TG9jYXRpb24pOwogICAgICAvLyBZb3UgY291bGQgY3JlYXRlIGEgbmV3IGluc3RhbmNlIHZpYToKICAgICBjb250YWluZXIubG9va3VwKCdsb2NhdGlvbjpoaXN0b3J5LXRlc3QnKTsKICAgICBgYGAKICAgICAgIEBtZXRob2QgY3JlYXRlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0gYW4gaW5zdGFuY2Ugb2YgYW4gaW1wbGVtZW50YXRpb24gb2YgdGhlIGBsb2NhdGlvbmAgQVBJCiAgICAgIEBkZXByZWNhdGVkIFVzZSB0aGUgY29udGFpbmVyIHRvIGxvb2t1cCB0aGUgbG9jYXRpb24gaW1wbGVtZW50YXRpb24gdGhhdCB5b3UKICAgICAgbmVlZC4KICAgICAgQHByaXZhdGUKICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIHZhciBpbXBsZW1lbnRhdGlvbiA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pbXBsZW1lbnRhdGlvbjsKICAgICAgKHRydWUgJiYgISghIWltcGxlbWVudGF0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoIkxvY2F0aW9uLmNyZWF0ZTogeW91IG11c3Qgc3BlY2lmeSBhICdpbXBsZW1lbnRhdGlvbicgb3B0aW9uIiwgISFpbXBsZW1lbnRhdGlvbikpOwoKCiAgICAgIHZhciBpbXBsZW1lbnRhdGlvbkNsYXNzID0gdGhpcy5pbXBsZW1lbnRhdGlvbnNbaW1wbGVtZW50YXRpb25dOwogICAgICAodHJ1ZSAmJiAhKCEhaW1wbGVtZW50YXRpb25DbGFzcykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdMb2NhdGlvbi5jcmVhdGU6ICcgKyBpbXBsZW1lbnRhdGlvbiArICcgaXMgbm90IGEgdmFsaWQgaW1wbGVtZW50YXRpb24nLCAhIWltcGxlbWVudGF0aW9uQ2xhc3MpKTsKCgogICAgICByZXR1cm4gaW1wbGVtZW50YXRpb25DbGFzcy5jcmVhdGUuYXBwbHkoaW1wbGVtZW50YXRpb25DbGFzcywgYXJndW1lbnRzKTsKICAgIH0sCgoKICAgIGltcGxlbWVudGF0aW9uczoge30sCiAgICBfbG9jYXRpb246IF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC5sb2NhdGlvbiwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgY3VycmVudCBgbG9jYXRpb24uaGFzaGAgYnkgcGFyc2luZyBsb2NhdGlvbi5ocmVmIHNpbmNlIGJyb3dzZXJzCiAgICAgIGluY29uc2lzdGVudGx5IFVSTC1kZWNvZGUgYGxvY2F0aW9uLmhhc2hgLgogICAgICAgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDgzMzA0CiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldEhhc2gKICAgICAgQHNpbmNlIDEuNC4wCiAgICAqLwogICAgX2dldEhhc2g6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfdXRpbC5nZXRIYXNoKSh0aGlzLmxvY2F0aW9uKTsKICAgIH0KICB9Owp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9hdXRvX2xvY2F0aW9uJywgWydleHBvcnRzJywgJ2VtYmVyLW93bmVyJywgJ2VtYmVyLXV0aWxzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1ydW50aW1lJywgJ2VtYmVyLWJyb3dzZXItZW52aXJvbm1lbnQnLCAnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vdXRpbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyT3duZXIsIF9lbWJlclV0aWxzLCBfZW1iZXJNZXRhbCwgX2RlYnVnLCBfZW1iZXJSdW50aW1lLCBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQsIF91dGlsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmdldEhpc3RvcnlQYXRoID0gZ2V0SGlzdG9yeVBhdGg7CiAgZXhwb3J0cy5nZXRIYXNoUGF0aCA9IGdldEhhc2hQYXRoOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0LmV4dGVuZCh7CiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgIFRoZSBicm93c2VyJ3MgYGxvY2F0aW9uYCBvYmplY3QuIFRoaXMgaXMgdHlwaWNhbGx5IGVxdWl2YWxlbnQgdG8KICAgICAgYHdpbmRvdy5sb2NhdGlvbmAsIGJ1dCBtYXkgYmUgb3ZlcnJpZGRlbiBmb3IgdGVzdGluZy4KICAgICAgIEBwcm9wZXJ0eSBsb2NhdGlvbgogICAgICBAZGVmYXVsdCBlbnZpcm9ubWVudC5sb2NhdGlvbgogICAgKi8KICAgIGxvY2F0aW9uOiBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQubG9jYXRpb24sCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICBUaGUgYnJvd3NlcidzIGBoaXN0b3J5YCBvYmplY3QuIFRoaXMgaXMgdHlwaWNhbGx5IGVxdWl2YWxlbnQgdG8KICAgICAgYHdpbmRvdy5oaXN0b3J5YCwgYnV0IG1heSBiZSBvdmVycmlkZGVuIGZvciB0ZXN0aW5nLgogICAgICAgQHNpbmNlIDEuNS4xCiAgICAgIEBwcm9wZXJ0eSBoaXN0b3J5CiAgICAgIEBkZWZhdWx0IGVudmlyb25tZW50Lmhpc3RvcnkKICAgICovCiAgICBoaXN0b3J5OiBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaGlzdG9yeSwKCiAgICAvKioKICAgICBAcHJpdmF0ZQogICAgICBUaGUgdXNlciBhZ2VudCdzIGdsb2JhbCB2YXJpYWJsZS4gSW4gYnJvd3NlcnMsIHRoaXMgd2lsbCBiZSBgd2luZG93YC4KICAgICAgQHNpbmNlIDEuMTEKICAgICBAcHJvcGVydHkgZ2xvYmFsCiAgICAgQGRlZmF1bHQgd2luZG93CiAgICAqLwogICAgZ2xvYmFsOiBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQud2luZG93LAoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgVGhlIGJyb3dzZXIncyBgdXNlckFnZW50YC4gVGhpcyBpcyB0eXBpY2FsbHkgZXF1aXZhbGVudCB0bwogICAgICBgbmF2aWdhdG9yLnVzZXJBZ2VudGAsIGJ1dCBtYXkgYmUgb3ZlcnJpZGRlbiBmb3IgdGVzdGluZy4KICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAcHJvcGVydHkgdXNlckFnZW50CiAgICAgIEBkZWZhdWx0IGVudmlyb25tZW50Lmhpc3RvcnkKICAgICovCiAgICB1c2VyQWdlbnQ6IF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC51c2VyQWdlbnQsCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICBUaGlzIHByb3BlcnR5IGlzIHVzZWQgYnkgdGhlIHJvdXRlciB0byBrbm93IHdoZXRoZXIgdG8gY2FuY2VsIHRoZSByb3V0aW5nCiAgICAgIHNldHVwIHByb2Nlc3MsIHdoaWNoIGlzIG5lZWRlZCB3aGlsZSB3ZSByZWRpcmVjdCB0aGUgYnJvd3Nlci4KICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAcHJvcGVydHkgY2FuY2VsUm91dGVyU2V0dXAKICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICovCiAgICBjYW5jZWxSb3V0ZXJTZXR1cDogZmFsc2UsCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICBXaWxsIGJlIHByZS1wZW5kZWQgdG8gcGF0aCB1cG9uIHN0YXRlIGNoYW5nZS4KICAgICAgIEBzaW5jZSAxLjUuMQogICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICovCiAgICByb290VVJMOiAnLycsCgogICAgLyoqCiAgICAgQ2FsbGVkIGJ5IHRoZSByb3V0ZXIgdG8gaW5zdHJ1Y3QgdGhlIGxvY2F0aW9uIHRvIGRvIGFueSBmZWF0dXJlIGRldGVjdGlvbgogICAgIG5lY2Vzc2FyeS4gSW4gdGhlIGNhc2Ugb2YgQXV0b0xvY2F0aW9uLCB3ZSBkZXRlY3Qgd2hldGhlciB0byB1c2UgaGlzdG9yeQogICAgIG9yIGhhc2ggY29uY3JldGUgaW1wbGVtZW50YXRpb25zLgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGRldGVjdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcm9vdFVSTCA9IHRoaXMucm9vdFVSTDsKCiAgICAgICh0cnVlICYmICEocm9vdFVSTC5jaGFyQXQocm9vdFVSTC5sZW5ndGggLSAxKSA9PT0gJy8nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ3Jvb3RVUkwgbXVzdCBlbmQgd2l0aCBhIHRyYWlsaW5nIGZvcndhcmQgc2xhc2ggZS5nLiAiL2FwcC8iJywgcm9vdFVSTC5jaGFyQXQocm9vdFVSTC5sZW5ndGggLSAxKSA9PT0gJy8nKSk7CgoKICAgICAgdmFyIGltcGxlbWVudGF0aW9uID0gZGV0ZWN0SW1wbGVtZW50YXRpb24oewogICAgICAgIGxvY2F0aW9uOiB0aGlzLmxvY2F0aW9uLAogICAgICAgIGhpc3Rvcnk6IHRoaXMuaGlzdG9yeSwKICAgICAgICB1c2VyQWdlbnQ6IHRoaXMudXNlckFnZW50LAogICAgICAgIHJvb3RVUkw6IHJvb3RVUkwsCiAgICAgICAgZG9jdW1lbnRNb2RlOiB0aGlzLmRvY3VtZW50TW9kZSwKICAgICAgICBnbG9iYWw6IHRoaXMuZ2xvYmFsCiAgICAgIH0pOwoKICAgICAgaWYgKGltcGxlbWVudGF0aW9uID09PSBmYWxzZSkgewogICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMsICdjYW5jZWxSb3V0ZXJTZXR1cCcsIHRydWUpOwogICAgICAgIGltcGxlbWVudGF0aW9uID0gJ25vbmUnOwogICAgICB9CgogICAgICB2YXIgY29uY3JldGUgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHRoaXMpLmxvb2t1cCgnbG9jYXRpb246JyArIGltcGxlbWVudGF0aW9uKTsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkoY29uY3JldGUsICdyb290VVJMJywgcm9vdFVSTCk7CgogICAgICAodHJ1ZSAmJiAhKCEhY29uY3JldGUpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ291bGQgbm90IGZpbmQgbG9jYXRpb24gXCcnICsgaW1wbGVtZW50YXRpb24gKyAnXCcuJywgISFjb25jcmV0ZSkpOwoKCiAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMsICdjb25jcmV0ZUltcGxlbWVudGF0aW9uJywgY29uY3JldGUpOwogICAgfSwKCgogICAgaW5pdFN0YXRlOiBkZWxlZ2F0ZVRvQ29uY3JldGVJbXBsZW1lbnRhdGlvbignaW5pdFN0YXRlJyksCiAgICBnZXRVUkw6IGRlbGVnYXRlVG9Db25jcmV0ZUltcGxlbWVudGF0aW9uKCdnZXRVUkwnKSwKICAgIHNldFVSTDogZGVsZWdhdGVUb0NvbmNyZXRlSW1wbGVtZW50YXRpb24oJ3NldFVSTCcpLAogICAgcmVwbGFjZVVSTDogZGVsZWdhdGVUb0NvbmNyZXRlSW1wbGVtZW50YXRpb24oJ3JlcGxhY2VVUkwnKSwKICAgIG9uVXBkYXRlVVJMOiBkZWxlZ2F0ZVRvQ29uY3JldGVJbXBsZW1lbnRhdGlvbignb25VcGRhdGVVUkwnKSwKICAgIGZvcm1hdFVSTDogZGVsZWdhdGVUb0NvbmNyZXRlSW1wbGVtZW50YXRpb24oJ2Zvcm1hdFVSTCcpLAoKICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb25jcmV0ZUltcGxlbWVudGF0aW9uID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2NvbmNyZXRlSW1wbGVtZW50YXRpb24nKTsKCiAgICAgIGlmIChjb25jcmV0ZUltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgY29uY3JldGVJbXBsZW1lbnRhdGlvbi5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KICB9KTsKCgogIGZ1bmN0aW9uIGRlbGVnYXRlVG9Db25jcmV0ZUltcGxlbWVudGF0aW9uKG1ldGhvZE5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb25jcmV0ZUltcGxlbWVudGF0aW9uID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2NvbmNyZXRlSW1wbGVtZW50YXRpb24nKTsKICAgICAgKHRydWUgJiYgISghIWNvbmNyZXRlSW1wbGVtZW50YXRpb24pICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQXV0b0xvY2F0aW9uJ3MgZGV0ZWN0KCkgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYW55IG90aGVyIGhvb2tzLiIsICEhY29uY3JldGVJbXBsZW1lbnRhdGlvbikpOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gKDAsIF9lbWJlclV0aWxzLnRyeUludm9rZSkoY29uY3JldGVJbXBsZW1lbnRhdGlvbiwgbWV0aG9kTmFtZSwgYXJncyk7CiAgICB9OwogIH0KCiAgLyoKICAgIEdpdmVuIHRoZSBicm93c2VyJ3MgYGxvY2F0aW9uYCwgYGhpc3RvcnlgIGFuZCBgdXNlckFnZW50YCwgYW5kIGEgY29uZmlndXJlZAogICAgcm9vdCBVUkwsIHRoaXMgZnVuY3Rpb24gZGV0ZWN0cyB3aGV0aGVyIHRoZSBicm93c2VyIHN1cHBvcnRzIHRoZSBbSGlzdG9yeQogICAgQVBJXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSGlzdG9yeSkgYW5kIHJldHVybnMgYQogICAgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgTG9jYXRpb24gb2JqZWN0IHRvIHVzZSBiYXNlZCBvbiBpdHMgZGV0ZXJtaW5hdGlvbi4KICAKICAgIEZvciBleGFtcGxlLCBpZiB0aGUgcGFnZSBsb2FkcyBpbiBhbiBldmVyZ3JlZW4gYnJvd3NlciwgdGhpcyBmdW5jdGlvbiB3b3VsZAogICAgcmV0dXJuIHRoZSBzdHJpbmcgImhpc3RvcnkiLCBtZWFuaW5nIHRoZSBoaXN0b3J5IEFQSSBhbmQgdGh1cyBIaXN0b3J5TG9jYXRpb24KICAgIHNob3VsZCBiZSB1c2VkLiBJZiB0aGUgcGFnZSBpcyBsb2FkZWQgaW4gSUU4LCBpdCB3aWxsIHJldHVybiB0aGUgc3RyaW5nCiAgICAiaGFzaCwiIGluZGljYXRpbmcgdGhhdCB0aGUgSGlzdG9yeSBBUEkgc2hvdWxkIGJlIHNpbXVsYXRlZCBieSBtYW5pcHVsYXRpbmcgdGhlCiAgICBoYXNoIHBvcnRpb24gb2YgdGhlIGxvY2F0aW9uLgogIAogICovCgogIGZ1bmN0aW9uIGRldGVjdEltcGxlbWVudGF0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBsb2NhdGlvbiA9IG9wdGlvbnMubG9jYXRpb24sCiAgICAgICAgdXNlckFnZW50ID0gb3B0aW9ucy51c2VyQWdlbnQsCiAgICAgICAgaGlzdG9yeSA9IG9wdGlvbnMuaGlzdG9yeSwKICAgICAgICBkb2N1bWVudE1vZGUgPSBvcHRpb25zLmRvY3VtZW50TW9kZSwKICAgICAgICBnbG9iYWwgPSBvcHRpb25zLmdsb2JhbCwKICAgICAgICByb290VVJMID0gb3B0aW9ucy5yb290VVJMOwoKCiAgICB2YXIgaW1wbGVtZW50YXRpb24gPSAnbm9uZSc7CiAgICB2YXIgY2FuY2VsUm91dGVyU2V0dXAgPSBmYWxzZTsKICAgIHZhciBjdXJyZW50UGF0aCA9ICgwLCBfdXRpbC5nZXRGdWxsUGF0aCkobG9jYXRpb24pOwoKICAgIGlmICgoMCwgX3V0aWwuc3VwcG9ydHNIaXN0b3J5KSh1c2VyQWdlbnQsIGhpc3RvcnkpKSB7CiAgICAgIHZhciBoaXN0b3J5UGF0aCA9IGdldEhpc3RvcnlQYXRoKHJvb3RVUkwsIGxvY2F0aW9uKTsKCiAgICAgIC8vIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIGhpc3RvcnkgYW5kIHdlIGhhdmUgYSBoaXN0b3J5IHBhdGgsIHdlIGNhbiB1c2UKICAgICAgLy8gdGhlIGhpc3RvcnkgbG9jYXRpb24gd2l0aCBubyByZWRpcmVjdHMuCiAgICAgIGlmIChjdXJyZW50UGF0aCA9PT0gaGlzdG9yeVBhdGgpIHsKICAgICAgICBpbXBsZW1lbnRhdGlvbiA9ICdoaXN0b3J5JzsKICAgICAgfSBlbHNlIGlmIChjdXJyZW50UGF0aC5zdWJzdHIoMCwgMikgPT09ICcvIycpIHsKICAgICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSh7IHBhdGg6IGhpc3RvcnlQYXRoIH0sIG51bGwsIGhpc3RvcnlQYXRoKTsKICAgICAgICBpbXBsZW1lbnRhdGlvbiA9ICdoaXN0b3J5JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYW5jZWxSb3V0ZXJTZXR1cCA9IHRydWU7CiAgICAgICAgKDAsIF91dGlsLnJlcGxhY2VQYXRoKShsb2NhdGlvbiwgaGlzdG9yeVBhdGgpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCgwLCBfdXRpbC5zdXBwb3J0c0hhc2hDaGFuZ2UpKGRvY3VtZW50TW9kZSwgZ2xvYmFsKSkgewogICAgICB2YXIgaGFzaFBhdGggPSBnZXRIYXNoUGF0aChyb290VVJMLCBsb2NhdGlvbik7CgogICAgICAvLyBCZSBzdXJlIHdlJ3JlIHVzaW5nIGEgaGFzaGVkIHBhdGgsIG90aGVyd2lzZSBsZXQncyBzd2l0Y2ggb3ZlciBpdCB0byBzbwogICAgICAvLyB3ZSBzdGFydCBvZmYgY2xlYW4gYW5kIGNvbnNpc3RlbnQuIFdlJ2xsIGNvdW50IGFuIGluZGV4IHBhdGggd2l0aCBubwogICAgICAvLyBoYXNoIGFzICJnb29kIGVub3VnaCIgYXMgd2VsbC4KICAgICAgaWYgKGN1cnJlbnRQYXRoID09PSBoYXNoUGF0aCB8fCBjdXJyZW50UGF0aCA9PT0gJy8nICYmIGhhc2hQYXRoID09PSAnLyMvJykgewogICAgICAgIGltcGxlbWVudGF0aW9uID0gJ2hhc2gnOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIE91ciBVUkwgaXNuJ3QgaW4gdGhlIGV4cGVjdGVkIGhhc2gtc3VwcG9ydGVkIGZvcm1hdCwgc28gd2Ugd2FudCB0bwogICAgICAgIC8vIGNhbmNlbCB0aGUgcm91dGVyIHNldHVwIGFuZCByZXBsYWNlIHRoZSBVUkwgdG8gc3RhcnQgb2ZmIGNsZWFuCiAgICAgICAgY2FuY2VsUm91dGVyU2V0dXAgPSB0cnVlOwogICAgICAgICgwLCBfdXRpbC5yZXBsYWNlUGF0aCkobG9jYXRpb24sIGhhc2hQYXRoKTsKICAgICAgfQogICAgfQoKICAgIGlmIChjYW5jZWxSb3V0ZXJTZXR1cCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIGltcGxlbWVudGF0aW9uOwogIH0KCiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgUmV0dXJucyB0aGUgY3VycmVudCBwYXRoIGFzIGl0IHNob3VsZCBhcHBlYXIgZm9yIEhpc3RvcnlMb2NhdGlvbiBzdXBwb3J0ZWQKICAgIGJyb3dzZXJzLiBUaGlzIG1heSB2ZXJ5IHdlbGwgZGlmZmVyIGZyb20gdGhlIHJlYWwgY3VycmVudCBwYXRoIChlLmcuIGlmIGl0CiAgICBzdGFydHMgb2ZmIGFzIGEgaGFzaGVkIFVSTCkKICAqLwogIGZ1bmN0aW9uIGdldEhpc3RvcnlQYXRoKHJvb3RVUkwsIGxvY2F0aW9uKSB7CiAgICB2YXIgcGF0aCA9ICgwLCBfdXRpbC5nZXRQYXRoKShsb2NhdGlvbik7CiAgICB2YXIgaGFzaCA9ICgwLCBfdXRpbC5nZXRIYXNoKShsb2NhdGlvbik7CiAgICB2YXIgcXVlcnkgPSAoMCwgX3V0aWwuZ2V0UXVlcnkpKGxvY2F0aW9uKTsKICAgIHZhciByb290VVJMSW5kZXggPSBwYXRoLmluZGV4T2Yocm9vdFVSTCk7CiAgICB2YXIgcm91dGVIYXNoID0gdm9pZCAwLAogICAgICAgIGhhc2hQYXJ0cyA9IHZvaWQgMDsKCiAgICAodHJ1ZSAmJiAhKHJvb3RVUkxJbmRleCA9PT0gMCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdQYXRoICcgKyBwYXRoICsgJyBkb2VzIG5vdCBzdGFydCB3aXRoIHRoZSBwcm92aWRlZCByb290VVJMICcgKyByb290VVJMLCByb290VVJMSW5kZXggPT09IDApKTsKCgogICAgLy8gQnkgY29udmVudGlvbiwgRW1iZXIuanMgcm91dGVzIHVzaW5nIEhhc2hMb2NhdGlvbiBhcmUgcmVxdWlyZWQgdG8gc3RhcnQKICAgIC8vIHdpdGggYCMvYC4gQW55dGhpbmcgZWxzZSBzaG91bGQgTk9UIGJlIGNvbnNpZGVyZWQgYSByb3V0ZSBhbmQgc2hvdWxkCiAgICAvLyBiZSBwYXNzZWQgc3RyYWlnaHQgdGhyb3VnaCwgd2l0aG91dCB0cmFuc2Zvcm1hdGlvbi4KICAgIGlmIChoYXNoLnN1YnN0cigwLCAyKSA9PT0gJyMvJykgewogICAgICAvLyBUaGVyZSBjb3VsZCBiZSBleHRyYSBoYXNoIHNlZ21lbnRzIGFmdGVyIHRoZSByb3V0ZQogICAgICBoYXNoUGFydHMgPSBoYXNoLnN1YnN0cigxKS5zcGxpdCgnIycpOwogICAgICAvLyBUaGUgZmlyc3Qgb25lIGlzIGFsd2F5cyB0aGUgcm91dGUgdXJsCiAgICAgIHJvdXRlSGFzaCA9IGhhc2hQYXJ0cy5zaGlmdCgpOwoKICAgICAgLy8gSWYgdGhlIHBhdGggYWxyZWFkeSBoYXMgYSB0cmFpbGluZyBzbGFzaCwgcmVtb3ZlIHRoZSBvbmUKICAgICAgLy8gZnJvbSB0aGUgaGFzaGVkIHJvdXRlIHNvIHdlIGRvbid0IGRvdWJsZSB1cC4KICAgICAgaWYgKHBhdGguY2hhckF0KHBhdGgubGVuZ3RoIC0gMSkgPT09ICcvJykgewogICAgICAgIHJvdXRlSGFzaCA9IHJvdXRlSGFzaC5zdWJzdHIoMSk7CiAgICAgIH0KCiAgICAgIC8vIFRoaXMgaXMgdGhlICJleHBlY3RlZCIgZmluYWwgb3JkZXIKICAgICAgcGF0aCArPSByb3V0ZUhhc2ggKyBxdWVyeTsKCiAgICAgIGlmIChoYXNoUGFydHMubGVuZ3RoKSB7CiAgICAgICAgcGF0aCArPSAnIycgKyBoYXNoUGFydHMuam9pbignIycpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBwYXRoICs9IHF1ZXJ5ICsgaGFzaDsKICAgIH0KCiAgICByZXR1cm4gcGF0aDsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgcGF0aCBhcyBpdCBzaG91bGQgYXBwZWFyIGZvciBIYXNoTG9jYXRpb24gc3VwcG9ydGVkCiAgICBicm93c2Vycy4gVGhpcyBtYXkgdmVyeSB3ZWxsIGRpZmZlciBmcm9tIHRoZSByZWFsIGN1cnJlbnQgcGF0aC4KICAKICAgIEBtZXRob2QgX2dldEhhc2hQYXRoCiAgKi8KICBmdW5jdGlvbiBnZXRIYXNoUGF0aChyb290VVJMLCBsb2NhdGlvbikgewogICAgdmFyIHBhdGggPSByb290VVJMOwogICAgdmFyIGhpc3RvcnlQYXRoID0gZ2V0SGlzdG9yeVBhdGgocm9vdFVSTCwgbG9jYXRpb24pOwogICAgdmFyIHJvdXRlUGF0aCA9IGhpc3RvcnlQYXRoLnN1YnN0cihyb290VVJMLmxlbmd0aCk7CgogICAgaWYgKHJvdXRlUGF0aCAhPT0gJycpIHsKICAgICAgaWYgKHJvdXRlUGF0aFswXSAhPT0gJy8nKSB7CiAgICAgICAgcm91dGVQYXRoID0gJy8nICsgcm91dGVQYXRoOwogICAgICB9CgogICAgICBwYXRoICs9ICcjJyArIHJvdXRlUGF0aDsKICAgIH0KCiAgICByZXR1cm4gcGF0aDsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXJvdXRpbmcvbGliL2xvY2F0aW9uL2hhc2hfbG9jYXRpb24nLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItbWV0YWwnLCAnZW1iZXItcnVudGltZScsICdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9hcGknXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9ydW5sb29wLCBfZW1iZXJNZXRhbCwgX2VtYmVyUnVudGltZSwgX2FwaSkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyUnVudGltZS5PYmplY3QuZXh0ZW5kKHsKICAgIGltcGxlbWVudGF0aW9uOiAnaGFzaCcsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCAnbG9jYXRpb24nLCAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnX2xvY2F0aW9uJykgfHwgd2luZG93LmxvY2F0aW9uKTsKCiAgICAgIHRoaXMuX2hhc2hjaGFuZ2VIYW5kbGVyID0gdW5kZWZpbmVkOwogICAgfSwKCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICBSZXR1cm5zIG5vcm1hbGl6ZWQgbG9jYXRpb24uaGFzaAogICAgICAgQHNpbmNlIDEuNS4xCiAgICAgIEBtZXRob2QgZ2V0SGFzaAogICAgKi8KICAgIGdldEhhc2g6IF9hcGkuZGVmYXVsdC5fZ2V0SGFzaCwKCiAgICAvKioKICAgICAgUmV0dXJucyB0aGUgbm9ybWFsaXplZCBVUkwsIGNvbnN0cnVjdGVkIGZyb20gYGxvY2F0aW9uLmhhc2hgLgogICAgICAgZS5nLiBgIy9mb29gID0+IGAvZm9vYCBhcyB3ZWxsIGFzIGAjL2ZvbyNiYXJgID0+IGAvZm9vI2JhcmAuCiAgICAgICBCeSBjb252ZW50aW9uLCBoYXNoZWQgcGF0aHMgbXVzdCBiZWdpbiB3aXRoIGEgZm9yd2FyZCBzbGFzaCwgb3RoZXJ3aXNlIHRoZXkKICAgICAgYXJlIG5vdCB0cmVhdGVkIGFzIGEgcGF0aCBzbyB3ZSBjYW4gZGlzdGluZ3Vpc2ggaW50ZW50LgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBnZXRVUkwKICAgICovCiAgICBnZXRVUkw6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG9yaWdpbmFsUGF0aCA9IHRoaXMuZ2V0SGFzaCgpLnN1YnN0cigxKTsKICAgICAgdmFyIG91dFBhdGggPSBvcmlnaW5hbFBhdGg7CgogICAgICBpZiAob3V0UGF0aFswXSAhPT0gJy8nKSB7CiAgICAgICAgb3V0UGF0aCA9ICcvJzsKCiAgICAgICAgLy8gT25seSBhZGQgdGhlICMgaWYgdGhlIHBhdGggaXNuJ3QgZW1wdHkuCiAgICAgICAgLy8gV2UgZG8gTk9UIHdhbnQgYC8jYCBzaW5jZSB0aGUgYW1wZXJzYW5kCiAgICAgICAgLy8gaXMgb25seSBpbmNsdWRlZCAoY29udmVudGlvbmFsbHkpIHdoZW4KICAgICAgICAvLyB0aGUgbG9jYXRpb24uaGFzaCBoYXMgYSB2YWx1ZQogICAgICAgIGlmIChvcmlnaW5hbFBhdGgpIHsKICAgICAgICAgIG91dFBhdGggKz0gJyMnICsgb3JpZ2luYWxQYXRoOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG91dFBhdGg7CiAgICB9LAoKCiAgICAvKioKICAgICAgU2V0IHRoZSBgbG9jYXRpb24uaGFzaGAgYW5kIHJlbWVtYmVycyB3aGF0IHdhcyBzZXQuIFRoaXMgcHJldmVudHMKICAgICAgYG9uVXBkYXRlVVJMYCBjYWxsYmFja3MgZnJvbSB0cmlnZ2VyaW5nIHdoZW4gdGhlIGhhc2ggd2FzIHNldCBieQogICAgICBgSGFzaExvY2F0aW9uYC4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2Qgc2V0VVJMCiAgICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgICAqLwogICAgc2V0VVJMOiBmdW5jdGlvbiAocGF0aCkgewogICAgICAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbG9jYXRpb24nKS5oYXNoID0gcGF0aDsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2xhc3RTZXRVUkwnLCBwYXRoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBVc2VzIGxvY2F0aW9uLnJlcGxhY2UgdG8gdXBkYXRlIHRoZSB1cmwgd2l0aG91dCBhIHBhZ2UgcmVsb2FkCiAgICAgIG9yIGhpc3RvcnkgbW9kaWZpY2F0aW9uLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCByZXBsYWNlVVJMCiAgICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgICAqLwogICAgcmVwbGFjZVVSTDogZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xvY2F0aW9uJykucmVwbGFjZSgnIycgKyBwYXRoKTsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2xhc3RTZXRVUkwnLCBwYXRoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgaGFzaCBjaGFuZ2VzLiBUaGVzZQogICAgICBjYWxsYmFja3Mgd2lsbCBleGVjdXRlIHdoZW4gdGhlIHVzZXIgcHJlc3NlcyB0aGUgYmFjayBvciBmb3J3YXJkCiAgICAgIGJ1dHRvbiwgYnV0IG5vdCBhZnRlciBgc2V0VVJMYCBpcyBpbnZva2VkLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgKi8KICAgIG9uVXBkYXRlVVJMOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5fcmVtb3ZlRXZlbnRMaXN0ZW5lcigpOwoKICAgICAgdGhpcy5faGFzaGNoYW5nZUhhbmRsZXIgPSAoMCwgX3J1bmxvb3AuYmluZCkodGhpcywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwYXRoID0gdGhpcy5nZXRVUkwoKTsKICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xhc3RTZXRVUkwnKSA9PT0gcGF0aCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2xhc3RTZXRVUkwnLCBudWxsKTsKCiAgICAgICAgY2FsbGJhY2socGF0aCk7CiAgICAgIH0pOwoKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCB0aGlzLl9oYXNoY2hhbmdlSGFuZGxlcik7CiAgICB9LAoKCiAgICAvKioKICAgICAgR2l2ZW4gYSBVUkwsIGZvcm1hdHMgaXQgdG8gYmUgcGxhY2VkIGludG8gdGhlIHBhZ2UgYXMgcGFydAogICAgICBvZiBhbiBlbGVtZW50J3MgYGhyZWZgIGF0dHJpYnV0ZS4KICAgICAgIFRoaXMgaXMgdXNlZCwgZm9yIGV4YW1wbGUsIHdoZW4gdXNpbmcgdGhlIHt7YWN0aW9ufX0gaGVscGVyCiAgICAgIHRvIGdlbmVyYXRlIGEgVVJMIGJhc2VkIG9uIGFuIGV2ZW50LgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBmb3JtYXRVUkwKICAgICAgQHBhcmFtIHVybCB7U3RyaW5nfQogICAgKi8KICAgIGZvcm1hdFVSTDogZnVuY3Rpb24gKHVybCkgewogICAgICByZXR1cm4gJyMnICsgdXJsOwogICAgfSwKCgogICAgLyoqCiAgICAgIENsZWFucyB1cCB0aGUgSGFzaExvY2F0aW9uIGV2ZW50IGxpc3RlbmVyLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3aWxsRGVzdHJveQogICAgKi8KICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlbW92ZUV2ZW50TGlzdGVuZXIoKTsKICAgIH0sCiAgICBfcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5faGFzaGNoYW5nZUhhbmRsZXIpIHsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignaGFzaGNoYW5nZScsIHRoaXMuX2hhc2hjaGFuZ2VIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9oaXN0b3J5X2xvY2F0aW9uJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXJ1bnRpbWUnLCAnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vYXBpJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCwgX2VtYmVyUnVudGltZSwgX2FwaSkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgQG1vZHVsZSBAZW1iZXIvcm91dGluZwogICovCgogIHZhciBwb3BzdGF0ZUZpcmVkID0gZmFsc2U7CgogIGZ1bmN0aW9uIF91dWlkKCkgewogICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHsKICAgICAgdmFyIHIsIHY7CiAgICAgIHIgPSBNYXRoLnJhbmRvbSgpICogMTYgfCAwOwogICAgICB2ID0gYyA9PT0gJ3gnID8gciA6IHIgJiAzIHwgODsKICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpOwogICAgfSk7CiAgfQoKICAvKioKICAgIEhpc3RvcnlMb2NhdGlvbiBpbXBsZW1lbnRzIHRoZSBsb2NhdGlvbiBBUEkgdXNpbmcgdGhlIGJyb3dzZXIncwogICAgaGlzdG9yeS5wdXNoU3RhdGUgQVBJLgogIAogICAgVXNpbmcgYEhpc3RvcnlMb2NhdGlvbmAgcmVzdWx0cyBpbiBVUkxzIHRoYXQgYXJlIGluZGlzdGluZ3Vpc2hhYmxlIGZyb20gYQogICAgc3RhbmRhcmQgVVJMLiBUaGlzIHJlbGllcyB1cG9uIHRoZSBicm93c2VyJ3MgYGhpc3RvcnlgIEFQSS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBhcHAvcm91dGVyLmpzCiAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJvdXRlKCdwb3N0cycsIGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm91dGUoJ25ldycpOwogICAgICB9KTsKICAgIH0pOwogIAogICAgUm91dGVyLnJlb3Blbih7CiAgICAgIGxvY2F0aW9uOiAnaGlzdG9yeScKICAgIH0pOwogICAgYGBgCiAgCiAgICBUaGlzIHdpbGwgcmVzdWx0IGluIGEgcG9zdHMubmV3IHVybCBvZiBgL3Bvc3RzL25ld2AuCiAgCiAgICBLZWVwIGluIG1pbmQgdGhhdCB5b3VyIHNlcnZlciBtdXN0IHNlcnZlIHRoZSBFbWJlciBhcHAgYXQgYWxsIHRoZSByb3V0ZXMgeW91CiAgICBkZWZpbmUuCiAgCiAgICBAY2xhc3MgSGlzdG9yeUxvY2F0aW9uCiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHByb3RlY3RlZAogICovCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyUnVudGltZS5PYmplY3QuZXh0ZW5kKHsKICAgIGltcGxlbWVudGF0aW9uOiAnaGlzdG9yeScsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdmFyIGJhc2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdiYXNlJyk7CiAgICAgIHZhciBiYXNlVVJMID0gJyc7CiAgICAgIGlmIChiYXNlKSB7CiAgICAgICAgYmFzZVVSTCA9IGJhc2UuZ2V0QXR0cmlidXRlKCdocmVmJyk7CiAgICAgIH0KCiAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMsICdiYXNlVVJMJywgYmFzZVVSTCk7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRoaXMsICdsb2NhdGlvbicsICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2NhdGlvbicpIHx8IHdpbmRvdy5sb2NhdGlvbik7CgogICAgICB0aGlzLl9wb3BzdGF0ZUhhbmRsZXIgPSB1bmRlZmluZWQ7CiAgICB9LAoKCiAgICAvKioKICAgICAgVXNlZCB0byBzZXQgc3RhdGUgb24gZmlyc3QgY2FsbCB0byBzZXRVUkwKICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgaW5pdFN0YXRlCiAgICAqLwogICAgaW5pdFN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBoaXN0b3J5ID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2hpc3RvcnknKSB8fCB3aW5kb3cuaGlzdG9yeTsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2hpc3RvcnknLCBoaXN0b3J5KTsKCiAgICAgIGlmIChoaXN0b3J5ICYmICdzdGF0ZScgaW4gaGlzdG9yeSkgewogICAgICAgIHRoaXMuc3VwcG9ydHNIaXN0b3J5ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIHN0YXRlID0gdGhpcy5nZXRTdGF0ZSgpOwogICAgICB2YXIgcGF0aCA9IHRoaXMuZm9ybWF0VVJMKHRoaXMuZ2V0VVJMKCkpOwogICAgICBpZiAoc3RhdGUgJiYgc3RhdGUucGF0aCA9PT0gcGF0aCkgewogICAgICAgIC8vIHByZXNlcnZlIGV4aXN0aW5nIHN0YXRlCiAgICAgICAgLy8gdXNlZCBmb3Igd2Via2l0IHdvcmthcm91bmQsIHNpbmNlIHRoZXJlIHdpbGwgYmUgbm8gaW5pdGlhbCBwb3BzdGF0ZSBldmVudAogICAgICAgIHRoaXMuX3ByZXZpb3VzVVJMID0gdGhpcy5nZXRVUkwoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlcGxhY2VTdGF0ZShwYXRoKTsKICAgICAgfQogICAgfSwKCgogICAgLyoqCiAgICAgIFdpbGwgYmUgcHJlLXBlbmRlZCB0byBwYXRoIHVwb24gc3RhdGUgY2hhbmdlCiAgICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICAgQHByaXZhdGUKICAgICovCiAgICByb290VVJMOiAnLycsCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLnBhdGhuYW1lYCB3aXRob3V0IGByb290VVJMYCBvciBgYmFzZVVSTGAKICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0VVJMCiAgICAgIEByZXR1cm4gdXJsIHtTdHJpbmd9CiAgICAqLwogICAgZ2V0VVJMOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsb2NhdGlvbiA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2NhdGlvbicpOwogICAgICB2YXIgcGF0aCA9IGxvY2F0aW9uLnBhdGhuYW1lOwoKICAgICAgdmFyIHJvb3RVUkwgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm9vdFVSTCcpOwogICAgICB2YXIgYmFzZVVSTCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdiYXNlVVJMJyk7CgogICAgICAvLyByZW1vdmUgdHJhaWxpbmcgc2xhc2hlcyBpZiB0aGV5IGV4aXN0cwogICAgICByb290VVJMID0gcm9vdFVSTC5yZXBsYWNlKC9cLyQvLCAnJyk7CiAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKCiAgICAgIC8vIHJlbW92ZSBiYXNlVVJMIGFuZCByb290VVJMIGZyb20gc3RhcnQgb2YgcGF0aAogICAgICB2YXIgdXJsID0gcGF0aC5yZXBsYWNlKG5ldyBSZWdFeHAoJ14nICsgYmFzZVVSTCArICcoPz0vfCQpJyksICcnKS5yZXBsYWNlKG5ldyBSZWdFeHAoJ14nICsgcm9vdFVSTCArICcoPz0vfCQpJyksICcnKS5yZXBsYWNlKC9cL1wvJC9nLCAnLycpOyAvLyByZW1vdmUgZXh0cmEgc2xhc2hlcwoKICAgICAgdmFyIHNlYXJjaCA9IGxvY2F0aW9uLnNlYXJjaCB8fCAnJzsKICAgICAgdXJsICs9IHNlYXJjaCArIHRoaXMuZ2V0SGFzaCgpOwoKICAgICAgcmV0dXJuIHVybDsKICAgIH0sCgoKICAgIC8qKgogICAgICBVc2VzIGBoaXN0b3J5LnB1c2hTdGF0ZWAgdG8gdXBkYXRlIHRoZSB1cmwgd2l0aG91dCBhIHBhZ2UgcmVsb2FkLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBzZXRVUkwKICAgICAgQHBhcmFtIHBhdGgge1N0cmluZ30KICAgICovCiAgICBzZXRVUkw6IGZ1bmN0aW9uIChwYXRoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKTsKICAgICAgcGF0aCA9IHRoaXMuZm9ybWF0VVJMKHBhdGgpOwoKICAgICAgaWYgKCFzdGF0ZSB8fCBzdGF0ZS5wYXRoICE9PSBwYXRoKSB7CiAgICAgICAgdGhpcy5wdXNoU3RhdGUocGF0aCk7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICBVc2VzIGBoaXN0b3J5LnJlcGxhY2VTdGF0ZWAgdG8gdXBkYXRlIHRoZSB1cmwgd2l0aG91dCBhIHBhZ2UgcmVsb2FkCiAgICAgIG9yIGhpc3RvcnkgbW9kaWZpY2F0aW9uLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCByZXBsYWNlVVJMCiAgICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgICAqLwogICAgcmVwbGFjZVVSTDogZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgdmFyIHN0YXRlID0gdGhpcy5nZXRTdGF0ZSgpOwogICAgICBwYXRoID0gdGhpcy5mb3JtYXRVUkwocGF0aCk7CgogICAgICBpZiAoIXN0YXRlIHx8IHN0YXRlLnBhdGggIT09IHBhdGgpIHsKICAgICAgICB0aGlzLnJlcGxhY2VTdGF0ZShwYXRoKTsKICAgICAgfQogICAgfSwKCgogICAgLyoqCiAgICAgIEdldCB0aGUgY3VycmVudCBgaGlzdG9yeS5zdGF0ZWAuIENoZWNrcyBmb3IgaWYgYSBwb2x5ZmlsbCBpcwogICAgICByZXF1aXJlZCBhbmQgaWYgc28gZmV0Y2hlcyB0aGlzLl9oaXN0b3J5U3RhdGUuIFRoZSBzdGF0ZSByZXR1cm5lZAogICAgICBmcm9tIGdldFN0YXRlIG1heSBiZSBudWxsIGlmIGFuIGlmcmFtZSBoYXMgY2hhbmdlZCBhIHdpbmRvdydzCiAgICAgIGhpc3RvcnkuCiAgICAgICBUaGUgb2JqZWN0IHJldHVybmVkIHdpbGwgY29udGFpbiBhIGBwYXRoYCBmb3IgdGhlIGdpdmVuIHN0YXRlIGFzIHdlbGwKICAgICAgYXMgYSB1bmlxdWUgc3RhdGUgYGlkYC4gVGhlIHN0YXRlIGluZGV4IHdpbGwgYWxsb3cgdGhlIGFwcCB0byBkaXN0aW5ndWlzaAogICAgICBiZXR3ZWVuIHR3byBzdGF0ZXMgd2l0aCBzaW1pbGFyIHBhdGhzIGJ1dCBzaG91bGQgYmUgdW5pcXVlIGZyb20gb25lIGFub3RoZXIuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdldFN0YXRlCiAgICAgIEByZXR1cm4gc3RhdGUge09iamVjdH0KICAgICovCiAgICBnZXRTdGF0ZTogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5zdXBwb3J0c0hpc3RvcnkpIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2hpc3RvcnknKS5zdGF0ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2hpc3RvcnlTdGF0ZTsKICAgIH0sCgoKICAgIC8qKgogICAgIFB1c2hlcyBhIG5ldyBzdGF0ZS4KICAgICAgQHByaXZhdGUKICAgICBAbWV0aG9kIHB1c2hTdGF0ZQogICAgIEBwYXJhbSBwYXRoIHtTdHJpbmd9CiAgICAqLwogICAgcHVzaFN0YXRlOiBmdW5jdGlvbiAocGF0aCkgewogICAgICB2YXIgc3RhdGUgPSB7IHBhdGg6IHBhdGgsIHV1aWQ6IF91dWlkKCkgfTsKCiAgICAgICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdoaXN0b3J5JykucHVzaFN0YXRlKHN0YXRlLCBudWxsLCBwYXRoKTsKCiAgICAgIHRoaXMuX2hpc3RvcnlTdGF0ZSA9IHN0YXRlOwoKICAgICAgLy8gdXNlZCBmb3Igd2Via2l0IHdvcmthcm91bmQKICAgICAgdGhpcy5fcHJldmlvdXNVUkwgPSB0aGlzLmdldFVSTCgpOwogICAgfSwKCgogICAgLyoqCiAgICAgUmVwbGFjZXMgdGhlIGN1cnJlbnQgc3RhdGUuCiAgICAgIEBwcml2YXRlCiAgICAgQG1ldGhvZCByZXBsYWNlU3RhdGUKICAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICAgKi8KICAgIHJlcGxhY2VTdGF0ZTogZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgdmFyIHN0YXRlID0geyBwYXRoOiBwYXRoLCB1dWlkOiBfdXVpZCgpIH07CgogICAgICAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnaGlzdG9yeScpLnJlcGxhY2VTdGF0ZShzdGF0ZSwgbnVsbCwgcGF0aCk7CgogICAgICB0aGlzLl9oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKCiAgICAgIC8vIHVzZWQgZm9yIHdlYmtpdCB3b3JrYXJvdW5kCiAgICAgIHRoaXMuX3ByZXZpb3VzVVJMID0gdGhpcy5nZXRVUkwoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbmV2ZXIgdGhlIGJyb3dzZXIKICAgICAgaGlzdG9yeSBjaGFuZ2VzLCBpbmNsdWRpbmcgdXNpbmcgZm9yd2FyZCBhbmQgYmFjayBidXR0b25zLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgKi8KICAgIG9uVXBkYXRlVVJMOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIHRoaXMuX3JlbW92ZUV2ZW50TGlzdGVuZXIoKTsKCiAgICAgIHRoaXMuX3BvcHN0YXRlSGFuZGxlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBJZ25vcmUgaW5pdGlhbCBwYWdlIGxvYWQgcG9wc3RhdGUgZXZlbnQgaW4gQ2hyb21lCiAgICAgICAgaWYgKCFwb3BzdGF0ZUZpcmVkKSB7CiAgICAgICAgICBwb3BzdGF0ZUZpcmVkID0gdHJ1ZTsKICAgICAgICAgIGlmIChfdGhpcy5nZXRVUkwoKSA9PT0gX3RoaXMuX3ByZXZpb3VzVVJMKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soX3RoaXMuZ2V0VVJMKCkpOwogICAgICB9OwoKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5fcG9wc3RhdGVIYW5kbGVyKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBVc2VkIHdoZW4gdXNpbmcgYHt7YWN0aW9ufX1gIGhlbHBlci4gIFRoZSB1cmwgaXMgYWx3YXlzIGFwcGVuZGVkIHRvIHRoZSByb290VVJMLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBmb3JtYXRVUkwKICAgICAgQHBhcmFtIHVybCB7U3RyaW5nfQogICAgICBAcmV0dXJuIGZvcm1hdHRlZCB1cmwge1N0cmluZ30KICAgICovCiAgICBmb3JtYXRVUkw6IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgdmFyIHJvb3RVUkwgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm9vdFVSTCcpOwogICAgICB2YXIgYmFzZVVSTCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdiYXNlVVJMJyk7CgogICAgICBpZiAodXJsICE9PSAnJykgewogICAgICAgIC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCiAgICAgICAgcm9vdFVSTCA9IHJvb3RVUkwucmVwbGFjZSgvXC8kLywgJycpOwogICAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKICAgICAgfSBlbHNlIGlmIChiYXNlVVJMWzBdID09PSAnLycgJiYgcm9vdFVSTFswXSA9PT0gJy8nKSB7CiAgICAgICAgLy8gaWYgYmFzZVVSTCBhbmQgcm9vdFVSTCBib3RoIHN0YXJ0IHdpdGggYSBzbGFzaAogICAgICAgIC8vIC4uLiByZW1vdmUgdHJhaWxpbmcgc2xhc2ggZnJvbSBiYXNlVVJMIGlmIGl0IGV4aXN0cwogICAgICAgIGJhc2VVUkwgPSBiYXNlVVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGJhc2VVUkwgKyByb290VVJMICsgdXJsOwogICAgfSwKCgogICAgLyoqCiAgICAgIENsZWFucyB1cCB0aGUgSGlzdG9yeUxvY2F0aW9uIGV2ZW50IGxpc3RlbmVyLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCB3aWxsRGVzdHJveQogICAgKi8KICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3JlbW92ZUV2ZW50TGlzdGVuZXIoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBAcHJpdmF0ZQogICAgICAgUmV0dXJucyBub3JtYWxpemVkIGxvY2F0aW9uLmhhc2gKICAgICAgIEBtZXRob2QgZ2V0SGFzaAogICAgKi8KICAgIGdldEhhc2g6IF9hcGkuZGVmYXVsdC5fZ2V0SGFzaCwKCiAgICBfcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5fcG9wc3RhdGVIYW5kbGVyKSB7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgdGhpcy5fcG9wc3RhdGVIYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9sb2NhdGlvbi9ub25lX2xvY2F0aW9uJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1ydW50aW1lJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCwgX2RlYnVnLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoewogICAgaW1wbGVtZW50YXRpb246ICdub25lJywKICAgIHBhdGg6ICcnLAoKICAgIGRldGVjdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcm9vdFVSTCA9IHRoaXMucm9vdFVSTDsKCiAgICAgICh0cnVlICYmICEocm9vdFVSTC5jaGFyQXQocm9vdFVSTC5sZW5ndGggLSAxKSA9PT0gJy8nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ3Jvb3RVUkwgbXVzdCBlbmQgd2l0aCBhIHRyYWlsaW5nIGZvcndhcmQgc2xhc2ggZS5nLiAiL2FwcC8iJywgcm9vdFVSTC5jaGFyQXQocm9vdFVSTC5sZW5ndGggLSAxKSA9PT0gJy8nKSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgV2lsbCBiZSBwcmUtcGVuZGVkIHRvIHBhdGguCiAgICAgICBAcHJpdmF0ZQogICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICovCiAgICByb290VVJMOiAnLycsCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGN1cnJlbnQgcGF0aCB3aXRob3V0IGByb290VVJMYC4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgZ2V0VVJMCiAgICAgIEByZXR1cm4ge1N0cmluZ30gcGF0aAogICAgKi8KICAgIGdldFVSTDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcGF0aCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdwYXRoJyk7CiAgICAgIHZhciByb290VVJMID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3Jvb3RVUkwnKTsKCiAgICAgIC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCiAgICAgIHJvb3RVUkwgPSByb290VVJMLnJlcGxhY2UoL1wvJC8sICcnKTsKCiAgICAgIC8vIHJlbW92ZSByb290VVJMIGZyb20gdXJsCiAgICAgIHJldHVybiBwYXRoLnJlcGxhY2UobmV3IFJlZ0V4cCgnXicgKyByb290VVJMICsgJyg/PS98JCknKSwgJycpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFNldCB0aGUgcGF0aCBhbmQgcmVtZW1iZXJzIHdoYXQgd2FzIHNldC4gVXNpbmcgdGhpcyBtZXRob2QKICAgICAgdG8gY2hhbmdlIHRoZSBwYXRoIHdpbGwgbm90IGludm9rZSB0aGUgYHVwZGF0ZVVSTGAgY2FsbGJhY2suCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldFVSTAogICAgICBAcGFyYW0gcGF0aCB7U3RyaW5nfQogICAgKi8KICAgIHNldFVSTDogZnVuY3Rpb24gKHBhdGgpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ3BhdGgnLCBwYXRoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBSZWdpc3RlciBhIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgcGF0aCBjaGFuZ2VzLiBUaGVzZQogICAgICBjYWxsYmFja3Mgd2lsbCBleGVjdXRlIHdoZW4gdGhlIHVzZXIgcHJlc3NlcyB0aGUgYmFjayBvciBmb3J3YXJkCiAgICAgIGJ1dHRvbiwgYnV0IG5vdCBhZnRlciBgc2V0VVJMYCBpcyBpbnZva2VkLgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBvblVwZGF0ZVVSTAogICAgICBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufQogICAgKi8KICAgIG9uVXBkYXRlVVJMOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgdGhpcy51cGRhdGVDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgfSwKCgogICAgLyoqCiAgICAgIFNldHMgdGhlIHBhdGggYW5kIGNhbGxzIHRoZSBgdXBkYXRlVVJMYCBjYWxsYmFjay4KICAgICAgIEBwcml2YXRlCiAgICAgIEBtZXRob2QgaGFuZGxlVVJMCiAgICAgIEBwYXJhbSB1cmwge1N0cmluZ30KICAgICovCiAgICBoYW5kbGVVUkw6IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ3BhdGgnLCB1cmwpOwogICAgICB0aGlzLnVwZGF0ZUNhbGxiYWNrKHVybCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgR2l2ZW4gYSBVUkwsIGZvcm1hdHMgaXQgdG8gYmUgcGxhY2VkIGludG8gdGhlIHBhZ2UgYXMgcGFydAogICAgICBvZiBhbiBlbGVtZW50J3MgYGhyZWZgIGF0dHJpYnV0ZS4KICAgICAgIFRoaXMgaXMgdXNlZCwgZm9yIGV4YW1wbGUsIHdoZW4gdXNpbmcgdGhlIHt7YWN0aW9ufX0gaGVscGVyCiAgICAgIHRvIGdlbmVyYXRlIGEgVVJMIGJhc2VkIG9uIGFuIGV2ZW50LgogICAgICAgQHByaXZhdGUKICAgICAgQG1ldGhvZCBmb3JtYXRVUkwKICAgICAgQHBhcmFtIHVybCB7U3RyaW5nfQogICAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAgKi8KICAgIGZvcm1hdFVSTDogZnVuY3Rpb24gKHVybCkgewogICAgICB2YXIgcm9vdFVSTCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyb290VVJMJyk7CgogICAgICBpZiAodXJsICE9PSAnJykgewogICAgICAgIC8vIHJlbW92ZSB0cmFpbGluZyBzbGFzaGVzIGlmIHRoZXkgZXhpc3RzCiAgICAgICAgcm9vdFVSTCA9IHJvb3RVUkwucmVwbGFjZSgvXC8kLywgJycpOwogICAgICB9CgogICAgICByZXR1cm4gcm9vdFVSTCArIHVybDsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItcm91dGluZy9saWIvbG9jYXRpb24vdXRpbCcsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5nZXRQYXRoID0gZ2V0UGF0aDsKICBleHBvcnRzLmdldFF1ZXJ5ID0gZ2V0UXVlcnk7CiAgZXhwb3J0cy5nZXRIYXNoID0gZ2V0SGFzaDsKICBleHBvcnRzLmdldEZ1bGxQYXRoID0gZ2V0RnVsbFBhdGg7CiAgZXhwb3J0cy5nZXRPcmlnaW4gPSBnZXRPcmlnaW47CiAgZXhwb3J0cy5zdXBwb3J0c0hhc2hDaGFuZ2UgPSBzdXBwb3J0c0hhc2hDaGFuZ2U7CiAgZXhwb3J0cy5zdXBwb3J0c0hpc3RvcnkgPSBzdXBwb3J0c0hpc3Rvcnk7CiAgZXhwb3J0cy5yZXBsYWNlUGF0aCA9IHJlcGxhY2VQYXRoOwogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLnBhdGhuYW1lYCwgbm9ybWFsaXplZCBmb3IgSUUgaW5jb25zaXN0ZW5jaWVzLgogICovCiAgZnVuY3Rpb24gZ2V0UGF0aChsb2NhdGlvbikgewogICAgdmFyIHBhdGhuYW1lID0gbG9jYXRpb24ucGF0aG5hbWU7CiAgICAvLyBWYXJpb3VzIHZlcnNpb25zIG9mIElFL09wZXJhIGRvbid0IGFsd2F5cyByZXR1cm4gYSBsZWFkaW5nIHNsYXNoCiAgICBpZiAocGF0aG5hbWVbMF0gIT09ICcvJykgewogICAgICBwYXRobmFtZSA9ICcvJyArIHBhdGhuYW1lOwogICAgfQoKICAgIHJldHVybiBwYXRobmFtZTsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLnNlYXJjaGAuCiAgKi8KICBmdW5jdGlvbiBnZXRRdWVyeShsb2NhdGlvbikgewogICAgcmV0dXJuIGxvY2F0aW9uLnNlYXJjaDsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFJldHVybnMgdGhlIGN1cnJlbnQgYGxvY2F0aW9uLmhhc2hgIGJ5IHBhcnNpbmcgbG9jYXRpb24uaHJlZiBzaW5jZSBicm93c2VycwogICAgaW5jb25zaXN0ZW50bHkgVVJMLWRlY29kZSBgbG9jYXRpb24uaGFzaGAuCiAgCiAgICBTaG91bGQgYmUgcGFzc2VkIHRoZSBicm93c2VyJ3MgYGxvY2F0aW9uYCBvYmplY3QgYXMgdGhlIGZpcnN0IGFyZ3VtZW50LgogIAogICAgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDgzMzA0CiAgKi8KICBmdW5jdGlvbiBnZXRIYXNoKGxvY2F0aW9uKSB7CiAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWY7CiAgICB2YXIgaGFzaEluZGV4ID0gaHJlZi5pbmRleE9mKCcjJyk7CgogICAgaWYgKGhhc2hJbmRleCA9PT0gLTEpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGhyZWYuc3Vic3RyKGhhc2hJbmRleCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRGdWxsUGF0aChsb2NhdGlvbikgewogICAgcmV0dXJuIGdldFBhdGgobG9jYXRpb24pICsgZ2V0UXVlcnkobG9jYXRpb24pICsgZ2V0SGFzaChsb2NhdGlvbik7CiAgfQoKICBmdW5jdGlvbiBnZXRPcmlnaW4obG9jYXRpb24pIHsKICAgIHZhciBvcmlnaW4gPSBsb2NhdGlvbi5vcmlnaW47CgogICAgLy8gT2xkZXIgYnJvd3NlcnMsIGVzcGVjaWFsbHkgSUUsIGRvbid0IGhhdmUgb3JpZ2luCiAgICBpZiAoIW9yaWdpbikgewogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0bmFtZTsKCiAgICAgIGlmIChsb2NhdGlvbi5wb3J0KSB7CiAgICAgICAgb3JpZ2luICs9ICc6JyArIGxvY2F0aW9uLnBvcnQ7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gb3JpZ2luOwogIH0KCiAgLyoKICAgIGBkb2N1bWVudE1vZGVgIG9ubHkgZXhpc3QgaW4gSW50ZXJuZXQgRXhwbG9yZXIsIGFuZCBpdCdzIHRlc3RlZCBiZWNhdXNlIElFOCBydW5uaW5nIGluCiAgICBJRTcgY29tcGF0aWJpbGl0eSBtb2RlIGNsYWltcyB0byBzdXBwb3J0IGBvbmhhc2hjaGFuZ2VgIGJ1dCBhY3R1YWxseSBkb2VzIG5vdC4KICAKICAgIGBnbG9iYWxgIGlzIGFuIG9iamVjdCB0aGF0IG1heSBoYXZlIGFuIGBvbmhhc2hjaGFuZ2VgIHByb3BlcnR5LgogIAogICAgQHByaXZhdGUKICAgIEBmdW5jdGlvbiBzdXBwb3J0c0hhc2hDaGFuZ2UKICAqLwogIGZ1bmN0aW9uIHN1cHBvcnRzSGFzaENoYW5nZShkb2N1bWVudE1vZGUsIGdsb2JhbCkgewogICAgcmV0dXJuICdvbmhhc2hjaGFuZ2UnIGluIGdsb2JhbCAmJiAoZG9jdW1lbnRNb2RlID09PSB1bmRlZmluZWQgfHwgZG9jdW1lbnRNb2RlID4gNyk7CiAgfQoKICAvKgogICAgYHVzZXJBZ2VudGAgaXMgYSB1c2VyIGFnZW50IHN0cmluZy4gV2UgdXNlIHVzZXIgYWdlbnQgdGVzdGluZyBoZXJlLCBiZWNhdXNlCiAgICB0aGUgc3RvY2sgQW5kcm9pZCBicm93c2VyIGlzIGtub3duIHRvIGhhdmUgYnVnZ3kgdmVyc2lvbnMgb2YgdGhlIEhpc3RvcnkgQVBJLAogICAgaW4gc29tZSBBbmRyb2lkIHZlcnNpb25zLgogIAogICAgQHByaXZhdGUKICAgIEBmdW5jdGlvbiBzdXBwb3J0c0hpc3RvcnkKICAqLwogIGZ1bmN0aW9uIHN1cHBvcnRzSGlzdG9yeSh1c2VyQWdlbnQsIGhpc3RvcnkpIHsKICAgIC8vIEJvb3N0ZWQgZnJvbSBNb2Rlcm5penI6IGh0dHBzOi8vZ2l0aHViLmNvbS9Nb2Rlcm5penIvTW9kZXJuaXpyL2Jsb2IvbWFzdGVyL2ZlYXR1cmUtZGV0ZWN0cy9oaXN0b3J5LmpzCiAgICAvLyBUaGUgc3RvY2sgYnJvd3NlciBvbiBBbmRyb2lkIDIuMiAmIDIuMywgYW5kIDQuMC54IHJldHVybnMgcG9zaXRpdmUgb24gaGlzdG9yeSBzdXBwb3J0CiAgICAvLyBVbmZvcnR1bmF0ZWx5IHN1cHBvcnQgaXMgcmVhbGx5IGJ1Z2d5IGFuZCB0aGVyZSBpcyBubyBjbGVhbiB3YXkgdG8gZGV0ZWN0CiAgICAvLyB0aGVzZSBidWdzLCBzbyB3ZSBmYWxsIGJhY2sgdG8gYSB1c2VyIGFnZW50IHNuaWZmIDooCgogICAgLy8gV2Ugb25seSB3YW50IEFuZHJvaWQgMiBhbmQgNC4wLCBzdG9jayBicm93c2VyLCBhbmQgbm90IENocm9tZSB3aGljaCBpZGVudGlmaWVzCiAgICAvLyBpdHNlbGYgYXMgJ01vYmlsZSBTYWZhcmknIGFzIHdlbGwsIG5vciBXaW5kb3dzIFBob25lLgogICAgaWYgKCh1c2VyQWdlbnQuaW5kZXhPZignQW5kcm9pZCAyLicpICE9PSAtMSB8fCB1c2VyQWdlbnQuaW5kZXhPZignQW5kcm9pZCA0LjAnKSAhPT0gLTEpICYmIHVzZXJBZ2VudC5pbmRleE9mKCdNb2JpbGUgU2FmYXJpJykgIT09IC0xICYmIHVzZXJBZ2VudC5pbmRleE9mKCdDaHJvbWUnKSA9PT0gLTEgJiYgdXNlckFnZW50LmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiAhIShoaXN0b3J5ICYmICdwdXNoU3RhdGUnIGluIGhpc3RvcnkpOwogIH0KCiAgLyoqCiAgICBSZXBsYWNlcyB0aGUgY3VycmVudCBsb2NhdGlvbiwgbWFraW5nIHN1cmUgd2UgZXhwbGljaXRseSBpbmNsdWRlIHRoZSBvcmlnaW4KICAgIHRvIHByZXZlbnQgcmVkaXJlY3RpbmcgdG8gYSBkaWZmZXJlbnQgb3JpZ2luLgogIAogICAgQHByaXZhdGUKICAqLwogIGZ1bmN0aW9uIHJlcGxhY2VQYXRoKGxvY2F0aW9uLCBwYXRoKSB7CiAgICBsb2NhdGlvbi5yZXBsYWNlKGdldE9yaWdpbihsb2NhdGlvbikgKyBwYXRoKTsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXJvdXRpbmcvbGliL3NlcnZpY2VzL3JvdXRlcicsIFsnZXhwb3J0cycsICdAZW1iZXIvc2VydmljZScsICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJywgJ2VtYmVyLXJvdXRpbmcvbGliL3V0aWxzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfc2VydmljZSwgX2NvbXB1dGVkLCBfdXRpbHMpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgIFRoZSBSb3V0ZXIgc2VydmljZSBpcyB0aGUgcHVibGljIEFQSSB0aGF0IHByb3ZpZGVzIGNvbXBvbmVudC92aWV3IGxheWVyCiAgICAgYWNjZXNzIHRvIHRoZSByb3V0ZXIuCiAgCiAgICAgQHB1YmxpYwogICAgIEBjbGFzcyBSb3V0ZXJTZXJ2aWNlCiAgICAgQGNhdGVnb3J5IGVtYmVyLXJvdXRpbmctcm91dGVyLXNlcnZpY2UKICAgKi8KICB2YXIgUm91dGVyU2VydmljZSA9IF9zZXJ2aWNlLmRlZmF1bHQuZXh0ZW5kKHsKICAgIC8qKgogICAgICAgTmFtZSBvZiB0aGUgY3VycmVudCByb3V0ZS4KICAgICAgICBUaGlzIHByb3BlcnR5IHJlcHJlc2VudCB0aGUgbG9naWNhbCBuYW1lIG9mIHRoZSByb3V0ZSwKICAgICAgIHdoaWNoIGlzIGNvbW1hIHNlcGFyYXRlZC4KICAgICAgIEZvciB0aGUgZm9sbG93aW5nIHJvdXRlcjoKICAgICAgICBgYGBhcHAvcm91dGVyLmpzCiAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICB0aGlzLnJvdXRlKCdhYm91dCcpOwogICAgICAgICB0aGlzLnJvdXRlKCdibG9nJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgIHRoaXMucm91dGUoJ3Bvc3QnLCB7IHBhdGg6ICc6cG9zdF9pZCcgfSk7CiAgICAgICAgIH0pOwogICAgICAgfSk7CiAgICAgICBgYGAKICAgICAgICBJdCB3aWxsIHJldHVybjoKICAgICAgICAqIGBpbmRleGAgd2hlbiB5b3UgdmlzaXQgYC9gCiAgICAgICAqIGBhYm91dGAgd2hlbiB5b3UgdmlzaXQgYC9hYm91dGAKICAgICAgICogYGJsb2cuaW5kZXhgIHdoZW4geW91IHZpc2l0IGAvYmxvZ2AKICAgICAgICogYGJsb2cucG9zdGAgd2hlbiB5b3UgdmlzaXQgYC9ibG9nL3NvbWUtcG9zdC1pZGAKICAgICAgICBAcHJvcGVydHkgY3VycmVudFJvdXRlTmFtZQogICAgICAgQHR5cGUgU3RyaW5nCiAgICAgICBAcHVibGljCiAgICAgKi8KICAgIGN1cnJlbnRSb3V0ZU5hbWU6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdfcm91dGVyLmN1cnJlbnRSb3V0ZU5hbWUnKSwKCiAgICAvKioKICAgICAgIEN1cnJlbnQgVVJMIGZvciB0aGUgYXBwbGljYXRpb24uCiAgICAgICBUaGlzIHByb3BlcnR5IHJlcHJlc2VudCB0aGUgVVJMIHBhdGggZm9yIHRoaXMgcm91dGUuCiAgICAgIEZvciB0aGUgZm9sbG93aW5nIHJvdXRlcjoKICAgICAgICBgYGBhcHAvcm91dGVyLmpzCiAgICAgICBSb3V0ZXIubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICB0aGlzLnJvdXRlKCdhYm91dCcpOwogICAgICAgICB0aGlzLnJvdXRlKCdibG9nJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgIHRoaXMucm91dGUoJ3Bvc3QnLCB7IHBhdGg6ICc6cG9zdF9pZCcgfSk7CiAgICAgICAgIH0pOwogICAgICAgfSk7CiAgICAgICBgYGAKICAgICAgICBJdCB3aWxsIHJldHVybjoKICAgICAgICAqIGAvYCB3aGVuIHlvdSB2aXNpdCBgL2AKICAgICAgICogYC9hYm91dGAgd2hlbiB5b3UgdmlzaXQgYC9hYm91dGAKICAgICAgICogYC9ibG9nYCB3aGVuIHlvdSB2aXNpdCBgL2Jsb2dgCiAgICAgICAqIGAvYmxvZy9zb21lLXBvc3QtaWRgIHdoZW4geW91IHZpc2l0IGAvYmxvZy9zb21lLXBvc3QtaWRgCiAgICAgICAgQHByb3BlcnR5IGN1cnJlbnRVUkwKICAgICAgIEB0eXBlIFN0cmluZwogICAgICAgQHB1YmxpYwogICAgICovCiAgICBjdXJyZW50VVJMOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgnX3JvdXRlci5jdXJyZW50VVJMJyksCgogICAgLyoqCiAgICAgIFRoZSBgbG9jYXRpb25gIHByb3BlcnR5IGRldGVybWluZXMgdGhlIHR5cGUgb2YgVVJMJ3MgdGhhdCB5b3VyCiAgICAgIGFwcGxpY2F0aW9uIHdpbGwgdXNlLgogICAgICBUaGUgZm9sbG93aW5nIGxvY2F0aW9uIHR5cGVzIGFyZSBjdXJyZW50bHkgYXZhaWxhYmxlOgogICAgICAqIGBhdXRvYAogICAgICAqIGBoYXNoYAogICAgICAqIGBoaXN0b3J5YAogICAgICAqIGBub25lYAogICAgICAgQHByb3BlcnR5IGxvY2F0aW9uCiAgICAgIEBkZWZhdWx0ICdoYXNoJwogICAgICBAc2VlIHtMb2NhdGlvbn0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGxvY2F0aW9uOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgnX3JvdXRlci5sb2NhdGlvbicpLAoKICAgIC8qKgogICAgICBUaGUgYHJvb3RVUkxgIHByb3BlcnR5IHJlcHJlc2VudHMgdGhlIFVSTCBvZiB0aGUgcm9vdCBvZgogICAgICB0aGUgYXBwbGljYXRpb24sICcvJyBieSBkZWZhdWx0LgogICAgICBUaGlzIHByZWZpeCBpcyBhc3N1bWVkIG9uIGFsbCByb3V0ZXMgZGVmaW5lZCBvbiB0aGlzIGFwcC4KICAgICAgIElGIHlvdSBjaGFuZ2UgdGhlIGByb290VVJMYCBpbiB5b3VyIGVudmlyb25tZW50IGNvbmZpZ3VyYXRpb24KICAgICAgbGlrZSBzbzoKICAgICAgIGBgYGNvbmZpZy9lbnZpcm9ubWVudC5qcwogICAgICAndXNlIHN0cmljdCc7CiAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGVudmlyb25tZW50KSB7CiAgICAgICAgbGV0IEVOViA9IHsKICAgICAgICAgIG1vZHVsZVByZWZpeDogJ3JvdXRlci1zZXJ2aWNlJywKICAgICAgICAgIGVudmlyb25tZW50LAogICAgICAgICAgcm9vdFVSTDogJy9teS1yb290JywKICAgICAgICDigKYKICAgICAgICB9CiAgICAgIF0KICAgICAgYGBgCiAgICAgICBUaGlzIHByb3BlcnR5IHdpbGwgcmV0dXJuIGAvbXktcm9vdGAuCiAgICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgICBAZGVmYXVsdCAnLycKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJvb3RVUkw6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdfcm91dGVyLnJvb3RVUkwnKSwKICAgIF9yb3V0ZXI6IG51bGwsCgogICAgdHJhbnNpdGlvblRvOiBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgaWYgKCgwLCBfdXRpbHMucmVzZW1ibGVzVVJMKShhcmdzWzBdKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXIuX2RvVVJMVHJhbnNpdGlvbigndHJhbnNpdGlvblRvJywgYXJnc1swXSk7CiAgICAgIH0KCiAgICAgIHZhciBfZXh0cmFjdFJvdXRlQXJncyA9ICgwLCBfdXRpbHMuZXh0cmFjdFJvdXRlQXJncykoYXJncyksCiAgICAgICAgICByb3V0ZU5hbWUgPSBfZXh0cmFjdFJvdXRlQXJncy5yb3V0ZU5hbWUsCiAgICAgICAgICBtb2RlbHMgPSBfZXh0cmFjdFJvdXRlQXJncy5tb2RlbHMsCiAgICAgICAgICBxdWVyeVBhcmFtcyA9IF9leHRyYWN0Um91dGVBcmdzLnF1ZXJ5UGFyYW1zOwoKICAgICAgdmFyIHRyYW5zaXRpb24gPSB0aGlzLl9yb3V0ZXIuX2RvVHJhbnNpdGlvbihyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHRydWUpOwogICAgICB0cmFuc2l0aW9uLl9rZWVwRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXMgPSB0cnVlOwoKICAgICAgcmV0dXJuIHRyYW5zaXRpb247CiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uICgpIC8qIHJvdXRlTmFtZU9yVXJsLCAuLi5tb2RlbHMsIG9wdGlvbnMgKi97CiAgICAgIHJldHVybiB0aGlzLnRyYW5zaXRpb25Uby5hcHBseSh0aGlzLCBhcmd1bWVudHMpLm1ldGhvZCgncmVwbGFjZScpOwogICAgfSwKICAgIHVybEZvcjogZnVuY3Rpb24gKCkgLyogcm91dGVOYW1lLCAuLi5tb2RlbHMsIG9wdGlvbnMgKi97CiAgICAgIHZhciBfcm91dGVyOwoKICAgICAgcmV0dXJuIChfcm91dGVyID0gdGhpcy5fcm91dGVyKS5nZW5lcmF0ZS5hcHBseShfcm91dGVyLCBhcmd1bWVudHMpOwogICAgfSwKICAgIGlzQWN0aXZlOiBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICB2YXIgX2V4dHJhY3RSb3V0ZUFyZ3MyID0gKDAsIF91dGlscy5leHRyYWN0Um91dGVBcmdzKShhcmdzKSwKICAgICAgICAgIHJvdXRlTmFtZSA9IF9leHRyYWN0Um91dGVBcmdzMi5yb3V0ZU5hbWUsCiAgICAgICAgICBtb2RlbHMgPSBfZXh0cmFjdFJvdXRlQXJnczIubW9kZWxzLAogICAgICAgICAgcXVlcnlQYXJhbXMgPSBfZXh0cmFjdFJvdXRlQXJnczIucXVlcnlQYXJhbXM7CgogICAgICB2YXIgcm91dGVyTWljcm9saWIgPSB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliOwoKICAgICAgaWYgKCFyb3V0ZXJNaWNyb2xpYi5pc0FjdGl2ZUludGVudChyb3V0ZU5hbWUsIG1vZGVscywgbnVsbCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGhhc1F1ZXJ5UGFyYW1zID0gT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmxlbmd0aCA+IDA7CgogICAgICBpZiAoaGFzUXVlcnlQYXJhbXMpIHsKICAgICAgICB0aGlzLl9yb3V0ZXIuX3ByZXBhcmVRdWVyeVBhcmFtcyhyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHRydWUgLyogZnJvbVJvdXRlclNlcnZpY2UgKi8KICAgICAgICApOwogICAgICAgIHJldHVybiAoMCwgX3V0aWxzLnNoYWxsb3dFcXVhbCkocXVlcnlQYXJhbXMsIHJvdXRlck1pY3JvbGliLnN0YXRlLnF1ZXJ5UGFyYW1zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IFJvdXRlclNlcnZpY2U7Cn0pOwplbmlmZWQoJ2VtYmVyLXJvdXRpbmcvbGliL3NlcnZpY2VzL3JvdXRpbmcnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL3BvbHlmaWxscycsICdAZW1iZXIvc2VydmljZScsICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcG9seWZpbGxzLCBfc2VydmljZSwgX2NvbXB1dGVkLCBfZW1iZXJNZXRhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gX3NlcnZpY2UuZGVmYXVsdC5leHRlbmQoewogICAgcm91dGVyOiBudWxsLAoKICAgIHRhcmdldFN0YXRlOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgncm91dGVyLnRhcmdldFN0YXRlJyksCiAgICBjdXJyZW50U3RhdGU6ICgwLCBfY29tcHV0ZWQucmVhZE9ubHkpKCdyb3V0ZXIuY3VycmVudFN0YXRlJyksCiAgICBjdXJyZW50Um91dGVOYW1lOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgncm91dGVyLmN1cnJlbnRSb3V0ZU5hbWUnKSwKICAgIGN1cnJlbnRQYXRoOiAoMCwgX2NvbXB1dGVkLnJlYWRPbmx5KSgncm91dGVyLmN1cnJlbnRQYXRoJyksCgogICAgaGFzUm91dGU6IGZ1bmN0aW9uIChyb3V0ZU5hbWUpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyb3V0ZXInKS5oYXNSb3V0ZShyb3V0ZU5hbWUpOwogICAgfSwKICAgIHRyYW5zaXRpb25UbzogZnVuY3Rpb24gKHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcywgc2hvdWxkUmVwbGFjZSkgewogICAgICB2YXIgcm91dGVyID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3JvdXRlcicpOwoKICAgICAgdmFyIHRyYW5zaXRpb24gPSByb3V0ZXIuX2RvVHJhbnNpdGlvbihyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpOwoKICAgICAgaWYgKHNob3VsZFJlcGxhY2UpIHsKICAgICAgICB0cmFuc2l0aW9uLm1ldGhvZCgncmVwbGFjZScpOwogICAgICB9CgogICAgICByZXR1cm4gdHJhbnNpdGlvbjsKICAgIH0sCiAgICBub3JtYWxpemVRdWVyeVBhcmFtczogZnVuY3Rpb24gKHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcykgewogICAgICAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm91dGVyJykuX3ByZXBhcmVRdWVyeVBhcmFtcyhyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpOwogICAgfSwKICAgIGdlbmVyYXRlVVJMOiBmdW5jdGlvbiAocm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciByb3V0ZXIgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm91dGVyJyk7CiAgICAgIC8vIHJldHVybiBlYXJseSB3aGVuIHRoZSByb3V0ZXIgbWljcm9saWIgaXMgbm90IHByZXNlbnQsIHdoaWNoIGlzIHRoZSBjYXNlIGZvciB7e2xpbmstdG99fSBpbiBpbnRlZ3JhdGlvbiB0ZXN0cwogICAgICBpZiAoIXJvdXRlci5fcm91dGVyTWljcm9saWIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB2aXNpYmxlUXVlcnlQYXJhbXMgPSB7fTsKICAgICAgaWYgKHF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh2aXNpYmxlUXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zKTsKICAgICAgICB0aGlzLm5vcm1hbGl6ZVF1ZXJ5UGFyYW1zKHJvdXRlTmFtZSwgbW9kZWxzLCB2aXNpYmxlUXVlcnlQYXJhbXMpOwogICAgICB9CgogICAgICByZXR1cm4gcm91dGVyLmdlbmVyYXRlLmFwcGx5KHJvdXRlciwgW3JvdXRlTmFtZV0uY29uY2F0KG1vZGVscywgW3sKICAgICAgICBxdWVyeVBhcmFtczogdmlzaWJsZVF1ZXJ5UGFyYW1zCiAgICAgIH1dKSk7CiAgICB9LAogICAgaXNBY3RpdmVGb3JSb3V0ZTogZnVuY3Rpb24gKGNvbnRleHRzLCBxdWVyeVBhcmFtcywgcm91dGVOYW1lLCByb3V0ZXJTdGF0ZSwgaXNDdXJyZW50V2hlblNwZWNpZmllZCkgewogICAgICB2YXIgcm91dGVyID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3JvdXRlcicpOwoKICAgICAgdmFyIGhhbmRsZXJzID0gcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5yZWNvZ25pemVyLmhhbmRsZXJzRm9yKHJvdXRlTmFtZSk7CiAgICAgIHZhciBsZWFmTmFtZSA9IGhhbmRsZXJzW2hhbmRsZXJzLmxlbmd0aCAtIDFdLmhhbmRsZXI7CiAgICAgIHZhciBtYXhpbXVtQ29udGV4dHMgPSBudW1iZXJPZkNvbnRleHRzQWNjZXB0ZWRCeUhhbmRsZXIocm91dGVOYW1lLCBoYW5kbGVycyk7CgogICAgICAvLyBOT1RFOiBhbnkgdWdsaW5lc3MgaW4gdGhlIGNhbGN1bGF0aW9uIG9mIGFjdGl2ZW5lc3MgaXMgbGFyZ2VseQogICAgICAvLyBkdWUgdG8gdGhlIGZhY3QgdGhhdCB3ZSBzdXBwb3J0IGF1dG9tYXRpYyBub3JtYWxpemluZyBvZgogICAgICAvLyBgcmVzb3VyY2VgIC0+IGByZXNvdXJjZS5pbmRleGAsIGV2ZW4gdGhvdWdoIHRoZXJlIG1pZ2h0IGJlCiAgICAgIC8vIGR5bmFtaWMgc2VnbWVudHMgLyBxdWVyeSBwYXJhbXMgZGVmaW5lZCBvbiBgcmVzb3VyY2UuaW5kZXhgCiAgICAgIC8vIHdoaWNoIGNvbXBsaWNhdGVzIChhbmQgbWFrZXMgc29tZXdoYXQgYW1iaWd1b3VzKSB0aGUgY2FsY3VsYXRpb24KICAgICAgLy8gb2YgYWN0aXZlbmVzcyBmb3IgbGlua3MgdGhhdCBsaW5rIHRvIGByZXNvdXJjZWAgaW5zdGVhZCBvZgogICAgICAvLyBkaXJlY3RseSB0byBgcmVzb3VyY2UuaW5kZXhgLgoKICAgICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSBlbm91Z2ggY29udGV4dHMgcmV2ZXJ0IGJhY2sgdG8gZnVsbCByb3V0ZSBuYW1lCiAgICAgIC8vIHRoaXMgaXMgYmVjYXVzZSB0aGUgbGVhZiByb3V0ZSB3aWxsIHVzZSBvbmUgb2YgdGhlIGNvbnRleHRzCiAgICAgIGlmIChjb250ZXh0cy5sZW5ndGggPiBtYXhpbXVtQ29udGV4dHMpIHsKICAgICAgICByb3V0ZU5hbWUgPSBsZWFmTmFtZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJvdXRlclN0YXRlLmlzQWN0aXZlSW50ZW50KHJvdXRlTmFtZSwgY29udGV4dHMsIHF1ZXJ5UGFyYW1zLCAhaXNDdXJyZW50V2hlblNwZWNpZmllZCk7CiAgICB9CiAgfSk7CgoKICBmdW5jdGlvbiBudW1iZXJPZkNvbnRleHRzQWNjZXB0ZWRCeUhhbmRsZXIoaGFuZGxlciwgaGFuZGxlckluZm9zKSB7CiAgICB2YXIgcmVxID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlckluZm9zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlcSArPSBoYW5kbGVySW5mb3NbaV0ubmFtZXMubGVuZ3RoOwogICAgICBpZiAoaGFuZGxlckluZm9zW2ldLmhhbmRsZXIgPT09IGhhbmRsZXIpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXE7CiAgfQp9KTsKZW5pZmVkKCJlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vY2FjaGUiLCBbImV4cG9ydHMiLCAiZW1iZXItYmFiZWwiXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgQnVja2V0Q2FjaGUgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBCdWNrZXRDYWNoZSgpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBCdWNrZXRDYWNoZSk7CgogICAgICB0aGlzLmNhY2hlID0gbmV3IE1hcCgpOwogICAgfQoKICAgIEJ1Y2tldENhY2hlLnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbiBoYXMoYnVja2V0S2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmNhY2hlLmhhcyhidWNrZXRLZXkpOwogICAgfTsKCiAgICBCdWNrZXRDYWNoZS5wcm90b3R5cGUuc3Rhc2ggPSBmdW5jdGlvbiBzdGFzaChidWNrZXRLZXksIGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGJ1Y2tldCA9IHRoaXMuY2FjaGUuZ2V0KGJ1Y2tldEtleSk7CgogICAgICBpZiAoYnVja2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBidWNrZXQgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5jYWNoZS5zZXQoYnVja2V0S2V5LCBidWNrZXQpOwogICAgICB9CgogICAgICBidWNrZXQuc2V0KGtleSwgdmFsdWUpOwogICAgfTsKCiAgICBCdWNrZXRDYWNoZS5wcm90b3R5cGUubG9va3VwID0gZnVuY3Rpb24gbG9va3VwKGJ1Y2tldEtleSwgcHJvcCwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmICghdGhpcy5oYXMoYnVja2V0S2V5KSkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KCiAgICAgIHZhciBidWNrZXQgPSB0aGlzLmNhY2hlLmdldChidWNrZXRLZXkpOwogICAgICBpZiAoYnVja2V0Lmhhcyhwcm9wKSkgewogICAgICAgIHJldHVybiBidWNrZXQuZ2V0KHByb3ApOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIEJ1Y2tldENhY2hlOwogIH0oKTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gQnVja2V0Q2FjaGU7Cn0pOwplbmlmZWQoImVtYmVyLXJvdXRpbmcvbGliL3N5c3RlbS9jb250cm9sbGVyX2ZvciIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gY29udHJvbGxlckZvcjsKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgLyoqCiAgICBGaW5kcyBhIGNvbnRyb2xsZXIgaW5zdGFuY2UuCiAgCiAgICBAZm9yIEVtYmVyCiAgICBAbWV0aG9kIGNvbnRyb2xsZXJGb3IKICAgIEBwcml2YXRlCiAgKi8KICBmdW5jdGlvbiBjb250cm9sbGVyRm9yKGNvbnRhaW5lciwgY29udHJvbGxlck5hbWUsIGxvb2t1cE9wdGlvbnMpIHsKICAgIHJldHVybiBjb250YWluZXIubG9va3VwKCJjb250cm9sbGVyOiIgKyBjb250cm9sbGVyTmFtZSwgbG9va3VwT3B0aW9ucyk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vZHNsJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnQGVtYmVyL2RlYnVnJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX3BvbHlmaWxscywgX2RlYnVnKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgdXVpZCA9IDA7CgogIHZhciBEU0wgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBEU0wobmFtZSwgb3B0aW9ucykgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIERTTCk7CgogICAgICB0aGlzLnBhcmVudCA9IG5hbWU7CiAgICAgIHRoaXMuZW5hYmxlTG9hZGluZ1N1YnN0YXRlcyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5lbmFibGVMb2FkaW5nU3Vic3RhdGVzOwogICAgICB0aGlzLm1hdGNoZXMgPSBbXTsKICAgICAgdGhpcy5leHBsaWNpdEluZGV4ID0gdW5kZWZpbmVkOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfQoKICAgIERTTC5wcm90b3R5cGUucm91dGUgPSBmdW5jdGlvbiByb3V0ZShuYW1lKSB7CiAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgICAgdmFyIGNhbGxiYWNrID0gYXJndW1lbnRzWzJdOwoKICAgICAgdmFyIGR1bW15RXJyb3JSb3V0ZSA9ICcvX3VudXNlZF9kdW1teV9lcnJvcl9wYXRoX3JvdXRlXycgKyBuYW1lICsgJy86ZXJyb3InOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gb3B0aW9uczsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgICh0cnVlICYmICEoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChvcHRpb25zLm92ZXJyaWRlTmFtZUFzc2VydGlvbiA9PT0gdHJ1ZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gWydhcnJheScsICdiYXNpYycsICdvYmplY3QnLCAnYXBwbGljYXRpb24nXS5pbmRleE9mKG5hbWUpID09PSAtMTsKICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1wnJyArIG5hbWUgKyAnXCcgY2Fubm90IGJlIHVzZWQgYXMgYSByb3V0ZSBuYW1lLicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAob3B0aW9ucy5vdmVycmlkZU5hbWVBc3NlcnRpb24gPT09IHRydWUpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH1yZXR1cm4gWydhcnJheScsICdiYXNpYycsICdvYmplY3QnLCAnYXBwbGljYXRpb24nXS5pbmRleE9mKG5hbWUpID09PSAtMTsKICAgICAgfSgpKSk7CiAgICAgICh0cnVlICYmICEobmFtZS5pbmRleE9mKCc6JykgPT09IC0xKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1wnJyArIG5hbWUgKyAnXCcgaXMgbm90IGEgdmFsaWQgcm91dGUgbmFtZS4gSXQgY2Fubm90IGNvbnRhaW4gYSBcJzpcJy4gWW91IG1heSB3YW50IHRvIHVzZSB0aGUgXCdwYXRoXCcgb3B0aW9uIGluc3RlYWQuJywgbmFtZS5pbmRleE9mKCc6JykgPT09IC0xKSk7CgoKICAgICAgaWYgKHRoaXMuZW5hYmxlTG9hZGluZ1N1YnN0YXRlcykgewogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIG5hbWUgKyAnX2xvYWRpbmcnLCB7CiAgICAgICAgICByZXNldE5hbWVzcGFjZTogb3B0aW9ucy5yZXNldE5hbWVzcGFjZQogICAgICAgIH0pOwogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIG5hbWUgKyAnX2Vycm9yJywgewogICAgICAgICAgcmVzZXROYW1lc3BhY2U6IG9wdGlvbnMucmVzZXROYW1lc3BhY2UsCiAgICAgICAgICBwYXRoOiBkdW1teUVycm9yUm91dGUKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGZ1bGxOYW1lID0gZ2V0RnVsbE5hbWUodGhpcywgbmFtZSwgb3B0aW9ucy5yZXNldE5hbWVzcGFjZSk7CiAgICAgICAgdmFyIGRzbCA9IG5ldyBEU0woZnVsbE5hbWUsIHRoaXMub3B0aW9ucyk7CgogICAgICAgIGNyZWF0ZVJvdXRlKGRzbCwgJ2xvYWRpbmcnKTsKICAgICAgICBjcmVhdGVSb3V0ZShkc2wsICdlcnJvcicsIHsgcGF0aDogZHVtbXlFcnJvclJvdXRlIH0pOwoKICAgICAgICBjYWxsYmFjay5jYWxsKGRzbCk7CgogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIG5hbWUsIG9wdGlvbnMsIGRzbC5nZW5lcmF0ZSgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjcmVhdGVSb3V0ZSh0aGlzLCBuYW1lLCBvcHRpb25zKTsKICAgICAgfQogICAgfTsKCiAgICBEU0wucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBwdXNoKHVybCwgbmFtZSwgY2FsbGJhY2ssIHNlcmlhbGl6ZSkgewogICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CgogICAgICBpZiAodGhpcy5vcHRpb25zLmVuZ2luZUluZm8pIHsKICAgICAgICB2YXIgbG9jYWxGdWxsTmFtZSA9IG5hbWUuc2xpY2UodGhpcy5vcHRpb25zLmVuZ2luZUluZm8uZnVsbE5hbWUubGVuZ3RoICsgMSk7CiAgICAgICAgdmFyIHJvdXRlSW5mbyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoeyBsb2NhbEZ1bGxOYW1lOiBsb2NhbEZ1bGxOYW1lIH0sIHRoaXMub3B0aW9ucy5lbmdpbmVJbmZvKTsKCiAgICAgICAgaWYgKHNlcmlhbGl6ZSkgewogICAgICAgICAgcm91dGVJbmZvLnNlcmlhbGl6ZU1ldGhvZCA9IHNlcmlhbGl6ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMub3B0aW9ucy5hZGRSb3V0ZUZvckVuZ2luZShuYW1lLCByb3V0ZUluZm8pOwogICAgICB9IGVsc2UgaWYgKHNlcmlhbGl6ZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRGVmaW5pbmcgYSByb3V0ZSBzZXJpYWxpemVyIG9uIHJvdXRlIFwnJyArIG5hbWUgKyAnXCcgb3V0c2lkZSBhbiBFbmdpbmUgaXMgbm90IGFsbG93ZWQuJyk7CiAgICAgIH0KCiAgICAgIGlmICh1cmwgPT09ICcnIHx8IHVybCA9PT0gJy8nIHx8IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdID09PSAnaW5kZXgnKSB7CiAgICAgICAgdGhpcy5leHBsaWNpdEluZGV4ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgdGhpcy5tYXRjaGVzLnB1c2godXJsLCBuYW1lLCBjYWxsYmFjayk7CiAgICB9OwoKICAgIERTTC5wcm90b3R5cGUuZ2VuZXJhdGUgPSBmdW5jdGlvbiBnZW5lcmF0ZSgpIHsKICAgICAgdmFyIGRzbE1hdGNoZXMgPSB0aGlzLm1hdGNoZXM7CgogICAgICBpZiAoIXRoaXMuZXhwbGljaXRJbmRleCkgewogICAgICAgIHRoaXMucm91dGUoJ2luZGV4JywgeyBwYXRoOiAnLycgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRzbE1hdGNoZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIG1hdGNoKGRzbE1hdGNoZXNbaV0pLnRvKGRzbE1hdGNoZXNbaSArIDFdLCBkc2xNYXRjaGVzW2kgKyAyXSk7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKCiAgICBEU0wucHJvdG90eXBlLm1vdW50ID0gZnVuY3Rpb24gbW91bnQoX25hbWUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwoKICAgICAgdmFyIGVuZ2luZVJvdXRlTWFwID0gdGhpcy5vcHRpb25zLnJlc29sdmVSb3V0ZU1hcChfbmFtZSk7CiAgICAgIHZhciBuYW1lID0gX25hbWU7CgogICAgICBpZiAob3B0aW9ucy5hcykgewogICAgICAgIG5hbWUgPSBvcHRpb25zLmFzOwogICAgICB9CgogICAgICB2YXIgZnVsbE5hbWUgPSBnZXRGdWxsTmFtZSh0aGlzLCBuYW1lLCBvcHRpb25zLnJlc2V0TmFtZXNwYWNlKTsKCiAgICAgIHZhciBlbmdpbmVJbmZvID0gewogICAgICAgIG5hbWU6IF9uYW1lLAogICAgICAgIGluc3RhbmNlSWQ6IHV1aWQrKywKICAgICAgICBtb3VudFBvaW50OiBmdWxsTmFtZSwKICAgICAgICBmdWxsTmFtZTogZnVsbE5hbWUKICAgICAgfTsKCiAgICAgIHZhciBwYXRoID0gb3B0aW9ucy5wYXRoOwoKICAgICAgaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgewogICAgICAgIHBhdGggPSAnLycgKyBuYW1lOwogICAgICB9CgogICAgICB2YXIgY2FsbGJhY2sgPSB2b2lkIDA7CiAgICAgIHZhciBkdW1teUVycm9yUm91dGUgPSAnL191bnVzZWRfZHVtbXlfZXJyb3JfcGF0aF9yb3V0ZV8nICsgbmFtZSArICcvOmVycm9yJzsKICAgICAgaWYgKGVuZ2luZVJvdXRlTWFwKSB7CiAgICAgICAgdmFyIHNob3VsZFJlc2V0RW5naW5lSW5mbyA9IGZhbHNlOwogICAgICAgIHZhciBvbGRFbmdpbmVJbmZvID0gdGhpcy5vcHRpb25zLmVuZ2luZUluZm87CiAgICAgICAgaWYgKG9sZEVuZ2luZUluZm8pIHsKICAgICAgICAgIHNob3VsZFJlc2V0RW5naW5lSW5mbyA9IHRydWU7CiAgICAgICAgICB0aGlzLm9wdGlvbnMuZW5naW5lSW5mbyA9IGVuZ2luZUluZm87CiAgICAgICAgfQoKICAgICAgICB2YXIgb3B0aW9uc0ZvckNoaWxkID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7IGVuZ2luZUluZm86IGVuZ2luZUluZm8gfSwgdGhpcy5vcHRpb25zKTsKICAgICAgICB2YXIgY2hpbGREU0wgPSBuZXcgRFNMKGZ1bGxOYW1lLCBvcHRpb25zRm9yQ2hpbGQpOwoKICAgICAgICBjcmVhdGVSb3V0ZShjaGlsZERTTCwgJ2xvYWRpbmcnKTsKICAgICAgICBjcmVhdGVSb3V0ZShjaGlsZERTTCwgJ2Vycm9yJywgeyBwYXRoOiBkdW1teUVycm9yUm91dGUgfSk7CgogICAgICAgIGVuZ2luZVJvdXRlTWFwLmNsYXNzLmNhbGwoY2hpbGREU0wpOwoKICAgICAgICBjYWxsYmFjayA9IGNoaWxkRFNMLmdlbmVyYXRlKCk7CgogICAgICAgIGlmIChzaG91bGRSZXNldEVuZ2luZUluZm8pIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5lbmdpbmVJbmZvID0gb2xkRW5naW5lSW5mbzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBsb2NhbEZ1bGxOYW1lID0gJ2FwcGxpY2F0aW9uJzsKICAgICAgdmFyIHJvdXRlSW5mbyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoeyBsb2NhbEZ1bGxOYW1lOiBsb2NhbEZ1bGxOYW1lIH0sIGVuZ2luZUluZm8pOwoKICAgICAgaWYgKHRoaXMuZW5hYmxlTG9hZGluZ1N1YnN0YXRlcykgewogICAgICAgIC8vIFRoZXNlIHZhbHVlcyBhcmUgaW1wb3J0YW50IHRvIHJlZ2lzdGVyIHRoZSBsb2FkaW5nIHJvdXRlcyB1bmRlciB0aGVpcgogICAgICAgIC8vIHByb3BlciBuYW1lcyBmb3IgdGhlIFJvdXRlciBhbmQgd2l0aGluIHRoZSBFbmdpbmUncyByZWdpc3RyeS4KICAgICAgICB2YXIgc3Vic3RhdGVOYW1lID0gbmFtZSArICdfbG9hZGluZyc7CiAgICAgICAgdmFyIF9sb2NhbEZ1bGxOYW1lID0gJ2FwcGxpY2F0aW9uX2xvYWRpbmcnOwogICAgICAgIHZhciBfcm91dGVJbmZvID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7IGxvY2FsRnVsbE5hbWU6IF9sb2NhbEZ1bGxOYW1lIH0sIGVuZ2luZUluZm8pOwogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIHN1YnN0YXRlTmFtZSwgewogICAgICAgICAgcmVzZXROYW1lc3BhY2U6IG9wdGlvbnMucmVzZXROYW1lc3BhY2UKICAgICAgICB9KTsKICAgICAgICB0aGlzLm9wdGlvbnMuYWRkUm91dGVGb3JFbmdpbmUoc3Vic3RhdGVOYW1lLCBfcm91dGVJbmZvKTsKCiAgICAgICAgc3Vic3RhdGVOYW1lID0gbmFtZSArICdfZXJyb3InOwogICAgICAgIF9sb2NhbEZ1bGxOYW1lID0gJ2FwcGxpY2F0aW9uX2Vycm9yJzsKICAgICAgICBfcm91dGVJbmZvID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7IGxvY2FsRnVsbE5hbWU6IF9sb2NhbEZ1bGxOYW1lIH0sIGVuZ2luZUluZm8pOwogICAgICAgIGNyZWF0ZVJvdXRlKHRoaXMsIHN1YnN0YXRlTmFtZSwgewogICAgICAgICAgcmVzZXROYW1lc3BhY2U6IG9wdGlvbnMucmVzZXROYW1lc3BhY2UsCiAgICAgICAgICBwYXRoOiBkdW1teUVycm9yUm91dGUKICAgICAgICB9KTsKICAgICAgICB0aGlzLm9wdGlvbnMuYWRkUm91dGVGb3JFbmdpbmUoc3Vic3RhdGVOYW1lLCBfcm91dGVJbmZvKTsKICAgICAgfQoKICAgICAgdGhpcy5vcHRpb25zLmFkZFJvdXRlRm9yRW5naW5lKGZ1bGxOYW1lLCByb3V0ZUluZm8pOwoKICAgICAgdGhpcy5wdXNoKHBhdGgsIGZ1bGxOYW1lLCBjYWxsYmFjayk7CiAgICB9OwoKICAgIHJldHVybiBEU0w7CiAgfSgpOwoKICBleHBvcnRzLmRlZmF1bHQgPSBEU0w7CgoKICBmdW5jdGlvbiBjYW5OZXN0KGRzbCkgewogICAgcmV0dXJuIGRzbC5wYXJlbnQgIT09ICdhcHBsaWNhdGlvbic7CiAgfQoKICBmdW5jdGlvbiBnZXRGdWxsTmFtZShkc2wsIG5hbWUsIHJlc2V0TmFtZXNwYWNlKSB7CiAgICBpZiAoY2FuTmVzdChkc2wpICYmIHJlc2V0TmFtZXNwYWNlICE9PSB0cnVlKSB7CiAgICAgIHJldHVybiBkc2wucGFyZW50ICsgJy4nICsgbmFtZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUm91dGUoZHNsLCBuYW1lKSB7CiAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDoge307CiAgICB2YXIgY2FsbGJhY2sgPSBhcmd1bWVudHNbM107CgogICAgdmFyIGZ1bGxOYW1lID0gZ2V0RnVsbE5hbWUoZHNsLCBuYW1lLCBvcHRpb25zLnJlc2V0TmFtZXNwYWNlKTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMucGF0aCAhPT0gJ3N0cmluZycpIHsKICAgICAgb3B0aW9ucy5wYXRoID0gJy8nICsgbmFtZTsKICAgIH0KCiAgICBkc2wucHVzaChvcHRpb25zLnBhdGgsIGZ1bGxOYW1lLCBjYWxsYmFjaywgb3B0aW9ucy5zZXJpYWxpemUpOwogIH0KCiAgRFNMLm1hcCA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgdmFyIGRzbCA9IG5ldyBEU0woKTsKICAgIGNhbGxiYWNrLmNhbGwoZHNsKTsKICAgIHJldHVybiBkc2w7CiAgfTsKfSk7CmVuaWZlZCgnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL2dlbmVyYXRlX2NvbnRyb2xsZXInLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL2RlYnVnJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCwgX2RlYnVnKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkgPSBnZW5lcmF0ZUNvbnRyb2xsZXJGYWN0b3J5OwogIGV4cG9ydHMuZGVmYXVsdCA9IGdlbmVyYXRlQ29udHJvbGxlcjsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgR2VuZXJhdGVzIGEgY29udHJvbGxlciBmYWN0b3J5CiAgCiAgICBAZm9yIEVtYmVyCiAgICBAbWV0aG9kIGdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkKICAgIEBwcml2YXRlCiAgKi8KCiAgZnVuY3Rpb24gZ2VuZXJhdGVDb250cm9sbGVyRmFjdG9yeShvd25lciwgY29udHJvbGxlck5hbWUpIHsKICAgIHZhciBGYWN0b3J5ID0gb3duZXIuZmFjdG9yeUZvcignY29udHJvbGxlcjpiYXNpYycpLmNsYXNzOwoKICAgIEZhY3RvcnkgPSBGYWN0b3J5LmV4dGVuZCh7CiAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICcoZ2VuZXJhdGVkICcgKyBjb250cm9sbGVyTmFtZSArICcgY29udHJvbGxlciknOwogICAgICB9CiAgICB9KTsKCiAgICB2YXIgZnVsbE5hbWUgPSAnY29udHJvbGxlcjonICsgY29udHJvbGxlck5hbWU7CgogICAgb3duZXIucmVnaXN0ZXIoZnVsbE5hbWUsIEZhY3RvcnkpOwoKICAgIHJldHVybiBGYWN0b3J5OwogIH0KCiAgLyoqCiAgICBHZW5lcmF0ZXMgYW5kIGluc3RhbnRpYXRlcyBhIGNvbnRyb2xsZXIgZXh0ZW5kaW5nIGZyb20gYGNvbnRyb2xsZXI6YmFzaWNgCiAgICBpZiBwcmVzZW50LCBvciBgQ29udHJvbGxlcmAgaWYgbm90LgogIAogICAgQGZvciBFbWJlcgogICAgQG1ldGhvZCBnZW5lcmF0ZUNvbnRyb2xsZXIKICAgIEBwcml2YXRlCiAgICBAc2luY2UgMS4zLjAKICAqLwogIGZ1bmN0aW9uIGdlbmVyYXRlQ29udHJvbGxlcihvd25lciwgY29udHJvbGxlck5hbWUpIHsKICAgIGdlbmVyYXRlQ29udHJvbGxlckZhY3Rvcnkob3duZXIsIGNvbnRyb2xsZXJOYW1lKTsKCiAgICB2YXIgZnVsbE5hbWUgPSAnY29udHJvbGxlcjonICsgY29udHJvbGxlck5hbWU7CiAgICB2YXIgaW5zdGFuY2UgPSBvd25lci5sb29rdXAoZnVsbE5hbWUpOwoKICAgIGlmICh0cnVlKSB7CiAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwuZ2V0KShpbnN0YW5jZSwgJ25hbWVzcGFjZS5MT0dfQUNUSVZFX0dFTkVSQVRJT04nKSkgewogICAgICAgICgwLCBfZGVidWcuaW5mbykoJ2dlbmVyYXRlZCAtPiAnICsgZnVsbE5hbWUsIHsgZnVsbE5hbWU6IGZ1bGxOYW1lIH0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluc3RhbmNlOwogIH0KfSk7CmVuaWZlZCgiZW1iZXItcm91dGluZy9saWIvc3lzdGVtL3F1ZXJ5X3BhcmFtcyIsIFsiZXhwb3J0cyIsICJlbWJlci1iYWJlbCJdLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBRdWVyeVBhcmFtcyA9IGZ1bmN0aW9uIFF1ZXJ5UGFyYW1zKCkgewogICAgdmFyIHZhbHVlcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUXVlcnlQYXJhbXMpOwoKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgdGhpcy5pc1F1ZXJ5UGFyYW1zID0gdHJ1ZTsKICB9OwoKICBleHBvcnRzLmRlZmF1bHQgPSBRdWVyeVBhcmFtczsKfSk7CmVuaWZlZCgnZW1iZXItcm91dGluZy9saWIvc3lzdGVtL3JvdXRlJywgWydleHBvcnRzJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMnLCAnZW1iZXItb3duZXInLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL2RlYnVnJywgJ0BlbWJlci9zdHJpbmcnLCAnZW1iZXItcnVudGltZScsICdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vZ2VuZXJhdGVfY29udHJvbGxlcicsICdlbWJlci1yb3V0aW5nL2xpYi91dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3BvbHlmaWxscywgX2RlcHJlY2F0ZWRGZWF0dXJlcywgX2VtYmVyT3duZXIsIF9ydW5sb29wLCBfZW1iZXJNZXRhbCwgX2RlYnVnLCBfc3RyaW5nLCBfZW1iZXJSdW50aW1lLCBfZ2VuZXJhdGVfY29udHJvbGxlciwgX3V0aWxzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHRTZXJpYWxpemUgPSBkZWZhdWx0U2VyaWFsaXplOwogIGV4cG9ydHMuaGFzRGVmYXVsdFNlcmlhbGl6ZSA9IGhhc0RlZmF1bHRTZXJpYWxpemU7CgoKICBmdW5jdGlvbiBLKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0U2VyaWFsaXplKG1vZGVsLCBwYXJhbXMpIHsKICAgIGlmIChwYXJhbXMubGVuZ3RoIDwgMSB8fCAhbW9kZWwpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBvYmplY3QgPSB7fTsKICAgIGlmIChwYXJhbXMubGVuZ3RoID09PSAxKSB7CiAgICAgIHZhciBuYW1lID0gcGFyYW1zWzBdOwoKICAgICAgaWYgKG5hbWUgaW4gbW9kZWwpIHsKICAgICAgICBvYmplY3RbbmFtZV0gPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShtb2RlbCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAoL19pZCQvLnRlc3QobmFtZSkpIHsKICAgICAgICBvYmplY3RbbmFtZV0gPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShtb2RlbCwgJ2lkJyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdCA9ICgwLCBfZW1iZXJNZXRhbC5nZXRQcm9wZXJ0aWVzKShtb2RlbCwgcGFyYW1zKTsKICAgIH0KCiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgZnVuY3Rpb24gaGFzRGVmYXVsdFNlcmlhbGl6ZShyb3V0ZSkgewogICAgcmV0dXJuIHJvdXRlLnNlcmlhbGl6ZSA9PT0gZGVmYXVsdFNlcmlhbGl6ZTsKICB9CgogIC8qKgogIEBtb2R1bGUgQGVtYmVyL3JvdXRpbmcKICAqLwoKICAvKioKICAgIFRoZSBgUm91dGVgIGNsYXNzIGlzIHVzZWQgdG8gZGVmaW5lIGluZGl2aWR1YWwgcm91dGVzLiBSZWZlciB0bwogICAgdGhlIFtyb3V0aW5nIGd1aWRlXShodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9yZWxlYXNlL3JvdXRpbmcvKSBmb3IgZG9jdW1lbnRhdGlvbi4KICAKICAgIEBjbGFzcyBSb3V0ZQogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEB1c2VzIEFjdGlvbkhhbmRsZXIKICAgIEB1c2VzIEV2ZW50ZWQKICAgIEBzaW5jZSAxLjAuMAogICAgQHB1YmxpYwogICovCiAgdmFyIFJvdXRlID0gX2VtYmVyUnVudGltZS5PYmplY3QuZXh0ZW5kKF9lbWJlclJ1bnRpbWUuQWN0aW9uSGFuZGxlciwgX2VtYmVyUnVudGltZS5FdmVudGVkLCB7CiAgICAvKioKICAgICAgQ29uZmlndXJhdGlvbiBoYXNoIGZvciB0aGlzIHJvdXRlJ3MgcXVlcnlQYXJhbXMuIFRoZSBwb3NzaWJsZQogICAgICBjb25maWd1cmF0aW9uIG9wdGlvbnMgYW5kIHRoZWlyIGRlZmF1bHRzIGFyZSBhcyBmb2xsb3dzCiAgICAgIChhc3N1bWluZyBhIHF1ZXJ5IHBhcmFtIHdob3NlIGNvbnRyb2xsZXIgcHJvcGVydHkgaXMgYHBhZ2VgKToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcXVlcnlQYXJhbXM6IHsKICAgICAgICBwYWdlOiB7CiAgICAgICAgICAvLyBCeSBkZWZhdWx0LCBjb250cm9sbGVyIHF1ZXJ5IHBhcmFtIHByb3BlcnRpZXMgZG9uJ3QKICAgICAgICAgIC8vIGNhdXNlIGEgZnVsbCB0cmFuc2l0aW9uIHdoZW4gdGhleSBhcmUgY2hhbmdlZCwgYnV0CiAgICAgICAgICAvLyByYXRoZXIgb25seSBjYXVzZSB0aGUgVVJMIHRvIHVwZGF0ZS4gU2V0dGluZwogICAgICAgICAgLy8gYHJlZnJlc2hNb2RlbGAgdG8gdHJ1ZSB3aWxsIGNhdXNlIGFuICJpbi1wbGFjZSIKICAgICAgICAgIC8vIHRyYW5zaXRpb24gdG8gb2NjdXIsIHdoZXJlYnkgdGhlIG1vZGVsIGhvb2tzIGZvcgogICAgICAgICAgLy8gdGhpcyByb3V0ZSAoYW5kIGFueSBjaGlsZCByb3V0ZXMpIHdpbGwgcmUtZmlyZSwgYWxsb3dpbmcKICAgICAgICAgIC8vIHlvdSB0byByZWxvYWQgbW9kZWxzIChlLmcuLCBmcm9tIHRoZSBzZXJ2ZXIpIHVzaW5nIHRoZQogICAgICAgICAgLy8gdXBkYXRlZCBxdWVyeSBwYXJhbSB2YWx1ZXMuCiAgICAgICAgICByZWZyZXNoTW9kZWw6IGZhbHNlLAogICAgICAgICAgIC8vIEJ5IGRlZmF1bHQsIGNoYW5nZXMgdG8gY29udHJvbGxlciBxdWVyeSBwYXJhbSBwcm9wZXJ0aWVzCiAgICAgICAgICAvLyBjYXVzZSB0aGUgVVJMIHRvIHVwZGF0ZSB2aWEgYHB1c2hTdGF0ZWAsIHdoaWNoIG1lYW5zIGFuCiAgICAgICAgICAvLyBpdGVtIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGJyb3dzZXIncyBoaXN0b3J5LCBhbGxvd2luZwogICAgICAgICAgLy8geW91IHRvIHVzZSB0aGUgYmFjayBidXR0b24gdG8gcmVzdG9yZSB0aGUgYXBwIHRvIHRoZQogICAgICAgICAgLy8gcHJldmlvdXMgc3RhdGUgYmVmb3JlIHRoZSBxdWVyeSBwYXJhbSBwcm9wZXJ0eSB3YXMgY2hhbmdlZC4KICAgICAgICAgIC8vIFNldHRpbmcgYHJlcGxhY2VgIHRvIHRydWUgd2lsbCB1c2UgYHJlcGxhY2VTdGF0ZWAgKG9yIGl0cwogICAgICAgICAgLy8gaGFzaCBsb2NhdGlvbiBlcXVpdmFsZW50KSwgd2hpY2ggY2F1c2VzIG5vIGJyb3dzZXIgaGlzdG9yeQogICAgICAgICAgLy8gaXRlbSB0byBiZSBhZGRlZC4gVGhpcyBvcHRpb25zIG5hbWUgYW5kIGRlZmF1bHQgdmFsdWUgYXJlCiAgICAgICAgICAvLyB0aGUgc2FtZSBhcyB0aGUgYGxpbmstdG9gIGhlbHBlcidzIGByZXBsYWNlYCBvcHRpb24uCiAgICAgICAgICByZXBsYWNlOiBmYWxzZSwKICAgICAgICAgICAvLyBCeSBkZWZhdWx0LCB0aGUgcXVlcnkgcGFyYW0gVVJMIGtleSBpcyB0aGUgc2FtZSBuYW1lIGFzCiAgICAgICAgICAvLyB0aGUgY29udHJvbGxlciBwcm9wZXJ0eSBuYW1lLiBVc2UgYGFzYCB0byBzcGVjaWZ5IGEKICAgICAgICAgIC8vIGRpZmZlcmVudCBVUkwga2V5LgogICAgICAgICAgYXM6ICdwYWdlJwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBxdWVyeVBhcmFtcwogICAgICBAZm9yIFJvdXRlCiAgICAgIEB0eXBlIE9iamVjdAogICAgICBAc2luY2UgMS42LjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHF1ZXJ5UGFyYW1zOiB7fSwKCiAgICByb3V0ZXI6IF9kZXByZWNhdGVkRmVhdHVyZXMuUk9VVEVSX1JPVVRFUiA/ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoJ19yb3V0ZXInLCBmdW5jdGlvbiAoKSB7CiAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuZGVwcmVjYXRlKSgnUm91dGUjcm91dGVyIGlzIGFuIGludGltYXRlIEFQSSB0aGF0IGhhcyBiZWVuIHJlbmFtZWQgdG8gUm91dGUjX3JvdXRlci4gSG93ZXZlciB5b3UgbWlnaHQgd2FudCB0byBjb25zaWRlciB1c2luZyB0aGUgcm91dGVyIHNlcnZpY2UnLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItcm91dGluZy5yb3V0ZS1yb3V0ZXInLAogICAgICAgIHVudGlsOiAnMy41LjAnLAogICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2VtYmVyLXJvdXRpbmctcm91dGUtcm91dGVyJwogICAgICB9KSk7CgogICAgICByZXR1cm4gdGhpcy5fcm91dGVyOwogICAgfSkgOiB1bmRlZmluZWQsCgogICAgX3NldFJvdXRlTmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhpcy5yb3V0ZU5hbWUgPSBuYW1lOwogICAgICB0aGlzLmZ1bGxSb3V0ZU5hbWUgPSBnZXRFbmdpbmVSb3V0ZU5hbWUoKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKSwgbmFtZSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQHByaXZhdGUKICAgICAgIEBwcm9wZXJ0eSBfcXAKICAgICovCiAgICBfcXA6ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdmFyIGNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0gdm9pZCAwOwoKICAgICAgdmFyIGNvbnRyb2xsZXJOYW1lID0gdGhpcy5jb250cm9sbGVyTmFtZSB8fCB0aGlzLnJvdXRlTmFtZTsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgdmFyIGNvbnRyb2xsZXIgPSBvd25lci5sb29rdXAoJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lKTsKICAgICAgdmFyIHF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdG9uID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3F1ZXJ5UGFyYW1zJyk7CiAgICAgIHZhciBoYXNSb3V0ZXJEZWZpbmVkUXVlcnlQYXJhbXMgPSBPYmplY3Qua2V5cyhxdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRvbikubGVuZ3RoID4gMDsKCiAgICAgIGlmIChjb250cm9sbGVyKSB7CiAgICAgICAgLy8gdGhlIGRldmVsb3BlciBoYXMgYXV0aG9yZWQgYSBjb250cm9sbGVyIGNsYXNzIGluIHRoZWlyIGFwcGxpY2F0aW9uIGZvcgogICAgICAgIC8vIHRoaXMgcm91dGUgZmluZCBpdHMgcXVlcnkgcGFyYW1zIGFuZCBub3JtYWxpemUgdGhlaXIgb2JqZWN0IHNoYXBlIHRoZW0KICAgICAgICAvLyBtZXJnZSBpbiB0aGUgcXVlcnkgcGFyYW1zIGZvciB0aGUgcm91dGUuIEFzIGEgbWVyZ2VkUHJvcGVydHksCiAgICAgICAgLy8gUm91dGUjcXVlcnlQYXJhbXMgaXMgYWx3YXlzIGF0IGxlYXN0IGB7fWAKCiAgICAgICAgdmFyIGNvbnRyb2xsZXJEZWZpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0gKDAsIF9lbWJlck1ldGFsLmdldCkoY29udHJvbGxlciwgJ3F1ZXJ5UGFyYW1zJykgfHwge307CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRDb250cm9sbGVyUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0gKDAsIF91dGlscy5ub3JtYWxpemVDb250cm9sbGVyUXVlcnlQYXJhbXMpKGNvbnRyb2xsZXJEZWZpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uKTsKICAgICAgICBjb21iaW5lZFF1ZXJ5UGFyYW1ldGVyQ29uZmlndXJhdGlvbiA9IG1lcmdlRWFjaFF1ZXJ5UGFyYW1zKG5vcm1hbGl6ZWRDb250cm9sbGVyUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uLCBxdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRvbik7CiAgICAgIH0gZWxzZSBpZiAoaGFzUm91dGVyRGVmaW5lZFF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgLy8gdGhlIGRldmVsb3BlciBoYXMgbm90IGRlZmluZWQgYSBjb250cm9sbGVyIGJ1dCAqaGFzKiBzdXBwbGllZCByb3V0ZSBxdWVyeSBwYXJhbXMuCiAgICAgICAgLy8gR2VuZXJhdGUgYSBjbGFzcyBmb3IgdGhlbSBzbyB3ZSBjYW4gbGF0ZXIgaW5zZXJ0IGRlZmF1bHQgdmFsdWVzCiAgICAgICAgY29udHJvbGxlciA9ICgwLCBfZ2VuZXJhdGVfY29udHJvbGxlci5kZWZhdWx0KShvd25lciwgY29udHJvbGxlck5hbWUpOwogICAgICAgIGNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0gcXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0b247CiAgICAgIH0KCiAgICAgIHZhciBxcHMgPSBbXTsKICAgICAgdmFyIG1hcCA9IHt9OwogICAgICB2YXIgcHJvcGVydHlOYW1lcyA9IFtdOwoKICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gY29tYmluZWRRdWVyeVBhcmFtZXRlckNvbmZpZ3VyYXRpb24pIHsKICAgICAgICBpZiAoIWNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyB0byBzdXBwb3J0IHRoZSBkdWJpb3VzIGZlYXR1cmUgb2YgdXNpbmcgdW5rbm93blByb3BlcnR5CiAgICAgICAgLy8gb24gcXVlcnlQYXJhbXMgY29uZmlndXJhdGlvbgogICAgICAgIGlmIChwcm9wTmFtZSA9PT0gJ3Vua25vd25Qcm9wZXJ0eScgfHwgcHJvcE5hbWUgPT09ICdfc3VwZXInKSB7CiAgICAgICAgICAvLyBwb3NzaWJsZSB0b2RvOiBpc3N1ZSBkZXByZWNhdGlvbiB3YXJuaW5nPwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVzYyA9IGNvbWJpbmVkUXVlcnlQYXJhbWV0ZXJDb25maWd1cmF0aW9uW3Byb3BOYW1lXTsKICAgICAgICB2YXIgc2NvcGUgPSBkZXNjLnNjb3BlIHx8ICdtb2RlbCc7CiAgICAgICAgdmFyIHBhcnRzID0gdm9pZCAwOwoKICAgICAgICBpZiAoc2NvcGUgPT09ICdjb250cm9sbGVyJykgewogICAgICAgICAgcGFydHMgPSBbXTsKICAgICAgICB9CgogICAgICAgIHZhciB1cmxLZXkgPSBkZXNjLmFzIHx8IHRoaXMuc2VyaWFsaXplUXVlcnlQYXJhbUtleShwcm9wTmFtZSk7CiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKGNvbnRyb2xsZXIsIHByb3BOYW1lKTsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGVmYXVsdFZhbHVlKSkgewogICAgICAgICAgZGVmYXVsdFZhbHVlID0gKDAsIF9lbWJlclJ1bnRpbWUuQSkoZGVmYXVsdFZhbHVlLnNsaWNlKCkpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cGUgPSBkZXNjLnR5cGUgfHwgKDAsIF9lbWJlclJ1bnRpbWUudHlwZU9mKShkZWZhdWx0VmFsdWUpOwoKICAgICAgICB2YXIgZGVmYXVsdFZhbHVlU2VyaWFsaXplZCA9IHRoaXMuc2VyaWFsaXplUXVlcnlQYXJhbShkZWZhdWx0VmFsdWUsIHVybEtleSwgdHlwZSk7CiAgICAgICAgdmFyIHNjb3BlZFByb3BlcnR5TmFtZSA9IGNvbnRyb2xsZXJOYW1lICsgJzonICsgcHJvcE5hbWU7CiAgICAgICAgdmFyIHFwID0gewogICAgICAgICAgdW5kZWNvcmF0ZWREZWZhdWx0VmFsdWU6ICgwLCBfZW1iZXJNZXRhbC5nZXQpKGNvbnRyb2xsZXIsIHByb3BOYW1lKSwKICAgICAgICAgIGRlZmF1bHRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgc2VyaWFsaXplZERlZmF1bHRWYWx1ZTogZGVmYXVsdFZhbHVlU2VyaWFsaXplZCwKICAgICAgICAgIHNlcmlhbGl6ZWRWYWx1ZTogZGVmYXVsdFZhbHVlU2VyaWFsaXplZCwKCiAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgdXJsS2V5OiB1cmxLZXksCiAgICAgICAgICBwcm9wOiBwcm9wTmFtZSwKICAgICAgICAgIHNjb3BlZFByb3BlcnR5TmFtZTogc2NvcGVkUHJvcGVydHlOYW1lLAogICAgICAgICAgY29udHJvbGxlck5hbWU6IGNvbnRyb2xsZXJOYW1lLAogICAgICAgICAgcm91dGU6IHRoaXMsCiAgICAgICAgICBwYXJ0czogcGFydHMsIC8vIHByb3ZpZGVkIGxhdGVyIHdoZW4gc3Rhc2hOYW1lcyBpcyBjYWxsZWQgaWYgJ21vZGVsJyBzY29wZQogICAgICAgICAgdmFsdWVzOiBudWxsLCAvLyBwcm92aWRlZCBsYXRlciB3aGVuIHNldHVwIGlzIGNhbGxlZC4gbm8gaWRlYSB3aHkuCiAgICAgICAgICBzY29wZTogc2NvcGUKICAgICAgICB9OwoKICAgICAgICBtYXBbcHJvcE5hbWVdID0gbWFwW3VybEtleV0gPSBtYXBbc2NvcGVkUHJvcGVydHlOYW1lXSA9IHFwOwogICAgICAgIHFwcy5wdXNoKHFwKTsKICAgICAgICBwcm9wZXJ0eU5hbWVzLnB1c2gocHJvcE5hbWUpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHFwczogcXBzLAogICAgICAgIG1hcDogbWFwLAogICAgICAgIHByb3BlcnR5TmFtZXM6IHByb3BlcnR5TmFtZXMsCiAgICAgICAgc3RhdGVzOiB7CiAgICAgICAgICAvKgogICAgICAgICAgICBDYWxsZWQgd2hlbiBhIHF1ZXJ5IHBhcmFtZXRlciBjaGFuZ2VzIGluIHRoZSBVUkwsIHRoaXMgcm91dGUgY2FyZXMKICAgICAgICAgICAgYWJvdXQgdGhhdCBxdWVyeSBwYXJhbWV0ZXIsIGJ1dCB0aGUgcm91dGUgaXMgbm90IGN1cnJlbnRseQogICAgICAgICAgICBpbiB0aGUgYWN0aXZlIHJvdXRlIGhpZXJhcmNoeS4KICAgICAgICAgICovCiAgICAgICAgICBpbmFjdGl2ZTogZnVuY3Rpb24gKHByb3AsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBxcCA9IG1hcFtwcm9wXTsKICAgICAgICAgICAgX3RoaXMuX3FwQ2hhbmdlZChwcm9wLCB2YWx1ZSwgcXApOwogICAgICAgICAgfSwKICAgICAgICAgIC8qCiAgICAgICAgICAgIENhbGxlZCB3aGVuIGEgcXVlcnkgcGFyYW1ldGVyIGNoYW5nZXMgaW4gdGhlIFVSTCwgdGhpcyByb3V0ZSBjYXJlcwogICAgICAgICAgICBhYm91dCB0aGF0IHF1ZXJ5IHBhcmFtZXRlciwgYW5kIHRoZSByb3V0ZSBpcyBjdXJyZW50bHkKICAgICAgICAgICAgaW4gdGhlIGFjdGl2ZSByb3V0ZSBoaWVyYXJjaHkuCiAgICAgICAgICAqLwogICAgICAgICAgYWN0aXZlOiBmdW5jdGlvbiAocHJvcCwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIHFwID0gbWFwW3Byb3BdOwogICAgICAgICAgICBfdGhpcy5fcXBDaGFuZ2VkKHByb3AsIHZhbHVlLCBxcCk7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5fYWN0aXZlUVBDaGFuZ2VkKHFwLCB2YWx1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgLyoKICAgICAgICAgICAgQ2FsbGVkIHdoZW4gYSB2YWx1ZSBvZiBhIHF1ZXJ5IHBhcmFtZXRlciB0aGlzIHJvdXRlIGhhbmRsZXMgY2hhbmdlcyBpbiBhIGNvbnRyb2xsZXIKICAgICAgICAgICAgYW5kIHRoZSByb3V0ZSBpcyBjdXJyZW50bHkgaW4gdGhlIGFjdGl2ZSByb3V0ZSBoaWVyYXJjaHkuCiAgICAgICAgICAqLwogICAgICAgICAgYWxsb3dPdmVycmlkZXM6IGZ1bmN0aW9uIChwcm9wLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgcXAgPSBtYXBbcHJvcF07CiAgICAgICAgICAgIF90aGlzLl9xcENoYW5nZWQocHJvcCwgdmFsdWUsIHFwKTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLl91cGRhdGluZ1FQQ2hhbmdlZChxcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSksCgogICAgLyoqCiAgICAgIEBwcml2YXRlCiAgICAgICBAcHJvcGVydHkgX25hbWVzCiAgICAqLwogICAgX25hbWVzOiBudWxsLAoKICAgIF9zdGFzaE5hbWVzOiBmdW5jdGlvbiAoaGFuZGxlckluZm8sIGR5bmFtaWNQYXJlbnQpIHsKICAgICAgaWYgKHRoaXMuX25hbWVzKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBuYW1lcyA9IHRoaXMuX25hbWVzID0gaGFuZGxlckluZm8uX25hbWVzOwoKICAgICAgaWYgKCFuYW1lcy5sZW5ndGgpIHsKICAgICAgICBoYW5kbGVySW5mbyA9IGR5bmFtaWNQYXJlbnQ7CiAgICAgICAgbmFtZXMgPSBoYW5kbGVySW5mbyAmJiBoYW5kbGVySW5mby5fbmFtZXMgfHwgW107CiAgICAgIH0KCiAgICAgIHZhciBxcHMgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnX3FwLnFwcycpOwoKICAgICAgdmFyIG5hbWVQYXRocyA9IG5ldyBBcnJheShuYW1lcy5sZW5ndGgpOwogICAgICBmb3IgKHZhciBhID0gMDsgYSA8IG5hbWVzLmxlbmd0aDsgKythKSB7CiAgICAgICAgbmFtZVBhdGhzW2FdID0gaGFuZGxlckluZm8ubmFtZSArICcuJyArIG5hbWVzW2FdOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHFwcy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBxcCA9IHFwc1tpXTsKICAgICAgICBpZiAocXAuc2NvcGUgPT09ICdtb2RlbCcpIHsKICAgICAgICAgIHFwLnBhcnRzID0gbmFtZVBhdGhzOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIF9hY3RpdmVRUENoYW5nZWQ6IGZ1bmN0aW9uIChxcCwgdmFsdWUpIHsKICAgICAgdGhpcy5fcm91dGVyLl9hY3RpdmVRUENoYW5nZWQocXAuc2NvcGVkUHJvcGVydHlOYW1lLCB2YWx1ZSk7CiAgICB9LAogICAgX3VwZGF0aW5nUVBDaGFuZ2VkOiBmdW5jdGlvbiAocXApIHsKICAgICAgdGhpcy5fcm91dGVyLl91cGRhdGluZ1FQQ2hhbmdlZChxcC51cmxLZXkpOwogICAgfSwKCgogICAgbWVyZ2VkUHJvcGVydGllczogWydxdWVyeVBhcmFtcyddLAoKICAgIHBhcmFtc0ZvcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgcm91dGUgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHRoaXMpLmxvb2t1cCgncm91dGU6JyArIG5hbWUpOwoKICAgICAgaWYgKCFyb3V0ZSkgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQoKICAgICAgdmFyIHRyYW5zaXRpb24gPSB0aGlzLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLmFjdGl2ZVRyYW5zaXRpb247CiAgICAgIHZhciBzdGF0ZSA9IHRyYW5zaXRpb24gPyB0cmFuc2l0aW9uLnN0YXRlIDogdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5zdGF0ZTsKCiAgICAgIHZhciBmdWxsTmFtZSA9IHJvdXRlLmZ1bGxSb3V0ZU5hbWU7CiAgICAgIHZhciBwYXJhbXMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBzdGF0ZS5wYXJhbXNbZnVsbE5hbWVdKTsKICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gZ2V0UXVlcnlQYXJhbXNGb3Iocm91dGUsIHN0YXRlKTsKCiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykucmVkdWNlKGZ1bmN0aW9uIChwYXJhbXMsIGtleSkgewogICAgICAgICh0cnVlICYmICEoIXBhcmFtc1trZXldKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSByb3V0ZSBcJycgKyBfdGhpczIucm91dGVOYW1lICsgJ1wnIGhhcyBib3RoIGEgZHluYW1pYyBzZWdtZW50IGFuZCBxdWVyeSBwYXJhbSB3aXRoIG5hbWUgXCcnICsga2V5ICsgJ1wnLiBQbGVhc2UgcmVuYW1lIG9uZSB0byBhdm9pZCBjb2xsaXNpb25zLicsICFwYXJhbXNba2V5XSkpOwoKICAgICAgICBwYXJhbXNba2V5XSA9IHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgcmV0dXJuIHBhcmFtczsKICAgICAgfSwgcGFyYW1zKTsKICAgIH0sCiAgICBzZXJpYWxpemVRdWVyeVBhcmFtS2V5OiBmdW5jdGlvbiAoY29udHJvbGxlclByb3BlcnR5TmFtZSkgewogICAgICByZXR1cm4gY29udHJvbGxlclByb3BlcnR5TmFtZTsKICAgIH0sCiAgICBzZXJpYWxpemVRdWVyeVBhcmFtOiBmdW5jdGlvbiAodmFsdWUsIHVybEtleSwgZGVmYXVsdFZhbHVlVHlwZSkgewogICAgICAvLyB1cmxLZXkgaXNuJ3QgdXNlZCBoZXJlLCBidXQgYW55b25lIG92ZXJyaWRpbmcKICAgICAgLy8gY2FuIHVzZSBpdCB0byBwcm92aWRlIHNlcmlhbGl6YXRpb24gc3BlY2lmaWMKICAgICAgLy8gdG8gYSBjZXJ0YWluIHF1ZXJ5IHBhcmFtLgogICAgICByZXR1cm4gdGhpcy5fcm91dGVyLl9zZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBkZWZhdWx0VmFsdWVUeXBlKTsKICAgIH0sCiAgICBkZXNlcmlhbGl6ZVF1ZXJ5UGFyYW06IGZ1bmN0aW9uICh2YWx1ZSwgdXJsS2V5LCBkZWZhdWx0VmFsdWVUeXBlKSB7CiAgICAgIC8vIHVybEtleSBpc24ndCB1c2VkIGhlcmUsIGJ1dCBhbnlvbmUgb3ZlcnJpZGluZwogICAgICAvLyBjYW4gdXNlIGl0IHRvIHByb3ZpZGUgZGVzZXJpYWxpemF0aW9uIHNwZWNpZmljCiAgICAgIC8vIHRvIGEgY2VydGFpbiBxdWVyeSBwYXJhbS4KICAgICAgcmV0dXJuIHRoaXMuX3JvdXRlci5fZGVzZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBkZWZhdWx0VmFsdWVUeXBlKTsKICAgIH0sCiAgICBfb3B0aW9uc0ZvclF1ZXJ5UGFyYW06IGZ1bmN0aW9uIChxcCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3F1ZXJ5UGFyYW1zLicgKyBxcC51cmxLZXkpIHx8ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdxdWVyeVBhcmFtcy4nICsgcXAucHJvcCkgfHwge307CiAgICB9LAoKCiAgICAvKioKICAgICAgQSBob29rIHlvdSBjYW4gdXNlIHRvIHJlc2V0IGNvbnRyb2xsZXIgdmFsdWVzIGVpdGhlciB3aGVuIHRoZSBtb2RlbAogICAgICBjaGFuZ2VzIG9yIHRoZSByb3V0ZSBpcyBleGl0aW5nLgogICAgICAgYGBgYXBwL3JvdXRlcy9hcnRpY2xlcy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICByZXNldENvbnRyb2xsZXIoY29udHJvbGxlciwgaXNFeGl0aW5nLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAoaXNFeGl0aW5nICYmIHRyYW5zaXRpb24udGFyZ2V0TmFtZSAhPT0gJ2Vycm9yJykgewogICAgICAgICAgICBjb250cm9sbGVyLnNldCgncGFnZScsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCByZXNldENvbnRyb2xsZXIKICAgICAgQHBhcmFtIHtDb250cm9sbGVyfSBjb250cm9sbGVyIGluc3RhbmNlCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNFeGl0aW5nCiAgICAgIEBwYXJhbSB7T2JqZWN0fSB0cmFuc2l0aW9uCiAgICAgIEBzaW5jZSAxLjcuMAogICAgICBAcHVibGljCiAgICAqLwogICAgcmVzZXRDb250cm9sbGVyOiBLLAoKICAgIGV4aXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5kZWFjdGl2YXRlKCk7CiAgICAgIHRoaXMudHJpZ2dlcignZGVhY3RpdmF0ZScpOwogICAgICB0aGlzLnRlYXJkb3duVmlld3MoKTsKICAgIH0sCiAgICBfcmVzZXQ6IGZ1bmN0aW9uIChpc0V4aXRpbmcsIHRyYW5zaXRpb24pIHsKICAgICAgdmFyIGNvbnRyb2xsZXIgPSB0aGlzLmNvbnRyb2xsZXI7CiAgICAgIGNvbnRyb2xsZXIuX3FwRGVsZWdhdGUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnX3FwLnN0YXRlcy5pbmFjdGl2ZScpOwoKICAgICAgdGhpcy5yZXNldENvbnRyb2xsZXIoY29udHJvbGxlciwgaXNFeGl0aW5nLCB0cmFuc2l0aW9uKTsKICAgIH0sCiAgICBlbnRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmNvbm5lY3Rpb25zID0gW107CiAgICAgIHRoaXMuYWN0aXZhdGUoKTsKICAgICAgdGhpcy50cmlnZ2VyKCdhY3RpdmF0ZScpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFRoZSBuYW1lIG9mIHRoZSB0ZW1wbGF0ZSB0byB1c2UgYnkgZGVmYXVsdCB3aGVuIHJlbmRlcmluZyB0aGlzIHJvdXRlcwogICAgICB0ZW1wbGF0ZS4KICAgICAgIGBgYGFwcC9yb3V0ZXMvcG9zdHMvbGlzdC5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICB0ZW1wbGF0ZU5hbWU6ICdwb3N0cy9saXN0JwogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzL2luZGV4LmpzCiAgICAgIGltcG9ydCBQb3N0c0xpc3QgZnJvbSAnLi4vcG9zdHMvbGlzdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBQb3N0c0xpc3QuZXh0ZW5kKCk7CiAgICAgIGBgYAogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy9hcmNoaXZlZC5qcwogICAgICBpbXBvcnQgUG9zdHNMaXN0IGZyb20gJy4uL3Bvc3RzL2xpc3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUG9zdHNMaXN0LmV4dGVuZCgpOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSB0ZW1wbGF0ZU5hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHNpbmNlIDEuNC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICB0ZW1wbGF0ZU5hbWU6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBuYW1lIG9mIHRoZSBjb250cm9sbGVyIHRvIGFzc29jaWF0ZSB3aXRoIHRoaXMgcm91dGUuCiAgICAgICBCeSBkZWZhdWx0LCBFbWJlciB3aWxsIGxvb2t1cCBhIHJvdXRlJ3MgY29udHJvbGxlciB0aGF0IG1hdGNoZXMgdGhlIG5hbWUKICAgICAgb2YgdGhlIHJvdXRlIChpLmUuIGBwb3N0cy5uZXdgKS4gSG93ZXZlciwKICAgICAgaWYgeW91IHdvdWxkIGxpa2UgdG8gZGVmaW5lIGEgc3BlY2lmaWMgY29udHJvbGxlciB0byB1c2UsIHlvdSBjYW4gZG8gc28KICAgICAgdXNpbmcgdGhpcyBwcm9wZXJ0eS4KICAgICAgIFRoaXMgaXMgdXNlZnVsIGluIG1hbnkgd2F5cywgYXMgdGhlIGNvbnRyb2xsZXIgc3BlY2lmaWVkIHdpbGwgYmU6CiAgICAgICAqIHBhc3NlZCB0byB0aGUgYHNldHVwQ29udHJvbGxlcmAgbWV0aG9kLgogICAgICAqIHVzZWQgYXMgdGhlIGNvbnRyb2xsZXIgZm9yIHRoZSB0ZW1wbGF0ZSBiZWluZyByZW5kZXJlZCBieSB0aGUgcm91dGUuCiAgICAgICogcmV0dXJuZWQgZnJvbSBhIGNhbGwgdG8gYGNvbnRyb2xsZXJGb3JgIGZvciB0aGUgcm91dGUuCiAgICAgICBAcHJvcGVydHkgY29udHJvbGxlck5hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHNpbmNlIDEuNC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBjb250cm9sbGVyTmFtZTogbnVsbCwKCiAgICAvKioKICAgICAgVGhlIGB3aWxsVHJhbnNpdGlvbmAgYWN0aW9uIGlzIGZpcmVkIGF0IHRoZSBiZWdpbm5pbmcgb2YgYW55CiAgICAgIGF0dGVtcHRlZCB0cmFuc2l0aW9uIHdpdGggYSBgVHJhbnNpdGlvbmAgb2JqZWN0IGFzIHRoZSBzb2xlCiAgICAgIGFyZ3VtZW50LiBUaGlzIGFjdGlvbiBjYW4gYmUgdXNlZCBmb3IgYWJvcnRpbmcsIHJlZGlyZWN0aW5nLAogICAgICBvciBkZWNvcmF0aW5nIHRoZSB0cmFuc2l0aW9uIGZyb20gdGhlIGN1cnJlbnRseSBhY3RpdmUgcm91dGVzLgogICAgICAgQSBnb29kIGV4YW1wbGUgaXMgcHJldmVudGluZyBuYXZpZ2F0aW9uIHdoZW4gYSBmb3JtIGlzCiAgICAgIGhhbGYtZmlsbGVkIG91dDoKICAgICAgIGBgYGFwcC9yb3V0ZXMvY29udGFjdC1mb3JtLmpzCiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIHdpbGxUcmFuc2l0aW9uKHRyYW5zaXRpb24pIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbGxlci5nZXQoJ3VzZXJIYXNFbnRlcmVkRGF0YScpKSB7CiAgICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyLmRpc3BsYXlOYXZpZ2F0aW9uQ29uZmlybSgpOwogICAgICAgICAgICAgIHRyYW5zaXRpb24uYWJvcnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgWW91IGNhbiBhbHNvIHJlZGlyZWN0IGVsc2V3aGVyZSBieSBjYWxsaW5nCiAgICAgIGB0aGlzLnRyYW5zaXRpb25UbygnZWxzZXdoZXJlJylgIGZyb20gd2l0aGluIGB3aWxsVHJhbnNpdGlvbmAuCiAgICAgIE5vdGUgdGhhdCBgd2lsbFRyYW5zaXRpb25gIHdpbGwgbm90IGJlIGZpcmVkIGZvciB0aGUKICAgICAgcmVkaXJlY3RpbmcgYHRyYW5zaXRpb25Ub2AsIHNpbmNlIGB3aWxsVHJhbnNpdGlvbmAgZG9lc24ndAogICAgICBmaXJlIHdoZW4gdGhlcmUgaXMgYWxyZWFkeSBhIHRyYW5zaXRpb24gdW5kZXJ3YXkuIElmIHlvdSB3YW50CiAgICAgIHN1YnNlcXVlbnQgYHdpbGxUcmFuc2l0aW9uYCBhY3Rpb25zIHRvIGZpcmUgZm9yIHRoZSByZWRpcmVjdGluZwogICAgICB0cmFuc2l0aW9uLCB5b3UgbXVzdCBmaXJzdCBleHBsaWNpdGx5IGNhbGwKICAgICAgYHRyYW5zaXRpb24uYWJvcnQoKWAuCiAgICAgICBUbyBhbGxvdyB0aGUgYHdpbGxUcmFuc2l0aW9uYCBldmVudCB0byBjb250aW51ZSBidWJibGluZyB0byB0aGUgcGFyZW50CiAgICAgIHJvdXRlLCB1c2UgYHJldHVybiB0cnVlO2AuIFdoZW4gdGhlIGB3aWxsVHJhbnNpdGlvbmAgbWV0aG9kIGhhcyBhCiAgICAgIHJldHVybiB2YWx1ZSBvZiBgdHJ1ZWAgdGhlbiB0aGUgcGFyZW50IHJvdXRlJ3MgYHdpbGxUcmFuc2l0aW9uYCBtZXRob2QKICAgICAgd2lsbCBiZSBmaXJlZCwgZW5hYmxpbmcgImJ1YmJsaW5nIiBiZWhhdmlvciBmb3IgdGhlIGV2ZW50LgogICAgICAgQGV2ZW50IHdpbGxUcmFuc2l0aW9uCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICAvKioKICAgICAgVGhlIGBkaWRUcmFuc2l0aW9uYCBhY3Rpb24gaXMgZmlyZWQgYWZ0ZXIgYSB0cmFuc2l0aW9uIGhhcwogICAgICBzdWNjZXNzZnVsbHkgYmVlbiBjb21wbGV0ZWQuIFRoaXMgb2NjdXJzIGFmdGVyIHRoZSBub3JtYWwgbW9kZWwKICAgICAgaG9va3MgKGBiZWZvcmVNb2RlbGAsIGBtb2RlbGAsIGBhZnRlck1vZGVsYCwgYHNldHVwQ29udHJvbGxlcmApCiAgICAgIGhhdmUgcmVzb2x2ZWQuIFRoZSBgZGlkVHJhbnNpdGlvbmAgYWN0aW9uIGhhcyBubyBhcmd1bWVudHMsCiAgICAgIGhvd2V2ZXIsIGl0IGNhbiBiZSB1c2VmdWwgZm9yIHRyYWNraW5nIHBhZ2Ugdmlld3Mgb3IgcmVzZXR0aW5nCiAgICAgIHN0YXRlIG9uIHRoZSBjb250cm9sbGVyLgogICAgICAgYGBgYXBwL3JvdXRlcy9sb2dpbi5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBkaWRUcmFuc2l0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZ2V0KCdlcnJvcnMuYmFzZScpLmNsZWFyKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBCdWJibGUgdGhlIGRpZFRyYW5zaXRpb24gZXZlbnQKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBldmVudCBkaWRUcmFuc2l0aW9uCiAgICAgIEBzaW5jZSAxLjIuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGUgYGxvYWRpbmdgIGFjdGlvbiBpcyBmaXJlZCBvbiB0aGUgcm91dGUgd2hlbiBhIHJvdXRlJ3MgYG1vZGVsYAogICAgICBob29rIHJldHVybnMgYSBwcm9taXNlIHRoYXQgaXMgbm90IGFscmVhZHkgcmVzb2x2ZWQuIFRoZSBjdXJyZW50CiAgICAgIGBUcmFuc2l0aW9uYCBvYmplY3QgaXMgdGhlIGZpcnN0IHBhcmFtZXRlciBhbmQgdGhlIHJvdXRlIHRoYXQKICAgICAgdHJpZ2dlcmVkIHRoZSBsb2FkaW5nIGV2ZW50IGlzIHRoZSBzZWNvbmQgcGFyYW1ldGVyLgogICAgICAgYGBgYXBwL3JvdXRlcy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBsb2FkaW5nKHRyYW5zaXRpb24sIHJvdXRlKSB7CiAgICAgICAgICAgIGxldCBjb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVyRm9yKCdmb28nKTsKICAgICAgICAgICAgY29udHJvbGxlci5zZXQoJ2N1cnJlbnRseUxvYWRpbmcnLCB0cnVlKTsKICAgICAgICAgICAgIHRyYW5zaXRpb24uZmluYWxseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyLnNldCgnY3VycmVudGx5TG9hZGluZycsIGZhbHNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAZXZlbnQgbG9hZGluZwogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHBhcmFtIHtSb3V0ZX0gcm91dGUgVGhlIHJvdXRlIHRoYXQgdHJpZ2dlcmVkIHRoZSBsb2FkaW5nIGV2ZW50CiAgICAgIEBzaW5jZSAxLjIuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBXaGVuIGF0dGVtcHRpbmcgdG8gdHJhbnNpdGlvbiBpbnRvIGEgcm91dGUsIGFueSBvZiB0aGUgaG9va3MKICAgICAgbWF5IHJldHVybiBhIHByb21pc2UgdGhhdCByZWplY3RzLCBhdCB3aGljaCBwb2ludCBhbiBgZXJyb3JgCiAgICAgIGFjdGlvbiB3aWxsIGJlIGZpcmVkIG9uIHRoZSBwYXJ0aWFsbHktZW50ZXJlZCByb3V0ZXMsIGFsbG93aW5nCiAgICAgIGZvciBwZXItcm91dGUgZXJyb3IgaGFuZGxpbmcgbG9naWMsIG9yIHNoYXJlZCBlcnJvciBoYW5kbGluZwogICAgICBsb2dpYyBkZWZpbmVkIG9uIGEgcGFyZW50IHJvdXRlLgogICAgICAgSGVyZSBpcyBhbiBleGFtcGxlIG9mIGFuIGVycm9yIGhhbmRsZXIgdGhhdCB3aWxsIGJlIGludm9rZWQKICAgICAgZm9yIHJlamVjdGVkIHByb21pc2VzIGZyb20gdGhlIHZhcmlvdXMgaG9va3Mgb24gdGhlIHJvdXRlLAogICAgICBhcyB3ZWxsIGFzIGFueSB1bmhhbmRsZWQgZXJyb3JzIGZyb20gY2hpbGQgcm91dGVzOgogICAgICAgYGBgYXBwL3JvdXRlcy9hZG1pbi5qcwogICAgICBpbXBvcnQgeyByZWplY3QgfSBmcm9tICdyc3ZwJzsKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYmVmb3JlTW9kZWwoKSB7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KCdiYWQgdGhpbmdzIScpOwogICAgICAgIH0sCiAgICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICAgIC8vIEFzc3VtaW5nIHdlIGdvdCBoZXJlIGR1ZSB0byB0aGUgZXJyb3IgaW4gYGJlZm9yZU1vZGVsYCwKICAgICAgICAgICAgLy8gd2UgY2FuIGV4cGVjdCB0aGF0IGVycm9yID09PSAiYmFkIHRoaW5ncyEiLAogICAgICAgICAgICAvLyBidXQgYSBwcm9taXNlIG1vZGVsIHJlamVjdGluZyB3b3VsZCBhbHNvCiAgICAgICAgICAgIC8vIGNhbGwgdGhpcyBob29rLCBhcyB3b3VsZCBhbnkgZXJyb3JzIGVuY291bnRlcmVkCiAgICAgICAgICAgIC8vIGluIGBhZnRlck1vZGVsYC4KICAgICAgICAgICAgIC8vIFRoZSBgZXJyb3JgIGhvb2sgaXMgYWxzbyBwcm92aWRlZCB0aGUgZmFpbGVkCiAgICAgICAgICAgIC8vIGB0cmFuc2l0aW9uYCwgd2hpY2ggY2FuIGJlIHN0b3JlZCBhbmQgbGF0ZXIKICAgICAgICAgICAgLy8gYC5yZXRyeSgpYGQgaWYgZGVzaXJlZC4KICAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdsb2dpbicpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGVycm9yYCBhY3Rpb25zIHRoYXQgYnViYmxlIHVwIGFsbCB0aGUgd2F5IHRvIGBBcHBsaWNhdGlvblJvdXRlYAogICAgICB3aWxsIGZpcmUgYSBkZWZhdWx0IGVycm9yIGhhbmRsZXIgdGhhdCBsb2dzIHRoZSBlcnJvci4gWW91IGNhbgogICAgICBzcGVjaWZ5IHlvdXIgb3duIGdsb2JhbCBkZWZhdWx0IGVycm9yIGhhbmRsZXIgYnkgb3ZlcnJpZGluZyB0aGUKICAgICAgYGVycm9yYCBoYW5kbGVyIG9uIGBBcHBsaWNhdGlvblJvdXRlYDoKICAgICAgIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgYWN0aW9uczogewogICAgICAgICAgZXJyb3IoZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyRm9yKCdiYW5uZXInKS5kaXNwbGF5RXJyb3IoZXJyb3IubWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBldmVudCBlcnJvcgogICAgICBAcGFyYW0ge0Vycm9yfSBlcnJvcgogICAgICBAcGFyYW0ge1RyYW5zaXRpb259IHRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCgogICAgLyoqCiAgICAgIFRoaXMgZXZlbnQgaXMgdHJpZ2dlcmVkIHdoZW4gdGhlIHJvdXRlciBlbnRlcnMgdGhlIHJvdXRlLiBJdCBpcwogICAgICBub3QgZXhlY3V0ZWQgd2hlbiB0aGUgbW9kZWwgZm9yIHRoZSByb3V0ZSBjaGFuZ2VzLgogICAgICAgYGBgYXBwL3JvdXRlcy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgeyBvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QvZXZlbnRlZCc7CiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIGNvbGxlY3RBbmFseXRpY3M6IG9uKCdhY3RpdmF0ZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICBjb2xsZWN0QW5hbHl0aWNzKCk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQGV2ZW50IGFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjkuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGlzIGV2ZW50IGlzIHRyaWdnZXJlZCB3aGVuIHRoZSByb3V0ZXIgY29tcGxldGVseSBleGl0cyB0aGlzCiAgICAgIHJvdXRlLiBJdCBpcyBub3QgZXhlY3V0ZWQgd2hlbiB0aGUgbW9kZWwgZm9yIHRoZSByb3V0ZSBjaGFuZ2VzLgogICAgICAgYGBgYXBwL3JvdXRlcy9pbmRleC5qcwogICAgICBpbXBvcnQgeyBvbiB9IGZyb20gJ0BlbWJlci9vYmplY3QvZXZlbnRlZCc7CiAgICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICAgIHRyYWNrUGFnZUxlYXZlQW5hbHl0aWNzOiBvbignZGVhY3RpdmF0ZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICB0cmFja1BhZ2VMZWF2ZUFuYWx5dGljcygpOwogICAgICAgIH0pCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBldmVudCBkZWFjdGl2YXRlCiAgICAgIEBzaW5jZSAxLjkuMAogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGUgY29udHJvbGxlciBhc3NvY2lhdGVkIHdpdGggdGhpcyByb3V0ZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9yb3V0ZXMvZm9ybS5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICB3aWxsVHJhbnNpdGlvbih0cmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xsZXIuZ2V0KCd1c2VySGFzRW50ZXJlZERhdGEnKSAmJgogICAgICAgICAgICAgICAgIWNvbmZpcm0oJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBhYmFuZG9uIHByb2dyZXNzPycpKSB7CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5hYm9ydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIEJ1YmJsZSB0aGUgYHdpbGxUcmFuc2l0aW9uYCBhY3Rpb24gc28gdGhhdAogICAgICAgICAgICAgIC8vIHBhcmVudCByb3V0ZXMgY2FuIGRlY2lkZSB3aGV0aGVyIG9yIG5vdCB0byBhYm9ydC4KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGNvbnRyb2xsZXIKICAgICAgQHR5cGUgQ29udHJvbGxlcgogICAgICBAc2luY2UgMS42LjAKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICBhY3Rpb25zOiB7CiAgICAgIHF1ZXJ5UGFyYW1zRGlkQ2hhbmdlOiBmdW5jdGlvbiAoY2hhbmdlZCwgdG90YWxQcmVzZW50LCByZW1vdmVkKSB7CiAgICAgICAgdmFyIHFwTWFwID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19xcCcpLm1hcDsKCiAgICAgICAgdmFyIHRvdGFsQ2hhbmdlZCA9IE9iamVjdC5rZXlzKGNoYW5nZWQpLmNvbmNhdChPYmplY3Qua2V5cyhyZW1vdmVkKSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbENoYW5nZWQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBxcCA9IHFwTWFwW3RvdGFsQ2hhbmdlZFtpXV07CiAgICAgICAgICBpZiAocXAgJiYgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcy5fb3B0aW9uc0ZvclF1ZXJ5UGFyYW0ocXApLCAncmVmcmVzaE1vZGVsJykgJiYgdGhpcy5fcm91dGVyLmN1cnJlbnRTdGF0ZSkgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlOiBmdW5jdGlvbiAocGFyYW1zLCBmaW5hbFBhcmFtcywgdHJhbnNpdGlvbikgewogICAgICAgIGlmICh0aGlzLmZ1bGxSb3V0ZU5hbWUgIT09ICdhcHBsaWNhdGlvbicpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gVHJhbnNpdGlvbiBvYmplY3QgaXMgYWJzZW50IGZvciBpbnRlcm1lZGlhdGUgdHJhbnNpdGlvbnMuCiAgICAgICAgaWYgKCF0cmFuc2l0aW9uKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFuZGxlckluZm9zID0gdHJhbnNpdGlvbi5zdGF0ZS5oYW5kbGVySW5mb3M7CiAgICAgICAgdmFyIHJvdXRlciA9IHRoaXMuX3JvdXRlcjsKICAgICAgICB2YXIgcXBNZXRhID0gcm91dGVyLl9xdWVyeVBhcmFtc0ZvcihoYW5kbGVySW5mb3MpOwogICAgICAgIHZhciBjaGFuZ2VzID0gcm91dGVyLl9xcFVwZGF0ZXM7CiAgICAgICAgdmFyIHJlcGxhY2VVcmwgPSB2b2lkIDA7CgogICAgICAgICgwLCBfdXRpbHMuc3Rhc2hQYXJhbU5hbWVzKShyb3V0ZXIsIGhhbmRsZXJJbmZvcyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXBNZXRhLnFwcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHFwID0gcXBNZXRhLnFwc1tpXTsKICAgICAgICAgIHZhciByb3V0ZSA9IHFwLnJvdXRlOwogICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSByb3V0ZS5jb250cm9sbGVyOwogICAgICAgICAgdmFyIHByZXNlbnRLZXkgPSBxcC51cmxLZXkgaW4gcGFyYW1zICYmIHFwLnVybEtleTsKCiAgICAgICAgICAvLyBEbyBhIHJldmVyc2UgbG9va3VwIHRvIHNlZSBpZiB0aGUgY2hhbmdlZCBxdWVyeQogICAgICAgICAgLy8gcGFyYW0gVVJMIGtleSBjb3JyZXNwb25kcyB0byBhIFFQIHByb3BlcnR5IG9uCiAgICAgICAgICAvLyB0aGlzIGNvbnRyb2xsZXIuCiAgICAgICAgICB2YXIgdmFsdWUgPSB2b2lkIDAsCiAgICAgICAgICAgICAgc3ZhbHVlID0gdm9pZCAwOwogICAgICAgICAgaWYgKGNoYW5nZXMgJiYgcXAudXJsS2V5IGluIGNoYW5nZXMpIHsKICAgICAgICAgICAgLy8gVmFsdWUgdXBkYXRlZCBpbi9iZWZvcmUgc2V0dXBDb250cm9sbGVyCiAgICAgICAgICAgIHZhbHVlID0gKDAsIF9lbWJlck1ldGFsLmdldCkoY29udHJvbGxlciwgcXAucHJvcCk7CiAgICAgICAgICAgIHN2YWx1ZSA9IHJvdXRlLnNlcmlhbGl6ZVF1ZXJ5UGFyYW0odmFsdWUsIHFwLnVybEtleSwgcXAudHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocHJlc2VudEtleSkgewogICAgICAgICAgICAgIHN2YWx1ZSA9IHBhcmFtc1twcmVzZW50S2V5XTsKCiAgICAgICAgICAgICAgaWYgKHN2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJvdXRlLmRlc2VyaWFsaXplUXVlcnlQYXJhbShzdmFsdWUsIHFwLnVybEtleSwgcXAudHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIE5vIFFQIHByb3ZpZGVkOyB1c2UgZGVmYXVsdCB2YWx1ZS4KICAgICAgICAgICAgICBzdmFsdWUgPSBxcC5zZXJpYWxpemVkRGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgIHZhbHVlID0gY29weURlZmF1bHRWYWx1ZShxcC5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgY29udHJvbGxlci5fcXBEZWxlZ2F0ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHJvdXRlLCAnX3FwLnN0YXRlcy5pbmFjdGl2ZScpOwoKICAgICAgICAgIHZhciB0aGlzUXVlcnlQYXJhbUNoYW5nZWQgPSBzdmFsdWUgIT09IHFwLnNlcmlhbGl6ZWRWYWx1ZTsKICAgICAgICAgIGlmICh0aGlzUXVlcnlQYXJhbUNoYW5nZWQpIHsKICAgICAgICAgICAgaWYgKHRyYW5zaXRpb24ucXVlcnlQYXJhbXNPbmx5ICYmIHJlcGxhY2VVcmwgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSByb3V0ZS5fb3B0aW9uc0ZvclF1ZXJ5UGFyYW0ocXApOwogICAgICAgICAgICAgIHZhciByZXBsYWNlQ29uZmlnVmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShvcHRpb25zLCAncmVwbGFjZScpOwogICAgICAgICAgICAgIGlmIChyZXBsYWNlQ29uZmlnVmFsdWUpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2VVcmwgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVwbGFjZUNvbmZpZ1ZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gRXhwbGljaXQgcHVzaFN0YXRlIHdpbnMgb3ZlciBhbnkgb3RoZXIgcmVwbGFjZVN0YXRlcy4KICAgICAgICAgICAgICAgIHJlcGxhY2VVcmwgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKGNvbnRyb2xsZXIsIHFwLnByb3AsIHZhbHVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdGFzaCBjdXJyZW50IHNlcmlhbGl6ZWQgdmFsdWUgb2YgY29udHJvbGxlci4KICAgICAgICAgIHFwLnNlcmlhbGl6ZWRWYWx1ZSA9IHN2YWx1ZTsKCiAgICAgICAgICB2YXIgdGhpc1F1ZXJ5UGFyYW1IYXNEZWZhdWx0VmFsdWUgPSBxcC5zZXJpYWxpemVkRGVmYXVsdFZhbHVlID09PSBzdmFsdWU7CiAgICAgICAgICBpZiAoIXRoaXNRdWVyeVBhcmFtSGFzRGVmYXVsdFZhbHVlIHx8IHRyYW5zaXRpb24uX2tlZXBEZWZhdWx0UXVlcnlQYXJhbVZhbHVlcykgewogICAgICAgICAgICBmaW5hbFBhcmFtcy5wdXNoKHsKICAgICAgICAgICAgICB2YWx1ZTogc3ZhbHVlLAogICAgICAgICAgICAgIHZpc2libGU6IHRydWUsCiAgICAgICAgICAgICAga2V5OiBwcmVzZW50S2V5IHx8IHFwLnVybEtleQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChyZXBsYWNlVXJsKSB7CiAgICAgICAgICB0cmFuc2l0aW9uLm1ldGhvZCgncmVwbGFjZScpOwogICAgICAgIH0KCiAgICAgICAgcXBNZXRhLnFwcy5mb3JFYWNoKGZ1bmN0aW9uIChxcCkgewogICAgICAgICAgdmFyIHJvdXRlUXBNZXRhID0gKDAsIF9lbWJlck1ldGFsLmdldCkocXAucm91dGUsICdfcXAnKTsKICAgICAgICAgIHZhciBmaW5hbGl6ZWRDb250cm9sbGVyID0gcXAucm91dGUuY29udHJvbGxlcjsKICAgICAgICAgIGZpbmFsaXplZENvbnRyb2xsZXIuX3FwRGVsZWdhdGUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShyb3V0ZVFwTWV0YSwgJ3N0YXRlcy5hY3RpdmUnKTsKICAgICAgICB9KTsKCiAgICAgICAgcm91dGVyLl9xcFVwZGF0ZXMgPSBudWxsOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIGhvb2sgaXMgZXhlY3V0ZWQgd2hlbiB0aGUgcm91dGVyIGNvbXBsZXRlbHkgZXhpdHMgdGhpcyByb3V0ZS4gSXQgaXMKICAgICAgbm90IGV4ZWN1dGVkIHdoZW4gdGhlIG1vZGVsIGZvciB0aGUgcm91dGUgY2hhbmdlcy4KICAgICAgIEBtZXRob2QgZGVhY3RpdmF0ZQogICAgICBAc2luY2UgMS4wLjAKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGRlYWN0aXZhdGU6IEssCgogICAgLyoqCiAgICAgIFRoaXMgaG9vayBpcyBleGVjdXRlZCB3aGVuIHRoZSByb3V0ZXIgZW50ZXJzIHRoZSByb3V0ZS4gSXQgaXMgbm90IGV4ZWN1dGVkCiAgICAgIHdoZW4gdGhlIG1vZGVsIGZvciB0aGUgcm91dGUgY2hhbmdlcy4KICAgICAgIEBtZXRob2QgYWN0aXZhdGUKICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBhY3RpdmF0ZTogSywKCiAgICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uICgpIC8qIG5hbWUsIGNvbnRleHQgKi97CiAgICAgIHZhciBfcm91dGVyOwoKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFycwogICAgICByZXR1cm4gKF9yb3V0ZXIgPSB0aGlzLl9yb3V0ZXIpLnRyYW5zaXRpb25Uby5hcHBseShfcm91dGVyLCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcm91dGVyMjsKCiAgICAgIChfcm91dGVyMiA9IHRoaXMuX3JvdXRlcikuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvLmFwcGx5KF9yb3V0ZXIyLCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgcmVmcmVzaDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5yZWZyZXNoKHRoaXMpOwogICAgfSwKICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcm91dGVyMzsKCiAgICAgIHJldHVybiAoX3JvdXRlcjMgPSB0aGlzLl9yb3V0ZXIpLnJlcGxhY2VXaXRoLmFwcGx5KF9yb3V0ZXIzLCAoMCwgX3V0aWxzLnByZWZpeFJvdXRlTmFtZUFyZykodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgc2VuZDogZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgICh0cnVlICYmICEoIXRoaXMuaXNEZXN0cm95aW5nICYmICF0aGlzLmlzRGVzdHJveWVkKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0F0dGVtcHRlZCB0byBjYWxsIC5zZW5kKCkgd2l0aCB0aGUgYWN0aW9uIFwnJyArIGFyZ3NbMF0gKyAnXCcgb24gdGhlIGRlc3Ryb3llZCByb3V0ZSBcJycgKyB0aGlzLnJvdXRlTmFtZSArICdcJy4nLCAhdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpKTsKCiAgICAgIGlmICh0aGlzLl9yb3V0ZXIgJiYgdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYiB8fCAhKDAsIF9kZWJ1Zy5pc1Rlc3RpbmcpKCkpIHsKICAgICAgICB2YXIgX3JvdXRlcjQ7CgogICAgICAgIChfcm91dGVyNCA9IHRoaXMuX3JvdXRlcikuc2VuZC5hcHBseShfcm91dGVyNCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG5hbWUgPSBhcmdzLnNoaWZ0KCk7CiAgICAgICAgdmFyIGFjdGlvbiA9IHRoaXMuYWN0aW9uc1tuYW1lXTsKICAgICAgICBpZiAoYWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHNldHVwOiBmdW5jdGlvbiAoY29udGV4dCwgdHJhbnNpdGlvbikgewogICAgICB2YXIgY29udHJvbGxlciA9IHZvaWQgMDsKCiAgICAgIHZhciBjb250cm9sbGVyTmFtZSA9IHRoaXMuY29udHJvbGxlck5hbWUgfHwgdGhpcy5yb3V0ZU5hbWU7CiAgICAgIHZhciBkZWZpbmVkQ29udHJvbGxlciA9IHRoaXMuY29udHJvbGxlckZvcihjb250cm9sbGVyTmFtZSwgdHJ1ZSk7CgogICAgICBpZiAoZGVmaW5lZENvbnRyb2xsZXIpIHsKICAgICAgICBjb250cm9sbGVyID0gZGVmaW5lZENvbnRyb2xsZXI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udHJvbGxlciA9IHRoaXMuZ2VuZXJhdGVDb250cm9sbGVyKGNvbnRyb2xsZXJOYW1lKTsKICAgICAgfQoKICAgICAgLy8gQXNzaWduIHRoZSByb3V0ZSdzIGNvbnRyb2xsZXIgc28gdGhhdCBpdCBjYW4gbW9yZSBlYXNpbHkgYmUKICAgICAgLy8gcmVmZXJlbmNlZCBpbiBhY3Rpb24gaGFuZGxlcnMuIFNpZGUgZWZmZWN0cy4gU2lkZSBlZmZlY3RzIGV2ZXJ5d2hlcmUuCiAgICAgIGlmICghdGhpcy5jb250cm9sbGVyKSB7CiAgICAgICAgdmFyIHByb3BOYW1lcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdfcXAucHJvcGVydHlOYW1lcycpOwogICAgICAgIGFkZFF1ZXJ5UGFyYW1zT2JzZXJ2ZXJzKGNvbnRyb2xsZXIsIHByb3BOYW1lcyk7CiAgICAgICAgdGhpcy5jb250cm9sbGVyID0gY29udHJvbGxlcjsKICAgICAgfQoKICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19xcCcpOwoKICAgICAgdmFyIHN0YXRlcyA9IHF1ZXJ5UGFyYW1zLnN0YXRlczsKCiAgICAgIGNvbnRyb2xsZXIuX3FwRGVsZWdhdGUgPSBzdGF0ZXMuYWxsb3dPdmVycmlkZXM7CgogICAgICBpZiAodHJhbnNpdGlvbikgewogICAgICAgIC8vIFVwZGF0ZSB0aGUgbW9kZWwgZGVwIHZhbHVlcyB1c2VkIHRvIGNhbGN1bGF0ZSBjYWNoZSBrZXlzLgogICAgICAgICgwLCBfdXRpbHMuc3Rhc2hQYXJhbU5hbWVzKSh0aGlzLl9yb3V0ZXIsIHRyYW5zaXRpb24uc3RhdGUuaGFuZGxlckluZm9zKTsKCiAgICAgICAgdmFyIGNhY2hlID0gdGhpcy5fYnVja2V0Q2FjaGU7CiAgICAgICAgdmFyIHBhcmFtcyA9IHRyYW5zaXRpb24ucGFyYW1zOwogICAgICAgIHZhciBhbGxQYXJhbXMgPSBxdWVyeVBhcmFtcy5wcm9wZXJ0eU5hbWVzOwoKICAgICAgICBhbGxQYXJhbXMuZm9yRWFjaChmdW5jdGlvbiAocHJvcCkgewogICAgICAgICAgdmFyIGFRcCA9IHF1ZXJ5UGFyYW1zLm1hcFtwcm9wXTsKICAgICAgICAgIGFRcC52YWx1ZXMgPSBwYXJhbXM7CgogICAgICAgICAgdmFyIGNhY2hlS2V5ID0gKDAsIF91dGlscy5jYWxjdWxhdGVDYWNoZUtleSkoYVFwLnJvdXRlLmZ1bGxSb3V0ZU5hbWUsIGFRcC5wYXJ0cywgYVFwLnZhbHVlcyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSBjYWNoZS5sb29rdXAoY2FjaGVLZXksIHByb3AsIGFRcC51bmRlY29yYXRlZERlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KShjb250cm9sbGVyLCBwcm9wLCB2YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBxcFZhbHVlcyA9IGdldFF1ZXJ5UGFyYW1zRm9yKHRoaXMsIHRyYW5zaXRpb24uc3RhdGUpOwogICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXRQcm9wZXJ0aWVzKShjb250cm9sbGVyLCBxcFZhbHVlcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0dXBDb250cm9sbGVyKGNvbnRyb2xsZXIsIGNvbnRleHQsIHRyYW5zaXRpb24pOwoKICAgICAgaWYgKHRoaXMuX2Vudmlyb25tZW50Lm9wdGlvbnMuc2hvdWxkUmVuZGVyKSB7CiAgICAgICAgdGhpcy5yZW5kZXJUZW1wbGF0ZShjb250cm9sbGVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAgIF9xcENoYW5nZWQ6IGZ1bmN0aW9uIChwcm9wLCB2YWx1ZSwgcXApIHsKICAgICAgaWYgKCFxcCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gVXBkYXRlIG1vZGVsLWRlcCBjYWNoZQogICAgICB2YXIgY2FjaGUgPSB0aGlzLl9idWNrZXRDYWNoZTsKICAgICAgdmFyIGNhY2hlS2V5ID0gKDAsIF91dGlscy5jYWxjdWxhdGVDYWNoZUtleSkocXAucm91dGUuZnVsbFJvdXRlTmFtZSwgcXAucGFydHMsIHFwLnZhbHVlcyk7CiAgICAgIGNhY2hlLnN0YXNoKGNhY2hlS2V5LCBwcm9wLCB2YWx1ZSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgVGhpcyBob29rIGlzIHRoZSBmaXJzdCBvZiB0aGUgcm91dGUgZW50cnkgdmFsaWRhdGlvbiBob29rcwogICAgICBjYWxsZWQgd2hlbiBhbiBhdHRlbXB0IGlzIG1hZGUgdG8gdHJhbnNpdGlvbiBpbnRvIGEgcm91dGUKICAgICAgb3Igb25lIG9mIGl0cyBjaGlsZHJlbi4gSXQgaXMgY2FsbGVkIGJlZm9yZSBgbW9kZWxgIGFuZAogICAgICBgYWZ0ZXJNb2RlbGAsIGFuZCBpcyBhcHByb3ByaWF0ZSBmb3IgY2FzZXMgd2hlbjoKICAgICAgIDEpIEEgZGVjaXNpb24gY2FuIGJlIG1hZGUgdG8gcmVkaXJlY3QgZWxzZXdoZXJlIHdpdGhvdXQKICAgICAgICAgbmVlZGluZyB0byByZXNvbHZlIHRoZSBtb2RlbCBmaXJzdC4KICAgICAgMikgQW55IGFzeW5jIG9wZXJhdGlvbnMgbmVlZCB0byBvY2N1ciBmaXJzdCBiZWZvcmUgdGhlCiAgICAgICAgIG1vZGVsIGlzIGF0dGVtcHRlZCB0byBiZSByZXNvbHZlZC4KICAgICAgIFRoaXMgaG9vayBpcyBwcm92aWRlZCB0aGUgY3VycmVudCBgdHJhbnNpdGlvbmAgYXR0ZW1wdAogICAgICBhcyBhIHBhcmFtZXRlciwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYC5hYm9ydCgpYCB0aGUgdHJhbnNpdGlvbiwKICAgICAgc2F2ZSBpdCBmb3IgYSBsYXRlciBgLnJldHJ5KClgLCBvciByZXRyaWV2ZSB2YWx1ZXMgc2V0CiAgICAgIG9uIGl0IGZyb20gYSBwcmV2aW91cyBob29rLiBZb3UgY2FuIGFsc28ganVzdCBjYWxsCiAgICAgIGB0aGlzLnRyYW5zaXRpb25Ub2AgdG8gYW5vdGhlciByb3V0ZSB0byBpbXBsaWNpdGx5CiAgICAgIGFib3J0IHRoZSBgdHJhbnNpdGlvbmAuCiAgICAgICBZb3UgY2FuIHJldHVybiBhIHByb21pc2UgZnJvbSB0aGlzIGhvb2sgdG8gcGF1c2UgdGhlCiAgICAgIHRyYW5zaXRpb24gdW50aWwgdGhlIHByb21pc2UgcmVzb2x2ZXMgKG9yIHJlamVjdHMpLiBUaGlzIGNvdWxkCiAgICAgIGJlIHVzZWZ1bCwgZm9yIGluc3RhbmNlLCBmb3IgcmV0cmlldmluZyBhc3luYyBjb2RlIGZyb20KICAgICAgdGhlIHNlcnZlciB0aGF0IGlzIHJlcXVpcmVkIHRvIGVudGVyIGEgcm91dGUuCiAgICAgICBAbWV0aG9kIGJlZm9yZU1vZGVsCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgICBAcmV0dXJuIHthbnkgfCBQcm9taXNlPGFueT59IGlmIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoaXMgaG9vayBpcwogICAgICAgIGEgcHJvbWlzZSwgdGhlIHRyYW5zaXRpb24gd2lsbCBwYXVzZSB1bnRpbCB0aGUgdHJhbnNpdGlvbgogICAgICAgIHJlc29sdmVzLiBPdGhlcndpc2UsIG5vbi1wcm9taXNlIHJldHVybiB2YWx1ZXMgYXJlIG5vdAogICAgICAgIHV0aWxpemVkIGluIGFueSB3YXkuCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgYmVmb3JlTW9kZWw6IEssCgogICAgLyoqCiAgICAgIFRoaXMgaG9vayBpcyBjYWxsZWQgYWZ0ZXIgdGhpcyByb3V0ZSdzIG1vZGVsIGhhcyByZXNvbHZlZC4KICAgICAgSXQgZm9sbG93cyBpZGVudGljYWwgYXN5bmMvcHJvbWlzZSBzZW1hbnRpY3MgdG8gYGJlZm9yZU1vZGVsYAogICAgICBidXQgaXMgcHJvdmlkZWQgdGhlIHJvdXRlJ3MgcmVzb2x2ZWQgbW9kZWwgaW4gYWRkaXRpb24gdG8KICAgICAgdGhlIGB0cmFuc2l0aW9uYCwgYW5kIGlzIHRoZXJlZm9yZSBzdWl0ZWQgdG8gcGVyZm9ybWluZwogICAgICBsb2dpYyB0aGF0IGNhbiBvbmx5IHRha2UgcGxhY2UgYWZ0ZXIgdGhlIG1vZGVsIGhhcyBhbHJlYWR5CiAgICAgIHJlc29sdmVkLgogICAgICAgYGBgYXBwL3JvdXRlcy9wb3N0cy5qcwogICAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgICBhZnRlck1vZGVsKHBvc3RzLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgICBpZiAocG9zdHMuZ2V0KCdsZW5ndGgnKSA9PT0gMSkgewogICAgICAgICAgICB0aGlzLnRyYW5zaXRpb25UbygncG9zdC5zaG93JywgcG9zdHMuZ2V0KCdmaXJzdE9iamVjdCcpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFJlZmVyIHRvIGRvY3VtZW50YXRpb24gZm9yIGBiZWZvcmVNb2RlbGAgZm9yIGEgZGVzY3JpcHRpb24KICAgICAgb2YgdHJhbnNpdGlvbi1wYXVzaW5nIHNlbWFudGljcyB3aGVuIGEgcHJvbWlzZSBpcyByZXR1cm5lZAogICAgICBmcm9tIHRoaXMgaG9vay4KICAgICAgIEBtZXRob2QgYWZ0ZXJNb2RlbAogICAgICBAcGFyYW0ge09iamVjdH0gcmVzb2x2ZWRNb2RlbCB0aGUgdmFsdWUgcmV0dXJuZWQgZnJvbSBgbW9kZWxgLAogICAgICAgIG9yIGl0cyByZXNvbHZlZCB2YWx1ZSBpZiBpdCB3YXMgYSBwcm9taXNlCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbgogICAgICBAcmV0dXJuIHthbnkgfCBQcm9taXNlPGFueT59IGlmIHRoZSB2YWx1ZSByZXR1cm5lZCBmcm9tIHRoaXMgaG9vayBpcwogICAgICAgIGEgcHJvbWlzZSwgdGhlIHRyYW5zaXRpb24gd2lsbCBwYXVzZSB1bnRpbCB0aGUgdHJhbnNpdGlvbgogICAgICAgIHJlc29sdmVzLiBPdGhlcndpc2UsIG5vbi1wcm9taXNlIHJldHVybiB2YWx1ZXMgYXJlIG5vdAogICAgICAgIHV0aWxpemVkIGluIGFueSB3YXkuCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAgKi8KICAgIGFmdGVyTW9kZWw6IEssCgogICAgLyoqCiAgICAgIEEgaG9vayB5b3UgY2FuIGltcGxlbWVudCB0byBvcHRpb25hbGx5IHJlZGlyZWN0IHRvIGFub3RoZXIgcm91dGUuCiAgICAgICBJZiB5b3UgY2FsbCBgdGhpcy50cmFuc2l0aW9uVG9gIGZyb20gaW5zaWRlIG9mIHRoaXMgaG9vaywgdGhpcyByb3V0ZQogICAgICB3aWxsIG5vdCBiZSBlbnRlcmVkIGluIGZhdm9yIG9mIHRoZSBvdGhlciBob29rLgogICAgICAgYHJlZGlyZWN0YCBhbmQgYGFmdGVyTW9kZWxgIGJlaGF2ZSB2ZXJ5IHNpbWlsYXJseSBhbmQgYXJlCiAgICAgIGNhbGxlZCBhbG1vc3QgYXQgdGhlIHNhbWUgdGltZSwgYnV0IHRoZXkgaGF2ZSBhbiBpbXBvcnRhbnQKICAgICAgZGlzdGluY3Rpb24gaW4gdGhlIGNhc2UgdGhhdCwgZnJvbSBvbmUgb2YgdGhlc2UgaG9va3MsIGEKICAgICAgcmVkaXJlY3QgaW50byBhIGNoaWxkIHJvdXRlIG9mIHRoaXMgcm91dGUgb2NjdXJzOiByZWRpcmVjdHMKICAgICAgZnJvbSBgYWZ0ZXJNb2RlbGAgZXNzZW50aWFsbHkgaW52YWxpZGF0ZSB0aGUgY3VycmVudCBhdHRlbXB0CiAgICAgIHRvIGVudGVyIHRoaXMgcm91dGUsIGFuZCB3aWxsIHJlc3VsdCBpbiB0aGlzIHJvdXRlJ3MgYGJlZm9yZU1vZGVsYCwKICAgICAgYG1vZGVsYCwgYW5kIGBhZnRlck1vZGVsYCBob29rcyBiZWluZyBmaXJlZCBhZ2FpbiB3aXRoaW4KICAgICAgdGhlIG5ldywgcmVkaXJlY3RpbmcgdHJhbnNpdGlvbi4gUmVkaXJlY3RzIHRoYXQgb2NjdXIgd2l0aGluCiAgICAgIHRoZSBgcmVkaXJlY3RgIGhvb2ssIG9uIHRoZSBvdGhlciBoYW5kLCB3aWxsIF9ub3RfIGNhdXNlCiAgICAgIHRoZXNlIGhvb2tzIHRvIGJlIGZpcmVkIGFnYWluIHRoZSBzZWNvbmQgdGltZSBhcm91bmQ7IGluCiAgICAgIG90aGVyIHdvcmRzLCBieSB0aGUgdGltZSB0aGUgYHJlZGlyZWN0YCBob29rIGhhcyBiZWVuIGNhbGxlZCwKICAgICAgYm90aCB0aGUgcmVzb2x2ZWQgbW9kZWwgYW5kIGF0dGVtcHRlZCBlbnRyeSBpbnRvIHRoaXMgcm91dGUKICAgICAgYXJlIGNvbnNpZGVyZWQgdG8gYmUgZnVsbHkgdmFsaWRhdGVkLgogICAgICAgQG1ldGhvZCByZWRpcmVjdAogICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwgdGhlIG1vZGVsIGZvciB0aGlzIHJvdXRlCiAgICAgIEBwYXJhbSB7VHJhbnNpdGlvbn0gdHJhbnNpdGlvbiB0aGUgdHJhbnNpdGlvbiBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50IHRyYW5zaXRpb24KICAgICAgQHNpbmNlIDEuMC4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZWRpcmVjdDogSywKCiAgICBjb250ZXh0RGlkQ2hhbmdlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuY3VycmVudE1vZGVsID0gdGhpcy5jb250ZXh0OwogICAgfSwKICAgIG1vZGVsOiBmdW5jdGlvbiAocGFyYW1zLCB0cmFuc2l0aW9uKSB7CiAgICAgIHZhciBuYW1lID0gdm9pZCAwLAogICAgICAgICAgc2F3UGFyYW1zID0gdm9pZCAwLAogICAgICAgICAgdmFsdWUgPSB2b2lkIDA7CiAgICAgIHZhciBxdWVyeVBhcmFtcyA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdfcXAubWFwJyk7CgogICAgICBmb3IgKHZhciBwcm9wIGluIHBhcmFtcykgewogICAgICAgIGlmIChwcm9wID09PSAncXVlcnlQYXJhbXMnIHx8IHF1ZXJ5UGFyYW1zICYmIHByb3AgaW4gcXVlcnlQYXJhbXMpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1hdGNoID0gcHJvcC5tYXRjaCgvXiguKilfaWQkLyk7CiAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICBuYW1lID0gbWF0Y2hbMV07CiAgICAgICAgICB2YWx1ZSA9IHBhcmFtc1twcm9wXTsKICAgICAgICB9CiAgICAgICAgc2F3UGFyYW1zID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgaWYgKHNhd1BhcmFtcykgewogICAgICAgICAgcmV0dXJuICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIHBhcmFtcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0cmFuc2l0aW9uLnJlc29sdmVJbmRleCA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRyYW5zaXRpb24uc3RhdGUuaGFuZGxlckluZm9zW3RyYW5zaXRpb24ucmVzb2x2ZUluZGV4IC0gMV0uY29udGV4dDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmZpbmRNb2RlbChuYW1lLCB2YWx1ZSk7CiAgICB9LAogICAgZGVzZXJpYWxpemU6IGZ1bmN0aW9uIChwYXJhbXMsIHRyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWwodGhpcy5wYXJhbXNGb3IodGhpcy5yb3V0ZU5hbWUpLCB0cmFuc2l0aW9uKTsKICAgIH0sCiAgICBmaW5kTW9kZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXQ7CgogICAgICByZXR1cm4gKF9nZXQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnc3RvcmUnKSkuZmluZC5hcHBseShfZ2V0LCBhcmd1bWVudHMpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFN0b3JlIHByb3BlcnR5IHByb3ZpZGVzIGEgaG9vayBmb3IgZGF0YSBwZXJzaXN0ZW5jZSBsaWJyYXJpZXMgdG8gaW5qZWN0IHRoZW1zZWx2ZXMuCiAgICAgICBCeSBkZWZhdWx0LCB0aGlzIHN0b3JlIHByb3BlcnR5IHByb3ZpZGVzIHRoZSBleGFjdCBzYW1lIGZ1bmN0aW9uYWxpdHkgcHJldmlvdXNseQogICAgICBpbiB0aGUgbW9kZWwgaG9vay4KICAgICAgIEN1cnJlbnRseSwgdGhlIHJlcXVpcmVkIGludGVyZmFjZSBpczoKICAgICAgIGBzdG9yZS5maW5kKG1vZGVsTmFtZSwgZmluZEFyZ3VtZW50cylgCiAgICAgICBAbWV0aG9kIHN0b3JlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBzdG9yZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHN0b3JlOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgdmFyIHJvdXRlTmFtZSA9IHRoaXMucm91dGVOYW1lOwogICAgICB2YXIgbmFtZXNwYWNlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ19yb3V0ZXIubmFtZXNwYWNlJyk7CgogICAgICByZXR1cm4gewogICAgICAgIGZpbmQ6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICAgICAgdmFyIG1vZGVsQ2xhc3MgPSBvd25lci5mYWN0b3J5Rm9yKCdtb2RlbDonICsgbmFtZSk7CgogICAgICAgICAgKHRydWUgJiYgISghIW1vZGVsQ2xhc3MpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHVzZWQgdGhlIGR5bmFtaWMgc2VnbWVudCAnICsgbmFtZSArICdfaWQgaW4geW91ciByb3V0ZSAnICsgcm91dGVOYW1lICsgJywgYnV0ICcgKyBuYW1lc3BhY2UgKyAnLicgKyAoMCwgX3N0cmluZy5jbGFzc2lmeSkobmFtZSkgKyAnIGRpZCBub3QgZXhpc3QgYW5kIHlvdSBkaWQgbm90IG92ZXJyaWRlIHlvdXIgcm91dGVcJ3MgYG1vZGVsYCBob29rLicsICEhbW9kZWxDbGFzcykpOwoKCiAgICAgICAgICBpZiAoIW1vZGVsQ2xhc3MpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIG1vZGVsQ2xhc3MgPSBtb2RlbENsYXNzLmNsYXNzOwoKICAgICAgICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsQ2xhc3MuZmluZCA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCgwLCBfc3RyaW5nLmNsYXNzaWZ5KShuYW1lKSArICcgaGFzIG5vIG1ldGhvZCBgZmluZGAuJywgdHlwZW9mIG1vZGVsQ2xhc3MuZmluZCA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICAgICAgICByZXR1cm4gbW9kZWxDbGFzcy5maW5kKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KSwKCiAgICAvKioKICAgICAgQSBob29rIHlvdSBjYW4gaW1wbGVtZW50IHRvIGNvbnZlcnQgdGhlIHJvdXRlJ3MgbW9kZWwgaW50byBwYXJhbWV0ZXJzCiAgICAgIGZvciB0aGUgVVJMLgogICAgICAgYGBgYXBwL3JvdXRlci5qcwogICAgICAvLyAuLi4KICAgICAgIFJvdXRlci5tYXAoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yb3V0ZSgncG9zdCcsIHsgcGF0aDogJy9wb3N0cy86cG9zdF9pZCcgfSk7CiAgICAgIH0pOwogICAgICAgYGBgCiAgICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgICAvLyB0aGUgc2VydmVyIHJldHVybnMgYHsgaWQ6IDEyIH1gCiAgICAgICAgICByZXR1cm4gJC5nZXRKU09OKCcvcG9zdHMvJyArIHBhcmFtcy5wb3N0X2lkKTsKICAgICAgICB9LAogICAgICAgICBzZXJpYWxpemUobW9kZWwpIHsKICAgICAgICAgIC8vIHRoaXMgd2lsbCBtYWtlIHRoZSBVUkwgYC9wb3N0cy8xMmAKICAgICAgICAgIHJldHVybiB7IHBvc3RfaWQ6IG1vZGVsLmlkIH07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGUgZGVmYXVsdCBgc2VyaWFsaXplYCBtZXRob2Qgd2lsbCBpbnNlcnQgdGhlIG1vZGVsJ3MgYGlkYCBpbnRvIHRoZQogICAgICByb3V0ZSdzIGR5bmFtaWMgc2VnbWVudCAoaW4gdGhpcyBjYXNlLCBgOnBvc3RfaWRgKSBpZiB0aGUgc2VnbWVudCBjb250YWlucyAnX2lkJy4KICAgICAgSWYgdGhlIHJvdXRlIGhhcyBtdWx0aXBsZSBkeW5hbWljIHNlZ21lbnRzIG9yIGRvZXMgbm90IGNvbnRhaW4gJ19pZCcsIGBzZXJpYWxpemVgCiAgICAgIHdpbGwgcmV0dXJuIGBnZXRQcm9wZXJ0aWVzKG1vZGVsLCBwYXJhbXMpYAogICAgICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gYHRyYW5zaXRpb25Ub2AgaXMgY2FsbGVkIHdpdGggYSBjb250ZXh0CiAgICAgIGluIG9yZGVyIHRvIHBvcHVsYXRlIHRoZSBVUkwuCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgICBAcGFyYW0ge09iamVjdH0gbW9kZWwgdGhlIHJvdXRlcyBtb2RlbAogICAgICBAcGFyYW0ge0FycmF5fSBwYXJhbXMgYW4gQXJyYXkgb2YgcGFyYW1ldGVyIG5hbWVzIGZvciB0aGUgY3VycmVudAogICAgICAgIHJvdXRlIChpbiB0aGUgZXhhbXBsZSwgYFsncG9zdF9pZCddYC4KICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgc2VyaWFsaXplZCBwYXJhbWV0ZXJzCiAgICAgIEBzaW5jZSAxLjAuMAogICAgICBAcHVibGljCiAgICAqLwogICAgc2VyaWFsaXplOiBkZWZhdWx0U2VyaWFsaXplLAoKICAgIHNldHVwQ29udHJvbGxlcjogZnVuY3Rpb24gKGNvbnRyb2xsZXIsIGNvbnRleHQgLyosIHRyYW5zaXRpb24gKi8pIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtdmFycwogICAgICBpZiAoY29udHJvbGxlciAmJiBjb250ZXh0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KShjb250cm9sbGVyLCAnbW9kZWwnLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAgIGNvbnRyb2xsZXJGb3I6IGZ1bmN0aW9uIChuYW1lLCBfc2tpcEFzc2VydCkgewogICAgICB2YXIgb3duZXIgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHRoaXMpOwogICAgICB2YXIgcm91dGUgPSBvd25lci5sb29rdXAoJ3JvdXRlOicgKyBuYW1lKTsKICAgICAgdmFyIGNvbnRyb2xsZXIgPSB2b2lkIDA7CgogICAgICBpZiAocm91dGUgJiYgcm91dGUuY29udHJvbGxlck5hbWUpIHsKICAgICAgICBuYW1lID0gcm91dGUuY29udHJvbGxlck5hbWU7CiAgICAgIH0KCiAgICAgIGNvbnRyb2xsZXIgPSBvd25lci5sb29rdXAoJ2NvbnRyb2xsZXI6JyArIG5hbWUpOwoKICAgICAgLy8gTk9URTogV2UncmUgc3BlY2lmaWNhbGx5IGNoZWNraW5nIHRoYXQgc2tpcEFzc2VydCBpcyB0cnVlLCBiZWNhdXNlIGFjY29yZGluZwogICAgICAvLyAgIHRvIHRoZSBvbGQgQVBJIHRoZSBzZWNvbmQgcGFyYW1ldGVyIHdhcyBtb2RlbC4gV2UgZG8gbm90IHdhbnQgcGVvcGxlIHdobwogICAgICAvLyAgIHBhc3NlZCBhIG1vZGVsIHRvIHNraXAgdGhlIGFzc2VydGlvbi4KICAgICAgKHRydWUgJiYgIShjb250cm9sbGVyIHx8IF9za2lwQXNzZXJ0ID09PSB0cnVlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBjb250cm9sbGVyIG5hbWVkIFwnJyArIG5hbWUgKyAnXCcgY291bGQgbm90IGJlIGZvdW5kLiBNYWtlIHN1cmUgdGhhdCB0aGlzIHJvdXRlIGV4aXN0cyBhbmQgaGFzIGFscmVhZHkgYmVlbiBlbnRlcmVkIGF0IGxlYXN0IG9uY2UuIElmIHlvdSBhcmUgYWNjZXNzaW5nIGEgY29udHJvbGxlciBub3QgYXNzb2NpYXRlZCB3aXRoIGEgcm91dGUsIG1ha2Ugc3VyZSB0aGUgY29udHJvbGxlciBjbGFzcyBpcyBleHBsaWNpdGx5IGRlZmluZWQuJywgY29udHJvbGxlciB8fCBfc2tpcEFzc2VydCA9PT0gdHJ1ZSkpOwoKCiAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgfSwKICAgIGdlbmVyYXRlQ29udHJvbGxlcjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKCiAgICAgIHJldHVybiAoMCwgX2dlbmVyYXRlX2NvbnRyb2xsZXIuZGVmYXVsdCkob3duZXIsIG5hbWUpOwogICAgfSwKICAgIG1vZGVsRm9yOiBmdW5jdGlvbiAoX25hbWUpIHsKICAgICAgdmFyIG5hbWUgPSB2b2lkIDA7CiAgICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgIHZhciB0cmFuc2l0aW9uID0gdGhpcy5fcm91dGVyID8gdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uIDogbnVsbDsKCiAgICAgIC8vIE9ubHkgY2hhbmdlIHRoZSByb3V0ZSBuYW1lIHdoZW4gdGhlcmUgaXMgYW4gYWN0aXZlIHRyYW5zaXRpb24uCiAgICAgIC8vIE90aGVyd2lzZSwgdXNlIHRoZSBwYXNzZWQgaW4gcm91dGUgbmFtZS4KICAgICAgaWYgKG93bmVyLnJvdXRhYmxlICYmIHRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICBuYW1lID0gZ2V0RW5naW5lUm91dGVOYW1lKG93bmVyLCBfbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmFtZSA9IF9uYW1lOwogICAgICB9CgogICAgICB2YXIgcm91dGUgPSBvd25lci5sb29rdXAoJ3JvdXRlOicgKyBuYW1lKTsKICAgICAgLy8gSWYgd2UgYXJlIG1pZC10cmFuc2l0aW9uLCB3ZSB3YW50IHRvIHRyeSBhbmQgbG9vayB1cAogICAgICAvLyByZXNvbHZlZCBwYXJlbnQgY29udGV4dHMgb24gdGhlIGN1cnJlbnQgdHJhbnNpdGlvbkV2ZW50LgogICAgICBpZiAodHJhbnNpdGlvbiAhPT0gbnVsbCkgewogICAgICAgIHZhciBtb2RlbExvb2t1cE5hbWUgPSByb3V0ZSAmJiByb3V0ZS5yb3V0ZU5hbWUgfHwgbmFtZTsKICAgICAgICBpZiAodHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVscy5oYXNPd25Qcm9wZXJ0eShtb2RlbExvb2t1cE5hbWUpKSB7CiAgICAgICAgICByZXR1cm4gdHJhbnNpdGlvbi5yZXNvbHZlZE1vZGVsc1ttb2RlbExvb2t1cE5hbWVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJvdXRlICYmIHJvdXRlLmN1cnJlbnRNb2RlbDsKICAgIH0sCiAgICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24gKCkgLyogY29udHJvbGxlciwgbW9kZWwgKi97CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnMKICAgICAgdGhpcy5yZW5kZXIoKTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIChfbmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgbmFtZSA9IHZvaWQgMDsKICAgICAgdmFyIGlzRGVmYXVsdFJlbmRlciA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDA7CiAgICAgIGlmICghaXNEZWZhdWx0UmVuZGVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBfbmFtZSA9PT0gJ29iamVjdCcgJiYgIW9wdGlvbnMpIHsKICAgICAgICAgIG5hbWUgPSB0aGlzLnRlbXBsYXRlTmFtZSB8fCB0aGlzLnJvdXRlTmFtZTsKICAgICAgICAgIG9wdGlvbnMgPSBfbmFtZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgKHRydWUgJiYgISghKDAsIF9lbWJlck1ldGFsLmlzRW1wdHkpKF9uYW1lKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgbmFtZSBpbiB0aGUgZ2l2ZW4gYXJndW1lbnRzIGlzIHVuZGVmaW5lZCBvciBlbXB0eSBzdHJpbmcnLCAhKDAsIF9lbWJlck1ldGFsLmlzRW1wdHkpKF9uYW1lKSkpOwoKICAgICAgICAgIG5hbWUgPSBfbmFtZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciByZW5kZXJPcHRpb25zID0gYnVpbGRSZW5kZXJPcHRpb25zKHRoaXMsIGlzRGVmYXVsdFJlbmRlciwgbmFtZSwgb3B0aW9ucyk7CiAgICAgIHRoaXMuY29ubmVjdGlvbnMucHVzaChyZW5kZXJPcHRpb25zKTsKICAgICAgKDAsIF9ydW5sb29wLm9uY2UpKHRoaXMuX3JvdXRlciwgJ19zZXRPdXRsZXRzJyk7CiAgICB9LAogICAgZGlzY29ubmVjdE91dGxldDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIG91dGxldE5hbWUgPSB2b2lkIDA7CiAgICAgIHZhciBwYXJlbnRWaWV3ID0gdm9pZCAwOwogICAgICBpZiAob3B0aW9ucykgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG91dGxldE5hbWUgPSBvcHRpb25zOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRsZXROYW1lID0gb3B0aW9ucy5vdXRsZXQ7CiAgICAgICAgICBwYXJlbnRWaWV3ID0gb3B0aW9ucy5wYXJlbnRWaWV3ID8gb3B0aW9ucy5wYXJlbnRWaWV3LnJlcGxhY2UoL1wvL2csICcuJykgOiB1bmRlZmluZWQ7CgogICAgICAgICAgKHRydWUgJiYgISghKCdvdXRsZXQnIGluIG9wdGlvbnMgJiYgb3B0aW9ucy5vdXRsZXQgPT09IHVuZGVmaW5lZCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHBhc3NlZCB1bmRlZmluZWQgYXMgdGhlIG91dGxldCBuYW1lLicsICEoJ291dGxldCcgaW4gb3B0aW9ucyAmJiBvcHRpb25zLm91dGxldCA9PT0gdW5kZWZpbmVkKSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgb3V0bGV0TmFtZSA9IG91dGxldE5hbWUgfHwgJ21haW4nOwogICAgICB0aGlzLl9kaXNjb25uZWN0T3V0bGV0KG91dGxldE5hbWUsIHBhcmVudFZpZXcpOwogICAgICB2YXIgaGFuZGxlckluZm9zID0gdGhpcy5fcm91dGVyLl9yb3V0ZXJNaWNyb2xpYi5jdXJyZW50SGFuZGxlckluZm9zOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIFRoaXMgbm9uLWxvY2FsIHN0YXRlIG11bmdpbmcgaXMgc2FkbHkgbmVjZXNzYXJ5IHRvIG1haW50YWluCiAgICAgICAgLy8gYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIG91ciBleGlzdGluZyBzZW1hbnRpY3MsIHdoaWNoIGFsbG93CiAgICAgICAgLy8gYW55IHJvdXRlIHRvIGRpc2Nvbm5lY3RPdXRsZXQgdGhpbmdzIG9yaWdpbmFsbHkgcmVuZGVyZWQgYnkgYW55CiAgICAgICAgLy8gb3RoZXIgcm91dGUuIFRoaXMgc2hvdWxkIGFsbCBnZXQgY3V0IGluIDIuMC4KICAgICAgICBoYW5kbGVySW5mb3NbaV0uaGFuZGxlci5fZGlzY29ubmVjdE91dGxldChvdXRsZXROYW1lLCBwYXJlbnRWaWV3KTsKICAgICAgfQogICAgfSwKICAgIF9kaXNjb25uZWN0T3V0bGV0OiBmdW5jdGlvbiAob3V0bGV0TmFtZSwgcGFyZW50VmlldykgewogICAgICB2YXIgcGFyZW50ID0gcGFyZW50Um91dGUodGhpcyk7CiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50VmlldyA9PT0gcGFyZW50LnJvdXRlTmFtZSkgewogICAgICAgIHBhcmVudFZpZXcgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbm5lY3Rpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvbm5lY3Rpb24gPSB0aGlzLmNvbm5lY3Rpb25zW2ldOwogICAgICAgIGlmIChjb25uZWN0aW9uLm91dGxldCA9PT0gb3V0bGV0TmFtZSAmJiBjb25uZWN0aW9uLmludG8gPT09IHBhcmVudFZpZXcpIHsKICAgICAgICAgIC8vIFRoaXMgbmV1dGVycyB0aGUgZGlzY29ubmVjdGVkIG91dGxldCBzdWNoIHRoYXQgaXQgZG9lc24ndAogICAgICAgICAgLy8gcmVuZGVyIGFueXRoaW5nLCBidXQgaXQgbGVhdmVzIGFuIGVudHJ5IGluIHRoZSBvdXRsZXQKICAgICAgICAgIC8vIGhpZXJhcmNoeSBzbyB0aGF0IGFueSBleGlzdGluZyBvdGhlciByZW5kZXJzIHRoYXQgdGFyZ2V0IGl0CiAgICAgICAgICAvLyBkb24ndCBzdWRkZW5seSBibG93IHVwLiBUaGV5IHdpbGwgc3RpbGwgc3RpY2sgdGhlbXNlbHZlcwogICAgICAgICAgLy8gaW50byBpdHMgb3V0bGV0cywgd2hpY2ggd29uJ3QgcmVuZGVyIGFueXdoZXJlLiBBbGwgb2YgdGhpcwogICAgICAgICAgLy8gc3RhdGVmdWxuZXNzIHNob3VsZCBnZXQgdGhlIG1hY2hldGUgaW4gMi4wLgogICAgICAgICAgdGhpcy5jb25uZWN0aW9uc1tpXSA9IHsKICAgICAgICAgICAgb3duZXI6IGNvbm5lY3Rpb24ub3duZXIsCiAgICAgICAgICAgIGludG86IGNvbm5lY3Rpb24uaW50bywKICAgICAgICAgICAgb3V0bGV0OiBjb25uZWN0aW9uLm91dGxldCwKICAgICAgICAgICAgbmFtZTogY29ubmVjdGlvbi5uYW1lLAogICAgICAgICAgICBjb250cm9sbGVyOiB1bmRlZmluZWQsCiAgICAgICAgICAgIHRlbXBsYXRlOiB1bmRlZmluZWQKICAgICAgICAgIH07CiAgICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcy5fcm91dGVyLCAnX3NldE91dGxldHMnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICB3aWxsRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnRlYXJkb3duVmlld3MoKTsKICAgIH0sCiAgICB0ZWFyZG93blZpZXdzOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmNvbm5lY3Rpb25zICYmIHRoaXMuY29ubmVjdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuY29ubmVjdGlvbnMgPSBbXTsKICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcy5fcm91dGVyLCAnX3NldE91dGxldHMnKTsKICAgICAgfQogICAgfQogIH0pOwoKICBSb3V0ZS5yZW9wZW5DbGFzcyh7CiAgICBpc1JvdXRlRmFjdG9yeTogdHJ1ZQogIH0pOwoKICBmdW5jdGlvbiBwYXJlbnRSb3V0ZShyb3V0ZSkgewogICAgdmFyIGhhbmRsZXJJbmZvID0gaGFuZGxlckluZm9Gb3Iocm91dGUsIHJvdXRlLl9yb3V0ZXIuX3JvdXRlck1pY3JvbGliLnN0YXRlLmhhbmRsZXJJbmZvcywgLTEpOwogICAgcmV0dXJuIGhhbmRsZXJJbmZvICYmIGhhbmRsZXJJbmZvLmhhbmRsZXI7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVySW5mb0Zvcihyb3V0ZSwgaGFuZGxlckluZm9zKSB7CiAgICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiAwOwoKICAgIGlmICghaGFuZGxlckluZm9zKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgY3VycmVudCA9IHZvaWQgMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlckluZm9zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGN1cnJlbnQgPSBoYW5kbGVySW5mb3NbaV0uaGFuZGxlcjsKICAgICAgaWYgKGN1cnJlbnQgPT09IHJvdXRlKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZXJJbmZvc1tpICsgb2Zmc2V0XTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gYnVpbGRSZW5kZXJPcHRpb25zKHJvdXRlLCBpc0RlZmF1bHRSZW5kZXIsIF9uYW1lLCBvcHRpb25zKSB7CiAgICAodHJ1ZSAmJiAhKGlzRGVmYXVsdFJlbmRlciB8fCAhKG9wdGlvbnMgJiYgJ291dGxldCcgaW4gb3B0aW9ucyAmJiBvcHRpb25zLm91dGxldCA9PT0gdW5kZWZpbmVkKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgcGFzc2VkIHVuZGVmaW5lZCBhcyB0aGUgb3V0bGV0IG5hbWUuJywgaXNEZWZhdWx0UmVuZGVyIHx8ICEob3B0aW9ucyAmJiAnb3V0bGV0JyBpbiBvcHRpb25zICYmIG9wdGlvbnMub3V0bGV0ID09PSB1bmRlZmluZWQpKSk7CgoKICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikocm91dGUpOwogICAgdmFyIG5hbWUgPSB2b2lkIDAsCiAgICAgICAgdGVtcGxhdGVOYW1lID0gdm9pZCAwLAogICAgICAgIGludG8gPSB2b2lkIDAsCiAgICAgICAgb3V0bGV0ID0gdm9pZCAwLAogICAgICAgIGNvbnRyb2xsZXIgPSB2b2lkIDAsCiAgICAgICAgbW9kZWwgPSB2b2lkIDA7CiAgICBpZiAob3B0aW9ucykgewogICAgICBpbnRvID0gb3B0aW9ucy5pbnRvICYmIG9wdGlvbnMuaW50by5yZXBsYWNlKC9cLy9nLCAnLicpOwogICAgICBvdXRsZXQgPSBvcHRpb25zLm91dGxldDsKICAgICAgY29udHJvbGxlciA9IG9wdGlvbnMuY29udHJvbGxlcjsKICAgICAgbW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgfQogICAgb3V0bGV0ID0gb3V0bGV0IHx8ICdtYWluJzsKCiAgICBpZiAoaXNEZWZhdWx0UmVuZGVyKSB7CiAgICAgIG5hbWUgPSByb3V0ZS5yb3V0ZU5hbWU7CiAgICAgIHRlbXBsYXRlTmFtZSA9IHJvdXRlLnRlbXBsYXRlTmFtZSB8fCBuYW1lOwogICAgfSBlbHNlIHsKICAgICAgbmFtZSA9IF9uYW1lLnJlcGxhY2UoL1wvL2csICcuJyk7CiAgICAgIHRlbXBsYXRlTmFtZSA9IG5hbWU7CiAgICB9CgogICAgaWYgKCFjb250cm9sbGVyKSB7CiAgICAgIGlmIChpc0RlZmF1bHRSZW5kZXIpIHsKICAgICAgICBjb250cm9sbGVyID0gcm91dGUuY29udHJvbGxlck5hbWUgfHwgb3duZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250cm9sbGVyID0gb3duZXIubG9va3VwKCdjb250cm9sbGVyOicgKyBuYW1lKSB8fCByb3V0ZS5jb250cm9sbGVyTmFtZSB8fCByb3V0ZS5yb3V0ZU5hbWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBjb250cm9sbGVyTmFtZSA9IGNvbnRyb2xsZXI7CiAgICAgIGNvbnRyb2xsZXIgPSBvd25lci5sb29rdXAoJ2NvbnRyb2xsZXI6JyArIGNvbnRyb2xsZXJOYW1lKTsKICAgICAgKHRydWUgJiYgIShpc0RlZmF1bHRSZW5kZXIgfHwgY29udHJvbGxlcikgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgcGFzc2VkIGBjb250cm9sbGVyOiBcJycgKyBjb250cm9sbGVyTmFtZSArICdcJ2AgaW50byB0aGUgYHJlbmRlcmAgbWV0aG9kLCBidXQgbm8gc3VjaCBjb250cm9sbGVyIGNvdWxkIGJlIGZvdW5kLicsIGlzRGVmYXVsdFJlbmRlciB8fCBjb250cm9sbGVyKSk7CiAgICB9CgogICAgaWYgKG1vZGVsKSB7CiAgICAgIGNvbnRyb2xsZXIuc2V0KCdtb2RlbCcsIG1vZGVsKTsKICAgIH0KCiAgICB2YXIgdGVtcGxhdGUgPSBvd25lci5sb29rdXAoJ3RlbXBsYXRlOicgKyB0ZW1wbGF0ZU5hbWUpOwogICAgKHRydWUgJiYgIShpc0RlZmF1bHRSZW5kZXIgfHwgdGVtcGxhdGUpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ291bGQgbm90IGZpbmQgIicgKyB0ZW1wbGF0ZU5hbWUgKyAnIiB0ZW1wbGF0ZSwgdmlldywgb3IgY29tcG9uZW50LicsIGlzRGVmYXVsdFJlbmRlciB8fCB0ZW1wbGF0ZSkpOwoKCiAgICB2YXIgcGFyZW50ID0gdm9pZCAwOwogICAgaWYgKGludG8gJiYgKHBhcmVudCA9IHBhcmVudFJvdXRlKHJvdXRlKSkgJiYgaW50byA9PT0gcGFyZW50LnJvdXRlTmFtZSkgewogICAgICBpbnRvID0gdW5kZWZpbmVkOwogICAgfQoKICAgIHZhciByZW5kZXJPcHRpb25zID0gewogICAgICBvd25lcjogb3duZXIsCiAgICAgIGludG86IGludG8sCiAgICAgIG91dGxldDogb3V0bGV0LAogICAgICBuYW1lOiBuYW1lLAogICAgICBjb250cm9sbGVyOiBjb250cm9sbGVyLAogICAgICB0ZW1wbGF0ZTogdGVtcGxhdGUgfHwgcm91dGUuX3RvcExldmVsVmlld1RlbXBsYXRlCiAgICB9OwoKICAgIGlmICh0cnVlKSB7CiAgICAgIHZhciBMT0dfVklFV19MT09LVVBTID0gKDAsIF9lbWJlck1ldGFsLmdldCkocm91dGUuX3JvdXRlciwgJ25hbWVzcGFjZS5MT0dfVklFV19MT09LVVBTJyk7CiAgICAgIGlmIChMT0dfVklFV19MT09LVVBTICYmICF0ZW1wbGF0ZSkgewogICAgICAgICgwLCBfZGVidWcuaW5mbykoJ0NvdWxkIG5vdCBmaW5kICInICsgbmFtZSArICciIHRlbXBsYXRlLiBOb3RoaW5nIHdpbGwgYmUgcmVuZGVyZWQnLCB7CiAgICAgICAgICBmdWxsTmFtZTogJ3RlbXBsYXRlOicgKyBuYW1lCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVuZGVyT3B0aW9uczsKICB9CgogIGZ1bmN0aW9uIGdldEZ1bGxRdWVyeVBhcmFtcyhyb3V0ZXIsIHN0YXRlKSB7CiAgICBpZiAoc3RhdGUuZnVsbFF1ZXJ5UGFyYW1zKSB7CiAgICAgIHJldHVybiBzdGF0ZS5mdWxsUXVlcnlQYXJhbXM7CiAgICB9CgogICAgc3RhdGUuZnVsbFF1ZXJ5UGFyYW1zID0ge307CiAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHN0YXRlLmZ1bGxRdWVyeVBhcmFtcywgc3RhdGUucXVlcnlQYXJhbXMpOwoKICAgIHJvdXRlci5fZGVzZXJpYWxpemVRdWVyeVBhcmFtcyhzdGF0ZS5oYW5kbGVySW5mb3MsIHN0YXRlLmZ1bGxRdWVyeVBhcmFtcyk7CiAgICByZXR1cm4gc3RhdGUuZnVsbFF1ZXJ5UGFyYW1zOwogIH0KCiAgZnVuY3Rpb24gZ2V0UXVlcnlQYXJhbXNGb3Iocm91dGUsIHN0YXRlKSB7CiAgICBzdGF0ZS5xdWVyeVBhcmFtc0ZvciA9IHN0YXRlLnF1ZXJ5UGFyYW1zRm9yIHx8IHt9OwogICAgdmFyIG5hbWUgPSByb3V0ZS5mdWxsUm91dGVOYW1lOwoKICAgIGlmIChzdGF0ZS5xdWVyeVBhcmFtc0ZvcltuYW1lXSkgewogICAgICByZXR1cm4gc3RhdGUucXVlcnlQYXJhbXNGb3JbbmFtZV07CiAgICB9CgogICAgdmFyIGZ1bGxRdWVyeVBhcmFtcyA9IGdldEZ1bGxRdWVyeVBhcmFtcyhyb3V0ZS5fcm91dGVyLCBzdGF0ZSk7CgogICAgdmFyIHBhcmFtcyA9IHN0YXRlLnF1ZXJ5UGFyYW1zRm9yW25hbWVdID0ge307CgogICAgLy8gQ29weSBvdmVyIGFsbCB0aGUgcXVlcnkgcGFyYW1zIGZvciB0aGlzIHJvdXRlL2NvbnRyb2xsZXIgaW50byBwYXJhbXMgaGFzaC4KICAgIHZhciBxcE1ldGEgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShyb3V0ZSwgJ19xcCcpOwogICAgdmFyIHFwcyA9IHFwTWV0YS5xcHM7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHFwcy5sZW5ndGg7ICsraSkgewogICAgICAvLyBQdXQgZGVzZXJpYWxpemVkIHFwIG9uIHBhcmFtcyBoYXNoLgogICAgICB2YXIgcXAgPSBxcHNbaV07CgogICAgICB2YXIgcXBWYWx1ZVdhc1Bhc3NlZEluID0gcXAucHJvcCBpbiBmdWxsUXVlcnlQYXJhbXM7CiAgICAgIHBhcmFtc1txcC5wcm9wXSA9IHFwVmFsdWVXYXNQYXNzZWRJbiA/IGZ1bGxRdWVyeVBhcmFtc1txcC5wcm9wXSA6IGNvcHlEZWZhdWx0VmFsdWUocXAuZGVmYXVsdFZhbHVlKTsKICAgIH0KCiAgICByZXR1cm4gcGFyYW1zOwogIH0KCiAgZnVuY3Rpb24gY29weURlZmF1bHRWYWx1ZSh2YWx1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyUnVudGltZS5BKSh2YWx1ZS5zbGljZSgpKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qCiAgICBNZXJnZXMgYWxsIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSBhIGNvbnRyb2xsZXIgd2l0aCB0aG9zZSBmcm9tCiAgICBhIHJvdXRlLCByZXR1cm5pbmcgYSBuZXcgb2JqZWN0IGFuZCBhdm9pZGluZyBhbnkgbXV0YXRpb25zIHRvCiAgICB0aGUgZXhpc3Rpbmcgb2JqZWN0cy4KICAqLwogIGZ1bmN0aW9uIG1lcmdlRWFjaFF1ZXJ5UGFyYW1zKGNvbnRyb2xsZXJRUCwgcm91dGVRUCkgewogICAgdmFyIHFwcyA9IHt9OwogICAgdmFyIGtleXNBbHJlYWR5TWVyZ2VkT3JTa2lwcGFibGUgPSB7CiAgICAgIGRlZmF1bHRWYWx1ZTogdHJ1ZSwKICAgICAgdHlwZTogdHJ1ZSwKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGFzOiB0cnVlCiAgICB9OwoKICAgIC8vIGZpcnN0IGxvb3Agb3ZlciBhbGwgY29udHJvbGxlciBxcHMsIG1lcmdpbmcgdGhlbSB3aXRoIGFueSBtYXRjaGluZyByb3V0ZSBxcHMKICAgIC8vIGludG8gYSBuZXcgZW1wdHkgb2JqZWN0IHRvIGF2b2lkIG11dGF0aW5nLgogICAgZm9yICh2YXIgY3FwTmFtZSBpbiBjb250cm9sbGVyUVApIHsKICAgICAgaWYgKCFjb250cm9sbGVyUVAuaGFzT3duUHJvcGVydHkoY3FwTmFtZSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIG5ld0NvbnRyb2xsZXJQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0ge307CiAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikobmV3Q29udHJvbGxlclBhcmFtZXRlckNvbmZpZ3VyYXRpb24sIGNvbnRyb2xsZXJRUFtjcXBOYW1lXSwgcm91dGVRUFtjcXBOYW1lXSk7CgogICAgICBxcHNbY3FwTmFtZV0gPSBuZXdDb250cm9sbGVyUGFyYW1ldGVyQ29uZmlndXJhdGlvbjsKCiAgICAgIC8vIGFsbG93cyB1cyB0byBza2lwIHRoaXMgUVAgd2hlbiB3ZSBjaGVjayByb3V0ZSBRUHMuCiAgICAgIGtleXNBbHJlYWR5TWVyZ2VkT3JTa2lwcGFibGVbY3FwTmFtZV0gPSB0cnVlOwogICAgfQoKICAgIC8vIGxvb3Agb3ZlciBhbGwgcm91dGUgcXBzLCBza2lwcGluZyB0aG9zZSB0aGF0IHdlcmUgbWVyZ2VkIGluIHRoZSBmaXJzdCBwYXNzCiAgICAvLyBiZWNhdXNlIHRoZXkgYWxzbyBhcHBlYXIgaW4gY29udHJvbGxlciBxcHMKICAgIGZvciAodmFyIHJxcE5hbWUgaW4gcm91dGVRUCkgewogICAgICBpZiAoIXJvdXRlUVAuaGFzT3duUHJvcGVydHkocnFwTmFtZSkgfHwga2V5c0FscmVhZHlNZXJnZWRPclNraXBwYWJsZVtycXBOYW1lXSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgbmV3Um91dGVQYXJhbWV0ZXJDb25maWd1cmF0aW9uID0ge307CiAgICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikobmV3Um91dGVQYXJhbWV0ZXJDb25maWd1cmF0aW9uLCByb3V0ZVFQW3JxcE5hbWVdLCBjb250cm9sbGVyUVBbcnFwTmFtZV0pOwogICAgICBxcHNbcnFwTmFtZV0gPSBuZXdSb3V0ZVBhcmFtZXRlckNvbmZpZ3VyYXRpb247CiAgICB9CgogICAgcmV0dXJuIHFwczsKICB9CgogIGZ1bmN0aW9uIGFkZFF1ZXJ5UGFyYW1zT2JzZXJ2ZXJzKGNvbnRyb2xsZXIsIHByb3BOYW1lcykgewogICAgcHJvcE5hbWVzLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHsKICAgICAgY29udHJvbGxlci5hZGRPYnNlcnZlcihwcm9wICsgJy5bXScsIGNvbnRyb2xsZXIsIGNvbnRyb2xsZXIuX3FwQ2hhbmdlZCk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdldEVuZ2luZVJvdXRlTmFtZShlbmdpbmUsIHJvdXRlTmFtZSkgewogICAgaWYgKGVuZ2luZS5yb3V0YWJsZSkgewogICAgICB2YXIgcHJlZml4ID0gZW5naW5lLm1vdW50UG9pbnQ7CgogICAgICBpZiAocm91dGVOYW1lID09PSAnYXBwbGljYXRpb24nKSB7CiAgICAgICAgcmV0dXJuIHByZWZpeDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gcHJlZml4ICsgJy4nICsgcm91dGVOYW1lOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJvdXRlTmFtZTsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IFJvdXRlOwp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vcm91dGVyJywgWydleHBvcnRzJywgJ2VtYmVyLW93bmVyJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL2Vycm9yJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1ydW50aW1lJywgJ2VtYmVyLXJvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZScsICdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vZHNsJywgJ2VtYmVyLXJvdXRpbmcvbGliL2xvY2F0aW9uL2FwaScsICdlbWJlci1yb3V0aW5nL2xpYi91dGlscycsICdlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vcm91dGVyX3N0YXRlJywgJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzJywgJ3JvdXRlciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyT3duZXIsIF9wb2x5ZmlsbHMsIF9ydW5sb29wLCBfZW1iZXJNZXRhbCwgX2Vycm9yMiwgX2RlYnVnLCBfZW1iZXJSdW50aW1lLCBfcm91dGUsIF9kc2wsIF9hcGksIF91dGlscywgX3JvdXRlcl9zdGF0ZSwgX2RlcHJlY2F0ZWRGZWF0dXJlcywgX3JvdXRlcikgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy50cmlnZ2VyRXZlbnQgPSB0cmlnZ2VyRXZlbnQ7CgoKICBmdW5jdGlvbiBLKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICBAbW9kdWxlIEBlbWJlci9yb3V0aW5nCiAgKi8KCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCiAgLyoqCiAgICBUaGUgYEVtYmVyUm91dGVyYCBjbGFzcyBtYW5hZ2VzIHRoZSBhcHBsaWNhdGlvbiBzdGF0ZSBhbmQgVVJMcy4gUmVmZXIgdG8KICAgIHRoZSBbcm91dGluZyBndWlkZV0oaHR0cHM6Ly9lbWJlcmpzLmNvbS9ndWlkZXMvcm91dGluZy8pIGZvciBkb2N1bWVudGF0aW9uLgogIAogICAgQGNsYXNzIEVtYmVyUm91dGVyCiAgICBAZXh0ZW5kcyBFbWJlck9iamVjdAogICAgQHVzZXMgRXZlbnRlZAogICAgQHB1YmxpYwogICovCiAgdmFyIEVtYmVyUm91dGVyID0gX2VtYmVyUnVudGltZS5PYmplY3QuZXh0ZW5kKF9lbWJlclJ1bnRpbWUuRXZlbnRlZCwgewogICAgLyoqCiAgICAgIFRoZSBgbG9jYXRpb25gIHByb3BlcnR5IGRldGVybWluZXMgdGhlIHR5cGUgb2YgVVJMJ3MgdGhhdCB5b3VyCiAgICAgIGFwcGxpY2F0aW9uIHdpbGwgdXNlLgogICAgICAgVGhlIGZvbGxvd2luZyBsb2NhdGlvbiB0eXBlcyBhcmUgY3VycmVudGx5IGF2YWlsYWJsZToKICAgICAgICogYGhpc3RvcnlgIC0gdXNlIHRoZSBicm93c2VyJ3MgaGlzdG9yeSBBUEkgdG8gbWFrZSB0aGUgVVJMcyBsb29rIGp1c3QgbGlrZSBhbnkgc3RhbmRhcmQgVVJMCiAgICAgICogYGhhc2hgIC0gdXNlIGAjYCB0byBzZXBhcmF0ZSB0aGUgc2VydmVyIHBhcnQgb2YgdGhlIFVSTCBmcm9tIHRoZSBFbWJlciBwYXJ0OiBgL2Jsb2cvIy9wb3N0cy9uZXdgCiAgICAgICogYG5vbmVgIC0gZG8gbm90IHN0b3JlIHRoZSBFbWJlciBVUkwgaW4gdGhlIGFjdHVhbCBicm93c2VyIFVSTCAobWFpbmx5IHVzZWQgZm9yIHRlc3RpbmcpCiAgICAgICogYGF1dG9gIC0gdXNlIHRoZSBiZXN0IG9wdGlvbiBiYXNlZCBvbiBicm93c2VyIGNhcGFiaWxpdGllczogYGhpc3RvcnlgIGlmIHBvc3NpYmxlLCB0aGVuIGBoYXNoYCBpZiBwb3NzaWJsZSwgb3RoZXJ3aXNlIGBub25lYAogICAgICAgVGhpcyB2YWx1ZSBpcyBkZWZhdWx0ZWQgdG8gYGF1dG9gIGJ5IHRoZSBgbG9jYXRpb25UeXBlYCBzZXR0aW5nIG9mIGAvY29uZmlnL2Vudmlyb25tZW50LmpzYAogICAgICAgQHByb3BlcnR5IGxvY2F0aW9uCiAgICAgIEBkZWZhdWx0ICdoYXNoJwogICAgICBAc2VlIHtMb2NhdGlvbn0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGxvY2F0aW9uOiAnaGFzaCcsCgogICAgLyoqCiAgICAgUmVwcmVzZW50cyB0aGUgVVJMIG9mIHRoZSByb290IG9mIHRoZSBhcHBsaWNhdGlvbiwgb2Z0ZW4gJy8nLiBUaGlzIHByZWZpeCBpcwogICAgIGFzc3VtZWQgb24gYWxsIHJvdXRlcyBkZWZpbmVkIG9uIHRoaXMgcm91dGVyLgogICAgICBAcHJvcGVydHkgcm9vdFVSTAogICAgIEBkZWZhdWx0ICcvJwogICAgIEBwdWJsaWMKICAgICovCiAgICByb290VVJMOiAnLycsCgogICAgX2luaXRSb3V0ZXJKczogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcm91dGVyTWljcm9saWIgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYiA9IG5ldyBfcm91dGVyLmRlZmF1bHQoKTsKICAgICAgcm91dGVyTWljcm9saWIudHJpZ2dlckV2ZW50ID0gdHJpZ2dlckV2ZW50LmJpbmQodGhpcyk7CgogICAgICByb3V0ZXJNaWNyb2xpYi5fdHJpZ2dlcldpbGxDaGFuZ2VDb250ZXh0ID0gSzsKICAgICAgcm91dGVyTWljcm9saWIuX3RyaWdnZXJXaWxsTGVhdmUgPSBLOwoKICAgICAgdmFyIGRzbENhbGxiYWNrcyA9IHRoaXMuY29uc3RydWN0b3IuZHNsQ2FsbGJhY2tzIHx8IFtLXTsKICAgICAgdmFyIGRzbCA9IHRoaXMuX2J1aWxkRFNMKCk7CgogICAgICBkc2wucm91dGUoJ2FwcGxpY2F0aW9uJywgeyBwYXRoOiAnLycsIHJlc2V0TmFtZXNwYWNlOiB0cnVlLCBvdmVycmlkZU5hbWVBc3NlcnRpb246IHRydWUgfSwgZnVuY3Rpb24gKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZHNsQ2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBkc2xDYWxsYmFja3NbaV0uY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ25hbWVzcGFjZS5MT0dfVFJBTlNJVElPTlNfSU5URVJOQUwnKSkgewogICAgICAgICAgcm91dGVyTWljcm9saWIubG9nID0gY29uc29sZS5sb2cuYmluZChjb25zb2xlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgICAgICAgfQogICAgICB9CgogICAgICByb3V0ZXJNaWNyb2xpYi5tYXAoZHNsLmdlbmVyYXRlKCkpOwogICAgfSwKICAgIF9idWlsZERTTDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZW5hYmxlTG9hZGluZ1N1YnN0YXRlcyA9IHRoaXMuX2hhc01vZHVsZUJhc2VkUmVzb2x2ZXIoKTsKICAgICAgdmFyIG9wdGlvbnMgPSB7IGVuYWJsZUxvYWRpbmdTdWJzdGF0ZXM6IGVuYWJsZUxvYWRpbmdTdWJzdGF0ZXMgfTsKCiAgICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikodGhpcyk7CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwoKICAgICAgb3B0aW9ucy5yZXNvbHZlUm91dGVNYXAgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBvd25lci5mYWN0b3J5Rm9yKCdyb3V0ZS1tYXA6JyArIG5hbWUpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5hZGRSb3V0ZUZvckVuZ2luZSA9IGZ1bmN0aW9uIChuYW1lLCBlbmdpbmVJbmZvKSB7CiAgICAgICAgaWYgKCFyb3V0ZXIuX2VuZ2luZUluZm9CeVJvdXRlW25hbWVdKSB7CiAgICAgICAgICByb3V0ZXIuX2VuZ2luZUluZm9CeVJvdXRlW25hbWVdID0gZW5naW5lSW5mbzsKICAgICAgICB9CiAgICAgIH07CgogICAgICByZXR1cm4gbmV3IF9kc2wuZGVmYXVsdChudWxsLCBvcHRpb25zKTsKICAgIH0sCiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLmN1cnJlbnRVUkwgPSBudWxsOwogICAgICB0aGlzLmN1cnJlbnRSb3V0ZU5hbWUgPSBudWxsOwogICAgICB0aGlzLmN1cnJlbnRQYXRoID0gbnVsbDsKCiAgICAgIHRoaXMuX3FwQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9yZXNldFF1ZXVlZFF1ZXJ5UGFyYW1ldGVyQ2hhbmdlcygpOwogICAgICB0aGlzLl9oYW5kbGVkRXJyb3JzID0gbmV3IFNldCgpOwogICAgICB0aGlzLl9lbmdpbmVJbnN0YW5jZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9lbmdpbmVJbmZvQnlSb3V0ZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9LAogICAgX3Jlc2V0UXVldWVkUXVlcnlQYXJhbWV0ZXJDaGFuZ2VzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3F1ZXVlZFFQQ2hhbmdlcyA9IHt9OwogICAgfSwKCgogICAgLyoqCiAgICAgIFJlcHJlc2VudHMgdGhlIGN1cnJlbnQgVVJMLgogICAgICAgQG1ldGhvZCB1cmwKICAgICAgQHJldHVybiB7U3RyaW5nfSBUaGUgY3VycmVudCBVUkwuCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgdXJsOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2NhdGlvbicpLmdldFVSTCgpOwogICAgfSksCgogICAgX2hhc01vZHVsZUJhc2VkUmVzb2x2ZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgaWYgKCFvd25lcikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHJlc29sdmVyID0gKDAsIF9lbWJlck1ldGFsLmdldCkob3duZXIsICdhcHBsaWNhdGlvbi5fX3JlZ2lzdHJ5X18ucmVzb2x2ZXIubW9kdWxlQmFzZWRSZXNvbHZlcicpOwogICAgICByZXR1cm4gISFyZXNvbHZlcjsKICAgIH0sCiAgICBzdGFydFJvdXRpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGluaXRpYWxVUkwgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnaW5pdGlhbFVSTCcpOwoKICAgICAgaWYgKHRoaXMuc2V0dXBSb3V0ZXIoKSkgewogICAgICAgIGlmIChpbml0aWFsVVJMID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGluaXRpYWxVUkwgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbG9jYXRpb24nKS5nZXRVUkwoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGluaXRpYWxUcmFuc2l0aW9uID0gdGhpcy5oYW5kbGVVUkwoaW5pdGlhbFVSTCk7CiAgICAgICAgaWYgKGluaXRpYWxUcmFuc2l0aW9uICYmIGluaXRpYWxUcmFuc2l0aW9uLmVycm9yKSB7CiAgICAgICAgICB0aHJvdyBpbml0aWFsVHJhbnNpdGlvbi5lcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBzZXR1cFJvdXRlcjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgdGhpcy5faW5pdFJvdXRlckpzKCk7CiAgICAgIHRoaXMuX3NldHVwTG9jYXRpb24oKTsKCiAgICAgIHZhciBsb2NhdGlvbiA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdsb2NhdGlvbicpOwoKICAgICAgLy8gQWxsb3cgdGhlIExvY2F0aW9uIGNsYXNzIHRvIGNhbmNlbCB0aGUgcm91dGVyIHNldHVwIHdoaWxlIGl0IHJlZnJlc2hlcwogICAgICAvLyB0aGUgcGFnZQogICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkobG9jYXRpb24sICdjYW5jZWxSb3V0ZXJTZXR1cCcpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB0aGlzLl9zZXR1cFJvdXRlcihsb2NhdGlvbik7CgogICAgICBsb2NhdGlvbi5vblVwZGF0ZVVSTChmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgX3RoaXMuaGFuZGxlVVJMKHVybCk7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgZGlkVHJhbnNpdGlvbjogZnVuY3Rpb24gKGluZm9zKSB7CiAgICAgIHVwZGF0ZVBhdGhzKHRoaXMpOwoKICAgICAgdGhpcy5fY2FuY2VsU2xvd1RyYW5zaXRpb25UaW1lcigpOwoKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgndXJsJyk7CiAgICAgIHRoaXMuc2V0KCdjdXJyZW50U3RhdGUnLCB0aGlzLnRhcmdldFN0YXRlKTsKCiAgICAgIC8vIFB1dCB0aGlzIGluIHRoZSBydW5sb29wIHNvIHVybCB3aWxsIGJlIGFjY3VyYXRlLiBTZWVtcwogICAgICAvLyBsZXNzIHN1cnByaXNpbmcgdGhhbiBkaWRUcmFuc2l0aW9uIGJlaW5nIG91dCBvZiBzeW5jLgogICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcywgdGhpcy50cmlnZ2VyLCAnZGlkVHJhbnNpdGlvbicpOwoKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ25hbWVzcGFjZScpLkxPR19UUkFOU0lUSU9OUykgewogICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGUKICAgICAgICAgIGNvbnNvbGUubG9nKCdUcmFuc2l0aW9uZWQgaW50byBcJycgKyBFbWJlclJvdXRlci5fcm91dGVQYXRoKGluZm9zKSArICdcJycpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIF9zZXRPdXRsZXRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIFRoaXMgaXMgdHJpZ2dlcmVkIGFzeW5jIGR1cmluZyBSb3V0ZSN3aWxsRGVzdHJveS4KICAgICAgLy8gSWYgdGhlIHJvdXRlciBpcyBhbHNvIGJlaW5nIGRlc3Ryb3llZCB3ZSBkbyBub3Qgd2FudCB0bwogICAgICAvLyB0byBjcmVhdGUgYW5vdGhlciB0aGlzLl90b3BsZXZlbFZpZXcgKGFuZCBsZWFrIHRoZSByZW5kZXJlcikKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95aW5nIHx8IHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBoYW5kbGVySW5mb3MgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5jdXJyZW50SGFuZGxlckluZm9zOwogICAgICB2YXIgcm91dGUgPSB2b2lkIDA7CiAgICAgIHZhciBkZWZhdWx0UGFyZW50U3RhdGUgPSB2b2lkIDA7CiAgICAgIHZhciBsaXZlUm91dGVzID0gbnVsbDsKCiAgICAgIGlmICghaGFuZGxlckluZm9zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICAgIHJvdXRlID0gaGFuZGxlckluZm9zW2ldLmhhbmRsZXI7CiAgICAgICAgdmFyIGNvbm5lY3Rpb25zID0gcm91dGUuY29ubmVjdGlvbnM7CiAgICAgICAgdmFyIG93blN0YXRlID0gdm9pZCAwOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29ubmVjdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciBhcHBlbmRlZCA9IGFwcGVuZExpdmVSb3V0ZShsaXZlUm91dGVzLCBkZWZhdWx0UGFyZW50U3RhdGUsIGNvbm5lY3Rpb25zW2pdKTsKICAgICAgICAgIGxpdmVSb3V0ZXMgPSBhcHBlbmRlZC5saXZlUm91dGVzOwogICAgICAgICAgaWYgKGFwcGVuZGVkLm93blN0YXRlLnJlbmRlci5uYW1lID09PSByb3V0ZS5yb3V0ZU5hbWUgfHwgYXBwZW5kZWQub3duU3RhdGUucmVuZGVyLm91dGxldCA9PT0gJ21haW4nKSB7CiAgICAgICAgICAgIG93blN0YXRlID0gYXBwZW5kZWQub3duU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjb25uZWN0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIG93blN0YXRlID0gcmVwcmVzZW50RW1wdHlSb3V0ZShsaXZlUm91dGVzLCBkZWZhdWx0UGFyZW50U3RhdGUsIHJvdXRlKTsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdFBhcmVudFN0YXRlID0gb3duU3RhdGU7CiAgICAgIH0KCiAgICAgIC8vIHdoZW4gYSB0cmFuc2l0aW9uVG8gaGFwcGVucyBhZnRlciB0aGUgdmFsaWRhdGlvbiBwaGFzZQogICAgICAvLyBkdXJpbmcgdGhlIGluaXRpYWwgdHJhbnNpdGlvbiBfc2V0T3V0bGV0cyBpcyBjYWxsZWQKICAgICAgLy8gd2hlbiBubyByb3V0ZXMgYXJlIGFjdGl2ZS4gSG93ZXZlciwgaXQgd2lsbCBnZXQgY2FsbGVkCiAgICAgIC8vIGFnYWluIHdpdGggdGhlIGNvcnJlY3QgdmFsdWVzIGR1cmluZyB0aGUgbmV4dCB0dXJuIG9mCiAgICAgIC8vIHRoZSBydW5sb29wCiAgICAgIGlmICghbGl2ZVJvdXRlcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLl90b3BsZXZlbFZpZXcpIHsKICAgICAgICB2YXIgb3duZXIgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHRoaXMpOwogICAgICAgIHZhciBPdXRsZXRWaWV3ID0gb3duZXIuZmFjdG9yeUZvcigndmlldzotb3V0bGV0Jyk7CiAgICAgICAgdGhpcy5fdG9wbGV2ZWxWaWV3ID0gT3V0bGV0Vmlldy5jcmVhdGUoKTsKICAgICAgICB0aGlzLl90b3BsZXZlbFZpZXcuc2V0T3V0bGV0U3RhdGUobGl2ZVJvdXRlcyk7CiAgICAgICAgdmFyIGluc3RhbmNlID0gb3duZXIubG9va3VwKCctYXBwbGljYXRpb24taW5zdGFuY2U6bWFpbicpOwogICAgICAgIGluc3RhbmNlLmRpZENyZWF0ZVJvb3RWaWV3KHRoaXMuX3RvcGxldmVsVmlldyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fdG9wbGV2ZWxWaWV3LnNldE91dGxldFN0YXRlKGxpdmVSb3V0ZXMpOwogICAgICB9CiAgICB9LAogICAgd2lsbFRyYW5zaXRpb246IGZ1bmN0aW9uIChvbGRJbmZvcywgbmV3SW5mb3MsIHRyYW5zaXRpb24pIHsKICAgICAgKDAsIF9ydW5sb29wLm9uY2UpKHRoaXMsIHRoaXMudHJpZ2dlciwgJ3dpbGxUcmFuc2l0aW9uJywgdHJhbnNpdGlvbik7CgogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbmFtZXNwYWNlJykuTE9HX1RSQU5TSVRJT05TKSB7CiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZQogICAgICAgICAgY29uc29sZS5sb2coJ1ByZXBhcmluZyB0byB0cmFuc2l0aW9uIGZyb20gXCcnICsgRW1iZXJSb3V0ZXIuX3JvdXRlUGF0aChvbGRJbmZvcykgKyAnXCcgdG8gXCcnICsgRW1iZXJSb3V0ZXIuX3JvdXRlUGF0aChuZXdJbmZvcykgKyAnXCcnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBoYW5kbGVVUkw6IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgLy8gVW50aWwgd2UgaGF2ZSBhbiBlbWJlci1pZGlvbWF0aWMgd2F5IG9mIGFjY2Vzc2luZyAjaGFzaGVzLCB3ZSBuZWVkIHRvCiAgICAgIC8vIHJlbW92ZSBpdCBiZWNhdXNlIHJvdXRlci5qcyBkb2Vzbid0IGtub3cgaG93IHRvIGhhbmRsZSBpdC4KICAgICAgdmFyIF91cmwgPSB1cmwuc3BsaXQoLyMoLispPy8pWzBdOwogICAgICByZXR1cm4gdGhpcy5fZG9VUkxUcmFuc2l0aW9uKCdoYW5kbGVVUkwnLCBfdXJsKTsKICAgIH0sCiAgICBfZG9VUkxUcmFuc2l0aW9uOiBmdW5jdGlvbiAocm91dGVySnNNZXRob2QsIHVybCkgewogICAgICB2YXIgdHJhbnNpdGlvbiA9IHRoaXMuX3JvdXRlck1pY3JvbGliW3JvdXRlckpzTWV0aG9kXSh1cmwgfHwgJy8nKTsKICAgICAgZGlkQmVnaW5UcmFuc2l0aW9uKHRyYW5zaXRpb24sIHRoaXMpOwogICAgICByZXR1cm4gdHJhbnNpdGlvbjsKICAgIH0sCiAgICB0cmFuc2l0aW9uVG86IGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBpZiAoKDAsIF91dGlscy5yZXNlbWJsZXNVUkwpKGFyZ3NbMF0pKSB7CiAgICAgICAgKHRydWUgJiYgISghdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQSB0cmFuc2l0aW9uIHdhcyBhdHRlbXB0ZWQgZnJvbSBcJycgKyB0aGlzLmN1cnJlbnRSb3V0ZU5hbWUgKyAnXCcgdG8gXCcnICsgYXJnc1swXSArICdcJyBidXQgdGhlIGFwcGxpY2F0aW9uIGluc3RhbmNlIGhhcyBhbHJlYWR5IGJlZW4gZGVzdHJveWVkLicsICF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkpOwoKICAgICAgICByZXR1cm4gdGhpcy5fZG9VUkxUcmFuc2l0aW9uKCd0cmFuc2l0aW9uVG8nLCBhcmdzWzBdKTsKICAgICAgfQoKICAgICAgdmFyIF9leHRyYWN0Um91dGVBcmdzID0gKDAsIF91dGlscy5leHRyYWN0Um91dGVBcmdzKShhcmdzKSwKICAgICAgICAgIHJvdXRlTmFtZSA9IF9leHRyYWN0Um91dGVBcmdzLnJvdXRlTmFtZSwKICAgICAgICAgIG1vZGVscyA9IF9leHRyYWN0Um91dGVBcmdzLm1vZGVscywKICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gX2V4dHJhY3RSb3V0ZUFyZ3MucXVlcnlQYXJhbXM7CgogICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdBIHRyYW5zaXRpb24gd2FzIGF0dGVtcHRlZCBmcm9tIFwnJyArIHRoaXMuY3VycmVudFJvdXRlTmFtZSArICdcJyB0byBcJycgKyByb3V0ZU5hbWUgKyAnXCcgYnV0IHRoZSBhcHBsaWNhdGlvbiBpbnN0YW5jZSBoYXMgYWxyZWFkeSBiZWVuIGRlc3Ryb3llZC4nLCAhdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpKTsKCiAgICAgIHJldHVybiB0aGlzLl9kb1RyYW5zaXRpb24ocm91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zKTsKICAgIH0sCiAgICBpbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG86IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yb3V0ZXJNaWNyb2xpYjsKCiAgICAgIChfcm91dGVyTWljcm9saWIgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYikuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvLmFwcGx5KF9yb3V0ZXJNaWNyb2xpYiwgYXJndW1lbnRzKTsKCiAgICAgIHVwZGF0ZVBhdGhzKHRoaXMpOwoKICAgICAgaWYgKHRydWUpIHsKICAgICAgICB2YXIgaW5mb3MgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5jdXJyZW50SGFuZGxlckluZm9zOwogICAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbmFtZXNwYWNlJykuTE9HX1RSQU5TSVRJT05TKSB7CiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZQogICAgICAgICAgY29uc29sZS5sb2coJ0ludGVybWVkaWF0ZS10cmFuc2l0aW9uZWQgaW50byBcJycgKyBFbWJlclJvdXRlci5fcm91dGVQYXRoKGluZm9zKSArICdcJycpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnRyYW5zaXRpb25Uby5hcHBseSh0aGlzLCBhcmd1bWVudHMpLm1ldGhvZCgncmVwbGFjZScpOwogICAgfSwKICAgIGdlbmVyYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcm91dGVyTWljcm9saWIyOwoKICAgICAgdmFyIHVybCA9IChfcm91dGVyTWljcm9saWIyID0gdGhpcy5fcm91dGVyTWljcm9saWIpLmdlbmVyYXRlLmFwcGx5KF9yb3V0ZXJNaWNyb2xpYjIsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmZvcm1hdFVSTCh1cmwpOwogICAgfSwKICAgIGlzQWN0aXZlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcm91dGVyTWljcm9saWIzOwoKICAgICAgcmV0dXJuIChfcm91dGVyTWljcm9saWIzID0gdGhpcy5fcm91dGVyTWljcm9saWIpLmlzQWN0aXZlLmFwcGx5KF9yb3V0ZXJNaWNyb2xpYjMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgaXNBY3RpdmVJbnRlbnQ6IGZ1bmN0aW9uIChyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMpIHsKICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlLmlzQWN0aXZlSW50ZW50KHJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcyk7CiAgICB9LAogICAgc2VuZDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3JvdXRlck1pY3JvbGliNDsKCiAgICAgIC8qbmFtZSwgY29udGV4dCovCiAgICAgIChfcm91dGVyTWljcm9saWI0ID0gdGhpcy5fcm91dGVyTWljcm9saWIpLnRyaWdnZXIuYXBwbHkoX3JvdXRlck1pY3JvbGliNCwgYXJndW1lbnRzKTsKICAgIH0sCiAgICBoYXNSb3V0ZTogZnVuY3Rpb24gKHJvdXRlKSB7CiAgICAgIHJldHVybiB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5oYXNSb3V0ZShyb3V0ZSk7CiAgICB9LAogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuX3JvdXRlck1pY3JvbGliKSB7CiAgICAgICAgdGhpcy5fcm91dGVyTWljcm9saWIucmVzZXQoKTsKICAgICAgfQogICAgfSwKICAgIHdpbGxEZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl90b3BsZXZlbFZpZXcpIHsKICAgICAgICB0aGlzLl90b3BsZXZlbFZpZXcuZGVzdHJveSgpOwogICAgICAgIHRoaXMuX3RvcGxldmVsVmlldyA9IG51bGw7CiAgICAgIH0KCiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICB0aGlzLnJlc2V0KCk7CgogICAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5fZW5naW5lSW5zdGFuY2VzOwogICAgICBmb3IgKHZhciBuYW1lIGluIGluc3RhbmNlcykgewogICAgICAgIGZvciAodmFyIGlkIGluIGluc3RhbmNlc1tuYW1lXSkgewogICAgICAgICAgKDAsIF9ydW5sb29wLnJ1bikoaW5zdGFuY2VzW25hbWVdW2lkXSwgJ2Rlc3Ryb3knKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBfYWN0aXZlUVBDaGFuZ2VkOiBmdW5jdGlvbiAocXVlcnlQYXJhbWV0ZXJOYW1lLCBuZXdWYWx1ZSkgewogICAgICB0aGlzLl9xdWV1ZWRRUENoYW5nZXNbcXVlcnlQYXJhbWV0ZXJOYW1lXSA9IG5ld1ZhbHVlOwogICAgICAoMCwgX3J1bmxvb3Aub25jZSkodGhpcywgdGhpcy5fZmlyZVF1ZXJ5UGFyYW1UcmFuc2l0aW9uKTsKICAgIH0sCiAgICBfdXBkYXRpbmdRUENoYW5nZWQ6IGZ1bmN0aW9uIChxdWVyeVBhcmFtZXRlck5hbWUpIHsKICAgICAgaWYgKCF0aGlzLl9xcFVwZGF0ZXMpIHsKICAgICAgICB0aGlzLl9xcFVwZGF0ZXMgPSB7fTsKICAgICAgfQogICAgICB0aGlzLl9xcFVwZGF0ZXNbcXVlcnlQYXJhbWV0ZXJOYW1lXSA9IHRydWU7CiAgICB9LAogICAgX2ZpcmVRdWVyeVBhcmFtVHJhbnNpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnRyYW5zaXRpb25Ubyh7IHF1ZXJ5UGFyYW1zOiB0aGlzLl9xdWV1ZWRRUENoYW5nZXMgfSk7CiAgICAgIHRoaXMuX3Jlc2V0UXVldWVkUXVlcnlQYXJhbWV0ZXJDaGFuZ2VzKCk7CiAgICB9LAogICAgX3NldHVwTG9jYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxvY2F0aW9uID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2xvY2F0aW9uJyk7CiAgICAgIHZhciByb290VVJMID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3Jvb3RVUkwnKTsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKCiAgICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIGxvY2F0aW9uICYmIG93bmVyKSB7CiAgICAgICAgdmFyIHJlc29sdmVkTG9jYXRpb24gPSBvd25lci5sb29rdXAoJ2xvY2F0aW9uOicgKyBsb2NhdGlvbik7CgogICAgICAgIGlmIChyZXNvbHZlZExvY2F0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGxvY2F0aW9uID0gKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywgJ2xvY2F0aW9uJywgcmVzb2x2ZWRMb2NhdGlvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEFsbG93IGZvciBkZXByZWNhdGVkIHJlZ2lzdHJhdGlvbiBvZiBjdXN0b20gbG9jYXRpb24gQVBJJ3MKICAgICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogbG9jYXRpb24KICAgICAgICAgIH07CgogICAgICAgICAgbG9jYXRpb24gPSAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCAnbG9jYXRpb24nLCBfYXBpLmRlZmF1bHQuY3JlYXRlKG9wdGlvbnMpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChsb2NhdGlvbiAhPT0gbnVsbCAmJiB0eXBlb2YgbG9jYXRpb24gPT09ICdvYmplY3QnKSB7CiAgICAgICAgaWYgKHJvb3RVUkwpIHsKICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKGxvY2F0aW9uLCAncm9vdFVSTCcsIHJvb3RVUkwpOwogICAgICAgIH0KCiAgICAgICAgLy8gQWxsb3cgdGhlIGxvY2F0aW9uIHRvIGRvIGFueSBmZWF0dXJlIGRldGVjdGlvbiwgc3VjaCBhcyBBdXRvTG9jYXRpb24KICAgICAgICAvLyBkZXRlY3RpbmcgaGlzdG9yeSBzdXBwb3J0LiBUaGlzIGdpdmVzIGl0IGEgY2hhbmNlIHRvIHNldCBpdHMKICAgICAgICAvLyBgY2FuY2VsUm91dGVyU2V0dXBgIHByb3BlcnR5IHdoaWNoIGFib3J0cyByb3V0aW5nLgogICAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24uZGV0ZWN0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2NhdGlvbi5kZXRlY3QoKTsKICAgICAgICB9CgogICAgICAgIC8vIGVuc3VyZSB0aGF0IGluaXRTdGF0ZSBpcyBjYWxsZWQgQUZURVIgdGhlIHJvb3RVUkwgaXMgc2V0IG9uCiAgICAgICAgLy8gdGhlIGxvY2F0aW9uIGluc3RhbmNlCiAgICAgICAgaWYgKHR5cGVvZiBsb2NhdGlvbi5pbml0U3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvY2F0aW9uLmluaXRTdGF0ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIF9nZXRIYW5kbGVyRnVuY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgc2VlbiA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikodGhpcyk7CgogICAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICB2YXIgcm91dGVOYW1lID0gbmFtZTsKICAgICAgICB2YXIgcm91dGVPd25lciA9IG93bmVyOwogICAgICAgIHZhciBlbmdpbmVJbmZvID0gX3RoaXMyLl9lbmdpbmVJbmZvQnlSb3V0ZVtyb3V0ZU5hbWVdOwoKICAgICAgICBpZiAoZW5naW5lSW5mbykgewogICAgICAgICAgdmFyIGVuZ2luZUluc3RhbmNlID0gX3RoaXMyLl9nZXRFbmdpbmVJbnN0YW5jZShlbmdpbmVJbmZvKTsKCiAgICAgICAgICByb3V0ZU93bmVyID0gZW5naW5lSW5zdGFuY2U7CiAgICAgICAgICByb3V0ZU5hbWUgPSBlbmdpbmVJbmZvLmxvY2FsRnVsbE5hbWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgZnVsbFJvdXRlTmFtZSA9ICdyb3V0ZTonICsgcm91dGVOYW1lOwoKICAgICAgICB2YXIgaGFuZGxlciA9IHJvdXRlT3duZXIubG9va3VwKGZ1bGxSb3V0ZU5hbWUpOwoKICAgICAgICBpZiAoc2VlbltuYW1lXSkgewogICAgICAgICAgcmV0dXJuIGhhbmRsZXI7CiAgICAgICAgfQoKICAgICAgICBzZWVuW25hbWVdID0gdHJ1ZTsKCiAgICAgICAgaWYgKCFoYW5kbGVyKSB7CiAgICAgICAgICB2YXIgRGVmYXVsdFJvdXRlID0gcm91dGVPd25lci5mYWN0b3J5Rm9yKCdyb3V0ZTpiYXNpYycpLmNsYXNzOwogICAgICAgICAgcm91dGVPd25lci5yZWdpc3RlcihmdWxsUm91dGVOYW1lLCBEZWZhdWx0Um91dGUuZXh0ZW5kKCkpOwogICAgICAgICAgaGFuZGxlciA9IHJvdXRlT3duZXIubG9va3VwKGZ1bGxSb3V0ZU5hbWUpOwoKICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwuZ2V0KShfdGhpczIsICduYW1lc3BhY2UuTE9HX0FDVElWRV9HRU5FUkFUSU9OJykpIHsKICAgICAgICAgICAgICAoMCwgX2RlYnVnLmluZm8pKCdnZW5lcmF0ZWQgLT4gJyArIGZ1bGxSb3V0ZU5hbWUsIHsgZnVsbE5hbWU6IGZ1bGxSb3V0ZU5hbWUgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGhhbmRsZXIuX3NldFJvdXRlTmFtZShyb3V0ZU5hbWUpOwoKICAgICAgICBpZiAoZW5naW5lSW5mbyAmJiAhKDAsIF9yb3V0ZS5oYXNEZWZhdWx0U2VyaWFsaXplKShoYW5kbGVyKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEZWZpbmluZyBhIGN1c3RvbSBzZXJpYWxpemUgbWV0aG9kIG9uIGFuIEVuZ2luZSByb3V0ZSBpcyBub3Qgc3VwcG9ydGVkLicpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGhhbmRsZXI7CiAgICAgIH07CiAgICB9LAogICAgX2dldFNlcmlhbGl6ZXJGdW5jdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHJldHVybiBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciBlbmdpbmVJbmZvID0gX3RoaXMzLl9lbmdpbmVJbmZvQnlSb3V0ZVtuYW1lXTsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgYW4gRW5naW5lIHJvdXRlLCB3ZSBmYWxsIGJhY2sgdG8gdGhlIGhhbmRsZXIgZm9yIHNlcmlhbGl6YXRpb24KICAgICAgICBpZiAoIWVuZ2luZUluZm8pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlbmdpbmVJbmZvLnNlcmlhbGl6ZU1ldGhvZCB8fCBfcm91dGUuZGVmYXVsdFNlcmlhbGl6ZTsKICAgICAgfTsKICAgIH0sCiAgICBfc2V0dXBSb3V0ZXI6IGZ1bmN0aW9uIChsb2NhdGlvbikgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIHZhciBsYXN0VVJMID0gdm9pZCAwOwogICAgICB2YXIgcm91dGVyTWljcm9saWIgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYjsKCiAgICAgIHJvdXRlck1pY3JvbGliLmdldEhhbmRsZXIgPSB0aGlzLl9nZXRIYW5kbGVyRnVuY3Rpb24oKTsKICAgICAgcm91dGVyTWljcm9saWIuZ2V0U2VyaWFsaXplciA9IHRoaXMuX2dldFNlcmlhbGl6ZXJGdW5jdGlvbigpOwoKICAgICAgdmFyIGRvVXBkYXRlVVJMID0gZnVuY3Rpb24gKCkgewogICAgICAgIGxvY2F0aW9uLnNldFVSTChsYXN0VVJMKTsKICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KShfdGhpczQsICdjdXJyZW50VVJMJywgbGFzdFVSTCk7CiAgICAgIH07CgogICAgICByb3V0ZXJNaWNyb2xpYi51cGRhdGVVUkwgPSBmdW5jdGlvbiAocGF0aCkgewogICAgICAgIGxhc3RVUkwgPSBwYXRoOwogICAgICAgICgwLCBfcnVubG9vcC5vbmNlKShkb1VwZGF0ZVVSTCk7CiAgICAgIH07CgogICAgICBpZiAobG9jYXRpb24ucmVwbGFjZVVSTCkgewogICAgICAgIHZhciBkb1JlcGxhY2VVUkwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2NhdGlvbi5yZXBsYWNlVVJMKGxhc3RVUkwpOwogICAgICAgICAgKDAsIF9lbWJlck1ldGFsLnNldCkoX3RoaXM0LCAnY3VycmVudFVSTCcsIGxhc3RVUkwpOwogICAgICAgIH07CgogICAgICAgIHJvdXRlck1pY3JvbGliLnJlcGxhY2VVUkwgPSBmdW5jdGlvbiAocGF0aCkgewogICAgICAgICAgbGFzdFVSTCA9IHBhdGg7CiAgICAgICAgICAoMCwgX3J1bmxvb3Aub25jZSkoZG9SZXBsYWNlVVJMKTsKICAgICAgICB9OwogICAgICB9CgogICAgICByb3V0ZXJNaWNyb2xpYi5kaWRUcmFuc2l0aW9uID0gZnVuY3Rpb24gKGluZm9zKSB7CiAgICAgICAgX3RoaXM0LmRpZFRyYW5zaXRpb24oaW5mb3MpOwogICAgICB9OwoKICAgICAgcm91dGVyTWljcm9saWIud2lsbFRyYW5zaXRpb24gPSBmdW5jdGlvbiAob2xkSW5mb3MsIG5ld0luZm9zLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgX3RoaXM0LndpbGxUcmFuc2l0aW9uKG9sZEluZm9zLCBuZXdJbmZvcywgdHJhbnNpdGlvbik7CiAgICAgIH07CiAgICB9LAogICAgX3NlcmlhbGl6ZVF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiAoaGFuZGxlckluZm9zLCBxdWVyeVBhcmFtcykgewogICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgIGZvckVhY2hRdWVyeVBhcmFtKHRoaXMsIGhhbmRsZXJJbmZvcywgcXVlcnlQYXJhbXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlLCBxcCkgewogICAgICAgIGlmIChxcCkgewogICAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgICBxdWVyeVBhcmFtc1txcC51cmxLZXldID0gcXAucm91dGUuc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgcXAudXJsS2V5LCBxcC50eXBlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybjsgLy8gV2UgZG9uJ3Qgc2VyaWFsaXplIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVlcnlQYXJhbXNba2V5XSA9IF90aGlzNS5fc2VyaWFsaXplUXVlcnlQYXJhbSh2YWx1ZSwgKDAsIF9lbWJlclJ1bnRpbWUudHlwZU9mKSh2YWx1ZSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgX3NlcmlhbGl6ZVF1ZXJ5UGFyYW06IGZ1bmN0aW9uICh2YWx1ZSwgdHlwZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgfQoKICAgICAgcmV0dXJuICcnICsgdmFsdWU7CiAgICB9LAogICAgX2Rlc2VyaWFsaXplUXVlcnlQYXJhbXM6IGZ1bmN0aW9uIChoYW5kbGVySW5mb3MsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIGZvckVhY2hRdWVyeVBhcmFtKHRoaXMsIGhhbmRsZXJJbmZvcywgcXVlcnlQYXJhbXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlLCBxcCkgewogICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgUVAgbWV0YSBpbmZvIGZvciBhIGdpdmVuIGtleSwgdGhlbiB3ZSBkbyBub3RoaW5nCiAgICAgICAgLy8gYmVjYXVzZSBhbGwgdmFsdWVzIHdpbGwgYmUgdHJlYXRlZCBhcyBzdHJpbmdzCiAgICAgICAgaWYgKHFwKSB7CiAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIHF1ZXJ5UGFyYW1zW3FwLnByb3BdID0gcXAucm91dGUuZGVzZXJpYWxpemVRdWVyeVBhcmFtKHZhbHVlLCBxcC51cmxLZXksIHFwLnR5cGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgX2Rlc2VyaWFsaXplUXVlcnlQYXJhbTogZnVuY3Rpb24gKHZhbHVlLCBkZWZhdWx0VHlwZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSBlbHNlIGlmIChkZWZhdWx0VHlwZSA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSAndHJ1ZSc7CiAgICAgIH0gZWxzZSBpZiAoZGVmYXVsdFR5cGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZSkudmFsdWVPZigpOwogICAgICB9IGVsc2UgaWYgKGRlZmF1bHRUeXBlID09PSAnYXJyYXknKSB7CiAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJSdW50aW1lLkEpKEpTT04ucGFyc2UodmFsdWUpKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgX3BydW5lRGVmYXVsdFF1ZXJ5UGFyYW1WYWx1ZXM6IGZ1bmN0aW9uIChoYW5kbGVySW5mb3MsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciBxcHMgPSB0aGlzLl9xdWVyeVBhcmFtc0ZvcihoYW5kbGVySW5mb3MpOwogICAgICBmb3IgKHZhciBrZXkgaW4gcXVlcnlQYXJhbXMpIHsKICAgICAgICB2YXIgcXAgPSBxcHMubWFwW2tleV07CiAgICAgICAgaWYgKHFwICYmIHFwLnNlcmlhbGl6ZWREZWZhdWx0VmFsdWUgPT09IHF1ZXJ5UGFyYW1zW2tleV0pIHsKICAgICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIF9kb1RyYW5zaXRpb246IGZ1bmN0aW9uIChfdGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIF9xdWVyeVBhcmFtcywgX2tlZXBEZWZhdWx0UXVlcnlQYXJhbVZhbHVlcykgewogICAgICB2YXIgX3JvdXRlck1pY3JvbGliNTsKCiAgICAgIHZhciB0YXJnZXRSb3V0ZU5hbWUgPSBfdGFyZ2V0Um91dGVOYW1lIHx8ICgwLCBfdXRpbHMuZ2V0QWN0aXZlVGFyZ2V0TmFtZSkodGhpcy5fcm91dGVyTWljcm9saWIpOwogICAgICAodHJ1ZSAmJiAhKHRhcmdldFJvdXRlTmFtZSAmJiB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5oYXNSb3V0ZSh0YXJnZXRSb3V0ZU5hbWUpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSByb3V0ZSAnICsgdGFyZ2V0Um91dGVOYW1lICsgJyB3YXMgbm90IGZvdW5kJywgdGFyZ2V0Um91dGVOYW1lICYmIHRoaXMuX3JvdXRlck1pY3JvbGliLmhhc1JvdXRlKHRhcmdldFJvdXRlTmFtZSkpKTsKCgogICAgICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKCiAgICAgIHRoaXMuX3Byb2Nlc3NBY3RpdmVUcmFuc2l0aW9uUXVlcnlQYXJhbXModGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCBfcXVlcnlQYXJhbXMpOwoKICAgICAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShxdWVyeVBhcmFtcywgX3F1ZXJ5UGFyYW1zKTsKICAgICAgdGhpcy5fcHJlcGFyZVF1ZXJ5UGFyYW1zKHRhcmdldFJvdXRlTmFtZSwgbW9kZWxzLCBxdWVyeVBhcmFtcywgX2tlZXBEZWZhdWx0UXVlcnlQYXJhbVZhbHVlcyk7CgogICAgICB2YXIgdHJhbnNpdGlvbiA9IChfcm91dGVyTWljcm9saWI1ID0gdGhpcy5fcm91dGVyTWljcm9saWIpLnRyYW5zaXRpb25Uby5hcHBseShfcm91dGVyTWljcm9saWI1LCBbdGFyZ2V0Um91dGVOYW1lXS5jb25jYXQobW9kZWxzLCBbeyBxdWVyeVBhcmFtczogcXVlcnlQYXJhbXMgfV0pKTsKCiAgICAgIGRpZEJlZ2luVHJhbnNpdGlvbih0cmFuc2l0aW9uLCB0aGlzKTsKCiAgICAgIHJldHVybiB0cmFuc2l0aW9uOwogICAgfSwKICAgIF9wcm9jZXNzQWN0aXZlVHJhbnNpdGlvblF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiAodGFyZ2V0Um91dGVOYW1lLCBtb2RlbHMsIHF1ZXJ5UGFyYW1zLCBfcXVlcnlQYXJhbXMpIHsKICAgICAgLy8gbWVyZ2UgaW4gYW55IHF1ZXJ5UGFyYW1zIGZyb20gdGhlIGFjdGl2ZSB0cmFuc2l0aW9uIHdoaWNoIGNvdWxkIGluY2x1ZGUKICAgICAgLy8gcXVlcnlQYXJhbXMgZnJvbSB0aGUgdXJsIG9uIGluaXRpYWwgbG9hZC4KICAgICAgaWYgKCF0aGlzLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdW5jaGFuZ2VkUVBzID0ge307CiAgICAgIHZhciBxcFVwZGF0ZXMgPSB0aGlzLl9xcFVwZGF0ZXMgfHwge307CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uLnF1ZXJ5UGFyYW1zOwogICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFxcFVwZGF0ZXNba2V5XSkgewogICAgICAgICAgdW5jaGFuZ2VkUVBzW2tleV0gPSBwYXJhbXNba2V5XTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFdlIG5lZWQgdG8gZnVsbHkgc2NvcGUgcXVlcnlQYXJhbXMgc28gdGhhdCB3ZSBjYW4gY3JlYXRlIG9uZSBvYmplY3QKICAgICAgLy8gdGhhdCByZXByZXNlbnRzIGJvdGggcGFzc2VkLWluIHF1ZXJ5UGFyYW1zIGFuZCBvbmVzIHRoYXQgYXJlbid0IGNoYW5nZWQKICAgICAgLy8gZnJvbSB0aGUgYWN0aXZlIHRyYW5zaXRpb24uCiAgICAgIHRoaXMuX2Z1bGx5U2NvcGVRdWVyeVBhcmFtcyh0YXJnZXRSb3V0ZU5hbWUsIG1vZGVscywgX3F1ZXJ5UGFyYW1zKTsKICAgICAgdGhpcy5fZnVsbHlTY29wZVF1ZXJ5UGFyYW1zKHRhcmdldFJvdXRlTmFtZSwgbW9kZWxzLCB1bmNoYW5nZWRRUHMpOwogICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHF1ZXJ5UGFyYW1zLCB1bmNoYW5nZWRRUHMpOwogICAgfSwKICAgIF9wcmVwYXJlUXVlcnlQYXJhbXM6IGZ1bmN0aW9uICh0YXJnZXRSb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIF9mcm9tUm91dGVyU2VydmljZSkgewogICAgICB2YXIgc3RhdGUgPSBjYWxjdWxhdGVQb3N0VHJhbnNpdGlvblN0YXRlKHRoaXMsIHRhcmdldFJvdXRlTmFtZSwgbW9kZWxzKTsKICAgICAgdGhpcy5faHlkcmF0ZVVuc3VwcGxpZWRRdWVyeVBhcmFtcyhzdGF0ZSwgcXVlcnlQYXJhbXMsIF9mcm9tUm91dGVyU2VydmljZSk7CiAgICAgIHRoaXMuX3NlcmlhbGl6ZVF1ZXJ5UGFyYW1zKHN0YXRlLmhhbmRsZXJJbmZvcywgcXVlcnlQYXJhbXMpOwoKICAgICAgaWYgKCFfZnJvbVJvdXRlclNlcnZpY2UpIHsKICAgICAgICB0aGlzLl9wcnVuZURlZmF1bHRRdWVyeVBhcmFtVmFsdWVzKHN0YXRlLmhhbmRsZXJJbmZvcywgcXVlcnlQYXJhbXMpOwogICAgICB9CiAgICB9LAogICAgX2dldFFQTWV0YTogZnVuY3Rpb24gKGhhbmRsZXJJbmZvKSB7CiAgICAgIHZhciByb3V0ZSA9IGhhbmRsZXJJbmZvLmhhbmRsZXI7CiAgICAgIHJldHVybiByb3V0ZSAmJiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShyb3V0ZSwgJ19xcCcpOwogICAgfSwKICAgIF9xdWVyeVBhcmFtc0ZvcjogZnVuY3Rpb24gKGhhbmRsZXJJbmZvcykgewogICAgICB2YXIgaGFuZGxlckluZm9MZW5ndGggPSBoYW5kbGVySW5mb3MubGVuZ3RoOwogICAgICB2YXIgbGVhZlJvdXRlTmFtZSA9IGhhbmRsZXJJbmZvc1toYW5kbGVySW5mb0xlbmd0aCAtIDFdLm5hbWU7CiAgICAgIHZhciBjYWNoZWQgPSB0aGlzLl9xcENhY2hlW2xlYWZSb3V0ZU5hbWVdOwogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgfQoKICAgICAgdmFyIHNob3VsZENhY2hlID0gdHJ1ZTsKICAgICAgdmFyIHFwc0J5VXJsS2V5ID0ge307CiAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgdmFyIHFwcyA9IFtdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVySW5mb0xlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHFwTWV0YSA9IHRoaXMuX2dldFFQTWV0YShoYW5kbGVySW5mb3NbaV0pOwoKICAgICAgICBpZiAoIXFwTWV0YSkgewogICAgICAgICAgc2hvdWxkQ2FjaGUgPSBmYWxzZTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gTG9vcCBvdmVyIGVhY2ggUVAgdG8gbWFrZSBzdXJlIHdlIGRvbid0IGhhdmUgYW55IGNvbGxpc2lvbnMgYnkgdXJsS2V5CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHFwTWV0YS5xcHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICB2YXIgcXAgPSBxcE1ldGEucXBzW19pXTsKICAgICAgICAgIHZhciB1cmxLZXkgPSBxcC51cmxLZXk7CiAgICAgICAgICB2YXIgcXBPdGhlciA9IHFwc0J5VXJsS2V5W3VybEtleV07CgogICAgICAgICAgaWYgKHFwT3RoZXIgJiYgcXBPdGhlci5jb250cm9sbGVyTmFtZSAhPT0gcXAuY29udHJvbGxlck5hbWUpIHsKICAgICAgICAgICAgdmFyIG90aGVyUVAgPSBxcHNCeVVybEtleVt1cmxLZXldOwogICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdVwncmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBtb3JlIHRoYW4gb25lIGNvbnRyb2xsZXIgcHJvcGVydHkgbWFwIHRvIHRoZSBzYW1lIHF1ZXJ5IHBhcmFtIGtleSwgYnV0IGJvdGggYCcgKyBvdGhlclFQLnNjb3BlZFByb3BlcnR5TmFtZSArICdgIGFuZCBgJyArIHFwLnNjb3BlZFByb3BlcnR5TmFtZSArICdgIG1hcCB0byBgJyArIHVybEtleSArICdgLiBZb3UgY2FuIGZpeCB0aGlzIGJ5IG1hcHBpbmcgb25lIG9mIHRoZSBjb250cm9sbGVyIHByb3BlcnRpZXMgdG8gYSBkaWZmZXJlbnQgcXVlcnkgcGFyYW0ga2V5IHZpYSB0aGUgYGFzYCBjb25maWcgb3B0aW9uLCBlLmcuIGAnICsgb3RoZXJRUC5wcm9wICsgJzogeyBhczogXCdvdGhlci0nICsgb3RoZXJRUC5wcm9wICsgJ1wnIH1gJywgZmFsc2UpKTsKICAgICAgICAgIH0KCiAgICAgICAgICBxcHNCeVVybEtleVt1cmxLZXldID0gcXA7CiAgICAgICAgICBxcHMucHVzaChxcCk7CiAgICAgICAgfQoKICAgICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKG1hcCwgcXBNZXRhLm1hcCk7CiAgICAgIH0KCiAgICAgIHZhciBmaW5hbFFQTWV0YSA9IHsgcXBzOiBxcHMsIG1hcDogbWFwIH07CgogICAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgICB0aGlzLl9xcENhY2hlW2xlYWZSb3V0ZU5hbWVdID0gZmluYWxRUE1ldGE7CiAgICAgIH0KCiAgICAgIHJldHVybiBmaW5hbFFQTWV0YTsKICAgIH0sCiAgICBfZnVsbHlTY29wZVF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiAobGVhZlJvdXRlTmFtZSwgY29udGV4dHMsIHF1ZXJ5UGFyYW1zKSB7CiAgICAgIHZhciBzdGF0ZSA9IGNhbGN1bGF0ZVBvc3RUcmFuc2l0aW9uU3RhdGUodGhpcywgbGVhZlJvdXRlTmFtZSwgY29udGV4dHMpOwogICAgICB2YXIgaGFuZGxlckluZm9zID0gc3RhdGUuaGFuZGxlckluZm9zOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBxcE1ldGEgPSB0aGlzLl9nZXRRUE1ldGEoaGFuZGxlckluZm9zW2ldKTsKCiAgICAgICAgaWYgKCFxcE1ldGEpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaiA9IDAsIHFwTGVuID0gcXBNZXRhLnFwcy5sZW5ndGg7IGogPCBxcExlbjsgKytqKSB7CiAgICAgICAgICB2YXIgcXAgPSBxcE1ldGEucXBzW2pdOwoKICAgICAgICAgIHZhciBwcmVzZW50UHJvcCA9IHFwLnByb3AgaW4gcXVlcnlQYXJhbXMgJiYgcXAucHJvcCB8fCBxcC5zY29wZWRQcm9wZXJ0eU5hbWUgaW4gcXVlcnlQYXJhbXMgJiYgcXAuc2NvcGVkUHJvcGVydHlOYW1lIHx8IHFwLnVybEtleSBpbiBxdWVyeVBhcmFtcyAmJiBxcC51cmxLZXk7CgogICAgICAgICAgaWYgKHByZXNlbnRQcm9wKSB7CiAgICAgICAgICAgIGlmIChwcmVzZW50UHJvcCAhPT0gcXAuc2NvcGVkUHJvcGVydHlOYW1lKSB7CiAgICAgICAgICAgICAgcXVlcnlQYXJhbXNbcXAuc2NvcGVkUHJvcGVydHlOYW1lXSA9IHF1ZXJ5UGFyYW1zW3ByZXNlbnRQcm9wXTsKICAgICAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNbcHJlc2VudFByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgX2h5ZHJhdGVVbnN1cHBsaWVkUXVlcnlQYXJhbXM6IGZ1bmN0aW9uIChzdGF0ZSwgcXVlcnlQYXJhbXMsIF9mcm9tUm91dGVyU2VydmljZSkgewogICAgICB2YXIgaGFuZGxlckluZm9zID0gc3RhdGUuaGFuZGxlckluZm9zOwogICAgICB2YXIgYXBwQ2FjaGUgPSB0aGlzLl9idWNrZXRDYWNoZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlckluZm9zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHFwTWV0YSA9IHRoaXMuX2dldFFQTWV0YShoYW5kbGVySW5mb3NbaV0pOwoKICAgICAgICBpZiAoIXFwTWV0YSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBqID0gMCwgcXBMZW4gPSBxcE1ldGEucXBzLmxlbmd0aDsgaiA8IHFwTGVuOyArK2opIHsKICAgICAgICAgIHZhciBxcCA9IHFwTWV0YS5xcHNbal07CgogICAgICAgICAgdmFyIHByZXNlbnRQcm9wID0gcXAucHJvcCBpbiBxdWVyeVBhcmFtcyAmJiBxcC5wcm9wIHx8IHFwLnNjb3BlZFByb3BlcnR5TmFtZSBpbiBxdWVyeVBhcmFtcyAmJiBxcC5zY29wZWRQcm9wZXJ0eU5hbWUgfHwgcXAudXJsS2V5IGluIHF1ZXJ5UGFyYW1zICYmIHFwLnVybEtleTsKCiAgICAgICAgICAodHJ1ZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHFwLnVybEtleSA9PT0gcHJlc2VudFByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKF9mcm9tUm91dGVyU2VydmljZSAmJiBwcmVzZW50UHJvcCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBwYXNzZWQgdGhlIGAnICsgcHJlc2VudFByb3AgKyAnYCBxdWVyeSBwYXJhbWV0ZXIgZHVyaW5nIGEgdHJhbnNpdGlvbiBpbnRvICcgKyBxcC5yb3V0ZS5yb3V0ZU5hbWUgKyAnLCBwbGVhc2UgdXBkYXRlIHRvICcgKyBxcC51cmxLZXksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHFwLnVybEtleSA9PT0gcHJlc2VudFByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfWlmIChfZnJvbVJvdXRlclNlcnZpY2UgJiYgcHJlc2VudFByb3AgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9cmV0dXJuIHRydWU7CiAgICAgICAgICB9KCkpKTsKCgogICAgICAgICAgaWYgKHByZXNlbnRQcm9wKSB7CiAgICAgICAgICAgIGlmIChwcmVzZW50UHJvcCAhPT0gcXAuc2NvcGVkUHJvcGVydHlOYW1lKSB7CiAgICAgICAgICAgICAgcXVlcnlQYXJhbXNbcXAuc2NvcGVkUHJvcGVydHlOYW1lXSA9IHF1ZXJ5UGFyYW1zW3ByZXNlbnRQcm9wXTsKICAgICAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNbcHJlc2VudFByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgY2FjaGVLZXkgPSAoMCwgX3V0aWxzLmNhbGN1bGF0ZUNhY2hlS2V5KShxcC5yb3V0ZS5mdWxsUm91dGVOYW1lLCBxcC5wYXJ0cywgc3RhdGUucGFyYW1zKTsKICAgICAgICAgICAgcXVlcnlQYXJhbXNbcXAuc2NvcGVkUHJvcGVydHlOYW1lXSA9IGFwcENhY2hlLmxvb2t1cChjYWNoZUtleSwgcXAucHJvcCwgcXAuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBfc2NoZWR1bGVMb2FkaW5nRXZlbnQ6IGZ1bmN0aW9uICh0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSkgewogICAgICB0aGlzLl9jYW5jZWxTbG93VHJhbnNpdGlvblRpbWVyKCk7CiAgICAgIHRoaXMuX3Nsb3dUcmFuc2l0aW9uVGltZXIgPSAoMCwgX3J1bmxvb3Auc2NoZWR1bGVPbmNlKSgncm91dGVyVHJhbnNpdGlvbnMnLCB0aGlzLCAnX2hhbmRsZVNsb3dUcmFuc2l0aW9uJywgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogICAgfSwKCgogICAgY3VycmVudFN0YXRlOiBudWxsLAogICAgdGFyZ2V0U3RhdGU6IG51bGwsCgogICAgX2hhbmRsZVNsb3dUcmFuc2l0aW9uOiBmdW5jdGlvbiAodHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpIHsKICAgICAgaWYgKCF0aGlzLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgICAgLy8gRG9uJ3QgZmlyZSBhbiBldmVudCBpZiB3ZSd2ZSBzaW5jZSBtb3ZlZCBvbiBmcm9tCiAgICAgICAgLy8gdGhlIHRyYW5zaXRpb24gdGhhdCBwdXQgdXMgaW4gYSBsb2FkaW5nIHN0YXRlLgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGFyZ2V0U3RhdGUgPSBuZXcgX3JvdXRlcl9zdGF0ZS5kZWZhdWx0KHRoaXMsIHRoaXMuX3JvdXRlck1pY3JvbGliLCB0aGlzLl9yb3V0ZXJNaWNyb2xpYi5hY3RpdmVUcmFuc2l0aW9uLnN0YXRlKTsKICAgICAgdGhpcy5zZXQoJ3RhcmdldFN0YXRlJywgdGFyZ2V0U3RhdGUpOwoKICAgICAgdHJhbnNpdGlvbi50cmlnZ2VyKHRydWUsICdsb2FkaW5nJywgdHJhbnNpdGlvbiwgb3JpZ2luUm91dGUpOwogICAgfSwKICAgIF9jYW5jZWxTbG93VHJhbnNpdGlvblRpbWVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLl9zbG93VHJhbnNpdGlvblRpbWVyKSB7CiAgICAgICAgKDAsIF9ydW5sb29wLmNhbmNlbCkodGhpcy5fc2xvd1RyYW5zaXRpb25UaW1lcik7CiAgICAgIH0KICAgICAgdGhpcy5fc2xvd1RyYW5zaXRpb25UaW1lciA9IG51bGw7CiAgICB9LAogICAgX21hcmtFcnJvckFzSGFuZGxlZDogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIHRoaXMuX2hhbmRsZWRFcnJvcnMuYWRkKGVycm9yKTsKICAgIH0sCiAgICBfaXNFcnJvckhhbmRsZWQ6IGZ1bmN0aW9uIChlcnJvcikgewogICAgICByZXR1cm4gdGhpcy5faGFuZGxlZEVycm9ycy5oYXMoZXJyb3IpOwogICAgfSwKICAgIF9jbGVhckhhbmRsZWRFcnJvcjogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIHRoaXMuX2hhbmRsZWRFcnJvcnMuZGVsZXRlKGVycm9yKTsKICAgIH0sCiAgICBfZ2V0RW5naW5lSW5zdGFuY2U6IGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgIHZhciBuYW1lID0gX3JlZi5uYW1lLAogICAgICAgICAgaW5zdGFuY2VJZCA9IF9yZWYuaW5zdGFuY2VJZCwKICAgICAgICAgIG1vdW50UG9pbnQgPSBfcmVmLm1vdW50UG9pbnQ7CgogICAgICB2YXIgZW5naW5lSW5zdGFuY2VzID0gdGhpcy5fZW5naW5lSW5zdGFuY2VzOwoKICAgICAgaWYgKCFlbmdpbmVJbnN0YW5jZXNbbmFtZV0pIHsKICAgICAgICBlbmdpbmVJbnN0YW5jZXNbbmFtZV0gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB9CgogICAgICB2YXIgZW5naW5lSW5zdGFuY2UgPSBlbmdpbmVJbnN0YW5jZXNbbmFtZV1baW5zdGFuY2VJZF07CgogICAgICBpZiAoIWVuZ2luZUluc3RhbmNlKSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKCiAgICAgICAgKHRydWUgJiYgIShvd25lci5oYXNSZWdpc3RyYXRpb24oJ2VuZ2luZTonICsgbmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byBtb3VudCB0aGUgZW5naW5lIFwnJyArIG5hbWUgKyAnXCcgaW4geW91ciByb3V0ZXIgbWFwLCBidXQgdGhlIGVuZ2luZSBjYW4gbm90IGJlIGZvdW5kLicsIG93bmVyLmhhc1JlZ2lzdHJhdGlvbignZW5naW5lOicgKyBuYW1lKSkpOwoKCiAgICAgICAgZW5naW5lSW5zdGFuY2UgPSBvd25lci5idWlsZENoaWxkRW5naW5lSW5zdGFuY2UobmFtZSwgewogICAgICAgICAgcm91dGFibGU6IHRydWUsCiAgICAgICAgICBtb3VudFBvaW50OiBtb3VudFBvaW50CiAgICAgICAgfSk7CgogICAgICAgIGVuZ2luZUluc3RhbmNlLmJvb3QoKTsKCiAgICAgICAgZW5naW5lSW5zdGFuY2VzW25hbWVdW2luc3RhbmNlSWRdID0gZW5naW5lSW5zdGFuY2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBlbmdpbmVJbnN0YW5jZTsKICAgIH0KICB9KTsKCiAgLyoKICAgIEhlbHBlciBmdW5jdGlvbiBmb3IgaXRlcmF0aW5nIG92ZXIgcm91dGVzIGluIGEgc2V0IG9mIGhhbmRsZXJJbmZvcyB0aGF0IGFyZQogICAgYXQgb3IgYWJvdmUgdGhlIGdpdmVuIG9yaWdpbiByb3V0ZS4gRXhhbXBsZTogaWYgYG9yaWdpblJvdXRlYCA9PT0gJ2Zvby5iYXInCiAgICBhbmQgdGhlIGhhbmRsZXJJbmZvcyBnaXZlbiB3ZXJlIGZvciAnZm9vLmJhci5iYXonLCB0aGVuIHRoZSBnaXZlbiBjYWxsYmFjawogICAgd2lsbCBiZSBpbnZva2VkIHdpdGggdGhlIHJvdXRlcyBmb3IgJ2Zvby5iYXInLCAnZm9vJywgYW5kICdhcHBsaWNhdGlvbicKICAgIGluZGl2aWR1YWxseS4KICAKICAgIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGFueXRoaW5nIG90aGVyIHRoYW4gYHRydWVgLCB0aGVuIGl0ZXJhdGlvbiB3aWxsIHN0b3AuCiAgCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtSb3V0ZX0gb3JpZ2luUm91dGUKICAgIEBwYXJhbSB7QXJyYXk8SGFuZGxlckluZm8+fSBoYW5kbGVySW5mb3MKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICBAcmV0dXJuIHtWb2lkfQogICAqLwogIGZ1bmN0aW9uIGZvckVhY2hSb3V0ZUFib3ZlKGhhbmRsZXJJbmZvcywgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIGkgPSBoYW5kbGVySW5mb3MubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgdmFyIGhhbmRsZXJJbmZvID0gaGFuZGxlckluZm9zW2ldOwogICAgICB2YXIgcm91dGUgPSBoYW5kbGVySW5mby5oYW5kbGVyOwoKICAgICAgLy8gaGFuZGxlckluZm8uaGFuZGxlciBiZWluZyBgdW5kZWZpbmVkYCBnZW5lcmFsbHkgbWVhbnMgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAxLiBhbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgY3JlYXRpb24gb2YgdGhlIHJvdXRlIGluIHF1ZXN0aW9uCiAgICAgIC8vIDIuIHRoZSByb3V0ZSBpcyBhY3Jvc3MgYW4gYXN5bmMgYm91bmRhcnkgKGUuZy4gd2l0aGluIGFuIGVuZ2luZSkKICAgICAgLy8KICAgICAgLy8gSW4gYm90aCBvZiB0aGVzZSBjYXNlcywgd2UgY2Fubm90IGludm9rZSB0aGUgY2FsbGJhY2sgb24gdGhhdCBzcGVjaWZpYwogICAgICAvLyByb3V0ZSwgYmVjYXVzZSBpdCBqdXN0IGRvZXNuJ3QgZXhpc3QuLi4KICAgICAgaWYgKHJvdXRlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgaWYgKGNhbGxiYWNrKHJvdXRlLCBoYW5kbGVySW5mbykgIT09IHRydWUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFRoZXNlIGdldCBpbnZva2VkIHdoZW4gYW4gYWN0aW9uIGJ1YmJsZXMgYWJvdmUgQXBwbGljYXRpb25Sb3V0ZQogIC8vIGFuZCBhcmUgbm90IG1lYW50IHRvIGJlIG92ZXJyaWRhYmxlLgogIHZhciBkZWZhdWx0QWN0aW9uSGFuZGxlcnMgPSB7CiAgICB3aWxsUmVzb2x2ZU1vZGVsOiBmdW5jdGlvbiAoaGFuZGxlckluZm9zLCB0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSkgewogICAgICB0aGlzLl9zY2hlZHVsZUxvYWRpbmdFdmVudCh0cmFuc2l0aW9uLCBvcmlnaW5Sb3V0ZSk7CiAgICB9LAogICAgZXJyb3I6IGZ1bmN0aW9uIChoYW5kbGVySW5mb3MsIGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwoKICAgICAgdmFyIGhhbmRsZXJJbmZvV2l0aEVycm9yID0gaGFuZGxlckluZm9zW2hhbmRsZXJJbmZvcy5sZW5ndGggLSAxXTsKCiAgICAgIGZvckVhY2hSb3V0ZUFib3ZlKGhhbmRsZXJJbmZvcywgZnVuY3Rpb24gKHJvdXRlLCBoYW5kbGVySW5mbykgewogICAgICAgIC8vIFdlIGRvbid0IGNoZWNrIHRoZSBsZWFmIG1vc3QgaGFuZGxlckluZm8gc2luY2UgdGhhdCB3b3VsZAogICAgICAgIC8vIHRlY2huaWNhbGx5IGJlIGJlbG93IHdoZXJlIHdlJ3JlIGF0IGluIHRoZSByb3V0ZSBoaWVyYXJjaHkuCiAgICAgICAgaWYgKGhhbmRsZXJJbmZvICE9PSBoYW5kbGVySW5mb1dpdGhFcnJvcikgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIHRoZSBleGlzdGVuY2Ugb2YgYW4gJ2Vycm9yJyByb3V0ZS4KICAgICAgICAgIHZhciBlcnJvclJvdXRlTmFtZSA9IGZpbmRSb3V0ZVN0YXRlTmFtZShyb3V0ZSwgJ2Vycm9yJyk7CiAgICAgICAgICBpZiAoZXJyb3JSb3V0ZU5hbWUpIHsKICAgICAgICAgICAgcm91dGVyLl9tYXJrRXJyb3JBc0hhbmRsZWQoZXJyb3IpOwogICAgICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGVycm9yUm91dGVOYW1lLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIENoZWNrIGZvciBhbiAnZXJyb3InIHN1YnN0YXRlIHJvdXRlCiAgICAgICAgdmFyIGVycm9yU3Vic3RhdGVOYW1lID0gZmluZFJvdXRlU3Vic3RhdGVOYW1lKHJvdXRlLCAnZXJyb3InKTsKICAgICAgICBpZiAoZXJyb3JTdWJzdGF0ZU5hbWUpIHsKICAgICAgICAgIHJvdXRlci5fbWFya0Vycm9yQXNIYW5kbGVkKGVycm9yKTsKICAgICAgICAgIHJvdXRlci5pbnRlcm1lZGlhdGVUcmFuc2l0aW9uVG8oZXJyb3JTdWJzdGF0ZU5hbWUsIGVycm9yKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKCiAgICAgIGxvZ0Vycm9yKGVycm9yLCAnRXJyb3Igd2hpbGUgcHJvY2Vzc2luZyByb3V0ZTogJyArIHRyYW5zaXRpb24udGFyZ2V0TmFtZSk7CiAgICB9LAogICAgbG9hZGluZzogZnVuY3Rpb24gKGhhbmRsZXJJbmZvcywgdHJhbnNpdGlvbikgewogICAgICB2YXIgcm91dGVyID0gdGhpczsKCiAgICAgIHZhciBoYW5kbGVySW5mb1dpdGhTbG93TG9hZGluZyA9IGhhbmRsZXJJbmZvc1toYW5kbGVySW5mb3MubGVuZ3RoIC0gMV07CgogICAgICBmb3JFYWNoUm91dGVBYm92ZShoYW5kbGVySW5mb3MsIGZ1bmN0aW9uIChyb3V0ZSwgaGFuZGxlckluZm8pIHsKICAgICAgICAvLyBXZSBkb24ndCBjaGVjayB0aGUgbGVhZiBtb3N0IGhhbmRsZXJJbmZvIHNpbmNlIHRoYXQgd291bGQKICAgICAgICAvLyB0ZWNobmljYWxseSBiZSBiZWxvdyB3aGVyZSB3ZSdyZSBhdCBpbiB0aGUgcm91dGUgaGllcmFyY2h5LgogICAgICAgIGlmIChoYW5kbGVySW5mbyAhPT0gaGFuZGxlckluZm9XaXRoU2xvd0xvYWRpbmcpIHsKICAgICAgICAgIC8vIENoZWNrIGZvciB0aGUgZXhpc3RlbmNlIG9mIGEgJ2xvYWRpbmcnIHJvdXRlLgogICAgICAgICAgdmFyIGxvYWRpbmdSb3V0ZU5hbWUgPSBmaW5kUm91dGVTdGF0ZU5hbWUocm91dGUsICdsb2FkaW5nJyk7CiAgICAgICAgICBpZiAobG9hZGluZ1JvdXRlTmFtZSkgewogICAgICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGxvYWRpbmdSb3V0ZU5hbWUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDaGVjayBmb3IgbG9hZGluZyBzdWJzdGF0ZQogICAgICAgIHZhciBsb2FkaW5nU3Vic3RhdGVOYW1lID0gZmluZFJvdXRlU3Vic3RhdGVOYW1lKHJvdXRlLCAnbG9hZGluZycpOwogICAgICAgIGlmIChsb2FkaW5nU3Vic3RhdGVOYW1lKSB7CiAgICAgICAgICByb3V0ZXIuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKGxvYWRpbmdTdWJzdGF0ZU5hbWUpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gRG9uJ3QgYnViYmxlIGFib3ZlIHBpdm90IHJvdXRlLgogICAgICAgIHJldHVybiB0cmFuc2l0aW9uLnBpdm90SGFuZGxlciAhPT0gcm91dGU7CiAgICAgIH0pOwogICAgfQogIH07CgogIGZ1bmN0aW9uIGxvZ0Vycm9yKF9lcnJvciwgaW5pdGlhbE1lc3NhZ2UpIHsKICAgIHZhciBfY29uc29sZTsKCiAgICB2YXIgZXJyb3JBcmdzID0gW107CiAgICB2YXIgZXJyb3IgPSB2b2lkIDA7CiAgICBpZiAoX2Vycm9yICYmIHR5cGVvZiBfZXJyb3IgPT09ICdvYmplY3QnICYmIHR5cGVvZiBfZXJyb3IuZXJyb3JUaHJvd24gPT09ICdvYmplY3QnKSB7CiAgICAgIGVycm9yID0gX2Vycm9yLmVycm9yVGhyb3duOwogICAgfSBlbHNlIHsKICAgICAgZXJyb3IgPSBfZXJyb3I7CiAgICB9CgogICAgaWYgKGluaXRpYWxNZXNzYWdlKSB7CiAgICAgIGVycm9yQXJncy5wdXNoKGluaXRpYWxNZXNzYWdlKTsKICAgIH0KCiAgICBpZiAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIHsKICAgICAgICBlcnJvckFyZ3MucHVzaChlcnJvci5tZXNzYWdlKTsKICAgICAgfQogICAgICBpZiAoZXJyb3Iuc3RhY2spIHsKICAgICAgICBlcnJvckFyZ3MucHVzaChlcnJvci5zdGFjayk7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZXJyb3JBcmdzLnB1c2goZXJyb3IpOwogICAgICB9CiAgICB9CgogICAgKF9jb25zb2xlID0gY29uc29sZSkuZXJyb3IuYXBwbHkoX2NvbnNvbGUsIGVycm9yQXJncyk7IC8vZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlCiAgfQoKICAvKioKICAgIEZpbmRzIHRoZSBuYW1lIG9mIHRoZSBzdWJzdGF0ZSByb3V0ZSBpZiBpdCBleGlzdHMgZm9yIHRoZSBnaXZlbiByb3V0ZS4gQQogICAgc3Vic3RhdGUgcm91dGUgaXMgb2YgdGhlIGZvcm0gYHJvdXRlX3N0YXRlYCwgc3VjaCBhcyBgZm9vX2xvYWRpbmdgLgogIAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7Um91dGV9IHJvdXRlCiAgICBAcGFyYW0ge1N0cmluZ30gc3RhdGUKICAgIEByZXR1cm4ge1N0cmluZ30KICAqLwogIGZ1bmN0aW9uIGZpbmRSb3V0ZVN1YnN0YXRlTmFtZShyb3V0ZSwgc3RhdGUpIHsKICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikocm91dGUpOwogICAgdmFyIHJvdXRlTmFtZSA9IHJvdXRlLnJvdXRlTmFtZSwKICAgICAgICBmdWxsUm91dGVOYW1lID0gcm91dGUuZnVsbFJvdXRlTmFtZSwKICAgICAgICByb3V0ZXIgPSByb3V0ZS5fcm91dGVyOwoKCiAgICB2YXIgc3Vic3RhdGVOYW1lID0gcm91dGVOYW1lICsgJ18nICsgc3RhdGU7CiAgICB2YXIgc3Vic3RhdGVOYW1lRnVsbCA9IGZ1bGxSb3V0ZU5hbWUgKyAnXycgKyBzdGF0ZTsKCiAgICByZXR1cm4gcm91dGVIYXNCZWVuRGVmaW5lZChvd25lciwgcm91dGVyLCBzdWJzdGF0ZU5hbWUsIHN1YnN0YXRlTmFtZUZ1bGwpID8gc3Vic3RhdGVOYW1lRnVsbCA6ICcnOwogIH0KCiAgLyoqCiAgICBGaW5kcyB0aGUgbmFtZSBvZiB0aGUgc3RhdGUgcm91dGUgaWYgaXQgZXhpc3RzIGZvciB0aGUgZ2l2ZW4gcm91dGUuIEEgc3RhdGUKICAgIHJvdXRlIGlzIG9mIHRoZSBmb3JtIGByb3V0ZS5zdGF0ZWAsIHN1Y2ggYXMgYGZvby5sb2FkaW5nYC4gUHJvcGVybHkgSGFuZGxlcwogICAgYGFwcGxpY2F0aW9uYCBuYW1lZCByb3V0ZXMuCiAgCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtSb3V0ZX0gcm91dGUKICAgIEBwYXJhbSB7U3RyaW5nfSBzdGF0ZQogICAgQHJldHVybiB7U3RyaW5nfQogICovCiAgZnVuY3Rpb24gZmluZFJvdXRlU3RhdGVOYW1lKHJvdXRlLCBzdGF0ZSkgewogICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKShyb3V0ZSk7CiAgICB2YXIgcm91dGVOYW1lID0gcm91dGUucm91dGVOYW1lLAogICAgICAgIGZ1bGxSb3V0ZU5hbWUgPSByb3V0ZS5mdWxsUm91dGVOYW1lLAogICAgICAgIHJvdXRlciA9IHJvdXRlLl9yb3V0ZXI7CgoKICAgIHZhciBzdGF0ZU5hbWUgPSByb3V0ZU5hbWUgPT09ICdhcHBsaWNhdGlvbicgPyBzdGF0ZSA6IHJvdXRlTmFtZSArICcuJyArIHN0YXRlOwogICAgdmFyIHN0YXRlTmFtZUZ1bGwgPSBmdWxsUm91dGVOYW1lID09PSAnYXBwbGljYXRpb24nID8gc3RhdGUgOiBmdWxsUm91dGVOYW1lICsgJy4nICsgc3RhdGU7CgogICAgcmV0dXJuIHJvdXRlSGFzQmVlbkRlZmluZWQob3duZXIsIHJvdXRlciwgc3RhdGVOYW1lLCBzdGF0ZU5hbWVGdWxsKSA/IHN0YXRlTmFtZUZ1bGwgOiAnJzsKICB9CgogIC8qKgogICAgRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCBhIHJvdXRlIGhhcyBiZWVuIGRlZmluZWQgYnkgY2hlY2tpbmcgdGhhdCB0aGUgcm91dGUKICAgIGlzIGluIHRoZSBSb3V0ZXIncyBtYXAgYW5kIHRoZSBvd25lciBoYXMgYSByZWdpc3RyYXRpb24gZm9yIHRoYXQgcm91dGUuCiAgCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPd25lcn0gb3duZXIKICAgIEBwYXJhbSB7Um91dGVyfSByb3V0ZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBsb2NhbE5hbWUKICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgQHJldHVybiB7Qm9vbGVhbn0KICAqLwogIGZ1bmN0aW9uIHJvdXRlSGFzQmVlbkRlZmluZWQob3duZXIsIHJvdXRlciwgbG9jYWxOYW1lLCBmdWxsTmFtZSkgewogICAgdmFyIHJvdXRlckhhc1JvdXRlID0gcm91dGVyLmhhc1JvdXRlKGZ1bGxOYW1lKTsKICAgIHZhciBvd25lckhhc1JvdXRlID0gb3duZXIuaGFzUmVnaXN0cmF0aW9uKCd0ZW1wbGF0ZTonICsgbG9jYWxOYW1lKSB8fCBvd25lci5oYXNSZWdpc3RyYXRpb24oJ3JvdXRlOicgKyBsb2NhbE5hbWUpOwogICAgcmV0dXJuIHJvdXRlckhhc1JvdXRlICYmIG93bmVySGFzUm91dGU7CiAgfQoKICBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoaGFuZGxlckluZm9zLCBpZ25vcmVGYWlsdXJlLCBhcmdzKSB7CiAgICB2YXIgbmFtZSA9IGFyZ3Muc2hpZnQoKTsKCiAgICBpZiAoIWhhbmRsZXJJbmZvcykgewogICAgICBpZiAoaWdub3JlRmFpbHVyZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aHJvdyBuZXcgX2Vycm9yMi5kZWZhdWx0KCdDYW5cJ3QgdHJpZ2dlciBhY3Rpb24gXCcnICsgbmFtZSArICdcJyBiZWNhdXNlIHlvdXIgYXBwIGhhc25cJ3QgZmluaXNoZWQgdHJhbnNpdGlvbmluZyBpbnRvIGl0cyBmaXJzdCByb3V0ZS4gVG8gdHJpZ2dlciBhbiBhY3Rpb24gb24gZGVzdGluYXRpb24gcm91dGVzIGR1cmluZyBhIHRyYW5zaXRpb24sIHlvdSBjYW4gY2FsbCBgLnNlbmQoKWAgb24gdGhlIGBUcmFuc2l0aW9uYCBvYmplY3QgcGFzc2VkIHRvIHRoZSBgbW9kZWwvYmVmb3JlTW9kZWwvYWZ0ZXJNb2RlbGAgaG9va3MuJyk7CiAgICB9CgogICAgdmFyIGV2ZW50V2FzSGFuZGxlZCA9IGZhbHNlOwogICAgdmFyIGhhbmRsZXJJbmZvID0gdm9pZCAwLAogICAgICAgIGhhbmRsZXIgPSB2b2lkIDAsCiAgICAgICAgYWN0aW9uSGFuZGxlciA9IHZvaWQgMDsKCiAgICBmb3IgKHZhciBpID0gaGFuZGxlckluZm9zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGhhbmRsZXJJbmZvID0gaGFuZGxlckluZm9zW2ldOwogICAgICBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlcjsKICAgICAgYWN0aW9uSGFuZGxlciA9IGhhbmRsZXIgJiYgaGFuZGxlci5hY3Rpb25zICYmIGhhbmRsZXIuYWN0aW9uc1tuYW1lXTsKICAgICAgaWYgKGFjdGlvbkhhbmRsZXIpIHsKICAgICAgICBpZiAoYWN0aW9uSGFuZGxlci5hcHBseShoYW5kbGVyLCBhcmdzKSA9PT0gdHJ1ZSkgewogICAgICAgICAgZXZlbnRXYXNIYW5kbGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gU2hvdWxkIG9ubHkgaGl0IGhlcmUgaWYgYSBub24tYnViYmxpbmcgZXJyb3IgYWN0aW9uIGlzIHRyaWdnZXJlZCBvbiBhIHJvdXRlLgogICAgICAgICAgaWYgKG5hbWUgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgaGFuZGxlci5fcm91dGVyLl9tYXJrRXJyb3JBc0hhbmRsZWQoYXJnc1swXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGRlZmF1bHRIYW5kbGVyID0gZGVmYXVsdEFjdGlvbkhhbmRsZXJzW25hbWVdOwogICAgaWYgKGRlZmF1bHRIYW5kbGVyKSB7CiAgICAgIGRlZmF1bHRIYW5kbGVyLmFwcGx5KHRoaXMsIFtoYW5kbGVySW5mb3NdLmNvbmNhdChhcmdzKSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoIWV2ZW50V2FzSGFuZGxlZCAmJiAhaWdub3JlRmFpbHVyZSkgewogICAgICB0aHJvdyBuZXcgX2Vycm9yMi5kZWZhdWx0KCdOb3RoaW5nIGhhbmRsZWQgdGhlIGFjdGlvbiBcJycgKyBuYW1lICsgJ1wnLiBJZiB5b3UgZGlkIGhhbmRsZSB0aGUgYWN0aW9uLCB0aGlzIGVycm9yIGNhbiBiZSBjYXVzZWQgYnkgcmV0dXJuaW5nIHRydWUgZnJvbSBhbiBhY3Rpb24gaGFuZGxlciBpbiBhIGNvbnRyb2xsZXIsIGNhdXNpbmcgdGhlIGFjdGlvbiB0byBidWJibGUuJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVQb3N0VHJhbnNpdGlvblN0YXRlKGVtYmVyUm91dGVyLCBsZWFmUm91dGVOYW1lLCBjb250ZXh0cykgewogICAgdmFyIHN0YXRlID0gZW1iZXJSb3V0ZXIuX3JvdXRlck1pY3JvbGliLmFwcGx5SW50ZW50KGxlYWZSb3V0ZU5hbWUsIGNvbnRleHRzKTsKICAgIHZhciBoYW5kbGVySW5mb3MgPSBzdGF0ZS5oYW5kbGVySW5mb3MsCiAgICAgICAgcGFyYW1zID0gc3RhdGUucGFyYW1zOwoKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJJbmZvcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV07CgogICAgICAvLyBJZiB0aGUgaGFuZGxlckluZm8gaXMgbm90IHJlc29sdmVkLCB3ZSBzZXJpYWxpemUgdGhlIGNvbnRleHQgaW50byBwYXJhbXMKICAgICAgaWYgKCFoYW5kbGVySW5mby5pc1Jlc29sdmVkKSB7CiAgICAgICAgcGFyYW1zW2hhbmRsZXJJbmZvLm5hbWVdID0gaGFuZGxlckluZm8uc2VyaWFsaXplKGhhbmRsZXJJbmZvLmNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmFtc1toYW5kbGVySW5mby5uYW1lXSA9IGhhbmRsZXJJbmZvLnBhcmFtczsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN0YXRlOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlUGF0aHMocm91dGVyKSB7CiAgICB2YXIgaW5mb3MgPSByb3V0ZXIuX3JvdXRlck1pY3JvbGliLmN1cnJlbnRIYW5kbGVySW5mb3M7CiAgICBpZiAoaW5mb3MubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgcGF0aCA9IEVtYmVyUm91dGVyLl9yb3V0ZVBhdGgoaW5mb3MpOwogICAgdmFyIGN1cnJlbnRSb3V0ZU5hbWUgPSBpbmZvc1tpbmZvcy5sZW5ndGggLSAxXS5uYW1lOwogICAgdmFyIGN1cnJlbnRVUkwgPSByb3V0ZXIuZ2V0KCdsb2NhdGlvbicpLmdldFVSTCgpOwoKICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHJvdXRlciwgJ2N1cnJlbnRQYXRoJywgcGF0aCk7CiAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KShyb3V0ZXIsICdjdXJyZW50Um91dGVOYW1lJywgY3VycmVudFJvdXRlTmFtZSk7CiAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KShyb3V0ZXIsICdjdXJyZW50VVJMJywgY3VycmVudFVSTCk7CgogICAgdmFyIGFwcENvbnRyb2xsZXIgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHJvdXRlcikubG9va3VwKCdjb250cm9sbGVyOmFwcGxpY2F0aW9uJyk7CgogICAgaWYgKCFhcHBDb250cm9sbGVyKSB7CiAgICAgIC8vIGFwcENvbnRyb2xsZXIgbWlnaHQgbm90IGV4aXN0IHdoZW4gdG9wLWxldmVsIGxvYWRpbmcvZXJyb3IKICAgICAgLy8gc3Vic3RhdGVzIGhhdmUgYmVlbiBlbnRlcmVkIHNpbmNlIEFwcGxpY2F0aW9uUm91dGUgaGFzbid0CiAgICAgIC8vIGFjdHVhbGx5IGJlZW4gZW50ZXJlZCBhdCB0aGF0IHBvaW50LgogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKCEoJ2N1cnJlbnRQYXRoJyBpbiBhcHBDb250cm9sbGVyKSkgewogICAgICAoMCwgX2VtYmVyTWV0YWwuZGVmaW5lUHJvcGVydHkpKGFwcENvbnRyb2xsZXIsICdjdXJyZW50UGF0aCcpOwogICAgfQoKICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKGFwcENvbnRyb2xsZXIsICdjdXJyZW50UGF0aCcsIHBhdGgpOwoKICAgIGlmICghKCdjdXJyZW50Um91dGVOYW1lJyBpbiBhcHBDb250cm9sbGVyKSkgewogICAgICAoMCwgX2VtYmVyTWV0YWwuZGVmaW5lUHJvcGVydHkpKGFwcENvbnRyb2xsZXIsICdjdXJyZW50Um91dGVOYW1lJyk7CiAgICB9CgogICAgKDAsIF9lbWJlck1ldGFsLnNldCkoYXBwQ29udHJvbGxlciwgJ2N1cnJlbnRSb3V0ZU5hbWUnLCBjdXJyZW50Um91dGVOYW1lKTsKICB9CgogIEVtYmVyUm91dGVyLnJlb3BlbkNsYXNzKHsKICAgIG1hcDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIGlmICghdGhpcy5kc2xDYWxsYmFja3MpIHsKICAgICAgICB0aGlzLmRzbENhbGxiYWNrcyA9IFtdOwogICAgICAgIHRoaXMucmVvcGVuQ2xhc3MoeyBkc2xDYWxsYmFja3M6IHRoaXMuZHNsQ2FsbGJhY2tzIH0pOwogICAgICB9CgogICAgICB0aGlzLmRzbENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIF9yb3V0ZVBhdGg6IGZ1bmN0aW9uIChoYW5kbGVySW5mb3MpIHsKICAgICAgdmFyIHBhdGggPSBbXTsKCiAgICAgIC8vIFdlIGhhdmUgdG8gaGFuZGxlIGNvYWxlc2NpbmcgcmVzb3VyY2UgbmFtZXMgdGhhdAogICAgICAvLyBhcmUgcHJlZml4ZWQgd2l0aCB0aGVpciBwYXJlbnQncyBuYW1lcywgZS5nLgogICAgICAvLyBbJ2ZvbycsICdmb28uYmFyLmJheiddID0+ICdmb28uYmFyLmJheicsIG5vdCAnZm9vLmZvby5iYXIuYmF6JwoKICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0aW9uTWF0Y2hlcyhhMSwgYTIpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGExLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBpZiAoYTFbaV0gIT09IGEyW2ldKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHZhciBuYW1lID0gdm9pZCAwLAogICAgICAgICAgbmFtZVBhcnRzID0gdm9pZCAwLAogICAgICAgICAgb2xkTmFtZVBhcnRzID0gdm9pZCAwOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkrKykgewogICAgICAgIG5hbWUgPSBoYW5kbGVySW5mb3NbaV0ubmFtZTsKICAgICAgICBuYW1lUGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgb2xkTmFtZVBhcnRzID0gc2xpY2UuY2FsbChwYXRoKTsKCiAgICAgICAgd2hpbGUgKG9sZE5hbWVQYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgIGlmIChpbnRlcnNlY3Rpb25NYXRjaGVzKG9sZE5hbWVQYXJ0cywgbmFtZVBhcnRzKSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIG9sZE5hbWVQYXJ0cy5zaGlmdCgpOwogICAgICAgIH0KCiAgICAgICAgcGF0aC5wdXNoLmFwcGx5KHBhdGgsIG5hbWVQYXJ0cy5zbGljZShvbGROYW1lUGFydHMubGVuZ3RoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXRoLmpvaW4oJy4nKTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gZGlkQmVnaW5UcmFuc2l0aW9uKHRyYW5zaXRpb24sIHJvdXRlcikgewogICAgdmFyIHJvdXRlclN0YXRlID0gbmV3IF9yb3V0ZXJfc3RhdGUuZGVmYXVsdChyb3V0ZXIsIHJvdXRlci5fcm91dGVyTWljcm9saWIsIHRyYW5zaXRpb24uc3RhdGUpOwoKICAgIGlmICghcm91dGVyLmN1cnJlbnRTdGF0ZSkgewogICAgICByb3V0ZXIuc2V0KCdjdXJyZW50U3RhdGUnLCByb3V0ZXJTdGF0ZSk7CiAgICB9CiAgICByb3V0ZXIuc2V0KCd0YXJnZXRTdGF0ZScsIHJvdXRlclN0YXRlKTsKCiAgICB0cmFuc2l0aW9uLnByb21pc2UgPSB0cmFuc2l0aW9uLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICBpZiAocm91dGVyLl9pc0Vycm9ySGFuZGxlZChlcnJvcikpIHsKICAgICAgICByb3V0ZXIuX2NsZWFySGFuZGxlZEVycm9yKGVycm9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBmb3JFYWNoUXVlcnlQYXJhbShyb3V0ZXIsIGhhbmRsZXJJbmZvcywgcXVlcnlQYXJhbXMsIGNhbGxiYWNrKSB7CiAgICB2YXIgcXBDYWNoZSA9IHJvdXRlci5fcXVlcnlQYXJhbXNGb3IoaGFuZGxlckluZm9zKTsKCiAgICBmb3IgKHZhciBrZXkgaW4gcXVlcnlQYXJhbXMpIHsKICAgICAgaWYgKCFxdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgdmFyIHZhbHVlID0gcXVlcnlQYXJhbXNba2V5XTsKICAgICAgdmFyIHFwID0gcXBDYWNoZS5tYXBba2V5XTsKCiAgICAgIGNhbGxiYWNrKGtleSwgdmFsdWUsIHFwKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpbmRMaXZlUm91dGUobGl2ZVJvdXRlcywgbmFtZSkgewogICAgaWYgKCFsaXZlUm91dGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzdGFjayA9IFtsaXZlUm91dGVzXTsKICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgIHZhciB0ZXN0ID0gc3RhY2suc2hpZnQoKTsKICAgICAgaWYgKHRlc3QucmVuZGVyLm5hbWUgPT09IG5hbWUpIHsKICAgICAgICByZXR1cm4gdGVzdDsKICAgICAgfQogICAgICB2YXIgb3V0bGV0cyA9IHRlc3Qub3V0bGV0czsKICAgICAgZm9yICh2YXIgb3V0bGV0TmFtZSBpbiBvdXRsZXRzKSB7CiAgICAgICAgc3RhY2sucHVzaChvdXRsZXRzW291dGxldE5hbWVdKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gYXBwZW5kTGl2ZVJvdXRlKGxpdmVSb3V0ZXMsIGRlZmF1bHRQYXJlbnRTdGF0ZSwgcmVuZGVyT3B0aW9ucykgewogICAgdmFyIHRhcmdldCA9IHZvaWQgMDsKICAgIHZhciBteVN0YXRlID0gewogICAgICByZW5kZXI6IHJlbmRlck9wdGlvbnMsCiAgICAgIG91dGxldHM6IE9iamVjdC5jcmVhdGUobnVsbCksCiAgICAgIHdhc1VzZWQ6IGZhbHNlCiAgICB9OwogICAgaWYgKHJlbmRlck9wdGlvbnMuaW50bykgewogICAgICB0YXJnZXQgPSBmaW5kTGl2ZVJvdXRlKGxpdmVSb3V0ZXMsIHJlbmRlck9wdGlvbnMuaW50byk7CiAgICB9IGVsc2UgewogICAgICB0YXJnZXQgPSBkZWZhdWx0UGFyZW50U3RhdGU7CiAgICB9CiAgICBpZiAodGFyZ2V0KSB7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5zZXQpKHRhcmdldC5vdXRsZXRzLCByZW5kZXJPcHRpb25zLm91dGxldCwgbXlTdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5PUlBIQU5fT1VUTEVUX1JFTkRFUiAmJiByZW5kZXJPcHRpb25zLmludG8pIHsKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1JlbmRlcmluZyBpbnRvIGEge3tyZW5kZXJ9fSBoZWxwZXIgdGhhdCByZXNvbHZlcyB0byBhbiB7e291dGxldH19IGlzIGRlcHJlY2F0ZWQuJywgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItcm91dGluZy50b3AtbGV2ZWwtcmVuZGVyLWhlbHBlcicsCiAgICAgICAgICB1bnRpbDogJzMuMC4wJywKICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YyLngvI3RvY19yZW5kZXJpbmctaW50by1hLXJlbmRlci1oZWxwZXItdGhhdC1yZXNvbHZlcy10by1hbi1vdXRsZXQnCiAgICAgICAgfSkpOwoKCiAgICAgICAgLy8gTWVnYWhheCB0aW1lLiBQb3N0LTMuMC1icmVha2luZy1jaGFuZ2VzLCB3ZSB3aWxsIGp1c3QgYXNzZXJ0CiAgICAgICAgLy8gcmlnaHQgaGVyZSB0aGF0IHRoZSB1c2VyIHRyaWVkIHRvIHRhcmdldCBhIG5vbmV4aXN0ZW50CiAgICAgICAgLy8gdGhpbmcuIEJ1dCBmb3Igbm93IHdlIHN0aWxsIG5lZWQgdG8gc3VwcG9ydCB0aGUgYHJlbmRlcmAKICAgICAgICAvLyBoZWxwZXIsIGFuZCBwZW9wbGUgYXJlIGFsbG93ZWQgdG8gdGFyZ2V0IHRlbXBsYXRlcyByZW5kZXJlZAogICAgICAgIC8vIGJ5IHRoZSByZW5kZXIgaGVscGVyLiBTbyBpbnN0ZWFkIHdlIGRlZmVyIGRvaW5nIGFueXRpbmcgd2l0aAogICAgICAgIC8vIHRoZXNlIG9ycGhhbiByZW5kZXJzIHVudGlsIGFmdGVyUmVuZGVyLgogICAgICAgIGlmICghbGl2ZVJvdXRlcy5vdXRsZXRzLl9fZW1iZXJfb3JwaGFuc19fKSB7CiAgICAgICAgICBsaXZlUm91dGVzLm91dGxldHMuX19lbWJlcl9vcnBoYW5zX18gPSB7CiAgICAgICAgICAgIHJlbmRlcjogewogICAgICAgICAgICAgIG5hbWU6ICdfX2VtYmVyX29ycGhhbnNfXycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3V0bGV0czogT2JqZWN0LmNyZWF0ZShudWxsKQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGxpdmVSb3V0ZXMub3V0bGV0cy5fX2VtYmVyX29ycGhhbnNfXy5vdXRsZXRzW3JlbmRlck9wdGlvbnMuaW50b10gPSBteVN0YXRlOwogICAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2FmdGVyUmVuZGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgKHRydWUgJiYgIShsaXZlUm91dGVzLm91dGxldHMuX19lbWJlcl9vcnBoYW5zX18ub3V0bGV0c1tyZW5kZXJPcHRpb25zLmludG9dLndhc1VzZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGF0dGVtcHRlZCB0byByZW5kZXIgaW50byBcJycgKyByZW5kZXJPcHRpb25zLmludG8gKyAnXCcgYnV0IGl0IHdhcyBub3QgZm91bmQnLCBsaXZlUm91dGVzLm91dGxldHMuX19lbWJlcl9vcnBoYW5zX18ub3V0bGV0c1tyZW5kZXJPcHRpb25zLmludG9dLndhc1VzZWQpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsaXZlUm91dGVzID0gbXlTdGF0ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgbGl2ZVJvdXRlczogbGl2ZVJvdXRlcywKICAgICAgb3duU3RhdGU6IG15U3RhdGUKICAgIH07CiAgfQoKICBmdW5jdGlvbiByZXByZXNlbnRFbXB0eVJvdXRlKGxpdmVSb3V0ZXMsIGRlZmF1bHRQYXJlbnRTdGF0ZSwgcm91dGUpIHsKICAgIC8vIHRoZSByb3V0ZSBkaWRuJ3QgcmVuZGVyIGFueXRoaW5nCiAgICB2YXIgYWxyZWFkeUFwcGVuZGVkID0gZmluZExpdmVSb3V0ZShsaXZlUm91dGVzLCByb3V0ZS5yb3V0ZU5hbWUpOwogICAgaWYgKGFscmVhZHlBcHBlbmRlZCkgewogICAgICAvLyBCdXQgc29tZSBvdGhlciByb3V0ZSBoYXMgYWxyZWFkeSByZW5kZXJlZCBvdXIgZGVmYXVsdAogICAgICAvLyB0ZW1wbGF0ZSwgc28gdGhhdCBiZWNvbWVzIHRoZSBkZWZhdWx0IHRhcmdldCBmb3IgYW55CiAgICAgIC8vIGNoaWxkcmVuIHdlIG1heSBoYXZlLgogICAgICByZXR1cm4gYWxyZWFkeUFwcGVuZGVkOwogICAgfSBlbHNlIHsKICAgICAgLy8gQ3JlYXRlIGFuIGVudHJ5IHRvIHJlcHJlc2VudCBvdXIgZGVmYXVsdCB0ZW1wbGF0ZSBuYW1lLAogICAgICAvLyBqdXN0IHNvIG90aGVyIHJvdXRlcyBjYW4gdGFyZ2V0IGl0IGFuZCBpbmhlcml0IGl0cyBwbGFjZQogICAgICAvLyBpbiB0aGUgb3V0bGV0IGhpZXJhcmNoeS4KICAgICAgZGVmYXVsdFBhcmVudFN0YXRlLm91dGxldHMubWFpbiA9IHsKICAgICAgICByZW5kZXI6IHsKICAgICAgICAgIG5hbWU6IHJvdXRlLnJvdXRlTmFtZSwKICAgICAgICAgIG91dGxldDogJ21haW4nCiAgICAgICAgfSwKICAgICAgICBvdXRsZXRzOiB7fQogICAgICB9OwogICAgICByZXR1cm4gZGVmYXVsdFBhcmVudFN0YXRlOwogICAgfQogIH0KCiAgZXhwb3J0cy5kZWZhdWx0ID0gRW1iZXJSb3V0ZXI7Cn0pOwplbmlmZWQoJ2VtYmVyLXJvdXRpbmcvbGliL3N5c3RlbS9yb3V0ZXJfc3RhdGUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnQGVtYmVyL3BvbHlmaWxscycsICdlbWJlci1yb3V0aW5nL2xpYi91dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9wb2x5ZmlsbHMsIF91dGlscykgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFJvdXRlclN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gUm91dGVyU3RhdGUoKSB7CiAgICAgIHZhciBlbWJlclJvdXRlciA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKICAgICAgdmFyIHJvdXRlckpzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwogICAgICB2YXIgcm91dGVySnNTdGF0ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBSb3V0ZXJTdGF0ZSk7CgogICAgICB0aGlzLmVtYmVyUm91dGVyID0gZW1iZXJSb3V0ZXI7CiAgICAgIHRoaXMucm91dGVySnMgPSByb3V0ZXJKczsKICAgICAgdGhpcy5yb3V0ZXJKc1N0YXRlID0gcm91dGVySnNTdGF0ZTsKICAgIH0KCiAgICBSb3V0ZXJTdGF0ZS5wcm90b3R5cGUuaXNBY3RpdmVJbnRlbnQgPSBmdW5jdGlvbiBpc0FjdGl2ZUludGVudChyb3V0ZU5hbWUsIG1vZGVscywgcXVlcnlQYXJhbXMsIHF1ZXJ5UGFyYW1zTXVzdE1hdGNoKSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMucm91dGVySnNTdGF0ZTsKICAgICAgaWYgKCF0aGlzLnJvdXRlckpzLmlzQWN0aXZlSW50ZW50KHJvdXRlTmFtZSwgbW9kZWxzLCBudWxsLCBzdGF0ZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmIChxdWVyeVBhcmFtc011c3RNYXRjaCAmJiBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykubGVuZ3RoID4gMCkgewogICAgICAgIHZhciB2aXNpYmxlUXVlcnlQYXJhbXMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBxdWVyeVBhcmFtcyk7CgogICAgICAgIHRoaXMuZW1iZXJSb3V0ZXIuX3ByZXBhcmVRdWVyeVBhcmFtcyhyb3V0ZU5hbWUsIG1vZGVscywgdmlzaWJsZVF1ZXJ5UGFyYW1zKTsKICAgICAgICByZXR1cm4gKDAsIF91dGlscy5zaGFsbG93RXF1YWwpKHZpc2libGVRdWVyeVBhcmFtcywgc3RhdGUucXVlcnlQYXJhbXMpOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgcmV0dXJuIFJvdXRlclN0YXRlOwogIH0oKTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gUm91dGVyU3RhdGU7Cn0pOwovKioKICBBIFRyYW5zaXRpb24gaXMgYSB0aGVubmFibGUgKGEgcHJvbWlzZS1saWtlIG9iamVjdCkgdGhhdCByZXByZXNlbnRzCiAgYW4gYXR0ZW1wdCB0byB0cmFuc2l0aW9uIHRvIGFub3RoZXIgcm91dGUuIEl0IGNhbiBiZSBhYm9ydGVkLCBlaXRoZXIKICBleHBsaWNpdGx5IHZpYSBgYWJvcnRgIG9yIGJ5IGF0dGVtcHRpbmcgYW5vdGhlciB0cmFuc2l0aW9uIHdoaWxlIGEKICBwcmV2aW91cyBvbmUgaXMgc3RpbGwgdW5kZXJ3YXkuIEFuIGFib3J0ZWQgdHJhbnNpdGlvbiBjYW4gYWxzbwogIGJlIGByZXRyeSgpYGQgbGF0ZXIuCgogIEBjbGFzcyBUcmFuc2l0aW9uCiAgQGNvbnN0cnVjdG9yCiAgQHBhcmFtIHtPYmplY3R9IHJvdXRlcgogIEBwYXJhbSB7T2JqZWN0fSBpbnRlbnQKICBAcGFyYW0ge09iamVjdH0gc3RhdGUKICBAcGFyYW0ge09iamVjdH0gZXJyb3IKICBAcHJpdmF0ZQoqLwoKLyoqCiAgVGhlIFRyYW5zaXRpb24ncyBpbnRlcm5hbCBwcm9taXNlLiBDYWxsaW5nIGAudGhlbmAgb24gdGhpcyBwcm9wZXJ0eQogIGlzIHRoYXQgc2FtZSBhcyBjYWxsaW5nIGAudGhlbmAgb24gdGhlIFRyYW5zaXRpb24gb2JqZWN0IGl0c2VsZiwgYnV0CiAgdGhpcyBwcm9wZXJ0eSBpcyBleHBvc2VkIGZvciB3aGVuIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEKICBUcmFuc2l0aW9uJ3MgcHJvbWlzZSwgYnV0IG5vdCB0aGUgVHJhbnNpdGlvbiBvYmplY3QgaXRzZWxmLCBzaW5jZQogIFRyYW5zaXRpb24gb2JqZWN0IGNhbiBiZSBleHRlcm5hbGx5IGBhYm9ydGBlZCwgd2hpbGUgdGhlIHByb21pc2UKICBjYW5ub3QuCgogIEBwcm9wZXJ0eSBwcm9taXNlCiAgQHR5cGUge09iamVjdH0KICBAcHVibGljCiAgKi8KCi8qKgogIEN1c3RvbSBzdGF0ZSBjYW4gYmUgc3RvcmVkIG9uIGEgVHJhbnNpdGlvbidzIGBkYXRhYCBvYmplY3QuCiAgVGhpcyBjYW4gYmUgdXNlZnVsIGZvciBkZWNvcmF0aW5nIGEgVHJhbnNpdGlvbiB3aXRoaW4gYW4gZWFybGllcgogIGhvb2sgYW5kIHNoYXJlZCB3aXRoIGEgbGF0ZXIgaG9vay4gUHJvcGVydGllcyBzZXQgb24gYGRhdGFgIHdpbGwKICBiZSBjb3BpZWQgdG8gbmV3IHRyYW5zaXRpb25zIGdlbmVyYXRlZCBieSBjYWxsaW5nIGByZXRyeWAgb24gdGhpcwogIHRyYW5zaXRpb24uCgogIEBwcm9wZXJ0eSBkYXRhCiAgQHR5cGUge09iamVjdH0KICBAcHVibGljCiovCgovKioKICBBIHN0YW5kYXJkIHByb21pc2UgaG9vayB0aGF0IHJlc29sdmVzIGlmIHRoZSB0cmFuc2l0aW9uCiAgc3VjY2VlZHMgYW5kIHJlamVjdHMgaWYgaXQgZmFpbHMvcmVkaXJlY3RzL2Fib3J0cy4KCiAgRm9yd2FyZHMgdG8gdGhlIGludGVybmFsIGBwcm9taXNlYCBwcm9wZXJ0eSB3aGljaCB5b3UgY2FuCiAgdXNlIGluIHNpdHVhdGlvbnMgd2hlcmUgeW91IHdhbnQgdG8gcGFzcyBhcm91bmQgYSB0aGVubmFibGUsCiAgYnV0IG5vdCB0aGUgVHJhbnNpdGlvbiBpdHNlbGYuCgogIEBtZXRob2QgdGhlbgogIEBwYXJhbSB7RnVuY3Rpb259IG9uRnVsZmlsbGVkCiAgQHBhcmFtIHtGdW5jdGlvbn0gb25SZWplY3RlZAogIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogIFVzZWZ1bCBmb3IgdG9vbGluZy4KICBAcmV0dXJuIHtQcm9taXNlfQogIEBwdWJsaWMKKi8KCi8qKgoKICBGb3J3YXJkcyB0byB0aGUgaW50ZXJuYWwgYHByb21pc2VgIHByb3BlcnR5IHdoaWNoIHlvdSBjYW4KICB1c2UgaW4gc2l0dWF0aW9ucyB3aGVyZSB5b3Ugd2FudCB0byBwYXNzIGFyb3VuZCBhIHRoZW5uYWJsZSwKICBidXQgbm90IHRoZSBUcmFuc2l0aW9uIGl0c2VsZi4KCiAgQG1ldGhvZCBjYXRjaAogIEBwYXJhbSB7RnVuY3Rpb259IG9uUmVqZWN0aW9uCiAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgVXNlZnVsIGZvciB0b29saW5nLgogIEByZXR1cm4ge1Byb21pc2V9CiAgQHB1YmxpYwoqLwoKLyoqCgogIEZvcndhcmRzIHRvIHRoZSBpbnRlcm5hbCBgcHJvbWlzZWAgcHJvcGVydHkgd2hpY2ggeW91IGNhbgogIHVzZSBpbiBzaXR1YXRpb25zIHdoZXJlIHlvdSB3YW50IHRvIHBhc3MgYXJvdW5kIGEgdGhlbm5hYmxlLAogIGJ1dCBub3QgdGhlIFRyYW5zaXRpb24gaXRzZWxmLgoKICBAbWV0aG9kIGZpbmFsbHkKICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGxhYmVsaW5nIHRoZSBwcm9taXNlLgogIFVzZWZ1bCBmb3IgdG9vbGluZy4KICBAcmV0dXJuIHtQcm9taXNlfQogIEBwdWJsaWMKKi8KCi8qKgogIEFib3J0cyB0aGUgVHJhbnNpdGlvbi4gTm90ZSB5b3UgY2FuIGFsc28gaW1wbGljaXRseSBhYm9ydCBhIHRyYW5zaXRpb24KICBieSBpbml0aWF0aW5nIGFub3RoZXIgdHJhbnNpdGlvbiB3aGlsZSBhIHByZXZpb3VzIG9uZSBpcyB1bmRlcndheS4KCiAgQG1ldGhvZCBhYm9ydAogIEByZXR1cm4ge1RyYW5zaXRpb259IHRoaXMgdHJhbnNpdGlvbgogIEBwdWJsaWMKKi8KCi8qKgoKICBSZXRyaWVzIGEgcHJldmlvdXNseS1hYm9ydGVkIHRyYW5zaXRpb24gKG1ha2luZyBzdXJlIHRvIGFib3J0IHRoZQogIHRyYW5zaXRpb24gaWYgaXQncyBzdGlsbCBhY3RpdmUpLiBSZXR1cm5zIGEgbmV3IHRyYW5zaXRpb24gdGhhdAogIHJlcHJlc2VudHMgdGhlIG5ldyBhdHRlbXB0IHRvIHRyYW5zaXRpb24uCgogIEBtZXRob2QgcmV0cnkKICBAcmV0dXJuIHtUcmFuc2l0aW9ufSBuZXcgdHJhbnNpdGlvbgogIEBwdWJsaWMKICAqLwoKLyoqCgogIFNldHMgdGhlIFVSTC1jaGFuZ2luZyBtZXRob2QgdG8gYmUgZW1wbG95ZWQgYXQgdGhlIGVuZCBvZiBhCiAgc3VjY2Vzc2Z1bCB0cmFuc2l0aW9uLiBCeSBkZWZhdWx0LCBhIG5ldyBUcmFuc2l0aW9uIHdpbGwganVzdAogIHVzZSBgdXBkYXRlVVJMYCwgYnV0IHBhc3NpbmcgJ3JlcGxhY2UnIHRvIHRoaXMgbWV0aG9kIHdpbGwKICBjYXVzZSB0aGUgVVJMIHRvIHVwZGF0ZSB1c2luZyAncmVwbGFjZVdpdGgnIGluc3RlYWQuIE9taXR0aW5nCiAgYSBwYXJhbWV0ZXIgd2lsbCBkaXNhYmxlIHRoZSBVUkwgY2hhbmdlLCBhbGxvd2luZyBmb3IgdHJhbnNpdGlvbnMKICB0aGF0IGRvbid0IHVwZGF0ZSB0aGUgVVJMIGF0IGNvbXBsZXRpb24gKHRoaXMgaXMgYWxzbyB1c2VkIGZvcgogIGhhbmRsZVVSTCwgc2luY2UgdGhlIFVSTCBoYXMgYWxyZWFkeSBjaGFuZ2VkIGJlZm9yZSB0aGUKICB0cmFuc2l0aW9uIHRvb2sgcGxhY2UpLgoKICBAbWV0aG9kIG1ldGhvZAogIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgdGhlIHR5cGUgb2YgVVJMLWNoYW5naW5nIG1ldGhvZCB0byB1c2UKICAgIGF0IHRoZSBlbmQgb2YgYSB0cmFuc2l0aW9uLiBBY2NlcHRlZCB2YWx1ZXMgYXJlICdyZXBsYWNlJywKICAgIGZhbHN5IHZhbHVlcywgb3IgYW55IG90aGVyIG5vbi1mYWxzeSB2YWx1ZSAod2hpY2ggaXMKICAgIGludGVycHJldGVkIGFzIGFuIHVwZGF0ZVVSTCB0cmFuc2l0aW9uKS4KCiAgQHJldHVybiB7VHJhbnNpdGlvbn0gdGhpcyB0cmFuc2l0aW9uCiAgQHB1YmxpYwoqLwoKLyoqCgogIEZpcmVzIGFuIGV2ZW50IG9uIHRoZSBjdXJyZW50IGxpc3Qgb2YgcmVzb2x2ZWQvcmVzb2x2aW5nCiAgaGFuZGxlcnMgd2l0aGluIHRoaXMgdHJhbnNpdGlvbi4gVXNlZnVsIGZvciBmaXJpbmcgZXZlbnRzCiAgb24gcm91dGUgaGllcmFyY2hpZXMgdGhhdCBoYXZlbid0IGZ1bGx5IGJlZW4gZW50ZXJlZCB5ZXQuCgogIE5vdGU6IFRoaXMgbWV0aG9kIGlzIGFsc28gYWxpYXNlZCBhcyBgc2VuZGAKCiAgQG1ldGhvZCB0cmlnZ2VyCiAgQHBhcmFtIHtCb29sZWFufSBbaWdub3JlRmFpbHVyZT1mYWxzZV0gYSBib29sZWFuIHNwZWNpZnlpbmcgd2hldGhlciB1bmhhbmRsZWQgZXZlbnRzIHRocm93IGFuIGVycm9yCiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgdGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRvIGZpcmUKICBAcHVibGljCiovCgovKioKICBUcmFuc2l0aW9ucyBhcmUgYWJvcnRlZCBhbmQgdGhlaXIgcHJvbWlzZXMgcmVqZWN0ZWQKICB3aGVuIHJlZGlyZWN0cyBvY2N1cjsgdGhpcyBtZXRob2QgcmV0dXJucyBhIHByb21pc2UKICB0aGF0IHdpbGwgZm9sbG93IGFueSByZWRpcmVjdHMgdGhhdCBvY2N1ciBhbmQgZnVsZmlsbAogIHdpdGggdGhlIHZhbHVlIGZ1bGZpbGxlZCBieSBhbnkgcmVkaXJlY3RpbmcgdHJhbnNpdGlvbnMKICB0aGF0IG9jY3VyLgoKICBAbWV0aG9kIGZvbGxvd1JlZGlyZWN0cwogIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IGZ1bGZpbGxzIHdpdGggdGhlIHNhbWUKICAgIHZhbHVlIHRoYXQgdGhlIGZpbmFsIHJlZGlyZWN0aW5nIHRyYW5zaXRpb24gZnVsZmlsbHMgd2l0aAogIEBwdWJsaWMKKi8KZW5pZmVkKCJlbWJlci1yb3V0aW5nL2xpYi9zeXN0ZW0vdHJhbnNpdGlvbiIsIFtdLCBmdW5jdGlvbiAoKSB7CiAgInVzZSBzdHJpY3QiOwp9KTsKZW5pZmVkKCdlbWJlci1yb3V0aW5nL2xpYi91dGlscycsIFsnZXhwb3J0cycsICdlbWJlci1vd25lcicsICdAZW1iZXIvcG9seWZpbGxzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9lcnJvciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyT3duZXIsIF9wb2x5ZmlsbHMsIF9lbWJlck1ldGFsLCBfZXJyb3IpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZXh0cmFjdFJvdXRlQXJncyA9IGV4dHJhY3RSb3V0ZUFyZ3M7CiAgZXhwb3J0cy5nZXRBY3RpdmVUYXJnZXROYW1lID0gZ2V0QWN0aXZlVGFyZ2V0TmFtZTsKICBleHBvcnRzLnN0YXNoUGFyYW1OYW1lcyA9IHN0YXNoUGFyYW1OYW1lczsKICBleHBvcnRzLmNhbGN1bGF0ZUNhY2hlS2V5ID0gY2FsY3VsYXRlQ2FjaGVLZXk7CiAgZXhwb3J0cy5ub3JtYWxpemVDb250cm9sbGVyUXVlcnlQYXJhbXMgPSBub3JtYWxpemVDb250cm9sbGVyUXVlcnlQYXJhbXM7CiAgZXhwb3J0cy5yZXNlbWJsZXNVUkwgPSByZXNlbWJsZXNVUkw7CiAgZXhwb3J0cy5wcmVmaXhSb3V0ZU5hbWVBcmcgPSBwcmVmaXhSb3V0ZU5hbWVBcmc7CiAgZXhwb3J0cy5zaGFsbG93RXF1YWwgPSBzaGFsbG93RXF1YWw7CgoKICB2YXIgQUxMX1BFUklPRFNfUkVHRVggPSAvXC4vZzsKCiAgZnVuY3Rpb24gZXh0cmFjdFJvdXRlQXJncyhhcmdzKSB7CiAgICBhcmdzID0gYXJncy5zbGljZSgpOwogICAgdmFyIHBvc3NpYmxlUXVlcnlQYXJhbXMgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07CgogICAgdmFyIHF1ZXJ5UGFyYW1zID0gdm9pZCAwOwogICAgaWYgKHBvc3NpYmxlUXVlcnlQYXJhbXMgJiYgcG9zc2libGVRdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgncXVlcnlQYXJhbXMnKSkgewogICAgICBxdWVyeVBhcmFtcyA9IGFyZ3MucG9wKCkucXVlcnlQYXJhbXM7CiAgICB9IGVsc2UgewogICAgICBxdWVyeVBhcmFtcyA9IHt9OwogICAgfQoKICAgIHZhciByb3V0ZU5hbWUgPSBhcmdzLnNoaWZ0KCk7CgogICAgcmV0dXJuIHsgcm91dGVOYW1lOiByb3V0ZU5hbWUsIG1vZGVsczogYXJncywgcXVlcnlQYXJhbXM6IHF1ZXJ5UGFyYW1zIH07CiAgfQoKICBmdW5jdGlvbiBnZXRBY3RpdmVUYXJnZXROYW1lKHJvdXRlcikgewogICAgdmFyIGhhbmRsZXJJbmZvcyA9IHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uID8gcm91dGVyLmFjdGl2ZVRyYW5zaXRpb24uc3RhdGUuaGFuZGxlckluZm9zIDogcm91dGVyLnN0YXRlLmhhbmRsZXJJbmZvczsKICAgIHJldHVybiBoYW5kbGVySW5mb3NbaGFuZGxlckluZm9zLmxlbmd0aCAtIDFdLm5hbWU7CiAgfQoKICBmdW5jdGlvbiBzdGFzaFBhcmFtTmFtZXMocm91dGVyLCBoYW5kbGVySW5mb3MpIHsKICAgIGlmIChoYW5kbGVySW5mb3MuX25hbWVzU3Rhc2hlZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gVGhpcyBoZWxwZXIgZXhpc3RzIGJlY2F1c2Ugcm91dGVyLmpzL3JvdXRlLXJlY29nbml6ZXIuanMgYXdrd2FyZGx5CiAgICAvLyBrZWVwcyBzZXBhcmF0ZSBhIGhhbmRsZXJJbmZvJ3MgbGlzdCBvZiBwYXJhbWV0ZXIgbmFtZXMgZGVwZW5kaW5nCiAgICAvLyBvbiB3aGV0aGVyIGEgVVJMIHRyYW5zaXRpb24gb3IgbmFtZWQgdHJhbnNpdGlvbiBpcyBoYXBwZW5pbmcuCiAgICAvLyBIb3BlZnVsbHkgd2UgY2FuIHJlbW92ZSB0aGlzIGluIHRoZSBmdXR1cmUuCiAgICB2YXIgdGFyZ2V0Um91dGVOYW1lID0gaGFuZGxlckluZm9zW2hhbmRsZXJJbmZvcy5sZW5ndGggLSAxXS5uYW1lOwogICAgdmFyIHJlY29nSGFuZGxlcnMgPSByb3V0ZXIuX3JvdXRlck1pY3JvbGliLnJlY29nbml6ZXIuaGFuZGxlcnNGb3IodGFyZ2V0Um91dGVOYW1lKTsKICAgIHZhciBkeW5hbWljUGFyZW50ID0gbnVsbDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJJbmZvcy5sZW5ndGg7ICsraSkgewogICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV07CiAgICAgIHZhciBuYW1lcyA9IHJlY29nSGFuZGxlcnNbaV0ubmFtZXM7CgogICAgICBpZiAobmFtZXMubGVuZ3RoKSB7CiAgICAgICAgZHluYW1pY1BhcmVudCA9IGhhbmRsZXJJbmZvOwogICAgICB9CgogICAgICBoYW5kbGVySW5mby5fbmFtZXMgPSBuYW1lczsKCiAgICAgIHZhciByb3V0ZSA9IGhhbmRsZXJJbmZvLmhhbmRsZXI7CiAgICAgIHJvdXRlLl9zdGFzaE5hbWVzKGhhbmRsZXJJbmZvLCBkeW5hbWljUGFyZW50KTsKICAgIH0KCiAgICBoYW5kbGVySW5mb3MuX25hbWVzU3Rhc2hlZCA9IHRydWU7CiAgfQoKICBmdW5jdGlvbiBfY2FsY3VsYXRlQ2FjaGVWYWx1ZVByZWZpeChwcmVmaXgsIHBhcnQpIHsKICAgIC8vIGNhbGN1bGF0ZXMgdGhlIGRvdCBzZXBhcmF0ZWQgc2VjdGlvbnMgZnJvbSBwcmVmaXggdGhhdCBhcmUgYWxzbwogICAgLy8gYXQgdGhlIHN0YXJ0IG9mIHBhcnQgLSB3aGljaCBnaXZlcyB1cyB0aGUgcm91dGUgbmFtZQoKICAgIC8vIGdpdmVuIDogcHJlZml4ID0gc2l0ZS5hcnRpY2xlLmNvbW1lbnRzLCBwYXJ0ID0gc2l0ZS5hcnRpY2xlLmlkCiAgICAvLyAgICAgIC0gcmV0dXJuczogc2l0ZS5hcnRpY2xlICh1c2UgZ2V0KHZhbHVlc1tzaXRlLmFydGljbGVdLCAnaWQnKSB0byBnZXQgdGhlIGR5bmFtaWMgcGFydCAtIHVzZWQgYmVsb3cpCgogICAgLy8gZ2l2ZW4gOiBwcmVmaXggPSBzaXRlLmFydGljbGUsIHBhcnQgPSBzaXRlLmFydGljbGUuaWQKICAgIC8vICAgICAgLSByZXR1cm5zOiBzaXRlLmFydGljbGUuICh1c2UgZ2V0KHZhbHVlc1tzaXRlLmFydGljbGVdLCAnaWQnKSB0byBnZXQgdGhlIGR5bmFtaWMgcGFydCAtIHVzZWQgYmVsb3cpCgogICAgdmFyIHByZWZpeFBhcnRzID0gcHJlZml4LnNwbGl0KCcuJyk7CiAgICB2YXIgY3VyclByZWZpeCA9ICcnOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJlZml4UGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGN1cnJQYXJ0ID0gcHJlZml4UGFydHMuc2xpY2UoMCwgaSArIDEpLmpvaW4oJy4nKTsKICAgICAgaWYgKHBhcnQuaW5kZXhPZihjdXJyUGFydCkgIT09IDApIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjdXJyUHJlZml4ID0gY3VyclBhcnQ7CiAgICB9CgogICAgcmV0dXJuIGN1cnJQcmVmaXg7CiAgfQoKICAvKgogICAgU3RvbGVuIGZyb20gQ29udHJvbGxlcgogICovCiAgZnVuY3Rpb24gY2FsY3VsYXRlQ2FjaGVLZXkocHJlZml4KSB7CiAgICB2YXIgcGFydHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IFtdOwogICAgdmFyIHZhbHVlcyA9IGFyZ3VtZW50c1syXTsKCiAgICB2YXIgc3VmZml4ZXMgPSAnJzsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKICAgICAgdmFyIGNhY2hlVmFsdWVQcmVmaXggPSBfY2FsY3VsYXRlQ2FjaGVWYWx1ZVByZWZpeChwcmVmaXgsIHBhcnQpOwogICAgICB2YXIgdmFsdWUgPSB2b2lkIDA7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICBpZiAoY2FjaGVWYWx1ZVByZWZpeCAmJiBjYWNoZVZhbHVlUHJlZml4IGluIHZhbHVlcykgewogICAgICAgICAgdmFyIHBhcnRSZW1vdmVkUHJlZml4ID0gcGFydC5pbmRleE9mKGNhY2hlVmFsdWVQcmVmaXgpID09PSAwID8gcGFydC5zdWJzdHIoY2FjaGVWYWx1ZVByZWZpeC5sZW5ndGggKyAxKSA6IHBhcnQ7CiAgICAgICAgICB2YWx1ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHZhbHVlc1tjYWNoZVZhbHVlUHJlZml4XSwgcGFydFJlbW92ZWRQcmVmaXgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWx1ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHZhbHVlcywgcGFydCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1ZmZpeGVzICs9ICc6OicgKyBwYXJ0ICsgJzonICsgdmFsdWU7CiAgICB9CiAgICByZXR1cm4gcHJlZml4ICsgc3VmZml4ZXMucmVwbGFjZShBTExfUEVSSU9EU19SRUdFWCwgJy0nKTsKICB9CgogIC8qCiAgICBDb250cm9sbGVyLWRlZmluZWQgcXVlcnkgcGFyYW1ldGVycyBjYW4gY29tZSBpbiB0aHJlZSBzaGFwZXM6CiAgCiAgICBBcnJheQogICAgICBxdWVyeVBhcmFtczogWydmb28nLCAnYmFyJ10KICAgIEFycmF5IG9mIHNpbXBsZSBvYmplY3RzIHdoZXJlIHZhbHVlIGlzIGFuIGFsaWFzCiAgICAgIHF1ZXJ5UGFyYW1zOiBbCiAgICAgICAgewogICAgICAgICAgJ2Zvbyc6ICdyZW5hbWVfZm9vX3RvX3RoaXMnCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAnYmFyJzogJ2NhbGxfYmFyX3RoaXNfaW5zdGVhZCcKICAgICAgICB9CiAgICAgIF0KICAgIEFycmF5IG9mIGZ1bGx5IGRlZmluZWQgb2JqZWN0cwogICAgICBxdWVyeVBhcmFtczogWwogICAgICAgIHsKICAgICAgICAgICdmb28nOiB7CiAgICAgICAgICAgIGFzOiAncmVuYW1lX2Zvb190b190aGlzJwogICAgICAgICAgfSwKICAgICAgICB9CiAgICAgICAgewogICAgICAgICAgJ2Jhcic6IHsKICAgICAgICAgICAgYXM6ICdjYWxsX2Jhcl90aGlzX2luc3RlYWQnLAogICAgICAgICAgICBzY29wZTogJ2NvbnRyb2xsZXInCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBdCiAgCiAgICBUaGlzIGhlbHBlciBub3JtYWxpemVzIGFsbCB0aHJlZSBwb3NzaWJsZSBzdHlsZXMgaW50byB0aGUKICAgICdBcnJheSBvZiBmdWxseSBkZWZpbmVkIG9iamVjdHMnIHN0eWxlLgogICovCiAgZnVuY3Rpb24gbm9ybWFsaXplQ29udHJvbGxlclF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zKSB7CiAgICB2YXIgcXBNYXAgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5UGFyYW1zLmxlbmd0aDsgKytpKSB7CiAgICAgIGFjY3VtdWxhdGVRdWVyeVBhcmFtRGVzY3JpcHRvcnMocXVlcnlQYXJhbXNbaV0sIHFwTWFwKTsKICAgIH0KCiAgICByZXR1cm4gcXBNYXA7CiAgfQoKICBmdW5jdGlvbiBhY2N1bXVsYXRlUXVlcnlQYXJhbURlc2NyaXB0b3JzKF9kZXNjLCBhY2N1bSkgewogICAgdmFyIGRlc2MgPSBfZGVzYzsKICAgIHZhciB0bXAgPSB2b2lkIDA7CiAgICBpZiAodHlwZW9mIGRlc2MgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRtcCA9IHt9OwogICAgICB0bXBbZGVzY10gPSB7IGFzOiBudWxsIH07CiAgICAgIGRlc2MgPSB0bXA7CiAgICB9CgogICAgZm9yICh2YXIga2V5IGluIGRlc2MpIHsKICAgICAgaWYgKCFkZXNjLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBzaW5nbGVEZXNjID0gZGVzY1trZXldOwogICAgICBpZiAodHlwZW9mIHNpbmdsZURlc2MgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgc2luZ2xlRGVzYyA9IHsgYXM6IHNpbmdsZURlc2MgfTsKICAgICAgfQoKICAgICAgdG1wID0gYWNjdW1ba2V5XSB8fCB7IGFzOiBudWxsLCBzY29wZTogJ21vZGVsJyB9OwogICAgICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHRtcCwgc2luZ2xlRGVzYyk7CgogICAgICBhY2N1bVtrZXldID0gdG1wOwogICAgfQogIH0KCiAgLyoKICAgIENoZWNrIGlmIGEgcm91dGVOYW1lIHJlc2VtYmxlcyBhIHVybCBpbnN0ZWFkCiAgCiAgICBAcHJpdmF0ZQogICovCiAgZnVuY3Rpb24gcmVzZW1ibGVzVVJMKHN0cikgewogICAgcmV0dXJuIHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnICYmIChzdHIgPT09ICcnIHx8IHN0clswXSA9PT0gJy8nKTsKICB9CgogIC8qCiAgICBSZXR1cm5zIGFuIGFyZ3VtZW50cyBhcnJheSB3aGVyZSB0aGUgcm91dGUgbmFtZSBhcmcgaXMgcHJlZml4ZWQgYmFzZWQgb24gdGhlIG1vdW50IHBvaW50CiAgCiAgICBAcHJpdmF0ZQogICovCiAgZnVuY3Rpb24gcHJlZml4Um91dGVOYW1lQXJnKHJvdXRlLCBhcmdzKSB7CiAgICB2YXIgcm91dGVOYW1lID0gYXJnc1swXTsKICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikocm91dGUpOwogICAgdmFyIHByZWZpeCA9IG93bmVyLm1vdW50UG9pbnQ7CgogICAgLy8gb25seSBhbHRlciB0aGUgcm91dGVOYW1lIGlmIGl0J3MgYWN0dWFsbHkgcmVmZXJlbmNpbmcgYSByb3V0ZS4KICAgIGlmIChvd25lci5yb3V0YWJsZSAmJiB0eXBlb2Ygcm91dGVOYW1lID09PSAnc3RyaW5nJykgewogICAgICBpZiAocmVzZW1ibGVzVVJMKHJvdXRlTmFtZSkpIHsKICAgICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoJ1Byb2dyYW1tYXRpYyB0cmFuc2l0aW9ucyBieSBVUkwgY2Fubm90IGJlIHVzZWQgd2l0aGluIGFuIEVuZ2luZS4gUGxlYXNlIHVzZSB0aGUgcm91dGUgbmFtZSBpbnN0ZWFkLicpOwogICAgICB9IGVsc2UgewogICAgICAgIHJvdXRlTmFtZSA9IHByZWZpeCArICcuJyArIHJvdXRlTmFtZTsKICAgICAgICBhcmdzWzBdID0gcm91dGVOYW1lOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGFyZ3M7CiAgfQoKICBmdW5jdGlvbiBzaGFsbG93RXF1YWwoYSwgYikgewogICAgdmFyIGsgPSB2b2lkIDA7CiAgICB2YXIgYUNvdW50ID0gMDsKICAgIHZhciBiQ291bnQgPSAwOwogICAgZm9yIChrIGluIGEpIHsKICAgICAgaWYgKGEuaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICBpZiAoYVtrXSAhPT0gYltrXSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBhQ291bnQrKzsKICAgICAgfQogICAgfQoKICAgIGZvciAoayBpbiBiKSB7CiAgICAgIGlmIChiLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgYkNvdW50Kys7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYUNvdW50ID09PSBiQ291bnQ7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2luZGV4JywgWydleHBvcnRzJywgJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9vYmplY3QnLCAnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL3JlZ2lzdHJ5X3Byb3h5JywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9jb250YWluZXJfcHJveHknLCAnZW1iZXItcnVudGltZS9saWIvY29weScsICdlbWJlci1ydW50aW1lL2xpYi9jb21wYXJlJywgJ2VtYmVyLXJ1bnRpbWUvbGliL2lzLWVxdWFsJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9hcnJheScsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvY29tcGFyYWJsZScsICdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vbmFtZXNwYWNlJywgJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9hcnJheV9wcm94eScsICdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0X3Byb3h5JywgJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9jb3JlX29iamVjdCcsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvYWN0aW9uX2hhbmRsZXInLCAnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL2NvcHlhYmxlJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9lbnVtZXJhYmxlJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy8tcHJveHknLCAnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL29ic2VydmFibGUnLCAnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL211dGFibGVfZW51bWVyYWJsZScsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvdGFyZ2V0X2FjdGlvbl9zdXBwb3J0JywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9ldmVudGVkJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9wcm9taXNlX3Byb3h5JywgJ2VtYmVyLXJ1bnRpbWUvbGliL2V4dC9yc3ZwJywgJ2VtYmVyLXJ1bnRpbWUvbGliL3R5cGUtb2YnLCAnZW1iZXItcnVudGltZS9saWIvZXh0L2Z1bmN0aW9uJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfb2JqZWN0LCBfcmVnaXN0cnlfcHJveHksIF9jb250YWluZXJfcHJveHksIF9jb3B5LCBfY29tcGFyZSwgX2lzRXF1YWwsIF9hcnJheSwgX2NvbXBhcmFibGUsIF9uYW1lc3BhY2UsIF9hcnJheV9wcm94eSwgX29iamVjdF9wcm94eSwgX2NvcmVfb2JqZWN0LCBfYWN0aW9uX2hhbmRsZXIsIF9jb3B5YWJsZSwgX2VudW1lcmFibGUsIF9wcm94eSwgX29ic2VydmFibGUsIF9tdXRhYmxlX2VudW1lcmFibGUsIF90YXJnZXRfYWN0aW9uX3N1cHBvcnQsIF9ldmVudGVkLCBfcHJvbWlzZV9wcm94eSwgX3JzdnAsIF90eXBlT2YpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMudHlwZU9mID0gZXhwb3J0cy5vbmVycm9yRGVmYXVsdCA9IGV4cG9ydHMuUlNWUCA9IGV4cG9ydHMuUHJvbWlzZVByb3h5TWl4aW4gPSBleHBvcnRzLkV2ZW50ZWQgPSBleHBvcnRzLlRhcmdldEFjdGlvblN1cHBvcnQgPSBleHBvcnRzLk11dGFibGVFbnVtZXJhYmxlID0gZXhwb3J0cy5PYnNlcnZhYmxlID0gZXhwb3J0cy5fY29udGVudEZvciA9IGV4cG9ydHMuX1Byb3h5TWl4aW4gPSBleHBvcnRzLkVudW1lcmFibGUgPSBleHBvcnRzLkNvcHlhYmxlID0gZXhwb3J0cy5BY3Rpb25IYW5kbGVyID0gZXhwb3J0cy5Db3JlT2JqZWN0ID0gZXhwb3J0cy5PYmplY3RQcm94eSA9IGV4cG9ydHMuQXJyYXlQcm94eSA9IGV4cG9ydHMuTmFtZXNwYWNlID0gZXhwb3J0cy5Db21wYXJhYmxlID0gZXhwb3J0cy5pc0FycmF5ID0gZXhwb3J0cy51bmlxQnkgPSBleHBvcnRzLnJlbW92ZUF0ID0gZXhwb3J0cy5NdXRhYmxlQXJyYXkgPSBleHBvcnRzLkEgPSBleHBvcnRzLk5hdGl2ZUFycmF5ID0gZXhwb3J0cy5pc0VtYmVyQXJyYXkgPSBleHBvcnRzLkFycmF5ID0gZXhwb3J0cy5pc0VxdWFsID0gZXhwb3J0cy5jb21wYXJlID0gZXhwb3J0cy5jb3B5ID0gZXhwb3J0cy5Db250YWluZXJQcm94eU1peGluID0gZXhwb3J0cy5SZWdpc3RyeVByb3h5TWl4aW4gPSBleHBvcnRzLkZyYW1ld29ya09iamVjdCA9IGV4cG9ydHMuT2JqZWN0ID0gdW5kZWZpbmVkOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnT2JqZWN0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX29iamVjdC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnRnJhbWV3b3JrT2JqZWN0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX29iamVjdC5GcmFtZXdvcmtPYmplY3Q7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdSZWdpc3RyeVByb3h5TWl4aW4nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcmVnaXN0cnlfcHJveHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0NvbnRhaW5lclByb3h5TWl4aW4nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29udGFpbmVyX3Byb3h5LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdjb3B5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvcHkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2NvbXBhcmUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcGFyZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnaXNFcXVhbCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9pc0VxdWFsLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdBcnJheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hcnJheS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnaXNFbWJlckFycmF5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FycmF5LmlzRW1iZXJBcnJheTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ05hdGl2ZUFycmF5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FycmF5Lk5hdGl2ZUFycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hcnJheS5BOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTXV0YWJsZUFycmF5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FycmF5Lk11dGFibGVBcnJheTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ3JlbW92ZUF0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FycmF5LnJlbW92ZUF0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAndW5pcUJ5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FycmF5LnVuaXFCeTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2lzQXJyYXknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfYXJyYXkuaXNBcnJheTsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0NvbXBhcmFibGUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29tcGFyYWJsZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTmFtZXNwYWNlJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX25hbWVzcGFjZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQXJyYXlQcm94eScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hcnJheV9wcm94eS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnT2JqZWN0UHJveHknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfb2JqZWN0X3Byb3h5LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdDb3JlT2JqZWN0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvcmVfb2JqZWN0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdBY3Rpb25IYW5kbGVyJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2FjdGlvbl9oYW5kbGVyLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdDb3B5YWJsZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jb3B5YWJsZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnRW51bWVyYWJsZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9lbnVtZXJhYmxlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfUHJveHlNaXhpbicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcm94eS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX2NvbnRlbnRGb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJveHkuY29udGVudEZvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ09ic2VydmFibGUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfb2JzZXJ2YWJsZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTXV0YWJsZUVudW1lcmFibGUnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbXV0YWJsZV9lbnVtZXJhYmxlLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdUYXJnZXRBY3Rpb25TdXBwb3J0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3RhcmdldF9hY3Rpb25fc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnRXZlbnRlZCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9ldmVudGVkLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdQcm9taXNlUHJveHlNaXhpbicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcm9taXNlX3Byb3h5LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdSU1ZQJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JzdnAuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ29uZXJyb3JEZWZhdWx0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3JzdnAub25lcnJvckRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICd0eXBlT2YnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdHlwZU9mLnR5cGVPZjsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvY29tcGFyZScsIFsnZXhwb3J0cycsICdlbWJlci1ydW50aW1lL2xpYi90eXBlLW9mJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9jb21wYXJhYmxlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfdHlwZU9mLCBfY29tcGFyYWJsZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gY29tcGFyZTsKCgogIHZhciBUWVBFX09SREVSID0gewogICAgdW5kZWZpbmVkOiAwLAogICAgbnVsbDogMSwKICAgIGJvb2xlYW46IDIsCiAgICBudW1iZXI6IDMsCiAgICBzdHJpbmc6IDQsCiAgICBhcnJheTogNSwKICAgIG9iamVjdDogNiwKICAgIGluc3RhbmNlOiA3LAogICAgZnVuY3Rpb246IDgsCiAgICBjbGFzczogOSwKICAgIGRhdGU6IDEwCiAgfTsKCiAgLy8KICAvLyB0aGUgc3BhY2VzaGlwIG9wZXJhdG9yCiAgLy8KICAvLyAgICAgICAgICAgICAgICAgICAgICBgLiBfX18KICAvLyAgICAgICAgICAgICAgICAgICAgIF9fLCcgX19gLiAgICAgICAgICAgICAgICBfLi4tLS0tLi4uLl9fX18KICAvLyAgICAgICAgIF9fLi4uLS0uJ2BgOy4gICAsLiAgIDtgYC0tLi5fXyAgICAgLicgICAgLC0uXyAgICBfLi0nCiAgLy8gICBfLi4tJyctLS0tLS0tJyAgIGAnICAgYCcgICBgJyAgICAgTyBgYC0nJy5fICAgKCw7JykgXywnCiAgLy8gLCdfX19fX19fX19fX19fX19fICAgICAgICAgICAgICAgICAgICAgICAgICBcYC0uX2AtJywnCiAgLy8gIGAuXyAgICAgICAgICAgICAgYGBgYGBgYGBgYGAtLS0tLS0uLi5fX18gICAnLS4uXyctOgogIC8vICAgICBgYGAtLS4uXyAgICAgICwuICAgICAgICAgICAgICAgICAgICAgYGBgYC0tLi4uX19cLS4KICAvLyAgICAgICAgICAgICBgLi0tLiBgLWAgIklORklOSVRZIElTIExFU1MgICAgIF9fX18gICAgfCAgfGAKICAvLyAgICAgICAgICAgICAgIGAuIGAuICAgVEhBTiBCRVlPTkQiICAgICAgICAsJ2BgYGBgLiAgOyAgO2AKICAvLyAgICAgICAgICAgICAgICAgYC5fYC4gICAgICAgIF9fX19fX19fX18gICBgLiAgICAgIFwnX18vYAogIC8vICAgICAgICAgICAgICAgICAgICBgLTouX19fX18vX19fX19fL19fXy9fX19fYC4gICAgIFwgIGAKICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgICBgLl8gICAgYC4gICAgXAogIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgLl9fX19fX19fX2AtLiAgIGAuICAgYC5fX18KICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTU3QgIGAtLS0tLS0nYAogIGZ1bmN0aW9uIHNwYWNlc2hpcChhLCBiKSB7CiAgICB2YXIgZGlmZiA9IGEgLSBiOwogICAgcmV0dXJuIChkaWZmID4gMCkgLSAoZGlmZiA8IDApOwogIH0KCiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KCiAgLyoqCiAgIENvbXBhcmVzIHR3byBqYXZhc2NyaXB0IHZhbHVlcyBhbmQgcmV0dXJuczoKICAKICAgIC0gLTEgaWYgdGhlIGZpcnN0IGlzIHNtYWxsZXIgdGhhbiB0aGUgc2Vjb25kLAogICAgLSAwIGlmIGJvdGggYXJlIGVxdWFsLAogICAgLSAxIGlmIHRoZSBmaXJzdCBpcyBncmVhdGVyIHRoYW4gdGhlIHNlY29uZC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGNvbXBhcmUgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogIAogICAgY29tcGFyZSgnaGVsbG8nLCAnaGVsbG8nKTsgIC8vIDAKICAgIGNvbXBhcmUoJ2FiYycsICdkZmcnKTsgICAgICAvLyAtMQogICAgY29tcGFyZSgyLCAxKTsgICAgICAgICAgICAgIC8vIDEKICAgIGBgYAogIAogICBJZiB0aGUgdHlwZXMgb2YgdGhlIHR3byBvYmplY3RzIGFyZSBkaWZmZXJlbnQgcHJlY2VkZW5jZSBvY2N1cnMgaW4gdGhlCiAgIGZvbGxvd2luZyBvcmRlciwgd2l0aCB0eXBlcyBlYXJsaWVyIGluIHRoZSBsaXN0IGNvbnNpZGVyZWQgYDxgIHR5cGVzCiAgIGxhdGVyIGluIHRoZSBsaXN0OgogIAogICAgLSB1bmRlZmluZWQKICAgIC0gbnVsbAogICAgLSBib29sZWFuCiAgICAtIG51bWJlcgogICAgLSBzdHJpbmcKICAgIC0gYXJyYXkKICAgIC0gb2JqZWN0CiAgICAtIGluc3RhbmNlCiAgICAtIGZ1bmN0aW9uCiAgICAtIGNsYXNzCiAgICAtIGRhdGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGNvbXBhcmUgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogIAogICAgY29tcGFyZSgnaGVsbG8nLCA1MCk7ICAgICAgIC8vIDEKICAgIGNvbXBhcmUoNTAsICdoZWxsbycpOyAgICAgICAvLyAtMQogICAgYGBgCiAgCiAgIEBtZXRob2QgY29tcGFyZQogICBAZm9yIEBlbWJlci91dGlscwogICBAc3RhdGljCiAgIEBwYXJhbSB7T2JqZWN0fSB2IEZpcnN0IHZhbHVlIHRvIGNvbXBhcmUKICAgQHBhcmFtIHtPYmplY3R9IHcgU2Vjb25kIHZhbHVlIHRvIGNvbXBhcmUKICAgQHJldHVybiB7TnVtYmVyfSAtMSBpZiB2IDwgdywgMCBpZiB2ID0gdyBhbmQgMSBpZiB2ID4gdy4KICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gY29tcGFyZSh2LCB3KSB7CiAgICBpZiAodiA9PT0gdykgewogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICB2YXIgdHlwZTEgPSAoMCwgX3R5cGVPZi50eXBlT2YpKHYpOwogICAgdmFyIHR5cGUyID0gKDAsIF90eXBlT2YudHlwZU9mKSh3KTsKCiAgICBpZiAodHlwZTEgPT09ICdpbnN0YW5jZScgJiYgX2NvbXBhcmFibGUuZGVmYXVsdC5kZXRlY3QodikgJiYgdi5jb25zdHJ1Y3Rvci5jb21wYXJlKSB7CiAgICAgIHJldHVybiB2LmNvbnN0cnVjdG9yLmNvbXBhcmUodiwgdyk7CiAgICB9CgogICAgaWYgKHR5cGUyID09PSAnaW5zdGFuY2UnICYmIF9jb21wYXJhYmxlLmRlZmF1bHQuZGV0ZWN0KHcpICYmIHcuY29uc3RydWN0b3IuY29tcGFyZSkgewogICAgICByZXR1cm4gdy5jb25zdHJ1Y3Rvci5jb21wYXJlKHcsIHYpICogLTE7CiAgICB9CgogICAgdmFyIHJlcyA9IHNwYWNlc2hpcChUWVBFX09SREVSW3R5cGUxXSwgVFlQRV9PUkRFUlt0eXBlMl0pOwoKICAgIGlmIChyZXMgIT09IDApIHsKICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICAvLyB0eXBlcyBhcmUgZXF1YWwgLSBzbyB3ZSBoYXZlIHRvIGNoZWNrIHZhbHVlcyBub3cKICAgIHN3aXRjaCAodHlwZTEpIHsKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIHNwYWNlc2hpcCh2LCB3KTsKCiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHNwYWNlc2hpcCh2LmxvY2FsZUNvbXBhcmUodyksIDApOwoKICAgICAgY2FzZSAnYXJyYXknOgogICAgICAgIHsKICAgICAgICAgIHZhciB2TGVuID0gdi5sZW5ndGg7CiAgICAgICAgICB2YXIgd0xlbiA9IHcubGVuZ3RoOwogICAgICAgICAgdmFyIGxlbiA9IE1hdGgubWluKHZMZW4sIHdMZW4pOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIHIgPSBjb21wYXJlKHZbaV0sIHdbaV0pOwogICAgICAgICAgICBpZiAociAhPT0gMCkgewogICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gYWxsIGVsZW1lbnRzIGFyZSBlcXVhbCBub3cKICAgICAgICAgIC8vIHNob3J0ZXIgYXJyYXkgc2hvdWxkIGJlIG9yZGVyZWQgZmlyc3QKICAgICAgICAgIHJldHVybiBzcGFjZXNoaXAodkxlbiwgd0xlbik7CiAgICAgICAgfQogICAgICBjYXNlICdpbnN0YW5jZSc6CiAgICAgICAgaWYgKF9jb21wYXJhYmxlLmRlZmF1bHQuZGV0ZWN0KHYpKSB7CiAgICAgICAgICByZXR1cm4gdi5jb21wYXJlKHYsIHcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKCiAgICAgIGNhc2UgJ2RhdGUnOgogICAgICAgIHJldHVybiBzcGFjZXNoaXAodi5nZXRUaW1lKCksIHcuZ2V0VGltZSgpKTsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9jb3B5JywgWydleHBvcnRzJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0JywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9jb3B5YWJsZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnLCBfb2JqZWN0LCBfY29weWFibGUpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGNvcHk7CgoKICAvKioKICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KICBmdW5jdGlvbiBfY29weShvYmosIGRlZXAsIHNlZW4sIGNvcGllcykgewogICAgLy8gcHJpbWl0aXZlIGRhdGEgdHlwZXMgYXJlIGltbXV0YWJsZSwganVzdCByZXR1cm4gdGhlbS4KICAgIGlmICh0eXBlb2Ygb2JqICE9PSAnb2JqZWN0JyB8fCBvYmogPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgICB2YXIgcmV0ID0gdm9pZCAwLAogICAgICAgIGxvYyA9IHZvaWQgMDsKCiAgICAvLyBhdm9pZCBjeWNsaWNhbCBsb29wcwogICAgaWYgKGRlZXAgJiYgKGxvYyA9IHNlZW4uaW5kZXhPZihvYmopKSA+PSAwKSB7CiAgICAgIHJldHVybiBjb3BpZXNbbG9jXTsKICAgIH0KCiAgICAvLyBJTVBPUlRBTlQ6IHRoaXMgc3BlY2lmaWMgdGVzdCB3aWxsIGRldGVjdCBhIG5hdGl2ZSBhcnJheSBvbmx5LiBBbnkgb3RoZXIKICAgIC8vIG9iamVjdCB3aWxsIG5lZWQgdG8gaW1wbGVtZW50IENvcHlhYmxlLgogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICByZXQgPSBvYmouc2xpY2UoKTsKCiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgbG9jID0gcmV0Lmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKC0tbG9jID49IDApIHsKICAgICAgICAgIHJldFtsb2NdID0gX2NvcHkocmV0W2xvY10sIGRlZXAsIHNlZW4sIGNvcGllcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKF9jb3B5YWJsZS5kZWZhdWx0LmRldGVjdChvYmopKSB7CiAgICAgIHJldCA9IG9iai5jb3B5KGRlZXAsIHNlZW4sIGNvcGllcyk7CiAgICB9IGVsc2UgaWYgKG9iaiBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgcmV0ID0gbmV3IERhdGUob2JqLmdldFRpbWUoKSk7CiAgICB9IGVsc2UgewogICAgICAodHJ1ZSAmJiAhKCEob2JqIGluc3RhbmNlb2YgX29iamVjdC5kZWZhdWx0KSB8fCBfY29weWFibGUuZGVmYXVsdC5kZXRlY3Qob2JqKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdDYW5ub3QgY2xvbmUgYW4gRW1iZXJPYmplY3QgdGhhdCBkb2VzIG5vdCBpbXBsZW1lbnQgQ29weWFibGUnLCAhKG9iaiBpbnN0YW5jZW9mIF9vYmplY3QuZGVmYXVsdCkgfHwgX2NvcHlhYmxlLmRlZmF1bHQuZGV0ZWN0KG9iaikpKTsKCgogICAgICByZXQgPSB7fTsKICAgICAgdmFyIGtleSA9IHZvaWQgMDsKICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgLy8gc3VwcG9ydCBOdWxsIHByb3RvdHlwZQogICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyBQcmV2ZW50cyBicm93c2VycyB0aGF0IGRvbid0IHJlc3BlY3Qgbm9uLWVudW1lcmFiaWxpdHkgZnJvbQogICAgICAgIC8vIGNvcHlpbmcgaW50ZXJuYWwgRW1iZXIgcHJvcGVydGllcwogICAgICAgIGlmIChrZXkuc3Vic3RyaW5nKDAsIDIpID09PSAnX18nKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIHJldFtrZXldID0gZGVlcCA/IF9jb3B5KG9ialtrZXldLCBkZWVwLCBzZWVuLCBjb3BpZXMpIDogb2JqW2tleV07CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGVlcCkgewogICAgICBzZWVuLnB1c2gob2JqKTsKICAgICAgY29waWVzLnB1c2gocmV0KTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0KCiAgLyoqCiAgICBDcmVhdGVzIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBwYXNzZWQgb2JqZWN0LiBBIGRlZXAgY29weSBvZiB0aGUgb2JqZWN0IGlzCiAgICByZXR1cm5lZCBpZiB0aGUgb3B0aW9uYWwgYGRlZXBgIGFyZ3VtZW50IGlzIGB0cnVlYC4KICAKICAgIElmIHRoZSBwYXNzZWQgb2JqZWN0IGltcGxlbWVudHMgdGhlIGBDb3B5YWJsZWAgaW50ZXJmYWNlLCB0aGVuIHRoaXMKICAgIGZ1bmN0aW9uIHdpbGwgZGVsZWdhdGUgdG8gdGhlIG9iamVjdCdzIGBjb3B5KClgIG1ldGhvZCBhbmQgcmV0dXJuIHRoZQogICAgcmVzdWx0LiBTZWUgYENvcHlhYmxlYCBmb3IgZnVydGhlciBkZXRhaWxzLgogIAogICAgRm9yIHByaW1pdGl2ZSB2YWx1ZXMgKHdoaWNoIGFyZSBpbW11dGFibGUgaW4gSmF2YVNjcmlwdCksIHRoZSBwYXNzZWQgb2JqZWN0CiAgICBpcyBzaW1wbHkgcmV0dXJuZWQuCiAgCiAgICBAbWV0aG9kIGNvcHkKICAgIEBkZXByZWNhdGVkIFVzZSAnZW1iZXItY29weScgYWRkb24gaW5zdGVhZAogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvb2JqZWN0L2ludGVybmFscwogICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIGNsb25lCiAgICBAcGFyYW0ge0Jvb2xlYW59IFtkZWVwPWZhbHNlXSBJZiB0cnVlLCBhIGRlZXAgY29weSBvZiB0aGUgb2JqZWN0IGlzIG1hZGUuCiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBjb3BpZWQgb2JqZWN0CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBjb3B5KG9iaiwgZGVlcCkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdVc2UgZW1iZXItY29weSBhZGRvbiBpbnN0ZWFkIG9mIGNvcHkgbWV0aG9kIGFuZCBDb3B5YWJsZSBtaXhpbi4nLCBmYWxzZSwgewogICAgICBpZDogJ2VtYmVyLXJ1bnRpbWUuZGVwcmVjYXRlLWNvcHktY29weWFibGUnLAogICAgICB1bnRpbDogJzQuMC4wJywKICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueC8jdG9jX2VtYmVyLXJ1bnRpbWUtZGVwcmVjYXRlLWNvcHktY29weWFibGUnCiAgICB9KSk7CgoKICAgIC8vIGZhc3QgcGF0aHMKICAgIGlmICgnb2JqZWN0JyAhPT0gdHlwZW9mIG9iaiB8fCBvYmogPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG9iajsgLy8gY2FuJ3QgY29weSBwcmltaXRpdmVzCiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KG9iaikgJiYgX2NvcHlhYmxlLmRlZmF1bHQuZGV0ZWN0KG9iaikpIHsKICAgICAgcmV0dXJuIG9iai5jb3B5KGRlZXApOwogICAgfQoKICAgIHJldHVybiBfY29weShvYmosIGRlZXAsIGRlZXAgPyBbXSA6IG51bGwsIGRlZXAgPyBbXSA6IG51bGwpOwogIH0KfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvZXh0L2Z1bmN0aW9uJywgWydlbWJlci1lbnZpcm9ubWVudCcsICdlbWJlci1tZXRhbCddLCBmdW5jdGlvbiAoX2VtYmVyRW52aXJvbm1lbnQsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5GdW5jdGlvbikgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRnVuY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgIC8qKgogICAgICAgIFRoZSBgcHJvcGVydHlgIGV4dGVuc2lvbiBvZiBKYXZhc2NyaXB0J3MgRnVuY3Rpb24gcHJvdG90eXBlIGlzIGF2YWlsYWJsZQogICAgICAgIHdoZW4gYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICAgICAgYHRydWVgLCB3aGljaCBpcyB0aGUgZGVmYXVsdC4KICAgICAgICAgQ29tcHV0ZWQgcHJvcGVydGllcyBhbGxvdyB5b3UgdG8gdHJlYXQgYSBmdW5jdGlvbiBsaWtlIGEgcHJvcGVydHk6CiAgICAgICAgIGBgYGFwcC91dGlscy9wcmVzaWRlbnQuanMKICAgICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgICBmaXJzdE5hbWU6ICcnLAogICAgICAgICAgbGFzdE5hbWU6ICAnJywKICAgICAgICAgICBmdWxsTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgICAgICAgIH0ucHJvcGVydHkoKSAvLyBDYWxsIHRoaXMgZmxhZyB0byBtYXJrIHRoZSBmdW5jdGlvbiBhcyBhIHByb3BlcnR5CiAgICAgICAgfSk7CiAgICAgICAgYGBgCiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBsZXQgcHJlc2lkZW50ID0gUHJlc2lkZW50LmNyZWF0ZSh7CiAgICAgICAgICBmaXJzdE5hbWU6ICdCYXJhY2snLAogICAgICAgICAgbGFzdE5hbWU6ICdPYmFtYScKICAgICAgICB9KTsKICAgICAgICAgcHJlc2lkZW50LmdldCgnZnVsbE5hbWUnKTsgLy8gJ0JhcmFjayBPYmFtYScKICAgICAgICBgYGAKICAgICAgICAgVHJlYXRpbmcgYSBmdW5jdGlvbiBsaWtlIGEgcHJvcGVydHkgaXMgdXNlZnVsIGJlY2F1c2UgdGhleSBjYW4gd29yayB3aXRoCiAgICAgICAgYmluZGluZ3MsIGp1c3QgbGlrZSBhbnkgb3RoZXIgcHJvcGVydHkuCiAgICAgICAgIE1hbnkgY29tcHV0ZWQgcHJvcGVydGllcyBoYXZlIGRlcGVuZGVuY2llcyBvbiBvdGhlciBwcm9wZXJ0aWVzLiBGb3IKICAgICAgICBleGFtcGxlLCBpbiB0aGUgYWJvdmUgZXhhbXBsZSwgdGhlIGBmdWxsTmFtZWAgcHJvcGVydHkgZGVwZW5kcyBvbgogICAgICAgIGBmaXJzdE5hbWVgIGFuZCBgbGFzdE5hbWVgIHRvIGRldGVybWluZSBpdHMgdmFsdWUuIFlvdSBjYW4gdGVsbCBFbWJlcgogICAgICAgIGFib3V0IHRoZXNlIGRlcGVuZGVuY2llcyBsaWtlIHRoaXM6CiAgICAgICAgIGBgYGFwcC91dGlscy9wcmVzaWRlbnQuanMKICAgICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgICBmaXJzdE5hbWU6ICcnLAogICAgICAgICAgbGFzdE5hbWU6ICAnJywKICAgICAgICAgICBmdWxsTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldCgnZmlyc3ROYW1lJykgKyAnICcgKyB0aGlzLmdldCgnbGFzdE5hbWUnKTsKICAgICAgICAgICAgIC8vIFRlbGwgRW1iZXIuanMgdGhhdCB0aGlzIGNvbXB1dGVkIHByb3BlcnR5IGRlcGVuZHMgb24gZmlyc3ROYW1lCiAgICAgICAgICAgIC8vIGFuZCBsYXN0TmFtZQogICAgICAgICAgfS5wcm9wZXJ0eSgnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJykKICAgICAgICB9KTsKICAgICAgICBgYGAKICAgICAgICAgTWFrZSBzdXJlIHlvdSBsaXN0IHRoZXNlIGRlcGVuZGVuY2llcyBzbyBFbWJlciBrbm93cyB3aGVuIHRvIHVwZGF0ZQogICAgICAgIGJpbmRpbmdzIHRoYXQgY29ubmVjdCB0byBhIGNvbXB1dGVkIHByb3BlcnR5LiBDaGFuZ2luZyBhIGRlcGVuZGVuY3kKICAgICAgICB3aWxsIG5vdCBpbW1lZGlhdGVseSB0cmlnZ2VyIGFuIHVwZGF0ZSBvZiB0aGUgY29tcHV0ZWQgcHJvcGVydHksIGJ1dAogICAgICAgIHdpbGwgaW5zdGVhZCBjbGVhciB0aGUgY2FjaGUgc28gdGhhdCBpdCBpcyB1cGRhdGVkIHdoZW4gdGhlIG5leHQgYGdldGAKICAgICAgICBpcyBjYWxsZWQgb24gdGhlIHByb3BlcnR5LgogICAgICAgICBTZWUgW0NvbXB1dGVkUHJvcGVydHldKC9hcGkvZW1iZXIvcmVsZWFzZS9jbGFzc2VzL0NvbXB1dGVkUHJvcGVydHkpLCBbQGVtYmVyL29iamVjdC9jb21wdXRlZF0oL2FwaS9lbWJlci9yZWxlYXNlL2NsYXNzZXMvQGVtYmVyJTJGb2JqZWN0JTJGY29tcHV0ZWQpLgogICAgICAgICBAbWV0aG9kIHByb3BlcnR5CiAgICAgICAgQGZvciBGdW5jdGlvbgogICAgICAgIEBwdWJsaWMKICAgICAgKi8KICAgICAgcHJvcGVydHk6IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBfZW1iZXJNZXRhbC5jb21wdXRlZC5hcHBseSh1bmRlZmluZWQsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykuY29uY2F0KFt0aGlzXSkpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgIFRoZSBgb2JzZXJ2ZXNgIGV4dGVuc2lvbiBvZiBKYXZhc2NyaXB0J3MgRnVuY3Rpb24gcHJvdG90eXBlIGlzIGF2YWlsYWJsZQogICAgICAgIHdoZW4gYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuRnVuY3Rpb25gIGlzCiAgICAgICAgdHJ1ZSwgd2hpY2ggaXMgdGhlIGRlZmF1bHQuCiAgICAgICAgIFlvdSBjYW4gb2JzZXJ2ZSBwcm9wZXJ0eSBjaGFuZ2VzIHNpbXBseSBieSBhZGRpbmcgdGhlIGBvYnNlcnZlc2AKICAgICAgICBjYWxsIHRvIHRoZSBlbmQgb2YgeW91ciBtZXRob2QgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgdGhhdCB5b3Ugd3JpdGUuCiAgICAgICAgRm9yIGV4YW1wbGU6CiAgICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICAgIEVtYmVyT2JqZWN0LmV4dGVuZCh7CiAgICAgICAgICB2YWx1ZU9ic2VydmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gRXhlY3V0ZXMgd2hlbmV2ZXIgdGhlICJ2YWx1ZSIgcHJvcGVydHkgY2hhbmdlcwogICAgICAgICAgfS5vYnNlcnZlcygndmFsdWUnKQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgICBJbiB0aGUgZnV0dXJlIHRoaXMgbWV0aG9kIG1heSBiZWNvbWUgYXN5bmNocm9ub3VzLgogICAgICAgICBTZWUgYG9ic2VydmVyYC4KICAgICAgICAgQG1ldGhvZCBvYnNlcnZlcwogICAgICAgIEBmb3IgRnVuY3Rpb24KICAgICAgICBAcHVibGljCiAgICAgICovCiAgICAgIG9ic2VydmVzOiB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX2VtYmVyTWV0YWwub2JzZXJ2ZXIuYXBwbHkodW5kZWZpbmVkLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLmNvbmNhdChbdGhpc10pKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICBUaGUgYG9uYCBleHRlbnNpb24gb2YgSmF2YXNjcmlwdCdzIEZ1bmN0aW9uIHByb3RvdHlwZSBpcyBhdmFpbGFibGUKICAgICAgICB3aGVuIGBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFU2Agb3IgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTLkZ1bmN0aW9uYCBpcwogICAgICAgIHRydWUsIHdoaWNoIGlzIHRoZSBkZWZhdWx0LgogICAgICAgICBZb3UgY2FuIGxpc3RlbiBmb3IgZXZlbnRzIHNpbXBseSBieSBhZGRpbmcgdGhlIGBvbmAgY2FsbCB0byB0aGUgZW5kIG9mCiAgICAgICAgeW91ciBtZXRob2QgZGVjbGFyYXRpb25zIGluIGNsYXNzZXMgb3IgbWl4aW5zIHRoYXQgeW91IHdyaXRlLiBGb3IgZXhhbXBsZToKICAgICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIGltcG9ydCBNaXhpbiBmcm9tICdAZW1iZXIvbWl4aW4nOwogICAgICAgICBNaXhpbi5jcmVhdGUoewogICAgICAgICAgZG9Tb21ldGhpbmdXaXRoRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIEV4ZWN1dGVzIHdoZW5ldmVyIHRoZSAiZGlkSW5zZXJ0RWxlbWVudCIgZXZlbnQgZmlyZXMKICAgICAgICAgIH0ub24oJ2RpZEluc2VydEVsZW1lbnQnKQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgICBTZWUgYEBlbWJlci9vYmplY3QvZXZlbnRlZC9vbmAuCiAgICAgICAgIEBtZXRob2Qgb24KICAgICAgICBAZm9yIEZ1bmN0aW9uCiAgICAgICAgQHB1YmxpYwogICAgICAqLwoKICAgICAgb246IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBfZW1iZXJNZXRhbC5vbi5hcHBseSh1bmRlZmluZWQsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykuY29uY2F0KFt0aGlzXSkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9leHQvcnN2cCcsIFsnZXhwb3J0cycsICdyc3ZwJywgJ0BlbWJlci9ydW5sb29wJywgJ2VtYmVyLWVycm9yLWhhbmRsaW5nJywgJ0BlbWJlci9kZWJ1ZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3JzdnAsIF9ydW5sb29wLCBfZW1iZXJFcnJvckhhbmRsaW5nLCBfZGVidWcpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMub25lcnJvckRlZmF1bHQgPSBvbmVycm9yRGVmYXVsdDsKCgogIF9yc3ZwLmNvbmZpZ3VyZSgnYXN5bmMnLCBmdW5jdGlvbiAoY2FsbGJhY2ssIHByb21pc2UpIHsKICAgIF9ydW5sb29wLmJhY2tidXJuZXIuc2NoZWR1bGUoJ2FjdGlvbnMnLCBudWxsLCBjYWxsYmFjaywgcHJvbWlzZSk7CiAgfSk7CgogIF9yc3ZwLmNvbmZpZ3VyZSgnYWZ0ZXInLCBmdW5jdGlvbiAoY2IpIHsKICAgIF9ydW5sb29wLmJhY2tidXJuZXIuc2NoZWR1bGUoX3J1bmxvb3AuX3JzdnBFcnJvclF1ZXVlLCBudWxsLCBjYik7CiAgfSk7CgogIF9yc3ZwLm9uKCdlcnJvcicsIG9uZXJyb3JEZWZhdWx0KTsKCiAgZnVuY3Rpb24gb25lcnJvckRlZmF1bHQocmVhc29uKSB7CiAgICB2YXIgZXJyb3IgPSBlcnJvckZvcihyZWFzb24pOwogICAgaWYgKGVycm9yKSB7CiAgICAgIHZhciBvdmVycmlkZURpc3BhdGNoID0gKDAsIF9lbWJlckVycm9ySGFuZGxpbmcuZ2V0RGlzcGF0Y2hPdmVycmlkZSkoKTsKICAgICAgaWYgKG92ZXJyaWRlRGlzcGF0Y2gpIHsKICAgICAgICBvdmVycmlkZURpc3BhdGNoKGVycm9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZXJyb3JGb3IocmVhc29uKSB7CiAgICBpZiAoIXJlYXNvbikgcmV0dXJuOwoKICAgIGlmIChyZWFzb24uZXJyb3JUaHJvd24pIHsKICAgICAgcmV0dXJuIHVud3JhcEVycm9yVGhyb3duKHJlYXNvbik7CiAgICB9CgogICAgaWYgKHJlYXNvbi5uYW1lID09PSAnVW5yZWNvZ25pemVkVVJMRXJyb3InKSB7CiAgICAgICh0cnVlICYmICEoZmFsc2UpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIFVSTCBcJycgKyByZWFzb24ubWVzc2FnZSArICdcJyBkaWQgbm90IG1hdGNoIGFueSByb3V0ZXMgaW4geW91ciBhcHBsaWNhdGlvbicsIGZhbHNlKSk7CgogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHJlYXNvbi5uYW1lID09PSAnVHJhbnNpdGlvbkFib3J0ZWQnKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICByZXR1cm4gcmVhc29uOwogIH0KCiAgZnVuY3Rpb24gdW53cmFwRXJyb3JUaHJvd24ocmVhc29uKSB7CiAgICB2YXIgZXJyb3IgPSByZWFzb24uZXJyb3JUaHJvd247CiAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICBlcnJvciA9IG5ldyBFcnJvcihlcnJvcik7CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyb3IsICdfX3JlYXNvbl93aXRoX2Vycm9yX3Rocm93bl9fJywgewogICAgICB2YWx1ZTogcmVhc29uLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZQogICAgfSk7CiAgICByZXR1cm4gZXJyb3I7CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSBfcnN2cDsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvaXMtZXF1YWwnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGlzRXF1YWw7CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KICAvKioKICAgIENvbXBhcmVzIHR3byBvYmplY3RzLCByZXR1cm5pbmcgdHJ1ZSBpZiB0aGV5IGFyZSBlcXVhbC4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogIAogICAgaXNFcXVhbCgnaGVsbG8nLCAnaGVsbG8nKTsgICAgICAgICAgICAgICAgICAgLy8gdHJ1ZQogICAgaXNFcXVhbCgxLCAyKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmFsc2UKICAgIGBgYAogIAogICAgYGlzRXF1YWxgIGlzIGEgbW9yZSBzcGVjaWZpYyBjb21wYXJpc29uIHRoYW4gYSB0cmlwbGUgZXF1YWwgY29tcGFyaXNvbi4KICAgIEl0IHdpbGwgY2FsbCB0aGUgYGlzRXF1YWxgIGluc3RhbmNlIG1ldGhvZCBvbiB0aGUgb2JqZWN0cyBiZWluZwogICAgY29tcGFyZWQsIGFsbG93aW5nIGZpbmVyIGNvbnRyb2wgb3ZlciB3aGVuIG9iamVjdHMgc2hvdWxkIGJlIGNvbnNpZGVyZWQKICAgIGVxdWFsIHRvIGVhY2ggb3RoZXIuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBpc0VxdWFsIH0gZnJvbSAnQGVtYmVyL3V0aWxzJzsKICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGxldCBQZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoewogICAgICBpc0VxdWFsKG90aGVyKSB7IHJldHVybiB0aGlzLnNzbiA9PSBvdGhlci5zc247IH0KICAgIH0pOwogIAogICAgbGV0IHBlcnNvbkEgPSBQZXJzb24uY3JlYXRlKHtuYW1lOiAnTXVoYW1tYWQgQWxpJywgc3NuOiAnMTIzLTQ1LTY3ODknfSk7CiAgICBsZXQgcGVyc29uQiA9IFBlcnNvbi5jcmVhdGUoe25hbWU6ICdDYXNzaXVzIENsYXknLCBzc246ICcxMjMtNDUtNjc4OSd9KTsKICAKICAgIGlzRXF1YWwocGVyc29uQSwgcGVyc29uQik7IC8vIHRydWUKICAgIGBgYAogIAogICAgRHVlIHRvIHRoZSBleHBlbnNlIG9mIGFycmF5IGNvbXBhcmlzb25zLCBjb2xsZWN0aW9ucyB3aWxsIG5ldmVyIGJlIGVxdWFsIHRvCiAgICBlYWNoIG90aGVyIGV2ZW4gaWYgZWFjaCBvZiB0aGVpciBpdGVtcyBhcmUgZXF1YWwgdG8gZWFjaCBvdGhlci4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogIAogICAgaXNFcXVhbChbNCwgMl0sIFs0LCAyXSk7ICAgICAgICAgICAgICAgICAgICAgLy8gZmFsc2UKICAgIGBgYAogIAogICAgQG1ldGhvZCBpc0VxdWFsCiAgICBAZm9yIEBlbWJlci91dGlscwogICAgQHN0YXRpYwogICAgQHBhcmFtIHtPYmplY3R9IGEgZmlyc3Qgb2JqZWN0IHRvIGNvbXBhcmUKICAgIEBwYXJhbSB7T2JqZWN0fSBiIHNlY29uZCBvYmplY3QgdG8gY29tcGFyZQogICAgQHJldHVybiB7Qm9vbGVhbn0KICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYikgewogICAgaWYgKGEgJiYgdHlwZW9mIGEuaXNFcXVhbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gYS5pc0VxdWFsKGIpOwogICAgfQoKICAgIGlmIChhIGluc3RhbmNlb2YgRGF0ZSAmJiBiIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICByZXR1cm4gYS5nZXRUaW1lKCkgPT09IGIuZ2V0VGltZSgpOwogICAgfQoKICAgIHJldHVybiBhID09PSBiOwogIH0KfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zLy1wcm94eScsIFsnZXhwb3J0cycsICdAZ2xpbW1lci9yZWZlcmVuY2UnLCAnZW1iZXItbWV0YScsICdlbWJlci1tZXRhbCcsICdlbWJlci11dGlscycsICdAZW1iZXIvZGVidWcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9yZWZlcmVuY2UsIF9lbWJlck1ldGEsIF9lbWJlck1ldGFsLCBfZW1iZXJVdGlscywgX2RlYnVnKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmNvbnRlbnRGb3IgPSBjb250ZW50Rm9yOwoKCiAgZnVuY3Rpb24gY29udGVudFByb3BlcnR5RGlkQ2hhbmdlKGNvbnRlbnQsIGNvbnRlbnRLZXkpIHsKICAgIHZhciBrZXkgPSBjb250ZW50S2V5LnNsaWNlKDgpOyAvLyByZW1vdmUgImNvbnRlbnQuIgogICAgaWYgKGtleSBpbiB0aGlzKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gaWYgc2hhZG93ZWQgaW4gcHJveHkKICAgICgwLCBfZW1iZXJNZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSkodGhpcywga2V5KTsKICB9IC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KCiAgZnVuY3Rpb24gY29udGVudEZvcihwcm94eSwgbSkgewogICAgdmFyIGNvbnRlbnQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShwcm94eSwgJ2NvbnRlbnQnKTsKICAgIHZhciB0YWcgPSAobSA9PT0gdW5kZWZpbmVkID8gKDAsIF9lbWJlck1ldGEubWV0YSkocHJveHkpIDogbSkucmVhZGFibGVUYWcoKTsKICAgIGlmICh0YWcgIT09IHVuZGVmaW5lZCkgewogICAgICB0YWcuaW5uZXIuc2Vjb25kLmlubmVyLnVwZGF0ZSgoMCwgX2VtYmVyTWV0YWwudGFnRm9yKShjb250ZW50KSk7CiAgICB9CiAgICByZXR1cm4gY29udGVudDsKICB9CgogIC8qKgogICAgYEVtYmVyLlByb3h5TWl4aW5gIGZvcndhcmRzIGFsbCBwcm9wZXJ0aWVzIG5vdCBkZWZpbmVkIGJ5IHRoZSBwcm94eSBpdHNlbGYKICAgIHRvIGEgcHJveGllZCBgY29udGVudGAgb2JqZWN0LiAgU2VlIE9iamVjdFByb3h5IGZvciBtb3JlIGRldGFpbHMuCiAgCiAgICBAY2xhc3MgUHJveHlNaXhpbgogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHByaXZhdGUKICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgVGhlIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIHdpbGwgYmUgZm9yd2FyZGVkLgogICAgICAgQHByb3BlcnR5IGNvbnRlbnQKICAgICAgQHR5cGUgRW1iZXJPYmplY3QKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGNvbnRlbnQ6IG51bGwsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAoMCwgX2VtYmVyVXRpbHMuc2V0UHJveHkpKHRoaXMpOwogICAgICB2YXIgbSA9ICgwLCBfZW1iZXJNZXRhLm1ldGEpKHRoaXMpOwogICAgICBtLndyaXRhYmxlVGFnKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKDAsIF9yZWZlcmVuY2UuY29tYmluZSkoW19yZWZlcmVuY2UuRGlydHlhYmxlVGFnLmNyZWF0ZSgpLCBfcmVmZXJlbmNlLlVwZGF0YWJsZVRhZy5jcmVhdGUoX3JlZmVyZW5jZS5DT05TVEFOVF9UQUcpXSk7CiAgICAgIH0pOwogICAgfSwKCgogICAgaXNUcnV0aHk6ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoJ2NvbnRlbnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAhISgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdjb250ZW50Jyk7CiAgICB9KSwKCiAgICB3aWxsV2F0Y2hQcm9wZXJ0eTogZnVuY3Rpb24gKGtleSkgewogICAgICB2YXIgY29udGVudEtleSA9ICdjb250ZW50LicgKyBrZXk7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5hZGRPYnNlcnZlcikodGhpcywgY29udGVudEtleSwgbnVsbCwgY29udGVudFByb3BlcnR5RGlkQ2hhbmdlKTsKICAgIH0sCiAgICBkaWRVbndhdGNoUHJvcGVydHk6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIGNvbnRlbnRLZXkgPSAnY29udGVudC4nICsga2V5OwogICAgICAoMCwgX2VtYmVyTWV0YWwucmVtb3ZlT2JzZXJ2ZXIpKHRoaXMsIGNvbnRlbnRLZXksIG51bGwsIGNvbnRlbnRQcm9wZXJ0eURpZENoYW5nZSk7CiAgICB9LAogICAgdW5rbm93blByb3BlcnR5OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBjb250ZW50ID0gY29udGVudEZvcih0aGlzKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkoY29udGVudCwga2V5KTsKICAgICAgfQogICAgfSwKICAgIHNldFVua25vd25Qcm9wZXJ0eTogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIG0gPSAoMCwgX2VtYmVyTWV0YS5tZXRhKSh0aGlzKTsKCiAgICAgIGlmIChtLnByb3RvID09PSB0aGlzKSB7CiAgICAgICAgLy8gaWYgbWFya2VkIGFzIHByb3RvdHlwZSB0aGVuIGp1c3QgZGVmaW5lUHJvcGVydHkKICAgICAgICAvLyByYXRoZXIgdGhhbiBkZWxlZ2F0ZQogICAgICAgICgwLCBfZW1iZXJNZXRhbC5kZWZpbmVQcm9wZXJ0eSkodGhpcywga2V5LCBudWxsLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CgogICAgICB2YXIgY29udGVudCA9IGNvbnRlbnRGb3IodGhpcywgbSk7CgogICAgICAodHJ1ZSAmJiAhKGNvbnRlbnQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQ2Fubm90IGRlbGVnYXRlIHNldChcJycgKyBrZXkgKyAnXCcsICcgKyB2YWx1ZSArICcpIHRvIHRoZSBcJ2NvbnRlbnRcJyBwcm9wZXJ0eSBvZiBvYmplY3QgcHJveHkgJyArIHRoaXMgKyAnOiBpdHMgXCdjb250ZW50XCcgaXMgdW5kZWZpbmVkLicsIGNvbnRlbnQpKTsKCgogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLnNldCkoY29udGVudCwga2V5LCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9hY3Rpb25faGFuZGxlcicsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZGVidWcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfZGVidWcpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgYEVtYmVyLkFjdGlvbkhhbmRsZXJgIGlzIGF2YWlsYWJsZSBvbiBzb21lIGZhbWlsaWFyIGNsYXNzZXMgaW5jbHVkaW5nCiAgICBgUm91dGVgLCBgQ29tcG9uZW50YCwgYW5kIGBDb250cm9sbGVyYC4KICAgIChJbnRlcm5hbGx5IHRoZSBtaXhpbiBpcyB1c2VkIGJ5IGBFbWJlci5Db3JlVmlld2AsIGBFbWJlci5Db250cm9sbGVyTWl4aW5gLAogICAgYW5kIGBSb3V0ZWAgYW5kIGF2YWlsYWJsZSB0byB0aGUgYWJvdmUgY2xhc3NlcyB0aHJvdWdoCiAgICBpbmhlcml0YW5jZS4pCiAgCiAgICBAY2xhc3MgQWN0aW9uSGFuZGxlcgogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHByaXZhdGUKICAqLwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICB2YXIgQWN0aW9uSGFuZGxlciA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSh7CiAgICBtZXJnZWRQcm9wZXJ0aWVzOiBbJ2FjdGlvbnMnXSwKCiAgICBzZW5kOiBmdW5jdGlvbiAoYWN0aW9uTmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgKHRydWUgJiYgISghdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQXR0ZW1wdGVkIHRvIGNhbGwgLnNlbmQoKSB3aXRoIHRoZSBhY3Rpb24gXCcnICsgYWN0aW9uTmFtZSArICdcJyBvbiB0aGUgZGVzdHJveWVkIG9iamVjdCBcJycgKyB0aGlzICsgJ1wnLicsICF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkpOwoKICAgICAgaWYgKHRoaXMuYWN0aW9ucyAmJiB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV0pIHsKICAgICAgICB2YXIgc2hvdWxkQnViYmxlID0gdGhpcy5hY3Rpb25zW2FjdGlvbk5hbWVdLmFwcGx5KHRoaXMsIGFyZ3MpID09PSB0cnVlOwogICAgICAgIGlmICghc2hvdWxkQnViYmxlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgdGFyZ2V0ID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3RhcmdldCcpOwogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgKHRydWUgJiYgISh0eXBlb2YgdGFyZ2V0LnNlbmQgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGB0YXJnZXRgIGZvciAnICsgdGhpcyArICcgKCcgKyB0YXJnZXQgKyAnKSBkb2VzIG5vdCBoYXZlIGEgYHNlbmRgIG1ldGhvZCcsIHR5cGVvZiB0YXJnZXQuc2VuZCA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgICAgICB0YXJnZXQuc2VuZC5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gQWN0aW9uSGFuZGxlcjsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL2FycmF5JywgWydleHBvcnRzJywgJ0BlbWJlci9kZXByZWNhdGVkLWZlYXR1cmVzJywgJ2VtYmVyLXV0aWxzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvZW51bWVyYWJsZScsICdlbWJlci1ydW50aW1lL2xpYi9jb21wYXJlJywgJ2VtYmVyLWVudmlyb25tZW50JywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9vYnNlcnZhYmxlJywgJ2VtYmVyLXJ1bnRpbWUvbGliL2NvcHknLCAnQGVtYmVyL2Vycm9yJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9tdXRhYmxlX2VudW1lcmFibGUnLCAnZW1iZXItcnVudGltZS9saWIvdHlwZS1vZiddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlcHJlY2F0ZWRGZWF0dXJlcywgX2VtYmVyVXRpbHMsIF9lbWJlck1ldGFsLCBfZGVidWcsIF9lbnVtZXJhYmxlLCBfY29tcGFyZSwgX2VtYmVyRW52aXJvbm1lbnQsIF9vYnNlcnZhYmxlLCBfY29weSwgX2Vycm9yLCBfbXV0YWJsZV9lbnVtZXJhYmxlLCBfdHlwZU9mKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLk11dGFibGVBcnJheSA9IGV4cG9ydHMuTmF0aXZlQXJyYXkgPSBleHBvcnRzLkEgPSB1bmRlZmluZWQ7CiAgZXhwb3J0cy5pc0VtYmVyQXJyYXkgPSBpc0VtYmVyQXJyYXk7CiAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnk7CiAgZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKICBleHBvcnRzLnJlbW92ZUF0ID0gcmVtb3ZlQXQ7CgogIHZhciBfTWl4aW4kY3JlYXRlLCBfTmF0aXZlQXJyYXk7CgogIHZhciBFTVBUWV9BUlJBWSA9IE9iamVjdC5mcmVlemUoW10pOwogIHZhciBFTUJFUl9BUlJBWSA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdFTUJFUl9BUlJBWScpOwoKICBmdW5jdGlvbiBpc0VtYmVyQXJyYXkob2JqKSB7CiAgICByZXR1cm4gb2JqICYmIG9ialtFTUJFUl9BUlJBWV07CiAgfQoKICB2YXIgaWRlbnRpdHlGdW5jdGlvbiA9IGZ1bmN0aW9uIChpdGVtKSB7CiAgICByZXR1cm4gaXRlbTsKICB9OwoKICBmdW5jdGlvbiB1bmlxQnkoYXJyYXkpIHsKICAgIHZhciBrZXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGlkZW50aXR5RnVuY3Rpb247CiAgICAodHJ1ZSAmJiAhKGlzQXJyYXkoYXJyYXkpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2ZpcnN0IGFyZ3VtZW50IHBhc3NlZCB0byBgdW5pcUJ5YCBzaG91bGQgYmUgYXJyYXknLCBpc0FycmF5KGFycmF5KSkpOwoKCiAgICB2YXIgcmV0ID0gQSgpOwogICAgdmFyIHNlZW4gPSBuZXcgU2V0KCk7CiAgICB2YXIgZ2V0dGVyID0gdHlwZW9mIGtleSA9PT0gJ2Z1bmN0aW9uJyA/IGtleSA6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpdGVtLCBrZXkpOwogICAgfTsKCiAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHZhciB2YWwgPSBnZXR0ZXIoaXRlbSk7CiAgICAgIGlmICghc2Vlbi5oYXModmFsKSkgewogICAgICAgIHNlZW4uYWRkKHZhbCk7CiAgICAgICAgcmV0LnB1c2goaXRlbSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiByZXQ7CiAgfQoKICBmdW5jdGlvbiBpdGVyKGtleSwgdmFsdWUpIHsKICAgIHZhciB2YWx1ZVByb3ZpZGVkID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMjsKICAgIHJldHVybiB2YWx1ZVByb3ZpZGVkID8gZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpdGVtLCBrZXkpOwogICAgfSA6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAhISgwLCBfZW1iZXJNZXRhbC5nZXQpKGl0ZW0sIGtleSk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZmluZEluZGV4KGFycmF5LCBwcmVkaWNhdGUsIHN0YXJ0QXQpIHsKICAgIHZhciBsZW4gPSBhcnJheS5sZW5ndGg7CiAgICBmb3IgKHZhciBpbmRleCA9IHN0YXJ0QXQ7IGluZGV4IDwgbGVuOyBpbmRleCsrKSB7CiAgICAgIHZhciBpdGVtID0gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KShhcnJheSwgaW5kZXgpOwogICAgICBpZiAocHJlZGljYXRlKGl0ZW0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIGZ1bmN0aW9uIGZpbmQoYXJyYXksIGNhbGxiYWNrLCB0YXJnZXQpIHsKICAgIHZhciBwcmVkaWNhdGUgPSBjYWxsYmFjay5iaW5kKHRhcmdldCk7CiAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgoYXJyYXksIHByZWRpY2F0ZSwgMCk7CiAgICByZXR1cm4gaW5kZXggPT09IC0xID8gdW5kZWZpbmVkIDogKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KShhcnJheSwgaW5kZXgpOwogIH0KCiAgZnVuY3Rpb24gYW55KGFycmF5LCBjYWxsYmFjaywgdGFyZ2V0KSB7CiAgICB2YXIgcHJlZGljYXRlID0gY2FsbGJhY2suYmluZCh0YXJnZXQpOwogICAgcmV0dXJuIGZpbmRJbmRleChhcnJheSwgcHJlZGljYXRlLCAwKSAhPT0gLTE7CiAgfQoKICBmdW5jdGlvbiBldmVyeShhcnJheSwgY2FsbGJhY2ssIHRhcmdldCkgewogICAgdmFyIGNiID0gY2FsbGJhY2suYmluZCh0YXJnZXQpOwogICAgdmFyIHByZWRpY2F0ZSA9IGZ1bmN0aW9uIChpdGVtLCBpbmRleCwgYXJyYXkpIHsKICAgICAgcmV0dXJuICFjYihpdGVtLCBpbmRleCwgYXJyYXkpOwogICAgfTsKICAgIHJldHVybiBmaW5kSW5kZXgoYXJyYXksIHByZWRpY2F0ZSwgMCkgPT09IC0xOwogIH0KCiAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgdmFsKSB7CiAgICB2YXIgc3RhcnRBdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogMDsKICAgIHZhciB3aXRoTmFOQ2hlY2sgPSBhcmd1bWVudHNbM107CgogICAgdmFyIGxlbiA9IGFycmF5Lmxlbmd0aDsKCiAgICBpZiAoc3RhcnRBdCA8IDApIHsKICAgICAgc3RhcnRBdCArPSBsZW47CiAgICB9CgogICAgLy8gU2FtZVZhbHVlWmVybyBjb21wYXJpc29uIChOYU4gIT09IE5hTikKICAgIHZhciBwcmVkaWNhdGUgPSB3aXRoTmFOQ2hlY2sgJiYgdmFsICE9PSB2YWwgPyBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbSAhPT0gaXRlbTsKICAgIH0gOiBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbSA9PT0gdmFsOwogICAgfTsKICAgIHJldHVybiBmaW5kSW5kZXgoYXJyYXksIHByZWRpY2F0ZSwgc3RhcnRBdCk7CiAgfQoKICAvKioKICAgIFJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIG9iamVjdCBpcyBhbiBhcnJheSBvciBBcnJheS1saWtlLgogIAogICAgT2JqZWN0cyBhcmUgY29uc2lkZXJlZCBBcnJheS1saWtlIGlmIGFueSBvZiB0aGUgZm9sbG93aW5nIGFyZSB0cnVlOgogIAogICAgICAtIHRoZSBvYmplY3QgaXMgYSBuYXRpdmUgQXJyYXkKICAgICAgLSB0aGUgb2JqZWN0IGhhcyBhbiBvYmplY3RBdCBwcm9wZXJ0eQogICAgICAtIHRoZSBvYmplY3QgaXMgYW4gT2JqZWN0LCBhbmQgaGFzIGEgbGVuZ3RoIHByb3BlcnR5CiAgCiAgICBVbmxpa2UgYHR5cGVPZmAgdGhpcyBtZXRob2QgcmV0dXJucyB0cnVlIGV2ZW4gaWYgdGhlIHBhc3NlZCBvYmplY3QgaXMKICAgIG5vdCBmb3JtYWxseSBhbiBhcnJheSBidXQgYXBwZWFycyB0byBiZSBhcnJheS1saWtlIChpLmUuIGltcGxlbWVudHMgYEFycmF5YCkKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGlzQXJyYXkgfSBmcm9tICdAZW1iZXIvYXJyYXknOwogICAgaW1wb3J0IEFycmF5UHJveHkgZnJvbSAnQGVtYmVyL2FycmF5L3Byb3h5JzsKICAKICAgIGlzQXJyYXkoKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZhbHNlCiAgICBpc0FycmF5KFtdKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnVlCiAgICBpc0FycmF5KEFycmF5UHJveHkuY3JlYXRlKHsgY29udGVudDogW10gfSkpOyAgICAvLyB0cnVlCiAgICBgYGAKICAKICAgIEBtZXRob2QgaXNBcnJheQogICAgQHN0YXRpYwogICAgQGZvciBAZW1iZXIvYXJyYXkKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byB0ZXN0CiAgICBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBwYXNzZWQgb2JqZWN0IGlzIGFuIGFycmF5IG9yIEFycmF5LWxpa2UKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGlzQXJyYXkoX29iaikgewogICAgdmFyIG9iaiA9IF9vYmo7CiAgICBpZiAodHJ1ZSAmJiBfZW1iZXJVdGlscy5IQVNfTkFUSVZFX1BST1hZICYmIHR5cGVvZiBfb2JqID09PSAnb2JqZWN0JyAmJiBfb2JqICE9PSBudWxsKSB7CiAgICAgIHZhciBwb3NzaWJsZVByb3h5Q29udGVudCA9IF9vYmpbX2VtYmVyTWV0YWwuUFJPWFlfQ09OVEVOVF07CiAgICAgIGlmIChwb3NzaWJsZVByb3h5Q29udGVudCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgb2JqID0gcG9zc2libGVQcm94eUNvbnRlbnQ7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIW9iaiB8fCBvYmouc2V0SW50ZXJ2YWwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChBcnJheU1peGluLmRldGVjdChvYmopKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciB0eXBlID0gKDAsIF90eXBlT2YudHlwZU9mKShvYmopOwogICAgaWYgKCdhcnJheScgPT09IHR5cGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgIGlmICh0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPT09IGxlbmd0aCAmJiAnb2JqZWN0JyA9PT0gdHlwZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBBUlJBWQogIC8vCiAgLyoqCiAgICBUaGlzIG1peGluIGltcGxlbWVudHMgT2JzZXJ2ZXItZnJpZW5kbHkgQXJyYXktbGlrZSBiZWhhdmlvci4gSXQgaXMgbm90IGEKICAgIGNvbmNyZXRlIGltcGxlbWVudGF0aW9uLCBidXQgaXQgY2FuIGJlIHVzZWQgdXAgYnkgb3RoZXIgY2xhc3NlcyB0aGF0IHdhbnQKICAgIHRvIGFwcGVhciBsaWtlIGFycmF5cy4KICAKICAgIEZvciBleGFtcGxlLCBBcnJheVByb3h5IGlzIGEgY29uY3JldGUgY2xhc3NlcyB0aGF0IGNhbgogICAgYmUgaW5zdGFudGlhdGVkIHRvIGltcGxlbWVudCBhcnJheS1saWtlIGJlaGF2aW9yLiBCb3RoIG9mIHRoZXNlIGNsYXNzZXMgdXNlCiAgICB0aGUgQXJyYXkgTWl4aW4gYnkgd2F5IG9mIHRoZSBNdXRhYmxlQXJyYXkgbWl4aW4sIHdoaWNoIGFsbG93cyBvYnNlcnZhYmxlCiAgICBjaGFuZ2VzIHRvIGJlIG1hZGUgdG8gdGhlIHVuZGVybHlpbmcgYXJyYXkuCiAgCiAgICBUaGlzIG1peGluIGRlZmluZXMgbWV0aG9kcyBzcGVjaWZpY2FsbHkgZm9yIGNvbGxlY3Rpb25zIHRoYXQgcHJvdmlkZQogICAgaW5kZXgtb3JkZXJlZCBhY2Nlc3MgdG8gdGhlaXIgY29udGVudHMuIFdoZW4geW91IGFyZSBkZXNpZ25pbmcgY29kZSB0aGF0CiAgICBuZWVkcyB0byBhY2NlcHQgYW55IGtpbmQgb2YgQXJyYXktbGlrZSBvYmplY3QsIHlvdSBzaG91bGQgdXNlIHRoZXNlIG1ldGhvZHMKICAgIGluc3RlYWQgb2YgQXJyYXkgcHJpbWl0aXZlcyBiZWNhdXNlIHRoZXNlIHdpbGwgcHJvcGVybHkgbm90aWZ5IG9ic2VydmVycyBvZgogICAgY2hhbmdlcyB0byB0aGUgYXJyYXkuCiAgCiAgICBBbHRob3VnaCB0aGVzZSBtZXRob2RzIGFyZSBlZmZpY2llbnQsIHRoZXkgZG8gYWRkIGEgbGF5ZXIgb2YgaW5kaXJlY3Rpb24gdG8KICAgIHlvdXIgYXBwbGljYXRpb24gc28gaXQgaXMgYSBnb29kIGlkZWEgdG8gdXNlIHRoZW0gb25seSB3aGVuIHlvdSBuZWVkIHRoZQogICAgZmxleGliaWxpdHkgb2YgdXNpbmcgYm90aCB0cnVlIEphdmFTY3JpcHQgYXJyYXlzIGFuZCAidmlydHVhbCIgYXJyYXlzIHN1Y2gKICAgIGFzIGNvbnRyb2xsZXJzIGFuZCBjb2xsZWN0aW9ucy4KICAKICAgIFlvdSBjYW4gdXNlIHRoZSBtZXRob2RzIGRlZmluZWQgaW4gdGhpcyBtb2R1bGUgdG8gYWNjZXNzIGFuZCBtb2RpZnkgYXJyYXkKICAgIGNvbnRlbnRzIGluIGEgS1ZPLWZyaWVuZGx5IHdheS4gWW91IGNhbiBhbHNvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIHRoZQogICAgbWVtYmVyc2hpcCBvZiBhbiBhcnJheSBjaGFuZ2VzIGJ5IHVzaW5nIGAub2JzZXJ2ZXMoJ215QXJyYXkuW10nKWAuCiAgCiAgICBUbyBzdXBwb3J0IGBFbWJlckFycmF5YCBpbiB5b3VyIG93biBjbGFzcywgeW91IG11c3Qgb3ZlcnJpZGUgdHdvCiAgICBwcmltaXRpdmVzIHRvIHVzZSBpdDogYGxlbmd0aCgpYCBhbmQgYG9iamVjdEF0KClgLgogIAogICAgQGNsYXNzIEVtYmVyQXJyYXkKICAgIEB1c2VzIEVudW1lcmFibGUKICAgIEBzaW5jZSBFbWJlciAwLjkuMAogICAgQHB1YmxpYwogICovCiAgdmFyIEFycmF5TWl4aW4gPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoX2VudW1lcmFibGUuZGVmYXVsdCwgKF9NaXhpbiRjcmVhdGUgPSB7fSwgX01peGluJGNyZWF0ZVtFTUJFUl9BUlJBWV0gPSB0cnVlLCBfTWl4aW4kY3JlYXRlLmxlbmd0aCA9IG51bGwsIF9NaXhpbiRjcmVhdGUub2JqZWN0QXQgPSBmdW5jdGlvbiAoaWR4KSB7CiAgICBpZiAoaWR4IDwgMCB8fCBpZHggPj0gdGhpcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KCiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgaWR4KTsKICB9LCBfTWl4aW4kY3JlYXRlLm9iamVjdHNBdCA9IGZ1bmN0aW9uIChpbmRleGVzKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHJldHVybiBpbmRleGVzLm1hcChmdW5jdGlvbiAoaWR4KSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwub2JqZWN0QXQpKF90aGlzLCBpZHgpOwogICAgfSk7CiAgfSwgX01peGluJGNyZWF0ZVsnW10nXSA9ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoewogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdGhpcy5yZXBsYWNlKDAsIHRoaXMubGVuZ3RoLCB2YWx1ZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pLCBfTWl4aW4kY3JlYXRlLmZpcnN0T2JqZWN0ID0gKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKShmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KSh0aGlzLCAwKTsKICB9KS5yZWFkT25seSgpLCBfTWl4aW4kY3JlYXRlLmxhc3RPYmplY3QgPSAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwub2JqZWN0QXQpKHRoaXMsIHRoaXMubGVuZ3RoIC0gMSk7CiAgfSkucmVhZE9ubHkoKSwgX01peGluJGNyZWF0ZS5zbGljZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBiZWdpbkluZGV4ID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAwOwogICAgdmFyIGVuZEluZGV4ID0gYXJndW1lbnRzWzFdOwoKICAgIHZhciByZXQgPSBBKCk7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgogICAgaWYgKGJlZ2luSW5kZXggPCAwKSB7CiAgICAgIGJlZ2luSW5kZXggPSBsZW5ndGggKyBiZWdpbkluZGV4OwogICAgfQoKICAgIGlmIChlbmRJbmRleCA9PT0gdW5kZWZpbmVkIHx8IGVuZEluZGV4ID4gbGVuZ3RoKSB7CiAgICAgIGVuZEluZGV4ID0gbGVuZ3RoOwogICAgfSBlbHNlIGlmIChlbmRJbmRleCA8IDApIHsKICAgICAgZW5kSW5kZXggPSBsZW5ndGggKyBlbmRJbmRleDsKICAgIH0KCiAgICB3aGlsZSAoYmVnaW5JbmRleCA8IGVuZEluZGV4KSB7CiAgICAgIHJldFtyZXQubGVuZ3RoXSA9ICgwLCBfZW1iZXJNZXRhbC5vYmplY3RBdCkodGhpcywgYmVnaW5JbmRleCsrKTsKICAgIH0KCiAgICByZXR1cm4gcmV0OwogIH0sIF9NaXhpbiRjcmVhdGUuaW5kZXhPZiA9IGZ1bmN0aW9uIChvYmplY3QsIHN0YXJ0QXQpIHsKICAgIHJldHVybiBpbmRleE9mKHRoaXMsIG9iamVjdCwgc3RhcnRBdCwgZmFsc2UpOwogIH0sIF9NaXhpbiRjcmVhdGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiAob2JqZWN0LCBzdGFydEF0KSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgogICAgaWYgKHN0YXJ0QXQgPT09IHVuZGVmaW5lZCB8fCBzdGFydEF0ID49IGxlbikgewogICAgICBzdGFydEF0ID0gbGVuIC0gMTsKICAgIH0KCiAgICBpZiAoc3RhcnRBdCA8IDApIHsKICAgICAgc3RhcnRBdCArPSBsZW47CiAgICB9CgogICAgZm9yICh2YXIgaWR4ID0gc3RhcnRBdDsgaWR4ID49IDA7IGlkeC0tKSB7CiAgICAgIGlmICgoMCwgX2VtYmVyTWV0YWwub2JqZWN0QXQpKHRoaXMsIGlkeCkgPT09IG9iamVjdCkgewogICAgICAgIHJldHVybiBpZHg7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gLTE7CiAgfSwgX01peGluJGNyZWF0ZS5hZGRBcnJheU9ic2VydmVyID0gZnVuY3Rpb24gKHRhcmdldCwgb3B0cykgewogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5hZGRBcnJheU9ic2VydmVyKSh0aGlzLCB0YXJnZXQsIG9wdHMpOwogIH0sIF9NaXhpbiRjcmVhdGUucmVtb3ZlQXJyYXlPYnNlcnZlciA9IGZ1bmN0aW9uICh0YXJnZXQsIG9wdHMpIHsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwucmVtb3ZlQXJyYXlPYnNlcnZlcikodGhpcywgdGFyZ2V0LCBvcHRzKTsKICB9LCBfTWl4aW4kY3JlYXRlLmhhc0FycmF5T2JzZXJ2ZXJzID0gKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKShmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmhhc0xpc3RlbmVycykodGhpcywgJ0BhcnJheTpjaGFuZ2UnKSB8fCAoMCwgX2VtYmVyTWV0YWwuaGFzTGlzdGVuZXJzKSh0aGlzLCAnQGFycmF5OmJlZm9yZScpOwogIH0pLCBfTWl4aW4kY3JlYXRlLmFycmF5Q29udGVudFdpbGxDaGFuZ2UgPSBmdW5jdGlvbiAoc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmFycmF5Q29udGVudFdpbGxDaGFuZ2UpKHRoaXMsIHN0YXJ0SWR4LCByZW1vdmVBbXQsIGFkZEFtdCk7CiAgfSwgX01peGluJGNyZWF0ZS5hcnJheUNvbnRlbnREaWRDaGFuZ2UgPSBmdW5jdGlvbiAoc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KSB7CiAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLmFycmF5Q29udGVudERpZENoYW5nZSkodGhpcywgc3RhcnRJZHgsIHJlbW92ZUFtdCwgYWRkQW10KTsKICB9LCBfTWl4aW4kY3JlYXRlLmZvckVhY2ggPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgZm9yRWFjaGAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CgogICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICB2YXIgaXRlbSA9IHRoaXMub2JqZWN0QXQoaW5kZXgpOwogICAgICBjYWxsYmFjay5jYWxsKHRhcmdldCwgaXRlbSwgaW5kZXgsIHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sIF9NaXhpbiRjcmVhdGUuZ2V0RWFjaCA9ICgwLCBfZW1iZXJNZXRhbC5hbGlhc01ldGhvZCkoJ21hcEJ5JyksIF9NaXhpbiRjcmVhdGUuc2V0RWFjaCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuc2V0KShpdGVtLCBrZXksIHZhbHVlKTsKICAgIH0pOwogIH0sIF9NaXhpbiRjcmVhdGUubWFwID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICB2YXIgdGFyZ2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwogICAgKHRydWUgJiYgISh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnYG1hcGAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICB2YXIgcmV0ID0gQSgpOwoKICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAoeCwgaWR4LCBpKSB7CiAgICAgIHJldHVybiByZXRbaWR4XSA9IGNhbGxiYWNrLmNhbGwodGFyZ2V0LCB4LCBpZHgsIGkpOwogICAgfSk7CgogICAgcmV0dXJuIHJldDsKICB9LCBfTWl4aW4kY3JlYXRlLm1hcEJ5ID0gZnVuY3Rpb24gKGtleSkgewogICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChuZXh0KSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShuZXh0LCBrZXkpOwogICAgfSk7CiAgfSwgX01peGluJGNyZWF0ZS5maWx0ZXIgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgZmlsdGVyYCBleHBlY3RzIGEgZnVuY3Rpb24gYXMgZmlyc3QgYXJndW1lbnQuJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CgoKICAgIHZhciByZXQgPSBBKCk7CgogICAgdGhpcy5mb3JFYWNoKGZ1bmN0aW9uICh4LCBpZHgsIGkpIHsKICAgICAgaWYgKGNhbGxiYWNrLmNhbGwodGFyZ2V0LCB4LCBpZHgsIGkpKSB7CiAgICAgICAgcmV0LnB1c2goeCk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiByZXQ7CiAgfSwgX01peGluJGNyZWF0ZS5yZWplY3QgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgcmVqZWN0YCBleHBlY3RzIGEgZnVuY3Rpb24gYXMgZmlyc3QgYXJndW1lbnQuJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CgogICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICFjYWxsYmFjay5hcHBseSh0YXJnZXQsIGFyZ3VtZW50cyk7CiAgICB9KTsKICB9LCBfTWl4aW4kY3JlYXRlLmZpbHRlckJ5ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZmlsdGVyKGl0ZXIuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLnJlamVjdEJ5ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMucmVqZWN0KGl0ZXIuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLmZpbmQgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgZmluZGAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgIHJldHVybiBmaW5kKHRoaXMsIGNhbGxiYWNrLCB0YXJnZXQpOwogIH0sIF9NaXhpbiRjcmVhdGUuZmluZEJ5ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZmluZChpdGVyLmFwcGx5KHVuZGVmaW5lZCwgYXJndW1lbnRzKSk7CiAgfSwgX01peGluJGNyZWF0ZS5ldmVyeSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgdmFyIHRhcmdldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogbnVsbDsKICAgICh0cnVlICYmICEodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2BldmVyeWAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGZpcnN0IGFyZ3VtZW50LicsIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykpOwoKICAgIHJldHVybiBldmVyeSh0aGlzLCBjYWxsYmFjaywgdGFyZ2V0KTsKICB9LCBfTWl4aW4kY3JlYXRlLmlzRXZlcnkgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5ldmVyeShpdGVyLmFwcGx5KHVuZGVmaW5lZCwgYXJndW1lbnRzKSk7CiAgfSwgX01peGluJGNyZWF0ZS5hbnkgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IG51bGw7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgYW55YCBleHBlY3RzIGEgZnVuY3Rpb24gYXMgZmlyc3QgYXJndW1lbnQuJywgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSk7CgogICAgcmV0dXJuIGFueSh0aGlzLCBjYWxsYmFjaywgdGFyZ2V0KTsKICB9LCBfTWl4aW4kY3JlYXRlLmlzQW55ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYW55KGl0ZXIuYXBwbHkodW5kZWZpbmVkLCBhcmd1bWVudHMpKTsKICB9LCBfTWl4aW4kY3JlYXRlLnJlZHVjZSA9IGZ1bmN0aW9uIChjYWxsYmFjaywgaW5pdGlhbFZhbHVlLCByZWR1Y2VyUHJvcGVydHkpIHsKICAgICh0cnVlICYmICEodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ2ByZWR1Y2VgIGV4cGVjdHMgYSBmdW5jdGlvbiBhcyBmaXJzdCBhcmd1bWVudC4nLCB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpKTsKCgogICAgdmFyIHJldCA9IGluaXRpYWxWYWx1ZTsKCiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGkpIHsKICAgICAgcmV0ID0gY2FsbGJhY2socmV0LCBpdGVtLCBpLCB0aGlzLCByZWR1Y2VyUHJvcGVydHkpOwogICAgfSwgdGhpcyk7CgogICAgcmV0dXJuIHJldDsKICB9LCBfTWl4aW4kY3JlYXRlLmludm9rZSA9IGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CgogICAgdmFyIHJldCA9IEEoKTsKCiAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24gKHgsIGlkeCkgewogICAgICB2YXIgbWV0aG9kID0geCAmJiB4W21ldGhvZE5hbWVdOwoKICAgICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBtZXRob2QpIHsKICAgICAgICByZXRbaWR4XSA9IGFyZ3MubGVuZ3RoID8gbWV0aG9kLmFwcGx5KHgsIGFyZ3MpIDogeFttZXRob2ROYW1lXSgpOwogICAgICB9CiAgICB9LCB0aGlzKTsKCiAgICByZXR1cm4gcmV0OwogIH0sIF9NaXhpbiRjcmVhdGUudG9BcnJheSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbTsKICAgIH0pOwogIH0sIF9NaXhpbiRjcmVhdGUuY29tcGFjdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9IG51bGw7CiAgICB9KTsKICB9LCBfTWl4aW4kY3JlYXRlLmluY2x1ZGVzID0gZnVuY3Rpb24gKG9iamVjdCwgc3RhcnRBdCkgewogICAgcmV0dXJuIGluZGV4T2YodGhpcywgb2JqZWN0LCBzdGFydEF0LCB0cnVlKSAhPT0gLTE7CiAgfSwgX01peGluJGNyZWF0ZS5zb3J0QnkgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc29ydEtleXMgPSBhcmd1bWVudHM7CgogICAgcmV0dXJuIHRoaXMudG9BcnJheSgpLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0S2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBrZXkgPSBzb3J0S2V5c1tpXTsKICAgICAgICB2YXIgcHJvcEEgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShhLCBrZXkpOwogICAgICAgIHZhciBwcm9wQiA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKGIsIGtleSk7CiAgICAgICAgLy8gcmV0dXJuIDEgb3IgLTEgZWxzZSBjb250aW51ZSB0byB0aGUgbmV4dCBzb3J0S2V5CiAgICAgICAgdmFyIGNvbXBhcmVWYWx1ZSA9ICgwLCBfY29tcGFyZS5kZWZhdWx0KShwcm9wQSwgcHJvcEIpOwoKICAgICAgICBpZiAoY29tcGFyZVZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0pOwogIH0sIF9NaXhpbiRjcmVhdGUudW5pcSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1bmlxQnkodGhpcyk7CiAgfSwgX01peGluJGNyZWF0ZS51bmlxQnkgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICByZXR1cm4gdW5pcUJ5KHRoaXMsIGtleSk7CiAgfSwgX01peGluJGNyZWF0ZS53aXRob3V0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICBpZiAoIXRoaXMuaW5jbHVkZXModmFsdWUpKSB7CiAgICAgIHJldHVybiB0aGlzOyAvLyBub3RoaW5nIHRvIGRvCiAgICB9CgogICAgLy8gU2FtZVZhbHVlWmVybyBjb21wYXJpc29uIChOYU4gIT09IE5hTikKICAgIHZhciBwcmVkaWNhdGUgPSB2YWx1ZSA9PT0gdmFsdWUgPyBmdW5jdGlvbiAoaXRlbSkgewogICAgICByZXR1cm4gaXRlbSAhPT0gdmFsdWU7CiAgICB9IDogZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgcmV0dXJuIGl0ZW0gPT09IGl0ZW07CiAgICB9OwogICAgcmV0dXJuIHRoaXMuZmlsdGVyKHByZWRpY2F0ZSk7CiAgfSwgX01peGluJGNyZWF0ZVsnQGVhY2gnXSA9IF9kZXByZWNhdGVkRmVhdHVyZXMuQVJSQVlfQVRfRUFDSCA/ICgwLCBfZW1iZXJNZXRhbC5jb21wdXRlZCkoZnVuY3Rpb24gKCkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdHZXR0aW5nIHRoZSBcJ0BlYWNoXCcgcHJvcGVydHkgb24gb2JqZWN0ICcgKyAoMCwgX2VtYmVyVXRpbHMudG9TdHJpbmcpKHRoaXMpICsgJyBpcyBkZXByZWNhdGVkJywgZmFsc2UsIHsKICAgICAgaWQ6ICdlbWJlci1tZXRhbC5nZXR0aW5nLWVhY2gnLAogICAgICB1bnRpbDogJzMuNS4wJywKICAgICAgdXJsOiAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjMueCN0b2NfZ2V0dGluZy10aGUtZWFjaC1wcm9wZXJ0eScKICAgIH0pKTsKCgogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5lYWNoUHJveHlGb3IpKHRoaXMpOwogIH0pLnJlYWRPbmx5KCkgOiB1bmRlZmluZWQsIF9NaXhpbiRjcmVhdGUpKTsKCiAgdmFyIE9VVF9PRl9SQU5HRV9FWENFUFRJT04gPSAnSW5kZXggb3V0IG9mIHJhbmdlJzsKCiAgZnVuY3Rpb24gcmVtb3ZlQXQoYXJyYXksIHN0YXJ0LCBsZW4pIHsKICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIHN0YXJ0KSB7CiAgICAgIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gYXJyYXkubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KE9VVF9PRl9SQU5HRV9FWENFUFRJT04pOwogICAgICB9CgogICAgICAvLyBmYXN0IGNhc2UKICAgICAgaWYgKGxlbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGVuID0gMTsKICAgICAgfQoKICAgICAgYXJyYXkucmVwbGFjZShzdGFydCwgbGVuLCBFTVBUWV9BUlJBWSk7CiAgICB9CgogICAgcmV0dXJuIGFycmF5OwogIH0KCiAgLyoqCiAgICBUaGlzIG1peGluIGRlZmluZXMgdGhlIEFQSSBmb3IgbW9kaWZ5aW5nIGFycmF5LWxpa2Ugb2JqZWN0cy4gVGhlc2UgbWV0aG9kcwogICAgY2FuIGJlIGFwcGxpZWQgb25seSB0byBhIGNvbGxlY3Rpb24gdGhhdCBrZWVwcyBpdHMgaXRlbXMgaW4gYW4gb3JkZXJlZCBzZXQuCiAgICBJdCBidWlsZHMgdXBvbiB0aGUgQXJyYXkgbWl4aW4gYW5kIGFkZHMgbWV0aG9kcyB0byBtb2RpZnkgdGhlIGFycmF5LgogICAgT25lIGNvbmNyZXRlIGltcGxlbWVudGF0aW9ucyBvZiB0aGlzIGNsYXNzIGluY2x1ZGUgQXJyYXlQcm94eS4KICAKICAgIEl0IGlzIGltcG9ydGFudCB0byB1c2UgdGhlIG1ldGhvZHMgaW4gdGhpcyBjbGFzcyB0byBtb2RpZnkgYXJyYXlzIHNvIHRoYXQKICAgIGNoYW5nZXMgYXJlIG9ic2VydmFibGUuIFRoaXMgYWxsb3dzIHRoZSBiaW5kaW5nIHN5c3RlbSBpbiBFbWJlciB0byBmdW5jdGlvbgogICAgY29ycmVjdGx5LgogIAogIAogICAgTm90ZSB0aGF0IGFuIEFycmF5IGNhbiBjaGFuZ2UgZXZlbiBpZiBpdCBkb2VzIG5vdCBpbXBsZW1lbnQgdGhpcyBtaXhpbi4KICAgIEZvciBleGFtcGxlLCBvbmUgbWlnaHQgaW1wbGVtZW50IGEgU3BhcnNlQXJyYXkgdGhhdCBjYW5ub3QgYmUgZGlyZWN0bHkKICAgIG1vZGlmaWVkLCBidXQgaWYgaXRzIHVuZGVybHlpbmcgZW51bWVyYWJsZSBjaGFuZ2VzLCBpdCB3aWxsIGNoYW5nZSBhbHNvLgogIAogICAgQGNsYXNzIE11dGFibGVBcnJheQogICAgQHVzZXMgRW1iZXJBcnJheQogICAgQHVzZXMgTXV0YWJsZUVudW1lcmFibGUKICAgIEBwdWJsaWMKICAqLwoKICB2YXIgTXV0YWJsZUFycmF5ID0gX2VtYmVyTWV0YWwuTWl4aW4uY3JlYXRlKEFycmF5TWl4aW4sIF9tdXRhYmxlX2VudW1lcmFibGUuZGVmYXVsdCwgewogICAgLyoqCiAgICAgIF9fUmVxdWlyZWQuX18gWW91IG11c3QgaW1wbGVtZW50IHRoaXMgbWV0aG9kIHRvIGFwcGx5IHRoaXMgbWl4aW4uCiAgICAgICBUaGlzIGlzIG9uZSBvZiB0aGUgcHJpbWl0aXZlcyB5b3UgbXVzdCBpbXBsZW1lbnQgdG8gc3VwcG9ydCBgQXJyYXlgLgogICAgICBZb3Ugc2hvdWxkIHJlcGxhY2UgYW10IG9iamVjdHMgc3RhcnRlZCBhdCBpZHggd2l0aCB0aGUgb2JqZWN0cyBpbiB0aGUKICAgICAgcGFzc2VkIGFycmF5LiBZb3Ugc2hvdWxkIGFsc28gY2FsbCBgdGhpcy5hcnJheUNvbnRlbnREaWRDaGFuZ2UoKWAKICAgICAgIEBtZXRob2QgcmVwbGFjZQogICAgICBAcGFyYW0ge051bWJlcn0gaWR4IFN0YXJ0aW5nIGluZGV4IGluIHRoZSBhcnJheSB0byByZXBsYWNlLiBJZgogICAgICAgIGlkeCA+PSBsZW5ndGgsIHRoZW4gYXBwZW5kIHRvIHRoZSBlbmQgb2YgdGhlIGFycmF5LgogICAgICBAcGFyYW0ge051bWJlcn0gYW10IE51bWJlciBvZiBlbGVtZW50cyB0aGF0IHNob3VsZCBiZSByZW1vdmVkIGZyb20KICAgICAgICB0aGUgYXJyYXksIHN0YXJ0aW5nIGF0ICppZHgqLgogICAgICBAcGFyYW0ge0VtYmVyQXJyYXl9IG9iamVjdHMgQW4gYXJyYXkgb2YgemVybyBvciBtb3JlIG9iamVjdHMgdGhhdCBzaG91bGQgYmUKICAgICAgICBpbnNlcnRlZCBpbnRvIHRoZSBhcnJheSBhdCAqaWR4KgogICAgICBAcHVibGljCiAgICAqLwogICAgcmVwbGFjZTogbnVsbCwKCiAgICBjbGVhcjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgdGhpcy5yZXBsYWNlKDAsIGxlbiwgRU1QVFlfQVJSQVkpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBpbnNlcnRBdDogZnVuY3Rpb24gKGlkeCwgb2JqZWN0KSB7CiAgICAgIGlmIChpZHggPiB0aGlzLmxlbmd0aCkgewogICAgICAgIHRocm93IG5ldyBfZXJyb3IuZGVmYXVsdChPVVRfT0ZfUkFOR0VfRVhDRVBUSU9OKTsKICAgICAgfQoKICAgICAgdGhpcy5yZXBsYWNlKGlkeCwgMCwgW29iamVjdF0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZW1vdmVBdDogZnVuY3Rpb24gKHN0YXJ0LCBsZW4pIHsKICAgICAgcmV0dXJuIHJlbW92ZUF0KHRoaXMsIHN0YXJ0LCBsZW4pOwogICAgfSwKICAgIHB1c2hPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdGhpcy5pbnNlcnRBdCh0aGlzLmxlbmd0aCwgb2JqKTsKICAgICAgcmV0dXJuIG9iajsKICAgIH0sCiAgICBwdXNoT2JqZWN0czogZnVuY3Rpb24gKG9iamVjdHMpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdHMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTXVzdCBwYXNzIEVudW1lcmFibGUgdG8gTXV0YWJsZUFycmF5I3B1c2hPYmplY3RzJyk7CiAgICAgIH0KICAgICAgdGhpcy5yZXBsYWNlKHRoaXMubGVuZ3RoLCAwLCBvYmplY3RzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcG9wT2JqZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aDsKICAgICAgaWYgKGxlbiA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgcmV0ID0gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KSh0aGlzLCBsZW4gLSAxKTsKICAgICAgdGhpcy5yZW1vdmVBdChsZW4gLSAxLCAxKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICBzaGlmdE9iamVjdDogZnVuY3Rpb24gKCkgewogICAgICBpZiAodGhpcy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIHJldCA9ICgwLCBfZW1iZXJNZXRhbC5vYmplY3RBdCkodGhpcywgMCk7CiAgICAgIHRoaXMucmVtb3ZlQXQoMCk7CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgdW5zaGlmdE9iamVjdDogZnVuY3Rpb24gKG9iaikgewogICAgICB0aGlzLmluc2VydEF0KDAsIG9iaik7CiAgICAgIHJldHVybiBvYmo7CiAgICB9LAogICAgdW5zaGlmdE9iamVjdHM6IGZ1bmN0aW9uIChvYmplY3RzKSB7CiAgICAgIHRoaXMucmVwbGFjZSgwLCAwLCBvYmplY3RzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmV2ZXJzZU9iamVjdHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBpZiAobGVuID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIHZhciBvYmplY3RzID0gdGhpcy50b0FycmF5KCkucmV2ZXJzZSgpOwogICAgICB0aGlzLnJlcGxhY2UoMCwgbGVuLCBvYmplY3RzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2V0T2JqZWN0czogZnVuY3Rpb24gKG9iamVjdHMpIHsKICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2xlYXIoKTsKICAgICAgfQoKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICB0aGlzLnJlcGxhY2UoMCwgbGVuLCBvYmplY3RzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlT2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxlbmd0aCB8fCAwOwogICAgICB3aGlsZSAoLS1sb2MgPj0gMCkgewogICAgICAgIHZhciBjdXJPYmplY3QgPSAoMCwgX2VtYmVyTWV0YWwub2JqZWN0QXQpKHRoaXMsIGxvYyk7CgogICAgICAgIGlmIChjdXJPYmplY3QgPT09IG9iaikgewogICAgICAgICAgdGhpcy5yZW1vdmVBdChsb2MpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICByZW1vdmVPYmplY3RzOiBmdW5jdGlvbiAob2JqZWN0cykgewogICAgICAoMCwgX2VtYmVyTWV0YWwuYmVnaW5Qcm9wZXJ0eUNoYW5nZXMpKHRoaXMpOwogICAgICBmb3IgKHZhciBpID0gb2JqZWN0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIHRoaXMucmVtb3ZlT2JqZWN0KG9iamVjdHNbaV0pOwogICAgICB9CiAgICAgICgwLCBfZW1iZXJNZXRhbC5lbmRQcm9wZXJ0eUNoYW5nZXMpKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBhZGRPYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIGluY2x1ZGVkID0gdGhpcy5pbmNsdWRlcyhvYmopOwoKICAgICAgaWYgKCFpbmNsdWRlZCkgewogICAgICAgIHRoaXMucHVzaE9iamVjdChvYmopOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBhZGRPYmplY3RzOiBmdW5jdGlvbiAob2JqZWN0cykgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICgwLCBfZW1iZXJNZXRhbC5iZWdpblByb3BlcnR5Q2hhbmdlcykodGhpcyk7CiAgICAgIG9iamVjdHMuZm9yRWFjaChmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgcmV0dXJuIF90aGlzMi5hZGRPYmplY3Qob2JqKTsKICAgICAgfSk7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5lbmRQcm9wZXJ0eUNoYW5nZXMpKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKCiAgLyoqCiAgICBDcmVhdGVzIGFuIGBFbWJlci5OYXRpdmVBcnJheWAgZnJvbSBhbiBBcnJheS1saWtlIG9iamVjdC4KICAgIERvZXMgbm90IG1vZGlmeSB0aGUgb3JpZ2luYWwgb2JqZWN0J3MgY29udGVudHMuIGBBKClgIGlzIG5vdCBuZWVkZWQgaWYKICAgIGBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFU2AgaXMgYHRydWVgICh0aGUgZGVmYXVsdCB2YWx1ZSkuIEhvd2V2ZXIsCiAgICBpdCBpcyByZWNvbW1lbmRlZCB0aGF0IHlvdSB1c2UgYEEoKWAgd2hlbiBjcmVhdGluZyBhZGRvbnMgZm9yCiAgICBlbWJlciBvciB3aGVuIHlvdSBjYW4gbm90IGd1YXJhbnRlZSB0aGF0IGBFbWJlckVOVi5FWFRFTkRfUFJPVE9UWVBFU2AKICAgIHdpbGwgYmUgYHRydWVgLgogIAogICAgRXhhbXBsZQogIAogICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY29tcG9uZW50LmpzCiAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgdGFnTmFtZTogJ3VsJywKICAgICAgY2xhc3NOYW1lczogWydwYWdpbmF0aW9uJ10sCiAgCiAgICAgIGluaXQoKSB7CiAgICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAKICAgICAgICBpZiAoIXRoaXMuZ2V0KCdjb250ZW50JykpIHsKICAgICAgICAgIHRoaXMuc2V0KCdjb250ZW50JywgQSgpKTsKICAgICAgICAgIHRoaXMuc2V0KCdvdGhlckNvbnRlbnQnLCBBKFsxLDIsM10pKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIEEKICAgIEBzdGF0aWMKICAgIEBmb3IgQGVtYmVyL2FycmF5CiAgICBAcmV0dXJuIHtFbWJlci5OYXRpdmVBcnJheX0KICAgIEBwdWJsaWMKICAqLwoKICAvLyBBZGQgRW1iZXIuQXJyYXkgdG8gQXJyYXkucHJvdG90eXBlLiBSZW1vdmUgbWV0aG9kcyB3aXRoIG5hdGl2ZQogIC8vIGltcGxlbWVudGF0aW9ucyBhbmQgc3VwcGx5IHNvbWUgbW9yZSBvcHRpbWl6ZWQgdmVyc2lvbnMgb2YgZ2VuZXJpYyBtZXRob2RzCiAgLy8gYmVjYXVzZSB0aGV5IGFyZSBzbyBjb21tb24uCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgLyoqCiAgICBUaGUgTmF0aXZlQXJyYXkgbWl4aW4gY29udGFpbnMgdGhlIHByb3BlcnRpZXMgbmVlZGVkIHRvIG1ha2UgdGhlIG5hdGl2ZQogICAgQXJyYXkgc3VwcG9ydCBNdXRhYmxlQXJyYXkgYW5kIGFsbCBvZiBpdHMgZGVwZW5kZW50IEFQSXMuIFVubGVzcyB5b3UKICAgIGhhdmUgYEVtYmVyRU5WLkVYVEVORF9QUk9UT1RZUEVTYCBvciBgRW1iZXJFTlYuRVhURU5EX1BST1RPVFlQRVMuQXJyYXlgIHNldCB0bwogICAgZmFsc2UsIHRoaXMgd2lsbCBiZSBhcHBsaWVkIGF1dG9tYXRpY2FsbHkuIE90aGVyd2lzZSB5b3UgY2FuIGFwcGx5IHRoZSBtaXhpbgogICAgYXQgYW55dGltZSBieSBjYWxsaW5nIGBFbWJlci5OYXRpdmVBcnJheS5hcHBseShBcnJheS5wcm90b3R5cGUpYC4KICAKICAgIEBjbGFzcyBFbWJlci5OYXRpdmVBcnJheQogICAgQHVzZXMgTXV0YWJsZUFycmF5CiAgICBAdXNlcyBPYnNlcnZhYmxlCiAgICBAcHVibGljCiAgKi8KICB2YXIgTmF0aXZlQXJyYXkgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoTXV0YWJsZUFycmF5LCBfb2JzZXJ2YWJsZS5kZWZhdWx0LCB7CiAgICBvYmplY3RBdDogZnVuY3Rpb24gKGlkeCkgewogICAgICByZXR1cm4gdGhpc1tpZHhdOwogICAgfSwKICAgIHJlcGxhY2U6IGZ1bmN0aW9uIChzdGFydCwgZGVsZXRlQ291bnQpIHsKICAgICAgdmFyIGl0ZW1zID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBFTVBUWV9BUlJBWTsKICAgICAgKHRydWUgJiYgIShBcnJheS5pc0FycmF5KGl0ZW1zKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgdGhpcmQgYXJndW1lbnQgdG8gcmVwbGFjZSBuZWVkcyB0byBiZSBhbiBhcnJheS4nLCBBcnJheS5pc0FycmF5KGl0ZW1zKSkpOwoKCiAgICAgICgwLCBfZW1iZXJNZXRhbC5yZXBsYWNlSW5OYXRpdmVBcnJheSkodGhpcywgc3RhcnQsIGRlbGV0ZUNvdW50LCBpdGVtcyk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjb3B5OiBmdW5jdGlvbiAoZGVlcCkgewogICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkoJ1VzaW5nIGBOYXRpdmVBcnJheSNjb3B5YCBpcyBkZXByZWNhdGVkJywgZmFsc2UsIHsKICAgICAgICBpZDogJ2VtYmVyLXJ1bnRpbWUudXNpbmctYXJyYXktY29weScsCiAgICAgICAgdW50aWw6ICczLjUuMCcKICAgICAgfSkpOwoKCiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICByZXR1cm4gKDAsIF9jb3B5LmRlZmF1bHQpKGl0ZW0sIHRydWUpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5zbGljZSgpOwogICAgfQogIH0pOwoKICAvLyBSZW1vdmUgYW55IG1ldGhvZHMgaW1wbGVtZW50ZWQgbmF0aXZlbHkgc28gd2UgZG9uJ3Qgb3ZlcnJpZGUgdGhlbQogIHZhciBpZ25vcmUgPSBbJ2xlbmd0aCddOwogIE5hdGl2ZUFycmF5LmtleXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2ROYW1lKSB7CiAgICBpZiAoQXJyYXkucHJvdG90eXBlW21ldGhvZE5hbWVdKSB7CiAgICAgIGlnbm9yZS5wdXNoKG1ldGhvZE5hbWUpOwogICAgfQogIH0pOwoKICBleHBvcnRzLk5hdGl2ZUFycmF5ID0gTmF0aXZlQXJyYXkgPSAoX05hdGl2ZUFycmF5ID0gTmF0aXZlQXJyYXkpLndpdGhvdXQuYXBwbHkoX05hdGl2ZUFycmF5LCBpZ25vcmUpOwoKICB2YXIgQSA9IHZvaWQgMDsKCiAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5BcnJheSkgewogICAgTmF0aXZlQXJyYXkuYXBwbHkoQXJyYXkucHJvdG90eXBlKTsKICAgIGV4cG9ydHMuQSA9IEEgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICAgIHJldHVybiBhcnIgfHwgW107CiAgICB9OwogIH0gZWxzZSB7CiAgICBleHBvcnRzLkEgPSBBID0gZnVuY3Rpb24gKGFycikgewogICAgICBpZiAoIWFycikgewogICAgICAgIGFyciA9IFtdOwogICAgICB9CiAgICAgIHJldHVybiBBcnJheU1peGluLmRldGVjdChhcnIpID8gYXJyIDogTmF0aXZlQXJyYXkuYXBwbHkoYXJyKTsKICAgIH07CiAgfQoKICBleHBvcnRzLkEgPSBBOwogIGV4cG9ydHMuTmF0aXZlQXJyYXkgPSBOYXRpdmVBcnJheTsKICBleHBvcnRzLk11dGFibGVBcnJheSA9IE11dGFibGVBcnJheTsKICBleHBvcnRzLmRlZmF1bHQgPSBBcnJheU1peGluOwp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvY29tcGFyYWJsZScsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YWwpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgX19SZXF1aXJlZC5fXyBZb3UgbXVzdCBpbXBsZW1lbnQgdGhpcyBtZXRob2QgdG8gYXBwbHkgdGhpcyBtaXhpbi4KICAgICAgIE92ZXJyaWRlIHRvIHJldHVybiB0aGUgcmVzdWx0IG9mIHRoZSBjb21wYXJpc29uIG9mIHRoZSB0d28gcGFyYW1ldGVycy4gVGhlCiAgICAgIGNvbXBhcmUgbWV0aG9kIHNob3VsZCByZXR1cm46CiAgICAgICAtIGAtMWAgaWYgYGEgPCBiYAogICAgICAtIGAwYCBpZiBgYSA9PSBiYAogICAgICAtIGAxYCBpZiBgYSA+IGJgCiAgICAgICBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHJhaXNlcyBhbiBleGNlcHRpb24uCiAgICAgICBAbWV0aG9kIGNvbXBhcmUKICAgICAgQHBhcmFtIGEge09iamVjdH0gdGhlIGZpcnN0IG9iamVjdCB0byBjb21wYXJlCiAgICAgIEBwYXJhbSBiIHtPYmplY3R9IHRoZSBzZWNvbmQgb2JqZWN0IHRvIGNvbXBhcmUKICAgICAgQHJldHVybiB7TnVtYmVyfSB0aGUgcmVzdWx0IG9mIHRoZSBjb21wYXJpc29uCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgY29tcGFyZTogbnVsbAogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvY29udGFpbmVyX3Byb3h5JywgWydleHBvcnRzJywgJ0BlbWJlci9ydW5sb29wJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcnVubG9vcCwgX2VtYmVyTWV0YWwpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgQ29udGFpbmVyUHJveHlNaXhpbiBpcyB1c2VkIHRvIHByb3ZpZGUgcHVibGljIGFjY2VzcyB0byBzcGVjaWZpYwogICAgY29udGFpbmVyIGZ1bmN0aW9uYWxpdHkuCiAgCiAgICBAY2xhc3MgQ29udGFpbmVyUHJveHlNaXhpbgogICAgQHByaXZhdGUKICAqLwogIHZhciBjb250YWluZXJQcm94eU1peGluID0gewogICAgLyoqCiAgICAgVGhlIGNvbnRhaW5lciBzdG9yZXMgc3RhdGUuCiAgICAgIEBwcml2YXRlCiAgICAgQHByb3BlcnR5IHtFbWJlci5Db250YWluZXJ9IF9fY29udGFpbmVyX18KICAgICAqLwogICAgX19jb250YWluZXJfXzogbnVsbCwKCiAgICBvd25lckluamVjdGlvbjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fX2NvbnRhaW5lcl9fLm93bmVySW5qZWN0aW9uKCk7CiAgICB9LAogICAgbG9va3VwOiBmdW5jdGlvbiAoZnVsbE5hbWUsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX19jb250YWluZXJfXy5sb29rdXAoZnVsbE5hbWUsIG9wdGlvbnMpOwogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuX19jb250YWluZXJfXzsKCiAgICAgIGlmIChjb250YWluZXIpIHsKICAgICAgICAoMCwgX3J1bmxvb3Auam9pbikoZnVuY3Rpb24gKCkgewogICAgICAgICAgY29udGFpbmVyLmRlc3Ryb3koKTsKICAgICAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2Rlc3Ryb3knLCBjb250YWluZXIsICdmaW5hbGl6ZURlc3Ryb3knKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5fc3VwZXIoKTsKICAgIH0sCiAgICBmYWN0b3J5Rm9yOiBmdW5jdGlvbiAoZnVsbE5hbWUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwoKICAgICAgcmV0dXJuIHRoaXMuX19jb250YWluZXJfXy5mYWN0b3J5Rm9yKGZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0KICB9OwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZShjb250YWluZXJQcm94eU1peGluKTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL2NvcHlhYmxlJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyTWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIC8qKgogICAgICBfX1JlcXVpcmVkLl9fIFlvdSBtdXN0IGltcGxlbWVudCB0aGlzIG1ldGhvZCB0byBhcHBseSB0aGlzIG1peGluLgogICAgICAgT3ZlcnJpZGUgdG8gcmV0dXJuIGEgY29weSBvZiB0aGUgcmVjZWl2ZXIuIERlZmF1bHQgaW1wbGVtZW50YXRpb24gcmFpc2VzCiAgICAgIGFuIGV4Y2VwdGlvbi4KICAgICAgIEBtZXRob2QgY29weQogICAgICBAcGFyYW0ge0Jvb2xlYW59IGRlZXAgaWYgYHRydWVgLCBhIGRlZXAgY29weSBvZiB0aGUgb2JqZWN0IHNob3VsZCBiZSBtYWRlCiAgICAgIEByZXR1cm4ge09iamVjdH0gY29weSBvZiByZWNlaXZlcgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGNvcHk6IG51bGwKICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL2VudW1lcmFibGUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoKTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL2V2ZW50ZWQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgIFN1YnNjcmliZXMgdG8gYSBuYW1lZCBldmVudCB3aXRoIGdpdmVuIGZ1bmN0aW9uLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBwZXJzb24ub24oJ2RpZExvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAvLyBmaXJlZCBvbmNlIHRoZSBwZXJzb24gaGFzIGxvYWRlZAogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBBbiBvcHRpb25hbCB0YXJnZXQgY2FuIGJlIHBhc3NlZCBpbiBhcyB0aGUgMm5kIGFyZ3VtZW50IHRoYXQgd2lsbAogICAgICBiZSBzZXQgYXMgdGhlICJ0aGlzIiBmb3IgdGhlIGNhbGxiYWNrLiBUaGlzIGlzIGEgZ29vZCB3YXkgdG8gZ2l2ZSB5b3VyCiAgICAgIGZ1bmN0aW9uIGFjY2VzcyB0byB0aGUgb2JqZWN0IHRyaWdnZXJpbmcgdGhlIGV2ZW50LiBXaGVuIHRoZSB0YXJnZXQKICAgICAgcGFyYW1ldGVyIGlzIHVzZWQgdGhlIGNhbGxiYWNrIGJlY29tZXMgdGhlIHRoaXJkIGFyZ3VtZW50LgogICAgICAgQG1ldGhvZCBvbgogICAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAgQHBhcmFtIHtPYmplY3R9IFt0YXJnZXRdIFRoZSAidGhpcyIgYmluZGluZyBmb3IgdGhlIGNhbGxiYWNrCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IG1ldGhvZCBUaGUgY2FsbGJhY2sgdG8gZXhlY3V0ZQogICAgICBAcmV0dXJuIHRoaXMKICAgICAgQHB1YmxpYwogICAgKi8KICAgIG9uOiBmdW5jdGlvbiAobmFtZSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLmFkZExpc3RlbmVyKSh0aGlzLCBuYW1lLCB0YXJnZXQsIG1ldGhvZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgLyoqCiAgICAgIFN1YnNjcmliZXMgYSBmdW5jdGlvbiB0byBhIG5hbWVkIGV2ZW50IGFuZCB0aGVuIGNhbmNlbHMgdGhlIHN1YnNjcmlwdGlvbgogICAgICBhZnRlciB0aGUgZmlyc3QgdGltZSB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkLiBJdCBpcyBnb29kIHRvIHVzZSBgYG9uZWBgIHdoZW4KICAgICAgeW91IG9ubHkgY2FyZSBhYm91dCB0aGUgZmlyc3QgdGltZSBhbiBldmVudCBoYXMgdGFrZW4gcGxhY2UuCiAgICAgICBUaGlzIGZ1bmN0aW9uIHRha2VzIGFuIG9wdGlvbmFsIDJuZCBhcmd1bWVudCB0aGF0IHdpbGwgYmVjb21lIHRoZSAidGhpcyIKICAgICAgdmFsdWUgZm9yIHRoZSBjYWxsYmFjay4gSWYgdGhpcyBhcmd1bWVudCBpcyBwYXNzZWQgdGhlbiB0aGUgM3JkIGFyZ3VtZW50CiAgICAgIGJlY29tZXMgdGhlIGZ1bmN0aW9uLgogICAgICAgQG1ldGhvZCBvbmUKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSBUaGUgInRoaXMiIGJpbmRpbmcgZm9yIHRoZSBjYWxsYmFjawogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgICAgQHJldHVybiB0aGlzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBvbmU6IGZ1bmN0aW9uIChuYW1lLCB0YXJnZXQsIG1ldGhvZCkgewogICAgICBpZiAoIW1ldGhvZCkgewogICAgICAgIG1ldGhvZCA9IHRhcmdldDsKICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICB9CgogICAgICAoMCwgX2VtYmVyTWV0YWwuYWRkTGlzdGVuZXIpKHRoaXMsIG5hbWUsIHRhcmdldCwgbWV0aG9kLCB0cnVlKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgVHJpZ2dlcnMgYSBuYW1lZCBldmVudCBmb3IgdGhlIG9iamVjdC4gQW55IGFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICAgIHdpbGwgYmUgcGFzc2VkIGFzIHBhcmFtZXRlcnMgdG8gdGhlIGZ1bmN0aW9ucyB0aGF0IGFyZSBzdWJzY3JpYmVkIHRvIHRoZQogICAgICBldmVudC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcGVyc29uLm9uKCdkaWRFYXQnLCBmdW5jdGlvbihmb29kKSB7CiAgICAgICAgY29uc29sZS5sb2coJ3BlcnNvbiBhdGUgc29tZSAnICsgZm9vZCk7CiAgICAgIH0pOwogICAgICAgcGVyc29uLnRyaWdnZXIoJ2RpZEVhdCcsICdicm9jY29saScpOwogICAgICAgLy8gb3V0cHV0czogcGVyc29uIGF0ZSBzb21lIGJyb2Njb2xpCiAgICAgIGBgYAogICAgICBAbWV0aG9kIHRyaWdnZXIKICAgICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgIEBwYXJhbSB7T2JqZWN0Li4ufSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBwYXNzIG9uCiAgICAgIEBwdWJsaWMKICAgICovCiAgICB0cmlnZ2VyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgKDAsIF9lbWJlck1ldGFsLnNlbmRFdmVudCkodGhpcywgbmFtZSwgYXJncyk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQ2FuY2VscyBzdWJzY3JpcHRpb24gZm9yIGdpdmVuIG5hbWUsIHRhcmdldCwgYW5kIG1ldGhvZC4KICAgICAgIEBtZXRob2Qgb2ZmCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgICBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2YgdGhlIHN1YnNjcmlwdGlvbgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBtZXRob2QgVGhlIGZ1bmN0aW9uIG9mIHRoZSBzdWJzY3JpcHRpb24KICAgICAgQHJldHVybiB0aGlzCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBvZmY6IGZ1bmN0aW9uIChuYW1lLCB0YXJnZXQsIG1ldGhvZCkgewogICAgICAoMCwgX2VtYmVyTWV0YWwucmVtb3ZlTGlzdGVuZXIpKHRoaXMsIG5hbWUsIHRhcmdldCwgbWV0aG9kKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgQ2hlY2tzIHRvIHNlZSBpZiBvYmplY3QgaGFzIGFueSBzdWJzY3JpcHRpb25zIGZvciBuYW1lZCBldmVudC4KICAgICAgIEBtZXRob2QgaGFzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBldmVudAogICAgICBAcmV0dXJuIHtCb29sZWFufSBkb2VzIHRoZSBvYmplY3QgaGF2ZSBhIHN1YnNjcmlwdGlvbiBmb3IgZXZlbnQKICAgICAgQHB1YmxpYwogICAgICovCiAgICBoYXM6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuaGFzTGlzdGVuZXJzKSh0aGlzLCBuYW1lKTsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL211dGFibGVfZW51bWVyYWJsZScsIFsnZXhwb3J0cycsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvZW51bWVyYWJsZScsICdlbWJlci1tZXRhbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VudW1lcmFibGUsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoX2VudW1lcmFibGUuZGVmYXVsdCk7Cn0pOwplbmlmZWQoJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9vYnNlcnZhYmxlJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YWwsIF9kZWJ1ZykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyTWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIC8qKgogICAgICBSZXRyaWV2ZXMgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgZnJvbSB0aGUgb2JqZWN0LgogICAgICAgVGhpcyBtZXRob2QgaXMgdXN1YWxseSBzaW1pbGFyIHRvIHVzaW5nIGBvYmplY3Rba2V5TmFtZV1gIG9yIGBvYmplY3Qua2V5TmFtZWAsCiAgICAgIGhvd2V2ZXIgaXQgc3VwcG9ydHMgYm90aCBjb21wdXRlZCBwcm9wZXJ0aWVzIGFuZCB0aGUgdW5rbm93blByb3BlcnR5CiAgICAgIGhhbmRsZXIuCiAgICAgICBCZWNhdXNlIGBnZXRgIHVuaWZpZXMgdGhlIHN5bnRheCBmb3IgYWNjZXNzaW5nIGFsbCB0aGVzZSBraW5kcwogICAgICBvZiBwcm9wZXJ0aWVzLCBpdCBjYW4gbWFrZSBtYW55IHJlZmFjdG9yaW5ncyBlYXNpZXIsIHN1Y2ggYXMgcmVwbGFjaW5nIGEKICAgICAgc2ltcGxlIHByb3BlcnR5IHdpdGggYSBjb21wdXRlZCBwcm9wZXJ0eSwgb3IgdmljZSB2ZXJzYS4KICAgICAgICMjIyBDb21wdXRlZCBQcm9wZXJ0aWVzCiAgICAgICBDb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBtZXRob2RzIGRlZmluZWQgd2l0aCB0aGUgYHByb3BlcnR5YCBtb2RpZmllcgogICAgICBkZWNsYXJlZCBhdCB0aGUgZW5kLCBzdWNoIGFzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgZnVsbE5hbWU6IGNvbXB1dGVkKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2ZpcnN0TmFtZScpICsgJyAnICsgdGhpcy5nZXQoJ2xhc3ROYW1lJyk7CiAgICAgIH0pCiAgICAgIGBgYAogICAgICAgV2hlbiB5b3UgY2FsbCBgZ2V0YCBvbiBhIGNvbXB1dGVkIHByb3BlcnR5LCB0aGUgZnVuY3Rpb24gd2lsbCBiZQogICAgICBjYWxsZWQgYW5kIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIHRoZSBmdW5jdGlvbgogICAgICBpdHNlbGYuCiAgICAgICAjIyMgVW5rbm93biBQcm9wZXJ0aWVzCiAgICAgICBMaWtld2lzZSwgaWYgeW91IHRyeSB0byBjYWxsIGBnZXRgIG9uIGEgcHJvcGVydHkgd2hvc2UgdmFsdWUgaXMKICAgICAgYHVuZGVmaW5lZGAsIHRoZSBgdW5rbm93blByb3BlcnR5KClgIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCBvbiB0aGUgb2JqZWN0LgogICAgICBJZiB0aGlzIG1ldGhvZCByZXR1cm5zIGFueSB2YWx1ZSBvdGhlciB0aGFuIGB1bmRlZmluZWRgLCBpdCB3aWxsIGJlIHJldHVybmVkCiAgICAgIGluc3RlYWQuIFRoaXMgYWxsb3dzIHlvdSB0byBpbXBsZW1lbnQgInZpcnR1YWwiIHByb3BlcnRpZXMgdGhhdCBhcmUKICAgICAgbm90IGRlZmluZWQgdXBmcm9udC4KICAgICAgIEBtZXRob2QgZ2V0CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSB0byByZXRyaWV2ZQogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBwcm9wZXJ0eSB2YWx1ZSBvciB1bmRlZmluZWQuCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCBrZXlOYW1lKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBUbyBnZXQgdGhlIHZhbHVlcyBvZiBtdWx0aXBsZSBwcm9wZXJ0aWVzIGF0IG9uY2UsIGNhbGwgYGdldFByb3BlcnRpZXNgCiAgICAgIHdpdGggYSBsaXN0IG9mIHN0cmluZ3Mgb3IgYW4gYXJyYXk6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHJlY29yZC5nZXRQcm9wZXJ0aWVzKCdmaXJzdE5hbWUnLCAnbGFzdE5hbWUnLCAnemlwQ29kZScpOwogICAgICAvLyB7IGZpcnN0TmFtZTogJ0pvaG4nLCBsYXN0TmFtZTogJ0RvZScsIHppcENvZGU6ICcxMDAxMScgfQogICAgICBgYGAKICAgICAgIGlzIGVxdWl2YWxlbnQgdG86CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHJlY29yZC5nZXRQcm9wZXJ0aWVzKFsnZmlyc3ROYW1lJywgJ2xhc3ROYW1lJywgJ3ppcENvZGUnXSk7CiAgICAgIC8vIHsgZmlyc3ROYW1lOiAnSm9obicsIGxhc3ROYW1lOiAnRG9lJywgemlwQ29kZTogJzEwMDExJyB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBnZXRQcm9wZXJ0aWVzCiAgICAgIEBwYXJhbSB7U3RyaW5nLi4ufEFycmF5fSBsaXN0IG9mIGtleXMgdG8gZ2V0CiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGdldFByb3BlcnRpZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICByZXR1cm4gX2VtYmVyTWV0YWwuZ2V0UHJvcGVydGllcy5hcHBseSh1bmRlZmluZWQsIFt0aGlzXS5jb25jYXQoYXJncykpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFNldHMgdGhlIHByb3ZpZGVkIGtleSBvciBwYXRoIHRvIHRoZSB2YWx1ZS4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcmVjb3JkLnNldCgia2V5IiwgdmFsdWUpOwogICAgICBgYGAKICAgICAgIFRoaXMgbWV0aG9kIGlzIGdlbmVyYWxseSB2ZXJ5IHNpbWlsYXIgdG8gY2FsbGluZyBgb2JqZWN0WyJrZXkiXSA9IHZhbHVlYCBvcgogICAgICBgb2JqZWN0LmtleSA9IHZhbHVlYCwgZXhjZXB0IHRoYXQgaXQgcHJvdmlkZXMgc3VwcG9ydCBmb3IgY29tcHV0ZWQKICAgICAgcHJvcGVydGllcywgdGhlIGBzZXRVbmtub3duUHJvcGVydHkoKWAgbWV0aG9kIGFuZCBwcm9wZXJ0eSBvYnNlcnZlcnMuCiAgICAgICAjIyMgQ29tcHV0ZWQgUHJvcGVydGllcwogICAgICAgSWYgeW91IHRyeSB0byBzZXQgYSB2YWx1ZSBvbiBhIGtleSB0aGF0IGhhcyBhIGNvbXB1dGVkIHByb3BlcnR5IGhhbmRsZXIKICAgICAgZGVmaW5lZCAoc2VlIHRoZSBgZ2V0KClgIG1ldGhvZCBmb3IgYW4gZXhhbXBsZSksIHRoZW4gYHNldCgpYCB3aWxsIGNhbGwKICAgICAgdGhhdCBtZXRob2QsIHBhc3NpbmcgYm90aCB0aGUgdmFsdWUgYW5kIGtleSBpbnN0ZWFkIG9mIHNpbXBseSBjaGFuZ2luZwogICAgICB0aGUgdmFsdWUgaXRzZWxmLiBUaGlzIGlzIHVzZWZ1bCBmb3IgdGhvc2UgdGltZXMgd2hlbiB5b3UgbmVlZCB0bwogICAgICBpbXBsZW1lbnQgYSBwcm9wZXJ0eSB0aGF0IGlzIGNvbXBvc2VkIG9mIG9uZSBvciBtb3JlIG1lbWJlcgogICAgICBwcm9wZXJ0aWVzLgogICAgICAgIyMjIFVua25vd24gUHJvcGVydGllcwogICAgICAgSWYgeW91IHRyeSB0byBzZXQgYSB2YWx1ZSBvbiBhIGtleSB0aGF0IGlzIHVuZGVmaW5lZCBpbiB0aGUgdGFyZ2V0CiAgICAgIG9iamVjdCwgdGhlbiB0aGUgYHNldFVua25vd25Qcm9wZXJ0eSgpYCBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkIGluc3RlYWQuIFRoaXMKICAgICAgZ2l2ZXMgeW91IGFuIG9wcG9ydHVuaXR5IHRvIGltcGxlbWVudCBjb21wbGV4ICJ2aXJ0dWFsIiBwcm9wZXJ0aWVzIHRoYXQKICAgICAgYXJlIG5vdCBwcmVkZWZpbmVkIG9uIHRoZSBvYmplY3QuIElmIGBzZXRVbmtub3duUHJvcGVydHkoKWAgcmV0dXJucwogICAgICB1bmRlZmluZWQsIHRoZW4gYHNldCgpYCB3aWxsIHNpbXBseSBzZXQgdGhlIHZhbHVlIG9uIHRoZSBvYmplY3QuCiAgICAgICAjIyMgUHJvcGVydHkgT2JzZXJ2ZXJzCiAgICAgICBJbiBhZGRpdGlvbiB0byBjaGFuZ2luZyB0aGUgcHJvcGVydHksIGBzZXQoKWAgd2lsbCBhbHNvIHJlZ2lzdGVyIGEgcHJvcGVydHkKICAgICAgY2hhbmdlIHdpdGggdGhlIG9iamVjdC4gVW5sZXNzIHlvdSBoYXZlIHBsYWNlZCB0aGlzIGNhbGwgaW5zaWRlIG9mIGEKICAgICAgYGJlZ2luUHJvcGVydHlDaGFuZ2VzKClgIGFuZCBgZW5kUHJvcGVydHlDaGFuZ2VzKCksYCBhbnkgImxvY2FsIiBvYnNlcnZlcnMKICAgICAgKGkuZS4gb2JzZXJ2ZXIgbWV0aG9kcyBkZWNsYXJlZCBvbiB0aGUgc2FtZSBvYmplY3QpLCB3aWxsIGJlIGNhbGxlZAogICAgICBpbW1lZGlhdGVseS4gQW55ICJyZW1vdGUiIG9ic2VydmVycyAoaS5lLiBvYnNlcnZlciBtZXRob2RzIGRlY2xhcmVkIG9uCiAgICAgIGFub3RoZXIgb2JqZWN0KSB3aWxsIGJlIHBsYWNlZCBpbiBhIHF1ZXVlIGFuZCBjYWxsZWQgYXQgYSBsYXRlciB0aW1lIGluIGEKICAgICAgY29hbGVzY2VkIG1hbm5lci4KICAgICAgIEBtZXRob2Qgc2V0CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBwcm9wZXJ0eSB0byBzZXQKICAgICAgQHBhcmFtIHtPYmplY3R9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQgb3IgYG51bGxgLgogICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBwYXNzZWQgdmFsdWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNldDogZnVuY3Rpb24gKGtleU5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCBrZXlOYW1lLCB2YWx1ZSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgU2V0cyBhIGxpc3Qgb2YgcHJvcGVydGllcyBhdCBvbmNlLiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBzZXQgaW5zaWRlCiAgICAgIGEgc2luZ2xlIGBiZWdpblByb3BlcnR5Q2hhbmdlc2AgYW5kIGBlbmRQcm9wZXJ0eUNoYW5nZXNgIGJhdGNoLCBzbwogICAgICBvYnNlcnZlcnMgd2lsbCBiZSBidWZmZXJlZC4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgcmVjb3JkLnNldFByb3BlcnRpZXMoeyBmaXJzdE5hbWU6ICdDaGFybGVzJywgbGFzdE5hbWU6ICdKb2xsZXknIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2V0UHJvcGVydGllcwogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaCB0aGUgaGFzaCBvZiBrZXlzIGFuZCB2YWx1ZXMgdG8gc2V0CiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIHBhc3NlZCBpbiBoYXNoCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbiAoaGFzaCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLnNldFByb3BlcnRpZXMpKHRoaXMsIGhhc2gpOwogICAgfSwKCgogICAgLyoqCiAgICAgIEJlZ2lucyBhIGdyb3VwaW5nIG9mIHByb3BlcnR5IGNoYW5nZXMuCiAgICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBncm91cCBwcm9wZXJ0eSBjaGFuZ2VzIHNvIHRoYXQgbm90aWZpY2F0aW9ucwogICAgICB3aWxsIG5vdCBiZSBzZW50IHVudGlsIHRoZSBjaGFuZ2VzIGFyZSBmaW5pc2hlZC4gSWYgeW91IHBsYW4gdG8gbWFrZSBhCiAgICAgIGxhcmdlIG51bWJlciBvZiBjaGFuZ2VzIHRvIGFuIG9iamVjdCBhdCBvbmUgdGltZSwgeW91IHNob3VsZCBjYWxsIHRoaXMKICAgICAgbWV0aG9kIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNoYW5nZXMgdG8gYmVnaW4gZGVmZXJyaW5nIGNoYW5nZQogICAgICBub3RpZmljYXRpb25zLiBXaGVuIHlvdSBhcmUgZG9uZSBtYWtpbmcgY2hhbmdlcywgY2FsbAogICAgICBgZW5kUHJvcGVydHlDaGFuZ2VzKClgIHRvIGRlbGl2ZXIgdGhlIGRlZmVycmVkIGNoYW5nZSBub3RpZmljYXRpb25zIGFuZCBlbmQKICAgICAgZGVmZXJyaW5nLgogICAgICAgQG1ldGhvZCBiZWdpblByb3BlcnR5Q2hhbmdlcwogICAgICBAcmV0dXJuIHtPYnNlcnZhYmxlfQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGJlZ2luUHJvcGVydHlDaGFuZ2VzOiBmdW5jdGlvbiAoKSB7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5iZWdpblByb3BlcnR5Q2hhbmdlcykoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgRW5kcyBhIGdyb3VwaW5nIG9mIHByb3BlcnR5IGNoYW5nZXMuCiAgICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBncm91cCBwcm9wZXJ0eSBjaGFuZ2VzIHNvIHRoYXQgbm90aWZpY2F0aW9ucwogICAgICB3aWxsIG5vdCBiZSBzZW50IHVudGlsIHRoZSBjaGFuZ2VzIGFyZSBmaW5pc2hlZC4gSWYgeW91IHBsYW4gdG8gbWFrZSBhCiAgICAgIGxhcmdlIG51bWJlciBvZiBjaGFuZ2VzIHRvIGFuIG9iamVjdCBhdCBvbmUgdGltZSwgeW91IHNob3VsZCBjYWxsCiAgICAgIGBiZWdpblByb3BlcnR5Q2hhbmdlcygpYCBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjaGFuZ2VzIHRvIGRlZmVyIGNoYW5nZQogICAgICBub3RpZmljYXRpb25zLiBXaGVuIHlvdSBhcmUgZG9uZSBtYWtpbmcgY2hhbmdlcywgY2FsbCB0aGlzIG1ldGhvZCB0bwogICAgICBkZWxpdmVyIHRoZSBkZWZlcnJlZCBjaGFuZ2Ugbm90aWZpY2F0aW9ucyBhbmQgZW5kIGRlZmVycmluZy4KICAgICAgIEBtZXRob2QgZW5kUHJvcGVydHlDaGFuZ2VzCiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZW5kUHJvcGVydHlDaGFuZ2VzOiBmdW5jdGlvbiAoKSB7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5lbmRQcm9wZXJ0eUNoYW5nZXMpKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgLyoqCiAgICAgIEBtZXRob2QgcHJvcGVydHlXaWxsQ2hhbmdlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgcHJvcGVydHlXaWxsQ2hhbmdlOiBmdW5jdGlvbiAoa2V5TmFtZSkgewogICAgICAoMCwgX2VtYmVyTWV0YWwucHJvcGVydHlXaWxsQ2hhbmdlKSh0aGlzLCBrZXlOYW1lKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgQG1ldGhvZCBwcm9wZXJ0eURpZENoYW5nZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHByb3BlcnR5RGlkQ2hhbmdlOiBmdW5jdGlvbiAoa2V5TmFtZSkgewogICAgICAoMCwgX2VtYmVyTWV0YWwucHJvcGVydHlEaWRDaGFuZ2UpKHRoaXMsIGtleU5hbWUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIC8qKgogICAgICBOb3RpZnkgdGhlIG9ic2VydmVyIHN5c3RlbSB0aGF0IGEgcHJvcGVydHkgaGFzIGp1c3QgY2hhbmdlZC4KICAgICAgIFNvbWV0aW1lcyB5b3UgbmVlZCB0byBjaGFuZ2UgYSB2YWx1ZSBkaXJlY3RseSBvciBpbmRpcmVjdGx5IHdpdGhvdXQKICAgICAgYWN0dWFsbHkgY2FsbGluZyBgZ2V0KClgIG9yIGBzZXQoKWAgb24gaXQuIEluIHRoaXMgY2FzZSwgeW91IGNhbiB1c2UgdGhpcwogICAgICBtZXRob2QgaW5zdGVhZC4gQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIG5vdGlmeSBhbGwgb2JzZXJ2ZXJzIHRoYXQgdGhlCiAgICAgIHByb3BlcnR5IGhhcyBwb3RlbnRpYWxseSBjaGFuZ2VkIHZhbHVlLgogICAgICAgQG1ldGhvZCBub3RpZnlQcm9wZXJ0eUNoYW5nZQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgcHJvcGVydHkga2V5IHRvIGJlIG5vdGlmaWVkIGFib3V0LgogICAgICBAcmV0dXJuIHtPYnNlcnZhYmxlfQogICAgICBAcHVibGljCiAgICAqLwogICAgbm90aWZ5UHJvcGVydHlDaGFuZ2U6IGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSkodGhpcywga2V5TmFtZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgLyoqCiAgICAgIEFkZHMgYW4gb2JzZXJ2ZXIgb24gYSBwcm9wZXJ0eS4KICAgICAgIFRoaXMgaXMgdGhlIGNvcmUgbWV0aG9kIHVzZWQgdG8gcmVnaXN0ZXIgYW4gb2JzZXJ2ZXIgZm9yIGEgcHJvcGVydHkuCiAgICAgICBPbmNlIHlvdSBjYWxsIHRoaXMgbWV0aG9kLCBhbnkgdGltZSB0aGUga2V5J3MgdmFsdWUgaXMgc2V0LCB5b3VyIG9ic2VydmVyCiAgICAgIHdpbGwgYmUgbm90aWZpZWQuIE5vdGUgdGhhdCB0aGUgb2JzZXJ2ZXJzIGFyZSB0cmlnZ2VyZWQgYW55IHRpbWUgdGhlCiAgICAgIHZhbHVlIGlzIHNldCwgcmVnYXJkbGVzcyBvZiB3aGV0aGVyIGl0IGhhcyBhY3R1YWxseSBjaGFuZ2VkLiBZb3VyCiAgICAgIG9ic2VydmVyIHNob3VsZCBiZSBwcmVwYXJlZCB0byBoYW5kbGUgdGhhdC4KICAgICAgICMjIyBPYnNlcnZlciBNZXRob2RzCiAgICAgICBPYnNlcnZlciBtZXRob2RzIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmU6CiAgICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGluaXQoKSB7CiAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICAgdGhpcy5hZGRPYnNlcnZlcignZm9vJywgdGhpcywgJ2Zvb0RpZENoYW5nZScpOwogICAgICAgIH0sCiAgICAgICAgIGZvb0RpZENoYW5nZShzZW5kZXIsIGtleSwgdmFsdWUsIHJldikgewogICAgICAgICAgLy8geW91ciBjb2RlCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGUgYHNlbmRlcmAgaXMgdGhlIG9iamVjdCB0aGF0IGNoYW5nZWQuIFRoZSBga2V5YCBpcyB0aGUgcHJvcGVydHkgdGhhdAogICAgICBjaGFuZ2VzLiBUaGUgYHZhbHVlYCBwcm9wZXJ0eSBpcyBjdXJyZW50bHkgcmVzZXJ2ZWQgYW5kIHVudXNlZC4gVGhlIGByZXZgCiAgICAgIGlzIHRoZSBsYXN0IHByb3BlcnR5IHJldmlzaW9uIG9mIHRoZSBvYmplY3Qgd2hlbiBpdCBjaGFuZ2VkLCB3aGljaCB5b3UgY2FuCiAgICAgIHVzZSB0byBkZXRlY3QgaWYgdGhlIGtleSB2YWx1ZSBoYXMgcmVhbGx5IGNoYW5nZWQgb3Igbm90LgogICAgICAgVXN1YWxseSB5b3Ugd2lsbCBub3QgbmVlZCB0aGUgdmFsdWUgb3IgcmV2aXNpb24gcGFyYW1ldGVycyBhdAogICAgICB0aGUgZW5kLiBJbiB0aGlzIGNhc2UsIGl0IGlzIGNvbW1vbiB0byB3cml0ZSBvYnNlcnZlciBtZXRob2RzIHRoYXQgdGFrZQogICAgICBvbmx5IGEgc2VuZGVyIGFuZCBrZXkgdmFsdWUgYXMgcGFyYW1ldGVycyBvciwgaWYgeW91IGFyZW4ndCBpbnRlcmVzdGVkIGluCiAgICAgIGFueSBvZiB0aGVzZSB2YWx1ZXMsIHRvIHdyaXRlIGFuIG9ic2VydmVyIHRoYXQgaGFzIG5vIHBhcmFtZXRlcnMgYXQgYWxsLgogICAgICAgQG1ldGhvZCBhZGRPYnNlcnZlcgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgdG8gb2JzZXJ2ZQogICAgICBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2JqZWN0IHRvIGludm9rZQogICAgICBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlCiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24gKGtleSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLmFkZE9ic2VydmVyKSh0aGlzLCBrZXksIHRhcmdldCwgbWV0aG9kKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgUmVtb3ZlIGFuIG9ic2VydmVyIHlvdSBoYXZlIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCBvbiB0aGlzIG9iamVjdC4gUGFzcwogICAgICB0aGUgc2FtZSBrZXksIHRhcmdldCwgYW5kIG1ldGhvZCB5b3UgcGFzc2VkIHRvIGBhZGRPYnNlcnZlcigpYCBhbmQgeW91cgogICAgICB0YXJnZXQgd2lsbCBubyBsb25nZXIgcmVjZWl2ZSBub3RpZmljYXRpb25zLgogICAgICAgQG1ldGhvZCByZW1vdmVPYnNlcnZlcgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgdG8gb2JzZXJ2ZQogICAgICBAcGFyYW0ge09iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2JqZWN0IHRvIGludm9rZQogICAgICBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gbWV0aG9kIFRoZSBtZXRob2QgdG8gaW52b2tlCiAgICAgIEByZXR1cm4ge09ic2VydmFibGV9CiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24gKGtleSwgdGFyZ2V0LCBtZXRob2QpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLnJlbW92ZU9ic2VydmVyKSh0aGlzLCBrZXksIHRhcmdldCwgbWV0aG9kKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKCiAgICAvKioKICAgICAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIG9iamVjdCBjdXJyZW50bHkgaGFzIG9ic2VydmVycyByZWdpc3RlcmVkIGZvciBhCiAgICAgIHBhcnRpY3VsYXIga2V5LiBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBwb3RlbnRpYWxseSBkZWZlciBwZXJmb3JtaW5nCiAgICAgIGFuIGV4cGVuc2l2ZSBhY3Rpb24gdW50aWwgc29tZW9uZSBiZWdpbnMgb2JzZXJ2aW5nIGEgcGFydGljdWxhciBwcm9wZXJ0eQogICAgICBvbiB0aGUgb2JqZWN0LgogICAgICAgQG1ldGhvZCBoYXNPYnNlcnZlckZvcgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5IEtleSB0byBjaGVjawogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGhhc09ic2VydmVyRm9yOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuaGFzTGlzdGVuZXJzKSh0aGlzLCBrZXkgKyAnOmNoYW5nZScpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBwcm9wZXJ0eSwgb3IgYSBkZWZhdWx0IHZhbHVlIGluIHRoZSBjYXNlIHRoYXQgdGhlCiAgICAgIHByb3BlcnR5IHJldHVybnMgYHVuZGVmaW5lZGAuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHBlcnNvbi5nZXRXaXRoRGVmYXVsdCgnbGFzdE5hbWUnLCAnRG9lJyk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBnZXRXaXRoRGVmYXVsdAogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gcmV0cmlldmUKICAgICAgQHBhcmFtIHtPYmplY3R9IGRlZmF1bHRWYWx1ZSBUaGUgdmFsdWUgdG8gcmV0dXJuIGlmIHRoZSBwcm9wZXJ0eSB2YWx1ZSBpcyB1bmRlZmluZWQKICAgICAgQHJldHVybiB7T2JqZWN0fSBUaGUgcHJvcGVydHkgdmFsdWUgb3IgdGhlIGRlZmF1bHRWYWx1ZS4KICAgICAgQHB1YmxpYwogICAgKi8KICAgIGdldFdpdGhEZWZhdWx0OiBmdW5jdGlvbiAoa2V5TmFtZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0V2l0aERlZmF1bHQpKHRoaXMsIGtleU5hbWUsIGRlZmF1bHRWYWx1ZSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgU2V0IHRoZSB2YWx1ZSBvZiBhIHByb3BlcnR5IHRvIHRoZSBjdXJyZW50IHZhbHVlIHBsdXMgc29tZSBhbW91bnQuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHBlcnNvbi5pbmNyZW1lbnRQcm9wZXJ0eSgnYWdlJyk7CiAgICAgIHRlYW0uaW5jcmVtZW50UHJvcGVydHkoJ3Njb3JlJywgMik7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBpbmNyZW1lbnRQcm9wZXJ0eQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gaW5jcmVtZW50CiAgICAgIEBwYXJhbSB7TnVtYmVyfSBpbmNyZW1lbnQgVGhlIGFtb3VudCB0byBpbmNyZW1lbnQgYnkuIERlZmF1bHRzIHRvIDEKICAgICAgQHJldHVybiB7TnVtYmVyfSBUaGUgbmV3IHByb3BlcnR5IHZhbHVlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpbmNyZW1lbnRQcm9wZXJ0eTogZnVuY3Rpb24gKGtleU5hbWUpIHsKICAgICAgdmFyIGluY3JlbWVudCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogMTsKICAgICAgKHRydWUgJiYgISghaXNOYU4ocGFyc2VGbG9hdChpbmNyZW1lbnQpKSAmJiBpc0Zpbml0ZShpbmNyZW1lbnQpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ011c3QgcGFzcyBhIG51bWVyaWMgdmFsdWUgdG8gaW5jcmVtZW50UHJvcGVydHknLCAhaXNOYU4ocGFyc2VGbG9hdChpbmNyZW1lbnQpKSAmJiBpc0Zpbml0ZShpbmNyZW1lbnQpKSk7CgogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLnNldCkodGhpcywga2V5TmFtZSwgKHBhcnNlRmxvYXQoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywga2V5TmFtZSkpIHx8IDApICsgaW5jcmVtZW50KTsKICAgIH0sCgoKICAgIC8qKgogICAgICBTZXQgdGhlIHZhbHVlIG9mIGEgcHJvcGVydHkgdG8gdGhlIGN1cnJlbnQgdmFsdWUgbWludXMgc29tZSBhbW91bnQuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHBsYXllci5kZWNyZW1lbnRQcm9wZXJ0eSgnbGl2ZXMnKTsKICAgICAgb3JjLmRlY3JlbWVudFByb3BlcnR5KCdoZWFsdGgnLCA1KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGRlY3JlbWVudFByb3BlcnR5CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBkZWNyZW1lbnQKICAgICAgQHBhcmFtIHtOdW1iZXJ9IGRlY3JlbWVudCBUaGUgYW1vdW50IHRvIGRlY3JlbWVudCBieS4gRGVmYXVsdHMgdG8gMQogICAgICBAcmV0dXJuIHtOdW1iZXJ9IFRoZSBuZXcgcHJvcGVydHkgdmFsdWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGRlY3JlbWVudFByb3BlcnR5OiBmdW5jdGlvbiAoa2V5TmFtZSkgewogICAgICB2YXIgZGVjcmVtZW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAxOwogICAgICAodHJ1ZSAmJiAhKCFpc05hTihwYXJzZUZsb2F0KGRlY3JlbWVudCkpICYmIGlzRmluaXRlKGRlY3JlbWVudCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnTXVzdCBwYXNzIGEgbnVtZXJpYyB2YWx1ZSB0byBkZWNyZW1lbnRQcm9wZXJ0eScsICFpc05hTihwYXJzZUZsb2F0KGRlY3JlbWVudCkpICYmIGlzRmluaXRlKGRlY3JlbWVudCkpKTsKCiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCBrZXlOYW1lLCAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywga2V5TmFtZSkgfHwgMCkgLSBkZWNyZW1lbnQpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFNldCB0aGUgdmFsdWUgb2YgYSBib29sZWFuIHByb3BlcnR5IHRvIHRoZSBvcHBvc2l0ZSBvZiBpdHMKICAgICAgY3VycmVudCB2YWx1ZS4KICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc3RhcnNoaXAudG9nZ2xlUHJvcGVydHkoJ3dhcnBEcml2ZUVuZ2FnZWQnKTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHRvZ2dsZVByb3BlcnR5CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byB0b2dnbGUKICAgICAgQHJldHVybiB7Qm9vbGVhbn0gVGhlIG5ldyBwcm9wZXJ0eSB2YWx1ZQogICAgICBAcHVibGljCiAgICAqLwogICAgdG9nZ2xlUHJvcGVydHk6IGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCBrZXlOYW1lLCAhKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywga2V5TmFtZSkpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGNhY2hlZCB2YWx1ZSBvZiBhIGNvbXB1dGVkIHByb3BlcnR5LCBpZiBpdCBleGlzdHMuCiAgICAgIFRoaXMgYWxsb3dzIHlvdSB0byBpbnNwZWN0IHRoZSB2YWx1ZSBvZiBhIGNvbXB1dGVkIHByb3BlcnR5CiAgICAgIHdpdGhvdXQgYWNjaWRlbnRhbGx5IGludm9raW5nIGl0IGlmIGl0IGlzIGludGVuZGVkIHRvIGJlCiAgICAgIGdlbmVyYXRlZCBsYXppbHkuCiAgICAgICBAbWV0aG9kIGNhY2hlRm9yCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lCiAgICAgIEByZXR1cm4ge09iamVjdH0gVGhlIGNhY2hlZCB2YWx1ZSBvZiB0aGUgY29tcHV0ZWQgcHJvcGVydHksIGlmIGFueQogICAgICBAcHVibGljCiAgICAqLwogICAgY2FjaGVGb3I6IGZ1bmN0aW9uIChrZXlOYW1lKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0Q2FjaGVkVmFsdWVGb3IpKHRoaXMsIGtleU5hbWUpOwogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvcHJvbWlzZV9wcm94eScsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZXJyb3InXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfZXJyb3IpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgZnVuY3Rpb24gdGFwKHByb3h5LCBwcm9taXNlKSB7CiAgICAoMCwgX2VtYmVyTWV0YWwuc2V0UHJvcGVydGllcykocHJveHksIHsKICAgICAgaXNGdWxmaWxsZWQ6IGZhbHNlLAogICAgICBpc1JlamVjdGVkOiBmYWxzZQogICAgfSk7CgogICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgaWYgKCFwcm94eS5pc0Rlc3Ryb3llZCAmJiAhcHJveHkuaXNEZXN0cm95aW5nKSB7CiAgICAgICAgKDAsIF9lbWJlck1ldGFsLnNldFByb3BlcnRpZXMpKHByb3h5LCB7CiAgICAgICAgICBjb250ZW50OiB2YWx1ZSwKICAgICAgICAgIGlzRnVsZmlsbGVkOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICBpZiAoIXByb3h5LmlzRGVzdHJveWVkICYmICFwcm94eS5pc0Rlc3Ryb3lpbmcpIHsKICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0UHJvcGVydGllcykocHJveHksIHsKICAgICAgICAgIHJlYXNvbjogcmVhc29uLAogICAgICAgICAgaXNSZWplY3RlZDogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRocm93IHJlYXNvbjsKICAgIH0sICdFbWJlcjogUHJvbWlzZVByb3h5Jyk7CiAgfQoKICAvKioKICAgIEEgbG93IGxldmVsIG1peGluIG1ha2luZyBPYmplY3RQcm94eSBwcm9taXNlLWF3YXJlLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gJ3JzdnAnOwogICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgIGltcG9ydCBPYmplY3RQcm94eSBmcm9tICdAZW1iZXIvb2JqZWN0L3Byb3h5JzsKICAgIGltcG9ydCBQcm9taXNlUHJveHlNaXhpbiBmcm9tICdAZW1iZXIvb2JqZWN0L3Byb21pc2UtcHJveHktbWl4aW4nOwogIAogICAgbGV0IE9iamVjdFByb21pc2VQcm94eSA9IE9iamVjdFByb3h5LmV4dGVuZChQcm9taXNlUHJveHlNaXhpbik7CiAgCiAgICBsZXQgcHJveHkgPSBPYmplY3RQcm9taXNlUHJveHkuY3JlYXRlKHsKICAgICAgcHJvbWlzZTogcmVzb2x2ZSgkLmdldEpTT04oJy9zb21lL3JlbW90ZS9kYXRhLmpzb24nKSkKICAgIH0pOwogIAogICAgcHJveHkudGhlbihmdW5jdGlvbihqc29uKXsKICAgICAgIC8vIHRoZSBqc29uCiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgIC8vIHRoZSByZWFzb24gd2h5IHlvdSBoYXZlIG5vIGpzb24KICAgIH0pOwogICAgYGBgCiAgCiAgICB0aGUgcHJveHkgaGFzIGJpbmRhYmxlIGF0dHJpYnV0ZXMgd2hpY2gKICAgIHRyYWNrIHRoZSBwcm9taXNlcyBsaWZlIGN5Y2xlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBwcm94eS5nZXQoJ2lzUGVuZGluZycpICAgLy89PiB0cnVlCiAgICBwcm94eS5nZXQoJ2lzU2V0dGxlZCcpICAvLz0+IGZhbHNlCiAgICBwcm94eS5nZXQoJ2lzUmVqZWN0ZWQnKSAgLy89PiBmYWxzZQogICAgcHJveHkuZ2V0KCdpc0Z1bGZpbGxlZCcpIC8vPT4gZmFsc2UKICAgIGBgYAogIAogICAgV2hlbiB0aGUgJC5nZXRKU09OIGNvbXBsZXRlcywgYW5kIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZAogICAgd2l0aCBqc29uLCB0aGUgbGlmZSBjeWNsZSBhdHRyaWJ1dGVzIHdpbGwgdXBkYXRlIGFjY29yZGluZ2x5LgogICAgTm90ZSB0aGF0ICQuZ2V0SlNPTiBkb2Vzbid0IHJldHVybiBhbiBFQ01BIHNwZWNpZmllZCBwcm9taXNlLAogICAgaXQgaXMgdXNlZnVsIHRvIHdyYXAgdGhpcyB3aXRoIGFuIGBSU1ZQLnJlc29sdmVgIHNvIHRoYXQgaXQgYmVoYXZlcwogICAgYXMgYSBzcGVjIGNvbXBsaWFudCBwcm9taXNlLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgcHJveHkuZ2V0KCdpc1BlbmRpbmcnKSAgIC8vPT4gZmFsc2UKICAgIHByb3h5LmdldCgnaXNTZXR0bGVkJykgICAvLz0+IHRydWUKICAgIHByb3h5LmdldCgnaXNSZWplY3RlZCcpICAvLz0+IGZhbHNlCiAgICBwcm94eS5nZXQoJ2lzRnVsZmlsbGVkJykgLy89PiB0cnVlCiAgICBgYGAKICAKICAgIEFzIHRoZSBwcm94eSBpcyBhbiBPYmplY3RQcm94eSwgYW5kIHRoZSBqc29uIG5vdyBpdHMgY29udGVudCwKICAgIGFsbCB0aGUganNvbiBwcm9wZXJ0aWVzIHdpbGwgYmUgYXZhaWxhYmxlIGRpcmVjdGx5IGZyb20gdGhlIHByb3h5LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgLy8gQXNzdW1pbmcgdGhlIGZvbGxvd2luZyBqc29uOgogICAgewogICAgICBmaXJzdE5hbWU6ICdTdGVmYW4nLAogICAgICBsYXN0TmFtZTogJ1Blbm5lcicKICAgIH0KICAKICAgIC8vIGJvdGggcHJvcGVydGllcyB3aWxsIGFjY2Vzc2libGUgb24gdGhlIHByb3h5CiAgICBwcm94eS5nZXQoJ2ZpcnN0TmFtZScpIC8vPT4gJ1N0ZWZhbicKICAgIHByb3h5LmdldCgnbGFzdE5hbWUnKSAgLy89PiAnUGVubmVyJwogICAgYGBgCiAgCiAgICBAY2xhc3MgUHJvbWlzZVByb3h5TWl4aW4KICAgIEBwdWJsaWMKICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgSWYgdGhlIHByb3hpZWQgcHJvbWlzZSBpcyByZWplY3RlZCB0aGlzIHdpbGwgY29udGFpbiB0aGUgcmVhc29uCiAgICAgIHByb3ZpZGVkLgogICAgICAgQHByb3BlcnR5IHJlYXNvbgogICAgICBAZGVmYXVsdCBudWxsCiAgICAgIEBwdWJsaWMKICAgICovCiAgICByZWFzb246IG51bGwsCgogICAgLyoqCiAgICAgIE9uY2UgdGhlIHByb3hpZWQgcHJvbWlzZSBoYXMgc2V0dGxlZCB0aGlzIHdpbGwgYmVjb21lIGBmYWxzZWAuCiAgICAgICBAcHJvcGVydHkgaXNQZW5kaW5nCiAgICAgIEBkZWZhdWx0IHRydWUKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGlzUGVuZGluZzogKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKSgnaXNTZXR0bGVkJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gISgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdpc1NldHRsZWQnKTsKICAgIH0pLnJlYWRPbmx5KCksCgogICAgLyoqCiAgICAgIE9uY2UgdGhlIHByb3hpZWQgcHJvbWlzZSBoYXMgc2V0dGxlZCB0aGlzIHdpbGwgYmVjb21lIGB0cnVlYC4KICAgICAgIEBwcm9wZXJ0eSBpc1NldHRsZWQKICAgICAgQGRlZmF1bHQgZmFsc2UKICAgICAgQHB1YmxpYwogICAgKi8KICAgIGlzU2V0dGxlZDogKDAsIF9lbWJlck1ldGFsLmNvbXB1dGVkKSgnaXNSZWplY3RlZCcsICdpc0Z1bGZpbGxlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdpc1JlamVjdGVkJykgfHwgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2lzRnVsZmlsbGVkJyk7CiAgICB9KS5yZWFkT25seSgpLAoKICAgIC8qKgogICAgICBXaWxsIGJlY29tZSBgdHJ1ZWAgaWYgdGhlIHByb3hpZWQgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAgIEBwcm9wZXJ0eSBpc1JlamVjdGVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpc1JlamVjdGVkOiBmYWxzZSwKCiAgICAvKioKICAgICAgV2lsbCBiZWNvbWUgYHRydWVgIGlmIHRoZSBwcm94aWVkIHByb21pc2UgaXMgZnVsZmlsbGVkLgogICAgICAgQHByb3BlcnR5IGlzRnVsZmlsbGVkCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBpc0Z1bGZpbGxlZDogZmFsc2UsCgogICAgLyoqCiAgICAgIFRoZSBwcm9taXNlIHdob3NlIGZ1bGZpbGxtZW50IHZhbHVlIGlzIGJlaW5nIHByb3hpZWQgYnkgdGhpcyBvYmplY3QuCiAgICAgICBUaGlzIHByb3BlcnR5IG11c3QgYmUgc3BlY2lmaWVkIHVwb24gY3JlYXRpb24sIGFuZCBzaG91bGQgbm90IGJlCiAgICAgIGNoYW5nZWQgb25jZSBjcmVhdGVkLgogICAgICAgRXhhbXBsZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IE9iamVjdFByb3h5IGZyb20gJ0BlbWJlci9vYmplY3QvcHJveHknOwogICAgICBpbXBvcnQgUHJvbWlzZVByb3h5TWl4aW4gZnJvbSAnQGVtYmVyL29iamVjdC9wcm9taXNlLXByb3h5LW1peGluJzsKICAgICAgIE9iamVjdFByb3h5LmV4dGVuZChQcm9taXNlUHJveHlNaXhpbikuY3JlYXRlKHsKICAgICAgICBwcm9taXNlOiA8dGhlbmFibGU+CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBwcm9taXNlCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBwcm9taXNlOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCJQcm9taXNlUHJveHkncyBwcm9taXNlIG11c3QgYmUgc2V0Iik7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGtleSwgcHJvbWlzZSkgewogICAgICAgIHJldHVybiB0YXAodGhpcywgcHJvbWlzZSk7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgICBBbiBhbGlhcyB0byB0aGUgcHJveGllZCBwcm9taXNlJ3MgYHRoZW5gLgogICAgICAgU2VlIFJTVlAuUHJvbWlzZS50aGVuLgogICAgICAgQG1ldGhvZCB0aGVuCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHRoZW46IHByb21pc2VBbGlhcygndGhlbicpLAoKICAgIC8qKgogICAgICBBbiBhbGlhcyB0byB0aGUgcHJveGllZCBwcm9taXNlJ3MgYGNhdGNoYC4KICAgICAgIFNlZSBSU1ZQLlByb21pc2UuY2F0Y2guCiAgICAgICBAbWV0aG9kIGNhdGNoCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KICAgICAgQHNpbmNlIDEuMy4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBjYXRjaDogcHJvbWlzZUFsaWFzKCdjYXRjaCcpLAoKICAgIC8qKgogICAgICBBbiBhbGlhcyB0byB0aGUgcHJveGllZCBwcm9taXNlJ3MgYGZpbmFsbHlgLgogICAgICAgU2VlIFJTVlAuUHJvbWlzZS5maW5hbGx5LgogICAgICAgQG1ldGhvZCBmaW5hbGx5CiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZX0KICAgICAgQHNpbmNlIDEuMy4wCiAgICAgIEBwdWJsaWMKICAgICovCiAgICBmaW5hbGx5OiBwcm9taXNlQWxpYXMoJ2ZpbmFsbHknKQogIH0pOwoKCiAgZnVuY3Rpb24gcHJvbWlzZUFsaWFzKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwcm9taXNlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3Byb21pc2UnKTsKICAgICAgcmV0dXJuIHByb21pc2VbbmFtZV0uYXBwbHkocHJvbWlzZSwgYXJndW1lbnRzKTsKICAgIH07CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvcmVnaXN0cnlfcHJveHknLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZGVidWcsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgX19yZWdpc3RyeV9fOiBudWxsLAoKICAgIC8qKgogICAgIEdpdmVuIGEgZnVsbE5hbWUgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGZhY3RvcnkuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlc29sdmVSZWdpc3RyYXRpb24KICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcmV0dXJuIHtGdW5jdGlvbn0gZnVsbE5hbWUncyBmYWN0b3J5CiAgICAgKi8KICAgIHJlc29sdmVSZWdpc3RyYXRpb246IGZ1bmN0aW9uIChmdWxsTmFtZSwgb3B0aW9ucykgewogICAgICAodHJ1ZSAmJiAhKHRoaXMuX19yZWdpc3RyeV9fLmlzVmFsaWRGdWxsTmFtZShmdWxsTmFtZSkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnZnVsbE5hbWUgbXVzdCBiZSBhIHByb3BlciBmdWxsIG5hbWUnLCB0aGlzLl9fcmVnaXN0cnlfXy5pc1ZhbGlkRnVsbE5hbWUoZnVsbE5hbWUpKSk7CgogICAgICByZXR1cm4gdGhpcy5fX3JlZ2lzdHJ5X18ucmVzb2x2ZShmdWxsTmFtZSwgb3B0aW9ucyk7CiAgICB9LAoKCiAgICAvKioKICAgICAgUmVnaXN0ZXJzIGEgZmFjdG9yeSB0aGF0IGNhbiBiZSB1c2VkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbiAod2l0aAogICAgICBgaW5qZWN0YCkgb3IgZm9yIHNlcnZpY2UgbG9va3VwLiBFYWNoIGZhY3RvcnkgaXMgcmVnaXN0ZXJlZCB3aXRoCiAgICAgIGEgZnVsbCBuYW1lIGluY2x1ZGluZyB0d28gcGFydHM6IGB0eXBlOm5hbWVgLgogICAgICAgQSBzaW1wbGUgZXhhbXBsZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICAgIEFwcC5PcmFuZ2UgPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICAgQXBwLnJlZ2lzdGVyKCdmcnVpdDpmYXZvcml0ZScsIEFwcC5PcmFuZ2UpOwogICAgICBgYGAKICAgICAgIEVtYmVyIHdpbGwgcmVzb2x2ZSBmYWN0b3JpZXMgZnJvbSB0aGUgYEFwcGAgbmFtZXNwYWNlIGF1dG9tYXRpY2FsbHkuCiAgICAgIEZvciBleGFtcGxlIGBBcHAuQ2Fyc0NvbnRyb2xsZXJgIHdpbGwgYmUgZGlzY292ZXJlZCBhbmQgcmV0dXJuZWQgaWYKICAgICAgYW4gYXBwbGljYXRpb24gcmVxdWVzdHMgYGNvbnRyb2xsZXI6Y2Fyc2AuCiAgICAgICBBbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgY29udHJvbGxlciB3aXRoIGEgbm9uLXN0YW5kYXJkIG5hbWU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBpbXBvcnQgQ29udHJvbGxlciBmcm9tICdAZW1iZXIvY29udHJvbGxlcic7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgIGxldCBTZXNzaW9uID0gQ29udHJvbGxlci5leHRlbmQoKTsKICAgICAgIEFwcC5yZWdpc3RlcignY29udHJvbGxlcjpzZXNzaW9uJywgU2Vzc2lvbik7CiAgICAgICAvLyBUaGUgU2Vzc2lvbiBjb250cm9sbGVyIGNhbiBub3cgYmUgdHJlYXRlZCBsaWtlIGEgbm9ybWFsIGNvbnRyb2xsZXIsCiAgICAgIC8vIGRlc3BpdGUgaXRzIG5vbi1zdGFuZGFyZCBuYW1lLgogICAgICBBcHAuQXBwbGljYXRpb25Db250cm9sbGVyID0gQ29udHJvbGxlci5leHRlbmQoewogICAgICAgIG5lZWRzOiBbJ3Nlc3Npb24nXQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBSZWdpc3RlcmVkIGZhY3RvcmllcyBhcmUgKippbnN0YW50aWF0ZWQqKiBieSBoYXZpbmcgYGNyZWF0ZWAKICAgICAgY2FsbGVkIG9uIHRoZW0uIEFkZGl0aW9uYWxseSB0aGV5IGFyZSAqKnNpbmdsZXRvbnMqKiwgZWFjaCB0aW1lCiAgICAgIHRoZXkgYXJlIGxvb2tlZCB1cCB0aGV5IHJldHVybiB0aGUgc2FtZSBpbnN0YW5jZS4KICAgICAgIFNvbWUgZXhhbXBsZXMgbW9kaWZ5aW5nIHRoYXQgZGVmYXVsdCBiZWhhdmlvcjoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgIGltcG9ydCBFbWJlck9iamVjdCBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAgICAgIGxldCBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgICAgIEFwcC5QZXJzb24gPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICAgQXBwLk9yYW5nZSA9IEVtYmVyT2JqZWN0LmV4dGVuZCgpOwogICAgICBBcHAuRW1haWwgPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICAgQXBwLnNlc3Npb24gPSBFbWJlck9iamVjdC5jcmVhdGUoKTsKICAgICAgIEFwcC5yZWdpc3RlcignbW9kZWw6dXNlcicsIEFwcC5QZXJzb24sIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgICAgQXBwLnJlZ2lzdGVyKCdmcnVpdDpmYXZvcml0ZScsIEFwcC5PcmFuZ2UpOwogICAgICBBcHAucmVnaXN0ZXIoJ2NvbW11bmljYXRpb246bWFpbicsIEFwcC5FbWFpbCwgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgICBBcHAucmVnaXN0ZXIoJ3Nlc3Npb24nLCBBcHAuc2Vzc2lvbiwgeyBpbnN0YW50aWF0ZTogZmFsc2UgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCByZWdpc3RlcgogICAgICBAcGFyYW0gIGZ1bGxOYW1lIHtTdHJpbmd9IHR5cGU6bmFtZSAoZS5nLiwgJ21vZGVsOnVzZXInKQogICAgICBAcGFyYW0gIGZhY3Rvcnkge0Z1bmN0aW9ufSAoZS5nLiwgQXBwLlBlcnNvbikKICAgICAgQHBhcmFtICBvcHRpb25zIHtPYmplY3R9IChvcHRpb25hbCkgZGlzYWJsZSBpbnN0YW50aWF0aW9uIG9yIHNpbmdsZXRvbiB1c2FnZQogICAgICBAcHVibGljCiAgICAgKi8KICAgIHJlZ2lzdGVyOiByZWdpc3RyeUFsaWFzKCdyZWdpc3RlcicpLAoKICAgIC8qKgogICAgIFVucmVnaXN0ZXIgYSBmYWN0b3J5LgogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgbGV0IFVzZXIgPSBFbWJlck9iamVjdC5leHRlbmQoKTsKICAgICBBcHAucmVnaXN0ZXIoJ21vZGVsOnVzZXInLCBVc2VyKTsKICAgICAgQXBwLnJlc29sdmVSZWdpc3RyYXRpb24oJ21vZGVsOnVzZXInKS5jcmVhdGUoKSBpbnN0YW5jZW9mIFVzZXIgLy89PiB0cnVlCiAgICAgIEFwcC51bnJlZ2lzdGVyKCdtb2RlbDp1c2VyJykKICAgICBBcHAucmVzb2x2ZVJlZ2lzdHJhdGlvbignbW9kZWw6dXNlcicpID09PSB1bmRlZmluZWQgLy89PiB0cnVlCiAgICAgYGBgCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHVucmVnaXN0ZXIKICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICAqLwogICAgdW5yZWdpc3RlcjogcmVnaXN0cnlBbGlhcygndW5yZWdpc3RlcicpLAoKICAgIC8qKgogICAgIENoZWNrIGlmIGEgZmFjdG9yeSBpcyByZWdpc3RlcmVkLgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCBoYXNSZWdpc3RyYXRpb24KICAgICBAcGFyYW0ge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICBoYXNSZWdpc3RyYXRpb246IHJlZ2lzdHJ5QWxpYXMoJ2hhcycpLAoKICAgIC8qKgogICAgIFJldHVybiBhIHNwZWNpZmljIHJlZ2lzdGVyZWQgb3B0aW9uIGZvciBhIHBhcnRpY3VsYXIgZmFjdG9yeS4KICAgICAgQHB1YmxpYwogICAgIEBtZXRob2QgcmVnaXN0ZXJlZE9wdGlvbgogICAgIEBwYXJhbSAge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcGFyYW0gIHtTdHJpbmd9IG9wdGlvbk5hbWUKICAgICBAcmV0dXJuIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgcmVnaXN0ZXJlZE9wdGlvbjogcmVnaXN0cnlBbGlhcygnZ2V0T3B0aW9uJyksCgogICAgLyoqCiAgICAgUmVnaXN0ZXIgb3B0aW9ucyBmb3IgYSBwYXJ0aWN1bGFyIGZhY3RvcnkuCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlZ2lzdGVyT3B0aW9ucwogICAgIEBwYXJhbSB7U3RyaW5nfSBmdWxsTmFtZQogICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgKi8KICAgIHJlZ2lzdGVyT3B0aW9uczogcmVnaXN0cnlBbGlhcygnb3B0aW9ucycpLAoKICAgIC8qKgogICAgIFJldHVybiByZWdpc3RlcmVkIG9wdGlvbnMgZm9yIGEgcGFydGljdWxhciBmYWN0b3J5LgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCByZWdpc3RlcmVkT3B0aW9ucwogICAgIEBwYXJhbSAge1N0cmluZ30gZnVsbE5hbWUKICAgICBAcmV0dXJuIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgcmVnaXN0ZXJlZE9wdGlvbnM6IHJlZ2lzdHJ5QWxpYXMoJ2dldE9wdGlvbnMnKSwKCiAgICAvKioKICAgICBBbGxvdyByZWdpc3RlcmluZyBvcHRpb25zIGZvciBhbGwgZmFjdG9yaWVzIG9mIGEgdHlwZS4KICAgICAgYGBgamF2YXNjcmlwdAogICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgbGV0IGFwcEluc3RhbmNlID0gQXBwLmJ1aWxkSW5zdGFuY2UoKTsKICAgICAgLy8gaWYgYWxsIG9mIHR5cGUgYGNvbm5lY3Rpb25gIG11c3Qgbm90IGJlIHNpbmdsZXRvbnMKICAgICBhcHBJbnN0YW5jZS5yZWdpc3Rlck9wdGlvbnNGb3JUeXBlKCdjb25uZWN0aW9uJywgeyBzaW5nbGV0b246IGZhbHNlIH0pOwogICAgICBhcHBJbnN0YW5jZS5yZWdpc3RlcignY29ubmVjdGlvbjp0d2l0dGVyJywgVHdpdHRlckNvbm5lY3Rpb24pOwogICAgIGFwcEluc3RhbmNlLnJlZ2lzdGVyKCdjb25uZWN0aW9uOmZhY2Vib29rJywgRmFjZWJvb2tDb25uZWN0aW9uKTsKICAgICAgbGV0IHR3aXR0ZXIgPSBhcHBJbnN0YW5jZS5sb29rdXAoJ2Nvbm5lY3Rpb246dHdpdHRlcicpOwogICAgIGxldCB0d2l0dGVyMiA9IGFwcEluc3RhbmNlLmxvb2t1cCgnY29ubmVjdGlvbjp0d2l0dGVyJyk7CiAgICAgIHR3aXR0ZXIgPT09IHR3aXR0ZXIyOyAvLyA9PiBmYWxzZQogICAgICBsZXQgZmFjZWJvb2sgPSBhcHBJbnN0YW5jZS5sb29rdXAoJ2Nvbm5lY3Rpb246ZmFjZWJvb2snKTsKICAgICBsZXQgZmFjZWJvb2syID0gYXBwSW5zdGFuY2UubG9va3VwKCdjb25uZWN0aW9uOmZhY2Vib29rJyk7CiAgICAgIGZhY2Vib29rID09PSBmYWNlYm9vazI7IC8vID0+IGZhbHNlCiAgICAgYGBgCiAgICAgIEBwdWJsaWMKICAgICBAbWV0aG9kIHJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUKICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgKi8KICAgIHJlZ2lzdGVyT3B0aW9uc0ZvclR5cGU6IHJlZ2lzdHJ5QWxpYXMoJ29wdGlvbnNGb3JUeXBlJyksCgogICAgLyoqCiAgICAgUmV0dXJuIHRoZSByZWdpc3RlcmVkIG9wdGlvbnMgZm9yIGFsbCBmYWN0b3JpZXMgb2YgYSB0eXBlLgogICAgICBAcHVibGljCiAgICAgQG1ldGhvZCByZWdpc3RlcmVkT3B0aW9uc0ZvclR5cGUKICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgIEByZXR1cm4ge09iamVjdH0gb3B0aW9ucwogICAgICovCiAgICByZWdpc3RlcmVkT3B0aW9uc0ZvclR5cGU6IHJlZ2lzdHJ5QWxpYXMoJ2dldE9wdGlvbnNGb3JUeXBlJyksCgogICAgLyoqCiAgICAgIERlZmluZSBhIGRlcGVuZGVuY3kgaW5qZWN0aW9uIG9udG8gYSBzcGVjaWZpYyBmYWN0b3J5IG9yIGFsbCBmYWN0b3JpZXMKICAgICAgb2YgYSB0eXBlLgogICAgICAgV2hlbiBFbWJlciBpbnN0YW50aWF0ZXMgYSBjb250cm9sbGVyLCB2aWV3LCBvciBvdGhlciBmcmFtZXdvcmsgY29tcG9uZW50CiAgICAgIGl0IGNhbiBhdHRhY2ggYSBkZXBlbmRlbmN5IHRvIHRoYXQgY29tcG9uZW50LiBUaGlzIGlzIG9mdGVuIHVzZWQgdG8KICAgICAgcHJvdmlkZSBzZXJ2aWNlcyB0byBhIHNldCBvZiBmcmFtZXdvcmsgY29tcG9uZW50cy4KICAgICAgIEFuIGV4YW1wbGUgb2YgcHJvdmlkaW5nIGEgc2Vzc2lvbiBvYmplY3QgdG8gYWxsIGNvbnRyb2xsZXJzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyBhbGlhcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgICBpbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGVtYmVyL2FwcGxpY2F0aW9uJzsKICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgICBpbXBvcnQgRW1iZXJPYmplY3QgZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKCk7CiAgICAgIGxldCBTZXNzaW9uID0gRW1iZXJPYmplY3QuZXh0ZW5kKHsgaXNBdXRoZW50aWNhdGVkOiBmYWxzZSB9KTsKICAgICAgIC8vIEEgZmFjdG9yeSBtdXN0IGJlIHJlZ2lzdGVyZWQgYmVmb3JlIGl0IGNhbiBiZSBpbmplY3RlZAogICAgICBBcHAucmVnaXN0ZXIoJ3Nlc3Npb246bWFpbicsIFNlc3Npb24pOwogICAgICAgLy8gSW5qZWN0ICdzZXNzaW9uOm1haW4nIG9udG8gYWxsIGZhY3RvcmllcyBvZiB0aGUgdHlwZSAnY29udHJvbGxlcicKICAgICAgLy8gd2l0aCB0aGUgbmFtZSAnc2Vzc2lvbicKICAgICAgQXBwLmluamVjdCgnY29udHJvbGxlcicsICdzZXNzaW9uJywgJ3Nlc3Npb246bWFpbicpOwogICAgICAgQXBwLkluZGV4Q29udHJvbGxlciA9IENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgICBpc0xvZ2dlZEluOiBhbGlhcygnc2Vzc2lvbi5pc0F1dGhlbnRpY2F0ZWQnKQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJbmplY3Rpb25zIGNhbiBhbHNvIGJlIHBlcmZvcm1lZCBvbiBzcGVjaWZpYyBmYWN0b3JpZXMuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIEFwcC5pbmplY3QoPGZ1bGxfbmFtZSBvciB0eXBlPiwgPHByb3BlcnR5IG5hbWU+LCA8ZnVsbF9uYW1lPikKICAgICAgQXBwLmluamVjdCgncm91dGUnLCAnc291cmNlJywgJ3NvdXJjZTptYWluJykKICAgICAgQXBwLmluamVjdCgncm91dGU6YXBwbGljYXRpb24nLCAnZW1haWwnLCAnbW9kZWw6ZW1haWwnKQogICAgICBgYGAKICAgICAgIEl0IGlzIGltcG9ydGFudCB0byBub3RlIHRoYXQgaW5qZWN0aW9ucyBjYW4gb25seSBiZSBwZXJmb3JtZWQgb24KICAgICAgY2xhc3NlcyB0aGF0IGFyZSBpbnN0YW50aWF0ZWQgYnkgRW1iZXIgaXRzZWxmLiBJbnN0YW50aWF0aW5nIGEgY2xhc3MKICAgICAgZGlyZWN0bHkgKHZpYSBgY3JlYXRlYCBvciBgbmV3YCkgYnlwYXNzZXMgdGhlIGRlcGVuZGVuY3kgaW5qZWN0aW9uCiAgICAgIHN5c3RlbS4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBpbmplY3QKICAgICAgQHBhcmFtICBmYWN0b3J5TmFtZU9yVHlwZSB7U3RyaW5nfQogICAgICBAcGFyYW0gIHByb3BlcnR5IHtTdHJpbmd9CiAgICAgIEBwYXJhbSAgaW5qZWN0aW9uTmFtZSB7U3RyaW5nfQogICAgKiovCiAgICBpbmplY3Q6IHJlZ2lzdHJ5QWxpYXMoJ2luamVjdGlvbicpCiAgfSk7CgoKICBmdW5jdGlvbiByZWdpc3RyeUFsaWFzKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfcmVnaXN0cnlfXzsKCiAgICAgIHJldHVybiAoX3JlZ2lzdHJ5X18gPSB0aGlzLl9fcmVnaXN0cnlfXylbbmFtZV0uYXBwbHkoX3JlZ2lzdHJ5X18sIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvbWl4aW5zL3RhcmdldF9hY3Rpb25fc3VwcG9ydCcsIFsnZXhwb3J0cycsICdlbWJlci1lbnZpcm9ubWVudCcsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZGVidWcnLCAnQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckVudmlyb25tZW50LCBfZW1iZXJNZXRhbCwgX2RlYnVnLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgdGFyZ2V0OiBudWxsLAogICAgdGFyZ2V0T2JqZWN0OiBfZGVwcmVjYXRlZEZlYXR1cmVzLlRBUkdFVF9PQkpFQ1QgPyAoMCwgX2VtYmVyTWV0YWwuZGVzY3JpcHRvcikoewogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbWVzc2FnZSA9IHRoaXMgKyAnIFVzYWdlIG9mIGB0YXJnZXRPYmplY3RgIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgYHRhcmdldGAgaW5zdGVhZC4nOwogICAgICAgIHZhciBvcHRpb25zID0geyBpZDogJ2VtYmVyLXJ1bnRpbWUudXNpbmctdGFyZ2V0T2JqZWN0JywgdW50aWw6ICczLjUuMCcgfTsKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkobWVzc2FnZSwgZmFsc2UsIG9wdGlvbnMpKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldE9iamVjdDsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgbWVzc2FnZSA9IHRoaXMgKyAnIFVzYWdlIG9mIGB0YXJnZXRPYmplY3RgIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2UgYHRhcmdldGAgaW5zdGVhZC4nOwogICAgICAgIHZhciBvcHRpb25zID0geyBpZDogJ2VtYmVyLXJ1bnRpbWUudXNpbmctdGFyZ2V0T2JqZWN0JywgdW50aWw6ICczLjUuMCcgfTsKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmRlcHJlY2F0ZSkobWVzc2FnZSwgZmFsc2UsIG9wdGlvbnMpKTsKCiAgICAgICAgdGhpcy5fdGFyZ2V0T2JqZWN0ID0gdmFsdWU7CiAgICAgIH0KICAgIH0pIDogdW5kZWZpbmVkLAogICAgYWN0aW9uOiBudWxsLAogICAgYWN0aW9uQ29udGV4dDogbnVsbCwKCiAgICBhY3Rpb25Db250ZXh0T2JqZWN0OiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKCdhY3Rpb25Db250ZXh0JywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgYWN0aW9uQ29udGV4dCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdhY3Rpb25Db250ZXh0Jyk7CgogICAgICBpZiAodHlwZW9mIGFjdGlvbkNvbnRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIHZhbHVlID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgYWN0aW9uQ29udGV4dCk7CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhbHVlID0gKDAsIF9lbWJlck1ldGFsLmdldCkoX2VtYmVyRW52aXJvbm1lbnQuY29udGV4dC5sb29rdXAsIGFjdGlvbkNvbnRleHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGFjdGlvbkNvbnRleHQ7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgU2VuZCBhbiBgYWN0aW9uYCB3aXRoIGFuIGBhY3Rpb25Db250ZXh0YCB0byBhIGB0YXJnZXRgLiBUaGUgYWN0aW9uLCBhY3Rpb25Db250ZXh0CiAgICBhbmQgdGFyZ2V0IHdpbGwgYmUgcmV0cmlldmVkIGZyb20gcHJvcGVydGllcyBvZiB0aGUgb2JqZWN0LiBGb3IgZXhhbXBsZToKICAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBhbGlhcyB9IGZyb20gJ0BlbWJlci9vYmplY3QvY29tcHV0ZWQnOwogICAgIEFwcC5TYXZlQnV0dG9uVmlldyA9IEVtYmVyLlZpZXcuZXh0ZW5kKEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQsIHsKICAgICAgdGFyZ2V0OiBhbGlhcygnY29udHJvbGxlcicpLAogICAgICBhY3Rpb246ICdzYXZlJywKICAgICAgYWN0aW9uQ29udGV4dDogYWxpYXMoJ2NvbnRleHQnKSwKICAgICAgY2xpY2soKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyQWN0aW9uKCk7IC8vIFNlbmRzIHRoZSBgc2F2ZWAgYWN0aW9uLCBhbG9uZyB3aXRoIHRoZSBjdXJyZW50IGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnQgY29udHJvbGxlcgogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIFRoZSBgdGFyZ2V0YCwgYGFjdGlvbmAsIGFuZCBgYWN0aW9uQ29udGV4dGAgY2FuIGJlIHByb3ZpZGVkIGFzIHByb3BlcnRpZXMgb2YKICAgIGFuIG9wdGlvbmFsIG9iamVjdCBhcmd1bWVudCB0byBgdHJpZ2dlckFjdGlvbmAgYXMgd2VsbC4KICAgICBgYGBqYXZhc2NyaXB0CiAgICBBcHAuU2F2ZUJ1dHRvblZpZXcgPSBFbWJlci5WaWV3LmV4dGVuZChFbWJlci5UYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgICAgIGNsaWNrKCkgewogICAgICAgIHRoaXMudHJpZ2dlckFjdGlvbih7CiAgICAgICAgICBhY3Rpb246ICdzYXZlJywKICAgICAgICAgIHRhcmdldDogdGhpcy5nZXQoJ2NvbnRyb2xsZXInKSwKICAgICAgICAgIGFjdGlvbkNvbnRleHQ6IHRoaXMuZ2V0KCdjb250ZXh0JykKICAgICAgICB9KTsgLy8gU2VuZHMgdGhlIGBzYXZlYCBhY3Rpb24sIGFsb25nIHdpdGggdGhlIGN1cnJlbnQgY29udGV4dAogICAgICAgICAgICAvLyB0byB0aGUgY3VycmVudCBjb250cm9sbGVyCiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgVGhlIGBhY3Rpb25Db250ZXh0YCBkZWZhdWx0cyB0byB0aGUgb2JqZWN0IHlvdSBhcmUgbWl4aW5nIGBUYXJnZXRBY3Rpb25TdXBwb3J0YCBpbnRvLgogICAgQnV0IGB0YXJnZXRgIGFuZCBgYWN0aW9uYCBtdXN0IGJlIHNwZWNpZmllZCBlaXRoZXIgYXMgcHJvcGVydGllcyBvciB3aXRoIHRoZSBhcmd1bWVudAogICAgdG8gYHRyaWdnZXJBY3Rpb25gLCBvciBhIGNvbWJpbmF0aW9uOgogICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IGFsaWFzIH0gZnJvbSAnQGVtYmVyL29iamVjdC9jb21wdXRlZCc7CiAgICAgQXBwLlNhdmVCdXR0b25WaWV3ID0gRW1iZXIuVmlldy5leHRlbmQoRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydCwgewogICAgICB0YXJnZXQ6IGFsaWFzKCdjb250cm9sbGVyJyksCiAgICAgIGNsaWNrKCkgewogICAgICAgIHRoaXMudHJpZ2dlckFjdGlvbih7CiAgICAgICAgICBhY3Rpb246ICdzYXZlJwogICAgICAgIH0pOyAvLyBTZW5kcyB0aGUgYHNhdmVgIGFjdGlvbiwgYWxvbmcgd2l0aCBhIHJlZmVyZW5jZSB0byBgdGhpc2AsCiAgICAgICAgICAgIC8vIHRvIHRoZSBjdXJyZW50IGNvbnRyb2xsZXIKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIHRyaWdnZXJBY3Rpb24KICAgIEBwYXJhbSBvcHRzIHtPYmplY3R9IChvcHRpb25hbCwgd2l0aCB0aGUgb3B0aW9uYWwga2V5cyBhY3Rpb24sIHRhcmdldCBhbmQvb3IgYWN0aW9uQ29udGV4dCkKICAgIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIGFjdGlvbiB3YXMgc2VudCBzdWNjZXNzZnVsbHkgYW5kIGRpZCBub3QgcmV0dXJuIGZhbHNlCiAgICBAcHJpdmF0ZQogICAgKi8KICAgIHRyaWdnZXJBY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG9wdHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHt9OwogICAgICB2YXIgYWN0aW9uID0gb3B0cy5hY3Rpb24sCiAgICAgICAgICB0YXJnZXQgPSBvcHRzLnRhcmdldCwKICAgICAgICAgIGFjdGlvbkNvbnRleHQgPSBvcHRzLmFjdGlvbkNvbnRleHQ7CgogICAgICBhY3Rpb24gPSBhY3Rpb24gfHwgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2FjdGlvbicpOwogICAgICB0YXJnZXQgPSB0YXJnZXQgfHwgZ2V0VGFyZ2V0KHRoaXMpOwoKICAgICAgaWYgKGFjdGlvbkNvbnRleHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGFjdGlvbkNvbnRleHQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnYWN0aW9uQ29udGV4dE9iamVjdCcpIHx8IHRoaXM7CiAgICAgIH0KCiAgICAgIGlmICh0YXJnZXQgJiYgYWN0aW9uKSB7CiAgICAgICAgdmFyIHJldCA9IHZvaWQgMDsKCiAgICAgICAgaWYgKHRhcmdldC5zZW5kKSB7CiAgICAgICAgICB2YXIgX3RhcmdldDsKCiAgICAgICAgICByZXQgPSAoX3RhcmdldCA9IHRhcmdldCkuc2VuZC5hcHBseShfdGFyZ2V0LCBbYWN0aW9uXS5jb25jYXQoYWN0aW9uQ29udGV4dCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgX3RhcmdldDI7CgogICAgICAgICAgKHRydWUgJiYgISh0eXBlb2YgdGFyZ2V0W2FjdGlvbl0gPT09ICdmdW5jdGlvbicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGhlIGFjdGlvbiBcJycgKyBhY3Rpb24gKyAnXCcgZGlkIG5vdCBleGlzdCBvbiAnICsgdGFyZ2V0LCB0eXBlb2YgdGFyZ2V0W2FjdGlvbl0gPT09ICdmdW5jdGlvbicpKTsKCiAgICAgICAgICByZXQgPSAoX3RhcmdldDIgPSB0YXJnZXQpW2FjdGlvbl0uYXBwbHkoX3RhcmdldDIsIFtdLmNvbmNhdChhY3Rpb25Db250ZXh0KSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmV0ICE9PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSk7CgoKICBmdW5jdGlvbiBnZXRUYXJnZXQoaW5zdGFuY2UpIHsKICAgIHZhciB0YXJnZXQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpbnN0YW5jZSwgJ3RhcmdldCcpOwogICAgaWYgKHRhcmdldCkgewogICAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgdmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShpbnN0YW5jZSwgdGFyZ2V0KTsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFsdWUgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KShfZW1iZXJFbnZpcm9ubWVudC5jb250ZXh0Lmxvb2t1cCwgdGFyZ2V0KTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICB9CiAgICB9CgogICAgLy8gaWYgYSBgdGFyZ2V0T2JqZWN0YCBDUCB3YXMgcHJvdmlkZWQsIHVzZSBpdAogICAgaWYgKHRhcmdldCkgewogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICAgIC8vIGlmIF90YXJnZXRPYmplY3QgdXNlIGl0CiAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5UQVJHRVRfT0JKRUNUICYmIGluc3RhbmNlLl90YXJnZXRPYmplY3QpIHsKICAgICAgcmV0dXJuIGluc3RhbmNlLl90YXJnZXRPYmplY3Q7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vYXJyYXlfcHJveHknLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnLCAnZW1iZXItcnVudGltZS9saWIvc3lzdGVtL29iamVjdCcsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvYXJyYXknLCAnQGVtYmVyL2RlYnVnJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCwgX29iamVjdCwgX2FycmF5LCBfZGVidWcpIHsKICAndXNlIHN0cmljdCc7CgogIHZhciBfRW1iZXJPYmplY3QkZXh0ZW5kOwoKICB2YXIgQVJSQVlfT0JTRVJWRVJfTUFQUElORyA9IHsKICAgIHdpbGxDaGFuZ2U6ICdfYXJyYW5nZWRDb250ZW50QXJyYXlXaWxsQ2hhbmdlJywKICAgIGRpZENoYW5nZTogJ19hcnJhbmdlZENvbnRlbnRBcnJheURpZENoYW5nZScKICB9OwoKICAvKioKICAgIEFuIEFycmF5UHJveHkgd3JhcHMgYW55IG90aGVyIG9iamVjdCB0aGF0IGltcGxlbWVudHMgYEFycmF5YCBhbmQvb3IKICAgIGBNdXRhYmxlQXJyYXksYCBmb3J3YXJkaW5nIGFsbCByZXF1ZXN0cy4gVGhpcyBtYWtlcyBpdCB2ZXJ5IHVzZWZ1bCBmb3IKICAgIGEgbnVtYmVyIG9mIGJpbmRpbmcgdXNlIGNhc2VzIG9yIG90aGVyIGNhc2VzIHdoZXJlIGJlaW5nIGFibGUgdG8gc3dhcAogICAgb3V0IHRoZSB1bmRlcmx5aW5nIGFycmF5IGlzIHVzZWZ1bC4KICAKICAgIEEgc2ltcGxlIGV4YW1wbGUgb2YgdXNhZ2U6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAgIGltcG9ydCBBcnJheVByb3h5IGZyb20gJ0BlbWJlci9hcnJheS9wcm94eSc7CiAgCiAgICBsZXQgcGV0cyA9IFsnZG9nJywgJ2NhdCcsICdmaXNoJ107CiAgICBsZXQgYXAgPSBBcnJheVByb3h5LmNyZWF0ZSh7IGNvbnRlbnQ6IEEocGV0cykgfSk7CiAgCiAgICBhcC5nZXQoJ2ZpcnN0T2JqZWN0Jyk7ICAgICAgICAgICAgICAgICAgICAgICAgLy8gJ2RvZycKICAgIGFwLnNldCgnY29udGVudCcsIFsnYW1vZWJhJywgJ3BhcmFtZWNpdW0nXSk7CiAgICBhcC5nZXQoJ2ZpcnN0T2JqZWN0Jyk7ICAgICAgICAgICAgICAgICAgICAgICAgLy8gJ2Ftb2ViYScKICAgIGBgYAogIAogICAgVGhpcyBjbGFzcyBjYW4gYWxzbyBiZSB1c2VmdWwgYXMgYSBsYXllciB0byB0cmFuc2Zvcm0gdGhlIGNvbnRlbnRzIG9mCiAgICBhbiBhcnJheSwgYXMgdGhleSBhcmUgYWNjZXNzZWQuIFRoaXMgY2FuIGJlIGRvbmUgYnkgb3ZlcnJpZGluZwogICAgYG9iamVjdEF0Q29udGVudGA6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAgIGltcG9ydCBBcnJheVByb3h5IGZyb20gJ0BlbWJlci9hcnJheS9wcm94eSc7CiAgCiAgICBsZXQgcGV0cyA9IFsnZG9nJywgJ2NhdCcsICdmaXNoJ107CiAgICBsZXQgYXAgPSBBcnJheVByb3h5LmNyZWF0ZSh7CiAgICAgICAgY29udGVudDogQShwZXRzKSwKICAgICAgICBvYmplY3RBdENvbnRlbnQ6IGZ1bmN0aW9uKGlkeCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2NvbnRlbnQnKS5vYmplY3RBdChpZHgpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfQogICAgfSk7CiAgCiAgICBhcC5nZXQoJ2ZpcnN0T2JqZWN0Jyk7IC8vIC4gJ0RPRycKICAgIGBgYAogIAogICAgV2hlbiBvdmVycmlkaW5nIHRoaXMgY2xhc3MsIGl0IGlzIGltcG9ydGFudCB0byBwbGFjZSB0aGUgY2FsbCB0bwogICAgYF9zdXBlcmAgKmFmdGVyKiBzZXR0aW5nIGBjb250ZW50YCBzbyB0aGUgaW50ZXJuYWwgb2JzZXJ2ZXJzIGhhdmUKICAgIGEgY2hhbmNlIHRvIGZpcmUgcHJvcGVybHk6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyBBIH0gZnJvbSAnQGVtYmVyL2FycmF5JzsKICAgIGltcG9ydCBBcnJheVByb3h5IGZyb20gJ0BlbWJlci9hcnJheS9wcm94eSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBBcnJheVByb3h5LmV4dGVuZCh7CiAgICAgIGluaXQoKSB7CiAgICAgICAgdGhpcy5zZXQoJ2NvbnRlbnQnLCBBKFsnZG9nJywgJ2NhdCcsICdmaXNoJ10pKTsKICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIEFycmF5UHJveHkKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAdXNlcyBNdXRhYmxlQXJyYXkKICAgIEBwdWJsaWMKICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IF9vYmplY3QuZGVmYXVsdC5leHRlbmQoX2FycmF5Lk11dGFibGVBcnJheSwgKF9FbWJlck9iamVjdCRleHRlbmQgPSB7CiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAvKgogICAgICAgIGB0aGlzLl9vYmplY3RzRGlydHlJbmRleGAgZGV0ZXJtaW5lcyB3aGljaCBpbmRleGVzIGluIHRoZSBgdGhpcy5fb2JqZWN0c2AKICAgICAgICBjYWNoZSBhcmUgZGlydHkuCiAgICAgICAgIElmIGB0aGlzLl9vYmplY3RzRGlydHlJbmRleCA9PT0gLTFgIHRoZW4gbm8gaW5kZXhlcyBhcmUgZGlydHkuCiAgICAgICAgT3RoZXJ3aXNlLCBhbiBpbmRleCBgaWAgaXMgZGlydHkgaWYgYGkgPj0gdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXhgLgogICAgICAgICBDYWxsaW5nIGBvYmplY3RBdGAgd2l0aCBhIGRpcnR5IGluZGV4IHdpbGwgY2F1c2UgdGhlIGB0aGlzLl9vYmplY3RzYAogICAgICAgIGNhY2hlIHRvIGJlIHJlY29tcHV0ZWQuCiAgICAgICovCiAgICAgIHRoaXMuX29iamVjdHNEaXJ0eUluZGV4ID0gMDsKICAgICAgdGhpcy5fb2JqZWN0cyA9IG51bGw7CgogICAgICB0aGlzLl9sZW5ndGhEaXJ0eSA9IHRydWU7CiAgICAgIHRoaXMuX2xlbmd0aCA9IDA7CgogICAgICB0aGlzLl9hcnJhbmdlZENvbnRlbnQgPSBudWxsOwogICAgICB0aGlzLl9hZGRBcnJhbmdlZENvbnRlbnRBcnJheU9ic2V2ZXIoKTsKICAgIH0sCiAgICB3aWxsRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9yZW1vdmVBcnJhbmdlZENvbnRlbnRBcnJheU9ic2V2ZXIoKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBUaGUgY29udGVudCBhcnJheS4gTXVzdCBiZSBhbiBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIGBBcnJheWAgYW5kL29yCiAgICAgIGBNdXRhYmxlQXJyYXkuYAogICAgICAgQHByb3BlcnR5IGNvbnRlbnQKICAgICAgQHR5cGUgRW1iZXJBcnJheQogICAgICBAcHVibGljCiAgICAqLwogICAgY29udGVudDogbnVsbCwKCiAgICAvKioKICAgICBUaGUgYXJyYXkgdGhhdCB0aGUgcHJveHkgcHJldGVuZHMgdG8gYmUuIEluIHRoZSBkZWZhdWx0IGBBcnJheVByb3h5YAogICAgIGltcGxlbWVudGF0aW9uLCB0aGlzIGFuZCBgY29udGVudGAgYXJlIHRoZSBzYW1lLiBTdWJjbGFzc2VzIG9mIGBBcnJheVByb3h5YAogICAgIGNhbiBvdmVycmlkZSB0aGlzIHByb3BlcnR5IHRvIHByb3ZpZGUgdGhpbmdzIGxpa2Ugc29ydGluZyBhbmQgZmlsdGVyaW5nLgogICAgICBAcHJvcGVydHkgYXJyYW5nZWRDb250ZW50CiAgICAgQHB1YmxpYwogICAgKi8KICAgIGFycmFuZ2VkQ29udGVudDogKDAsIF9lbWJlck1ldGFsLmFsaWFzKSgnY29udGVudCcpLAoKICAgIC8qKgogICAgICBTaG91bGQgYWN0dWFsbHkgcmV0cmlldmUgdGhlIG9iamVjdCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4IGZyb20gdGhlCiAgICAgIGNvbnRlbnQuIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBtZXRob2QgaW4gc3ViY2xhc3NlcyB0byB0cmFuc2Zvcm0gdGhlCiAgICAgIGNvbnRlbnQgaXRlbSB0byBzb21ldGhpbmcgbmV3LgogICAgICAgVGhpcyBtZXRob2Qgd2lsbCBvbmx5IGJlIGNhbGxlZCBpZiBjb250ZW50IGlzIG5vbi1gbnVsbGAuCiAgICAgICBAbWV0aG9kIG9iamVjdEF0Q29udGVudAogICAgICBAcGFyYW0ge051bWJlcn0gaWR4IFRoZSBpbmRleCB0byByZXRyaWV2ZS4KICAgICAgQHJldHVybiB7T2JqZWN0fSB0aGUgdmFsdWUgb3IgdW5kZWZpbmVkIGlmIG5vbmUgZm91bmQKICAgICAgQHB1YmxpYwogICAgKi8KICAgIG9iamVjdEF0Q29udGVudDogZnVuY3Rpb24gKGlkeCkgewogICAgICByZXR1cm4gKDAsIF9lbWJlck1ldGFsLm9iamVjdEF0KSgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50JyksIGlkeCk7CiAgICB9LAogICAgcmVwbGFjZTogZnVuY3Rpb24gKGlkeCwgYW10LCBvYmplY3RzKSB7CiAgICAgICh0cnVlICYmICEoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpID09PSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnY29udGVudCcpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ011dGF0aW5nIGFuIGFycmFuZ2VkIEFycmF5UHJveHkgaXMgbm90IGFsbG93ZWQnLCAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50JykgPT09ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdjb250ZW50JykpKTsKCiAgICAgIHRoaXMucmVwbGFjZUNvbnRlbnQoaWR4LCBhbXQsIG9iamVjdHMpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFNob3VsZCBhY3R1YWxseSByZXBsYWNlIHRoZSBzcGVjaWZpZWQgb2JqZWN0cyBvbiB0aGUgY29udGVudCBhcnJheS4KICAgICAgWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCBpbiBzdWJjbGFzc2VzIHRvIHRyYW5zZm9ybSB0aGUgY29udGVudCBpdGVtCiAgICAgIGludG8gc29tZXRoaW5nIG5ldy4KICAgICAgIFRoaXMgbWV0aG9kIHdpbGwgb25seSBiZSBjYWxsZWQgaWYgY29udGVudCBpcyBub24tYG51bGxgLgogICAgICAgQG1ldGhvZCByZXBsYWNlQ29udGVudAogICAgICBAcGFyYW0ge051bWJlcn0gaWR4IFRoZSBzdGFydGluZyBpbmRleAogICAgICBAcGFyYW0ge051bWJlcn0gYW10IFRoZSBudW1iZXIgb2YgaXRlbXMgdG8gcmVtb3ZlIGZyb20gdGhlIGNvbnRlbnQuCiAgICAgIEBwYXJhbSB7RW1iZXJBcnJheX0gb2JqZWN0cyBPcHRpb25hbCBhcnJheSBvZiBvYmplY3RzIHRvIGluc2VydCBvciBudWxsIGlmIG5vCiAgICAgICAgb2JqZWN0cy4KICAgICAgQHJldHVybiB7dm9pZH0KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJlcGxhY2VDb250ZW50OiBmdW5jdGlvbiAoaWR4LCBhbXQsIG9iamVjdHMpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2NvbnRlbnQnKS5yZXBsYWNlKGlkeCwgYW10LCBvYmplY3RzKTsKICAgIH0sCgoKICAgIC8vIE92ZXJyaWRpbmcgb2JqZWN0QXQgaXMgbm90IHN1cHBvcnRlZC4KICAgIG9iamVjdEF0OiBmdW5jdGlvbiAoaWR4KSB7CiAgICAgIGlmICh0aGlzLl9vYmplY3RzID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fb2JqZWN0cyA9IFtdOwogICAgICB9CgogICAgICBpZiAodGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggIT09IC0xICYmIGlkeCA+PSB0aGlzLl9vYmplY3RzRGlydHlJbmRleCkgewogICAgICAgIHZhciBhcnJhbmdlZENvbnRlbnQgPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnYXJyYW5nZWRDb250ZW50Jyk7CiAgICAgICAgaWYgKGFycmFuZ2VkQ29udGVudCkgewogICAgICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuX29iamVjdHMubGVuZ3RoID0gKDAsIF9lbWJlck1ldGFsLmdldCkoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJyk7CgogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuX29iamVjdHNEaXJ0eUluZGV4OyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5fb2JqZWN0c1tpXSA9IHRoaXMub2JqZWN0QXRDb250ZW50KGkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9vYmplY3RzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX29iamVjdHNEaXJ0eUluZGV4ID0gLTE7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9vYmplY3RzW2lkeF07CiAgICB9LAoKCiAgICAvLyBPdmVycmlkaW5nIGxlbmd0aCBpcyBub3Qgc3VwcG9ydGVkLgogICAgbGVuZ3RoOiAoMCwgX2VtYmVyTWV0YWwuY29tcHV0ZWQpKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuX2xlbmd0aERpcnR5KSB7CiAgICAgICAgdmFyIGFycmFuZ2VkQ29udGVudCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKTsKICAgICAgICB0aGlzLl9sZW5ndGggPSBhcnJhbmdlZENvbnRlbnQgPyAoMCwgX2VtYmVyTWV0YWwuZ2V0KShhcnJhbmdlZENvbnRlbnQsICdsZW5ndGgnKSA6IDA7CiAgICAgICAgdGhpcy5fbGVuZ3RoRGlydHkgPSBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuX2xlbmd0aDsKICAgIH0pLnZvbGF0aWxlKCkKCiAgfSwgX0VtYmVyT2JqZWN0JGV4dGVuZFtfZW1iZXJNZXRhbC5QUk9QRVJUWV9ESURfQ0hBTkdFXSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgIGlmIChrZXkgPT09ICdhcnJhbmdlZENvbnRlbnQnKSB7CiAgICAgIHZhciBvbGRMZW5ndGggPSB0aGlzLl9vYmplY3RzID09PSBudWxsID8gMCA6IHRoaXMuX29iamVjdHMubGVuZ3RoOwogICAgICB2YXIgYXJyYW5nZWRDb250ZW50ID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2FycmFuZ2VkQ29udGVudCcpOwogICAgICB2YXIgbmV3TGVuZ3RoID0gYXJyYW5nZWRDb250ZW50ID8gKDAsIF9lbWJlck1ldGFsLmdldCkoYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJykgOiAwOwoKICAgICAgdGhpcy5fcmVtb3ZlQXJyYW5nZWRDb250ZW50QXJyYXlPYnNldmVyKCk7CiAgICAgIHRoaXMuYXJyYXlDb250ZW50V2lsbENoYW5nZSgwLCBvbGRMZW5ndGgsIG5ld0xlbmd0aCk7CgogICAgICB0aGlzLl9vYmplY3RzRGlydHlJbmRleCA9IDA7CiAgICAgIHRoaXMuX2xlbmd0aERpcnR5ID0gdHJ1ZTsKCiAgICAgIHRoaXMuYXJyYXlDb250ZW50RGlkQ2hhbmdlKDAsIG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKICAgICAgdGhpcy5fYWRkQXJyYW5nZWRDb250ZW50QXJyYXlPYnNldmVyKCk7CiAgICB9CiAgfSwgX0VtYmVyT2JqZWN0JGV4dGVuZC5fYWRkQXJyYW5nZWRDb250ZW50QXJyYXlPYnNldmVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFycmFuZ2VkQ29udGVudCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdhcnJhbmdlZENvbnRlbnQnKTsKICAgIGlmIChhcnJhbmdlZENvbnRlbnQpIHsKICAgICAgKHRydWUgJiYgIShhcnJhbmdlZENvbnRlbnQgIT09IHRoaXMpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiQ2FuJ3Qgc2V0IEFycmF5UHJveHkncyBjb250ZW50IHRvIGl0c2VsZiIsIGFycmFuZ2VkQ29udGVudCAhPT0gdGhpcykpOwogICAgICAodHJ1ZSAmJiAhKCgwLCBfYXJyYXkuaXNBcnJheSkoYXJyYW5nZWRDb250ZW50KSB8fCBhcnJhbmdlZENvbnRlbnQuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQXJyYXlQcm94eSBleHBlY3RzIGFuIEFycmF5IG9yIEFycmF5UHJveHksIGJ1dCB5b3UgcGFzc2VkICcgKyB0eXBlb2YgYXJyYW5nZWRDb250ZW50LCAoMCwgX2FycmF5LmlzQXJyYXkpKGFycmFuZ2VkQ29udGVudCkgfHwgYXJyYW5nZWRDb250ZW50LmlzRGVzdHJveWVkKSk7CgoKICAgICAgKDAsIF9lbWJlck1ldGFsLmFkZEFycmF5T2JzZXJ2ZXIpKGFycmFuZ2VkQ29udGVudCwgdGhpcywgQVJSQVlfT0JTRVJWRVJfTUFQUElORyk7CgogICAgICB0aGlzLl9hcnJhbmdlZENvbnRlbnQgPSBhcnJhbmdlZENvbnRlbnQ7CiAgICB9CiAgfSwgX0VtYmVyT2JqZWN0JGV4dGVuZC5fcmVtb3ZlQXJyYW5nZWRDb250ZW50QXJyYXlPYnNldmVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuX2FycmFuZ2VkQ29udGVudCkgewogICAgICAoMCwgX2VtYmVyTWV0YWwucmVtb3ZlQXJyYXlPYnNlcnZlcikodGhpcy5fYXJyYW5nZWRDb250ZW50LCB0aGlzLCBBUlJBWV9PQlNFUlZFUl9NQVBQSU5HKTsKICAgIH0KICB9LCBfRW1iZXJPYmplY3QkZXh0ZW5kLl9hcnJhbmdlZENvbnRlbnRBcnJheVdpbGxDaGFuZ2UgPSBmdW5jdGlvbiAoKSB7fSwgX0VtYmVyT2JqZWN0JGV4dGVuZC5fYXJyYW5nZWRDb250ZW50QXJyYXlEaWRDaGFuZ2UgPSBmdW5jdGlvbiAocHJveHksIGlkeCwgcmVtb3ZlZENudCwgYWRkZWRDbnQpIHsKICAgIHRoaXMuYXJyYXlDb250ZW50V2lsbENoYW5nZShpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KTsKCiAgICB2YXIgZGlydHlJbmRleCA9IGlkeDsKICAgIGlmIChkaXJ0eUluZGV4IDwgMCkgewogICAgICB2YXIgbGVuZ3RoID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcy5fYXJyYW5nZWRDb250ZW50LCAnbGVuZ3RoJyk7CiAgICAgIGRpcnR5SW5kZXggKz0gbGVuZ3RoICsgcmVtb3ZlZENudCAtIGFkZGVkQ250OwogICAgfQoKICAgIGlmICh0aGlzLl9vYmplY3RzRGlydHlJbmRleCA9PT0gLTEpIHsKICAgICAgdGhpcy5fb2JqZWN0c0RpcnR5SW5kZXggPSBkaXJ0eUluZGV4OwogICAgfSBlbHNlIHsKICAgICAgaWYgKHRoaXMuX29iamVjdHNEaXJ0eUluZGV4ID4gZGlydHlJbmRleCkgewogICAgICAgIHRoaXMuX29iamVjdHNEaXJ0eUluZGV4ID0gZGlydHlJbmRleDsKICAgICAgfQogICAgfQoKICAgIHRoaXMuX2xlbmd0aERpcnR5ID0gdHJ1ZTsKCiAgICB0aGlzLmFycmF5Q29udGVudERpZENoYW5nZShpZHgsIHJlbW92ZWRDbnQsIGFkZGVkQ250KTsKICB9LCBfRW1iZXJPYmplY3QkZXh0ZW5kKSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9jb3JlX29iamVjdCcsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdjb250YWluZXInLCAnQGVtYmVyL2RlcHJlY2F0ZWQtZmVhdHVyZXMnLCAnQGVtYmVyL3BvbHlmaWxscycsICdlbWJlci11dGlscycsICdAZW1iZXIvcnVubG9vcCcsICdlbWJlci1tZXRhJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXJ1bnRpbWUvbGliL21peGlucy9hY3Rpb25faGFuZGxlcicsICdAZW1iZXIvZGVidWcnLCAnZW1iZXItZW52aXJvbm1lbnQnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsLCBfY29udGFpbmVyLCBfZGVwcmVjYXRlZEZlYXR1cmVzLCBfcG9seWZpbGxzLCBfZW1iZXJVdGlscywgX3J1bmxvb3AsIF9lbWJlck1ldGEsIF9lbWJlck1ldGFsLCBfYWN0aW9uX2hhbmRsZXIsIF9kZWJ1ZywgX2VtYmVyRW52aXJvbm1lbnQpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgQG1vZHVsZSBAZW1iZXIvb2JqZWN0CiAgKi8KCiAgdmFyIGFwcGx5TWl4aW4gPSBfZW1iZXJNZXRhbC5NaXhpbi5fYXBwbHk7CiAgdmFyIF9yZW9wZW4gPSBfZW1iZXJNZXRhbC5NaXhpbi5wcm90b3R5cGUucmVvcGVuOwoKICB2YXIgd2FzQXBwbGllZCA9IG5ldyBfZW1iZXJVdGlscy5XZWFrU2V0KCk7CgogIHZhciBmYWN0b3J5TWFwID0gbmV3IFdlYWtNYXAoKTsKCiAgdmFyIHByb3RvdHlwZU1peGluTWFwID0gbmV3IFdlYWtNYXAoKTsKICB2YXIgY2xhc3NNaXhpbk1hcCA9IG5ldyBXZWFrTWFwKCk7CgogIC8qKgogICAgQGNsYXNzIENvcmVPYmplY3QKICAgIEBwdWJsaWMKICAqLwoKICB2YXIgQ29yZU9iamVjdCA9IGZ1bmN0aW9uICgpIHsKICAgIENvcmVPYmplY3QuX2luaXRGYWN0b3J5ID0gZnVuY3Rpb24gX2luaXRGYWN0b3J5KGZhY3RvcnkpIHsKICAgICAgZmFjdG9yeU1hcC5zZXQodGhpcywgZmFjdG9yeSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIENvcmVPYmplY3QocHJvcGVydGllcykgewogICAgICB2YXIgX3NlbGY7CgogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENvcmVPYmplY3QpOwoKICAgICAgLy8gcGx1Y2sgb2ZmIGZhY3RvcnkKICAgICAgdmFyIGluaXRGYWN0b3J5ID0gZmFjdG9yeU1hcC5nZXQodGhpcy5jb25zdHJ1Y3Rvcik7CiAgICAgIGlmIChpbml0RmFjdG9yeSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZmFjdG9yeU1hcC5kZWxldGUodGhpcy5jb25zdHJ1Y3Rvcik7CiAgICAgICAgX2NvbnRhaW5lci5GQUNUT1JZX0ZPUi5zZXQodGhpcywgaW5pdEZhY3RvcnkpOwogICAgICB9CgogICAgICAvLyBwcmVwYXJlIHByb3RvdHlwZS4uLgogICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvKCk7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICB2YXIgYmVmb3JlSW5pdENhbGxlZCA9IHZvaWQgMDsgLy8gb25seSB1c2VkIGluIGRlYnVnIGJ1aWxkcyB0byBlbmFibGUgdGhlIHByb3h5IHRyYXAKCiAgICAgIC8vIHVzaW5nIERFQlVHIGhlcmUgdG8gYXZvaWQgdGhlIGV4dHJhbmVvdXMgdmFyaWFibGUgd2hlbiBub3QgbmVlZGVkCiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgYmVmb3JlSW5pdENhbGxlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICh0cnVlICYmIF9lbWJlclV0aWxzLkhBU19OQVRJVkVfUFJPWFkgJiYgdHlwZW9mIHNlbGYudW5rbm93blByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIG1lc3NhZ2VGb3IgPSBmdW5jdGlvbiAob2JqLCBwcm9wZXJ0eSkgewogICAgICAgICAgcmV0dXJuICdZb3UgYXR0ZW1wdGVkIHRvIGFjY2VzcyB0aGUgYCcgKyBTdHJpbmcocHJvcGVydHkpICsgJ2AgcHJvcGVydHkgKG9mICcgKyBvYmogKyAnKS5cbicgKyAnU2luY2UgRW1iZXIgMy4xLCB0aGlzIGlzIHVzdWFsbHkgZmluZSBhcyB5b3Ugbm8gbG9uZ2VyIG5lZWQgdG8gdXNlIGAuZ2V0KClgXG4nICsgJ3RvIGFjY2VzcyBjb21wdXRlZCBwcm9wZXJ0aWVzLiBIb3dldmVyLCBpbiB0aGlzIGNhc2UsIHRoZSBvYmplY3QgaW4gcXVlc3Rpb25cbicgKyAnaXMgYSBzcGVjaWFsIGtpbmQgb2YgRW1iZXIgb2JqZWN0IChhIHByb3h5KS4gVGhlcmVmb3JlLCBpdCBpcyBzdGlsbCBuZWNlc3NhcnlcbicgKyAoJ3RvIHVzZSBgLmdldChcJycgKyBTdHJpbmcocHJvcGVydHkpICsgJ1wnKWAgaW4gdGhpcyBjYXNlLlxuXG4nKSArICdJZiB5b3UgZW5jb3VudGVyZWQgdGhpcyBlcnJvciBiZWNhdXNlIG9mIHRoaXJkLXBhcnR5IGNvZGUgdGhhdCB5b3UgZG9uXCd0IGNvbnRyb2wsXG4nICsgJ3RoZXJlIGlzIG1vcmUgaW5mb3JtYXRpb24gYXQgaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXIuanMvaXNzdWVzLzE2MTQ4LCBhbmRcbicgKyAneW91IGNhbiBoZWxwIHVzIGltcHJvdmUgdGhpcyBlcnJvciBtZXNzYWdlIGJ5IHRlbGxpbmcgdXMgbW9yZSBhYm91dCB3aGF0IGhhcHBlbmVkIGluXG4nICsgJ3RoaXMgc2l0dWF0aW9uLic7CiAgICAgICAgfTsKCiAgICAgICAgLyogZ2xvYmFscyBQcm94eSBSZWZsZWN0ICovCiAgICAgICAgc2VsZiA9IG5ldyBQcm94eSh0aGlzLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikgewogICAgICAgICAgICBpZiAocHJvcGVydHkgPT09IF9lbWJlck1ldGFsLlBST1hZX0NPTlRFTlQpIHsKICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB9IGVsc2UgaWYgKGJlZm9yZUluaXRDYWxsZWQgfHwgdHlwZW9mIHByb3BlcnR5ID09PSAnc3ltYm9sJyB8fCAoMCwgX2VtYmVyVXRpbHMuaXNJbnRlcm5hbFN5bWJvbCkocHJvcGVydHkpIHx8IHByb3BlcnR5ID09PSAndG9KU09OJyB8fCBwcm9wZXJ0eSA9PT0gJ3RvU3RyaW5nJyB8fCBwcm9wZXJ0eSA9PT0gJ3RvU3RyaW5nRXh0ZW5zaW9uJyB8fCBwcm9wZXJ0eSA9PT0gJ2RpZERlZmluZVByb3BlcnR5JyB8fCBwcm9wZXJ0eSA9PT0gJ3dpbGxXYXRjaFByb3BlcnR5JyB8fCBwcm9wZXJ0eSA9PT0gJ2RpZFVud2F0Y2hQcm9wZXJ0eScgfHwgcHJvcGVydHkgPT09ICdkaWRBZGRMaXN0ZW5lcicgfHwgcHJvcGVydHkgPT09ICdkaWRSZW1vdmVMaXN0ZW5lcicgfHwgcHJvcGVydHkgPT09ICdpc0Rlc2NyaXB0b3InIHx8IHByb3BlcnR5ID09PSAnX29uTG9va3VwJyB8fCBwcm9wZXJ0eSBpbiB0YXJnZXQpIHsKICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdmFsdWUgPSB0YXJnZXQudW5rbm93blByb3BlcnR5LmNhbGwocmVjZWl2ZXIsIHByb3BlcnR5KTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAodHJ1ZSAmJiAhKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KShtZXNzYWdlRm9yKHJlY2VpdmVyLCBwcm9wZXJ0eSksIHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBfY29udGFpbmVyLkZBQ1RPUllfRk9SLnNldChzZWxmLCBpbml0RmFjdG9yeSk7CiAgICAgIH0KCiAgICAgIHZhciBtID0gKDAsIF9lbWJlck1ldGEubWV0YSkoc2VsZik7CiAgICAgIHZhciBwcm90byA9IG0ucHJvdG87CiAgICAgIG0ucHJvdG8gPSBzZWxmOwoKICAgICAgaWYgKHByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICh0cnVlICYmICEodHlwZW9mIHByb3BlcnRpZXMgPT09ICdvYmplY3QnICYmIHByb3BlcnRpZXMgIT09IG51bGwpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRW1iZXJPYmplY3QuY3JlYXRlIG9ubHkgYWNjZXB0cyBvYmplY3RzLicsIHR5cGVvZiBwcm9wZXJ0aWVzID09PSAnb2JqZWN0JyAmJiBwcm9wZXJ0aWVzICE9PSBudWxsKSk7CiAgICAgICAgKHRydWUgJiYgISghKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5NaXhpbikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRW1iZXJPYmplY3QuY3JlYXRlIG5vIGxvbmdlciBzdXBwb3J0cyBtaXhpbmcgaW4gb3RoZXIgJyArICdkZWZpbml0aW9ucywgdXNlIC5leHRlbmQgJiAuY3JlYXRlIHNlcGFyYXRlbHkgaW5zdGVhZC4nLCAhKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5NaXhpbikpKTsKCgogICAgICAgIHZhciBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzID0gc2VsZi5jb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOwogICAgICAgIHZhciBtZXJnZWRQcm9wZXJ0aWVzID0gc2VsZi5tZXJnZWRQcm9wZXJ0aWVzOwogICAgICAgIHZhciBoYXNDb25jYXRlbmF0ZWRQcm9wcyA9IGNvbmNhdGVuYXRlZFByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCAmJiBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzLmxlbmd0aCA+IDA7CiAgICAgICAgdmFyIGhhc01lcmdlZFByb3BzID0gbWVyZ2VkUHJvcGVydGllcyAhPT0gdW5kZWZpbmVkICYmIG1lcmdlZFByb3BlcnRpZXMubGVuZ3RoID4gMDsKCiAgICAgICAgdmFyIGtleU5hbWVzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5TmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBrZXlOYW1lID0ga2V5TmFtZXNbaV07CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wZXJ0aWVzW2tleU5hbWVdOwoKICAgICAgICAgIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkJJTkRJTkdfU1VQUE9SVCAmJiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0VOQUJMRV9CSU5ESU5HX1NVUFBPUlQgJiYgX2VtYmVyTWV0YWwuTWl4aW4uZGV0ZWN0QmluZGluZyhrZXlOYW1lKSkgewogICAgICAgICAgICBtLndyaXRlQmluZGluZ3Moa2V5TmFtZSwgdmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgICh0cnVlICYmICEoISh2YWx1ZSBpbnN0YW5jZW9mIF9lbWJlck1ldGFsLkNvbXB1dGVkUHJvcGVydHkpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgZGVmaW5pbmcgY29tcHV0ZWQgJyArICdwcm9wZXJ0aWVzLiBEZWZpbmUgY29tcHV0ZWQgcHJvcGVydGllcyB1c2luZyBleHRlbmQoKSBvciByZW9wZW4oKSAnICsgJ2JlZm9yZSBjYWxsaW5nIGNyZWF0ZSgpLicsICEodmFsdWUgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5Db21wdXRlZFByb3BlcnR5KSkpOwogICAgICAgICAgKHRydWUgJiYgISghKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiB2YWx1ZS50b1N0cmluZygpLmluZGV4T2YoJy5fc3VwZXInKSAhPT0gLTEpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0VtYmVyT2JqZWN0LmNyZWF0ZSBubyBsb25nZXIgc3VwcG9ydHMgZGVmaW5pbmcgbWV0aG9kcyB0aGF0IGNhbGwgX3N1cGVyLicsICEodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmIHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZignLl9zdXBlcicpICE9PSAtMSkpKTsKICAgICAgICAgICh0cnVlICYmICEoIShrZXlOYW1lID09PSAnYWN0aW9ucycgJiYgX2FjdGlvbl9oYW5kbGVyLmRlZmF1bHQuZGV0ZWN0KHRoaXMpKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdgYWN0aW9uc2AgbXVzdCBiZSBwcm92aWRlZCBhdCBleHRlbmQgdGltZSwgbm90IGF0IGNyZWF0ZSB0aW1lLCAnICsgJ3doZW4gRW1iZXIuQWN0aW9uSGFuZGxlciBpcyB1c2VkIChpLmUuIHZpZXdzLCBjb250cm9sbGVycyAmIHJvdXRlcykuJywgIShrZXlOYW1lID09PSAnYWN0aW9ucycgJiYgX2FjdGlvbl9oYW5kbGVyLmRlZmF1bHQuZGV0ZWN0KHRoaXMpKSkpOwoKCiAgICAgICAgICB2YXIgcG9zc2libGVEZXNjID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikoc2VsZiwga2V5TmFtZSwgbSk7CiAgICAgICAgICB2YXIgaXNEZXNjcmlwdG9yID0gcG9zc2libGVEZXNjICE9PSB1bmRlZmluZWQ7CgogICAgICAgICAgaWYgKCFpc0Rlc2NyaXB0b3IpIHsKICAgICAgICAgICAgdmFyIGJhc2VWYWx1ZSA9IHNlbGZba2V5TmFtZV07CgogICAgICAgICAgICBpZiAoaGFzQ29uY2F0ZW5hdGVkUHJvcHMgJiYgY29uY2F0ZW5hdGVkUHJvcGVydGllcy5pbmRleE9mKGtleU5hbWUpID4gLTEpIHsKICAgICAgICAgICAgICBpZiAoYmFzZVZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9ICgwLCBfZW1iZXJVdGlscy5tYWtlQXJyYXkpKGJhc2VWYWx1ZSkuY29uY2F0KHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsdWUgPSAoMCwgX2VtYmVyVXRpbHMubWFrZUFycmF5KSh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzTWVyZ2VkUHJvcHMgJiYgbWVyZ2VkUHJvcGVydGllcy5pbmRleE9mKGtleU5hbWUpID4gLTEpIHsKICAgICAgICAgICAgICB2YWx1ZSA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIGJhc2VWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzRGVzY3JpcHRvcikgewogICAgICAgICAgICBwb3NzaWJsZURlc2Muc2V0KHNlbGYsIGtleU5hbWUsIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlbGYuc2V0VW5rbm93blByb3BlcnR5ID09PSAnZnVuY3Rpb24nICYmICEoa2V5TmFtZSBpbiBzZWxmKSkgewogICAgICAgICAgICBzZWxmLnNldFVua25vd25Qcm9wZXJ0eShrZXlOYW1lLCB2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgICgwLCBfZW1iZXJNZXRhbC5kZWZpbmVQcm9wZXJ0eSkoc2VsZiwga2V5TmFtZSwgbnVsbCwgdmFsdWUsIG0pOyAvLyBzZXR1cCBtYW5kYXRvcnkgc2V0dGVyCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZltrZXlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoX2RlcHJlY2F0ZWRGZWF0dXJlcy5CSU5ESU5HX1NVUFBPUlQgJiYgX2VtYmVyRW52aXJvbm1lbnQuRU5WLl9FTkFCTEVfQklORElOR19TVVBQT1JUKSB7CiAgICAgICAgX2VtYmVyTWV0YWwuTWl4aW4uZmluaXNoUGFydGlhbChzZWxmLCBtKTsKICAgICAgfQoKICAgICAgLy8gdXNpbmcgREVCVUcgaGVyZSB0byBhdm9pZCB0aGUgZXh0cmFuZW91cyB2YXJpYWJsZSB3aGVuIG5vdCBuZWVkZWQKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBiZWZvcmVJbml0Q2FsbGVkID0gZmFsc2U7CiAgICAgIH0KICAgICAgKF9zZWxmID0gc2VsZikuaW5pdC5hcHBseShfc2VsZiwgYXJndW1lbnRzKTsKCiAgICAgIG0ucHJvdG8gPSBwcm90bzsKICAgICAgKDAsIF9lbWJlck1ldGFsLmZpbmlzaENoYWlucykobSk7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5zZW5kRXZlbnQpKHNlbGYsICdpbml0JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgbSk7CgogICAgICAvLyBvbmx5IHJldHVybiB3aGVuIGluIGRlYnVnIGJ1aWxkcyBhbmQgYHNlbGZgIGlzIHRoZSBwcm94eSBjcmVhdGVkIGFib3ZlCiAgICAgIGlmICh0cnVlICYmIHNlbGYgIT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgfQogICAgfQoKICAgIENvcmVPYmplY3QucHJvdG90eXBlLnJlb3BlbiA9IGZ1bmN0aW9uIHJlb3BlbigpIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogICAgICB9CgogICAgICBhcHBseU1peGluKHRoaXMsIGFyZ3MsIHRydWUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgQ29yZU9iamVjdC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIGluaXQoKSB7fTsKCiAgICBDb3JlT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdmFyIG0gPSAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkodGhpcyk7CiAgICAgIGlmIChtLmlzU291cmNlRGVzdHJveWluZygpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBtLnNldFNvdXJjZURlc3Ryb3lpbmcoKTsKCiAgICAgICgwLCBfcnVubG9vcC5zY2hlZHVsZSkoJ2FjdGlvbnMnLCB0aGlzLCB0aGlzLndpbGxEZXN0cm95KTsKICAgICAgKDAsIF9ydW5sb29wLnNjaGVkdWxlKSgnZGVzdHJveScsIHRoaXMsIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3ksIG0pOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIENvcmVPYmplY3QucHJvdG90eXBlLndpbGxEZXN0cm95ID0gZnVuY3Rpb24gd2lsbERlc3Ryb3koKSB7fTsKCiAgICBDb3JlT2JqZWN0LnByb3RvdHlwZS5fc2NoZWR1bGVkRGVzdHJveSA9IGZ1bmN0aW9uIF9zY2hlZHVsZWREZXN0cm95KG0pIHsKICAgICAgaWYgKG0uaXNTb3VyY2VEZXN0cm95ZWQoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAoMCwgX2VtYmVyTWV0YS5kZWxldGVNZXRhKSh0aGlzKTsKICAgICAgbS5zZXRTb3VyY2VEZXN0cm95ZWQoKTsKICAgIH07CgogICAgQ29yZU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgdmFyIGhhc1RvU3RyaW5nRXh0ZW5zaW9uID0gdHlwZW9mIHRoaXMudG9TdHJpbmdFeHRlbnNpb24gPT09ICdmdW5jdGlvbic7CiAgICAgIHZhciBleHRlbnNpb24gPSBoYXNUb1N0cmluZ0V4dGVuc2lvbiA/ICc6JyArIHRoaXMudG9TdHJpbmdFeHRlbnNpb24oKSA6ICcnOwoKICAgICAgdmFyIHJldCA9ICc8JyArICgoMCwgX2VtYmVyVXRpbHMuZ2V0TmFtZSkodGhpcykgfHwgX2NvbnRhaW5lci5GQUNUT1JZX0ZPUi5nZXQodGhpcykgfHwgdGhpcy5jb25zdHJ1Y3Rvci50b1N0cmluZygpKSArICc6JyArICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKSh0aGlzKSArIGV4dGVuc2lvbiArICc+JzsKCiAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIENvcmVPYmplY3QuZXh0ZW5kID0gZnVuY3Rpb24gZXh0ZW5kKCkgewogICAgICB2YXIgQ2xhc3MgPSBmdW5jdGlvbiAoX3JlZikgewogICAgICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoQ2xhc3MsIF9yZWYpOwoKICAgICAgICBmdW5jdGlvbiBDbGFzcygpIHsKICAgICAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgQ2xhc3MpOwogICAgICAgICAgcmV0dXJuICgwLCBfZW1iZXJCYWJlbC5wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKSh0aGlzLCBfcmVmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIENsYXNzOwogICAgICB9KHRoaXMpOwogICAgICBfcmVvcGVuLmFwcGx5KENsYXNzLlByb3RvdHlwZU1peGluLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gQ2xhc3M7CiAgICB9OwoKICAgIENvcmVPYmplY3QuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHByb3BzLCBleHRyYSkgewogICAgICB2YXIgQyA9IHRoaXM7CgogICAgICBpZiAoZXh0cmEgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBuZXcgQyhwcm9wcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBDKGZsYXR0ZW5Qcm9wcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgfQogICAgfTsKCiAgICBDb3JlT2JqZWN0LnJlb3BlbiA9IGZ1bmN0aW9uIHJlb3BlbigpIHsKICAgICAgdGhpcy53aWxsUmVvcGVuKCk7CiAgICAgIF9yZW9wZW4uYXBwbHkodGhpcy5Qcm90b3R5cGVNaXhpbiwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIENvcmVPYmplY3Qud2lsbFJlb3BlbiA9IGZ1bmN0aW9uIHdpbGxSZW9wZW4oKSB7CiAgICAgIHZhciBwID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGlmICh3YXNBcHBsaWVkLmhhcyhwKSkgewogICAgICAgIHdhc0FwcGxpZWQuZGVsZXRlKHApOwogICAgICAgIHByb3RvdHlwZU1peGluTWFwLnNldCh0aGlzLCBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUodGhpcy5Qcm90b3R5cGVNaXhpbikpOwogICAgICB9CiAgICB9OwoKICAgIENvcmVPYmplY3QucmVvcGVuQ2xhc3MgPSBmdW5jdGlvbiByZW9wZW5DbGFzcygpIHsKICAgICAgX3Jlb3Blbi5hcHBseSh0aGlzLkNsYXNzTWl4aW4sIGFyZ3VtZW50cyk7CiAgICAgIGFwcGx5TWl4aW4odGhpcywgYXJndW1lbnRzLCBmYWxzZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBDb3JlT2JqZWN0LmRldGVjdCA9IGZ1bmN0aW9uIGRldGVjdChvYmopIHsKICAgICAgaWYgKCdmdW5jdGlvbicgIT09IHR5cGVvZiBvYmopIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd2hpbGUgKG9iaikgewogICAgICAgIGlmIChvYmogPT09IHRoaXMpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBvYmogPSBvYmouc3VwZXJjbGFzczsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIENvcmVPYmplY3QuZGV0ZWN0SW5zdGFuY2UgPSBmdW5jdGlvbiBkZXRlY3RJbnN0YW5jZShvYmopIHsKICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIHRoaXM7CiAgICB9OwoKICAgIENvcmVPYmplY3QubWV0YUZvclByb3BlcnR5ID0gZnVuY3Rpb24gbWV0YUZvclByb3BlcnR5KGtleSkgewogICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvKCk7IC8vIGVuc3VyZSBwcm90b3R5cGUgaXMgaW5pdGlhbGl6ZWQKICAgICAgdmFyIHBvc3NpYmxlRGVzYyA9ICgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKHByb3RvLCBrZXkpOwoKICAgICAgKHRydWUgJiYgIShwb3NzaWJsZURlc2MgIT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdtZXRhRm9yUHJvcGVydHkoKSBjb3VsZCBub3QgZmluZCBhIGNvbXB1dGVkIHByb3BlcnR5IHdpdGgga2V5IFwnJyArIGtleSArICdcJy4nLCBwb3NzaWJsZURlc2MgIT09IHVuZGVmaW5lZCkpOwoKCiAgICAgIHJldHVybiBwb3NzaWJsZURlc2MuX21ldGEgfHwge307CiAgICB9OwoKICAgIENvcmVPYmplY3QuZWFjaENvbXB1dGVkUHJvcGVydHkgPSBmdW5jdGlvbiBlYWNoQ29tcHV0ZWRQcm9wZXJ0eShjYWxsYmFjaykgewogICAgICB2YXIgYmluZGluZyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogdGhpczsKCiAgICAgIHRoaXMucHJvdG8oKTsgLy8gZW5zdXJlIHByb3RvdHlwZSBpcyBpbml0aWFsaXplZAogICAgICB2YXIgZW1wdHkgPSB7fTsKCiAgICAgICgwLCBfZW1iZXJNZXRhLm1ldGEpKHRoaXMucHJvdG90eXBlKS5mb3JFYWNoRGVzY3JpcHRvcnMoZnVuY3Rpb24gKG5hbWUsIGRlc2NyaXB0b3IpIHsKICAgICAgICBpZiAoZGVzY3JpcHRvci5lbnVtZXJhYmxlKSB7CiAgICAgICAgICB2YXIgX21ldGEgPSBkZXNjcmlwdG9yLl9tZXRhIHx8IGVtcHR5OwogICAgICAgICAgY2FsbGJhY2suY2FsbChiaW5kaW5nLCBuYW1lLCBfbWV0YSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgQ29yZU9iamVjdC5wcm90byA9IGZ1bmN0aW9uIHByb3RvKCkgewogICAgICB2YXIgcCA9IHRoaXMucHJvdG90eXBlOwogICAgICBpZiAoIXdhc0FwcGxpZWQuaGFzKHApKSB7CiAgICAgICAgd2FzQXBwbGllZC5hZGQocCk7CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuc3VwZXJjbGFzczsKICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICBwYXJlbnQucHJvdG8oKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Qcm90b3R5cGVNaXhpbi5hcHBseShwKTsKICAgICAgfQogICAgICByZXR1cm4gcDsKICAgIH07CgogICAgKDAsIF9lbWJlckJhYmVsLmNyZWF0ZUNsYXNzKShDb3JlT2JqZWN0LCBbewogICAgICBrZXk6ICdpc0Rlc3Ryb3llZCcsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkodGhpcykuaXNTb3VyY2VEZXN0cm95ZWQoKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3Qgc2V0IGAnICsgdGhpcyArICcuaXNEZXN0cm95ZWRgIGRpcmVjdGx5LCBwbGVhc2UgdXNlIGAuZGVzdHJveSgpYC4nLCBmYWxzZSkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogJ2lzRGVzdHJveWluZycsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YS5wZWVrTWV0YSkodGhpcykuaXNTb3VyY2VEZXN0cm95aW5nKCk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHNldCBgJyArIHRoaXMgKyAnLmlzRGVzdHJveWluZ2AgZGlyZWN0bHksIHBsZWFzZSB1c2UgYC5kZXN0cm95KClgLicsIGZhbHNlKSk7CiAgICAgIH0KICAgIH1dLCBbewogICAgICBrZXk6ICdDbGFzc01peGluJywKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGNsYXNzTWl4aW4gPSBjbGFzc01peGluTWFwLmdldCh0aGlzKTsKICAgICAgICBpZiAoY2xhc3NNaXhpbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMuc3VwZXJjbGFzczsKICAgICAgICAgIGNsYXNzTWl4aW4gPSBzID09PSB1bmRlZmluZWQgPyBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoKSA6IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZShzLkNsYXNzTWl4aW4pOwogICAgICAgICAgY2xhc3NNaXhpbi5vd25lckNvbnN0cnVjdG9yID0gdGhpczsKICAgICAgICAgIGNsYXNzTWl4aW5NYXAuc2V0KHRoaXMsIGNsYXNzTWl4aW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2xhc3NNaXhpbjsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICdQcm90b3R5cGVNaXhpbicsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcm90b3R5cGVNaXhpbiA9IHByb3RvdHlwZU1peGluTWFwLmdldCh0aGlzKTsKICAgICAgICBpZiAocHJvdG90eXBlTWl4aW4gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIHMgPSB0aGlzLnN1cGVyY2xhc3M7CiAgICAgICAgICBwcm90b3R5cGVNaXhpbiA9IHMgPT09IHVuZGVmaW5lZCA/IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSgpIDogX2VtYmVyTWV0YWwuTWl4aW4uY3JlYXRlKHMuUHJvdG90eXBlTWl4aW4pOwogICAgICAgICAgcHJvdG90eXBlTWl4aW4ub3duZXJDb25zdHJ1Y3RvciA9IHRoaXM7CiAgICAgICAgICBwcm90b3R5cGVNaXhpbk1hcC5zZXQodGhpcywgcHJvdG90eXBlTWl4aW4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJvdG90eXBlTWl4aW47CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAnc3VwZXJjbGFzcycsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpOwogICAgICAgIGlmIChjICE9PSBGdW5jdGlvbi5wcm90b3R5cGUpIHJldHVybiBjOwogICAgICB9CiAgICB9XSk7CiAgICByZXR1cm4gQ29yZU9iamVjdDsKICB9KCk7CgogIC8vIENvcmVPYmplY3QucHJvdG90eXBlLmNvbmNhdGVuYXRlZFByb3BlcnRpZXMgPSBudWxsOwogIC8vIENvcmVPYmplY3QucHJvdG90eXBlLm1lcmdlZFByb3BlcnRpZXMgPSBudWxsOwoKICBDb3JlT2JqZWN0LnRvU3RyaW5nID0gX2VtYmVyTWV0YWwuY2xhc3NUb1N0cmluZzsKICAoMCwgX2VtYmVyVXRpbHMuc2V0TmFtZSkoQ29yZU9iamVjdCwgJ0VtYmVyLkNvcmVPYmplY3QnKTsKCiAgQ29yZU9iamVjdC5Qcm90b3R5cGVNaXhpbi5vd25lckNvbnN0cnVjdG9yID0gQ29yZU9iamVjdDsKCiAgQ29yZU9iamVjdC5pc0NsYXNzID0gdHJ1ZTsKICBDb3JlT2JqZWN0LmlzTWV0aG9kID0gZmFsc2U7CgogIGZ1bmN0aW9uIGZsYXR0ZW5Qcm9wcygpIHsKICAgIHZhciBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzID0gdGhpcy5jb25jYXRlbmF0ZWRQcm9wZXJ0aWVzLAogICAgICAgIG1lcmdlZFByb3BlcnRpZXMgPSB0aGlzLm1lcmdlZFByb3BlcnRpZXM7CgogICAgdmFyIGhhc0NvbmNhdGVuYXRlZFByb3BzID0gY29uY2F0ZW5hdGVkUHJvcGVydGllcyAhPT0gdW5kZWZpbmVkICYmIGNvbmNhdGVuYXRlZFByb3BlcnRpZXMubGVuZ3RoID4gMDsKICAgIHZhciBoYXNNZXJnZWRQcm9wcyA9IG1lcmdlZFByb3BlcnRpZXMgIT09IHVuZGVmaW5lZCAmJiBtZXJnZWRQcm9wZXJ0aWVzLmxlbmd0aCA+IDA7CgogICAgdmFyIGluaXRQcm9wZXJ0aWVzID0ge307CgogICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBwcm9wcyA9IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgIHByb3BzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgcHJvcGVydGllcyA9IHByb3BzW2ldOwoKICAgICAgKHRydWUgJiYgISghKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5NaXhpbikpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRW1iZXJPYmplY3QuY3JlYXRlIG5vIGxvbmdlciBzdXBwb3J0cyBtaXhpbmcgaW4gb3RoZXIgJyArICdkZWZpbml0aW9ucywgdXNlIC5leHRlbmQgJiAuY3JlYXRlIHNlcGFyYXRlbHkgaW5zdGVhZC4nLCAhKHByb3BlcnRpZXMgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5NaXhpbikpKTsKCgogICAgICB2YXIga2V5TmFtZXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKTsKCiAgICAgIGZvciAodmFyIGogPSAwLCBrID0ga2V5TmFtZXMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgdmFyIGtleU5hbWUgPSBrZXlOYW1lc1tqXTsKICAgICAgICB2YXIgdmFsdWUgPSBwcm9wZXJ0aWVzW2tleU5hbWVdOwoKICAgICAgICBpZiAoaGFzQ29uY2F0ZW5hdGVkUHJvcHMgJiYgY29uY2F0ZW5hdGVkUHJvcGVydGllcy5pbmRleE9mKGtleU5hbWUpID4gLTEpIHsKICAgICAgICAgIHZhciBiYXNlVmFsdWUgPSBpbml0UHJvcGVydGllc1trZXlOYW1lXTsKCiAgICAgICAgICBpZiAoYmFzZVZhbHVlKSB7CiAgICAgICAgICAgIHZhbHVlID0gKDAsIF9lbWJlclV0aWxzLm1ha2VBcnJheSkoYmFzZVZhbHVlKS5jb25jYXQodmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSAoMCwgX2VtYmVyVXRpbHMubWFrZUFycmF5KSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaGFzTWVyZ2VkUHJvcHMgJiYgbWVyZ2VkUHJvcGVydGllcy5pbmRleE9mKGtleU5hbWUpID4gLTEpIHsKICAgICAgICAgIHZhciBfYmFzZVZhbHVlID0gaW5pdFByb3BlcnRpZXNba2V5TmFtZV07CgogICAgICAgICAgdmFsdWUgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCBfYmFzZVZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBpbml0UHJvcGVydGllc1trZXlOYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGluaXRQcm9wZXJ0aWVzOwogIH0KCiAgaWYgKHRydWUpIHsKICAgIC8qKgogICAgICBQcm92aWRlcyBsb29rdXAtdGltZSB0eXBlIHZhbGlkYXRpb24gZm9yIGluamVjdGVkIHByb3BlcnRpZXMuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIF9vbkxvb2t1cAogICAgKi8KICAgIENvcmVPYmplY3QuX29uTG9va3VwID0gZnVuY3Rpb24gaW5qZWN0ZWRQcm9wZXJ0eUFzc2VydGlvbihkZWJ1Z0NvbnRhaW5lcktleSkgewogICAgICB2YXIgX2RlYnVnQ29udGFpbmVyS2V5JHNwID0gZGVidWdDb250YWluZXJLZXkuc3BsaXQoJzonKSwKICAgICAgICAgIHR5cGUgPSBfZGVidWdDb250YWluZXJLZXkkc3BbMF07CgogICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvKCk7CgogICAgICBmb3IgKHZhciBrZXkgaW4gcHJvdG8pIHsKICAgICAgICB2YXIgZGVzYyA9ICgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKHByb3RvLCBrZXkpOwogICAgICAgIGlmIChkZXNjIGluc3RhbmNlb2YgX2VtYmVyTWV0YWwuSW5qZWN0ZWRQcm9wZXJ0eSkgewogICAgICAgICAgKHRydWUgJiYgISh0eXBlID09PSAnY29udHJvbGxlcicgfHwgZGVzYy50eXBlICE9PSAnY29udHJvbGxlcicpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnRGVmaW5pbmcgYCcgKyBrZXkgKyAnYCBhcyBhbiBpbmplY3RlZCBjb250cm9sbGVyIHByb3BlcnR5IG9uIGEgbm9uLWNvbnRyb2xsZXIgKGAnICsgZGVidWdDb250YWluZXJLZXkgKyAnYCkgaXMgbm90IGFsbG93ZWQuJywgdHlwZSA9PT0gJ2NvbnRyb2xsZXInIHx8IGRlc2MudHlwZSAhPT0gJ2NvbnRyb2xsZXInKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICBSZXR1cm5zIGEgaGFzaCBvZiBwcm9wZXJ0eSBuYW1lcyBhbmQgY29udGFpbmVyIG5hbWVzIHRoYXQgaW5qZWN0ZWQKICAgICAgcHJvcGVydGllcyB3aWxsIGxvb2t1cCBvbiB0aGUgY29udGFpbmVyIGxhemlseS4KICAgICAgIEBtZXRob2QgX2xhenlJbmplY3Rpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0gSGFzaCBvZiBhbGwgbGF6eSBpbmplY3RlZCBwcm9wZXJ0eSBrZXlzIHRvIGNvbnRhaW5lciBuYW1lcwogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIENvcmVPYmplY3QuX2xhenlJbmplY3Rpb25zID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgaW5qZWN0aW9ucyA9IHt9OwogICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvKCk7CiAgICAgIHZhciBrZXkgPSB2b2lkIDA7CiAgICAgIHZhciBkZXNjID0gdm9pZCAwOwoKICAgICAgZm9yIChrZXkgaW4gcHJvdG8pIHsKICAgICAgICBkZXNjID0gKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikocHJvdG8sIGtleSk7CiAgICAgICAgaWYgKGRlc2MgaW5zdGFuY2VvZiBfZW1iZXJNZXRhbC5JbmplY3RlZFByb3BlcnR5KSB7CiAgICAgICAgICBpbmplY3Rpb25zW2tleV0gPSB7CiAgICAgICAgICAgIG5hbWVzcGFjZTogZGVzYy5uYW1lc3BhY2UsCiAgICAgICAgICAgIHNvdXJjZTogZGVzYy5zb3VyY2UsCiAgICAgICAgICAgIHNwZWNpZmllcjogZGVzYy50eXBlICsgJzonICsgKGRlc2MubmFtZSB8fCBrZXkpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGluamVjdGlvbnM7CiAgICB9OwogIH0KCiAgZXhwb3J0cy5kZWZhdWx0ID0gQ29yZU9iamVjdDsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvc3lzdGVtL25hbWVzcGFjZScsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCcsICdlbWJlci11dGlscycsICdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCwgX2VtYmVyVXRpbHMsIF9vYmplY3QpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgQSBOYW1lc3BhY2UgaXMgYW4gb2JqZWN0IHVzdWFsbHkgdXNlZCB0byBjb250YWluIG90aGVyIG9iamVjdHMgb3IgbWV0aG9kcwogICAgc3VjaCBhcyBhbiBhcHBsaWNhdGlvbiBvciBmcmFtZXdvcmsuIENyZWF0ZSBhIG5hbWVzcGFjZSBhbnl0aW1lIHlvdSB3YW50CiAgICB0byBkZWZpbmUgb25lIG9mIHRoZXNlIG5ldyBjb250YWluZXJzLgogIAogICAgIyBFeGFtcGxlIFVzYWdlCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBNeUZyYW1ld29yayA9IEVtYmVyLk5hbWVzcGFjZS5jcmVhdGUoewogICAgICBWRVJTSU9OOiAnMS4wLjAnCiAgICB9KTsKICAgIGBgYAogIAogICAgQGNsYXNzIE5hbWVzcGFjZQogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQGV4dGVuZHMgRW1iZXJPYmplY3QKICAgIEBwdWJsaWMKICAqLwogIC8vIFByZWxvYWRlZCBpbnRvIG5hbWVzcGFjZXMKICB2YXIgTmFtZXNwYWNlID0gX29iamVjdC5kZWZhdWx0LmV4dGVuZCh7CiAgICBpc05hbWVzcGFjZTogdHJ1ZSwKCiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICgwLCBfZW1iZXJNZXRhbC5hZGROYW1lc3BhY2UpKHRoaXMpOwogICAgfSwKICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBuYW1lID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ25hbWUnKSB8fCAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnbW9kdWxlUHJlZml4Jyk7CiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgIH0KICAgICAgKDAsIF9lbWJlck1ldGFsLmZpbmROYW1lc3BhY2VzKSgpOwogICAgICBuYW1lID0gKDAsIF9lbWJlclV0aWxzLmdldE5hbWUpKHRoaXMpOwogICAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbmFtZSA9ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKSh0aGlzKTsKICAgICAgICAoMCwgX2VtYmVyVXRpbHMuc2V0TmFtZSkodGhpcywgbmFtZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5hbWU7CiAgICB9LAogICAgbmFtZUNsYXNzZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLnByb2Nlc3NOYW1lc3BhY2UpKHRoaXMpOwogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgKDAsIF9lbWJlck1ldGFsLnJlbW92ZU5hbWVzcGFjZSkodGhpcyk7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfSk7IC8qKgogICAgICBAbW9kdWxlIGVtYmVyCiAgICAgICovCgoKICBOYW1lc3BhY2UucmVvcGVuQ2xhc3MoewogICAgTkFNRVNQQUNFUzogX2VtYmVyTWV0YWwuTkFNRVNQQUNFUywKICAgIE5BTUVTUEFDRVNfQllfSUQ6IF9lbWJlck1ldGFsLk5BTUVTUEFDRVNfQllfSUQsCiAgICBwcm9jZXNzQWxsOiBfZW1iZXJNZXRhbC5wcm9jZXNzQWxsTmFtZXNwYWNlcywKICAgIGJ5TmFtZTogX2VtYmVyTWV0YWwuZmluZE5hbWVzcGFjZQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBOYW1lc3BhY2U7Cn0pOwplbmlmZWQoJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9vYmplY3QnLCBbJ2V4cG9ydHMnLCAnY29udGFpbmVyJywgJ2VtYmVyLW93bmVyJywgJ2VtYmVyLXV0aWxzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9jb3JlX29iamVjdCcsICdlbWJlci1ydW50aW1lL2xpYi9taXhpbnMvb2JzZXJ2YWJsZScsICdAZW1iZXIvZGVidWcnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9jb250YWluZXIsIF9lbWJlck93bmVyLCBfZW1iZXJVdGlscywgX2VtYmVyTWV0YWwsIF9jb3JlX29iamVjdCwgX29ic2VydmFibGUsIF9kZWJ1ZykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5GcmFtZXdvcmtPYmplY3QgPSB1bmRlZmluZWQ7CgogIHZhciBfQ29yZU9iamVjdCRleHRlbmQ7CgogIHZhciBPVkVSUklERV9PV05FUiA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdPVkVSUklERV9PV05FUicpOwoKICAvKioKICAgIGBFbWJlck9iamVjdGAgaXMgdGhlIG1haW4gYmFzZSBjbGFzcyBmb3IgYWxsIEVtYmVyIG9iamVjdHMuIEl0IGlzIGEgc3ViY2xhc3MKICAgIG9mIGBDb3JlT2JqZWN0YCB3aXRoIHRoZSBgT2JzZXJ2YWJsZWAgbWl4aW4gYXBwbGllZC4gRm9yIGRldGFpbHMsCiAgICBzZWUgdGhlIGRvY3VtZW50YXRpb24gZm9yIGVhY2ggb2YgdGhlc2UuCiAgCiAgICBAY2xhc3MgRW1iZXJPYmplY3QKICAgIEBleHRlbmRzIENvcmVPYmplY3QKICAgIEB1c2VzIE9ic2VydmFibGUKICAgIEBwdWJsaWMKICAqLwogIHZhciBFbWJlck9iamVjdCA9IF9jb3JlX29iamVjdC5kZWZhdWx0LmV4dGVuZChfb2JzZXJ2YWJsZS5kZWZhdWx0LCAoX0NvcmVPYmplY3QkZXh0ZW5kID0gewogICAgX2RlYnVnQ29udGFpbmVyS2V5OiAoMCwgX2VtYmVyTWV0YWwuZGVzY3JpcHRvcikoewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGZhY3RvcnkgPSBfY29udGFpbmVyLkZBQ1RPUllfRk9SLmdldCh0aGlzKTsKCiAgICAgICAgcmV0dXJuIGZhY3RvcnkgIT09IHVuZGVmaW5lZCAmJiBmYWN0b3J5LmZ1bGxOYW1lOwogICAgICB9CiAgICB9KQoKICB9LCBfQ29yZU9iamVjdCRleHRlbmRbX2VtYmVyT3duZXIuT1dORVJdID0gKDAsIF9lbWJlck1ldGFsLmRlc2NyaXB0b3IpKHsKICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzW09WRVJSSURFX09XTkVSXSkgewogICAgICAgIHJldHVybiB0aGlzW09WRVJSSURFX09XTkVSXTsKICAgICAgfQoKICAgICAgdmFyIGZhY3RvcnkgPSBfY29udGFpbmVyLkZBQ1RPUllfRk9SLmdldCh0aGlzKTsKCiAgICAgIHJldHVybiBmYWN0b3J5ICE9PSB1bmRlZmluZWQgJiYgZmFjdG9yeS5vd25lcjsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB0aGlzW09WRVJSSURFX09XTkVSXSA9IHZhbHVlOwogICAgfQogIH0pLCBfQ29yZU9iamVjdCRleHRlbmQpKTsKCiAgKDAsIF9lbWJlclV0aWxzLnNldE5hbWUpKEVtYmVyT2JqZWN0LCAnRW1iZXIuT2JqZWN0Jyk7CgogIHZhciBGcmFtZXdvcmtPYmplY3QgPSBleHBvcnRzLkZyYW1ld29ya09iamVjdCA9IEVtYmVyT2JqZWN0OwoKICBpZiAodHJ1ZSkgewogICAgdmFyIF9FbWJlck9iamVjdCRleHRlbmQ7CgogICAgdmFyIElOSVRfV0FTX0NBTExFRCA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdJTklUX1dBU19DQUxMRUQnKTsKICAgIHZhciBBU1NFUlRfSU5JVF9XQVNfQ0FMTEVEID0gKDAsIF9lbWJlclV0aWxzLnN5bWJvbCkoJ0FTU0VSVF9JTklUX1dBU19DQUxMRUQnKTsKCiAgICBleHBvcnRzLkZyYW1ld29ya09iamVjdCA9IEZyYW1ld29ya09iamVjdCA9IEVtYmVyT2JqZWN0LmV4dGVuZCgoX0VtYmVyT2JqZWN0JGV4dGVuZCA9IHsKICAgICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpc1tJTklUX1dBU19DQUxMRURdID0gdHJ1ZTsKICAgICAgfQogICAgfSwgX0VtYmVyT2JqZWN0JGV4dGVuZFtBU1NFUlRfSU5JVF9XQVNfQ0FMTEVEXSA9ICgwLCBfZW1iZXJNZXRhbC5vbikoJ2luaXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICh0cnVlICYmICEodGhpc1tJTklUX1dBU19DQUxMRURdKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBtdXN0IGNhbGwgYHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7YCB3aGVuIG92ZXJyaWRpbmcgYGluaXRgIG9uIGEgZnJhbWV3b3JrIG9iamVjdC4gUGxlYXNlIHVwZGF0ZSAnICsgdGhpcyArICcgdG8gY2FsbCBgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTtgIGZyb20gYGluaXRgLicsIHRoaXNbSU5JVF9XQVNfQ0FMTEVEXSkpOwogICAgfSksIF9FbWJlck9iamVjdCRleHRlbmQpKTsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyT2JqZWN0Owp9KTsKZW5pZmVkKCdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0X3Byb3h5JywgWydleHBvcnRzJywgJ2VtYmVyLXJ1bnRpbWUvbGliL3N5c3RlbS9vYmplY3QnLCAnZW1iZXItcnVudGltZS9saWIvbWl4aW5zLy1wcm94eSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX29iamVjdCwgX3Byb3h5KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfb2JqZWN0LmRlZmF1bHQuZXh0ZW5kKF9wcm94eS5kZWZhdWx0KTsKfSk7CmVuaWZlZCgnZW1iZXItcnVudGltZS9saWIvdHlwZS1vZicsIFsnZXhwb3J0cycsICdlbWJlci1ydW50aW1lL2xpYi9zeXN0ZW0vb2JqZWN0J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfb2JqZWN0KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLnR5cGVPZiA9IHR5cGVPZjsKCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4KICAvLyBUWVBJTkcgJiBBUlJBWSBNRVNTQUdJTkcKICAvLwogIHZhciBUWVBFX01BUCA9IHsKICAgICdbb2JqZWN0IEJvb2xlYW5dJzogJ2Jvb2xlYW4nLAogICAgJ1tvYmplY3QgTnVtYmVyXSc6ICdudW1iZXInLAogICAgJ1tvYmplY3QgU3RyaW5nXSc6ICdzdHJpbmcnLAogICAgJ1tvYmplY3QgRnVuY3Rpb25dJzogJ2Z1bmN0aW9uJywKICAgICdbb2JqZWN0IEFycmF5XSc6ICdhcnJheScsCiAgICAnW29iamVjdCBEYXRlXSc6ICdkYXRlJywKICAgICdbb2JqZWN0IFJlZ0V4cF0nOiAncmVnZXhwJywKICAgICdbb2JqZWN0IE9iamVjdF0nOiAnb2JqZWN0JywKICAgICdbb2JqZWN0IEZpbGVMaXN0XSc6ICdmaWxlbGlzdCcKICB9OwoKICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKCiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3V0aWxzCiAgKi8KICAvKioKICAgIFJldHVybnMgYSBjb25zaXN0ZW50IHR5cGUgZm9yIHRoZSBwYXNzZWQgb2JqZWN0LgogIAogICAgVXNlIHRoaXMgaW5zdGVhZCBvZiB0aGUgYnVpbHQtaW4gYHR5cGVvZmAgdG8gZ2V0IHRoZSB0eXBlIG9mIGFuIGl0ZW0uCiAgICBJdCB3aWxsIHJldHVybiB0aGUgc2FtZSByZXN1bHQgYWNyb3NzIGFsbCBicm93c2VycyBhbmQgaW5jbHVkZXMgYSBiaXQKICAgIG1vcmUgZGV0YWlsLiBIZXJlIGlzIHdoYXQgd2lsbCBiZSByZXR1cm5lZDoKICAKICAgICAgICB8IFJldHVybiBWYWx1ZSAgfCBNZWFuaW5nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICB8ICdzdHJpbmcnICAgICAgfCBTdHJpbmcgcHJpbWl0aXZlIG9yIFN0cmluZyBvYmplY3QuICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdudW1iZXInICAgICAgfCBOdW1iZXIgcHJpbWl0aXZlIG9yIE51bWJlciBvYmplY3QuICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdib29sZWFuJyAgICAgfCBCb29sZWFuIHByaW1pdGl2ZSBvciBCb29sZWFuIG9iamVjdC4gICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdudWxsJyAgICAgICAgfCBOdWxsIHZhbHVlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICd1bmRlZmluZWQnICAgfCBVbmRlZmluZWQgdmFsdWUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdmdW5jdGlvbicgICAgfCBBIGZ1bmN0aW9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdhcnJheScgICAgICAgfCBBbiBpbnN0YW5jZSBvZiBBcnJheSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdyZWdleHAnICAgICAgfCBBbiBpbnN0YW5jZSBvZiBSZWdFeHAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdkYXRlJyAgICAgICAgfCBBbiBpbnN0YW5jZSBvZiBEYXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdmaWxlbGlzdCcgICAgfCBBbiBpbnN0YW5jZSBvZiBGaWxlTGlzdCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdjbGFzcycgICAgICAgfCBBbiBFbWJlciBjbGFzcyAoY3JlYXRlZCB1c2luZyBFbWJlck9iamVjdC5leHRlbmQoKSkgIHwKICAgICAgICB8ICdpbnN0YW5jZScgICAgfCBBbiBFbWJlciBvYmplY3QgaW5zdGFuY2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdlcnJvcicgICAgICAgfCBBbiBpbnN0YW5jZSBvZiB0aGUgRXJyb3Igb2JqZWN0ICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICB8ICdvYmplY3QnICAgICAgfCBBIEphdmFTY3JpcHQgb2JqZWN0IG5vdCBpbmhlcml0aW5nIGZyb20gRW1iZXJPYmplY3QgIHwKICAKICAgIEV4YW1wbGVzOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgQSB9IGZyb20gJ0BlbWJlci9hcnJheSc7CiAgICBpbXBvcnQgeyB0eXBlT2YgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgaW1wb3J0IEVtYmVyT2JqZWN0IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgdHlwZU9mKCk7ICAgICAgICAgICAgICAgICAgICAgICAvLyAndW5kZWZpbmVkJwogICAgdHlwZU9mKG51bGwpOyAgICAgICAgICAgICAgICAgICAvLyAnbnVsbCcKICAgIHR5cGVPZih1bmRlZmluZWQpOyAgICAgICAgICAgICAgLy8gJ3VuZGVmaW5lZCcKICAgIHR5cGVPZignbWljaGFlbCcpOyAgICAgICAgICAgICAgLy8gJ3N0cmluZycKICAgIHR5cGVPZihuZXcgU3RyaW5nKCdtaWNoYWVsJykpOyAgLy8gJ3N0cmluZycKICAgIHR5cGVPZigxMDEpOyAgICAgICAgICAgICAgICAgICAgLy8gJ251bWJlcicKICAgIHR5cGVPZihuZXcgTnVtYmVyKDEwMSkpOyAgICAgICAgLy8gJ251bWJlcicKICAgIHR5cGVPZih0cnVlKTsgICAgICAgICAgICAgICAgICAgLy8gJ2Jvb2xlYW4nCiAgICB0eXBlT2YobmV3IEJvb2xlYW4odHJ1ZSkpOyAgICAgIC8vICdib29sZWFuJwogICAgdHlwZU9mKEEpOyAgICAgICAgICAgICAgICAgICAgICAvLyAnZnVuY3Rpb24nCiAgICB0eXBlT2YoWzEsIDIsIDkwXSk7ICAgICAgICAgICAgIC8vICdhcnJheScKICAgIHR5cGVPZigvYWJjLyk7ICAgICAgICAgICAgICAgICAgLy8gJ3JlZ2V4cCcKICAgIHR5cGVPZihuZXcgRGF0ZSgpKTsgICAgICAgICAgICAgLy8gJ2RhdGUnCiAgICB0eXBlT2YoZXZlbnQudGFyZ2V0LmZpbGVzKTsgICAgIC8vICdmaWxlbGlzdCcKICAgIHR5cGVPZihFbWJlck9iamVjdC5leHRlbmQoKSk7ICAgLy8gJ2NsYXNzJwogICAgdHlwZU9mKEVtYmVyT2JqZWN0LmNyZWF0ZSgpKTsgICAvLyAnaW5zdGFuY2UnCiAgICB0eXBlT2YobmV3IEVycm9yKCd0ZWFtb2NpbCcpKTsgIC8vICdlcnJvcicKICAKICAgIC8vICdub3JtYWwnIEphdmFTY3JpcHQgb2JqZWN0CiAgICB0eXBlT2YoeyBhOiAnYicgfSk7ICAgICAgICAgICAgIC8vICdvYmplY3QnCiAgICBgYGAKICAKICAgIEBtZXRob2QgdHlwZU9mCiAgICBAZm9yIEBlbWJlci91dGlscwogICAgQHBhcmFtIHtPYmplY3R9IGl0ZW0gdGhlIGl0ZW0gdG8gY2hlY2sKICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIHR5cGUKICAgIEBwdWJsaWMKICAgIEBzdGF0aWMKICAqLwogIGZ1bmN0aW9uIHR5cGVPZihpdGVtKSB7CiAgICBpZiAoaXRlbSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gJ251bGwnOwogICAgfQogICAgaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICB9CiAgICB2YXIgcmV0ID0gVFlQRV9NQVBbdG9TdHJpbmcuY2FsbChpdGVtKV0gfHwgJ29iamVjdCc7CgogICAgaWYgKHJldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAoX29iamVjdC5kZWZhdWx0LmRldGVjdChpdGVtKSkgewogICAgICAgIHJldCA9ICdjbGFzcyc7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocmV0ID09PSAnb2JqZWN0JykgewogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgcmV0ID0gJ2Vycm9yJzsKICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgX29iamVjdC5kZWZhdWx0KSB7CiAgICAgICAgcmV0ID0gJ2luc3RhbmNlJzsKICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgIHJldCA9ICdkYXRlJzsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXQ7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2luZGV4JywgWydleHBvcnRzJywgJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QnLCAnZW1iZXItdGVzdGluZy9saWIvYWRhcHRlcnMvYWRhcHRlcicsICdlbWJlci10ZXN0aW5nL2xpYi9zZXR1cF9mb3JfdGVzdGluZycsICdlbWJlci10ZXN0aW5nL2xpYi9hZGFwdGVycy9xdW5pdCcsICdlbWJlci10ZXN0aW5nL2xpYi9zdXBwb3J0JywgJ2VtYmVyLXRlc3RpbmcvbGliL2V4dC9hcHBsaWNhdGlvbicsICdlbWJlci10ZXN0aW5nL2xpYi9leHQvcnN2cCcsICdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzJywgJ2VtYmVyLXRlc3RpbmcvbGliL2luaXRpYWxpemVycyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3Rlc3QsIF9hZGFwdGVyLCBfc2V0dXBfZm9yX3Rlc3RpbmcsIF9xdW5pdCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5RVW5pdEFkYXB0ZXIgPSBleHBvcnRzLnNldHVwRm9yVGVzdGluZyA9IGV4cG9ydHMuQWRhcHRlciA9IGV4cG9ydHMuVGVzdCA9IHVuZGVmaW5lZDsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ1Rlc3QnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdGVzdC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQWRhcHRlcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hZGFwdGVyLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdzZXR1cEZvclRlc3RpbmcnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfc2V0dXBfZm9yX3Rlc3RpbmcuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ1FVbml0QWRhcHRlcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9xdW5pdC5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9hZGFwdGVycy9hZGFwdGVyJywgWydleHBvcnRzJywgJ2VtYmVyLXJ1bnRpbWUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlclJ1bnRpbWUpIHsKICAndXNlIHN0cmljdCc7CgogIGZ1bmN0aW9uIEsoKSB7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8qKgogICBAbW9kdWxlIEBlbWJlci90ZXN0CiAgKi8KCiAgLyoqCiAgICBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgY2xhc3MgaXMgdG8gY3JlYXRlIGhvb2tzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkCiAgICBieSBhbiBhZGFwdGVyIGZvciB2YXJpb3VzIHRlc3QgZnJhbWV3b3Jrcy4KICAKICAgIEBjbGFzcyBUZXN0QWRhcHRlcgogICAgQHB1YmxpYwogICovCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyUnVudGltZS5PYmplY3QuZXh0ZW5kKHsKICAgIC8qKgogICAgICBUaGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyIGFuIGFzeW5jIG9wZXJhdGlvbiBpcyBhYm91dCB0byBzdGFydC4KICAgICAgIE92ZXJyaWRlIHRoaXMgdG8gY2FsbCB5b3VyIGZyYW1ld29yaydzIG1ldGhvZHMgdGhhdCBoYW5kbGUgYXN5bmMKICAgICAgb3BlcmF0aW9ucy4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBhc3luY1N0YXJ0CiAgICAqLwogICAgYXN5bmNTdGFydDogSywKCiAgICAvKioKICAgICAgVGhpcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlciBhbiBhc3luYyBvcGVyYXRpb24gaGFzIGNvbXBsZXRlZC4KICAgICAgIEBwdWJsaWMKICAgICAgQG1ldGhvZCBhc3luY0VuZAogICAgKi8KICAgIGFzeW5jRW5kOiBLLAoKICAgIC8qKgogICAgICBPdmVycmlkZSB0aGlzIG1ldGhvZCB3aXRoIHlvdXIgdGVzdGluZyBmcmFtZXdvcmsncyBmYWxzZSBhc3NlcnRpb24uCiAgICAgIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdoZW5ldmVyIGFuIGV4Y2VwdGlvbiBvY2N1cnMgY2F1c2luZyB0aGUgdGVzdGluZwogICAgICBwcm9taXNlIHRvIGZhaWwuCiAgICAgICBRVW5pdCBleGFtcGxlOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAgIGV4Y2VwdGlvbjogZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIG9rKGZhbHNlLCBlcnJvcik7CiAgICAgICAgfTsKICAgICAgYGBgCiAgICAgICBAcHVibGljCiAgICAgIEBtZXRob2QgZXhjZXB0aW9uCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBlcnJvciBUaGUgZXhjZXB0aW9uIHRvIGJlIHJhaXNlZC4KICAgICovCiAgICBleGNlcHRpb246IGZ1bmN0aW9uIChlcnJvcikgewogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvYWRhcHRlcnMvcXVuaXQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdXRpbHMnLCAnZW1iZXItdGVzdGluZy9saWIvYWRhcHRlcnMvYWRhcHRlciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyVXRpbHMsIF9hZGFwdGVyKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfYWRhcHRlci5kZWZhdWx0LmV4dGVuZCh7CiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZG9uZUNhbGxiYWNrcyA9IFtdOwogICAgfSwKICAgIGFzeW5jU3RhcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHR5cGVvZiBRVW5pdC5zdG9wID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gdmVyeSBvbGQgUVVuaXQgdmVyc2lvbgogICAgICAgIFFVbml0LnN0b3AoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmRvbmVDYWxsYmFja3MucHVzaChRVW5pdC5jb25maWcuY3VycmVudCA/IFFVbml0LmNvbmZpZy5jdXJyZW50LmFzc2VydC5hc3luYygpIDogbnVsbCk7CiAgICAgIH0KICAgIH0sCiAgICBhc3luY0VuZDogZnVuY3Rpb24gKCkgewogICAgICAvLyBjaGVja2luZyBmb3IgUVVuaXQuc3RvcCBoZXJlIChldmVuIHRob3VnaCB3ZSBfbmVlZF8gUVVuaXQuc3RhcnQpIGJlY2F1c2UKICAgICAgLy8gUVVuaXQuc3RhcnQoKSBzdGlsbCBleGlzdHMgaW4gUVVuaXQgMi54IChpdCBqdXN0IHRocm93cyBhbiBlcnJvciB3aGVuIGNhbGxpbmcKICAgICAgLy8gaW5zaWRlIGEgdGVzdCBjb250ZXh0KQogICAgICBpZiAodHlwZW9mIFFVbml0LnN0b3AgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBRVW5pdC5zdGFydCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBkb25lID0gdGhpcy5kb25lQ2FsbGJhY2tzLnBvcCgpOwogICAgICAgIC8vIFRoaXMgY2FuIGJlIG51bGwgaWYgYXN5bmNTdGFydCgpIHdhcyBjYWxsZWQgb3V0c2lkZSBvZiBhIHRlc3QKICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGV4Y2VwdGlvbjogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIFFVbml0LmNvbmZpZy5jdXJyZW50LmFzc2VydC5vayhmYWxzZSwgKDAsIF9lbWJlclV0aWxzLmluc3BlY3QpKGVycm9yKSk7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL2V2ZW50cycsIFsnZXhwb3J0cycsICdAZW1iZXIvcnVubG9vcCcsICdAZW1iZXIvcG9seWZpbGxzJywgJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvLWlzLWZvcm0tY29udHJvbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3J1bmxvb3AsIF9wb2x5ZmlsbHMsIF9pc0Zvcm1Db250cm9sKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmZvY3VzID0gZm9jdXM7CiAgZXhwb3J0cy5maXJlRXZlbnQgPSBmaXJlRXZlbnQ7CgoKICB2YXIgREVGQVVMVF9FVkVOVF9PUFRJT05TID0geyBjYW5CdWJibGU6IHRydWUsIGNhbmNlbGFibGU6IHRydWUgfTsKICB2YXIgS0VZQk9BUkRfRVZFTlRfVFlQRVMgPSBbJ2tleWRvd24nLCAna2V5cHJlc3MnLCAna2V5dXAnXTsKICB2YXIgTU9VU0VfRVZFTlRfVFlQRVMgPSBbJ2NsaWNrJywgJ21vdXNlZG93bicsICdtb3VzZXVwJywgJ2RibGNsaWNrJywgJ21vdXNlZW50ZXInLCAnbW91c2VsZWF2ZScsICdtb3VzZW1vdmUnLCAnbW91c2VvdXQnLCAnbW91c2VvdmVyJ107CgogIGZ1bmN0aW9uIGZvY3VzKGVsKSB7CiAgICBpZiAoIWVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChlbC5pc0NvbnRlbnRFZGl0YWJsZSB8fCAoMCwgX2lzRm9ybUNvbnRyb2wuZGVmYXVsdCkoZWwpKSB7CiAgICAgIHZhciB0eXBlID0gZWwuZ2V0QXR0cmlidXRlKCd0eXBlJyk7CiAgICAgIGlmICh0eXBlICE9PSAnY2hlY2tib3gnICYmIHR5cGUgIT09ICdyYWRpbycgJiYgdHlwZSAhPT0gJ2hpZGRlbicpIHsKICAgICAgICAoMCwgX3J1bmxvb3AucnVuKShudWxsLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgYnJvd3NlcklzTm90Rm9jdXNlZCA9IGRvY3VtZW50Lmhhc0ZvY3VzICYmICFkb2N1bWVudC5oYXNGb2N1cygpOwoKICAgICAgICAgIC8vIG1ha2VzIGBkb2N1bWVudC5hY3RpdmVFbGVtZW50YCBiZSBgZWxlbWVudGAuIElmIHRoZSBicm93c2VyIGlzIGZvY3VzZWQsIGl0IGFsc28gZmlyZXMgYSBmb2N1cyBldmVudAogICAgICAgICAgZWwuZm9jdXMoKTsKCiAgICAgICAgICAvLyBGaXJlZm94IGRvZXMgbm90IHRyaWdnZXIgdGhlIGBmb2N1c2luYCBldmVudCBpZiB0aGUgd2luZG93CiAgICAgICAgICAvLyBkb2VzIG5vdCBoYXZlIGZvY3VzLiBJZiB0aGUgZG9jdW1lbnQgZG9lcyBub3QgaGF2ZSBmb2N1cyB0aGVuCiAgICAgICAgICAvLyBmaXJlIGBmb2N1c2luYCBldmVudCBhcyB3ZWxsLgogICAgICAgICAgaWYgKGJyb3dzZXJJc05vdEZvY3VzZWQpIHsKICAgICAgICAgICAgLy8gaWYgdGhlIGJyb3dzZXIgaXMgbm90IGZvY3VzZWQgdGhlIHByZXZpb3VzIGBlbC5mb2N1cygpYCBkaWRuJ3QgZmlyZSBhbiBldmVudCwgc28gd2Ugc2ltdWxhdGUgaXQKICAgICAgICAgICAgZmlyZUV2ZW50KGVsLCAnZm9jdXMnLCB7CiAgICAgICAgICAgICAgYnViYmxlczogZmFsc2UKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmaXJlRXZlbnQoZWwsICdmb2N1c2luJyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpcmVFdmVudChlbGVtZW50LCB0eXBlKSB7CiAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDoge307CgogICAgaWYgKCFlbGVtZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBldmVudCA9IHZvaWQgMDsKICAgIGlmIChLRVlCT0FSRF9FVkVOVF9UWVBFUy5pbmRleE9mKHR5cGUpID4gLTEpIHsKICAgICAgZXZlbnQgPSBidWlsZEtleWJvYXJkRXZlbnQodHlwZSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKE1PVVNFX0VWRU5UX1RZUEVTLmluZGV4T2YodHlwZSkgPiAtMSkgewogICAgICB2YXIgcmVjdCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHZhciB4ID0gcmVjdC5sZWZ0ICsgMTsKICAgICAgdmFyIHkgPSByZWN0LnRvcCArIDE7CiAgICAgIHZhciBzaW11bGF0ZWRDb29yZGluYXRlcyA9IHsKICAgICAgICBzY3JlZW5YOiB4ICsgNSwKICAgICAgICBzY3JlZW5ZOiB5ICsgOTUsCiAgICAgICAgY2xpZW50WDogeCwKICAgICAgICBjbGllbnRZOiB5CiAgICAgIH07CiAgICAgIGV2ZW50ID0gYnVpbGRNb3VzZUV2ZW50KHR5cGUsICgwLCBfcG9seWZpbGxzLmFzc2lnbikoc2ltdWxhdGVkQ29vcmRpbmF0ZXMsIG9wdGlvbnMpKTsKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50ID0gYnVpbGRCYXNpY0V2ZW50KHR5cGUsIG9wdGlvbnMpOwogICAgfQogICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9CgogIGZ1bmN0aW9uIGJ1aWxkQmFzaWNFdmVudCh0eXBlKSB7CiAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDoge307CgogICAgdmFyIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50cycpOwoKICAgIC8vIEV2ZW50LmJ1YmJsZXMgaXMgcmVhZCBvbmx5CiAgICB2YXIgYnViYmxlcyA9IG9wdGlvbnMuYnViYmxlcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5idWJibGVzIDogdHJ1ZTsKICAgIHZhciBjYW5jZWxhYmxlID0gb3B0aW9ucy5jYW5jZWxhYmxlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNhbmNlbGFibGUgOiB0cnVlOwoKICAgIGRlbGV0ZSBvcHRpb25zLmJ1YmJsZXM7CiAgICBkZWxldGUgb3B0aW9ucy5jYW5jZWxhYmxlOwoKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCBjYW5jZWxhYmxlKTsKICAgICgwLCBfcG9seWZpbGxzLmFzc2lnbikoZXZlbnQsIG9wdGlvbnMpOwogICAgcmV0dXJuIGV2ZW50OwogIH0KCiAgZnVuY3Rpb24gYnVpbGRNb3VzZUV2ZW50KHR5cGUpIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fTsKCiAgICB2YXIgZXZlbnQgPSB2b2lkIDA7CiAgICB0cnkgewogICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdNb3VzZUV2ZW50cycpOwogICAgICB2YXIgZXZlbnRPcHRzID0gKDAsIF9wb2x5ZmlsbHMuYXNzaWduKSh7fSwgREVGQVVMVF9FVkVOVF9PUFRJT05TLCBvcHRpb25zKTsKICAgICAgZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgZXZlbnRPcHRzLmNhbkJ1YmJsZSwgZXZlbnRPcHRzLmNhbmNlbGFibGUsIHdpbmRvdywgZXZlbnRPcHRzLmRldGFpbCwgZXZlbnRPcHRzLnNjcmVlblgsIGV2ZW50T3B0cy5zY3JlZW5ZLCBldmVudE9wdHMuY2xpZW50WCwgZXZlbnRPcHRzLmNsaWVudFksIGV2ZW50T3B0cy5jdHJsS2V5LCBldmVudE9wdHMuYWx0S2V5LCBldmVudE9wdHMuc2hpZnRLZXksIGV2ZW50T3B0cy5tZXRhS2V5LCBldmVudE9wdHMuYnV0dG9uLCBldmVudE9wdHMucmVsYXRlZFRhcmdldCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGV2ZW50ID0gYnVpbGRCYXNpY0V2ZW50KHR5cGUsIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIGV2ZW50OwogIH0KCiAgZnVuY3Rpb24gYnVpbGRLZXlib2FyZEV2ZW50KHR5cGUpIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB7fTsKCiAgICB2YXIgZXZlbnQgPSB2b2lkIDA7CiAgICB0cnkgewogICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdLZXlFdmVudHMnKTsKICAgICAgdmFyIGV2ZW50T3B0cyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoe30sIERFRkFVTFRfRVZFTlRfT1BUSU9OUywgb3B0aW9ucyk7CiAgICAgIGV2ZW50LmluaXRLZXlFdmVudCh0eXBlLCBldmVudE9wdHMuY2FuQnViYmxlLCBldmVudE9wdHMuY2FuY2VsYWJsZSwgd2luZG93LCBldmVudE9wdHMuY3RybEtleSwgZXZlbnRPcHRzLmFsdEtleSwgZXZlbnRPcHRzLnNoaWZ0S2V5LCBldmVudE9wdHMubWV0YUtleSwgZXZlbnRPcHRzLmtleUNvZGUsIGV2ZW50T3B0cy5jaGFyQ29kZSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGV2ZW50ID0gYnVpbGRCYXNpY0V2ZW50KHR5cGUsIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIGV2ZW50OwogIH0KfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvZXh0L2FwcGxpY2F0aW9uJywgWydAZW1iZXIvYXBwbGljYXRpb24nLCAnZW1iZXItdGVzdGluZy9saWIvc2V0dXBfZm9yX3Rlc3RpbmcnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9oZWxwZXJzJywgJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QvcHJvbWlzZScsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3J1bicsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L29uX2luamVjdF9oZWxwZXJzJywgJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QvYWRhcHRlciddLCBmdW5jdGlvbiAoX2FwcGxpY2F0aW9uLCBfc2V0dXBfZm9yX3Rlc3RpbmcsIF9oZWxwZXJzLCBfcHJvbWlzZSwgX3J1biwgX29uX2luamVjdF9oZWxwZXJzLCBfYWRhcHRlcikgewogICd1c2Ugc3RyaWN0JzsKCiAgX2FwcGxpY2F0aW9uLmRlZmF1bHQucmVvcGVuKHsKICAgIC8qKgogICAgIFRoaXMgcHJvcGVydHkgY29udGFpbnMgdGhlIHRlc3RpbmcgaGVscGVycyBmb3IgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24uIFRoZXNlCiAgICAgYXJlIGNyZWF0ZWQgb25jZSB5b3UgY2FsbCBgaW5qZWN0VGVzdEhlbHBlcnNgIG9uIHlvdXIgYEFwcGxpY2F0aW9uYAogICAgIGluc3RhbmNlLiBUaGUgaW5jbHVkZWQgaGVscGVycyBhcmUgYWxzbyBhdmFpbGFibGUgb24gdGhlIGB3aW5kb3dgIG9iamVjdCBieQogICAgIGRlZmF1bHQsIGJ1dCBjYW4gYmUgdXNlZCBmcm9tIHRoaXMgb2JqZWN0IG9uIHRoZSBpbmRpdmlkdWFsIGFwcGxpY2F0aW9uIGFsc28uCiAgICAgICBAcHJvcGVydHkgdGVzdEhlbHBlcnMKICAgICAgQHR5cGUge09iamVjdH0KICAgICAgQGRlZmF1bHQge30KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHRlc3RIZWxwZXJzOiB7fSwKCiAgICAvKioKICAgICBUaGlzIHByb3BlcnR5IHdpbGwgY29udGFpbiB0aGUgb3JpZ2luYWwgbWV0aG9kcyB0aGF0IHdlcmUgcmVnaXN0ZXJlZAogICAgIG9uIHRoZSBgaGVscGVyQ29udGFpbmVyYCBiZWZvcmUgYGluamVjdFRlc3RIZWxwZXJzYCBpcyBjYWxsZWQuCiAgICAgIFdoZW4gYHJlbW92ZVRlc3RIZWxwZXJzYCBpcyBjYWxsZWQsIHRoZXNlIG1ldGhvZHMgYXJlIHJlc3RvcmVkIHRvIHRoZQogICAgIGBoZWxwZXJDb250YWluZXJgLgogICAgICAgQHByb3BlcnR5IG9yaWdpbmFsTWV0aG9kcwogICAgICBAdHlwZSB7T2JqZWN0fQogICAgICBAZGVmYXVsdCB7fQogICAgICBAcHJpdmF0ZQogICAgICBAc2luY2UgMS4zLjAKICAgICovCiAgICBvcmlnaW5hbE1ldGhvZHM6IHt9LAoKICAgIC8qKgogICAgVGhpcyBwcm9wZXJ0eSBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgdGhpcyBhcHBsaWNhdGlvbiBpcyBjdXJyZW50bHkgaW4KICAgIHRlc3RpbmcgbW9kZS4gVGhpcyBpcyBzZXQgd2hlbiBgc2V0dXBGb3JUZXN0aW5nYCBpcyBjYWxsZWQgb24gdGhlIGN1cnJlbnQKICAgIGFwcGxpY2F0aW9uLgogICAgIEBwcm9wZXJ0eSB0ZXN0aW5nCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEBkZWZhdWx0IGZhbHNlCiAgICBAc2luY2UgMS4zLjAKICAgIEBwdWJsaWMKICAgICovCiAgICB0ZXN0aW5nOiBmYWxzZSwKCiAgICBzZXR1cEZvclRlc3Rpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgKDAsIF9zZXR1cF9mb3JfdGVzdGluZy5kZWZhdWx0KSgpOwoKICAgICAgdGhpcy50ZXN0aW5nID0gdHJ1ZTsKCiAgICAgIHRoaXMucmVzb2x2ZVJlZ2lzdHJhdGlvbigncm91dGVyOm1haW4nKS5yZW9wZW4oewogICAgICAgIGxvY2F0aW9uOiAnbm9uZScKICAgICAgfSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgVGhpcyB3aWxsIGJlIHVzZWQgYXMgdGhlIGNvbnRhaW5lciB0byBpbmplY3QgdGhlIHRlc3QgaGVscGVycyBpbnRvLiBCeQogICAgICBkZWZhdWx0IHRoZSBoZWxwZXJzIGFyZSBpbmplY3RlZCBpbnRvIGB3aW5kb3dgLgogICAgICAgQHByb3BlcnR5IGhlbHBlckNvbnRhaW5lcgogICAgICBAdHlwZSB7T2JqZWN0fSBUaGUgb2JqZWN0IHRvIGJlIHVzZWQgZm9yIHRlc3QgaGVscGVycy4KICAgICAgQGRlZmF1bHQgd2luZG93CiAgICAgIEBzaW5jZSAxLjIuMAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGhlbHBlckNvbnRhaW5lcjogbnVsbCwKCiAgICBpbmplY3RUZXN0SGVscGVyczogZnVuY3Rpb24gKGhlbHBlckNvbnRhaW5lcikgewogICAgICBpZiAoaGVscGVyQ29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5oZWxwZXJDb250YWluZXIgPSBoZWxwZXJDb250YWluZXI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5oZWxwZXJDb250YWluZXIgPSB3aW5kb3c7CiAgICAgIH0KCiAgICAgIHRoaXMucmVvcGVuKHsKICAgICAgICB3aWxsRGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIHRoaXMucmVtb3ZlVGVzdEhlbHBlcnMoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdGhpcy50ZXN0SGVscGVycyA9IHt9OwogICAgICBmb3IgKHZhciBuYW1lIGluIF9oZWxwZXJzLmhlbHBlcnMpIHsKICAgICAgICB0aGlzLm9yaWdpbmFsTWV0aG9kc1tuYW1lXSA9IHRoaXMuaGVscGVyQ29udGFpbmVyW25hbWVdOwogICAgICAgIHRoaXMudGVzdEhlbHBlcnNbbmFtZV0gPSB0aGlzLmhlbHBlckNvbnRhaW5lcltuYW1lXSA9IGhlbHBlcih0aGlzLCBuYW1lKTsKICAgICAgICBwcm90b1dyYXAoX3Byb21pc2UuZGVmYXVsdC5wcm90b3R5cGUsIG5hbWUsIGhlbHBlcih0aGlzLCBuYW1lKSwgX2hlbHBlcnMuaGVscGVyc1tuYW1lXS5tZXRhLndhaXQpOwogICAgICB9CgogICAgICAoMCwgX29uX2luamVjdF9oZWxwZXJzLmludm9rZUluamVjdEhlbHBlcnNDYWxsYmFja3MpKHRoaXMpOwogICAgfSwKICAgIHJlbW92ZVRlc3RIZWxwZXJzOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpcy5oZWxwZXJDb250YWluZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGZvciAodmFyIG5hbWUgaW4gX2hlbHBlcnMuaGVscGVycykgewogICAgICAgIHRoaXMuaGVscGVyQ29udGFpbmVyW25hbWVdID0gdGhpcy5vcmlnaW5hbE1ldGhvZHNbbmFtZV07CiAgICAgICAgZGVsZXRlIF9wcm9taXNlLmRlZmF1bHQucHJvdG90eXBlW25hbWVdOwogICAgICAgIGRlbGV0ZSB0aGlzLnRlc3RIZWxwZXJzW25hbWVdOwogICAgICAgIGRlbGV0ZSB0aGlzLm9yaWdpbmFsTWV0aG9kc1tuYW1lXTsKICAgICAgfQogICAgfQogIH0pOwoKICAvLyBUaGlzIG1ldGhvZCBpcyBubyBsb25nZXIgbmVlZGVkCiAgLy8gQnV0IHN0aWxsIGhlcmUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgLy8gb2YgaGVscGVyIGNoYWluaW5nCiAgZnVuY3Rpb24gcHJvdG9XcmFwKHByb3RvLCBuYW1lLCBjYWxsYmFjaywgaXNBc3luYykgewogICAgcHJvdG9bbmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgaWYgKGlzQXN5bmMpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBoZWxwZXIoYXBwLCBuYW1lKSB7CiAgICB2YXIgZm4gPSBfaGVscGVycy5oZWxwZXJzW25hbWVdLm1ldGhvZDsKICAgIHZhciBtZXRhID0gX2hlbHBlcnMuaGVscGVyc1tuYW1lXS5tZXRhOwogICAgaWYgKCFtZXRhLndhaXQpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGFwcCwgW2FwcF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgdmFyIGxhc3RQcm9taXNlID0gKDAsIF9ydW4uZGVmYXVsdCkoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoMCwgX3Byb21pc2UucmVzb2x2ZSkoKDAsIF9wcm9taXNlLmdldExhc3RQcm9taXNlKSgpKTsKICAgICAgfSk7CgogICAgICAvLyB3YWl0IGZvciBsYXN0IGhlbHBlcidzIHByb21pc2UgdG8gcmVzb2x2ZSBhbmQgdGhlbgogICAgICAvLyBleGVjdXRlLiBUbyBiZSBzYWZlLCB3ZSBuZWVkIHRvIHRlbGwgdGhlIGFkYXB0ZXIgd2UncmUgZ29pbmcKICAgICAgLy8gYXN5bmNocm9ub3VzIGhlcmUsIGJlY2F1c2UgZm4gbWF5IG5vdCBiZSBpbnZva2VkIGJlZm9yZSB3ZQogICAgICAvLyByZXR1cm4uCiAgICAgICgwLCBfYWRhcHRlci5hc3luY1N0YXJ0KSgpOwogICAgICByZXR1cm4gbGFzdFByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGFwcCwgW2FwcF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfSkuZmluYWxseShfYWRhcHRlci5hc3luY0VuZCk7CiAgICB9OwogIH0KfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvZXh0L3JzdnAnLCBbJ2V4cG9ydHMnLCAnZW1iZXItcnVudGltZScsICdAZW1iZXIvcnVubG9vcCcsICdAZW1iZXIvZGVidWcnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9hZGFwdGVyJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJSdW50aW1lLCBfcnVubG9vcCwgX2RlYnVnLCBfYWRhcHRlcikgewogICd1c2Ugc3RyaWN0JzsKCiAgX2VtYmVyUnVudGltZS5SU1ZQLmNvbmZpZ3VyZSgnYXN5bmMnLCBmdW5jdGlvbiAoY2FsbGJhY2ssIHByb21pc2UpIHsKICAgIC8vIGlmIHNjaGVkdWxlIHdpbGwgY2F1c2UgYXV0b3J1biwgd2UgbmVlZCB0byBpbmZvcm0gYWRhcHRlcgogICAgaWYgKCgwLCBfZGVidWcuaXNUZXN0aW5nKSgpICYmICFfcnVubG9vcC5iYWNrYnVybmVyLmN1cnJlbnRJbnN0YW5jZSkgewogICAgICAoMCwgX2FkYXB0ZXIuYXN5bmNTdGFydCkoKTsKICAgICAgX3J1bmxvb3AuYmFja2J1cm5lci5zY2hlZHVsZSgnYWN0aW9ucycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAoMCwgX2FkYXB0ZXIuYXN5bmNFbmQpKCk7CiAgICAgICAgY2FsbGJhY2socHJvbWlzZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgX3J1bmxvb3AuYmFja2J1cm5lci5zY2hlZHVsZSgnYWN0aW9ucycsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2socHJvbWlzZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJSdW50aW1lLlJTVlA7Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMnLCBbJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QvaGVscGVycycsICdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2FuZF90aGVuJywgJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvY2xpY2snLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9jdXJyZW50X3BhdGgnLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9jdXJyZW50X3JvdXRlX25hbWUnLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9jdXJyZW50X3VybCcsICdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2ZpbGxfaW4nLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9maW5kJywgJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvZmluZF93aXRoX2Fzc2VydCcsICdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2tleV9ldmVudCcsICdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL3BhdXNlX3Rlc3QnLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy90cmlnZ2VyX2V2ZW50JywgJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvdmlzaXQnLCAnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy93YWl0J10sIGZ1bmN0aW9uIChfaGVscGVycywgX2FuZF90aGVuLCBfY2xpY2ssIF9jdXJyZW50X3BhdGgsIF9jdXJyZW50X3JvdXRlX25hbWUsIF9jdXJyZW50X3VybCwgX2ZpbGxfaW4sIF9maW5kLCBfZmluZF93aXRoX2Fzc2VydCwgX2tleV9ldmVudCwgX3BhdXNlX3Rlc3QsIF90cmlnZ2VyX2V2ZW50LCBfdmlzaXQsIF93YWl0KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAoMCwgX2hlbHBlcnMucmVnaXN0ZXJBc3luY0hlbHBlcikoJ3Zpc2l0JywgX3Zpc2l0LmRlZmF1bHQpOwogICgwLCBfaGVscGVycy5yZWdpc3RlckFzeW5jSGVscGVyKSgnY2xpY2snLCBfY2xpY2suZGVmYXVsdCk7CiAgKDAsIF9oZWxwZXJzLnJlZ2lzdGVyQXN5bmNIZWxwZXIpKCdrZXlFdmVudCcsIF9rZXlfZXZlbnQuZGVmYXVsdCk7CiAgKDAsIF9oZWxwZXJzLnJlZ2lzdGVyQXN5bmNIZWxwZXIpKCdmaWxsSW4nLCBfZmlsbF9pbi5kZWZhdWx0KTsKICAoMCwgX2hlbHBlcnMucmVnaXN0ZXJBc3luY0hlbHBlcikoJ3dhaXQnLCBfd2FpdC5kZWZhdWx0KTsKICAoMCwgX2hlbHBlcnMucmVnaXN0ZXJBc3luY0hlbHBlcikoJ2FuZFRoZW4nLCBfYW5kX3RoZW4uZGVmYXVsdCk7CiAgKDAsIF9oZWxwZXJzLnJlZ2lzdGVyQXN5bmNIZWxwZXIpKCdwYXVzZVRlc3QnLCBfcGF1c2VfdGVzdC5wYXVzZVRlc3QpOwogICgwLCBfaGVscGVycy5yZWdpc3RlckFzeW5jSGVscGVyKSgndHJpZ2dlckV2ZW50JywgX3RyaWdnZXJfZXZlbnQuZGVmYXVsdCk7CgogICgwLCBfaGVscGVycy5yZWdpc3RlckhlbHBlcikoJ2ZpbmQnLCBfZmluZC5kZWZhdWx0KTsKICAoMCwgX2hlbHBlcnMucmVnaXN0ZXJIZWxwZXIpKCdmaW5kV2l0aEFzc2VydCcsIF9maW5kX3dpdGhfYXNzZXJ0LmRlZmF1bHQpOwogICgwLCBfaGVscGVycy5yZWdpc3RlckhlbHBlcikoJ2N1cnJlbnRSb3V0ZU5hbWUnLCBfY3VycmVudF9yb3V0ZV9uYW1lLmRlZmF1bHQpOwogICgwLCBfaGVscGVycy5yZWdpc3RlckhlbHBlcikoJ2N1cnJlbnRQYXRoJywgX2N1cnJlbnRfcGF0aC5kZWZhdWx0KTsKICAoMCwgX2hlbHBlcnMucmVnaXN0ZXJIZWxwZXIpKCdjdXJyZW50VVJMJywgX2N1cnJlbnRfdXJsLmRlZmF1bHQpOwogICgwLCBfaGVscGVycy5yZWdpc3RlckhlbHBlcikoJ3Jlc3VtZVRlc3QnLCBfcGF1c2VfdGVzdC5yZXN1bWVUZXN0KTsKfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy8taXMtZm9ybS1jb250cm9sJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBpc0Zvcm1Db250cm9sOwogIHZhciBGT1JNX0NPTlRST0xfVEFHUyA9IFsnSU5QVVQnLCAnQlVUVE9OJywgJ1NFTEVDVCcsICdURVhUQVJFQSddOwoKICAvKioKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdG8gY2hlY2sKICAgIEByZXR1cm5zIHtib29sZWFufSBgdHJ1ZWAgd2hlbiB0aGUgZWxlbWVudCBpcyBhIGZvcm0gY29udHJvbCwgYGZhbHNlYCBvdGhlcndpc2UKICAqLwogIGZ1bmN0aW9uIGlzRm9ybUNvbnRyb2woZWxlbWVudCkgewogICAgdmFyIHRhZ05hbWUgPSBlbGVtZW50LnRhZ05hbWUsCiAgICAgICAgdHlwZSA9IGVsZW1lbnQudHlwZTsKCgogICAgaWYgKHR5cGUgPT09ICdoaWRkZW4nKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gRk9STV9DT05UUk9MX1RBR1MuaW5kZXhPZih0YWdOYW1lKSA+IC0xOwogIH0KfSk7CmVuaWZlZCgiZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9hbmRfdGhlbiIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gYW5kVGhlbjsKICBmdW5jdGlvbiBhbmRUaGVuKGFwcCwgY2FsbGJhY2spIHsKICAgIHJldHVybiBhcHAudGVzdEhlbHBlcnMud2FpdChjYWxsYmFjayhhcHApKTsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvY2xpY2snLCBbJ2V4cG9ydHMnLCAnZW1iZXItdGVzdGluZy9saWIvZXZlbnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZXZlbnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBjbGljazsKCgogIC8qKgogICAgQ2xpY2tzIGFuIGVsZW1lbnQgYW5kIHRyaWdnZXJzIGFueSBhY3Rpb25zIHRyaWdnZXJlZCBieSB0aGUgZWxlbWVudCdzIGBjbGlja2AKICAgIGV2ZW50LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGNsaWNrKCcuc29tZS1qUXVlcnktc2VsZWN0b3InKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAvLyBhc3NlcnQgc29tZXRoaW5nCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBjbGljawogICAgQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGpRdWVyeSBzZWxlY3RvciBmb3IgZmluZGluZyBlbGVtZW50IG9uIHRoZSBET00KICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IEEgRE9NIEVsZW1lbnQsIERvY3VtZW50LCBvciBqUXVlcnkgdG8gdXNlIGFzIGNvbnRleHQKICAgIEByZXR1cm4ge1JTVlAuUHJvbWlzZTx1bmRlZmluZWQ+fQogICAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gY2xpY2soYXBwLCBzZWxlY3RvciwgY29udGV4dCkgewogICAgdmFyICRlbCA9IGFwcC50ZXN0SGVscGVycy5maW5kV2l0aEFzc2VydChzZWxlY3RvciwgY29udGV4dCk7CiAgICB2YXIgZWwgPSAkZWxbMF07CgogICAgKDAsIF9ldmVudHMuZmlyZUV2ZW50KShlbCwgJ21vdXNlZG93bicpOwoKICAgICgwLCBfZXZlbnRzLmZvY3VzKShlbCk7CgogICAgKDAsIF9ldmVudHMuZmlyZUV2ZW50KShlbCwgJ21vdXNldXAnKTsKICAgICgwLCBfZXZlbnRzLmZpcmVFdmVudCkoZWwsICdjbGljaycpOwoKICAgIHJldHVybiBhcHAudGVzdEhlbHBlcnMud2FpdCgpOwogIH0gLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2N1cnJlbnRfcGF0aCcsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YWwpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGN1cnJlbnRQYXRoOwoKCiAgLyoqCiAgICBSZXR1cm5zIHRoZSBjdXJyZW50IHBhdGguCiAgCiAgRXhhbXBsZToKICAKICBgYGBqYXZhc2NyaXB0CiAgZnVuY3Rpb24gdmFsaWRhdGVVUkwoKSB7CiAgICBlcXVhbChjdXJyZW50UGF0aCgpLCAnc29tZS5wYXRoLmluZGV4JywgImNvcnJlY3QgcGF0aCB3YXMgdHJhbnNpdGlvbmVkIGludG8uIik7CiAgfQogIAogIGNsaWNrKCcjc29tZS1saW5rLWlkJykudGhlbih2YWxpZGF0ZVVSTCk7CiAgYGBgCiAgCiAgQG1ldGhvZCBjdXJyZW50UGF0aAogIEByZXR1cm4ge09iamVjdH0gVGhlIGN1cnJlbnRseSBhY3RpdmUgcGF0aC4KICBAc2luY2UgMS41LjAKICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBjdXJyZW50UGF0aChhcHApIHsKICAgIHZhciByb3V0aW5nU2VydmljZSA9IGFwcC5fX2NvbnRhaW5lcl9fLmxvb2t1cCgnc2VydmljZTotcm91dGluZycpOwogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHJvdXRpbmdTZXJ2aWNlLCAnY3VycmVudFBhdGgnKTsKICB9IC8qKgogICAgQG1vZHVsZSBlbWJlcgogICAgKi8KfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9jdXJyZW50X3JvdXRlX25hbWUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBjdXJyZW50Um91dGVOYW1lOwoKICAvKioKICAgIFJldHVybnMgdGhlIGN1cnJlbnRseSBhY3RpdmUgcm91dGUgbmFtZS4KICAKICBFeGFtcGxlOgogIAogIGBgYGphdmFzY3JpcHQKICBmdW5jdGlvbiB2YWxpZGF0ZVJvdXRlTmFtZSgpIHsKICAgIGVxdWFsKGN1cnJlbnRSb3V0ZU5hbWUoKSwgJ3NvbWUucGF0aCcsICJjb3JyZWN0IHJvdXRlIHdhcyB0cmFuc2l0aW9uZWQgaW50by4iKTsKICB9CiAgdmlzaXQoJy9zb21lL3BhdGgnKS50aGVuKHZhbGlkYXRlUm91dGVOYW1lKQogIGBgYAogIAogIEBtZXRob2QgY3VycmVudFJvdXRlTmFtZQogIEByZXR1cm4ge09iamVjdH0gVGhlIG5hbWUgb2YgdGhlIGN1cnJlbnRseSBhY3RpdmUgcm91dGUuCiAgQHNpbmNlIDEuNS4wCiAgQHB1YmxpYwogICovCiAgZnVuY3Rpb24gY3VycmVudFJvdXRlTmFtZShhcHApIHsKICAgIHZhciByb3V0aW5nU2VydmljZSA9IGFwcC5fX2NvbnRhaW5lcl9fLmxvb2t1cCgnc2VydmljZTotcm91dGluZycpOwogICAgcmV0dXJuICgwLCBfZW1iZXJNZXRhbC5nZXQpKHJvdXRpbmdTZXJ2aWNlLCAnY3VycmVudFJvdXRlTmFtZScpOwogIH0gLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2N1cnJlbnRfdXJsJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJNZXRhbCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gY3VycmVudFVSTDsKCgogIC8qKgogICAgUmV0dXJucyB0aGUgY3VycmVudCBVUkwuCiAgCiAgRXhhbXBsZToKICAKICBgYGBqYXZhc2NyaXB0CiAgZnVuY3Rpb24gdmFsaWRhdGVVUkwoKSB7CiAgICBlcXVhbChjdXJyZW50VVJMKCksICcvc29tZS9wYXRoJywgImNvcnJlY3QgVVJMIHdhcyB0cmFuc2l0aW9uZWQgaW50by4iKTsKICB9CiAgCiAgY2xpY2soJyNzb21lLWxpbmstaWQnKS50aGVuKHZhbGlkYXRlVVJMKTsKICBgYGAKICAKICBAbWV0aG9kIGN1cnJlbnRVUkwKICBAcmV0dXJuIHtPYmplY3R9IFRoZSBjdXJyZW50bHkgYWN0aXZlIFVSTC4KICBAc2luY2UgMS41LjAKICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBjdXJyZW50VVJMKGFwcCkgewogICAgdmFyIHJvdXRlciA9IGFwcC5fX2NvbnRhaW5lcl9fLmxvb2t1cCgncm91dGVyOm1haW4nKTsKICAgIHJldHVybiAoMCwgX2VtYmVyTWV0YWwuZ2V0KShyb3V0ZXIsICdsb2NhdGlvbicpLmdldFVSTCgpOwogIH0gLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2ZpbGxfaW4nLCBbJ2V4cG9ydHMnLCAnZW1iZXItdGVzdGluZy9saWIvZXZlbnRzJywgJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvLWlzLWZvcm0tY29udHJvbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2V2ZW50cywgX2lzRm9ybUNvbnRyb2wpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGZpbGxJbjsKCgogIC8qKgogICAgRmlsbHMgaW4gYW4gaW5wdXQgZWxlbWVudCB3aXRoIHNvbWUgdGV4dC4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmaWxsSW4oJyNlbWFpbCcsICd5b3VAZXhhbXBsZS5jb20nKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAvLyBhc3NlcnQgc29tZXRoaW5nCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBmaWxsSW4KICAgIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBqUXVlcnkgc2VsZWN0b3IgZmluZGluZyBhbiBpbnB1dCBlbGVtZW50IG9uIHRoZSBET00KICAgIHRvIGZpbGwgdGV4dCB3aXRoCiAgICBAcGFyYW0ge1N0cmluZ30gdGV4dCB0ZXh0IHRvIHBsYWNlIGluc2lkZSB0aGUgaW5wdXQgZWxlbWVudAogICAgQHJldHVybiB7UlNWUC5Qcm9taXNlPHVuZGVmaW5lZD59CiAgICBAcHVibGljCiAgKi8KICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KICBmdW5jdGlvbiBmaWxsSW4oYXBwLCBzZWxlY3RvciwgY29udGV4dE9yVGV4dCwgdGV4dCkgewogICAgdmFyICRlbCA9IHZvaWQgMCwKICAgICAgICBlbCA9IHZvaWQgMCwKICAgICAgICBjb250ZXh0ID0gdm9pZCAwOwogICAgaWYgKHRleHQgPT09IHVuZGVmaW5lZCkgewogICAgICB0ZXh0ID0gY29udGV4dE9yVGV4dDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnRleHQgPSBjb250ZXh0T3JUZXh0OwogICAgfQogICAgJGVsID0gYXBwLnRlc3RIZWxwZXJzLmZpbmRXaXRoQXNzZXJ0KHNlbGVjdG9yLCBjb250ZXh0KTsKICAgIGVsID0gJGVsWzBdOwogICAgKDAsIF9ldmVudHMuZm9jdXMpKGVsKTsKCiAgICBpZiAoKDAsIF9pc0Zvcm1Db250cm9sLmRlZmF1bHQpKGVsKSkgewogICAgICBlbC52YWx1ZSA9IHRleHQ7CiAgICB9IGVsc2UgewogICAgICBlbC5pbm5lckhUTUwgPSB0ZXh0OwogICAgfQoKICAgICgwLCBfZXZlbnRzLmZpcmVFdmVudCkoZWwsICdpbnB1dCcpOwogICAgKDAsIF9ldmVudHMuZmlyZUV2ZW50KShlbCwgJ2NoYW5nZScpOwoKICAgIHJldHVybiBhcHAudGVzdEhlbHBlcnMud2FpdCgpOwogIH0KfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9maW5kJywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci12aWV3cyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YWwsIF9kZWJ1ZywgX2VtYmVyVmlld3MpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGZpbmQ7CgoKICAvKioKICAgIEZpbmRzIGFuIGVsZW1lbnQgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGFwcCdzIGNvbnRhaW5lciBlbGVtZW50LiBBIHNpbXBsZSBhbGlhcwogICAgZm9yIGBhcHAuJChzZWxlY3RvcilgLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciAkZWwgPSBmaW5kKCcubXktc2VsZWN0b3InKTsKICAgIGBgYAogIAogICAgV2l0aCB0aGUgYGNvbnRleHRgIHBhcmFtOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgdmFyICRlbCA9IGZpbmQoJy5teS1zZWxlY3RvcicsICcucGFyZW50LWVsZW1lbnQtY2xhc3MnKTsKICAgIGBgYAogIAogICAgQG1ldGhvZCBmaW5kCiAgICBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IgalF1ZXJ5IHNlbGVjdG9yIGZvciBlbGVtZW50IGxvb2t1cAogICAgQHBhcmFtIHtTdHJpbmd9IFtjb250ZXh0XSAob3B0aW9uYWwpIGpRdWVyeSBzZWxlY3RvciB0aGF0IHdpbGwgbGltaXQgdGhlIHNlbGVjdG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IHRvIGZpbmQgb25seSB3aXRoaW4gdGhlIGNvbnRleHQncyBjaGlsZHJlbgogICAgQHJldHVybiB7T2JqZWN0fSBET00gZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIHJlc3VsdHMgb2YgdGhlIHF1ZXJ5CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiBmaW5kKGFwcCwgc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgIGlmIChfZW1iZXJWaWV3cy5qUXVlcnlEaXNhYmxlZCkgewogICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0lmIGpRdWVyeSBpcyBkaXNhYmxlZCwgcGxlYXNlIGltcG9ydCBhbmQgdXNlIGhlbHBlcnMgZnJvbSBAZW1iZXIvdGVzdC1oZWxwZXJzIFtodHRwczovL2dpdGh1Yi5jb20vZW1iZXJqcy9lbWJlci10ZXN0LWhlbHBlcnNdLiBOb3RlOiBgZmluZGAgaXMgbm90IGFuIGF2YWlsYWJsZSBoZWxwZXIuJykpOwogICAgfQogICAgdmFyICRlbCA9IHZvaWQgMDsKICAgIGNvbnRleHQgPSBjb250ZXh0IHx8ICgwLCBfZW1iZXJNZXRhbC5nZXQpKGFwcCwgJ3Jvb3RFbGVtZW50Jyk7CiAgICAkZWwgPSBhcHAuJChzZWxlY3RvciwgY29udGV4dCk7CiAgICByZXR1cm4gJGVsOwogIH0gLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL2ZpbmRfd2l0aF9hc3NlcnQnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGZpbmRXaXRoQXNzZXJ0OwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIC8qKgogICAgTGlrZSBgZmluZGAsIGJ1dCB0aHJvd3MgYW4gZXJyb3IgaWYgdGhlIGVsZW1lbnQgc2VsZWN0b3IgcmV0dXJucyBubyByZXN1bHRzLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciAkZWwgPSBmaW5kV2l0aEFzc2VydCgnLmRvZXNudC1leGlzdCcpOyAvLyB0aHJvd3MgZXJyb3IKICAgIGBgYAogIAogICAgV2l0aCB0aGUgYGNvbnRleHRgIHBhcmFtOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgdmFyICRlbCA9IGZpbmRXaXRoQXNzZXJ0KCcuc2VsZWN0b3ItaWQnLCAnLnBhcmVudC1lbGVtZW50LWNsYXNzJyk7IC8vIGFzc2VydCB3aWxsIHBhc3MKICAgIGBgYAogIAogICAgQG1ldGhvZCBmaW5kV2l0aEFzc2VydAogICAgQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGpRdWVyeSBzZWxlY3RvciBzdHJpbmcgZm9yIGZpbmRpbmcgYW4gZWxlbWVudCB3aXRoaW4KICAgIHRoZSBET00KICAgIEBwYXJhbSB7U3RyaW5nfSBbY29udGV4dF0gKG9wdGlvbmFsKSBqUXVlcnkgc2VsZWN0b3IgdGhhdCB3aWxsIGxpbWl0IHRoZQogICAgc2VsZWN0b3IgYXJndW1lbnQgdG8gZmluZCBvbmx5IHdpdGhpbiB0aGUgY29udGV4dCdzIGNoaWxkcmVuCiAgICBAcmV0dXJuIHtPYmplY3R9IGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXN1bHRzIG9mIHRoZSBxdWVyeQogICAgQHRocm93cyB7RXJyb3J9IHRocm93cyBlcnJvciBpZiBvYmplY3QgcmV0dXJuZWQgaGFzIGEgbGVuZ3RoIG9mIDAKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGZpbmRXaXRoQXNzZXJ0KGFwcCwgc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgIHZhciAkZWwgPSBhcHAudGVzdEhlbHBlcnMuZmluZChzZWxlY3RvciwgY29udGV4dCk7CiAgICBpZiAoJGVsLmxlbmd0aCA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VsZW1lbnQgJyArIHNlbGVjdG9yICsgJyBub3QgZm91bmQuJyk7CiAgICB9CiAgICByZXR1cm4gJGVsOwogIH0KfSk7CmVuaWZlZCgiZW1iZXItdGVzdGluZy9saWIvaGVscGVycy9rZXlfZXZlbnQiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGtleUV2ZW50OwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIC8qKgogICAgU2ltdWxhdGVzIGEga2V5IGV2ZW50LCBlLmcuIGBrZXlwcmVzc2AsIGBrZXlkb3duYCwgYGtleXVwYCB3aXRoIHRoZSBkZXNpcmVkIGtleUNvZGUKICAgIEV4YW1wbGU6CiAgICBgYGBqYXZhc2NyaXB0CiAgICBrZXlFdmVudCgnLnNvbWUtalF1ZXJ5LXNlbGVjdG9yJywgJ2tleXByZXNzJywgMTMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgLy8gYXNzZXJ0IHNvbWV0aGluZwogICAgfSk7CiAgICBgYGAKICAgIEBtZXRob2Qga2V5RXZlbnQKICAgIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBqUXVlcnkgc2VsZWN0b3IgZm9yIGZpbmRpbmcgZWxlbWVudCBvbiB0aGUgRE9NCiAgICBAcGFyYW0ge1N0cmluZ30gdHlwZSB0aGUgdHlwZSBvZiBrZXkgZXZlbnQsIGUuZy4gYGtleXByZXNzYCwgYGtleWRvd25gLCBga2V5dXBgCiAgICBAcGFyYW0ge051bWJlcn0ga2V5Q29kZSB0aGUga2V5Q29kZSBvZiB0aGUgc2ltdWxhdGVkIGtleSBldmVudAogICAgQHJldHVybiB7UlNWUC5Qcm9taXNlPHVuZGVmaW5lZD59CiAgICBAc2luY2UgMS41LjAKICAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIGtleUV2ZW50KGFwcCwgc2VsZWN0b3IsIGNvbnRleHRPclR5cGUsIHR5cGVPcktleUNvZGUsIGtleUNvZGUpIHsKICAgIHZhciBjb250ZXh0ID0gdm9pZCAwLAogICAgICAgIHR5cGUgPSB2b2lkIDA7CgogICAgaWYgKGtleUNvZGUgPT09IHVuZGVmaW5lZCkgewogICAgICBjb250ZXh0ID0gbnVsbDsKICAgICAga2V5Q29kZSA9IHR5cGVPcktleUNvZGU7CiAgICAgIHR5cGUgPSBjb250ZXh0T3JUeXBlOwogICAgfSBlbHNlIHsKICAgICAgY29udGV4dCA9IGNvbnRleHRPclR5cGU7CiAgICAgIHR5cGUgPSB0eXBlT3JLZXlDb2RlOwogICAgfQoKICAgIHJldHVybiBhcHAudGVzdEhlbHBlcnMudHJpZ2dlckV2ZW50KHNlbGVjdG9yLCBjb250ZXh0LCB0eXBlLCB7CiAgICAgIGtleUNvZGU6IGtleUNvZGUsCiAgICAgIHdoaWNoOiBrZXlDb2RlCiAgICB9KTsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL2hlbHBlcnMvcGF1c2VfdGVzdCcsIFsnZXhwb3J0cycsICdlbWJlci1ydW50aW1lJywgJ0BlbWJlci9kZWJ1ZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyUnVudGltZSwgX2RlYnVnKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLnJlc3VtZVRlc3QgPSByZXN1bWVUZXN0OwogIGV4cG9ydHMucGF1c2VUZXN0ID0gcGF1c2VUZXN0OwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIHZhciByZXN1bWUgPSB2b2lkIDA7CgogIC8qKgogICBSZXN1bWVzIGEgdGVzdCBwYXVzZWQgYnkgYHBhdXNlVGVzdGAuCiAgCiAgIEBtZXRob2QgcmVzdW1lVGVzdAogICBAcmV0dXJuIHt2b2lkfQogICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiByZXN1bWVUZXN0KCkgewogICAgKHRydWUgJiYgIShyZXN1bWUpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVGVzdGluZyBoYXMgbm90IGJlZW4gcGF1c2VkLiBUaGVyZSBpcyBub3RoaW5nIHRvIHJlc3VtZS4nLCByZXN1bWUpKTsKCiAgICByZXN1bWUoKTsKICAgIHJlc3VtZSA9IHVuZGVmaW5lZDsKICB9CgogIC8qKgogICBQYXVzZXMgdGhlIGN1cnJlbnQgdGVzdCAtIHRoaXMgaXMgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgd2hpbGUgdGVzdGluZyBvciBmb3IgdGVzdC1kcml2aW5nLgogICBJdCBhbGxvd3MgeW91IHRvIGluc3BlY3QgdGhlIHN0YXRlIG9mIHlvdXIgYXBwbGljYXRpb24gYXQgYW55IHBvaW50LgogICBFeGFtcGxlIChUaGUgdGVzdCB3aWxsIHBhdXNlIGJlZm9yZSBjbGlja2luZyB0aGUgYnV0dG9uKToKICAKICAgYGBgamF2YXNjcmlwdAogICB2aXNpdCgnLycpCiAgIHJldHVybiBwYXVzZVRlc3QoKTsKICAgY2xpY2soJy5idG4nKTsKICAgYGBgCiAgCiAgIFlvdSBtYXkgd2FudCB0byB0dXJuIG9mZiB0aGUgdGltZW91dCBiZWZvcmUgcGF1c2luZy4KICAKICAgcXVuaXQgKGFzIG9mIDIuNC4wKToKICAKICAgYGBgCiAgIHZpc2l0KCcvJyk7CiAgIGFzc2VydC50aW1lb3V0KDApOwogICByZXR1cm4gcGF1c2VUZXN0KCk7CiAgIGNsaWNrKCcuYnRuJyk7CiAgIGBgYAogIAogICBtb2NoYToKICAKICAgYGBgCiAgIHZpc2l0KCcvJyk7CiAgIHRoaXMudGltZW91dCgwKTsKICAgcmV0dXJuIHBhdXNlVGVzdCgpOwogICBjbGljaygnLmJ0bicpOwogICBgYGAKICAKICAKICAgQHNpbmNlIDEuOS4wCiAgIEBtZXRob2QgcGF1c2VUZXN0CiAgIEByZXR1cm4ge09iamVjdH0gQSBwcm9taXNlIHRoYXQgd2lsbCBuZXZlciByZXNvbHZlCiAgIEBwdWJsaWMKICAqLwogIGZ1bmN0aW9uIHBhdXNlVGVzdCgpIHsKICAgICgwLCBfZGVidWcuaW5mbykoJ1Rlc3RpbmcgcGF1c2VkLiBVc2UgYHJlc3VtZVRlc3QoKWAgdG8gY29udGludWUuJyk7CgogICAgcmV0dXJuIG5ldyBfZW1iZXJSdW50aW1lLlJTVlAuUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICByZXN1bWUgPSByZXNvbHZlOwogICAgfSwgJ1Rlc3RBZGFwdGVyIHBhdXNlZCBwcm9taXNlJyk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL3RyaWdnZXJfZXZlbnQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdGVzdGluZy9saWIvZXZlbnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZXZlbnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSB0cmlnZ2VyRXZlbnQ7CgogIC8qKgogICAgVHJpZ2dlcnMgdGhlIGdpdmVuIERPTSBldmVudCBvbiB0aGUgZWxlbWVudCBpZGVudGlmaWVkIGJ5IHRoZSBwcm92aWRlZCBzZWxlY3Rvci4KICAgIEV4YW1wbGU6CiAgICBgYGBqYXZhc2NyaXB0CiAgICB0cmlnZ2VyRXZlbnQoJyNzb21lLWVsZW0taWQnLCAnYmx1cicpOwogICAgYGBgCiAgICBUaGlzIGlzIGFjdHVhbGx5IHVzZWQgaW50ZXJuYWxseSBieSB0aGUgYGtleUV2ZW50YCBoZWxwZXIgbGlrZSBzbzoKICAgIGBgYGphdmFzY3JpcHQKICAgIHRyaWdnZXJFdmVudCgnI3NvbWUtZWxlbS1pZCcsICdrZXlwcmVzcycsIHsga2V5Q29kZTogMTMgfSk7CiAgICBgYGAKICAgQG1ldGhvZCB0cmlnZ2VyRXZlbnQKICAgQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGpRdWVyeSBzZWxlY3RvciBmb3IgZmluZGluZyBlbGVtZW50IG9uIHRoZSBET00KICAgQHBhcmFtIHtTdHJpbmd9IFtjb250ZXh0XSBqUXVlcnkgc2VsZWN0b3IgdGhhdCB3aWxsIGxpbWl0IHRoZSBzZWxlY3RvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IHRvIGZpbmQgb25seSB3aXRoaW4gdGhlIGNvbnRleHQncyBjaGlsZHJlbgogICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdHlwZSB0byBiZSB0cmlnZ2VyZWQuCiAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIGpRdWVyeS5FdmVudC4KICAgQHJldHVybiB7UlNWUC5Qcm9taXNlPHVuZGVmaW5lZD59CiAgIEBzaW5jZSAxLjUuMAogICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoYXBwLCBzZWxlY3RvciwgY29udGV4dE9yVHlwZSwgdHlwZU9yT3B0aW9ucywgcG9zc2libGVPcHRpb25zKSB7CiAgICB2YXIgYXJpdHkgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgdmFyIGNvbnRleHQgPSB2b2lkIDAsCiAgICAgICAgdHlwZSA9IHZvaWQgMCwKICAgICAgICBvcHRpb25zID0gdm9pZCAwOwoKICAgIGlmIChhcml0eSA9PT0gMykgewogICAgICAvLyBjb250ZXh0IGFuZCBvcHRpb25zIGFyZSBvcHRpb25hbCwgc28gdGhpcyBpcwogICAgICAvLyBhcHAsIHNlbGVjdG9yLCB0eXBlCiAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICB0eXBlID0gY29udGV4dE9yVHlwZTsKICAgICAgb3B0aW9ucyA9IHt9OwogICAgfSBlbHNlIGlmIChhcml0eSA9PT0gNCkgewogICAgICAvLyBjb250ZXh0IGFuZCBvcHRpb25zIGFyZSBvcHRpb25hbCwgc28gdGhpcyBpcwogICAgICBpZiAodHlwZW9mIHR5cGVPck9wdGlvbnMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgLy8gZWl0aGVyCiAgICAgICAgLy8gYXBwLCBzZWxlY3RvciwgdHlwZSwgb3B0aW9ucwogICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICAgIHR5cGUgPSBjb250ZXh0T3JUeXBlOwogICAgICAgIG9wdGlvbnMgPSB0eXBlT3JPcHRpb25zOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIG9yCiAgICAgICAgLy8gYXBwLCBzZWxlY3RvciwgY29udGV4dCwgdHlwZQogICAgICAgIGNvbnRleHQgPSBjb250ZXh0T3JUeXBlOwogICAgICAgIHR5cGUgPSB0eXBlT3JPcHRpb25zOwogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29udGV4dCA9IGNvbnRleHRPclR5cGU7CiAgICAgIHR5cGUgPSB0eXBlT3JPcHRpb25zOwogICAgICBvcHRpb25zID0gcG9zc2libGVPcHRpb25zOwogICAgfQoKICAgIHZhciAkZWwgPSBhcHAudGVzdEhlbHBlcnMuZmluZFdpdGhBc3NlcnQoc2VsZWN0b3IsIGNvbnRleHQpOwogICAgdmFyIGVsID0gJGVsWzBdOwoKICAgICgwLCBfZXZlbnRzLmZpcmVFdmVudCkoZWwsIHR5cGUsIG9wdGlvbnMpOwoKICAgIHJldHVybiBhcHAudGVzdEhlbHBlcnMud2FpdCgpOwogIH0gLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgICAqLwp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL3Zpc2l0JywgWydleHBvcnRzJywgJ0BlbWJlci9ydW5sb29wJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcnVubG9vcCkgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gdmlzaXQ7CgoKICAvKioKICAgIExvYWRzIGEgcm91dGUsIHNldHMgdXAgYW55IGNvbnRyb2xsZXJzLCBhbmQgcmVuZGVycyBhbnkgdGVtcGxhdGVzIGFzc29jaWF0ZWQKICAgIHdpdGggdGhlIHJvdXRlIGFzIHRob3VnaCBhIHJlYWwgdXNlciBoYWQgdHJpZ2dlcmVkIHRoZSByb3V0ZSBjaGFuZ2Ugd2hpbGUKICAgIHVzaW5nIHlvdXIgYXBwLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHZpc2l0KCdwb3N0cy9pbmRleCcpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIC8vIGFzc2VydCBzb21ldGhpbmcKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHZpc2l0CiAgICBAcGFyYW0ge1N0cmluZ30gdXJsIHRoZSBuYW1lIG9mIHRoZSByb3V0ZQogICAgQHJldHVybiB7UlNWUC5Qcm9taXNlPHVuZGVmaW5lZD59CiAgICBAcHVibGljCiAgKi8KICBmdW5jdGlvbiB2aXNpdChhcHAsIHVybCkgewogICAgdmFyIHJvdXRlciA9IGFwcC5fX2NvbnRhaW5lcl9fLmxvb2t1cCgncm91dGVyOm1haW4nKTsKICAgIHZhciBzaG91bGRIYW5kbGVVUkwgPSBmYWxzZTsKCiAgICBhcHAuYm9vdCgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICByb3V0ZXIubG9jYXRpb24uc2V0VVJMKHVybCk7CgogICAgICBpZiAoc2hvdWxkSGFuZGxlVVJMKSB7CiAgICAgICAgKDAsIF9ydW5sb29wLnJ1bikoYXBwLl9fZGVwcmVjYXRlZEluc3RhbmNlX18sICdoYW5kbGVVUkwnLCB1cmwpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAoYXBwLl9yZWFkaW5lc3NEZWZlcnJhbHMgPiAwKSB7CiAgICAgIHJvdXRlclsnaW5pdGlhbFVSTCddID0gdXJsOwogICAgICAoMCwgX3J1bmxvb3AucnVuKShhcHAsICdhZHZhbmNlUmVhZGluZXNzJyk7CiAgICAgIGRlbGV0ZSByb3V0ZXJbJ2luaXRpYWxVUkwnXTsKICAgIH0gZWxzZSB7CiAgICAgIHNob3VsZEhhbmRsZVVSTCA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIGFwcC50ZXN0SGVscGVycy53YWl0KCk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9oZWxwZXJzL3dhaXQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC93YWl0ZXJzJywgJ2VtYmVyLXJ1bnRpbWUnLCAnQGVtYmVyL3J1bmxvb3AnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9wZW5kaW5nX3JlcXVlc3RzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfd2FpdGVycywgX2VtYmVyUnVudGltZSwgX3J1bmxvb3AsIF9wZW5kaW5nX3JlcXVlc3RzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSB3YWl0OwoKCiAgLyoqCiAgICBDYXVzZXMgdGhlIHJ1biBsb29wIHRvIHByb2Nlc3MgYW55IHBlbmRpbmcgZXZlbnRzLiBUaGlzIGlzIHVzZWQgdG8gZW5zdXJlIHRoYXQKICAgIGFueSBhc3luYyBvcGVyYXRpb25zIGZyb20gb3RoZXIgaGVscGVycyAob3IgeW91ciBhc3NlcnRpb25zKSBoYXZlIGJlZW4gcHJvY2Vzc2VkLgogIAogICAgVGhpcyBpcyBtb3N0IG9mdGVuIHVzZWQgYXMgdGhlIHJldHVybiB2YWx1ZSBmb3IgdGhlIGhlbHBlciBmdW5jdGlvbnMgKHNlZSAnY2xpY2snLAogICAgJ2ZpbGxJbicsJ3Zpc2l0JyxldGMpLiBIb3dldmVyLCB0aGVyZSBpcyBhIG1ldGhvZCB0byByZWdpc3RlciBhIHRlc3QgaGVscGVyIHdoaWNoCiAgICB1dGlsaXplcyB0aGlzIG1ldGhvZCB3aXRob3V0IHRoZSBuZWVkIHRvIGFjdHVhbGx5IGNhbGwgYHdhaXQoKWAgaW4geW91ciBoZWxwZXJzLgogIAogICAgVGhlIGB3YWl0YCBoZWxwZXIgaXMgYnVpbHQgaW50byBgcmVnaXN0ZXJBc3luY0hlbHBlcmAgYnkgZGVmYXVsdC4gWW91IHdpbGwgbm90IG5lZWQKICAgIHRvIGByZXR1cm4gYXBwLnRlc3RIZWxwZXJzLndhaXQoKTtgIC0gdGhlIHdhaXQgYmVoYXZpb3IgaXMgcHJvdmlkZWQgZm9yIHlvdS4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyByZWdpc3RlckFzeW5jSGVscGVyIH0gZnJvbSAnQGVtYmVyL3Rlc3QnOwogIAogICAgcmVnaXN0ZXJBc3luY0hlbHBlcignbG9naW5Vc2VyJywgZnVuY3Rpb24oYXBwLCB1c2VybmFtZSwgcGFzc3dvcmQpIHsKICAgICAgdmlzaXQoJ3NlY3VyZWQvcGF0aC9oZXJlJykKICAgICAgICAuZmlsbEluKCcjdXNlcm5hbWUnLCB1c2VybmFtZSkKICAgICAgICAuZmlsbEluKCcjcGFzc3dvcmQnLCBwYXNzd29yZCkKICAgICAgICAuY2xpY2soJy5zdWJtaXQnKTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHdhaXQKICAgIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZSBUaGUgdmFsdWUgdG8gYmUgcmV0dXJuZWQuCiAgICBAcmV0dXJuIHtSU1ZQLlByb21pc2U8YW55Pn0gUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHRoZSBwYXNzZWQgdmFsdWUuCiAgICBAcHVibGljCiAgICBAc2luY2UgMS4wLjAKICAqLwogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwogIGZ1bmN0aW9uIHdhaXQoYXBwLCB2YWx1ZSkgewogICAgcmV0dXJuIG5ldyBfZW1iZXJSdW50aW1lLlJTVlAuUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICB2YXIgcm91dGVyID0gYXBwLl9fY29udGFpbmVyX18ubG9va3VwKCdyb3V0ZXI6bWFpbicpOwoKICAgICAgLy8gRXZlcnkgMTBtcywgcG9sbCBmb3IgdGhlIGFzeW5jIHRoaW5nIHRvIGhhdmUgZmluaXNoZWQKICAgICAgdmFyIHdhdGNoZXIgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gMS4gSWYgdGhlIHJvdXRlciBpcyBsb2FkaW5nLCBrZWVwIHBvbGxpbmcKICAgICAgICB2YXIgcm91dGVySXNMb2FkaW5nID0gcm91dGVyLl9yb3V0ZXJNaWNyb2xpYiAmJiAhIXJvdXRlci5fcm91dGVyTWljcm9saWIuYWN0aXZlVHJhbnNpdGlvbjsKICAgICAgICBpZiAocm91dGVySXNMb2FkaW5nKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAyLiBJZiB0aGVyZSBhcmUgcGVuZGluZyBBamF4IHJlcXVlc3RzLCBrZWVwIHBvbGxpbmcKICAgICAgICBpZiAoKDAsIF9wZW5kaW5nX3JlcXVlc3RzLnBlbmRpbmdSZXF1ZXN0cykoKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gMy4gSWYgdGhlcmUgYXJlIHNjaGVkdWxlZCB0aW1lcnMgb3Igd2UgYXJlIGluc2lkZSBvZiBhIHJ1biBsb29wLCBrZWVwIHBvbGxpbmcKICAgICAgICBpZiAoKDAsIF9ydW5sb29wLmhhc1NjaGVkdWxlZFRpbWVycykoKSB8fCAoMCwgX3J1bmxvb3AuZ2V0Q3VycmVudFJ1bkxvb3ApKCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICgoMCwgX3dhaXRlcnMuY2hlY2tXYWl0ZXJzKSgpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9wIHBvbGxpbmcKICAgICAgICBjbGVhckludGVydmFsKHdhdGNoZXIpOwoKICAgICAgICAvLyBTeW5jaHJvbm91c2x5IHJlc29sdmUgdGhlIHByb21pc2UKICAgICAgICAoMCwgX3J1bmxvb3AucnVuKShudWxsLCByZXNvbHZlLCB2YWx1ZSk7CiAgICAgIH0sIDEwKTsKICAgIH0pOwogIH0KfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvaW5pdGlhbGl6ZXJzJywgWydAZW1iZXIvYXBwbGljYXRpb24nXSwgZnVuY3Rpb24gKF9hcHBsaWNhdGlvbikgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIG5hbWUgPSAnZGVmZXJSZWFkaW5lc3MgaW4gYHRlc3RpbmdgIG1vZGUnOwoKICAoMCwgX2FwcGxpY2F0aW9uLm9uTG9hZCkoJ0VtYmVyLkFwcGxpY2F0aW9uJywgZnVuY3Rpb24gKEFwcGxpY2F0aW9uKSB7CiAgICBpZiAoIUFwcGxpY2F0aW9uLmluaXRpYWxpemVyc1tuYW1lXSkgewogICAgICBBcHBsaWNhdGlvbi5pbml0aWFsaXplcih7CiAgICAgICAgbmFtZTogbmFtZSwKCiAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKGFwcGxpY2F0aW9uKSB7CiAgICAgICAgICBpZiAoYXBwbGljYXRpb24udGVzdGluZykgewogICAgICAgICAgICBhcHBsaWNhdGlvbi5kZWZlclJlYWRpbmVzcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL3NldHVwX2Zvcl90ZXN0aW5nJywgWydleHBvcnRzJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci12aWV3cycsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L2FkYXB0ZXInLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9wZW5kaW5nX3JlcXVlc3RzJywgJ2VtYmVyLXRlc3RpbmcvbGliL2FkYXB0ZXJzL2FkYXB0ZXInLCAnZW1iZXItdGVzdGluZy9saWIvYWRhcHRlcnMvcXVuaXQnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9kZWJ1ZywgX2VtYmVyVmlld3MsIF9hZGFwdGVyLCBfcGVuZGluZ19yZXF1ZXN0cywgX2FkYXB0ZXIyLCBfcXVuaXQpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IHNldHVwRm9yVGVzdGluZzsKCgogIC8qKgogICAgU2V0cyBFbWJlciB1cCBmb3IgdGVzdGluZy4gVGhpcyBpcyB1c2VmdWwgdG8gcGVyZm9ybQogICAgYmFzaWMgc2V0dXAgc3RlcHMgaW4gb3JkZXIgdG8gdW5pdCB0ZXN0LgogIAogICAgVXNlIGBBcHAuc2V0dXBGb3JUZXN0aW5nYCB0byBwZXJmb3JtIGludGVncmF0aW9uIHRlc3RzIChmdWxsCiAgICBhcHBsaWNhdGlvbiB0ZXN0aW5nKS4KICAKICAgIEBtZXRob2Qgc2V0dXBGb3JUZXN0aW5nCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAc2luY2UgMS41LjAKICAgIEBwcml2YXRlCiAgKi8KICAvKiBnbG9iYWwgc2VsZiAqLwoKICBmdW5jdGlvbiBzZXR1cEZvclRlc3RpbmcoKSB7CiAgICAoMCwgX2RlYnVnLnNldFRlc3RpbmcpKHRydWUpOwoKICAgIHZhciBhZGFwdGVyID0gKDAsIF9hZGFwdGVyLmdldEFkYXB0ZXIpKCk7CiAgICAvLyBpZiBhZGFwdGVyIGlzIG5vdCBtYW51YWxseSBzZXQgZGVmYXVsdCB0byBRVW5pdAogICAgaWYgKCFhZGFwdGVyKSB7CiAgICAgICgwLCBfYWRhcHRlci5zZXRBZGFwdGVyKSh0eXBlb2Ygc2VsZi5RVW5pdCA9PT0gJ3VuZGVmaW5lZCcgPyBuZXcgX2FkYXB0ZXIyLmRlZmF1bHQoKSA6IG5ldyBfcXVuaXQuZGVmYXVsdCgpKTsKICAgIH0KCiAgICBpZiAoIV9lbWJlclZpZXdzLmpRdWVyeURpc2FibGVkKSB7CiAgICAgICgwLCBfZW1iZXJWaWV3cy5qUXVlcnkpKGRvY3VtZW50KS5vZmYoJ2FqYXhTZW5kJywgX3BlbmRpbmdfcmVxdWVzdHMuaW5jcmVtZW50UGVuZGluZ1JlcXVlc3RzKTsKICAgICAgKDAsIF9lbWJlclZpZXdzLmpRdWVyeSkoZG9jdW1lbnQpLm9mZignYWpheENvbXBsZXRlJywgX3BlbmRpbmdfcmVxdWVzdHMuZGVjcmVtZW50UGVuZGluZ1JlcXVlc3RzKTsKCiAgICAgICgwLCBfcGVuZGluZ19yZXF1ZXN0cy5jbGVhclBlbmRpbmdSZXF1ZXN0cykoKTsKCiAgICAgICgwLCBfZW1iZXJWaWV3cy5qUXVlcnkpKGRvY3VtZW50KS5vbignYWpheFNlbmQnLCBfcGVuZGluZ19yZXF1ZXN0cy5pbmNyZW1lbnRQZW5kaW5nUmVxdWVzdHMpOwogICAgICAoMCwgX2VtYmVyVmlld3MualF1ZXJ5KShkb2N1bWVudCkub24oJ2FqYXhDb21wbGV0ZScsIF9wZW5kaW5nX3JlcXVlc3RzLmRlY3JlbWVudFBlbmRpbmdSZXF1ZXN0cyk7CiAgICB9CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi9zdXBwb3J0JywgWydAZW1iZXIvZGVidWcnLCAnZW1iZXItdmlld3MnLCAnZW1iZXItYnJvd3Nlci1lbnZpcm9ubWVudCddLCBmdW5jdGlvbiAoX2RlYnVnLCBfZW1iZXJWaWV3cywgX2VtYmVyQnJvd3NlckVudmlyb25tZW50KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvKioKICAgIEBtb2R1bGUgZW1iZXIKICAqLwoKICB2YXIgJCA9IF9lbWJlclZpZXdzLmpRdWVyeTsKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBjcmVhdGVzIGEgY2hlY2tib3ggYW5kIHRyaWdnZXJzIHRoZSBjbGljayBldmVudCB0byBmaXJlIHRoZQogICAgcGFzc2VkIGluIGhhbmRsZXIuIEl0IGlzIHVzZWQgdG8gY29ycmVjdCBmb3IgYSBidWcgaW4gb2xkZXIgdmVyc2lvbnMKICAgIG9mIGpRdWVyeSAoZS5nIDEuOC4zKS4KICAKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIHRlc3RDaGVja2JveENsaWNrCiAgKi8KICBmdW5jdGlvbiB0ZXN0Q2hlY2tib3hDbGljayhoYW5kbGVyKSB7CiAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOwogICAgJChpbnB1dCkuYXR0cigndHlwZScsICdjaGVja2JveCcpLmNzcyh7IHBvc2l0aW9uOiAnYWJzb2x1dGUnLCBsZWZ0OiAnLTEwMDBweCcsIHRvcDogJy0xMDAwcHgnIH0pLmFwcGVuZFRvKCdib2R5Jykub24oJ2NsaWNrJywgaGFuZGxlcikudHJpZ2dlcignY2xpY2snKS5yZW1vdmUoKTsKICB9CgogIGlmIChfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaGFzRE9NICYmICFfZW1iZXJWaWV3cy5qUXVlcnlEaXNhYmxlZCkgewogICAgJChmdW5jdGlvbiAoKSB7CiAgICAgIC8qCiAgICAgICAgRGV0ZXJtaW5lIHdoZXRoZXIgYSBjaGVja2JveCBjaGVja2VkIHVzaW5nIGpRdWVyeSdzICJjbGljayIgbWV0aG9kIHdpbGwgaGF2ZQogICAgICAgIHRoZSBjb3JyZWN0IHZhbHVlIGZvciBpdHMgY2hlY2tlZCBwcm9wZXJ0eS4KICAgICAgICAgSWYgd2UgZGV0ZXJtaW5lIHRoYXQgdGhlIGN1cnJlbnQgalF1ZXJ5IHZlcnNpb24gZXhoaWJpdHMgdGhpcyBiZWhhdmlvciwKICAgICAgICBwYXRjaCBpdCB0byB3b3JrIGNvcnJlY3RseSBhcyBpbiB0aGUgY29tbWl0IGZvciB0aGUgYWN0dWFsIGZpeDoKICAgICAgICBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9jb21taXQvMWZiMmY5Mi4KICAgICAgKi8KICAgICAgdGVzdENoZWNrYm94Q2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghdGhpcy5jaGVja2VkICYmICEkLmV2ZW50LnNwZWNpYWwuY2xpY2spIHsKICAgICAgICAgICQuZXZlbnQuc3BlY2lhbC5jbGljayA9IHsKICAgICAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmICh0aGlzLm5vZGVOYW1lID09PSAnSU5QVVQnICYmIHRoaXMudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiB0aGlzLmNsaWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsaWNrKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyBUcnkgYWdhaW4gdG8gdmVyaWZ5IHRoYXQgdGhlIHBhdGNoIHRvb2sgZWZmZWN0IG9yIGJsb3cgdXAuCiAgICAgIHRlc3RDaGVja2JveENsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAodHJ1ZSAmJiAoMCwgX2RlYnVnLndhcm4pKCJjbGlja2VkIGNoZWNrYm94ZXMgc2hvdWxkIGJlIGNoZWNrZWQhIHRoZSBqUXVlcnkgcGF0Y2ggZGlkbid0IHdvcmsiLCB0aGlzLmNoZWNrZWQsIHsKICAgICAgICAgIGlkOiAnZW1iZXItdGVzdGluZy50ZXN0LWNoZWNrYm94LWNsaWNrJwogICAgICAgIH0pKTsKICAgICAgfSk7CiAgICB9KTsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9oZWxwZXJzJywgJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3Qvb25faW5qZWN0X2hlbHBlcnMnLCAnZW1iZXItdGVzdGluZy9saWIvdGVzdC9wcm9taXNlJywgJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3Qvd2FpdGVycycsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L2FkYXB0ZXInXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9oZWxwZXJzLCBfb25faW5qZWN0X2hlbHBlcnMsIF9wcm9taXNlLCBfd2FpdGVycywgX2FkYXB0ZXIpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgVGhpcyBpcyBhIGNvbnRhaW5lciBmb3IgYW4gYXNzb3J0bWVudCBvZiB0ZXN0aW5nIHJlbGF0ZWQgZnVuY3Rpb25hbGl0eToKICAKICAgICogQ2hvb3NlIHlvdXIgZGVmYXVsdCB0ZXN0IGFkYXB0ZXIgKGZvciB5b3VyIGZyYW1ld29yayBvZiBjaG9pY2UpLgogICAgKiBSZWdpc3Rlci9VbnJlZ2lzdGVyIGFkZGl0aW9uYWwgdGVzdCBoZWxwZXJzLgogICAgKiBTZXR1cCBjYWxsYmFja3MgdG8gYmUgZmlyZWQgd2hlbiB0aGUgdGVzdCBoZWxwZXJzIGFyZSBpbmplY3RlZCBpbnRvCiAgICAgIHlvdXIgYXBwbGljYXRpb24uCiAgCiAgICBAY2xhc3MgVGVzdAogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHB1YmxpYwogICovCiAgdmFyIFRlc3QgPSB7CiAgICAvKioKICAgICAgSGFzaCBjb250YWluaW5nIGFsbCBrbm93biB0ZXN0IGhlbHBlcnMuCiAgICAgICBAcHJvcGVydHkgX2hlbHBlcnMKICAgICAgQHByaXZhdGUKICAgICAgQHNpbmNlIDEuNy4wCiAgICAqLwogICAgX2hlbHBlcnM6IF9oZWxwZXJzLmhlbHBlcnMsCgogICAgcmVnaXN0ZXJIZWxwZXI6IF9oZWxwZXJzLnJlZ2lzdGVySGVscGVyLAogICAgcmVnaXN0ZXJBc3luY0hlbHBlcjogX2hlbHBlcnMucmVnaXN0ZXJBc3luY0hlbHBlciwKICAgIHVucmVnaXN0ZXJIZWxwZXI6IF9oZWxwZXJzLnVucmVnaXN0ZXJIZWxwZXIsCiAgICBvbkluamVjdEhlbHBlcnM6IF9vbl9pbmplY3RfaGVscGVycy5vbkluamVjdEhlbHBlcnMsCiAgICBQcm9taXNlOiBfcHJvbWlzZS5kZWZhdWx0LAogICAgcHJvbWlzZTogX3Byb21pc2UucHJvbWlzZSwKICAgIHJlc29sdmU6IF9wcm9taXNlLnJlc29sdmUsCiAgICByZWdpc3RlcldhaXRlcjogX3dhaXRlcnMucmVnaXN0ZXJXYWl0ZXIsCiAgICB1bnJlZ2lzdGVyV2FpdGVyOiBfd2FpdGVycy51bnJlZ2lzdGVyV2FpdGVyLAogICAgY2hlY2tXYWl0ZXJzOiBfd2FpdGVycy5jaGVja1dhaXRlcnMKICB9OwoKICAvKioKICAgVXNlZCB0byBhbGxvdyBlbWJlci10ZXN0aW5nIHRvIGNvbW11bmljYXRlIHdpdGggYSBzcGVjaWZpYyB0ZXN0aW5nCiAgIGZyYW1ld29yay4KICAKICAgWW91IGNhbiBtYW51YWxseSBzZXQgaXQgYmVmb3JlIGNhbGxpbmcgYEFwcC5zZXR1cEZvclRlc3RpbmcoKWAuCiAgCiAgIEV4YW1wbGU6CiAgCiAgIGBgYGphdmFzY3JpcHQKICAgRW1iZXIuVGVzdC5hZGFwdGVyID0gTXlDdXN0b21BZGFwdGVyLmNyZWF0ZSgpCiAgIGBgYAogIAogICBJZiB5b3UgZG8gbm90IHNldCBpdCwgZW1iZXItdGVzdGluZyB3aWxsIGRlZmF1bHQgdG8gYEVtYmVyLlRlc3QuUVVuaXRBZGFwdGVyYC4KICAKICAgQHB1YmxpYwogICBAZm9yIEVtYmVyLlRlc3QKICAgQHByb3BlcnR5IGFkYXB0ZXIKICAgQHR5cGUge0NsYXNzfSBUaGUgYWRhcHRlciB0byBiZSB1c2VkLgogICBAZGVmYXVsdCBFbWJlci5UZXN0LlFVbml0QWRhcHRlcgogICovCiAgLyoqCiAgICBAbW9kdWxlIGVtYmVyCiAgKi8KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVGVzdCwgJ2FkYXB0ZXInLCB7CiAgICBnZXQ6IF9hZGFwdGVyLmdldEFkYXB0ZXIsCiAgICBzZXQ6IF9hZGFwdGVyLnNldEFkYXB0ZXIKICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gVGVzdDsKfSk7CmVuaWZlZCgnZW1iZXItdGVzdGluZy9saWIvdGVzdC9hZGFwdGVyJywgWydleHBvcnRzJywgJ2VtYmVyLWVycm9yLWhhbmRsaW5nJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJFcnJvckhhbmRsaW5nKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmdldEFkYXB0ZXIgPSBnZXRBZGFwdGVyOwogIGV4cG9ydHMuc2V0QWRhcHRlciA9IHNldEFkYXB0ZXI7CiAgZXhwb3J0cy5hc3luY1N0YXJ0ID0gYXN5bmNTdGFydDsKICBleHBvcnRzLmFzeW5jRW5kID0gYXN5bmNFbmQ7CgoKICB2YXIgYWRhcHRlciA9IHZvaWQgMDsKICBmdW5jdGlvbiBnZXRBZGFwdGVyKCkgewogICAgcmV0dXJuIGFkYXB0ZXI7CiAgfQoKICBmdW5jdGlvbiBzZXRBZGFwdGVyKHZhbHVlKSB7CiAgICBhZGFwdGVyID0gdmFsdWU7CiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmV4Y2VwdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAoMCwgX2VtYmVyRXJyb3JIYW5kbGluZy5zZXREaXNwYXRjaE92ZXJyaWRlKShhZGFwdGVyRGlzcGF0Y2gpOwogICAgfSBlbHNlIHsKICAgICAgKDAsIF9lbWJlckVycm9ySGFuZGxpbmcuc2V0RGlzcGF0Y2hPdmVycmlkZSkobnVsbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc3luY1N0YXJ0KCkgewogICAgaWYgKGFkYXB0ZXIpIHsKICAgICAgYWRhcHRlci5hc3luY1N0YXJ0KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhc3luY0VuZCgpIHsKICAgIGlmIChhZGFwdGVyKSB7CiAgICAgIGFkYXB0ZXIuYXN5bmNFbmQoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFkYXB0ZXJEaXNwYXRjaChlcnJvcikgewogICAgYWRhcHRlci5leGNlcHRpb24oZXJyb3IpOwoKICAgIGNvbnNvbGUuZXJyb3IoZXJyb3Iuc3RhY2spOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXRlc3RpbmcvbGliL3Rlc3QvaGVscGVycycsIFsnZXhwb3J0cycsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3Byb21pc2UnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9wcm9taXNlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmhlbHBlcnMgPSB1bmRlZmluZWQ7CiAgZXhwb3J0cy5yZWdpc3RlckhlbHBlciA9IHJlZ2lzdGVySGVscGVyOwogIGV4cG9ydHMucmVnaXN0ZXJBc3luY0hlbHBlciA9IHJlZ2lzdGVyQXN5bmNIZWxwZXI7CiAgZXhwb3J0cy51bnJlZ2lzdGVySGVscGVyID0gdW5yZWdpc3RlckhlbHBlcjsKICB2YXIgaGVscGVycyA9IGV4cG9ydHMuaGVscGVycyA9IHt9OwogIC8qKgogICBAbW9kdWxlIEBlbWJlci90ZXN0CiAgKi8KCiAgLyoqCiAgICBgcmVnaXN0ZXJIZWxwZXJgIGlzIHVzZWQgdG8gcmVnaXN0ZXIgYSB0ZXN0IGhlbHBlciB0aGF0IHdpbGwgYmUgaW5qZWN0ZWQKICAgIHdoZW4gYEFwcC5pbmplY3RUZXN0SGVscGVyc2AgaXMgY2FsbGVkLgogIAogICAgVGhlIGhlbHBlciBtZXRob2Qgd2lsbCBhbHdheXMgYmUgY2FsbGVkIHdpdGggdGhlIGN1cnJlbnQgQXBwbGljYXRpb24gYXMKICAgIHRoZSBmaXJzdCBwYXJhbWV0ZXIuCiAgCiAgICBGb3IgZXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCB7IHJlZ2lzdGVySGVscGVyIH0gZnJvbSAnQGVtYmVyL3Rlc3QnOwogICAgaW1wb3J0IHsgcnVuIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogIAogICAgcmVnaXN0ZXJIZWxwZXIoJ2Jvb3QnLCBmdW5jdGlvbihhcHApIHsKICAgICAgcnVuKGFwcCwgYXBwLmFkdmFuY2VSZWFkaW5lc3MpOwogICAgfSk7CiAgICBgYGAKICAKICAgIFRoaXMgaGVscGVyIGNhbiBsYXRlciBiZSBjYWxsZWQgd2l0aG91dCBhcmd1bWVudHMgYmVjYXVzZSBpdCB3aWxsIGJlCiAgICBjYWxsZWQgd2l0aCBgYXBwYCBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgCiAgICBBcHAgPSBBcHBsaWNhdGlvbi5jcmVhdGUoKTsKICAgIEFwcC5pbmplY3RUZXN0SGVscGVycygpOwogICAgYm9vdCgpOwogICAgYGBgCiAgCiAgICBAcHVibGljCiAgICBAZm9yIEBlbWJlci90ZXN0CiAgICBAc3RhdGljCiAgICBAbWV0aG9kIHJlZ2lzdGVySGVscGVyCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaGVscGVyIG1ldGhvZCB0byBhZGQuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBoZWxwZXJNZXRob2QKICAgIEBwYXJhbSBvcHRpb25zIHtPYmplY3R9CiAgKi8KICBmdW5jdGlvbiByZWdpc3RlckhlbHBlcihuYW1lLCBoZWxwZXJNZXRob2QpIHsKICAgIGhlbHBlcnNbbmFtZV0gPSB7CiAgICAgIG1ldGhvZDogaGVscGVyTWV0aG9kLAogICAgICBtZXRhOiB7IHdhaXQ6IGZhbHNlIH0KICAgIH07CiAgfQoKICAvKioKICAgIGByZWdpc3RlckFzeW5jSGVscGVyYCBpcyB1c2VkIHRvIHJlZ2lzdGVyIGFuIGFzeW5jIHRlc3QgaGVscGVyIHRoYXQgd2lsbCBiZSBpbmplY3RlZAogICAgd2hlbiBgQXBwLmluamVjdFRlc3RIZWxwZXJzYCBpcyBjYWxsZWQuCiAgCiAgICBUaGUgaGVscGVyIG1ldGhvZCB3aWxsIGFsd2F5cyBiZSBjYWxsZWQgd2l0aCB0aGUgY3VycmVudCBBcHBsaWNhdGlvbiBhcwogICAgdGhlIGZpcnN0IHBhcmFtZXRlci4KICAKICAgIEZvciBleGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgcmVnaXN0ZXJBc3luY0hlbHBlciB9IGZyb20gJ0BlbWJlci90ZXN0JzsKICAgIGltcG9ydCB7IHJ1biB9IGZyb20gJ0BlbWJlci9ydW5sb29wJzsKICAKICAgIHJlZ2lzdGVyQXN5bmNIZWxwZXIoJ2Jvb3QnLCBmdW5jdGlvbihhcHApIHsKICAgICAgcnVuKGFwcCwgYXBwLmFkdmFuY2VSZWFkaW5lc3MpOwogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSBhZHZhbnRhZ2Ugb2YgYW4gYXN5bmMgaGVscGVyIGlzIHRoYXQgaXQgd2lsbCBub3QgcnVuCiAgICB1bnRpbCB0aGUgbGFzdCBhc3luYyBoZWxwZXIgaGFzIGNvbXBsZXRlZC4gIEFsbCBhc3luYyBoZWxwZXJzCiAgICBhZnRlciBpdCB3aWxsIHdhaXQgZm9yIGl0IGNvbXBsZXRlIGJlZm9yZSBydW5uaW5nLgogIAogIAogICAgRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgeyByZWdpc3RlckFzeW5jSGVscGVyIH0gZnJvbSAnQGVtYmVyL3Rlc3QnOwogIAogICAgcmVnaXN0ZXJBc3luY0hlbHBlcignZGVsZXRlUG9zdCcsIGZ1bmN0aW9uKGFwcCwgcG9zdElkKSB7CiAgICAgIGNsaWNrKCcuZGVsZXRlLScgKyBwb3N0SWQpOwogICAgfSk7CiAgCiAgICAvLyAuLi4gaW4geW91ciB0ZXN0CiAgICB2aXNpdCgnL3Bvc3QvMicpOwogICAgZGVsZXRlUG9zdCgyKTsKICAgIHZpc2l0KCcvcG9zdC8zJyk7CiAgICBkZWxldGVQb3N0KDMpOwogICAgYGBgCiAgCiAgICBAcHVibGljCiAgICBAZm9yIEBlbWJlci90ZXN0CiAgICBAbWV0aG9kIHJlZ2lzdGVyQXN5bmNIZWxwZXIKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBoZWxwZXIgbWV0aG9kIHRvIGFkZC4KICAgIEBwYXJhbSB7RnVuY3Rpb259IGhlbHBlck1ldGhvZAogICAgQHNpbmNlIDEuMi4wCiAgKi8KICBmdW5jdGlvbiByZWdpc3RlckFzeW5jSGVscGVyKG5hbWUsIGhlbHBlck1ldGhvZCkgewogICAgaGVscGVyc1tuYW1lXSA9IHsKICAgICAgbWV0aG9kOiBoZWxwZXJNZXRob2QsCiAgICAgIG1ldGE6IHsgd2FpdDogdHJ1ZSB9CiAgICB9OwogIH0KCiAgLyoqCiAgICBSZW1vdmUgYSBwcmV2aW91c2x5IGFkZGVkIGhlbHBlciBtZXRob2QuCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgaW1wb3J0IHsgdW5yZWdpc3RlckhlbHBlciB9IGZyb20gJ0BlbWJlci90ZXN0JzsKICAKICAgIHVucmVnaXN0ZXJIZWxwZXIoJ3dhaXQnKTsKICAgIGBgYAogIAogICAgQHB1YmxpYwogICAgQG1ldGhvZCB1bnJlZ2lzdGVySGVscGVyCiAgICBAc3RhdGljCiAgICBAZm9yIEBlbWJlci90ZXN0CiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgaGVscGVyIHRvIHJlbW92ZS4KICAqLwogIGZ1bmN0aW9uIHVucmVnaXN0ZXJIZWxwZXIobmFtZSkgewogICAgZGVsZXRlIGhlbHBlcnNbbmFtZV07CiAgICBkZWxldGUgX3Byb21pc2UuZGVmYXVsdC5wcm90b3R5cGVbbmFtZV07CiAgfQp9KTsKZW5pZmVkKCJlbWJlci10ZXN0aW5nL2xpYi90ZXN0L29uX2luamVjdF9oZWxwZXJzIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBleHBvcnRzLm9uSW5qZWN0SGVscGVycyA9IG9uSW5qZWN0SGVscGVyczsKICBleHBvcnRzLmludm9rZUluamVjdEhlbHBlcnNDYWxsYmFja3MgPSBpbnZva2VJbmplY3RIZWxwZXJzQ2FsbGJhY2tzOwogIHZhciBjYWxsYmFja3MgPSBleHBvcnRzLmNhbGxiYWNrcyA9IFtdOwoKICAvKioKICAgIFVzZWQgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzIHRvIGJlIGZpcmVkIHdoZW5ldmVyIGBBcHAuaW5qZWN0VGVzdEhlbHBlcnNgCiAgICBpcyBjYWxsZWQuCiAgCiAgICBUaGUgY2FsbGJhY2sgd2lsbCByZWNlaXZlIHRoZSBjdXJyZW50IGFwcGxpY2F0aW9uIGFzIGFuIGFyZ3VtZW50LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgCiAgICBFbWJlci5UZXN0Lm9uSW5qZWN0SGVscGVycyhmdW5jdGlvbigpIHsKICAgICAgJChkb2N1bWVudCkuYWpheFNlbmQoZnVuY3Rpb24oKSB7CiAgICAgICAgVGVzdC5wZW5kaW5nUmVxdWVzdHMrKzsKICAgICAgfSk7CiAgCiAgICAgICQoZG9jdW1lbnQpLmFqYXhDb21wbGV0ZShmdW5jdGlvbigpIHsKICAgICAgICBUZXN0LnBlbmRpbmdSZXF1ZXN0cy0tOwogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAcHVibGljCiAgICBAZm9yIEVtYmVyLlRlc3QKICAgIEBtZXRob2Qgb25JbmplY3RIZWxwZXJzCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkLgogICovCiAgZnVuY3Rpb24gb25JbmplY3RIZWxwZXJzKGNhbGxiYWNrKSB7CiAgICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgfQoKICBmdW5jdGlvbiBpbnZva2VJbmplY3RIZWxwZXJzQ2FsbGJhY2tzKGFwcCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHsKICAgICAgY2FsbGJhY2tzW2ldKGFwcCk7CiAgICB9CiAgfQp9KTsKZW5pZmVkKCJlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3BlbmRpbmdfcmVxdWVzdHMiLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIGV4cG9ydHMucGVuZGluZ1JlcXVlc3RzID0gcGVuZGluZ1JlcXVlc3RzOwogIGV4cG9ydHMuY2xlYXJQZW5kaW5nUmVxdWVzdHMgPSBjbGVhclBlbmRpbmdSZXF1ZXN0czsKICBleHBvcnRzLmluY3JlbWVudFBlbmRpbmdSZXF1ZXN0cyA9IGluY3JlbWVudFBlbmRpbmdSZXF1ZXN0czsKICBleHBvcnRzLmRlY3JlbWVudFBlbmRpbmdSZXF1ZXN0cyA9IGRlY3JlbWVudFBlbmRpbmdSZXF1ZXN0czsKICB2YXIgcmVxdWVzdHMgPSBbXTsKCiAgZnVuY3Rpb24gcGVuZGluZ1JlcXVlc3RzKCkgewogICAgcmV0dXJuIHJlcXVlc3RzLmxlbmd0aDsKICB9CgogIGZ1bmN0aW9uIGNsZWFyUGVuZGluZ1JlcXVlc3RzKCkgewogICAgcmVxdWVzdHMubGVuZ3RoID0gMDsKICB9CgogIGZ1bmN0aW9uIGluY3JlbWVudFBlbmRpbmdSZXF1ZXN0cyhfLCB4aHIpIHsKICAgIHJlcXVlc3RzLnB1c2goeGhyKTsKICB9CgogIGZ1bmN0aW9uIGRlY3JlbWVudFBlbmRpbmdSZXF1ZXN0cyhfLCB4aHIpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcXVlc3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHhociA9PT0gcmVxdWVzdHNbaV0pIHsKICAgICAgICAgIHJlcXVlc3RzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwgMCk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3Byb21pc2UnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYmFiZWwnLCAnZW1iZXItcnVudGltZScsICdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3J1biddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwsIF9lbWJlclJ1bnRpbWUsIF9ydW4pIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMucHJvbWlzZSA9IHByb21pc2U7CiAgZXhwb3J0cy5yZXNvbHZlID0gcmVzb2x2ZTsKICBleHBvcnRzLmdldExhc3RQcm9taXNlID0gZ2V0TGFzdFByb21pc2U7CgoKICB2YXIgbGFzdFByb21pc2UgPSB2b2lkIDA7CgogIHZhciBUZXN0UHJvbWlzZSA9IGZ1bmN0aW9uIChfUlNWUCRQcm9taXNlKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFRlc3RQcm9taXNlLCBfUlNWUCRQcm9taXNlKTsKCiAgICBmdW5jdGlvbiBUZXN0UHJvbWlzZSgpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUZXN0UHJvbWlzZSk7CgogICAgICB2YXIgX3RoaXMgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX1JTVlAkUHJvbWlzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKCiAgICAgIGxhc3RQcm9taXNlID0gX3RoaXM7CiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBUZXN0UHJvbWlzZS5wcm90b3R5cGUudGhlbiA9IGZ1bmN0aW9uIHRoZW4oX29uRnVsZmlsbG1lbnQpIHsKICAgICAgdmFyIF9SU1ZQJFByb21pc2UkcHJvdG90eTsKCiAgICAgIHZhciBvbkZ1bGZpbGxtZW50ID0gdHlwZW9mIF9vbkZ1bGZpbGxtZW50ID09PSAnZnVuY3Rpb24nID8gZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgIHJldHVybiBpc29sYXRlKF9vbkZ1bGZpbGxtZW50LCByZXN1bHQpOwogICAgICB9IDogdW5kZWZpbmVkOwoKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIHJldHVybiAoX1JTVlAkUHJvbWlzZSRwcm90b3R5ID0gX1JTVlAkUHJvbWlzZS5wcm90b3R5cGUudGhlbikuY2FsbC5hcHBseShfUlNWUCRQcm9taXNlJHByb3RvdHksIFt0aGlzLCBvbkZ1bGZpbGxtZW50XS5jb25jYXQoYXJncykpOwogICAgfTsKCiAgICByZXR1cm4gVGVzdFByb21pc2U7CiAgfShfZW1iZXJSdW50aW1lLlJTVlAuUHJvbWlzZSk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IFRlc3RQcm9taXNlOwoKCiAgLyoqCiAgICBUaGlzIHJldHVybnMgYSB0aGVuYWJsZSB0YWlsb3JlZCBmb3IgdGVzdGluZy4gIEl0IGNhdGNoZXMgZmFpbGVkCiAgICBgb25TdWNjZXNzYCBjYWxsYmFja3MgYW5kIGludm9rZXMgdGhlIGBFbWJlci5UZXN0LmFkYXB0ZXIuZXhjZXB0aW9uYAogICAgY2FsbGJhY2sgaW4gdGhlIGxhc3QgY2hhaW5lZCB0aGVuLgogIAogICAgVGhpcyBtZXRob2Qgc2hvdWxkIGJlIHJldHVybmVkIGJ5IGFzeW5jIGhlbHBlcnMgc3VjaCBhcyBgd2FpdGAuCiAgCiAgICBAcHVibGljCiAgICBAZm9yIEVtYmVyLlRlc3QKICAgIEBtZXRob2QgcHJvbWlzZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gcmVzb2x2ZXIgVGhlIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgcHJvbWlzZS4KICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBBbiBvcHRpb25hbCBzdHJpbmcgZm9yIGlkZW50aWZ5aW5nIHRoZSBwcm9taXNlLgogICovCiAgZnVuY3Rpb24gcHJvbWlzZShyZXNvbHZlciwgbGFiZWwpIHsKICAgIHZhciBmdWxsTGFiZWwgPSAnRW1iZXIuVGVzdC5wcm9taXNlOiAnICsgKGxhYmVsIHx8ICc8VW5rbm93biBQcm9taXNlPicpOwogICAgcmV0dXJuIG5ldyBUZXN0UHJvbWlzZShyZXNvbHZlciwgZnVsbExhYmVsKTsKICB9CgogIC8qKgogICAgUmVwbGFjZW1lbnQgZm9yIGBFbWJlci5SU1ZQLnJlc29sdmVgCiAgICBUaGUgb25seSBkaWZmZXJlbmNlIGlzIHRoaXMgdXNlcwogICAgYW4gaW5zdGFuY2Ugb2YgYEVtYmVyLlRlc3QuUHJvbWlzZWAKICAKICAgIEBwdWJsaWMKICAgIEBmb3IgRW1iZXIuVGVzdAogICAgQG1ldGhvZCByZXNvbHZlCiAgICBAcGFyYW0ge01peGVkfSBUaGUgdmFsdWUgdG8gcmVzb2x2ZQogICAgQHNpbmNlIDEuMi4wCiAgKi8KICBmdW5jdGlvbiByZXNvbHZlKHJlc3VsdCwgbGFiZWwpIHsKICAgIHJldHVybiBUZXN0UHJvbWlzZS5yZXNvbHZlKHJlc3VsdCwgbGFiZWwpOwogIH0KCiAgZnVuY3Rpb24gZ2V0TGFzdFByb21pc2UoKSB7CiAgICByZXR1cm4gbGFzdFByb21pc2U7CiAgfQoKICAvLyBUaGlzIG1ldGhvZCBpc29sYXRlcyBuZXN0ZWQgYXN5bmMgbWV0aG9kcwogIC8vIHNvIHRoYXQgdGhleSBkb24ndCBjb25mbGljdCB3aXRoIG90aGVyIGxhc3QgcHJvbWlzZXMuCiAgLy8KICAvLyAxLiBTZXQgYEVtYmVyLlRlc3QubGFzdFByb21pc2VgIHRvIG51bGwKICAvLyAyLiBJbnZva2UgbWV0aG9kCiAgLy8gMy4gUmV0dXJuIHRoZSBsYXN0IHByb21pc2UgY3JlYXRlZCBkdXJpbmcgbWV0aG9kCiAgZnVuY3Rpb24gaXNvbGF0ZShvbkZ1bGZpbGxtZW50LCByZXN1bHQpIHsKICAgIC8vIFJlc2V0IGxhc3RQcm9taXNlIGZvciBuZXN0ZWQgaGVscGVycwogICAgbGFzdFByb21pc2UgPSBudWxsOwoKICAgIHZhciB2YWx1ZSA9IG9uRnVsZmlsbG1lbnQocmVzdWx0KTsKCiAgICB2YXIgcHJvbWlzZSA9IGxhc3RQcm9taXNlOwogICAgbGFzdFByb21pc2UgPSBudWxsOwoKICAgIC8vIElmIHRoZSBtZXRob2QgcmV0dXJuZWQgYSBwcm9taXNlCiAgICAvLyByZXR1cm4gdGhhdCBwcm9taXNlLiBJZiBub3QsCiAgICAvLyByZXR1cm4gdGhlIGxhc3QgYXN5bmMgaGVscGVyJ3MgcHJvbWlzZQogICAgaWYgKHZhbHVlICYmIHZhbHVlIGluc3RhbmNlb2YgVGVzdFByb21pc2UgfHwgIXByb21pc2UpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICgwLCBfcnVuLmRlZmF1bHQpKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZShwcm9taXNlKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfQp9KTsKZW5pZmVkKCdlbWJlci10ZXN0aW5nL2xpYi90ZXN0L3J1bicsIFsnZXhwb3J0cycsICdAZW1iZXIvcnVubG9vcCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3J1bmxvb3ApIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IHJ1bjsKICBmdW5jdGlvbiBydW4oZm4pIHsKICAgIGlmICghKDAsIF9ydW5sb29wLmdldEN1cnJlbnRSdW5Mb29wKSgpKSB7CiAgICAgIHJldHVybiAoMCwgX3J1bmxvb3AucnVuKShmbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZm4oKTsKICAgIH0KICB9Cn0pOwplbmlmZWQoImVtYmVyLXRlc3RpbmcvbGliL3Rlc3Qvd2FpdGVycyIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5yZWdpc3RlcldhaXRlciA9IHJlZ2lzdGVyV2FpdGVyOwogIGV4cG9ydHMudW5yZWdpc3RlcldhaXRlciA9IHVucmVnaXN0ZXJXYWl0ZXI7CiAgZXhwb3J0cy5jaGVja1dhaXRlcnMgPSBjaGVja1dhaXRlcnM7CiAgLyoqCiAgIEBtb2R1bGUgQGVtYmVyL3Rlc3QKICAqLwogIHZhciBjb250ZXh0cyA9IFtdOwogIHZhciBjYWxsYmFja3MgPSBbXTsKCiAgLyoqCiAgICAgVGhpcyBhbGxvd3MgZW1iZXItdGVzdGluZyB0byBwbGF5IG5pY2VseSB3aXRoIG90aGVyIGFzeW5jaHJvbm91cwogICAgIGV2ZW50cywgc3VjaCBhcyBhbiBhcHBsaWNhdGlvbiB0aGF0IGlzIHdhaXRpbmcgZm9yIGEgQ1NTMwogICAgIHRyYW5zaXRpb24gb3IgYW4gSW5kZXhEQiB0cmFuc2FjdGlvbi4gVGhlIHdhaXRlciBydW5zIHBlcmlvZGljYWxseQogICAgIGFmdGVyIGVhY2ggYXN5bmMgaGVscGVyIChpLmUuIGBjbGlja2AsIGBhbmRUaGVuYCwgYHZpc2l0YCwgZXRjKSBoYXMgZXhlY3V0ZWQsCiAgICAgdW50aWwgdGhlIHJldHVybmluZyByZXN1bHQgaXMgdHJ1dGh5LiBBZnRlciB0aGUgd2FpdGVycyBmaW5pc2gsIHRoZSBuZXh0IGFzeW5jIGhlbHBlcgogICAgIGlzIGV4ZWN1dGVkIGFuZCB0aGUgcHJvY2VzcyByZXBlYXRzLgogIAogICAgIEZvciBleGFtcGxlOgogIAogICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgeyByZWdpc3RlcldhaXRlciB9IGZyb20gJ0BlbWJlci90ZXN0JzsKICAKICAgICByZWdpc3RlcldhaXRlcihmdW5jdGlvbigpIHsKICAgICAgIHJldHVybiBteVBlbmRpbmdUcmFuc2FjdGlvbnMoKSA9PT0gMDsKICAgICB9KTsKICAgICBgYGAKICAgICBUaGUgYGNvbnRleHRgIGFyZ3VtZW50IGFsbG93cyB5b3UgdG8gb3B0aW9uYWxseSBzcGVjaWZ5IHRoZSBgdGhpc2AKICAgICB3aXRoIHdoaWNoIHlvdXIgY2FsbGJhY2sgd2lsbCBiZSBpbnZva2VkLgogIAogICAgIEZvciBleGFtcGxlOgogIAogICAgIGBgYGphdmFzY3JpcHQKICAgICBpbXBvcnQgeyByZWdpc3RlcldhaXRlciB9IGZyb20gJ0BlbWJlci90ZXN0JzsKICAKICAgICByZWdpc3RlcldhaXRlcihNeURCLCBNeURCLmhhc1BlbmRpbmdUcmFuc2FjdGlvbnMpOwogICAgIGBgYAogIAogICAgIEBwdWJsaWMKICAgICBAZm9yIEBlbWJlci90ZXN0CiAgICAgQHN0YXRpYwogICAgIEBtZXRob2QgcmVnaXN0ZXJXYWl0ZXIKICAgICBAcGFyYW0ge09iamVjdH0gY29udGV4dCAob3B0aW9uYWwpCiAgICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sKICAgICBAc2luY2UgMS4yLjAKICAqLwogIGZ1bmN0aW9uIHJlZ2lzdGVyV2FpdGVyKGNvbnRleHQsIGNhbGxiYWNrKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICBjYWxsYmFjayA9IGNvbnRleHQ7CiAgICAgIGNvbnRleHQgPSBudWxsOwogICAgfQogICAgaWYgKGluZGV4T2YoY29udGV4dCwgY2FsbGJhY2spID4gLTEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29udGV4dHMucHVzaChjb250ZXh0KTsKICAgIGNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKICB9CgogIC8qKgogICAgIGB1bnJlZ2lzdGVyV2FpdGVyYCBpcyB1c2VkIHRvIHVucmVnaXN0ZXIgYSBjYWxsYmFjayB0aGF0IHdhcwogICAgIHJlZ2lzdGVyZWQgd2l0aCBgcmVnaXN0ZXJXYWl0ZXJgLgogIAogICAgIEBwdWJsaWMKICAgICBAZm9yIEBlbWJlci90ZXN0CiAgICAgQHN0YXRpYwogICAgIEBtZXRob2QgdW5yZWdpc3RlcldhaXRlcgogICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IChvcHRpb25hbCkKICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjawogICAgIEBzaW5jZSAxLjIuMAogICovCiAgZnVuY3Rpb24gdW5yZWdpc3RlcldhaXRlcihjb250ZXh0LCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgIGNhbGxiYWNrID0gY29udGV4dDsKICAgICAgY29udGV4dCA9IG51bGw7CiAgICB9CiAgICB2YXIgaSA9IGluZGV4T2YoY29udGV4dCwgY2FsbGJhY2spOwogICAgaWYgKGkgPT09IC0xKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnRleHRzLnNwbGljZShpLCAxKTsKICAgIGNhbGxiYWNrcy5zcGxpY2UoaSwgMSk7CiAgfQoKICAvKioKICAgIEl0ZXJhdGVzIHRocm91Z2ggZWFjaCByZWdpc3RlcmVkIHRlc3Qgd2FpdGVyLCBhbmQgaW52b2tlcwogICAgaXRzIGNhbGxiYWNrLiBJZiBhbnkgd2FpdGVyIHJldHVybnMgZmFsc2UsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuCiAgICB0cnVlIGluZGljYXRpbmcgdGhhdCB0aGUgd2FpdGVycyBoYXZlIG5vdCBzZXR0bGVkIHlldC4KICAKICAgIFRoaXMgaXMgZ2VuZXJhbGx5IHVzZWQgaW50ZXJuYWxseSBmcm9tIHRoZSBhY2NlcHRhbmNlL2ludGVncmF0aW9uIHRlc3QKICAgIGluZnJhc3RydWN0dXJlLgogIAogICAgQHB1YmxpYwogICAgQGZvciBAZW1iZXIvdGVzdAogICAgQHN0YXRpYwogICAgQG1ldGhvZCBjaGVja1dhaXRlcnMKICAqLwogIGZ1bmN0aW9uIGNoZWNrV2FpdGVycygpIHsKICAgIGlmICghY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgY29udGV4dCA9IGNvbnRleHRzW2ldOwogICAgICB2YXIgY2FsbGJhY2sgPSBjYWxsYmFja3NbaV07CiAgICAgIGlmICghY2FsbGJhY2suY2FsbChjb250ZXh0KSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpbmRleE9mKGNvbnRleHQsIGNhbGxiYWNrKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoY2FsbGJhY2tzW2ldID09PSBjYWxsYmFjayAmJiBjb250ZXh0c1tpXSA9PT0gY29udGV4dCkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci11dGlscycsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyQmFiZWwpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBleHBvcnRzLkNhY2hlID0gZXhwb3J0cy5zZXRQcm94eSA9IGV4cG9ydHMuaXNQcm94eSA9IGV4cG9ydHMuV2Vha1NldCA9IGV4cG9ydHMuSEFTX05BVElWRV9QUk9YWSA9IGV4cG9ydHMuSEFTX05BVElWRV9TWU1CT0wgPSBleHBvcnRzLnRvU3RyaW5nID0gZXhwb3J0cy5zZXROYW1lID0gZXhwb3J0cy5nZXROYW1lID0gZXhwb3J0cy5tYWtlQXJyYXkgPSBleHBvcnRzLnRyeUludm9rZSA9IGV4cG9ydHMuY2FuSW52b2tlID0gZXhwb3J0cy5sb29rdXBEZXNjcmlwdG9yID0gZXhwb3J0cy5pbnNwZWN0ID0gZXhwb3J0cy5zZXRMaXN0ZW5lcnMgPSBleHBvcnRzLnNldE9ic2VydmVycyA9IGV4cG9ydHMuZ2V0TGlzdGVuZXJzID0gZXhwb3J0cy5nZXRPYnNlcnZlcnMgPSBleHBvcnRzLndyYXAgPSBleHBvcnRzLlJPT1QgPSBleHBvcnRzLmNoZWNrSGFzU3VwZXIgPSBleHBvcnRzLmludGVybiA9IGV4cG9ydHMuZ3VpZEZvciA9IGV4cG9ydHMuZ2VuZXJhdGVHdWlkID0gZXhwb3J0cy5HVUlEX0tFWSA9IGV4cG9ydHMudXVpZCA9IGV4cG9ydHMuZGljdGlvbmFyeSA9IGV4cG9ydHMuaXNJbnRlcm5hbFN5bWJvbCA9IGV4cG9ydHMuc3ltYm9sID0gZXhwb3J0cy5OQU1FX0tFWSA9IHVuZGVmaW5lZDsKICAgIC8qKgogICAgICBTdHJvbmdseSBoaW50IHJ1bnRpbWVzIHRvIGludGVybiB0aGUgcHJvdmlkZWQgc3RyaW5nLgogICAgCiAgICAgIFdoZW4gZG8gSSBuZWVkIHRvIHVzZSB0aGlzIGZ1bmN0aW9uPwogICAgCiAgICAgIEZvciB0aGUgbW9zdCBwYXJ0LCBuZXZlci4gUHJlLW1hdHVyZSBvcHRpbWl6YXRpb24gaXMgYmFkLCBhbmQgb2Z0ZW4gdGhlCiAgICAgIHJ1bnRpbWUgZG9lcyBleGFjdGx5IHdoYXQgeW91IG5lZWQgaXQgdG8sIGFuZCBtb3JlIG9mdGVuIHRoZSB0cmFkZS1vZmYgaXNuJ3QKICAgICAgd29ydGggaXQuCiAgICAKICAgICAgV2h5PwogICAgCiAgICAgIFJ1bnRpbWVzIHN0b3JlIHN0cmluZ3MgaW4gYXQgbGVhc3QgMiBkaWZmZXJlbnQgcmVwcmVzZW50YXRpb25zOgogICAgICBSb3BlcyBhbmQgU3ltYm9scyAoaW50ZXJuZWQgc3RyaW5ncykuIFRoZSBSb3BlIHByb3ZpZGVzIGEgbWVtb3J5IGVmZmljaWVudAogICAgICBkYXRhLXN0cnVjdHVyZSBmb3Igc3RyaW5ncyBjcmVhdGVkIGZyb20gY29uY2F0ZW5hdGlvbiBvciBzb21lIG90aGVyIHN0cmluZwogICAgICBtYW5pcHVsYXRpb24gbGlrZSBzcGxpdHRpbmcuCiAgICAKICAgICAgVW5mb3J0dW5hdGVseSBjaGVja2luZyBlcXVhbGl0eSBvZiBkaWZmZXJlbnQgcm9wZXMgY2FuIGJlIHF1aXRlIGNvc3RseSBhcwogICAgICBydW50aW1lcyBtdXN0IHJlc29ydCB0byBjbGV2ZXIgc3RyaW5nIGNvbXBhcmlzb24gYWxnb3JpdGhtcy4gVGhlc2UKICAgICAgYWxnb3JpdGhtcyB0eXBpY2FsbHkgY29zdCBpbiBwcm9wb3J0aW9uIHRvIHRoZSBsZW5ndGggb2YgdGhlIHN0cmluZy4KICAgICAgTHVja2lseSwgdGhpcyBpcyB3aGVyZSB0aGUgU3ltYm9scyAoaW50ZXJuZWQgc3RyaW5ncykgc2hpbmUuIEFzIFN5bWJvbHMgYXJlCiAgICAgIHVuaXF1ZSBieSB0aGVpciBzdHJpbmcgY29udGVudCwgZXF1YWxpdHkgY2hlY2tzIGNhbiBiZSBkb25lIGJ5IHBvaW50ZXIKICAgICAgY29tcGFyaXNvbi4KICAgIAogICAgICBIb3cgZG8gSSBrbm93IGlmIG15IHN0cmluZyBpcyBhIHJvcGUgb3Igc3ltYm9sPwogICAgCiAgICAgIFR5cGljYWxseSAod2FybmluZyBnZW5lcmFsIHN3ZWVwaW5nIHN0YXRlbWVudCwgYnV0IHRydXRoeSBpbiBydW50aW1lcyBhdAogICAgICBwcmVzZW50KSBzdGF0aWMgc3RyaW5ncyBjcmVhdGVkIGFzIHBhcnQgb2YgdGhlIEpTIHNvdXJjZSBhcmUgaW50ZXJuZWQuCiAgICAgIFN0cmluZ3Mgb2Z0ZW4gdXNlZCBmb3IgY29tcGFyaXNvbnMgY2FuIGJlIGludGVybmVkIGF0IHJ1bnRpbWUgaWYgc29tZQogICAgICBjcml0ZXJpYSBhcmUgbWV0LiAgT25lIG9mIHRoZXNlIGNyaXRlcmlhIGNhbiBiZSB0aGUgc2l6ZSBvZiB0aGUgZW50aXJlIHJvcGUuCiAgICAgIEZvciBleGFtcGxlLCBpbiBjaHJvbWUgMzggYSByb3BlIGxvbmdlciB0aGVuIDEyIGNoYXJhY3RlcnMgd2lsbCBub3QKICAgICAgaW50ZXJuLCBub3Igd2lsbCBzZWdtZW50cyBvZiB0aGF0IHJvcGUuCiAgICAKICAgICAgU29tZSBudW1iZXJzOiBodHRwOi8vanNwZXJmLmNvbS9ldmFsLXZzLWtleXMvOAogICAgCiAgICAgIEtub3duIFRyaWNr4oSiCiAgICAKICAgICAgQHByaXZhdGUKICAgICAgQHJldHVybiB7U3RyaW5nfSBpbnRlcm5lZCB2ZXJzaW9uIG9mIHRoZSBwcm92aWRlZCBzdHJpbmcKICAgICovCiAgICBmdW5jdGlvbiBpbnRlcm4oc3RyKSB7CiAgICAgICAgdmFyIG9iaiA9IHt9OwogICAgICAgIG9ialtzdHJdID0gMTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChrZXkgPT09IHN0cikgewogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgfQoKICAgIC8qKgogICAgICBSZXR1cm5zIHdoZXRoZXIgVHlwZSh2YWx1ZSkgaXMgT2JqZWN0LgogICAgCiAgICAgIFVzZWZ1bCBmb3IgY2hlY2tpbmcgd2hldGhlciBhIHZhbHVlIGlzIGEgdmFsaWQgV2Vha01hcCBrZXkuCiAgICAKICAgICAgUmVmczogaHR0cHM6Ly90YzM5LmdpdGh1Yi5pby9lY21hMjYyLyNzZWMtdHlwZW9mLW9wZXJhdG9yLXJ1bnRpbWUtc2VtYW50aWNzLWV2YWx1YXRpb24KICAgICAgICAgICAgaHR0cHM6Ly90YzM5LmdpdGh1Yi5pby9lY21hMjYyLyNzZWMtd2Vha21hcC5wcm90b3R5cGUuc2V0CiAgICAKICAgICAgQHByaXZhdGUKICAgICAgQGZ1bmN0aW9uIGlzT2JqZWN0CiAgICAqLwogICAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nKTsKICAgIH0KCiAgICAvKioKICAgICBAbW9kdWxlIEBlbWJlci9vYmplY3QKICAgICovCiAgICAvKioKICAgICBQcmV2aW91c2x5IHdlIHVzZWQgYEVtYmVyLiQudXVpZGAsIGhvd2V2ZXIgYCQudXVpZGAgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tCiAgICAgalF1ZXJ5IG1hc3Rlci4gV2UnbGwganVzdCBib290c3RyYXAgb3VyIG93biB1dWlkIG5vdy4KICAgIAogICAgIEBwcml2YXRlCiAgICAgQHJldHVybiB7TnVtYmVyfSB0aGUgdXVpZAogICAgICovCiAgICB2YXIgX3V1aWQgPSAwOwogICAgLyoqCiAgICAgR2VuZXJhdGVzIGEgdW5pdmVyc2FsbHkgdW5pcXVlIGlkZW50aWZpZXIuIFRoaXMgbWV0aG9kCiAgICAgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IEVtYmVyIGZvciBhc3Npc3Rpbmcgd2l0aAogICAgIHRoZSBnZW5lcmF0aW9uIG9mIEdVSUQncyBhbmQgb3RoZXIgdW5pcXVlIGlkZW50aWZpZXJzLgogICAgCiAgICAgQHB1YmxpYwogICAgIEByZXR1cm4ge051bWJlcn0gW2Rlc2NyaXB0aW9uXQogICAgICovCiAgICBmdW5jdGlvbiB1dWlkKCkgewogICAgICAgIHJldHVybiArK191dWlkOwogICAgfQogICAgLyoqCiAgICAgUHJlZml4IHVzZWQgZm9yIGd1aWRzIHRocm91Z2ggb3V0IEVtYmVyLgogICAgIEBwcml2YXRlCiAgICAgQHByb3BlcnR5IEdVSURfUFJFRklYCiAgICAgQGZvciBFbWJlcgogICAgIEB0eXBlIFN0cmluZwogICAgIEBmaW5hbAogICAgICovCiAgICB2YXIgR1VJRF9QUkVGSVggPSAnZW1iZXInOwogICAgLy8gVXNlZCBmb3IgZ3VpZCBnZW5lcmF0aW9uLi4uCiAgICB2YXIgT0JKRUNUX0dVSURTID0gbmV3IFdlYWtNYXAoKTsKICAgIHZhciBOT05fT0JKRUNUX0dVSURTID0gbmV3IE1hcCgpOwogICAgLyoqCiAgICAgIEEgdW5pcXVlIGtleSB1c2VkIHRvIGFzc2lnbiBndWlkcyBhbmQgb3RoZXIgcHJpdmF0ZSBtZXRhZGF0YSB0byBvYmplY3RzLgogICAgICBJZiB5b3UgaW5zcGVjdCBhbiBvYmplY3QgaW4geW91ciBicm93c2VyIGRlYnVnZ2VyIHlvdSB3aWxsIG9mdGVuIHNlZSB0aGVzZS4KICAgICAgVGhleSBjYW4gYmUgc2FmZWx5IGlnbm9yZWQuCiAgICAKICAgICAgT24gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGVzZSBwcm9wZXJ0aWVzIGFyZSBhZGRlZCB3aXRoIGVudW1lcmF0aW9uCiAgICAgIGRpc2FibGVkIHNvIHRoZXkgd29uJ3Qgc2hvdyB1cCB3aGVuIHlvdSBpdGVyYXRlIG92ZXIgeW91ciBwcm9wZXJ0aWVzLgogICAgCiAgICAgIEBwcml2YXRlCiAgICAgIEBwcm9wZXJ0eSBHVUlEX0tFWQogICAgICBAZm9yIEVtYmVyCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAZmluYWwKICAgICovCiAgICB2YXIgR1VJRF9LRVkgPSBpbnRlcm4oJ19fZW1iZXInICsgK25ldyBEYXRlKCkpOwogICAgLyoqCiAgICAgIEdlbmVyYXRlcyBhIG5ldyBndWlkLCBvcHRpb25hbGx5IHNhdmluZyB0aGUgZ3VpZCB0byB0aGUgb2JqZWN0IHRoYXQgeW91CiAgICAgIHBhc3MgaW4uIFlvdSB3aWxsIHJhcmVseSBuZWVkIHRvIHVzZSB0aGlzIG1ldGhvZC4gSW5zdGVhZCB5b3Ugc2hvdWxkCiAgICAgIGNhbGwgYGd1aWRGb3Iob2JqKWAsIHdoaWNoIHJldHVybiBhbiBleGlzdGluZyBndWlkIGlmIGF2YWlsYWJsZS4KICAgIAogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIGdlbmVyYXRlR3VpZAogICAgICBAc3RhdGljCiAgICAgIEBmb3IgQGVtYmVyL29iamVjdC9pbnRlcm5hbHMKICAgICAgQHBhcmFtIHtPYmplY3R9IFtvYmpdIE9iamVjdCB0aGUgZ3VpZCB3aWxsIGJlIHVzZWQgZm9yLiBJZiBwYXNzZWQgaW4sIHRoZSBndWlkIHdpbGwKICAgICAgICBiZSBzYXZlZCBvbiB0aGUgb2JqZWN0IGFuZCByZXVzZWQgd2hlbmV2ZXIgeW91IHBhc3MgdGhlIHNhbWUgb2JqZWN0CiAgICAgICAgYWdhaW4uCiAgICAKICAgICAgICBJZiBubyBvYmplY3QgaXMgcGFzc2VkLCBqdXN0IGdlbmVyYXRlIGEgbmV3IGd1aWQuCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBbcHJlZml4XSBQcmVmaXggdG8gcGxhY2UgaW4gZnJvbnQgb2YgdGhlIGd1aWQuIFVzZWZ1bCB3aGVuIHlvdSB3YW50IHRvCiAgICAgICAgc2VwYXJhdGUgdGhlIGd1aWQgaW50byBzZXBhcmF0ZSBuYW1lc3BhY2VzLgogICAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSBndWlkCiAgICAqLwogICAgZnVuY3Rpb24gZ2VuZXJhdGVHdWlkKG9iaikgewogICAgICAgIHZhciBwcmVmaXggPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IEdVSURfUFJFRklYOwoKICAgICAgICB2YXIgZ3VpZCA9IHByZWZpeCArIHV1aWQoKTsKICAgICAgICBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgICBPQkpFQ1RfR1VJRFMuc2V0KG9iaiwgZ3VpZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBndWlkOwogICAgfQogICAgLyoqCiAgICAgIFJldHVybnMgYSB1bmlxdWUgaWQgZm9yIHRoZSBvYmplY3QuIElmIHRoZSBvYmplY3QgZG9lcyBub3QgeWV0IGhhdmUgYSBndWlkLAogICAgICBvbmUgd2lsbCBiZSBhc3NpZ25lZCB0byBpdC4gWW91IGNhbiBjYWxsIHRoaXMgb24gYW55IG9iamVjdCwKICAgICAgYEVtYmVyT2JqZWN0YC1iYXNlZCBvciBub3QuCiAgICAKICAgICAgWW91IGNhbiBhbHNvIHVzZSB0aGlzIG1ldGhvZCBvbiBET00gRWxlbWVudCBvYmplY3RzLgogICAgCiAgICAgIEBwdWJsaWMKICAgICAgQHN0YXRpYwogICAgICBAbWV0aG9kIGd1aWRGb3IKICAgICAgQGZvciBAZW1iZXIvb2JqZWN0L2ludGVybmFscwogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIGFueSBvYmplY3QsIHN0cmluZywgbnVtYmVyLCBFbGVtZW50LCBvciBwcmltaXRpdmUKICAgICAgQHJldHVybiB7U3RyaW5nfSB0aGUgdW5pcXVlIGd1aWQgZm9yIHRoaXMgaW5zdGFuY2UuCiAgICAqLwogICAgZnVuY3Rpb24gZ3VpZEZvcih2YWx1ZSkgewogICAgICAgIHZhciBndWlkID0gdm9pZCAwOwogICAgICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgICAgZ3VpZCA9IE9CSkVDVF9HVUlEUy5nZXQodmFsdWUpOwogICAgICAgICAgICBpZiAoZ3VpZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBndWlkID0gR1VJRF9QUkVGSVggKyB1dWlkKCk7CiAgICAgICAgICAgICAgICBPQkpFQ1RfR1VJRFMuc2V0KHZhbHVlLCBndWlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGd1aWQgPSBOT05fT0JKRUNUX0dVSURTLmdldCh2YWx1ZSk7CiAgICAgICAgICAgIGlmIChndWlkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpZCA9ICdzdCcgKyB1dWlkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpZCA9ICdudScgKyB1dWlkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzeW1ib2wnKSB7CiAgICAgICAgICAgICAgICAgICAgZ3VpZCA9ICdzeScgKyB1dWlkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGd1aWQgPSAnKCcgKyB2YWx1ZSArICcpJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIE5PTl9PQkpFQ1RfR1VJRFMuc2V0KHZhbHVlLCBndWlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ3VpZDsKICAgIH0KCiAgICB2YXIgR0VORVJBVEVEX1NZTUJPTFMgPSBbXTsKICAgIGZ1bmN0aW9uIGlzSW50ZXJuYWxTeW1ib2wocG9zc2libGVTeW1ib2wpIHsKICAgICAgICByZXR1cm4gR0VORVJBVEVEX1NZTUJPTFMuaW5kZXhPZihwb3NzaWJsZVN5bWJvbCkgIT09IC0xOwogICAgfQogICAgZnVuY3Rpb24gc3ltYm9sKGRlYnVnTmFtZSkgewogICAgICAgIC8vIFRPRE86IEludmVzdGlnYXRlIHVzaW5nIHBsYXRmb3JtIHN5bWJvbHMsIGJ1dCB3ZSBkbyBub3QKICAgICAgICAvLyB3YW50IHRvIHJlcXVpcmUgbm9uLWVudW1lcmFiaWxpdHkgZm9yIHRoaXMgQVBJLCB3aGljaAogICAgICAgIC8vIHdvdWxkIGludHJvZHVjZSBhIGxhcmdlIGNvc3QuCiAgICAgICAgdmFyIGlkID0gR1VJRF9LRVkgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiArbmV3IERhdGUoKSk7CiAgICAgICAgdmFyIHN5bWJvbCA9IGludGVybignX18nICsgZGVidWdOYW1lICsgaWQgKyAnX18nKTsKICAgICAgICBHRU5FUkFURURfU1lNQk9MUy5wdXNoKHN5bWJvbCk7CiAgICAgICAgcmV0dXJuIHN5bWJvbDsKICAgIH0KCiAgICAvLyB0aGUgZGVsZXRlIGlzIG1lYW50IHRvIGhpbnQgYXQgcnVudGltZXMgdGhhdCB0aGlzIG9iamVjdCBzaG91bGQgcmVtYWluIGluCiAgICAvLyBkaWN0aW9uYXJ5IG1vZGUuIFRoaXMgaXMgY2xlYXJseSBhIHJ1bnRpbWUgc3BlY2lmaWMgaGFjaywgYnV0IGN1cnJlbnRseSBpdAogICAgLy8gYXBwZWFycyB3b3J0aHdoaWxlIGluIHNvbWUgdXNlY2FzZXMuIFBsZWFzZSBub3RlLCB0aGVzZSBkZWxldGVzIGRvIGluY3JlYXNlCiAgICAvLyB0aGUgY29zdCBvZiBjcmVhdGlvbiBkcmFtYXRpY2FsbHkgb3ZlciBhIHBsYWluIE9iamVjdC5jcmVhdGUuIEFuZCBhcyB0aGlzCiAgICAvLyBvbmx5IG1ha2VzIHNlbnNlIGZvciBsb25nLWxpdmVkIGRpY3Rpb25hcmllcyB0aGF0IGFyZW4ndCBpbnN0YW50aWF0ZWQgb2Z0ZW4uCiAgICBmdW5jdGlvbiBtYWtlRGljdGlvbmFyeShwYXJlbnQpIHsKICAgICAgICB2YXIgZGljdCA9IE9iamVjdC5jcmVhdGUocGFyZW50KTsKICAgICAgICBkaWN0WydfZGljdCddID0gbnVsbDsKICAgICAgICBkZWxldGUgZGljdFsnX2RpY3QnXTsKICAgICAgICByZXR1cm4gZGljdDsKICAgIH0KCiAgICAvKiBnbG9iYWxzIFdlYWtTZXQgKi8KICAgIHZhciBXZWFrU2V0JDEgPSB0eXBlb2YgV2Vha1NldCA9PT0gJ2Z1bmN0aW9uJyA/IFdlYWtTZXQgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gV2Vha1NldFBvbHlGaWxsKCkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFdlYWtTZXRQb2x5RmlsbCk7CgogICAgICAgICAgICB0aGlzLl9tYXAgPSBuZXcgV2Vha01hcCgpOwogICAgICAgIH0KCiAgICAgICAgV2Vha1NldFBvbHlGaWxsLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQodmFsKSB7CiAgICAgICAgICAgIHRoaXMuX21hcC5zZXQodmFsLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgV2Vha1NldFBvbHlGaWxsLnByb3RvdHlwZS5kZWxldGUgPSBmdW5jdGlvbiBfZGVsZXRlKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWFwLmRlbGV0ZSh2YWwpOwogICAgICAgIH07CgogICAgICAgIFdlYWtTZXRQb2x5RmlsbC5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWFwLmhhcyh2YWwpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBXZWFrU2V0UG9seUZpbGw7CiAgICB9KCk7CgogICAgdmFyIEhBU19TVVBFUl9QQVRURVJOID0gL1wuKF9zdXBlcnxjYWxsXCh0aGlzfGFwcGx5XCh0aGlzKS87CiAgICB2YXIgZm5Ub1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZzsKICAgIHZhciBjaGVja0hhc1N1cGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzb3VyY2VBdmFpbGFibGUgPSBmblRvU3RyaW5nLmNhbGwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9KS5pbmRleE9mKCdyZXR1cm4gdGhpcycpID4gLTE7CiAgICAgICAgaWYgKHNvdXJjZUF2YWlsYWJsZSkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gY2hlY2tIYXNTdXBlcihmdW5jKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSEFTX1NVUEVSX1BBVFRFUk4udGVzdChmblRvU3RyaW5nLmNhbGwoZnVuYykpOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuY3Rpb24gY2hlY2tIYXNTdXBlcigpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBIQVNfU1VQRVJfTUFQID0gbmV3IFdlYWtNYXAoKTsKICAgIHZhciBST09UID0gT2JqZWN0LmZyZWV6ZShmdW5jdGlvbiAoKSB7fSk7CiAgICBIQVNfU1VQRVJfTUFQLnNldChST09ULCBmYWxzZSk7CiAgICBmdW5jdGlvbiBoYXNTdXBlcihmdW5jKSB7CiAgICAgICAgdmFyIGhhc1N1cGVyID0gSEFTX1NVUEVSX01BUC5nZXQoZnVuYyk7CiAgICAgICAgaWYgKGhhc1N1cGVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaGFzU3VwZXIgPSBjaGVja0hhc1N1cGVyKGZ1bmMpOwogICAgICAgICAgICBIQVNfU1VQRVJfTUFQLnNldChmdW5jLCBoYXNTdXBlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoYXNTdXBlcjsKICAgIH0KICAgIHZhciBPQlNFUlZFUlNfTUFQID0gbmV3IFdlYWtNYXAoKTsKICAgIGZ1bmN0aW9uIHNldE9ic2VydmVycyhmdW5jLCBvYnNlcnZlcnMpIHsKICAgICAgICBpZiAob2JzZXJ2ZXJzKSB7CiAgICAgICAgICAgIE9CU0VSVkVSU19NQVAuc2V0KGZ1bmMsIG9ic2VydmVycyk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0T2JzZXJ2ZXJzKGZ1bmMpIHsKICAgICAgICByZXR1cm4gT0JTRVJWRVJTX01BUC5nZXQoZnVuYyk7CiAgICB9CiAgICB2YXIgTElTVEVORVJTX01BUCA9IG5ldyBXZWFrTWFwKCk7CiAgICBmdW5jdGlvbiBzZXRMaXN0ZW5lcnMoZnVuYywgbGlzdGVuZXJzKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycykgewogICAgICAgICAgICBMSVNURU5FUlNfTUFQLnNldChmdW5jLCBsaXN0ZW5lcnMpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGdldExpc3RlbmVycyhmdW5jKSB7CiAgICAgICAgcmV0dXJuIExJU1RFTkVSU19NQVAuZ2V0KGZ1bmMpOwogICAgfQogICAgdmFyIElTX1dSQVBQRURfRlVOQ1RJT05fU0VUID0gbmV3IFdlYWtTZXQkMSgpOwogICAgLyoqCiAgICAgIFdyYXBzIHRoZSBwYXNzZWQgZnVuY3Rpb24gc28gdGhhdCBgdGhpcy5fc3VwZXJgIHdpbGwgcG9pbnQgdG8gdGhlIHN1cGVyRnVuYwogICAgICB3aGVuIHRoZSBmdW5jdGlvbiBpcyBpbnZva2VkLiBUaGlzIGlzIHRoZSBwcmltaXRpdmUgd2UgdXNlIHRvIGltcGxlbWVudAogICAgICBjYWxscyB0byBzdXBlci4KICAgIAogICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHdyYXAKICAgICAgQGZvciBFbWJlcgogICAgICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjYWxsCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IHN1cGVyRnVuYyBUaGUgc3VwZXIgZnVuY3Rpb24uCiAgICAgIEByZXR1cm4ge0Z1bmN0aW9ufSB3cmFwcGVkIGZ1bmN0aW9uLgogICAgKi8KICAgIGZ1bmN0aW9uIHdyYXAoZnVuYywgc3VwZXJGdW5jKSB7CiAgICAgICAgaWYgKCFoYXNTdXBlcihmdW5jKSkgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICB9CiAgICAgICAgLy8gZW5zdXJlIGFuIHVud3JhcHBlZCBzdXBlciB0aGF0IGNhbGxzIF9zdXBlciBpcyB3cmFwcGVkIHdpdGggYSB0ZXJtaW5hbCBfc3VwZXIKICAgICAgICBpZiAoIUlTX1dSQVBQRURfRlVOQ1RJT05fU0VULmhhcyhzdXBlckZ1bmMpICYmIGhhc1N1cGVyKHN1cGVyRnVuYykpIHsKICAgICAgICAgICAgcmV0dXJuIF93cmFwKGZ1bmMsIF93cmFwKHN1cGVyRnVuYywgUk9PVCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gX3dyYXAoZnVuYywgc3VwZXJGdW5jKTsKICAgIH0KICAgIGZ1bmN0aW9uIF93cmFwKGZ1bmMsIHN1cGVyRnVuYykgewogICAgICAgIGZ1bmN0aW9uIHN1cGVyV3JhcHBlcigpIHsKICAgICAgICAgICAgdmFyIG9yaWcgPSB0aGlzLl9zdXBlcjsKICAgICAgICAgICAgdGhpcy5fc3VwZXIgPSBzdXBlckZ1bmM7CiAgICAgICAgICAgIHZhciByZXQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHRoaXMuX3N1cGVyID0gb3JpZzsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgSVNfV1JBUFBFRF9GVU5DVElPTl9TRVQuYWRkKHN1cGVyV3JhcHBlcik7CiAgICAgICAgc2V0T2JzZXJ2ZXJzKHN1cGVyV3JhcHBlciwgZ2V0T2JzZXJ2ZXJzKGZ1bmMpKTsKICAgICAgICBzZXRMaXN0ZW5lcnMoc3VwZXJXcmFwcGVyLCBnZXRMaXN0ZW5lcnMoZnVuYykpOwogICAgICAgIHJldHVybiBzdXBlcldyYXBwZXI7CiAgICB9CgogICAgdmFyIG9iamVjdFRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgIHZhciBmdW5jdGlvblRvU3RyaW5nID0gRnVuY3Rpb24ucHJvdG90eXBlLnRvU3RyaW5nOwogICAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwogICAgdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5czsKICAgIHZhciBzdHJpbmdpZnkgPSBKU09OLnN0cmluZ2lmeTsKCiAgICB2YXIgTElTVF9MSU1JVCA9IDEwMDsKICAgIHZhciBERVBUSF9MSU1JVCA9IDQ7CiAgICB2YXIgU0FGRV9LRVkgPSAvXltcdyRdKyQvOwogICAgLyoqCiAgICAgQG1vZHVsZSBAZW1iZXIvZGVidWcKICAgICovCiAgICAvKioKICAgICAgQ29udmVuaWVuY2UgbWV0aG9kIHRvIGluc3BlY3QgYW4gb2JqZWN0LiBUaGlzIG1ldGhvZCB3aWxsIGF0dGVtcHQgdG8KICAgICAgY29udmVydCB0aGUgb2JqZWN0IGludG8gYSB1c2VmdWwgc3RyaW5nIGRlc2NyaXB0aW9uLgogICAgCiAgICAgIEl0IGlzIGEgcHJldHR5IHNpbXBsZSBpbXBsZW1lbnRhdGlvbi4gSWYgeW91IHdhbnQgc29tZXRoaW5nIG1vcmUgcm9idXN0LAogICAgICB1c2Ugc29tZXRoaW5nIGxpa2UgSlNEdW1wOiBodHRwczovL2dpdGh1Yi5jb20vTlYvanNEdW1wCiAgICAKICAgICAgQG1ldGhvZCBpbnNwZWN0CiAgICAgIEBzdGF0aWMKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHlvdSB3YW50IHRvIGluc3BlY3QuCiAgICAgIEByZXR1cm4ge1N0cmluZ30gQSBkZXNjcmlwdGlvbiBvZiB0aGUgb2JqZWN0CiAgICAgIEBzaW5jZSAxLjQuMAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGluc3BlY3Qob2JqKSB7CiAgICAgICAgLy8gZGV0ZWN0IE5vZGUgdXRpbC5pbnNwZWN0IGNhbGwgaW5zcGVjdChkZXB0aDogbnVtYmVyLCBvcHRzOiBvYmplY3QpCiAgICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICdudW1iZXInICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnNwZWN0VmFsdWUob2JqLCAwKTsKICAgIH0KICAgIGZ1bmN0aW9uIGluc3BlY3RWYWx1ZSh2YWx1ZSwgZGVwdGgsIHNlZW4pIHsKICAgICAgICB2YXIgdmFsdWVJc0FycmF5ID0gZmFsc2U7CiAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAndW5kZWZpbmVkJzoKICAgICAgICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICAgICAgY2FzZSAnb2JqZWN0JzoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuICdudWxsJzsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbHVlSXNBcnJheSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBpcyB0b1N0cmluZyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nIG9yIHVuZGVmaW5lZCB0aGVuIHRyYXZlcnNlCiAgICAgICAgICAgICAgICBpZiAodmFsdWUudG9TdHJpbmcgPT09IG9iamVjdFRvU3RyaW5nIHx8IHZhbHVlLnRvU3RyaW5nID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGN1c3RvbSB0b1N0cmluZwogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZyA9PT0gZnVuY3Rpb25Ub1N0cmluZyA/IHZhbHVlLm5hbWUgPyAnW0Z1bmN0aW9uOicgKyB2YWx1ZS5uYW1lICsgJ10nIDogJ1tGdW5jdGlvbl0nIDogdmFsdWUudG9TdHJpbmcoKTsKICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdpZnkodmFsdWUpOwogICAgICAgICAgICBjYXNlICdzeW1ib2wnOgogICAgICAgICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgICBpZiAoc2VlbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHNlZW4gPSBuZXcgV2Vha1NldCQxKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNlZW4uaGFzKHZhbHVlKSkgcmV0dXJuICdbQ2lyY3VsYXJdJzsKICAgICAgICB9CiAgICAgICAgc2Vlbi5hZGQodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZUlzQXJyYXkgPyBpbnNwZWN0QXJyYXkodmFsdWUsIGRlcHRoICsgMSwgc2VlbikgOiBpbnNwZWN0T2JqZWN0KHZhbHVlLCBkZXB0aCArIDEsIHNlZW4pOwogICAgfQogICAgZnVuY3Rpb24gaW5zcGVjdEtleShrZXkpIHsKICAgICAgICByZXR1cm4gU0FGRV9LRVkudGVzdChrZXkpID8ga2V5IDogc3RyaW5naWZ5KGtleSk7CiAgICB9CiAgICBmdW5jdGlvbiBpbnNwZWN0T2JqZWN0KG9iaiwgZGVwdGgsIHNlZW4pIHsKICAgICAgICBpZiAoZGVwdGggPiBERVBUSF9MSU1JVCkgewogICAgICAgICAgICByZXR1cm4gJ1tPYmplY3RdJzsKICAgICAgICB9CiAgICAgICAgdmFyIHMgPSAneyc7CiAgICAgICAgdmFyIGtleXMgPSBvYmplY3RLZXlzKG9iaik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHMgKz0gaSA9PT0gMCA/ICcgJyA6ICcsICc7CiAgICAgICAgICAgIGlmIChpID49IExJU1RfTElNSVQpIHsKICAgICAgICAgICAgICAgIHMgKz0gJy4uLiAnICsgKGtleXMubGVuZ3RoIC0gTElTVF9MSU1JVCkgKyAnIG1vcmUga2V5cyc7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgcyArPSBpbnNwZWN0S2V5KGtleSkgKyAnOiAnICsgaW5zcGVjdFZhbHVlKG9ialtrZXldLCBkZXB0aCwgc2Vlbik7CiAgICAgICAgfQogICAgICAgIHMgKz0gJyB9JzsKICAgICAgICByZXR1cm4gczsKICAgIH0KICAgIGZ1bmN0aW9uIGluc3BlY3RBcnJheShhcnIsIGRlcHRoLCBzZWVuKSB7CiAgICAgICAgaWYgKGRlcHRoID4gREVQVEhfTElNSVQpIHsKICAgICAgICAgICAgcmV0dXJuICdbQXJyYXldJzsKICAgICAgICB9CiAgICAgICAgdmFyIHMgPSAnWyc7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcyArPSBpID09PSAwID8gJyAnIDogJywgJzsKICAgICAgICAgICAgaWYgKGkgPj0gTElTVF9MSU1JVCkgewogICAgICAgICAgICAgICAgcyArPSAnLi4uICcgKyAoYXJyLmxlbmd0aCAtIExJU1RfTElNSVQpICsgJyBtb3JlIGl0ZW1zJzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHMgKz0gaW5zcGVjdFZhbHVlKGFycltpXSwgZGVwdGgsIHNlZW4pOwogICAgICAgIH0KICAgICAgICBzICs9ICcgXSc7CiAgICAgICAgcmV0dXJuIHM7CiAgICB9CgogICAgZnVuY3Rpb24gbG9va3VwRGVzY3JpcHRvcihvYmosIGtleU5hbWUpIHsKICAgICAgICB2YXIgY3VycmVudCA9IG9iajsKICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjdXJyZW50LCBrZXlOYW1lKTsKICAgICAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihjdXJyZW50KTsKICAgICAgICB9IHdoaWxlIChjdXJyZW50ICE9PSBudWxsKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAgQ2hlY2tzIHRvIHNlZSBpZiB0aGUgYG1ldGhvZE5hbWVgIGV4aXN0cyBvbiB0aGUgYG9iamAuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBsZXQgZm9vID0geyBiYXI6IGZ1bmN0aW9uKCkgeyByZXR1cm4gJ2Jhcic7IH0sIGJhejogbnVsbCB9OwogICAgCiAgICAgIEVtYmVyLmNhbkludm9rZShmb28sICdiYXInKTsgLy8gdHJ1ZQogICAgICBFbWJlci5jYW5JbnZva2UoZm9vLCAnYmF6Jyk7IC8vIGZhbHNlCiAgICAgIEVtYmVyLmNhbkludm9rZShmb28sICdiYXQnKTsgLy8gZmFsc2UKICAgICAgYGBgCiAgICAKICAgICAgQG1ldGhvZCBjYW5JbnZva2UKICAgICAgQGZvciBFbWJlcgogICAgICBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHRoZSBtZXRob2QKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG1ldGhvZCBuYW1lIHRvIGNoZWNrIGZvcgogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGNhbkludm9rZShvYmosIG1ldGhvZE5hbWUpIHsKICAgICAgICByZXR1cm4gb2JqICE9PSBudWxsICYmIG9iaiAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvYmpbbWV0aG9kTmFtZV0gPT09ICdmdW5jdGlvbic7CiAgICB9CiAgICAvKioKICAgICAgQG1vZHVsZSBAZW1iZXIvdXRpbHMKICAgICovCiAgICAvKioKICAgICAgQ2hlY2tzIHRvIHNlZSBpZiB0aGUgYG1ldGhvZE5hbWVgIGV4aXN0cyBvbiB0aGUgYG9iamAsCiAgICAgIGFuZCBpZiBpdCBkb2VzLCBpbnZva2VzIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBwYXNzZWQuCiAgICAKICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgeyB0cnlJbnZva2UgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgCiAgICAgIGxldCBkID0gbmV3IERhdGUoJzAzLzE1LzIwMTMnKTsKICAgIAogICAgICB0cnlJbnZva2UoZCwgJ2dldFRpbWUnKTsgICAgICAgICAgICAgIC8vIDEzNjMzMjAwMDAwMDAKICAgICAgdHJ5SW52b2tlKGQsICdzZXRGdWxsWWVhcicsIFsyMDE0XSk7ICAvLyAxMzk0ODU2MDAwMDAwCiAgICAgIHRyeUludm9rZShkLCAnbm9TdWNoTWV0aG9kJywgWzIwMTRdKTsgLy8gdW5kZWZpbmVkCiAgICAgIGBgYAogICAgCiAgICAgIEBtZXRob2QgdHJ5SW52b2tlCiAgICAgIEBmb3IgQGVtYmVyL3V0aWxzCiAgICAgIEBzdGF0aWMKICAgICAgQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIGNoZWNrIGZvciB0aGUgbWV0aG9kCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2ROYW1lIFRoZSBtZXRob2QgbmFtZSB0byBjaGVjayBmb3IKICAgICAgQHBhcmFtIHtBcnJheX0gW2FyZ3NdIFRoZSBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgbWV0aG9kCiAgICAgIEByZXR1cm4geyp9IHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGludm9rZWQgbWV0aG9kIG9yIHVuZGVmaW5lZCBpZiBpdCBjYW5ub3QgYmUgaW52b2tlZAogICAgICBAcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gdHJ5SW52b2tlKG9iaiwgbWV0aG9kTmFtZSwgYXJncykgewogICAgICAgIGlmIChjYW5JbnZva2Uob2JqLCBtZXRob2ROYW1lKSkgewogICAgICAgICAgICB2YXIgbWV0aG9kID0gb2JqW21ldGhvZE5hbWVdOwogICAgICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KG9iaiwgYXJncyk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBpc0FycmF5JDEgPSBBcnJheS5pc0FycmF5OwoKICAgIGZ1bmN0aW9uIG1ha2VBcnJheShvYmopIHsKICAgICAgICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzQXJyYXkkMShvYmopID8gb2JqIDogW29ial07CiAgICB9CgogICAgdmFyIE5BTUVTID0gbmV3IFdlYWtNYXAoKTsKICAgIGZ1bmN0aW9uIHNldE5hbWUob2JqLCBuYW1lKSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KG9iaikpIE5BTUVTLnNldChvYmosIG5hbWUpOwogICAgfQogICAgZnVuY3Rpb24gZ2V0TmFtZShvYmopIHsKICAgICAgICByZXR1cm4gTkFNRVMuZ2V0KG9iaik7CiAgICB9CgogICAgdmFyIG9iamVjdFRvU3RyaW5nJDEgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogICAgZnVuY3Rpb24gaXNOb25lKG9iaikgewogICAgICAgIHJldHVybiBvYmogPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQ7CiAgICB9CiAgICAvKgogICAgIEEgYHRvU3RyaW5nYCB1dGlsIGZ1bmN0aW9uIHRoYXQgc3VwcG9ydHMgb2JqZWN0cyB3aXRob3V0IGEgYHRvU3RyaW5nYAogICAgIG1ldGhvZCwgZS5nLiBhbiBvYmplY3QgY3JlYXRlZCB3aXRoIGBPYmplY3QuY3JlYXRlKG51bGwpYC4KICAgICovCiAgICBmdW5jdGlvbiB0b1N0cmluZyhvYmopIHsKICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9CiAgICAgICAgaWYgKG51bGwgPT09IG9iaikgcmV0dXJuICdudWxsJzsKICAgICAgICBpZiAodW5kZWZpbmVkID09PSBvYmopIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7CiAgICAgICAgICAgIC8vIFJlaW1wbGVtZW50IEFycmF5LnByb3RvdHlwZS5qb2luIGFjY29yZGluZyB0byBzcGVjICgyMi4xLjMuMTMpCiAgICAgICAgICAgIC8vIENoYW5naW5nIFRvU3RyaW5nKGVsZW1lbnQpIHdpdGggdGhpcyBzYWZlIHZlcnNpb24gb2YgVG9TdHJpbmcuCiAgICAgICAgICAgIHZhciByID0gJyc7CiAgICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgb2JqLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICBpZiAoayA+IDApIHsKICAgICAgICAgICAgICAgICAgICByICs9ICcsJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghaXNOb25lKG9ialtrXSkpIHsKICAgICAgICAgICAgICAgICAgICByICs9IHRvU3RyaW5nKG9ialtrXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb2JqLnRvU3RyaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJldHVybiBvYmoudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdFRvU3RyaW5nJDEuY2FsbChvYmopOwogICAgfQoKICAgIHZhciBIQVNfTkFUSVZFX1NZTUJPTCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIC8vIHVzZSBgT2JqZWN0YCdzIGAudG9TdHJpbmdgIGRpcmVjdGx5IHRvIHByZXZlbnQgdXMgZnJvbSBkZXRlY3RpbmcKICAgICAgICAvLyBwb2x5ZmlsbHMgYXMgbmF0aXZlCiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChTeW1ib2woKSkgPT09ICdbb2JqZWN0IFN5bWJvbF0nOwogICAgfSgpOwoKICAgIHZhciBIQVNfTkFUSVZFX1BST1hZID0gdHlwZW9mIFByb3h5ID09PSAnZnVuY3Rpb24nOwoKICAgIHZhciBQUk9YSUVTID0gbmV3IFdlYWtTZXQkMSgpOwogICAgZnVuY3Rpb24gaXNQcm94eShvYmplY3QpIHsKICAgICAgICBpZiAoaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgICAgICByZXR1cm4gUFJPWElFUy5oYXMob2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gc2V0UHJveHkob2JqZWN0KSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICAgICAgUFJPWElFUy5hZGQob2JqZWN0KTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIENhY2hlID0gZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIENhY2hlKGxpbWl0LCBmdW5jLCBzdG9yZSkgewogICAgICAgICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIENhY2hlKTsKCiAgICAgICAgICAgIHRoaXMubGltaXQgPSBsaW1pdDsKICAgICAgICAgICAgdGhpcy5mdW5jID0gZnVuYzsKICAgICAgICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgICAgICB0aGlzLm1pc3NlcyA9IDA7CiAgICAgICAgICAgIHRoaXMuaGl0cyA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZSB8fCBuZXcgTWFwKCk7CiAgICAgICAgfQoKICAgICAgICBDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLnN0b3JlLmdldChrZXkpOwogICAgICAgICAgICBpZiAodGhpcy5zdG9yZS5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgdGhpcy5oaXRzKys7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXQoa2V5KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMubWlzc2VzKys7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMuc2V0KGtleSwgdGhpcy5mdW5jKGtleSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9OwoKICAgICAgICBDYWNoZS5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMubGltaXQgPiB0aGlzLnNpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2l6ZSsrOwogICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH07CgogICAgICAgIENhY2hlLnByb3RvdHlwZS5wdXJnZSA9IGZ1bmN0aW9uIHB1cmdlKCkgewogICAgICAgICAgICB0aGlzLnN0b3JlLmNsZWFyKCk7CiAgICAgICAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaGl0cyA9IDA7CiAgICAgICAgICAgIHRoaXMubWlzc2VzID0gMDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ2FjaGU7CiAgICB9KCk7CgogICAgLyoKICAgICBUaGlzIHBhY2thZ2Ugd2lsbCBiZSBlYWdlcmx5IHBhcnNlZCBhbmQgc2hvdWxkIGhhdmUgbm8gZGVwZW5kZW5jaWVzIG9uIGV4dGVybmFsCiAgICAgcGFja2FnZXMuCiAgICAKICAgICBJdCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIHRvIHNoYXJlIHV0aWxpdHkgbWV0aG9kcyB0aGF0IHdpbGwgYmUgbmVlZGVkCiAgICAgYnkgZXZlcnkgRW1iZXIgYXBwbGljYXRpb24gKGFuZCBpcyAqKm5vdCoqIGEgZHVtcGluZyBncm91bmQgb2YgdXNlZnVsIHV0aWxpdGllcykuCiAgICAKICAgICBVdGlsaXR5IG1ldGhvZHMgdGhhdCBhcmUgbmVlZGVkIGluIDwgODAlIG9mIGNhc2VzIHNob3VsZCBiZSBwbGFjZWQKICAgICBlbHNld2hlcmUgKHNvIHRoZXkgY2FuIGJlIGxhemlseSBldmFsdWF0ZWQgLyBwYXJzZWQpLgogICAgKi8KICAgIHZhciBOQU1FX0tFWSA9IHN5bWJvbCgnTkFNRV9LRVknKTsKCiAgICBleHBvcnRzLk5BTUVfS0VZID0gTkFNRV9LRVk7CiAgICBleHBvcnRzLnN5bWJvbCA9IHN5bWJvbDsKICAgIGV4cG9ydHMuaXNJbnRlcm5hbFN5bWJvbCA9IGlzSW50ZXJuYWxTeW1ib2w7CiAgICBleHBvcnRzLmRpY3Rpb25hcnkgPSBtYWtlRGljdGlvbmFyeTsKICAgIGV4cG9ydHMudXVpZCA9IHV1aWQ7CiAgICBleHBvcnRzLkdVSURfS0VZID0gR1VJRF9LRVk7CiAgICBleHBvcnRzLmdlbmVyYXRlR3VpZCA9IGdlbmVyYXRlR3VpZDsKICAgIGV4cG9ydHMuZ3VpZEZvciA9IGd1aWRGb3I7CiAgICBleHBvcnRzLmludGVybiA9IGludGVybjsKICAgIGV4cG9ydHMuY2hlY2tIYXNTdXBlciA9IGNoZWNrSGFzU3VwZXI7CiAgICBleHBvcnRzLlJPT1QgPSBST09UOwogICAgZXhwb3J0cy53cmFwID0gd3JhcDsKICAgIGV4cG9ydHMuZ2V0T2JzZXJ2ZXJzID0gZ2V0T2JzZXJ2ZXJzOwogICAgZXhwb3J0cy5nZXRMaXN0ZW5lcnMgPSBnZXRMaXN0ZW5lcnM7CiAgICBleHBvcnRzLnNldE9ic2VydmVycyA9IHNldE9ic2VydmVyczsKICAgIGV4cG9ydHMuc2V0TGlzdGVuZXJzID0gc2V0TGlzdGVuZXJzOwogICAgZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKICAgIGV4cG9ydHMubG9va3VwRGVzY3JpcHRvciA9IGxvb2t1cERlc2NyaXB0b3I7CiAgICBleHBvcnRzLmNhbkludm9rZSA9IGNhbkludm9rZTsKICAgIGV4cG9ydHMudHJ5SW52b2tlID0gdHJ5SW52b2tlOwogICAgZXhwb3J0cy5tYWtlQXJyYXkgPSBtYWtlQXJyYXk7CiAgICBleHBvcnRzLmdldE5hbWUgPSBnZXROYW1lOwogICAgZXhwb3J0cy5zZXROYW1lID0gc2V0TmFtZTsKICAgIGV4cG9ydHMudG9TdHJpbmcgPSB0b1N0cmluZzsKICAgIGV4cG9ydHMuSEFTX05BVElWRV9TWU1CT0wgPSBIQVNfTkFUSVZFX1NZTUJPTDsKICAgIGV4cG9ydHMuSEFTX05BVElWRV9QUk9YWSA9IEhBU19OQVRJVkVfUFJPWFk7CiAgICBleHBvcnRzLldlYWtTZXQgPSBXZWFrU2V0JDE7CiAgICBleHBvcnRzLmlzUHJveHkgPSBpc1Byb3h5OwogICAgZXhwb3J0cy5zZXRQcm94eSA9IHNldFByb3h5OwogICAgZXhwb3J0cy5DYWNoZSA9IENhY2hlOwp9KTsKZW5pZmVkKCdlbWJlci12aWV3cy9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci12aWV3cy9saWIvc3lzdGVtL2pxdWVyeScsICdlbWJlci12aWV3cy9saWIvc3lzdGVtL3V0aWxzJywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vZXZlbnRfZGlzcGF0Y2hlcicsICdlbWJlci12aWV3cy9saWIvY29tcG9uZW50X2xvb2t1cCcsICdlbWJlci12aWV3cy9saWIvbWl4aW5zL3RleHRfc3VwcG9ydCcsICdlbWJlci12aWV3cy9saWIvdmlld3MvY29yZV92aWV3JywgJ2VtYmVyLXZpZXdzL2xpYi9taXhpbnMvY2xhc3NfbmFtZXNfc3VwcG9ydCcsICdlbWJlci12aWV3cy9saWIvbWl4aW5zL2NoaWxkX3ZpZXdzX3N1cHBvcnQnLCAnZW1iZXItdmlld3MvbGliL21peGlucy92aWV3X3N0YXRlX3N1cHBvcnQnLCAnZW1iZXItdmlld3MvbGliL21peGlucy92aWV3X3N1cHBvcnQnLCAnZW1iZXItdmlld3MvbGliL21peGlucy9hY3Rpb25fc3VwcG9ydCcsICdlbWJlci12aWV3cy9saWIvY29tcGF0L2F0dHJzJywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vbG9va3VwX3BhcnRpYWwnLCAnZW1iZXItdmlld3MvbGliL3V0aWxzL2xvb2t1cC1jb21wb25lbnQnLCAnZW1iZXItdmlld3MvbGliL3N5c3RlbS9hY3Rpb25fbWFuYWdlcicsICdlbWJlci12aWV3cy9saWIvY29tcGF0L2ZhbGxiYWNrLXZpZXctcmVnaXN0cnknXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9qcXVlcnksIF91dGlscywgX2V2ZW50X2Rpc3BhdGNoZXIsIF9jb21wb25lbnRfbG9va3VwLCBfdGV4dF9zdXBwb3J0LCBfY29yZV92aWV3LCBfY2xhc3NfbmFtZXNfc3VwcG9ydCwgX2NoaWxkX3ZpZXdzX3N1cHBvcnQsIF92aWV3X3N0YXRlX3N1cHBvcnQsIF92aWV3X3N1cHBvcnQsIF9hY3Rpb25fc3VwcG9ydCwgX2F0dHJzLCBfbG9va3VwX3BhcnRpYWwsIF9sb29rdXBDb21wb25lbnQsIF9hY3Rpb25fbWFuYWdlciwgX2ZhbGxiYWNrVmlld1JlZ2lzdHJ5KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2pRdWVyeScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9qcXVlcnkuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2pRdWVyeURpc2FibGVkJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2pxdWVyeS5qUXVlcnlEaXNhYmxlZDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2FkZENoaWxkVmlldycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF91dGlscy5hZGRDaGlsZFZpZXc7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdpc1NpbXBsZUNsaWNrJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3V0aWxzLmlzU2ltcGxlQ2xpY2s7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdnZXRWaWV3Qm91bmRzJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3V0aWxzLmdldFZpZXdCb3VuZHM7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdnZXRWaWV3Q2xpZW50UmVjdHMnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuZ2V0Vmlld0NsaWVudFJlY3RzOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZ2V0Vmlld0JvdW5kaW5nQ2xpZW50UmVjdCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZ2V0Um9vdFZpZXdzJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3V0aWxzLmdldFJvb3RWaWV3czsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2dldENoaWxkVmlld3MnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuZ2V0Q2hpbGRWaWV3czsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2dldFZpZXdJZCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3SWQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdnZXRWaWV3RWxlbWVudCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF91dGlscy5nZXRWaWV3RWxlbWVudDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ3NldFZpZXdFbGVtZW50JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3V0aWxzLnNldFZpZXdFbGVtZW50OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2UnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfdXRpbHMuY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2U7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdFdmVudERpc3BhdGNoZXInLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfZXZlbnRfZGlzcGF0Y2hlci5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQ29tcG9uZW50TG9va3VwJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NvbXBvbmVudF9sb29rdXAuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ1RleHRTdXBwb3J0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3RleHRfc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQ29yZVZpZXcnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY29yZV92aWV3LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdDbGFzc05hbWVzU3VwcG9ydCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jbGFzc19uYW1lc19zdXBwb3J0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdDaGlsZFZpZXdzU3VwcG9ydCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9jaGlsZF92aWV3c19zdXBwb3J0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdWaWV3U3RhdGVTdXBwb3J0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3ZpZXdfc3RhdGVfc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnVmlld01peGluJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3ZpZXdfc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQWN0aW9uU3VwcG9ydCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9hY3Rpb25fc3VwcG9ydC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnTVVUQUJMRV9DRUxMJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2F0dHJzLk1VVEFCTEVfQ0VMTDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2xvb2t1cFBhcnRpYWwnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbG9va3VwX3BhcnRpYWwuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2hhc1BhcnRpYWwnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfbG9va3VwX3BhcnRpYWwuaGFzUGFydGlhbDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2xvb2t1cENvbXBvbmVudCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9sb29rdXBDb21wb25lbnQuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ0FjdGlvbk1hbmFnZXInLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfYWN0aW9uX21hbmFnZXIuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2ZhbGxiYWNrVmlld1JlZ2lzdHJ5JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2ZhbGxiYWNrVmlld1JlZ2lzdHJ5LmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9jb21wYXQvYXR0cnMnLCBbJ2V4cG9ydHMnLCAnZW1iZXItdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlclV0aWxzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLk1VVEFCTEVfQ0VMTCA9IHVuZGVmaW5lZDsKICB2YXIgTVVUQUJMRV9DRUxMID0gZXhwb3J0cy5NVVRBQkxFX0NFTEwgPSAoMCwgX2VtYmVyVXRpbHMuc3ltYm9sKSgnTVVUQUJMRV9DRUxMJyk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9jb21wYXQvZmFsbGJhY2stdmlldy1yZWdpc3RyeScsIFsnZXhwb3J0cycsICdlbWJlci11dGlscyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyVXRpbHMpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9ICgwLCBfZW1iZXJVdGlscy5kaWN0aW9uYXJ5KShudWxsKTsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL2NvbXBvbmVudF9sb29rdXAnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ0BlbWJlci9zdHJpbmcnLCAnZW1iZXItcnVudGltZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnLCBfc3RyaW5nLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoewogICAgY29tcG9uZW50Rm9yOiBmdW5jdGlvbiAoX25hbWUsIG93bmVyLCBvcHRpb25zKSB7CiAgICAgICh0cnVlICYmICEoX25hbWUuaW5kZXhPZignLScpID4gLTEgfHwgZmFsc2UgLyogRU1CRVJfR0xJTU1FUl9BTkdMRV9CUkFDS0VUX0lOVk9DQVRJT04gKi8gJiYgX25hbWUuY2hhckF0KDApID09PSBfbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSBcJycgKyBfbmFtZSArICdcJyBhcyBhIGNvbXBvbmVudCBuYW1lLiBDb21wb25lbnQgbmFtZXMgbXVzdCBjb250YWluIGEgaHlwaGVuJyArIChmYWxzZSAvKiBFTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTiAqLyA/ICcgb3Igc3RhcnQgd2l0aCBhIGNhcGl0YWwgbGV0dGVyJyA6ICcnKSArICcuJywgX25hbWUuaW5kZXhPZignLScpID4gLTEgfHwgZmFsc2UgJiYgX25hbWUuY2hhckF0KDApID09PSBfbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSkpOwoKICAgICAgdmFyIG5hbWUgPSBmYWxzZSAvKiBFTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTiAqLyAmJiBfbmFtZS5jaGFyQXQoMCkgPT09IF9uYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpID8gKDAsIF9zdHJpbmcuZGFzaGVyaXplKShfbmFtZSkgOiBfbmFtZTsKICAgICAgdmFyIGZ1bGxOYW1lID0gJ2NvbXBvbmVudDonICsgbmFtZTsKICAgICAgcmV0dXJuIG93bmVyLmZhY3RvcnlGb3IoZnVsbE5hbWUsIG9wdGlvbnMpOwogICAgfSwKICAgIGxheW91dEZvcjogZnVuY3Rpb24gKF9uYW1lLCBvd25lciwgb3B0aW9ucykgewogICAgICAodHJ1ZSAmJiAhKF9uYW1lLmluZGV4T2YoJy0nKSA+IC0xIHx8IGZhbHNlIC8qIEVNQkVSX0dMSU1NRVJfQU5HTEVfQlJBQ0tFVF9JTlZPQ0FUSU9OICovICYmIF9uYW1lLmNoYXJBdCgwKSA9PT0gX25hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCB1c2UgXCcnICsgX25hbWUgKyAnXCcgYXMgYSBjb21wb25lbnQgbmFtZS4gQ29tcG9uZW50IG5hbWVzIG11c3QgY29udGFpbiBhIGh5cGhlbi4nLCBfbmFtZS5pbmRleE9mKCctJykgPiAtMSB8fCBmYWxzZSAmJiBfbmFtZS5jaGFyQXQoMCkgPT09IF9uYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpKSk7CgoKICAgICAgdmFyIG5hbWUgPSBmYWxzZSAvKiBFTUJFUl9HTElNTUVSX0FOR0xFX0JSQUNLRVRfSU5WT0NBVElPTiAqLyAmJiBfbmFtZS5jaGFyQXQoMCkgPT09IF9uYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpID8gKDAsIF9zdHJpbmcuZGFzaGVyaXplKShfbmFtZSkgOiBfbmFtZTsKICAgICAgdmFyIHRlbXBsYXRlRnVsbE5hbWUgPSAndGVtcGxhdGU6Y29tcG9uZW50cy8nICsgbmFtZTsKICAgICAgcmV0dXJuIG93bmVyLmxvb2t1cCh0ZW1wbGF0ZUZ1bGxOYW1lLCBvcHRpb25zKTsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL21peGlucy9hY3Rpb25fc3VwcG9ydCcsIFsnZXhwb3J0cycsICdlbWJlci11dGlscycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZGVidWcnLCAnZW1iZXItdmlld3MvbGliL2NvbXBhdC9hdHRycyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyVXRpbHMsIF9lbWJlck1ldGFsLCBfZGVidWcsIF9hdHRycykgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgIEBtb2R1bGUgZW1iZXIKICAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlQWN0aW9uKGNvbXBvbmVudCwgYWN0aW9uTmFtZSkgewogICAgaWYgKGFjdGlvbk5hbWUgJiYgYWN0aW9uTmFtZVtfYXR0cnMuTVVUQUJMRV9DRUxMXSkgewogICAgICBhY3Rpb25OYW1lID0gYWN0aW9uTmFtZS52YWx1ZTsKICAgIH0KCiAgICAodHJ1ZSAmJiAhKGFjdGlvbk5hbWUgPT09IG51bGwgfHwgYWN0aW9uTmFtZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBhY3Rpb25OYW1lID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdUaGUgZGVmYXVsdCBhY3Rpb24gd2FzIHRyaWdnZXJlZCBvbiB0aGUgY29tcG9uZW50ICcgKyBjb21wb25lbnQudG9TdHJpbmcoKSArICcsIGJ1dCB0aGUgYWN0aW9uIG5hbWUgKCcgKyBhY3Rpb25OYW1lICsgJykgd2FzIG5vdCBhIHN0cmluZy4nLCBhY3Rpb25OYW1lID09PSBudWxsIHx8IGFjdGlvbk5hbWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgYWN0aW9uTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIGFjdGlvbk5hbWUgPT09ICdmdW5jdGlvbicpKTsKCiAgICByZXR1cm4gYWN0aW9uTmFtZTsKICB9CgogIC8qKgogICBAY2xhc3MgQWN0aW9uU3VwcG9ydAogICBAbmFtZXNwYWNlIEVtYmVyCiAgIEBwcml2YXRlCiAgKi8KICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgIENhbGxzIGFuIGFjdGlvbiBwYXNzZWQgdG8gYSBjb21wb25lbnQuCiAgICAgICBGb3IgZXhhbXBsZSBhIGNvbXBvbmVudCBmb3IgcGxheWluZyBvciBwYXVzaW5nIG11c2ljIG1heSB0cmFuc2xhdGUgY2xpY2sgZXZlbnRzCiAgICAgIGludG8gYWN0aW9uIG5vdGlmaWNhdGlvbnMgb2YgInBsYXkiIG9yICJzdG9wIiBkZXBlbmRpbmcgb24gc29tZSBpbnRlcm5hbCBzdGF0ZQogICAgICBvZiB0aGUgY29tcG9uZW50OgogICAgICAgYGBgYXBwL2NvbXBvbmVudHMvcGxheS1idXR0b24uanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsaWNrKCkgewogICAgICAgICAgaWYgKHRoaXMuZ2V0KCdpc1BsYXlpbmcnKSkgewogICAgICAgICAgICB0aGlzLnNlbmRBY3Rpb24oJ3BsYXknKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2VuZEFjdGlvbignc3RvcCcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVGhlIGFjdGlvbnMgInBsYXkiIGFuZCAic3RvcCIgbXVzdCBiZSBwYXNzZWQgdG8gdGhpcyBgcGxheS1idXR0b25gIGNvbXBvbmVudDoKICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3shIGFwcC90ZW1wbGF0ZXMvYXBwbGljYXRpb24uaGJzIH19CiAgICAgIHt7cGxheS1idXR0b24gcGxheT0oYWN0aW9uICJtdXNpY1N0YXJ0ZWQiKSBzdG9wPShhY3Rpb24gIm11c2ljU3RvcHBlZCIpfX0KICAgICAgYGBgCiAgICAgICBXaGVuIHRoZSBjb21wb25lbnQgcmVjZWl2ZXMgYSBicm93c2VyIGBjbGlja2AgZXZlbnQgaXQgdHJhbnNsYXRlIHRoaXMKICAgICAgaW50ZXJhY3Rpb24gaW50byBhcHBsaWNhdGlvbi1zcGVjaWZpYyBzZW1hbnRpY3MgKCJwbGF5IiBvciAic3RvcCIpIGFuZAogICAgICBjYWxscyB0aGUgc3BlY2lmaWVkIGFjdGlvbi4KICAgICAgIGBgYGFwcC9jb250cm9sbGVyL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBDb250cm9sbGVyIGZyb20gJ0BlbWJlci9jb250cm9sbGVyJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICBtdXNpY1N0YXJ0ZWQoKSB7CiAgICAgICAgICAgIC8vIGNhbGxlZCB3aGVuIHRoZSBwbGF5IGJ1dHRvbiBpcyBjbGlja2VkCiAgICAgICAgICAgIC8vIGFuZCB0aGUgbXVzaWMgc3RhcnRlZCBwbGF5aW5nCiAgICAgICAgICB9LAogICAgICAgICAgbXVzaWNTdG9wcGVkKCkgewogICAgICAgICAgICAvLyBjYWxsZWQgd2hlbiB0aGUgcGxheSBidXR0b24gaXMgY2xpY2tlZAogICAgICAgICAgICAvLyBhbmQgdGhlIG11c2ljIHN0b3BwZWQgcGxheWluZwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSWYgbm8gYWN0aW9uIGlzIHBhc3NlZCB0byBgc2VuZEFjdGlvbmAgYSBkZWZhdWx0IG5hbWUgb2YgImFjdGlvbiIKICAgICAgaXMgYXNzdW1lZC4KICAgICAgIGBgYGFwcC9jb21wb25lbnRzL25leHQtYnV0dG9uLmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGljaygpIHsKICAgICAgICAgIHRoaXMuc2VuZEFjdGlvbigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgYXBwL3RlbXBsYXRlcy9hcHBsaWNhdGlvbi5oYnMgfX0KICAgICAge3tuZXh0LWJ1dHRvbiBhY3Rpb249KGFjdGlvbiAicGxheU5leHRTb25nSW5BbGJ1bSIpfX0KICAgICAgYGBgCiAgICAgICBgYGBhcHAvY29udHJvbGxlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgICAgZXhwb3J0IGRlZmF1bHQgQ29udHJvbGxlci5leHRlbmQoewogICAgICAgIGFjdGlvbnM6IHsKICAgICAgICAgIHBsYXlOZXh0U29uZ0luQWxidW0oKSB7CiAgICAgICAgICAgIC4uLgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZW5kQWN0aW9uCiAgICAgIEBwYXJhbSBbYWN0aW9uXSB7U3RyaW5nfSB0aGUgYWN0aW9uIHRvIGNhbGwKICAgICAgQHBhcmFtIFtwYXJhbXNdIHsqfSBhcmd1bWVudHMgZm9yIHRoZSBhY3Rpb24KICAgICAgQHB1YmxpYwogICAgKi8KICAgIHNlbmRBY3Rpb246IGZ1bmN0aW9uIChhY3Rpb24pIHsKICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGNvbnRleHRzID0gQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGNvbnRleHRzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgKHRydWUgJiYgISghdGhpcy5pc0Rlc3Ryb3lpbmcgJiYgIXRoaXMuaXNEZXN0cm95ZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnQXR0ZW1wdGVkIHRvIGNhbGwgLnNlbmRBY3Rpb24oKSB3aXRoIHRoZSBhY3Rpb24gXCcnICsgYWN0aW9uICsgJ1wnIG9uIHRoZSBkZXN0cm95ZWQgb2JqZWN0IFwnJyArIHRoaXMgKyAnXCcuJywgIXRoaXMuaXNEZXN0cm95aW5nICYmICF0aGlzLmlzRGVzdHJveWVkKSk7CgoKICAgICAgdmFyIGFjdGlvbk5hbWUgPSB2b2lkIDA7CgogICAgICAvLyBTZW5kIHRoZSBkZWZhdWx0IGFjdGlvbgogICAgICBpZiAoYWN0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICBhY3Rpb24gPSAnYWN0aW9uJzsKICAgICAgfQogICAgICBhY3Rpb25OYW1lID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ2F0dHJzLicgKyBhY3Rpb24pIHx8ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsIGFjdGlvbik7CiAgICAgIGFjdGlvbk5hbWUgPSB2YWxpZGF0ZUFjdGlvbih0aGlzLCBhY3Rpb25OYW1lKTsKCiAgICAgIC8vIElmIG5vIGFjdGlvbiBuYW1lIGZvciB0aGF0IGFjdGlvbiBjb3VsZCBiZSBmb3VuZCwganVzdCBhYm9ydC4KICAgICAgaWYgKGFjdGlvbk5hbWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHR5cGVvZiBhY3Rpb25OYW1lID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgYWN0aW9uTmFtZS5hcHBseSh1bmRlZmluZWQsIGNvbnRleHRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRyaWdnZXJBY3Rpb24oewogICAgICAgICAgYWN0aW9uOiBhY3Rpb25OYW1lLAogICAgICAgICAgYWN0aW9uQ29udGV4dDogY29udGV4dHMKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIHNlbmQ6IGZ1bmN0aW9uIChhY3Rpb25OYW1lKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzRGVzdHJveWluZyAmJiAhdGhpcy5pc0Rlc3Ryb3llZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdBdHRlbXB0ZWQgdG8gY2FsbCAuc2VuZCgpIHdpdGggdGhlIGFjdGlvbiBcJycgKyBhY3Rpb25OYW1lICsgJ1wnIG9uIHRoZSBkZXN0cm95ZWQgb2JqZWN0IFwnJyArIHRoaXMgKyAnXCcuJywgIXRoaXMuaXNEZXN0cm95aW5nICYmICF0aGlzLmlzRGVzdHJveWVkKSk7CgoKICAgICAgdmFyIGFjdGlvbiA9IHRoaXMuYWN0aW9ucyAmJiB0aGlzLmFjdGlvbnNbYWN0aW9uTmFtZV07CgogICAgICBpZiAoYWN0aW9uKSB7CiAgICAgICAgdmFyIHNob3VsZEJ1YmJsZSA9IGFjdGlvbi5hcHBseSh0aGlzLCBhcmdzKSA9PT0gdHJ1ZTsKICAgICAgICBpZiAoIXNob3VsZEJ1YmJsZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHRhcmdldCA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd0YXJnZXQnKTsKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICh0cnVlICYmICEodHlwZW9mIHRhcmdldC5zZW5kID09PSAnZnVuY3Rpb24nKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1RoZSBgdGFyZ2V0YCBmb3IgJyArIHRoaXMgKyAnICgnICsgdGFyZ2V0ICsgJykgZG9lcyBub3QgaGF2ZSBhIGBzZW5kYCBtZXRob2QnLCB0eXBlb2YgdGFyZ2V0LnNlbmQgPT09ICdmdW5jdGlvbicpKTsKCiAgICAgICAgdGFyZ2V0LnNlbmQuYXBwbHkodGFyZ2V0LCBhcmd1bWVudHMpOwogICAgICB9IGVsc2UgewogICAgICAgICh0cnVlICYmICEoYWN0aW9uKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoKDAsIF9lbWJlclV0aWxzLmluc3BlY3QpKHRoaXMpICsgJyBoYWQgbm8gYWN0aW9uIGhhbmRsZXIgZm9yOiAnICsgYWN0aW9uTmFtZSwgYWN0aW9uKSk7CiAgICAgIH0KICAgIH0KICB9KTsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL21peGlucy9jaGlsZF92aWV3c19zdXBwb3J0JywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfdXRpbHMpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IF9lbWJlck1ldGFsLk1peGluLmNyZWF0ZSh7CiAgICAvKioKICAgICAgQXJyYXkgb2YgY2hpbGQgdmlld3MuIFlvdSBzaG91bGQgbmV2ZXIgZWRpdCB0aGlzIGFycmF5IGRpcmVjdGx5LgogICAgICAgQHByb3BlcnR5IGNoaWxkVmlld3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgW10KICAgICAgQHByaXZhdGUKICAgICovCiAgICBjaGlsZFZpZXdzOiAoMCwgX2VtYmVyTWV0YWwuZGVzY3JpcHRvcikoewogICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICgwLCBfdXRpbHMuZ2V0Q2hpbGRWaWV3cykodGhpcyk7CiAgICAgIH0KICAgIH0pLAoKICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbiAodmlldykgewogICAgICAoMCwgX3V0aWxzLmFkZENoaWxkVmlldykodGhpcywgdmlldyk7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9taXhpbnMvY2xhc3NfbmFtZXNfc3VwcG9ydCcsIFsnZXhwb3J0cycsICdlbWJlci1tZXRhJywgJ2VtYmVyLW1ldGFsJywgJ0BlbWJlci9kZWJ1ZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyTWV0YSwgX2VtYmVyTWV0YWwsIF9kZWJ1ZykgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIEVNUFRZX0FSUkFZID0gT2JqZWN0LmZyZWV6ZShbXSk7CgogIC8qKgogICAgQGNsYXNzIENsYXNzTmFtZXNTdXBwb3J0CiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICovCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCiAgZXhwb3J0cy5kZWZhdWx0ID0gX2VtYmVyTWV0YWwuTWl4aW4uY3JlYXRlKHsKICAgIGNvbmNhdGVuYXRlZFByb3BlcnRpZXM6IFsnY2xhc3NOYW1lcycsICdjbGFzc05hbWVCaW5kaW5ncyddLAoKICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICh0cnVlICYmICEoKDAsIF9lbWJlck1ldGEuZGVzY3JpcHRvckZvcikodGhpcywgJ2NsYXNzTmFtZUJpbmRpbmdzJykgPT09IHVuZGVmaW5lZCAmJiBBcnJheS5pc0FycmF5KHRoaXMuY2xhc3NOYW1lQmluZGluZ3MpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ09ubHkgYXJyYXlzIGFyZSBhbGxvd2VkIGZvciBcJ2NsYXNzTmFtZUJpbmRpbmdzXCcnLCAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKSh0aGlzLCAnY2xhc3NOYW1lQmluZGluZ3MnKSA9PT0gdW5kZWZpbmVkICYmIEFycmF5LmlzQXJyYXkodGhpcy5jbGFzc05hbWVCaW5kaW5ncykpKTsKICAgICAgKHRydWUgJiYgISgoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKSh0aGlzLCAnY2xhc3NOYW1lcycpID09PSB1bmRlZmluZWQgJiYgQXJyYXkuaXNBcnJheSh0aGlzLmNsYXNzTmFtZXMpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ09ubHkgYXJyYXlzIG9mIHN0YXRpYyBjbGFzcyBzdHJpbmdzIGFyZSBhbGxvd2VkIGZvciBcJ2NsYXNzTmFtZXNcJy4gRm9yIGR5bmFtaWMgY2xhc3NlcywgdXNlIFwnY2xhc3NOYW1lQmluZGluZ3NcJy4nLCAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKSh0aGlzLCAnY2xhc3NOYW1lcycpID09PSB1bmRlZmluZWQgJiYgQXJyYXkuaXNBcnJheSh0aGlzLmNsYXNzTmFtZXMpKSk7CiAgICB9LAoKCiAgICAvKioKICAgICAgU3RhbmRhcmQgQ1NTIGNsYXNzIG5hbWVzIHRvIGFwcGx5IHRvIHRoZSB2aWV3J3Mgb3V0ZXIgZWxlbWVudC4gVGhpcwogICAgICBwcm9wZXJ0eSBhdXRvbWF0aWNhbGx5IGluaGVyaXRzIGFueSBjbGFzcyBuYW1lcyBkZWZpbmVkIGJ5IHRoZSB2aWV3J3MKICAgICAgc3VwZXJjbGFzc2VzIGFzIHdlbGwuCiAgICAgICBAcHJvcGVydHkgY2xhc3NOYW1lcwogICAgICBAdHlwZSBBcnJheQogICAgICBAZGVmYXVsdCBbJ2VtYmVyLXZpZXcnXQogICAgICBAcHVibGljCiAgICAqLwogICAgY2xhc3NOYW1lczogRU1QVFlfQVJSQVksCgogICAgLyoqCiAgICAgIEEgbGlzdCBvZiBwcm9wZXJ0aWVzIG9mIHRoZSB2aWV3IHRvIGFwcGx5IGFzIGNsYXNzIG5hbWVzLiBJZiB0aGUgcHJvcGVydHkKICAgICAgaXMgYSBzdHJpbmcgdmFsdWUsIHRoZSB2YWx1ZSBvZiB0aGF0IHN0cmluZyB3aWxsIGJlIGFwcGxpZWQgYXMgYSBjbGFzcwogICAgICBuYW1lLgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBBcHBsaWVzIHRoZSAnaGlnaCcgY2xhc3MgdG8gdGhlIHZpZXcgZWxlbWVudAogICAgICBpbXBvcnQgQ29tcG9uZW50IGZyb20gJ0BlbWJlci9jb21wb25lbnQnOwogICAgICBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBjbGFzc05hbWVCaW5kaW5nczogWydwcmlvcml0eSddLAogICAgICAgIHByaW9yaXR5OiAnaGlnaCcKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSWYgdGhlIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSBpcyBhIEJvb2xlYW4sIHRoZSBuYW1lIG9mIHRoYXQgcHJvcGVydHkgaXMKICAgICAgYWRkZWQgYXMgYSBkYXNoZXJpemVkIGNsYXNzIG5hbWUuCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIEFwcGxpZXMgdGhlICdpcy11cmdlbnQnIGNsYXNzIHRvIHRoZSB2aWV3IGVsZW1lbnQKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgQ29tcG9uZW50LmV4dGVuZCh7CiAgICAgICAgY2xhc3NOYW1lQmluZGluZ3M6IFsnaXNVcmdlbnQnXSwKICAgICAgICBpc1VyZ2VudDogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJZiB5b3Ugd291bGQgcHJlZmVyIHRvIHVzZSBhIGN1c3RvbSB2YWx1ZSBpbnN0ZWFkIG9mIHRoZSBkYXNoZXJpemVkCiAgICAgIHByb3BlcnR5IG5hbWUsIHlvdSBjYW4gcGFzcyBhIGJpbmRpbmcgbGlrZSB0aGlzOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBBcHBsaWVzIHRoZSAndXJnZW50JyBjbGFzcyB0byB0aGUgdmlldyBlbGVtZW50CiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgIENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzVXJnZW50OnVyZ2VudCddLAogICAgICAgIGlzVXJnZW50OiB0cnVlCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIElmIHlvdSB3b3VsZCBsaWtlIHRvIHNwZWNpZnkgYSBjbGFzcyB0aGF0IHNob3VsZCBvbmx5IGJlIGFkZGVkIHdoZW4gdGhlCiAgICAgIHByb3BlcnR5IGlzIGZhbHNlLCB5b3UgY2FuIGRlY2xhcmUgYSBiaW5kaW5nIGxpa2UgdGhpczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgLy8gQXBwbGllcyB0aGUgJ2Rpc2FibGVkJyBjbGFzcyB0byB0aGUgdmlldyBlbGVtZW50CiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgIENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGNsYXNzTmFtZUJpbmRpbmdzOiBbJ2lzRW5hYmxlZDo6ZGlzYWJsZWQnXSwKICAgICAgICBpc0VuYWJsZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoaXMgbGlzdCBvZiBwcm9wZXJ0aWVzIGlzIGluaGVyaXRlZCBmcm9tIHRoZSBjb21wb25lbnQncyBzdXBlcmNsYXNzZXMgYXMgd2VsbC4KICAgICAgIEBwcm9wZXJ0eSBjbGFzc05hbWVCaW5kaW5ncwogICAgICBAdHlwZSBBcnJheQogICAgICBAZGVmYXVsdCBbXQogICAgICBAcHVibGljCiAgICAqLwogICAgY2xhc3NOYW1lQmluZGluZ3M6IEVNUFRZX0FSUkFZCiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9taXhpbnMvdGV4dF9zdXBwb3J0JywgWydleHBvcnRzJywgJ2VtYmVyLW1ldGFsJywgJ2VtYmVyLXJ1bnRpbWUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsLCBfZW1iZXJSdW50aW1lKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgdmFyIEtFWV9FVkVOVFMgPSB7CiAgICAxMzogJ2luc2VydE5ld2xpbmUnLAogICAgMjc6ICdjYW5jZWwnCiAgfTsKCiAgLyoqCiAgICBgVGV4dFN1cHBvcnRgIGlzIGEgc2hhcmVkIG1peGluIHVzZWQgYnkgYm90aCBgVGV4dEZpZWxkYCBhbmQKICAgIGBUZXh0QXJlYWAuIGBUZXh0U3VwcG9ydGAgYWRkcyBhIG51bWJlciBvZiBtZXRob2RzIHRoYXQgYWxsb3cgeW91IHRvCiAgICBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBjZXJ0YWluIGV2ZW50IGlzIGZpcmVkIG9uIHlvdXIKICAgIHRleHQgZmllbGQgb3IgdGV4dGFyZWEuIFRoZSBzcGVjaWZpZWQgY29udHJvbGxlciBhY3Rpb24gd291bGQgZ2V0IHRoZSBjdXJyZW50CiAgICB2YWx1ZSBvZiB0aGUgZmllbGQgcGFzc2VkIGluIGFzIHRoZSBvbmx5IGFyZ3VtZW50IHVubGVzcyB0aGUgdmFsdWUgb2YKICAgIHRoZSBmaWVsZCBpcyBlbXB0eS4gSW4gdGhhdCBjYXNlLCB0aGUgaW5zdGFuY2Ugb2YgdGhlIGZpZWxkIGl0c2VsZiBpcyBwYXNzZWQKICAgIGluIGFzIHRoZSBvbmx5IGFyZ3VtZW50LgogIAogICAgTGV0J3MgdXNlIHRoZSBwcmVzc2luZyBvZiB0aGUgZXNjYXBlIGtleSBhcyBhbiBleGFtcGxlLiBJZiB5b3Ugd2FudGVkIHRvCiAgICBpbnZva2UgYSBjb250cm9sbGVyIGFjdGlvbiB3aGVuIGEgdXNlciBwcmVzc2VzIHRoZSBlc2NhcGUga2V5IHdoaWxlIG9uIHlvdXIKICAgIGZpZWxkLCB5b3Ugd291bGQgdXNlIHRoZSBgZXNjYXBlLXByZXNzYCBhdHRyaWJ1dGUgb24geW91ciBmaWVsZCBsaWtlIHNvOgogIAogICAgYGBgaGFuZGxlYmFycwogICAgICB7eyEgYXBwbGljYXRpb24uaGJzfX0KICAKICAgICAge3tpbnB1dCBlc2NhcGUtcHJlc3M9J2FsZXJ0VXNlcid9fQogICAgYGBgCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgICAgaW1wb3J0IENvbnRyb2xsZXIgZnJvbSAnQGVtYmVyL2NvbnRyb2xsZXInOwogICAgICAgIEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSgpOwogIAogICAgICAgIEFwcC5BcHBsaWNhdGlvbkNvbnRyb2xsZXIgPSBDb250cm9sbGVyLmV4dGVuZCh7CiAgICAgICAgICBhY3Rpb25zOiB7CiAgICAgICAgICAgIGFsZXJ0VXNlcjogZnVuY3Rpb24gKCBjdXJyZW50VmFsdWUgKSB7CiAgICAgICAgICAgICAgYWxlcnQoICdlc2NhcGUgcHJlc3NlZCwgY3VycmVudCB2YWx1ZTogJyArIGN1cnJlbnRWYWx1ZSApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSBmb2xsb3dpbmcgY2hhcnQgaXMgYSB2aXN1YWwgcmVwcmVzZW50YXRpb24gb2Ygd2hhdCB0YWtlcyBwbGFjZSB3aGVuIHRoZQogICAgZXNjYXBlIGtleSBpcyBwcmVzc2VkIGluIHRoaXMgc2NlbmFyaW86CiAgCiAgICBgYGAKICAgIFRoZSBUZW1wbGF0ZQogICAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICB8IGVzY2FwZS1wcmVzcz0nYWxlcnRVc2VyJyAgfAogICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgVGV4dFN1cHBvcnQgTWl4aW4KICAgICstLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rICAgICAgICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwogICAgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjYW5jZWwgbWV0aG9kICAgICAgICAgICAgICAgICB8CiAgICAgICAgIHwgICAgICBlc2NhcGUgYnV0dG9uIHByZXNzZWQgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0+IHwgY2hlY2tzIGZvciB0aGUgYGVzY2FwZS1wcmVzc2AgfAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBhdHRyaWJ1dGUgYW5kIHB1bGxzIG91dCB0aGUgICB8CiAgICAgICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKyB8IGBhbGVydFVzZXJgIHZhbHVlICAgICAgICAgICAgIHwKICAgICAgICAgfCAgICAgYWN0aW9uIG5hbWUgJ2FsZXJ0VXNlcicgICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwogICAgICAgICB8ICAgICBzZW50IHRvIGNvbnRyb2xsZXIKICAgICAgICAgdgogICAgQ29udHJvbGxlcgogICAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSArCiAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgIHwgIGFjdGlvbnM6IHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgfCAgICAgYWxlcnRVc2VyOiBmdW5jdGlvbiggY3VycmVudFZhbHVlICl7ICB8CiAgICB8ICAgICAgIGFsZXJ0KCAndGhlIGVzYyBrZXkgd2FzIHByZXNzZWQhJyApIHwKICAgIHwgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgfCAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKwogICAgYGBgCiAgCiAgICBIZXJlIGFyZSB0aGUgZXZlbnRzIHRoYXQgd2UgY3VycmVudGx5IHN1cHBvcnQgYWxvbmcgd2l0aCB0aGUgbmFtZSBvZiB0aGUKICAgIGF0dHJpYnV0ZSB5b3Ugd291bGQgbmVlZCB0byB1c2Ugb24geW91ciBmaWVsZC4gVG8gcmVpdGVyYXRlLCB5b3Ugd291bGQgdXNlIHRoZQogICAgYXR0cmlidXRlIG5hbWUgbGlrZSBzbzoKICAKICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3tpbnB1dCBhdHRyaWJ1dGUtbmFtZT0nY29udHJvbGxlckFjdGlvbid9fQogICAgYGBgCiAgCiAgICBgYGAKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tKwogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGV2ZW50ICAgICAgICAgICAgICB8IGF0dHJpYnV0ZSBuYW1lIHwKICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLS0tLS0tKwogICAgfCBuZXcgbGluZSBpbnNlcnRlZCAgfCBpbnNlcnQtbmV3bGluZSB8CiAgICB8ICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAgIHwKICAgIHwgZW50ZXIga2V5IHByZXNzZWQgIHwgaW5zZXJ0LW5ld2xpbmUgfAogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGNhbmNlbCBrZXkgcHJlc3NlZCB8IGVzY2FwZS1wcmVzcyAgIHwKICAgIHwgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgICAgICAgfAogICAgfCBmb2N1c2luICAgICAgICAgICAgfCBmb2N1cy1pbiAgICAgICB8CiAgICB8ICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAgIHwKICAgIHwgZm9jdXNvdXQgICAgICAgICAgIHwgZm9jdXMtb3V0ICAgICAgfAogICAgfCAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICAgICAgICB8CiAgICB8IGtleXByZXNzICAgICAgICAgICB8IGtleS1wcmVzcyAgICAgIHwKICAgIHwgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgICAgICAgfAogICAgfCBrZXl1cCAgICAgICAgICAgICAgfCBrZXktdXAgICAgICAgICB8CiAgICB8ICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgICAgICAgIHwKICAgIHwga2V5ZG93biAgICAgICAgICAgIHwga2V5LWRvd24gICAgICAgfAogICAgKy0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0rCiAgICBgYGAKICAKICAgIEBjbGFzcyBUZXh0U3VwcG9ydAogICAgQG5hbWVzcGFjZSBFbWJlcgogICAgQHVzZXMgRW1iZXIuVGFyZ2V0QWN0aW9uU3VwcG9ydAogICAgQGV4dGVuZHMgTWl4aW4KICAgIEBwcml2YXRlCiAgKi8KICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoX2VtYmVyUnVudGltZS5UYXJnZXRBY3Rpb25TdXBwb3J0LCB7CiAgICB2YWx1ZTogJycsCgogICAgYXR0cmlidXRlQmluZGluZ3M6IFsnYXV0b2NhcGl0YWxpemUnLCAnYXV0b2NvcnJlY3QnLCAnYXV0b2ZvY3VzJywgJ2Rpc2FibGVkJywgJ2Zvcm0nLCAnbWF4bGVuZ3RoJywgJ21pbmxlbmd0aCcsICdwbGFjZWhvbGRlcicsICdyZWFkb25seScsICdyZXF1aXJlZCcsICdzZWxlY3Rpb25EaXJlY3Rpb24nLCAnc3BlbGxjaGVjaycsICd0YWJpbmRleCcsICd0aXRsZSddLAogICAgcGxhY2Vob2xkZXI6IG51bGwsCiAgICBkaXNhYmxlZDogZmFsc2UsCiAgICBtYXhsZW5ndGg6IG51bGwsCgogICAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgICB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB0aGlzLm9uKCdwYXN0ZScsIHRoaXMsIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSk7CiAgICAgIHRoaXMub24oJ2N1dCcsIHRoaXMsIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZSk7CiAgICAgIHRoaXMub24oJ2lucHV0JywgdGhpcywgdGhpcy5fZWxlbWVudFZhbHVlRGlkQ2hhbmdlKTsKICAgIH0sCgoKICAgIC8qKgogICAgICBXaGV0aGVyIHRoZSBga2V5VXBgIGV2ZW50IHRoYXQgdHJpZ2dlcnMgYW4gYGFjdGlvbmAgdG8gYmUgc2VudCBjb250aW51ZXMKICAgICAgcHJvcGFnYXRpbmcgdG8gb3RoZXIgdmlld3MuCiAgICAgICBCeSBkZWZhdWx0LCB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIHJldHVybiBrZXkgb24gdGhlaXIga2V5Ym9hcmQgYW5kCiAgICAgIHRoZSB0ZXh0IGZpZWxkIGhhcyBhbiBgYWN0aW9uYCBzZXQsIHRoZSBhY3Rpb24gd2lsbCBiZSBzZW50IHRvIHRoZSB2aWV3J3MKICAgICAgY29udHJvbGxlciBhbmQgdGhlIGtleSBldmVudCB3aWxsIHN0b3AgcHJvcGFnYXRpbmcuCiAgICAgICBJZiB5b3Ugd291bGQgbGlrZSBwYXJlbnQgdmlld3MgdG8gcmVjZWl2ZSB0aGUgYGtleVVwYCBldmVudCBldmVuIGFmdGVyIGFuCiAgICAgIGFjdGlvbiBoYXMgYmVlbiBkaXNwYXRjaGVkLCBzZXQgYGJ1YmJsZXNgIHRvIHRydWUuCiAgICAgICBAcHJvcGVydHkgYnViYmxlcwogICAgICBAdHlwZSBCb29sZWFuCiAgICAgIEBkZWZhdWx0IGZhbHNlCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYnViYmxlczogZmFsc2UsCgogICAgaW50ZXJwcmV0S2V5RXZlbnRzOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIG1hcCA9IEtFWV9FVkVOVFM7CiAgICAgIHZhciBtZXRob2QgPSBtYXBbZXZlbnQua2V5Q29kZV07CgogICAgICB0aGlzLl9lbGVtZW50VmFsdWVEaWRDaGFuZ2UoKTsKICAgICAgaWYgKG1ldGhvZCkgewogICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0oZXZlbnQpOwogICAgICB9CiAgICB9LAogICAgX2VsZW1lbnRWYWx1ZURpZENoYW5nZTogZnVuY3Rpb24gKCkgewogICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCAndmFsdWUnLCB0aGlzLmVsZW1lbnQudmFsdWUpOwogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHRoaXMuX2VsZW1lbnRWYWx1ZURpZENoYW5nZShldmVudCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gZWl0aGVyIHRoZSBgZW50ZXJgCiAgICAgIGtleSBpcyBwcmVzc2VkIG9yLCBpbiB0aGUgY2FzZSBvZiB0aGUgZmllbGQgYmVpbmcgYSB0ZXh0YXJlYSwgd2hlbiBhIG5ld2xpbmUKICAgICAgaXMgaW5zZXJ0ZWQuIFRvIHVzZSB0aGlzIG1ldGhvZCwgZ2l2ZSB5b3VyIGZpZWxkIGFuIGBpbnNlcnQtbmV3bGluZWAKICAgICAgYXR0cmlidXRlLiBUaGUgdmFsdWUgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24KICAgICAgaW4geW91ciBjb250cm9sbGVyIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGluc2VydC1uZXdsaW5lYCBhdHRyaWJ1dGUsIHBsZWFzZQogICAgICByZWZlcmVuY2UgdGhlIGV4YW1wbGUgbmVhciB0aGUgdG9wIG9mIHRoaXMgZmlsZS4KICAgICAgIEBtZXRob2QgaW5zZXJ0TmV3bGluZQogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGluc2VydE5ld2xpbmU6IGZ1bmN0aW9uIChldmVudCkgewogICAgICBzZW5kQWN0aW9uKCdlbnRlcicsIHRoaXMsIGV2ZW50KTsKICAgICAgc2VuZEFjdGlvbignaW5zZXJ0LW5ld2xpbmUnLCB0aGlzLCBldmVudCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gdGhlIGVzY2FwZSBidXR0b24KICAgICAgaXMgcHJlc3NlZC4gVG8gdXNlIHRoaXMgbWV0aG9kLCBnaXZlIHlvdXIgZmllbGQgYW4gYGVzY2FwZS1wcmVzc2AKICAgICAgYXR0cmlidXRlLiBUaGUgdmFsdWUgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24KICAgICAgaW4geW91ciBjb250cm9sbGVyIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGVzY2FwZS1wcmVzc2AgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlCiAgICAgIHRoZSBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGNhbmNlbAogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGNhbmNlbDogZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHNlbmRBY3Rpb24oJ2VzY2FwZS1wcmVzcycsIHRoaXMsIGV2ZW50KTsKICAgIH0sCgoKICAgIC8qKgogICAgICBBbGxvd3MgeW91IHRvIHNwZWNpZnkgYSBjb250cm9sbGVyIGFjdGlvbiB0byBpbnZva2Ugd2hlbiBhIGZpZWxkIHJlY2VpdmVzCiAgICAgIGZvY3VzLiBUbyB1c2UgdGhpcyBtZXRob2QsIGdpdmUgeW91ciBmaWVsZCBhIGBmb2N1cy1pbmAgYXR0cmlidXRlLiBUaGUgdmFsdWUKICAgICAgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24gaW4geW91ciBjb250cm9sbGVyCiAgICAgIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGZvY3VzLWluYCBhdHRyaWJ1dGUsIHBsZWFzZSByZWZlcmVuY2UgdGhlCiAgICAgIGV4YW1wbGUgbmVhciB0aGUgdG9wIG9mIHRoaXMgZmlsZS4KICAgICAgIEBtZXRob2QgZm9jdXNJbgogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZvY3VzSW46IGZ1bmN0aW9uIChldmVudCkgewogICAgICBzZW5kQWN0aW9uKCdmb2N1cy1pbicsIHRoaXMsIGV2ZW50KTsKICAgIH0sCgoKICAgIC8qKgogICAgICBBbGxvd3MgeW91IHRvIHNwZWNpZnkgYSBjb250cm9sbGVyIGFjdGlvbiB0byBpbnZva2Ugd2hlbiBhIGZpZWxkIGxvc2VzCiAgICAgIGZvY3VzLiBUbyB1c2UgdGhpcyBtZXRob2QsIGdpdmUgeW91ciBmaWVsZCBhIGBmb2N1cy1vdXRgIGF0dHJpYnV0ZS4gVGhlIHZhbHVlCiAgICAgIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uIGluIHlvdXIgY29udHJvbGxlcgogICAgICB0aGF0IHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBmb2N1cy1vdXRgIGF0dHJpYnV0ZSwgcGxlYXNlIHJlZmVyZW5jZSB0aGUKICAgICAgZXhhbXBsZSBuZWFyIHRoZSB0b3Agb2YgdGhpcyBmaWxlLgogICAgICAgQG1ldGhvZCBmb2N1c091dAogICAgICBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGZvY3VzT3V0OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdGhpcy5fZWxlbWVudFZhbHVlRGlkQ2hhbmdlKGV2ZW50KTsKICAgICAgc2VuZEFjdGlvbignZm9jdXMtb3V0JywgdGhpcywgZXZlbnQpOwogICAgfSwKCgogICAgLyoqCiAgICAgIEFsbG93cyB5b3UgdG8gc3BlY2lmeSBhIGNvbnRyb2xsZXIgYWN0aW9uIHRvIGludm9rZSB3aGVuIGEga2V5IGlzIHByZXNzZWQuCiAgICAgIFRvIHVzZSB0aGlzIG1ldGhvZCwgZ2l2ZSB5b3VyIGZpZWxkIGEgYGtleS1wcmVzc2AgYXR0cmlidXRlLiBUaGUgdmFsdWUgb2YKICAgICAgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24gaW4geW91ciBjb250cm9sbGVyIHlvdQogICAgICB0aGF0IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGtleS1wcmVzc2AgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlIHRoZQogICAgICBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGtleVByZXNzCiAgICAgIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAga2V5UHJlc3M6IGZ1bmN0aW9uIChldmVudCkgewogICAgICBzZW5kQWN0aW9uKCdrZXktcHJlc3MnLCB0aGlzLCBldmVudCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBrZXktdXAgZXZlbnQgaXMKICAgICAgZmlyZWQuIFRvIHVzZSB0aGlzIG1ldGhvZCwgZ2l2ZSB5b3VyIGZpZWxkIGEgYGtleS11cGAgYXR0cmlidXRlLiBUaGUgdmFsdWUKICAgICAgb2YgdGhhdCBhdHRyaWJ1dGUgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBhY3Rpb24gaW4geW91ciBjb250cm9sbGVyCiAgICAgIHRoYXQgeW91IHdpc2ggdG8gaW52b2tlLgogICAgICAgRm9yIGFuIGV4YW1wbGUgb24gaG93IHRvIHVzZSB0aGUgYGtleS11cGAgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlIHRoZQogICAgICBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGtleVVwCiAgICAgIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAga2V5VXA6IGZ1bmN0aW9uIChldmVudCkgewogICAgICB0aGlzLmludGVycHJldEtleUV2ZW50cyhldmVudCk7CgogICAgICB0aGlzLnNlbmRBY3Rpb24oJ2tleS11cCcsICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd2YWx1ZScpLCBldmVudCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgQWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEgY29udHJvbGxlciBhY3Rpb24gdG8gaW52b2tlIHdoZW4gYSBrZXktZG93biBldmVudCBpcwogICAgICBmaXJlZC4gVG8gdXNlIHRoaXMgbWV0aG9kLCBnaXZlIHlvdXIgZmllbGQgYSBga2V5LWRvd25gIGF0dHJpYnV0ZS4gVGhlIHZhbHVlCiAgICAgIG9mIHRoYXQgYXR0cmlidXRlIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgYWN0aW9uIGluIHlvdXIgY29udHJvbGxlciB0aGF0CiAgICAgIHlvdSB3aXNoIHRvIGludm9rZS4KICAgICAgIEZvciBhbiBleGFtcGxlIG9uIGhvdyB0byB1c2UgdGhlIGBrZXktZG93bmAgYXR0cmlidXRlLCBwbGVhc2UgcmVmZXJlbmNlIHRoZQogICAgICBleGFtcGxlIG5lYXIgdGhlIHRvcCBvZiB0aGlzIGZpbGUuCiAgICAgICBAbWV0aG9kIGtleURvd24KICAgICAgQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAgQHByaXZhdGUKICAgICovCiAgICBrZXlEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdGhpcy5zZW5kQWN0aW9uKCdrZXktZG93bicsICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICd2YWx1ZScpLCBldmVudCk7CiAgICB9CiAgfSk7CgoKICAvLyBJbiBwcmluY2lwbGUsIHRoaXMgc2hvdWxkbid0IGJlIG5lY2Vzc2FyeSwgYnV0IHRoZSBsZWdhY3kKICAvLyBzZW5kQWN0aW9uIHNlbWFudGljcyBmb3IgVGV4dEZpZWxkIGFyZSBkaWZmZXJlbnQgZnJvbQogIC8vIHRoZSBjb21wb25lbnQgc2VtYW50aWNzIHNvIHRoaXMgbWV0aG9kIG5vcm1hbGl6ZXMgdGhlbS4KICBmdW5jdGlvbiBzZW5kQWN0aW9uKGV2ZW50TmFtZSwgdmlldywgZXZlbnQpIHsKICAgIHZhciBhY3Rpb24gPSAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh2aWV3LCAnYXR0cnMuJyArIGV2ZW50TmFtZSkgfHwgKDAsIF9lbWJlck1ldGFsLmdldCkodmlldywgZXZlbnROYW1lKTsKICAgIHZhciB2YWx1ZSA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHZpZXcsICd2YWx1ZScpOwoKICAgIHZpZXcuc2VuZEFjdGlvbihldmVudE5hbWUsIHZhbHVlKTsKCiAgICBpZiAoYWN0aW9uICYmICEoMCwgX2VtYmVyTWV0YWwuZ2V0KSh2aWV3LCAnYnViYmxlcycpKSB7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQogIH0KfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL21peGlucy92aWV3X3N0YXRlX3N1cHBvcnQnLCBbJ2V4cG9ydHMnLCAnZW1iZXItbWV0YWwnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck1ldGFsKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgX3RyYW5zaXRpb25UbzogZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIHZhciBwcmlvclN0YXRlID0gdGhpcy5fY3VycmVudFN0YXRlOwogICAgICB2YXIgY3VycmVudFN0YXRlID0gdGhpcy5fY3VycmVudFN0YXRlID0gdGhpcy5fc3RhdGVzW3N0YXRlXTsKICAgICAgdGhpcy5fc3RhdGUgPSBzdGF0ZTsKCiAgICAgIGlmIChwcmlvclN0YXRlICYmIHByaW9yU3RhdGUuZXhpdCkgewogICAgICAgIHByaW9yU3RhdGUuZXhpdCh0aGlzKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudFN0YXRlLmVudGVyKSB7CiAgICAgICAgY3VycmVudFN0YXRlLmVudGVyKHRoaXMpOwogICAgICB9CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9taXhpbnMvdmlld19zdXBwb3J0JywgWydleHBvcnRzJywgJ2VtYmVyLXV0aWxzJywgJ2VtYmVyLW1ldGEnLCAnZW1iZXItbWV0YWwnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLWJyb3dzZXItZW52aXJvbm1lbnQnLCAnZW1iZXItdmlld3MvbGliL3N5c3RlbS91dGlscycsICdlbWJlci12aWV3cy9saWIvc3lzdGVtL2pxdWVyeSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2VtYmVyVXRpbHMsIF9lbWJlck1ldGEsIF9lbWJlck1ldGFsLCBfZGVidWcsIF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudCwgX3V0aWxzLCBfanF1ZXJ5KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBLKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvKioKICAgQGNsYXNzIFZpZXdNaXhpbgogICBAbmFtZXNwYWNlIEVtYmVyCiAgIEBwcml2YXRlCiAgKi8KICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJNZXRhbC5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgIEEgbGlzdCBvZiBwcm9wZXJ0aWVzIG9mIHRoZSB2aWV3IHRvIGFwcGx5IGFzIGF0dHJpYnV0ZXMuIElmIHRoZSBwcm9wZXJ0eQogICAgICBpcyBhIHN0cmluZyB2YWx1ZSwgdGhlIHZhbHVlIG9mIHRoYXQgc3RyaW5nIHdpbGwgYmUgYXBwbGllZCBhcyB0aGUgdmFsdWUKICAgICAgZm9yIGFuIGF0dHJpYnV0ZSBvZiB0aGUgcHJvcGVydHkncyBuYW1lLgogICAgICAgVGhlIGZvbGxvd2luZyBleGFtcGxlIGNyZWF0ZXMgYSB0YWcgbGlrZSBgPGRpdiBwcmlvcml0eT0iaGlnaCIgLz5gLgogICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY29tcG9uZW50LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWydwcmlvcml0eSddLAogICAgICAgIHByaW9yaXR5OiAnaGlnaCcKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgSWYgdGhlIHZhbHVlIG9mIHRoZSBwcm9wZXJ0eSBpcyBhIEJvb2xlYW4sIHRoZSBhdHRyaWJ1dGUgaXMgdHJlYXRlZCBhcwogICAgICBhbiBIVE1MIEJvb2xlYW4gYXR0cmlidXRlLiBJdCB3aWxsIGJlIHByZXNlbnQgaWYgdGhlIHByb3BlcnR5IGlzIGB0cnVlYAogICAgICBhbmQgb21pdHRlZCBpZiB0aGUgcHJvcGVydHkgaXMgYGZhbHNlYC4KICAgICAgIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBjcmVhdGVzIG1hcmt1cCBsaWtlIGA8ZGl2IHZpc2libGUgLz5gLgogICAgICAgYGBgYXBwL2NvbXBvbmVudHMvbXktY29tcG9uZW50LmpzCiAgICAgIGltcG9ydCBDb21wb25lbnQgZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBDb21wb25lbnQuZXh0ZW5kKHsKICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nczogWyd2aXNpYmxlJ10sCiAgICAgICAgdmlzaWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBJZiB5b3Ugd291bGQgcHJlZmVyIHRvIHVzZSBhIGN1c3RvbSB2YWx1ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBuYW1lLAogICAgICB5b3UgY2FuIGNyZWF0ZSB0aGUgc2FtZSBtYXJrdXAgYXMgdGhlIGxhc3QgZXhhbXBsZSB3aXRoIGEgYmluZGluZyBsaWtlCiAgICAgIHRoaXM6CiAgICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGF0dHJpYnV0ZUJpbmRpbmdzOiBbJ2lzVmlzaWJsZTp2aXNpYmxlJ10sCiAgICAgICAgaXNWaXNpYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoaXMgbGlzdCBvZiBhdHRyaWJ1dGVzIGlzIGluaGVyaXRlZCBmcm9tIHRoZSBjb21wb25lbnQncyBzdXBlcmNsYXNzZXMsCiAgICAgIGFzIHdlbGwuCiAgICAgICBAcHJvcGVydHkgYXR0cmlidXRlQmluZGluZ3MKICAgICAgQHR5cGUgQXJyYXkKICAgICAgQGRlZmF1bHQgW10KICAgICAgQHB1YmxpYwogICAgICovCiAgICBjb25jYXRlbmF0ZWRQcm9wZXJ0aWVzOiBbJ2F0dHJpYnV0ZUJpbmRpbmdzJ10sCgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gVEVNUExBVEUgU1VQUE9SVAogICAgLy8KCiAgICAvKioKICAgICAgUmV0dXJuIHRoZSBuZWFyZXN0IGFuY2VzdG9yIHRoYXQgaXMgYW4gaW5zdGFuY2Ugb2YgdGhlIHByb3ZpZGVkCiAgICAgIGNsYXNzIG9yIG1peGluLgogICAgICAgQG1ldGhvZCBuZWFyZXN0T2ZUeXBlCiAgICAgIEBwYXJhbSB7Q2xhc3MsTWl4aW59IGtsYXNzIFN1YmNsYXNzIG9mIEVtYmVyLlZpZXcgKG9yIEVtYmVyLlZpZXcgaXRzZWxmKSwKICAgICAgICAgICAgIG9yIGFuIGluc3RhbmNlIG9mIE1peGluLgogICAgICBAcmV0dXJuIEVtYmVyLlZpZXcKICAgICAgQGRlcHJlY2F0ZWQgdXNlIGB5aWVsZGAgYW5kIGNvbnRleHR1YWwgY29tcG9uZW50cyBmb3IgY29tcG9zaXRpb24gaW5zdGVhZC4KICAgICAgQHByaXZhdGUKICAgICovCiAgICBuZWFyZXN0T2ZUeXBlOiBmdW5jdGlvbiAoa2xhc3MpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLnBhcmVudFZpZXc7CiAgICAgIHZhciBpc09mVHlwZSA9IGtsYXNzIGluc3RhbmNlb2YgX2VtYmVyTWV0YWwuTWl4aW4gPyBmdW5jdGlvbiAodmlldykgewogICAgICAgIHJldHVybiBrbGFzcy5kZXRlY3Qodmlldyk7CiAgICAgIH0gOiBmdW5jdGlvbiAodmlldykgewogICAgICAgIHJldHVybiBrbGFzcy5kZXRlY3Qodmlldy5jb25zdHJ1Y3Rvcik7CiAgICAgIH07CgogICAgICB3aGlsZSAodmlldykgewogICAgICAgIGlmIChpc09mVHlwZSh2aWV3KSkgewogICAgICAgICAgcmV0dXJuIHZpZXc7CiAgICAgICAgfQogICAgICAgIHZpZXcgPSB2aWV3LnBhcmVudFZpZXc7CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICBSZXR1cm4gdGhlIG5lYXJlc3QgYW5jZXN0b3IgdGhhdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eS4KICAgICAgIEBtZXRob2QgbmVhcmVzdFdpdGhQcm9wZXJ0eQogICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcGVydHkgQSBwcm9wZXJ0eSBuYW1lCiAgICAgIEByZXR1cm4gRW1iZXIuVmlldwogICAgICBAZGVwcmVjYXRlZCB1c2UgYHlpZWxkYCBhbmQgY29udGV4dHVhbCBjb21wb25lbnRzIGZvciBjb21wb3NpdGlvbiBpbnN0ZWFkLgogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIG5lYXJlc3RXaXRoUHJvcGVydHk6IGZ1bmN0aW9uIChwcm9wZXJ0eSkgewogICAgICB2YXIgdmlldyA9IHRoaXMucGFyZW50VmlldzsKCiAgICAgIHdoaWxlICh2aWV3KSB7CiAgICAgICAgaWYgKHByb3BlcnR5IGluIHZpZXcpIHsKICAgICAgICAgIHJldHVybiB2aWV3OwogICAgICAgIH0KICAgICAgICB2aWV3ID0gdmlldy5wYXJlbnRWaWV3OwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAgUmVuZGVycyB0aGUgdmlldyBhZ2Fpbi4gVGhpcyB3aWxsIHdvcmsgcmVnYXJkbGVzcyBvZiB3aGV0aGVyIHRoZQogICAgICB2aWV3IGlzIGFscmVhZHkgaW4gdGhlIERPTSBvciBub3QuIElmIHRoZSB2aWV3IGlzIGluIHRoZSBET00sIHRoZQogICAgICByZW5kZXJpbmcgcHJvY2VzcyB3aWxsIGJlIGRlZmVycmVkIHRvIGdpdmUgYmluZGluZ3MgYSBjaGFuY2UKICAgICAgdG8gc3luY2hyb25pemUuCiAgICAgICBJZiBjaGlsZHJlbiB3ZXJlIGFkZGVkIGR1cmluZyB0aGUgcmVuZGVyaW5nIHByb2Nlc3MgdXNpbmcgYGFwcGVuZENoaWxkYCwKICAgICAgYHJlcmVuZGVyYCB3aWxsIHJlbW92ZSB0aGVtLCBiZWNhdXNlIHRoZXkgd2lsbCBiZSBhZGRlZCBhZ2FpbgogICAgICBpZiBuZWVkZWQgYnkgdGhlIG5leHQgYHJlbmRlcmAuCiAgICAgICBJbiBnZW5lcmFsLCBpZiB0aGUgZGlzcGxheSBvZiB5b3VyIHZpZXcgY2hhbmdlcywgeW91IHNob3VsZCBtb2RpZnkKICAgICAgdGhlIERPTSBlbGVtZW50IGRpcmVjdGx5IGluc3RlYWQgb2YgbWFudWFsbHkgY2FsbGluZyBgcmVyZW5kZXJgLCB3aGljaCBjYW4KICAgICAgYmUgc2xvdy4KICAgICAgIEBtZXRob2QgcmVyZW5kZXIKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHJlcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50U3RhdGUucmVyZW5kZXIodGhpcyk7CiAgICB9LAoKCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBFTEVNRU5UIFNVUFBPUlQKICAgIC8vCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIGN1cnJlbnQgRE9NIGVsZW1lbnQgZm9yIHRoZSB2aWV3LgogICAgICAgQHByb3BlcnR5IGVsZW1lbnQKICAgICAgQHR5cGUgRE9NRWxlbWVudAogICAgICBAcHVibGljCiAgICAqLwogICAgZWxlbWVudDogKDAsIF9lbWJlck1ldGFsLmRlc2NyaXB0b3IpKHsKICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnJlbmRlcmVyLmdldEVsZW1lbnQodGhpcyk7CiAgICAgIH0KICAgIH0pLAoKICAgIC8qKgogICAgICBSZXR1cm5zIGEgalF1ZXJ5IG9iamVjdCBmb3IgdGhpcyB2aWV3J3MgZWxlbWVudC4gSWYgeW91IHBhc3MgaW4gYSBzZWxlY3RvcgogICAgICBzdHJpbmcsIHRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGEgalF1ZXJ5IG9iamVjdCwgdXNpbmcgdGhlIGN1cnJlbnQgZWxlbWVudAogICAgICBhcyBpdHMgYnVmZmVyLgogICAgICAgRm9yIGV4YW1wbGUsIGNhbGxpbmcgYHZpZXcuJCgnbGknKWAgd2lsbCByZXR1cm4gYSBqUXVlcnkgb2JqZWN0IGNvbnRhaW5pbmcKICAgICAgYWxsIG9mIHRoZSBgbGlgIGVsZW1lbnRzIGluc2lkZSB0aGUgRE9NIGVsZW1lbnQgb2YgdGhpcyB2aWV3LgogICAgICAgQG1ldGhvZCAkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBbc2VsZWN0b3JdIGEgalF1ZXJ5LWNvbXBhdGlibGUgc2VsZWN0b3Igc3RyaW5nCiAgICAgIEByZXR1cm4ge2pRdWVyeX0gdGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBET00gbm9kZQogICAgICBAcHVibGljCiAgICAqLwogICAgJDogZnVuY3Rpb24gKHNlbCkgewogICAgICAodHJ1ZSAmJiAhKHRoaXMudGFnTmFtZSAhPT0gJycpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgiWW91IGNhbm5vdCBhY2Nlc3MgdGhpcy4kKCkgb24gYSBjb21wb25lbnQgd2l0aCBgdGFnTmFtZTogJydgIHNwZWNpZmllZC4iLCB0aGlzLnRhZ05hbWUgIT09ICcnKSk7CiAgICAgICh0cnVlICYmICEoIV9qcXVlcnkualF1ZXJ5RGlzYWJsZWQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBhY2Nlc3MgdGhpcy4kKCkgd2l0aCBgalF1ZXJ5YCBkaXNhYmxlZC4nLCAhX2pxdWVyeS5qUXVlcnlEaXNhYmxlZCkpOwoKICAgICAgaWYgKHRoaXMuZWxlbWVudCkgewogICAgICAgIHJldHVybiBzZWwgPyAoMCwgX2pxdWVyeS5kZWZhdWx0KShzZWwsIHRoaXMuZWxlbWVudCkgOiAoMCwgX2pxdWVyeS5kZWZhdWx0KSh0aGlzLmVsZW1lbnQpOwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAgQXBwZW5kcyB0aGUgdmlldydzIGVsZW1lbnQgdG8gdGhlIHNwZWNpZmllZCBwYXJlbnQgZWxlbWVudC4KICAgICAgIE5vdGUgdGhhdCB0aGlzIG1ldGhvZCBqdXN0IHNjaGVkdWxlcyB0aGUgdmlldyB0byBiZSBhcHBlbmRlZDsgdGhlIERPTQogICAgICBlbGVtZW50IHdpbGwgbm90IGJlIGFwcGVuZGVkIHRvIHRoZSBnaXZlbiBlbGVtZW50IHVudGlsIGFsbCBiaW5kaW5ncyBoYXZlCiAgICAgIGZpbmlzaGVkIHN5bmNocm9uaXppbmcuCiAgICAgICBUaGlzIGlzIG5vdCB0eXBpY2FsbHkgYSBmdW5jdGlvbiB0aGF0IHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBkaXJlY3RseSB3aGVuCiAgICAgIGJ1aWxkaW5nIHlvdXIgYXBwbGljYXRpb24uIElmIHlvdSBkbyBuZWVkIHRvIHVzZSBgYXBwZW5kVG9gLCBiZSBzdXJlIHRoYXQKICAgICAgdGhlIHRhcmdldCBlbGVtZW50IHlvdSBhcmUgcHJvdmlkaW5nIGlzIGFzc29jaWF0ZWQgd2l0aCBhbiBgQXBwbGljYXRpb25gCiAgICAgIGFuZCBkb2VzIG5vdCBoYXZlIGFuIGFuY2VzdG9yIGVsZW1lbnQgdGhhdCBpcyBhc3NvY2lhdGVkIHdpdGggYW4gRW1iZXIgdmlldy4KICAgICAgIEBtZXRob2QgYXBwZW5kVG8KICAgICAgQHBhcmFtIHtTdHJpbmd8RE9NRWxlbWVudHxqUXVlcnl9IEEgc2VsZWN0b3IsIGVsZW1lbnQsIEhUTUwgc3RyaW5nLCBvciBqUXVlcnkgb2JqZWN0CiAgICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYXBwZW5kVG86IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICB2YXIgdGFyZ2V0ID0gdm9pZCAwOwoKICAgICAgaWYgKF9lbWJlckJyb3dzZXJFbnZpcm9ubWVudC5oYXNET00pIHsKICAgICAgICB0YXJnZXQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnID8gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikgOiBzZWxlY3RvcjsKCiAgICAgICAgKHRydWUgJiYgISh0YXJnZXQpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IHRyaWVkIHRvIGFwcGVuZCB0byAoJyArIHNlbGVjdG9yICsgJykgYnV0IHRoYXQgaXNuXCd0IGluIHRoZSBET00nLCB0YXJnZXQpKTsKICAgICAgICAodHJ1ZSAmJiAhKCEoMCwgX3V0aWxzLm1hdGNoZXMpKHRhcmdldCwgJy5lbWJlci12aWV3JykpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBhcHBlbmQgdG8gYW4gZXhpc3RpbmcgRW1iZXIuVmlldy4nLCAhKDAsIF91dGlscy5tYXRjaGVzKSh0YXJnZXQsICcuZW1iZXItdmlldycpKSk7CiAgICAgICAgKHRydWUgJiYgIShmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgIT09IDkgJiYgKDAsIF91dGlscy5tYXRjaGVzKShub2RlLCAnLmVtYmVyLXZpZXcnKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9KCkpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnWW91IGNhbm5vdCBhcHBlbmQgdG8gYW4gZXhpc3RpbmcgRW1iZXIuVmlldy4nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldC5wYXJlbnROb2RlO3doaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlICE9PSA5ICYmICgwLCBfdXRpbHMubWF0Y2hlcykobm9kZSwgJy5lbWJlci12aWV3JykpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH1ub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfXJldHVybiB0cnVlOwogICAgICAgIH0oKSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRhcmdldCA9IHNlbGVjdG9yOwoKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiB0YXJnZXQgIT09ICdzdHJpbmcnKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSB0cmllZCB0byBhcHBlbmQgdG8gYSBzZWxlY3RvciBzdHJpbmcgKCcgKyBzZWxlY3RvciArICcpIGluIGFuIGVudmlyb25tZW50IHdpdGhvdXQgalF1ZXJ5JywgdHlwZW9mIHRhcmdldCAhPT0gJ3N0cmluZycpKTsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBzZWxlY3Rvci5hcHBlbmRDaGlsZCA9PT0gJ2Z1bmN0aW9uJykgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgdHJpZWQgdG8gYXBwZW5kIHRvIGEgbm9uLUVsZW1lbnQgKCcgKyBzZWxlY3RvciArICcpIGluIGFuIGVudmlyb25tZW50IHdpdGhvdXQgalF1ZXJ5JywgdHlwZW9mIHNlbGVjdG9yLmFwcGVuZENoaWxkID09PSAnZnVuY3Rpb24nKSk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kVG8odGhpcywgdGFyZ2V0KTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgLyoqCiAgICAgIEFwcGVuZHMgdGhlIHZpZXcncyBlbGVtZW50IHRvIHRoZSBkb2N1bWVudCBib2R5LiBJZiB0aGUgdmlldyBkb2VzCiAgICAgIG5vdCBoYXZlIGFuIEhUTUwgcmVwcmVzZW50YXRpb24geWV0CiAgICAgIHRoZSBlbGVtZW50IHdpbGwgYmUgZ2VuZXJhdGVkIGF1dG9tYXRpY2FsbHkuCiAgICAgICBJZiB5b3VyIGFwcGxpY2F0aW9uIHVzZXMgdGhlIGByb290RWxlbWVudGAgcHJvcGVydHksIHlvdSBtdXN0IGFwcGVuZAogICAgICB0aGUgdmlldyB3aXRoaW4gdGhhdCBlbGVtZW50LiBSZW5kZXJpbmcgdmlld3Mgb3V0c2lkZSBvZiB0aGUgYHJvb3RFbGVtZW50YAogICAgICBpcyBub3Qgc3VwcG9ydGVkLgogICAgICAgTm90ZSB0aGF0IHRoaXMgbWV0aG9kIGp1c3Qgc2NoZWR1bGVzIHRoZSB2aWV3IHRvIGJlIGFwcGVuZGVkOyB0aGUgRE9NCiAgICAgIGVsZW1lbnQgd2lsbCBub3QgYmUgYXBwZW5kZWQgdG8gdGhlIGRvY3VtZW50IGJvZHkgdW50aWwgYWxsIGJpbmRpbmdzIGhhdmUKICAgICAgZmluaXNoZWQgc3luY2hyb25pemluZy4KICAgICAgIEBtZXRob2QgYXBwZW5kCiAgICAgIEByZXR1cm4ge0VtYmVyLlZpZXd9IHJlY2VpdmVyCiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgYXBwZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwogICAgfSwKCgogICAgLyoqCiAgICAgIFRoZSBIVE1MIGBpZGAgb2YgdGhlIHZpZXcncyBlbGVtZW50IGluIHRoZSBET00uIFlvdSBjYW4gcHJvdmlkZSB0aGlzCiAgICAgIHZhbHVlIHlvdXJzZWxmIGJ1dCBpdCBtdXN0IGJlIHVuaXF1ZSAoanVzdCBhcyBpbiBIVE1MKToKICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAgICB7e215LWNvbXBvbmVudCBlbGVtZW50SWQ9ImEtcmVhbGx5LWNvb2wtaWQifX0KICAgICAgYGBgCiAgICAgICBJZiBub3QgbWFudWFsbHkgc2V0IGEgZGVmYXVsdCB2YWx1ZSB3aWxsIGJlIHByb3ZpZGVkIGJ5IHRoZSBmcmFtZXdvcmsuCiAgICAgICBPbmNlIHJlbmRlcmVkIGFuIGVsZW1lbnQncyBgZWxlbWVudElkYCBpcyBjb25zaWRlcmVkIGltbXV0YWJsZSBhbmQgeW91CiAgICAgIHNob3VsZCBuZXZlciBjaGFuZ2UgaXQuIElmIHlvdSBuZWVkIHRvIGNvbXB1dGUgYSBkeW5hbWljIHZhbHVlIGZvciB0aGUKICAgICAgYGVsZW1lbnRJZGAsIHlvdSBzaG91bGQgZG8gdGhpcyB3aGVuIHRoZSBjb21wb25lbnQgb3IgZWxlbWVudCBpcyBiZWluZwogICAgICBpbnN0YW50aWF0ZWQ6CiAgICAgICBgYGBhcHAvY29tcG9uZW50cy9teS1jb21wb25lbnQuanMKICAgICAgaW1wb3J0IENvbXBvbmVudCBmcm9tICdAZW1iZXIvY29tcG9uZW50JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IENvbXBvbmVudC5leHRlbmQoewogICAgICAgIGluaXQoKSB7CiAgICAgICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5nZXQoJ2luZGV4Jyk7CiAgICAgICAgICB0aGlzLnNldCgnZWxlbWVudElkJywgJ2NvbXBvbmVudC1pZCcgKyBpbmRleCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgZWxlbWVudElkCiAgICAgIEB0eXBlIFN0cmluZwogICAgICBAcHVibGljCiAgICAqLwogICAgZWxlbWVudElkOiBudWxsLAoKICAgIC8qKgogICAgICBBdHRlbXB0cyB0byBkaXNjb3ZlciB0aGUgZWxlbWVudCBpbiB0aGUgcGFyZW50IGVsZW1lbnQuIFRoZSBkZWZhdWx0CiAgICAgIGltcGxlbWVudGF0aW9uIGxvb2tzIGZvciBhbiBlbGVtZW50IHdpdGggYW4gSUQgb2YgYGVsZW1lbnRJZGAgKG9yIHRoZQogICAgICB2aWV3J3MgZ3VpZCBpZiBgZWxlbWVudElkYCBpcyBudWxsKS4gWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCB0bwogICAgICBwcm92aWRlIHlvdXIgb3duIGZvcm0gb2YgbG9va3VwLiBGb3IgZXhhbXBsZSwgaWYgeW91IHdhbnQgdG8gZGlzY292ZXIgeW91cgogICAgICBlbGVtZW50IHVzaW5nIGEgQ1NTIGNsYXNzIG5hbWUgaW5zdGVhZCBvZiBhbiBJRC4KICAgICAgIEBtZXRob2QgZmluZEVsZW1lbnRJblBhcmVudEVsZW1lbnQKICAgICAgQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnRFbGVtZW50IFRoZSBwYXJlbnQncyBET00gZWxlbWVudAogICAgICBAcmV0dXJuIHtET01FbGVtZW50fSBUaGUgZGlzY292ZXJlZCBlbGVtZW50CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgZmluZEVsZW1lbnRJblBhcmVudEVsZW1lbnQ6IGZ1bmN0aW9uIChwYXJlbnRFbGVtKSB7CiAgICAgIHZhciBpZCA9ICcjJyArIHRoaXMuZWxlbWVudElkOwogICAgICByZXR1cm4gKDAsIF9qcXVlcnkuZGVmYXVsdCkoaWQpWzBdIHx8ICgwLCBfanF1ZXJ5LmRlZmF1bHQpKGlkLCBwYXJlbnRFbGVtKVswXTsKICAgIH0sCgoKICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiBhIHZpZXcgaXMgZ29pbmcgdG8gaW5zZXJ0IGFuIGVsZW1lbnQgaW50byB0aGUgRE9NLgogICAgICAgQGV2ZW50IHdpbGxJbnNlcnRFbGVtZW50CiAgICAgIEBwdWJsaWMKICAgICovCiAgICB3aWxsSW5zZXJ0RWxlbWVudDogSywKCiAgICAvKioKICAgICAgQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgb2YgdGhlIHZpZXcgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NLgogICAgICBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGRvIGFueSBzZXQgdXAgdGhhdCByZXF1aXJlcyBhbiBlbGVtZW50CiAgICAgIGluIHRoZSBkb2N1bWVudCBib2R5LgogICAgICAgV2hlbiBhIHZpZXcgaGFzIGNoaWxkcmVuLCBkaWRJbnNlcnRFbGVtZW50IHdpbGwgYmUgY2FsbGVkIG9uIHRoZQogICAgICBjaGlsZCB2aWV3KHMpIGZpcnN0IGFuZCBvbiBpdHNlbGYgYWZ0ZXJ3YXJkcy4KICAgICAgIEBldmVudCBkaWRJbnNlcnRFbGVtZW50CiAgICAgIEBwdWJsaWMKICAgICovCiAgICBkaWRJbnNlcnRFbGVtZW50OiBLLAoKICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiB0aGUgdmlldyBpcyBhYm91dCB0byByZXJlbmRlciwgYnV0IGJlZm9yZSBhbnl0aGluZyBoYXMKICAgICAgYmVlbiB0b3JuIGRvd24uIFRoaXMgaXMgYSBnb29kIG9wcG9ydHVuaXR5IHRvIHRlYXIgZG93biBhbnkgbWFudWFsCiAgICAgIG9ic2VydmVycyB5b3UgaGF2ZSBpbnN0YWxsZWQgYmFzZWQgb24gdGhlIERPTSBzdGF0ZQogICAgICAgQGV2ZW50IHdpbGxDbGVhclJlbmRlcgogICAgICBAcHVibGljCiAgICAqLwogICAgd2lsbENsZWFyUmVuZGVyOiBLLAoKICAgIC8qKgogICAgICBZb3UgbXVzdCBjYWxsIGBkZXN0cm95YCBvbiBhIHZpZXcgdG8gZGVzdHJveSB0aGUgdmlldyAoYW5kIGFsbCBvZiBpdHMKICAgICAgY2hpbGQgdmlld3MpLiBUaGlzIHdpbGwgcmVtb3ZlIHRoZSB2aWV3IGZyb20gYW55IHBhcmVudCBub2RlLCB0aGVuIG1ha2UKICAgICAgc3VyZSB0aGF0IHRoZSBET00gZWxlbWVudCBtYW5hZ2VkIGJ5IHRoZSB2aWV3IGNhbiBiZSByZWxlYXNlZCBieSB0aGUKICAgICAgbWVtb3J5IG1hbmFnZXIuCiAgICAgICBAbWV0aG9kIGRlc3Ryb3kKICAgICAgQHByaXZhdGUKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuX2N1cnJlbnRTdGF0ZS5kZXN0cm95KHRoaXMpOwogICAgfSwKCgogICAgLyoqCiAgICAgIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IG9mIHRoZSB2aWV3IGlzIGdvaW5nIHRvIGJlIGRlc3Ryb3llZC4gT3ZlcnJpZGUKICAgICAgdGhpcyBmdW5jdGlvbiB0byBkbyBhbnkgdGVhcmRvd24gdGhhdCByZXF1aXJlcyBhbiBlbGVtZW50LCBsaWtlIHJlbW92aW5nCiAgICAgIGV2ZW50IGxpc3RlbmVycy4KICAgICAgIFBsZWFzZSBub3RlOiBhbnkgcHJvcGVydHkgY2hhbmdlcyBtYWRlIGR1cmluZyB0aGlzIGV2ZW50IHdpbGwgaGF2ZSBubwogICAgICBlZmZlY3Qgb24gb2JqZWN0IG9ic2VydmVycy4KICAgICAgIEBldmVudCB3aWxsRGVzdHJveUVsZW1lbnQKICAgICAgQHB1YmxpYwogICAgKi8KICAgIHdpbGxEZXN0cm95RWxlbWVudDogSywKCiAgICAvKioKICAgICAgQ2FsbGVkIHdoZW4gdGhlIHBhcmVudFZpZXcgcHJvcGVydHkgaGFzIGNoYW5nZWQuCiAgICAgICBAZXZlbnQgcGFyZW50Vmlld0RpZENoYW5nZQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHBhcmVudFZpZXdEaWRDaGFuZ2U6IEssCgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gU1RBTkRBUkQgUkVOREVSIFBST1BFUlRJRVMKICAgIC8vCgogICAgLyoqCiAgICAgIFRhZyBuYW1lIGZvciB0aGUgdmlldydzIG91dGVyIGVsZW1lbnQuIFRoZSB0YWcgbmFtZSBpcyBvbmx5IHVzZWQgd2hlbiBhbgogICAgICBlbGVtZW50IGlzIGZpcnN0IGNyZWF0ZWQuIElmIHlvdSBjaGFuZ2UgdGhlIGB0YWdOYW1lYCBmb3IgYW4gZWxlbWVudCwgeW91CiAgICAgIG11c3QgZGVzdHJveSBhbmQgcmVjcmVhdGUgdGhlIHZpZXcgZWxlbWVudC4KICAgICAgIEJ5IGRlZmF1bHQsIHRoZSByZW5kZXIgYnVmZmVyIHdpbGwgdXNlIGEgYDxkaXY+YCB0YWcgZm9yIHZpZXdzLgogICAgICAgQHByb3BlcnR5IHRhZ05hbWUKICAgICAgQHR5cGUgU3RyaW5nCiAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgQHB1YmxpYwogICAgKi8KCiAgICAvLyBXZSBsZWF2ZSB0aGlzIG51bGwgYnkgZGVmYXVsdCBzbyB3ZSBjYW4gdGVsbCB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuCiAgICAvLyB0aGUgZGVmYXVsdCBjYXNlIGFuZCBhIHVzZXItc3BlY2lmaWVkIHRhZy4KICAgIHRhZ05hbWU6IG51bGwsCgogICAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogICAgLy8gQ09SRSBESVNQTEFZIE1FVEhPRFMKICAgIC8vCgogICAgLyoqCiAgICAgIFNldHVwIGEgdmlldywgYnV0IGRvIG5vdCBmaW5pc2ggd2FraW5nIGl0IHVwLgogICAgICAgKiBjb25maWd1cmUgYGNoaWxkVmlld3NgCiAgICAgICogcmVnaXN0ZXIgdGhlIHZpZXcgd2l0aCB0aGUgZ2xvYmFsIHZpZXdzIGhhc2gsIHdoaWNoIGlzIHVzZWQgZm9yIGV2ZW50CiAgICAgICAgZGlzcGF0Y2gKICAgICAgIEBtZXRob2QgaW5pdAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGgKICAgICAgKHRydWUgJiYgISgoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKSh0aGlzLCAnZWxlbWVudElkJykgPT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSBhIGNvbXB1dGVkIHByb3BlcnR5IGZvciB0aGUgY29tcG9uZW50XCdzIGBlbGVtZW50SWRgICgnICsgdGhpcyArICcpLicsICgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKHRoaXMsICdlbGVtZW50SWQnKSA9PT0gdW5kZWZpbmVkKSk7CgogICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoCgogICAgICAodHJ1ZSAmJiAhKCgwLCBfZW1iZXJNZXRhLmRlc2NyaXB0b3JGb3IpKHRoaXMsICd0YWdOYW1lJykgPT09IHVuZGVmaW5lZCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSBhIGNvbXB1dGVkIHByb3BlcnR5IGZvciB0aGUgY29tcG9uZW50XCdzIGB0YWdOYW1lYCAoJyArIHRoaXMgKyAnKS4nLCAoMCwgX2VtYmVyTWV0YS5kZXNjcmlwdG9yRm9yKSh0aGlzLCAndGFnTmFtZScpID09PSB1bmRlZmluZWQpKTsKCgogICAgICBpZiAoIXRoaXMuZWxlbWVudElkICYmIHRoaXMudGFnTmFtZSAhPT0gJycpIHsKICAgICAgICB0aGlzLmVsZW1lbnRJZCA9ICgwLCBfZW1iZXJVdGlscy5ndWlkRm9yKSh0aGlzKTsKICAgICAgfQoKICAgICAgKHRydWUgJiYgISghdGhpcy5yZW5kZXIpICYmICgwLCBfZGVidWcuYXNzZXJ0KSgnVXNpbmcgYSBjdXN0b20gYC5yZW5kZXJgIGZ1bmN0aW9uIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuJywgIXRoaXMucmVuZGVyKSk7CiAgICB9LAoKCiAgICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAvLyBFVkVOVCBIQU5ETElORwogICAgLy8KCiAgICAvKioKICAgICAgSGFuZGxlIGV2ZW50cyBmcm9tIGBFdmVudERpc3BhdGNoZXJgCiAgICAgICBAbWV0aG9kIGhhbmRsZUV2ZW50CiAgICAgIEBwYXJhbSBldmVudE5hbWUge1N0cmluZ30KICAgICAgQHBhcmFtIGV2dCB7RXZlbnR9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uIChldmVudE5hbWUsIGV2dCkgewogICAgICByZXR1cm4gdGhpcy5fY3VycmVudFN0YXRlLmhhbmRsZUV2ZW50KHRoaXMsIGV2ZW50TmFtZSwgZXZ0KTsKICAgIH0KICB9KTsKfSk7CmVuaWZlZCgiZW1iZXItdmlld3MvbGliL3N5c3RlbS9hY3Rpb25fbWFuYWdlciIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gQWN0aW9uTWFuYWdlcjsKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgZnVuY3Rpb24gQWN0aW9uTWFuYWdlcigpIHt9CgogIC8qKgogICAgR2xvYmFsIGFjdGlvbiBpZCBoYXNoLgogIAogICAgQHByaXZhdGUKICAgIEBwcm9wZXJ0eSByZWdpc3RlcmVkQWN0aW9ucwogICAgQHR5cGUgT2JqZWN0CiAgKi8KICBBY3Rpb25NYW5hZ2VyLnJlZ2lzdGVyZWRBY3Rpb25zID0ge307Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vZXZlbnRfZGlzcGF0Y2hlcicsIFsnZXhwb3J0cycsICdlbWJlci1vd25lcicsICdAZW1iZXIvcG9seWZpbGxzJywgJ0BlbWJlci9kZWJ1ZycsICdlbWJlci1tZXRhbCcsICdlbWJlci1ydW50aW1lJywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5JywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vYWN0aW9uX21hbmFnZXInLCAnZW1iZXItdmlld3MvbGliL2NvbXBhdC9mYWxsYmFjay12aWV3LXJlZ2lzdHJ5JywgJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5X2V2ZW50X2RlcHJlY2F0aW9uJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJPd25lciwgX3BvbHlmaWxscywgX2RlYnVnLCBfZW1iZXJNZXRhbCwgX2VtYmVyUnVudGltZSwgX2pxdWVyeSwgX2FjdGlvbl9tYW5hZ2VyLCBfZmFsbGJhY2tWaWV3UmVnaXN0cnksIF9qcXVlcnlfZXZlbnRfZGVwcmVjYXRpb24pIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogIEBtb2R1bGUgZW1iZXIKICAqLwoKICB2YXIgUk9PVF9FTEVNRU5UX0NMQVNTID0gJ2VtYmVyLWFwcGxpY2F0aW9uJzsKICB2YXIgUk9PVF9FTEVNRU5UX1NFTEVDVE9SID0gJy4nICsgUk9PVF9FTEVNRU5UX0NMQVNTOwoKICAvKioKICAgIGBFbWJlci5FdmVudERpc3BhdGNoZXJgIGhhbmRsZXMgZGVsZWdhdGluZyBicm93c2VyIGV2ZW50cyB0byB0aGVpcgogICAgY29ycmVzcG9uZGluZyBgRW1iZXIuVmlld3MuYCBGb3IgZXhhbXBsZSwgd2hlbiB5b3UgY2xpY2sgb24gYSB2aWV3LAogICAgYEVtYmVyLkV2ZW50RGlzcGF0Y2hlcmAgZW5zdXJlcyB0aGF0IHRoYXQgdmlldydzIGBtb3VzZURvd25gIG1ldGhvZCBnZXRzCiAgICBjYWxsZWQuCiAgCiAgICBAY2xhc3MgRXZlbnREaXNwYXRjaGVyCiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAcHJpdmF0ZQogICAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0CiAgKi8KICBleHBvcnRzLmRlZmF1bHQgPSBfZW1iZXJSdW50aW1lLk9iamVjdC5leHRlbmQoewogICAgLyoqCiAgICAgIFRoZSBzZXQgb2YgZXZlbnRzIG5hbWVzIChhbmQgYXNzb2NpYXRlZCBoYW5kbGVyIGZ1bmN0aW9uIG5hbWVzKSB0byBiZSBzZXR1cAogICAgICBhbmQgZGlzcGF0Y2hlZCBieSB0aGUgYEV2ZW50RGlzcGF0Y2hlcmAuIE1vZGlmaWNhdGlvbnMgdG8gdGhpcyBsaXN0IGNhbiBiZSBkb25lCiAgICAgIGF0IHNldHVwIHRpbWUsIGdlbmVyYWxseSB2aWEgdGhlIGBBcHBsaWNhdGlvbi5jdXN0b21FdmVudHNgIGhhc2guCiAgICAgICBUbyBhZGQgbmV3IGV2ZW50cyB0byBiZSBsaXN0ZW5lZCB0bzoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgaW1wb3J0IEFwcGxpY2F0aW9uIGZyb20gJ0BlbWJlci9hcHBsaWNhdGlvbic7CiAgICAgICBsZXQgQXBwID0gQXBwbGljYXRpb24uY3JlYXRlKHsKICAgICAgICBjdXN0b21FdmVudHM6IHsKICAgICAgICAgIHBhc3RlOiAncGFzdGUnCiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUbyBwcmV2ZW50IGRlZmF1bHQgZXZlbnRzIGZyb20gYmVpbmcgbGlzdGVuZWQgdG86CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAZW1iZXIvYXBwbGljYXRpb24nOwogICAgICAgbGV0IEFwcCA9IEFwcGxpY2F0aW9uLmNyZWF0ZSh7CiAgICAgICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgICAgICBtb3VzZWVudGVyOiBudWxsLAogICAgICAgICAgbW91c2VsZWF2ZTogbnVsbAogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICBAcHJvcGVydHkgZXZlbnRzCiAgICAgIEB0eXBlIE9iamVjdAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIGV2ZW50czogewogICAgICB0b3VjaHN0YXJ0OiAndG91Y2hTdGFydCcsCiAgICAgIHRvdWNobW92ZTogJ3RvdWNoTW92ZScsCiAgICAgIHRvdWNoZW5kOiAndG91Y2hFbmQnLAogICAgICB0b3VjaGNhbmNlbDogJ3RvdWNoQ2FuY2VsJywKICAgICAga2V5ZG93bjogJ2tleURvd24nLAogICAgICBrZXl1cDogJ2tleVVwJywKICAgICAga2V5cHJlc3M6ICdrZXlQcmVzcycsCiAgICAgIG1vdXNlZG93bjogJ21vdXNlRG93bicsCiAgICAgIG1vdXNldXA6ICdtb3VzZVVwJywKICAgICAgY29udGV4dG1lbnU6ICdjb250ZXh0TWVudScsCiAgICAgIGNsaWNrOiAnY2xpY2snLAogICAgICBkYmxjbGljazogJ2RvdWJsZUNsaWNrJywKICAgICAgbW91c2Vtb3ZlOiAnbW91c2VNb3ZlJywKICAgICAgZm9jdXNpbjogJ2ZvY3VzSW4nLAogICAgICBmb2N1c291dDogJ2ZvY3VzT3V0JywKICAgICAgbW91c2VlbnRlcjogJ21vdXNlRW50ZXInLAogICAgICBtb3VzZWxlYXZlOiAnbW91c2VMZWF2ZScsCiAgICAgIHN1Ym1pdDogJ3N1Ym1pdCcsCiAgICAgIGlucHV0OiAnaW5wdXQnLAogICAgICBjaGFuZ2U6ICdjaGFuZ2UnLAogICAgICBkcmFnc3RhcnQ6ICdkcmFnU3RhcnQnLAogICAgICBkcmFnOiAnZHJhZycsCiAgICAgIGRyYWdlbnRlcjogJ2RyYWdFbnRlcicsCiAgICAgIGRyYWdsZWF2ZTogJ2RyYWdMZWF2ZScsCiAgICAgIGRyYWdvdmVyOiAnZHJhZ092ZXInLAogICAgICBkcm9wOiAnZHJvcCcsCiAgICAgIGRyYWdlbmQ6ICdkcmFnRW5kJwogICAgfSwKCiAgICAvKioKICAgICAgVGhlIHJvb3QgRE9NIGVsZW1lbnQgdG8gd2hpY2ggZXZlbnQgbGlzdGVuZXJzIHNob3VsZCBiZSBhdHRhY2hlZC4gRXZlbnQKICAgICAgbGlzdGVuZXJzIHdpbGwgYmUgYXR0YWNoZWQgdG8gdGhlIGRvY3VtZW50IHVubGVzcyB0aGlzIGlzIG92ZXJyaWRkZW4uCiAgICAgICBDYW4gYmUgc3BlY2lmaWVkIGFzIGEgRE9NRWxlbWVudCBvciBhIHNlbGVjdG9yIHN0cmluZy4KICAgICAgIFRoZSBkZWZhdWx0IGJvZHkgaXMgYSBzdHJpbmcgc2luY2UgdGhpcyBtYXkgYmUgZXZhbHVhdGVkIGJlZm9yZSBkb2N1bWVudC5ib2R5CiAgICAgIGV4aXN0cyBpbiB0aGUgRE9NLgogICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5IHJvb3RFbGVtZW50CiAgICAgIEB0eXBlIERPTUVsZW1lbnQKICAgICAgQGRlZmF1bHQgJ2JvZHknCiAgICAqLwogICAgcm9vdEVsZW1lbnQ6ICdib2R5JywKCiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICB0aGlzLl9zdXBlcigpOwoKICAgICAgKHRydWUgJiYgIShmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKShfdGhpcyk7CiAgICAgICAgdmFyIGVudmlyb25tZW50ID0gb3duZXIubG9va3VwKCctZW52aXJvbm1lbnQ6bWFpbicpOwoKICAgICAgICByZXR1cm4gZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZTsKICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0V2ZW50RGlzcGF0Y2hlciBzaG91bGQgbmV2ZXIgYmUgaW5zdGFudGlhdGVkIGluIGZhc3Rib290IG1vZGUuIFBsZWFzZSByZXBvcnQgdGhpcyBhcyBhbiBFbWJlciBidWcuJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBvd25lciA9ICgwLCBfZW1iZXJPd25lci5nZXRPd25lcikoX3RoaXMpO3ZhciBlbnZpcm9ubWVudCA9IG93bmVyLmxvb2t1cCgnLWVudmlyb25tZW50Om1haW4nKTtyZXR1cm4gZW52aXJvbm1lbnQuaXNJbnRlcmFjdGl2ZTsKICAgICAgfSgpKSk7CgoKICAgICAgdGhpcy5fZXZlbnRIYW5kbGVycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9LAoKCiAgICAvKioKICAgICAgU2V0cyB1cCBldmVudCBsaXN0ZW5lcnMgZm9yIHN0YW5kYXJkIGJyb3dzZXIgZXZlbnRzLgogICAgICAgVGhpcyB3aWxsIGJlIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBzZW5kcyBhIGBET01Db250ZW50UmVhZHlgIGV2ZW50LiBCeQogICAgICBkZWZhdWx0LCBpdCB3aWxsIHNldCB1cCBhbGwgb2YgdGhlIGxpc3RlbmVycyBvbiB0aGUgZG9jdW1lbnQgYm9keS4gSWYgeW91CiAgICAgIHdvdWxkIGxpa2UgdG8gcmVnaXN0ZXIgdGhlIGxpc3RlbmVycyBvbiBhIGRpZmZlcmVudCBlbGVtZW50LCBzZXQgdGhlIGV2ZW50CiAgICAgIGRpc3BhdGNoZXIncyBgcm9vdGAgcHJvcGVydHkuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldHVwCiAgICAgIEBwYXJhbSBhZGRlZEV2ZW50cyB7T2JqZWN0fQogICAgKi8KICAgIHNldHVwOiBmdW5jdGlvbiAoYWRkZWRFdmVudHMsIF9yb290RWxlbWVudCkgewogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZmluYWxFdmVudHMgPSAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKHt9LCAoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAnZXZlbnRzJyksIGFkZGVkRXZlbnRzKTsKCiAgICAgIGlmIChfcm9vdEVsZW1lbnQgIT09IHVuZGVmaW5lZCAmJiBfcm9vdEVsZW1lbnQgIT09IG51bGwpIHsKICAgICAgICAoMCwgX2VtYmVyTWV0YWwuc2V0KSh0aGlzLCAncm9vdEVsZW1lbnQnLCBfcm9vdEVsZW1lbnQpOwogICAgICB9CgogICAgICB2YXIgcm9vdEVsZW1lbnRTZWxlY3RvciA9ICgwLCBfZW1iZXJNZXRhbC5nZXQpKHRoaXMsICdyb290RWxlbWVudCcpOwogICAgICB2YXIgcm9vdEVsZW1lbnQgPSB2b2lkIDA7CiAgICAgIGlmIChfanF1ZXJ5LmpRdWVyeURpc2FibGVkKSB7CiAgICAgICAgaWYgKHR5cGVvZiByb290RWxlbWVudFNlbGVjdG9yICE9PSAnc3RyaW5nJykgewogICAgICAgICAgcm9vdEVsZW1lbnQgPSByb290RWxlbWVudFNlbGVjdG9yOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByb290RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iocm9vdEVsZW1lbnRTZWxlY3Rvcik7CiAgICAgICAgfQoKICAgICAgICAodHJ1ZSAmJiAhKCFyb290RWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoUk9PVF9FTEVNRU5UX0NMQVNTKSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IHVzZSB0aGUgc2FtZSByb290IGVsZW1lbnQgKCcgKyAoKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3Jvb3RFbGVtZW50JykgfHwgcm9vdEVsZW1lbnQudGFnTmFtZSkgKyAnKSBtdWx0aXBsZSB0aW1lcyBpbiBhbiBFbWJlci5BcHBsaWNhdGlvbicsICFyb290RWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoUk9PVF9FTEVNRU5UX0NMQVNTKSkpOwogICAgICAgICh0cnVlICYmICEoZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHJvb3RFbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKFJPT1RfRUxFTUVOVF9DTEFTUykpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgfSB3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PT0gMSk7CgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSgpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgbWFrZSBhIG5ldyBFbWJlci5BcHBsaWNhdGlvbiB1c2luZyBhIHJvb3QgZWxlbWVudCB0aGF0IGlzIGEgZGVzY2VuZGVudCBvZiBhbiBleGlzdGluZyBFbWJlci5BcHBsaWNhdGlvbicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSByb290RWxlbWVudC5wYXJlbnROb2RlO2RvIHsKICAgICAgICAgICAgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoUk9PVF9FTEVNRU5UX0NMQVNTKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgfSB3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PT0gMSk7cmV0dXJuIHRydWU7CiAgICAgICAgfSgpKSk7CiAgICAgICAgKHRydWUgJiYgISghcm9vdEVsZW1lbnQucXVlcnlTZWxlY3RvcihST09UX0VMRU1FTlRfU0VMRUNUT1IpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgbWFrZSBhIG5ldyBFbWJlci5BcHBsaWNhdGlvbiB1c2luZyBhIHJvb3QgZWxlbWVudCB0aGF0IGlzIGFuIGFuY2VzdG9yIG9mIGFuIGV4aXN0aW5nIEVtYmVyLkFwcGxpY2F0aW9uJywgIXJvb3RFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoUk9PVF9FTEVNRU5UX1NFTEVDVE9SKSkpOwoKCiAgICAgICAgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LmFkZChST09UX0VMRU1FTlRfQ0xBU1MpOwoKICAgICAgICAodHJ1ZSAmJiAhKHJvb3RFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhST09UX0VMRU1FTlRfQ0xBU1MpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1VuYWJsZSB0byBhZGQgXCcnICsgUk9PVF9FTEVNRU5UX0NMQVNTICsgJ1wnIGNsYXNzIHRvIHJvb3QgZWxlbWVudCAoJyArICgoMCwgX2VtYmVyTWV0YWwuZ2V0KSh0aGlzLCAncm9vdEVsZW1lbnQnKSB8fCByb290RWxlbWVudC50YWdOYW1lKSArICcpLiBNYWtlIHN1cmUgeW91IHNldCByb290RWxlbWVudCB0byB0aGUgYm9keSBvciBhbiBlbGVtZW50IGluIHRoZSBib2R5LicsIHJvb3RFbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhST09UX0VMRU1FTlRfQ0xBU1MpKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVsZW1lbnQgPSAoMCwgX2pxdWVyeS5kZWZhdWx0KShyb290RWxlbWVudFNlbGVjdG9yKTsKICAgICAgICAodHJ1ZSAmJiAhKCFyb290RWxlbWVudC5pcyhST09UX0VMRU1FTlRfU0VMRUNUT1IpKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgdXNlIHRoZSBzYW1lIHJvb3QgZWxlbWVudCAoJyArIChyb290RWxlbWVudC5zZWxlY3RvciB8fCByb290RWxlbWVudFswXS50YWdOYW1lKSArICcpIG11bHRpcGxlIHRpbWVzIGluIGFuIEVtYmVyLkFwcGxpY2F0aW9uJywgIXJvb3RFbGVtZW50LmlzKFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikpKTsKICAgICAgICAodHJ1ZSAmJiAhKCFyb290RWxlbWVudC5jbG9zZXN0KFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikubGVuZ3RoKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1lvdSBjYW5ub3QgbWFrZSBhIG5ldyBFbWJlci5BcHBsaWNhdGlvbiB1c2luZyBhIHJvb3QgZWxlbWVudCB0aGF0IGlzIGEgZGVzY2VuZGVudCBvZiBhbiBleGlzdGluZyBFbWJlci5BcHBsaWNhdGlvbicsICFyb290RWxlbWVudC5jbG9zZXN0KFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikubGVuZ3RoKSk7CiAgICAgICAgKHRydWUgJiYgISghcm9vdEVsZW1lbnQuZmluZChST09UX0VMRU1FTlRfU0VMRUNUT1IpLmxlbmd0aCkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCdZb3UgY2Fubm90IG1ha2UgYSBuZXcgRW1iZXIuQXBwbGljYXRpb24gdXNpbmcgYSByb290IGVsZW1lbnQgdGhhdCBpcyBhbiBhbmNlc3RvciBvZiBhbiBleGlzdGluZyBFbWJlci5BcHBsaWNhdGlvbicsICFyb290RWxlbWVudC5maW5kKFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikubGVuZ3RoKSk7CgoKICAgICAgICByb290RWxlbWVudC5hZGRDbGFzcyhST09UX0VMRU1FTlRfQ0xBU1MpOwoKICAgICAgICBpZiAoIXJvb3RFbGVtZW50LmlzKFJPT1RfRUxFTUVOVF9TRUxFQ1RPUikpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1VuYWJsZSB0byBhZGQgXCcnICsgUk9PVF9FTEVNRU5UX0NMQVNTICsgJ1wnIGNsYXNzIHRvIHJvb3QgZWxlbWVudCAoJyArIChyb290RWxlbWVudC5zZWxlY3RvciB8fCByb290RWxlbWVudFswXS50YWdOYW1lKSArICcpLiBNYWtlIHN1cmUgeW91IHNldCByb290RWxlbWVudCB0byB0aGUgYm9keSBvciBhbiBlbGVtZW50IGluIHRoZSBib2R5LicpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHZpZXdSZWdpc3RyeSA9IHRoaXMuX2dldFZpZXdSZWdpc3RyeSgpOwoKICAgICAgZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB7CiAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShldmVudCkpIHsKICAgICAgICAgIHRoaXMuc2V0dXBIYW5kbGVyKHJvb3RFbGVtZW50LCBldmVudCwgZXZlbnRzW2V2ZW50XSwgdmlld1JlZ2lzdHJ5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgoKICAgIC8qKgogICAgICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgb24gdGhlIHJvb3RFbGVtZW50LiBJZiB0aGUgZ2l2ZW4gZXZlbnQgaXMKICAgICAgdHJpZ2dlcmVkLCB0aGUgcHJvdmlkZWQgZXZlbnQgaGFuZGxlciB3aWxsIGJlIHRyaWdnZXJlZCBvbiB0aGUgdGFyZ2V0IHZpZXcuCiAgICAgICBJZiB0aGUgdGFyZ2V0IHZpZXcgZG9lcyBub3QgaW1wbGVtZW50IHRoZSBldmVudCBoYW5kbGVyLCBvciBpZiB0aGUgaGFuZGxlcgogICAgICByZXR1cm5zIGBmYWxzZWAsIHRoZSBwYXJlbnQgdmlldyB3aWxsIGJlIGNhbGxlZC4gVGhlIGV2ZW50IHdpbGwgY29udGludWUgdG8KICAgICAgYnViYmxlIHRvIGVhY2ggc3VjY2Vzc2l2ZSBwYXJlbnQgdmlldyB1bnRpbCBpdCByZWFjaGVzIHRoZSB0b3AuCiAgICAgICBAcHJpdmF0ZQogICAgICBAbWV0aG9kIHNldHVwSGFuZGxlcgogICAgICBAcGFyYW0ge0VsZW1lbnR9IHJvb3RFbGVtZW50CiAgICAgIEBwYXJhbSB7U3RyaW5nfSBldmVudCB0aGUgYnJvd3Nlci1vcmlnaW5hdGVkIGV2ZW50IHRvIGxpc3RlbiB0bwogICAgICBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QgdG8gY2FsbCBvbiB0aGUgdmlldwogICAgICBAcGFyYW0ge09iamVjdH0gdmlld1JlZ2lzdHJ5CiAgICAqLwogICAgc2V0dXBIYW5kbGVyOiBmdW5jdGlvbiAocm9vdEVsZW1lbnQsIGV2ZW50LCBldmVudE5hbWUsIHZpZXdSZWdpc3RyeSkgewogICAgICBpZiAoZXZlbnROYW1lID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoX2pxdWVyeS5qUXVlcnlEaXNhYmxlZCkgewogICAgICAgIHZhciB2aWV3SGFuZGxlciA9IGZ1bmN0aW9uICh0YXJnZXQsIGV2ZW50KSB7CiAgICAgICAgICB2YXIgdmlldyA9IHZpZXdSZWdpc3RyeVt0YXJnZXQuaWRdOwogICAgICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CgogICAgICAgICAgaWYgKHZpZXcpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdmlldy5oYW5kbGVFdmVudChldmVudE5hbWUsIGV2ZW50KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CgogICAgICAgIHZhciBhY3Rpb25IYW5kbGVyID0gZnVuY3Rpb24gKHRhcmdldCwgZXZlbnQpIHsKICAgICAgICAgIHZhciBhY3Rpb25JZCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtZW1iZXItYWN0aW9uJyk7CiAgICAgICAgICB2YXIgYWN0aW9ucyA9IF9hY3Rpb25fbWFuYWdlci5kZWZhdWx0LnJlZ2lzdGVyZWRBY3Rpb25zW2FjdGlvbklkXTsKCiAgICAgICAgICAvLyBJbiBHbGltbWVyMiB0aGlzIGF0dHJpYnV0ZSBpcyBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nIGFuZCBhbiBhZGRpdGlvbmFsCiAgICAgICAgICAvLyBhdHRyaWJ1dGUgaXQgc2V0IGZvciBlYWNoIGFjdGlvbiBvbiBhIGdpdmVuIGVsZW1lbnQuIEluIHRoaXMgY2FzZSwgdGhlCiAgICAgICAgICAvLyBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUgcmVhZCBzbyB0aGF0IGEgcHJvcGVyIHNldCBvZiBhY3Rpb24gaGFuZGxlcnMgY2FuCiAgICAgICAgICAvLyBiZSBjb2FsZXNjZWQuCiAgICAgICAgICBpZiAoYWN0aW9uSWQgPT09ICcnKSB7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gdGFyZ2V0LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVDb3VudCA9IGF0dHJpYnV0ZXMubGVuZ3RoOwoKICAgICAgICAgICAgYWN0aW9ucyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdHRyaWJ1dGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGF0dHIgPSBhdHRyaWJ1dGVzLml0ZW0oaSk7CiAgICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYXR0ci5uYW1lOwoKICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUuaW5kZXhPZignZGF0YS1lbWJlci1hY3Rpb24tJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGFjdGlvbnMgPSBhY3Rpb25zLmNvbmNhdChfYWN0aW9uX21hbmFnZXIuZGVmYXVsdC5yZWdpc3RlcmVkQWN0aW9uc1thdHRyLnZhbHVlXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gV2UgaGF2ZSB0byBjaGVjayBmb3IgYWN0aW9ucyBoZXJlIHNpbmNlIGluIHNvbWUgY2FzZXMsIGpRdWVyeSB3aWxsIHRyaWdnZXIKICAgICAgICAgIC8vIGFuIGV2ZW50IG9uIGByZW1vdmVDaGlsZGAgKGkuZS4gZm9jdXNvdXQpIGFmdGVyIHdlJ3ZlIGFscmVhZHkgdG9ybiBkb3duIHRoZQogICAgICAgICAgLy8gYWN0aW9uIGhhbmRsZXJzIGZvciB0aGUgdmlldy4KICAgICAgICAgIGlmICghYWN0aW9ucykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IGFjdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIHZhciBhY3Rpb24gPSBhY3Rpb25zW2luZGV4XTsKCiAgICAgICAgICAgIGlmIChhY3Rpb24gJiYgYWN0aW9uLmV2ZW50TmFtZSA9PT0gZXZlbnROYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFjdGlvbi5oYW5kbGVyKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBoYW5kbGVFdmVudCA9IHRoaXMuX2V2ZW50SGFuZGxlcnNbZXZlbnRdID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgaWYgKHZpZXdSZWdpc3RyeVt0YXJnZXQuaWRdKSB7CiAgICAgICAgICAgICAgaWYgKHZpZXdIYW5kbGVyKHRhcmdldCwgZXZlbnQpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldC5oYXNBdHRyaWJ1dGUoJ2RhdGEtZW1iZXItYWN0aW9uJykpIHsKICAgICAgICAgICAgICBpZiAoYWN0aW9uSGFuZGxlcih0YXJnZXQsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICB9IHdoaWxlICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVUeXBlID09PSAxKTsKICAgICAgICB9OwoKICAgICAgICByb290RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBoYW5kbGVFdmVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVsZW1lbnQub24oZXZlbnQgKyAnLmVtYmVyJywgJy5lbWJlci12aWV3JywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgdmFyIHZpZXcgPSB2aWV3UmVnaXN0cnlbdGhpcy5pZF07CiAgICAgICAgICB2YXIgcmVzdWx0ID0gdHJ1ZTsKCiAgICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICByZXN1bHQgPSB2aWV3LmhhbmRsZUV2ZW50KGV2ZW50TmFtZSwgKDAsIF9qcXVlcnlfZXZlbnRfZGVwcmVjYXRpb24uZGVmYXVsdCkoZXZ0KSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9KTsKCiAgICAgICAgcm9vdEVsZW1lbnQub24oZXZlbnQgKyAnLmVtYmVyJywgJ1tkYXRhLWVtYmVyLWFjdGlvbl0nLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGV2dC5jdXJyZW50VGFyZ2V0LmF0dHJpYnV0ZXM7CiAgICAgICAgICB2YXIgaGFuZGxlZEFjdGlvbnMgPSBbXTsKCiAgICAgICAgICBldnQgPSAoMCwgX2pxdWVyeV9ldmVudF9kZXByZWNhdGlvbi5kZWZhdWx0KShldnQpOwoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYXR0ciA9IGF0dHJpYnV0ZXMuaXRlbShpKTsKICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gYXR0ci5uYW1lOwoKICAgICAgICAgICAgaWYgKGF0dHJOYW1lLmxhc3RJbmRleE9mKCdkYXRhLWVtYmVyLWFjdGlvbi0nLCAwKSAhPT0gLTEpIHsKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gX2FjdGlvbl9tYW5hZ2VyLmRlZmF1bHQucmVnaXN0ZXJlZEFjdGlvbnNbYXR0ci52YWx1ZV07CgogICAgICAgICAgICAgIC8vIFdlIGhhdmUgdG8gY2hlY2sgZm9yIGFjdGlvbiBoZXJlIHNpbmNlIGluIHNvbWUgY2FzZXMsIGpRdWVyeSB3aWxsIHRyaWdnZXIKICAgICAgICAgICAgICAvLyBhbiBldmVudCBvbiBgcmVtb3ZlQ2hpbGRgIChpLmUuIGZvY3Vzb3V0KSBhZnRlciB3ZSd2ZSBhbHJlYWR5IHRvcm4gZG93biB0aGUKICAgICAgICAgICAgICAvLyBhY3Rpb24gaGFuZGxlcnMgZm9yIHRoZSB2aWV3LgogICAgICAgICAgICAgIGlmIChhY3Rpb24gJiYgYWN0aW9uLmV2ZW50TmFtZSA9PT0gZXZlbnROYW1lICYmIGhhbmRsZWRBY3Rpb25zLmluZGV4T2YoYWN0aW9uKSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIGFjdGlvbi5oYW5kbGVyKGV2dCk7CiAgICAgICAgICAgICAgICAvLyBBY3Rpb24gaGFuZGxlcnMgY2FuIG11dGF0ZSBzdGF0ZSB3aGljaCBpbiB0dXJuIGNyZWF0ZXMgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAvLyBUaGlzIGVmZmVjdCBjb3VsZCBjYXVzZSB0aGUgYGRhdGEtZW1iZXItYWN0aW9uYCBhdHRyaWJ1dGUgdG8gc2hpZnQgZG93biBhbmQgYmUgaW52b2tlZCB0d2ljZS4KICAgICAgICAgICAgICAgIC8vIFRvIGF2b2lkIHRoaXMsIHdlIGtlZXAgdHJhY2sgb2Ygd2hpY2ggYWN0aW9ucyBoYXZlIGJlZW4gaGFuZGxlZC4KICAgICAgICAgICAgICAgIGhhbmRsZWRBY3Rpb25zLnB1c2goYWN0aW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIF9nZXRWaWV3UmVnaXN0cnk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIG93bmVyID0gKDAsIF9lbWJlck93bmVyLmdldE93bmVyKSh0aGlzKTsKICAgICAgdmFyIHZpZXdSZWdpc3RyeSA9IG93bmVyICYmIG93bmVyLmxvb2t1cCgnLXZpZXctcmVnaXN0cnk6bWFpbicpIHx8IF9mYWxsYmFja1ZpZXdSZWdpc3RyeS5kZWZhdWx0OwoKICAgICAgcmV0dXJuIHZpZXdSZWdpc3RyeTsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciByb290RWxlbWVudFNlbGVjdG9yID0gKDAsIF9lbWJlck1ldGFsLmdldCkodGhpcywgJ3Jvb3RFbGVtZW50Jyk7CiAgICAgIHZhciByb290RWxlbWVudCA9IHZvaWQgMDsKICAgICAgaWYgKHJvb3RFbGVtZW50U2VsZWN0b3Iubm9kZVR5cGUpIHsKICAgICAgICByb290RWxlbWVudCA9IHJvb3RFbGVtZW50U2VsZWN0b3I7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHJvb3RFbGVtZW50U2VsZWN0b3IpOwogICAgICB9CgogICAgICBpZiAoIXJvb3RFbGVtZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoX2pxdWVyeS5qUXVlcnlEaXNhYmxlZCkgewogICAgICAgIGZvciAodmFyIGV2ZW50IGluIHRoaXMuX2V2ZW50SGFuZGxlcnMpIHsKICAgICAgICAgIHJvb3RFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIHRoaXMuX2V2ZW50SGFuZGxlcnNbZXZlbnRdKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKDAsIF9qcXVlcnkuZGVmYXVsdCkocm9vdEVsZW1lbnRTZWxlY3Rvcikub2ZmKCcuZW1iZXInLCAnKionKTsKICAgICAgfQoKICAgICAgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZShST09UX0VMRU1FTlRfQ0xBU1MpOwoKICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICcoRXZlbnREaXNwYXRjaGVyKSc7CiAgICB9CiAgfSk7Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vanF1ZXJ5JywgWydleHBvcnRzJywgJ2VtYmVyLWVudmlyb25tZW50JywgJ2VtYmVyLWJyb3dzZXItZW52aXJvbm1lbnQnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckVudmlyb25tZW50LCBfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMualF1ZXJ5RGlzYWJsZWQgPSB1bmRlZmluZWQ7CgoKICB2YXIgalF1ZXJ5ID0gdm9pZCAwOwogIHZhciBqUXVlcnlEaXNhYmxlZCA9IGV4cG9ydHMualF1ZXJ5RGlzYWJsZWQgPSBfZW1iZXJFbnZpcm9ubWVudC5FTlYuX0pRVUVSWV9JTlRFR1JBVElPTiA9PT0gZmFsc2U7CgogIGlmIChfZW1iZXJCcm93c2VyRW52aXJvbm1lbnQuaGFzRE9NKSB7CiAgICBqUXVlcnkgPSBfZW1iZXJFbnZpcm9ubWVudC5jb250ZXh0LmltcG9ydHMualF1ZXJ5OwoKICAgIGlmICghalF1ZXJ5RGlzYWJsZWQgJiYgalF1ZXJ5KSB7CiAgICAgIGlmIChqUXVlcnkuZXZlbnQuYWRkUHJvcCkgewogICAgICAgIGpRdWVyeS5ldmVudC5hZGRQcm9wKCdkYXRhVHJhbnNmZXInKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBodHRwOi8vd3d3LndoYXR3Zy5vcmcvc3BlY3Mvd2ViLWFwcHMvY3VycmVudC13b3JrL211bHRpcGFnZS9kbmQuaHRtbCNkbmRldmVudHMKICAgICAgICBbJ2RyYWdzdGFydCcsICdkcmFnJywgJ2RyYWdlbnRlcicsICdkcmFnbGVhdmUnLCAnZHJhZ292ZXInLCAnZHJvcCcsICdkcmFnZW5kJ10uZm9yRWFjaChmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICAgICAgICBqUXVlcnkuZXZlbnQuZml4SG9va3NbZXZlbnROYW1lXSA9IHsKICAgICAgICAgICAgcHJvcHM6IFsnZGF0YVRyYW5zZmVyJ10KICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGV4cG9ydHMualF1ZXJ5RGlzYWJsZWQgPSBqUXVlcnlEaXNhYmxlZCA9IHRydWU7CiAgICB9CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSBqUXVlcnlEaXNhYmxlZCA/IHVuZGVmaW5lZCA6IGpRdWVyeTsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL3N5c3RlbS9qcXVlcnlfZXZlbnRfZGVwcmVjYXRpb24nLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ2VtYmVyLWVudmlyb25tZW50JywgJ2VtYmVyLXV0aWxzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZGVidWcsIF9lbWJlckVudmlyb25tZW50LCBfZW1iZXJVdGlscykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gYWRkSlF1ZXJ5RXZlbnREZXByZWNhdGlvbjsKICBmdW5jdGlvbiBhZGRKUXVlcnlFdmVudERlcHJlY2F0aW9uKGpxRXZlbnQpIHsKICAgIGlmICghdHJ1ZSB8fCAhX2VtYmVyVXRpbHMuSEFTX05BVElWRV9QUk9YWSkgewogICAgICByZXR1cm4ganFFdmVudDsKICAgIH0KCiAgICB2YXIgYm91bmRGdW5jdGlvbnMgPSBuZXcgTWFwKCk7CgogICAgLy8gd3JhcCB0aGUgalF1ZXJ5IGV2ZW50IGluIGEgUHJveHkgdG8gYWRkIHRoZSBkZXByZWNhdGlvbiBtZXNzYWdlIGZvciBvcmlnaW5hbEV2ZW50LCBhY2NvcmRpbmcgdG8gUkZDIzI5NAogICAgLy8gd2UgbmVlZCBhIG5hdGl2ZSBQcm94eSBoZXJlLCBzbyB3ZSBjYW4gbWFrZSBzdXJlIHRoYXQgdGhlIGludGVybmFsIHVzZSBvZiBvcmlnaW5hbEV2ZW50IGluIGpRdWVyeSBpdHNlbGYgZG9lcwogICAgLy8gbm90IHRyaWdnZXIgYSBkZXByZWNhdGlvbgogICAgcmV0dXJuIG5ldyBQcm94eShqcUV2ZW50LCB7CiAgICAgIGdldDogZnVuY3Rpb24gKHRhcmdldCwgbmFtZSkgewogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgY2FzZSAnb3JpZ2luYWxFdmVudCc6CiAgICAgICAgICAgICh0cnVlICYmICEoZnVuY3Rpb24gKEVtYmVyRU5WKSB7CiAgICAgICAgICAgICAgLy8gdGhpcyBkZXByZWNhdGlvbiBpcyBpbnRlbnRpb25hbGx5IGNoZWNraW5nIGBnbG9iYWwuRW1iZXJFTlZgIC8KICAgICAgICAgICAgICAvLyBgZ2xvYmFsLkVOVmAgc28gdGhhdCB3ZSBjYW4gZW5zdXJlIHdlIF9vbmx5XyBkZXByZWNhdGUgaW4gdGhlCiAgICAgICAgICAgICAgLy8gY2FzZSB3aGVyZSBqUXVlcnkgaW50ZWdyYXRpb24gaXMgZW5hYmxlZCBpbXBsaWNpdGx5IChlLmcuCiAgICAgICAgICAgICAgLy8gImRlZmF1bHRlZCIgdG8gZW5hYmxlZCkgYXMgb3Bwb3NlZCB0byB3aGVuIHRoZSB1c2VyIGV4cGxpY2l0bHkKICAgICAgICAgICAgICAvLyBvcHRzIGluIHRvIHVzaW5nIGpRdWVyeQogICAgICAgICAgICAgIGlmICh0eXBlb2YgRW1iZXJFTlYgIT09ICdvYmplY3QnIHx8IEVtYmVyRU5WID09PSBudWxsKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAgIHJldHVybiBFbWJlckVOVi5fSlFVRVJZX0lOVEVHUkFUSU9OID09PSB0cnVlOwogICAgICAgICAgICB9KF9lbWJlckVudmlyb25tZW50Lmdsb2JhbC5FbWJlckVOViB8fCBfZW1iZXJFbnZpcm9ubWVudC5nbG9iYWwuRU5WKSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdBY2Nlc3NpbmcgalF1ZXJ5LkV2ZW50IHNwZWNpZmljIHByb3BlcnRpZXMgaXMgZGVwcmVjYXRlZC4gRWl0aGVyIHVzZSB0aGUgZW1iZXItanF1ZXJ5LWxlZ2FjeSBhZGRvbiB0byBub3JtYWxpemUgZXZlbnRzIHRvIG5hdGl2ZSBldmVudHMsIG9yIGV4cGxpY2l0bHkgb3B0IGludG8galF1ZXJ5IGludGVncmF0aW9uIHVzaW5nIEBlbWJlci9vcHRpb25hbC1mZWF0dXJlcy4nLCBmdW5jdGlvbiAoRW1iZXJFTlYpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIEVtYmVyRU5WICE9PSAnb2JqZWN0JyB8fCBFbWJlckVOViA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlO3JldHVybiBFbWJlckVOVi5fSlFVRVJZX0lOVEVHUkFUSU9OID09PSB0cnVlOwogICAgICAgICAgICB9KF9lbWJlckVudmlyb25tZW50Lmdsb2JhbC5FbWJlckVOViB8fCBfZW1iZXJFbnZpcm9ubWVudC5nbG9iYWwuRU5WKSwgewogICAgICAgICAgICAgIGlkOiAnZW1iZXItdmlld3MuZXZlbnQtZGlzcGF0Y2hlci5qcXVlcnktZXZlbnQnLAogICAgICAgICAgICAgIHVudGlsOiAnNC4wLjAnLAogICAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vZW1iZXJqcy5jb20vZGVwcmVjYXRpb25zL3YzLngjdG9jX2pxdWVyeS1ldmVudCcKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgcmV0dXJuIHRhcmdldFtuYW1lXTsKCiAgICAgICAgICAvLyBwcm92aWRlIGFuIGVzY2FwZSBoYXRjaCBmb3IgZW1iZXItanF1ZXJ5LWxlZ2FjeSB0byBhY2Nlc3Mgb3JpZ2luYWxFdmVudCB3aXRob3V0IGEgZGVwcmVjYXRpb24KICAgICAgICAgIGNhc2UgJ19fb3JpZ2luYWxFdmVudCc6CiAgICAgICAgICAgIHJldHVybiB0YXJnZXQub3JpZ2luYWxFdmVudDsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFtuYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIC8vIGNhY2hlIGZ1bmN0aW9ucyBmb3IgcmV1c2UKICAgICAgICAgICAgICBpZiAoIWJvdW5kRnVuY3Rpb25zLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgLy8gZm9yIGpRdWVyeS5FdmVudCBtZXRob2RzIGNhbGwgdGhlbSB3aXRoIGB0YXJnZXRgIGFzIHRoZSBgdGhpc2AgY29udGV4dCwgc28gdGhleSB3aWxsIGFjY2VzcwogICAgICAgICAgICAgICAgLy8gYG9yaWdpbmFsRXZlbnRgIGZyb20gdGhlIG9yaWdpbmFsIGpRdWVyeSBldmVudCwgbm90IG91ciBwcm94eSwgdGh1cyBub3QgdHJpZ2dlciB0aGUgZGVwcmVjYXRpb24KICAgICAgICAgICAgICAgIGJvdW5kRnVuY3Rpb25zLnNldChuYW1lLCB0YXJnZXRbbmFtZV0uYmluZCh0YXJnZXQpKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBib3VuZEZ1bmN0aW9ucy5nZXQobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gc2FtZSBmb3IgalF1ZXJ5J3MgZ2V0dGVyIGZ1bmN0aW9ucyBmb3Igc2ltcGxlIHByb3BlcnRpZXMKICAgICAgICAgICAgcmV0dXJuIHRhcmdldFtuYW1lXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0gLyogZ2xvYmFsIFByb3h5ICovCn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vbG9va3VwX3BhcnRpYWwnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL2RlYnVnJywgJ0BlbWJlci9lcnJvciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2RlYnVnLCBfZXJyb3IpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGxvb2t1cFBhcnRpYWw7CiAgZXhwb3J0cy5oYXNQYXJ0aWFsID0gaGFzUGFydGlhbDsKCgogIGZ1bmN0aW9uIHBhcnNlVW5kZXJzY29yZWROYW1lKHRlbXBsYXRlTmFtZSkgewogICAgdmFyIG5hbWVQYXJ0cyA9IHRlbXBsYXRlTmFtZS5zcGxpdCgnLycpOwogICAgdmFyIGxhc3RQYXJ0ID0gbmFtZVBhcnRzW25hbWVQYXJ0cy5sZW5ndGggLSAxXTsKCiAgICBuYW1lUGFydHNbbmFtZVBhcnRzLmxlbmd0aCAtIDFdID0gJ18nICsgbGFzdFBhcnQ7CgogICAgcmV0dXJuIG5hbWVQYXJ0cy5qb2luKCcvJyk7CiAgfQoKICBmdW5jdGlvbiBsb29rdXBQYXJ0aWFsKHRlbXBsYXRlTmFtZSwgb3duZXIpIHsKICAgIGlmICh0ZW1wbGF0ZU5hbWUgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHRlbXBsYXRlID0gdGVtcGxhdGVGb3Iob3duZXIsIHBhcnNlVW5kZXJzY29yZWROYW1lKHRlbXBsYXRlTmFtZSksIHRlbXBsYXRlTmFtZSk7CgogICAgKHRydWUgJiYgISghIXRlbXBsYXRlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ1VuYWJsZSB0byBmaW5kIHBhcnRpYWwgd2l0aCBuYW1lICInICsgdGVtcGxhdGVOYW1lICsgJyInLCAhIXRlbXBsYXRlKSk7CgoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9CgogIGZ1bmN0aW9uIGhhc1BhcnRpYWwobmFtZSwgb3duZXIpIHsKICAgIGlmICghb3duZXIpIHsKICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCdDb250YWluZXIgd2FzIG5vdCBmb3VuZCB3aGVuIGxvb2tpbmcgdXAgYSB2aWV3cyB0ZW1wbGF0ZS4gJyArICdUaGlzIGlzIG1vc3QgbGlrZWx5IGR1ZSB0byBtYW51YWxseSBpbnN0YW50aWF0aW5nIGFuIEVtYmVyLlZpZXcuICcgKyAnU2VlOiBodHRwOi8vZ2l0LmlvL0VLUHBuQScpOwogICAgfQoKICAgIHJldHVybiBvd25lci5oYXNSZWdpc3RyYXRpb24oJ3RlbXBsYXRlOicgKyBwYXJzZVVuZGVyc2NvcmVkTmFtZShuYW1lKSkgfHwgb3duZXIuaGFzUmVnaXN0cmF0aW9uKCd0ZW1wbGF0ZTonICsgbmFtZSk7CiAgfQoKICBmdW5jdGlvbiB0ZW1wbGF0ZUZvcihvd25lciwgdW5kZXJzY29yZWQsIG5hbWUpIHsKICAgIGlmICghbmFtZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICAodHJ1ZSAmJiAhKG5hbWUuaW5kZXhPZignLicpID09PSAtMSkgJiYgKDAsIF9kZWJ1Zy5hc3NlcnQpKCd0ZW1wbGF0ZU5hbWVzIGFyZSBub3QgYWxsb3dlZCB0byBjb250YWluIHBlcmlvZHM6ICcgKyBuYW1lLCBuYW1lLmluZGV4T2YoJy4nKSA9PT0gLTEpKTsKCgogICAgaWYgKCFvd25lcikgewogICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoJ0NvbnRhaW5lciB3YXMgbm90IGZvdW5kIHdoZW4gbG9va2luZyB1cCBhIHZpZXdzIHRlbXBsYXRlLiAnICsgJ1RoaXMgaXMgbW9zdCBsaWtlbHkgZHVlIHRvIG1hbnVhbGx5IGluc3RhbnRpYXRpbmcgYW4gRW1iZXIuVmlldy4gJyArICdTZWU6IGh0dHA6Ly9naXQuaW8vRUtQcG5BJyk7CiAgICB9CgogICAgcmV0dXJuIG93bmVyLmxvb2t1cCgndGVtcGxhdGU6JyArIHVuZGVyc2NvcmVkKSB8fCBvd25lci5sb29rdXAoJ3RlbXBsYXRlOicgKyBuYW1lKTsKICB9Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi9zeXN0ZW0vdXRpbHMnLCBbJ2V4cG9ydHMnLCAnZW1iZXItb3duZXInLCAnZW1iZXItdXRpbHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlck93bmVyLCBfZW1iZXJVdGlscykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5lbE1hdGNoZXMgPSB1bmRlZmluZWQ7CiAgZXhwb3J0cy5pc1NpbXBsZUNsaWNrID0gaXNTaW1wbGVDbGljazsKICBleHBvcnRzLmNvbnN0cnVjdFN0eWxlRGVwcmVjYXRpb25NZXNzYWdlID0gY29uc3RydWN0U3R5bGVEZXByZWNhdGlvbk1lc3NhZ2U7CiAgZXhwb3J0cy5nZXRSb290Vmlld3MgPSBnZXRSb290Vmlld3M7CiAgZXhwb3J0cy5nZXRWaWV3SWQgPSBnZXRWaWV3SWQ7CiAgZXhwb3J0cy5nZXRWaWV3RWxlbWVudCA9IGdldFZpZXdFbGVtZW50OwogIGV4cG9ydHMuaW5pdFZpZXdFbGVtZW50ID0gaW5pdFZpZXdFbGVtZW50OwogIGV4cG9ydHMuc2V0Vmlld0VsZW1lbnQgPSBzZXRWaWV3RWxlbWVudDsKICBleHBvcnRzLmdldENoaWxkVmlld3MgPSBnZXRDaGlsZFZpZXdzOwogIGV4cG9ydHMuaW5pdENoaWxkVmlld3MgPSBpbml0Q2hpbGRWaWV3czsKICBleHBvcnRzLmFkZENoaWxkVmlldyA9IGFkZENoaWxkVmlldzsKICBleHBvcnRzLmNvbGxlY3RDaGlsZFZpZXdzID0gY29sbGVjdENoaWxkVmlld3M7CiAgZXhwb3J0cy5nZXRWaWV3Qm91bmRzID0gZ2V0Vmlld0JvdW5kczsKICBleHBvcnRzLmdldFZpZXdSYW5nZSA9IGdldFZpZXdSYW5nZTsKICBleHBvcnRzLmdldFZpZXdDbGllbnRSZWN0cyA9IGdldFZpZXdDbGllbnRSZWN0czsKICBleHBvcnRzLmdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3QgPSBnZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0OwogIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXM7CgoKICAvKioKICBAbW9kdWxlIGVtYmVyCiAgKi8KCiAgZnVuY3Rpb24gaXNTaW1wbGVDbGljayhldmVudCkgewogICAgdmFyIG1vZGlmaWVyID0gZXZlbnQuc2hpZnRLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleTsKICAgIHZhciBzZWNvbmRhcnlDbGljayA9IGV2ZW50LndoaWNoID4gMTsgLy8gSUU5IG1heSByZXR1cm4gdW5kZWZpbmVkCgogICAgcmV0dXJuICFtb2RpZmllciAmJiAhc2Vjb25kYXJ5Q2xpY2s7CiAgfQogIC8qIGdsb2JhbHMgRWxlbWVudCAqLwogIGZ1bmN0aW9uIGNvbnN0cnVjdFN0eWxlRGVwcmVjYXRpb25NZXNzYWdlKGFmZmVjdGVkU3R5bGUpIHsKICAgIHJldHVybiAnJyArICdCaW5kaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbWF5IGludHJvZHVjZSBjcm9zcy1zaXRlIHNjcmlwdGluZyB2dWxuZXJhYmlsaXRpZXM7ICcgKyAncGxlYXNlIGVuc3VyZSB0aGF0IHZhbHVlcyBiZWluZyBib3VuZCBhcmUgcHJvcGVybHkgZXNjYXBlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sICcgKyAnaW5jbHVkaW5nIGhvdyB0byBkaXNhYmxlIHRoaXMgd2FybmluZywgc2VlICcgKyAnaHR0cHM6Ly9lbWJlcmpzLmNvbS9kZXByZWNhdGlvbnMvdjEueC8jdG9jX2JpbmRpbmctc3R5bGUtYXR0cmlidXRlcy4gJyArICdTdHlsZSBhZmZlY3RlZDogIicgKyBhZmZlY3RlZFN0eWxlICsgJyInOwogIH0KCiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRSb290Vmlld3MKICAgIEBwYXJhbSB7T2JqZWN0fSBvd25lcgogICovCiAgZnVuY3Rpb24gZ2V0Um9vdFZpZXdzKG93bmVyKSB7CiAgICB2YXIgcmVnaXN0cnkgPSBvd25lci5sb29rdXAoJy12aWV3LXJlZ2lzdHJ5Om1haW4nKTsKCiAgICB2YXIgcm9vdFZpZXdzID0gW107CgogICAgT2JqZWN0LmtleXMocmVnaXN0cnkpLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7CiAgICAgIHZhciB2aWV3ID0gcmVnaXN0cnlbaWRdOwoKICAgICAgaWYgKHZpZXcucGFyZW50VmlldyA9PT0gbnVsbCkgewogICAgICAgIHJvb3RWaWV3cy5wdXNoKHZpZXcpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gcm9vdFZpZXdzOwogIH0KCiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRWaWV3SWQKICAgIEBwYXJhbSB7RW1iZXIuVmlld30gdmlldwogICAqLwogIGZ1bmN0aW9uIGdldFZpZXdJZCh2aWV3KSB7CiAgICBpZiAodmlldy50YWdOYW1lICE9PSAnJyAmJiB2aWV3LmVsZW1lbnRJZCkgewogICAgICByZXR1cm4gdmlldy5lbGVtZW50SWQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKDAsIF9lbWJlclV0aWxzLmd1aWRGb3IpKHZpZXcpOwogICAgfQogIH0KCiAgdmFyIFZJRVdfRUxFTUVOVCA9ICgwLCBfZW1iZXJVdGlscy5zeW1ib2wpKCdWSUVXX0VMRU1FTlQnKTsKCiAgLyoqCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBnZXRWaWV3RWxlbWVudAogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgICovCiAgZnVuY3Rpb24gZ2V0Vmlld0VsZW1lbnQodmlldykgewogICAgcmV0dXJuIHZpZXdbVklFV19FTEVNRU5UXTsKICB9CgogIGZ1bmN0aW9uIGluaXRWaWV3RWxlbWVudCh2aWV3KSB7CiAgICB2aWV3W1ZJRVdfRUxFTUVOVF0gPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gc2V0Vmlld0VsZW1lbnQodmlldywgZWxlbWVudCkgewogICAgcmV0dXJuIHZpZXdbVklFV19FTEVNRU5UXSA9IGVsZW1lbnQ7CiAgfQoKICB2YXIgQ0hJTERfVklFV19JRFMgPSBuZXcgV2Vha01hcCgpOwoKICAvKioKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldENoaWxkVmlld3MKICAgIEBwYXJhbSB7RW1iZXIuVmlld30gdmlldwogICovCiAgZnVuY3Rpb24gZ2V0Q2hpbGRWaWV3cyh2aWV3KSB7CiAgICB2YXIgb3duZXIgPSAoMCwgX2VtYmVyT3duZXIuZ2V0T3duZXIpKHZpZXcpOwogICAgdmFyIHJlZ2lzdHJ5ID0gb3duZXIubG9va3VwKCctdmlldy1yZWdpc3RyeTptYWluJyk7CiAgICByZXR1cm4gY29sbGVjdENoaWxkVmlld3ModmlldywgcmVnaXN0cnkpOwogIH0KCiAgZnVuY3Rpb24gaW5pdENoaWxkVmlld3ModmlldykgewogICAgdmFyIGNoaWxkVmlld3MgPSBuZXcgU2V0KCk7CiAgICBDSElMRF9WSUVXX0lEUy5zZXQodmlldywgY2hpbGRWaWV3cyk7CiAgICByZXR1cm4gY2hpbGRWaWV3czsKICB9CgogIGZ1bmN0aW9uIGFkZENoaWxkVmlldyhwYXJlbnQsIGNoaWxkKSB7CiAgICB2YXIgY2hpbGRWaWV3cyA9IENISUxEX1ZJRVdfSURTLmdldChwYXJlbnQpOwogICAgaWYgKGNoaWxkVmlld3MgPT09IHVuZGVmaW5lZCkgewogICAgICBjaGlsZFZpZXdzID0gaW5pdENoaWxkVmlld3MocGFyZW50KTsKICAgIH0KCiAgICBjaGlsZFZpZXdzLmFkZChnZXRWaWV3SWQoY2hpbGQpKTsKICB9CgogIGZ1bmN0aW9uIGNvbGxlY3RDaGlsZFZpZXdzKHZpZXcsIHJlZ2lzdHJ5KSB7CiAgICB2YXIgdmlld3MgPSBbXTsKICAgIHZhciBjaGlsZFZpZXdzID0gQ0hJTERfVklFV19JRFMuZ2V0KHZpZXcpOwoKICAgIGlmIChjaGlsZFZpZXdzICE9PSB1bmRlZmluZWQpIHsKICAgICAgY2hpbGRWaWV3cy5mb3JFYWNoKGZ1bmN0aW9uIChpZCkgewogICAgICAgIHZhciB2aWV3ID0gcmVnaXN0cnlbaWRdOwogICAgICAgIGlmICh2aWV3ICYmICF2aWV3LmlzRGVzdHJveWluZyAmJiAhdmlldy5pc0Rlc3Ryb3llZCkgewogICAgICAgICAgdmlld3MucHVzaCh2aWV3KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB2aWV3czsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld0JvdW5kcwogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgKi8KICBmdW5jdGlvbiBnZXRWaWV3Qm91bmRzKHZpZXcpIHsKICAgIHJldHVybiB2aWV3LnJlbmRlcmVyLmdldEJvdW5kcyh2aWV3KTsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld1JhbmdlCiAgICBAcGFyYW0ge0VtYmVyLlZpZXd9IHZpZXcKICAqLwogIGZ1bmN0aW9uIGdldFZpZXdSYW5nZSh2aWV3KSB7CiAgICB2YXIgYm91bmRzID0gZ2V0Vmlld0JvdW5kcyh2aWV3KTsKCiAgICB2YXIgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpOwogICAgcmFuZ2Uuc2V0U3RhcnRCZWZvcmUoYm91bmRzLmZpcnN0Tm9kZSk7CiAgICByYW5nZS5zZXRFbmRBZnRlcihib3VuZHMubGFzdE5vZGUpOwoKICAgIHJldHVybiByYW5nZTsKICB9CgogIC8qKgogICAgYGdldFZpZXdDbGllbnRSZWN0c2AgcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBib3JkZXIKICAgIGJveCBlZGdlcyBvZiBhIHZpZXcgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0LgogIAogICAgSXQgaXMgb25seSBpbnRlbmRlZCB0byBiZSB1c2VkIGJ5IGRldmVsb3BtZW50IHRvb2xzIGxpa2UgdGhlIEVtYmVyIEluc3BlY3RvcgogICAgYW5kIG1heSBub3Qgd29yayBvbiBvbGRlciBicm93c2Vycy4KICAKICAgIEBwcml2YXRlCiAgICBAbWV0aG9kIGdldFZpZXdDbGllbnRSZWN0cwogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgKi8KICBmdW5jdGlvbiBnZXRWaWV3Q2xpZW50UmVjdHModmlldykgewogICAgdmFyIHJhbmdlID0gZ2V0Vmlld1JhbmdlKHZpZXcpOwogICAgcmV0dXJuIHJhbmdlLmdldENsaWVudFJlY3RzKCk7CiAgfQoKICAvKioKICAgIGBnZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0YCBwcm92aWRlcyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcG9zaXRpb24gb2YgdGhlCiAgICBib3VuZGluZyBib3JkZXIgYm94IGVkZ2VzIG9mIGEgdmlldyByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQuCiAgCiAgICBJdCBpcyBvbmx5IGludGVuZGVkIHRvIGJlIHVzZWQgYnkgZGV2ZWxvcG1lbnQgdG9vbHMgbGlrZSB0aGUgRW1iZXIgSW5zcGVjdG9yCiAgICBhbmQgbWF5IG5vdCB3b3JrIG9uIG9sZGVyIGJyb3dzZXJzLgogIAogICAgQHByaXZhdGUKICAgIEBtZXRob2QgZ2V0Vmlld0JvdW5kaW5nQ2xpZW50UmVjdAogICAgQHBhcmFtIHtFbWJlci5WaWV3fSB2aWV3CiAgKi8KICBmdW5jdGlvbiBnZXRWaWV3Qm91bmRpbmdDbGllbnRSZWN0KHZpZXcpIHsKICAgIHZhciByYW5nZSA9IGdldFZpZXdSYW5nZSh2aWV3KTsKICAgIHJldHVybiByYW5nZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CgogIC8qKgogICAgRGV0ZXJtaW5lcyBpZiB0aGUgZWxlbWVudCBtYXRjaGVzIHRoZSBzcGVjaWZpZWQgc2VsZWN0b3IuCiAgCiAgICBAcHJpdmF0ZQogICAgQG1ldGhvZCBtYXRjaGVzCiAgICBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsCiAgICBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IKICAqLwogIHZhciBlbE1hdGNoZXMgPSBleHBvcnRzLmVsTWF0Y2hlcyA9IHR5cGVvZiBFbGVtZW50ICE9PSAndW5kZWZpbmVkJyAmJiAoRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlcyB8fCBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGUubW96TWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlLm1zTWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlLm9NYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGUud2Via2l0TWF0Y2hlc1NlbGVjdG9yKTsKCiAgZnVuY3Rpb24gbWF0Y2hlcyhlbCwgc2VsZWN0b3IpIHsKICAgIHJldHVybiBlbE1hdGNoZXMuY2FsbChlbCwgc2VsZWN0b3IpOwogIH0KfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL3V0aWxzL2xvb2t1cC1jb21wb25lbnQnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZGVmYXVsdCA9IGxvb2t1cENvbXBvbmVudDsKCgogIGZ1bmN0aW9uIGxvb2t1cE1vZHVsZVVuaWZpY2F0aW9uQ29tcG9uZW50UGFpcihjb21wb25lbnRMb29rdXAsIG93bmVyLCBuYW1lLCBvcHRpb25zKSB7CiAgICB2YXIgbG9jYWxDb21wb25lbnQgPSBjb21wb25lbnRMb29rdXAuY29tcG9uZW50Rm9yKG5hbWUsIG93bmVyLCBvcHRpb25zKTsKICAgIHZhciBsb2NhbExheW91dCA9IGNvbXBvbmVudExvb2t1cC5sYXlvdXRGb3IobmFtZSwgb3duZXIsIG9wdGlvbnMpOwoKICAgIHZhciBnbG9iYWxDb21wb25lbnQgPSBjb21wb25lbnRMb29rdXAuY29tcG9uZW50Rm9yKG5hbWUsIG93bmVyKTsKICAgIHZhciBnbG9iYWxMYXlvdXQgPSBjb21wb25lbnRMb29rdXAubGF5b3V0Rm9yKG5hbWUsIG93bmVyKTsKCiAgICAvLyBUT0RPOiB3ZSBzaG91bGRuJ3QgaGF2ZSB0byByZWNoZWNrIGZhbGxiYWNrLCB3ZSBzaG91bGQgaGF2ZSBhIGxvb2t1cCB0aGF0IGRvZXNuJ3QgZmFsbGJhY2sKICAgIGlmIChsb2NhbENvbXBvbmVudCAhPT0gdW5kZWZpbmVkICYmIGdsb2JhbENvbXBvbmVudCAhPT0gdW5kZWZpbmVkICYmIGdsb2JhbENvbXBvbmVudC5jbGFzcyA9PT0gbG9jYWxDb21wb25lbnQuY2xhc3MpIHsKICAgICAgbG9jYWxDb21wb25lbnQgPSB1bmRlZmluZWQ7CiAgICB9CiAgICBpZiAobG9jYWxMYXlvdXQgIT09IHVuZGVmaW5lZCAmJiBnbG9iYWxMYXlvdXQgIT09IHVuZGVmaW5lZCAmJiBsb2NhbExheW91dC5yZWZlcnJlci5tb2R1bGVOYW1lID09PSBnbG9iYWxMYXlvdXQucmVmZXJyZXIubW9kdWxlTmFtZSkgewogICAgICBsb2NhbExheW91dCA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICBpZiAobG9jYWxMYXlvdXQgIT09IHVuZGVmaW5lZCB8fCBsb2NhbENvbXBvbmVudCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB7IGxheW91dDogbG9jYWxMYXlvdXQsIGNvbXBvbmVudDogbG9jYWxDb21wb25lbnQgfTsKICAgIH0KCiAgICByZXR1cm4geyBsYXlvdXQ6IGdsb2JhbExheW91dCwgY29tcG9uZW50OiBnbG9iYWxDb21wb25lbnQgfTsKICB9CgogIGZ1bmN0aW9uIGxvb2t1cENvbXBvbmVudFBhaXIoY29tcG9uZW50TG9va3VwLCBvd25lciwgbmFtZSwgb3B0aW9ucykgewogICAgaWYgKGZhbHNlKSB7CiAgICAgIHJldHVybiBsb29rdXBNb2R1bGVVbmlmaWNhdGlvbkNvbXBvbmVudFBhaXIoY29tcG9uZW50TG9va3VwLCBvd25lciwgbmFtZSwgb3B0aW9ucyk7CiAgICB9CgogICAgdmFyIGNvbXBvbmVudCA9IGNvbXBvbmVudExvb2t1cC5jb21wb25lbnRGb3IobmFtZSwgb3duZXIsIG9wdGlvbnMpOwogICAgdmFyIGxheW91dCA9IGNvbXBvbmVudExvb2t1cC5sYXlvdXRGb3IobmFtZSwgb3duZXIsIG9wdGlvbnMpOwoKICAgIHZhciByZXN1bHQgPSB7IGxheW91dDogbGF5b3V0LCBjb21wb25lbnQ6IGNvbXBvbmVudCB9OwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBmdW5jdGlvbiBsb29rdXBDb21wb25lbnQob3duZXIsIG5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciBjb21wb25lbnRMb29rdXAgPSBvd25lci5sb29rdXAoJ2NvbXBvbmVudC1sb29rdXA6bWFpbicpOwoKICAgIGlmIChvcHRpb25zICYmIChvcHRpb25zLnNvdXJjZSB8fCBvcHRpb25zLm5hbWVzcGFjZSkpIHsKICAgICAgdmFyIGxvY2FsUmVzdWx0ID0gbG9va3VwQ29tcG9uZW50UGFpcihjb21wb25lbnRMb29rdXAsIG93bmVyLCBuYW1lLCBvcHRpb25zKTsKCiAgICAgIGlmIChsb2NhbFJlc3VsdC5jb21wb25lbnQgfHwgbG9jYWxSZXN1bHQubGF5b3V0KSB7CiAgICAgICAgcmV0dXJuIGxvY2FsUmVzdWx0OwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGxvb2t1cENvbXBvbmVudFBhaXIoY29tcG9uZW50TG9va3VwLCBvd25lciwgbmFtZSk7CiAgfQp9KTsKZW5pZmVkKCdlbWJlci12aWV3cy9saWIvdmlld3MvY29yZV92aWV3JywgWydleHBvcnRzJywgJ2VtYmVyLXJ1bnRpbWUnLCAnZW1iZXItdmlld3MvbGliL3N5c3RlbS91dGlscycsICdlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJSdW50aW1lLCBfdXRpbHMsIF9zdGF0ZXMpIHsKICAndXNlIHN0cmljdCc7CgogIC8qKgogICAgYEVtYmVyLkNvcmVWaWV3YCBpcyBhbiBhYnN0cmFjdCBjbGFzcyB0aGF0IGV4aXN0cyB0byBnaXZlIHZpZXctbGlrZSBiZWhhdmlvcgogICAgdG8gYm90aCBFbWJlcidzIG1haW4gdmlldyBjbGFzcyBgQ29tcG9uZW50YCBhbmQgb3RoZXIgY2xhc3NlcyB0aGF0IGRvbid0IG5lZWQKICAgIHRoZSBmdWxsIGZ1bmN0aW9uYWxpdHkgb2YgYENvbXBvbmVudGAuCiAgCiAgICBVbmxlc3MgeW91IGhhdmUgc3BlY2lmaWMgbmVlZHMgZm9yIGBDb3JlVmlld2AsIHlvdSB3aWxsIHVzZSBgQ29tcG9uZW50YAogICAgaW4geW91ciBhcHBsaWNhdGlvbnMuCiAgCiAgICBAY2xhc3MgQ29yZVZpZXcKICAgIEBuYW1lc3BhY2UgRW1iZXIKICAgIEBleHRlbmRzIEVtYmVyT2JqZWN0CiAgICBAZGVwcmVjYXRlZCBVc2UgYENvbXBvbmVudGAgaW5zdGVhZC4KICAgIEB1c2VzIEV2ZW50ZWQKICAgIEB1c2VzIEVtYmVyLkFjdGlvbkhhbmRsZXIKICAgIEBwcml2YXRlCiAgKi8KICB2YXIgQ29yZVZpZXcgPSBfZW1iZXJSdW50aW1lLkZyYW1ld29ya09iamVjdC5leHRlbmQoX2VtYmVyUnVudGltZS5FdmVudGVkLCBfZW1iZXJSdW50aW1lLkFjdGlvbkhhbmRsZXIsIHsKICAgIGlzVmlldzogdHJ1ZSwKCiAgICBfc3RhdGVzOiAoMCwgX3N0YXRlcy5jbG9uZVN0YXRlcykoX3N0YXRlcy5zdGF0ZXMpLAoKICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdGhpcy5fc3RhdGUgPSAncHJlUmVuZGVyJzsKICAgICAgdGhpcy5fY3VycmVudFN0YXRlID0gdGhpcy5fc3RhdGVzLnByZVJlbmRlcjsKCiAgICAgICgwLCBfdXRpbHMuaW5pdFZpZXdFbGVtZW50KSh0aGlzKTsKCiAgICAgIGlmICghdGhpcy5yZW5kZXJlcikgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGluc3RhbnRpYXRlIGEgY29tcG9uZW50IHdpdGhvdXQgYSByZW5kZXJlci4gUGxlYXNlIGVuc3VyZSB0aGF0IHlvdSBhcmUgY3JlYXRpbmcgJyArIHRoaXMgKyAnIHdpdGggYSBwcm9wZXIgY29udGFpbmVyL3JlZ2lzdHJ5LicpOwogICAgICB9CiAgICB9LAoKCiAgICAvKioKICAgICAgSWYgdGhlIHZpZXcgaXMgY3VycmVudGx5IGluc2VydGVkIGludG8gdGhlIERPTSBvZiBhIHBhcmVudCB2aWV3LCB0aGlzCiAgICAgIHByb3BlcnR5IHdpbGwgcG9pbnQgdG8gdGhlIHBhcmVudCBvZiB0aGUgdmlldy4KICAgICAgIEBwcm9wZXJ0eSBwYXJlbnRWaWV3CiAgICAgIEB0eXBlIEVtYmVyLlZpZXcKICAgICAgQGRlZmF1bHQgbnVsbAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIHBhcmVudFZpZXc6IG51bGwsCgogICAgaW5zdHJ1bWVudERldGFpbHM6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgIGhhc2gub2JqZWN0ID0gdGhpcy50b1N0cmluZygpOwogICAgICBoYXNoLmNvbnRhaW5lcktleSA9IHRoaXMuX2RlYnVnQ29udGFpbmVyS2V5OwogICAgICBoYXNoLnZpZXcgPSB0aGlzOwogICAgICByZXR1cm4gaGFzaDsKICAgIH0sCiAgICB0cmlnZ2VyOiBmdW5jdGlvbiAobmFtZSkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgfQoKICAgICAgdGhpcy5fc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgdmFyIG1ldGhvZCA9IHRoaXNbbmFtZV07CiAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSwKICAgIGhhczogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzW25hbWVdID09PSAnZnVuY3Rpb24nIHx8IHRoaXMuX3N1cGVyKG5hbWUpOwogICAgfQogIH0pOwoKICBDb3JlVmlldy5yZW9wZW5DbGFzcyh7CiAgICBpc1ZpZXdGYWN0b3J5OiB0cnVlCiAgfSk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IENvcmVWaWV3Owp9KTsKZW5pZmVkKCdlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzJywgWydleHBvcnRzJywgJ0BlbWJlci9wb2x5ZmlsbHMnLCAnZW1iZXItdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9kZWZhdWx0JywgJ2VtYmVyLXZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvcHJlX3JlbmRlcicsICdlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzL2hhc19lbGVtZW50JywgJ2VtYmVyLXZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvaW5fZG9tJywgJ2VtYmVyLXZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvZGVzdHJveWluZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3BvbHlmaWxscywgX2RlZmF1bHQyLCBfcHJlX3JlbmRlciwgX2hhc19lbGVtZW50LCBfaW5fZG9tLCBfZGVzdHJveWluZykgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5zdGF0ZXMgPSB1bmRlZmluZWQ7CiAgZXhwb3J0cy5jbG9uZVN0YXRlcyA9IGNsb25lU3RhdGVzOwogIGZ1bmN0aW9uIGNsb25lU3RhdGVzKGZyb20pIHsKICAgIHZhciBpbnRvID0ge307CgogICAgaW50by5fZGVmYXVsdCA9IHt9OwogICAgaW50by5wcmVSZW5kZXIgPSBPYmplY3QuY3JlYXRlKGludG8uX2RlZmF1bHQpOwogICAgaW50by5kZXN0cm95aW5nID0gT2JqZWN0LmNyZWF0ZShpbnRvLl9kZWZhdWx0KTsKICAgIGludG8uaGFzRWxlbWVudCA9IE9iamVjdC5jcmVhdGUoaW50by5fZGVmYXVsdCk7CiAgICBpbnRvLmluRE9NID0gT2JqZWN0LmNyZWF0ZShpbnRvLmhhc0VsZW1lbnQpOwoKICAgIGZvciAodmFyIHN0YXRlTmFtZSBpbiBmcm9tKSB7CiAgICAgIGlmICghZnJvbS5oYXNPd25Qcm9wZXJ0eShzdGF0ZU5hbWUpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShpbnRvW3N0YXRlTmFtZV0sIGZyb21bc3RhdGVOYW1lXSk7CiAgICB9CgogICAgcmV0dXJuIGludG87CiAgfQoKICAvKgogICAgRGVzY3JpYmUgaG93IHRoZSBzcGVjaWZpZWQgYWN0aW9ucyBzaG91bGQgYmVoYXZlIGluIHRoZSB2YXJpb3VzCiAgICBzdGF0ZXMgdGhhdCBhIHZpZXcgY2FuIGV4aXN0IGluLiBQb3NzaWJsZSBzdGF0ZXM6CiAgCiAgICAqIHByZVJlbmRlcjogd2hlbiBhIHZpZXcgaXMgZmlyc3QgaW5zdGFudGlhdGVkLCBhbmQgYWZ0ZXIgaXRzCiAgICAgIGVsZW1lbnQgd2FzIGRlc3Ryb3llZCwgaXQgaXMgaW4gdGhlIHByZVJlbmRlciBzdGF0ZQogICAgKiBoYXNFbGVtZW50OiB0aGUgRE9NIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB2aWV3IGlzIGNyZWF0ZWQsCiAgICAgIGFuZCBpcyByZWFkeSB0byBiZSBpbnNlcnRlZAogICAgKiBpbkRPTTogb25jZSBhIHZpZXcgaGFzIGJlZW4gaW5zZXJ0ZWQgaW50byB0aGUgRE9NIGl0IGlzIGluCiAgICAgIHRoZSBpbkRPTSBzdGF0ZS4gQSB2aWV3IHNwZW5kcyB0aGUgdmFzdCBtYWpvcml0eSBvZiBpdHMKICAgICAgZXhpc3RlbmNlIGluIHRoaXMgc3RhdGUuCiAgICAqIGRlc3Ryb3llZDogb25jZSBhIHZpZXcgaGFzIGJlZW4gZGVzdHJveWVkICh1c2luZyB0aGUgZGVzdHJveQogICAgICBtZXRob2QpLCBpdCBpcyBpbiB0aGlzIHN0YXRlLiBObyBmdXJ0aGVyIGFjdGlvbnMgY2FuIGJlIGludm9rZWQKICAgICAgb24gYSBkZXN0cm95ZWQgdmlldy4KICAqLwogIHZhciBzdGF0ZXMgPSBleHBvcnRzLnN0YXRlcyA9IHsKICAgIF9kZWZhdWx0OiBfZGVmYXVsdDIuZGVmYXVsdCwKICAgIHByZVJlbmRlcjogX3ByZV9yZW5kZXIuZGVmYXVsdCwKICAgIGluRE9NOiBfaW5fZG9tLmRlZmF1bHQsCiAgICBoYXNFbGVtZW50OiBfaGFzX2VsZW1lbnQuZGVmYXVsdCwKICAgIGRlc3Ryb3lpbmc6IF9kZXN0cm95aW5nLmRlZmF1bHQKICB9Owp9KTsKZW5pZmVkKCJlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzL2RlZmF1bHQiLCBbImV4cG9ydHMiLCAiQGVtYmVyL2Vycm9yIl0sIGZ1bmN0aW9uIChleHBvcnRzLCBfZXJyb3IpIHsKICAidXNlIHN0cmljdCI7CgogIGV4cG9ydHMuZGVmYXVsdCA9IHsKICAgIC8vIGFwcGVuZENoaWxkIGlzIG9ubHkgbGVnYWwgd2hpbGUgcmVuZGVyaW5nIHRoZSBidWZmZXIuCiAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24gKCkgewogICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoIllvdSBjYW4ndCB1c2UgYXBwZW5kQ2hpbGQgb3V0c2lkZSBvZiB0aGUgcmVuZGVyaW5nIHByb2Nlc3MiKTsKICAgIH0sCgoKICAgIC8vIEhhbmRsZSBldmVudHMgZnJvbSBgRW1iZXIuRXZlbnREaXNwYXRjaGVyYAogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRydWU7IC8vIGNvbnRpbnVlIGV2ZW50IHByb3BhZ2F0aW9uCiAgICB9LAogICAgcmVyZW5kZXI6IGZ1bmN0aW9uICgpIHt9LAogICAgZGVzdHJveTogZnVuY3Rpb24gKCkge30KICB9Owp9KTsKZW5pZmVkKCdlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzL2Rlc3Ryb3lpbmcnLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL3BvbHlmaWxscycsICdAZW1iZXIvZXJyb3InLCAnZW1iZXItdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9kZWZhdWx0J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcG9seWZpbGxzLCBfZXJyb3IsIF9kZWZhdWx0MikgewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGRlc3Ryb3lpbmcgPSBPYmplY3QuY3JlYXRlKF9kZWZhdWx0Mi5kZWZhdWx0KTsKCiAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShkZXN0cm95aW5nLCB7CiAgICBhcHBlbmRDaGlsZDogZnVuY3Rpb24gKCkgewogICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoIllvdSBjYW4ndCBjYWxsIGFwcGVuZENoaWxkIG9uIGEgdmlldyBiZWluZyBkZXN0cm95ZWQiKTsKICAgIH0sCiAgICByZXJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgICB0aHJvdyBuZXcgX2Vycm9yLmRlZmF1bHQoIllvdSBjYW4ndCBjYWxsIHJlcmVuZGVyIG9uIGEgdmlldyBiZWluZyBkZXN0cm95ZWQiKTsKICAgIH0KICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gZGVzdHJveWluZzsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9oYXNfZWxlbWVudCcsIFsnZXhwb3J0cycsICdAZW1iZXIvcG9seWZpbGxzJywgJ2VtYmVyLXZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvZGVmYXVsdCcsICdAZW1iZXIvcnVubG9vcCcsICdAZW1iZXIvaW5zdHJ1bWVudGF0aW9uJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcG9seWZpbGxzLCBfZGVmYXVsdDIsIF9ydW5sb29wLCBfaW5zdHJ1bWVudGF0aW9uKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaGFzRWxlbWVudCA9IE9iamVjdC5jcmVhdGUoX2RlZmF1bHQyLmRlZmF1bHQpOwoKICAoMCwgX3BvbHlmaWxscy5hc3NpZ24pKGhhc0VsZW1lbnQsIHsKICAgIHJlcmVuZGVyOiBmdW5jdGlvbiAodmlldykgewogICAgICB2aWV3LnJlbmRlcmVyLnJlcmVuZGVyKHZpZXcpOwogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgIHZpZXcucmVuZGVyZXIucmVtb3ZlKHZpZXcpOwogICAgfSwKICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbiAodmlldywgZXZlbnROYW1lLCBldmVudCkgewogICAgICBpZiAodmlldy5oYXMoZXZlbnROYW1lKSkgewogICAgICAgIC8vIEhhbmRsZXIgc2hvdWxkIGJlIGFibGUgdG8gcmUtZGlzcGF0Y2ggZXZlbnRzLCBzbyB3ZSBkb24ndAogICAgICAgIC8vIHByZXZlbnREZWZhdWx0IG9yIHN0b3BQcm9wYWdhdGlvbi4KICAgICAgICByZXR1cm4gKDAsIF9pbnN0cnVtZW50YXRpb24uZmxhZ2dlZEluc3RydW1lbnQpKCdpbnRlcmFjdGlvbi4nICsgZXZlbnROYW1lLCB7IGV2ZW50OiBldmVudCwgdmlldzogdmlldyB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gKDAsIF9ydW5sb29wLmpvaW4pKHZpZXcsIHZpZXcudHJpZ2dlciwgZXZlbnROYW1lLCBldmVudCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNvbnRpbnVlIGV2ZW50IHByb3BhZ2F0aW9uCiAgICAgIH0KICAgIH0KICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gaGFzRWxlbWVudDsKfSk7CmVuaWZlZCgnZW1iZXItdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9pbl9kb20nLCBbJ2V4cG9ydHMnLCAnQGVtYmVyL3BvbHlmaWxscycsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvZXJyb3InLCAnZW1iZXItdmlld3MvbGliL3ZpZXdzL3N0YXRlcy9oYXNfZWxlbWVudCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3BvbHlmaWxscywgX2VtYmVyTWV0YWwsIF9lcnJvciwgX2hhc19lbGVtZW50KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaW5ET00gPSBPYmplY3QuY3JlYXRlKF9oYXNfZWxlbWVudC5kZWZhdWx0KTsKCiAgKDAsIF9wb2x5ZmlsbHMuYXNzaWduKShpbkRPTSwgewogICAgZW50ZXI6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgIC8vIFJlZ2lzdGVyIHRoZSB2aWV3IGZvciBldmVudCBoYW5kbGluZy4gVGhpcyBoYXNoIGlzIHVzZWQgYnkKICAgICAgLy8gRW1iZXIuRXZlbnREaXNwYXRjaGVyIHRvIGRpc3BhdGNoIGluY29taW5nIGV2ZW50cy4KICAgICAgdmlldy5yZW5kZXJlci5yZWdpc3Rlcih2aWV3KTsKCiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgKDAsIF9lbWJlck1ldGFsLmFkZE9ic2VydmVyKSh2aWV3LCAnZWxlbWVudElkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhyb3cgbmV3IF9lcnJvci5kZWZhdWx0KCJDaGFuZ2luZyBhIHZpZXcncyBlbGVtZW50SWQgYWZ0ZXIgY3JlYXRpb24gaXMgbm90IGFsbG93ZWQiKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAgIGV4aXQ6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgIHZpZXcucmVuZGVyZXIudW5yZWdpc3Rlcih2aWV3KTsKICAgIH0KICB9KTsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gaW5ET007Cn0pOwplbmlmZWQoJ2VtYmVyLXZpZXdzL2xpYi92aWV3cy9zdGF0ZXMvcHJlX3JlbmRlcicsIFsnZXhwb3J0cycsICdlbWJlci12aWV3cy9saWIvdmlld3Mvc3RhdGVzL2RlZmF1bHQnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9kZWZhdWx0MikgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5kZWZhdWx0ID0gT2JqZWN0LmNyZWF0ZShfZGVmYXVsdDIuZGVmYXVsdCk7Cn0pOwplbmlmZWQoJ2VtYmVyL2luZGV4JywgWydleHBvcnRzJywgJ3JlcXVpcmUnLCAnZW1iZXItZW52aXJvbm1lbnQnLCAnbm9kZS1tb2R1bGUnLCAnZW1iZXItdXRpbHMnLCAnY29udGFpbmVyJywgJ0BlbWJlci9pbnN0cnVtZW50YXRpb24nLCAnZW1iZXItbWV0YScsICdlbWJlci1tZXRhbCcsICdAZW1iZXIvY2FuYXJ5LWZlYXR1cmVzJywgJ0BlbWJlci9kZWJ1ZycsICdiYWNrYnVybmVyJywgJ2VtYmVyLWNvbnNvbGUnLCAnQGVtYmVyL2NvbnRyb2xsZXInLCAnQGVtYmVyL2NvbnRyb2xsZXIvbGliL2NvbnRyb2xsZXJfbWl4aW4nLCAnQGVtYmVyL3N0cmluZycsICdAZW1iZXIvc2VydmljZScsICdAZW1iZXIvb2JqZWN0L2NvbXB1dGVkJywgJ2VtYmVyLXJ1bnRpbWUnLCAnZW1iZXItZ2xpbW1lcicsICdlbWJlci92ZXJzaW9uJywgJ2VtYmVyLXZpZXdzJywgJ2VtYmVyLXJvdXRpbmcnLCAnZW1iZXItZXh0ZW5zaW9uLXN1cHBvcnQnLCAnQGVtYmVyL2Vycm9yJywgJ0BlbWJlci9ydW5sb29wJywgJ2VtYmVyLWVycm9yLWhhbmRsaW5nJywgJ2VtYmVyLW93bmVyJywgJ0BlbWJlci9hcHBsaWNhdGlvbicsICdAZW1iZXIvYXBwbGljYXRpb24vZ2xvYmFscy1yZXNvbHZlcicsICdAZW1iZXIvYXBwbGljYXRpb24vaW5zdGFuY2UnLCAnQGVtYmVyL2VuZ2luZScsICdAZW1iZXIvZW5naW5lL2luc3RhbmNlJywgJ0BlbWJlci9tYXAnLCAnQGVtYmVyL21hcC93aXRoLWRlZmF1bHQnLCAnQGVtYmVyL21hcC9saWIvb3JkZXJlZC1zZXQnLCAnQGVtYmVyL3BvbHlmaWxscycsICdAZW1iZXIvZGVwcmVjYXRlZC1mZWF0dXJlcyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3JlcXVpcmUyLCBfZW1iZXJFbnZpcm9ubWVudCwgX25vZGVNb2R1bGUsIF9lbWJlclV0aWxzLCBfY29udGFpbmVyLCBfaW5zdHJ1bWVudGF0aW9uLCBfZW1iZXJNZXRhLCBfZW1iZXJNZXRhbCwgX2NhbmFyeUZlYXR1cmVzLCBfZGVidWcsIF9iYWNrYnVybmVyLCBfZW1iZXJDb25zb2xlLCBfY29udHJvbGxlciwgX2NvbnRyb2xsZXJfbWl4aW4sIF9zdHJpbmcsIF9zZXJ2aWNlLCBfY29tcHV0ZWQsIF9lbWJlclJ1bnRpbWUsIF9lbWJlckdsaW1tZXIsIF92ZXJzaW9uLCBfZW1iZXJWaWV3cywgX2VtYmVyUm91dGluZywgX2VtYmVyRXh0ZW5zaW9uU3VwcG9ydCwgX2Vycm9yLCBfcnVubG9vcCwgX2VtYmVyRXJyb3JIYW5kbGluZywgX2VtYmVyT3duZXIsIF9hcHBsaWNhdGlvbiwgX2dsb2JhbHNSZXNvbHZlciwgX2luc3RhbmNlLCBfZW5naW5lLCBfaW5zdGFuY2UyLCBfbWFwLCBfd2l0aERlZmF1bHQsIF9vcmRlcmVkU2V0LCBfcG9seWZpbGxzLCBfZGVwcmVjYXRlZEZlYXR1cmVzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvLyAqKioqZW1iZXItZW52aXJvbm1lbnQqKioqCgogIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZAogIHZhciBFbWJlciA9IHR5cGVvZiBfZW1iZXJFbnZpcm9ubWVudC5jb250ZXh0LmltcG9ydHMuRW1iZXIgPT09ICdvYmplY3QnICYmIF9lbWJlckVudmlyb25tZW50LmNvbnRleHQuaW1wb3J0cy5FbWJlciB8fCB7fTsKCiAgRW1iZXIuaXNOYW1lc3BhY2UgPSB0cnVlOwogIEVtYmVyLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICdFbWJlcic7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAnRU5WJywgewogICAgZ2V0OiBfZW1iZXJFbnZpcm9ubWVudC5nZXRFTlYsCiAgICBlbnVtZXJhYmxlOiBmYWxzZQogIH0pOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdsb29rdXAnLCB7CiAgICBnZXQ6IF9lbWJlckVudmlyb25tZW50LmdldExvb2t1cCwKICAgIHNldDogX2VtYmVyRW52aXJvbm1lbnQuc2V0TG9va3VwLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsKCiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuRU1CRVJfRVhURU5EX1BST1RPVFlQRVMpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJ0VYVEVORF9QUk9UT1RZUEVTJywgewogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgKHRydWUgJiYgIShmYWxzZSkgJiYgKDAsIF9kZWJ1Zy5kZXByZWNhdGUpKCdBY2Nlc3NpbmcgRW1iZXIuRVhURU5EX1BST1RPVFlQRVMgaXMgZGVwcmVjYXRlZCwgcGxlYXNlIG1pZ3JhdGUgdG8gRW1iZXIuRU5WLkVYVEVORF9QUk9UT1RZUEVTJywgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItZW52Lm9sZC1leHRlbmQtcHJvdG90eXBlcycsCiAgICAgICAgICB1bnRpbDogJzQuMC4wJwogICAgICAgIH0pKTsKCgogICAgICAgIHJldHVybiBfZW1iZXJFbnZpcm9ubWVudC5FTlYuRVhURU5EX1BST1RPVFlQRVM7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy8gKioqKkBlbWJlci9hcHBsaWNhdGlvbioqKioKICBFbWJlci5nZXRPd25lciA9IF9lbWJlck93bmVyLmdldE93bmVyOwogIEVtYmVyLnNldE93bmVyID0gX2VtYmVyT3duZXIuc2V0T3duZXI7CiAgRW1iZXIuQXBwbGljYXRpb24gPSBfYXBwbGljYXRpb24uZGVmYXVsdDsKICBFbWJlci5EZWZhdWx0UmVzb2x2ZXIgPSBFbWJlci5SZXNvbHZlciA9IF9nbG9iYWxzUmVzb2x2ZXIuZGVmYXVsdDsKICBFbWJlci5BcHBsaWNhdGlvbkluc3RhbmNlID0gX2luc3RhbmNlLmRlZmF1bHQ7CgogIC8vICoqKipAZW1iZXIvZW5naW5lKioqKgogIEVtYmVyLkVuZ2luZSA9IF9lbmdpbmUuZGVmYXVsdDsKICBFbWJlci5FbmdpbmVJbnN0YW5jZSA9IF9pbnN0YW5jZTIuZGVmYXVsdDsKCiAgLy8gKioqKkBlbWJlci9tYXAqKioqCiAgRW1iZXIuT3JkZXJlZFNldCA9IF9vcmRlcmVkU2V0LmRlZmF1bHQ7CiAgRW1iZXIuX19PcmRlcmVkU2V0X18gPSBfb3JkZXJlZFNldC5fX09yZGVyZWRTZXRfXzsKICBFbWJlci5NYXAgPSBfbWFwLmRlZmF1bHQ7CiAgRW1iZXIuTWFwV2l0aERlZmF1bHQgPSBfd2l0aERlZmF1bHQuZGVmYXVsdDsKCiAgLy8gKioqKkBlbWJlci9wb2x5ZmlsbHMqKioqCiAgRW1iZXIuYXNzaWduID0gX3BvbHlmaWxscy5hc3NpZ247CiAgRW1iZXIubWVyZ2UgPSBfcG9seWZpbGxzLm1lcmdlOwoKICAvLyAqKioqZW1iZXItdXRpbHMqKioqCiAgRW1iZXIuZ2VuZXJhdGVHdWlkID0gX2VtYmVyVXRpbHMuZ2VuZXJhdGVHdWlkOwogIEVtYmVyLkdVSURfS0VZID0gX2VtYmVyVXRpbHMuR1VJRF9LRVk7CiAgRW1iZXIuZ3VpZEZvciA9IF9lbWJlclV0aWxzLmd1aWRGb3I7CiAgRW1iZXIuaW5zcGVjdCA9IF9lbWJlclV0aWxzLmluc3BlY3Q7CiAgRW1iZXIubWFrZUFycmF5ID0gX2VtYmVyVXRpbHMubWFrZUFycmF5OwogIEVtYmVyLmNhbkludm9rZSA9IF9lbWJlclV0aWxzLmNhbkludm9rZTsKICBFbWJlci50cnlJbnZva2UgPSBfZW1iZXJVdGlscy50cnlJbnZva2U7CiAgRW1iZXIud3JhcCA9IF9lbWJlclV0aWxzLndyYXA7CiAgRW1iZXIudXVpZCA9IF9lbWJlclV0aWxzLnV1aWQ7CiAgRW1iZXIuTkFNRV9LRVkgPSBfZW1iZXJVdGlscy5OQU1FX0tFWTsKICBFbWJlci5fQ2FjaGUgPSBfZW1iZXJVdGlscy5DYWNoZTsKCiAgLy8gKioqKmNvbnRhaW5lcioqKioKICBFbWJlci5Db250YWluZXIgPSBfY29udGFpbmVyLkNvbnRhaW5lcjsKICBFbWJlci5SZWdpc3RyeSA9IF9jb250YWluZXIuUmVnaXN0cnk7CgogIC8vICoqKipAZW1iZXIvZGVidWcqKioqCiAgRW1iZXIuYXNzZXJ0ID0gX2RlYnVnLmFzc2VydDsKICBFbWJlci53YXJuID0gX2RlYnVnLndhcm47CiAgRW1iZXIuZGVidWcgPSBfZGVidWcuZGVidWc7CiAgRW1iZXIuZGVwcmVjYXRlID0gX2RlYnVnLmRlcHJlY2F0ZTsKICBFbWJlci5kZXByZWNhdGVGdW5jID0gX2RlYnVnLmRlcHJlY2F0ZUZ1bmM7CiAgRW1iZXIucnVuSW5EZWJ1ZyA9IF9kZWJ1Zy5ydW5JbkRlYnVnOwoKICAvLyAqKioqQGVtYmVyL2Vycm9yKioqKgogIEVtYmVyLkVycm9yID0gX2Vycm9yLmRlZmF1bHQ7CgogIC8qKgogICAgQHB1YmxpYwogICAgQGNsYXNzIEVtYmVyLkRlYnVnCiAgKi8KICBFbWJlci5EZWJ1ZyA9IHsKICAgIHJlZ2lzdGVyRGVwcmVjYXRpb25IYW5kbGVyOiBfZGVidWcucmVnaXN0ZXJEZXByZWNhdGlvbkhhbmRsZXIsCiAgICByZWdpc3Rlcldhcm5IYW5kbGVyOiBfZGVidWcucmVnaXN0ZXJXYXJuSGFuZGxlcgogIH07CgogIC8vICoqKipAZW1iZXIvaW5zdHJ1bWVudGF0aW9uKioqKgogIEVtYmVyLmluc3RydW1lbnQgPSBfaW5zdHJ1bWVudGF0aW9uLmluc3RydW1lbnQ7CiAgRW1iZXIuc3Vic2NyaWJlID0gX2luc3RydW1lbnRhdGlvbi5zdWJzY3JpYmU7CiAgRW1iZXIuSW5zdHJ1bWVudGF0aW9uID0gewogICAgaW5zdHJ1bWVudDogX2luc3RydW1lbnRhdGlvbi5pbnN0cnVtZW50LAogICAgc3Vic2NyaWJlOiBfaW5zdHJ1bWVudGF0aW9uLnN1YnNjcmliZSwKICAgIHVuc3Vic2NyaWJlOiBfaW5zdHJ1bWVudGF0aW9uLnVuc3Vic2NyaWJlLAogICAgcmVzZXQ6IF9pbnN0cnVtZW50YXRpb24ucmVzZXQKICB9OwoKICAvLyAqKioqQGVtYmVyL3J1bmxvb3AqKioqCgogIC8vIFVzaW5nIF9nbG9iYWxzUnVuIGhlcmUgc28gdGhhdCBtdXRhdGluZyB0aGUgZnVuY3Rpb24gKGFkZGluZwogIC8vIGBuZXh0YCwgYGxhdGVyYCwgZXRjIHRvIGl0KSBpcyBvbmx5IGF2YWlsYWJsZSBpbiBnbG9iYWxzIGJ1aWxkcwogIEVtYmVyLnJ1biA9IF9ydW5sb29wLl9nbG9iYWxzUnVuOwogIEVtYmVyLnJ1bi5iYWNrYnVybmVyID0gX3J1bmxvb3AuYmFja2J1cm5lcjsKICBFbWJlci5ydW4uYmVnaW4gPSBfcnVubG9vcC5iZWdpbjsKICBFbWJlci5ydW4uYmluZCA9IF9ydW5sb29wLmJpbmQ7CiAgRW1iZXIucnVuLmNhbmNlbCA9IF9ydW5sb29wLmNhbmNlbDsKICBFbWJlci5ydW4uZGVib3VuY2UgPSBfcnVubG9vcC5kZWJvdW5jZTsKICBFbWJlci5ydW4uZW5kID0gX3J1bmxvb3AuZW5kOwogIEVtYmVyLnJ1bi5oYXNTY2hlZHVsZWRUaW1lcnMgPSBfcnVubG9vcC5oYXNTY2hlZHVsZWRUaW1lcnM7CiAgRW1iZXIucnVuLmpvaW4gPSBfcnVubG9vcC5qb2luOwogIEVtYmVyLnJ1bi5sYXRlciA9IF9ydW5sb29wLmxhdGVyOwogIEVtYmVyLnJ1bi5uZXh0ID0gX3J1bmxvb3AubmV4dDsKICBFbWJlci5ydW4ub25jZSA9IF9ydW5sb29wLm9uY2U7CiAgRW1iZXIucnVuLnNjaGVkdWxlID0gX3J1bmxvb3Auc2NoZWR1bGU7CiAgRW1iZXIucnVuLnNjaGVkdWxlT25jZSA9IF9ydW5sb29wLnNjaGVkdWxlT25jZTsKICBFbWJlci5ydW4udGhyb3R0bGUgPSBfcnVubG9vcC50aHJvdHRsZTsKICBFbWJlci5ydW4uY2FuY2VsVGltZXJzID0gX3J1bmxvb3AuY2FuY2VsVGltZXJzOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlci5ydW4sICdjdXJyZW50UnVuTG9vcCcsIHsKICAgIGdldDogX3J1bmxvb3AuZ2V0Q3VycmVudFJ1bkxvb3AsCiAgICBlbnVtZXJhYmxlOiBmYWxzZQogIH0pOwoKICAvLyAqKioqZW1iZXItbWV0YWwqKioqCgogIC8vIFVzaW5nIF9nbG9iYWxzQ29tcHV0ZWQgaGVyZSBzbyB0aGF0IG11dGF0aW5nIHRoZSBmdW5jdGlvbiBpcyBvbmx5IGF2YWlsYWJsZQogIC8vIGluIGdsb2JhbHMgYnVpbGRzCiAgdmFyIGNvbXB1dGVkID0gX2VtYmVyTWV0YWwuX2dsb2JhbHNDb21wdXRlZDsKICBFbWJlci5jb21wdXRlZCA9IGNvbXB1dGVkOwogIGNvbXB1dGVkLmFsaWFzID0gX2VtYmVyTWV0YWwuYWxpYXM7CiAgRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eSA9IF9lbWJlck1ldGFsLkNvbXB1dGVkUHJvcGVydHk7CiAgRW1iZXIuY2FjaGVGb3IgPSBfZW1iZXJNZXRhbC5nZXRDYWNoZWRWYWx1ZUZvcjsKICBFbWJlci5tZXRhID0gX2VtYmVyTWV0YS5tZXRhOwogIEVtYmVyLmdldCA9IF9lbWJlck1ldGFsLmdldDsKICBFbWJlci5nZXRXaXRoRGVmYXVsdCA9IF9lbWJlck1ldGFsLmdldFdpdGhEZWZhdWx0OwogIEVtYmVyLl9nZXRQYXRoID0gX2VtYmVyTWV0YWwuX2dldFBhdGg7CiAgRW1iZXIuc2V0ID0gX2VtYmVyTWV0YWwuc2V0OwogIEVtYmVyLnRyeVNldCA9IF9lbWJlck1ldGFsLnRyeVNldDsKICBFbWJlci5GRUFUVVJFUyA9ICgwLCBfcG9seWZpbGxzLmFzc2lnbikoeyBpc0VuYWJsZWQ6IF9jYW5hcnlGZWF0dXJlcy5pc0VuYWJsZWQgfSwgX2NhbmFyeUZlYXR1cmVzLkZFQVRVUkVTKTsKICBFbWJlci5fQ2FjaGUgPSBfZW1iZXJVdGlscy5DYWNoZTsKICBFbWJlci5vbiA9IF9lbWJlck1ldGFsLm9uOwogIEVtYmVyLmFkZExpc3RlbmVyID0gX2VtYmVyTWV0YWwuYWRkTGlzdGVuZXI7CiAgRW1iZXIucmVtb3ZlTGlzdGVuZXIgPSBfZW1iZXJNZXRhbC5yZW1vdmVMaXN0ZW5lcjsKICBFbWJlci5zZW5kRXZlbnQgPSBfZW1iZXJNZXRhbC5zZW5kRXZlbnQ7CiAgRW1iZXIuaGFzTGlzdGVuZXJzID0gX2VtYmVyTWV0YWwuaGFzTGlzdGVuZXJzOwogIEVtYmVyLmlzTm9uZSA9IF9lbWJlck1ldGFsLmlzTm9uZTsKICBFbWJlci5pc0VtcHR5ID0gX2VtYmVyTWV0YWwuaXNFbXB0eTsKICBFbWJlci5pc0JsYW5rID0gX2VtYmVyTWV0YWwuaXNCbGFuazsKICBFbWJlci5pc1ByZXNlbnQgPSBfZW1iZXJNZXRhbC5pc1ByZXNlbnQ7CiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUFJPUEVSVFlfV0lMTF9DSEFOR0UpIHsKICAgIEVtYmVyLnByb3BlcnR5V2lsbENoYW5nZSA9IF9lbWJlck1ldGFsLnByb3BlcnR5V2lsbENoYW5nZTsKICB9CiAgaWYgKF9kZXByZWNhdGVkRmVhdHVyZXMuUFJPUEVSVFlfRElEX0NIQU5HRSkgewogICAgRW1iZXIucHJvcGVydHlEaWRDaGFuZ2UgPSBfZW1iZXJNZXRhbC5wcm9wZXJ0eURpZENoYW5nZTsKICB9CiAgRW1iZXIubm90aWZ5UHJvcGVydHlDaGFuZ2UgPSBfZW1iZXJNZXRhbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZTsKICBFbWJlci5vdmVycmlkZUNoYWlucyA9IF9lbWJlck1ldGFsLm92ZXJyaWRlQ2hhaW5zOwogIEVtYmVyLmJlZ2luUHJvcGVydHlDaGFuZ2VzID0gX2VtYmVyTWV0YWwuYmVnaW5Qcm9wZXJ0eUNoYW5nZXM7CiAgRW1iZXIuZW5kUHJvcGVydHlDaGFuZ2VzID0gX2VtYmVyTWV0YWwuZW5kUHJvcGVydHlDaGFuZ2VzOwogIEVtYmVyLmNoYW5nZVByb3BlcnRpZXMgPSBfZW1iZXJNZXRhbC5jaGFuZ2VQcm9wZXJ0aWVzOwogIEVtYmVyLnBsYXRmb3JtID0gewogICAgZGVmaW5lUHJvcGVydHk6IHRydWUsCiAgICBoYXNQcm9wZXJ0eUFjY2Vzc29yczogdHJ1ZQogIH07CiAgRW1iZXIuZGVmaW5lUHJvcGVydHkgPSBfZW1iZXJNZXRhbC5kZWZpbmVQcm9wZXJ0eTsKICBFbWJlci53YXRjaEtleSA9IF9lbWJlck1ldGFsLndhdGNoS2V5OwogIEVtYmVyLnVud2F0Y2hLZXkgPSBfZW1iZXJNZXRhbC51bndhdGNoS2V5OwogIEVtYmVyLnJlbW92ZUNoYWluV2F0Y2hlciA9IF9lbWJlck1ldGFsLnJlbW92ZUNoYWluV2F0Y2hlcjsKICBFbWJlci5fQ2hhaW5Ob2RlID0gX2VtYmVyTWV0YWwuQ2hhaW5Ob2RlOwogIEVtYmVyLmZpbmlzaENoYWlucyA9IF9lbWJlck1ldGFsLmZpbmlzaENoYWluczsKICBFbWJlci53YXRjaFBhdGggPSBfZW1iZXJNZXRhbC53YXRjaFBhdGg7CiAgRW1iZXIudW53YXRjaFBhdGggPSBfZW1iZXJNZXRhbC51bndhdGNoUGF0aDsKICBFbWJlci53YXRjaCA9IF9lbWJlck1ldGFsLndhdGNoOwogIEVtYmVyLmlzV2F0Y2hpbmcgPSBfZW1iZXJNZXRhbC5pc1dhdGNoaW5nOwogIEVtYmVyLnVud2F0Y2ggPSBfZW1iZXJNZXRhbC51bndhdGNoOwogIEVtYmVyLmRlc3Ryb3kgPSBfZW1iZXJNZXRhLmRlbGV0ZU1ldGE7CiAgRW1iZXIubGlicmFyaWVzID0gX2VtYmVyTWV0YWwubGlicmFyaWVzOwogIEVtYmVyLmdldFByb3BlcnRpZXMgPSBfZW1iZXJNZXRhbC5nZXRQcm9wZXJ0aWVzOwogIEVtYmVyLnNldFByb3BlcnRpZXMgPSBfZW1iZXJNZXRhbC5zZXRQcm9wZXJ0aWVzOwogIEVtYmVyLmV4cGFuZFByb3BlcnRpZXMgPSBfZW1iZXJNZXRhbC5leHBhbmRQcm9wZXJ0aWVzOwogIEVtYmVyLmFkZE9ic2VydmVyID0gX2VtYmVyTWV0YWwuYWRkT2JzZXJ2ZXI7CiAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIgPSBfZW1iZXJNZXRhbC5yZW1vdmVPYnNlcnZlcjsKICBFbWJlci5hbGlhc01ldGhvZCA9IF9lbWJlck1ldGFsLmFsaWFzTWV0aG9kOwogIEVtYmVyLm9ic2VydmVyID0gX2VtYmVyTWV0YWwub2JzZXJ2ZXI7CiAgRW1iZXIubWl4aW4gPSBfZW1iZXJNZXRhbC5taXhpbjsKICBFbWJlci5NaXhpbiA9IF9lbWJlck1ldGFsLk1peGluOwoKICAvKioKICAgIEEgZnVuY3Rpb24gbWF5IGJlIGFzc2lnbmVkIHRvIGBFbWJlci5vbmVycm9yYCB0byBiZSBjYWxsZWQgd2hlbiBFbWJlcgogICAgaW50ZXJuYWxzIGVuY291bnRlciBhbiBlcnJvci4gVGhpcyBpcyB1c2VmdWwgZm9yIHNwZWNpYWxpemVkIGVycm9yIGhhbmRsaW5nCiAgICBhbmQgcmVwb3J0aW5nIGNvZGUuCiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogIAogICAgRW1iZXIub25lcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICQuYWpheCgnL3JlcG9ydC1lcnJvcicsICdQT1NUJywgewogICAgICAgIHN0YWNrOiBlcnJvci5zdGFjaywKICAgICAgICBvdGhlckluZm9ybWF0aW9uOiAnd2hhdGV2ZXIgYXBwIHN0YXRlIHlvdSB3YW50IHRvIHByb3ZpZGUnCiAgICAgIH0pOwogICAgfTsKICAgIGBgYAogIAogICAgSW50ZXJuYWxseSwgYEVtYmVyLm9uZXJyb3JgIGlzIHVzZWQgYXMgQmFja2J1cm5lcidzIGVycm9yIGhhbmRsZXIuCiAgCiAgICBAZXZlbnQgb25lcnJvcgogICAgQGZvciBFbWJlcgogICAgQHBhcmFtIHtFeGNlcHRpb259IGVycm9yIHRoZSBlcnJvciBvYmplY3QKICAgIEBwdWJsaWMKICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJ29uZXJyb3InLCB7CiAgICBnZXQ6IF9lbWJlckVycm9ySGFuZGxpbmcuZ2V0T25lcnJvciwKICAgIHNldDogX2VtYmVyRXJyb3JIYW5kbGluZy5zZXRPbmVycm9yLAogICAgZW51bWVyYWJsZTogZmFsc2UKICB9KTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAndGVzdGluZycsIHsKICAgIGdldDogX2RlYnVnLmlzVGVzdGluZywKICAgIHNldDogX2RlYnVnLnNldFRlc3RpbmcsCiAgICBlbnVtZXJhYmxlOiBmYWxzZQogIH0pOwoKICBFbWJlci5fQmFja2J1cm5lciA9IF9iYWNrYnVybmVyLmRlZmF1bHQ7CgogIC8vICoqKiplbWJlci1jb25zb2xlKioqKgogIGlmIChfZGVwcmVjYXRlZEZlYXR1cmVzLkxPR0dFUikgewogICAgRW1iZXIuTG9nZ2VyID0gX2VtYmVyQ29uc29sZS5kZWZhdWx0OwogIH0KCiAgLy8gKioqKmVtYmVyLXJ1bnRpbWUqKioqCiAgRW1iZXIuQSA9IF9lbWJlclJ1bnRpbWUuQTsKICBFbWJlci5TdHJpbmcgPSB7CiAgICBsb2M6IF9zdHJpbmcubG9jLAogICAgdzogX3N0cmluZy53LAogICAgZGFzaGVyaXplOiBfc3RyaW5nLmRhc2hlcml6ZSwKICAgIGRlY2FtZWxpemU6IF9zdHJpbmcuZGVjYW1lbGl6ZSwKICAgIGNhbWVsaXplOiBfc3RyaW5nLmNhbWVsaXplLAogICAgY2xhc3NpZnk6IF9zdHJpbmcuY2xhc3NpZnksCiAgICB1bmRlcnNjb3JlOiBfc3RyaW5nLnVuZGVyc2NvcmUsCiAgICBjYXBpdGFsaXplOiBfc3RyaW5nLmNhcGl0YWxpemUKICB9OwogIEVtYmVyLk9iamVjdCA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0OwogIEVtYmVyLl9SZWdpc3RyeVByb3h5TWl4aW4gPSBfZW1iZXJSdW50aW1lLlJlZ2lzdHJ5UHJveHlNaXhpbjsKICBFbWJlci5fQ29udGFpbmVyUHJveHlNaXhpbiA9IF9lbWJlclJ1bnRpbWUuQ29udGFpbmVyUHJveHlNaXhpbjsKICBFbWJlci5jb21wYXJlID0gX2VtYmVyUnVudGltZS5jb21wYXJlOwogIEVtYmVyLmNvcHkgPSBfZW1iZXJSdW50aW1lLmNvcHk7CiAgRW1iZXIuaXNFcXVhbCA9IF9lbWJlclJ1bnRpbWUuaXNFcXVhbDsKCiAgLyoqCiAgQG1vZHVsZSBlbWJlcgogICovCgogIC8qKgogICAgTmFtZXNwYWNlIGZvciBpbmplY3Rpb24gaGVscGVyIG1ldGhvZHMuCiAgCiAgICBAY2xhc3MgaW5qZWN0CiAgICBAbmFtZXNwYWNlIEVtYmVyCiAgICBAc3RhdGljCiAgICBAcHVibGljCiAgKi8KICBFbWJlci5pbmplY3QgPSBmdW5jdGlvbiBpbmplY3QoKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiAoMCwgX2RlYnVnLmFzc2VydCkoJ0luamVjdGVkIHByb3BlcnRpZXMgbXVzdCBiZSBjcmVhdGVkIHRocm91Z2ggaGVscGVycywgc2VlIFwnJyArIE9iamVjdC5rZXlzKGluamVjdCkubWFwKGZ1bmN0aW9uIChrKSB7CiAgICAgIHJldHVybiAnXCdpbmplY3QuJyArIGsgKyAnXCcnOwogICAgfSkuam9pbignIG9yICcpICsgJ1wnJykpOwogIH07CiAgRW1iZXIuaW5qZWN0LnNlcnZpY2UgPSBfc2VydmljZS5pbmplY3Q7CiAgRW1iZXIuaW5qZWN0LmNvbnRyb2xsZXIgPSBfY29udHJvbGxlci5pbmplY3Q7CgogIEVtYmVyLkFycmF5ID0gX2VtYmVyUnVudGltZS5BcnJheTsKICBFbWJlci5Db21wYXJhYmxlID0gX2VtYmVyUnVudGltZS5Db21wYXJhYmxlOwogIEVtYmVyLkVudW1lcmFibGUgPSBfZW1iZXJSdW50aW1lLkVudW1lcmFibGU7CiAgRW1iZXIuQXJyYXlQcm94eSA9IF9lbWJlclJ1bnRpbWUuQXJyYXlQcm94eTsKICBFbWJlci5PYmplY3RQcm94eSA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0UHJveHk7CiAgRW1iZXIuQWN0aW9uSGFuZGxlciA9IF9lbWJlclJ1bnRpbWUuQWN0aW9uSGFuZGxlcjsKICBFbWJlci5Db3JlT2JqZWN0ID0gX2VtYmVyUnVudGltZS5Db3JlT2JqZWN0OwogIEVtYmVyLk5hdGl2ZUFycmF5ID0gX2VtYmVyUnVudGltZS5OYXRpdmVBcnJheTsKICBFbWJlci5Db3B5YWJsZSA9IF9lbWJlclJ1bnRpbWUuQ29weWFibGU7CiAgRW1iZXIuTXV0YWJsZUVudW1lcmFibGUgPSBfZW1iZXJSdW50aW1lLk11dGFibGVFbnVtZXJhYmxlOwogIEVtYmVyLk11dGFibGVBcnJheSA9IF9lbWJlclJ1bnRpbWUuTXV0YWJsZUFycmF5OwogIEVtYmVyLlRhcmdldEFjdGlvblN1cHBvcnQgPSBfZW1iZXJSdW50aW1lLlRhcmdldEFjdGlvblN1cHBvcnQ7CiAgRW1iZXIuRXZlbnRlZCA9IF9lbWJlclJ1bnRpbWUuRXZlbnRlZDsKICBFbWJlci5Qcm9taXNlUHJveHlNaXhpbiA9IF9lbWJlclJ1bnRpbWUuUHJvbWlzZVByb3h5TWl4aW47CiAgRW1iZXIuT2JzZXJ2YWJsZSA9IF9lbWJlclJ1bnRpbWUuT2JzZXJ2YWJsZTsKICBFbWJlci50eXBlT2YgPSBfZW1iZXJSdW50aW1lLnR5cGVPZjsKICBFbWJlci5pc0FycmF5ID0gX2VtYmVyUnVudGltZS5pc0FycmF5OwogIEVtYmVyLk9iamVjdCA9IF9lbWJlclJ1bnRpbWUuT2JqZWN0OwogIEVtYmVyLm9uTG9hZCA9IF9hcHBsaWNhdGlvbi5vbkxvYWQ7CiAgRW1iZXIucnVuTG9hZEhvb2tzID0gX2FwcGxpY2F0aW9uLnJ1bkxvYWRIb29rczsKICBFbWJlci5Db250cm9sbGVyID0gX2NvbnRyb2xsZXIuZGVmYXVsdDsKICBFbWJlci5Db250cm9sbGVyTWl4aW4gPSBfY29udHJvbGxlcl9taXhpbi5kZWZhdWx0OwogIEVtYmVyLlNlcnZpY2UgPSBfc2VydmljZS5kZWZhdWx0OwogIEVtYmVyLl9Qcm94eU1peGluID0gX2VtYmVyUnVudGltZS5fUHJveHlNaXhpbjsKICBFbWJlci5SU1ZQID0gX2VtYmVyUnVudGltZS5SU1ZQOwogIEVtYmVyLk5hbWVzcGFjZSA9IF9lbWJlclJ1bnRpbWUuTmFtZXNwYWNlOwoKICBjb21wdXRlZC5lbXB0eSA9IF9jb21wdXRlZC5lbXB0eTsKICBjb21wdXRlZC5ub3RFbXB0eSA9IF9jb21wdXRlZC5ub3RFbXB0eTsKICBjb21wdXRlZC5ub25lID0gX2NvbXB1dGVkLm5vbmU7CiAgY29tcHV0ZWQubm90ID0gX2NvbXB1dGVkLm5vdDsKICBjb21wdXRlZC5ib29sID0gX2NvbXB1dGVkLmJvb2w7CiAgY29tcHV0ZWQubWF0Y2ggPSBfY29tcHV0ZWQubWF0Y2g7CiAgY29tcHV0ZWQuZXF1YWwgPSBfY29tcHV0ZWQuZXF1YWw7CiAgY29tcHV0ZWQuZ3QgPSBfY29tcHV0ZWQuZ3Q7CiAgY29tcHV0ZWQuZ3RlID0gX2NvbXB1dGVkLmd0ZTsKICBjb21wdXRlZC5sdCA9IF9jb21wdXRlZC5sdDsKICBjb21wdXRlZC5sdGUgPSBfY29tcHV0ZWQubHRlOwogIGNvbXB1dGVkLm9uZVdheSA9IF9jb21wdXRlZC5vbmVXYXk7CiAgY29tcHV0ZWQucmVhZHMgPSBfY29tcHV0ZWQub25lV2F5OwogIGNvbXB1dGVkLnJlYWRPbmx5ID0gX2NvbXB1dGVkLnJlYWRPbmx5OwogIGNvbXB1dGVkLmRlcHJlY2F0aW5nQWxpYXMgPSBfY29tcHV0ZWQuZGVwcmVjYXRpbmdBbGlhczsKICBjb21wdXRlZC5hbmQgPSBfY29tcHV0ZWQuYW5kOwogIGNvbXB1dGVkLm9yID0gX2NvbXB1dGVkLm9yOwoKICBjb21wdXRlZC5zdW0gPSBfY29tcHV0ZWQuc3VtOwogIGNvbXB1dGVkLm1pbiA9IF9jb21wdXRlZC5taW47CiAgY29tcHV0ZWQubWF4ID0gX2NvbXB1dGVkLm1heDsKICBjb21wdXRlZC5tYXAgPSBfY29tcHV0ZWQubWFwOwogIGNvbXB1dGVkLnNvcnQgPSBfY29tcHV0ZWQuc29ydDsKICBjb21wdXRlZC5zZXREaWZmID0gX2NvbXB1dGVkLnNldERpZmY7CiAgY29tcHV0ZWQubWFwQnkgPSBfY29tcHV0ZWQubWFwQnk7CiAgY29tcHV0ZWQuZmlsdGVyID0gX2NvbXB1dGVkLmZpbHRlcjsKICBjb21wdXRlZC5maWx0ZXJCeSA9IF9jb21wdXRlZC5maWx0ZXJCeTsKICBjb21wdXRlZC51bmlxID0gX2NvbXB1dGVkLnVuaXE7CgogIGNvbXB1dGVkLnVuaXFCeSA9IF9jb21wdXRlZC51bmlxQnk7CiAgY29tcHV0ZWQudW5pb24gPSBfY29tcHV0ZWQudW5pb247CiAgY29tcHV0ZWQuaW50ZXJzZWN0ID0gX2NvbXB1dGVkLmludGVyc2VjdDsKICBjb21wdXRlZC5jb2xsZWN0ID0gX2NvbXB1dGVkLmNvbGxlY3Q7CgogIC8qKgogICAgRGVmaW5lcyB0aGUgaGFzaCBvZiBsb2NhbGl6ZWQgc3RyaW5ncyBmb3IgdGhlIGN1cnJlbnQgbGFuZ3VhZ2UuIFVzZWQgYnkKICAgIHRoZSBgU3RyaW5nLmxvY2AgaGVscGVyLiBUbyBsb2NhbGl6ZSwgYWRkIHN0cmluZyB2YWx1ZXMgdG8gdGhpcwogICAgaGFzaC4KICAKICAgIEBwcm9wZXJ0eSBTVFJJTkdTCiAgICBAZm9yIEVtYmVyCiAgICBAdHlwZSBPYmplY3QKICAgIEBwcml2YXRlCiAgKi8KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIsICdTVFJJTkdTJywgewogICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgIGdldDogX3N0cmluZy5fZ2V0U3RyaW5ncywKICAgIHNldDogX3N0cmluZy5fc2V0U3RyaW5ncwogIH0pOwoKICAvKioKICAgIFdoZXRoZXIgc2VhcmNoaW5nIG9uIHRoZSBnbG9iYWwgZm9yIG5ldyBOYW1lc3BhY2UgaW5zdGFuY2VzIGlzIGVuYWJsZWQuCiAgCiAgICBUaGlzIGlzIG9ubHkgZXhwb3J0ZWQgaGVyZSBhcyB0byBub3QgYnJlYWsgYW55IGFkZG9ucy4gIEdpdmVuIHRoZSBuZXcKICAgIHZpc2l0IEFQSSwgeW91IHdpbGwgaGF2ZSBpc3N1ZXMgaWYgeW91IHRyZWF0IHRoaXMgYXMgYSBpbmRpY2F0b3Igb2YKICAgIGJvb3RlZC4KICAKICAgIEludGVybmFsbHkgdGhpcyBpcyBvbmx5IGV4cG9zaW5nIGEgZmxhZyBpbiBOYW1lc3BhY2UuCiAgCiAgICBAcHJvcGVydHkgQk9PVEVECiAgICBAZm9yIEVtYmVyCiAgICBAdHlwZSBCb29sZWFuCiAgICBAcHJpdmF0ZQogICovCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVtYmVyLCAnQk9PVEVEJywgewogICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgZ2V0OiBfZW1iZXJNZXRhbC5pc05hbWVzcGFjZVNlYXJjaERpc2FibGVkLAogICAgc2V0OiBfZW1iZXJNZXRhbC5zZXROYW1lc3BhY2VTZWFyY2hEaXNhYmxlZAogIH0pOwoKICAvLyAqKioqZW1iZXItZ2xpbW1lcioqKioKICBFbWJlci5Db21wb25lbnQgPSBfZW1iZXJHbGltbWVyLkNvbXBvbmVudDsKICBfZW1iZXJHbGltbWVyLkhlbHBlci5oZWxwZXIgPSBfZW1iZXJHbGltbWVyLmhlbHBlcjsKICBFbWJlci5IZWxwZXIgPSBfZW1iZXJHbGltbWVyLkhlbHBlcjsKICBFbWJlci5DaGVja2JveCA9IF9lbWJlckdsaW1tZXIuQ2hlY2tib3g7CiAgRW1iZXIuVGV4dEZpZWxkID0gX2VtYmVyR2xpbW1lci5UZXh0RmllbGQ7CiAgRW1iZXIuVGV4dEFyZWEgPSBfZW1iZXJHbGltbWVyLlRleHRBcmVhOwogIEVtYmVyLkxpbmtDb21wb25lbnQgPSBfZW1iZXJHbGltbWVyLkxpbmtDb21wb25lbnQ7CiAgRW1iZXIuX3NldENvbXBvbmVudE1hbmFnZXIgPSBfZW1iZXJHbGltbWVyLmNvbXBvbmVudE1hbmFnZXI7CiAgRW1iZXIuSGFuZGxlYmFycyA9IHsKICAgIHRlbXBsYXRlOiBfZW1iZXJHbGltbWVyLnRlbXBsYXRlLAogICAgVXRpbHM6IHsKICAgICAgZXNjYXBlRXhwcmVzc2lvbjogX2VtYmVyR2xpbW1lci5lc2NhcGVFeHByZXNzaW9uCiAgICB9CiAgfTsKICBFbWJlci5IVE1MQmFycyA9IHsKICAgIHRlbXBsYXRlOiBfZW1iZXJHbGltbWVyLnRlbXBsYXRlCiAgfTsKCiAgaWYgKF9lbWJlckVudmlyb25tZW50LkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcpIHsKICAgIFN0cmluZy5wcm90b3R5cGUuaHRtbFNhZmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVyR2xpbW1lci5odG1sU2FmZSkodGhpcyk7CiAgICB9OwogIH0KICBFbWJlci5TdHJpbmcuaHRtbFNhZmUgPSBfZW1iZXJHbGltbWVyLmh0bWxTYWZlOwogIEVtYmVyLlN0cmluZy5pc0hUTUxTYWZlID0gX2VtYmVyR2xpbW1lci5pc0hUTUxTYWZlOwoKICAvKioKICAgIEdsb2JhbCBoYXNoIG9mIHNoYXJlZCB0ZW1wbGF0ZXMuIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIHBvcHVsYXRlZAogICAgYnkgdGhlIGJ1aWxkIHRvb2xzIHNvIHRoYXQgeW91IGNhbiBzdG9yZSB5b3VyIEhhbmRsZWJhcnMgdGVtcGxhdGVzIGluCiAgICBzZXBhcmF0ZSBmaWxlcyB0aGF0IGdldCBsb2FkZWQgaW50byBKYXZhU2NyaXB0IGF0IGJ1aWxkdGltZS4KICAKICAgIEBwcm9wZXJ0eSBURU1QTEFURVMKICAgIEBmb3IgRW1iZXIKICAgIEB0eXBlIE9iamVjdAogICAgQHByaXZhdGUKICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJ1RFTVBMQVRFUycsIHsKICAgIGdldDogX2VtYmVyR2xpbW1lci5nZXRUZW1wbGF0ZXMsCiAgICBzZXQ6IF9lbWJlckdsaW1tZXIuc2V0VGVtcGxhdGVzLAogICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgIGVudW1lcmFibGU6IGZhbHNlCiAgfSk7CgogIC8qKgogICAgVGhlIHNlbWFudGljIHZlcnNpb24KICAKICAgIEBwcm9wZXJ0eSBWRVJTSU9OCiAgICBAdHlwZSBTdHJpbmcKICAgIEBwdWJsaWMKICAqLwogIEVtYmVyLlZFUlNJT04gPSBfdmVyc2lvbi5kZWZhdWx0OwoKICAvLyAqKioqZW1iZXItdmlld3MqKioqCiAgaWYgKCFfZW1iZXJWaWV3cy5qUXVlcnlEaXNhYmxlZCkgewogICAgRW1iZXIuJCA9IF9lbWJlclZpZXdzLmpRdWVyeTsKICB9CiAgRW1iZXIuVmlld1V0aWxzID0gewogICAgaXNTaW1wbGVDbGljazogX2VtYmVyVmlld3MuaXNTaW1wbGVDbGljaywKICAgIGdldFZpZXdFbGVtZW50OiBfZW1iZXJWaWV3cy5nZXRWaWV3RWxlbWVudCwKICAgIGdldFZpZXdCb3VuZHM6IF9lbWJlclZpZXdzLmdldFZpZXdCb3VuZHMsCiAgICBnZXRWaWV3Q2xpZW50UmVjdHM6IF9lbWJlclZpZXdzLmdldFZpZXdDbGllbnRSZWN0cywKICAgIGdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3Q6IF9lbWJlclZpZXdzLmdldFZpZXdCb3VuZGluZ0NsaWVudFJlY3QsCiAgICBnZXRSb290Vmlld3M6IF9lbWJlclZpZXdzLmdldFJvb3RWaWV3cywKICAgIGdldENoaWxkVmlld3M6IF9lbWJlclZpZXdzLmdldENoaWxkVmlld3MsCiAgICBpc1NlcmlhbGl6YXRpb25GaXJzdE5vZGU6IF9lbWJlckdsaW1tZXIuaXNTZXJpYWxpemF0aW9uRmlyc3ROb2RlCiAgfTsKICBFbWJlci5UZXh0U3VwcG9ydCA9IF9lbWJlclZpZXdzLlRleHRTdXBwb3J0OwogIEVtYmVyLkNvbXBvbmVudExvb2t1cCA9IF9lbWJlclZpZXdzLkNvbXBvbmVudExvb2t1cDsKICBFbWJlci5FdmVudERpc3BhdGNoZXIgPSBfZW1iZXJWaWV3cy5FdmVudERpc3BhdGNoZXI7CgogIC8vICoqKiplbWJlci1yb3V0aW5nKioqKgogIEVtYmVyLkxvY2F0aW9uID0gX2VtYmVyUm91dGluZy5Mb2NhdGlvbjsKICBFbWJlci5BdXRvTG9jYXRpb24gPSBfZW1iZXJSb3V0aW5nLkF1dG9Mb2NhdGlvbjsKICBFbWJlci5IYXNoTG9jYXRpb24gPSBfZW1iZXJSb3V0aW5nLkhhc2hMb2NhdGlvbjsKICBFbWJlci5IaXN0b3J5TG9jYXRpb24gPSBfZW1iZXJSb3V0aW5nLkhpc3RvcnlMb2NhdGlvbjsKICBFbWJlci5Ob25lTG9jYXRpb24gPSBfZW1iZXJSb3V0aW5nLk5vbmVMb2NhdGlvbjsKICBFbWJlci5jb250cm9sbGVyRm9yID0gX2VtYmVyUm91dGluZy5jb250cm9sbGVyRm9yOwogIEVtYmVyLmdlbmVyYXRlQ29udHJvbGxlckZhY3RvcnkgPSBfZW1iZXJSb3V0aW5nLmdlbmVyYXRlQ29udHJvbGxlckZhY3Rvcnk7CiAgRW1iZXIuZ2VuZXJhdGVDb250cm9sbGVyID0gX2VtYmVyUm91dGluZy5nZW5lcmF0ZUNvbnRyb2xsZXI7CiAgRW1iZXIuUm91dGVyRFNMID0gX2VtYmVyUm91dGluZy5Sb3V0ZXJEU0w7CiAgRW1iZXIuUm91dGVyID0gX2VtYmVyUm91dGluZy5Sb3V0ZXI7CiAgRW1iZXIuUm91dGUgPSBfZW1iZXJSb3V0aW5nLlJvdXRlOwoKICAoMCwgX2FwcGxpY2F0aW9uLnJ1bkxvYWRIb29rcykoJ0VtYmVyLkFwcGxpY2F0aW9uJywgX2FwcGxpY2F0aW9uLmRlZmF1bHQpOwoKICBFbWJlci5EYXRhQWRhcHRlciA9IF9lbWJlckV4dGVuc2lvblN1cHBvcnQuRGF0YUFkYXB0ZXI7CiAgRW1iZXIuQ29udGFpbmVyRGVidWdBZGFwdGVyID0gX2VtYmVyRXh0ZW5zaW9uU3VwcG9ydC5Db250YWluZXJEZWJ1Z0FkYXB0ZXI7CgogIGlmICgoMCwgX3JlcXVpcmUyLmhhcykoJ2VtYmVyLXRlbXBsYXRlLWNvbXBpbGVyJykpIHsKICAgICgwLCBfcmVxdWlyZTIuZGVmYXVsdCkoJ2VtYmVyLXRlbXBsYXRlLWNvbXBpbGVyJyk7CiAgfQoKICAvLyBkbyB0aGlzIHRvIGVuc3VyZSB0aGF0IEVtYmVyLlRlc3QgaXMgZGVmaW5lZCBwcm9wZXJseSBvbiB0aGUgZ2xvYmFsCiAgLy8gaWYgaXQgaXMgcHJlc2VudC4KICBpZiAoKDAsIF9yZXF1aXJlMi5oYXMpKCdlbWJlci10ZXN0aW5nJykpIHsKICAgIHZhciB0ZXN0aW5nID0gKDAsIF9yZXF1aXJlMi5kZWZhdWx0KSgnZW1iZXItdGVzdGluZycpOwoKICAgIEVtYmVyLlRlc3QgPSB0ZXN0aW5nLlRlc3Q7CiAgICBFbWJlci5UZXN0LkFkYXB0ZXIgPSB0ZXN0aW5nLkFkYXB0ZXI7CiAgICBFbWJlci5UZXN0LlFVbml0QWRhcHRlciA9IHRlc3RpbmcuUVVuaXRBZGFwdGVyOwogICAgRW1iZXIuc2V0dXBGb3JUZXN0aW5nID0gdGVzdGluZy5zZXR1cEZvclRlc3Rpbmc7CiAgfQoKICAoMCwgX2FwcGxpY2F0aW9uLnJ1bkxvYWRIb29rcykoJ0VtYmVyJyk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyOwoKCiAgaWYgKF9ub2RlTW9kdWxlLklTX05PREUpIHsKICAgIF9ub2RlTW9kdWxlLm1vZHVsZS5leHBvcnRzID0gRW1iZXI7CiAgfSBlbHNlIHsKICAgIF9lbWJlckVudmlyb25tZW50LmNvbnRleHQuZXhwb3J0cy5FbWJlciA9IF9lbWJlckVudmlyb25tZW50LmNvbnRleHQuZXhwb3J0cy5FbSA9IEVtYmVyOwogIH0KCiAgLyoqCiAgIEBtb2R1bGUganF1ZXJ5CiAgIEBwdWJsaWMKICAgKi8KCiAgLyoqCiAgIEBjbGFzcyBqcXVlcnkKICAgQHB1YmxpYwogICBAc3RhdGljCiAgICovCgogIC8qKgogICAgQWxpYXMgZm9yIGpRdWVyeQogIAogICAgQGZvciBqcXVlcnkKICAgIEBtZXRob2QgJAogICAgQHN0YXRpYwogICAgQHB1YmxpYwogICovCn0pOwplbmlmZWQoImVtYmVyL3ZlcnNpb24iLCBbImV4cG9ydHMiXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIGV4cG9ydHMuZGVmYXVsdCA9ICIzLjMuMSI7Cn0pOwovKmdsb2JhbCBlbmlmZWQsIG1vZHVsZSAqLwplbmlmZWQoJ25vZGUtbW9kdWxlJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uKF9leHBvcnRzKSB7CiAgdmFyIElTX05PREUgPSB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlLnJlcXVpcmUgPT09ICdmdW5jdGlvbic7CiAgaWYgKElTX05PREUpIHsKICAgIF9leHBvcnRzLnJlcXVpcmUgPSBtb2R1bGUucmVxdWlyZTsKICAgIF9leHBvcnRzLm1vZHVsZSA9IG1vZHVsZTsKICAgIF9leHBvcnRzLklTX05PREUgPSBJU19OT0RFOwogIH0gZWxzZSB7CiAgICBfZXhwb3J0cy5yZXF1aXJlID0gbnVsbDsKICAgIF9leHBvcnRzLm1vZHVsZSA9IG51bGw7CiAgICBfZXhwb3J0cy5JU19OT0RFID0gSVNfTk9ERTsKICB9Cn0pOwoKZW5pZmVkKCJyb3V0ZS1yZWNvZ25pemVyIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIGNyZWF0ZU9iamVjdCA9IE9iamVjdC5jcmVhdGU7CiAgICBmdW5jdGlvbiBjcmVhdGVNYXAoKSB7CiAgICAgICAgdmFyIG1hcCA9IGNyZWF0ZU9iamVjdChudWxsKTsKICAgICAgICBtYXBbIl9fIl0gPSB1bmRlZmluZWQ7CiAgICAgICAgZGVsZXRlIG1hcFsiX18iXTsKICAgICAgICByZXR1cm4gbWFwOwogICAgfQoKICAgIHZhciBUYXJnZXQgPSBmdW5jdGlvbiBUYXJnZXQocGF0aCwgbWF0Y2hlciwgZGVsZWdhdGUpIHsKICAgICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICAgIHRoaXMubWF0Y2hlciA9IG1hdGNoZXI7CiAgICAgICAgdGhpcy5kZWxlZ2F0ZSA9IGRlbGVnYXRlOwogICAgfTsKICAgIFRhcmdldC5wcm90b3R5cGUudG8gPSBmdW5jdGlvbiB0byh0YXJnZXQsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZTsKICAgICAgICBpZiAoZGVsZWdhdGUgJiYgZGVsZWdhdGUud2lsbEFkZFJvdXRlKSB7CiAgICAgICAgICAgIHRhcmdldCA9IGRlbGVnYXRlLndpbGxBZGRSb3V0ZSh0aGlzLm1hdGNoZXIudGFyZ2V0LCB0YXJnZXQpOwogICAgICAgIH0KICAgICAgICB0aGlzLm1hdGNoZXIuYWRkKHRoaXMucGF0aCwgdGFyZ2V0KTsKICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBoYXZlIGFuIGFyZ3VtZW50IGluIHRoZSBmdW5jdGlvbiBwYXNzZWQgdG8gYHRvYCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubWF0Y2hlci5hZGRDaGlsZCh0aGlzLnBhdGgsIHRhcmdldCwgY2FsbGJhY2ssIHRoaXMuZGVsZWdhdGUpOwogICAgICAgIH0KICAgIH07CiAgICB2YXIgTWF0Y2hlciA9IGZ1bmN0aW9uIE1hdGNoZXIodGFyZ2V0KSB7CiAgICAgICAgdGhpcy5yb3V0ZXMgPSBjcmVhdGVNYXAoKTsKICAgICAgICB0aGlzLmNoaWxkcmVuID0gY3JlYXRlTWFwKCk7CiAgICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB9OwogICAgTWF0Y2hlci5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkKHBhdGgsIHRhcmdldCkgewogICAgICAgIHRoaXMucm91dGVzW3BhdGhdID0gdGFyZ2V0OwogICAgfTsKICAgIE1hdGNoZXIucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24gYWRkQ2hpbGQocGF0aCwgdGFyZ2V0LCBjYWxsYmFjaywgZGVsZWdhdGUpIHsKICAgICAgICB2YXIgbWF0Y2hlciA9IG5ldyBNYXRjaGVyKHRhcmdldCk7CiAgICAgICAgdGhpcy5jaGlsZHJlbltwYXRoXSA9IG1hdGNoZXI7CiAgICAgICAgdmFyIG1hdGNoID0gZ2VuZXJhdGVNYXRjaChwYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSk7CiAgICAgICAgaWYgKGRlbGVnYXRlICYmIGRlbGVnYXRlLmNvbnRleHRFbnRlcmVkKSB7CiAgICAgICAgICAgIGRlbGVnYXRlLmNvbnRleHRFbnRlcmVkKHRhcmdldCwgbWF0Y2gpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhtYXRjaCk7CiAgICB9OwogICAgZnVuY3Rpb24gZ2VuZXJhdGVNYXRjaChzdGFydGluZ1BhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKSB7CiAgICAgICAgZnVuY3Rpb24gbWF0Y2gocGF0aCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZ1bGxQYXRoID0gc3RhcnRpbmdQYXRoICsgcGF0aDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhnZW5lcmF0ZU1hdGNoKGZ1bGxQYXRoLCBtYXRjaGVyLCBkZWxlZ2F0ZSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYXJnZXQoZnVsbFBhdGgsIG1hdGNoZXIsIGRlbGVnYXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgfQogICAgZnVuY3Rpb24gYWRkUm91dGUocm91dGVBcnJheSwgcGF0aCwgaGFuZGxlcikgewogICAgICAgIHZhciBsZW4gPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm91dGVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBsZW4gKz0gcm91dGVBcnJheVtpXS5wYXRoLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKGxlbik7CiAgICAgICAgdmFyIHJvdXRlID0geyBwYXRoOiBwYXRoLCBoYW5kbGVyOiBoYW5kbGVyIH07CiAgICAgICAgcm91dGVBcnJheS5wdXNoKHJvdXRlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGVhY2hSb3V0ZShiYXNlUm91dGUsIG1hdGNoZXIsIGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICAgICAgdmFyIHJvdXRlcyA9IG1hdGNoZXIucm91dGVzOwogICAgICAgIHZhciBwYXRocyA9IE9iamVjdC5rZXlzKHJvdXRlcyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRocy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgcGF0aCA9IHBhdGhzW2ldOwogICAgICAgICAgICB2YXIgcm91dGVBcnJheSA9IGJhc2VSb3V0ZS5zbGljZSgpOwogICAgICAgICAgICBhZGRSb3V0ZShyb3V0ZUFycmF5LCBwYXRoLCByb3V0ZXNbcGF0aF0pOwogICAgICAgICAgICB2YXIgbmVzdGVkID0gbWF0Y2hlci5jaGlsZHJlbltwYXRoXTsKICAgICAgICAgICAgaWYgKG5lc3RlZCkgewogICAgICAgICAgICAgICAgZWFjaFJvdXRlKHJvdXRlQXJyYXksIG5lc3RlZCwgY2FsbGJhY2ssIGJpbmRpbmcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbChiaW5kaW5nLCByb3V0ZUFycmF5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHZhciBtYXAgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIGFkZFJvdXRlQ2FsbGJhY2spIHsKICAgICAgICB2YXIgbWF0Y2hlciA9IG5ldyBNYXRjaGVyKCk7CiAgICAgICAgY2FsbGJhY2soZ2VuZXJhdGVNYXRjaCgiIiwgbWF0Y2hlciwgdGhpcy5kZWxlZ2F0ZSkpOwogICAgICAgIGVhY2hSb3V0ZShbXSwgbWF0Y2hlciwgZnVuY3Rpb24gKHJvdXRlcykgewogICAgICAgICAgICBpZiAoYWRkUm91dGVDYWxsYmFjaykgewogICAgICAgICAgICAgICAgYWRkUm91dGVDYWxsYmFjayh0aGlzLCByb3V0ZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5hZGQocm91dGVzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgfTsKCiAgICAvLyBOb3JtYWxpemVzIHBlcmNlbnQtZW5jb2RlZCB2YWx1ZXMgaW4gYHBhdGhgIHRvIHVwcGVyLWNhc2UgYW5kIGRlY29kZXMgcGVyY2VudC1lbmNvZGVkCiAgICAvLyB2YWx1ZXMgdGhhdCBhcmUgbm90IHJlc2VydmVkIChpLmUuLCB1bmljb2RlIGNoYXJhY3RlcnMsIGVtb2ppLCBldGMpLiBUaGUgcmVzZXJ2ZWQKICAgIC8vIGNoYXJzIGFyZSAiLyIgYW5kICIlIi4KICAgIC8vIFNhZmUgdG8gY2FsbCBtdWx0aXBsZSB0aW1lcyBvbiB0aGUgc2FtZSBwYXRoLgogICAgLy8gTm9ybWFsaXplcyBwZXJjZW50LWVuY29kZWQgdmFsdWVzIGluIGBwYXRoYCB0byB1cHBlci1jYXNlIGFuZCBkZWNvZGVzIHBlcmNlbnQtZW5jb2RlZAogICAgZnVuY3Rpb24gbm9ybWFsaXplUGF0aChwYXRoKSB7CiAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoIi8iKS5tYXAobm9ybWFsaXplU2VnbWVudCkuam9pbigiLyIpOwogICAgfQogICAgLy8gV2Ugd2FudCB0byBlbnN1cmUgdGhlIGNoYXJhY3RlcnMgIiUiIGFuZCAiLyIgcmVtYWluIGluIHBlcmNlbnQtZW5jb2RlZAogICAgLy8gZm9ybSB3aGVuIG5vcm1hbGl6aW5nIHBhdGhzLCBzbyByZXBsYWNlIHRoZW0gd2l0aCB0aGVpciBlbmNvZGVkIGZvcm0gYWZ0ZXIKICAgIC8vIGRlY29kaW5nIHRoZSByZXN0IG9mIHRoZSBwYXRoCiAgICB2YXIgU0VHTUVOVF9SRVNFUlZFRF9DSEFSUyA9IC8lfFwvL2c7CiAgICBmdW5jdGlvbiBub3JtYWxpemVTZWdtZW50KHNlZ21lbnQpIHsKICAgICAgICBpZiAoc2VnbWVudC5sZW5ndGggPCAzIHx8IHNlZ21lbnQuaW5kZXhPZigiJSIpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gc2VnbWVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzZWdtZW50KS5yZXBsYWNlKFNFR01FTlRfUkVTRVJWRURfQ0hBUlMsIGVuY29kZVVSSUNvbXBvbmVudCk7CiAgICB9CiAgICAvLyBXZSBkbyBub3Qgd2FudCB0byBlbmNvZGUgdGhlc2UgY2hhcmFjdGVycyB3aGVuIGdlbmVyYXRpbmcgZHluYW1pYyBwYXRoIHNlZ21lbnRzCiAgICAvLyBTZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzM5ODYjc2VjdGlvbi0zLjMKICAgIC8vIHN1Yi1kZWxpbXM6ICIhIiwgIiQiLCAiJiIsICInIiwgIigiLCAiKSIsICIqIiwgIisiLCAiLCIsICI7IiwgIj0iCiAgICAvLyBvdGhlcnMgYWxsb3dlZCBieSBSRkMgMzk4NjogIjoiLCAiQCIKICAgIC8vCiAgICAvLyBGaXJzdCBlbmNvZGUgdGhlIGVudGlyZSBwYXRoIHNlZ21lbnQsIHRoZW4gZGVjb2RlIGFueSBvZiB0aGUgZW5jb2RlZCBzcGVjaWFsIGNoYXJzLgogICAgLy8KICAgIC8vIFRoZSBjaGFycyAiISIsICInIiwgIigiLCAiKSIsICIqIiBkbyBub3QgZ2V0IGNoYW5nZWQgYnkgYGVuY29kZVVSSUNvbXBvbmVudGAsCiAgICAvLyBzbyB0aGUgcG9zc2libGUgZW5jb2RlZCBjaGFycyBhcmU6CiAgICAvLyBbJyUyNCcsICclMjYnLCAnJTJCJywgJyUyQycsICclM0InLCAnJTNEJywgJyUzQScsICclNDAnXS4KICAgIHZhciBQQVRIX1NFR01FTlRfRU5DT0RJTkdTID0gLyUoPzoyKD86NHw2fEJ8Qyl8Myg/OkJ8RHxBKXw0MCkvZzsKICAgIGZ1bmN0aW9uIGVuY29kZVBhdGhTZWdtZW50KHN0cikgewogICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyKS5yZXBsYWNlKFBBVEhfU0VHTUVOVF9FTkNPRElOR1MsIGRlY29kZVVSSUNvbXBvbmVudCk7CiAgICB9CgogICAgdmFyIGVzY2FwZVJlZ2V4ID0gLyhcL3xcLnxcKnxcK3xcP3xcfHxcKHxcKXxcW3xcXXxce3xcfXxcXCkvZzsKICAgIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBmdW5jdGlvbiBnZXRQYXJhbShwYXJhbXMsIGtleSkgewogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSAib2JqZWN0IiB8fCBwYXJhbXMgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBwYXNzIGFuIG9iamVjdCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIGBnZW5lcmF0ZWAuIik7CiAgICAgICAgfQogICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIGtleSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBwcm92aWRlIHBhcmFtIGAiICsga2V5ICsgImAgdG8gYGdlbmVyYXRlYC4iKTsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW2tleV07CiAgICAgICAgdmFyIHN0ciA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZSA6ICIiICsgdmFsdWU7CiAgICAgICAgaWYgKHN0ci5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3UgbXVzdCBwcm92aWRlIGEgcGFyYW0gYCIgKyBrZXkgKyAiYC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICAgIHZhciBlYWNoQ2hhciA9IFtdOwogICAgZWFjaENoYXJbMCAvKiBTdGF0aWMgKi9dID0gZnVuY3Rpb24gKHNlZ21lbnQsIGN1cnJlbnRTdGF0ZSkgewogICAgICAgIHZhciBzdGF0ZSA9IGN1cnJlbnRTdGF0ZTsKICAgICAgICB2YXIgdmFsdWUgPSBzZWdtZW50LnZhbHVlOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGNoID0gdmFsdWUuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZS5wdXQoY2gsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdGF0ZTsKICAgIH07CiAgICBlYWNoQ2hhclsxIC8qIER5bmFtaWMgKi9dID0gZnVuY3Rpb24gKF8sIGN1cnJlbnRTdGF0ZSkgewogICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUucHV0KDQ3IC8qIFNMQVNIICovLCB0cnVlLCB0cnVlKTsKICAgIH07CiAgICBlYWNoQ2hhclsyIC8qIFN0YXIgKi9dID0gZnVuY3Rpb24gKF8sIGN1cnJlbnRTdGF0ZSkgewogICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUucHV0KC0xIC8qIEFOWSAqLywgZmFsc2UsIHRydWUpOwogICAgfTsKICAgIGVhY2hDaGFyWzQgLyogRXBzaWxvbiAqL10gPSBmdW5jdGlvbiAoXywgY3VycmVudFN0YXRlKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRTdGF0ZTsKICAgIH07CiAgICB2YXIgcmVnZXggPSBbXTsKICAgIHJlZ2V4WzAgLyogU3RhdGljICovXSA9IGZ1bmN0aW9uIChzZWdtZW50KSB7CiAgICAgICAgcmV0dXJuIHNlZ21lbnQudmFsdWUucmVwbGFjZShlc2NhcGVSZWdleCwgIlxcJDEiKTsKICAgIH07CiAgICByZWdleFsxIC8qIER5bmFtaWMgKi9dID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAiKFteL10rKSI7CiAgICB9OwogICAgcmVnZXhbMiAvKiBTdGFyICovXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIiguKykiOwogICAgfTsKICAgIHJlZ2V4WzQgLyogRXBzaWxvbiAqL10gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgfTsKICAgIHZhciBnZW5lcmF0ZSA9IFtdOwogICAgZ2VuZXJhdGVbMCAvKiBTdGF0aWMgKi9dID0gZnVuY3Rpb24gKHNlZ21lbnQpIHsKICAgICAgICByZXR1cm4gc2VnbWVudC52YWx1ZTsKICAgIH07CiAgICBnZW5lcmF0ZVsxIC8qIER5bmFtaWMgKi9dID0gZnVuY3Rpb24gKHNlZ21lbnQsIHBhcmFtcykgewogICAgICAgIHZhciB2YWx1ZSA9IGdldFBhcmFtKHBhcmFtcywgc2VnbWVudC52YWx1ZSk7CiAgICAgICAgaWYgKFJvdXRlUmVjb2duaXplci5FTkNPREVfQU5EX0RFQ09ERV9QQVRIX1NFR01FTlRTKSB7CiAgICAgICAgICAgIHJldHVybiBlbmNvZGVQYXRoU2VnbWVudCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgIH07CiAgICBnZW5lcmF0ZVsyIC8qIFN0YXIgKi9dID0gZnVuY3Rpb24gKHNlZ21lbnQsIHBhcmFtcykgewogICAgICAgIHJldHVybiBnZXRQYXJhbShwYXJhbXMsIHNlZ21lbnQudmFsdWUpOwogICAgfTsKICAgIGdlbmVyYXRlWzQgLyogRXBzaWxvbiAqL10gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgfTsKICAgIHZhciBFbXB0eU9iamVjdCA9IE9iamVjdC5mcmVlemUoe30pOwogICAgdmFyIEVtcHR5QXJyYXkgPSBPYmplY3QuZnJlZXplKFtdKTsKICAgIC8vIFRoZSBgbmFtZXNgIHdpbGwgYmUgcG9wdWxhdGVkIHdpdGggdGhlIHBhcmFtdGVyIG5hbWUgZm9yIGVhY2ggZHluYW1pYy9zdGFyCiAgICAvLyBzZWdtZW50LiBgc2hvdWxkRGVjb2Rlc2Agd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhIGJvb2xlYW4gZm9yIGVhY2ggZHlhbmFtaWMvc3RhcgogICAgLy8gc2VnbWVudCwgaW5kaWNhdGluZyB3aGV0aGVyIGl0IHNob3VsZCBiZSBkZWNvZGVkIGR1cmluZyByZWNvZ25pdGlvbi4KICAgIGZ1bmN0aW9uIHBhcnNlKHNlZ21lbnRzLCByb3V0ZSwgdHlwZXMpIHsKICAgICAgICAvLyBub3JtYWxpemUgcm91dGUgYXMgbm90IHN0YXJ0aW5nIHdpdGggYSAiLyIuIFJlY29nbml0aW9uIHdpbGwKICAgICAgICAvLyBhbHNvIG5vcm1hbGl6ZS4KICAgICAgICBpZiAocm91dGUubGVuZ3RoID4gMCAmJiByb3V0ZS5jaGFyQ29kZUF0KDApID09PSA0NyAvKiBTTEFTSCAqLykgewogICAgICAgICAgICAgICAgcm91dGUgPSByb3V0ZS5zdWJzdHIoMSk7CiAgICAgICAgICAgIH0KICAgICAgICB2YXIgcGFydHMgPSByb3V0ZS5zcGxpdCgiLyIpOwogICAgICAgIHZhciBuYW1lcyA9IHVuZGVmaW5lZDsKICAgICAgICB2YXIgc2hvdWxkRGVjb2RlcyA9IHVuZGVmaW5lZDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07CiAgICAgICAgICAgIHZhciBmbGFncyA9IDA7CiAgICAgICAgICAgIHZhciB0eXBlID0gMDsKICAgICAgICAgICAgaWYgKHBhcnQgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0eXBlID0gNCAvKiBFcHNpbG9uICovOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhcnQuY2hhckNvZGVBdCgwKSA9PT0gNTggLyogQ09MT04gKi8pIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gMSAvKiBEeW5hbWljICovOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJ0LmNoYXJDb2RlQXQoMCkgPT09IDQyIC8qIFNUQVIgKi8pIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gMiAvKiBTdGFyICovOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHR5cGUgPSAwIC8qIFN0YXRpYyAqLzsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbGFncyA9IDIgPDwgdHlwZTsKICAgICAgICAgICAgaWYgKGZsYWdzICYgMTIgLyogTmFtZWQgKi8pIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gcGFydC5zbGljZSgxKTsKICAgICAgICAgICAgICAgICAgICBuYW1lcyA9IG5hbWVzIHx8IFtdOwogICAgICAgICAgICAgICAgICAgIG5hbWVzLnB1c2gocGFydCk7CiAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGVjb2RlcyA9IHNob3VsZERlY29kZXMgfHwgW107CiAgICAgICAgICAgICAgICAgICAgc2hvdWxkRGVjb2Rlcy5wdXNoKChmbGFncyAmIDQgLyogRGVjb2RlZCAqLykgIT09IDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmxhZ3MgJiAxNCAvKiBDb3VudGVkICovKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZXNbdHlwZV0rKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VnbWVudHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgICAgdmFsdWU6IG5vcm1hbGl6ZVNlZ21lbnQocGFydCkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5hbWVzOiBuYW1lcyB8fCBFbXB0eUFycmF5LAogICAgICAgICAgICBzaG91bGREZWNvZGVzOiBzaG91bGREZWNvZGVzIHx8IEVtcHR5QXJyYXkKICAgICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gaXNFcXVhbENoYXJTcGVjKHNwZWMsIGNoYXIsIG5lZ2F0ZSkgewogICAgICAgIHJldHVybiBzcGVjLmNoYXIgPT09IGNoYXIgJiYgc3BlYy5uZWdhdGUgPT09IG5lZ2F0ZTsKICAgIH0KICAgIC8vIEEgU3RhdGUgaGFzIGEgY2hhcmFjdGVyIHNwZWNpZmljYXRpb24gYW5kIChgY2hhclNwZWNgKSBhbmQgYSBsaXN0IG9mIHBvc3NpYmxlCiAgICAvLyBzdWJzZXF1ZW50IHN0YXRlcyAoYG5leHRTdGF0ZXNgKS4KICAgIC8vCiAgICAvLyBJZiBhIFN0YXRlIGlzIGFuIGFjY2VwdGluZyBzdGF0ZSwgaXQgd2lsbCBhbHNvIGhhdmUgc2V2ZXJhbCBhZGRpdGlvbmFsCiAgICAvLyBwcm9wZXJ0aWVzOgogICAgLy8KICAgIC8vICogYHJlZ2V4YDogQSByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIHRvIGV4dHJhY3QgcGFyYW1ldGVycyBmcm9tIHBhdGhzCiAgICAvLyAgIHRoYXQgcmVhY2hlZCB0aGlzIGFjY2VwdGluZyBzdGF0ZS4KICAgIC8vICogYGhhbmRsZXJzYDogSW5mb3JtYXRpb24gb24gaG93IHRvIGNvbnZlcnQgdGhlIGxpc3Qgb2YgY2FwdHVyZXMgaW50byBjYWxscwogICAgLy8gICB0byByZWdpc3RlcmVkIGhhbmRsZXJzIHdpdGggdGhlIHNwZWNpZmllZCBwYXJhbWV0ZXJzCiAgICAvLyAqIGB0eXBlc2A6IEhvdyBtYW55IHN0YXRpYywgZHluYW1pYyBvciBzdGFyIHNlZ21lbnRzIGluIHRoaXMgcm91dGUuIFVzZWQgdG8KICAgIC8vICAgZGVjaWRlIHdoaWNoIHJvdXRlIHRvIHVzZSBpZiBtdWx0aXBsZSByZWdpc3RlcmVkIHJvdXRlcyBtYXRjaCBhIHBhdGguCiAgICAvLwogICAgLy8gQ3VycmVudGx5LCBTdGF0ZSBpcyBpbXBsZW1lbnRlZCBuYWl2ZWx5IGJ5IGxvb3Bpbmcgb3ZlciBgbmV4dFN0YXRlc2AgYW5kCiAgICAvLyBjb21wYXJpbmcgYSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBhZ2FpbnN0IGEgY2hhcmFjdGVyLiBBIG1vcmUgZWZmaWNpZW50CiAgICAvLyBpbXBsZW1lbnRhdGlvbiB3b3VsZCB1c2UgYSBoYXNoIG9mIGtleXMgcG9pbnRpbmcgYXQgb25lIG9yIG1vcmUgbmV4dCBzdGF0ZXMuCiAgICB2YXIgU3RhdGUgPSBmdW5jdGlvbiBTdGF0ZShzdGF0ZXMsIGlkLCBjaGFyLCBuZWdhdGUsIHJlcGVhdCkgewogICAgICAgIHRoaXMuc3RhdGVzID0gc3RhdGVzOwogICAgICAgIHRoaXMuaWQgPSBpZDsKICAgICAgICB0aGlzLmNoYXIgPSBjaGFyOwogICAgICAgIHRoaXMubmVnYXRlID0gbmVnYXRlOwogICAgICAgIHRoaXMubmV4dFN0YXRlcyA9IHJlcGVhdCA/IGlkIDogbnVsbDsKICAgICAgICB0aGlzLnBhdHRlcm4gPSAiIjsKICAgICAgICB0aGlzLl9yZWdleCA9IHVuZGVmaW5lZDsKICAgICAgICB0aGlzLmhhbmRsZXJzID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMudHlwZXMgPSB1bmRlZmluZWQ7CiAgICB9OwogICAgU3RhdGUucHJvdG90eXBlLnJlZ2V4ID0gZnVuY3Rpb24gcmVnZXgkMSgpIHsKICAgICAgICBpZiAoIXRoaXMuX3JlZ2V4KSB7CiAgICAgICAgICAgIHRoaXMuX3JlZ2V4ID0gbmV3IFJlZ0V4cCh0aGlzLnBhdHRlcm4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcmVnZXg7CiAgICB9OwogICAgU3RhdGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldChjaGFyLCBuZWdhdGUpIHsKICAgICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgICAgdmFyIG5leHRTdGF0ZXMgPSB0aGlzLm5leHRTdGF0ZXM7CiAgICAgICAgaWYgKG5leHRTdGF0ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNBcnJheShuZXh0U3RhdGVzKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5leHRTdGF0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMkMS5zdGF0ZXNbbmV4dFN0YXRlc1tpXV07CiAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbENoYXJTcGVjKGNoaWxkLCBjaGFyLCBuZWdhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkJDEgPSB0aGlzLnN0YXRlc1tuZXh0U3RhdGVzXTsKICAgICAgICAgICAgaWYgKGlzRXF1YWxDaGFyU3BlYyhjaGlsZCQxLCBjaGFyLCBuZWdhdGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQkMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBTdGF0ZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gcHV0KGNoYXIsIG5lZ2F0ZSwgcmVwZWF0KSB7CiAgICAgICAgdmFyIHN0YXRlOwogICAgICAgIC8vIElmIHRoZSBjaGFyYWN0ZXIgc3BlY2lmaWNhdGlvbiBhbHJlYWR5IGV4aXN0cyBpbiBhIGNoaWxkIG9mIHRoZSBjdXJyZW50CiAgICAgICAgLy8gc3RhdGUsIGp1c3QgcmV0dXJuIHRoYXQgc3RhdGUuCiAgICAgICAgaWYgKHN0YXRlID0gdGhpcy5nZXQoY2hhciwgbmVnYXRlKSkgewogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgfQogICAgICAgIC8vIE1ha2UgYSBuZXcgc3RhdGUgZm9yIHRoZSBjaGFyYWN0ZXIgc3BlYwogICAgICAgIHZhciBzdGF0ZXMgPSB0aGlzLnN0YXRlczsKICAgICAgICBzdGF0ZSA9IG5ldyBTdGF0ZShzdGF0ZXMsIHN0YXRlcy5sZW5ndGgsIGNoYXIsIG5lZ2F0ZSwgcmVwZWF0KTsKICAgICAgICBzdGF0ZXNbc3RhdGVzLmxlbmd0aF0gPSBzdGF0ZTsKICAgICAgICAvLyBJbnNlcnQgdGhlIG5ldyBzdGF0ZSBhcyBhIGNoaWxkIG9mIHRoZSBjdXJyZW50IHN0YXRlCiAgICAgICAgaWYgKHRoaXMubmV4dFN0YXRlcyA9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMubmV4dFN0YXRlcyA9IHN0YXRlLmlkOwogICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheSh0aGlzLm5leHRTdGF0ZXMpKSB7CiAgICAgICAgICAgIHRoaXMubmV4dFN0YXRlcy5wdXNoKHN0YXRlLmlkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLm5leHRTdGF0ZXMgPSBbdGhpcy5uZXh0U3RhdGVzLCBzdGF0ZS5pZF07CiAgICAgICAgfQogICAgICAgIC8vIFJldHVybiB0aGUgbmV3IHN0YXRlCiAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgfTsKICAgIC8vIEZpbmQgYSBsaXN0IG9mIGNoaWxkIHN0YXRlcyBtYXRjaGluZyB0aGUgbmV4dCBjaGFyYWN0ZXIKICAgIFN0YXRlLnByb3RvdHlwZS5tYXRjaCA9IGZ1bmN0aW9uIG1hdGNoKGNoKSB7CiAgICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICAgIHZhciBuZXh0U3RhdGVzID0gdGhpcy5uZXh0U3RhdGVzOwogICAgICAgIGlmICghbmV4dFN0YXRlcykgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciByZXR1cm5lZCA9IFtdOwogICAgICAgIGlmIChpc0FycmF5KG5leHRTdGF0ZXMpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV4dFN0YXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcyQxLnN0YXRlc1tuZXh0U3RhdGVzW2ldXTsKICAgICAgICAgICAgICAgIGlmIChpc01hdGNoKGNoaWxkLCBjaCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm5lZC5wdXNoKGNoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCQxID0gdGhpcy5zdGF0ZXNbbmV4dFN0YXRlc107CiAgICAgICAgICAgIGlmIChpc01hdGNoKGNoaWxkJDEsIGNoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuZWQucHVzaChjaGlsZCQxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0dXJuZWQ7CiAgICB9OwogICAgZnVuY3Rpb24gaXNNYXRjaChzcGVjLCBjaGFyKSB7CiAgICAgICAgcmV0dXJuIHNwZWMubmVnYXRlID8gc3BlYy5jaGFyICE9PSBjaGFyICYmIHNwZWMuY2hhciAhPT0gLTEgLyogQU5ZICovIDogc3BlYy5jaGFyID09PSBjaGFyIHx8IHNwZWMuY2hhciA9PT0gLTEgLyogQU5ZICovOwogICAgfQogICAgLy8gVGhpcyBpcyBhIHNvbWV3aGF0IG5haXZlIHN0cmF0ZWd5LCBidXQgc2hvdWxkIHdvcmsgaW4gYSBsb3Qgb2YgY2FzZXMKICAgIC8vIEEgYmV0dGVyIHN0cmF0ZWd5IHdvdWxkIHByb3Blcmx5IHJlc29sdmUgL3Bvc3RzLzppZC9uZXcgYW5kIC9wb3N0cy9lZGl0LzppZC4KICAgIC8vCiAgICAvLyBUaGlzIHN0cmF0ZWd5IGdlbmVyYWxseSBwcmVmZXJzIG1vcmUgc3RhdGljIGFuZCBsZXNzIGR5bmFtaWMgbWF0Y2hpbmcuCiAgICAvLyBTcGVjaWZpY2FsbHksIGl0CiAgICAvLwogICAgLy8gICogcHJlZmVycyBmZXdlciBzdGFycyB0byBtb3JlLCB0aGVuCiAgICAvLyAgKiBwcmVmZXJzIHVzaW5nIHN0YXJzIGZvciBsZXNzIG9mIHRoZSBtYXRjaCB0byBtb3JlLCB0aGVuCiAgICAvLyAgKiBwcmVmZXJzIGZld2VyIGR5bmFtaWMgc2VnbWVudHMgdG8gbW9yZSwgdGhlbgogICAgLy8gICogcHJlZmVycyBtb3JlIHN0YXRpYyBzZWdtZW50cyB0byBtb3JlCiAgICBmdW5jdGlvbiBzb3J0U29sdXRpb25zKHN0YXRlcykgewogICAgICAgIHJldHVybiBzdGF0ZXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICB2YXIgcmVmID0gYS50eXBlcyB8fCBbMCwgMCwgMF07CiAgICAgICAgICAgIHZhciBhc3RhdGljcyA9IHJlZlswXTsKICAgICAgICAgICAgdmFyIGFkeW5hbWljcyA9IHJlZlsxXTsKICAgICAgICAgICAgdmFyIGFzdGFycyA9IHJlZlsyXTsKICAgICAgICAgICAgdmFyIHJlZiQxID0gYi50eXBlcyB8fCBbMCwgMCwgMF07CiAgICAgICAgICAgIHZhciBic3RhdGljcyA9IHJlZiQxWzBdOwogICAgICAgICAgICB2YXIgYmR5bmFtaWNzID0gcmVmJDFbMV07CiAgICAgICAgICAgIHZhciBic3RhcnMgPSByZWYkMVsyXTsKICAgICAgICAgICAgaWYgKGFzdGFycyAhPT0gYnN0YXJzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXN0YXJzIC0gYnN0YXJzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhc3RhcnMpIHsKICAgICAgICAgICAgICAgIGlmIChhc3RhdGljcyAhPT0gYnN0YXRpY3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnN0YXRpY3MgLSBhc3RhdGljczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChhZHluYW1pY3MgIT09IGJkeW5hbWljcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBiZHluYW1pY3MgLSBhZHluYW1pY3M7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFkeW5hbWljcyAhPT0gYmR5bmFtaWNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWR5bmFtaWNzIC0gYmR5bmFtaWNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhc3RhdGljcyAhPT0gYnN0YXRpY3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBic3RhdGljcyAtIGFzdGF0aWNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcmVjb2duaXplQ2hhcihzdGF0ZXMsIGNoKSB7CiAgICAgICAgdmFyIG5leHRTdGF0ZXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHN0YXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdmFyIHN0YXRlID0gc3RhdGVzW2ldOwogICAgICAgICAgICBuZXh0U3RhdGVzID0gbmV4dFN0YXRlcy5jb25jYXQoc3RhdGUubWF0Y2goY2gpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5leHRTdGF0ZXM7CiAgICB9CiAgICB2YXIgUmVjb2duaXplUmVzdWx0cyA9IGZ1bmN0aW9uIFJlY29nbml6ZVJlc3VsdHMocXVlcnlQYXJhbXMpIHsKICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5xdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zIHx8IHt9OwogICAgfTsKCiAgICBSZWNvZ25pemVSZXN1bHRzLnByb3RvdHlwZS5zcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlOwogICAgUmVjb2duaXplUmVzdWx0cy5wcm90b3R5cGUuc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICBSZWNvZ25pemVSZXN1bHRzLnByb3RvdHlwZS5wdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2g7CiAgICBmdW5jdGlvbiBmaW5kSGFuZGxlcihzdGF0ZSwgb3JpZ2luYWxQYXRoLCBxdWVyeVBhcmFtcykgewogICAgICAgIHZhciBoYW5kbGVycyA9IHN0YXRlLmhhbmRsZXJzOwogICAgICAgIHZhciByZWdleCA9IHN0YXRlLnJlZ2V4KCk7CiAgICAgICAgaWYgKCFyZWdleCB8fCAhaGFuZGxlcnMpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzdGF0ZSBub3QgaW5pdGlhbGl6ZWQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNhcHR1cmVzID0gb3JpZ2luYWxQYXRoLm1hdGNoKHJlZ2V4KTsKICAgICAgICB2YXIgY3VycmVudENhcHR1cmUgPSAxOwogICAgICAgIHZhciByZXN1bHQgPSBuZXcgUmVjb2duaXplUmVzdWx0cyhxdWVyeVBhcmFtcyk7CiAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGhhbmRsZXJzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gaGFuZGxlcnNbaV07CiAgICAgICAgICAgIHZhciBuYW1lcyA9IGhhbmRsZXIubmFtZXM7CiAgICAgICAgICAgIHZhciBzaG91bGREZWNvZGVzID0gaGFuZGxlci5zaG91bGREZWNvZGVzOwogICAgICAgICAgICB2YXIgcGFyYW1zID0gRW1wdHlPYmplY3Q7CiAgICAgICAgICAgIHZhciBpc0R5bmFtaWMgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKG5hbWVzICE9PSBFbXB0eUFycmF5ICYmIHNob3VsZERlY29kZXMgIT09IEVtcHR5QXJyYXkpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbmFtZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBpc0R5bmFtaWMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gbmFtZXNbal07CiAgICAgICAgICAgICAgICAgICAgdmFyIGNhcHR1cmUgPSBjYXB0dXJlcyAmJiBjYXB0dXJlc1tjdXJyZW50Q2FwdHVyZSsrXTsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zID09PSBFbXB0eU9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKFJvdXRlUmVjb2duaXplci5FTkNPREVfQU5EX0RFQ09ERV9QQVRIX1NFR01FTlRTICYmIHNob3VsZERlY29kZXNbal0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW25hbWVdID0gY2FwdHVyZSAmJiBkZWNvZGVVUklDb21wb25lbnQoY2FwdHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW25hbWVdID0gY2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0W2ldID0gewogICAgICAgICAgICAgICAgaGFuZGxlcjogaGFuZGxlci5oYW5kbGVyLAogICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICAgICAgICBpc0R5bmFtaWM6IGlzRHluYW1pYwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZGVjb2RlUXVlcnlQYXJhbVBhcnQocGFydCkgewogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw0MDEvaW50ZXJhY3QvZm9ybXMuaHRtbCNoLTE3LjEzLjQuMQogICAgICAgIHBhcnQgPSBwYXJ0LnJlcGxhY2UoL1wrL2dtLCAiJTIwIik7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXN1bHQgPSBkZWNvZGVVUklDb21wb25lbnQocGFydCk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgcmVzdWx0ID0gIiI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB2YXIgUm91dGVSZWNvZ25pemVyID0gZnVuY3Rpb24gUm91dGVSZWNvZ25pemVyKCkgewogICAgICAgIHRoaXMubmFtZXMgPSBjcmVhdGVNYXAoKTsKICAgICAgICB2YXIgc3RhdGVzID0gW107CiAgICAgICAgdmFyIHN0YXRlID0gbmV3IFN0YXRlKHN0YXRlcywgMCwgLTEgLyogQU5ZICovLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgc3RhdGVzWzBdID0gc3RhdGU7CiAgICAgICAgdGhpcy5zdGF0ZXMgPSBzdGF0ZXM7CiAgICAgICAgdGhpcy5yb290U3RhdGUgPSBzdGF0ZTsKICAgIH07CiAgICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIGFkZChyb3V0ZXMsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gdGhpcy5yb290U3RhdGU7CiAgICAgICAgdmFyIHBhdHRlcm4gPSAiXiI7CiAgICAgICAgdmFyIHR5cGVzID0gWzAsIDAsIDBdOwogICAgICAgIHZhciBoYW5kbGVycyA9IG5ldyBBcnJheShyb3V0ZXMubGVuZ3RoKTsKICAgICAgICB2YXIgYWxsU2VnbWVudHMgPSBbXTsKICAgICAgICB2YXIgaXNFbXB0eSA9IHRydWU7CiAgICAgICAgdmFyIGogPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm91dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1tpXTsKICAgICAgICAgICAgdmFyIHJlZiA9IHBhcnNlKGFsbFNlZ21lbnRzLCByb3V0ZS5wYXRoLCB0eXBlcyk7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IHJlZi5uYW1lczsKICAgICAgICAgICAgdmFyIHNob3VsZERlY29kZXMgPSByZWYuc2hvdWxkRGVjb2RlczsKICAgICAgICAgICAgLy8gcHJlc2VydmUgaiBzbyBpdCBwb2ludHMgdG8gdGhlIHN0YXJ0IG9mIG5ld2x5IGFkZGVkIHNlZ21lbnRzCiAgICAgICAgICAgIGZvciAoOyBqIDwgYWxsU2VnbWVudHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBzZWdtZW50ID0gYWxsU2VnbWVudHNbal07CiAgICAgICAgICAgICAgICBpZiAoc2VnbWVudC50eXBlID09PSA0IC8qIEVwc2lsb24gKi8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaXNFbXB0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgLy8gQWRkIGEgIi8iIGZvciB0aGUgbmV3IHNlZ21lbnQKICAgICAgICAgICAgICAgIGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnRTdGF0ZS5wdXQoNDcgLyogU0xBU0ggKi8sIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBwYXR0ZXJuICs9ICIvIjsKICAgICAgICAgICAgICAgIC8vIEFkZCBhIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBzZWdtZW50IHRvIHRoZSBORkEgYW5kIHJlZ2V4CiAgICAgICAgICAgICAgICBjdXJyZW50U3RhdGUgPSBlYWNoQ2hhcltzZWdtZW50LnR5cGVdKHNlZ21lbnQsIGN1cnJlbnRTdGF0ZSk7CiAgICAgICAgICAgICAgICBwYXR0ZXJuICs9IHJlZ2V4W3NlZ21lbnQudHlwZV0oc2VnbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlcnNbaV0gPSB7CiAgICAgICAgICAgICAgICBoYW5kbGVyOiByb3V0ZS5oYW5kbGVyLAogICAgICAgICAgICAgICAgbmFtZXM6IG5hbWVzLAogICAgICAgICAgICAgICAgc2hvdWxkRGVjb2Rlczogc2hvdWxkRGVjb2RlcwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBpZiAoaXNFbXB0eSkgewogICAgICAgICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50U3RhdGUucHV0KDQ3IC8qIFNMQVNIICovLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICBwYXR0ZXJuICs9ICIvIjsKICAgICAgICB9CiAgICAgICAgY3VycmVudFN0YXRlLmhhbmRsZXJzID0gaGFuZGxlcnM7CiAgICAgICAgY3VycmVudFN0YXRlLnBhdHRlcm4gPSBwYXR0ZXJuICsgIiQiOwogICAgICAgIGN1cnJlbnRTdGF0ZS50eXBlcyA9IHR5cGVzOwogICAgICAgIHZhciBuYW1lOwogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zLmFzKSB7CiAgICAgICAgICAgIG5hbWUgPSBvcHRpb25zLmFzOwogICAgICAgIH0KICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAvLyBpZiAodGhpcy5uYW1lc1tuYW1lXSkgewogICAgICAgICAgICAvLyAgIHRocm93IG5ldyBFcnJvcigiWW91IG1heSBub3QgYWRkIGEgZHVwbGljYXRlIHJvdXRlIG5hbWVkIGAiICsgbmFtZSArICJgLiIpOwogICAgICAgICAgICAvLyB9CiAgICAgICAgICAgIHRoaXMubmFtZXNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICBzZWdtZW50czogYWxsU2VnbWVudHMsCiAgICAgICAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9OwogICAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5oYW5kbGVyc0ZvciA9IGZ1bmN0aW9uIGhhbmRsZXJzRm9yKG5hbWUpIHsKICAgICAgICB2YXIgcm91dGUgPSB0aGlzLm5hbWVzW25hbWVdOwogICAgICAgIGlmICghcm91dGUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyByb3V0ZSBuYW1lZCAiICsgbmFtZSk7CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkocm91dGUuaGFuZGxlcnMubGVuZ3RoKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdXRlLmhhbmRsZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gcm91dGUuaGFuZGxlcnNbaV07CiAgICAgICAgICAgIHJlc3VsdFtpXSA9IGhhbmRsZXI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5oYXNSb3V0ZSA9IGZ1bmN0aW9uIGhhc1JvdXRlKG5hbWUpIHsKICAgICAgICByZXR1cm4gISF0aGlzLm5hbWVzW25hbWVdOwogICAgfTsKICAgIFJvdXRlUmVjb2duaXplci5wcm90b3R5cGUuZ2VuZXJhdGUgPSBmdW5jdGlvbiBnZW5lcmF0ZSQxKG5hbWUsIHBhcmFtcykgewogICAgICAgIHZhciByb3V0ZSA9IHRoaXMubmFtZXNbbmFtZV07CiAgICAgICAgdmFyIG91dHB1dCA9ICIiOwogICAgICAgIGlmICghcm91dGUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyByb3V0ZSBuYW1lZCAiICsgbmFtZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzZWdtZW50cyA9IHJvdXRlLnNlZ21lbnRzOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHNlZ21lbnQgPSBzZWdtZW50c1tpXTsKICAgICAgICAgICAgaWYgKHNlZ21lbnQudHlwZSA9PT0gNCAvKiBFcHNpbG9uICovKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIG91dHB1dCArPSAiLyI7CiAgICAgICAgICAgIG91dHB1dCArPSBnZW5lcmF0ZVtzZWdtZW50LnR5cGVdKHNlZ21lbnQsIHBhcmFtcyk7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgb3V0cHV0ID0gIi8iICsgb3V0cHV0OwogICAgICAgIH0KICAgICAgICBpZiAocGFyYW1zICYmIHBhcmFtcy5xdWVyeVBhcmFtcykgewogICAgICAgICAgICBvdXRwdXQgKz0gdGhpcy5nZW5lcmF0ZVF1ZXJ5U3RyaW5nKHBhcmFtcy5xdWVyeVBhcmFtcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9OwogICAgUm91dGVSZWNvZ25pemVyLnByb3RvdHlwZS5nZW5lcmF0ZVF1ZXJ5U3RyaW5nID0gZnVuY3Rpb24gZ2VuZXJhdGVRdWVyeVN0cmluZyhwYXJhbXMpIHsKICAgICAgICB2YXIgcGFpcnMgPSBbXTsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7CiAgICAgICAga2V5cy5zb3J0KCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwYWlyID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSk7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWx1ZS5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgIHZhciBhcnJheVBhaXIgPSBrZXkgKyAiW10iICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlW2pdKTsKICAgICAgICAgICAgICAgICAgICBwYWlycy5wdXNoKGFycmF5UGFpcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYWlyICs9ICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICBwYWlycy5wdXNoKHBhaXIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwYWlycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICByZXR1cm4gIj8iICsgcGFpcnMuam9pbigiJiIpOwogICAgfTsKICAgIFJvdXRlUmVjb2duaXplci5wcm90b3R5cGUucGFyc2VRdWVyeVN0cmluZyA9IGZ1bmN0aW9uIHBhcnNlUXVlcnlTdHJpbmcocXVlcnlTdHJpbmcpIHsKICAgICAgICB2YXIgcGFpcnMgPSBxdWVyeVN0cmluZy5zcGxpdCgiJiIpOwogICAgICAgIHZhciBxdWVyeVBhcmFtcyA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFpcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHBhaXIgPSBwYWlyc1tpXS5zcGxpdCgiPSIpLAogICAgICAgICAgICAgICAga2V5ID0gZGVjb2RlUXVlcnlQYXJhbVBhcnQocGFpclswXSksCiAgICAgICAgICAgICAgICBrZXlMZW5ndGggPSBrZXkubGVuZ3RoLAogICAgICAgICAgICAgICAgaXNBcnJheSA9IGZhbHNlLAogICAgICAgICAgICAgICAgdmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChwYWlyLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSAidHJ1ZSI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYXJyYXlzCiAgICAgICAgICAgICAgICBpZiAoa2V5TGVuZ3RoID4gMiAmJiBrZXkuc2xpY2Uoa2V5TGVuZ3RoIC0gMikgPT09ICJbXSIpIHsKICAgICAgICAgICAgICAgICAgICBpc0FycmF5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBrZXkuc2xpY2UoMCwga2V5TGVuZ3RoIC0gMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFxdWVyeVBhcmFtc1trZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHBhaXJbMV0gPyBkZWNvZGVRdWVyeVBhcmFtUGFydChwYWlyWzFdKSA6ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0FycmF5KSB7CiAgICAgICAgICAgICAgICBxdWVyeVBhcmFtc1trZXldLnB1c2godmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcXVlcnlQYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBxdWVyeVBhcmFtczsKICAgIH07CiAgICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLnJlY29nbml6ZSA9IGZ1bmN0aW9uIHJlY29nbml6ZShwYXRoKSB7CiAgICAgICAgdmFyIHJlc3VsdHM7CiAgICAgICAgdmFyIHN0YXRlcyA9IFt0aGlzLnJvb3RTdGF0ZV07CiAgICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CiAgICAgICAgdmFyIGlzU2xhc2hEcm9wcGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGhhc2hTdGFydCA9IHBhdGguaW5kZXhPZigiIyIpOwogICAgICAgIGlmIChoYXNoU3RhcnQgIT09IC0xKSB7CiAgICAgICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cigwLCBoYXNoU3RhcnQpOwogICAgICAgIH0KICAgICAgICB2YXIgcXVlcnlTdGFydCA9IHBhdGguaW5kZXhPZigiPyIpOwogICAgICAgIGlmIChxdWVyeVN0YXJ0ICE9PSAtMSkgewogICAgICAgICAgICB2YXIgcXVlcnlTdHJpbmcgPSBwYXRoLnN1YnN0cihxdWVyeVN0YXJ0ICsgMSwgcGF0aC5sZW5ndGgpOwogICAgICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIoMCwgcXVlcnlTdGFydCk7CiAgICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gdGhpcy5wYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgcGF0aCA9ICIvIiArIHBhdGg7CiAgICAgICAgfQogICAgICAgIHZhciBvcmlnaW5hbFBhdGggPSBwYXRoOwogICAgICAgIGlmIChSb3V0ZVJlY29nbml6ZXIuRU5DT0RFX0FORF9ERUNPREVfUEFUSF9TRUdNRU5UUykgewogICAgICAgICAgICBwYXRoID0gbm9ybWFsaXplUGF0aChwYXRoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXRoID0gZGVjb2RlVVJJKHBhdGgpOwogICAgICAgICAgICBvcmlnaW5hbFBhdGggPSBkZWNvZGVVUkkob3JpZ2luYWxQYXRoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHBhdGhMZW4gPSBwYXRoLmxlbmd0aDsKICAgICAgICBpZiAocGF0aExlbiA+IDEgJiYgcGF0aC5jaGFyQXQocGF0aExlbiAtIDEpID09PSAiLyIpIHsKICAgICAgICAgICAgcGF0aCA9IHBhdGguc3Vic3RyKDAsIHBhdGhMZW4gLSAxKTsKICAgICAgICAgICAgb3JpZ2luYWxQYXRoID0gb3JpZ2luYWxQYXRoLnN1YnN0cigwLCBvcmlnaW5hbFBhdGgubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIGlzU2xhc2hEcm9wcGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHN0YXRlcyA9IHJlY29nbml6ZUNoYXIoc3RhdGVzLCBwYXRoLmNoYXJDb2RlQXQoaSkpOwogICAgICAgICAgICBpZiAoIXN0YXRlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzb2x1dGlvbnMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBzdGF0ZXMubGVuZ3RoOyBpJDErKykgewogICAgICAgICAgICBpZiAoc3RhdGVzW2kkMV0uaGFuZGxlcnMpIHsKICAgICAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKHN0YXRlc1tpJDFdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0ZXMgPSBzb3J0U29sdXRpb25zKHNvbHV0aW9ucyk7CiAgICAgICAgdmFyIHN0YXRlID0gc29sdXRpb25zWzBdOwogICAgICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5oYW5kbGVycykgewogICAgICAgICAgICAvLyBpZiBhIHRyYWlsaW5nIHNsYXNoIHdhcyBkcm9wcGVkIGFuZCBhIHN0YXIgc2VnbWVudCBpcyB0aGUgbGFzdCBzZWdtZW50CiAgICAgICAgICAgIC8vIHNwZWNpZmllZCwgcHV0IHRoZSB0cmFpbGluZyBzbGFzaCBiYWNrCiAgICAgICAgICAgIGlmIChpc1NsYXNoRHJvcHBlZCAmJiBzdGF0ZS5wYXR0ZXJuICYmIHN0YXRlLnBhdHRlcm4uc2xpY2UoLTUpID09PSAiKC4rKSQiKSB7CiAgICAgICAgICAgICAgICBvcmlnaW5hbFBhdGggPSBvcmlnaW5hbFBhdGggKyAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0cyA9IGZpbmRIYW5kbGVyKHN0YXRlLCBvcmlnaW5hbFBhdGgsIHF1ZXJ5UGFyYW1zKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwogICAgUm91dGVSZWNvZ25pemVyLlZFUlNJT04gPSAiMC4zLjMiOwogICAgLy8gU2V0IHRvIGZhbHNlIHRvIG9wdC1vdXQgb2YgZW5jb2RpbmcgYW5kIGRlY29kaW5nIHBhdGggc2VnbWVudHMuCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3RpbGRlaW8vcm91dGUtcmVjb2duaXplci9wdWxsLzU1CiAgICBSb3V0ZVJlY29nbml6ZXIuRU5DT0RFX0FORF9ERUNPREVfUEFUSF9TRUdNRU5UUyA9IHRydWU7CiAgICBSb3V0ZVJlY29nbml6ZXIuTm9ybWFsaXplciA9IHsKICAgICAgICBub3JtYWxpemVTZWdtZW50OiBub3JtYWxpemVTZWdtZW50LCBub3JtYWxpemVQYXRoOiBub3JtYWxpemVQYXRoLCBlbmNvZGVQYXRoU2VnbWVudDogZW5jb2RlUGF0aFNlZ21lbnQKICAgIH07CiAgICBSb3V0ZVJlY29nbml6ZXIucHJvdG90eXBlLm1hcCA9IG1hcDsKCiAgICBleHBvcnRzLmRlZmF1bHQgPSBSb3V0ZVJlY29nbml6ZXI7Cn0pOwplbmlmZWQoJ3JvdXRlcicsIFsnZXhwb3J0cycsICdlbWJlci1iYWJlbCcsICdyc3ZwJywgJ3JvdXRlLXJlY29nbml6ZXInXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckJhYmVsLCBfcnN2cCwgX3JvdXRlUmVjb2duaXplcikgewogICd1c2Ugc3RyaWN0JzsKCiAgZXhwb3J0cy5UcmFuc2l0aW9uID0gdW5kZWZpbmVkOwoKCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogIC8qKgogICAgRGV0ZXJtaW5lcyBpZiBhbiBvYmplY3QgaXMgUHJvbWlzZSBieSBjaGVja2luZyBpZiBpdCBpcyAidGhlbmFibGUiLgogICoqLwogIGZ1bmN0aW9uIGlzUHJvbWlzZShvYmopIHsKICAgIHJldHVybiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsIHx8IHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpICYmIHR5cGVvZiBvYmoudGhlbiA9PT0gJ2Z1bmN0aW9uJzsKICB9CgogIGZ1bmN0aW9uIG1lcmdlKGhhc2gsIG90aGVyKSB7CiAgICBmb3IgKHZhciBwcm9wIGluIG90aGVyKSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG90aGVyLCBwcm9wKSkgewogICAgICAgIGhhc2hbcHJvcF0gPSBvdGhlcltwcm9wXTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgRXh0cmFjdHMgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGVuZCBvZiBhbiBhcnJheQogICoqLwogIGZ1bmN0aW9uIGV4dHJhY3RRdWVyeVBhcmFtcyhhcnJheSkgewogICAgdmFyIGxlbiA9IGFycmF5ICYmIGFycmF5Lmxlbmd0aCwKICAgICAgICBoZWFkID0gdm9pZCAwLAogICAgICAgIHF1ZXJ5UGFyYW1zID0gdm9pZCAwOwoKICAgIGlmIChsZW4gJiYgbGVuID4gMCAmJiBhcnJheVtsZW4gLSAxXSAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGFycmF5W2xlbiAtIDFdLCAncXVlcnlQYXJhbXMnKSkgewogICAgICBxdWVyeVBhcmFtcyA9IGFycmF5W2xlbiAtIDFdLnF1ZXJ5UGFyYW1zOwogICAgICBoZWFkID0gc2xpY2UuY2FsbChhcnJheSwgMCwgbGVuIC0gMSk7CiAgICAgIHJldHVybiBbaGVhZCwgcXVlcnlQYXJhbXNdOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIFthcnJheSwgbnVsbF07CiAgICB9CiAgfQoKICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBDb2VyY2VzIHF1ZXJ5IHBhcmFtIHByb3BlcnRpZXMgYW5kIGFycmF5IGVsZW1lbnRzIGludG8gc3RyaW5ncy4KICAqKi8KICBmdW5jdGlvbiBjb2VyY2VRdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5UGFyYW1zKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcXVlcnlQYXJhbXMpIHsKICAgICAgdmFyIHZhbCA9IHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSAnJyArIHZhbDsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhbFtpXSA9ICcnICsgdmFsW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioKICAgIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gX2xvZyhyb3V0ZXIsIHNlcXVlbmNlLCBtc2cpIHsKICAgIGlmICghcm91dGVyLmxvZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHsKICAgICAgcm91dGVyLmxvZygnVHJhbnNpdGlvbiAjJyArIHNlcXVlbmNlICsgJzogJyArIG1zZyk7CiAgICB9IGVsc2UgewogICAgICBtc2cgPSBzZXF1ZW5jZTsKICAgICAgcm91dGVyLmxvZyhtc2cpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNQYXJhbShvYmplY3QpIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAnc3RyaW5nJyB8fCBvYmplY3QgaW5zdGFuY2VvZiBTdHJpbmcgfHwgdHlwZW9mIG9iamVjdCA9PT0gJ251bWJlcicgfHwgb2JqZWN0IGluc3RhbmNlb2YgTnVtYmVyOwogIH0KCiAgZnVuY3Rpb24gZm9yRWFjaChhcnJheSwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbCAmJiBmYWxzZSAhPT0gY2FsbGJhY2soYXJyYXlbaV0pOyBpKyspIHsKICAgICAgLy8gZW1wdHkgaW50ZW50aW9uYWxseQogICAgfQogIH0KCiAgZnVuY3Rpb24gX3RyaWdnZXIocm91dGVyLCBoYW5kbGVySW5mb3MsIGlnbm9yZUZhaWx1cmUsIGFyZ3MpIHsKICAgIGlmIChyb3V0ZXIudHJpZ2dlckV2ZW50KSB7CiAgICAgIHJvdXRlci50cmlnZ2VyRXZlbnQoaGFuZGxlckluZm9zLCBpZ25vcmVGYWlsdXJlLCBhcmdzKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBuYW1lID0gYXJncy5zaGlmdCgpOwoKICAgIGlmICghaGFuZGxlckluZm9zKSB7CiAgICAgIGlmIChpZ25vcmVGYWlsdXJlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IHRyaWdnZXIgZXZlbnQgJyIgKyBuYW1lICsgIicuIFRoZXJlIGFyZSBubyBhY3RpdmUgaGFuZGxlcnMiKTsKICAgIH0KCiAgICB2YXIgZXZlbnRXYXNIYW5kbGVkID0gZmFsc2U7CgogICAgZnVuY3Rpb24gZGVsYXllZEV2ZW50KG5hbWUsIGFyZ3MsIGhhbmRsZXIpIHsKICAgICAgaGFuZGxlci5ldmVudHNbbmFtZV0uYXBwbHkoaGFuZGxlciwgYXJncyk7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IGhhbmRsZXJJbmZvcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV0sCiAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlcjsKCiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGhhbmRsZXIsIGl0IG1lYW5zIHRoZSBoYW5kbGVyIGhhc24ndCByZXNvbHZlZCB5ZXQgd2hpY2gKICAgICAgLy8gbWVhbnMgdGhhdCB3ZSBzaG91bGQgdHJpZ2dlciB0aGUgZXZlbnQgbGF0ZXIgd2hlbiB0aGUgaGFuZGxlciBpcyBhdmFpbGFibGUKICAgICAgaWYgKCFoYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlckluZm8uaGFuZGxlclByb21pc2UudGhlbihkZWxheWVkRXZlbnQuYmluZChudWxsLCBuYW1lLCBhcmdzKSk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmIChoYW5kbGVyLmV2ZW50cyAmJiBoYW5kbGVyLmV2ZW50c1tuYW1lXSkgewogICAgICAgIGlmIChoYW5kbGVyLmV2ZW50c1tuYW1lXS5hcHBseShoYW5kbGVyLCBhcmdzKSA9PT0gdHJ1ZSkgewogICAgICAgICAgZXZlbnRXYXNIYW5kbGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIEluIHRoZSBjYXNlIHRoYXQgd2UgZ290IGFuIFVucmVjb2duaXplZFVSTEVycm9yIGFzIGFuIGV2ZW50IHdpdGggbm8gaGFuZGxlciwKICAgIC8vIGxldCBpdCBidWJibGUgdXAKICAgIGlmIChuYW1lID09PSAnZXJyb3InICYmIGFyZ3NbMF0ubmFtZSA9PT0gJ1VucmVjb2duaXplZFVSTEVycm9yJykgewogICAgICB0aHJvdyBhcmdzWzBdOwogICAgfSBlbHNlIGlmICghZXZlbnRXYXNIYW5kbGVkICYmICFpZ25vcmVGYWlsdXJlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm90aGluZyBoYW5kbGVkIHRoZSBldmVudCAnIiArIG5hbWUgKyAiJy4iKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldENoYW5nZWxpc3Qob2xkT2JqZWN0LCBuZXdPYmplY3QpIHsKICAgIHZhciBrZXkgPSB2b2lkIDA7CiAgICB2YXIgcmVzdWx0cyA9IHsKICAgICAgYWxsOiB7fSwKICAgICAgY2hhbmdlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9CiAgICB9OwoKICAgIG1lcmdlKHJlc3VsdHMuYWxsLCBuZXdPYmplY3QpOwoKICAgIHZhciBkaWRDaGFuZ2UgPSBmYWxzZTsKICAgIGNvZXJjZVF1ZXJ5UGFyYW1zVG9TdHJpbmcob2xkT2JqZWN0KTsKICAgIGNvZXJjZVF1ZXJ5UGFyYW1zVG9TdHJpbmcobmV3T2JqZWN0KTsKCiAgICAvLyBDYWxjdWxhdGUgcmVtb3ZhbHMKICAgIGZvciAoa2V5IGluIG9sZE9iamVjdCkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvbGRPYmplY3QsIGtleSkpIHsKICAgICAgICBpZiAoIWhhc093blByb3BlcnR5LmNhbGwobmV3T2JqZWN0LCBrZXkpKSB7CiAgICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlOwogICAgICAgICAgcmVzdWx0cy5yZW1vdmVkW2tleV0gPSBvbGRPYmplY3Rba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxjdWxhdGUgY2hhbmdlcwogICAgZm9yIChrZXkgaW4gbmV3T2JqZWN0KSB7CiAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG5ld09iamVjdCwga2V5KSkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9sZE9iamVjdFtrZXldKSAmJiBBcnJheS5pc0FycmF5KG5ld09iamVjdFtrZXldKSkgewogICAgICAgICAgaWYgKG9sZE9iamVjdFtrZXldLmxlbmd0aCAhPT0gbmV3T2JqZWN0W2tleV0ubGVuZ3RoKSB7CiAgICAgICAgICAgIHJlc3VsdHMuY2hhbmdlZFtrZXldID0gbmV3T2JqZWN0W2tleV07CiAgICAgICAgICAgIGRpZENoYW5nZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9sZE9iamVjdFtrZXldLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIGlmIChvbGRPYmplY3Rba2V5XVtpXSAhPT0gbmV3T2JqZWN0W2tleV1baV0pIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMuY2hhbmdlZFtrZXldID0gbmV3T2JqZWN0W2tleV07CiAgICAgICAgICAgICAgICBkaWRDaGFuZ2UgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob2xkT2JqZWN0W2tleV0gIT09IG5ld09iamVjdFtrZXldKSB7CiAgICAgICAgICByZXN1bHRzLmNoYW5nZWRba2V5XSA9IG5ld09iamVjdFtrZXldOwogICAgICAgICAgZGlkQ2hhbmdlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZGlkQ2hhbmdlID8gcmVzdWx0cyA6IHVuZGVmaW5lZDsKICB9CgogIGZ1bmN0aW9uIF9wcm9taXNlTGFiZWwobGFiZWwpIHsKICAgIHJldHVybiAnUm91dGVyOiAnICsgbGFiZWw7CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlSG9vayhvYmosIGhvb2tOYW1lKSB7CiAgICBpZiAoIW9iaikgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdW5kZXJzY29yZWQgPSAnXycgKyBob29rTmFtZTsKICAgIHJldHVybiBvYmpbdW5kZXJzY29yZWRdICYmIHVuZGVyc2NvcmVkIHx8IG9ialtob29rTmFtZV0gJiYgaG9va05hbWU7CiAgfQoKICBmdW5jdGlvbiBjYWxsSG9vayhvYmosIF9ob29rTmFtZSwgYXJnMSwgYXJnMikgewogICAgdmFyIGhvb2tOYW1lID0gcmVzb2x2ZUhvb2sob2JqLCBfaG9va05hbWUpOwogICAgcmV0dXJuIGhvb2tOYW1lICYmIG9ialtob29rTmFtZV0uY2FsbChvYmosIGFyZzEsIGFyZzIpOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlIb29rKG9iaiwgX2hvb2tOYW1lLCBhcmdzKSB7CiAgICB2YXIgaG9va05hbWUgPSByZXNvbHZlSG9vayhvYmosIF9ob29rTmFtZSk7CiAgICBpZiAoaG9va05hbWUpIHsKICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIG9ialtob29rTmFtZV0uY2FsbChvYmopOwogICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoID09PSAxKSB7CiAgICAgICAgcmV0dXJuIG9ialtob29rTmFtZV0uY2FsbChvYmosIGFyZ3NbMF0pOwogICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7CiAgICAgICAgcmV0dXJuIG9ialtob29rTmFtZV0uY2FsbChvYmosIGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBvYmpbaG9va05hbWVdLmFwcGx5KG9iaiwgYXJncyk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBUcmFuc2l0aW9uU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBUcmFuc2l0aW9uU3RhdGUoKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVHJhbnNpdGlvblN0YXRlKTsKCiAgICAgIHRoaXMuaGFuZGxlckluZm9zID0gW107CiAgICAgIHRoaXMucXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpcy5wYXJhbXMgPSB7fTsKICAgIH0KCiAgICBUcmFuc2l0aW9uU3RhdGUucHJvdG90eXBlLnByb21pc2VMYWJlbCA9IGZ1bmN0aW9uIHByb21pc2VMYWJlbChsYWJlbCkgewogICAgICB2YXIgdGFyZ2V0TmFtZSA9ICcnOwogICAgICBmb3JFYWNoKHRoaXMuaGFuZGxlckluZm9zLCBmdW5jdGlvbiAoaGFuZGxlckluZm8pIHsKICAgICAgICBpZiAodGFyZ2V0TmFtZSAhPT0gJycpIHsKICAgICAgICAgIHRhcmdldE5hbWUgKz0gJy4nOwogICAgICAgIH0KICAgICAgICB0YXJnZXROYW1lICs9IGhhbmRsZXJJbmZvLm5hbWU7CiAgICAgIH0pOwogICAgICByZXR1cm4gX3Byb21pc2VMYWJlbCgiJyIgKyB0YXJnZXROYW1lICsgIic6ICIgKyBsYWJlbCk7CiAgICB9OwoKICAgIFRyYW5zaXRpb25TdGF0ZS5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hvdWxkQ29udGludWUpIHsKICAgICAgdmFyIHBheWxvYWQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9OwoKICAgICAgLy8gRmlyc3QsIGNhbGN1bGF0ZSBwYXJhbXMgZm9yIHRoaXMgc3RhdGUuIFRoaXMgaXMgdXNlZnVsCiAgICAgIC8vIGluZm9ybWF0aW9uIHRvIHByb3ZpZGUgdG8gdGhlIHZhcmlvdXMgcm91dGUgaG9va3MuCiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgZm9yRWFjaCh0aGlzLmhhbmRsZXJJbmZvcywgZnVuY3Rpb24gKGhhbmRsZXJJbmZvKSB7CiAgICAgICAgcGFyYW1zW2hhbmRsZXJJbmZvLm5hbWVdID0gaGFuZGxlckluZm8ucGFyYW1zIHx8IHt9OwogICAgICB9KTsKCiAgICAgIHBheWxvYWQucmVzb2x2ZUluZGV4ID0gMDsKCiAgICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzOwogICAgICB2YXIgd2FzQWJvcnRlZCA9IGZhbHNlOwoKICAgICAgLy8gVGhlIHByZWx1ZGUgUlNWUC5yZXNvbHZlKCkgYXN5bmNzIHVzIGludG8gdGhlIHByb21pc2UgbGFuZC4KICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZShudWxsLCB0aGlzLnByb21pc2VMYWJlbCgnU3RhcnQgdHJhbnNpdGlvbicpKS50aGVuKHJlc29sdmVPbmVIYW5kbGVySW5mbywgbnVsbCwgdGhpcy5wcm9taXNlTGFiZWwoJ1Jlc29sdmUgaGFuZGxlcicpKS5jYXRjaChoYW5kbGVFcnJvciwgdGhpcy5wcm9taXNlTGFiZWwoJ0hhbmRsZSBlcnJvcicpKTsKCiAgICAgIGZ1bmN0aW9uIGlubmVyU2hvdWxkQ29udGludWUoKSB7CiAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZShzaG91bGRDb250aW51ZSgpLCBjdXJyZW50U3RhdGUucHJvbWlzZUxhYmVsKCdDaGVjayBpZiBzaG91bGQgY29udGludWUnKSkuY2F0Y2goZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgLy8gV2UgZGlzdGluZ3Vpc2ggYmV0d2VlbiBlcnJvcnMgdGhhdCBvY2N1cnJlZAogICAgICAgICAgLy8gZHVyaW5nIHJlc29sdXRpb24gKGUuZy4gYmVmb3JlIk1vZGVsL21vZGVsL2FmdGVyTW9kZWwpLAogICAgICAgICAgLy8gYW5kIGFib3J0cyBkdWUgdG8gYSByZWplY3RpbmcgcHJvbWlzZSBmcm9tIHNob3VsZENvbnRpbnVlKCkuCiAgICAgICAgICB3YXNBYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChyZWFzb24pOwogICAgICAgIH0sIGN1cnJlbnRTdGF0ZS5wcm9taXNlTGFiZWwoJ0hhbmRsZSBhYm9ydCcpKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3IpIHsKICAgICAgICAvLyBUaGlzIGlzIHRoZSBvbmx5IHBvc3NpYmxlCiAgICAgICAgLy8gcmVqZWN0IHZhbHVlIG9mIFRyYW5zaXRpb25TdGF0ZSNyZXNvbHZlCiAgICAgICAgdmFyIGhhbmRsZXJJbmZvcyA9IGN1cnJlbnRTdGF0ZS5oYW5kbGVySW5mb3M7CiAgICAgICAgdmFyIGVycm9ySGFuZGxlckluZGV4ID0gcGF5bG9hZC5yZXNvbHZlSW5kZXggPj0gaGFuZGxlckluZm9zLmxlbmd0aCA/IGhhbmRsZXJJbmZvcy5sZW5ndGggLSAxIDogcGF5bG9hZC5yZXNvbHZlSW5kZXg7CiAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVqZWN0KHsKICAgICAgICAgIGVycm9yOiBlcnJvciwKICAgICAgICAgIGhhbmRsZXJXaXRoRXJyb3I6IGN1cnJlbnRTdGF0ZS5oYW5kbGVySW5mb3NbZXJyb3JIYW5kbGVySW5kZXhdLmhhbmRsZXIsCiAgICAgICAgICB3YXNBYm9ydGVkOiB3YXNBYm9ydGVkLAogICAgICAgICAgc3RhdGU6IGN1cnJlbnRTdGF0ZQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcm9jZWVkKHJlc29sdmVkSGFuZGxlckluZm8pIHsKICAgICAgICB2YXIgd2FzQWxyZWFkeVJlc29sdmVkID0gY3VycmVudFN0YXRlLmhhbmRsZXJJbmZvc1twYXlsb2FkLnJlc29sdmVJbmRleF0uaXNSZXNvbHZlZDsKCiAgICAgICAgLy8gU3dhcCB0aGUgcHJldmlvdXNseSB1bnJlc29sdmVkIGhhbmRsZXJJbmZvIHdpdGgKICAgICAgICAvLyB0aGUgcmVzb2x2ZWQgaGFuZGxlckluZm8KICAgICAgICBjdXJyZW50U3RhdGUuaGFuZGxlckluZm9zW3BheWxvYWQucmVzb2x2ZUluZGV4KytdID0gcmVzb2x2ZWRIYW5kbGVySW5mbzsKCiAgICAgICAgaWYgKCF3YXNBbHJlYWR5UmVzb2x2ZWQpIHsKICAgICAgICAgIC8vIENhbGwgdGhlIHJlZGlyZWN0IGhvb2suIFRoZSByZWFzb24gd2UgY2FsbCBpdCBoZXJlCiAgICAgICAgICAvLyB2cy4gYWZ0ZXJNb2RlbCBpcyBzbyB0aGF0IHJlZGlyZWN0cyBpbnRvIGNoaWxkCiAgICAgICAgICAvLyByb3V0ZXMgZG9uJ3QgcmUtcnVuIHRoZSBtb2RlbCBob29rcyBmb3IgdGhpcwogICAgICAgICAgLy8gYWxyZWFkeS1yZXNvbHZlZCByb3V0ZS4KICAgICAgICAgIHZhciBoYW5kbGVyID0gcmVzb2x2ZWRIYW5kbGVySW5mby5oYW5kbGVyOwogICAgICAgICAgY2FsbEhvb2soaGFuZGxlciwgJ3JlZGlyZWN0JywgcmVzb2x2ZWRIYW5kbGVySW5mby5jb250ZXh0LCBwYXlsb2FkKTsKICAgICAgICB9CgogICAgICAgIC8vIFByb2NlZWQgYWZ0ZXIgZW5zdXJpbmcgdGhhdCB0aGUgcmVkaXJlY3QgaG9vawogICAgICAgIC8vIGRpZG4ndCBhYm9ydCB0aGlzIHRyYW5zaXRpb24gYnkgdHJhbnNpdGlvbmluZyBlbHNld2hlcmUuCiAgICAgICAgcmV0dXJuIGlubmVyU2hvdWxkQ29udGludWUoKS50aGVuKHJlc29sdmVPbmVIYW5kbGVySW5mbywgbnVsbCwgY3VycmVudFN0YXRlLnByb21pc2VMYWJlbCgnUmVzb2x2ZSBoYW5kbGVyJykpOwogICAgICB9CgogICAgICBmdW5jdGlvbiByZXNvbHZlT25lSGFuZGxlckluZm8oKSB7CiAgICAgICAgaWYgKHBheWxvYWQucmVzb2x2ZUluZGV4ID09PSBjdXJyZW50U3RhdGUuaGFuZGxlckluZm9zLmxlbmd0aCkgewogICAgICAgICAgLy8gVGhpcyBpcyBpcyB0aGUgb25seSBwb3NzaWJsZQogICAgICAgICAgLy8gZnVsZmlsbCB2YWx1ZSBvZiBUcmFuc2l0aW9uU3RhdGUjcmVzb2x2ZQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgICAgIHN0YXRlOiBjdXJyZW50U3RhdGUKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBjdXJyZW50U3RhdGUuaGFuZGxlckluZm9zW3BheWxvYWQucmVzb2x2ZUluZGV4XTsKCiAgICAgICAgcmV0dXJuIGhhbmRsZXJJbmZvLnJlc29sdmUoaW5uZXJTaG91bGRDb250aW51ZSwgcGF5bG9hZCkudGhlbihwcm9jZWVkLCBudWxsLCBjdXJyZW50U3RhdGUucHJvbWlzZUxhYmVsKCdQcm9jZWVkJykpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBUcmFuc2l0aW9uU3RhdGU7CiAgfSgpOwoKICBmdW5jdGlvbiBUcmFuc2l0aW9uQWJvcnRlZEVycm9yKG1lc3NhZ2UpIHsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBUcmFuc2l0aW9uQWJvcnRlZEVycm9yKSkgewogICAgICByZXR1cm4gbmV3IFRyYW5zaXRpb25BYm9ydGVkRXJyb3IobWVzc2FnZSk7CiAgICB9CgogICAgdmFyIGVycm9yID0gRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKCiAgICBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgVHJhbnNpdGlvbkFib3J0ZWRFcnJvcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnN0YWNrID0gZXJyb3Iuc3RhY2s7CiAgICB9CgogICAgdGhpcy5kZXNjcmlwdGlvbiA9IGVycm9yLmRlc2NyaXB0aW9uOwogICAgdGhpcy5maWxlTmFtZSA9IGVycm9yLmZpbGVOYW1lOwogICAgdGhpcy5saW5lTnVtYmVyID0gZXJyb3IubGluZU51bWJlcjsKICAgIHRoaXMubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2UgfHwgJ1RyYW5zaXRpb25BYm9ydGVkJzsKICAgIHRoaXMubmFtZSA9ICdUcmFuc2l0aW9uQWJvcnRlZCc7CiAgICB0aGlzLm51bWJlciA9IGVycm9yLm51bWJlcjsKICAgIHRoaXMuY29kZSA9IGVycm9yLmNvZGU7CiAgfQoKICBUcmFuc2l0aW9uQWJvcnRlZEVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICBBIFRyYW5zaXRpb24gaXMgYSB0aGVubmFibGUgKGEgcHJvbWlzZS1saWtlIG9iamVjdCkgdGhhdCByZXByZXNlbnRzCiAgICBhbiBhdHRlbXB0IHRvIHRyYW5zaXRpb24gdG8gYW5vdGhlciByb3V0ZS4gSXQgY2FuIGJlIGFib3J0ZWQsIGVpdGhlcgogICAgZXhwbGljaXRseSB2aWEgYGFib3J0YCBvciBieSBhdHRlbXB0aW5nIGFub3RoZXIgdHJhbnNpdGlvbiB3aGlsZSBhCiAgICBwcmV2aW91cyBvbmUgaXMgc3RpbGwgdW5kZXJ3YXkuIEFuIGFib3J0ZWQgdHJhbnNpdGlvbiBjYW4gYWxzbwogICAgYmUgYHJldHJ5KClgZCBsYXRlci4KICAKICAgIEBjbGFzcyBUcmFuc2l0aW9uCiAgICBAY29uc3RydWN0b3IKICAgIEBwYXJhbSB7T2JqZWN0fSByb3V0ZXIKICAgIEBwYXJhbSB7T2JqZWN0fSBpbnRlbnQKICAgIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGVycm9yCiAgICBAcHJpdmF0ZQogICAqLwoKICB2YXIgVHJhbnNpdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFRyYW5zaXRpb24ocm91dGVyLCBpbnRlbnQsIHN0YXRlLCBlcnJvciwgcHJldmlvdXNUcmFuc2l0aW9uKSB7CiAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFRyYW5zaXRpb24pOwoKICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlIHx8IHJvdXRlci5zdGF0ZTsKICAgICAgdGhpcy5pbnRlbnQgPSBpbnRlbnQ7CiAgICAgIHRoaXMucm91dGVyID0gcm91dGVyOwogICAgICB0aGlzLmRhdGEgPSB0aGlzLmludGVudCAmJiB0aGlzLmludGVudC5kYXRhIHx8IHt9OwogICAgICB0aGlzLnJlc29sdmVkTW9kZWxzID0ge307CiAgICAgIHRoaXMucXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdGhpcy5wcm9taXNlID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmVycm9yID0gdW5kZWZpbmVkOwogICAgICB0aGlzLnBhcmFtcyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5oYW5kbGVySW5mb3MgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMudGFyZ2V0TmFtZSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5waXZvdEhhbmRsZXIgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc2VxdWVuY2UgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaXNBYm9ydGVkID0gZmFsc2U7CiAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlOwogICAgICB0aGlzLnVybE1ldGhvZCA9ICd1cGRhdGUnOwogICAgICB0aGlzLnJlc29sdmVJbmRleCA9IDA7CiAgICAgIHRoaXMucXVlcnlQYXJhbXNPbmx5ID0gZmFsc2U7CiAgICAgIHRoaXMuaXNUcmFuc2l0aW9uID0gdHJ1ZTsKCiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHRoaXMucHJvbWlzZSA9IF9yc3ZwLlByb21pc2UucmVqZWN0KGVycm9yKTsKICAgICAgICB0aGlzLmVycm9yID0gZXJyb3I7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBpZiB5b3UncmUgZG9pbmcgbXVsdGlwbGUgcmVkaXJlY3RzLCBuZWVkIHRoZSBuZXcgdHJhbnNpdGlvbiB0byBrbm93IGlmIGl0CiAgICAgIC8vIGlzIGFjdHVhbGx5IHBhcnQgb2YgdGhlIGZpcnN0IHRyYW5zaXRpb24gb3Igbm90LiBBbnkgZnVydGhlciByZWRpcmVjdHMKICAgICAgLy8gaW4gdGhlIGluaXRpYWwgdHJhbnNpdGlvbiBhbHNvIG5lZWQgdG8ga25vdyBpZiB0aGV5IGFyZSBwYXJ0IG9mIHRoZQogICAgICAvLyBpbml0aWFsIHRyYW5zaXRpb24KICAgICAgdGhpcy5pc0NhdXNlZEJ5QWJvcnRpbmdUcmFuc2l0aW9uID0gISFwcmV2aW91c1RyYW5zaXRpb247CiAgICAgIHRoaXMuaXNDYXVzZWRCeUluaXRpYWxUcmFuc2l0aW9uID0gcHJldmlvdXNUcmFuc2l0aW9uICYmIChwcmV2aW91c1RyYW5zaXRpb24uaXNDYXVzZWRCeUluaXRpYWxUcmFuc2l0aW9uIHx8IHByZXZpb3VzVHJhbnNpdGlvbi5zZXF1ZW5jZSA9PT0gMCk7CiAgICAgIC8vIEV2ZXJ5IHRyYW5zaXRpb24gaW4gdGhlIGNoYWluIGlzIGEgcmVwbGFjZQogICAgICB0aGlzLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uID0gcHJldmlvdXNUcmFuc2l0aW9uICYmIHByZXZpb3VzVHJhbnNpdGlvbi51cmxNZXRob2QgPT0gJ3JlcGxhY2UnICYmICghcHJldmlvdXNUcmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1RyYW5zaXRpb24gfHwgcHJldmlvdXNUcmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uKTsKCiAgICAgIGlmIChzdGF0ZSkgewogICAgICAgIHRoaXMucGFyYW1zID0gc3RhdGUucGFyYW1zOwogICAgICAgIHRoaXMucXVlcnlQYXJhbXMgPSBzdGF0ZS5xdWVyeVBhcmFtczsKICAgICAgICB0aGlzLmhhbmRsZXJJbmZvcyA9IHN0YXRlLmhhbmRsZXJJbmZvczsKCiAgICAgICAgdmFyIGxlbiA9IHN0YXRlLmhhbmRsZXJJbmZvcy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgdGhpcy50YXJnZXROYW1lID0gc3RhdGUuaGFuZGxlckluZm9zW2xlbiAtIDFdLm5hbWU7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBzdGF0ZS5oYW5kbGVySW5mb3NbaV07CgogICAgICAgICAgLy8gVE9ETzogdGhpcyBhbGwgc2VlbXMgaGFja3kKICAgICAgICAgIGlmICghaGFuZGxlckluZm8uaXNSZXNvbHZlZCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMucGl2b3RIYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlcjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc2VxdWVuY2UgPSByb3V0ZXIuY3VycmVudFNlcXVlbmNlKys7CiAgICAgICAgdGhpcy5wcm9taXNlID0gc3RhdGUucmVzb2x2ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoX3RoaXMuaXNBYm9ydGVkKSB7CiAgICAgICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdCh1bmRlZmluZWQsIF9wcm9taXNlTGFiZWwoJ1RyYW5zaXRpb24gYWJvcnRlZCAtIHJlamVjdCcpKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzKS5jYXRjaChmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc0Fib3J0ZWQgfHwgX3RoaXMuaXNBYm9ydGVkKSB7CiAgICAgICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChsb2dBYm9ydChfdGhpcykpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX3RoaXMudHJpZ2dlcignZXJyb3InLCByZXN1bHQuZXJyb3IsIF90aGlzLCByZXN1bHQuaGFuZGxlcldpdGhFcnJvcik7CiAgICAgICAgICAgIF90aGlzLmFib3J0KCk7CiAgICAgICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChyZXN1bHQuZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0sIF9wcm9taXNlTGFiZWwoJ0hhbmRsZSBBYm9ydCcpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByb21pc2UgPSBfcnN2cC5Qcm9taXNlLnJlc29sdmUodGhpcy5zdGF0ZSk7CiAgICAgICAgdGhpcy5wYXJhbXMgPSB7fTsKICAgICAgfQogICAgfQoKICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLmlzRXhpdGluZyA9IGZ1bmN0aW9uIGlzRXhpdGluZyhoYW5kbGVyKSB7CiAgICAgIHZhciBoYW5kbGVySW5mb3MgPSB0aGlzLmhhbmRsZXJJbmZvczsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBoYW5kbGVySW5mbyA9IGhhbmRsZXJJbmZvc1tpXTsKICAgICAgICBpZiAoaGFuZGxlckluZm8ubmFtZSA9PT0gaGFuZGxlciB8fCBoYW5kbGVySW5mby5oYW5kbGVyID09PSBoYW5kbGVyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24gdGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCwgbGFiZWwpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvbWlzZS50aGVuKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkLCBsYWJlbCk7CiAgICB9OwoKICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLmNhdGNoID0gZnVuY3Rpb24gX2NhdGNoKG9uUmVqZWN0aW9uLCBsYWJlbCkgewogICAgICByZXR1cm4gdGhpcy5wcm9taXNlLmNhdGNoKG9uUmVqZWN0aW9uLCBsYWJlbCk7CiAgICB9OwoKICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLmZpbmFsbHkgPSBmdW5jdGlvbiBfZmluYWxseShjYWxsYmFjaywgbGFiZWwpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvbWlzZS5maW5hbGx5KGNhbGxiYWNrLCBsYWJlbCk7CiAgICB9OwoKICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLmFib3J0ID0gZnVuY3Rpb24gYWJvcnQoKSB7CiAgICAgIGlmICh0aGlzLmlzQWJvcnRlZCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIF9sb2codGhpcy5yb3V0ZXIsIHRoaXMuc2VxdWVuY2UsIHRoaXMudGFyZ2V0TmFtZSArICc6IHRyYW5zaXRpb24gd2FzIGFib3J0ZWQnKTsKICAgICAgdGhpcy5pbnRlbnQucHJlVHJhbnNpdGlvblN0YXRlID0gdGhpcy5yb3V0ZXIuc3RhdGU7CiAgICAgIHRoaXMuaXNBYm9ydGVkID0gdHJ1ZTsKICAgICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICB0aGlzLnJvdXRlci5hY3RpdmVUcmFuc2l0aW9uID0gbnVsbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLnJldHJ5ID0gZnVuY3Rpb24gcmV0cnkoKSB7CiAgICAgIC8vIFRPRE86IGFkZCB0ZXN0cyBmb3IgbWVyZ2VkIHN0YXRlIHJldHJ5KClzCiAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAgdmFyIG5ld1RyYW5zaXRpb24gPSB0aGlzLnJvdXRlci50cmFuc2l0aW9uQnlJbnRlbnQodGhpcy5pbnRlbnQsIGZhbHNlKTsKCiAgICAgIC8vIGluaGVyaXRpbmcgYSBgbnVsbGAgdXJsTWV0aG9kIGlzIG5vdCB2YWxpZAogICAgICAvLyB0aGUgdXJsTWV0aG9kIGlzIG9ubHkgc2V0IHRvIGBudWxsYCB3aGVuCiAgICAgIC8vIHRoZSB0cmFuc2l0aW9uIGlzIGluaXRpYXRlZCAqYWZ0ZXIqIHRoZSB1cmwKICAgICAgLy8gaGFzIGJlZW4gdXBkYXRlZCAoaS5lLiBgcm91dGVyLmhhbmRsZVVSTGApCiAgICAgIC8vCiAgICAgIC8vIGluIHRoYXQgc2NlbmFyaW8sIHRoZSB1cmwgbWV0aG9kIGNhbm5vdCBiZQogICAgICAvLyBpbmhlcml0ZWQgZm9yIGEgbmV3IHRyYW5zaXRpb24gYmVjYXVzZSB0aGVuCiAgICAgIC8vIHRoZSB1cmwgd291bGQgbm90IHVwZGF0ZSBldmVuIHRob3VnaCBpdCBzaG91bGQKICAgICAgaWYgKHRoaXMudXJsTWV0aG9kICE9PSBudWxsKSB7CiAgICAgICAgbmV3VHJhbnNpdGlvbi5tZXRob2QodGhpcy51cmxNZXRob2QpOwogICAgICB9CiAgICAgIHJldHVybiBuZXdUcmFuc2l0aW9uOwogICAgfTsKCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZS5tZXRob2QgPSBmdW5jdGlvbiBtZXRob2QoX21ldGhvZCkgewogICAgICB0aGlzLnVybE1ldGhvZCA9IF9tZXRob2Q7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZS50cmlnZ2VyID0gZnVuY3Rpb24gdHJpZ2dlcihpZ25vcmVGYWlsdXJlKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBpZiAodHlwZW9mIGlnbm9yZUZhaWx1cmUgPT09ICdib29sZWFuJykgewogICAgICAgIGFyZ3Muc2hpZnQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUaHJvdyBlcnJvcnMgb24gdW5oYW5kbGVkIHRyaWdnZXIgZXZlbnRzIGJ5IGRlZmF1bHQKICAgICAgICBpZ25vcmVGYWlsdXJlID0gZmFsc2U7CiAgICAgIH0KICAgICAgX3RyaWdnZXIodGhpcy5yb3V0ZXIsIHRoaXMuc3RhdGUuaGFuZGxlckluZm9zLnNsaWNlKDAsIHRoaXMucmVzb2x2ZUluZGV4ICsgMSksIGlnbm9yZUZhaWx1cmUsIGFyZ3MpOwogICAgfTsKCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZS5mb2xsb3dSZWRpcmVjdHMgPSBmdW5jdGlvbiBmb2xsb3dSZWRpcmVjdHMoKSB7CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzLnJvdXRlcjsKICAgICAgcmV0dXJuIHRoaXMucHJvbWlzZS5jYXRjaChmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgaWYgKHJvdXRlci5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgICAgICByZXR1cm4gcm91dGVyLmFjdGl2ZVRyYW5zaXRpb24uZm9sbG93UmVkaXJlY3RzKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlamVjdChyZWFzb24pOwogICAgICB9KTsKICAgIH07CgogICAgVHJhbnNpdGlvbi5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZygpIHsKICAgICAgcmV0dXJuICdUcmFuc2l0aW9uIChzZXF1ZW5jZSAnICsgdGhpcy5zZXF1ZW5jZSArICcpJzsKICAgIH07CgogICAgVHJhbnNpdGlvbi5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gbG9nKG1lc3NhZ2UpIHsKICAgICAgX2xvZyh0aGlzLnJvdXRlciwgdGhpcy5zZXF1ZW5jZSwgbWVzc2FnZSk7CiAgICB9OwoKICAgIHJldHVybiBUcmFuc2l0aW9uOwogIH0oKTsKCiAgLy8gQWxpYXMgJ3RyaWdnZXInIGFzICdzZW5kJwogIFRyYW5zaXRpb24ucHJvdG90eXBlLnNlbmQgPSBUcmFuc2l0aW9uLnByb3RvdHlwZS50cmlnZ2VyOwoKICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBMb2dzIGFuZCByZXR1cm5zIGFuIGluc3RhbmNlIG9mIFRyYW5zaXRpb25BYm9ydGVkLgogICAqLwogIGZ1bmN0aW9uIGxvZ0Fib3J0KHRyYW5zaXRpb24pIHsKICAgIF9sb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICdkZXRlY3RlZCBhYm9ydC4nKTsKICAgIHJldHVybiBuZXcgVHJhbnNpdGlvbkFib3J0ZWRFcnJvcigpOwogIH0KCiAgdmFyIFRyYW5zaXRpb25JbnRlbnQgPSBmdW5jdGlvbiBUcmFuc2l0aW9uSW50ZW50KCkgewogICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBUcmFuc2l0aW9uSW50ZW50KTsKCiAgICB0aGlzLmRhdGEgPSB0aGlzLmRhdGEgfHwge307CiAgfTsKCiAgdmFyIERFRkFVTFRfSEFORExFUiA9IE9iamVjdC5mcmVlemUoe30pOwoKICB2YXIgSGFuZGxlckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBIYW5kbGVySW5mbygpIHsKICAgICAgdmFyIHByb3BzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fTsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBIYW5kbGVySW5mbyk7CgogICAgICAvLyBpbml0aWFsaXplIGxvY2FsIHByb3BlcnRpZXMgdG8gZW5zdXJlIGNvbnNpc3RlbnQgb2JqZWN0IHNoYXBlCiAgICAgIHRoaXMuX2hhbmRsZXIgPSBERUZBVUxUX0hBTkRMRVI7CiAgICAgIHRoaXMuX2hhbmRsZXJQcm9taXNlID0gbnVsbDsKICAgICAgdGhpcy5mYWN0b3J5ID0gbnVsbDsgLy8gSW5qZWN0ZWQgYnkgdGhlIGhhbmRsZXIgaW5mbyBmYWN0b3J5CiAgICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWU7CgogICAgICBmb3IgKHZhciBwcm9wIGluIHByb3BzKSB7CiAgICAgICAgaWYgKHByb3AgPT09ICdoYW5kbGVyJykgewogICAgICAgICAgdGhpcy5fcHJvY2Vzc0hhbmRsZXIocHJvcHMuaGFuZGxlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbcHJvcF0gPSBwcm9wc1twcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUuZ2V0SGFuZGxlciA9IGZ1bmN0aW9uIGdldEhhbmRsZXIoKSB7fTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUuZmV0Y2hIYW5kbGVyID0gZnVuY3Rpb24gZmV0Y2hIYW5kbGVyKCkgewogICAgICB2YXIgaGFuZGxlciA9IHRoaXMuZ2V0SGFuZGxlcih0aGlzLm5hbWUpOwogICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc0hhbmRsZXIoaGFuZGxlcik7CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5fcHJvY2Vzc0hhbmRsZXIgPSBmdW5jdGlvbiBfcHJvY2Vzc0hhbmRsZXIoaGFuZGxlcikgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIC8vIFNldHVwIGEgaGFuZGxlclByb21pc2Ugc28gdGhhdCB3ZSBjYW4gd2FpdCBmb3IgYXN5bmNocm9ub3VzbHkgbG9hZGVkIGhhbmRsZXJzCiAgICAgIHRoaXMuaGFuZGxlclByb21pc2UgPSBfcnN2cC5Qcm9taXNlLnJlc29sdmUoaGFuZGxlcik7CgogICAgICAvLyBXYWl0IHVudGlsIHRoZSAnaGFuZGxlcicgcHJvcGVydHkgaGFzIGJlZW4gdXBkYXRlZCB3aGVuIGNoYWluaW5nIHRvIGEgaGFuZGxlcgogICAgICAvLyB0aGF0IGlzIGEgcHJvbWlzZQogICAgICBpZiAoaXNQcm9taXNlKGhhbmRsZXIpKSB7CiAgICAgICAgdGhpcy5oYW5kbGVyUHJvbWlzZSA9IHRoaXMuaGFuZGxlclByb21pc2UudGhlbihmdW5jdGlvbiAoaCkgewogICAgICAgICAgcmV0dXJuIF90aGlzMi51cGRhdGVIYW5kbGVyKGgpOwogICAgICAgIH0pOwogICAgICAgIC8vIHNldCB0byB1bmRlZmluZWQgdG8gYXZvaWQgcmVjdXJzaXZlIGxvb3AgaW4gdGhlIGhhbmRsZXIgZ2V0dGVyCiAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlciA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChoYW5kbGVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlSGFuZGxlcihoYW5kbGVyKTsKICAgICAgfQogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gbG9nKHBheWxvYWQsIG1lc3NhZ2UpIHsKICAgICAgaWYgKHBheWxvYWQubG9nKSB7CiAgICAgICAgcGF5bG9hZC5sb2codGhpcy5uYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgICB9CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5wcm9taXNlTGFiZWwgPSBmdW5jdGlvbiBwcm9taXNlTGFiZWwobGFiZWwpIHsKICAgICAgcmV0dXJuIF9wcm9taXNlTGFiZWwoIiciICsgdGhpcy5uYW1lICsgIicgIiArIGxhYmVsKTsKICAgIH07CgogICAgSGFuZGxlckluZm8ucHJvdG90eXBlLmdldFVucmVzb2x2ZWQgPSBmdW5jdGlvbiBnZXRVbnJlc29sdmVkKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH07CgogICAgSGFuZGxlckluZm8ucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyYW1zIHx8IHt9OwogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUudXBkYXRlSGFuZGxlciA9IGZ1bmN0aW9uIHVwZGF0ZUhhbmRsZXIoaGFuZGxlcikgewogICAgICAvLyBTdG9yZSB0aGUgbmFtZSBvZiB0aGUgaGFuZGxlciBvbiB0aGUgaGFuZGxlciBmb3IgZWFzeSBjaGVja3MgbGF0ZXIKICAgICAgaGFuZGxlci5faGFuZGxlck5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIHJldHVybiB0aGlzLmhhbmRsZXIgPSBoYW5kbGVyOwogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hvdWxkQ29udGludWUsIHBheWxvYWQpIHsKICAgICAgdmFyIGNoZWNrRm9yQWJvcnQgPSB0aGlzLmNoZWNrRm9yQWJvcnQuYmluZCh0aGlzLCBzaG91bGRDb250aW51ZSk7CiAgICAgIHZhciBiZWZvcmVNb2RlbCA9IHRoaXMucnVuQmVmb3JlTW9kZWxIb29rLmJpbmQodGhpcywgcGF5bG9hZCk7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuZ2V0TW9kZWwuYmluZCh0aGlzLCBwYXlsb2FkKTsKICAgICAgdmFyIGFmdGVyTW9kZWwgPSB0aGlzLnJ1bkFmdGVyTW9kZWxIb29rLmJpbmQodGhpcywgcGF5bG9hZCk7CiAgICAgIHZhciBiZWNvbWVSZXNvbHZlZCA9IHRoaXMuYmVjb21lUmVzb2x2ZWQuYmluZCh0aGlzLCBwYXlsb2FkKTsKCiAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlc29sdmUodGhpcy5oYW5kbGVyUHJvbWlzZSwgdGhpcy5wcm9taXNlTGFiZWwoJ1N0YXJ0IGhhbmRsZXInKSkudGhlbihjaGVja0ZvckFib3J0LCBudWxsLCB0aGlzLnByb21pc2VMYWJlbCgnQ2hlY2sgZm9yIGFib3J0JykpLnRoZW4oYmVmb3JlTW9kZWwsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCdCZWZvcmUgbW9kZWwnKSkudGhlbihjaGVja0ZvckFib3J0LCBudWxsLCB0aGlzLnByb21pc2VMYWJlbCgiQ2hlY2sgaWYgYWJvcnRlZCBkdXJpbmcgJ2JlZm9yZU1vZGVsJyBob29rIikpLnRoZW4obW9kZWwsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCdNb2RlbCcpKS50aGVuKGNoZWNrRm9yQWJvcnQsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCJDaGVjayBpZiBhYm9ydGVkIGluICdtb2RlbCcgaG9vayIpKS50aGVuKGFmdGVyTW9kZWwsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCdBZnRlciBtb2RlbCcpKS50aGVuKGNoZWNrRm9yQWJvcnQsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCJDaGVjayBpZiBhYm9ydGVkIGluICdhZnRlck1vZGVsJyBob29rIikpLnRoZW4oYmVjb21lUmVzb2x2ZWQsIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCdCZWNvbWUgcmVzb2x2ZWQnKSk7CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5ydW5CZWZvcmVNb2RlbEhvb2sgPSBmdW5jdGlvbiBydW5CZWZvcmVNb2RlbEhvb2socGF5bG9hZCkgewogICAgICBpZiAocGF5bG9hZC50cmlnZ2VyKSB7CiAgICAgICAgcGF5bG9hZC50cmlnZ2VyKHRydWUsICd3aWxsUmVzb2x2ZU1vZGVsJywgcGF5bG9hZCwgdGhpcy5oYW5kbGVyKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5ydW5TaGFyZWRNb2RlbEhvb2socGF5bG9hZCwgJ2JlZm9yZU1vZGVsJywgW10pOwogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUucnVuQWZ0ZXJNb2RlbEhvb2sgPSBmdW5jdGlvbiBydW5BZnRlck1vZGVsSG9vayhwYXlsb2FkLCByZXNvbHZlZE1vZGVsKSB7CiAgICAgIC8vIFN0YXNoIHRoZSByZXNvbHZlZCBtb2RlbCBvbiB0aGUgcGF5bG9hZC4KICAgICAgLy8gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSBmb3IgdXNlcnMgdG8gc3dhcCBvdXQKICAgICAgLy8gdGhlIHJlc29sdmVkIG1vZGVsIGluIGFmdGVyTW9kZWwuCiAgICAgIHZhciBuYW1lID0gdGhpcy5uYW1lOwogICAgICB0aGlzLnN0YXNoUmVzb2x2ZWRNb2RlbChwYXlsb2FkLCByZXNvbHZlZE1vZGVsKTsKCiAgICAgIHJldHVybiB0aGlzLnJ1blNoYXJlZE1vZGVsSG9vayhwYXlsb2FkLCAnYWZ0ZXJNb2RlbCcsIFtyZXNvbHZlZE1vZGVsXSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gSWdub3JlIHRoZSBmdWxmaWxsZWQgdmFsdWUgcmV0dXJuZWQgZnJvbSBhZnRlck1vZGVsLgogICAgICAgIC8vIFJldHVybiB0aGUgdmFsdWUgc3Rhc2hlZCBpbiByZXNvbHZlZE1vZGVscywgd2hpY2gKICAgICAgICAvLyBtaWdodCBoYXZlIGJlZW4gc3dhcHBlZCBvdXQgaW4gYWZ0ZXJNb2RlbC4KICAgICAgICByZXR1cm4gcGF5bG9hZC5yZXNvbHZlZE1vZGVsc1tuYW1lXTsKICAgICAgfSwgbnVsbCwgdGhpcy5wcm9taXNlTGFiZWwoJ0lnbm9yZSBmdWxmaWxsbWVudCB2YWx1ZSBhbmQgcmV0dXJuIG1vZGVsIHZhbHVlJykpOwogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUucnVuU2hhcmVkTW9kZWxIb29rID0gZnVuY3Rpb24gcnVuU2hhcmVkTW9kZWxIb29rKHBheWxvYWQsIGhvb2tOYW1lLCBhcmdzKSB7CiAgICAgIHRoaXMubG9nKHBheWxvYWQsICdjYWxsaW5nICcgKyBob29rTmFtZSArICcgaG9vaycpOwoKICAgICAgaWYgKHRoaXMucXVlcnlQYXJhbXMpIHsKICAgICAgICBhcmdzLnB1c2godGhpcy5xdWVyeVBhcmFtcyk7CiAgICAgIH0KICAgICAgYXJncy5wdXNoKHBheWxvYWQpOwoKICAgICAgdmFyIHJlc3VsdCA9IGFwcGx5SG9vayh0aGlzLmhhbmRsZXIsIGhvb2tOYW1lLCBhcmdzKTsKCiAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmlzVHJhbnNpdGlvbikgewogICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBfcnN2cC5Qcm9taXNlLnJlc29sdmUocmVzdWx0LCB0aGlzLnByb21pc2VMYWJlbCgnUmVzb2x2ZSB2YWx1ZSByZXR1cm5lZCBmcm9tIG9uZSBvZiB0aGUgbW9kZWwgaG9va3MnKSk7CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5nZXRNb2RlbCA9IGZ1bmN0aW9uIGdldE1vZGVsKCkge307CgogICAgSGFuZGxlckluZm8ucHJvdG90eXBlLmNoZWNrRm9yQWJvcnQgPSBmdW5jdGlvbiBjaGVja0ZvckFib3J0KHNob3VsZENvbnRpbnVlLCBwcm9taXNlVmFsdWUpIHsKICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZShzaG91bGRDb250aW51ZSgpLCB0aGlzLnByb21pc2VMYWJlbCgnQ2hlY2sgZm9yIGFib3J0JykpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIC8vIFdlIGRvbid0IGNhcmUgYWJvdXQgc2hvdWxkQ29udGludWUncyByZXNvbHZlIHZhbHVlOwogICAgICAgIC8vIHBhc3MgYWxvbmcgdGhlIG9yaWdpbmFsIHZhbHVlIHBhc3NlZCB0byB0aGlzIGZuLgogICAgICAgIHJldHVybiBwcm9taXNlVmFsdWU7CiAgICAgIH0sIG51bGwsIHRoaXMucHJvbWlzZUxhYmVsKCdJZ25vcmUgZnVsZmlsbG1lbnQgdmFsdWUgYW5kIGNvbnRpbnVlJykpOwogICAgfTsKCiAgICBIYW5kbGVySW5mby5wcm90b3R5cGUuc3Rhc2hSZXNvbHZlZE1vZGVsID0gZnVuY3Rpb24gc3Rhc2hSZXNvbHZlZE1vZGVsKHBheWxvYWQsIHJlc29sdmVkTW9kZWwpIHsKICAgICAgcGF5bG9hZC5yZXNvbHZlZE1vZGVscyA9IHBheWxvYWQucmVzb2x2ZWRNb2RlbHMgfHwge307CiAgICAgIHBheWxvYWQucmVzb2x2ZWRNb2RlbHNbdGhpcy5uYW1lXSA9IHJlc29sdmVkTW9kZWw7CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5iZWNvbWVSZXNvbHZlZCA9IGZ1bmN0aW9uIGJlY29tZVJlc29sdmVkKHBheWxvYWQsIHJlc29sdmVkQ29udGV4dCkgewogICAgICB2YXIgcGFyYW1zID0gdGhpcy5zZXJpYWxpemUocmVzb2x2ZWRDb250ZXh0KTsKCiAgICAgIGlmIChwYXlsb2FkKSB7CiAgICAgICAgdGhpcy5zdGFzaFJlc29sdmVkTW9kZWwocGF5bG9hZCwgcmVzb2x2ZWRDb250ZXh0KTsKICAgICAgICBwYXlsb2FkLnBhcmFtcyA9IHBheWxvYWQucGFyYW1zIHx8IHt9OwogICAgICAgIHBheWxvYWQucGFyYW1zW3RoaXMubmFtZV0gPSBwYXJhbXM7CiAgICAgIH0KCiAgICAgIHZhciByZXNvbHV0aW9uID0gewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIsCiAgICAgICAgcGFyYW1zOiBwYXJhbXMKICAgICAgfTsKCiAgICAgIC8vIERvbid0IHNldCBhIGNvbnRleHQgb24gdGhlIHJlc29sdXRpb24gdW5sZXNzIHdlIGFjdHVhbGx5IGhhdmUgb25lLgogICAgICB2YXIgY29udGV4dHNNYXRjaCA9IHJlc29sdmVkQ29udGV4dCA9PT0gdGhpcy5jb250ZXh0OwogICAgICBpZiAoJ2NvbnRleHQnIGluIHRoaXMgfHwgIWNvbnRleHRzTWF0Y2gpIHsKICAgICAgICByZXNvbHV0aW9uLmNvbnRleHQgPSByZXNvbHZlZENvbnRleHQ7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLmZhY3RvcnkoJ3Jlc29sdmVkJywgcmVzb2x1dGlvbik7CiAgICB9OwoKICAgIEhhbmRsZXJJbmZvLnByb3RvdHlwZS5zaG91bGRTdXBlcmNlZGUgPSBmdW5jdGlvbiBzaG91bGRTdXBlcmNlZGUob3RoZXIpIHsKICAgICAgLy8gUHJlZmVyIHRoaXMgbmV3ZXIgaGFuZGxlckluZm8gb3ZlciBgb3RoZXJgIGlmOgogICAgICAvLyAxKSBUaGUgb3RoZXIgb25lIGRvZXNuJ3QgZXhpc3QKICAgICAgLy8gMikgVGhlIG5hbWVzIGRvbid0IG1hdGNoCiAgICAgIC8vIDMpIFRoaXMgaGFuZGxlciBoYXMgYSBjb250ZXh0IHRoYXQgZG9lc24ndCBtYXRjaAogICAgICAvLyAgICB0aGUgb3RoZXIgb25lIChvciB0aGUgb3RoZXIgb25lIGRvZXNuJ3QgaGF2ZSBvbmUpLgogICAgICAvLyA0KSBUaGlzIGhhbmRsZXIgaGFzIHBhcmFtZXRlcnMgdGhhdCBkb24ndCBtYXRjaCB0aGUgb3RoZXIuCiAgICAgIGlmICghb3RoZXIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIGNvbnRleHRzTWF0Y2ggPSBvdGhlci5jb250ZXh0ID09PSB0aGlzLmNvbnRleHQ7CiAgICAgIHJldHVybiBvdGhlci5uYW1lICE9PSB0aGlzLm5hbWUgfHwgJ2NvbnRleHQnIGluIHRoaXMgJiYgIWNvbnRleHRzTWF0Y2ggfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eSgncGFyYW1zJykgJiYgIXBhcmFtc01hdGNoKHRoaXMucGFyYW1zLCBvdGhlci5wYXJhbXMpOwogICAgfTsKCiAgICAoMCwgX2VtYmVyQmFiZWwuY3JlYXRlQ2xhc3MpKEhhbmRsZXJJbmZvLCBbewogICAgICBrZXk6ICdoYW5kbGVyJywKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gX2hhbmRsZXIgY291bGQgYmUgc2V0IHRvIGVpdGhlciBhIGhhbmRsZXIgb2JqZWN0IG9yIHVuZGVmaW5lZCwgc28gd2UKICAgICAgICAvLyBjb21wYXJlIGFnYWluc3QgYSBkZWZhdWx0IHJlZmVyZW5jZSB0byBrbm93IHdoZW4gaXQncyBiZWVuIHNldAogICAgICAgIGlmICh0aGlzLl9oYW5kbGVyICE9PSBERUZBVUxUX0hBTkRMRVIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVyOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2hIYW5kbGVyKCk7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGhhbmRsZXIpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlciA9IGhhbmRsZXI7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAnaGFuZGxlclByb21pc2UnLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5faGFuZGxlclByb21pc2UgIT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVyUHJvbWlzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZmV0Y2hIYW5kbGVyKCk7CgogICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVyUHJvbWlzZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiAoaGFuZGxlclByb21pc2UpIHsKICAgICAgICB0aGlzLl9oYW5kbGVyUHJvbWlzZSA9IGhhbmRsZXJQcm9taXNlOwoKICAgICAgICByZXR1cm4gaGFuZGxlclByb21pc2U7CiAgICAgIH0KICAgIH1dKTsKICAgIHJldHVybiBIYW5kbGVySW5mbzsKICB9KCk7CgogIGZ1bmN0aW9uIHBhcmFtc01hdGNoKGEsIGIpIHsKICAgIGlmICghYSBeICFiKSB7CiAgICAgIC8vIE9ubHkgb25lIGlzIG51bGwuCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoIWEpIHsKICAgICAgLy8gQm90aCBtdXN0IGJlIG51bGwuCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIE5vdGU6IHRoaXMgYXNzdW1lcyB0aGF0IGJvdGggcGFyYW1zIGhhdmUgdGhlIHNhbWUKICAgIC8vIG51bWJlciBvZiBrZXlzLCBidXQgc2luY2Ugd2UncmUgY29tcGFyaW5nIHRoZQogICAgLy8gc2FtZSBoYW5kbGVycywgdGhleSBzaG91bGQuCiAgICBmb3IgKHZhciBrIGluIGEpIHsKICAgICAgaWYgKGEuaGFzT3duUHJvcGVydHkoaykgJiYgYVtrXSAhPT0gYltrXSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgUmVzb2x2ZWRIYW5kbGVySW5mbyA9IGZ1bmN0aW9uIChfSGFuZGxlckluZm8pIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoUmVzb2x2ZWRIYW5kbGVySW5mbywgX0hhbmRsZXJJbmZvKTsKCiAgICBmdW5jdGlvbiBSZXNvbHZlZEhhbmRsZXJJbmZvKHByb3BzKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUmVzb2x2ZWRIYW5kbGVySW5mbyk7CgogICAgICB2YXIgX3RoaXMzID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9IYW5kbGVySW5mby5jYWxsKHRoaXMsIHByb3BzKSk7CgogICAgICBfdGhpczMuaXNSZXNvbHZlZCA9IHRydWU7CiAgICAgIHJldHVybiBfdGhpczM7CiAgICB9CgogICAgUmVzb2x2ZWRIYW5kbGVySW5mby5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hvdWxkQ29udGludWUsIHBheWxvYWQpIHsKICAgICAgLy8gQSBSZXNvbHZlZEhhbmRsZXJJbmZvIGp1c3QgcmVzb2x2ZWQgd2l0aCBpdHNlbGYuCiAgICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQucmVzb2x2ZWRNb2RlbHMpIHsKICAgICAgICBwYXlsb2FkLnJlc29sdmVkTW9kZWxzW3RoaXMubmFtZV0gPSB0aGlzLmNvbnRleHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0aGlzLCB0aGlzLnByb21pc2VMYWJlbCgnUmVzb2x2ZScpKTsKICAgIH07CgogICAgUmVzb2x2ZWRIYW5kbGVySW5mby5wcm90b3R5cGUuZ2V0VW5yZXNvbHZlZCA9IGZ1bmN0aW9uIGdldFVucmVzb2x2ZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmZhY3RvcnkoJ3BhcmFtJywgewogICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIsCiAgICAgICAgcGFyYW1zOiB0aGlzLnBhcmFtcwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIFJlc29sdmVkSGFuZGxlckluZm87CiAgfShIYW5kbGVySW5mbyk7CgogIHZhciBVbnJlc29sdmVkSGFuZGxlckluZm9CeU9iamVjdCA9IGZ1bmN0aW9uIChfSGFuZGxlckluZm8yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5T2JqZWN0LCBfSGFuZGxlckluZm8yKTsKCiAgICBmdW5jdGlvbiBVbnJlc29sdmVkSGFuZGxlckluZm9CeU9iamVjdChwcm9wcykgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5T2JqZWN0KTsKCiAgICAgIHZhciBfdGhpczQgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0hhbmRsZXJJbmZvMi5jYWxsKHRoaXMsIHByb3BzKSk7CgogICAgICBfdGhpczQubmFtZXMgPSBfdGhpczQubmFtZXMgfHwgW107CiAgICAgIHJldHVybiBfdGhpczQ7CiAgICB9CgogICAgVW5yZXNvbHZlZEhhbmRsZXJJbmZvQnlPYmplY3QucHJvdG90eXBlLmdldE1vZGVsID0gZnVuY3Rpb24gZ2V0TW9kZWwocGF5bG9hZCkgewogICAgICB0aGlzLmxvZyhwYXlsb2FkLCB0aGlzLm5hbWUgKyAnOiByZXNvbHZpbmcgcHJvdmlkZWQgbW9kZWwnKTsKICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVzb2x2ZSh0aGlzLmNvbnRleHQpOwogICAgfTsKCiAgICBVbnJlc29sdmVkSGFuZGxlckluZm9CeU9iamVjdC5wcm90b3R5cGUuc2VyaWFsaXplID0gZnVuY3Rpb24gc2VyaWFsaXplKF9tb2RlbCkgewogICAgICB2YXIgbW9kZWwgPSBfbW9kZWwgfHwgdGhpcy5jb250ZXh0LAogICAgICAgICAgbmFtZXMgPSB0aGlzLm5hbWVzOwoKICAgICAgdmFyIG9iamVjdCA9IHt9OwogICAgICBpZiAoaXNQYXJhbShtb2RlbCkpIHsKICAgICAgICBvYmplY3RbbmFtZXNbMF1dID0gbW9kZWw7CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfQoKICAgICAgLy8gVXNlIGN1c3RvbSBzZXJpYWxpemUgaWYgaXQgZXhpc3RzLgogICAgICBpZiAodGhpcy5zZXJpYWxpemVyKSB7CiAgICAgICAgLy8gaW52b2tlIHRoaXMuc2VyaWFsaXplciB1bmJvdW5kIChnZXRTZXJpYWxpemVyIHJldHVybnMgYSBzdGF0ZWxlc3MgZnVuY3Rpb24pCiAgICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplci5jYWxsKG51bGwsIG1vZGVsLCBuYW1lcyk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5oYW5kbGVyICYmIHRoaXMuaGFuZGxlci5zZXJpYWxpemUpIHsKICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVyLnNlcmlhbGl6ZShtb2RlbCwgbmFtZXMpOwogICAgICB9CgogICAgICBpZiAobmFtZXMubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbmFtZSA9IG5hbWVzWzBdOwoKICAgICAgaWYgKC9faWQkLy50ZXN0KG5hbWUpKSB7CiAgICAgICAgb2JqZWN0W25hbWVdID0gbW9kZWwuaWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqZWN0W25hbWVdID0gbW9kZWw7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH07CgogICAgcmV0dXJuIFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5T2JqZWN0OwogIH0oSGFuZGxlckluZm8pOwoKICB2YXIgVW5yZXNvbHZlZEhhbmRsZXJJbmZvQnlQYXJhbSA9IGZ1bmN0aW9uIChfSGFuZGxlckluZm8zKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5UGFyYW0sIF9IYW5kbGVySW5mbzMpOwoKICAgIGZ1bmN0aW9uIFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5UGFyYW0ocHJvcHMpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBVbnJlc29sdmVkSGFuZGxlckluZm9CeVBhcmFtKTsKCiAgICAgIHZhciBfdGhpczUgPSAoMCwgX2VtYmVyQmFiZWwucG9zc2libGVDb25zdHJ1Y3RvclJldHVybikodGhpcywgX0hhbmRsZXJJbmZvMy5jYWxsKHRoaXMsIHByb3BzKSk7CgogICAgICBfdGhpczUucGFyYW1zID0gX3RoaXM1LnBhcmFtcyB8fCB7fTsKICAgICAgcmV0dXJuIF90aGlzNTsKICAgIH0KCiAgICBVbnJlc29sdmVkSGFuZGxlckluZm9CeVBhcmFtLnByb3RvdHlwZS5nZXRNb2RlbCA9IGZ1bmN0aW9uIGdldE1vZGVsKHBheWxvYWQpIHsKICAgICAgdmFyIGZ1bGxQYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5xdWVyeVBhcmFtcykgewogICAgICAgIGZ1bGxQYXJhbXMgPSB7fTsKICAgICAgICBtZXJnZShmdWxsUGFyYW1zLCB0aGlzLnBhcmFtcyk7CiAgICAgICAgZnVsbFBhcmFtcy5xdWVyeVBhcmFtcyA9IHBheWxvYWQucXVlcnlQYXJhbXM7CiAgICAgIH0KCiAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5oYW5kbGVyOwogICAgICB2YXIgaG9va05hbWUgPSByZXNvbHZlSG9vayhoYW5kbGVyLCAnZGVzZXJpYWxpemUnKSB8fCByZXNvbHZlSG9vayhoYW5kbGVyLCAnbW9kZWwnKTsKCiAgICAgIHJldHVybiB0aGlzLnJ1blNoYXJlZE1vZGVsSG9vayhwYXlsb2FkLCBob29rTmFtZSwgW2Z1bGxQYXJhbXNdKTsKICAgIH07CgogICAgcmV0dXJuIFVucmVzb2x2ZWRIYW5kbGVySW5mb0J5UGFyYW07CiAgfShIYW5kbGVySW5mbyk7CgogIGhhbmRsZXJJbmZvRmFjdG9yeS5rbGFzc2VzID0gewogICAgcmVzb2x2ZWQ6IFJlc29sdmVkSGFuZGxlckluZm8sCiAgICBwYXJhbTogVW5yZXNvbHZlZEhhbmRsZXJJbmZvQnlQYXJhbSwKICAgIG9iamVjdDogVW5yZXNvbHZlZEhhbmRsZXJJbmZvQnlPYmplY3QKICB9OwoKICBmdW5jdGlvbiBoYW5kbGVySW5mb0ZhY3RvcnkobmFtZSwgcHJvcHMpIHsKICAgIHZhciBrbGFzcyA9IGhhbmRsZXJJbmZvRmFjdG9yeS5rbGFzc2VzW25hbWVdOwogICAgdmFyIGhhbmRsZXJJbmZvID0gbmV3IGtsYXNzKHByb3BzIHx8IHt9KTsKICAgIGhhbmRsZXJJbmZvLmZhY3RvcnkgPSBoYW5kbGVySW5mb0ZhY3Rvcnk7CiAgICByZXR1cm4gaGFuZGxlckluZm87CiAgfQoKICB2YXIgTmFtZWRUcmFuc2l0aW9uSW50ZW50ID0gZnVuY3Rpb24gKF9UcmFuc2l0aW9uSW50ZW50KSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKE5hbWVkVHJhbnNpdGlvbkludGVudCwgX1RyYW5zaXRpb25JbnRlbnQpOwoKICAgIGZ1bmN0aW9uIE5hbWVkVHJhbnNpdGlvbkludGVudChwcm9wcykgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE5hbWVkVHJhbnNpdGlvbkludGVudCk7CgogICAgICB2YXIgX3RoaXM2ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9UcmFuc2l0aW9uSW50ZW50LmNhbGwodGhpcywgcHJvcHMpKTsKCiAgICAgIF90aGlzNi5uYW1lID0gcHJvcHMubmFtZTsKICAgICAgX3RoaXM2LnBpdm90SGFuZGxlciA9IHByb3BzLnBpdm90SGFuZGxlcjsKICAgICAgX3RoaXM2LmNvbnRleHRzID0gcHJvcHMuY29udGV4dHMgfHwgW107CiAgICAgIF90aGlzNi5xdWVyeVBhcmFtcyA9IHByb3BzLnF1ZXJ5UGFyYW1zOwogICAgICByZXR1cm4gX3RoaXM2OwogICAgfQoKICAgIE5hbWVkVHJhbnNpdGlvbkludGVudC5wcm90b3R5cGUuYXBwbHlUb1N0YXRlID0gZnVuY3Rpb24gYXBwbHlUb1N0YXRlKG9sZFN0YXRlLCByZWNvZ25pemVyLCBnZXRIYW5kbGVyLCBpc0ludGVybWVkaWF0ZSwgZ2V0U2VyaWFsaXplcikgewogICAgICB2YXIgcGFydGl0aW9uZWRBcmdzID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKFt0aGlzLm5hbWVdLmNvbmNhdCh0aGlzLmNvbnRleHRzKSksCiAgICAgICAgICBwdXJlQXJncyA9IHBhcnRpdGlvbmVkQXJnc1swXSwKICAgICAgICAgIGhhbmRsZXJzID0gcmVjb2duaXplci5oYW5kbGVyc0ZvcihwdXJlQXJnc1swXSk7CgogICAgICB2YXIgdGFyZ2V0Um91dGVOYW1lID0gaGFuZGxlcnNbaGFuZGxlcnMubGVuZ3RoIC0gMV0uaGFuZGxlcjsKCiAgICAgIHJldHVybiB0aGlzLmFwcGx5VG9IYW5kbGVycyhvbGRTdGF0ZSwgaGFuZGxlcnMsIGdldEhhbmRsZXIsIHRhcmdldFJvdXRlTmFtZSwgaXNJbnRlcm1lZGlhdGUsIG51bGwsIGdldFNlcmlhbGl6ZXIpOwogICAgfTsKCiAgICBOYW1lZFRyYW5zaXRpb25JbnRlbnQucHJvdG90eXBlLmFwcGx5VG9IYW5kbGVycyA9IGZ1bmN0aW9uIGFwcGx5VG9IYW5kbGVycyhvbGRTdGF0ZSwgaGFuZGxlcnMsIGdldEhhbmRsZXIsIHRhcmdldFJvdXRlTmFtZSwgaXNJbnRlcm1lZGlhdGUsIGNoZWNraW5nSWZBY3RpdmUsIGdldFNlcmlhbGl6ZXIpIHsKICAgICAgdmFyIGksIGxlbjsKICAgICAgdmFyIG5ld1N0YXRlID0gbmV3IFRyYW5zaXRpb25TdGF0ZSgpOwogICAgICB2YXIgb2JqZWN0cyA9IHRoaXMuY29udGV4dHMuc2xpY2UoMCk7CgogICAgICB2YXIgaW52YWxpZGF0ZUluZGV4ID0gaGFuZGxlcnMubGVuZ3RoOwoKICAgICAgLy8gUGl2b3QgaGFuZGxlcnMgYXJlIHByb3ZpZGVkIGZvciByZWZyZXNoIHRyYW5zaXRpb25zCiAgICAgIGlmICh0aGlzLnBpdm90SGFuZGxlcikgewogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGhhbmRsZXJzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICBpZiAoaGFuZGxlcnNbaV0uaGFuZGxlciA9PT0gdGhpcy5waXZvdEhhbmRsZXIuX2hhbmRsZXJOYW1lKSB7CiAgICAgICAgICAgIGludmFsaWRhdGVJbmRleCA9IGk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpID0gaGFuZGxlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gaGFuZGxlcnNbaV07CiAgICAgICAgdmFyIG5hbWUgPSByZXN1bHQuaGFuZGxlcjsKCiAgICAgICAgdmFyIG9sZEhhbmRsZXJJbmZvID0gb2xkU3RhdGUuaGFuZGxlckluZm9zW2ldOwogICAgICAgIHZhciBuZXdIYW5kbGVySW5mbyA9IG51bGw7CgogICAgICAgIGlmIChyZXN1bHQubmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgaWYgKGkgPj0gaW52YWxpZGF0ZUluZGV4KSB7CiAgICAgICAgICAgIG5ld0hhbmRsZXJJbmZvID0gdGhpcy5jcmVhdGVQYXJhbUhhbmRsZXJJbmZvKG5hbWUsIGdldEhhbmRsZXIsIHJlc3VsdC5uYW1lcywgb2JqZWN0cywgb2xkSGFuZGxlckluZm8pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBnZXRTZXJpYWxpemVyKG5hbWUpOwogICAgICAgICAgICBuZXdIYW5kbGVySW5mbyA9IHRoaXMuZ2V0SGFuZGxlckluZm9Gb3JEeW5hbWljU2VnbWVudChuYW1lLCBnZXRIYW5kbGVyLCByZXN1bHQubmFtZXMsIG9iamVjdHMsIG9sZEhhbmRsZXJJbmZvLCB0YXJnZXRSb3V0ZU5hbWUsIGksIHNlcmlhbGl6ZXIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUaGlzIHJvdXRlIGhhcyBubyBkeW5hbWljIHNlZ21lbnQuCiAgICAgICAgICAvLyBUaGVyZWZvcmUgdHJlYXQgYXMgYSBwYXJhbS1iYXNlZCBoYW5kbGVySW5mbwogICAgICAgICAgLy8gd2l0aCBlbXB0eSBwYXJhbXMuIFRoaXMgd2lsbCBjYXVzZSB0aGUgYG1vZGVsYAogICAgICAgICAgLy8gaG9vayB0byBiZSBjYWxsZWQgd2l0aCBlbXB0eSBwYXJhbXMsIHdoaWNoIGlzIGRlc2lyYWJsZS4KICAgICAgICAgIG5ld0hhbmRsZXJJbmZvID0gdGhpcy5jcmVhdGVQYXJhbUhhbmRsZXJJbmZvKG5hbWUsIGdldEhhbmRsZXIsIHJlc3VsdC5uYW1lcywgb2JqZWN0cywgb2xkSGFuZGxlckluZm8pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNoZWNraW5nSWZBY3RpdmUpIHsKICAgICAgICAgIC8vIElmIHdlJ3JlIHBlcmZvcm1pbmcgYW4gaXNBY3RpdmUgY2hlY2ssIHdlIHdhbnQgdG8KICAgICAgICAgIC8vIHNlcmlhbGl6ZSBVUkwgcGFyYW1zIHdpdGggdGhlIHByb3ZpZGVkIGNvbnRleHQsIGJ1dAogICAgICAgICAgLy8gaWdub3JlIG1pc21hdGNoZXMgYmV0d2VlbiBvbGQgYW5kIG5ldyBjb250ZXh0LgogICAgICAgICAgbmV3SGFuZGxlckluZm8gPSBuZXdIYW5kbGVySW5mby5iZWNvbWVSZXNvbHZlZChudWxsLCBuZXdIYW5kbGVySW5mby5jb250ZXh0KTsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gb2xkSGFuZGxlckluZm8gJiYgb2xkSGFuZGxlckluZm8uY29udGV4dDsKICAgICAgICAgIGlmIChyZXN1bHQubmFtZXMubGVuZ3RoID4gMCAmJiAnY29udGV4dCcgaW4gb2xkSGFuZGxlckluZm8gJiYgbmV3SGFuZGxlckluZm8uY29udGV4dCA9PT0gb2xkQ29udGV4dCkgewogICAgICAgICAgICAvLyBJZiBjb250ZXh0cyBtYXRjaCBpbiBpc0FjdGl2ZSB0ZXN0LCBhc3N1bWUgcGFyYW1zIGFsc28gbWF0Y2guCiAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIGZvciBmbGV4aWJpbGl0eSBpbiBub3QgcmVxdWlyaW5nIHRoYXQgZXZlcnkgbGFzdAogICAgICAgICAgICAvLyBoYW5kbGVyIHByb3ZpZGUgYSBgc2VyaWFsaXplYCBtZXRob2QKICAgICAgICAgICAgbmV3SGFuZGxlckluZm8ucGFyYW1zID0gb2xkSGFuZGxlckluZm8gJiYgb2xkSGFuZGxlckluZm8ucGFyYW1zOwogICAgICAgICAgfQogICAgICAgICAgbmV3SGFuZGxlckluZm8uY29udGV4dCA9IG9sZENvbnRleHQ7CiAgICAgICAgfQoKICAgICAgICB2YXIgaGFuZGxlclRvVXNlID0gb2xkSGFuZGxlckluZm87CiAgICAgICAgaWYgKGkgPj0gaW52YWxpZGF0ZUluZGV4IHx8IG5ld0hhbmRsZXJJbmZvLnNob3VsZFN1cGVyY2VkZShvbGRIYW5kbGVySW5mbykpIHsKICAgICAgICAgIGludmFsaWRhdGVJbmRleCA9IE1hdGgubWluKGksIGludmFsaWRhdGVJbmRleCk7CiAgICAgICAgICBoYW5kbGVyVG9Vc2UgPSBuZXdIYW5kbGVySW5mbzsKICAgICAgICB9CgogICAgICAgIGlmIChpc0ludGVybWVkaWF0ZSAmJiAhY2hlY2tpbmdJZkFjdGl2ZSkgewogICAgICAgICAgaGFuZGxlclRvVXNlID0gaGFuZGxlclRvVXNlLmJlY29tZVJlc29sdmVkKG51bGwsIGhhbmRsZXJUb1VzZS5jb250ZXh0KTsKICAgICAgICB9CgogICAgICAgIG5ld1N0YXRlLmhhbmRsZXJJbmZvcy51bnNoaWZ0KGhhbmRsZXJUb1VzZSk7CiAgICAgIH0KCiAgICAgIGlmIChvYmplY3RzLmxlbmd0aCA+IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vcmUgY29udGV4dCBvYmplY3RzIHdlcmUgcGFzc2VkIHRoYW4gdGhlcmUgYXJlIGR5bmFtaWMgc2VnbWVudHMgZm9yIHRoZSByb3V0ZTogJyArIHRhcmdldFJvdXRlTmFtZSk7CiAgICAgIH0KCiAgICAgIGlmICghaXNJbnRlcm1lZGlhdGUpIHsKICAgICAgICB0aGlzLmludmFsaWRhdGVDaGlsZHJlbihuZXdTdGF0ZS5oYW5kbGVySW5mb3MsIGludmFsaWRhdGVJbmRleCk7CiAgICAgIH0KCiAgICAgIG1lcmdlKG5ld1N0YXRlLnF1ZXJ5UGFyYW1zLCB0aGlzLnF1ZXJ5UGFyYW1zIHx8IHt9KTsKCiAgICAgIHJldHVybiBuZXdTdGF0ZTsKICAgIH07CgogICAgTmFtZWRUcmFuc2l0aW9uSW50ZW50LnByb3RvdHlwZS5pbnZhbGlkYXRlQ2hpbGRyZW4gPSBmdW5jdGlvbiBpbnZhbGlkYXRlQ2hpbGRyZW4oaGFuZGxlckluZm9zLCBpbnZhbGlkYXRlSW5kZXgpIHsKICAgICAgZm9yICh2YXIgaSA9IGludmFsaWRhdGVJbmRleCwgbCA9IGhhbmRsZXJJbmZvcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBoYW5kbGVySW5mb3NbaV07CiAgICAgICAgaGFuZGxlckluZm9zW2ldID0gaGFuZGxlckluZm8uZ2V0VW5yZXNvbHZlZCgpOwogICAgICB9CiAgICB9OwoKICAgIE5hbWVkVHJhbnNpdGlvbkludGVudC5wcm90b3R5cGUuZ2V0SGFuZGxlckluZm9Gb3JEeW5hbWljU2VnbWVudCA9IGZ1bmN0aW9uIGdldEhhbmRsZXJJbmZvRm9yRHluYW1pY1NlZ21lbnQobmFtZSwgZ2V0SGFuZGxlciwgbmFtZXMsIG9iamVjdHMsIG9sZEhhbmRsZXJJbmZvLCB0YXJnZXRSb3V0ZU5hbWUsIGksIHNlcmlhbGl6ZXIpIHsKICAgICAgdmFyIG9iamVjdFRvVXNlOwogICAgICBpZiAob2JqZWN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gVXNlIHRoZSBvYmplY3RzIHByb3ZpZGVkIGZvciB0aGlzIHRyYW5zaXRpb24uCiAgICAgICAgb2JqZWN0VG9Vc2UgPSBvYmplY3RzW29iamVjdHMubGVuZ3RoIC0gMV07CiAgICAgICAgaWYgKGlzUGFyYW0ob2JqZWN0VG9Vc2UpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVQYXJhbUhhbmRsZXJJbmZvKG5hbWUsIGdldEhhbmRsZXIsIG5hbWVzLCBvYmplY3RzLCBvbGRIYW5kbGVySW5mbyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9iamVjdHMucG9wKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG9sZEhhbmRsZXJJbmZvICYmIG9sZEhhbmRsZXJJbmZvLm5hbWUgPT09IG5hbWUpIHsKICAgICAgICAvLyBSZXVzZSB0aGUgbWF0Y2hpbmcgb2xkSGFuZGxlckluZm8KICAgICAgICByZXR1cm4gb2xkSGFuZGxlckluZm87CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMucHJlVHJhbnNpdGlvblN0YXRlKSB7CiAgICAgICAgICB2YXIgcHJlVHJhbnNpdGlvbkhhbmRsZXJJbmZvID0gdGhpcy5wcmVUcmFuc2l0aW9uU3RhdGUuaGFuZGxlckluZm9zW2ldOwogICAgICAgICAgb2JqZWN0VG9Vc2UgPSBwcmVUcmFuc2l0aW9uSGFuZGxlckluZm8gJiYgcHJlVHJhbnNpdGlvbkhhbmRsZXJJbmZvLmNvbnRleHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElkZWFsbHkgd2Ugc2hvdWxkIHRocm93IHRoaXMgZXJyb3IgdG8gcHJvdmlkZSBtYXhpbWFsCiAgICAgICAgICAvLyBpbmZvcm1hdGlvbiB0byB0aGUgdXNlciB0aGF0IG5vdCBlbm91Z2ggY29udGV4dCBvYmplY3RzCiAgICAgICAgICAvLyB3ZXJlIHByb3ZpZGVkLCBidXQgdGhpcyBwcm92ZXMgdG9vIGN1bWJlcnNvbWUgaW4gRW1iZXIKICAgICAgICAgIC8vIGluIGNhc2VzIHdoZXJlIGlubmVyIHRlbXBsYXRlIGhlbHBlcnMgYXJlIGV2YWx1YXRlZAogICAgICAgICAgLy8gYmVmb3JlIHBhcmVudCBoZWxwZXJzIHVuLXJlbmRlciwgaW4gd2hpY2ggY2FzZXMgdGhpcwogICAgICAgICAgLy8gZXJyb3Igc29tZXdoYXQgcHJlbWF0dXJlbHkgZmlyZXMuCiAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcigiTm90IGVub3VnaCBjb250ZXh0IG9iamVjdHMgd2VyZSBwcm92aWRlZCB0byBjb21wbGV0ZSBhIHRyYW5zaXRpb24gdG8gIiArIHRhcmdldFJvdXRlTmFtZSArICIuIFNwZWNpZmljYWxseSwgdGhlICIgKyBuYW1lICsgIiByb3V0ZSBuZWVkcyBhbiBvYmplY3QgdGhhdCBjYW4gYmUgc2VyaWFsaXplZCBpbnRvIGl0cyBkeW5hbWljIFVSTCBzZWdtZW50cyBbIiArIG5hbWVzLmpvaW4oJywgJykgKyAiXSIpOwogICAgICAgICAgcmV0dXJuIG9sZEhhbmRsZXJJbmZvOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGhhbmRsZXJJbmZvRmFjdG9yeSgnb2JqZWN0JywgewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgZ2V0SGFuZGxlcjogZ2V0SGFuZGxlciwKICAgICAgICBzZXJpYWxpemVyOiBzZXJpYWxpemVyLAogICAgICAgIGNvbnRleHQ6IG9iamVjdFRvVXNlLAogICAgICAgIG5hbWVzOiBuYW1lcwogICAgICB9KTsKICAgIH07CgogICAgTmFtZWRUcmFuc2l0aW9uSW50ZW50LnByb3RvdHlwZS5jcmVhdGVQYXJhbUhhbmRsZXJJbmZvID0gZnVuY3Rpb24gY3JlYXRlUGFyYW1IYW5kbGVySW5mbyhuYW1lLCBnZXRIYW5kbGVyLCBuYW1lcywgb2JqZWN0cywgb2xkSGFuZGxlckluZm8pIHsKICAgICAgdmFyIHBhcmFtcyA9IHt9OwoKICAgICAgLy8gU29hayB1cCBhbGwgdGhlIHByb3ZpZGVkIHN0cmluZy9udW1iZXJzCiAgICAgIHZhciBudW1OYW1lcyA9IG5hbWVzLmxlbmd0aDsKICAgICAgd2hpbGUgKG51bU5hbWVzLS0pIHsKICAgICAgICAvLyBPbmx5IHVzZSBvbGQgcGFyYW1zIGlmIHRoZSBuYW1lcyBtYXRjaCB3aXRoIHRoZSBuZXcgaGFuZGxlcgogICAgICAgIHZhciBvbGRQYXJhbXMgPSBvbGRIYW5kbGVySW5mbyAmJiBuYW1lID09PSBvbGRIYW5kbGVySW5mby5uYW1lICYmIG9sZEhhbmRsZXJJbmZvLnBhcmFtcyB8fCB7fTsKCiAgICAgICAgdmFyIHBlZWsgPSBvYmplY3RzW29iamVjdHMubGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIHBhcmFtTmFtZSA9IG5hbWVzW251bU5hbWVzXTsKICAgICAgICBpZiAoaXNQYXJhbShwZWVrKSkgewogICAgICAgICAgcGFyYW1zW3BhcmFtTmFtZV0gPSAnJyArIG9iamVjdHMucG9wKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElmIHdlJ3JlIGhlcmUsIHRoaXMgbWVhbnMgb25seSBzb21lIG9mIHRoZSBwYXJhbXMKICAgICAgICAgIC8vIHdlcmUgc3RyaW5nL251bWJlciBwYXJhbXMsIHNvIHRyeSBhbmQgdXNlIGEgcGFyYW0KICAgICAgICAgIC8vIHZhbHVlIGZyb20gYSBwcmV2aW91cyBoYW5kbGVyLgogICAgICAgICAgaWYgKG9sZFBhcmFtcy5oYXNPd25Qcm9wZXJ0eShwYXJhbU5hbWUpKSB7CiAgICAgICAgICAgIHBhcmFtc1twYXJhbU5hbWVdID0gb2xkUGFyYW1zW3BhcmFtTmFtZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBkaWRuJ3QgcHJvdmlkZSBlbm91Z2ggc3RyaW5nL251bWVyaWMgcGFyYW1ldGVycyB0byBzYXRpc2Z5IGFsbCBvZiB0aGUgZHluYW1pYyBzZWdtZW50cyBmb3Igcm91dGUgIiArIG5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGhhbmRsZXJJbmZvRmFjdG9yeSgncGFyYW0nLCB7CiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBnZXRIYW5kbGVyOiBnZXRIYW5kbGVyLAogICAgICAgIHBhcmFtczogcGFyYW1zCiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gTmFtZWRUcmFuc2l0aW9uSW50ZW50OwogIH0oVHJhbnNpdGlvbkludGVudCk7CgogIGZ1bmN0aW9uIFVucmVjb2duaXplZFVSTEVycm9yKG1lc3NhZ2UpIHsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBVbnJlY29nbml6ZWRVUkxFcnJvcikpIHsKICAgICAgcmV0dXJuIG5ldyBVbnJlY29nbml6ZWRVUkxFcnJvcihtZXNzYWdlKTsKICAgIH0KCiAgICB2YXIgZXJyb3IgPSBFcnJvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwoKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBVbnJlY29nbml6ZWRVUkxFcnJvcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnN0YWNrID0gZXJyb3Iuc3RhY2s7CiAgICB9CgogICAgdGhpcy5kZXNjcmlwdGlvbiA9IGVycm9yLmRlc2NyaXB0aW9uOwogICAgdGhpcy5maWxlTmFtZSA9IGVycm9yLmZpbGVOYW1lOwogICAgdGhpcy5saW5lTnVtYmVyID0gZXJyb3IubGluZU51bWJlcjsKICAgIHRoaXMubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2UgfHwgJ1VucmVjb2duaXplZFVSTCc7CiAgICB0aGlzLm5hbWUgPSAnVW5yZWNvZ25pemVkVVJMRXJyb3InOwogICAgdGhpcy5udW1iZXIgPSBlcnJvci5udW1iZXI7CiAgICB0aGlzLmNvZGUgPSBlcnJvci5jb2RlOwogIH0KCiAgVW5yZWNvZ25pemVkVVJMRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpOwoKICB2YXIgVVJMVHJhbnNpdGlvbkludGVudCA9IGZ1bmN0aW9uIChfVHJhbnNpdGlvbkludGVudDIpIHsKICAgICgwLCBfZW1iZXJCYWJlbC5pbmhlcml0cykoVVJMVHJhbnNpdGlvbkludGVudCwgX1RyYW5zaXRpb25JbnRlbnQyKTsKCiAgICBmdW5jdGlvbiBVUkxUcmFuc2l0aW9uSW50ZW50KHByb3BzKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgVVJMVHJhbnNpdGlvbkludGVudCk7CgogICAgICB2YXIgX3RoaXM3ID0gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9UcmFuc2l0aW9uSW50ZW50Mi5jYWxsKHRoaXMsIHByb3BzKSk7CgogICAgICBfdGhpczcudXJsID0gcHJvcHMudXJsOwogICAgICByZXR1cm4gX3RoaXM3OwogICAgfQoKICAgIFVSTFRyYW5zaXRpb25JbnRlbnQucHJvdG90eXBlLmFwcGx5VG9TdGF0ZSA9IGZ1bmN0aW9uIGFwcGx5VG9TdGF0ZShvbGRTdGF0ZSwgcmVjb2duaXplciwgZ2V0SGFuZGxlcikgewogICAgICB2YXIgbmV3U3RhdGUgPSBuZXcgVHJhbnNpdGlvblN0YXRlKCk7CgogICAgICB2YXIgcmVzdWx0cyA9IHJlY29nbml6ZXIucmVjb2duaXplKHRoaXMudXJsKSwKICAgICAgICAgIGksCiAgICAgICAgICBsZW47CgogICAgICBpZiAoIXJlc3VsdHMpIHsKICAgICAgICB0aHJvdyBuZXcgVW5yZWNvZ25pemVkVVJMRXJyb3IodGhpcy51cmwpOwogICAgICB9CgogICAgICB2YXIgc3RhdGVzRGlmZmVyID0gZmFsc2U7CiAgICAgIHZhciB1cmwgPSB0aGlzLnVybDsKCiAgICAgIC8vIENoZWNrcyBpZiBhIGhhbmRsZXIgaXMgYWNjZXNzaWJsZSBieSBVUkwuIElmIGl0IGlzIG5vdCwgYW4gZXJyb3IgaXMgdGhyb3duLgogICAgICAvLyBGb3IgdGhlIGNhc2Ugd2hlcmUgdGhlIGhhbmRsZXIgaXMgbG9hZGVkIGFzeW5jaHJvbm91c2x5LCB0aGUgZXJyb3Igd2lsbCBiZQogICAgICAvLyB0aHJvd24gb25jZSBpdCBpcyBsb2FkZWQuCiAgICAgIGZ1bmN0aW9uIGNoZWNrSGFuZGxlckFjY2Vzc2liaWxpdHkoaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyICYmIGhhbmRsZXIuaW5hY2Nlc3NpYmxlQnlVUkwpIHsKICAgICAgICAgIHRocm93IG5ldyBVbnJlY29nbml6ZWRVUkxFcnJvcih1cmwpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGhhbmRsZXI7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IHJlc3VsdHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gcmVzdWx0c1tpXTsKICAgICAgICB2YXIgbmFtZSA9IHJlc3VsdC5oYW5kbGVyOwogICAgICAgIHZhciBuZXdIYW5kbGVySW5mbyA9IGhhbmRsZXJJbmZvRmFjdG9yeSgncGFyYW0nLCB7CiAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgZ2V0SGFuZGxlcjogZ2V0SGFuZGxlciwKICAgICAgICAgIHBhcmFtczogcmVzdWx0LnBhcmFtcwogICAgICAgIH0pOwogICAgICAgIHZhciBoYW5kbGVyID0gbmV3SGFuZGxlckluZm8uaGFuZGxlcjsKCiAgICAgICAgaWYgKGhhbmRsZXIpIHsKICAgICAgICAgIGNoZWNrSGFuZGxlckFjY2Vzc2liaWxpdHkoaGFuZGxlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElmIHRoZSBoYW5sZGVyIGlzIGJlaW5nIGxvYWRlZCBhc3luY2hyb25vdXNseSwgY2hlY2sgaWYgd2UgY2FuCiAgICAgICAgICAvLyBhY2Nlc3MgaXQgYWZ0ZXIgaXQgaGFzIHJlc29sdmVkCiAgICAgICAgICBuZXdIYW5kbGVySW5mby5oYW5kbGVyUHJvbWlzZSA9IG5ld0hhbmRsZXJJbmZvLmhhbmRsZXJQcm9taXNlLnRoZW4oY2hlY2tIYW5kbGVyQWNjZXNzaWJpbGl0eSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgb2xkSGFuZGxlckluZm8gPSBvbGRTdGF0ZS5oYW5kbGVySW5mb3NbaV07CiAgICAgICAgaWYgKHN0YXRlc0RpZmZlciB8fCBuZXdIYW5kbGVySW5mby5zaG91bGRTdXBlcmNlZGUob2xkSGFuZGxlckluZm8pKSB7CiAgICAgICAgICBzdGF0ZXNEaWZmZXIgPSB0cnVlOwogICAgICAgICAgbmV3U3RhdGUuaGFuZGxlckluZm9zW2ldID0gbmV3SGFuZGxlckluZm87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld1N0YXRlLmhhbmRsZXJJbmZvc1tpXSA9IG9sZEhhbmRsZXJJbmZvOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbWVyZ2UobmV3U3RhdGUucXVlcnlQYXJhbXMsIHJlc3VsdHMucXVlcnlQYXJhbXMpOwoKICAgICAgcmV0dXJuIG5ld1N0YXRlOwogICAgfTsKCiAgICByZXR1cm4gVVJMVHJhbnNpdGlvbkludGVudDsKICB9KFRyYW5zaXRpb25JbnRlbnQpOwoKICB2YXIgcG9wID0gQXJyYXkucHJvdG90eXBlLnBvcDsKCiAgdmFyIFJvdXRlciA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFJvdXRlcigpIHsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHt9OwogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIFJvdXRlcik7CgogICAgICB0aGlzLmdldEhhbmRsZXIgPSBvcHRpb25zLmdldEhhbmRsZXIgfHwgdGhpcy5nZXRIYW5kbGVyOwogICAgICB0aGlzLmdldFNlcmlhbGl6ZXIgPSBvcHRpb25zLmdldFNlcmlhbGl6ZXIgfHwgdGhpcy5nZXRTZXJpYWxpemVyOwogICAgICB0aGlzLnVwZGF0ZVVSTCA9IG9wdGlvbnMudXBkYXRlVVJMIHx8IHRoaXMudXBkYXRlVVJMOwogICAgICB0aGlzLnJlcGxhY2VVUkwgPSBvcHRpb25zLnJlcGxhY2VVUkwgfHwgdGhpcy5yZXBsYWNlVVJMOwogICAgICB0aGlzLmRpZFRyYW5zaXRpb24gPSBvcHRpb25zLmRpZFRyYW5zaXRpb24gfHwgdGhpcy5kaWRUcmFuc2l0aW9uOwogICAgICB0aGlzLndpbGxUcmFuc2l0aW9uID0gb3B0aW9ucy53aWxsVHJhbnNpdGlvbiB8fCB0aGlzLndpbGxUcmFuc2l0aW9uOwogICAgICB0aGlzLmRlbGVnYXRlID0gb3B0aW9ucy5kZWxlZ2F0ZSB8fCB0aGlzLmRlbGVnYXRlOwogICAgICB0aGlzLnRyaWdnZXJFdmVudCA9IG9wdGlvbnMudHJpZ2dlckV2ZW50IHx8IHRoaXMudHJpZ2dlckV2ZW50OwogICAgICB0aGlzLmxvZyA9IG9wdGlvbnMubG9nIHx8IHRoaXMubG9nOwogICAgICB0aGlzLmRzbENhbGxCYWNrcyA9IFtdOyAvLyBOT1RFOiBzZXQgYnkgRW1iZXIKCiAgICAgIHRoaXMuc3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuYWN0aXZlVHJhbnNpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fY2hhbmdlZFF1ZXJ5UGFyYW1zID0gdW5kZWZpbmVkOwogICAgICB0aGlzLm9sZFN0YXRlID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmN1cnJlbnRIYW5kbGVySW5mb3MgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuY3VycmVudFNlcXVlbmNlID0gMDsKCiAgICAgIHRoaXMucmVjb2duaXplciA9IG5ldyBfcm91dGVSZWNvZ25pemVyLmRlZmF1bHQoKTsKICAgICAgdGhpcy5yZXNldCgpOwogICAgfQoKICAgIC8qKgogICAgICBUaGUgbWFpbiBlbnRyeSBwb2ludCBpbnRvIHRoZSByb3V0ZXIuIFRoZSBBUEkgaXMgZXNzZW50aWFsbHkKICAgICAgdGhlIHNhbWUgYXMgdGhlIGBtYXBgIG1ldGhvZCBpbiBgcm91dGUtcmVjb2duaXplcmAuCiAgICAgICBUaGlzIG1ldGhvZCBleHRyYWN0cyB0aGUgU3RyaW5nIGhhbmRsZXIgYXQgdGhlIGxhc3QgYC50bygpYAogICAgICBjYWxsIGFuZCB1c2VzIGl0IGFzIHRoZSBuYW1lIG9mIHRoZSB3aG9sZSByb3V0ZS4KICAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrCiAgICAqLwoKCiAgICBSb3V0ZXIucHJvdG90eXBlLm1hcCA9IGZ1bmN0aW9uIG1hcChjYWxsYmFjaykgewogICAgICB0aGlzLnJlY29nbml6ZXIuZGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwoKICAgICAgdGhpcy5yZWNvZ25pemVyLm1hcChjYWxsYmFjaywgZnVuY3Rpb24gKHJlY29nbml6ZXIsIHJvdXRlcykgewogICAgICAgIGZvciAodmFyIGkgPSByb3V0ZXMubGVuZ3RoIC0gMSwgcHJvY2VlZCA9IHRydWU7IGkgPj0gMCAmJiBwcm9jZWVkOyAtLWkpIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1tpXTsKICAgICAgICAgIHJlY29nbml6ZXIuYWRkKHJvdXRlcywgeyBhczogcm91dGUuaGFuZGxlciB9KTsKICAgICAgICAgIHByb2NlZWQgPSByb3V0ZS5wYXRoID09PSAnLycgfHwgcm91dGUucGF0aCA9PT0gJycgfHwgcm91dGUuaGFuZGxlci5zbGljZSgtNikgPT09ICcuaW5kZXgnOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUuaGFzUm91dGUgPSBmdW5jdGlvbiBoYXNSb3V0ZShyb3V0ZSkgewogICAgICByZXR1cm4gdGhpcy5yZWNvZ25pemVyLmhhc1JvdXRlKHJvdXRlKTsKICAgIH07CgogICAgUm91dGVyLnByb3RvdHlwZS5nZXRIYW5kbGVyID0gZnVuY3Rpb24gZ2V0SGFuZGxlcigpIHt9OwoKICAgIFJvdXRlci5wcm90b3R5cGUuZ2V0U2VyaWFsaXplciA9IGZ1bmN0aW9uIGdldFNlcmlhbGl6ZXIoKSB7fTsKCiAgICBSb3V0ZXIucHJvdG90eXBlLnF1ZXJ5UGFyYW1zVHJhbnNpdGlvbiA9IGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zVHJhbnNpdGlvbihjaGFuZ2VsaXN0LCB3YXNUcmFuc2l0aW9uaW5nLCBvbGRTdGF0ZSwgbmV3U3RhdGUpIHsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CgogICAgICBmaXJlUXVlcnlQYXJhbURpZENoYW5nZSh0aGlzLCBuZXdTdGF0ZSwgY2hhbmdlbGlzdCk7CgogICAgICBpZiAoIXdhc1RyYW5zaXRpb25pbmcgJiYgdGhpcy5hY3RpdmVUcmFuc2l0aW9uKSB7CiAgICAgICAgLy8gT25lIG9mIHRoZSBoYW5kbGVycyBpbiBxdWVyeVBhcmFtc0RpZENoYW5nZQogICAgICAgIC8vIGNhdXNlZCBhIHRyYW5zaXRpb24uIEp1c3QgcmV0dXJuIHRoYXQgdHJhbnNpdGlvbi4KICAgICAgICByZXR1cm4gdGhpcy5hY3RpdmVUcmFuc2l0aW9uOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFJ1bm5pbmcgcXVlcnlQYXJhbXNEaWRDaGFuZ2UgZGlkbid0IGNoYW5nZSBhbnl0aGluZy4KICAgICAgICAvLyBKdXN0IHVwZGF0ZSBxdWVyeSBwYXJhbXMgYW5kIGJlIG9uIG91ciB3YXkuCgogICAgICAgIC8vIFdlIGhhdmUgdG8gcmV0dXJuIGEgbm9vcCB0cmFuc2l0aW9uIHRoYXQgd2lsbAogICAgICAgIC8vIHBlcmZvcm0gYSBVUkwgdXBkYXRlIGF0IHRoZSBlbmQuIFRoaXMgZ2l2ZXMKICAgICAgICAvLyB0aGUgdXNlciB0aGUgYWJpbGl0eSB0byBzZXQgdGhlIHVybCB1cGRhdGUKICAgICAgICAvLyBtZXRob2QgKGRlZmF1bHQgaXMgcmVwbGFjZVN0YXRlKS4KICAgICAgICB2YXIgbmV3VHJhbnNpdGlvbiA9IG5ldyBUcmFuc2l0aW9uKHRoaXMpOwogICAgICAgIG5ld1RyYW5zaXRpb24ucXVlcnlQYXJhbXNPbmx5ID0gdHJ1ZTsKCiAgICAgICAgb2xkU3RhdGUucXVlcnlQYXJhbXMgPSBmaW5hbGl6ZVF1ZXJ5UGFyYW1DaGFuZ2UodGhpcywgbmV3U3RhdGUuaGFuZGxlckluZm9zLCBuZXdTdGF0ZS5xdWVyeVBhcmFtcywgbmV3VHJhbnNpdGlvbik7CgogICAgICAgIG5ld1RyYW5zaXRpb24ucHJvbWlzZSA9IG5ld1RyYW5zaXRpb24ucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIHVwZGF0ZVVSTChuZXdUcmFuc2l0aW9uLCBvbGRTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICBpZiAocm91dGVyLmRpZFRyYW5zaXRpb24pIHsKICAgICAgICAgICAgcm91dGVyLmRpZFRyYW5zaXRpb24ocm91dGVyLmN1cnJlbnRIYW5kbGVySW5mb3MpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LCBudWxsLCBfcHJvbWlzZUxhYmVsKCdUcmFuc2l0aW9uIGNvbXBsZXRlJykpOwogICAgICAgIHJldHVybiBuZXdUcmFuc2l0aW9uOwogICAgICB9CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUudHJhbnNpdGlvbkJ5SW50ZW50ID0gZnVuY3Rpb24gdHJhbnNpdGlvbkJ5SW50ZW50KGludGVudCAvKiwgaXNJbnRlcm1lZGlhdGUqLykgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBnZXRUcmFuc2l0aW9uQnlJbnRlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBuZXcgVHJhbnNpdGlvbih0aGlzLCBpbnRlbnQsIG51bGwsIGUpOwogICAgICB9CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgaWYgKHRoaXMuc3RhdGUpIHsKICAgICAgICBmb3JFYWNoKHRoaXMuc3RhdGUuaGFuZGxlckluZm9zLnNsaWNlKCkucmV2ZXJzZSgpLCBmdW5jdGlvbiAoaGFuZGxlckluZm8pIHsKICAgICAgICAgIHZhciBoYW5kbGVyID0gaGFuZGxlckluZm8uaGFuZGxlcjsKICAgICAgICAgIGNhbGxIb29rKGhhbmRsZXIsICdleGl0Jyk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMub2xkU3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RhdGUgPSBuZXcgVHJhbnNpdGlvblN0YXRlKCk7CiAgICAgIHRoaXMuY3VycmVudEhhbmRsZXJJbmZvcyA9IG51bGw7CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUuaGFuZGxlVVJMID0gZnVuY3Rpb24gaGFuZGxlVVJMKCkgewogICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgIH0KCiAgICAgIC8vIFBlcmZvcm0gYSBVUkwtYmFzZWQgdHJhbnNpdGlvbiwgYnV0IGRvbid0IGNoYW5nZQogICAgICAvLyB0aGUgVVJMIGFmdGVyd2FyZCwgc2luY2UgaXQgYWxyZWFkeSBoYXBwZW5lZC4KICAgICAgdmFyIHVybCA9IGFyZ3NbMF07CiAgICAgIGlmICh1cmwuY2hhckF0KDApICE9PSAnLycpIHsKICAgICAgICBhcmdzWzBdID0gJy8nICsgdXJsOwogICAgICB9CgogICAgICByZXR1cm4gZG9UcmFuc2l0aW9uKHRoaXMsIGFyZ3MpLm1ldGhvZChudWxsKTsKICAgIH07CgogICAgUm91dGVyLnByb3RvdHlwZS51cGRhdGVVUkwgPSBmdW5jdGlvbiB1cGRhdGVVUkwoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndXBkYXRlVVJMIGlzIG5vdCBpbXBsZW1lbnRlZCcpOwogICAgfTsKCiAgICBSb3V0ZXIucHJvdG90eXBlLnJlcGxhY2VVUkwgPSBmdW5jdGlvbiByZXBsYWNlVVJMKHVybCkgewogICAgICB0aGlzLnVwZGF0ZVVSTCh1cmwpOwogICAgfTsKCiAgICBSb3V0ZXIucHJvdG90eXBlLnRyYW5zaXRpb25UbyA9IGZ1bmN0aW9uIHRyYW5zaXRpb25UbygpIC8qbmFtZSovewogICAgICByZXR1cm4gZG9UcmFuc2l0aW9uKHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUuaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvID0gZnVuY3Rpb24gaW50ZXJtZWRpYXRlVHJhbnNpdGlvblRvKCkgLypuYW1lKi97CiAgICAgIHJldHVybiBkb1RyYW5zaXRpb24odGhpcywgYXJndW1lbnRzLCB0cnVlKTsKICAgIH07CgogICAgUm91dGVyLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gcmVmcmVzaChwaXZvdEhhbmRsZXIpIHsKICAgICAgdmFyIHByZXZpb3VzVHJhbnNpdGlvbiA9IHRoaXMuYWN0aXZlVHJhbnNpdGlvbjsKICAgICAgdmFyIHN0YXRlID0gcHJldmlvdXNUcmFuc2l0aW9uID8gcHJldmlvdXNUcmFuc2l0aW9uLnN0YXRlIDogdGhpcy5zdGF0ZTsKICAgICAgdmFyIGhhbmRsZXJJbmZvcyA9IHN0YXRlLmhhbmRsZXJJbmZvczsKCiAgICAgIF9sb2codGhpcywgJ1N0YXJ0aW5nIGEgcmVmcmVzaCB0cmFuc2l0aW9uJyk7CiAgICAgIHZhciBpbnRlbnQgPSBuZXcgTmFtZWRUcmFuc2l0aW9uSW50ZW50KHsKICAgICAgICBuYW1lOiBoYW5kbGVySW5mb3NbaGFuZGxlckluZm9zLmxlbmd0aCAtIDFdLm5hbWUsCiAgICAgICAgcGl2b3RIYW5kbGVyOiBwaXZvdEhhbmRsZXIgfHwgaGFuZGxlckluZm9zWzBdLmhhbmRsZXIsCiAgICAgICAgY29udGV4dHM6IFtdLCAvLyBUT0RPIGNvbGxlY3QgY29udGV4dHMuLi4/CiAgICAgICAgcXVlcnlQYXJhbXM6IHRoaXMuX2NoYW5nZWRRdWVyeVBhcmFtcyB8fCBzdGF0ZS5xdWVyeVBhcmFtcyB8fCB7fQogICAgICB9KTsKCiAgICAgIHZhciBuZXdUcmFuc2l0aW9uID0gdGhpcy50cmFuc2l0aW9uQnlJbnRlbnQoaW50ZW50LCBmYWxzZSk7CgogICAgICAvLyBpZiB0aGUgcHJldmlvdXMgdHJhbnNpdGlvbiBpcyBhIHJlcGxhY2UgdHJhbnNpdGlvbiwgdGhhdCBuZWVkcyB0byBiZSBwcmVzZXJ2ZWQKICAgICAgaWYgKHByZXZpb3VzVHJhbnNpdGlvbiAmJiBwcmV2aW91c1RyYW5zaXRpb24udXJsTWV0aG9kID09PSAncmVwbGFjZScpIHsKICAgICAgICBuZXdUcmFuc2l0aW9uLm1ldGhvZChwcmV2aW91c1RyYW5zaXRpb24udXJsTWV0aG9kKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ld1RyYW5zaXRpb247CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUucmVwbGFjZVdpdGggPSBmdW5jdGlvbiByZXBsYWNlV2l0aCgpIC8qbmFtZSovewogICAgICByZXR1cm4gZG9UcmFuc2l0aW9uKHRoaXMsIGFyZ3VtZW50cykubWV0aG9kKCdyZXBsYWNlJyk7CiAgICB9OwoKICAgIFJvdXRlci5wcm90b3R5cGUuZ2VuZXJhdGUgPSBmdW5jdGlvbiBnZW5lcmF0ZShoYW5kbGVyTmFtZSkgewogICAgICB2YXIgcGFydGl0aW9uZWRBcmdzID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSksCiAgICAgICAgICBzdXBwbGllZFBhcmFtcyA9IHBhcnRpdGlvbmVkQXJnc1swXSwKICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gcGFydGl0aW9uZWRBcmdzWzFdOwoKICAgICAgLy8gQ29uc3RydWN0IGEgVHJhbnNpdGlvbkludGVudCB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbXMKICAgICAgLy8gYW5kIGFwcGx5IGl0IHRvIHRoZSBwcmVzZW50IHN0YXRlIG9mIHRoZSByb3V0ZXIuCiAgICAgIHZhciBpbnRlbnQgPSBuZXcgTmFtZWRUcmFuc2l0aW9uSW50ZW50KHsKICAgICAgICBuYW1lOiBoYW5kbGVyTmFtZSwKICAgICAgICBjb250ZXh0czogc3VwcGxpZWRQYXJhbXMKICAgICAgfSk7CiAgICAgIHZhciBzdGF0ZSA9IGludGVudC5hcHBseVRvU3RhdGUodGhpcy5zdGF0ZSwgdGhpcy5yZWNvZ25pemVyLCB0aGlzLmdldEhhbmRsZXIsIG51bGwsIHRoaXMuZ2V0U2VyaWFsaXplcik7CgogICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzdGF0ZS5oYW5kbGVySW5mb3MubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB2YXIgaGFuZGxlckluZm8gPSBzdGF0ZS5oYW5kbGVySW5mb3NbaV07CiAgICAgICAgdmFyIGhhbmRsZXJQYXJhbXMgPSBoYW5kbGVySW5mby5zZXJpYWxpemUoKTsKICAgICAgICBtZXJnZShwYXJhbXMsIGhhbmRsZXJQYXJhbXMpOwogICAgICB9CiAgICAgIHBhcmFtcy5xdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zOwoKICAgICAgcmV0dXJuIHRoaXMucmVjb2duaXplci5nZW5lcmF0ZShoYW5kbGVyTmFtZSwgcGFyYW1zKTsKICAgIH07CgogICAgUm91dGVyLnByb3RvdHlwZS5hcHBseUludGVudCA9IGZ1bmN0aW9uIGFwcGx5SW50ZW50KGhhbmRsZXJOYW1lLCBjb250ZXh0cykgewogICAgICB2YXIgaW50ZW50ID0gbmV3IE5hbWVkVHJhbnNpdGlvbkludGVudCh7CiAgICAgICAgbmFtZTogaGFuZGxlck5hbWUsCiAgICAgICAgY29udGV4dHM6IGNvbnRleHRzCiAgICAgIH0pOwoKICAgICAgdmFyIHN0YXRlID0gdGhpcy5hY3RpdmVUcmFuc2l0aW9uICYmIHRoaXMuYWN0aXZlVHJhbnNpdGlvbi5zdGF0ZSB8fCB0aGlzLnN0YXRlOwoKICAgICAgcmV0dXJuIGludGVudC5hcHBseVRvU3RhdGUoc3RhdGUsIHRoaXMucmVjb2duaXplciwgdGhpcy5nZXRIYW5kbGVyLCBudWxsLCB0aGlzLmdldFNlcmlhbGl6ZXIpOwogICAgfTsKCiAgICBSb3V0ZXIucHJvdG90eXBlLmlzQWN0aXZlSW50ZW50ID0gZnVuY3Rpb24gaXNBY3RpdmVJbnRlbnQoaGFuZGxlck5hbWUsIGNvbnRleHRzLCBxdWVyeVBhcmFtcywgX3N0YXRlKSB7CiAgICAgIHZhciBzdGF0ZSA9IF9zdGF0ZSB8fCB0aGlzLnN0YXRlLAogICAgICAgICAgdGFyZ2V0SGFuZGxlckluZm9zID0gc3RhdGUuaGFuZGxlckluZm9zLAogICAgICAgICAgaGFuZGxlckluZm8gPSB2b2lkIDAsCiAgICAgICAgICBsZW4gPSB2b2lkIDA7CgogICAgICBpZiAoIXRhcmdldEhhbmRsZXJJbmZvcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciB0YXJnZXRIYW5kbGVyID0gdGFyZ2V0SGFuZGxlckluZm9zW3RhcmdldEhhbmRsZXJJbmZvcy5sZW5ndGggLSAxXS5uYW1lOwogICAgICB2YXIgcmVjb2dIYW5kbGVycyA9IHRoaXMucmVjb2duaXplci5oYW5kbGVyc0Zvcih0YXJnZXRIYW5kbGVyKTsKCiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIGZvciAobGVuID0gcmVjb2dIYW5kbGVycy5sZW5ndGg7IGluZGV4IDwgbGVuOyArK2luZGV4KSB7CiAgICAgICAgaGFuZGxlckluZm8gPSB0YXJnZXRIYW5kbGVySW5mb3NbaW5kZXhdOwogICAgICAgIGlmIChoYW5kbGVySW5mby5uYW1lID09PSBoYW5kbGVyTmFtZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaW5kZXggPT09IHJlY29nSGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgLy8gVGhlIHByb3ZpZGVkIHJvdXRlIG5hbWUgaXNuJ3QgZXZlbiBpbiB0aGUgcm91dGUgaGllcmFyY2h5LgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgdmFyIHRlc3RTdGF0ZSA9IG5ldyBUcmFuc2l0aW9uU3RhdGUoKTsKICAgICAgdGVzdFN0YXRlLmhhbmRsZXJJbmZvcyA9IHRhcmdldEhhbmRsZXJJbmZvcy5zbGljZSgwLCBpbmRleCArIDEpOwogICAgICByZWNvZ0hhbmRsZXJzID0gcmVjb2dIYW5kbGVycy5zbGljZSgwLCBpbmRleCArIDEpOwoKICAgICAgdmFyIGludGVudCA9IG5ldyBOYW1lZFRyYW5zaXRpb25JbnRlbnQoewogICAgICAgIG5hbWU6IHRhcmdldEhhbmRsZXIsCiAgICAgICAgY29udGV4dHM6IGNvbnRleHRzCiAgICAgIH0pOwoKICAgICAgdmFyIG5ld1N0YXRlID0gaW50ZW50LmFwcGx5VG9IYW5kbGVycyh0ZXN0U3RhdGUsIHJlY29nSGFuZGxlcnMsIHRoaXMuZ2V0SGFuZGxlciwgdGFyZ2V0SGFuZGxlciwgdHJ1ZSwgdHJ1ZSwgdGhpcy5nZXRTZXJpYWxpemVyKTsKCiAgICAgIHZhciBoYW5kbGVyc0VxdWFsID0gaGFuZGxlckluZm9zRXF1YWwobmV3U3RhdGUuaGFuZGxlckluZm9zLCB0ZXN0U3RhdGUuaGFuZGxlckluZm9zKTsKICAgICAgaWYgKCFxdWVyeVBhcmFtcyB8fCAhaGFuZGxlcnNFcXVhbCkgewogICAgICAgIHJldHVybiBoYW5kbGVyc0VxdWFsOwogICAgICB9CgogICAgICAvLyBHZXQgYSBoYXNoIG9mIFFQcyB0aGF0IHdpbGwgc3RpbGwgYmUgYWN0aXZlIG9uIG5ldyByb3V0ZQogICAgICB2YXIgYWN0aXZlUVBzT25OZXdIYW5kbGVyID0ge307CiAgICAgIG1lcmdlKGFjdGl2ZVFQc09uTmV3SGFuZGxlciwgcXVlcnlQYXJhbXMpOwoKICAgICAgdmFyIGFjdGl2ZVF1ZXJ5UGFyYW1zID0gc3RhdGUucXVlcnlQYXJhbXM7CiAgICAgIGZvciAodmFyIGtleSBpbiBhY3RpdmVRdWVyeVBhcmFtcykgewogICAgICAgIGlmIChhY3RpdmVRdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIGFjdGl2ZVFQc09uTmV3SGFuZGxlci5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBhY3RpdmVRUHNPbk5ld0hhbmRsZXJba2V5XSA9IGFjdGl2ZVF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaGFuZGxlcnNFcXVhbCAmJiAhZ2V0Q2hhbmdlbGlzdChhY3RpdmVRUHNPbk5ld0hhbmRsZXIsIHF1ZXJ5UGFyYW1zKTsKICAgIH07CgogICAgUm91dGVyLnByb3RvdHlwZS5pc0FjdGl2ZSA9IGZ1bmN0aW9uIGlzQWN0aXZlKGhhbmRsZXJOYW1lKSB7CiAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICB9CgogICAgICB2YXIgcGFydGl0aW9uZWRBcmdzID0gZXh0cmFjdFF1ZXJ5UGFyYW1zKGFyZ3MpOwogICAgICByZXR1cm4gdGhpcy5pc0FjdGl2ZUludGVudChoYW5kbGVyTmFtZSwgcGFydGl0aW9uZWRBcmdzWzBdLCBwYXJ0aXRpb25lZEFyZ3NbMV0pOwogICAgfTsKCiAgICBSb3V0ZXIucHJvdG90eXBlLnRyaWdnZXIgPSBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICAgICAgfQoKICAgICAgX3RyaWdnZXIodGhpcywgdGhpcy5jdXJyZW50SGFuZGxlckluZm9zLCBmYWxzZSwgYXJncyk7CiAgICB9OwoKICAgIHJldHVybiBSb3V0ZXI7CiAgfSgpOwoKICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uQnlJbnRlbnQoaW50ZW50LCBpc0ludGVybWVkaWF0ZSkgewogICAgdmFyIHdhc1RyYW5zaXRpb25pbmcgPSAhIXRoaXMuYWN0aXZlVHJhbnNpdGlvbjsKICAgIHZhciBvbGRTdGF0ZSA9IHdhc1RyYW5zaXRpb25pbmcgPyB0aGlzLmFjdGl2ZVRyYW5zaXRpb24uc3RhdGUgOiB0aGlzLnN0YXRlOwogICAgdmFyIG5ld1RyYW5zaXRpb247CgogICAgdmFyIG5ld1N0YXRlID0gaW50ZW50LmFwcGx5VG9TdGF0ZShvbGRTdGF0ZSwgdGhpcy5yZWNvZ25pemVyLCB0aGlzLmdldEhhbmRsZXIsIGlzSW50ZXJtZWRpYXRlLCB0aGlzLmdldFNlcmlhbGl6ZXIpOwogICAgdmFyIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0ID0gZ2V0Q2hhbmdlbGlzdChvbGRTdGF0ZS5xdWVyeVBhcmFtcywgbmV3U3RhdGUucXVlcnlQYXJhbXMpOwoKICAgIGlmIChoYW5kbGVySW5mb3NFcXVhbChuZXdTdGF0ZS5oYW5kbGVySW5mb3MsIG9sZFN0YXRlLmhhbmRsZXJJbmZvcykpIHsKICAgICAgLy8gVGhpcyBpcyBhIG5vLW9wIHRyYW5zaXRpb24uIFNlZSBpZiBxdWVyeSBwYXJhbXMgY2hhbmdlZC4KICAgICAgaWYgKHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0KSB7CiAgICAgICAgbmV3VHJhbnNpdGlvbiA9IHRoaXMucXVlcnlQYXJhbXNUcmFuc2l0aW9uKHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0LCB3YXNUcmFuc2l0aW9uaW5nLCBvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgIGlmIChuZXdUcmFuc2l0aW9uKSB7CiAgICAgICAgICBuZXdUcmFuc2l0aW9uLnF1ZXJ5UGFyYW1zT25seSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gbmV3VHJhbnNpdGlvbjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE5vLW9wLiBObyBuZWVkIHRvIGNyZWF0ZSBhIG5ldyB0cmFuc2l0aW9uLgogICAgICByZXR1cm4gdGhpcy5hY3RpdmVUcmFuc2l0aW9uIHx8IG5ldyBUcmFuc2l0aW9uKHRoaXMpOwogICAgfQoKICAgIGlmIChpc0ludGVybWVkaWF0ZSkgewogICAgICBzZXR1cENvbnRleHRzKHRoaXMsIG5ld1N0YXRlKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIENyZWF0ZSBhIG5ldyB0cmFuc2l0aW9uIHRvIHRoZSBkZXN0aW5hdGlvbiByb3V0ZS4KICAgIG5ld1RyYW5zaXRpb24gPSBuZXcgVHJhbnNpdGlvbih0aGlzLCBpbnRlbnQsIG5ld1N0YXRlLCB1bmRlZmluZWQsIHRoaXMuYWN0aXZlVHJhbnNpdGlvbik7CgogICAgLy8gdHJhbnNpdGlvbiBpcyB0byBzYW1lIHJvdXRlIHdpdGggc2FtZSBwYXJhbXMsIG9ubHkgcXVlcnkgcGFyYW1zIGRpZmZlci4KICAgIC8vIG5vdCBjYXVnaHQgYWJvdmUgcHJvYmFibHkgYmVjYXVzZSByZWZyZXNoKCkgaGFzIGJlZW4gdXNlZAogICAgaWYgKGhhbmRsZXJJbmZvc1NhbWVFeGNlcHRRdWVyeVBhcmFtcyhuZXdTdGF0ZS5oYW5kbGVySW5mb3MsIG9sZFN0YXRlLmhhbmRsZXJJbmZvcykpIHsKICAgICAgbmV3VHJhbnNpdGlvbi5xdWVyeVBhcmFtc09ubHkgPSB0cnVlOwogICAgfQoKICAgIC8vIEFib3J0IGFuZCB1c3VycCBhbnkgcHJldmlvdXNseSBhY3RpdmUgdHJhbnNpdGlvbi4KICAgIGlmICh0aGlzLmFjdGl2ZVRyYW5zaXRpb24pIHsKICAgICAgdGhpcy5hY3RpdmVUcmFuc2l0aW9uLmFib3J0KCk7CiAgICB9CiAgICB0aGlzLmFjdGl2ZVRyYW5zaXRpb24gPSBuZXdUcmFuc2l0aW9uOwoKICAgIC8vIFRyYW5zaXRpb24gcHJvbWlzZXMgYnkgZGVmYXVsdCByZXNvbHZlIHdpdGggcmVzb2x2ZWQgc3RhdGUuCiAgICAvLyBGb3Igb3VyIHB1cnBvc2VzLCBzd2FwIG91dCB0aGUgcHJvbWlzZSB0byByZXNvbHZlCiAgICAvLyBhZnRlciB0aGUgdHJhbnNpdGlvbiBoYXMgYmVlbiBmaW5hbGl6ZWQuCiAgICBuZXdUcmFuc2l0aW9uLnByb21pc2UgPSBuZXdUcmFuc2l0aW9uLnByb21pc2UudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgIHJldHVybiBmaW5hbGl6ZVRyYW5zaXRpb24obmV3VHJhbnNpdGlvbiwgcmVzdWx0LnN0YXRlKTsKICAgIH0sIG51bGwsIF9wcm9taXNlTGFiZWwoJ1NldHRsZSB0cmFuc2l0aW9uIHByb21pc2Ugd2hlbiB0cmFuc2l0aW9uIGlzIGZpbmFsaXplZCcpKTsKCiAgICBpZiAoIXdhc1RyYW5zaXRpb25pbmcpIHsKICAgICAgbm90aWZ5RXhpc3RpbmdIYW5kbGVycyh0aGlzLCBuZXdTdGF0ZSwgbmV3VHJhbnNpdGlvbik7CiAgICB9CgogICAgZmlyZVF1ZXJ5UGFyYW1EaWRDaGFuZ2UodGhpcywgbmV3U3RhdGUsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0KTsKCiAgICByZXR1cm4gbmV3VHJhbnNpdGlvbjsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIEZpcmVzIHF1ZXJ5UGFyYW1zRGlkQ2hhbmdlIGV2ZW50CiAgKi8KICBmdW5jdGlvbiBmaXJlUXVlcnlQYXJhbURpZENoYW5nZShyb3V0ZXIsIG5ld1N0YXRlLCBxdWVyeVBhcmFtQ2hhbmdlbGlzdCkgewogICAgLy8gSWYgcXVlcnlQYXJhbXMgY2hhbmdlZCB0cmlnZ2VyIGV2ZW50CiAgICBpZiAocXVlcnlQYXJhbUNoYW5nZWxpc3QpIHsKICAgICAgLy8gVGhpcyBpcyBhIGxpdHRsZSBoYWNreSBidXQgd2UgbmVlZCBzb21lIHdheSBvZiBzdG9yaW5nCiAgICAgIC8vIGNoYW5nZWQgcXVlcnkgcGFyYW1zIGdpdmVuIHRoYXQgbm8gYWN0aXZlVHJhbnNpdGlvbgogICAgICAvLyBpcyBndWFyYW50ZWVkIHRvIGhhdmUgb2NjdXJyZWQuCiAgICAgIHJvdXRlci5fY2hhbmdlZFF1ZXJ5UGFyYW1zID0gcXVlcnlQYXJhbUNoYW5nZWxpc3QuYWxsOwogICAgICBfdHJpZ2dlcihyb3V0ZXIsIG5ld1N0YXRlLmhhbmRsZXJJbmZvcywgdHJ1ZSwgWydxdWVyeVBhcmFtc0RpZENoYW5nZScsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0LmNoYW5nZWQsIHF1ZXJ5UGFyYW1DaGFuZ2VsaXN0LmFsbCwgcXVlcnlQYXJhbUNoYW5nZWxpc3QucmVtb3ZlZF0pOwogICAgICByb3V0ZXIuX2NoYW5nZWRRdWVyeVBhcmFtcyA9IG51bGw7CiAgICB9CiAgfQoKICAvKioKICAgIEBwcml2YXRlCiAgCiAgICBUYWtlcyBhbiBBcnJheSBvZiBgSGFuZGxlckluZm9gcywgZmlndXJlcyBvdXQgd2hpY2ggb25lcyBhcmUKICAgIGV4aXRpbmcsIGVudGVyaW5nLCBvciBjaGFuZ2luZyBjb250ZXh0cywgYW5kIGNhbGxzIHRoZQogICAgcHJvcGVyIGhhbmRsZXIgaG9va3MuCiAgCiAgICBGb3IgZXhhbXBsZSwgY29uc2lkZXIgdGhlIGZvbGxvd2luZyB0cmVlIG9mIGhhbmRsZXJzLiBFYWNoIGhhbmRsZXIgaXMKICAgIGZvbGxvd2VkIGJ5IHRoZSBVUkwgc2VnbWVudCBpdCBoYW5kbGVzLgogIAogICAgYGBgCiAgICB8fmluZGV4ICgiLyIpCiAgICB8IHx+cG9zdHMgKCIvcG9zdHMiKQogICAgfCB8IHwtc2hvd1Bvc3QgKCIvOmlkIikKICAgIHwgfCB8LW5ld1Bvc3QgKCIvbmV3IikKICAgIHwgfCB8LWVkaXRQb3N0ICgiL2VkaXQiKQogICAgfCB8fmFib3V0ICgiL2Fib3V0LzppZCIpCiAgICBgYGAKICAKICAgIENvbnNpZGVyIHRoZSBmb2xsb3dpbmcgdHJhbnNpdGlvbnM6CiAgCiAgICAxLiBBIFVSTCB0cmFuc2l0aW9uIHRvIGAvcG9zdHMvMWAuCiAgICAgICAxLiBUcmlnZ2VycyB0aGUgYCptb2RlbGAgY2FsbGJhY2tzIG9uIHRoZQogICAgICAgICAgYGluZGV4YCwgYHBvc3RzYCwgYW5kIGBzaG93UG9zdGAgaGFuZGxlcnMKICAgICAgIDIuIFRyaWdnZXJzIHRoZSBgZW50ZXJgIGNhbGxiYWNrIG9uIHRoZSBzYW1lCiAgICAgICAzLiBUcmlnZ2VycyB0aGUgYHNldHVwYCBjYWxsYmFjayBvbiB0aGUgc2FtZQogICAgMi4gQSBkaXJlY3QgdHJhbnNpdGlvbiB0byBgbmV3UG9zdGAKICAgICAgIDEuIFRyaWdnZXJzIHRoZSBgZXhpdGAgY2FsbGJhY2sgb24gYHNob3dQb3N0YAogICAgICAgMi4gVHJpZ2dlcnMgdGhlIGBlbnRlcmAgY2FsbGJhY2sgb24gYG5ld1Bvc3RgCiAgICAgICAzLiBUcmlnZ2VycyB0aGUgYHNldHVwYCBjYWxsYmFjayBvbiBgbmV3UG9zdGAKICAgIDMuIEEgZGlyZWN0IHRyYW5zaXRpb24gdG8gYGFib3V0YCB3aXRoIGEgc3BlY2lmaWVkCiAgICAgICBjb250ZXh0IG9iamVjdAogICAgICAgMS4gVHJpZ2dlcnMgdGhlIGBleGl0YCBjYWxsYmFjayBvbiBgbmV3UG9zdGAKICAgICAgICAgIGFuZCBgcG9zdHNgCiAgICAgICAyLiBUcmlnZ2VycyB0aGUgYHNlcmlhbGl6ZWAgY2FsbGJhY2sgb24gYGFib3V0YAogICAgICAgMy4gVHJpZ2dlcnMgdGhlIGBlbnRlcmAgY2FsbGJhY2sgb24gYGFib3V0YAogICAgICAgNC4gVHJpZ2dlcnMgdGhlIGBzZXR1cGAgY2FsbGJhY2sgb24gYGFib3V0YAogIAogICAgQHBhcmFtIHtSb3V0ZXJ9IHRyYW5zaXRpb24KICAgIEBwYXJhbSB7VHJhbnNpdGlvblN0YXRlfSBuZXdTdGF0ZQogICovCiAgZnVuY3Rpb24gc2V0dXBDb250ZXh0cyhyb3V0ZXIsIG5ld1N0YXRlLCB0cmFuc2l0aW9uKSB7CiAgICB2YXIgcGFydGl0aW9uID0gcGFydGl0aW9uSGFuZGxlcnMocm91dGVyLnN0YXRlLCBuZXdTdGF0ZSk7CiAgICB2YXIgaSwgbCwgaGFuZGxlcjsKCiAgICBmb3IgKGkgPSAwLCBsID0gcGFydGl0aW9uLmV4aXRlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaGFuZGxlciA9IHBhcnRpdGlvbi5leGl0ZWRbaV0uaGFuZGxlcjsKICAgICAgZGVsZXRlIGhhbmRsZXIuY29udGV4dDsKCiAgICAgIGNhbGxIb29rKGhhbmRsZXIsICdyZXNldCcsIHRydWUsIHRyYW5zaXRpb24pOwogICAgICBjYWxsSG9vayhoYW5kbGVyLCAnZXhpdCcsIHRyYW5zaXRpb24pOwogICAgfQoKICAgIHZhciBvbGRTdGF0ZSA9IHJvdXRlci5vbGRTdGF0ZSA9IHJvdXRlci5zdGF0ZTsKICAgIHJvdXRlci5zdGF0ZSA9IG5ld1N0YXRlOwogICAgdmFyIGN1cnJlbnRIYW5kbGVySW5mb3MgPSByb3V0ZXIuY3VycmVudEhhbmRsZXJJbmZvcyA9IHBhcnRpdGlvbi51bmNoYW5nZWQuc2xpY2UoKTsKCiAgICB0cnkgewogICAgICBmb3IgKGkgPSAwLCBsID0gcGFydGl0aW9uLnJlc2V0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGhhbmRsZXIgPSBwYXJ0aXRpb24ucmVzZXRbaV0uaGFuZGxlcjsKICAgICAgICBjYWxsSG9vayhoYW5kbGVyLCAncmVzZXQnLCBmYWxzZSwgdHJhbnNpdGlvbik7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGwgPSBwYXJ0aXRpb24udXBkYXRlZENvbnRleHQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaGFuZGxlckVudGVyZWRPclVwZGF0ZWQoY3VycmVudEhhbmRsZXJJbmZvcywgcGFydGl0aW9uLnVwZGF0ZWRDb250ZXh0W2ldLCBmYWxzZSwgdHJhbnNpdGlvbik7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGwgPSBwYXJ0aXRpb24uZW50ZXJlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBoYW5kbGVyRW50ZXJlZE9yVXBkYXRlZChjdXJyZW50SGFuZGxlckluZm9zLCBwYXJ0aXRpb24uZW50ZXJlZFtpXSwgdHJ1ZSwgdHJhbnNpdGlvbik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcm91dGVyLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgIHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zID0gb2xkU3RhdGUuaGFuZGxlckluZm9zOwogICAgICB0aHJvdyBlOwogICAgfQoKICAgIHJvdXRlci5zdGF0ZS5xdWVyeVBhcmFtcyA9IGZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZShyb3V0ZXIsIGN1cnJlbnRIYW5kbGVySW5mb3MsIG5ld1N0YXRlLnF1ZXJ5UGFyYW1zLCB0cmFuc2l0aW9uKTsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIEhlbHBlciBtZXRob2QgdXNlZCBieSBzZXR1cENvbnRleHRzLiBIYW5kbGVzIGVycm9ycyBvciByZWRpcmVjdHMKICAgIHRoYXQgbWF5IGhhcHBlbiBpbiBlbnRlci9zZXR1cC4KICAqLwogIGZ1bmN0aW9uIGhhbmRsZXJFbnRlcmVkT3JVcGRhdGVkKGN1cnJlbnRIYW5kbGVySW5mb3MsIGhhbmRsZXJJbmZvLCBlbnRlciwgdHJhbnNpdGlvbikgewogICAgdmFyIGhhbmRsZXIgPSBoYW5kbGVySW5mby5oYW5kbGVyLAogICAgICAgIGNvbnRleHQgPSBoYW5kbGVySW5mby5jb250ZXh0OwoKICAgIGZ1bmN0aW9uIF9oYW5kbGVyRW50ZXJlZE9yVXBkYXRlZChoYW5kbGVyKSB7CiAgICAgIGlmIChlbnRlcikgewogICAgICAgIGNhbGxIb29rKGhhbmRsZXIsICdlbnRlcicsIHRyYW5zaXRpb24pOwogICAgICB9CgogICAgICBpZiAodHJhbnNpdGlvbiAmJiB0cmFuc2l0aW9uLmlzQWJvcnRlZCkgewogICAgICAgIHRocm93IG5ldyBUcmFuc2l0aW9uQWJvcnRlZEVycm9yKCk7CiAgICAgIH0KCiAgICAgIGhhbmRsZXIuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIGNhbGxIb29rKGhhbmRsZXIsICdjb250ZXh0RGlkQ2hhbmdlJyk7CgogICAgICBjYWxsSG9vayhoYW5kbGVyLCAnc2V0dXAnLCBjb250ZXh0LCB0cmFuc2l0aW9uKTsKICAgICAgaWYgKHRyYW5zaXRpb24gJiYgdHJhbnNpdGlvbi5pc0Fib3J0ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgVHJhbnNpdGlvbkFib3J0ZWRFcnJvcigpOwogICAgICB9CgogICAgICBjdXJyZW50SGFuZGxlckluZm9zLnB1c2goaGFuZGxlckluZm8pOwogICAgfQoKICAgIC8vIElmIHRoZSBoYW5kbGVyIGRvZXNuJ3QgZXhpc3QsIGl0IG1lYW5zIHdlIGhhdmVuJ3QgcmVzb2x2ZWQgdGhlIGhhbmRsZXIgcHJvbWlzZSB5ZXQKICAgIGlmICghaGFuZGxlcikgewogICAgICBoYW5kbGVySW5mby5oYW5kbGVyUHJvbWlzZSA9IGhhbmRsZXJJbmZvLmhhbmRsZXJQcm9taXNlLnRoZW4oX2hhbmRsZXJFbnRlcmVkT3JVcGRhdGVkKTsKICAgIH0gZWxzZSB7CiAgICAgIF9oYW5kbGVyRW50ZXJlZE9yVXBkYXRlZChoYW5kbGVyKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdoZW4gdHJhbnNpdGlvbmluZyBmcm9tIG9uZSBVUkwgdG8KICAgIGFub3RoZXIgdG8gZGV0ZXJtaW5lIHdoaWNoIGhhbmRsZXJzIGFyZSBubyBsb25nZXIgYWN0aXZlLAogICAgd2hpY2ggaGFuZGxlcnMgYXJlIG5ld2x5IGFjdGl2ZSwgYW5kIHdoaWNoIGhhbmRsZXJzIHJlbWFpbgogICAgYWN0aXZlIGJ1dCBoYXZlIHRoZWlyIGNvbnRleHQgY2hhbmdlZC4KICAKICAgIFRha2UgYSBsaXN0IG9mIG9sZCBoYW5kbGVycyBhbmQgbmV3IGhhbmRsZXJzIGFuZCBwYXJ0aXRpb24KICAgIHRoZW0gaW50byBmb3VyIGJ1Y2tldHM6CiAgCiAgICAqIHVuY2hhbmdlZDogdGhlIGhhbmRsZXIgd2FzIGFjdGl2ZSBpbiBib3RoIHRoZSBvbGQgYW5kCiAgICAgIG5ldyBVUkwsIGFuZCBpdHMgY29udGV4dCByZW1haW5zIHRoZSBzYW1lCiAgICAqIHVwZGF0ZWQgY29udGV4dDogdGhlIGhhbmRsZXIgd2FzIGFjdGl2ZSBpbiBib3RoIHRoZQogICAgICBvbGQgYW5kIG5ldyBVUkwsIGJ1dCBpdHMgY29udGV4dCBjaGFuZ2VkLiBUaGUgaGFuZGxlcidzCiAgICAgIGBzZXR1cGAgbWV0aG9kLCBpZiBhbnksIHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIG5ldwogICAgICBjb250ZXh0LgogICAgKiBleGl0ZWQ6IHRoZSBoYW5kbGVyIHdhcyBhY3RpdmUgaW4gdGhlIG9sZCBVUkwsIGJ1dCBpcwogICAgICBubyBsb25nZXIgYWN0aXZlLgogICAgKiBlbnRlcmVkOiB0aGUgaGFuZGxlciB3YXMgbm90IGFjdGl2ZSBpbiB0aGUgb2xkIFVSTCwgYnV0CiAgICAgIGlzIG5vdyBhY3RpdmUuCiAgCiAgICBUaGUgUGFydGl0aW9uZWRIYW5kbGVycyBzdHJ1Y3R1cmUgaGFzIGZvdXIgZmllbGRzOgogIAogICAgKiBgdXBkYXRlZENvbnRleHRgOiBhIGxpc3Qgb2YgYEhhbmRsZXJJbmZvYCBvYmplY3RzIHRoYXQKICAgICAgcmVwcmVzZW50IGhhbmRsZXJzIHRoYXQgcmVtYWluIGFjdGl2ZSBidXQgaGF2ZSBhIGNoYW5nZWQKICAgICAgY29udGV4dAogICAgKiBgZW50ZXJlZGA6IGEgbGlzdCBvZiBgSGFuZGxlckluZm9gIG9iamVjdHMgdGhhdCByZXByZXNlbnQKICAgICAgaGFuZGxlcnMgdGhhdCBhcmUgbmV3bHkgYWN0aXZlCiAgICAqIGBleGl0ZWRgOiBhIGxpc3Qgb2YgYEhhbmRsZXJJbmZvYCBvYmplY3RzIHRoYXQgYXJlIG5vCiAgICAgIGxvbmdlciBhY3RpdmUuCiAgICAqIGB1bmNoYW5nZWRgOiBhIGxpc3Qgb2YgYEhhbmRlckluZm9gIG9iamVjdHMgdGhhdCByZW1haW4gYWN0aXZlLgogIAogICAgQHBhcmFtIHtBcnJheVtIYW5kbGVySW5mb119IG9sZEhhbmRsZXJzIGEgbGlzdCBvZiB0aGUgaGFuZGxlcgogICAgICBpbmZvcm1hdGlvbiBmb3IgdGhlIHByZXZpb3VzIFVSTCAob3IgYFtdYCBpZiB0aGlzIGlzIHRoZQogICAgICBmaXJzdCBoYW5kbGVkIHRyYW5zaXRpb24pCiAgICBAcGFyYW0ge0FycmF5W0hhbmRsZXJJbmZvXX0gbmV3SGFuZGxlcnMgYSBsaXN0IG9mIHRoZSBoYW5kbGVyCiAgICAgIGluZm9ybWF0aW9uIGZvciB0aGUgbmV3IFVSTAogIAogICAgQHJldHVybiB7UGFydGl0aW9ufQogICovCiAgZnVuY3Rpb24gcGFydGl0aW9uSGFuZGxlcnMob2xkU3RhdGUsIG5ld1N0YXRlKSB7CiAgICB2YXIgb2xkSGFuZGxlcnMgPSBvbGRTdGF0ZS5oYW5kbGVySW5mb3M7CiAgICB2YXIgbmV3SGFuZGxlcnMgPSBuZXdTdGF0ZS5oYW5kbGVySW5mb3M7CgogICAgdmFyIGhhbmRsZXJzID0gewogICAgICB1cGRhdGVkQ29udGV4dDogW10sCiAgICAgIGV4aXRlZDogW10sCiAgICAgIGVudGVyZWQ6IFtdLAogICAgICB1bmNoYW5nZWQ6IFtdLAogICAgICByZXNldDogdW5kZWZpbmVkCiAgICB9OwoKICAgIHZhciBoYW5kbGVyQ2hhbmdlZCwKICAgICAgICBjb250ZXh0Q2hhbmdlZCA9IGZhbHNlLAogICAgICAgIGksCiAgICAgICAgbDsKCiAgICBmb3IgKGkgPSAwLCBsID0gbmV3SGFuZGxlcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBvbGRIYW5kbGVyID0gb2xkSGFuZGxlcnNbaV0sCiAgICAgICAgICBuZXdIYW5kbGVyID0gbmV3SGFuZGxlcnNbaV07CgogICAgICBpZiAoIW9sZEhhbmRsZXIgfHwgb2xkSGFuZGxlci5oYW5kbGVyICE9PSBuZXdIYW5kbGVyLmhhbmRsZXIpIHsKICAgICAgICBoYW5kbGVyQ2hhbmdlZCA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmIChoYW5kbGVyQ2hhbmdlZCkgewogICAgICAgIGhhbmRsZXJzLmVudGVyZWQucHVzaChuZXdIYW5kbGVyKTsKICAgICAgICBpZiAob2xkSGFuZGxlcikgewogICAgICAgICAgaGFuZGxlcnMuZXhpdGVkLnVuc2hpZnQob2xkSGFuZGxlcik7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNvbnRleHRDaGFuZ2VkIHx8IG9sZEhhbmRsZXIuY29udGV4dCAhPT0gbmV3SGFuZGxlci5jb250ZXh0KSB7CiAgICAgICAgY29udGV4dENoYW5nZWQgPSB0cnVlOwogICAgICAgIGhhbmRsZXJzLnVwZGF0ZWRDb250ZXh0LnB1c2gobmV3SGFuZGxlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlcnMudW5jaGFuZ2VkLnB1c2gob2xkSGFuZGxlcik7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKGkgPSBuZXdIYW5kbGVycy5sZW5ndGgsIGwgPSBvbGRIYW5kbGVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaGFuZGxlcnMuZXhpdGVkLnVuc2hpZnQob2xkSGFuZGxlcnNbaV0pOwogICAgfQoKICAgIGhhbmRsZXJzLnJlc2V0ID0gaGFuZGxlcnMudXBkYXRlZENvbnRleHQuc2xpY2UoKTsKICAgIGhhbmRsZXJzLnJlc2V0LnJldmVyc2UoKTsKCiAgICByZXR1cm4gaGFuZGxlcnM7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVVUkwodHJhbnNpdGlvbiwgc3RhdGUgLyosIGlucHV0VXJsKi8pIHsKICAgIHZhciB1cmxNZXRob2QgPSB0cmFuc2l0aW9uLnVybE1ldGhvZDsKCiAgICBpZiAoIXVybE1ldGhvZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHJvdXRlciA9IHRyYW5zaXRpb24ucm91dGVyLAogICAgICAgIGhhbmRsZXJJbmZvcyA9IHN0YXRlLmhhbmRsZXJJbmZvcywKICAgICAgICBoYW5kbGVyTmFtZSA9IGhhbmRsZXJJbmZvc1toYW5kbGVySW5mb3MubGVuZ3RoIC0gMV0ubmFtZSwKICAgICAgICBwYXJhbXMgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gaGFuZGxlckluZm9zLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgIHZhciBoYW5kbGVySW5mbyA9IGhhbmRsZXJJbmZvc1tpXTsKICAgICAgbWVyZ2UocGFyYW1zLCBoYW5kbGVySW5mby5wYXJhbXMpOwogICAgICBpZiAoaGFuZGxlckluZm8uaGFuZGxlci5pbmFjY2Vzc2libGVCeVVSTCkgewogICAgICAgIHVybE1ldGhvZCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodXJsTWV0aG9kKSB7CiAgICAgIHBhcmFtcy5xdWVyeVBhcmFtcyA9IHRyYW5zaXRpb24uX3Zpc2libGVRdWVyeVBhcmFtcyB8fCBzdGF0ZS5xdWVyeVBhcmFtczsKICAgICAgdmFyIHVybCA9IHJvdXRlci5yZWNvZ25pemVyLmdlbmVyYXRlKGhhbmRsZXJOYW1lLCBwYXJhbXMpOwoKICAgICAgLy8gdHJhbnNpdGlvbnMgZHVyaW5nIHRoZSBpbml0aWFsIHRyYW5zaXRpb24gbXVzdCBhbHdheXMgdXNlIHJlcGxhY2VVUkwuCiAgICAgIC8vIFdoZW4gdGhlIGFwcCBib290cywgeW91IGFyZSBhdCBhIHVybCwgZS5nLiAvZm9vLiBJZiBzb21lIGhhbmRsZXIKICAgICAgLy8gcmVkaXJlY3RzIHRvIGJhciBhcyBwYXJ0IG9mIHRoZSBpbml0aWFsIHRyYW5zaXRpb24sIHlvdSBkb24ndCB3YW50IHRvCiAgICAgIC8vIGFkZCBhIGhpc3RvcnkgZW50cnkgZm9yIC9mb28uIElmIHlvdSBkbywgcHJlc3NpbmcgYmFjayB3aWxsIGltbWVkaWF0ZWx5CiAgICAgIC8vIGhpdCB0aGUgcmVkaXJlY3QgYWdhaW4gYW5kIHRha2UgeW91IGJhY2sgdG8gL2JhciwgdGh1cyBraWxsaW5nIHRoZSBiYWNrCiAgICAgIC8vIGJ1dHRvbgogICAgICB2YXIgaW5pdGlhbCA9IHRyYW5zaXRpb24uaXNDYXVzZWRCeUluaXRpYWxUcmFuc2l0aW9uOwoKICAgICAgLy8gc2F5IHlvdSBhcmUgYXQgLyBhbmQgeW91IGNsaWNrIGEgbGluayB0byByb3V0ZSAvZm9vLiBJbiAvZm9vJ3MKICAgICAgLy8gaGFuZGxlciwgdGhlIHRyYW5zaXRpb24gaXMgYWJvcnRlZCB1c2luZyByZXBsYWNld2l0aCgnL2JhcicpLgogICAgICAvLyBCZWNhdXNlIHRoZSBjdXJyZW50IHVybCBpcyBzdGlsbCAvLCB0aGUgaGlzdG9yeSBlbnRyeSBmb3IgLyBpcwogICAgICAvLyByZW1vdmVkIGZyb20gdGhlIGhpc3RvcnkuIENsaWNraW5nIGJhY2sgd2lsbCB0YWtlIHlvdSB0byB0aGUgcGFnZQogICAgICAvLyB5b3Ugd2VyZSBvbiBiZWZvcmUgLywgd2hpY2ggaXMgb2Z0ZW4gbm90IGV2ZW4gdGhlIGFwcCwgdGh1cyBraWxsaW5nCiAgICAgIC8vIHRoZSBiYWNrIGJ1dHRvbi4gVGhhdCdzIHdoeSB1cGRhdGVVUkwgaXMgYWx3YXlzIGNvcnJlY3QgZm9yIGFuCiAgICAgIC8vIGFib3J0aW5nIHRyYW5zaXRpb24gdGhhdCdzIG5vdCB0aGUgaW5pdGlhbCB0cmFuc2l0aW9uCiAgICAgIHZhciByZXBsYWNlQW5kTm90QWJvcnRpbmcgPSB1cmxNZXRob2QgPT09ICdyZXBsYWNlJyAmJiAhdHJhbnNpdGlvbi5pc0NhdXNlZEJ5QWJvcnRpbmdUcmFuc2l0aW9uOwoKICAgICAgLy8gYmVjYXVzZSBjYWxsaW5nIHJlZnJlc2ggY2F1c2VzIGFuIGFib3J0ZWQgdHJhbnNpdGlvbiwgdGhpcyBuZWVkcyB0byBiZQogICAgICAvLyBzcGVjaWFsIGNhc2VkIC0gaWYgdGhlIGluaXRpYWwgdHJhbnNpdGlvbiBpcyBhIHJlcGxhY2UgdHJhbnNpdGlvbiwgdGhlCiAgICAgIC8vIHVybE1ldGhvZCBzaG91bGQgYmUgaG9ub3JlZCBoZXJlLgogICAgICB2YXIgaXNRdWVyeVBhcmFtc1JlZnJlc2hUcmFuc2l0aW9uID0gdHJhbnNpdGlvbi5xdWVyeVBhcmFtc09ubHkgJiYgdXJsTWV0aG9kID09PSAncmVwbGFjZSc7CgogICAgICAvLyBzYXkgeW91IGFyZSBhdCAvIGFuZCB5b3UgYSBgcmVwbGFjZVdpdGgoL2ZvbylgIGlzIGNhbGxlZC4gVGhlbiwgdGhhdAogICAgICAvLyB0cmFuc2l0aW9uIGlzIGFib3J0ZWQgd2l0aCBgcmVwbGFjZVdpdGgoL2JhcilgLiBBdCB0aGUgZW5kLCB3ZSBzaG91bGQKICAgICAgLy8gZW5kIHVwIHdpdGggL2JhciByZXBsYWNpbmcgLy4gV2UgYXJlIHJlcGxhY2luZyB0aGUgcmVwbGFjZS4gV2Ugb25seQogICAgICAvLyB3aWxsIHJlcGxhY2UgdGhlIGluaXRpYWwgcm91dGUgaWYgYWxsIHN1YnNlcXVlbnQgYWJvcnRzIGFyZSBhbHNvCiAgICAgIC8vIHJlcGxhY2VzLiBIb3dldmVyLCB0aGVyZSBpcyBzb21lIGFtYmlndWl0eSBhcm91bmQgdGhlIGNvcnJlY3QgYmVoYXZpb3IKICAgICAgLy8gaGVyZS4KICAgICAgdmFyIHJlcGxhY2luZ1JlcGxhY2UgPSB1cmxNZXRob2QgPT09ICdyZXBsYWNlJyAmJiB0cmFuc2l0aW9uLmlzQ2F1c2VkQnlBYm9ydGluZ1JlcGxhY2VUcmFuc2l0aW9uOwoKICAgICAgaWYgKGluaXRpYWwgfHwgcmVwbGFjZUFuZE5vdEFib3J0aW5nIHx8IGlzUXVlcnlQYXJhbXNSZWZyZXNoVHJhbnNpdGlvbiB8fCByZXBsYWNpbmdSZXBsYWNlKSB7CiAgICAgICAgcm91dGVyLnJlcGxhY2VVUkwodXJsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByb3V0ZXIudXBkYXRlVVJMKHVybCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAgQHByaXZhdGUKICAKICAgIFVwZGF0ZXMgdGhlIFVSTCAoaWYgbmVjZXNzYXJ5KSBhbmQgY2FsbHMgYHNldHVwQ29udGV4dHNgCiAgICB0byB1cGRhdGUgdGhlIHJvdXRlcidzIGFycmF5IG9mIGBjdXJyZW50SGFuZGxlckluZm9zYC4KICAgKi8KICBmdW5jdGlvbiBmaW5hbGl6ZVRyYW5zaXRpb24odHJhbnNpdGlvbiwgbmV3U3RhdGUpIHsKICAgIHRyeSB7CiAgICAgIF9sb2codHJhbnNpdGlvbi5yb3V0ZXIsIHRyYW5zaXRpb24uc2VxdWVuY2UsICdSZXNvbHZlZCBhbGwgbW9kZWxzIG9uIGRlc3RpbmF0aW9uIHJvdXRlOyBmaW5hbGl6aW5nIHRyYW5zaXRpb24uJyk7CgogICAgICB2YXIgcm91dGVyID0gdHJhbnNpdGlvbi5yb3V0ZXIsCiAgICAgICAgICBoYW5kbGVySW5mb3MgPSBuZXdTdGF0ZS5oYW5kbGVySW5mb3M7CgogICAgICAvLyBSdW4gYWxsIHRoZSBuZWNlc3NhcnkgZW50ZXIvc2V0dXAvZXhpdCBob29rcwogICAgICBzZXR1cENvbnRleHRzKHJvdXRlciwgbmV3U3RhdGUsIHRyYW5zaXRpb24pOwoKICAgICAgLy8gQ2hlY2sgaWYgYSByZWRpcmVjdCBvY2N1cnJlZCBpbiBlbnRlci9zZXR1cAogICAgICBpZiAodHJhbnNpdGlvbi5pc0Fib3J0ZWQpIHsKICAgICAgICAvLyBUT0RPOiBjbGVhbmVyIHdheT8gZGlzdGluZ3Vpc2ggYi93IHRhcmdldEhhbmRsZXJJbmZvcz8KICAgICAgICByb3V0ZXIuc3RhdGUuaGFuZGxlckluZm9zID0gcm91dGVyLmN1cnJlbnRIYW5kbGVySW5mb3M7CiAgICAgICAgcmV0dXJuIF9yc3ZwLlByb21pc2UucmVqZWN0KGxvZ0Fib3J0KHRyYW5zaXRpb24pKTsKICAgICAgfQoKICAgICAgdXBkYXRlVVJMKHRyYW5zaXRpb24sIG5ld1N0YXRlLCB0cmFuc2l0aW9uLmludGVudC51cmwpOwoKICAgICAgdHJhbnNpdGlvbi5pc0FjdGl2ZSA9IGZhbHNlOwogICAgICByb3V0ZXIuYWN0aXZlVHJhbnNpdGlvbiA9IG51bGw7CgogICAgICBfdHJpZ2dlcihyb3V0ZXIsIHJvdXRlci5jdXJyZW50SGFuZGxlckluZm9zLCB0cnVlLCBbJ2RpZFRyYW5zaXRpb24nXSk7CgogICAgICBpZiAocm91dGVyLmRpZFRyYW5zaXRpb24pIHsKICAgICAgICByb3V0ZXIuZGlkVHJhbnNpdGlvbihyb3V0ZXIuY3VycmVudEhhbmRsZXJJbmZvcyk7CiAgICAgIH0KCiAgICAgIF9sb2cocm91dGVyLCB0cmFuc2l0aW9uLnNlcXVlbmNlLCAnVFJBTlNJVElPTiBDT01QTEVURS4nKTsKCiAgICAgIC8vIFJlc29sdmUgd2l0aCB0aGUgZmluYWwgaGFuZGxlci4KICAgICAgcmV0dXJuIGhhbmRsZXJJbmZvc1toYW5kbGVySW5mb3MubGVuZ3RoIC0gMV0uaGFuZGxlcjsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKCEoZSBpbnN0YW5jZW9mIFRyYW5zaXRpb25BYm9ydGVkRXJyb3IpKSB7CiAgICAgICAgLy92YXIgZXJyb25lb3VzSGFuZGxlciA9IGhhbmRsZXJJbmZvcy5wb3AoKTsKICAgICAgICB2YXIgaW5mb3MgPSB0cmFuc2l0aW9uLnN0YXRlLmhhbmRsZXJJbmZvczsKICAgICAgICB0cmFuc2l0aW9uLnRyaWdnZXIodHJ1ZSwgJ2Vycm9yJywgZSwgdHJhbnNpdGlvbiwgaW5mb3NbaW5mb3MubGVuZ3RoIC0gMV0uaGFuZGxlcik7CiAgICAgICAgdHJhbnNpdGlvbi5hYm9ydCgpOwogICAgICB9CgogICAgICB0aHJvdyBlOwogICAgfQogIH0KCiAgLyoqCiAgICBAcHJpdmF0ZQogIAogICAgQmVnaW5zIGFuZCByZXR1cm5zIGEgVHJhbnNpdGlvbiBiYXNlZCBvbiB0aGUgcHJvdmlkZWQKICAgIGFyZ3VtZW50cy4gQWNjZXB0cyBhcmd1bWVudHMgaW4gdGhlIGZvcm0gb2YgYm90aCBVUkwKICAgIHRyYW5zaXRpb25zIGFuZCBuYW1lZCB0cmFuc2l0aW9ucy4KICAKICAgIEBwYXJhbSB7Um91dGVyfSByb3V0ZXIKICAgIEBwYXJhbSB7QXJyYXlbT2JqZWN0XX0gYXJncyBhcmd1bWVudHMgcGFzc2VkIHRvIHRyYW5zaXRpb25UbywKICAgICAgcmVwbGFjZVdpdGgsIG9yIGhhbmRsZVVSTAogICovCiAgZnVuY3Rpb24gZG9UcmFuc2l0aW9uKHJvdXRlciwgYXJncywgaXNJbnRlcm1lZGlhdGUpIHsKICAgIC8vIE5vcm1hbGl6ZSBibGFuayB0cmFuc2l0aW9ucyB0byByb290IFVSTCB0cmFuc2l0aW9ucy4KICAgIHZhciBuYW1lID0gYXJnc1swXSB8fCAnLyc7CgogICAgdmFyIGxhc3RBcmcgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKICAgIGlmIChsYXN0QXJnICYmIGxhc3RBcmcuaGFzT3duUHJvcGVydHkoJ3F1ZXJ5UGFyYW1zJykpIHsKICAgICAgcXVlcnlQYXJhbXMgPSBwb3AuY2FsbChhcmdzKS5xdWVyeVBhcmFtczsKICAgIH0KCiAgICB2YXIgaW50ZW50OwogICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICAgIF9sb2cocm91dGVyLCAnVXBkYXRpbmcgcXVlcnkgcGFyYW1zJyk7CgogICAgICAvLyBBIHF1ZXJ5IHBhcmFtIHVwZGF0ZSBpcyByZWFsbHkganVzdCBhIHRyYW5zaXRpb24KICAgICAgLy8gaW50byB0aGUgcm91dGUgeW91J3JlIGFscmVhZHkgb24uCiAgICAgIHZhciBoYW5kbGVySW5mb3MgPSByb3V0ZXIuc3RhdGUuaGFuZGxlckluZm9zOwogICAgICBpbnRlbnQgPSBuZXcgTmFtZWRUcmFuc2l0aW9uSW50ZW50KHsKICAgICAgICBuYW1lOiBoYW5kbGVySW5mb3NbaGFuZGxlckluZm9zLmxlbmd0aCAtIDFdLm5hbWUsCiAgICAgICAgY29udGV4dHM6IFtdLAogICAgICAgIHF1ZXJ5UGFyYW1zOiBxdWVyeVBhcmFtcwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAobmFtZS5jaGFyQXQoMCkgPT09ICcvJykgewogICAgICBfbG9nKHJvdXRlciwgJ0F0dGVtcHRpbmcgVVJMIHRyYW5zaXRpb24gdG8gJyArIG5hbWUpOwogICAgICBpbnRlbnQgPSBuZXcgVVJMVHJhbnNpdGlvbkludGVudCh7IHVybDogbmFtZSB9KTsKICAgIH0gZWxzZSB7CiAgICAgIF9sb2cocm91dGVyLCAnQXR0ZW1wdGluZyB0cmFuc2l0aW9uIHRvICcgKyBuYW1lKTsKICAgICAgaW50ZW50ID0gbmV3IE5hbWVkVHJhbnNpdGlvbkludGVudCh7CiAgICAgICAgbmFtZTogYXJnc1swXSwKICAgICAgICBjb250ZXh0czogc2xpY2UuY2FsbChhcmdzLCAxKSwKICAgICAgICBxdWVyeVBhcmFtczogcXVlcnlQYXJhbXMKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHJvdXRlci50cmFuc2l0aW9uQnlJbnRlbnQoaW50ZW50LCBpc0ludGVybWVkaWF0ZSk7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVySW5mb3NFcXVhbChoYW5kbGVySW5mb3MsIG90aGVySGFuZGxlckluZm9zKSB7CiAgICBpZiAoaGFuZGxlckluZm9zLmxlbmd0aCAhPT0gb3RoZXJIYW5kbGVySW5mb3MubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaGFuZGxlckluZm9zLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChoYW5kbGVySW5mb3NbaV0gIT09IG90aGVySGFuZGxlckluZm9zW2ldKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZXJJbmZvc1NhbWVFeGNlcHRRdWVyeVBhcmFtcyhoYW5kbGVySW5mb3MsIG90aGVySGFuZGxlckluZm9zKSB7CiAgICBpZiAoaGFuZGxlckluZm9zLmxlbmd0aCAhPT0gb3RoZXJIYW5kbGVySW5mb3MubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaGFuZGxlckluZm9zLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChoYW5kbGVySW5mb3NbaV0ubmFtZSAhPT0gb3RoZXJIYW5kbGVySW5mb3NbaV0ubmFtZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCFwYXJhbXNFcXVhbChoYW5kbGVySW5mb3NbaV0ucGFyYW1zLCBvdGhlckhhbmRsZXJJbmZvc1tpXS5wYXJhbXMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIHBhcmFtc0VxdWFsKHBhcmFtcywgb3RoZXJQYXJhbXMpIHsKICAgIGlmICghcGFyYW1zICYmICFvdGhlclBhcmFtcykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoIXBhcmFtcyAmJiAhIW90aGVyUGFyYW1zIHx8ICEhcGFyYW1zICYmICFvdGhlclBhcmFtcykgewogICAgICAvLyBvbmUgaXMgZmFsc3kgYnV0IG90aGVyIGlzIG5vdDsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpOwogICAgdmFyIG90aGVyS2V5cyA9IE9iamVjdC5rZXlzKG90aGVyUGFyYW1zKTsKCiAgICBpZiAoa2V5cy5sZW5ndGggIT09IG90aGVyS2V5cy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBrZXlzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwoKICAgICAgaWYgKHBhcmFtc1trZXldICE9PSBvdGhlclBhcmFtc1trZXldKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBmaW5hbGl6ZVF1ZXJ5UGFyYW1DaGFuZ2Uocm91dGVyLCByZXNvbHZlZEhhbmRsZXJzLCBuZXdRdWVyeVBhcmFtcywgdHJhbnNpdGlvbikgewogICAgLy8gV2UgZmlyZSBhIGZpbmFsaXplUXVlcnlQYXJhbUNoYW5nZSBldmVudCB3aGljaAogICAgLy8gZ2l2ZXMgdGhlIG5ldyByb3V0ZSBoaWVyYXJjaHkgYSBjaGFuY2UgdG8gdGVsbAogICAgLy8gdXMgd2hpY2ggcXVlcnkgcGFyYW1zIGl0J3MgY29uc3VtaW5nIGFuZCB3aGF0CiAgICAvLyB0aGVpciBmaW5hbCB2YWx1ZXMgYXJlLiBJZiBhIHF1ZXJ5IHBhcmFtIGlzCiAgICAvLyBubyBsb25nZXIgY29uc3VtZWQgaW4gdGhlIGZpbmFsIHJvdXRlIGhpZXJhcmNoeSwKICAgIC8vIGl0cyBzZXJpYWxpemVkIHNlZ21lbnQgd2lsbCBiZSByZW1vdmVkCiAgICAvLyBmcm9tIHRoZSBVUkwuCgogICAgZm9yICh2YXIgayBpbiBuZXdRdWVyeVBhcmFtcykgewogICAgICBpZiAobmV3UXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoaykgJiYgbmV3UXVlcnlQYXJhbXNba10gPT09IG51bGwpIHsKICAgICAgICBkZWxldGUgbmV3UXVlcnlQYXJhbXNba107CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZmluYWxRdWVyeVBhcmFtc0FycmF5ID0gW107CiAgICBfdHJpZ2dlcihyb3V0ZXIsIHJlc29sdmVkSGFuZGxlcnMsIHRydWUsIFsnZmluYWxpemVRdWVyeVBhcmFtQ2hhbmdlJywgbmV3UXVlcnlQYXJhbXMsIGZpbmFsUXVlcnlQYXJhbXNBcnJheSwgdHJhbnNpdGlvbl0pOwoKICAgIGlmICh0cmFuc2l0aW9uKSB7CiAgICAgIHRyYW5zaXRpb24uX3Zpc2libGVRdWVyeVBhcmFtcyA9IHt9OwogICAgfQoKICAgIHZhciBmaW5hbFF1ZXJ5UGFyYW1zID0ge307CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gZmluYWxRdWVyeVBhcmFtc0FycmF5Lmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciBxcCA9IGZpbmFsUXVlcnlQYXJhbXNBcnJheVtpXTsKICAgICAgZmluYWxRdWVyeVBhcmFtc1txcC5rZXldID0gcXAudmFsdWU7CiAgICAgIGlmICh0cmFuc2l0aW9uICYmIHFwLnZpc2libGUgIT09IGZhbHNlKSB7CiAgICAgICAgdHJhbnNpdGlvbi5fdmlzaWJsZVF1ZXJ5UGFyYW1zW3FwLmtleV0gPSBxcC52YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZpbmFsUXVlcnlQYXJhbXM7CiAgfQoKICBmdW5jdGlvbiBub3RpZnlFeGlzdGluZ0hhbmRsZXJzKHJvdXRlciwgbmV3U3RhdGUsIG5ld1RyYW5zaXRpb24pIHsKICAgIHZhciBvbGRIYW5kbGVycyA9IHJvdXRlci5zdGF0ZS5oYW5kbGVySW5mb3MsCiAgICAgICAgaSwKICAgICAgICBvbGRIYW5kbGVyTGVuLAogICAgICAgIG9sZEhhbmRsZXIsCiAgICAgICAgbmV3SGFuZGxlcjsKCiAgICBvbGRIYW5kbGVyTGVuID0gb2xkSGFuZGxlcnMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IG9sZEhhbmRsZXJMZW47IGkrKykgewogICAgICBvbGRIYW5kbGVyID0gb2xkSGFuZGxlcnNbaV07CiAgICAgIG5ld0hhbmRsZXIgPSBuZXdTdGF0ZS5oYW5kbGVySW5mb3NbaV07CgogICAgICBpZiAoIW5ld0hhbmRsZXIgfHwgb2xkSGFuZGxlci5uYW1lICE9PSBuZXdIYW5kbGVyLm5hbWUpIHsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKCFuZXdIYW5kbGVyLmlzUmVzb2x2ZWQpIHt9CiAgICB9CgogICAgX3RyaWdnZXIocm91dGVyLCBvbGRIYW5kbGVycywgdHJ1ZSwgWyd3aWxsVHJhbnNpdGlvbicsIG5ld1RyYW5zaXRpb25dKTsKCiAgICBpZiAocm91dGVyLndpbGxUcmFuc2l0aW9uKSB7CiAgICAgIHJvdXRlci53aWxsVHJhbnNpdGlvbihvbGRIYW5kbGVycywgbmV3U3RhdGUuaGFuZGxlckluZm9zLCBuZXdUcmFuc2l0aW9uKTsKICAgIH0KICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IFJvdXRlcjsKICBleHBvcnRzLlRyYW5zaXRpb24gPSBUcmFuc2l0aW9uOwp9KTsKZW5pZmVkKCdyc3ZwJywgWydleHBvcnRzJywgJ2VtYmVyLWJhYmVsJywgJ25vZGUtbW9kdWxlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfZW1iZXJCYWJlbCwgX25vZGVNb2R1bGUpIHsKICAndXNlIHN0cmljdCc7CgogIGV4cG9ydHMuZmlsdGVyID0gZXhwb3J0cy5hc3luYyA9IGV4cG9ydHMubWFwID0gZXhwb3J0cy5yZWplY3QgPSBleHBvcnRzLnJlc29sdmUgPSBleHBvcnRzLm9mZiA9IGV4cG9ydHMub24gPSBleHBvcnRzLmNvbmZpZ3VyZSA9IGV4cG9ydHMuZGVub2RlaWZ5ID0gZXhwb3J0cy5kZWZlciA9IGV4cG9ydHMucmV0aHJvdyA9IGV4cG9ydHMuaGFzaFNldHRsZWQgPSBleHBvcnRzLmhhc2ggPSBleHBvcnRzLnJhY2UgPSBleHBvcnRzLmFsbFNldHRsZWQgPSBleHBvcnRzLmFsbCA9IGV4cG9ydHMuRXZlbnRUYXJnZXQgPSBleHBvcnRzLlByb21pc2UgPSBleHBvcnRzLmNhc3QgPSBleHBvcnRzLmFzYXAgPSB1bmRlZmluZWQ7CiAgZnVuY3Rpb24gY2FsbGJhY2tzRm9yKG9iamVjdCkgewogICAgdmFyIGNhbGxiYWNrcyA9IG9iamVjdC5fcHJvbWlzZUNhbGxiYWNrczsKCiAgICBpZiAoIWNhbGxiYWNrcykgewogICAgICBjYWxsYmFja3MgPSBvYmplY3QuX3Byb21pc2VDYWxsYmFja3MgPSB7fTsKICAgIH0KCiAgICByZXR1cm4gY2FsbGJhY2tzOwogIH0KCiAgLyoqCiAgICBAY2xhc3MgUlNWUC5FdmVudFRhcmdldAogICovCiAgdmFyIEV2ZW50VGFyZ2V0ID0gewogICAgbWl4aW46IGZ1bmN0aW9uIChvYmplY3QpIHsKICAgICAgb2JqZWN0Lm9uID0gdGhpcy5vbjsKICAgICAgb2JqZWN0Lm9mZiA9IHRoaXMub2ZmOwogICAgICBvYmplY3QudHJpZ2dlciA9IHRoaXMudHJpZ2dlcjsKICAgICAgb2JqZWN0Ll9wcm9taXNlQ2FsbGJhY2tzID0gdW5kZWZpbmVkOwogICAgICByZXR1cm4gb2JqZWN0OwogICAgfSwKICAgIG9uOiBmdW5jdGlvbiAoZXZlbnROYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2FsbGJhY2sgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIH0KCiAgICAgIHZhciBhbGxDYWxsYmFja3MgPSBjYWxsYmFja3NGb3IodGhpcyk7CiAgICAgIHZhciBjYWxsYmFja3MgPSBhbGxDYWxsYmFja3NbZXZlbnROYW1lXTsKCiAgICAgIGlmICghY2FsbGJhY2tzKSB7CiAgICAgICAgY2FsbGJhY2tzID0gYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV0gPSBbXTsKICAgICAgfQoKICAgICAgaWYgKGNhbGxiYWNrcy5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEpIHsKICAgICAgICBjYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgICBvZmY6IGZ1bmN0aW9uIChldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBhbGxDYWxsYmFja3MgPSBjYWxsYmFja3NGb3IodGhpcyk7CgogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgYWxsQ2FsbGJhY2tzW2V2ZW50TmFtZV0gPSBbXTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBjYWxsYmFja3MgPSBhbGxDYWxsYmFja3NbZXZlbnROYW1lXTsKICAgICAgdmFyIGluZGV4ID0gY2FsbGJhY2tzLmluZGV4T2YoY2FsbGJhY2spOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIGNhbGxiYWNrcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgdHJpZ2dlcjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgb3B0aW9ucywgbGFiZWwpIHsKICAgICAgdmFyIGFsbENhbGxiYWNrcyA9IGNhbGxiYWNrc0Zvcih0aGlzKTsKCiAgICAgIHZhciBjYWxsYmFja3MgPSBhbGxDYWxsYmFja3NbZXZlbnROYW1lXTsKICAgICAgaWYgKGNhbGxiYWNrcykgewogICAgICAgIC8vIERvbid0IGNhY2hlIHRoZSBjYWxsYmFja3MubGVuZ3RoIHNpbmNlIGl0IG1heSBncm93CiAgICAgICAgdmFyIGNhbGxiYWNrID0gdm9pZCAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgIGNhbGxiYWNrKG9wdGlvbnMsIGxhYmVsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgY29uZmlnID0gewogICAgaW5zdHJ1bWVudDogZmFsc2UKICB9OwoKICBFdmVudFRhcmdldFsnbWl4aW4nXShjb25maWcpOwoKICBmdW5jdGlvbiBjb25maWd1cmUobmFtZSwgdmFsdWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIGNvbmZpZ1tuYW1lXSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNvbmZpZ1tuYW1lXTsKICAgIH0KICB9CgogIHZhciBxdWV1ZSA9IFtdOwoKICBmdW5jdGlvbiBzY2hlZHVsZUZsdXNoKCkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZW50cnkgPSBxdWV1ZVtpXTsKCiAgICAgICAgdmFyIHBheWxvYWQgPSBlbnRyeS5wYXlsb2FkOwoKICAgICAgICBwYXlsb2FkLmd1aWQgPSBwYXlsb2FkLmtleSArIHBheWxvYWQuaWQ7CiAgICAgICAgcGF5bG9hZC5jaGlsZEd1aWQgPSBwYXlsb2FkLmtleSArIHBheWxvYWQuY2hpbGRJZDsKICAgICAgICBpZiAocGF5bG9hZC5lcnJvcikgewogICAgICAgICAgcGF5bG9hZC5zdGFjayA9IHBheWxvYWQuZXJyb3Iuc3RhY2s7CiAgICAgICAgfQoKICAgICAgICBjb25maWdbJ3RyaWdnZXInXShlbnRyeS5uYW1lLCBlbnRyeS5wYXlsb2FkKTsKICAgICAgfQogICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgfSwgNTApOwogIH0KCiAgZnVuY3Rpb24gaW5zdHJ1bWVudChldmVudE5hbWUsIHByb21pc2UsIGNoaWxkKSB7CiAgICBpZiAoMSA9PT0gcXVldWUucHVzaCh7CiAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgcGF5bG9hZDogewogICAgICAgIGtleTogcHJvbWlzZS5fZ3VpZEtleSwKICAgICAgICBpZDogcHJvbWlzZS5faWQsCiAgICAgICAgZXZlbnROYW1lOiBldmVudE5hbWUsCiAgICAgICAgZGV0YWlsOiBwcm9taXNlLl9yZXN1bHQsCiAgICAgICAgY2hpbGRJZDogY2hpbGQgJiYgY2hpbGQuX2lkLAogICAgICAgIGxhYmVsOiBwcm9taXNlLl9sYWJlbCwKICAgICAgICB0aW1lU3RhbXA6IERhdGUubm93KCksCiAgICAgICAgZXJyb3I6IGNvbmZpZ1siaW5zdHJ1bWVudC13aXRoLXN0YWNrIl0gPyBuZXcgRXJyb3IocHJvbWlzZS5fbGFiZWwpIDogbnVsbAogICAgICB9IH0pKSB7CiAgICAgIHNjaGVkdWxlRmx1c2goKTsKICAgIH0KICB9CgogIC8qKgogICAgYFJTVlAuUHJvbWlzZS5yZXNvbHZlYCByZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdpbGwgYmVjb21lIHJlc29sdmVkIHdpdGggdGhlCiAgICBwYXNzZWQgYHZhbHVlYC4gSXQgaXMgc2hvcnRoYW5kIGZvciB0aGUgZm9sbG93aW5nOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgIHJlc29sdmUoMSk7CiAgICB9KTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgIC8vIHZhbHVlID09PSAxCiAgICB9KTsKICAgIGBgYAogIAogICAgSW5zdGVhZCBvZiB3cml0aW5nIHRoZSBhYm92ZSwgeW91ciBjb2RlIG5vdyBzaW1wbHkgYmVjb21lcyB0aGUgZm9sbG93aW5nOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UgPSBSU1ZQLlByb21pc2UucmVzb2x2ZSgxKTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgIC8vIHZhbHVlID09PSAxCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCByZXNvbHZlCiAgICBAc3RhdGljCiAgICBAcGFyYW0geyp9IG9iamVjdCB2YWx1ZSB0aGF0IHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aAogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgIGB2YWx1ZWAKICAqLwogIGZ1bmN0aW9uIHJlc29sdmUkJDEob2JqZWN0LCBsYWJlbCkgewogICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi8KICAgIHZhciBDb25zdHJ1Y3RvciA9IHRoaXM7CgogICAgaWYgKG9iamVjdCAmJiB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyAmJiBvYmplY3QuY29uc3RydWN0b3IgPT09IENvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwogICAgcmVzb2x2ZSQxKHByb21pc2UsIG9iamVjdCk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CgogIGZ1bmN0aW9uIHdpdGhPd25Qcm9taXNlKCkgewogICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoJ0EgcHJvbWlzZXMgY2FsbGJhY2sgY2Fubm90IHJldHVybiB0aGF0IHNhbWUgcHJvbWlzZS4nKTsKICB9CgogIGZ1bmN0aW9uIG9iamVjdE9yRnVuY3Rpb24oeCkgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgeDsKICAgIHJldHVybiB4ICE9PSBudWxsICYmICh0eXBlID09PSAnb2JqZWN0JyB8fCB0eXBlID09PSAnZnVuY3Rpb24nKTsKICB9CgogIGZ1bmN0aW9uIG5vb3AoKSB7fQoKICB2YXIgUEVORElORyA9IHZvaWQgMDsKICB2YXIgRlVMRklMTEVEID0gMTsKICB2YXIgUkVKRUNURUQgPSAyOwoKICB2YXIgVFJZX0NBVENIX0VSUk9SID0geyBlcnJvcjogbnVsbCB9OwoKICBmdW5jdGlvbiBnZXRUaGVuKHByb21pc2UpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBwcm9taXNlLnRoZW47CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBlcnJvcjsKICAgICAgcmV0dXJuIFRSWV9DQVRDSF9FUlJPUjsKICAgIH0KICB9CgogIHZhciB0cnlDYXRjaENhbGxiYWNrID0gdm9pZCAwOwogIGZ1bmN0aW9uIHRyeUNhdGNoZXIoKSB7CiAgICB0cnkgewogICAgICB2YXIgdGFyZ2V0ID0gdHJ5Q2F0Y2hDYWxsYmFjazsKICAgICAgdHJ5Q2F0Y2hDYWxsYmFjayA9IG51bGw7CiAgICAgIHJldHVybiB0YXJnZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgVFJZX0NBVENIX0VSUk9SLmVycm9yID0gZTsKICAgICAgcmV0dXJuIFRSWV9DQVRDSF9FUlJPUjsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRyeUNhdGNoKGZuKSB7CiAgICB0cnlDYXRjaENhbGxiYWNrID0gZm47CiAgICByZXR1cm4gdHJ5Q2F0Y2hlcjsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZUZvcmVpZ25UaGVuYWJsZShwcm9taXNlLCB0aGVuYWJsZSwgdGhlbiQkMSkgewogICAgY29uZmlnLmFzeW5jKGZ1bmN0aW9uIChwcm9taXNlKSB7CiAgICAgIHZhciBzZWFsZWQgPSBmYWxzZTsKICAgICAgdmFyIHJlc3VsdCA9IHRyeUNhdGNoKHRoZW4kJDEpLmNhbGwodGhlbmFibGUsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmIChzZWFsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgc2VhbGVkID0gdHJ1ZTsKICAgICAgICBpZiAodGhlbmFibGUgPT09IHZhbHVlKSB7CiAgICAgICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZSQxKHByb21pc2UsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICBpZiAoc2VhbGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHNlYWxlZCA9IHRydWU7CgogICAgICAgIHJlamVjdChwcm9taXNlLCByZWFzb24pOwogICAgICB9LCAnU2V0dGxlOiAnICsgKHByb21pc2UuX2xhYmVsIHx8ICcgdW5rbm93biBwcm9taXNlJykpOwoKICAgICAgaWYgKCFzZWFsZWQgJiYgcmVzdWx0ID09PSBUUllfQ0FUQ0hfRVJST1IpIHsKICAgICAgICBzZWFsZWQgPSB0cnVlOwogICAgICAgIHZhciBlcnJvciA9IFRSWV9DQVRDSF9FUlJPUi5lcnJvcjsKICAgICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBudWxsOwogICAgICAgIHJlamVjdChwcm9taXNlLCBlcnJvcik7CiAgICAgIH0KICAgIH0sIHByb21pc2UpOwogIH0KCiAgZnVuY3Rpb24gaGFuZGxlT3duVGhlbmFibGUocHJvbWlzZSwgdGhlbmFibGUpIHsKICAgIGlmICh0aGVuYWJsZS5fc3RhdGUgPT09IEZVTEZJTExFRCkgewogICAgICBmdWxmaWxsKHByb21pc2UsIHRoZW5hYmxlLl9yZXN1bHQpOwogICAgfSBlbHNlIGlmICh0aGVuYWJsZS5fc3RhdGUgPT09IFJFSkVDVEVEKSB7CiAgICAgIHRoZW5hYmxlLl9vbkVycm9yID0gbnVsbDsKICAgICAgcmVqZWN0KHByb21pc2UsIHRoZW5hYmxlLl9yZXN1bHQpOwogICAgfSBlbHNlIHsKICAgICAgc3Vic2NyaWJlKHRoZW5hYmxlLCB1bmRlZmluZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh0aGVuYWJsZSA9PT0gdmFsdWUpIHsKICAgICAgICAgIGZ1bGZpbGwocHJvbWlzZSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlJDEocHJvbWlzZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHJldHVybiByZWplY3QocHJvbWlzZSwgcmVhc29uKTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVNYXliZVRoZW5hYmxlKHByb21pc2UsIG1heWJlVGhlbmFibGUsIHRoZW4kJDEpIHsKICAgIHZhciBpc093blRoZW5hYmxlID0gbWF5YmVUaGVuYWJsZS5jb25zdHJ1Y3RvciA9PT0gcHJvbWlzZS5jb25zdHJ1Y3RvciAmJiB0aGVuJCQxID09PSB0aGVuICYmIHByb21pc2UuY29uc3RydWN0b3IucmVzb2x2ZSA9PT0gcmVzb2x2ZSQkMTsKCiAgICBpZiAoaXNPd25UaGVuYWJsZSkgewogICAgICBoYW5kbGVPd25UaGVuYWJsZShwcm9taXNlLCBtYXliZVRoZW5hYmxlKTsKICAgIH0gZWxzZSBpZiAodGhlbiQkMSA9PT0gVFJZX0NBVENIX0VSUk9SKSB7CiAgICAgIHZhciBlcnJvciA9IFRSWV9DQVRDSF9FUlJPUi5lcnJvcjsKICAgICAgVFJZX0NBVENIX0VSUk9SLmVycm9yID0gbnVsbDsKICAgICAgcmVqZWN0KHByb21pc2UsIGVycm9yKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoZW4kJDEgPT09ICdmdW5jdGlvbicpIHsKICAgICAgaGFuZGxlRm9yZWlnblRoZW5hYmxlKHByb21pc2UsIG1heWJlVGhlbmFibGUsIHRoZW4kJDEpOwogICAgfSBlbHNlIHsKICAgICAgZnVsZmlsbChwcm9taXNlLCBtYXliZVRoZW5hYmxlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc29sdmUkMShwcm9taXNlLCB2YWx1ZSkgewogICAgaWYgKHByb21pc2UgPT09IHZhbHVlKSB7CiAgICAgIGZ1bGZpbGwocHJvbWlzZSwgdmFsdWUpOwogICAgfSBlbHNlIGlmIChvYmplY3RPckZ1bmN0aW9uKHZhbHVlKSkgewogICAgICBoYW5kbGVNYXliZVRoZW5hYmxlKHByb21pc2UsIHZhbHVlLCBnZXRUaGVuKHZhbHVlKSk7CiAgICB9IGVsc2UgewogICAgICBmdWxmaWxsKHByb21pc2UsIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHB1Ymxpc2hSZWplY3Rpb24ocHJvbWlzZSkgewogICAgaWYgKHByb21pc2UuX29uRXJyb3IpIHsKICAgICAgcHJvbWlzZS5fb25FcnJvcihwcm9taXNlLl9yZXN1bHQpOwogICAgfQoKICAgIHB1Ymxpc2gocHJvbWlzZSk7CiAgfQoKICBmdW5jdGlvbiBmdWxmaWxsKHByb21pc2UsIHZhbHVlKSB7CiAgICBpZiAocHJvbWlzZS5fc3RhdGUgIT09IFBFTkRJTkcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UuX3Jlc3VsdCA9IHZhbHVlOwogICAgcHJvbWlzZS5fc3RhdGUgPSBGVUxGSUxMRUQ7CgogICAgaWYgKHByb21pc2UuX3N1YnNjcmliZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoY29uZmlnLmluc3RydW1lbnQpIHsKICAgICAgICBpbnN0cnVtZW50KCdmdWxmaWxsZWQnLCBwcm9taXNlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uZmlnLmFzeW5jKHB1Ymxpc2gsIHByb21pc2UpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVqZWN0KHByb21pc2UsIHJlYXNvbikgewogICAgaWYgKHByb21pc2UuX3N0YXRlICE9PSBQRU5ESU5HKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHByb21pc2UuX3N0YXRlID0gUkVKRUNURUQ7CiAgICBwcm9taXNlLl9yZXN1bHQgPSByZWFzb247CiAgICBjb25maWcuYXN5bmMocHVibGlzaFJlamVjdGlvbiwgcHJvbWlzZSk7CiAgfQoKICBmdW5jdGlvbiBzdWJzY3JpYmUocGFyZW50LCBjaGlsZCwgb25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24pIHsKICAgIHZhciBzdWJzY3JpYmVycyA9IHBhcmVudC5fc3Vic2NyaWJlcnM7CiAgICB2YXIgbGVuZ3RoID0gc3Vic2NyaWJlcnMubGVuZ3RoOwoKICAgIHBhcmVudC5fb25FcnJvciA9IG51bGw7CgogICAgc3Vic2NyaWJlcnNbbGVuZ3RoXSA9IGNoaWxkOwogICAgc3Vic2NyaWJlcnNbbGVuZ3RoICsgRlVMRklMTEVEXSA9IG9uRnVsZmlsbG1lbnQ7CiAgICBzdWJzY3JpYmVyc1tsZW5ndGggKyBSRUpFQ1RFRF0gPSBvblJlamVjdGlvbjsKCiAgICBpZiAobGVuZ3RoID09PSAwICYmIHBhcmVudC5fc3RhdGUpIHsKICAgICAgY29uZmlnLmFzeW5jKHB1Ymxpc2gsIHBhcmVudCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwdWJsaXNoKHByb21pc2UpIHsKICAgIHZhciBzdWJzY3JpYmVycyA9IHByb21pc2UuX3N1YnNjcmliZXJzOwogICAgdmFyIHNldHRsZWQgPSBwcm9taXNlLl9zdGF0ZTsKCiAgICBpZiAoY29uZmlnLmluc3RydW1lbnQpIHsKICAgICAgaW5zdHJ1bWVudChzZXR0bGVkID09PSBGVUxGSUxMRUQgPyAnZnVsZmlsbGVkJyA6ICdyZWplY3RlZCcsIHByb21pc2UpOwogICAgfQoKICAgIGlmIChzdWJzY3JpYmVycy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBjaGlsZCA9IHZvaWQgMCwKICAgICAgICBjYWxsYmFjayA9IHZvaWQgMCwKICAgICAgICByZXN1bHQgPSBwcm9taXNlLl9yZXN1bHQ7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdWJzY3JpYmVycy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjaGlsZCA9IHN1YnNjcmliZXJzW2ldOwogICAgICBjYWxsYmFjayA9IHN1YnNjcmliZXJzW2kgKyBzZXR0bGVkXTsKCiAgICAgIGlmIChjaGlsZCkgewogICAgICAgIGludm9rZUNhbGxiYWNrKHNldHRsZWQsIGNoaWxkLCBjYWxsYmFjaywgcmVzdWx0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwogICAgICB9CiAgICB9CgogICAgcHJvbWlzZS5fc3Vic2NyaWJlcnMubGVuZ3RoID0gMDsKICB9CgogIGZ1bmN0aW9uIGludm9rZUNhbGxiYWNrKHN0YXRlLCBwcm9taXNlLCBjYWxsYmFjaywgcmVzdWx0KSB7CiAgICB2YXIgaGFzQ2FsbGJhY2sgPSB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbic7CiAgICB2YXIgdmFsdWUgPSB2b2lkIDA7CgogICAgaWYgKGhhc0NhbGxiYWNrKSB7CiAgICAgIHZhbHVlID0gdHJ5Q2F0Y2goY2FsbGJhY2spKHJlc3VsdCk7CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IHJlc3VsdDsKICAgIH0KCiAgICBpZiAocHJvbWlzZS5fc3RhdGUgIT09IFBFTkRJTkcpIHsKICAgICAgLy8gbm9vcAogICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gcHJvbWlzZSkgewogICAgICByZWplY3QocHJvbWlzZSwgd2l0aE93blByb21pc2UoKSk7CiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBUUllfQ0FUQ0hfRVJST1IpIHsKICAgICAgdmFyIGVycm9yID0gVFJZX0NBVENIX0VSUk9SLmVycm9yOwogICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBudWxsOyAvLyByZWxlYXNlCiAgICAgIHJlamVjdChwcm9taXNlLCBlcnJvcik7CiAgICB9IGVsc2UgaWYgKGhhc0NhbGxiYWNrKSB7CiAgICAgIHJlc29sdmUkMShwcm9taXNlLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKHN0YXRlID09PSBGVUxGSUxMRUQpIHsKICAgICAgZnVsZmlsbChwcm9taXNlLCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKHN0YXRlID09PSBSRUpFQ1RFRCkgewogICAgICByZWplY3QocHJvbWlzZSwgdmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdGlhbGl6ZVByb21pc2UocHJvbWlzZSwgcmVzb2x2ZXIpIHsKICAgIHZhciByZXNvbHZlZCA9IGZhbHNlOwogICAgdHJ5IHsKICAgICAgcmVzb2x2ZXIoZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgICByZXNvbHZlJDEocHJvbWlzZSwgdmFsdWUpOwogICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgICByZWplY3QocHJvbWlzZSwgcmVhc29uKTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJlamVjdChwcm9taXNlLCBlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24sIGxhYmVsKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHBhcmVudC5fc3RhdGU7CgogICAgaWYgKHN0YXRlID09PSBGVUxGSUxMRUQgJiYgIW9uRnVsZmlsbG1lbnQgfHwgc3RhdGUgPT09IFJFSkVDVEVEICYmICFvblJlamVjdGlvbikgewogICAgICBjb25maWcuaW5zdHJ1bWVudCAmJiBpbnN0cnVtZW50KCdjaGFpbmVkJywgcGFyZW50LCBwYXJlbnQpOwogICAgICByZXR1cm4gcGFyZW50OwogICAgfQoKICAgIHBhcmVudC5fb25FcnJvciA9IG51bGw7CgogICAgdmFyIGNoaWxkID0gbmV3IHBhcmVudC5jb25zdHJ1Y3Rvcihub29wLCBsYWJlbCk7CiAgICB2YXIgcmVzdWx0ID0gcGFyZW50Ll9yZXN1bHQ7CgogICAgY29uZmlnLmluc3RydW1lbnQgJiYgaW5zdHJ1bWVudCgnY2hhaW5lZCcsIHBhcmVudCwgY2hpbGQpOwoKICAgIGlmIChzdGF0ZSA9PT0gUEVORElORykgewogICAgICBzdWJzY3JpYmUocGFyZW50LCBjaGlsZCwgb25GdWxmaWxsbWVudCwgb25SZWplY3Rpb24pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNhbGxiYWNrID0gc3RhdGUgPT09IEZVTEZJTExFRCA/IG9uRnVsZmlsbG1lbnQgOiBvblJlamVjdGlvbjsKICAgICAgY29uZmlnLmFzeW5jKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gaW52b2tlQ2FsbGJhY2soc3RhdGUsIGNoaWxkLCBjYWxsYmFjaywgcmVzdWx0KTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGNoaWxkOwogIH0KCiAgdmFyIEVudW1lcmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFbnVtZXJhdG9yKENvbnN0cnVjdG9yLCBpbnB1dCwgYWJvcnRPblJlamVjdCwgbGFiZWwpIHsKICAgICAgKDAsIF9lbWJlckJhYmVsLmNsYXNzQ2FsbENoZWNrKSh0aGlzLCBFbnVtZXJhdG9yKTsKCiAgICAgIHRoaXMuX2luc3RhbmNlQ29uc3RydWN0b3IgPSBDb25zdHJ1Y3RvcjsKICAgICAgdGhpcy5wcm9taXNlID0gbmV3IENvbnN0cnVjdG9yKG5vb3AsIGxhYmVsKTsKICAgICAgdGhpcy5fYWJvcnRPblJlamVjdCA9IGFib3J0T25SZWplY3Q7CiAgICAgIHRoaXMuX2lzVXNpbmdPd25Qcm9taXNlID0gQ29uc3RydWN0b3IgPT09IFByb21pc2U7CiAgICAgIHRoaXMuX2lzVXNpbmdPd25SZXNvbHZlID0gQ29uc3RydWN0b3IucmVzb2x2ZSA9PT0gcmVzb2x2ZSQkMTsKCiAgICAgIHRoaXMuX2luaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgICBFbnVtZXJhdG9yLnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIF9pbml0KENvbnN0cnVjdG9yLCBpbnB1dCkgewogICAgICB2YXIgbGVuID0gaW5wdXQubGVuZ3RoIHx8IDA7CiAgICAgIHRoaXMubGVuZ3RoID0gbGVuOwogICAgICB0aGlzLl9yZW1haW5pbmcgPSBsZW47CiAgICAgIHRoaXMuX3Jlc3VsdCA9IG5ldyBBcnJheShsZW4pOwoKICAgICAgdGhpcy5fZW51bWVyYXRlKGlucHV0KTsKICAgIH07CgogICAgRW51bWVyYXRvci5wcm90b3R5cGUuX2VudW1lcmF0ZSA9IGZ1bmN0aW9uIF9lbnVtZXJhdGUoaW5wdXQpIHsKICAgICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwogICAgICB2YXIgcHJvbWlzZSA9IHRoaXMucHJvbWlzZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBwcm9taXNlLl9zdGF0ZSA9PT0gUEVORElORyAmJiBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9lYWNoRW50cnkoaW5wdXRbaV0sIGksIHRydWUpOwogICAgICB9CiAgICAgIHRoaXMuX2NoZWNrRnVsbGZpbGxtZW50KCk7CiAgICB9OwoKICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl9jaGVja0Z1bGxmaWxsbWVudCA9IGZ1bmN0aW9uIF9jaGVja0Z1bGxmaWxsbWVudCgpIHsKICAgICAgaWYgKHRoaXMuX3JlbWFpbmluZyA9PT0gMCkgewogICAgICAgIHZhciByZXN1bHQgPSB0aGlzLl9yZXN1bHQ7CiAgICAgICAgZnVsZmlsbCh0aGlzLnByb21pc2UsIHJlc3VsdCk7CiAgICAgICAgdGhpcy5fcmVzdWx0ID0gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBFbnVtZXJhdG9yLnByb3RvdHlwZS5fc2V0dGxlTWF5YmVUaGVuYWJsZSA9IGZ1bmN0aW9uIF9zZXR0bGVNYXliZVRoZW5hYmxlKGVudHJ5LCBpLCBmaXJzdFBhc3MpIHsKICAgICAgdmFyIGMgPSB0aGlzLl9pbnN0YW5jZUNvbnN0cnVjdG9yOwoKICAgICAgaWYgKHRoaXMuX2lzVXNpbmdPd25SZXNvbHZlKSB7CiAgICAgICAgdmFyIHRoZW4kJDEgPSBnZXRUaGVuKGVudHJ5KTsKCiAgICAgICAgaWYgKHRoZW4kJDEgPT09IHRoZW4gJiYgZW50cnkuX3N0YXRlICE9PSBQRU5ESU5HKSB7CiAgICAgICAgICBlbnRyeS5fb25FcnJvciA9IG51bGw7CiAgICAgICAgICB0aGlzLl9zZXR0bGVkQXQoZW50cnkuX3N0YXRlLCBpLCBlbnRyeS5fcmVzdWx0LCBmaXJzdFBhc3MpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoZW4kJDEgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXMuX3NldHRsZWRBdChGVUxGSUxMRUQsIGksIGVudHJ5LCBmaXJzdFBhc3MpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faXNVc2luZ093blByb21pc2UpIHsKICAgICAgICAgIHZhciBwcm9taXNlID0gbmV3IGMobm9vcCk7CiAgICAgICAgICBoYW5kbGVNYXliZVRoZW5hYmxlKHByb21pc2UsIGVudHJ5LCB0aGVuJCQxKTsKICAgICAgICAgIHRoaXMuX3dpbGxTZXR0bGVBdChwcm9taXNlLCBpLCBmaXJzdFBhc3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl93aWxsU2V0dGxlQXQobmV3IGMoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZW50cnkpOwogICAgICAgICAgfSksIGksIGZpcnN0UGFzcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3dpbGxTZXR0bGVBdChjLnJlc29sdmUoZW50cnkpLCBpLCBmaXJzdFBhc3MpOwogICAgICB9CiAgICB9OwoKICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl9lYWNoRW50cnkgPSBmdW5jdGlvbiBfZWFjaEVudHJ5KGVudHJ5LCBpLCBmaXJzdFBhc3MpIHsKICAgICAgaWYgKGVudHJ5ICE9PSBudWxsICYmIHR5cGVvZiBlbnRyeSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB0aGlzLl9zZXR0bGVNYXliZVRoZW5hYmxlKGVudHJ5LCBpLCBmaXJzdFBhc3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3NldFJlc3VsdEF0KEZVTEZJTExFRCwgaSwgZW50cnksIGZpcnN0UGFzcyk7CiAgICAgIH0KICAgIH07CgogICAgRW51bWVyYXRvci5wcm90b3R5cGUuX3NldHRsZWRBdCA9IGZ1bmN0aW9uIF9zZXR0bGVkQXQoc3RhdGUsIGksIHZhbHVlLCBmaXJzdFBhc3MpIHsKICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CgogICAgICBpZiAocHJvbWlzZS5fc3RhdGUgPT09IFBFTkRJTkcpIHsKICAgICAgICBpZiAodGhpcy5fYWJvcnRPblJlamVjdCAmJiBzdGF0ZSA9PT0gUkVKRUNURUQpIHsKICAgICAgICAgIHJlamVjdChwcm9taXNlLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3NldFJlc3VsdEF0KHN0YXRlLCBpLCB2YWx1ZSwgZmlyc3RQYXNzKTsKICAgICAgICAgIHRoaXMuX2NoZWNrRnVsbGZpbGxtZW50KCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl9zZXRSZXN1bHRBdCA9IGZ1bmN0aW9uIF9zZXRSZXN1bHRBdChzdGF0ZSwgaSwgdmFsdWUsIGZpcnN0UGFzcykgewogICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgdGhpcy5fcmVzdWx0W2ldID0gdmFsdWU7CiAgICB9OwoKICAgIEVudW1lcmF0b3IucHJvdG90eXBlLl93aWxsU2V0dGxlQXQgPSBmdW5jdGlvbiBfd2lsbFNldHRsZUF0KHByb21pc2UsIGksIGZpcnN0UGFzcykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgc3Vic2NyaWJlKHByb21pc2UsIHVuZGVmaW5lZCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIF90aGlzLl9zZXR0bGVkQXQoRlVMRklMTEVELCBpLCB2YWx1ZSwgZmlyc3RQYXNzKTsKICAgICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHJldHVybiBfdGhpcy5fc2V0dGxlZEF0KFJFSkVDVEVELCBpLCByZWFzb24sIGZpcnN0UGFzcyk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gRW51bWVyYXRvcjsKICB9KCk7CgogIGZ1bmN0aW9uIHNldFNldHRsZWRSZXN1bHQoc3RhdGUsIGksIHZhbHVlKSB7CiAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgIGlmIChzdGF0ZSA9PT0gRlVMRklMTEVEKSB7CiAgICAgIHRoaXMuX3Jlc3VsdFtpXSA9IHsKICAgICAgICBzdGF0ZTogJ2Z1bGZpbGxlZCcsCiAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9yZXN1bHRbaV0gPSB7CiAgICAgICAgc3RhdGU6ICdyZWplY3RlZCcsCiAgICAgICAgcmVhc29uOiB2YWx1ZQogICAgICB9OwogICAgfQogIH0KCiAgLyoqCiAgICBgUlNWUC5Qcm9taXNlLmFsbGAgYWNjZXB0cyBhbiBhcnJheSBvZiBwcm9taXNlcywgYW5kIHJldHVybnMgYSBuZXcgcHJvbWlzZSB3aGljaAogICAgaXMgZnVsZmlsbGVkIHdpdGggYW4gYXJyYXkgb2YgZnVsZmlsbG1lbnQgdmFsdWVzIGZvciB0aGUgcGFzc2VkIHByb21pc2VzLCBvcgogICAgcmVqZWN0ZWQgd2l0aCB0aGUgcmVhc29uIG9mIHRoZSBmaXJzdCBwYXNzZWQgcHJvbWlzZSB0byBiZSByZWplY3RlZC4gSXQgY2FzdHMgYWxsCiAgICBlbGVtZW50cyBvZiB0aGUgcGFzc2VkIGl0ZXJhYmxlIHRvIHByb21pc2VzIGFzIGl0IHJ1bnMgdGhpcyBhbGdvcml0aG0uCiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UxID0gUlNWUC5yZXNvbHZlKDEpOwogICAgbGV0IHByb21pc2UyID0gUlNWUC5yZXNvbHZlKDIpOwogICAgbGV0IHByb21pc2UzID0gUlNWUC5yZXNvbHZlKDMpOwogICAgbGV0IHByb21pc2VzID0gWyBwcm9taXNlMSwgcHJvbWlzZTIsIHByb21pc2UzIF07CiAgCiAgICBSU1ZQLlByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGFycmF5KXsKICAgICAgLy8gVGhlIGFycmF5IGhlcmUgd291bGQgYmUgWyAxLCAyLCAzIF07CiAgICB9KTsKICAgIGBgYAogIAogICAgSWYgYW55IG9mIHRoZSBgcHJvbWlzZXNgIGdpdmVuIHRvIGBSU1ZQLmFsbGAgYXJlIHJlamVjdGVkLCB0aGUgZmlyc3QgcHJvbWlzZQogICAgdGhhdCBpcyByZWplY3RlZCB3aWxsIGJlIGdpdmVuIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSByZXR1cm5lZCBwcm9taXNlcydzCiAgICByZWplY3Rpb24gaGFuZGxlci4gRm9yIGV4YW1wbGU6CiAgCiAgICBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UxID0gUlNWUC5yZXNvbHZlKDEpOwogICAgbGV0IHByb21pc2UyID0gUlNWUC5yZWplY3QobmV3IEVycm9yKCIyIikpOwogICAgbGV0IHByb21pc2UzID0gUlNWUC5yZWplY3QobmV3IEVycm9yKCIzIikpOwogICAgbGV0IHByb21pc2VzID0gWyBwcm9taXNlMSwgcHJvbWlzZTIsIHByb21pc2UzIF07CiAgCiAgICBSU1ZQLlByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGFycmF5KXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAvLyBlcnJvci5tZXNzYWdlID09PSAiMiIKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGFsbAogICAgQHN0YXRpYwogICAgQHBhcmFtIHtBcnJheX0gZW50cmllcyBhcnJheSBvZiBwcm9taXNlcwogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIGBwcm9taXNlc2AgaGF2ZSBiZWVuCiAgICBmdWxmaWxsZWQsIG9yIHJlamVjdGVkIGlmIGFueSBvZiB0aGVtIGJlY29tZSByZWplY3RlZC4KICAgIEBzdGF0aWMKICAqLwogIGZ1bmN0aW9uIGFsbChlbnRyaWVzLCBsYWJlbCkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KGVudHJpZXMpKSB7CiAgICAgIHJldHVybiB0aGlzLnJlamVjdChuZXcgVHlwZUVycm9yKCJQcm9taXNlLmFsbCBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIGFycmF5IiksIGxhYmVsKTsKICAgIH0KICAgIHJldHVybiBuZXcgRW51bWVyYXRvcih0aGlzLCBlbnRyaWVzLCB0cnVlIC8qIGFib3J0IG9uIHJlamVjdCAqLywgbGFiZWwpLnByb21pc2U7CiAgfQoKICAvKioKICAgIGBSU1ZQLlByb21pc2UucmFjZWAgcmV0dXJucyBhIG5ldyBwcm9taXNlIHdoaWNoIGlzIHNldHRsZWQgaW4gdGhlIHNhbWUgd2F5IGFzIHRoZQogICAgZmlyc3QgcGFzc2VkIHByb21pc2UgdG8gc2V0dGxlLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlMSA9IG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHJlc29sdmUoJ3Byb21pc2UgMScpOwogICAgICB9LCAyMDApOwogICAgfSk7CiAgCiAgICBsZXQgcHJvbWlzZTIgPSBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICByZXNvbHZlKCdwcm9taXNlIDInKTsKICAgICAgfSwgMTAwKTsKICAgIH0pOwogIAogICAgUlNWUC5Qcm9taXNlLnJhY2UoW3Byb21pc2UxLCBwcm9taXNlMl0pLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgLy8gcmVzdWx0ID09PSAncHJvbWlzZSAyJyBiZWNhdXNlIGl0IHdhcyByZXNvbHZlZCBiZWZvcmUgcHJvbWlzZTEKICAgICAgLy8gd2FzIHJlc29sdmVkLgogICAgfSk7CiAgICBgYGAKICAKICAgIGBSU1ZQLlByb21pc2UucmFjZWAgaXMgZGV0ZXJtaW5pc3RpYyBpbiB0aGF0IG9ubHkgdGhlIHN0YXRlIG9mIHRoZSBmaXJzdAogICAgc2V0dGxlZCBwcm9taXNlIG1hdHRlcnMuIEZvciBleGFtcGxlLCBldmVuIGlmIG90aGVyIHByb21pc2VzIGdpdmVuIHRvIHRoZQogICAgYHByb21pc2VzYCBhcnJheSBhcmd1bWVudCBhcmUgcmVzb2x2ZWQsIGJ1dCB0aGUgZmlyc3Qgc2V0dGxlZCBwcm9taXNlIGhhcwogICAgYmVjb21lIHJlamVjdGVkIGJlZm9yZSB0aGUgb3RoZXIgcHJvbWlzZXMgYmVjYW1lIGZ1bGZpbGxlZCwgdGhlIHJldHVybmVkCiAgICBwcm9taXNlIHdpbGwgYmVjb21lIHJlamVjdGVkOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UxID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgcmVzb2x2ZSgncHJvbWlzZSAxJyk7CiAgICAgIH0sIDIwMCk7CiAgICB9KTsKICAKICAgIGxldCBwcm9taXNlMiA9IG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ3Byb21pc2UgMicpKTsKICAgICAgfSwgMTAwKTsKICAgIH0pOwogIAogICAgUlNWUC5Qcm9taXNlLnJhY2UoW3Byb21pc2UxLCBwcm9taXNlMl0pLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgIC8vIHJlYXNvbi5tZXNzYWdlID09PSAncHJvbWlzZSAyJyBiZWNhdXNlIHByb21pc2UgMiBiZWNhbWUgcmVqZWN0ZWQgYmVmb3JlCiAgICAgIC8vIHByb21pc2UgMSBiZWNhbWUgZnVsZmlsbGVkCiAgICB9KTsKICAgIGBgYAogIAogICAgQW4gZXhhbXBsZSByZWFsLXdvcmxkIHVzZSBjYXNlIGlzIGltcGxlbWVudGluZyB0aW1lb3V0czoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIFJTVlAuUHJvbWlzZS5yYWNlKFthamF4KCdmb28uanNvbicpLCB0aW1lb3V0KDUwMDApXSkKICAgIGBgYAogIAogICAgQG1ldGhvZCByYWNlCiAgICBAc3RhdGljCiAgICBAcGFyYW0ge0FycmF5fSBlbnRyaWVzIGFycmF5IG9mIHByb21pc2VzIHRvIG9ic2VydmUKICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgZm9yIGRlc2NyaWJpbmcgdGhlIHByb21pc2UgcmV0dXJuZWQuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2Ugd2hpY2ggc2V0dGxlcyBpbiB0aGUgc2FtZSB3YXkgYXMgdGhlIGZpcnN0IHBhc3NlZAogICAgcHJvbWlzZSB0byBzZXR0bGUuCiAgKi8KICBmdW5jdGlvbiByYWNlKGVudHJpZXMsIGxhYmVsKSB7CiAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqLwogICAgdmFyIENvbnN0cnVjdG9yID0gdGhpczsKCiAgICB2YXIgcHJvbWlzZSA9IG5ldyBDb25zdHJ1Y3Rvcihub29wLCBsYWJlbCk7CgogICAgaWYgKCFBcnJheS5pc0FycmF5KGVudHJpZXMpKSB7CiAgICAgIHJlamVjdChwcm9taXNlLCBuZXcgVHlwZUVycm9yKCdQcm9taXNlLnJhY2UgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBhcnJheScpKTsKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IHByb21pc2UuX3N0YXRlID09PSBQRU5ESU5HICYmIGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHN1YnNjcmliZShDb25zdHJ1Y3Rvci5yZXNvbHZlKGVudHJpZXNbaV0pLCB1bmRlZmluZWQsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHJldHVybiByZXNvbHZlJDEocHJvbWlzZSwgdmFsdWUpOwogICAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgcmV0dXJuIHJlamVjdChwcm9taXNlLCByZWFzb24pOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gcHJvbWlzZTsKICB9CgogIC8qKgogICAgYFJTVlAuUHJvbWlzZS5yZWplY3RgIHJldHVybnMgYSBwcm9taXNlIHJlamVjdGVkIHdpdGggdGhlIHBhc3NlZCBgcmVhc29uYC4KICAgIEl0IGlzIHNob3J0aGFuZCBmb3IgdGhlIGZvbGxvd2luZzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlID0gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpewogICAgICByZWplY3QobmV3IEVycm9yKCdXSE9PUFMnKSk7CiAgICB9KTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgIC8vIENvZGUgaGVyZSBkb2Vzbid0IHJ1biBiZWNhdXNlIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkIQogICAgfSwgZnVuY3Rpb24ocmVhc29uKXsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICdXSE9PUFMnCiAgICB9KTsKICAgIGBgYAogIAogICAgSW5zdGVhZCBvZiB3cml0aW5nIHRoZSBhYm92ZSwgeW91ciBjb2RlIG5vdyBzaW1wbHkgYmVjb21lcyB0aGUgZm9sbG93aW5nOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHByb21pc2UgPSBSU1ZQLlByb21pc2UucmVqZWN0KG5ldyBFcnJvcignV0hPT1BTJykpOwogIAogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgLy8gQ29kZSBoZXJlIGRvZXNuJ3QgcnVuIGJlY2F1c2UgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQhCiAgICB9LCBmdW5jdGlvbihyZWFzb24pewogICAgICAvLyByZWFzb24ubWVzc2FnZSA9PT0gJ1dIT09QUycKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIHJlamVjdAogICAgQHN0YXRpYwogICAgQHBhcmFtIHsqfSByZWFzb24gdmFsdWUgdGhhdCB0aGUgcmV0dXJuZWQgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIHdpdGguCiAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIGZvciBpZGVudGlmeWluZyB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSByZWplY3RlZCB3aXRoIHRoZSBnaXZlbiBgcmVhc29uYC4KICAqLwogIGZ1bmN0aW9uIHJlamVjdCQxKHJlYXNvbiwgbGFiZWwpIHsKICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovCiAgICB2YXIgQ29uc3RydWN0b3IgPSB0aGlzOwogICAgdmFyIHByb21pc2UgPSBuZXcgQ29uc3RydWN0b3Iobm9vcCwgbGFiZWwpOwogICAgcmVqZWN0KHByb21pc2UsIHJlYXNvbik7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CgogIHZhciBndWlkS2V5ID0gJ3JzdnBfJyArIERhdGUubm93KCkgKyAnLSc7CiAgdmFyIGNvdW50ZXIgPSAwOwoKICBmdW5jdGlvbiBuZWVkc1Jlc29sdmVyKCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignWW91IG11c3QgcGFzcyBhIHJlc29sdmVyIGZ1bmN0aW9uIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvcicpOwogIH0KCiAgZnVuY3Rpb24gbmVlZHNOZXcoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJGYWlsZWQgdG8gY29uc3RydWN0ICdQcm9taXNlJzogUGxlYXNlIHVzZSB0aGUgJ25ldycgb3BlcmF0b3IsIHRoaXMgb2JqZWN0IGNvbnN0cnVjdG9yIGNhbm5vdCBiZSBjYWxsZWQgYXMgYSBmdW5jdGlvbi4iKTsKICB9CgogIC8qKgogICAgUHJvbWlzZSBvYmplY3RzIHJlcHJlc2VudCB0aGUgZXZlbnR1YWwgcmVzdWx0IG9mIGFuIGFzeW5jaHJvbm91cyBvcGVyYXRpb24uIFRoZQogICAgcHJpbWFyeSB3YXkgb2YgaW50ZXJhY3Rpbmcgd2l0aCBhIHByb21pc2UgaXMgdGhyb3VnaCBpdHMgYHRoZW5gIG1ldGhvZCwgd2hpY2gKICAgIHJlZ2lzdGVycyBjYWxsYmFja3MgdG8gcmVjZWl2ZSBlaXRoZXIgYSBwcm9taXNl4oCZcyBldmVudHVhbCB2YWx1ZSBvciB0aGUgcmVhc29uCiAgICB3aHkgdGhlIHByb21pc2UgY2Fubm90IGJlIGZ1bGZpbGxlZC4KICAKICAgIFRlcm1pbm9sb2d5CiAgICAtLS0tLS0tLS0tLQogIAogICAgLSBgcHJvbWlzZWAgaXMgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uIHdpdGggYSBgdGhlbmAgbWV0aG9kIHdob3NlIGJlaGF2aW9yIGNvbmZvcm1zIHRvIHRoaXMgc3BlY2lmaWNhdGlvbi4KICAgIC0gYHRoZW5hYmxlYCBpcyBhbiBvYmplY3Qgb3IgZnVuY3Rpb24gdGhhdCBkZWZpbmVzIGEgYHRoZW5gIG1ldGhvZC4KICAgIC0gYHZhbHVlYCBpcyBhbnkgbGVnYWwgSmF2YVNjcmlwdCB2YWx1ZSAoaW5jbHVkaW5nIHVuZGVmaW5lZCwgYSB0aGVuYWJsZSwgb3IgYSBwcm9taXNlKS4KICAgIC0gYGV4Y2VwdGlvbmAgaXMgYSB2YWx1ZSB0aGF0IGlzIHRocm93biB1c2luZyB0aGUgdGhyb3cgc3RhdGVtZW50LgogICAgLSBgcmVhc29uYCBpcyBhIHZhbHVlIHRoYXQgaW5kaWNhdGVzIHdoeSBhIHByb21pc2Ugd2FzIHJlamVjdGVkLgogICAgLSBgc2V0dGxlZGAgdGhlIGZpbmFsIHJlc3Rpbmcgc3RhdGUgb2YgYSBwcm9taXNlLCBmdWxmaWxsZWQgb3IgcmVqZWN0ZWQuCiAgCiAgICBBIHByb21pc2UgY2FuIGJlIGluIG9uZSBvZiB0aHJlZSBzdGF0ZXM6IHBlbmRpbmcsIGZ1bGZpbGxlZCwgb3IgcmVqZWN0ZWQuCiAgCiAgICBQcm9taXNlcyB0aGF0IGFyZSBmdWxmaWxsZWQgaGF2ZSBhIGZ1bGZpbGxtZW50IHZhbHVlIGFuZCBhcmUgaW4gdGhlIGZ1bGZpbGxlZAogICAgc3RhdGUuICBQcm9taXNlcyB0aGF0IGFyZSByZWplY3RlZCBoYXZlIGEgcmVqZWN0aW9uIHJlYXNvbiBhbmQgYXJlIGluIHRoZQogICAgcmVqZWN0ZWQgc3RhdGUuICBBIGZ1bGZpbGxtZW50IHZhbHVlIGlzIG5ldmVyIGEgdGhlbmFibGUuCiAgCiAgICBQcm9taXNlcyBjYW4gYWxzbyBiZSBzYWlkIHRvICpyZXNvbHZlKiBhIHZhbHVlLiAgSWYgdGhpcyB2YWx1ZSBpcyBhbHNvIGEKICAgIHByb21pc2UsIHRoZW4gdGhlIG9yaWdpbmFsIHByb21pc2UncyBzZXR0bGVkIHN0YXRlIHdpbGwgbWF0Y2ggdGhlIHZhbHVlJ3MKICAgIHNldHRsZWQgc3RhdGUuICBTbyBhIHByb21pc2UgdGhhdCAqcmVzb2x2ZXMqIGEgcHJvbWlzZSB0aGF0IHJlamVjdHMgd2lsbAogICAgaXRzZWxmIHJlamVjdCwgYW5kIGEgcHJvbWlzZSB0aGF0ICpyZXNvbHZlcyogYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgd2lsbAogICAgaXRzZWxmIGZ1bGZpbGwuCiAgCiAgCiAgICBCYXNpYyBVc2FnZToKICAgIC0tLS0tLS0tLS0tLQogIAogICAgYGBganMKICAgIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIC8vIG9uIHN1Y2Nlc3MKICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgCiAgICAgIC8vIG9uIGZhaWx1cmUKICAgICAgcmVqZWN0KHJlYXNvbik7CiAgICB9KTsKICAKICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAvLyBvbiBmdWxmaWxsbWVudAogICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIC8vIG9uIHJlamVjdGlvbgogICAgfSk7CiAgICBgYGAKICAKICAgIEFkdmFuY2VkIFVzYWdlOgogICAgLS0tLS0tLS0tLS0tLS0tCiAgCiAgICBQcm9taXNlcyBzaGluZSB3aGVuIGFic3RyYWN0aW5nIGF3YXkgYXN5bmNocm9ub3VzIGludGVyYWN0aW9ucyBzdWNoIGFzCiAgICBgWE1MSHR0cFJlcXVlc3Rgcy4KICAKICAgIGBgYGpzCiAgICBmdW5jdGlvbiBnZXRKU09OKHVybCkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KXsKICAgICAgICBsZXQgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgCiAgICAgICAgeGhyLm9wZW4oJ0dFVCcsIHVybCk7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGhhbmRsZXI7CiAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICdqc29uJzsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTsKICAgICAgICB4aHIuc2VuZCgpOwogIAogICAgICAgIGZ1bmN0aW9uIGhhbmRsZXIoKSB7CiAgICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucmVzcG9uc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2dldEpTT046IGAnICsgdXJsICsgJ2AgZmFpbGVkIHdpdGggc3RhdHVzOiBbJyArIHRoaXMuc3RhdHVzICsgJ10nKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KTsKICAgIH0KICAKICAgIGdldEpTT04oJy9wb3N0cy5qc29uJykudGhlbihmdW5jdGlvbihqc29uKSB7CiAgICAgIC8vIG9uIGZ1bGZpbGxtZW50CiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gb24gcmVqZWN0aW9uCiAgICB9KTsKICAgIGBgYAogIAogICAgVW5saWtlIGNhbGxiYWNrcywgcHJvbWlzZXMgYXJlIGdyZWF0IGNvbXBvc2FibGUgcHJpbWl0aXZlcy4KICAKICAgIGBgYGpzCiAgICBQcm9taXNlLmFsbChbCiAgICAgIGdldEpTT04oJy9wb3N0cycpLAogICAgICBnZXRKU09OKCcvY29tbWVudHMnKQogICAgXSkudGhlbihmdW5jdGlvbih2YWx1ZXMpewogICAgICB2YWx1ZXNbMF0gLy8gPT4gcG9zdHNKU09OCiAgICAgIHZhbHVlc1sxXSAvLyA9PiBjb21tZW50c0pTT04KICAKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAY2xhc3MgUlNWUC5Qcm9taXNlCiAgICBAcGFyYW0ge2Z1bmN0aW9ufSByZXNvbHZlcgogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAY29uc3RydWN0b3IKICAqLwoKICB2YXIgUHJvbWlzZSA9IGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFByb21pc2UocmVzb2x2ZXIsIGxhYmVsKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUHJvbWlzZSk7CgogICAgICB0aGlzLl9pZCA9IGNvdW50ZXIrKzsKICAgICAgdGhpcy5fbGFiZWwgPSBsYWJlbDsKICAgICAgdGhpcy5fc3RhdGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuX3Jlc3VsdCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5fc3Vic2NyaWJlcnMgPSBbXTsKCiAgICAgIGNvbmZpZy5pbnN0cnVtZW50ICYmIGluc3RydW1lbnQoJ2NyZWF0ZWQnLCB0aGlzKTsKCiAgICAgIGlmIChub29wICE9PSByZXNvbHZlcikgewogICAgICAgIHR5cGVvZiByZXNvbHZlciAhPT0gJ2Z1bmN0aW9uJyAmJiBuZWVkc1Jlc29sdmVyKCk7CiAgICAgICAgdGhpcyBpbnN0YW5jZW9mIFByb21pc2UgPyBpbml0aWFsaXplUHJvbWlzZSh0aGlzLCByZXNvbHZlcikgOiBuZWVkc05ldygpOwogICAgICB9CiAgICB9CgogICAgUHJvbWlzZS5wcm90b3R5cGUuX29uRXJyb3IgPSBmdW5jdGlvbiBfb25FcnJvcihyZWFzb24pIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICBjb25maWcuYWZ0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChfdGhpczIuX29uRXJyb3IpIHsKICAgICAgICAgIGNvbmZpZy50cmlnZ2VyKCdlcnJvcicsIHJlYXNvbiwgX3RoaXMyLl9sYWJlbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgUHJvbWlzZS5wcm90b3R5cGUuY2F0Y2ggPSBmdW5jdGlvbiBfY2F0Y2gob25SZWplY3Rpb24sIGxhYmVsKSB7CiAgICAgIHJldHVybiB0aGlzLnRoZW4odW5kZWZpbmVkLCBvblJlamVjdGlvbiwgbGFiZWwpOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5maW5hbGx5ID0gZnVuY3Rpb24gX2ZpbmFsbHkoY2FsbGJhY2ssIGxhYmVsKSB7CiAgICAgIHZhciBwcm9taXNlID0gdGhpczsKICAgICAgdmFyIGNvbnN0cnVjdG9yID0gcHJvbWlzZS5jb25zdHJ1Y3RvcjsKCiAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGNvbnN0cnVjdG9yLnJlc29sdmUoY2FsbGJhY2soKSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICByZXR1cm4gY29uc3RydWN0b3IucmVzb2x2ZShjYWxsYmFjaygpKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRocm93IHJlYXNvbjsKICAgICAgICB9KTsKICAgICAgfSwgbGFiZWwpOwogICAgfTsKCiAgICByZXR1cm4gUHJvbWlzZTsKICB9KCk7CgogIFByb21pc2UuY2FzdCA9IHJlc29sdmUkJDE7IC8vIGRlcHJlY2F0ZWQKICBQcm9taXNlLmFsbCA9IGFsbDsKICBQcm9taXNlLnJhY2UgPSByYWNlOwogIFByb21pc2UucmVzb2x2ZSA9IHJlc29sdmUkJDE7CiAgUHJvbWlzZS5yZWplY3QgPSByZWplY3QkMTsKCiAgUHJvbWlzZS5wcm90b3R5cGUuX2d1aWRLZXkgPSBndWlkS2V5OwoKICAvKioKICAgIFRoZSBwcmltYXJ5IHdheSBvZiBpbnRlcmFjdGluZyB3aXRoIGEgcHJvbWlzZSBpcyB0aHJvdWdoIGl0cyBgdGhlbmAgbWV0aG9kLAogICAgd2hpY2ggcmVnaXN0ZXJzIGNhbGxiYWNrcyB0byByZWNlaXZlIGVpdGhlciBhIHByb21pc2UncyBldmVudHVhbCB2YWx1ZSBvciB0aGUKICAgIHJlYXNvbiB3aHkgdGhlIHByb21pc2UgY2Fubm90IGJlIGZ1bGZpbGxlZC4KICAKICAgIGBgYGpzCiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24odXNlcil7CiAgICAgIC8vIHVzZXIgaXMgYXZhaWxhYmxlCiAgICB9LCBmdW5jdGlvbihyZWFzb24pewogICAgICAvLyB1c2VyIGlzIHVuYXZhaWxhYmxlLCBhbmQgeW91IGFyZSBnaXZlbiB0aGUgcmVhc29uIHdoeQogICAgfSk7CiAgICBgYGAKICAKICAgIENoYWluaW5nCiAgICAtLS0tLS0tLQogIAogICAgVGhlIHJldHVybiB2YWx1ZSBvZiBgdGhlbmAgaXMgaXRzZWxmIGEgcHJvbWlzZS4gIFRoaXMgc2Vjb25kLCAnZG93bnN0cmVhbScKICAgIHByb21pc2UgaXMgcmVzb2x2ZWQgd2l0aCB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBmaXJzdCBwcm9taXNlJ3MgZnVsZmlsbG1lbnQKICAgIG9yIHJlamVjdGlvbiBoYW5kbGVyLCBvciByZWplY3RlZCBpZiB0aGUgaGFuZGxlciB0aHJvd3MgYW4gZXhjZXB0aW9uLgogIAogICAgYGBganMKICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICByZXR1cm4gdXNlci5uYW1lOwogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICByZXR1cm4gJ2RlZmF1bHQgbmFtZSc7CiAgICB9KS50aGVuKGZ1bmN0aW9uICh1c2VyTmFtZSkgewogICAgICAvLyBJZiBgZmluZFVzZXJgIGZ1bGZpbGxlZCwgYHVzZXJOYW1lYCB3aWxsIGJlIHRoZSB1c2VyJ3MgbmFtZSwgb3RoZXJ3aXNlIGl0CiAgICAgIC8vIHdpbGwgYmUgYCdkZWZhdWx0IG5hbWUnYAogICAgfSk7CiAgCiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCB1c2VyLCBidXQgc3RpbGwgdW5oYXBweScpOwogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2BmaW5kVXNlcmAgcmVqZWN0ZWQgYW5kIHdlXCdyZSB1bmhhcHB5Jyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAvLyBuZXZlciByZWFjaGVkCiAgICB9LCBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIC8vIGlmIGBmaW5kVXNlcmAgZnVsZmlsbGVkLCBgcmVhc29uYCB3aWxsIGJlICdGb3VuZCB1c2VyLCBidXQgc3RpbGwgdW5oYXBweScuCiAgICAgIC8vIElmIGBmaW5kVXNlcmAgcmVqZWN0ZWQsIGByZWFzb25gIHdpbGwgYmUgJ2BmaW5kVXNlcmAgcmVqZWN0ZWQgYW5kIHdlXCdyZSB1bmhhcHB5Jy4KICAgIH0pOwogICAgYGBgCiAgICBJZiB0aGUgZG93bnN0cmVhbSBwcm9taXNlIGRvZXMgbm90IHNwZWNpZnkgYSByZWplY3Rpb24gaGFuZGxlciwgcmVqZWN0aW9uIHJlYXNvbnMgd2lsbCBiZSBwcm9wYWdhdGVkIGZ1cnRoZXIgZG93bnN0cmVhbS4KICAKICAgIGBgYGpzCiAgICBmaW5kVXNlcigpLnRoZW4oZnVuY3Rpb24gKHVzZXIpIHsKICAgICAgdGhyb3cgbmV3IFBlZGFnb2dpY2FsRXhjZXB0aW9uKCdVcHN0cmVhbSBlcnJvcicpOwogICAgfSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgLy8gbmV2ZXIgcmVhY2hlZAogICAgfSkudGhlbihmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgLy8gbmV2ZXIgcmVhY2hlZAogICAgfSwgZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAvLyBUaGUgYFBlZGdhZ29jaWFsRXhjZXB0aW9uYCBpcyBwcm9wYWdhdGVkIGFsbCB0aGUgd2F5IGRvd24gdG8gaGVyZQogICAgfSk7CiAgICBgYGAKICAKICAgIEFzc2ltaWxhdGlvbgogICAgLS0tLS0tLS0tLS0tCiAgCiAgICBTb21ldGltZXMgdGhlIHZhbHVlIHlvdSB3YW50IHRvIHByb3BhZ2F0ZSB0byBhIGRvd25zdHJlYW0gcHJvbWlzZSBjYW4gb25seSBiZQogICAgcmV0cmlldmVkIGFzeW5jaHJvbm91c2x5LiBUaGlzIGNhbiBiZSBhY2hpZXZlZCBieSByZXR1cm5pbmcgYSBwcm9taXNlIGluIHRoZQogICAgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIGhhbmRsZXIuIFRoZSBkb3duc3RyZWFtIHByb21pc2Ugd2lsbCB0aGVuIGJlIHBlbmRpbmcKICAgIHVudGlsIHRoZSByZXR1cm5lZCBwcm9taXNlIGlzIHNldHRsZWQuIFRoaXMgaXMgY2FsbGVkICphc3NpbWlsYXRpb24qLgogIAogICAgYGBganMKICAgIGZpbmRVc2VyKCkudGhlbihmdW5jdGlvbiAodXNlcikgewogICAgICByZXR1cm4gZmluZENvbW1lbnRzQnlBdXRob3IodXNlcik7CiAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21tZW50cykgewogICAgICAvLyBUaGUgdXNlcidzIGNvbW1lbnRzIGFyZSBub3cgYXZhaWxhYmxlCiAgICB9KTsKICAgIGBgYAogIAogICAgSWYgdGhlIGFzc2ltbGlhdGVkIHByb21pc2UgcmVqZWN0cywgdGhlbiB0aGUgZG93bnN0cmVhbSBwcm9taXNlIHdpbGwgYWxzbyByZWplY3QuCiAgCiAgICBgYGBqcwogICAgZmluZFVzZXIoKS50aGVuKGZ1bmN0aW9uICh1c2VyKSB7CiAgICAgIHJldHVybiBmaW5kQ29tbWVudHNCeUF1dGhvcih1c2VyKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKGNvbW1lbnRzKSB7CiAgICAgIC8vIElmIGBmaW5kQ29tbWVudHNCeUF1dGhvcmAgZnVsZmlsbHMsIHdlJ2xsIGhhdmUgdGhlIHZhbHVlIGhlcmUKICAgIH0sIGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgLy8gSWYgYGZpbmRDb21tZW50c0J5QXV0aG9yYCByZWplY3RzLCB3ZSdsbCBoYXZlIHRoZSByZWFzb24gaGVyZQogICAgfSk7CiAgICBgYGAKICAKICAgIFNpbXBsZSBFeGFtcGxlCiAgICAtLS0tLS0tLS0tLS0tLQogIAogICAgU3luY2hyb25vdXMgRXhhbXBsZQogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlc3VsdDsKICAKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IGZpbmRSZXN1bHQoKTsKICAgICAgLy8gc3VjY2VzcwogICAgfSBjYXRjaChyZWFzb24pIHsKICAgICAgLy8gZmFpbHVyZQogICAgfQogICAgYGBgCiAgCiAgICBFcnJiYWNrIEV4YW1wbGUKICAKICAgIGBgYGpzCiAgICBmaW5kUmVzdWx0KGZ1bmN0aW9uKHJlc3VsdCwgZXJyKXsKICAgICAgaWYgKGVycikgewogICAgICAgIC8vIGZhaWx1cmUKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBzdWNjZXNzCiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBQcm9taXNlIEV4YW1wbGU7CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmaW5kUmVzdWx0KCkudGhlbihmdW5jdGlvbihyZXN1bHQpewogICAgICAvLyBzdWNjZXNzCiAgICB9LCBmdW5jdGlvbihyZWFzb24pewogICAgICAvLyBmYWlsdXJlCiAgICB9KTsKICAgIGBgYAogIAogICAgQWR2YW5jZWQgRXhhbXBsZQogICAgLS0tLS0tLS0tLS0tLS0KICAKICAgIFN5bmNocm9ub3VzIEV4YW1wbGUKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBhdXRob3IsIGJvb2tzOwogIAogICAgdHJ5IHsKICAgICAgYXV0aG9yID0gZmluZEF1dGhvcigpOwogICAgICBib29rcyAgPSBmaW5kQm9va3NCeUF1dGhvcihhdXRob3IpOwogICAgICAvLyBzdWNjZXNzCiAgICB9IGNhdGNoKHJlYXNvbikgewogICAgICAvLyBmYWlsdXJlCiAgICB9CiAgICBgYGAKICAKICAgIEVycmJhY2sgRXhhbXBsZQogIAogICAgYGBganMKICAKICAgIGZ1bmN0aW9uIGZvdW5kQm9va3MoYm9va3MpIHsKICAKICAgIH0KICAKICAgIGZ1bmN0aW9uIGZhaWx1cmUocmVhc29uKSB7CiAgCiAgICB9CiAgCiAgICBmaW5kQXV0aG9yKGZ1bmN0aW9uKGF1dGhvciwgZXJyKXsKICAgICAgaWYgKGVycikgewogICAgICAgIGZhaWx1cmUoZXJyKTsKICAgICAgICAvLyBmYWlsdXJlCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZpbmRCb29va3NCeUF1dGhvcihhdXRob3IsIGZ1bmN0aW9uKGJvb2tzLCBlcnIpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIGZhaWx1cmUoZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm91bmRCb29rcyhib29rcyk7CiAgICAgICAgICAgICAgfSBjYXRjaChyZWFzb24pIHsKICAgICAgICAgICAgICAgIGZhaWx1cmUocmVhc29uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2goZXJyb3IpIHsKICAgICAgICAgIGZhaWx1cmUoZXJyKTsKICAgICAgICB9CiAgICAgICAgLy8gc3VjY2VzcwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgUHJvbWlzZSBFeGFtcGxlOwogIAogICAgYGBgamF2YXNjcmlwdAogICAgZmluZEF1dGhvcigpLgogICAgICB0aGVuKGZpbmRCb29rc0J5QXV0aG9yKS4KICAgICAgdGhlbihmdW5jdGlvbihib29rcyl7CiAgICAgICAgLy8gZm91bmQgYm9va3MKICAgIH0pLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbil7CiAgICAgIC8vIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICB9KTsKICAgIGBgYAogIAogICAgQG1ldGhvZCB0aGVuCiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBvbkZ1bGZpbGxtZW50CiAgICBAcGFyYW0ge0Z1bmN0aW9ufSBvblJlamVjdGlvbgogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfQogICovCiAgUHJvbWlzZS5wcm90b3R5cGUudGhlbiA9IHRoZW47CgogIGZ1bmN0aW9uIG1ha2VPYmplY3QoXywgYXJndW1lbnROYW1lcykgewogICAgdmFyIG9iaiA9IHt9OwogICAgdmFyIGxlbmd0aCA9IF8ubGVuZ3RoOwogICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkobGVuZ3RoKTsKCiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGxlbmd0aDsgeCsrKSB7CiAgICAgIGFyZ3NbeF0gPSBfW3hdOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnROYW1lcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgbmFtZSA9IGFyZ3VtZW50TmFtZXNbaV07CiAgICAgIG9ialtuYW1lXSA9IGFyZ3NbaSArIDFdOwogICAgfQoKICAgIHJldHVybiBvYmo7CiAgfQoKICBmdW5jdGlvbiBhcnJheVJlc3VsdChfKSB7CiAgICB2YXIgbGVuZ3RoID0gXy5sZW5ndGg7CiAgICB2YXIgYXJncyA9IG5ldyBBcnJheShsZW5ndGggLSAxKTsKCiAgICBmb3IgKHZhciBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGFyZ3NbaSAtIDFdID0gX1tpXTsKICAgIH0KCiAgICByZXR1cm4gYXJnczsKICB9CgogIGZ1bmN0aW9uIHdyYXBUaGVuYWJsZSh0aGVuLCBwcm9taXNlKSB7CiAgICByZXR1cm4gewogICAgICB0aGVuOiBmdW5jdGlvbiAob25GdWxGaWxsbWVudCwgb25SZWplY3Rpb24pIHsKICAgICAgICByZXR1cm4gdGhlbi5jYWxsKHByb21pc2UsIG9uRnVsRmlsbG1lbnQsIG9uUmVqZWN0aW9uKTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAgYFJTVlAuZGVub2RlaWZ5YCB0YWtlcyBhICdub2RlLXN0eWxlJyBmdW5jdGlvbiBhbmQgcmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQKICAgIHdpbGwgcmV0dXJuIGFuIGBSU1ZQLlByb21pc2VgLiBZb3UgY2FuIHVzZSBgZGVub2RlaWZ5YCBpbiBOb2RlLmpzIG9yIHRoZQogICAgYnJvd3NlciB3aGVuIHlvdSdkIHByZWZlciB0byB1c2UgcHJvbWlzZXMgb3ZlciB1c2luZyBjYWxsYmFja3MuIEZvciBleGFtcGxlLAogICAgYGRlbm9kZWlmeWAgdHJhbnNmb3JtcyB0aGUgZm9sbG93aW5nOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGZzID0gcmVxdWlyZSgnZnMnKTsKICAKICAgIGZzLnJlYWRGaWxlKCdteWZpbGUudHh0JywgZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgaWYgKGVycikgcmV0dXJuIGhhbmRsZUVycm9yKGVycik7CiAgICAgIGhhbmRsZURhdGEoZGF0YSk7CiAgICB9KTsKICAgIGBgYAogIAogICAgaW50bzoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICBsZXQgcmVhZEZpbGUgPSBSU1ZQLmRlbm9kZWlmeShmcy5yZWFkRmlsZSk7CiAgCiAgICByZWFkRmlsZSgnbXlmaWxlLnR4dCcpLnRoZW4oaGFuZGxlRGF0YSwgaGFuZGxlRXJyb3IpOwogICAgYGBgCiAgCiAgICBJZiB0aGUgbm9kZSBmdW5jdGlvbiBoYXMgbXVsdGlwbGUgc3VjY2VzcyBwYXJhbWV0ZXJzLCB0aGVuIGBkZW5vZGVpZnlgCiAgICBqdXN0IHJldHVybnMgdGhlIGZpcnN0IG9uZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCByZXF1ZXN0ID0gUlNWUC5kZW5vZGVpZnkocmVxdWlyZSgncmVxdWVzdCcpKTsKICAKICAgIHJlcXVlc3QoJ2h0dHA6Ly9leGFtcGxlLmNvbScpLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgIC8vIC4uLgogICAgfSk7CiAgICBgYGAKICAKICAgIEhvd2V2ZXIsIGlmIHlvdSBuZWVkIGFsbCBzdWNjZXNzIHBhcmFtZXRlcnMsIHNldHRpbmcgYGRlbm9kZWlmeWAncwogICAgc2Vjb25kIHBhcmFtZXRlciB0byBgdHJ1ZWAgY2F1c2VzIGl0IHRvIHJldHVybiBhbGwgc3VjY2VzcyBwYXJhbWV0ZXJzCiAgICBhcyBhbiBhcnJheToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCByZXF1ZXN0ID0gUlNWUC5kZW5vZGVpZnkocmVxdWlyZSgncmVxdWVzdCcpLCB0cnVlKTsKICAKICAgIHJlcXVlc3QoJ2h0dHA6Ly9leGFtcGxlLmNvbScpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgIC8vIHJlc3VsdFswXSAtPiByZXMKICAgICAgLy8gcmVzdWx0WzFdIC0+IGJvZHkKICAgIH0pOwogICAgYGBgCiAgCiAgICBPciBpZiB5b3UgcGFzcyBpdCBhbiBhcnJheSB3aXRoIG5hbWVzIGl0IHJldHVybnMgdGhlIHBhcmFtZXRlcnMgYXMgYSBoYXNoOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlcXVlc3QgPSBSU1ZQLmRlbm9kZWlmeShyZXF1aXJlKCdyZXF1ZXN0JyksIFsncmVzJywgJ2JvZHknXSk7CiAgCiAgICByZXF1ZXN0KCdodHRwOi8vZXhhbXBsZS5jb20nKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAvLyByZXN1bHQucmVzCiAgICAgIC8vIHJlc3VsdC5ib2R5CiAgICB9KTsKICAgIGBgYAogIAogICAgU29tZXRpbWVzIHlvdSBuZWVkIHRvIHJldGFpbiB0aGUgYHRoaXNgOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGFwcCA9IHJlcXVpcmUoJ2V4cHJlc3MnKSgpOwogICAgbGV0IHJlbmRlciA9IFJTVlAuZGVub2RlaWZ5KGFwcC5yZW5kZXIuYmluZChhcHApKTsKICAgIGBgYAogIAogICAgVGhlIGRlbm9kaWZpZWQgZnVuY3Rpb24gaW5oZXJpdHMgZnJvbSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uIEl0IHdvcmtzIGluIGFsbAogICAgZW52aXJvbm1lbnRzLCBleGNlcHQgSUUgMTAgYW5kIGJlbG93LiBDb25zZXF1ZW50bHkgYWxsIHByb3BlcnRpZXMgb2YgdGhlIG9yaWdpbmFsCiAgICBmdW5jdGlvbiBhcmUgYXZhaWxhYmxlIHRvIHlvdS4gSG93ZXZlciwgYW55IHByb3BlcnRpZXMgeW91IGNoYW5nZSBvbiB0aGUKICAgIGRlbm9kZWlmaWVkIGZ1bmN0aW9uIHdvbid0IGJlIGNoYW5nZWQgb24gdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLiBFeGFtcGxlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlcXVlc3QgPSBSU1ZQLmRlbm9kZWlmeShyZXF1aXJlKCdyZXF1ZXN0JykpLAogICAgICAgIGNvb2tpZUphciA9IHJlcXVlc3QuamFyKCk7IC8vIDwtIEluaGVyaXRhbmNlIGlzIHVzZWQgaGVyZQogIAogICAgcmVxdWVzdCgnaHR0cDovL2V4YW1wbGUuY29tJywge2phcjogY29va2llSmFyfSkudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAgLy8gY29va2llSmFyLmNvb2tpZXMgaG9sZHMgbm93IHRoZSBjb29raWVzIHJldHVybmVkIGJ5IGV4YW1wbGUuY29tCiAgICB9KTsKICAgIGBgYAogIAogICAgVXNpbmcgYGRlbm9kZWlmeWAgbWFrZXMgaXQgZWFzaWVyIHRvIGNvbXBvc2UgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMgaW5zdGVhZAogICAgb2YgdXNpbmcgY2FsbGJhY2tzLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZjoKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgCiAgICBmcy5yZWFkRmlsZSgnbXlmaWxlLnR4dCcsIGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgIGlmIChlcnIpIHsgLi4uIH0gLy8gSGFuZGxlIGVycm9yCiAgICAgIGZzLndyaXRlRmlsZSgnbXlmaWxlMi50eHQnLCBkYXRhLCBmdW5jdGlvbihlcnIpewogICAgICAgIGlmIChlcnIpIHsgLi4uIH0gLy8gSGFuZGxlIGVycm9yCiAgICAgICAgY29uc29sZS5sb2coJ2RvbmUnKQogICAgICB9KTsKICAgIH0pOwogICAgYGBgCiAgCiAgICB5b3UgY2FuIGNoYWluIHRoZSBvcGVyYXRpb25zIHRvZ2V0aGVyIHVzaW5nIGB0aGVuYCBmcm9tIHRoZSByZXR1cm5lZCBwcm9taXNlOgogIAogICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGZzID0gcmVxdWlyZSgnZnMnKTsKICAgIGxldCByZWFkRmlsZSA9IFJTVlAuZGVub2RlaWZ5KGZzLnJlYWRGaWxlKTsKICAgIGxldCB3cml0ZUZpbGUgPSBSU1ZQLmRlbm9kZWlmeShmcy53cml0ZUZpbGUpOwogIAogICAgcmVhZEZpbGUoJ215ZmlsZS50eHQnKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICByZXR1cm4gd3JpdGVGaWxlKCdteWZpbGUyLnR4dCcsIGRhdGEpOwogICAgfSkudGhlbihmdW5jdGlvbigpewogICAgICBjb25zb2xlLmxvZygnZG9uZScpCiAgICB9KS5jYXRjaChmdW5jdGlvbihlcnJvcil7CiAgICAgIC8vIEhhbmRsZSBlcnJvcgogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgZGVub2RlaWZ5CiAgICBAc3RhdGljCiAgICBAZm9yIFJTVlAKICAgIEBwYXJhbSB7RnVuY3Rpb259IG5vZGVGdW5jIGEgJ25vZGUtc3R5bGUnIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYSBjYWxsYmFjayBhcwogICAgaXRzIGxhc3QgYXJndW1lbnQuIFRoZSBjYWxsYmFjayBleHBlY3RzIGFuIGVycm9yIHRvIGJlIHBhc3NlZCBhcyBpdHMgZmlyc3QKICAgIGFyZ3VtZW50IChpZiBhbiBlcnJvciBvY2N1cnJlZCwgb3RoZXJ3aXNlIG51bGwpLCBhbmQgdGhlIHZhbHVlIGZyb20gdGhlCiAgICBvcGVyYXRpb24gYXMgaXRzIHNlY29uZCBhcmd1bWVudCAoJ2Z1bmN0aW9uKGVyciwgdmFsdWUpeyB9JykuCiAgICBAcGFyYW0ge0Jvb2xlYW58QXJyYXl9IFtvcHRpb25zXSBBbiBvcHRpb25hbCBwYXJhbXRlciB0aGF0IGlmIHNldAogICAgdG8gYHRydWVgIGNhdXNlcyB0aGUgcHJvbWlzZSB0byBmdWxmaWxsIHdpdGggdGhlIGNhbGxiYWNrJ3Mgc3VjY2VzcyBhcmd1bWVudHMKICAgIGFzIGFuIGFycmF5LiBUaGlzIGlzIHVzZWZ1bCBpZiB0aGUgbm9kZSBmdW5jdGlvbiBoYXMgbXVsdGlwbGUgc3VjY2VzcwogICAgcGFyYW10ZXJzLiBJZiB5b3Ugc2V0IHRoaXMgcGFyYW10ZXIgdG8gYW4gYXJyYXkgd2l0aCBuYW1lcywgdGhlIHByb21pc2Ugd2lsbAogICAgZnVsZmlsbCB3aXRoIGEgaGFzaCB3aXRoIHRoZXNlIG5hbWVzIGFzIGtleXMgYW5kIHRoZSBzdWNjZXNzIHBhcmFtZXRlcnMgYXMKICAgIHZhbHVlcy4KICAgIEByZXR1cm4ge0Z1bmN0aW9ufSBhIGZ1bmN0aW9uIHRoYXQgd3JhcHMgYG5vZGVGdW5jYCB0byByZXR1cm4gYW4KICAgIGBSU1ZQLlByb21pc2VgCiAgICBAc3RhdGljCiAgKi8KICBmdW5jdGlvbiBkZW5vZGVpZnkobm9kZUZ1bmMsIG9wdGlvbnMpIHsKICAgIHZhciBmbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGwgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShsICsgMSk7CiAgICAgIHZhciBwcm9taXNlSW5wdXQgPSBmYWxzZTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbDsgKytpKSB7CiAgICAgICAgdmFyIGFyZyA9IGFyZ3VtZW50c1tpXTsKCiAgICAgICAgaWYgKCFwcm9taXNlSW5wdXQpIHsKICAgICAgICAgIC8vIFRPRE86IGNsZWFuIHRoaXMgdXAKICAgICAgICAgIHByb21pc2VJbnB1dCA9IG5lZWRzUHJvbWlzZUlucHV0KGFyZyk7CiAgICAgICAgICBpZiAocHJvbWlzZUlucHV0ID09PSBUUllfQ0FUQ0hfRVJST1IpIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gVFJZX0NBVENIX0VSUk9SLmVycm9yOwogICAgICAgICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBudWxsOwogICAgICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKG5vb3ApOwogICAgICAgICAgICByZWplY3QocCwgZXJyb3IpOwogICAgICAgICAgICByZXR1cm4gcDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvbWlzZUlucHV0ICYmIHByb21pc2VJbnB1dCAhPT0gdHJ1ZSkgewogICAgICAgICAgICBhcmcgPSB3cmFwVGhlbmFibGUocHJvbWlzZUlucHV0LCBhcmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhcmdzW2ldID0gYXJnOwogICAgICB9CgogICAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKG5vb3ApOwoKICAgICAgYXJnc1tsXSA9IGZ1bmN0aW9uIChlcnIsIHZhbCkgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlamVjdChwcm9taXNlLCBlcnIpOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXNvbHZlJDEocHJvbWlzZSwgdmFsKTsKICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMgPT09IHRydWUpIHsKICAgICAgICAgIHJlc29sdmUkMShwcm9taXNlLCBhcnJheVJlc3VsdChhcmd1bWVudHMpKTsKICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucykpIHsKICAgICAgICAgIHJlc29sdmUkMShwcm9taXNlLCBtYWtlT2JqZWN0KGFyZ3VtZW50cywgb3B0aW9ucykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlJDEocHJvbWlzZSwgdmFsKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAocHJvbWlzZUlucHV0KSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZVByb21pc2VJbnB1dChwcm9taXNlLCBhcmdzLCBub2RlRnVuYywgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZVZhbHVlSW5wdXQocHJvbWlzZSwgYXJncywgbm9kZUZ1bmMsIHRoaXMpOwogICAgICB9CiAgICB9OwoKICAgIGZuLl9fcHJvdG9fXyA9IG5vZGVGdW5jOwoKICAgIHJldHVybiBmbjsKICB9CgogIGZ1bmN0aW9uIGhhbmRsZVZhbHVlSW5wdXQocHJvbWlzZSwgYXJncywgbm9kZUZ1bmMsIHNlbGYpIHsKICAgIHZhciByZXN1bHQgPSB0cnlDYXRjaChub2RlRnVuYykuYXBwbHkoc2VsZiwgYXJncyk7CiAgICBpZiAocmVzdWx0ID09PSBUUllfQ0FUQ0hfRVJST1IpIHsKICAgICAgdmFyIGVycm9yID0gVFJZX0NBVENIX0VSUk9SLmVycm9yOwogICAgICBUUllfQ0FUQ0hfRVJST1IuZXJyb3IgPSBudWxsOwogICAgICByZWplY3QocHJvbWlzZSwgZXJyb3IpOwogICAgfQogICAgcmV0dXJuIHByb21pc2U7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVQcm9taXNlSW5wdXQocHJvbWlzZSwgYXJncywgbm9kZUZ1bmMsIHNlbGYpIHsKICAgIHJldHVybiBQcm9taXNlLmFsbChhcmdzKS50aGVuKGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHJldHVybiBoYW5kbGVWYWx1ZUlucHV0KHByb21pc2UsIGFyZ3MsIG5vZGVGdW5jLCBzZWxmKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gbmVlZHNQcm9taXNlSW5wdXQoYXJnKSB7CiAgICBpZiAoYXJnICE9PSBudWxsICYmIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnKSB7CiAgICAgIGlmIChhcmcuY29uc3RydWN0b3IgPT09IFByb21pc2UpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZ2V0VGhlbihhcmcpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICAvKioKICAgIFRoaXMgaXMgYSBjb252ZW5pZW50IGFsaWFzIGZvciBgUlNWUC5Qcm9taXNlLmFsbGAuCiAgCiAgICBAbWV0aG9kIGFsbAogICAgQHN0YXRpYwogICAgQGZvciBSU1ZQCiAgICBAcGFyYW0ge0FycmF5fSBhcnJheSBBcnJheSBvZiBwcm9taXNlcy4KICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBBbiBvcHRpb25hbCBsYWJlbC4gVGhpcyBpcyB1c2VmdWwKICAgIGZvciB0b29saW5nLgogICovCiAgZnVuY3Rpb24gYWxsJDEoYXJyYXksIGxhYmVsKSB7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYXJyYXksIGxhYmVsKTsKICB9CgogIHZhciBBbGxTZXR0bGVkID0gZnVuY3Rpb24gKF9FbnVtZXJhdG9yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEFsbFNldHRsZWQsIF9FbnVtZXJhdG9yKTsKCiAgICBmdW5jdGlvbiBBbGxTZXR0bGVkKENvbnN0cnVjdG9yLCBlbnRyaWVzLCBsYWJlbCkgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEFsbFNldHRsZWQpOwogICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9FbnVtZXJhdG9yLmNhbGwodGhpcywgQ29uc3RydWN0b3IsIGVudHJpZXMsIGZhbHNlIC8qIGRvbid0IGFib3J0IG9uIHJlamVjdCAqLywgbGFiZWwpKTsKICAgIH0KCiAgICByZXR1cm4gQWxsU2V0dGxlZDsKICB9KEVudW1lcmF0b3IpOwoKICBBbGxTZXR0bGVkLnByb3RvdHlwZS5fc2V0UmVzdWx0QXQgPSBzZXRTZXR0bGVkUmVzdWx0OwoKICAvKioKICBgUlNWUC5hbGxTZXR0bGVkYCBpcyBzaW1pbGFyIHRvIGBSU1ZQLmFsbGAsIGJ1dCBpbnN0ZWFkIG9mIGltcGxlbWVudGluZwogIGEgZmFpbC1mYXN0IG1ldGhvZCwgaXQgd2FpdHMgdW50aWwgYWxsIHRoZSBwcm9taXNlcyBoYXZlIHJldHVybmVkIGFuZAogIHNob3dzIHlvdSBhbGwgdGhlIHJlc3VsdHMuIFRoaXMgaXMgdXNlZnVsIGlmIHlvdSB3YW50IHRvIGhhbmRsZSBtdWx0aXBsZQogIHByb21pc2VzJyBmYWlsdXJlIHN0YXRlcyB0b2dldGhlciBhcyBhIHNldC4KICAgUmV0dXJucyBhIHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2hlbiBhbGwgdGhlIGdpdmVuIHByb21pc2VzIGhhdmUgYmVlbgogIHNldHRsZWQuIFRoZSByZXR1cm4gcHJvbWlzZSBpcyBmdWxmaWxsZWQgd2l0aCBhbiBhcnJheSBvZiB0aGUgc3RhdGVzIG9mCiAgdGhlIHByb21pc2VzIHBhc3NlZCBpbnRvIHRoZSBgcHJvbWlzZXNgIGFycmF5IGFyZ3VtZW50LgogICBFYWNoIHN0YXRlIG9iamVjdCB3aWxsIGVpdGhlciBpbmRpY2F0ZSBmdWxmaWxsbWVudCBvciByZWplY3Rpb24sIGFuZAogIHByb3ZpZGUgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUgb3IgcmVhc29uLiBUaGUgc3RhdGVzIHdpbGwgdGFrZSBvbmUgb2YKICB0aGUgZm9sbG93aW5nIGZvcm1hdHM6CiAgIGBgYGphdmFzY3JpcHQKICB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IHZhbHVlIH0KICAgIG9yCiAgeyBzdGF0ZTogJ3JlamVjdGVkJywgcmVhc29uOiByZWFzb24gfQogIGBgYAogICBFeGFtcGxlOgogICBgYGBqYXZhc2NyaXB0CiAgbGV0IHByb21pc2UxID0gUlNWUC5Qcm9taXNlLnJlc29sdmUoMSk7CiAgbGV0IHByb21pc2UyID0gUlNWUC5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJzInKSk7CiAgbGV0IHByb21pc2UzID0gUlNWUC5Qcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJzMnKSk7CiAgbGV0IHByb21pc2VzID0gWyBwcm9taXNlMSwgcHJvbWlzZTIsIHByb21pc2UzIF07CiAgIFJTVlAuYWxsU2V0dGxlZChwcm9taXNlcykudGhlbihmdW5jdGlvbihhcnJheSl7CiAgICAvLyBhcnJheSA9PSBbCiAgICAvLyAgIHsgc3RhdGU6ICdmdWxmaWxsZWQnLCB2YWx1ZTogMSB9LAogICAgLy8gICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0sCiAgICAvLyAgIHsgc3RhdGU6ICdyZWplY3RlZCcsIHJlYXNvbjogRXJyb3IgfQogICAgLy8gXQogICAgLy8gTm90ZSB0aGF0IGZvciB0aGUgc2Vjb25kIGl0ZW0sIHJlYXNvbi5tZXNzYWdlIHdpbGwgYmUgJzInLCBhbmQgZm9yIHRoZQogICAgLy8gdGhpcmQgaXRlbSwgcmVhc29uLm1lc3NhZ2Ugd2lsbCBiZSAnMycuCiAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgIC8vIE5vdCBydW4uIChUaGlzIGJsb2NrIHdvdWxkIG9ubHkgYmUgY2FsbGVkIGlmIGFsbFNldHRsZWQgaGFkIGZhaWxlZCwKICAgIC8vIGZvciBpbnN0YW5jZSBpZiBwYXNzZWQgYW4gaW5jb3JyZWN0IGFyZ3VtZW50IHR5cGUuKQogIH0pOwogIGBgYAogICBAbWV0aG9kIGFsbFNldHRsZWQKICBAc3RhdGljCiAgQGZvciBSU1ZQCiAgQHBhcmFtIHtBcnJheX0gZW50cmllcwogIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCAtIG9wdGlvbmFsIHN0cmluZyB0aGF0IGRlc2NyaWJlcyB0aGUgcHJvbWlzZS4KICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGFuIGFycmF5IG9mIHRoZSBzZXR0bGVkCiAgc3RhdGVzIG9mIHRoZSBjb25zdGl0dWVudCBwcm9taXNlcy4KICAqLwoKICBmdW5jdGlvbiBhbGxTZXR0bGVkKGVudHJpZXMsIGxhYmVsKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZW50cmllcykpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBUeXBlRXJyb3IoIlByb21pc2UuYWxsU2V0dGxlZCBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIGFycmF5IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEFsbFNldHRsZWQoUHJvbWlzZSwgZW50cmllcywgbGFiZWwpLnByb21pc2U7CiAgfQoKICAvKioKICAgIFRoaXMgaXMgYSBjb252ZW5pZW50IGFsaWFzIGZvciBgUlNWUC5Qcm9taXNlLnJhY2VgLgogIAogICAgQG1ldGhvZCByYWNlCiAgICBAc3RhdGljCiAgICBAZm9yIFJTVlAKICAgIEBwYXJhbSB7QXJyYXl9IGFycmF5IEFycmF5IG9mIHByb21pc2VzLgogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIEFuIG9wdGlvbmFsIGxhYmVsLiBUaGlzIGlzIHVzZWZ1bAogICAgZm9yIHRvb2xpbmcuCiAgICovCiAgZnVuY3Rpb24gcmFjZSQxKGFycmF5LCBsYWJlbCkgewogICAgcmV0dXJuIFByb21pc2UucmFjZShhcnJheSwgbGFiZWwpOwogIH0KCiAgdmFyIFByb21pc2VIYXNoID0gZnVuY3Rpb24gKF9FbnVtZXJhdG9yMikgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShQcm9taXNlSGFzaCwgX0VudW1lcmF0b3IyKTsKCiAgICBmdW5jdGlvbiBQcm9taXNlSGFzaChDb25zdHJ1Y3Rvciwgb2JqZWN0KSB7CiAgICAgIHZhciBhYm9ydE9uUmVqZWN0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogICAgICB2YXIgbGFiZWwgPSBhcmd1bWVudHNbM107CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgUHJvbWlzZUhhc2gpOwogICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9FbnVtZXJhdG9yMi5jYWxsKHRoaXMsIENvbnN0cnVjdG9yLCBvYmplY3QsIGFib3J0T25SZWplY3QsIGxhYmVsKSk7CiAgICB9CgogICAgUHJvbWlzZUhhc2gucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gX2luaXQoQ29uc3RydWN0b3IsIG9iamVjdCkgewogICAgICB0aGlzLl9yZXN1bHQgPSB7fTsKICAgICAgdGhpcy5fZW51bWVyYXRlKG9iamVjdCk7CiAgICB9OwoKICAgIFByb21pc2VIYXNoLnByb3RvdHlwZS5fZW51bWVyYXRlID0gZnVuY3Rpb24gX2VudW1lcmF0ZShpbnB1dCkgewogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGlucHV0KTsKCiAgICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CiAgICAgIHRoaXMuX3JlbWFpbmluZyA9IGxlbmd0aDsKCiAgICAgIHZhciBrZXkgPSB2b2lkIDAsCiAgICAgICAgICB2YWwgPSB2b2lkIDA7CiAgICAgIGZvciAodmFyIGkgPSAwOyBwcm9taXNlLl9zdGF0ZSA9PT0gUEVORElORyAmJiBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHZhbCA9IGlucHV0W2tleV07CiAgICAgICAgdGhpcy5fZWFjaEVudHJ5KHZhbCwga2V5LCB0cnVlKTsKICAgICAgfQoKICAgICAgdGhpcy5fY2hlY2tGdWxsZmlsbG1lbnQoKTsKICAgIH07CgogICAgcmV0dXJuIFByb21pc2VIYXNoOwogIH0oRW51bWVyYXRvcik7CgogIC8qKgogICAgYFJTVlAuaGFzaGAgaXMgc2ltaWxhciB0byBgUlNWUC5hbGxgLCBidXQgdGFrZXMgYW4gb2JqZWN0IGluc3RlYWQgb2YgYW4gYXJyYXkKICAgIGZvciBpdHMgYHByb21pc2VzYCBhcmd1bWVudC4KICAKICAgIFJldHVybnMgYSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gYWxsIHRoZSBnaXZlbiBwcm9taXNlcyBoYXZlIGJlZW4KICAgIGZ1bGZpbGxlZCwgb3IgcmVqZWN0ZWQgaWYgYW55IG9mIHRoZW0gYmVjb21lIHJlamVjdGVkLiBUaGUgcmV0dXJuZWQgcHJvbWlzZQogICAgaXMgZnVsZmlsbGVkIHdpdGggYSBoYXNoIHRoYXQgaGFzIHRoZSBzYW1lIGtleSBuYW1lcyBhcyB0aGUgYHByb21pc2VzYCBvYmplY3QKICAgIGFyZ3VtZW50LiBJZiBhbnkgb2YgdGhlIHZhbHVlcyBpbiB0aGUgb2JqZWN0IGFyZSBub3QgcHJvbWlzZXMsIHRoZXkgd2lsbAogICAgc2ltcGx5IGJlIGNvcGllZCBvdmVyIHRvIHRoZSBmdWxmaWxsZWQgb2JqZWN0LgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlcyA9IHsKICAgICAgbXlQcm9taXNlOiBSU1ZQLnJlc29sdmUoMSksCiAgICAgIHlvdXJQcm9taXNlOiBSU1ZQLnJlc29sdmUoMiksCiAgICAgIHRoZWlyUHJvbWlzZTogUlNWUC5yZXNvbHZlKDMpLAogICAgICBub3RBUHJvbWlzZTogNAogICAgfTsKICAKICAgIFJTVlAuaGFzaChwcm9taXNlcykudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gaGFzaCBoZXJlIGlzIGFuIG9iamVjdCB0aGF0IGxvb2tzIGxpa2U6CiAgICAgIC8vIHsKICAgICAgLy8gICBteVByb21pc2U6IDEsCiAgICAgIC8vICAgeW91clByb21pc2U6IDIsCiAgICAgIC8vICAgdGhlaXJQcm9taXNlOiAzLAogICAgICAvLyAgIG5vdEFQcm9taXNlOiA0CiAgICAgIC8vIH0KICAgIH0pOwogICAgYGBgYAogIAogICAgSWYgYW55IG9mIHRoZSBgcHJvbWlzZXNgIGdpdmVuIHRvIGBSU1ZQLmhhc2hgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyB0aGUgcmVhc29uIHRvIHRoZSByZWplY3Rpb24gaGFuZGxlci4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcHJvbWlzZXMgPSB7CiAgICAgIG15UHJvbWlzZTogUlNWUC5yZXNvbHZlKDEpLAogICAgICByZWplY3RlZFByb21pc2U6IFJTVlAucmVqZWN0KG5ldyBFcnJvcigncmVqZWN0ZWRQcm9taXNlJykpLAogICAgICBhbm90aGVyUmVqZWN0ZWRQcm9taXNlOiBSU1ZQLnJlamVjdChuZXcgRXJyb3IoJ2Fub3RoZXJSZWplY3RlZFByb21pc2UnKSksCiAgICB9OwogIAogICAgUlNWUC5oYXNoKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uKGhhc2gpewogICAgICAvLyBDb2RlIGhlcmUgbmV2ZXIgcnVucyBiZWNhdXNlIHRoZXJlIGFyZSByZWplY3RlZCBwcm9taXNlcyEKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAvLyByZWFzb24ubWVzc2FnZSA9PT0gJ3JlamVjdGVkUHJvbWlzZScKICAgIH0pOwogICAgYGBgCiAgCiAgICBBbiBpbXBvcnRhbnQgbm90ZTogYFJTVlAuaGFzaGAgaXMgaW50ZW5kZWQgZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cyB0aGF0CiAgICBhcmUganVzdCBhIHNldCBvZiBrZXlzIGFuZCB2YWx1ZXMuIGBSU1ZQLmhhc2hgIHdpbGwgTk9UIHByZXNlcnZlIHByb3RvdHlwZQogICAgY2hhaW5zLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGZ1bmN0aW9uIE15Q29uc3RydWN0b3IoKXsKICAgICAgdGhpcy5leGFtcGxlID0gUlNWUC5yZXNvbHZlKCdFeGFtcGxlJyk7CiAgICB9CiAgCiAgICBNeUNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IHsKICAgICAgcHJvdG9Qcm9wZXJ0eTogUlNWUC5yZXNvbHZlKCdQcm90byBQcm9wZXJ0eScpCiAgICB9OwogIAogICAgbGV0IG15T2JqZWN0ID0gbmV3IE15Q29uc3RydWN0b3IoKTsKICAKICAgIFJTVlAuaGFzaChteU9iamVjdCkudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gcHJvdG9Qcm9wZXJ0eSB3aWxsIG5vdCBiZSBwcmVzZW50LCBpbnN0ZWFkIHlvdSB3aWxsIGp1c3QgaGF2ZSBhbgogICAgICAvLyBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAvLyB7CiAgICAgIC8vICAgZXhhbXBsZTogJ0V4YW1wbGUnCiAgICAgIC8vIH0KICAgICAgLy8KICAgICAgLy8gaGFzaC5oYXNPd25Qcm9wZXJ0eSgncHJvdG9Qcm9wZXJ0eScpOyAvLyBmYWxzZQogICAgICAvLyAndW5kZWZpbmVkJyA9PT0gdHlwZW9mIGhhc2gucHJvdG9Qcm9wZXJ0eQogICAgfSk7CiAgICBgYGAKICAKICAgIEBtZXRob2QgaGFzaAogICAgQHN0YXRpYwogICAgQGZvciBSU1ZQCiAgICBAcGFyYW0ge09iamVjdH0gb2JqZWN0CiAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIHRoYXQgZGVzY3JpYmVzIHRoZSBwcm9taXNlLgogICAgVXNlZnVsIGZvciB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aGVuIGFsbCBwcm9wZXJ0aWVzIG9mIGBwcm9taXNlc2AKICAgIGhhdmUgYmVlbiBmdWxmaWxsZWQsIG9yIHJlamVjdGVkIGlmIGFueSBvZiB0aGVtIGJlY29tZSByZWplY3RlZC4KICAqLwogIGZ1bmN0aW9uIGhhc2gob2JqZWN0LCBsYWJlbCkgewogICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqZWN0ICE9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcigiUHJvbWlzZS5oYXNoIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gb2JqZWN0IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IFByb21pc2VIYXNoKFByb21pc2UsIG9iamVjdCwgbGFiZWwpLnByb21pc2U7CiAgfQoKICB2YXIgSGFzaFNldHRsZWQgPSBmdW5jdGlvbiAoX1Byb21pc2VIYXNoKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEhhc2hTZXR0bGVkLCBfUHJvbWlzZUhhc2gpOwoKICAgIGZ1bmN0aW9uIEhhc2hTZXR0bGVkKENvbnN0cnVjdG9yLCBvYmplY3QsIGxhYmVsKSB7CiAgICAgICgwLCBfZW1iZXJCYWJlbC5jbGFzc0NhbGxDaGVjaykodGhpcywgSGFzaFNldHRsZWQpOwogICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9Qcm9taXNlSGFzaC5jYWxsKHRoaXMsIENvbnN0cnVjdG9yLCBvYmplY3QsIGZhbHNlLCBsYWJlbCkpOwogICAgfQoKICAgIHJldHVybiBIYXNoU2V0dGxlZDsKICB9KFByb21pc2VIYXNoKTsKCiAgSGFzaFNldHRsZWQucHJvdG90eXBlLl9zZXRSZXN1bHRBdCA9IHNldFNldHRsZWRSZXN1bHQ7CgogIC8qKgogICAgYFJTVlAuaGFzaFNldHRsZWRgIGlzIHNpbWlsYXIgdG8gYFJTVlAuYWxsU2V0dGxlZGAsIGJ1dCB0YWtlcyBhbiBvYmplY3QKICAgIGluc3RlYWQgb2YgYW4gYXJyYXkgZm9yIGl0cyBgcHJvbWlzZXNgIGFyZ3VtZW50LgogIAogICAgVW5saWtlIGBSU1ZQLmFsbGAgb3IgYFJTVlAuaGFzaGAsIHdoaWNoIGltcGxlbWVudCBhIGZhaWwtZmFzdCBtZXRob2QsCiAgICBidXQgbGlrZSBgUlNWUC5hbGxTZXR0bGVkYCwgYGhhc2hTZXR0bGVkYCB3YWl0cyB1bnRpbCBhbGwgdGhlCiAgICBjb25zdGl0dWVudCBwcm9taXNlcyBoYXZlIHJldHVybmVkIGFuZCB0aGVuIHNob3dzIHlvdSBhbGwgdGhlIHJlc3VsdHMKICAgIHdpdGggdGhlaXIgc3RhdGVzIGFuZCB2YWx1ZXMvcmVhc29ucy4gVGhpcyBpcyB1c2VmdWwgaWYgeW91IHdhbnQgdG8KICAgIGhhbmRsZSBtdWx0aXBsZSBwcm9taXNlcycgZmFpbHVyZSBzdGF0ZXMgdG9nZXRoZXIgYXMgYSBzZXQuCiAgCiAgICBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aGVuIGFsbCB0aGUgZ2l2ZW4gcHJvbWlzZXMgaGF2ZSBiZWVuCiAgICBzZXR0bGVkLCBvciByZWplY3RlZCBpZiB0aGUgcGFzc2VkIHBhcmFtZXRlcnMgYXJlIGludmFsaWQuCiAgCiAgICBUaGUgcmV0dXJuZWQgcHJvbWlzZSBpcyBmdWxmaWxsZWQgd2l0aCBhIGhhc2ggdGhhdCBoYXMgdGhlIHNhbWUga2V5IG5hbWVzIGFzCiAgICB0aGUgYHByb21pc2VzYCBvYmplY3QgYXJndW1lbnQuIElmIGFueSBvZiB0aGUgdmFsdWVzIGluIHRoZSBvYmplY3QgYXJlIG5vdAogICAgcHJvbWlzZXMsIHRoZXkgd2lsbCBiZSBjb3BpZWQgb3ZlciB0byB0aGUgZnVsZmlsbGVkIG9iamVjdCBhbmQgbWFya2VkIHdpdGggc3RhdGUKICAgICdmdWxmaWxsZWQnLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlcyA9IHsKICAgICAgbXlQcm9taXNlOiBSU1ZQLlByb21pc2UucmVzb2x2ZSgxKSwKICAgICAgeW91clByb21pc2U6IFJTVlAuUHJvbWlzZS5yZXNvbHZlKDIpLAogICAgICB0aGVpclByb21pc2U6IFJTVlAuUHJvbWlzZS5yZXNvbHZlKDMpLAogICAgICBub3RBUHJvbWlzZTogNAogICAgfTsKICAKICAgIFJTVlAuaGFzaFNldHRsZWQocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24oaGFzaCl7CiAgICAgIC8vIGhhc2ggaGVyZSBpcyBhbiBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAvLyB7CiAgICAgIC8vICAgbXlQcm9taXNlOiB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IDEgfSwKICAgICAgLy8gICB5b3VyUHJvbWlzZTogeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiAyIH0sCiAgICAgIC8vICAgdGhlaXJQcm9taXNlOiB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IDMgfSwKICAgICAgLy8gICBub3RBUHJvbWlzZTogeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiA0IH0KICAgICAgLy8gfQogICAgfSk7CiAgICBgYGAKICAKICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgUlNWUC5oYXNoYCBhcmUgcmVqZWN0ZWQsIHRoZSBzdGF0ZSB3aWxsCiAgICBiZSBzZXQgdG8gJ3JlamVjdGVkJyBhbmQgdGhlIHJlYXNvbiBmb3IgcmVqZWN0aW9uIHByb3ZpZGVkLgogIAogICAgRXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCBwcm9taXNlcyA9IHsKICAgICAgbXlQcm9taXNlOiBSU1ZQLlByb21pc2UucmVzb2x2ZSgxKSwKICAgICAgcmVqZWN0ZWRQcm9taXNlOiBSU1ZQLlByb21pc2UucmVqZWN0KG5ldyBFcnJvcigncmVqZWN0aW9uJykpLAogICAgICBhbm90aGVyUmVqZWN0ZWRQcm9taXNlOiBSU1ZQLlByb21pc2UucmVqZWN0KG5ldyBFcnJvcignbW9yZSByZWplY3Rpb24nKSksCiAgICB9OwogIAogICAgUlNWUC5oYXNoU2V0dGxlZChwcm9taXNlcykudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gaGFzaCBoZXJlIGlzIGFuIG9iamVjdCB0aGF0IGxvb2tzIGxpa2U6CiAgICAgIC8vIHsKICAgICAgLy8gICBteVByb21pc2U6ICAgICAgICAgICAgICB7IHN0YXRlOiAnZnVsZmlsbGVkJywgdmFsdWU6IDEgfSwKICAgICAgLy8gICByZWplY3RlZFByb21pc2U6ICAgICAgICB7IHN0YXRlOiAncmVqZWN0ZWQnLCByZWFzb246IEVycm9yIH0sCiAgICAgIC8vICAgYW5vdGhlclJlamVjdGVkUHJvbWlzZTogeyBzdGF0ZTogJ3JlamVjdGVkJywgcmVhc29uOiBFcnJvciB9LAogICAgICAvLyB9CiAgICAgIC8vIE5vdGUgdGhhdCBmb3IgcmVqZWN0ZWRQcm9taXNlLCByZWFzb24ubWVzc2FnZSA9PSAncmVqZWN0aW9uJywKICAgICAgLy8gYW5kIGZvciBhbm90aGVyUmVqZWN0ZWRQcm9taXNlLCByZWFzb24ubWVzc2FnZSA9PSAnbW9yZSByZWplY3Rpb24nLgogICAgfSk7CiAgICBgYGAKICAKICAgIEFuIGltcG9ydGFudCBub3RlOiBgUlNWUC5oYXNoU2V0dGxlZGAgaXMgaW50ZW5kZWQgZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cyB0aGF0CiAgICBhcmUganVzdCBhIHNldCBvZiBrZXlzIGFuZCB2YWx1ZXMuIGBSU1ZQLmhhc2hTZXR0bGVkYCB3aWxsIE5PVCBwcmVzZXJ2ZSBwcm90b3R5cGUKICAgIGNoYWlucy4KICAKICAgIEV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBmdW5jdGlvbiBNeUNvbnN0cnVjdG9yKCl7CiAgICAgIHRoaXMuZXhhbXBsZSA9IFJTVlAuUHJvbWlzZS5yZXNvbHZlKCdFeGFtcGxlJyk7CiAgICB9CiAgCiAgICBNeUNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IHsKICAgICAgcHJvdG9Qcm9wZXJ0eTogUlNWUC5Qcm9taXNlLnJlc29sdmUoJ1Byb3RvIFByb3BlcnR5JykKICAgIH07CiAgCiAgICBsZXQgbXlPYmplY3QgPSBuZXcgTXlDb25zdHJ1Y3RvcigpOwogIAogICAgUlNWUC5oYXNoU2V0dGxlZChteU9iamVjdCkudGhlbihmdW5jdGlvbihoYXNoKXsKICAgICAgLy8gcHJvdG9Qcm9wZXJ0eSB3aWxsIG5vdCBiZSBwcmVzZW50LCBpbnN0ZWFkIHlvdSB3aWxsIGp1c3QgaGF2ZSBhbgogICAgICAvLyBvYmplY3QgdGhhdCBsb29rcyBsaWtlOgogICAgICAvLyB7CiAgICAgIC8vICAgZXhhbXBsZTogeyBzdGF0ZTogJ2Z1bGZpbGxlZCcsIHZhbHVlOiAnRXhhbXBsZScgfQogICAgICAvLyB9CiAgICAgIC8vCiAgICAgIC8vIGhhc2guaGFzT3duUHJvcGVydHkoJ3Byb3RvUHJvcGVydHknKTsgLy8gZmFsc2UKICAgICAgLy8gJ3VuZGVmaW5lZCcgPT09IHR5cGVvZiBoYXNoLnByb3RvUHJvcGVydHkKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGhhc2hTZXR0bGVkCiAgICBAZm9yIFJTVlAKICAgIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QKICAgIEBwYXJhbSB7U3RyaW5nfSBsYWJlbCBvcHRpb25hbCBzdHJpbmcgdGhhdCBkZXNjcmliZXMgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdoZW4gd2hlbiBhbGwgcHJvcGVydGllcyBvZiBgcHJvbWlzZXNgCiAgICBoYXZlIGJlZW4gc2V0dGxlZC4KICAgIEBzdGF0aWMKICAqLwoKICBmdW5jdGlvbiBoYXNoU2V0dGxlZChvYmplY3QsIGxhYmVsKSB7CiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgVHlwZUVycm9yKCJSU1ZQLmhhc2hTZXR0bGVkIG11c3QgYmUgY2FsbGVkIHdpdGggYW4gb2JqZWN0IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEhhc2hTZXR0bGVkKFByb21pc2UsIG9iamVjdCwgZmFsc2UsIGxhYmVsKS5wcm9taXNlOwogIH0KCiAgLyoqCiAgICBgUlNWUC5yZXRocm93YCB3aWxsIHJldGhyb3cgYW4gZXJyb3Igb24gdGhlIG5leHQgdHVybiBvZiB0aGUgSmF2YVNjcmlwdCBldmVudAogICAgbG9vcCBpbiBvcmRlciB0byBhaWQgZGVidWdnaW5nLgogIAogICAgUHJvbWlzZXMgQSsgc3BlY2lmaWVzIHRoYXQgYW55IGV4Y2VwdGlvbnMgdGhhdCBvY2N1ciB3aXRoIGEgcHJvbWlzZSBtdXN0IGJlCiAgICBjYXVnaHQgYnkgdGhlIHByb21pc2VzIGltcGxlbWVudGF0aW9uIGFuZCBidWJibGVkIHRvIHRoZSBsYXN0IGhhbmRsZXIuIEZvcgogICAgdGhpcyByZWFzb24sIGl0IGlzIHJlY29tbWVuZGVkIHRoYXQgeW91IGFsd2F5cyBzcGVjaWZ5IGEgc2Vjb25kIHJlamVjdGlvbgogICAgaGFuZGxlciBmdW5jdGlvbiB0byBgdGhlbmAuIEhvd2V2ZXIsIGBSU1ZQLnJldGhyb3dgIHdpbGwgdGhyb3cgdGhlIGV4Y2VwdGlvbgogICAgb3V0c2lkZSBvZiB0aGUgcHJvbWlzZSwgc28gaXQgYnViYmxlcyB1cCB0byB5b3VyIGNvbnNvbGUgaWYgaW4gdGhlIGJyb3dzZXIsCiAgICBvciBkb21haW4vY2F1c2UgdW5jYXVnaHQgZXhjZXB0aW9uIGluIE5vZGUuIGByZXRocm93YCB3aWxsIGFsc28gdGhyb3cgdGhlCiAgICBlcnJvciBhZ2FpbiBzbyB0aGUgZXJyb3IgY2FuIGJlIGhhbmRsZWQgYnkgdGhlIHByb21pc2UgcGVyIHRoZSBzcGVjLgogIAogICAgYGBgamF2YXNjcmlwdAogICAgZnVuY3Rpb24gdGhyb3dzKCl7CiAgICAgIHRocm93IG5ldyBFcnJvcignV2hvb3BzIScpOwogICAgfQogIAogICAgbGV0IHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCl7CiAgICAgIHRocm93cygpOwogICAgfSk7CiAgCiAgICBwcm9taXNlLmNhdGNoKFJTVlAucmV0aHJvdykudGhlbihmdW5jdGlvbigpewogICAgICAvLyBDb2RlIGhlcmUgZG9lc24ndCBydW4gYmVjYXVzZSB0aGUgcHJvbWlzZSBiZWNhbWUgcmVqZWN0ZWQgZHVlIHRvIGFuCiAgICAgIC8vIGVycm9yIQogICAgfSwgZnVuY3Rpb24gKGVycil7CiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgaGVyZQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSAnV2hvb3BzJyBlcnJvciB3aWxsIGJlIHRocm93biBvbiB0aGUgbmV4dCB0dXJuIG9mIHRoZSBldmVudCBsb29wCiAgICBhbmQgeW91IGNhbiB3YXRjaCBmb3IgaXQgaW4geW91ciBjb25zb2xlLiBZb3UgY2FuIGFsc28gaGFuZGxlIGl0IHVzaW5nIGEKICAgIHJlamVjdGlvbiBoYW5kbGVyIGdpdmVuIHRvIGAudGhlbmAgb3IgYC5jYXRjaGAgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgCiAgICBAbWV0aG9kIHJldGhyb3cKICAgIEBzdGF0aWMKICAgIEBmb3IgUlNWUAogICAgQHBhcmFtIHtFcnJvcn0gcmVhc29uIHJlYXNvbiB0aGUgcHJvbWlzZSBiZWNhbWUgcmVqZWN0ZWQuCiAgICBAdGhyb3dzIEVycm9yCiAgICBAc3RhdGljCiAgKi8KICBmdW5jdGlvbiByZXRocm93KHJlYXNvbikgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHRocm93IHJlYXNvbjsKICAgIH0pOwogICAgdGhyb3cgcmVhc29uOwogIH0KCiAgLyoqCiAgICBgUlNWUC5kZWZlcmAgcmV0dXJucyBhbiBvYmplY3Qgc2ltaWxhciB0byBqUXVlcnkncyBgJC5EZWZlcnJlZGAuCiAgICBgUlNWUC5kZWZlcmAgc2hvdWxkIGJlIHVzZWQgd2hlbiBwb3J0aW5nIG92ZXIgY29kZSByZWxpYW50IG9uIGAkLkRlZmVycmVkYCdzCiAgICBpbnRlcmZhY2UuIE5ldyBjb2RlIHNob3VsZCB1c2UgdGhlIGBSU1ZQLlByb21pc2VgIGNvbnN0cnVjdG9yIGluc3RlYWQuCiAgCiAgICBUaGUgb2JqZWN0IHJldHVybmVkIGZyb20gYFJTVlAuZGVmZXJgIGlzIGEgcGxhaW4gb2JqZWN0IHdpdGggdGhyZWUgcHJvcGVydGllczoKICAKICAgICogcHJvbWlzZSAtIGFuIGBSU1ZQLlByb21pc2VgLgogICAgKiByZWplY3QgLSBhIGZ1bmN0aW9uIHRoYXQgY2F1c2VzIHRoZSBgcHJvbWlzZWAgcHJvcGVydHkgb24gdGhpcyBvYmplY3QgdG8KICAgICAgYmVjb21lIHJlamVjdGVkCiAgICAqIHJlc29sdmUgLSBhIGZ1bmN0aW9uIHRoYXQgY2F1c2VzIHRoZSBgcHJvbWlzZWAgcHJvcGVydHkgb24gdGhpcyBvYmplY3QgdG8KICAgICAgYmVjb21lIGZ1bGZpbGxlZC4KICAKICAgIEV4YW1wbGU6CiAgCiAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBkZWZlcnJlZCA9IFJTVlAuZGVmZXIoKTsKICAKICAgICBkZWZlcnJlZC5yZXNvbHZlKCJTdWNjZXNzISIpOwogIAogICAgIGRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAvLyB2YWx1ZSBoZXJlIGlzICJTdWNjZXNzISIKICAgICB9KTsKICAgICBgYGAKICAKICAgIEBtZXRob2QgZGVmZXIKICAgIEBzdGF0aWMKICAgIEBmb3IgUlNWUAogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgbGFiZWxpbmcgdGhlIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtPYmplY3R9CiAgICovCgogIGZ1bmN0aW9uIGRlZmVyKGxhYmVsKSB7CiAgICB2YXIgZGVmZXJyZWQgPSB7IHJlc29sdmU6IHVuZGVmaW5lZCwgcmVqZWN0OiB1bmRlZmluZWQgfTsKCiAgICBkZWZlcnJlZC5wcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBkZWZlcnJlZC5yZXNvbHZlID0gcmVzb2x2ZTsKICAgICAgZGVmZXJyZWQucmVqZWN0ID0gcmVqZWN0OwogICAgfSwgbGFiZWwpOwoKICAgIHJldHVybiBkZWZlcnJlZDsKICB9CgogIHZhciBNYXBFbnVtZXJhdG9yID0gZnVuY3Rpb24gKF9FbnVtZXJhdG9yMykgewogICAgKDAsIF9lbWJlckJhYmVsLmluaGVyaXRzKShNYXBFbnVtZXJhdG9yLCBfRW51bWVyYXRvcjMpOwoKICAgIGZ1bmN0aW9uIE1hcEVudW1lcmF0b3IoQ29uc3RydWN0b3IsIGVudHJpZXMsIG1hcEZuLCBsYWJlbCkgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIE1hcEVudW1lcmF0b3IpOwogICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9FbnVtZXJhdG9yMy5jYWxsKHRoaXMsIENvbnN0cnVjdG9yLCBlbnRyaWVzLCB0cnVlLCBsYWJlbCwgbWFwRm4pKTsKICAgIH0KCiAgICBNYXBFbnVtZXJhdG9yLnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIF9pbml0KENvbnN0cnVjdG9yLCBpbnB1dCwgYm9vbCwgbGFiZWwsIG1hcEZuKSB7CiAgICAgIHZhciBsZW4gPSBpbnB1dC5sZW5ndGggfHwgMDsKICAgICAgdGhpcy5sZW5ndGggPSBsZW47CiAgICAgIHRoaXMuX3JlbWFpbmluZyA9IGxlbjsKICAgICAgdGhpcy5fcmVzdWx0ID0gbmV3IEFycmF5KGxlbik7CiAgICAgIHRoaXMuX21hcEZuID0gbWFwRm47CgogICAgICB0aGlzLl9lbnVtZXJhdGUoaW5wdXQpOwogICAgfTsKCiAgICBNYXBFbnVtZXJhdG9yLnByb3RvdHlwZS5fc2V0UmVzdWx0QXQgPSBmdW5jdGlvbiBfc2V0UmVzdWx0QXQoc3RhdGUsIGksIHZhbHVlLCBmaXJzdFBhc3MpIHsKICAgICAgaWYgKGZpcnN0UGFzcykgewogICAgICAgIHZhciB2YWwgPSB0cnlDYXRjaCh0aGlzLl9tYXBGbikodmFsdWUsIGkpOwogICAgICAgIGlmICh2YWwgPT09IFRSWV9DQVRDSF9FUlJPUikgewogICAgICAgICAgdGhpcy5fc2V0dGxlZEF0KFJFSkVDVEVELCBpLCB2YWwuZXJyb3IsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fZWFjaEVudHJ5KHZhbCwgaSwgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgICB0aGlzLl9yZXN1bHRbaV0gPSB2YWx1ZTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gTWFwRW51bWVyYXRvcjsKICB9KEVudW1lcmF0b3IpOwoKICAvKioKICAgYFJTVlAubWFwYCBpcyBzaW1pbGFyIHRvIEphdmFTY3JpcHQncyBuYXRpdmUgYG1hcGAgbWV0aG9kLiBgbWFwRm5gIGlzIGVhZ2VybHkgY2FsbGVkCiAgICBtZWFuaW5nIHRoYXQgYXMgc29vbiBhcyBhbnkgcHJvbWlzZSByZXNvbHZlcyBpdHMgdmFsdWUgd2lsbCBiZSBwYXNzZWQgdG8gYG1hcEZuYC4KICAgIGBSU1ZQLm1hcGAgcmV0dXJucyBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIHJ1bm5pbmcKICAgIGBtYXBGbmAgb24gdGhlIHZhbHVlcyB0aGUgcHJvbWlzZXMgYmVjb21lIGZ1bGZpbGxlZCB3aXRoLgogIAogICAgRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgCiAgICBsZXQgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSBSU1ZQLnJlc29sdmUoMik7CiAgICBsZXQgcHJvbWlzZTMgPSBSU1ZQLnJlc29sdmUoMyk7CiAgICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKICAKICAgIGxldCBtYXBGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSArIDE7CiAgICB9OwogIAogICAgUlNWUC5tYXAocHJvbWlzZXMsIG1hcEZuKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgIC8vIHJlc3VsdCBpcyBbIDIsIDMsIDQgXQogICAgfSk7CiAgICBgYGAKICAKICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgUlNWUC5tYXBgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyBhbiBhcmd1bWVudCB0byB0aGUgcmV0dXJuZWQgcHJvbWlzZSdzCiAgICByZWplY3Rpb24gaGFuZGxlci4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSBSU1ZQLnJlamVjdChuZXcgRXJyb3IoJzInKSk7CiAgICBsZXQgcHJvbWlzZTMgPSBSU1ZQLnJlamVjdChuZXcgRXJyb3IoJzMnKSk7CiAgICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKICAKICAgIGxldCBtYXBGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSArIDE7CiAgICB9OwogIAogICAgUlNWUC5tYXAocHJvbWlzZXMsIG1hcEZuKS50aGVuKGZ1bmN0aW9uKGFycmF5KXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICcyJwogICAgfSk7CiAgICBgYGAKICAKICAgIGBSU1ZQLm1hcGAgd2lsbCBhbHNvIHdhaXQgaWYgYSBwcm9taXNlIGlzIHJldHVybmVkIGZyb20gYG1hcEZuYC4gRm9yIGV4YW1wbGUsCiAgICBzYXkgeW91IHdhbnQgdG8gZ2V0IGFsbCBjb21tZW50cyBmcm9tIGEgc2V0IG9mIGJsb2cgcG9zdHMsIGJ1dCB5b3UgbmVlZAogICAgdGhlIGJsb2cgcG9zdHMgZmlyc3QgYmVjYXVzZSB0aGV5IGNvbnRhaW4gYSB1cmwgdG8gdGhvc2UgY29tbWVudHMuCiAgCiAgICBgYGBqYXZzY3JpcHQKICAKICAgIGxldCBtYXBGbiA9IGZ1bmN0aW9uKGJsb2dQb3N0KXsKICAgICAgLy8gZ2V0Q29tbWVudHMgZG9lcyBzb21lIGFqYXggYW5kIHJldHVybnMgYW4gUlNWUC5Qcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkCiAgICAgIC8vIHdpdGggc29tZSBjb21tZW50cyBkYXRhCiAgICAgIHJldHVybiBnZXRDb21tZW50cyhibG9nUG9zdC5jb21tZW50c191cmwpOwogICAgfTsKICAKICAgIC8vIGdldEJsb2dQb3N0cyBkb2VzIHNvbWUgYWpheCBhbmQgcmV0dXJucyBhbiBSU1ZQLlByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQKICAgIC8vIHdpdGggc29tZSBibG9nIHBvc3QgZGF0YQogICAgUlNWUC5tYXAoZ2V0QmxvZ1Bvc3RzKCksIG1hcEZuKS50aGVuKGZ1bmN0aW9uKGNvbW1lbnRzKXsKICAgICAgLy8gY29tbWVudHMgaXMgdGhlIHJlc3VsdCBvZiBhc2tpbmcgdGhlIHNlcnZlciBmb3IgdGhlIGNvbW1lbnRzCiAgICAgIC8vIG9mIGFsbCBibG9nIHBvc3RzIHJldHVybmVkIGZyb20gZ2V0QmxvZ1Bvc3RzKCkKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIG1hcAogICAgQHN0YXRpYwogICAgQGZvciBSU1ZQCiAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcwogICAgQHBhcmFtIHtGdW5jdGlvbn0gbWFwRm4gZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGVhY2ggZnVsZmlsbGVkIHByb21pc2UuCiAgICBAcGFyYW0ge1N0cmluZ30gbGFiZWwgb3B0aW9uYWwgc3RyaW5nIGZvciBsYWJlbGluZyB0aGUgcHJvbWlzZS4KICAgIFVzZWZ1bCBmb3IgdG9vbGluZy4KICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2l0aCB0aGUgcmVzdWx0IG9mIGNhbGxpbmcKICAgIGBtYXBGbmAgb24gZWFjaCBmdWxmaWxsZWQgcHJvbWlzZSBvciB2YWx1ZSB3aGVuIHRoZXkgYmVjb21lIGZ1bGZpbGxlZC4KICAgICBUaGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGlmIGFueSBvZiB0aGUgZ2l2ZW4gYHByb21pc2VzYCBiZWNvbWUgcmVqZWN0ZWQuCiAgICBAc3RhdGljCiAgKi8KICBmdW5jdGlvbiBtYXAocHJvbWlzZXMsIG1hcEZuLCBsYWJlbCkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHByb21pc2VzKSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcigiUlNWUC5tYXAgbXVzdCBiZSBjYWxsZWQgd2l0aCBhbiBhcnJheSIpLCBsYWJlbCk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXBGbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcigiUlNWUC5tYXAgZXhwZWN0cyBhIGZ1bmN0aW9uIGFzIGEgc2Vjb25kIGFyZ3VtZW50IiksIGxhYmVsKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IE1hcEVudW1lcmF0b3IoUHJvbWlzZSwgcHJvbWlzZXMsIG1hcEZuLCBsYWJlbCkucHJvbWlzZTsKICB9CgogIC8qKgogICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBSU1ZQLlByb21pc2UucmVzb2x2ZWAuCiAgCiAgICBAbWV0aG9kIHJlc29sdmUKICAgIEBzdGF0aWMKICAgIEBmb3IgUlNWUAogICAgQHBhcmFtIHsqfSB2YWx1ZSB2YWx1ZSB0aGF0IHRoZSByZXR1cm5lZCBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aAogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlY29tZSBmdWxmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgIGB2YWx1ZWAKICAqLwogIGZ1bmN0aW9uIHJlc29sdmUkMih2YWx1ZSwgbGFiZWwpIHsKICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodmFsdWUsIGxhYmVsKTsKICB9CgogIC8qKgogICAgVGhpcyBpcyBhIGNvbnZlbmllbnQgYWxpYXMgZm9yIGBSU1ZQLlByb21pc2UucmVqZWN0YC4KICAKICAgIEBtZXRob2QgcmVqZWN0CiAgICBAc3RhdGljCiAgICBAZm9yIFJTVlAKICAgIEBwYXJhbSB7Kn0gcmVhc29uIHZhbHVlIHRoYXQgdGhlIHJldHVybmVkIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoLgogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBmb3IgaWRlbnRpZnlpbmcgdGhlIHJldHVybmVkIHByb21pc2UuCiAgICBVc2VmdWwgZm9yIHRvb2xpbmcuCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgcmVqZWN0ZWQgd2l0aCB0aGUgZ2l2ZW4gYHJlYXNvbmAuCiAgKi8KICBmdW5jdGlvbiByZWplY3QkMihyZWFzb24sIGxhYmVsKSB7CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVhc29uLCBsYWJlbCk7CiAgfQoKICB2YXIgRU1QVFlfT0JKRUNUID0ge307CgogIHZhciBGaWx0ZXJFbnVtZXJhdG9yID0gZnVuY3Rpb24gKF9NYXBFbnVtZXJhdG9yKSB7CiAgICAoMCwgX2VtYmVyQmFiZWwuaW5oZXJpdHMpKEZpbHRlckVudW1lcmF0b3IsIF9NYXBFbnVtZXJhdG9yKTsKCiAgICBmdW5jdGlvbiBGaWx0ZXJFbnVtZXJhdG9yKCkgewogICAgICAoMCwgX2VtYmVyQmFiZWwuY2xhc3NDYWxsQ2hlY2spKHRoaXMsIEZpbHRlckVudW1lcmF0b3IpOwogICAgICByZXR1cm4gKDAsIF9lbWJlckJhYmVsLnBvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4pKHRoaXMsIF9NYXBFbnVtZXJhdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgfQoKICAgIEZpbHRlckVudW1lcmF0b3IucHJvdG90eXBlLl9jaGVja0Z1bGxmaWxsbWVudCA9IGZ1bmN0aW9uIF9jaGVja0Z1bGxmaWxsbWVudCgpIHsKICAgICAgaWYgKHRoaXMuX3JlbWFpbmluZyA9PT0gMCAmJiB0aGlzLl9yZXN1bHQgIT09IG51bGwpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5fcmVzdWx0LmZpbHRlcihmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICByZXR1cm4gdmFsICE9PSBFTVBUWV9PQkpFQ1Q7CiAgICAgICAgfSk7CiAgICAgICAgZnVsZmlsbCh0aGlzLnByb21pc2UsIHJlc3VsdCk7CiAgICAgICAgdGhpcy5fcmVzdWx0ID0gbnVsbDsKICAgICAgfQogICAgfTsKCiAgICBGaWx0ZXJFbnVtZXJhdG9yLnByb3RvdHlwZS5fc2V0UmVzdWx0QXQgPSBmdW5jdGlvbiBfc2V0UmVzdWx0QXQoc3RhdGUsIGksIHZhbHVlLCBmaXJzdFBhc3MpIHsKICAgICAgaWYgKGZpcnN0UGFzcykgewogICAgICAgIHRoaXMuX3Jlc3VsdFtpXSA9IHZhbHVlOwogICAgICAgIHZhciB2YWwgPSB0cnlDYXRjaCh0aGlzLl9tYXBGbikodmFsdWUsIGkpOwogICAgICAgIGlmICh2YWwgPT09IFRSWV9DQVRDSF9FUlJPUikgewogICAgICAgICAgdGhpcy5fc2V0dGxlZEF0KFJFSkVDVEVELCBpLCB2YWwuZXJyb3IsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fZWFjaEVudHJ5KHZhbCwgaSwgZmFsc2UpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9yZW1haW5pbmctLTsKICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICB0aGlzLl9yZXN1bHRbaV0gPSBFTVBUWV9PQkpFQ1Q7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBGaWx0ZXJFbnVtZXJhdG9yOwogIH0oTWFwRW51bWVyYXRvcik7CgogIC8qKgogICBgUlNWUC5maWx0ZXJgIGlzIHNpbWlsYXIgdG8gSmF2YVNjcmlwdCdzIG5hdGl2ZSBgZmlsdGVyYCBtZXRob2QuCiAgIGBmaWx0ZXJGbmAgaXMgZWFnZXJseSBjYWxsZWQgbWVhbmluZyB0aGF0IGFzIHNvb24gYXMgYW55IHByb21pc2UKICAgIHJlc29sdmVzIGl0cyB2YWx1ZSB3aWxsIGJlIHBhc3NlZCB0byBgZmlsdGVyRm5gLiBgUlNWUC5maWx0ZXJgIHJldHVybnMKICAgIGEgcHJvbWlzZSB0aGF0IHdpbGwgYmVjb21lIGZ1bGZpbGxlZCB3aXRoIHRoZSByZXN1bHQgb2YgcnVubmluZwogICAgYGZpbHRlckZuYCBvbiB0aGUgdmFsdWVzIHRoZSBwcm9taXNlcyBiZWNvbWUgZnVsZmlsbGVkIHdpdGguCiAgCiAgICBGb3IgZXhhbXBsZToKICAKICAgIGBgYGphdmFzY3JpcHQKICAKICAgIGxldCBwcm9taXNlMSA9IFJTVlAucmVzb2x2ZSgxKTsKICAgIGxldCBwcm9taXNlMiA9IFJTVlAucmVzb2x2ZSgyKTsKICAgIGxldCBwcm9taXNlMyA9IFJTVlAucmVzb2x2ZSgzKTsKICAKICAgIGxldCBwcm9taXNlcyA9IFtwcm9taXNlMSwgcHJvbWlzZTIsIHByb21pc2UzXTsKICAKICAgIGxldCBmaWx0ZXJGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSA+IDE7CiAgICB9OwogIAogICAgUlNWUC5maWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgIC8vIHJlc3VsdCBpcyBbIDIsIDMgXQogICAgfSk7CiAgICBgYGAKICAKICAgIElmIGFueSBvZiB0aGUgYHByb21pc2VzYCBnaXZlbiB0byBgUlNWUC5maWx0ZXJgIGFyZSByZWplY3RlZCwgdGhlIGZpcnN0IHByb21pc2UKICAgIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBiZSBnaXZlbiBhcyBhbiBhcmd1bWVudCB0byB0aGUgcmV0dXJuZWQgcHJvbWlzZSdzCiAgICByZWplY3Rpb24gaGFuZGxlci4gRm9yIGV4YW1wbGU6CiAgCiAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcHJvbWlzZTEgPSBSU1ZQLnJlc29sdmUoMSk7CiAgICBsZXQgcHJvbWlzZTIgPSBSU1ZQLnJlamVjdChuZXcgRXJyb3IoJzInKSk7CiAgICBsZXQgcHJvbWlzZTMgPSBSU1ZQLnJlamVjdChuZXcgRXJyb3IoJzMnKSk7CiAgICBsZXQgcHJvbWlzZXMgPSBbIHByb21pc2UxLCBwcm9taXNlMiwgcHJvbWlzZTMgXTsKICAKICAgIGxldCBmaWx0ZXJGbiA9IGZ1bmN0aW9uKGl0ZW0pewogICAgICByZXR1cm4gaXRlbSA+IDE7CiAgICB9OwogIAogICAgUlNWUC5maWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuKS50aGVuKGZ1bmN0aW9uKGFycmF5KXsKICAgICAgLy8gQ29kZSBoZXJlIG5ldmVyIHJ1bnMgYmVjYXVzZSB0aGVyZSBhcmUgcmVqZWN0ZWQgcHJvbWlzZXMhCiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgLy8gcmVhc29uLm1lc3NhZ2UgPT09ICcyJwogICAgfSk7CiAgICBgYGAKICAKICAgIGBSU1ZQLmZpbHRlcmAgd2lsbCBhbHNvIHdhaXQgZm9yIGFueSBwcm9taXNlcyByZXR1cm5lZCBmcm9tIGBmaWx0ZXJGbmAuCiAgICBGb3IgaW5zdGFuY2UsIHlvdSBtYXkgd2FudCB0byBmZXRjaCBhIGxpc3Qgb2YgdXNlcnMgdGhlbiByZXR1cm4gYSBzdWJzZXQKICAgIG9mIHRob3NlIHVzZXJzIGJhc2VkIG9uIHNvbWUgYXN5bmNocm9ub3VzIG9wZXJhdGlvbjoKICAKICAgIGBgYGphdmFzY3JpcHQKICAKICAgIGxldCBhbGljZSA9IHsgbmFtZTogJ2FsaWNlJyB9OwogICAgbGV0IGJvYiAgID0geyBuYW1lOiAnYm9iJyB9OwogICAgbGV0IHVzZXJzID0gWyBhbGljZSwgYm9iIF07CiAgCiAgICBsZXQgcHJvbWlzZXMgPSB1c2Vycy5tYXAoZnVuY3Rpb24odXNlcil7CiAgICAgIHJldHVybiBSU1ZQLnJlc29sdmUodXNlcik7CiAgICB9KTsKICAKICAgIGxldCBmaWx0ZXJGbiA9IGZ1bmN0aW9uKHVzZXIpewogICAgICAvLyBIZXJlLCBBbGljZSBoYXMgcGVybWlzc2lvbnMgdG8gY3JlYXRlIGEgYmxvZyBwb3N0LCBidXQgQm9iIGRvZXMgbm90LgogICAgICByZXR1cm4gZ2V0UHJpdmlsZWdlc0ZvclVzZXIodXNlcikudGhlbihmdW5jdGlvbihwcml2cyl7CiAgICAgICAgcmV0dXJuIHByaXZzLmNhbl9jcmVhdGVfYmxvZ19wb3N0ID09PSB0cnVlOwogICAgICB9KTsKICAgIH07CiAgICBSU1ZQLmZpbHRlcihwcm9taXNlcywgZmlsdGVyRm4pLnRoZW4oZnVuY3Rpb24odXNlcnMpewogICAgICAvLyB0cnVlLCBiZWNhdXNlIHRoZSBzZXJ2ZXIgdG9sZCB1cyBvbmx5IEFsaWNlIGNhbiBjcmVhdGUgYSBibG9nIHBvc3QuCiAgICAgIHVzZXJzLmxlbmd0aCA9PT0gMTsKICAgICAgLy8gZmFsc2UsIGJlY2F1c2UgQWxpY2UgaXMgdGhlIG9ubHkgdXNlciBwcmVzZW50IGluIGB1c2Vyc2AKICAgICAgdXNlcnNbMF0gPT09IGJvYjsKICAgIH0pOwogICAgYGBgCiAgCiAgICBAbWV0aG9kIGZpbHRlcgogICAgQHN0YXRpYwogICAgQGZvciBSU1ZQCiAgICBAcGFyYW0ge0FycmF5fSBwcm9taXNlcwogICAgQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRm4gLSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gZWFjaCByZXNvbHZlZCB2YWx1ZSB0bwogICAgZmlsdGVyIHRoZSBmaW5hbCByZXN1bHRzLgogICAgQHBhcmFtIHtTdHJpbmd9IGxhYmVsIG9wdGlvbmFsIHN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9taXNlLiBVc2VmdWwgZm9yCiAgICB0b29saW5nLgogICAgQHJldHVybiB7UHJvbWlzZX0KICAqLwoKICBmdW5jdGlvbiBmaWx0ZXIocHJvbWlzZXMsIGZpbHRlckZuLCBsYWJlbCkgewogICAgaWYgKHR5cGVvZiBmaWx0ZXJGbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcigiUlNWUC5maWx0ZXIgZXhwZWN0cyBmdW5jdGlvbiBhcyBhIHNlY29uZCBhcmd1bWVudCIpLCBsYWJlbCk7CiAgICB9CgogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwcm9taXNlcywgbGFiZWwpLnRoZW4oZnVuY3Rpb24gKHByb21pc2VzKSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShwcm9taXNlcykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJSU1ZQLmZpbHRlciBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIGFycmF5Iik7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBGaWx0ZXJFbnVtZXJhdG9yKFByb21pc2UsIHByb21pc2VzLCBmaWx0ZXJGbiwgbGFiZWwpLnByb21pc2U7CiAgICB9KTsKICB9CgogIHZhciBsZW4gPSAwOwogIHZhciB2ZXJ0eE5leHQgPSB2b2lkIDA7CiAgZnVuY3Rpb24gYXNhcChjYWxsYmFjaywgYXJnKSB7CiAgICBxdWV1ZSQxW2xlbl0gPSBjYWxsYmFjazsKICAgIHF1ZXVlJDFbbGVuICsgMV0gPSBhcmc7CiAgICBsZW4gKz0gMjsKICAgIGlmIChsZW4gPT09IDIpIHsKICAgICAgLy8gSWYgbGVuIGlzIDEsIHRoYXQgbWVhbnMgdGhhdCB3ZSBuZWVkIHRvIHNjaGVkdWxlIGFuIGFzeW5jIGZsdXNoLgogICAgICAvLyBJZiBhZGRpdGlvbmFsIGNhbGxiYWNrcyBhcmUgcXVldWVkIGJlZm9yZSB0aGUgcXVldWUgaXMgZmx1c2hlZCwgdGhleQogICAgICAvLyB3aWxsIGJlIHByb2Nlc3NlZCBieSB0aGlzIGZsdXNoIHRoYXQgd2UgYXJlIHNjaGVkdWxpbmcuCiAgICAgIHNjaGVkdWxlRmx1c2gkMSgpOwogICAgfQogIH0KCiAgdmFyIGJyb3dzZXJXaW5kb3cgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHVuZGVmaW5lZDsKICB2YXIgYnJvd3Nlckdsb2JhbCA9IGJyb3dzZXJXaW5kb3cgfHwge307CiAgdmFyIEJyb3dzZXJNdXRhdGlvbk9ic2VydmVyID0gYnJvd3Nlckdsb2JhbC5NdXRhdGlvbk9ic2VydmVyIHx8IGJyb3dzZXJHbG9iYWwuV2ViS2l0TXV0YXRpb25PYnNlcnZlcjsKICB2YXIgaXNOb2RlID0gdHlwZW9mIHNlbGYgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyAmJiB7fS50b1N0cmluZy5jYWxsKHByb2Nlc3MpID09PSAnW29iamVjdCBwcm9jZXNzXSc7CgogIC8vIHRlc3QgZm9yIHdlYiB3b3JrZXIgYnV0IG5vdCBpbiBJRTEwCiAgdmFyIGlzV29ya2VyID0gdHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgaW1wb3J0U2NyaXB0cyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAndW5kZWZpbmVkJzsKCiAgLy8gbm9kZQogIGZ1bmN0aW9uIHVzZU5leHRUaWNrKCkgewogICAgdmFyIG5leHRUaWNrID0gcHJvY2Vzcy5uZXh0VGljazsKICAgIC8vIG5vZGUgdmVyc2lvbiAwLjEwLnggZGlzcGxheXMgYSBkZXByZWNhdGlvbiB3YXJuaW5nIHdoZW4gbmV4dFRpY2sgaXMgdXNlZCByZWN1cnNpdmVseQogICAgLy8gc2V0SW1tZWRpYXRlIHNob3VsZCBiZSB1c2VkIGluc3RlYWQgaW5zdGVhZAogICAgdmFyIHZlcnNpb24gPSBwcm9jZXNzLnZlcnNpb25zLm5vZGUubWF0Y2goL14oPzooXGQrKVwuKT8oPzooXGQrKVwuKT8oXCp8XGQrKSQvKTsKICAgIGlmIChBcnJheS5pc0FycmF5KHZlcnNpb24pICYmIHZlcnNpb25bMV0gPT09ICcwJyAmJiB2ZXJzaW9uWzJdID09PSAnMTAnKSB7CiAgICAgIG5leHRUaWNrID0gc2V0SW1tZWRpYXRlOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIG5leHRUaWNrKGZsdXNoKTsKICAgIH07CiAgfQoKICAvLyB2ZXJ0eAogIGZ1bmN0aW9uIHVzZVZlcnR4VGltZXIoKSB7CiAgICBpZiAodHlwZW9mIHZlcnR4TmV4dCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2ZXJ0eE5leHQoZmx1c2gpOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIHVzZVNldFRpbWVvdXQoKTsKICB9CgogIGZ1bmN0aW9uIHVzZU11dGF0aW9uT2JzZXJ2ZXIoKSB7CiAgICB2YXIgaXRlcmF0aW9ucyA9IDA7CiAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgQnJvd3Nlck11dGF0aW9uT2JzZXJ2ZXIoZmx1c2gpOwogICAgdmFyIG5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnJyk7CiAgICBvYnNlcnZlci5vYnNlcnZlKG5vZGUsIHsgY2hhcmFjdGVyRGF0YTogdHJ1ZSB9KTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbm9kZS5kYXRhID0gaXRlcmF0aW9ucyA9ICsraXRlcmF0aW9ucyAlIDI7CiAgICB9OwogIH0KCiAgLy8gd2ViIHdvcmtlcgogIGZ1bmN0aW9uIHVzZU1lc3NhZ2VDaGFubmVsKCkgewogICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZmx1c2g7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSgwKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiB1c2VTZXRUaW1lb3V0KCkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZmx1c2gsIDEpOwogICAgfTsKICB9CgogIHZhciBxdWV1ZSQxID0gbmV3IEFycmF5KDEwMDApOwoKICBmdW5jdGlvbiBmbHVzaCgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWUkMVtpXTsKICAgICAgdmFyIGFyZyA9IHF1ZXVlJDFbaSArIDFdOwoKICAgICAgY2FsbGJhY2soYXJnKTsKCiAgICAgIHF1ZXVlJDFbaV0gPSB1bmRlZmluZWQ7CiAgICAgIHF1ZXVlJDFbaSArIDFdID0gdW5kZWZpbmVkOwogICAgfQoKICAgIGxlbiA9IDA7CiAgfQoKICBmdW5jdGlvbiBhdHRlbXB0VmVydGV4KCkgewogICAgdHJ5IHsKICAgICAgdmFyIHZlcnR4ID0gRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKS5yZXF1aXJlKCd2ZXJ0eCcpOwogICAgICB2ZXJ0eE5leHQgPSB2ZXJ0eC5ydW5Pbkxvb3AgfHwgdmVydHgucnVuT25Db250ZXh0OwogICAgICByZXR1cm4gdXNlVmVydHhUaW1lcigpOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gdXNlU2V0VGltZW91dCgpOwogICAgfQogIH0KCiAgdmFyIHNjaGVkdWxlRmx1c2gkMSA9IHZvaWQgMDsKICAvLyBEZWNpZGUgd2hhdCBhc3luYyBtZXRob2QgdG8gdXNlIHRvIHRyaWdnZXJpbmcgcHJvY2Vzc2luZyBvZiBxdWV1ZWQgY2FsbGJhY2tzOgogIGlmIChpc05vZGUpIHsKICAgIHNjaGVkdWxlRmx1c2gkMSA9IHVzZU5leHRUaWNrKCk7CiAgfSBlbHNlIGlmIChCcm93c2VyTXV0YXRpb25PYnNlcnZlcikgewogICAgc2NoZWR1bGVGbHVzaCQxID0gdXNlTXV0YXRpb25PYnNlcnZlcigpOwogIH0gZWxzZSBpZiAoaXNXb3JrZXIpIHsKICAgIHNjaGVkdWxlRmx1c2gkMSA9IHVzZU1lc3NhZ2VDaGFubmVsKCk7CiAgfSBlbHNlIGlmIChicm93c2VyV2luZG93ID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIF9ub2RlTW9kdWxlLnJlcXVpcmUgPT09ICdmdW5jdGlvbicpIHsKICAgIHNjaGVkdWxlRmx1c2gkMSA9IGF0dGVtcHRWZXJ0ZXgoKTsKICB9IGVsc2UgewogICAgc2NoZWR1bGVGbHVzaCQxID0gdXNlU2V0VGltZW91dCgpOwogIH0KCiAgLy8gZGVmYXVsdHMKICBjb25maWcuYXN5bmMgPSBhc2FwOwogIGNvbmZpZy5hZnRlciA9IGZ1bmN0aW9uIChjYikgewogICAgcmV0dXJuIHNldFRpbWVvdXQoY2IsIDApOwogIH07CiAgdmFyIGNhc3QgPSByZXNvbHZlJDI7CgogIHZhciBhc3luYyA9IGZ1bmN0aW9uIChjYWxsYmFjaywgYXJnKSB7CiAgICByZXR1cm4gY29uZmlnLmFzeW5jKGNhbGxiYWNrLCBhcmcpOwogIH07CgogIGZ1bmN0aW9uIG9uKCkgewogICAgY29uZmlnLm9uLmFwcGx5KGNvbmZpZywgYXJndW1lbnRzKTsKICB9CgogIGZ1bmN0aW9uIG9mZigpIHsKICAgIGNvbmZpZy5vZmYuYXBwbHkoY29uZmlnLCBhcmd1bWVudHMpOwogIH0KCiAgLy8gU2V0IHVwIGluc3RydW1lbnRhdGlvbiB0aHJvdWdoIGB3aW5kb3cuX19QUk9NSVNFX0lOVFJVTUVOVEFUSU9OX19gCiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiB3aW5kb3dbJ19fUFJPTUlTRV9JTlNUUlVNRU5UQVRJT05fXyddID09PSAnb2JqZWN0JykgewogICAgdmFyIGNhbGxiYWNrcyA9IHdpbmRvd1snX19QUk9NSVNFX0lOU1RSVU1FTlRBVElPTl9fJ107CiAgICBjb25maWd1cmUoJ2luc3RydW1lbnQnLCB0cnVlKTsKICAgIGZvciAodmFyIGV2ZW50TmFtZSBpbiBjYWxsYmFja3MpIHsKICAgICAgaWYgKGNhbGxiYWNrcy5oYXNPd25Qcm9wZXJ0eShldmVudE5hbWUpKSB7CiAgICAgICAgb24oZXZlbnROYW1lLCBjYWxsYmFja3NbZXZlbnROYW1lXSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIHRoZSBkZWZhdWx0IGV4cG9ydCBoZXJlIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0OgogIC8vICAgaHR0cHM6Ly9naXRodWIuY29tL3RpbGRlaW8vcnN2cC5qcy9pc3N1ZXMvNDM0CiAgdmFyIHJzdnAgPSB7CiAgICBhc2FwOiBhc2FwLAogICAgY2FzdDogY2FzdCwKICAgIFByb21pc2U6IFByb21pc2UsCiAgICBFdmVudFRhcmdldDogRXZlbnRUYXJnZXQsCiAgICBhbGw6IGFsbCQxLAogICAgYWxsU2V0dGxlZDogYWxsU2V0dGxlZCwKICAgIHJhY2U6IHJhY2UkMSwKICAgIGhhc2g6IGhhc2gsCiAgICBoYXNoU2V0dGxlZDogaGFzaFNldHRsZWQsCiAgICByZXRocm93OiByZXRocm93LAogICAgZGVmZXI6IGRlZmVyLAogICAgZGVub2RlaWZ5OiBkZW5vZGVpZnksCiAgICBjb25maWd1cmU6IGNvbmZpZ3VyZSwKICAgIG9uOiBvbiwKICAgIG9mZjogb2ZmLAogICAgcmVzb2x2ZTogcmVzb2x2ZSQyLAogICAgcmVqZWN0OiByZWplY3QkMiwKICAgIG1hcDogbWFwLAogICAgYXN5bmM6IGFzeW5jLAogICAgZmlsdGVyOiBmaWx0ZXIKICB9OwoKICBleHBvcnRzLmRlZmF1bHQgPSByc3ZwOwogIGV4cG9ydHMuYXNhcCA9IGFzYXA7CiAgZXhwb3J0cy5jYXN0ID0gY2FzdDsKICBleHBvcnRzLlByb21pc2UgPSBQcm9taXNlOwogIGV4cG9ydHMuRXZlbnRUYXJnZXQgPSBFdmVudFRhcmdldDsKICBleHBvcnRzLmFsbCA9IGFsbCQxOwogIGV4cG9ydHMuYWxsU2V0dGxlZCA9IGFsbFNldHRsZWQ7CiAgZXhwb3J0cy5yYWNlID0gcmFjZSQxOwogIGV4cG9ydHMuaGFzaCA9IGhhc2g7CiAgZXhwb3J0cy5oYXNoU2V0dGxlZCA9IGhhc2hTZXR0bGVkOwogIGV4cG9ydHMucmV0aHJvdyA9IHJldGhyb3c7CiAgZXhwb3J0cy5kZWZlciA9IGRlZmVyOwogIGV4cG9ydHMuZGVub2RlaWZ5ID0gZGVub2RlaWZ5OwogIGV4cG9ydHMuY29uZmlndXJlID0gY29uZmlndXJlOwogIGV4cG9ydHMub24gPSBvbjsKICBleHBvcnRzLm9mZiA9IG9mZjsKICBleHBvcnRzLnJlc29sdmUgPSByZXNvbHZlJDI7CiAgZXhwb3J0cy5yZWplY3QgPSByZWplY3QkMjsKICBleHBvcnRzLm1hcCA9IG1hcDsKICBleHBvcnRzLmFzeW5jID0gYXN5bmM7CiAgZXhwb3J0cy5maWx0ZXIgPSBmaWx0ZXI7Cn0pOwpyZXF1aXJlTW9kdWxlKCdlbWJlcicpCgp9KCkpOwoKOyhmdW5jdGlvbigpIHsKICBkZWZpbmUoJ2VtYmVyLWNsaS1zaGltcy9kZXByZWNhdGlvbnMnLCBbXSwgZnVuY3Rpb24oKSB7CiAgICB2YXIgdmFsdWVzID0geyJlbWJlci1hcHBsaWNhdGlvbiI6eyJkZWZhdWx0IjpbIkBlbWJlci9hcHBsaWNhdGlvbiJdfSwiZW1iZXItYXJyYXkiOnsiZGVmYXVsdCI6WyJAZW1iZXIvYXJyYXkiXX0sImVtYmVyLWFycmF5L211dGFibGUiOnsiZGVmYXVsdCI6WyJAZW1iZXIvYXJyYXkvbXV0YWJsZSJdfSwiZW1iZXItYXJyYXkvdXRpbHMiOnsiQSI6WyJAZW1iZXIvYXJyYXkiLCJBIl0sImlzRW1iZXJBcnJheSI6WyJAZW1iZXIvYXJyYXkiLCJpc0FycmF5Il0sIndyYXAiOlsiQGVtYmVyL2FycmF5IiwibWFrZUFycmF5Il19LCJlbWJlci1jb21wb25lbnQiOnsiZGVmYXVsdCI6WyJAZW1iZXIvY29tcG9uZW50Il19LCJlbWJlci1jb21wb25lbnRzL2NoZWNrYm94Ijp7ImRlZmF1bHQiOlsiQGVtYmVyL2NvbXBvbmVudC9jaGVja2JveCJdfSwiZW1iZXItY29tcG9uZW50cy90ZXh0LWFyZWEiOnsiZGVmYXVsdCI6WyJAZW1iZXIvY29tcG9uZW50L3RleHQtYXJlYSJdfSwiZW1iZXItY29tcG9uZW50cy90ZXh0LWZpZWxkIjp7ImRlZmF1bHQiOlsiQGVtYmVyL2NvbXBvbmVudC90ZXh0LWZpZWxkIl19LCJlbWJlci1jb21wdXRlZCI6eyJkZWZhdWx0IjpbIkBlbWJlci9vYmplY3QiLCJjb21wdXRlZCJdLCJhbGlhcyI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwiYWxpYXMiXSwiYW5kIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJhbmQiXSwiYm9vbCI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwiYm9vbCJdLCJjb2xsZWN0IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJjb2xsZWN0Il0sImRlcHJlY2F0aW5nQWxpYXMiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImRlcHJlY2F0aW5nQWxpYXMiXSwiZW1wdHkiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImVtcHR5Il0sImVxdWFsIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJlcXVhbCJdLCJmaWx0ZXIiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImZpbHRlciJdLCJmaWx0ZXJCeSI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwiZmlsdGVyQnkiXSwiZmlsdGVyUHJvcGVydHkiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImZpbHRlclByb3BlcnR5Il0sImd0IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJndCJdLCJndGUiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImd0ZSJdLCJpbnRlcnNlY3QiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsImludGVyc2VjdCJdLCJsdCI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwibHQiXSwibHRlIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJsdGUiXSwibWFwIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJtYXAiXSwibWFwQnkiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsIm1hcEJ5Il0sIm1hcFByb3BlcnR5IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJtYXBQcm9wZXJ0eSJdLCJtYXRjaCI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwibWF0Y2giXSwibWF4IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJtYXgiXSwibWluIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJtaW4iXSwibm9uZSI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwibm9uZSJdLCJub3QiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsIm5vdCJdLCJub3RFbXB0eSI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwibm90RW1wdHkiXSwib25lV2F5IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJvbmVXYXkiXSwib3IiOlsiQGVtYmVyL29iamVjdC9jb21wdXRlZCIsIm9yIl0sInJlYWRPbmx5IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJyZWFkT25seSJdLCJyZWFkcyI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwicmVhZHMiXSwic2V0RGlmZiI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwic2V0RGlmZiJdLCJzb3J0IjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJzb3J0Il0sInN1bSI6WyJAZW1iZXIvb2JqZWN0L2NvbXB1dGVkIiwic3VtIl0sInVuaW9uIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJ1bmlvbiJdLCJ1bmlxIjpbIkBlbWJlci9vYmplY3QvY29tcHV0ZWQiLCJ1bmlxIl19LCJlbWJlci1jb250cm9sbGVyIjp7ImRlZmF1bHQiOlsiQGVtYmVyL2NvbnRyb2xsZXIiXX0sImVtYmVyLWNvbnRyb2xsZXIvaW5qZWN0Ijp7ImRlZmF1bHQiOlsiQGVtYmVyL2NvbnRyb2xsZXIiLCJpbmplY3QiXX0sImVtYmVyLWNvbnRyb2xsZXIvcHJveHkiOnsiZGVmYXVsdCI6WyJAZW1iZXIvYXJyYXkvcHJveHkiXX0sImVtYmVyLWRlYnVnIjp7Imluc3BlY3QiOlsiQGVtYmVyL2RlYnVnIiwiaW5zcGVjdCJdLCJsb2ciOlsiQGVtYmVyL2RlYnVnIiwiZGVidWciXSwicnVuIjpbIkBlbWJlci9kZWJ1ZyIsInJ1bkluRGVidWciXSwid2FybiI6WyJAZW1iZXIvZGVidWciLCJ3YXJuIl19LCJlbWJlci1kZWJ1Zy9jb250YWluZXItZGVidWctYWRhcHRlciI6eyJkZWZhdWx0IjpbIkBlbWJlci9kZWJ1Zy9jb250YWluZXItZGVidWctYWRhcHRlciJdfSwiZW1iZXItZGVidWcvZGF0YS1hZGFwdGVyIjp7ImRlZmF1bHQiOlsiQGVtYmVyL2RlYnVnL2RhdGEtYWRhcHRlciJdfSwiZW1iZXItZGVwcmVjYXRpb25zIjp7ImRlcHJlY2F0ZSI6WyJAZW1iZXIvYXBwbGljYXRpb24vZGVwcmVjYXRpb25zIiwiZGVwcmVjYXRlIl0sImRlcHJlY2F0ZUZ1bmMiOlsiQGVtYmVyL2FwcGxpY2F0aW9uL2RlcHJlY2F0aW9ucyIsImRlcHJlY2F0ZUZ1bmMiXX0sImVtYmVyLWVudW1lcmFibGUiOnsiZGVmYXVsdCI6WyJAZW1iZXIvZW51bWVyYWJsZSJdfSwiZW1iZXItZXZlbnRlZCI6eyJkZWZhdWx0IjpbIkBlbWJlci9vYmplY3QvZXZlbnRlZCJdfSwiZW1iZXItZXZlbnRlZC9vbiI6eyJkZWZhdWx0IjpbIkBlbWJlci9vYmplY3QvZXZlbnRlZCIsIm9uIl19LCJlbWJlci1nbG9iYWxzLXJlc29sdmVyIjp7ImRlZmF1bHQiOlsiQGVtYmVyL2FwcGxpY2F0aW9uL2dsb2JhbHMtcmVzb2x2ZXIiXX0sImVtYmVyLWhlbHBlciI6eyJkZWZhdWx0IjpbIkBlbWJlci9jb21wb25lbnQvaGVscGVyIl0sImhlbHBlciI6WyJAZW1iZXIvY29tcG9uZW50L2hlbHBlciIsImhlbHBlciJdfSwiZW1iZXItaW5zdHJ1bWVudGF0aW9uIjp7Imluc3RydW1lbnQiOlsiQGVtYmVyL2luc3RydW1lbnRhdGlvbiIsImluc3RydW1lbnQiXSwicmVzZXQiOlsiQGVtYmVyL2luc3RydW1lbnRhdGlvbiIsInJlc2V0Il0sInN1YnNjcmliZSI6WyJAZW1iZXIvaW5zdHJ1bWVudGF0aW9uIiwic3Vic2NyaWJlIl0sInVuc3Vic2NyaWJlIjpbIkBlbWJlci9pbnN0cnVtZW50YXRpb24iLCJ1bnN1YnNjcmliZSJdfSwiZW1iZXItbG9jYXRpb25zL2hhc2giOnsiZGVmYXVsdCI6WyJAZW1iZXIvcm91dGluZy9oYXNoLWxvY2F0aW9uIl19LCJlbWJlci1sb2NhdGlvbnMvaGlzdG9yeSI6eyJkZWZhdWx0IjpbIkBlbWJlci9yb3V0aW5nL2hpc3RvcnktbG9jYXRpb24iXX0sImVtYmVyLWxvY2F0aW9ucy9ub25lIjp7ImRlZmF1bHQiOlsiQGVtYmVyL3JvdXRpbmcvbm9uZS1sb2NhdGlvbiJdfSwiZW1iZXItbWFwIjp7ImRlZmF1bHQiOlsiQGVtYmVyL21hcCJdLCJ3aXRoRGVmYXVsdCI6WyJAZW1iZXIvbWFwL3dpdGgtZGVmYXVsdCJdfSwiZW1iZXItbWV0YWwvZXZlbnRzIjp7ImFkZExpc3RlbmVyIjpbIkBlbWJlci9vYmplY3QvZXZlbnRzIiwiYWRkTGlzdGVuZXIiXSwicmVtb3ZlTGlzdGVuZXIiOlsiQGVtYmVyL29iamVjdC9ldmVudHMiLCJyZW1vdmVMaXN0ZW5lciJdLCJzZW5kIjpbIkBlbWJlci9vYmplY3QvZXZlbnRzIiwic2VuZEV2ZW50Il19LCJlbWJlci1tZXRhbC9nZXQiOnsiZGVmYXVsdCI6WyJAZW1iZXIvb2JqZWN0IiwiZ2V0Il0sImdldFByb3BlcnRpZXMiOlsiQGVtYmVyL29iamVjdCIsImdldFByb3BlcnRpZXMiXX0sImVtYmVyLW1ldGFsL21peGluIjp7ImRlZmF1bHQiOlsiQGVtYmVyL29iamVjdC9taXhpbiJdfSwiZW1iZXItbWV0YWwvb2JzZXJ2ZXIiOnsiZGVmYXVsdCI6WyJAZW1iZXIvb2JqZWN0Iiwib2JzZXJ2ZXIiXSwiYWRkT2JzZXJ2ZXIiOlsiQGVtYmVyL29iamVjdC9vYnNlcnZlcnMiLCJhZGRPYnNlcnZlciJdLCJyZW1vdmVPYnNlcnZlciI6WyJAZW1iZXIvb2JqZWN0L29ic2VydmVycyIsInJlbW92ZU9ic2VydmVyIl19LCJlbWJlci1tZXRhbC9vbi1sb2FkIjp7ImRlZmF1bHQiOlsiQGVtYmVyL2FwcGxpY2F0aW9uIiwib25Mb2FkIl0sInJ1biI6WyJAZW1iZXIvYXBwbGljYXRpb24iLCJydW5Mb2FkSG9va3MiXX0sImVtYmVyLW1ldGFsL3NldCI6eyJkZWZhdWx0IjpbIkBlbWJlci9vYmplY3QiLCJzZXQiXSwic2V0UHJvcGVydGllcyI6WyJAZW1iZXIvb2JqZWN0Iiwic2V0UHJvcGVydGllcyJdLCJ0cnlTZXQiOlsiQGVtYmVyL29iamVjdCIsInRyeVNldCJdfSwiZW1iZXItbWV0YWwvdXRpbHMiOnsiYWxpYXNNZXRob2QiOlsiQGVtYmVyL29iamVjdCIsImFsaWFzTWV0aG9kIl0sImFzc2VydCI6WyJAZW1iZXIvZGVidWciLCJhc3NlcnQiXSwiY2FjaGVGb3IiOlsiQGVtYmVyL29iamVjdC9pbnRlcm5hbHMiLCJjYWNoZUZvciJdLCJjb3B5IjpbIkBlbWJlci9vYmplY3QvaW50ZXJuYWxzIiwiY29weSJdLCJndWlkRm9yIjpbIkBlbWJlci9vYmplY3QvaW50ZXJuYWxzIiwiZ3VpZEZvciJdfSwiZW1iZXItb2JqZWN0Ijp7ImRlZmF1bHQiOlsiQGVtYmVyL29iamVjdCJdfSwiZW1iZXItb3duZXIvZ2V0Ijp7ImRlZmF1bHQiOlsiQGVtYmVyL2FwcGxpY2F0aW9uIiwiZ2V0T3duZXIiXX0sImVtYmVyLW93bmVyL3NldCI6eyJkZWZhdWx0IjpbIkBlbWJlci9hcHBsaWNhdGlvbiIsInNldE93bmVyIl19LCJlbWJlci1wbGF0Zm9ybSI6eyJhc3NpZ24iOlsiQGVtYmVyL3BvbHlmaWxscyIsImFzc2lnbiJdLCJjcmVhdGUiOlsiQGVtYmVyL3BvbHlmaWxscyIsImNyZWF0ZSJdLCJoYXNBY2Nlc3NvcnMiOlsiQGVtYmVyL3BvbHlmaWxscyIsImhhc1Byb3BlcnR5QWNjZXNzb3JzIl0sImtleXMiOlsiQGVtYmVyL3BvbHlmaWxscyIsImtleXMiXX0sImVtYmVyLXJvdXRlIjp7ImRlZmF1bHQiOlsiQGVtYmVyL3JvdXRpbmcvcm91dGUiXX0sImVtYmVyLXJvdXRlciI6eyJkZWZhdWx0IjpbIkBlbWJlci9yb3V0aW5nL3JvdXRlciJdfSwiZW1iZXItcnVubG9vcCI6eyJkZWZhdWx0IjpbIkBlbWJlci9ydW5sb29wIiwicnVuIl0sImJlZ2luIjpbIkBlbWJlci9ydW5sb29wIiwiYmVnaW4iXSwiYmluZCI6WyJAZW1iZXIvcnVubG9vcCIsImJpbmQiXSwiY2FuY2VsIjpbIkBlbWJlci9ydW5sb29wIiwiY2FuY2VsIl0sImRlYm91bmNlIjpbIkBlbWJlci9ydW5sb29wIiwiZGVib3VuY2UiXSwiZW5kIjpbIkBlbWJlci9ydW5sb29wIiwiZW5kIl0sImpvaW4iOlsiQGVtYmVyL3J1bmxvb3AiLCJqb2luIl0sImxhdGVyIjpbIkBlbWJlci9ydW5sb29wIiwibGF0ZXIiXSwibmV4dCI6WyJAZW1iZXIvcnVubG9vcCIsIm5leHQiXSwib25jZSI6WyJAZW1iZXIvcnVubG9vcCIsIm9uY2UiXSwic2NoZWR1bGUiOlsiQGVtYmVyL3J1bmxvb3AiLCJzY2hlZHVsZSJdLCJzY2hlZHVsZU9uY2UiOlsiQGVtYmVyL3J1bmxvb3AiLCJzY2hlZHVsZU9uY2UiXSwidGhyb3R0bGUiOlsiQGVtYmVyL3J1bmxvb3AiLCJ0aHJvdHRsZSJdfSwiZW1iZXItc2VydmljZSI6eyJkZWZhdWx0IjpbIkBlbWJlci9zZXJ2aWNlIl19LCJlbWJlci1zZXJ2aWNlL2luamVjdCI6eyJkZWZhdWx0IjpbIkBlbWJlci9zZXJ2aWNlIiwiaW5qZWN0Il19LCJlbWJlci1zdHJpbmciOnsiY2FtZWxpemUiOlsiQGVtYmVyL3N0cmluZyIsImNhbWVsaXplIl0sImNhcGl0YWxpemUiOlsiQGVtYmVyL3N0cmluZyIsImNhcGl0YWxpemUiXSwiY2xhc3NpZnkiOlsiQGVtYmVyL3N0cmluZyIsImNsYXNzaWZ5Il0sImRhc2hlcml6ZSI6WyJAZW1iZXIvc3RyaW5nIiwiZGFzaGVyaXplIl0sImRlY2FtZWxpemUiOlsiQGVtYmVyL3N0cmluZyIsImRlY2FtZWxpemUiXSwiZm10IjpbIkBlbWJlci9zdHJpbmciLCJmbXQiXSwiaHRtbFNhZmUiOlsiQGVtYmVyL3N0cmluZyIsImh0bWxTYWZlIl0sImxvYyI6WyJAZW1iZXIvc3RyaW5nIiwibG9jIl0sInVuZGVyc2NvcmUiOlsiQGVtYmVyL3N0cmluZyIsInVuZGVyc2NvcmUiXSwidyI6WyJAZW1iZXIvc3RyaW5nIiwidyJdfSwiZW1iZXItdGVzdC9hZGFwdGVyIjp7ImRlZmF1bHQiOlsiQGVtYmVyL3Rlc3QvYWRhcHRlciJdfSwiZW1iZXItdXRpbHMiOnsiaXNCbGFuayI6WyJAZW1iZXIvdXRpbHMiLCJpc0JsYW5rIl0sImlzRW1wdHkiOlsiQGVtYmVyL3V0aWxzIiwiaXNFbXB0eSJdLCJpc05vbmUiOlsiQGVtYmVyL3V0aWxzIiwiaXNOb25lIl0sImlzUHJlc2VudCI6WyJAZW1iZXIvdXRpbHMiLCJpc1ByZXNlbnQiXSwidHJ5SW52b2tlIjpbIkBlbWJlci91dGlscyIsInRyeUludm9rZSJdLCJ0eXBlT2YiOlsiQGVtYmVyL3V0aWxzIiwidHlwZU9mIl19fTsKICAgIAogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbHVlcywgJ19fZXNNb2R1bGUnLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKCiAgICByZXR1cm4gdmFsdWVzOwogIH0pOwp9KSgpOwo7KGZ1bmN0aW9uKCkgewovKiBnbG9iYWxzIGRlZmluZSwgRW1iZXIsIGpRdWVyeSAqLwoKICBmdW5jdGlvbiBwcm9jZXNzRW1iZXJTaGltcygpIHsKICAgIHZhciBzaGltcyA9IHsKICAgICAgJ2VtYmVyLWFwcGxpY2F0aW9uJzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuQXBwbGljYXRpb24KICAgICAgfSwKICAgICAgJ2VtYmVyLWFycmF5JzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuQXJyYXkKICAgICAgfSwKICAgICAgJ2VtYmVyLWFycmF5L211dGFibGUnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5NdXRhYmxlQXJyYXkKICAgICAgfSwKICAgICAgJ2VtYmVyLWFycmF5L3V0aWxzJzogewogICAgICAgICdBJzogICAgICAgICAgICBFbWJlci5BLAogICAgICAgICdpc0VtYmVyQXJyYXknOiBFbWJlci5pc0FycmF5LAogICAgICAgICd3cmFwJzogICAgICAgICBFbWJlci5tYWtlQXJyYXkKICAgICAgfSwKICAgICAgJ2VtYmVyLWNvbXBvbmVudCc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLkNvbXBvbmVudAogICAgICB9LAogICAgICAnZW1iZXItY29tcG9uZW50cy9jaGVja2JveCc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLkNoZWNrYm94CiAgICAgIH0sCiAgICAgICdlbWJlci1jb21wb25lbnRzL3RleHQtYXJlYSc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLlRleHRBcmVhCiAgICAgIH0sCiAgICAgICdlbWJlci1jb21wb25lbnRzL3RleHQtZmllbGQnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5UZXh0RmllbGQKICAgICAgfSwKICAgICAgJ2VtYmVyLWNvbnRyb2xsZXInOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5Db250cm9sbGVyCiAgICAgIH0sCiAgICAgICdlbWJlci1jb250cm9sbGVyL2luamVjdCc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLmluamVjdC5jb250cm9sbGVyCiAgICAgIH0sCiAgICAgICdlbWJlci1jb250cm9sbGVyL3Byb3h5JzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuQXJyYXlQcm94eQogICAgICB9LAogICAgICAnZW1iZXItY29udHJvbGxlcnMvc29ydGFibGUnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5Tb3J0YWJsZU1peGluCiAgICAgIH0sCiAgICAgICdlbWJlci1kZWJ1Zyc6IHsKICAgICAgICAnbG9nJzogICAgICBFbWJlci5kZWJ1ZywKICAgICAgICAnaW5zcGVjdCc6ICBFbWJlci5pbnNwZWN0LAogICAgICAgICdydW4nOiAgICAgIEVtYmVyLnJ1bkluRGVidWcsCiAgICAgICAgJ3dhcm4nOiAgICAgRW1iZXIud2FybgogICAgICB9LAogICAgICAnZW1iZXItZGVidWcvY29udGFpbmVyLWRlYnVnLWFkYXB0ZXInOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5Db250YWluZXJEZWJ1Z0FkYXB0ZXIKICAgICAgfSwKICAgICAgJ2VtYmVyLWRlYnVnL2RhdGEtYWRhcHRlcic6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLkRhdGFBZGFwdGVyCiAgICAgIH0sCiAgICAgICdlbWJlci1kZXByZWNhdGlvbnMnOiB7CiAgICAgICAgJ2RlcHJlY2F0ZSc6ICAgICAgRW1iZXIuZGVwcmVjYXRlLAogICAgICAgICdkZXByZWNhdGVGdW5jJzogIEVtYmVyLmRlcHJlY2F0ZUZ1bmMKICAgICAgfSwKICAgICAgJ2VtYmVyLWVudW1lcmFibGUnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5FbnVtZXJhYmxlCiAgICAgIH0sCiAgICAgICdlbWJlci1ldmVudGVkJzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuRXZlbnRlZAogICAgICB9LAogICAgICAnZW1iZXItZXZlbnRlZC9vbic6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLm9uCiAgICAgIH0sCiAgICAgICdlbWJlci1nbG9iYWxzLXJlc29sdmVyJzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuRGVmYXVsdFJlc29sdmVyCiAgICAgIH0sCiAgICAgICdlbWJlci1oZWxwZXInOiB7CiAgICAgICAgJ2RlZmF1bHQnOiAgRW1iZXIuSGVscGVyLAogICAgICAgICdoZWxwZXInOiAgIEVtYmVyLkhlbHBlciAmJiBFbWJlci5IZWxwZXIuaGVscGVyCiAgICAgIH0sCiAgICAgICdlbWJlci1pbnN0cnVtZW50YXRpb24nOiB7CiAgICAgICAgJ2luc3RydW1lbnQnOiAgIEVtYmVyLkluc3RydW1lbnRhdGlvbi5pbnN0cnVtZW50LAogICAgICAgICdyZXNldCc6ICAgICAgICBFbWJlci5JbnN0cnVtZW50YXRpb24ucmVzZXQsCiAgICAgICAgJ3N1YnNjcmliZSc6ICAgIEVtYmVyLkluc3RydW1lbnRhdGlvbi5zdWJzY3JpYmUsCiAgICAgICAgJ3Vuc3Vic2NyaWJlJzogIEVtYmVyLkluc3RydW1lbnRhdGlvbi51bnN1YnNjcmliZQogICAgICB9LAogICAgICAnZW1iZXItbG9jYXRpb25zL2hhc2gnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5IYXNoTG9jYXRpb24KICAgICAgfSwKICAgICAgJ2VtYmVyLWxvY2F0aW9ucy9oaXN0b3J5JzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuSGlzdG9yeUxvY2F0aW9uCiAgICAgIH0sCiAgICAgICdlbWJlci1sb2NhdGlvbnMvbm9uZSc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLk5vbmVMb2NhdGlvbgogICAgICB9LAogICAgICAnZW1iZXItbWFwJzogewogICAgICAgICdkZWZhdWx0JzogICAgICBFbWJlci5NYXAsCiAgICAgICAgJ3dpdGhEZWZhdWx0JzogIEVtYmVyLk1hcFdpdGhEZWZhdWx0CiAgICAgIH0sCiAgICAgICdlbWJlci1tZXRhbC9kZXN0cm95JzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuZGVzdHJveQogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvZXZlbnRzJzogewogICAgICAgICdhZGRMaXN0ZW5lcic6ICAgIEVtYmVyLmFkZExpc3RlbmVyLAogICAgICAgICdyZW1vdmVMaXN0ZW5lcic6IEVtYmVyLnJlbW92ZUxpc3RlbmVyLAogICAgICAgICdzZW5kJzogICAgICAgICAgIEVtYmVyLnNlbmRFdmVudAogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvZ2V0JzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuZ2V0LAogICAgICAgICdnZXRQcm9wZXJ0aWVzJzogRW1iZXIuZ2V0UHJvcGVydGllcwogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvbWl4aW4nOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5NaXhpbgogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvb2JzZXJ2ZXInOiB7CiAgICAgICAgJ2RlZmF1bHQnOiAgICAgICAgRW1iZXIub2JzZXJ2ZXIsCiAgICAgICAgJ2FkZE9ic2VydmVyJzogICAgRW1iZXIuYWRkT2JzZXJ2ZXIsCiAgICAgICAgJ3JlbW92ZU9ic2VydmVyJzogRW1iZXIucmVtb3ZlT2JzZXJ2ZXIKICAgICAgfSwKICAgICAgJ2VtYmVyLW1ldGFsL29uLWxvYWQnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiAgRW1iZXIub25Mb2FkLAogICAgICAgICdydW4nOiAgICAgIEVtYmVyLnJ1bkxvYWRIb29rcwogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvc2V0JzogewogICAgICAgICdkZWZhdWx0JzogICAgICAgIEVtYmVyLnNldCwKICAgICAgICAnc2V0UHJvcGVydGllcyc6ICBFbWJlci5zZXRQcm9wZXJ0aWVzLAogICAgICAgICd0cnlTZXQnOiAgICAgICAgIEVtYmVyLnRyeVNldAogICAgICB9LAogICAgICAnZW1iZXItbWV0YWwvdXRpbHMnOiB7CiAgICAgICAgJ2FsaWFzTWV0aG9kJzogIEVtYmVyLmFsaWFzTWV0aG9kLAogICAgICAgICdhc3NlcnQnOiAgICAgICBFbWJlci5hc3NlcnQsCiAgICAgICAgJ2NhY2hlRm9yJzogICAgIEVtYmVyLmNhY2hlRm9yLAogICAgICAgICdjb3B5JzogICAgICAgICBFbWJlci5jb3B5LAogICAgICAgICdndWlkRm9yJzogICAgICBFbWJlci5ndWlkRm9yCiAgICAgIH0sCiAgICAgICdlbWJlci1vYmplY3QnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5PYmplY3QKICAgICAgfSwKICAgICAgJ2VtYmVyLW93bmVyL2dldCc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLmdldE93bmVyCiAgICAgIH0sCiAgICAgICdlbWJlci1vd25lci9zZXQnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5zZXRPd25lcgogICAgICB9LAogICAgICAnZW1iZXItcGxhdGZvcm0nOiB7CiAgICAgICAgJ2Fzc2lnbic6ICAgICAgICAgRW1iZXIuYXNzaWduIHx8IEVtYmVyLm1lcmdlLAogICAgICAgICdjcmVhdGUnOiAgICAgICAgIEVtYmVyLmNyZWF0ZSwKICAgICAgICAnZGVmaW5lUHJvcGVydHknOiBFbWJlci5wbGF0Zm9ybS5kZWZpbmVQcm9wZXJ0eSwKICAgICAgICAnaGFzQWNjZXNzb3JzJzogICBFbWJlci5wbGF0Zm9ybS5oYXNQcm9wZXJ0eUFjY2Vzc29ycywKICAgICAgICAna2V5cyc6ICAgICAgICAgICBFbWJlci5rZXlzCiAgICAgIH0sCiAgICAgICdlbWJlci1yb3V0ZSc6IHsKICAgICAgICAnZGVmYXVsdCc6IEVtYmVyLlJvdXRlCiAgICAgIH0sCiAgICAgICdlbWJlci1yb3V0ZXInOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5Sb3V0ZXIKICAgICAgfSwKICAgICAgJ2VtYmVyLXJ1bmxvb3AnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiAgICAgIEVtYmVyLnJ1biwKICAgICAgICAnYmVnaW4nOiAgICAgICAgRW1iZXIucnVuLmJlZ2luLAogICAgICAgICdiaW5kJzogICAgICAgICBFbWJlci5ydW4uYmluZCwKICAgICAgICAnY2FuY2VsJzogICAgICAgRW1iZXIucnVuLmNhbmNlbCwKICAgICAgICAnZGVib3VuY2UnOiAgICAgRW1iZXIucnVuLmRlYm91bmNlLAogICAgICAgICdlbmQnOiAgICAgICAgICBFbWJlci5ydW4uZW5kLAogICAgICAgICdqb2luJzogICAgICAgICBFbWJlci5ydW4uam9pbiwKICAgICAgICAnbGF0ZXInOiAgICAgICAgRW1iZXIucnVuLmxhdGVyLAogICAgICAgICduZXh0JzogICAgICAgICBFbWJlci5ydW4ubmV4dCwKICAgICAgICAnb25jZSc6ICAgICAgICAgRW1iZXIucnVuLm9uY2UsCiAgICAgICAgJ3NjaGVkdWxlJzogICAgIEVtYmVyLnJ1bi5zY2hlZHVsZSwKICAgICAgICAnc2NoZWR1bGVPbmNlJzogRW1iZXIucnVuLnNjaGVkdWxlT25jZSwKICAgICAgICAndGhyb3R0bGUnOiAgICAgRW1iZXIucnVuLnRocm90dGxlCiAgICAgIH0sCiAgICAgICdlbWJlci1zZXJ2aWNlJzogewogICAgICAgICdkZWZhdWx0JzogRW1iZXIuU2VydmljZQogICAgICB9LAogICAgICAnZW1iZXItc2VydmljZS9pbmplY3QnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5pbmplY3Quc2VydmljZQogICAgICB9LAogICAgICAnZW1iZXItc2V0L29yZGVyZWQnOiB7CiAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5PcmRlcmVkU2V0CiAgICAgIH0sCiAgICAgICdlbWJlci1zdHJpbmcnOiB7CiAgICAgICAgJ2NhbWVsaXplJzogICAgIEVtYmVyLlN0cmluZy5jYW1lbGl6ZSwKICAgICAgICAnY2FwaXRhbGl6ZSc6ICAgRW1iZXIuU3RyaW5nLmNhcGl0YWxpemUsCiAgICAgICAgJ2NsYXNzaWZ5JzogICAgIEVtYmVyLlN0cmluZy5jbGFzc2lmeSwKICAgICAgICAnZGFzaGVyaXplJzogICAgRW1iZXIuU3RyaW5nLmRhc2hlcml6ZSwKICAgICAgICAnZGVjYW1lbGl6ZSc6ICAgRW1iZXIuU3RyaW5nLmRlY2FtZWxpemUsCiAgICAgICAgJ2ZtdCc6ICAgICAgICAgIEVtYmVyLlN0cmluZy5mbXQsCiAgICAgICAgJ2h0bWxTYWZlJzogICAgIEVtYmVyLlN0cmluZy5odG1sU2FmZSwKICAgICAgICAnbG9jJzogICAgICAgICAgRW1iZXIuU3RyaW5nLmxvYywKICAgICAgICAndW5kZXJzY29yZSc6ICAgRW1iZXIuU3RyaW5nLnVuZGVyc2NvcmUsCiAgICAgICAgJ3cnOiAgICAgICAgICAgIEVtYmVyLlN0cmluZy53CiAgICAgIH0sCiAgICAgICdlbWJlci11dGlscyc6IHsKICAgICAgICAnaXNCbGFuayc6ICAgIEVtYmVyLmlzQmxhbmssCiAgICAgICAgJ2lzRW1wdHknOiAgICBFbWJlci5pc0VtcHR5LAogICAgICAgICdpc05vbmUnOiAgICAgRW1iZXIuaXNOb25lLAogICAgICAgICdpc1ByZXNlbnQnOiAgRW1iZXIuaXNQcmVzZW50LAogICAgICAgICd0cnlJbnZva2UnOiAgRW1iZXIudHJ5SW52b2tlLAogICAgICAgICd0eXBlT2YnOiAgICAgRW1iZXIudHlwZU9mCiAgICAgIH0KICAgIH07CgogICAgLy8gcG9wdWxhdGUgYGVtYmVyL2NvbXB1dGVkYCBuYW1lZCBleHBvcnRzCiAgICBzaGltc1snZW1iZXItY29tcHV0ZWQnXSA9IHsKICAgICAgJ2RlZmF1bHQnOiBFbWJlci5jb21wdXRlZAogICAgfTsKICAgIHZhciBjb21wdXRlZE1hY3JvcyA9IFsKICAgICAgImVtcHR5Iiwibm90RW1wdHkiLCAibm9uZSIsICJub3QiLCAiYm9vbCIsICJtYXRjaCIsCiAgICAgICJlcXVhbCIsICJndCIsICJndGUiLCAibHQiLCAibHRlIiwgImFsaWFzIiwgIm9uZVdheSIsCiAgICAgICJyZWFkcyIsICJyZWFkT25seSIsICJkZXByZWNhdGluZ0FsaWFzIiwKICAgICAgImFuZCIsICJvciIsICJjb2xsZWN0IiwgInN1bSIsICJtaW4iLCAibWF4IiwKICAgICAgIm1hcCIsICJzb3J0IiwgInNldERpZmYiLCAibWFwQnkiLCAibWFwUHJvcGVydHkiLAogICAgICAiZmlsdGVyIiwgImZpbHRlckJ5IiwgImZpbHRlclByb3BlcnR5IiwgInVuaXEiLAogICAgICAidW5pb24iLCAiaW50ZXJzZWN0IgogICAgXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gY29tcHV0ZWRNYWNyb3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBjb21wdXRlZE1hY3Jvc1tpXTsKICAgICAgc2hpbXNbJ2VtYmVyLWNvbXB1dGVkJ11ba2V5XSA9IEVtYmVyLmNvbXB1dGVkW2tleV07CiAgICB9CgogICAgZm9yICh2YXIgbW9kdWxlTmFtZSBpbiBzaGltcykgewogICAgICBnZW5lcmF0ZU1vZHVsZShtb2R1bGVOYW1lLCBzaGltc1ttb2R1bGVOYW1lXSwgdHJ1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzVGVzdFNoaW1zKCkgewogICAgaWYgKEVtYmVyLlRlc3QpIHsKICAgICAgdmFyIHRlc3RTaGltcyA9IHsKICAgICAgICAnZW1iZXItdGVzdCc6IHsKICAgICAgICAgICdkZWZhdWx0JzogRW1iZXIuVGVzdAogICAgICAgIH0sCiAgICAgICAgJ2VtYmVyLXRlc3QvYWRhcHRlcic6IHsKICAgICAgICAgICdkZWZhdWx0JzogRW1iZXIuVGVzdC5BZGFwdGVyCiAgICAgICAgfSwKICAgICAgICAnZW1iZXItdGVzdC9xdW5pdC1hZGFwdGVyJzogewogICAgICAgICAgJ2RlZmF1bHQnOiBFbWJlci5UZXN0LlFVbml0QWRhcHRlcgogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZvciAodmFyIG1vZHVsZU5hbWUgaW4gdGVzdFNoaW1zKSB7CiAgICAgICAgZ2VuZXJhdGVNb2R1bGUobW9kdWxlTmFtZSwgdGVzdFNoaW1zW21vZHVsZU5hbWVdKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuZXJhdGVNb2R1bGUobmFtZSwgdmFsdWVzLCBkZXByZWNhdGVkKSB7CiAgICBkZWZpbmUobmFtZSwgWydlbWJlci1jbGktc2hpbXMvZGVwcmVjYXRpb25zJ10sIGZ1bmN0aW9uKGRlcHJlY2F0aW9ucykgewogICAgICAndXNlIHN0cmljdCc7CgogICAgICBpZiAoZGVwcmVjYXRlZCkgewogICAgICAgIHZhciBtb2R1bGVEZXByZWNhdGlvbnMgPSBkZXByZWNhdGlvbnNbbmFtZV07CgogICAgICAgIHZhciBtZXNzYWdlID0gJ0ltcG9ydGluZyBmcm9tIHRoZSBgJyArIG5hbWUgKyAnYCBtb2R1bGUgaGFzIGJlZW4gZGVwcmVjYXRlZC4gJzsKICAgICAgICBpZiAobW9kdWxlRGVwcmVjYXRpb25zKSB7CiAgICAgICAgICBtZXNzYWdlICs9ICdQbGVhc2UgdXNlIHRoZSBuZXcgbW9kdWxlIGltcG9ydHM6XG5cbic7CiAgICAgICAgICBPYmplY3Qua2V5cyhtb2R1bGVEZXByZWNhdGlvbnMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHZhciBuZXdJbXBvcnQgPSBtb2R1bGVEZXByZWNhdGlvbnNba2V5XTsKICAgICAgICAgICAgaWYgKG5ld0ltcG9ydFsxXSkgewogICAgICAgICAgICAgIG1lc3NhZ2UgKz0gJ2ltcG9ydCB7ICcgKyBuZXdJbXBvcnRbMV0gKyAnIH0gZnJvbSBcJycgKyBuZXdJbXBvcnRbMF0gKyAnXCdcbic7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGltcG9ydE5hbWUgPSBFbWJlci5TdHJpbmcuY2xhc3NpZnkobmV3SW1wb3J0WzBdLnNwbGl0KCcvJykucG9wKCkpOwogICAgICAgICAgICAgIG1lc3NhZ2UgKz0gJ2ltcG9ydCAnICsgaW1wb3J0TmFtZSArICcgZnJvbSBcJycgKyBuZXdJbXBvcnRbMF0gKyAnXCdcbic7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgbWVzc2FnZSArPSAnXG4nOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWVzc2FnZSArPSAnUGxlYXNlIHVzZSBnbG9iYWxzIGluc3RlYWQuJzsKICAgICAgICB9CgogICAgICAgIEVtYmVyLmRlcHJlY2F0ZShtZXNzYWdlLCBmYWxzZSwgewogICAgICAgICAgaWQ6ICdlbWJlci1jbGktc2hpbXMuZGVwcmVjYXRlZC1zaGltcycsCiAgICAgICAgICB1bnRpbDogJzMuMC4wJywKICAgICAgICAgIHVybDogJ2h0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL3JmY3MvYmxvYi9tYXN0ZXIvdGV4dC8wMTc2LWphdmFzY3JpcHQtbW9kdWxlLWFwaS5tZCcKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbHVlcywgJ19fZXNNb2R1bGUnLCB7CiAgICAgICAgdmFsdWU6IHRydWUKICAgICAgfSk7CgogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSk7CiAgfQoKICBnZW5lcmF0ZU1vZHVsZSgnZW1iZXInLCB7IGRlZmF1bHQ6IEVtYmVyIH0pOwogIHByb2Nlc3NFbWJlclNoaW1zKCk7CiAgcHJvY2Vzc1Rlc3RTaGltcygpOwogIGdlbmVyYXRlTW9kdWxlKCdqcXVlcnknLCB7ICdkZWZhdWx0Jzogc2VsZi5qUXVlcnkgfSk7CiAgZ2VuZXJhdGVNb2R1bGUoJ3JzdnAnLCB7ICdkZWZhdWx0JzogRW1iZXIuUlNWUCB9KTsKfSkoKTsKCjsvKiBnbG9iYWxzIGRlZmluZSAqLwoKZnVuY3Rpb24gY3JlYXRlRGVwcmVjYXRlZE1vZHVsZShtb2R1bGVJZCkgewogIGRlZmluZShtb2R1bGVJZCwgWydleHBvcnRzJywgJ2VtYmVyLXJlc29sdmVyL3Jlc29sdmVyJywgJ2VtYmVyJ10sIGZ1bmN0aW9uKGV4cG9ydHMsIFJlc29sdmVyLCBFbWJlcikgewogICAgRW1iZXJbJ2RlZmF1bHQnXS5kZXByZWNhdGUoCiAgICAgICdVc2FnZSBvZiBgJyArIG1vZHVsZUlkICsgJ2AgbW9kdWxlIGlzIGRlcHJlY2F0ZWQsIHBsZWFzZSB1cGRhdGUgdG8gYGVtYmVyLXJlc29sdmVyYC4nLAogICAgICBmYWxzZSwKICAgICAgeyBpZDogJ2VtYmVyLXJlc29sdmVyLmxlZ2FjeS1zaGltcycsIHVudGlsOiAnMy4wLjAnIH0KICAgICk7CgogICAgZXhwb3J0c1snZGVmYXVsdCddID0gUmVzb2x2ZXJbJ2RlZmF1bHQnXTsKICB9KTsKfQoKY3JlYXRlRGVwcmVjYXRlZE1vZHVsZSgnZW1iZXIvcmVzb2x2ZXInKTsKY3JlYXRlRGVwcmVjYXRlZE1vZHVsZSgncmVzb2x2ZXInKTsKCjtkZWZpbmUoJ0BlbWJlci9vcmRlcmVkLXNldC9pbmRleCcsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKCgogIGNvbnN0IE5FRURTX0NVU1RPTV9PUkRFUkVEX1NFVCA9IGZhbHNlOwoKICBsZXQgT3JkZXJlZFNldDsKCiAgaWYgKE5FRURTX0NVU1RPTV9PUkRFUkVEX1NFVCkgewogICAgLyoqCiAgICBAY2xhc3MgT3JkZXJlZFNldAogICAgQGNvbnN0cnVjdG9yCiAgICAqLwogICAgT3JkZXJlZFNldCA9IGNsYXNzIE9yZGVyZWRTZXQgewogICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGNyZWF0ZQogICAgICBAc3RhdGljCiAgICAgIEByZXR1cm4ge09yZGVyZWRTZXR9CiAgICAgICovCiAgICAgIHN0YXRpYyBjcmVhdGUoKSB7CiAgICAgICAgbGV0IENvbnN0cnVjdG9yID0gdGhpczsKICAgICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGNsZWFyCiAgICAgICovCiAgICAgIGNsZWFyKCkgewogICAgICAgIHRoaXMucHJlc2VuY2VTZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHRoaXMubGlzdCA9IFtdOwogICAgICAgIHRoaXMuc2l6ZSA9IDA7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGFkZAogICAgICBAcGFyYW0geyp9IG9iagogICAgICBAcGFyYW0ge3N0cmluZ30gW19ndWlkXSAoZm9yIGludGVybmFsIHVzZSkKICAgICAgQHJldHVybiB7T3JkZXJlZFNldH0KICAgICAgKi8KICAgICAgYWRkKG9iaiwgX2d1aWQpIHsKICAgICAgICBsZXQgZ3VpZCA9IF9ndWlkIHx8IEVtYmVyLmd1aWRGb3Iob2JqKTsKICAgICAgICBsZXQgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0OwogICAgICAgIGxldCBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgICBpZiAocHJlc2VuY2VTZXRbZ3VpZF0gIT09IHRydWUpIHsKICAgICAgICAgIHByZXNlbmNlU2V0W2d1aWRdID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuc2l6ZSA9IGxpc3QucHVzaChvYmopOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGRlbGV0ZQogICAgICBAcGFyYW0geyp9IG9iagogICAgICBAcGFyYW0ge3N0cmluZ30gW19ndWlkXSAoZm9yIGludGVybmFsIHVzZSkKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICAgKi8KICAgICAgZGVsZXRlKG9iaiwgX2d1aWQpIHsKICAgICAgICBsZXQgZ3VpZCA9IF9ndWlkIHx8IEVtYmVyLmd1aWRGb3Iob2JqKTsKICAgICAgICBsZXQgcHJlc2VuY2VTZXQgPSB0aGlzLnByZXNlbmNlU2V0OwogICAgICAgIGxldCBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgICBpZiAocHJlc2VuY2VTZXRbZ3VpZF0gPT09IHRydWUpIHsKICAgICAgICAgIGRlbGV0ZSBwcmVzZW5jZVNldFtndWlkXTsKICAgICAgICAgIGxldCBpbmRleCA9IGxpc3QuaW5kZXhPZihvYmopOwogICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zaXplID0gbGlzdC5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLyoqCiAgICAgIEBtZXRob2QgaXNFbXB0eQogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICAqLwogICAgICBpc0VtcHR5KCkgewogICAgICAgIHJldHVybiB0aGlzLnNpemUgPT09IDA7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGhhcwogICAgICBAcGFyYW0geyp9IG9iagogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgICAqLwogICAgICBoYXMob2JqKSB7CiAgICAgICAgaWYgKHRoaXMuc2l6ZSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgbGV0IGd1aWQgPSBFbWJlci5ndWlkRm9yKG9iaik7CiAgICAgICAgbGV0IHByZXNlbmNlU2V0ID0gdGhpcy5wcmVzZW5jZVNldDsKCiAgICAgICAgcmV0dXJuIHByZXNlbmNlU2V0W2d1aWRdID09PSB0cnVlOwogICAgICB9CgogICAgICAvKioKICAgICAgQG1ldGhvZCBmb3JFYWNoCiAgICAgIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgIEBwYXJhbSBzZWxmCiAgICAgICovCiAgICAgIGZvckVhY2goZm4gLyosIC4uLnRoaXNBcmcqLykgewogICAgICAgICh0cnVlICYmICEodHlwZW9mIGZuID09PSAnZnVuY3Rpb24nKSAmJiBFbWJlci5hc3NlcnQoYCR7T2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZuKX0gaXMgbm90IGEgZnVuY3Rpb25gLCB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpKTsKCgogICAgICAgIGlmICh0aGlzLnNpemUgPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBsaXN0ID0gdGhpcy5saXN0OwoKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGZuLmNhbGwoYXJndW1lbnRzWzFdLCBsaXN0W2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGZuKGxpc3RbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLyoqCiAgICAgIEBtZXRob2QgdG9BcnJheQogICAgICBAcmV0dXJuIHtBcnJheX0KICAgICAgKi8KICAgICAgdG9BcnJheSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5saXN0LnNsaWNlKCk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICBAbWV0aG9kIGNvcHkKICAgICAgQHJldHVybiB7T3JkZXJlZFNldH0KICAgICAgKi8KICAgICAgY29weSgpIHsKICAgICAgICBsZXQgQ29uc3RydWN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGxldCBzZXQgPSBuZXcgQ29uc3RydWN0b3IoKTsKCiAgICAgICAgc2V0LnByZXNlbmNlU2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAgICAgZm9yIChsZXQgcHJvcCBpbiB0aGlzLnByZXNlbmNlU2V0KSB7CiAgICAgICAgICAvLyBoYXNPd25Qcm9wZXJ5IGlzIG5vdCBuZWVkZWQgYmVjYXVzZSBvYmogaXMgT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgIHNldC5wcmVzZW5jZVNldFtwcm9wXSA9IHRoaXMucHJlc2VuY2VTZXRbcHJvcF07CiAgICAgICAgfQoKICAgICAgICBzZXQubGlzdCA9IHRoaXMudG9BcnJheSgpOwogICAgICAgIHNldC5zaXplID0gdGhpcy5zaXplOwoKICAgICAgICByZXR1cm4gc2V0OwogICAgICB9CiAgICB9OwogIH0gZWxzZSB7CiAgICBPcmRlcmVkU2V0ID0gRW1iZXIuX19PcmRlcmVkU2V0X18gfHwgRW1iZXIuT3JkZXJlZFNldDsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IE9yZGVyZWRTZXQ7Cn0pOwo7ZGVmaW5lKCdlbWJlci1hamF4Ly1wcml2YXRlL3Byb21pc2UnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CgoKICAvKioKICAgKiBBSkFYIFByb21pc2UKICAgKgogICAqIFN1Yi1jbGFzcyBvZiBSU1ZQIFByb21pc2UgdGhhdCBwYXNzZXMgdGhlIFhIUiBwcm9wZXJ0eSBvbiB0byB0aGUKICAgKiBjaGlsZCBwcm9taXNlCiAgICoKICAgKiBAZXh0ZW5kcyBSU1ZQLlByb21pc2UKICAgKiBAcHJpdmF0ZQogICAqLwogIGNsYXNzIEFKQVhQcm9taXNlIGV4dGVuZHMgRW1iZXIuUlNWUC5Qcm9taXNlIHsKICAgIC8qKgogICAgICogT3ZlcnJpZGluZyBgLnRoZW5gIHRvIGFkZCBYSFIgdG8gY2hpbGQgcHJvbWlzZQogICAgICoKICAgICAqIEBwdWJsaWMKICAgICAqIEByZXR1cm4ge0FKQVhQcm9taXNlfSBjaGlsZCBwcm9taXNlCiAgICAgKi8KICAgIHRoZW4oKSB7CiAgICAgIGNvbnN0IGNoaWxkID0gc3VwZXIudGhlbiguLi5hcmd1bWVudHMpOwoKICAgICAgY2hpbGQueGhyID0gdGhpcy54aHI7CgogICAgICByZXR1cm4gY2hpbGQ7CiAgICB9CiAgfQogIGV4cG9ydHMuZGVmYXVsdCA9IEFKQVhQcm9taXNlOwp9KTsKO2RlZmluZSgnZW1iZXItYWpheC8tcHJpdmF0ZS91dGlscy9nZXQtaGVhZGVyJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IGdldEhlYWRlcjsKCgogIC8qKgogICAqIERvIGEgY2FzZS1pbnNlbnNpdGl2ZSBsb29rdXAgb2YgYW4gSFRUUCBoZWFkZXIKICAgKgogICAqIEBmdW5jdGlvbiBnZXRIZWFkZXIKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBoZWFkZXJzCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICovCiAgZnVuY3Rpb24gZ2V0SGVhZGVyKGhlYWRlcnMsIG5hbWUpIHsKICAgIGlmIChFbWJlci5pc05vbmUoaGVhZGVycykgfHwgRW1iZXIuaXNOb25lKG5hbWUpKSB7CiAgICAgIHJldHVybjsgLy8gYXNrIGZvciBub3RoaW5nLCBnZXQgbm90aGluZy4KICAgIH0KCiAgICBjb25zdCBtYXRjaGVkS2V5ID0gRW1iZXIuQShPYmplY3Qua2V5cyhoZWFkZXJzKSkuZmluZChrZXkgPT4gewogICAgICByZXR1cm4ga2V5LnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0pOwoKICAgIHJldHVybiBoZWFkZXJzW21hdGNoZWRLZXldOwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvLXByaXZhdGUvdXRpbHMvaXMtZmFzdGJvb3QnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgLyogZ2xvYmFsIEZhc3RCb290ICovCiAgY29uc3QgaXNGYXN0Qm9vdCA9IHR5cGVvZiBGYXN0Qm9vdCAhPT0gJ3VuZGVmaW5lZCc7CiAgZXhwb3J0cy5kZWZhdWx0ID0gaXNGYXN0Qm9vdDsKfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvLXByaXZhdGUvdXRpbHMvaXMtc3RyaW5nJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IGlzU3RyaW5nOwogIGZ1bmN0aW9uIGlzU3RyaW5nKG9iamVjdCkgewogICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICdzdHJpbmcnOwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvLXByaXZhdGUvdXRpbHMvcGFyc2UtcmVzcG9uc2UtaGVhZGVycycsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBwYXJzZVJlc3BvbnNlSGVhZGVyczsKICBjb25zdCBDUkxGID0gZXhwb3J0cy5DUkxGID0gJ1x1MDAwZFx1MDAwYSc7CgogIGZ1bmN0aW9uIHBhcnNlUmVzcG9uc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpIHsKICAgIGNvbnN0IGhlYWRlcnMgPSB7fTsKCiAgICBpZiAoIWhlYWRlcnNTdHJpbmcpIHsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9CgogICAgcmV0dXJuIGhlYWRlcnNTdHJpbmcuc3BsaXQoQ1JMRikucmVkdWNlKChoYXNoLCBoZWFkZXIpID0+IHsKICAgICAgbGV0IFtmaWVsZCwgLi4udmFsdWVdID0gaGVhZGVyLnNwbGl0KCc6Jyk7CgogICAgICBmaWVsZCA9IGZpZWxkLnRyaW0oKTsKICAgICAgdmFsdWUgPSB2YWx1ZS5qb2luKCc6JykudHJpbSgpOwoKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgaGFzaFtmaWVsZF0gPSB2YWx1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGhhc2g7CiAgICB9LCBoZWFkZXJzKTsKICB9Cn0pOwo7ZGVmaW5lKCdlbWJlci1hamF4Ly1wcml2YXRlL3V0aWxzL3VybC1oZWxwZXJzJywgWydleHBvcnRzJywgJ3JlcXVpcmUnLCAnZW1iZXItYWpheC8tcHJpdmF0ZS91dGlscy9pcy1mYXN0Ym9vdCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3JlcXVpcmUyLCBfaXNGYXN0Ym9vdCkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLnBhcnNlVVJMID0gcGFyc2VVUkw7CiAgZXhwb3J0cy5pc0Z1bGxVUkwgPSBpc0Z1bGxVUkw7CiAgZXhwb3J0cy5oYXZlU2FtZUhvc3QgPSBoYXZlU2FtZUhvc3Q7CiAgLyogZXNsaW50LWVudiBicm93c2VyLCBub2RlICovCgogIGNvbnN0IGNvbXBsZXRlVXJsUmVnZXggPSAvXihodHRwfGh0dHBzKS87CgogIC8qCiAgICogSXNvbW9ycGhpYyBVUkwgcGFyc2luZwogICAqIEJvcnJvd2VkIGZyb20KICAgKiBodHRwOi8vd3d3LnNpdGVwb2ludC5jb20vdXJsLXBhcnNpbmctaXNvbW9ycGhpYy1qYXZhc2NyaXB0LwogICAqLwogIGNvbnN0IGlzTm9kZSA9IHR5cGVvZiBzZWxmID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcgJiYge30udG9TdHJpbmcuY2FsbChwcm9jZXNzKSA9PT0gJ1tvYmplY3QgcHJvY2Vzc10nOwoKICBjb25zdCB1cmwgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoX2lzRmFzdGJvb3QuZGVmYXVsdCkgewogICAgICAvLyBlbWJlci1mYXN0Ym9vdC1zZXJ2ZXIgcHJvdmlkZXMgdGhlIG5vZGUgdXJsIG1vZHVsZSBhcyBVUkwgZ2xvYmFsCiAgICAgIHJldHVybiBVUkw7CiAgICB9CgogICAgaWYgKGlzTm9kZSkgewogICAgICByZXR1cm4gKDAsIF9yZXF1aXJlMi5kZWZhdWx0KSgndXJsJyk7CiAgICB9CgogICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICB9KCk7CgogIC8qKgogICAqIFBhcnNlIGEgVVJMIHN0cmluZyBpbnRvIGFuIG9iamVjdCB0aGF0IGRlZmluZXMgaXRzIHN0cnVjdHVyZQogICAqCiAgICogVGhlIHJldHVybmVkIG9iamVjdCB3aWxsIGhhdmUgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqCiAgICogICBocmVmOiB0aGUgZnVsbCBVUkwKICAgKiAgIHByb3RvY29sOiB0aGUgcmVxdWVzdCBwcm90b2NvbAogICAqICAgaG9zdG5hbWU6IHRoZSB0YXJnZXQgZm9yIHRoZSByZXF1ZXN0CiAgICogICBwb3J0OiB0aGUgcG9ydCBmb3IgdGhlIHJlcXVlc3QKICAgKiAgIHBhdGhuYW1lOiBhbnkgVVJMIGFmdGVyIHRoZSBob3N0CiAgICogICBzZWFyY2g6IHF1ZXJ5IHBhcmFtZXRlcnMKICAgKiAgIGhhc2g6IHRoZSBVUkwgaGFzaAogICAqCiAgICogQGZ1bmN0aW9uIHBhcnNlVVJMCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyIFRoZSBzdHJpbmcgdG8gcGFyc2UKICAgKiBAcmV0dXJuIHtPYmplY3R9IFVSTCBzdHJ1Y3R1cmUKICAgKi8KICBmdW5jdGlvbiBwYXJzZVVSTChzdHIpIHsKICAgIGxldCBmdWxsT2JqZWN0OwoKICAgIGlmIChpc05vZGUgfHwgX2lzRmFzdGJvb3QuZGVmYXVsdCkgewogICAgICBmdWxsT2JqZWN0ID0gdXJsLnBhcnNlKHN0cik7CiAgICB9IGVsc2UgewogICAgICB1cmwuaHJlZiA9IHN0cjsKICAgICAgZnVsbE9iamVjdCA9IHVybDsKICAgIH0KCiAgICBjb25zdCBkZXNpcmVkUHJvcHMgPSB7fTsKICAgIGRlc2lyZWRQcm9wcy5ocmVmID0gZnVsbE9iamVjdC5ocmVmOwogICAgZGVzaXJlZFByb3BzLnByb3RvY29sID0gZnVsbE9iamVjdC5wcm90b2NvbDsKICAgIGRlc2lyZWRQcm9wcy5ob3N0bmFtZSA9IGZ1bGxPYmplY3QuaG9zdG5hbWU7CiAgICBkZXNpcmVkUHJvcHMucG9ydCA9IGZ1bGxPYmplY3QucG9ydDsKICAgIGRlc2lyZWRQcm9wcy5wYXRobmFtZSA9IGZ1bGxPYmplY3QucGF0aG5hbWU7CiAgICBkZXNpcmVkUHJvcHMuc2VhcmNoID0gZnVsbE9iamVjdC5zZWFyY2g7CiAgICBkZXNpcmVkUHJvcHMuaGFzaCA9IGZ1bGxPYmplY3QuaGFzaDsKICAgIHJldHVybiBkZXNpcmVkUHJvcHM7CiAgfQoKICBmdW5jdGlvbiBpc0Z1bGxVUkwodXJsKSB7CiAgICByZXR1cm4gdXJsLm1hdGNoKGNvbXBsZXRlVXJsUmVnZXgpOwogIH0KCiAgZnVuY3Rpb24gaGF2ZVNhbWVIb3N0KGEsIGIpIHsKICAgIGEgPSBwYXJzZVVSTChhKTsKICAgIGIgPSBwYXJzZVVSTChiKTsKCiAgICByZXR1cm4gYS5wcm90b2NvbCA9PT0gYi5wcm90b2NvbCAmJiBhLmhvc3RuYW1lID09PSBiLmhvc3RuYW1lICYmIGEucG9ydCA9PT0gYi5wb3J0OwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvYWpheC1yZXF1ZXN0JywgWydleHBvcnRzJywgJ2VtYmVyLWFqYXgvbWl4aW5zL2FqYXgtcmVxdWVzdCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2FqYXhSZXF1ZXN0KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoX2FqYXhSZXF1ZXN0LmRlZmF1bHQpOwp9KTsKO2RlZmluZSgnZW1iZXItYWpheC9lcnJvcnMnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5BamF4RXJyb3IgPSBBamF4RXJyb3I7CiAgZXhwb3J0cy5JbnZhbGlkRXJyb3IgPSBJbnZhbGlkRXJyb3I7CiAgZXhwb3J0cy5VbmF1dGhvcml6ZWRFcnJvciA9IFVuYXV0aG9yaXplZEVycm9yOwogIGV4cG9ydHMuRm9yYmlkZGVuRXJyb3IgPSBGb3JiaWRkZW5FcnJvcjsKICBleHBvcnRzLkJhZFJlcXVlc3RFcnJvciA9IEJhZFJlcXVlc3RFcnJvcjsKICBleHBvcnRzLk5vdEZvdW5kRXJyb3IgPSBOb3RGb3VuZEVycm9yOwogIGV4cG9ydHMuVGltZW91dEVycm9yID0gVGltZW91dEVycm9yOwogIGV4cG9ydHMuQWJvcnRFcnJvciA9IEFib3J0RXJyb3I7CiAgZXhwb3J0cy5Db25mbGljdEVycm9yID0gQ29uZmxpY3RFcnJvcjsKICBleHBvcnRzLlNlcnZlckVycm9yID0gU2VydmVyRXJyb3I7CiAgZXhwb3J0cy5pc0FqYXhFcnJvciA9IGlzQWpheEVycm9yOwogIGV4cG9ydHMuaXNVbmF1dGhvcml6ZWRFcnJvciA9IGlzVW5hdXRob3JpemVkRXJyb3I7CiAgZXhwb3J0cy5pc0ZvcmJpZGRlbkVycm9yID0gaXNGb3JiaWRkZW5FcnJvcjsKICBleHBvcnRzLmlzSW52YWxpZEVycm9yID0gaXNJbnZhbGlkRXJyb3I7CiAgZXhwb3J0cy5pc0JhZFJlcXVlc3RFcnJvciA9IGlzQmFkUmVxdWVzdEVycm9yOwogIGV4cG9ydHMuaXNOb3RGb3VuZEVycm9yID0gaXNOb3RGb3VuZEVycm9yOwogIGV4cG9ydHMuaXNUaW1lb3V0RXJyb3IgPSBpc1RpbWVvdXRFcnJvcjsKICBleHBvcnRzLmlzQWJvcnRFcnJvciA9IGlzQWJvcnRFcnJvcjsKICBleHBvcnRzLmlzQ29uZmxpY3RFcnJvciA9IGlzQ29uZmxpY3RFcnJvcjsKICBleHBvcnRzLmlzU2VydmVyRXJyb3IgPSBpc1NlcnZlckVycm9yOwogIGV4cG9ydHMuaXNTdWNjZXNzID0gaXNTdWNjZXNzOwoKCiAgLyoqCiAgICogQGNsYXNzIEFqYXhFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBFbWJlci5FcnJvcgogICAqLwogIGZ1bmN0aW9uIEFqYXhFcnJvcihwYXlsb2FkLCBtZXNzYWdlID0gJ0FqYXggb3BlcmF0aW9uIGZhaWxlZCcsIHN0YXR1cykgewogICAgRW1iZXIuRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKCiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgfQoKICBBamF4RXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFbWJlci5FcnJvci5wcm90b3R5cGUpOwoKICAvKioKICAgKiBAY2xhc3MgSW52YWxpZEVycm9yCiAgICogQHB1YmxpYwogICAqIEBleHRlbmRzIEFqYXhFcnJvcgogICAqLwogIGZ1bmN0aW9uIEludmFsaWRFcnJvcihwYXlsb2FkKSB7CiAgICBBamF4RXJyb3IuY2FsbCh0aGlzLCBwYXlsb2FkLCAnUmVxdWVzdCB3YXMgcmVqZWN0ZWQgYmVjYXVzZSBpdCB3YXMgaW52YWxpZCcsIDQyMik7CiAgfQoKICBJbnZhbGlkRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBamF4RXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICogQGNsYXNzIFVuYXV0aG9yaXplZEVycm9yCiAgICogQHB1YmxpYwogICAqIEBleHRlbmRzIEFqYXhFcnJvcgogICAqLwogIGZ1bmN0aW9uIFVuYXV0aG9yaXplZEVycm9yKHBheWxvYWQpIHsKICAgIEFqYXhFcnJvci5jYWxsKHRoaXMsIHBheWxvYWQsICdBamF4IGF1dGhvcml6YXRpb24gZmFpbGVkJywgNDAxKTsKICB9CgogIFVuYXV0aG9yaXplZEVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWpheEVycm9yLnByb3RvdHlwZSk7CgogIC8qKgogICAqIEBjbGFzcyBGb3JiaWRkZW5FcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBBamF4RXJyb3IKICAgKi8KICBmdW5jdGlvbiBGb3JiaWRkZW5FcnJvcihwYXlsb2FkKSB7CiAgICBBamF4RXJyb3IuY2FsbCh0aGlzLCBwYXlsb2FkLCAnUmVxdWVzdCB3YXMgcmVqZWN0ZWQgYmVjYXVzZSB1c2VyIGlzIG5vdCBwZXJtaXR0ZWQgdG8gcGVyZm9ybSB0aGlzIG9wZXJhdGlvbi4nLCA0MDMpOwogIH0KCiAgRm9yYmlkZGVuRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBamF4RXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICogQGNsYXNzIEJhZFJlcXVlc3RFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBBamF4RXJyb3IKICAgKi8KICBmdW5jdGlvbiBCYWRSZXF1ZXN0RXJyb3IocGF5bG9hZCkgewogICAgQWpheEVycm9yLmNhbGwodGhpcywgcGF5bG9hZCwgJ1JlcXVlc3Qgd2FzIGZvcm1hdHRlZCBpbmNvcnJlY3RseS4nLCA0MDApOwogIH0KCiAgQmFkUmVxdWVzdEVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWpheEVycm9yLnByb3RvdHlwZSk7CgogIC8qKgogICAqIEBjbGFzcyBOb3RGb3VuZEVycm9yCiAgICogQHB1YmxpYwogICAqIEBleHRlbmRzIEFqYXhFcnJvcgogICAqLwogIGZ1bmN0aW9uIE5vdEZvdW5kRXJyb3IocGF5bG9hZCkgewogICAgQWpheEVycm9yLmNhbGwodGhpcywgcGF5bG9hZCwgJ1Jlc291cmNlIHdhcyBub3QgZm91bmQuJywgNDA0KTsKICB9CgogIE5vdEZvdW5kRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBamF4RXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICogQGNsYXNzIFRpbWVvdXRFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBBamF4RXJyb3IKICAgKi8KICBmdW5jdGlvbiBUaW1lb3V0RXJyb3IoKSB7CiAgICBBamF4RXJyb3IuY2FsbCh0aGlzLCBudWxsLCAnVGhlIGFqYXggb3BlcmF0aW9uIHRpbWVkIG91dCcsIC0xKTsKICB9CgogIFRpbWVvdXRFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEFqYXhFcnJvci5wcm90b3R5cGUpOwoKICAvKioKICAgKiBAY2xhc3MgQWJvcnRFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBBamF4RXJyb3IKICAgKi8KICBmdW5jdGlvbiBBYm9ydEVycm9yKCkgewogICAgQWpheEVycm9yLmNhbGwodGhpcywgbnVsbCwgJ1RoZSBhamF4IG9wZXJhdGlvbiB3YXMgYWJvcnRlZCcsIDApOwogIH0KCiAgQWJvcnRFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEFqYXhFcnJvci5wcm90b3R5cGUpOwoKICAvKioKICAgKiBAY2xhc3MgQ29uZmxpY3RFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAZXh0ZW5kcyBBamF4RXJyb3IKICAgKi8KICBmdW5jdGlvbiBDb25mbGljdEVycm9yKHBheWxvYWQpIHsKICAgIEFqYXhFcnJvci5jYWxsKHRoaXMsIHBheWxvYWQsICdUaGUgYWpheCBvcGVyYXRpb24gZmFpbGVkIGR1ZSB0byBhIGNvbmZsaWN0JywgNDA5KTsKICB9CgogIENvbmZsaWN0RXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBamF4RXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICogQGNsYXNzIFNlcnZlckVycm9yCiAgICogQHB1YmxpYwogICAqIEBleHRlbmRzIEFqYXhFcnJvcgogICAqLwogIGZ1bmN0aW9uIFNlcnZlckVycm9yKHBheWxvYWQsIHN0YXR1cykgewogICAgQWpheEVycm9yLmNhbGwodGhpcywgcGF5bG9hZCwgJ1JlcXVlc3Qgd2FzIHJlamVjdGVkIGR1ZSB0byBzZXJ2ZXIgZXJyb3InLCBzdGF0dXMpOwogIH0KCiAgU2VydmVyRXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBamF4RXJyb3IucHJvdG90eXBlKTsKCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBlcnJvciBpcyBvciBpbmhlcml0cyBmcm9tIEFqYXhFcnJvcgogICAqCiAgICogQG1ldGhvZCBpc0FqYXhFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAcGFyYW0gIHtFcnJvcn0gZXJyb3IKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzQWpheEVycm9yKGVycm9yKSB7CiAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBBamF4RXJyb3I7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0YXR1cyBjb2RlIG9yIEFqYXhFcnJvciBvYmplY3QgcmVwcmVzZW50cyBhbgogICAqIHVuYXV0aG9yaXplZCByZXF1ZXN0IGVycm9yCiAgICoKICAgKiBAbWV0aG9kIGlzVW5hdXRob3JpemVkRXJyb3IKICAgKiBAcHVibGljCiAgICogQHBhcmFtICB7TnVtYmVyIHwgQWpheEVycm9yfSBlcnJvcgogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCiAgZnVuY3Rpb24gaXNVbmF1dGhvcml6ZWRFcnJvcihlcnJvcikgewogICAgaWYgKGlzQWpheEVycm9yKGVycm9yKSkgewogICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFcnJvcjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlcnJvciA9PT0gNDAxOwogICAgfQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdGF0dXMgY29kZSBvciBBamF4RXJyb3Igb2JqZWN0IHJlcHJlc2VudHMgYSBmb3JiaWRkZW4KICAgKiByZXF1ZXN0IGVycm9yCiAgICoKICAgKiBAbWV0aG9kIGlzRm9yYmlkZGVuRXJyb3IKICAgKiBAcHVibGljCiAgICogQHBhcmFtICB7TnVtYmVyIHwgQWpheEVycm9yfSBlcnJvcgogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCiAgZnVuY3Rpb24gaXNGb3JiaWRkZW5FcnJvcihlcnJvcikgewogICAgaWYgKGlzQWpheEVycm9yKGVycm9yKSkgewogICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBGb3JiaWRkZW5FcnJvcjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlcnJvciA9PT0gNDAzOwogICAgfQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdGF0dXMgY29kZSBvciBBamF4RXJyb3Igb2JqZWN0IHJlcHJlc2VudHMgYW4gaW52YWxpZAogICAqIHJlcXVlc3QgZXJyb3IKICAgKgogICAqIEBtZXRob2QgaXNJbnZhbGlkRXJyb3IKICAgKiBAcHVibGljCiAgICogQHBhcmFtICB7TnVtYmVyIHwgQWpheEVycm9yfSBlcnJvcgogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCiAgZnVuY3Rpb24gaXNJbnZhbGlkRXJyb3IoZXJyb3IpIHsKICAgIGlmIChpc0FqYXhFcnJvcihlcnJvcikpIHsKICAgICAgcmV0dXJuIGVycm9yIGluc3RhbmNlb2YgSW52YWxpZEVycm9yOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVycm9yID09PSA0MjI7CiAgICB9CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0YXR1cyBjb2RlIG9yIEFqYXhFcnJvciBvYmplY3QgcmVwcmVzZW50cyBhIGJhZCByZXF1ZXN0CiAgICogZXJyb3IKICAgKgogICAqIEBtZXRob2QgaXNCYWRSZXF1ZXN0RXJyb3IKICAgKiBAcHVibGljCiAgICogQHBhcmFtICB7TnVtYmVyIHwgQWpheEVycm9yfSBlcnJvcgogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCiAgZnVuY3Rpb24gaXNCYWRSZXF1ZXN0RXJyb3IoZXJyb3IpIHsKICAgIGlmIChpc0FqYXhFcnJvcihlcnJvcikpIHsKICAgICAgcmV0dXJuIGVycm9yIGluc3RhbmNlb2YgQmFkUmVxdWVzdEVycm9yOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVycm9yID09PSA0MDA7CiAgICB9CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0YXR1cyBjb2RlIG9yIEFqYXhFcnJvciBvYmplY3QgcmVwcmVzZW50cyBhCiAgICogIm5vdCBmb3VuZCIgZXJyb3IKICAgKgogICAqIEBtZXRob2QgaXNOb3RGb3VuZEVycm9yCiAgICogQHB1YmxpYwogICAqIEBwYXJhbSAge051bWJlciB8IEFqYXhFcnJvcn0gZXJyb3IKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzTm90Rm91bmRFcnJvcihlcnJvcikgewogICAgaWYgKGlzQWpheEVycm9yKGVycm9yKSkgewogICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBOb3RGb3VuZEVycm9yOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVycm9yID09PSA0MDQ7CiAgICB9CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0YXR1cyBjb2RlIG9yIEFqYXhFcnJvciBvYmplY3QgcmVwcmVzZW50cyBhCiAgICogInRpbWVvdXQiIGVycm9yCiAgICoKICAgKiBAbWV0aG9kIGlzVGltZW91dEVycm9yCiAgICogQHB1YmxpYwogICAqIEBwYXJhbSAge0FqYXhFcnJvcn0gZXJyb3IKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzVGltZW91dEVycm9yKGVycm9yKSB7CiAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBUaW1lb3V0RXJyb3I7CiAgfQoKICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0YXR1cyBjb2RlIG9yIEFqYXhFcnJvciBvYmplY3QgcmVwcmVzZW50cyBhbgogICAqICJhYm9ydCIgZXJyb3IKICAgKgogICAqIEBtZXRob2QgaXNBYm9ydEVycm9yCiAgICogQHB1YmxpYwogICAqIEBwYXJhbSAge0FqYXhFcnJvcn0gZXJyb3IKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzQWJvcnRFcnJvcihlcnJvcikgewogICAgaWYgKGlzQWpheEVycm9yKGVycm9yKSkgewogICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBBYm9ydEVycm9yOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVycm9yID09PSAwOwogICAgfQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdGF0dXMgY29kZSBvciBBamF4RXJyb3Igb2JqZWN0IHJlcHJlc2VudHMgYQogICAqIGNvbmZsaWN0IGVycm9yCiAgICoKICAgKiBAbWV0aG9kIGlzQ29uZmxpY3RFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAcGFyYW0gIHtOdW1iZXIgfCBBamF4RXJyb3J9IGVycm9yCiAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgKi8KICBmdW5jdGlvbiBpc0NvbmZsaWN0RXJyb3IoZXJyb3IpIHsKICAgIGlmIChpc0FqYXhFcnJvcihlcnJvcikpIHsKICAgICAgcmV0dXJuIGVycm9yIGluc3RhbmNlb2YgQ29uZmxpY3RFcnJvcjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBlcnJvciA9PT0gNDA5OwogICAgfQogIH0KCiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBzdGF0dXMgY29kZSBvciBBamF4RXJyb3Igb2JqZWN0IHJlcHJlc2VudHMgYSBzZXJ2ZXIgZXJyb3IKICAgKgogICAqIEBtZXRob2QgaXNTZXJ2ZXJFcnJvcgogICAqIEBwdWJsaWMKICAgKiBAcGFyYW0gIHtOdW1iZXIgfCBBamF4RXJyb3J9IGVycm9yCiAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgKi8KICBmdW5jdGlvbiBpc1NlcnZlckVycm9yKGVycm9yKSB7CiAgICBpZiAoaXNBamF4RXJyb3IoZXJyb3IpKSB7CiAgICAgIHJldHVybiBlcnJvciBpbnN0YW5jZW9mIFNlcnZlckVycm9yOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVycm9yID49IDUwMCAmJiBlcnJvciA8IDYwMDsKICAgIH0KICB9CgogIC8qKgogICAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gc3RhdHVzIGNvZGUgcmVwcmVzZW50cyBhIHN1Y2Nlc3NmdWwgcmVxdWVzdAogICAqCiAgICogQG1ldGhvZCBpc1N1Y2Nlc3MKICAgKiBAcHVibGljCiAgICogQHBhcmFtICB7TnVtYmVyfSBzdGF0dXMKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMpIHsKICAgIGNvbnN0IHMgPSBwYXJzZUludChzdGF0dXMsIDEwKTsKCiAgICByZXR1cm4gcyA+PSAyMDAgJiYgcyA8IDMwMCB8fCBzID09PSAzMDQ7CiAgfQp9KTsKO2RlZmluZSgnZW1iZXItYWpheC9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1hamF4L3JlcXVlc3QnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9yZXF1ZXN0KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZGVmYXVsdCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9yZXF1ZXN0LmRlZmF1bHQ7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCdlbWJlci1hamF4L21peGlucy9hamF4LXJlcXVlc3QnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYWpheC9lcnJvcnMnLCAnZW1iZXItYWpheC91dGlscy9hamF4JywgJ2VtYmVyLWFqYXgvLXByaXZhdGUvdXRpbHMvcGFyc2UtcmVzcG9uc2UtaGVhZGVycycsICdlbWJlci1hamF4Ly1wcml2YXRlL3V0aWxzL2dldC1oZWFkZXInLCAnZW1iZXItYWpheC8tcHJpdmF0ZS91dGlscy91cmwtaGVscGVycycsICdlbWJlci1hamF4Ly1wcml2YXRlL3V0aWxzL2lzLXN0cmluZycsICdlbWJlci1hamF4Ly1wcml2YXRlL3Byb21pc2UnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lcnJvcnMsIF9hamF4LCBfcGFyc2VSZXNwb25zZUhlYWRlcnMsIF9nZXRIZWFkZXIsIF91cmxIZWxwZXJzLCBfaXNTdHJpbmcsIF9wcm9taXNlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgY29uc3QgeyBMb2dnZXIsIFRlc3QsIHRlc3RpbmcgfSA9IEVtYmVyOwogIGNvbnN0IEpTT05Db250ZW50VHlwZSA9IC9eYXBwbGljYXRpb25cLyg/OnZuZFwuYXBpXCspP2pzb24vaTsKCiAgZnVuY3Rpb24gaXNKU09OQ29udGVudFR5cGUoaGVhZGVyKSB7CiAgICBpZiAoISgwLCBfaXNTdHJpbmcuZGVmYXVsdCkoaGVhZGVyKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gISFoZWFkZXIubWF0Y2goSlNPTkNvbnRlbnRUeXBlKTsKICB9CgogIGZ1bmN0aW9uIGlzSlNPTlN0cmluZ2lmeWFibGUobWV0aG9kLCB7IGNvbnRlbnRUeXBlLCBkYXRhLCBoZWFkZXJzIH0pIHsKICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoIWlzSlNPTkNvbnRlbnRUeXBlKGNvbnRlbnRUeXBlKSAmJiAhaXNKU09OQ29udGVudFR5cGUoKDAsIF9nZXRIZWFkZXIuZGVmYXVsdCkoaGVhZGVycywgJ0NvbnRlbnQtVHlwZScpKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKHR5cGVvZiBkYXRhICE9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBzdGFydHNXaXRoU2xhc2goc3RyaW5nKSB7CiAgICByZXR1cm4gc3RyaW5nLmNoYXJBdCgwKSA9PT0gJy8nOwogIH0KCiAgZnVuY3Rpb24gZW5kc1dpdGhTbGFzaChzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcuY2hhckF0KHN0cmluZy5sZW5ndGggLSAxKSA9PT0gJy8nOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlTGVhZGluZ1NsYXNoKHN0cmluZykgewogICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMSk7CiAgfQoKICBmdW5jdGlvbiBzdHJpcFNsYXNoZXMocGF0aCkgewogICAgLy8gbWFrZSBzdXJlIHBhdGggc3RhcnRzIHdpdGggYC9gCiAgICBpZiAoc3RhcnRzV2l0aFNsYXNoKHBhdGgpKSB7CiAgICAgIHBhdGggPSByZW1vdmVMZWFkaW5nU2xhc2gocGF0aCk7CiAgICB9CgogICAgLy8gcmVtb3ZlIGVuZCBgL2AKICAgIGlmIChlbmRzV2l0aFNsYXNoKHBhdGgpKSB7CiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKDAsIC0xKTsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH0KCiAgbGV0IHBlbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogIGlmICh0ZXN0aW5nKSB7CiAgICBUZXN0LnJlZ2lzdGVyV2FpdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHBlbmRpbmdSZXF1ZXN0Q291bnQgPT09IDA7CiAgICB9KTsKICB9CgogIC8qKgogICAqIEFqYXhSZXF1ZXN0IE1peGluCiAgICoKICAgKiBAcHVibGljCiAgICogQG1peGluCiAgICovCiAgZXhwb3J0cy5kZWZhdWx0ID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgIC8qKgogICAgICogVGhlIGRlZmF1bHQgdmFsdWUgZm9yIHRoZSByZXF1ZXN0IGBjb250ZW50VHlwZWAKICAgICAqCiAgICAgKiBGb3Igbm93LCBkZWZhdWx0cyB0byB0aGUgc2FtZSB2YWx1ZSB0aGF0IGpRdWVyeSB3b3VsZCBhc3NpZ24uICBJbiB0aGUKICAgICAqIGZ1dHVyZSwgdGhlIGRlZmF1bHQgdmFsdWUgd2lsbCBiZSBmb3IgSlNPTiByZXF1ZXN0cy4KICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjb250ZW50VHlwZQogICAgICogQHB1YmxpYwogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgnLAoKICAgIC8qKgogICAgICogSGVhZGVycyB0byBpbmNsdWRlIG9uIHRoZSByZXF1ZXN0CiAgICAgKgogICAgICogU29tZSBBUElzIHJlcXVpcmUgSFRUUCBoZWFkZXJzLCBlLmcuIHRvIHByb3ZpZGUgYW4gQVBJIGtleS4gQXJiaXRyYXJ5CiAgICAgKiBoZWFkZXJzIGNhbiBiZSBzZXQgYXMga2V5L3ZhbHVlIHBhaXJzIG9uIHRoZSBgUkVTVEFkYXB0ZXJgJ3MgYGhlYWRlcnNgCiAgICAgKiBvYmplY3QgYW5kIEVtYmVyIERhdGEgd2lsbCBzZW5kIHRoZW0gYWxvbmcgd2l0aCBlYWNoIGFqYXggcmVxdWVzdC4KICAgICAqCiAgICAgKiBgYGBqYXZhc2NyaXB0CiAgICAgKiAvLyBhcHAvc2VydmljZXMvYWpheC5qcwogICAgICogaW1wb3J0IEFqYXhTZXJ2aWNlIGZyb20gJ2VtYmVyLWFqYXgvc2VydmljZXMvYWpheCc7CiAgICAgKgogICAgICogZXhwb3J0IGRlZmF1bHQgQWpheFNlcnZpY2UuZXh0ZW5kKHsKICAgICAqICAgaGVhZGVyczogewogICAgICogICAgICdBUElfS0VZJzogJ3NlY3JldCBrZXknLAogICAgICogICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAqICAgfQogICAgICogfSk7CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBgaGVhZGVyc2AgY2FuIGFsc28gYmUgdXNlZCBhcyBhIGNvbXB1dGVkIHByb3BlcnR5IHRvIHN1cHBvcnQgZHluYW1pYwogICAgICogaGVhZGVycy4KICAgICAqCiAgICAgKiBgYGBqYXZhc2NyaXB0CiAgICAgKiAvLyBhcHAvc2VydmljZXMvYWpheC5qcwogICAgICogaW1wb3J0IEVtYmVyIGZyb20gJ2VtYmVyJzsKICAgICAqIGltcG9ydCBBamF4U2VydmljZSBmcm9tICdlbWJlci1hamF4L3NlcnZpY2VzL2FqYXgnOwogICAgICoKICAgICAqIGNvbnN0IHsKICAgICAqICAgY29tcHV0ZWQsCiAgICAgKiAgIGdldCwKICAgICAqICAgaW5qZWN0OiB7IHNlcnZpY2UgfQogICAgICogfSA9IEVtYmVyOwogICAgICoKICAgICAqIGV4cG9ydCBkZWZhdWx0IEFqYXhTZXJ2aWNlLmV4dGVuZCh7CiAgICAgKiAgIHNlc3Npb246IHNlcnZpY2UoKSwKICAgICAqICAgaGVhZGVyczogY29tcHV0ZWQoJ3Nlc3Npb24uYXV0aFRva2VuJywgZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgcmV0dXJuIHsKICAgICAqICAgICAgICdBUElfS0VZJzogZ2V0KHRoaXMsICdzZXNzaW9uLmF1dGhUb2tlbicpLAogICAgICogICAgICAgJ0FOT1RIRVJfSEVBREVSJzogJ1NvbWUgaGVhZGVyIHZhbHVlJwogICAgICogICAgIH07CiAgICAgKiAgIH0pCiAgICAgKiB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIEluIHNvbWUgY2FzZXMsIHlvdXIgZHluYW1pYyBoZWFkZXJzIG1heSByZXF1aXJlIGRhdGEgZnJvbSBzb21lIG9iamVjdAogICAgICogb3V0c2lkZSBvZiBFbWJlcidzIG9ic2VydmVyIHN5c3RlbSAoZm9yIGV4YW1wbGUgYGRvY3VtZW50LmNvb2tpZWApLiBZb3UKICAgICAqIGNhbiB1c2UgdGhlIGB2b2xhdGlsZWAgZnVuY3Rpb24gdG8gc2V0IHRoZSBwcm9wZXJ0eSBpbnRvIGEgbm9uLWNhY2hlZCBtb2RlCiAgICAgKiBjYXVzaW5nIHRoZSBoZWFkZXJzIHRvIGJlIHJlY29tcHV0ZWQgd2l0aCBldmVyeSByZXF1ZXN0LgogICAgICoKICAgICAqIGBgYGphdmFzY3JpcHQKICAgICAqIC8vIGFwcC9zZXJ2aWNlcy9hamF4LmpzCiAgICAgKiBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICAgICogaW1wb3J0IEFqYXhTZXJ2aWNlIGZyb20gJ2VtYmVyLWFqYXgvc2VydmljZXMvYWpheCc7CiAgICAgKgogICAgICogY29uc3QgewogICAgICogICBjb21wdXRlZCwKICAgICAqICAgZ2V0LAogICAgICogICBpbmplY3Q6IHsgc2VydmljZSB9CiAgICAgKiB9ID0gRW1iZXI7CiAgICAgKgogICAgICogZXhwb3J0IGRlZmF1bHQgQWpheFNlcnZpY2UuZXh0ZW5kKHsKICAgICAqICAgc2Vzc2lvbjogc2VydmljZSgpLAogICAgICogICBoZWFkZXJzOiBjb21wdXRlZCgnc2Vzc2lvbi5hdXRoVG9rZW4nLCBmdW5jdGlvbigpIHsKICAgICAqICAgICByZXR1cm4gewogICAgICogICAgICAgJ0FQSV9LRVknOiBnZXQoZG9jdW1lbnQuY29va2llLm1hdGNoKC9hcGlLZXlcPShbXjtdKikvKSwgJzEnKSwKICAgICAqICAgICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAqICAgICB9OwogICAgICogICB9KS52b2xhdGlsZSgpCiAgICAgKiB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBoZWFkZXJzCiAgICAgKiBAcHVibGljCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICBoZWFkZXJzOiB7fSwKCiAgICAvKioKICAgICAqIE1ha2UgYW4gQUpBWCByZXF1ZXN0LCBpZ25vcmluZyB0aGUgcmF3IFhIUiBvYmplY3QgYW5kIGRlYWxpbmcgb25seSB3aXRoCiAgICAgKiB0aGUgcmVzcG9uc2UKICAgICAqCiAgICAgKiBAbWV0aG9kIHJlcXVlc3QKICAgICAqIEBwdWJsaWMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBtYWtlIGEgcmVxdWVzdCB0bwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoZSByZXF1ZXN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBUaGUgcmVzdWx0IG9mIHRoZSByZXF1ZXN0CiAgICAgKi8KICAgIHJlcXVlc3QodXJsLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLm9wdGlvbnModXJsLCBvcHRpb25zKTsKICAgICAgY29uc3QgaW50ZXJuYWxQcm9taXNlID0gdGhpcy5fbWFrZVJlcXVlc3QoaGFzaCk7CgogICAgICBjb25zdCBhamF4UHJvbWlzZSA9IG5ldyBfcHJvbWlzZS5kZWZhdWx0KChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBpbnRlcm5hbFByb21pc2UudGhlbigoeyByZXNwb25zZSB9KSA9PiB7CiAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTsKICAgICAgICB9KS5jYXRjaCgoeyByZXNwb25zZSB9KSA9PiB7CiAgICAgICAgICByZWplY3QocmVzcG9uc2UpOwogICAgICAgIH0pOwogICAgICB9LCBgZW1iZXItYWpheDogJHtoYXNoLnR5cGV9ICR7aGFzaC51cmx9IHJlc3BvbnNlYCk7CgogICAgICBhamF4UHJvbWlzZS54aHIgPSBpbnRlcm5hbFByb21pc2UueGhyOwoKICAgICAgcmV0dXJuIGFqYXhQcm9taXNlOwogICAgfSwKCiAgICAvKioKICAgICAqIE1ha2UgYW4gQUpBWCByZXF1ZXN0LCByZXR1cm5pbmcgdGhlIHJhdyBYSFIgb2JqZWN0IGFsb25nIHdpdGggdGhlIHJlc3BvbnNlCiAgICAgKgogICAgICogQG1ldGhvZCByYXcKICAgICAqIEBwdWJsaWMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBtYWtlIGEgcmVxdWVzdCB0bwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoZSByZXF1ZXN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBUaGUgcmVzdWx0IG9mIHRoZSByZXF1ZXN0CiAgICAgKi8KICAgIHJhdyh1cmwsIG9wdGlvbnMpIHsKICAgICAgY29uc3QgaGFzaCA9IHRoaXMub3B0aW9ucyh1cmwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3QoaGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICogU2hhcmVkIG1ldGhvZCB0byBhY3R1YWxseSBtYWtlIGFuIEFKQVggcmVxdWVzdAogICAgICoKICAgICAqIEBtZXRob2QgX21ha2VSZXF1ZXN0CiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IGhhc2ggVGhlIG9wdGlvbnMgZm9yIHRoZSByZXF1ZXN0CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaC51cmwgVGhlIFVSTCB0byBtYWtlIHRoZSByZXF1ZXN0IHRvCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBUaGUgcmVzdWx0IG9mIHRoZSByZXF1ZXN0CiAgICAgKi8KICAgIF9tYWtlUmVxdWVzdChoYXNoKSB7CiAgICAgIGNvbnN0IG1ldGhvZCA9IGhhc2gubWV0aG9kIHx8IGhhc2gudHlwZSB8fCAnR0VUJzsKICAgICAgY29uc3QgcmVxdWVzdERhdGEgPSB7IG1ldGhvZCwgdHlwZTogbWV0aG9kLCB1cmw6IGhhc2gudXJsIH07CgogICAgICBpZiAoaXNKU09OU3RyaW5naWZ5YWJsZShtZXRob2QsIGhhc2gpKSB7CiAgICAgICAgaGFzaC5kYXRhID0gSlNPTi5zdHJpbmdpZnkoaGFzaC5kYXRhKTsKICAgICAgfQoKICAgICAgcGVuZGluZ1JlcXVlc3RDb3VudCA9IHBlbmRpbmdSZXF1ZXN0Q291bnQgKyAxOwoKICAgICAgY29uc3QganFYSFIgPSAoMCwgX2FqYXguZGVmYXVsdCkoaGFzaCk7CgogICAgICBjb25zdCBwcm9taXNlID0gbmV3IF9wcm9taXNlLmRlZmF1bHQoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGpxWEhSLmRvbmUoKHBheWxvYWQsIHRleHRTdGF0dXMsIGpxWEhSKSA9PiB7CiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHRoaXMuaGFuZGxlUmVzcG9uc2UoanFYSFIuc3RhdHVzLCAoMCwgX3BhcnNlUmVzcG9uc2VIZWFkZXJzLmRlZmF1bHQpKGpxWEhSLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKSwgcGF5bG9hZCwgcmVxdWVzdERhdGEpOwoKICAgICAgICAgIGlmICgoMCwgX2Vycm9ycy5pc0FqYXhFcnJvcikocmVzcG9uc2UpKSB7CiAgICAgICAgICAgIEVtYmVyLnJ1bi5qb2luKG51bGwsIHJlamVjdCwgeyBwYXlsb2FkLCB0ZXh0U3RhdHVzLCBqcVhIUiwgcmVzcG9uc2UgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBFbWJlci5ydW4uam9pbihudWxsLCByZXNvbHZlLCB7IHBheWxvYWQsIHRleHRTdGF0dXMsIGpxWEhSLCByZXNwb25zZSB9KTsKICAgICAgICAgIH0KICAgICAgICB9KS5mYWlsKChqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pID0+IHsKICAgICAgICAgIEVtYmVyLnJ1bkluRGVidWcoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYFRoZSBzZXJ2ZXIgcmV0dXJuZWQgYW4gZW1wdHkgc3RyaW5nIGZvciAke3JlcXVlc3REYXRhLnR5cGV9ICR7cmVxdWVzdERhdGEudXJsfSwgd2hpY2ggY2Fubm90IGJlIHBhcnNlZCBpbnRvIGEgdmFsaWQgSlNPTi4gUmV0dXJuIGVpdGhlciBudWxsIG9yIHt9LmA7CiAgICAgICAgICAgIGNvbnN0IHZhbGlkSlNPTlN0cmluZyA9ICEodGV4dFN0YXR1cyA9PT0gJ3BhcnNlcmVycm9yJyAmJiBqcVhIUi5yZXNwb25zZVRleHQgPT09ICcnKTsKCiAgICAgICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4obWVzc2FnZSwgdmFsaWRKU09OU3RyaW5nLCB7CiAgICAgICAgICAgICAgaWQ6ICdkcy5hZGFwdGVyLnJldHVybmVkLWVtcHR5LXN0cmluZy1hcy1KU09OJwogICAgICAgICAgICB9KSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5wYXJzZUVycm9yUmVzcG9uc2UoanFYSFIucmVzcG9uc2VUZXh0KSB8fCBlcnJvclRocm93bjsKICAgICAgICAgIGxldCByZXNwb25zZTsKCiAgICAgICAgICBpZiAoZXJyb3JUaHJvd24gaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICByZXNwb25zZSA9IGVycm9yVGhyb3duOwogICAgICAgICAgfSBlbHNlIGlmICh0ZXh0U3RhdHVzID09PSAndGltZW91dCcpIHsKICAgICAgICAgICAgcmVzcG9uc2UgPSBuZXcgX2Vycm9ycy5UaW1lb3V0RXJyb3IoKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGV4dFN0YXR1cyA9PT0gJ2Fib3J0JykgewogICAgICAgICAgICByZXNwb25zZSA9IG5ldyBfZXJyb3JzLkFib3J0RXJyb3IoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3BvbnNlID0gdGhpcy5oYW5kbGVSZXNwb25zZShqcVhIUi5zdGF0dXMsICgwLCBfcGFyc2VSZXNwb25zZUhlYWRlcnMuZGVmYXVsdCkoanFYSFIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICB9CgogICAgICAgICAgRW1iZXIucnVuLmpvaW4obnVsbCwgcmVqZWN0LCB7IHBheWxvYWQsIHRleHRTdGF0dXMsIGpxWEhSLCBlcnJvclRocm93biwgcmVzcG9uc2UgfSk7CiAgICAgICAgfSkuYWx3YXlzKCgpID0+IHsKICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0Q291bnQgPSBwZW5kaW5nUmVxdWVzdENvdW50IC0gMTsKICAgICAgICB9KTsKICAgICAgfSwgYGVtYmVyLWFqYXg6ICR7aGFzaC50eXBlfSAke2hhc2gudXJsfWApOwoKICAgICAgcHJvbWlzZS54aHIgPSBqcVhIUjsKCiAgICAgIHJldHVybiBwcm9taXNlOwogICAgfSwKCiAgICAvKioKICAgICAqIGNhbGxzIGByZXF1ZXN0KClgIGJ1dCBmb3JjZXMgYG9wdGlvbnMudHlwZWAgdG8gYFBPU1RgCiAgICAgKgogICAgICogQG1ldGhvZCBwb3N0CiAgICAgKiBAcHVibGljCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gbWFrZSBhIHJlcXVlc3QgdG8KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciB0aGUgcmVxdWVzdAogICAgICogQHJldHVybiB7UHJvbWlzZX0gVGhlIHJlc3VsdCBvZiB0aGUgcmVxdWVzdAogICAgICovCiAgICBwb3N0KHVybCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHVybCwgdGhpcy5fYWRkVHlwZVRvT3B0aW9uc0ZvcihvcHRpb25zLCAnUE9TVCcpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBjYWxscyBgcmVxdWVzdCgpYCBidXQgZm9yY2VzIGBvcHRpb25zLnR5cGVgIHRvIGBQVVRgCiAgICAgKgogICAgICogQG1ldGhvZCBwdXQKICAgICAqIEBwdWJsaWMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0byBtYWtlIGEgcmVxdWVzdCB0bwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoZSByZXF1ZXN0CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSBUaGUgcmVzdWx0IG9mIHRoZSByZXF1ZXN0CiAgICAgKi8KICAgIHB1dCh1cmwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCh1cmwsIHRoaXMuX2FkZFR5cGVUb09wdGlvbnNGb3Iob3B0aW9ucywgJ1BVVCcpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBjYWxscyBgcmVxdWVzdCgpYCBidXQgZm9yY2VzIGBvcHRpb25zLnR5cGVgIHRvIGBQQVRDSGAKICAgICAqCiAgICAgKiBAbWV0aG9kIHBhdGNoCiAgICAgKiBAcHVibGljCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gbWFrZSBhIHJlcXVlc3QgdG8KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciB0aGUgcmVxdWVzdAogICAgICogQHJldHVybiB7UHJvbWlzZX0gVGhlIHJlc3VsdCBvZiB0aGUgcmVxdWVzdAogICAgICovCiAgICBwYXRjaCh1cmwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCh1cmwsIHRoaXMuX2FkZFR5cGVUb09wdGlvbnNGb3Iob3B0aW9ucywgJ1BBVENIJykpOwogICAgfSwKCiAgICAvKioKICAgICAqIGNhbGxzIGByZXF1ZXN0KClgIGJ1dCBmb3JjZXMgYG9wdGlvbnMudHlwZWAgdG8gYERFTEVURWAKICAgICAqCiAgICAgKiBAbWV0aG9kIGRlbAogICAgICogQHB1YmxpYwogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIHRvIG1ha2UgYSByZXF1ZXN0IHRvCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3IgdGhlIHJlcXVlc3QKICAgICAqIEByZXR1cm4ge1Byb21pc2V9IFRoZSByZXN1bHQgb2YgdGhlIHJlcXVlc3QKICAgICAqLwogICAgZGVsKHVybCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHVybCwgdGhpcy5fYWRkVHlwZVRvT3B0aW9uc0ZvcihvcHRpb25zLCAnREVMRVRFJykpOwogICAgfSwKCiAgICAvKioKICAgICAqIGNhbGxzIGByZXF1ZXN0KClgIGJ1dCBmb3JjZXMgYG9wdGlvbnMudHlwZWAgdG8gYERFTEVURWAKICAgICAqCiAgICAgKiBBbGlhcyBmb3IgYGRlbCgpYAogICAgICoKICAgICAqIEBtZXRob2QgZGVsZXRlCiAgICAgKiBAcHVibGljCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwgdG8gbWFrZSBhIHJlcXVlc3QgdG8KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciB0aGUgcmVxdWVzdAogICAgICogQHJldHVybiB7UHJvbWlzZX0gVGhlIHJlc3VsdCBvZiB0aGUgcmVxdWVzdAogICAgICovCiAgICBkZWxldGUoKSB7CiAgICAgIHJldHVybiB0aGlzLmRlbCguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAqIFdyYXAgdGhlIGAuZ2V0YCBtZXRob2Qgc28gdGhhdCB3ZSBpc3N1ZSBhIHdhcm5pbmcgaWYKICAgICAqCiAgICAgKiBTaW5jZSBgLmdldGAgaXMgYm90aCBhbiBBSkFYIHBhdHRlcm4gX2FuZF8gYW4gRW1iZXIgcGF0dGVybiwgd2Ugd2FudCB0byB0cnkKICAgICAqIHRvIHdhcm4gdXNlcnMgd2hlbiB0aGV5IHRyeSB1c2luZyBgLmdldGAgdG8gbWFrZSBhIHJlcXVlc3QKICAgICAqCiAgICAgKiBAbWV0aG9kIGdldAogICAgICogQHB1YmxpYwogICAgICovCiAgICBnZXQodXJsKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSB8fCB1cmwuaW5kZXhPZignLycpICE9PSAtMSkgewogICAgICAgIHRocm93IG5ldyBFbWJlci5FcnJvcignSXQgc2VlbXMgeW91IHRyaWVkIHRvIHVzZSBgLmdldGAgdG8gbWFrZSBhIHJlcXVlc3QhIFVzZSB0aGUgYC5yZXF1ZXN0YCBtZXRob2QgaW5zdGVhZC4nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBNYW5pcHVsYXRlcyB0aGUgb3B0aW9ucyBoYXNoIHRvIGluY2x1ZGUgdGhlIEhUVFAgbWV0aG9kIG9uIHRoZSB0eXBlIGtleQogICAgICoKICAgICAqIEBtZXRob2QgX2FkZFR5cGVUb09wdGlvbnNGb3IKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgb3JpZ2luYWwgcmVxdWVzdCBvcHRpb25zCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kIFRoZSBtZXRob2QgdG8gZW5mb3JjZQogICAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgbmV3IG9wdGlvbnMsIHdpdGggdGhlIG1ldGhvZCBzZXQKICAgICAqLwogICAgX2FkZFR5cGVUb09wdGlvbnNGb3Iob3B0aW9ucywgbWV0aG9kKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBvcHRpb25zLnR5cGUgPSBtZXRob2Q7CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfSwKCiAgICAvKioKICAgICAqIEdldCB0aGUgZnVsbCAiaGVhZGVycyIgaGFzaCwgY29tYmluaW5nIHRoZSBzZXJ2aWNlLWRlZmluZWQgaGVhZGVycyB3aXRoCiAgICAgKiB0aGUgb25lcyBwcm92aWRlZCBmb3IgdGhlIHJlcXVlc3QKICAgICAqCiAgICAgKiBAbWV0aG9kIF9nZXRGdWxsSGVhZGVyc0hhc2gKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaGVhZGVycwogICAgICogQHJldHVybiB7T2JqZWN0fQogICAgICovCiAgICBfZ2V0RnVsbEhlYWRlcnNIYXNoKGhlYWRlcnMpIHsKICAgICAgY29uc3QgY2xhc3NIZWFkZXJzID0gRW1iZXIuZ2V0KHRoaXMsICdoZWFkZXJzJyk7CiAgICAgIGNvbnN0IF9oZWFkZXJzID0gRW1iZXIubWVyZ2Uoe30sIGNsYXNzSGVhZGVycyk7CiAgICAgIHJldHVybiBFbWJlci5tZXJnZShfaGVhZGVycywgaGVhZGVycyk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG1ldGhvZCBvcHRpb25zCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybAogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAqLwogICAgb3B0aW9ucyh1cmwsIG9wdGlvbnMgPSB7fSkgewogICAgICBvcHRpb25zID0gRW1iZXIubWVyZ2Uoe30sIG9wdGlvbnMpOwogICAgICBvcHRpb25zLnVybCA9IHRoaXMuX2J1aWxkVVJMKHVybCwgb3B0aW9ucyk7CiAgICAgIG9wdGlvbnMudHlwZSA9IG9wdGlvbnMudHlwZSB8fCAnR0VUJzsKICAgICAgb3B0aW9ucy5kYXRhVHlwZSA9IG9wdGlvbnMuZGF0YVR5cGUgfHwgJ2pzb24nOwogICAgICBvcHRpb25zLmNvbnRlbnRUeXBlID0gRW1iZXIuaXNFbXB0eShvcHRpb25zLmNvbnRlbnRUeXBlKSA/IEVtYmVyLmdldCh0aGlzLCAnY29udGVudFR5cGUnKSA6IG9wdGlvbnMuY29udGVudFR5cGU7CgogICAgICBpZiAodGhpcy5fc2hvdWxkU2VuZEhlYWRlcnMob3B0aW9ucykpIHsKICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSB0aGlzLl9nZXRGdWxsSGVhZGVyc0hhc2gob3B0aW9ucy5oZWFkZXJzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvcHRpb25zLmhlYWRlcnMgPSBvcHRpb25zLmhlYWRlcnMgfHwge307CiAgICAgIH0KCiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfSwKCiAgICAvKioKICAgICAqIEJ1aWxkIGEgVVJMIGZvciBhIHJlcXVlc3QKICAgICAqCiAgICAgKiBJZiB0aGUgcHJvdmlkZWQgYHVybGAgaXMgZGVlbWVkIHRvIGJlIGEgY29tcGxldGUgVVJMLCBpdCB3aWxsIGJlIHJldHVybmVkCiAgICAgKiBkaXJlY3RseS4gIElmIGl0IGlzIG5vdCBjb21wbGV0ZSwgdGhlbiB0aGUgc2VnbWVudCBwcm92aWRlZCB3aWxsIGJlIGNvbWJpbmVkCiAgICAgKiB3aXRoIHRoZSBgaG9zdGAgYW5kIGBuYW1lc3BhY2VgIG9wdGlvbnMgb2YgdGhlIHJlcXVlc3QgY2xhc3MgdG8gY3JlYXRlIHRoZQogICAgICogZnVsbCBVUkwuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgdGhlIHVybCwgb3IgdXJsIHNlZ21lbnQsIHRvIHJlcXVlc3QKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucz17fV0gdGhlIG9wdGlvbnMgZm9yIHRoZSByZXF1ZXN0IGJlaW5nIG1hZGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5ob3N0XSB0aGUgaG9zdCB0byB1c2UgZm9yIHRoaXMgcmVxdWVzdAogICAgICogQHJldHVybnMge3N0cmluZ30gdGhlIFVSTCB0byBtYWtlIGEgcmVxdWVzdCB0bwogICAgICovCiAgICBfYnVpbGRVUkwodXJsLCBvcHRpb25zID0ge30pIHsKICAgICAgaWYgKCgwLCBfdXJsSGVscGVycy5pc0Z1bGxVUkwpKHVybCkpIHsKICAgICAgICByZXR1cm4gdXJsOwogICAgICB9CgogICAgICBjb25zdCB1cmxQYXJ0cyA9IFtdOwoKICAgICAgbGV0IGhvc3QgPSBvcHRpb25zLmhvc3QgfHwgRW1iZXIuZ2V0KHRoaXMsICdob3N0Jyk7CiAgICAgIGlmIChob3N0KSB7CiAgICAgICAgaG9zdCA9IHN0cmlwU2xhc2hlcyhob3N0KTsKICAgICAgfQogICAgICB1cmxQYXJ0cy5wdXNoKGhvc3QpOwoKICAgICAgbGV0IG5hbWVzcGFjZSA9IG9wdGlvbnMubmFtZXNwYWNlIHx8IEVtYmVyLmdldCh0aGlzLCAnbmFtZXNwYWNlJyk7CiAgICAgIGlmIChuYW1lc3BhY2UpIHsKICAgICAgICBuYW1lc3BhY2UgPSBzdHJpcFNsYXNoZXMobmFtZXNwYWNlKTsKICAgICAgICB1cmxQYXJ0cy5wdXNoKG5hbWVzcGFjZSk7CiAgICAgIH0KCiAgICAgIC8vIElmIHRoZSBVUkwgaGFzIGFscmVhZHkgYmVlbiBjb25zdHJ1Y3RlZCAocHJlc3VtYWJseSwgYnkgRW1iZXIgRGF0YSksIHRoZW4gd2Ugc2hvdWxkIGp1c3QgbGVhdmUgaXQgYWxvbmUKICAgICAgY29uc3QgaGFzTmFtZXNwYWNlUmVnZXggPSBuZXcgUmVnRXhwKGBeKC8pPyR7bmFtZXNwYWNlfWApOwogICAgICBpZiAoaGFzTmFtZXNwYWNlUmVnZXgudGVzdCh1cmwpKSB7CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfQoKICAgICAgLy8gKk9ubHkqIHJlbW92ZSBhIGxlYWRpbmcgc2xhc2ggLS0gd2UgbmVlZCB0byBtYWludGFpbiBhIHRyYWlsaW5nIHNsYXNoIGZvcgogICAgICAvLyBBUElzIHRoYXQgZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIGl0IGJlaW5nIGFuZCBub3QgYmVpbmcgcHJlc2VudAogICAgICBpZiAoc3RhcnRzV2l0aFNsYXNoKHVybCkpIHsKICAgICAgICB1cmwgPSByZW1vdmVMZWFkaW5nU2xhc2godXJsKTsKICAgICAgfQogICAgICB1cmxQYXJ0cy5wdXNoKHVybCk7CgogICAgICByZXR1cm4gdXJsUGFydHMuam9pbignLycpOwogICAgfSwKCiAgICAvKioKICAgICAqIFRha2VzIGFuIGFqYXggcmVzcG9uc2UsIGFuZCByZXR1cm5zIHRoZSBqc29uIHBheWxvYWQgb3IgYW4gZXJyb3IuCiAgICAgKgogICAgICogQnkgZGVmYXVsdCB0aGlzIGhvb2sganVzdCByZXR1cm5zIHRoZSBqc29uIHBheWxvYWQgcGFzc2VkIHRvIGl0LgogICAgICogWW91IG1pZ2h0IHdhbnQgdG8gb3ZlcnJpZGUgaXQgaW4gdHdvIGNhc2VzOgogICAgICoKICAgICAqIDEuIFlvdXIgQVBJIG1pZ2h0IHJldHVybiB1c2VmdWwgcmVzdWx0cyBpbiB0aGUgcmVzcG9uc2UgaGVhZGVycy4KICAgICAqICAgIFJlc3BvbnNlIGhlYWRlcnMgYXJlIHBhc3NlZCBpbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICoKICAgICAqIDIuIFlvdXIgQVBJIG1pZ2h0IHJldHVybiBlcnJvcnMgYXMgc3VjY2Vzc2Z1bCByZXNwb25zZXMgd2l0aCBzdGF0dXMgY29kZQogICAgICogICAgMjAwIGFuZCBhbiBFcnJvcnMgdGV4dCBvciBvYmplY3QuCiAgICAgKgogICAgICogQG1ldGhvZCBoYW5kbGVSZXNwb25zZQogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IGhlYWRlcnMKICAgICAqIEBwYXJhbSAge09iamVjdH0gcGF5bG9hZAogICAgICogQHBhcmFtICB7T2JqZWN0fSByZXF1ZXN0RGF0YSB0aGUgb3JpZ2luYWwgcmVxdWVzdCBpbmZvcm1hdGlvbgogICAgICogQHJldHVybiB7T2JqZWN0IHwgQWpheEVycm9yfSByZXNwb25zZQogICAgICovCiAgICBoYW5kbGVSZXNwb25zZShzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKSB7CiAgICAgIGlmICh0aGlzLmlzU3VjY2VzcyhzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgIH0KCiAgICAgIC8vIEFsbG93IG92ZXJyaWRpbmcgb2YgZXJyb3IgcGF5bG9hZAogICAgICBwYXlsb2FkID0gdGhpcy5ub3JtYWxpemVFcnJvclJlc3BvbnNlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCk7CgogICAgICByZXR1cm4gdGhpcy5fY3JlYXRlQ29ycmVjdEVycm9yKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCwgcmVxdWVzdERhdGEpOwogICAgfSwKCiAgICBfY3JlYXRlQ29ycmVjdEVycm9yKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCwgcmVxdWVzdERhdGEpIHsKICAgICAgbGV0IGVycm9yOwoKICAgICAgaWYgKHRoaXMuaXNVbmF1dGhvcml6ZWRFcnJvcihzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgZXJyb3IgPSBuZXcgX2Vycm9ycy5VbmF1dGhvcml6ZWRFcnJvcihwYXlsb2FkKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRm9yYmlkZGVuRXJyb3Ioc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkKSkgewogICAgICAgIGVycm9yID0gbmV3IF9lcnJvcnMuRm9yYmlkZGVuRXJyb3IocGF5bG9hZCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ludmFsaWRFcnJvcihzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgZXJyb3IgPSBuZXcgX2Vycm9ycy5JbnZhbGlkRXJyb3IocGF5bG9hZCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0JhZFJlcXVlc3RFcnJvcihzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgZXJyb3IgPSBuZXcgX2Vycm9ycy5CYWRSZXF1ZXN0RXJyb3IocGF5bG9hZCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc05vdEZvdW5kRXJyb3Ioc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkKSkgewogICAgICAgIGVycm9yID0gbmV3IF9lcnJvcnMuTm90Rm91bmRFcnJvcihwYXlsb2FkKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzQWJvcnRFcnJvcihzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgZXJyb3IgPSBuZXcgX2Vycm9ycy5BYm9ydEVycm9yKHBheWxvYWQpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaXNDb25mbGljdEVycm9yKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkpIHsKICAgICAgICBlcnJvciA9IG5ldyBfZXJyb3JzLkNvbmZsaWN0RXJyb3IocGF5bG9hZCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1NlcnZlckVycm9yKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkpIHsKICAgICAgICBlcnJvciA9IG5ldyBfZXJyb3JzLlNlcnZlckVycm9yKHBheWxvYWQsIHN0YXR1cyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZGV0YWlsZWRNZXNzYWdlID0gdGhpcy5nZW5lcmF0ZURldGFpbGVkTWVzc2FnZShzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKTsKCiAgICAgICAgZXJyb3IgPSBuZXcgX2Vycm9ycy5BamF4RXJyb3IocGF5bG9hZCwgZGV0YWlsZWRNZXNzYWdlLCBzdGF0dXMpOwogICAgICB9CgogICAgICByZXR1cm4gZXJyb3I7CiAgICB9LAoKICAgIC8qKgogICAgICogTWF0Y2ggdGhlIGhvc3QgdG8gYSBwcm92aWRlZCBhcnJheSBvZiBzdHJpbmdzIG9yIHJlZ2V4ZXMgdGhhdCBjYW4gbWF0Y2ggdG8gYSBob3N0CiAgICAgKgogICAgICogQG1ldGhvZCBtYXRjaEhvc3RzCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhvc3QgdGhlIGhvc3QgeW91IGFyZSBzZW5kaW5nIHRvbwogICAgICogQHBhcmFtIHtSZWdFeHAgfCBzdHJpbmd9IG1hdGNoZXIgYSBzdHJpbmcgb3IgcmVnZXggdGhhdCB5b3UgY2FuIG1hdGNoIHRoZSBob3N0IHRvLgogICAgICogQHJldHVybnMge0Jvb2xlYW59IGlmIHRoZSBob3N0IHBhc3NlZCB0aGUgbWF0Y2hlcgogICAgICovCiAgICBfbWF0Y2hIb3N0cyhob3N0LCBtYXRjaGVyKSB7CiAgICAgIGlmIChtYXRjaGVyLmNvbnN0cnVjdG9yID09PSBSZWdFeHApIHsKICAgICAgICByZXR1cm4gbWF0Y2hlci50ZXN0KGhvc3QpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtYXRjaGVyID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBtYXRjaGVyID09PSBob3N0OwogICAgICB9IGVsc2UgewogICAgICAgIExvZ2dlci53YXJuKCd0cnVzdGVkSG9zdHMgb25seSBoYW5kbGVzIHN0cmluZ3Mgb3IgcmVnZXhlcy4nLCBtYXRjaGVyLCAnaXMgbmVpdGhlci4nKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmUgd2hldGhlciB0aGUgaGVhZGVycyBzaG91bGQgYmUgYWRkZWQgZm9yIHRoaXMgcmVxdWVzdAogICAgICoKICAgICAqIFRoaXMgaG9vayBpcyB1c2VkIHRvIGhlbHAgcHJldmVudCBzZW5kaW5nIGhlYWRlcnMgdG8gZXZlcnkgaG9zdCwgcmVnYXJkbGVzcwogICAgICogb2YgdGhlIGRlc3RpbmF0aW9uLCBzaW5jZSB0aGlzIGNvdWxkIGJlIGEgc2VjdXJpdHkgaXNzdWUgaWYgYXV0aGVudGljYXRpb24KICAgICAqIHRva2VucyBhcmUgYWNjaWRlbnRhbGx5IGxlYWtlZCB0byB0aGlyZCBwYXJ0aWVzLgogICAgICoKICAgICAqIFRvIGF2b2lkIHRoYXQgcHJvYmxlbSwgc3ViY2xhc3NlcyBzaG91bGQgdXRpbGl6ZSB0aGUgYGhlYWRlcnNgIGNvbXB1dGVkCiAgICAgKiBwcm9wZXJ0eSB0byBwcmV2ZW50IGF1dGhlbnRpY2F0aW9uIGZyb20gYmVpbmcgc2VudCB0byB0aGlyZCBwYXJ0aWVzLCBvcgogICAgICogaW1wbGVtZW50IHRoaXMgaG9vayBmb3IgbW9yZSBmaW5lLWdyYWluIGNvbnRyb2wgb3ZlciB3aGVuIGhlYWRlcnMgYXJlIHNlbnQuCiAgICAgKgogICAgICogQnkgZGVmYXVsdCwgdGhlIGhlYWRlcnMgYXJlIHNlbnQgaWYgdGhlIGhvc3Qgb2YgdGhlIHJlcXVlc3QgbWF0Y2hlcyB0aGUKICAgICAqIGBob3N0YCBwcm9wZXJ0eSBkZXNpZ25hdGVkIG9uIHRoZSBjbGFzcy4KICAgICAqCiAgICAgKiBAbWV0aG9kIF9zaG91bGRTZW5kSGVhZGVycwogICAgICogQHByaXZhdGUKICAgICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBoYXNoIHJlcXVlc3Qgb3B0aW9ucyBoYXNoCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBvciBub3QgaGVhZGVycyBzaG91bGQgYmUgc2VudAogICAgICovCiAgICBfc2hvdWxkU2VuZEhlYWRlcnMoeyB1cmwsIGhvc3QgfSkgewogICAgICB1cmwgPSB1cmwgfHwgJyc7CiAgICAgIGhvc3QgPSBob3N0IHx8IEVtYmVyLmdldCh0aGlzLCAnaG9zdCcpIHx8ICcnOwoKICAgICAgY29uc3QgdHJ1c3RlZEhvc3RzID0gRW1iZXIuZ2V0KHRoaXMsICd0cnVzdGVkSG9zdHMnKSB8fCBFbWJlci5BKCk7CiAgICAgIGNvbnN0IHsgaG9zdG5hbWUgfSA9ICgwLCBfdXJsSGVscGVycy5wYXJzZVVSTCkodXJsKTsKCiAgICAgIC8vIEFkZCBoZWFkZXJzIG9uIHJlbGF0aXZlIFVSTHMKICAgICAgaWYgKCEoMCwgX3VybEhlbHBlcnMuaXNGdWxsVVJMKSh1cmwpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAodHJ1c3RlZEhvc3RzLmZpbmQobWF0Y2hlciA9PiB0aGlzLl9tYXRjaEhvc3RzKGhvc3RuYW1lLCBtYXRjaGVyKSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gQWRkIGhlYWRlcnMgb24gbWF0Y2hpbmcgaG9zdAogICAgICByZXR1cm4gKDAsIF91cmxIZWxwZXJzLmhhdmVTYW1lSG9zdCkodXJsLCBob3N0KTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBHZW5lcmF0ZXMgYSBkZXRhaWxlZCAoImZyaWVuZGx5IikgZXJyb3IgbWVzc2FnZSwgd2l0aCBwbGVudHkKICAgICAqIG9mIGluZm9ybWF0aW9uIGZvciBkZWJ1Z2dpbmcgKGdvb2QgbHVjayEpCiAgICAgKgogICAgICogQG1ldGhvZCBnZW5lcmF0ZURldGFpbGVkTWVzc2FnZQogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IGhlYWRlcnMKICAgICAqIEBwYXJhbSAge09iamVjdH0gcGF5bG9hZAogICAgICogQHBhcmFtICB7T2JqZWN0fSByZXF1ZXN0RGF0YSB0aGUgb3JpZ2luYWwgcmVxdWVzdCBpbmZvcm1hdGlvbgogICAgICogQHJldHVybiB7T2JqZWN0fSByZXF1ZXN0IGluZm9ybWF0aW9uCiAgICAgKi8KICAgIGdlbmVyYXRlRGV0YWlsZWRNZXNzYWdlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCwgcmVxdWVzdERhdGEpIHsKICAgICAgbGV0IHNob3J0ZW5lZFBheWxvYWQ7CiAgICAgIGNvbnN0IHBheWxvYWRDb250ZW50VHlwZSA9ICgwLCBfZ2V0SGVhZGVyLmRlZmF1bHQpKGhlYWRlcnMsICdDb250ZW50LVR5cGUnKSB8fCAnRW1wdHkgQ29udGVudC1UeXBlJzsKCiAgICAgIGlmIChwYXlsb2FkQ29udGVudFR5cGUudG9Mb3dlckNhc2UoKSA9PT0gJ3RleHQvaHRtbCcgJiYgcGF5bG9hZC5sZW5ndGggPiAyNTApIHsKICAgICAgICBzaG9ydGVuZWRQYXlsb2FkID0gJ1tPbWl0dGVkIExlbmd0aHkgSFRNTF0nOwogICAgICB9IGVsc2UgewogICAgICAgIHNob3J0ZW5lZFBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTsKICAgICAgfQoKICAgICAgY29uc3QgcmVxdWVzdERlc2NyaXB0aW9uID0gYCR7cmVxdWVzdERhdGEudHlwZX0gJHtyZXF1ZXN0RGF0YS51cmx9YDsKICAgICAgY29uc3QgcGF5bG9hZERlc2NyaXB0aW9uID0gYFBheWxvYWQgKCR7cGF5bG9hZENvbnRlbnRUeXBlfSlgOwoKICAgICAgcmV0dXJuIFtgRW1iZXIgQUpBWCBSZXF1ZXN0ICR7cmVxdWVzdERlc2NyaXB0aW9ufSByZXR1cm5lZCBhICR7c3RhdHVzfWAsIHBheWxvYWREZXNjcmlwdGlvbiwgc2hvcnRlbmVkUGF5bG9hZF0uam9pbignXG4nKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICogcmVzcG9uc2UgaXMgYSBhbiBhdXRob3JpemVkIGVycm9yLgogICAgICoKICAgICAqIEBtZXRob2QgaXNVbmF1dGhvcml6ZWRFcnJvcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBzdGF0dXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBoZWFkZXJzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgaXNVbmF1dGhvcml6ZWRFcnJvcihzdGF0dXMpIHsKICAgICAgcmV0dXJuICgwLCBfZXJyb3JzLmlzVW5hdXRob3JpemVkRXJyb3IpKHN0YXR1cyk7CiAgICB9LAoKICAgIC8qKgogICAgICogRGVmYXVsdCBgaGFuZGxlUmVzcG9uc2VgIGltcGxlbWVudGF0aW9uIHVzZXMgdGhpcyBob29rIHRvIGRlY2lkZSBpZiB0aGUKICAgICAqIHJlc3BvbnNlIGlzIGEgZm9yYmlkZGVuIGVycm9yLgogICAgICoKICAgICAqIEBtZXRob2QgaXNGb3JiaWRkZW5FcnJvcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBzdGF0dXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBoZWFkZXJzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgaXNGb3JiaWRkZW5FcnJvcihzdGF0dXMpIHsKICAgICAgcmV0dXJuICgwLCBfZXJyb3JzLmlzRm9yYmlkZGVuRXJyb3IpKHN0YXR1cyk7CiAgICB9LAoKICAgIC8qKgogICAgICogRGVmYXVsdCBgaGFuZGxlUmVzcG9uc2VgIGltcGxlbWVudGF0aW9uIHVzZXMgdGhpcyBob29rIHRvIGRlY2lkZSBpZiB0aGUKICAgICAqIHJlc3BvbnNlIGlzIGEgYW4gaW52YWxpZCBlcnJvci4KICAgICAqCiAgICAgKiBAbWV0aG9kIGlzSW52YWxpZEVycm9yCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXR1cwogICAgICogQHBhcmFtIHtPYmplY3R9IGhlYWRlcnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICBpc0ludmFsaWRFcnJvcihzdGF0dXMpIHsKICAgICAgcmV0dXJuICgwLCBfZXJyb3JzLmlzSW52YWxpZEVycm9yKShzdGF0dXMpOwogICAgfSwKCiAgICAvKioKICAgICAqIERlZmF1bHQgYGhhbmRsZVJlc3BvbnNlYCBpbXBsZW1lbnRhdGlvbiB1c2VzIHRoaXMgaG9vayB0byBkZWNpZGUgaWYgdGhlCiAgICAgKiByZXNwb25zZSBpcyBhIGJhZCByZXF1ZXN0IGVycm9yLgogICAgICoKICAgICAqIEBtZXRob2QgaXNCYWRSZXF1ZXN0RXJyb3IKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gc3RhdHVzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaGVhZGVycwogICAgICogQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIGlzQmFkUmVxdWVzdEVycm9yKHN0YXR1cykgewogICAgICByZXR1cm4gKDAsIF9lcnJvcnMuaXNCYWRSZXF1ZXN0RXJyb3IpKHN0YXR1cyk7CiAgICB9LAoKICAgIC8qKgogICAgICogRGVmYXVsdCBgaGFuZGxlUmVzcG9uc2VgIGltcGxlbWVudGF0aW9uIHVzZXMgdGhpcyBob29rIHRvIGRlY2lkZSBpZiB0aGUKICAgICAqIHJlc3BvbnNlIGlzIGEgIm5vdCBmb3VuZCIgZXJyb3IuCiAgICAgKgogICAgICogQG1ldGhvZCBpc05vdEZvdW5kRXJyb3IKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gc3RhdHVzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaGVhZGVycwogICAgICogQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIGlzTm90Rm91bmRFcnJvcihzdGF0dXMpIHsKICAgICAgcmV0dXJuICgwLCBfZXJyb3JzLmlzTm90Rm91bmRFcnJvcikoc3RhdHVzKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICogcmVzcG9uc2UgaXMgYW4gImFib3J0IiBlcnJvci4KICAgICAqCiAgICAgKiBAbWV0aG9kIGlzQWJvcnRFcnJvcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBzdGF0dXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBoZWFkZXJzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgaXNBYm9ydEVycm9yKHN0YXR1cykgewogICAgICByZXR1cm4gKDAsIF9lcnJvcnMuaXNBYm9ydEVycm9yKShzdGF0dXMpOwogICAgfSwKCiAgICAvKioKICAgICAqIERlZmF1bHQgYGhhbmRsZVJlc3BvbnNlYCBpbXBsZW1lbnRhdGlvbiB1c2VzIHRoaXMgaG9vayB0byBkZWNpZGUgaWYgdGhlCiAgICAgKiByZXNwb25zZSBpcyBhICJjb25mbGljdCIgZXJyb3IuCiAgICAgKgogICAgICogQG1ldGhvZCBpc0NvbmZsaWN0RXJyb3IKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gc3RhdHVzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaGVhZGVycwogICAgICogQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIGlzQ29uZmxpY3RFcnJvcihzdGF0dXMpIHsKICAgICAgcmV0dXJuICgwLCBfZXJyb3JzLmlzQ29uZmxpY3RFcnJvcikoc3RhdHVzKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICogcmVzcG9uc2UgaXMgYSBzZXJ2ZXIgZXJyb3IuCiAgICAgKgogICAgICogQG1ldGhvZCBpc1NlcnZlckVycm9yCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXR1cwogICAgICogQHBhcmFtIHtPYmplY3R9IGhlYWRlcnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICBpc1NlcnZlckVycm9yKHN0YXR1cykgewogICAgICByZXR1cm4gKDAsIF9lcnJvcnMuaXNTZXJ2ZXJFcnJvcikoc3RhdHVzKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICogcmVzcG9uc2UgaXMgYSBzdWNjZXNzLgogICAgICoKICAgICAqIEBtZXRob2QgaXNTdWNjZXNzCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXR1cwogICAgICogQHBhcmFtIHtPYmplY3R9IGhlYWRlcnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICBpc1N1Y2Nlc3Moc3RhdHVzKSB7CiAgICAgIHJldHVybiAoMCwgX2Vycm9ycy5pc1N1Y2Nlc3MpKHN0YXR1cyk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG1ldGhvZCBwYXJzZUVycm9yUmVzcG9uc2UKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVzcG9uc2VUZXh0CiAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIHBhcnNlRXJyb3JSZXNwb25zZShyZXNwb25zZVRleHQpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXNwb25zZVRleHQpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlVGV4dDsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIENhbiBiZSBvdmVyd3JpdHRlbiB0byBhbGxvdyByZS1mb3JtYXR0aW5nIG9mIGVycm9yIG1lc3NhZ2VzCiAgICAgKgogICAgICogQG1ldGhvZCBub3JtYWxpemVFcnJvclJlc3BvbnNlCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtICB7TnVtYmVyfSBzdGF0dXMKICAgICAqIEBwYXJhbSAge09iamVjdH0gaGVhZGVycwogICAgICogQHBhcmFtICB7T2JqZWN0fSBwYXlsb2FkCiAgICAgKiBAcmV0dXJuIHsqfSBlcnJvciByZXNwb25zZQogICAgICovCiAgICBub3JtYWxpemVFcnJvclJlc3BvbnNlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICByZXR1cm4gcGF5bG9hZDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvbWl4aW5zL2FqYXgtc3VwcG9ydCcsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgKiBUaGUgQUpBWCBzZXJ2aWNlIHRvIHNlbmQgcmVxdWVzdHMgdGhyb3VnaAogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7QWpheFNlcnZpY2V9IGFqYXhTZXJ2aWNlCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIGFqYXhTZXJ2aWNlOiBFbWJlci5pbmplY3Quc2VydmljZSgnYWpheCcpLAoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGhvc3QKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgaG9zdDogRW1iZXIuY29tcHV0ZWQuYWxpYXMoJ2FqYXhTZXJ2aWNlLmhvc3QnKSwKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lc3BhY2UKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgbmFtZXNwYWNlOiBFbWJlci5jb21wdXRlZC5hbGlhcygnYWpheFNlcnZpY2UubmFtZXNwYWNlJyksCgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gaGVhZGVycwogICAgICogQHB1YmxpYwogICAgICovCiAgICBoZWFkZXJzOiBFbWJlci5jb21wdXRlZC5hbGlhcygnYWpheFNlcnZpY2UuaGVhZGVycycpLAoKICAgIGFqYXgodXJsKSB7CiAgICAgIGNvbnN0IGF1Z21lbnRlZE9wdGlvbnMgPSB0aGlzLmFqYXhPcHRpb25zKC4uLmFyZ3VtZW50cyk7CgogICAgICByZXR1cm4gdGhpcy5nZXQoJ2FqYXhTZXJ2aWNlJykucmVxdWVzdCh1cmwsIGF1Z21lbnRlZE9wdGlvbnMpOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItYWpheC9taXhpbnMvbGVnYWN5L25vcm1hbGl6ZS1lcnJvci1yZXNwb25zZScsIFsnZXhwb3J0cycsICdlbWJlci1hamF4Ly1wcml2YXRlL3V0aWxzL2lzLXN0cmluZyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2lzU3RyaW5nKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgZnVuY3Rpb24gaXNPYmplY3Qob2JqZWN0KSB7CiAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gJ29iamVjdCc7CiAgfQoKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5NaXhpbi5jcmVhdGUoewogICAgLyoqCiAgICAgKiBOb3JtYWxpemUgdGhlIGVycm9yIGZyb20gdGhlIHNlcnZlciBpbnRvIHRoZSBzYW1lIGZvcm1hdAogICAgICoKICAgICAqIFRoZSBmb3JtYXQgd2Ugbm9ybWFsaXplIHRvIGlzIGJhc2VkIG9uIHRoZSBKU09OIEFQSSBzcGVjaWZpY2F0aW9uLiAgVGhlCiAgICAgKiByZXR1cm4gdmFsdWUgc2hvdWxkIGJlIGFuIGFycmF5IG9mIG9iamVjdHMgdGhhdCBtYXRjaCB0aGUgZm9ybWF0IHRoZXkKICAgICAqIGRlc2NyaWJlLiBNb3JlIGRldGFpbHMgYWJvdXQgdGhlIG9iamVjdCBmb3JtYXQgY2FuIGJlIGZvdW5kCiAgICAgKiBbaGVyZV0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZXJyb3Itb2JqZWN0cykKICAgICAqCiAgICAgKiBUaGUgYmFzaWNzIG9mIHRoZSBmb3JtYXQgYXJlIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogYGBgamF2YXNjcmlwdAogICAgICogWwogICAgICogICB7CiAgICAgKiAgICAgc3RhdHVzOiAnVGhlIHN0YXR1cyBjb2RlIGZvciB0aGUgZXJyb3InLAogICAgICogICAgIHRpdGxlOiAnVGhlIGh1bWFuLXJlYWRhYmxlIHRpdGxlIG9mIHRoZSBlcnJvcicKICAgICAqICAgICBkZXRhaWw6ICdUaGUgaHVtYW4tcmVhZGFibGUgZGV0YWlscyBvZiB0aGUgZXJyb3InCiAgICAgKiAgIH0KICAgICAqIF0KICAgICAqIGBgYAogICAgICoKICAgICAqIEluIGNhc2VzIHdoZXJlIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhcnJheSwgdGhlbiB0aGVyZSBzaG91bGQgYmUgb25lIGl0ZW0KICAgICAqIGluIHRoZSBhcnJheSBmb3IgZWFjaCBvZiB0aGUgcGF5bG9hZC4gIElmIHlvdXIgc2VydmVyIHJldHVybnMgYSBKU09OIEFQSQogICAgICogZm9ybWF0dGVkIHBheWxvYWQgYWxyZWFkeSwgaXQgd2lsbCBqdXN0IGJlIHJldHVybmVkIGRpcmVjdGx5LgogICAgICoKICAgICAqIElmIHlvdXIgc2VydmVyIHJldHVybnMgc29tZXRoaW5nIG90aGVyIHRoYW4gYSBKU09OIEFQSSBmb3JtYXQsIGl0J3MKICAgICAqIHN1Z2dlc3RlZCB0aGF0IHlvdSBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBjb252ZXJ0IHlvdXIgb3duIGVycm9ycyBpbnRvIHRoZQogICAgICogb25lIGRlc2NyaWJlZCBhYm92ZS4KICAgICAqCiAgICAgKiBAbWV0aG9kIG5vcm1hbGl6ZUVycm9yUmVzcG9uc2UKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0gIHtOdW1iZXJ9IHN0YXR1cwogICAgICogQHBhcmFtICB7T2JqZWN0fSBoZWFkZXJzCiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IHBheWxvYWQKICAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBKU09OIEFQSS1mb3JtYXR0ZWQgZXJyb3Igb2JqZWN0cwogICAgICovCiAgICBub3JtYWxpemVFcnJvclJlc3BvbnNlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICBwYXlsb2FkID0gRW1iZXIuaXNOb25lKHBheWxvYWQpID8ge30gOiBwYXlsb2FkOwoKICAgICAgaWYgKEVtYmVyLmlzQXJyYXkocGF5bG9hZC5lcnJvcnMpKSB7CiAgICAgICAgcmV0dXJuIHBheWxvYWQuZXJyb3JzLm1hcChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGlmIChpc09iamVjdChlcnJvcikpIHsKICAgICAgICAgICAgY29uc3QgcmV0ID0gRW1iZXIubWVyZ2Uoe30sIGVycm9yKTsKICAgICAgICAgICAgcmV0LnN0YXR1cyA9IGAke2Vycm9yLnN0YXR1c31gOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBzdGF0dXM6IGAke3N0YXR1c31gLAogICAgICAgICAgICAgIHRpdGxlOiBlcnJvcgogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKEVtYmVyLmlzQXJyYXkocGF5bG9hZCkpIHsKICAgICAgICByZXR1cm4gcGF5bG9hZC5tYXAoZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBpZiAoaXNPYmplY3QoZXJyb3IpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhdHVzOiBgJHtzdGF0dXN9YCwKICAgICAgICAgICAgICB0aXRsZTogZXJyb3IudGl0bGUgfHwgJ1RoZSBiYWNrZW5kIHJlc3BvbmRlZCB3aXRoIGFuIGVycm9yJywKICAgICAgICAgICAgICBkZXRhaWw6IGVycm9yCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHN0YXR1czogYCR7c3RhdHVzfWAsCiAgICAgICAgICAgICAgdGl0bGU6IGAke2Vycm9yfWAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICgoMCwgX2lzU3RyaW5nLmRlZmF1bHQpKHBheWxvYWQpKSB7CiAgICAgICAgcmV0dXJuIFt7CiAgICAgICAgICBzdGF0dXM6IGAke3N0YXR1c31gLAogICAgICAgICAgdGl0bGU6IHBheWxvYWQKICAgICAgICB9XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gW3sKICAgICAgICAgIHN0YXR1czogYCR7c3RhdHVzfWAsCiAgICAgICAgICB0aXRsZTogcGF5bG9hZC50aXRsZSB8fCAnVGhlIGJhY2tlbmQgcmVzcG9uZGVkIHdpdGggYW4gZXJyb3InLAogICAgICAgICAgZGV0YWlsOiBwYXlsb2FkCiAgICAgICAgfV07CiAgICAgIH0KICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvcmF3JywgWydleHBvcnRzJywgJ2VtYmVyLWFqYXgvYWpheC1yZXF1ZXN0J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfYWpheFJlcXVlc3QpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gcmF3OwoKCiAgLyoqCiAgICogU2FtZSBhcyBgcmVxdWVzdGAgZXhjZXB0IGl0IHJlc29sdmVzIGFuIG9iamVjdCB3aXRoCiAgICoKICAgKiAgIHtyZXNwb25zZSwgdGV4dFN0YXR1cywganFYSFJ9CiAgICoKICAgKiBVc2VmdWwgaWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBqcVhIUiBvYmplY3QgZm9yIGhlYWRlcnMsIGV0Yy4KICAgKgogICAqIEBwdWJsaWMKICAgKi8KICBmdW5jdGlvbiByYXcoKSB7CiAgICBjb25zdCBhamF4ID0gbmV3IF9hamF4UmVxdWVzdC5kZWZhdWx0KCk7CiAgICByZXR1cm4gYWpheC5yYXcoLi4uYXJndW1lbnRzKTsKICB9Cn0pOwo7ZGVmaW5lKCdlbWJlci1hamF4L3JlcXVlc3QnLCBbJ2V4cG9ydHMnLCAnZW1iZXItYWpheC9hamF4LXJlcXVlc3QnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9hamF4UmVxdWVzdCkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSByZXF1ZXN0OwoKCiAgLyoqCiAgICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHlvdSB0byB1c2UgdGhlIGRlZmF1bHQgYGVtYmVyLWFqYXhgIHRvIG1ha2UKICAgKiByZXF1ZXN0cyB3aXRob3V0IHVzaW5nIHRoZSBzZXJ2aWNlLgogICAqCiAgICogTm90ZTogVW5saWtlIGBpYy1hamF4YCdzIGByZXF1ZXN0YCBoZWxwZXIgZnVuY3Rpb24sIHRoaXMgd2lsbCAqbm90KiByZXR1cm4gYQogICAqIGpxWEhSIG9iamVjdCBpbiB0aGUgZXJyb3IgaGFuZGxlci4gIElmIHlvdSBuZWVkIGpxWEhSLCB5b3UgY2FuIHVzZSB0aGUgYHJhd2AKICAgKiBmdW5jdGlvbiBpbnN0ZWFkLgogICAqCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIHJlcXVlc3QoKSB7CiAgICBjb25zdCBhamF4ID0gbmV3IF9hamF4UmVxdWVzdC5kZWZhdWx0KCk7CiAgICByZXR1cm4gYWpheC5yZXF1ZXN0KC4uLmFyZ3VtZW50cyk7CiAgfQp9KTsKO2RlZmluZSgnZW1iZXItYWpheC9zZXJ2aWNlcy9hamF4JywgWydleHBvcnRzJywgJ2VtYmVyLWFqYXgvbWl4aW5zL2FqYXgtcmVxdWVzdCddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2FqYXhSZXF1ZXN0KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyLlNlcnZpY2UuZXh0ZW5kKF9hamF4UmVxdWVzdC5kZWZhdWx0KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWFqYXgvdXRpbHMvYWpheCcsIFsnZXhwb3J0cycsICdlbWJlci1hamF4Ly1wcml2YXRlL3V0aWxzL2lzLWZhc3Rib290J10sIGZ1bmN0aW9uIChleHBvcnRzLCBfaXNGYXN0Ym9vdCkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBfaXNGYXN0Ym9vdC5kZWZhdWx0ID8gbmFqYXggOiBFbWJlci4kLmFqYXg7Cn0pOwo7ZGVmaW5lKCdlbWJlci1jbGktYXBwLXZlcnNpb24vaW5pdGlhbGl6ZXItZmFjdG9yeScsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBpbml0aWFsaXplckZhY3Rvcnk7CgoKICBjb25zdCB7CiAgICBsaWJyYXJpZXMKICB9ID0gRW1iZXI7CgogIGZ1bmN0aW9uIGluaXRpYWxpemVyRmFjdG9yeShuYW1lLCB2ZXJzaW9uKSB7CiAgICBsZXQgcmVnaXN0ZXJlZCA9IGZhbHNlOwoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghcmVnaXN0ZXJlZCAmJiBuYW1lICYmIHZlcnNpb24pIHsKICAgICAgICBsZXQgYXBwTmFtZSA9IEVtYmVyLlN0cmluZy5jbGFzc2lmeShuYW1lKTsKICAgICAgICBsaWJyYXJpZXMucmVnaXN0ZXIoYXBwTmFtZSwgdmVyc2lvbik7CiAgICAgICAgcmVnaXN0ZXJlZCA9IHRydWU7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKO2RlZmluZSgiZW1iZXItY2xpLWFwcC12ZXJzaW9uL3V0aWxzL3JlZ2V4cCIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb25zdCB2ZXJzaW9uUmVnRXhwID0gZXhwb3J0cy52ZXJzaW9uUmVnRXhwID0gL1xkK1suXVxkK1suXVxkKy87IC8vIE1hdGNoIGFueSBudW1iZXIgb2YgMyBzZWN0aW9ucyBvZiBkaWdpdHMgc2VwYXJhdGVkIGJ5IC4KICBjb25zdCB2ZXJzaW9uRXh0ZW5kZWRSZWdFeHAgPSBleHBvcnRzLnZlcnNpb25FeHRlbmRlZFJlZ0V4cCA9IC9cZCtbLl1cZCtbLl1cZCstW2Etel0qKFsuXVxkKyk/LzsgLy8gTWF0Y2ggdGhlIGFib3ZlIGJ1dCBhbHNvIGh5cGhlbiBmb2xsb3dlZCBieSBhbnkgbnVtYmVyIG9mIGxvd2VyY2FzZSBsZXR0ZXJzLCB0aGVuIG9wdGlvbmFsbHkgcGVyaW9kIGFuZCBkaWdpdHMKICBjb25zdCBzaGFSZWdFeHAgPSBleHBvcnRzLnNoYVJlZ0V4cCA9IC9bYS16XGRdezh9JC87IC8vIE1hdGNoIDggbG93ZXJjYXNlIGxldHRlcnMgYW5kIGRpZ2l0cywgYXQgdGhlIGVuZCBvZiB0aGUgc3RyaW5nIG9ubHkgKHRvIGF2b2lkIG1hdGNoaW5nIHdpdGggdmVyc2lvbiBleHRlbmRlZCBwYXJ0KQp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS8tZGVidWcvaW5kZXgnLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5pbnN0cnVtZW50ID0gaW5zdHJ1bWVudDsKICBmdW5jdGlvbiBpbnN0cnVtZW50KG1ldGhvZCkgewogICAgcmV0dXJuIG1ldGhvZCgpOwogIH0KCiAgLyoKICAgIEFzc2VydCB0aGF0IGBhZGRlZFJlY29yZGAgaGFzIGEgdmFsaWQgdHlwZSBzbyBpdCBjYW4gYmUgYWRkZWQgdG8gdGhlCiAgICByZWxhdGlvbnNoaXAgb2YgdGhlIGByZWNvcmRgLgogIAogICAgVGhlIGFzc2VydCBiYXNpY2FsbHkgY2hlY2tzIGlmIHRoZSBgYWRkZWRSZWNvcmRgIGNhbiBiZSBhZGRlZCB0byB0aGUKICAgIHJlbGF0aW9uc2hpcCAoc3BlY2lmaWVkIHZpYSBgcmVsYXRpb25zaGlwTWV0YWApIG9mIHRoZSBgcmVjb3JkYC4KICAKICAgIFRoaXMgdXRpbGl0eSBzaG91bGQgb25seSBiZSB1c2VkIGludGVybmFsbHksIGFzIGJvdGggcmVjb3JkIHBhcmFtZXRlcnMgbXVzdAogICAgYmUgYW4gSW50ZXJuYWxNb2RlbCBhbmQgdGhlIGByZWxhdGlvbnNoaXBNZXRhYCBuZWVkcyB0byBiZSB0aGUgbWV0YQogICAgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlbGF0aW9uc2hpcCwgcmV0cmlldmVkIHZpYQogICAgYHJlY29yZC5yZWxhdGlvbnNoaXBGb3Ioa2V5KWAuCiAgCiAgICBAbWV0aG9kIGFzc2VydFBvbHltb3JwaGljVHlwZQogICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICBAcGFyYW0ge1JlbGF0aW9uc2hpcE1ldGF9IHJlbGF0aW9uc2hpcE1ldGEgcmV0cmlldmVkIHZpYQogICAgICAgICAgIGByZWNvcmQucmVsYXRpb25zaGlwRm9yKGtleSlgCiAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGFkZGVkUmVjb3JkIHJlY29yZCB3aGljaAogICAgICAgICAgIHNob3VsZCBiZSBhZGRlZC9zZXQgZm9yIHRoZSByZWxhdGlvbnNoaXAKICAqLwogIHZhciBhc3NlcnRQb2x5bW9ycGhpY1R5cGUgPSB2b2lkIDA7CgogIGlmICh0cnVlKSB7CiAgICB2YXIgY2hlY2tQb2x5bW9ycGhpYyA9IGZ1bmN0aW9uIGNoZWNrUG9seW1vcnBoaWMobW9kZWxDbGFzcywgYWRkZWRNb2RlbENsYXNzKSB7CiAgICAgIGlmIChtb2RlbENsYXNzLl9faXNNaXhpbikgewogICAgICAgIC8vVE9ETyBOZWVkIHRvIGRvIHRoaXMgaW4gb3JkZXIgdG8gc3VwcG9ydCBtaXhpbnMsIHNob3VsZCBjb252ZXJ0IHRvIHB1YmxpYyBhcGkKICAgICAgICAvL29uY2UgaXQgZXhpc3RzIGluIEVtYmVyCiAgICAgICAgcmV0dXJuIG1vZGVsQ2xhc3MuX19taXhpbi5kZXRlY3QoYWRkZWRNb2RlbENsYXNzLlByb3RvdHlwZU1peGluKTsKICAgICAgfQogICAgICBpZiAoRW1iZXIuTU9ERUxfRkFDVE9SWV9JTkpFQ1RJT05TKSB7CiAgICAgICAgbW9kZWxDbGFzcyA9IG1vZGVsQ2xhc3Muc3VwZXJjbGFzczsKICAgICAgfQogICAgICByZXR1cm4gbW9kZWxDbGFzcy5kZXRlY3QoYWRkZWRNb2RlbENsYXNzKTsKICAgIH07CgogICAgZXhwb3J0cy5hc3NlcnRQb2x5bW9ycGhpY1R5cGUgPSBhc3NlcnRQb2x5bW9ycGhpY1R5cGUgPSBmdW5jdGlvbiBhc3NlcnRQb2x5bW9ycGhpY1R5cGUocGFyZW50SW50ZXJuYWxNb2RlbCwgcmVsYXRpb25zaGlwTWV0YSwgYWRkZWRJbnRlcm5hbE1vZGVsKSB7CiAgICAgIHZhciBhZGRlZE1vZGVsTmFtZSA9IGFkZGVkSW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICAgIHZhciBwYXJlbnRNb2RlbE5hbWUgPSBwYXJlbnRJbnRlcm5hbE1vZGVsLm1vZGVsTmFtZTsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcE1ldGEua2V5OwogICAgICB2YXIgcmVsYXRpb25zaGlwTW9kZWxOYW1lID0gcmVsYXRpb25zaGlwTWV0YS50eXBlOwogICAgICB2YXIgcmVsYXRpb25zaGlwQ2xhc3MgPSBwYXJlbnRJbnRlcm5hbE1vZGVsLnN0b3JlLm1vZGVsRm9yKHJlbGF0aW9uc2hpcE1vZGVsTmFtZSk7CiAgICAgIHZhciBhc3NlcnRpb25NZXNzYWdlID0gYFlvdSBjYW5ub3QgYWRkIGEgcmVjb3JkIG9mIG1vZGVsQ2xhc3MgJyR7YWRkZWRNb2RlbE5hbWV9JyB0byB0aGUgJyR7cGFyZW50TW9kZWxOYW1lfS4ke2tleX0nIHJlbGF0aW9uc2hpcCAob25seSAnJHtyZWxhdGlvbnNoaXBNb2RlbE5hbWV9JyBhbGxvd2VkKWA7CgogICAgICAodHJ1ZSAmJiAhKGNoZWNrUG9seW1vcnBoaWMocmVsYXRpb25zaGlwQ2xhc3MsIGFkZGVkSW50ZXJuYWxNb2RlbC5tb2RlbENsYXNzKSkgJiYgRW1iZXIuYXNzZXJ0KGFzc2VydGlvbk1lc3NhZ2UsIGNoZWNrUG9seW1vcnBoaWMocmVsYXRpb25zaGlwQ2xhc3MsIGFkZGVkSW50ZXJuYWxNb2RlbC5tb2RlbENsYXNzKSkpOwogICAgfTsKICB9CgogIGV4cG9ydHMuYXNzZXJ0UG9seW1vcnBoaWNUeXBlID0gYXNzZXJ0UG9seW1vcnBoaWNUeXBlOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS8tcHJpdmF0ZScsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3InLCAnZW1iZXItZGF0YS8tZGVidWcnLCAnQGVtYmVyL29yZGVyZWQtc2V0JywgJ2VtYmVyLWRhdGEvdmVyc2lvbiddLCBmdW5jdGlvbiAoZXhwb3J0cywgZW1iZXJJbmZsZWN0b3IsIGVtYmVyRGF0YV9EZWJ1ZywgRW1iZXJPcmRlcmVkU2V0LCBWRVJTSU9OKSB7ICd1c2Ugc3RyaWN0JzsKCkVtYmVyT3JkZXJlZFNldCA9ICdkZWZhdWx0JyBpbiBFbWJlck9yZGVyZWRTZXQgPyBFbWJlck9yZGVyZWRTZXRbJ2RlZmF1bHQnXSA6IEVtYmVyT3JkZXJlZFNldDsKVkVSU0lPTiA9ICdkZWZhdWx0JyBpbiBWRVJTSU9OID8gVkVSU0lPTlsnZGVmYXVsdCddIDogVkVSU0lPTjsKCi8qCiAgIyMgV2h5IGRvZXMgdGhpcyBleGlzdD8hPwoKICBgRW1iZXIuTWFwYCB3YXMgYSBwcml2YXRlIEFQSSBwcm92aWRlZCBieSBFbWJlciAoZm9yIHF1aXRlIHNvbWUgdGltZSkuCiAgVW5mb3J0dW5hdGVseSwgZW1iZXItZGF0YSBtYWRlIGBFbWJlci5NYXBgIHBhcnQgb2YgaXRzIHB1YmxpYyBBUEkgc3VyZmFjZSB2aWEKICBkb2N1bWVudGF0aW9uIGJsb2Nrcy4KCiAgYEVtYmVyLk1hcGAgd2lsbCBiZSBkZXByZWNhdGVkIGFuZCByZW1vdmVkIGZyb20gRW1iZXIgInNvb24iCiAgKGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL3JmY3MvcHVsbC8yMzcpIGFuZCB3ZSB3b3VsZCBsaWtlIHRvIGNvbmZpcm0gdGhhdAogIEVtYmVyIERhdGEgd2lsbCB3b3JrIHdpdGhvdXQgZGVwcmVjYXRpb24gYmVmb3JlIGFuZCBhZnRlciB0aGF0IGhhcHBlbnMuCgogIGBFbWJlci5NYXBgIGRpZmZlcnMgZnJvbSBuYXRpdmUgYE1hcGAgaW4gYSBmZXcgd2F5czoKCiAgKiBgRW1iZXIuTWFwYCBoYXMgY3VzdG9tIGBjb3B5YCBhbmQgYGlzRW1wdHlgIG1ldGhvZHMgd2hpY2ggYXJlIG5vdCBwcmVzZW50IGluIG5hdGl2ZSBgTWFwYAogICogYEVtYmVyLk1hcGAgYWRkcyBhIHN0YXRpYyBgY3JlYXRlYCBtZXRob2QgKHdoaWNoIHNpbXBseSBpbnN0YW50aWF0ZXMgaXRzZWxmIHdpdGggYG5ldyBFbWJlci5NYXAoKWApCiAgKiBgRW1iZXIuTWFwYCBkb2VzIG5vdCBhY2NlcHQgY29uc3RydWN0b3IgYXJndW1lbnRzCiAgKiBgRW1iZXIuTWFwYCBkb2VzIG5vdCBoYXZlOgogICAgKiBgQEBzcGVjaWVzYAogICAgKiBgQEBpdGVyYXRvcmAKICAgICogYGVudHJpZXNgCiAgICAqIGB2YWx1ZXNgCgogIFRoaXMgaW1wbGVtZW50YXRpb24gYWRkcyBhIGRlcHJlY2F0ZWQgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yOgoKICAqIGBjb3B5YAogICogYGlzRW1wdHlgCgogICMjIFdoeSBpcyB0aGlzIHdyaXR0ZW4gdGhpcyB3YXk/IT8KCiAgVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSBgTWFwYCByZXF1aXJlcyBpbnN0YW50aWF0aW9uIHdpdGggYG5ld2AgYW5kIGJ5IGRlZmF1bHQKICBCYWJlbCB0cmFuc3BpbGF0aW9uIHdpbGwgZG8gYHN1cGVyQ29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKWAgd2hpY2gKICB0aHJvd3MgYW4gZXJyb3Igd2l0aCBuYXRpdmUgYE1hcGAuCgogIFRoZSBkZXNpcmVkIGNvZGUgKGlmIHdlIGxpdmVkIGluIGFuICJvbmx5IG5hdGl2ZSBjbGFzcyIgd29ybGQpIHdvdWxkIGJlOgoKICBgYGBqcwogIGV4cG9ydCBkZWZhdWx0IGNsYXNzIE1hcFdpdGhEZXByZWNhdGlvbnMgZXh0ZW5kcyBNYXAgewogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmRlZmF1bHRWYWx1ZSA9IG9wdGlvbnMuZGVmYXVsdFZhbHVlOwogICAgfQoKICAgIGdldChrZXkpIHsKICAgICAgbGV0IGhhc1ZhbHVlID0gdGhpcy5oYXMoa2V5KTsKCiAgICAgIGlmIChoYXNWYWx1ZSkgewogICAgICAgIHJldHVybiBzdXBlci5nZXQoa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gdGhpcy5kZWZhdWx0VmFsdWUoa2V5KTsKICAgICAgICB0aGlzLnNldChrZXksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgfQogIH0KICBgYGAKKi8KY2xhc3MgTWFwV2l0aERlcHJlY2F0aW9ucyB7CiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgdGhpcy5fbWFwID0gbmV3IE1hcCgpOwogIH0KCiAgY29weSgpIHsKICAgICh0cnVlICYmICEoZmFsc2UpICYmIEVtYmVyLmRlcHJlY2F0ZSgnQ2FsbGluZyBgLmNvcHkoKWAgb24gYSBtYXAgZ2VuZXJhdGVkIGJ5IGVtYmVyLWRhdGEgaXMgZGVwcmVjYXRlZCwgcGxlYXNlIG1pZ3JhdGUgdG8gdXNpbmcgbmF0aXZlIE1hcCBmdW5jdGlvbmFsaXR5IG9ubHkuJywgZmFsc2UsIHsgaWQ6ICdlbWJlci1kYXRhLm1hcC5jb3B5JywgdW50aWw6ICczLjUuMCcgfSkpOwoKICAgIC8vIGNhbid0IGp1c3QgcGFzcyBgdGhpcy5fbWFwYCBoZXJlIGJlY2F1c2UgSUUxMSBkb2Vzbid0IGFjY2VwdAogICAgLy8gY29uc3RydWN0b3IgYXJncyB3aXRoIGl0cyBgTWFwYAoKICAgIHZhciBuZXdNYXAgPSBuZXcgTWFwV2l0aERlcHJlY2F0aW9ucygpOwogICAgdGhpcy5fbWFwLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgbmV3TWFwLnNldChrZXksIHZhbHVlKTsKICAgIH0pOwoKICAgIHJldHVybiBuZXdNYXA7CiAgfQoKICBpc0VtcHR5KCkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgRW1iZXIuZGVwcmVjYXRlKCdDYWxsaW5nIGAuaXNFbXB0eSgpYCBvbiBhIG1hcCBnZW5lcmF0ZWQgYnkgZW1iZXItZGF0YSBpcyBkZXByZWNhdGVkLCBwbGVhc2UgbWlncmF0ZSB0byB1c2luZyBuYXRpdmUgTWFwIGZ1bmN0aW9uYWxpdHkgb25seS4nLCBmYWxzZSwgeyBpZDogJ2VtYmVyLWRhdGEubWFwLmlzRW1wdHknLCB1bnRpbDogJzMuNS4wJyB9KSk7CgoKICAgIHJldHVybiB0aGlzLnNpemUgPT09IDA7CiAgfQoKICAvLyBwcm94eSBhbGwgbm9ybWFsIE1hcCBtZXRob2RzIHRvIHRoZSB1bmRlcmx5aW5nIE1hcAogIGdldCBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5zaXplOwogIH0KICBjbGVhcigpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuY2xlYXIoLi4uYXJndW1lbnRzKTsKICB9CiAgZGVsZXRlKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5kZWxldGUoLi4uYXJndW1lbnRzKTsKICB9CiAgZW50cmllcygpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuZW50cmllcyguLi5hcmd1bWVudHMpOwogIH0KICBmb3JFYWNoKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5mb3JFYWNoKC4uLmFyZ3VtZW50cyk7CiAgfQogIGdldCgpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuZ2V0KC4uLmFyZ3VtZW50cyk7CiAgfQogIGhhcygpIHsKICAgIHJldHVybiB0aGlzLl9tYXAuaGFzKC4uLmFyZ3VtZW50cyk7CiAgfQogIGtleXMoKSB7CiAgICByZXR1cm4gdGhpcy5fbWFwLmtleXMoLi4uYXJndW1lbnRzKTsKICB9CiAgc2V0KCkgewogICAgcmV0dXJuIHRoaXMuX21hcC5zZXQoLi4uYXJndW1lbnRzKTsKICB9CiAgdmFsdWVzKCkgewogICAgcmV0dXJuIHRoaXMuX21hcC52YWx1ZXMoLi4uYXJndW1lbnRzKTsKICB9Cn0KCi8qKgogIEEgYFByb21pc2VBcnJheWAgaXMgYW4gb2JqZWN0IHRoYXQgYWN0cyBsaWtlIGJvdGggYW4gYEVtYmVyLkFycmF5YAogIGFuZCBhIHByb21pc2UuIFdoZW4gdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgdGhlIHJlc3VsdGluZyB2YWx1ZQogIHdpbGwgYmUgc2V0IHRvIHRoZSBgUHJvbWlzZUFycmF5YCdzIGBjb250ZW50YCBwcm9wZXJ0eS4gVGhpcyBtYWtlcwogIGl0IGVhc3kgdG8gY3JlYXRlIGRhdGEgYmluZGluZ3Mgd2l0aCB0aGUgYFByb21pc2VBcnJheWAgdGhhdCB3aWxsIGJlCiAgdXBkYXRlZCB3aGVuIHRoZSBwcm9taXNlIHJlc29sdmVzLgoKICBGb3IgbW9yZSBpbmZvcm1hdGlvbiBzZWUgdGhlIFtFbWJlci5Qcm9taXNlUHJveHlNaXhpbgogIGRvY3VtZW50YXRpb25dKC9hcGkvY2xhc3Nlcy9FbWJlci5Qcm9taXNlUHJveHlNaXhpbi5odG1sKS4KCiAgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgbGV0IHByb21pc2VBcnJheSA9IERTLlByb21pc2VBcnJheS5jcmVhdGUoewogICAgcHJvbWlzZTogJC5nZXRKU09OKCcvc29tZS9yZW1vdGUvZGF0YS5qc29uJykKICB9KTsKCiAgcHJvbWlzZUFycmF5LmdldCgnbGVuZ3RoJyk7IC8vIDAKCiAgcHJvbWlzZUFycmF5LnRoZW4oZnVuY3Rpb24oKSB7CiAgICBwcm9taXNlQXJyYXkuZ2V0KCdsZW5ndGgnKTsgLy8gMTAwCiAgfSk7CiAgYGBgCgogIEBjbGFzcyBQcm9taXNlQXJyYXkKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRW1iZXIuQXJyYXlQcm94eQogIEB1c2VzIEVtYmVyLlByb21pc2VQcm94eU1peGluCiovCnZhciBQcm9taXNlQXJyYXkgPSBFbWJlci5BcnJheVByb3h5LmV4dGVuZChFbWJlci5Qcm9taXNlUHJveHlNaXhpbiwgewogIG1ldGE6IEVtYmVyLmNvbXB1dGVkLnJlYWRzKCdjb250ZW50Lm1ldGEnKQp9KTsKCi8qKgogIEEgYFByb21pc2VPYmplY3RgIGlzIGFuIG9iamVjdCB0aGF0IGFjdHMgbGlrZSBib3RoIGFuIGBFbWJlci5PYmplY3RgCiAgYW5kIGEgcHJvbWlzZS4gV2hlbiB0aGUgcHJvbWlzZSBpcyByZXNvbHZlZCwgdGhlbiB0aGUgcmVzdWx0aW5nIHZhbHVlCiAgd2lsbCBiZSBzZXQgdG8gdGhlIGBQcm9taXNlT2JqZWN0YCdzIGBjb250ZW50YCBwcm9wZXJ0eS4gVGhpcyBtYWtlcwogIGl0IGVhc3kgdG8gY3JlYXRlIGRhdGEgYmluZGluZ3Mgd2l0aCB0aGUgYFByb21pc2VPYmplY3RgIHRoYXQgd2lsbAogIGJlIHVwZGF0ZWQgd2hlbiB0aGUgcHJvbWlzZSByZXNvbHZlcy4KCiAgRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIHRoZSBbRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4KICBkb2N1bWVudGF0aW9uXSgvYXBpL2NsYXNzZXMvRW1iZXIuUHJvbWlzZVByb3h5TWl4aW4uaHRtbCkuCgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIGxldCBwcm9taXNlT2JqZWN0ID0gRFMuUHJvbWlzZU9iamVjdC5jcmVhdGUoewogICAgcHJvbWlzZTogJC5nZXRKU09OKCcvc29tZS9yZW1vdGUvZGF0YS5qc29uJykKICB9KTsKCiAgcHJvbWlzZU9iamVjdC5nZXQoJ25hbWUnKTsgLy8gbnVsbAoKICBwcm9taXNlT2JqZWN0LnRoZW4oZnVuY3Rpb24oKSB7CiAgICBwcm9taXNlT2JqZWN0LmdldCgnbmFtZScpOyAvLyAnVG9tc3RlcicKICB9KTsKICBgYGAKCiAgQGNsYXNzIFByb21pc2VPYmplY3QKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRW1iZXIuT2JqZWN0UHJveHkKICBAdXNlcyBFbWJlci5Qcm9taXNlUHJveHlNaXhpbgoqLwp2YXIgUHJvbWlzZU9iamVjdCA9IEVtYmVyLk9iamVjdFByb3h5LmV4dGVuZChFbWJlci5Qcm9taXNlUHJveHlNaXhpbik7CgpmdW5jdGlvbiBwcm9taXNlT2JqZWN0KHByb21pc2UsIGxhYmVsKSB7CiAgcmV0dXJuIFByb21pc2VPYmplY3QuY3JlYXRlKHsKICAgIHByb21pc2U6IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKHByb21pc2UsIGxhYmVsKQogIH0pOwp9CgpmdW5jdGlvbiBwcm9taXNlQXJyYXkocHJvbWlzZSwgbGFiZWwpIHsKICByZXR1cm4gUHJvbWlzZUFycmF5LmNyZWF0ZSh7CiAgICBwcm9taXNlOiBFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZShwcm9taXNlLCBsYWJlbCkKICB9KTsKfQoKdmFyIFByb21pc2VCZWxvbmdzVG8gPSBQcm9taXNlT2JqZWN0LmV4dGVuZCh7CgogIC8vIHdlIGRvbid0IHByb3h5IG1ldGEgYmVjYXVzZSB3ZSB3b3VsZCBuZWVkIHRvIHByb3h5IGl0IHRvIHRoZSByZWxhdGlvbnNoaXAgc3RhdGUgY29udGFpbmVyCiAgLy8gIGhvd2V2ZXIsIG1ldGEgb24gcmVsYXRpb25zaGlwcyBkb2VzIG5vdCB0cmlnZ2VyIGNoYW5nZSBub3RpZmljYXRpb25zLgogIC8vICBpZiB5b3UgbmVlZCByZWxhdGlvbnNoaXAgbWV0YSwgeW91IHNob3VsZCBkbyBgcmVjb3JkLmJlbG9uZ3NUbyhyZWxhdGlvbnNoaXBOYW1lKS5tZXRhKClgCiAgbWV0YTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgRW1iZXIuYXNzZXJ0KCdZb3UgYXR0ZW1wdGVkIHRvIGFjY2VzcyBtZXRhIG9uIHRoZSBwcm9taXNlIGZvciB0aGUgYXN5bmMgYmVsb25nc1RvIHJlbGF0aW9uc2hpcCAnICsgYCR7dGhpcy5nZXQoJ19iZWxvbmdzVG9TdGF0ZScpLmludGVybmFsTW9kZWwubW9kZWxOYW1lfToke3RoaXMuZ2V0KCdfYmVsb25nc1RvU3RhdGUnKS5rZXl9Jy5gICsgJ1xuVXNlIGByZWNvcmQuYmVsb25nc1RvKHJlbGF0aW9uc2hpcE5hbWUpLm1ldGEoKWAgaW5zdGVhZC4nLCBmYWxzZSkpOwogIH0pLAoKICByZWxvYWQoKSB7CiAgICAodHJ1ZSAmJiAhKHRoaXMuZ2V0KCdjb250ZW50JykgIT09IHVuZGVmaW5lZCkgJiYgRW1iZXIuYXNzZXJ0KCdZb3UgYXJlIHRyeWluZyB0byByZWxvYWQgYW4gYXN5bmMgYmVsb25nc1RvIGJlZm9yZSBpdCBoYXMgYmVlbiBjcmVhdGVkJywgdGhpcy5nZXQoJ2NvbnRlbnQnKSAhPT0gdW5kZWZpbmVkKSk7CgogICAgdGhpcy5nZXQoJ19iZWxvbmdzVG9TdGF0ZScpLnJlbG9hZCgpOwoKICAgIHJldHVybiB0aGlzOwogIH0KfSk7CgovKioKICBBIFByb21pc2VNYW55QXJyYXkgaXMgYSBQcm9taXNlQXJyYXkgdGhhdCBhbHNvIHByb3hpZXMgY2VydGFpbiBtZXRob2QgY2FsbHMKICB0byB0aGUgdW5kZXJseWluZyBtYW55QXJyYXkuCiAgUmlnaHQgbm93IHdlIHByb3h5OgoKICAgICogYHJlbG9hZCgpYAogICAgKiBgY3JlYXRlUmVjb3JkKClgCiAgICAqIGBvbigpYAogICAgKiBgb25lKClgCiAgICAqIGB0cmlnZ2VyKClgCiAgICAqIGBvZmYoKWAKICAgICogYGhhcygpYAoKICBAY2xhc3MgUHJvbWlzZU1hbnlBcnJheQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5BcnJheVByb3h5CiovCgpmdW5jdGlvbiBwcm94eVRvQ29udGVudChtZXRob2QpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIEVtYmVyLmdldCh0aGlzLCAnY29udGVudCcpW21ldGhvZF0oLi4uYXJndW1lbnRzKTsKICB9Owp9Cgp2YXIgUHJvbWlzZU1hbnlBcnJheSA9IFByb21pc2VBcnJheS5leHRlbmQoewogIHJlbG9hZCgpIHsKICAgICh0cnVlICYmICEoRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50JykpICYmIEVtYmVyLmFzc2VydCgnWW91IGFyZSB0cnlpbmcgdG8gcmVsb2FkIGFuIGFzeW5jIG1hbnlBcnJheSBiZWZvcmUgaXQgaGFzIGJlZW4gY3JlYXRlZCcsIEVtYmVyLmdldCh0aGlzLCAnY29udGVudCcpKSk7CgogICAgdGhpcy5zZXQoJ3Byb21pc2UnLCB0aGlzLmdldCgnY29udGVudCcpLnJlbG9hZCgpKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIGNyZWF0ZVJlY29yZDogcHJveHlUb0NvbnRlbnQoJ2NyZWF0ZVJlY29yZCcpLAoKICBvbjogcHJveHlUb0NvbnRlbnQoJ29uJyksCgogIG9uZTogcHJveHlUb0NvbnRlbnQoJ29uZScpLAoKICB0cmlnZ2VyOiBwcm94eVRvQ29udGVudCgndHJpZ2dlcicpLAoKICBvZmY6IHByb3h5VG9Db250ZW50KCdvZmYnKSwKCiAgaGFzOiBwcm94eVRvQ29udGVudCgnaGFzJykKfSk7CgpjbGFzcyBNYXBXaXRoRGVmYXVsdCBleHRlbmRzIE1hcFdpdGhEZXByZWNhdGlvbnMgewogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHN1cGVyKCk7CgogICAgdGhpcy5kZWZhdWx0VmFsdWUgPSBvcHRpb25zLmRlZmF1bHRWYWx1ZTsKICB9CgogIGdldChrZXkpIHsKICAgIHZhciBoYXNWYWx1ZSA9IHRoaXMuaGFzKGtleSk7CgogICAgaWYgKGhhc1ZhbHVlKSB7CiAgICAgIHJldHVybiBzdXBlci5nZXQoa2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBkZWZhdWx0VmFsdWUgPSB0aGlzLmRlZmF1bHRWYWx1ZShrZXkpOwogICAgICB0aGlzLnNldChrZXksIGRlZmF1bHRWYWx1ZSk7CiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfQp9CgovKioKQG1vZHVsZSBlbWJlci1kYXRhCiovCgovKioKICBIb2xkcyB2YWxpZGF0aW9uIGVycm9ycyBmb3IgYSBnaXZlbiByZWNvcmQsIG9yZ2FuaXplZCBieSBhdHRyaWJ1dGUgbmFtZXMuCgogIEV2ZXJ5IGBEUy5Nb2RlbGAgaGFzIGFuIGBlcnJvcnNgIHByb3BlcnR5IHRoYXQgaXMgYW4gaW5zdGFuY2Ugb2YKICBgRFMuRXJyb3JzYC4gVGhpcyBjYW4gYmUgdXNlZCB0byBkaXNwbGF5IHZhbGlkYXRpb24gZXJyb3IKICBtZXNzYWdlcyByZXR1cm5lZCBmcm9tIHRoZSBzZXJ2ZXIgd2hlbiBhIGByZWNvcmQuc2F2ZSgpYCByZWplY3RzLgoKICBGb3IgRXhhbXBsZSwgaWYgeW91IGhhZCBhIGBVc2VyYCBtb2RlbCB0aGF0IGxvb2tlZCBsaWtlIHRoaXM6CgogIGBgYGFwcC9tb2RlbHMvdXNlci5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHVzZXJuYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgIGVtYWlsOiBEUy5hdHRyKCdzdHJpbmcnKQogIH0pOwogIGBgYAogIEFuZCB5b3UgYXR0ZW1wdGVkIHRvIHNhdmUgYSByZWNvcmQgdGhhdCBkaWQgbm90IHZhbGlkYXRlIG9uIHRoZSBiYWNrZW5kOgoKICBgYGBqYXZhc2NyaXB0CiAgbGV0IHVzZXIgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ3VzZXInLCB7CiAgICB1c2VybmFtZTogJ3RvbXN0ZXInLAogICAgZW1haWw6ICdpbnZhbGlkRW1haWwnCiAgfSk7CiAgdXNlci5zYXZlKCk7CiAgYGBgCgogIFlvdXIgYmFja2VuZCB3b3VsZCBiZSBleHBlY3RlZCB0byByZXR1cm4gYW4gZXJyb3IgcmVzcG9uc2UgdGhhdCBkZXNjcmliZWQKICB0aGUgcHJvYmxlbSwgc28gdGhhdCBlcnJvciBtZXNzYWdlcyBjYW4gYmUgZ2VuZXJhdGVkIG9uIHRoZSBhcHAuCgogIEFQSSByZXNwb25zZXMgd2lsbCBiZSB0cmFuc2xhdGVkIGludG8gaW5zdGFuY2VzIG9mIGBEUy5FcnJvcnNgIGRpZmZlcmVudGx5LAogIGRlcGVuZGluZyBvbiB0aGUgc3BlY2lmaWMgY29tYmluYXRpb24gb2YgYWRhcHRlciBhbmQgc2VyaWFsaXplciB1c2VkLiBZb3UKICBtYXkgd2FudCB0byBjaGVjayB0aGUgZG9jdW1lbnRhdGlvbiBvciB0aGUgc291cmNlIGNvZGUgb2YgdGhlIGxpYnJhcmllcwogIHRoYXQgeW91IGFyZSB1c2luZywgdG8ga25vdyBob3cgdGhleSBleHBlY3QgZXJyb3JzIHRvIGJlIGNvbW11bmljYXRlZC4KCiAgRXJyb3JzIGNhbiBiZSBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIgYnkgYWNjZXNzaW5nIHRoZWlyIHByb3BlcnR5IG5hbWUKICB0byBnZXQgYW4gYXJyYXkgb2YgYWxsIHRoZSBlcnJvciBvYmplY3RzIGZvciB0aGF0IHByb3BlcnR5LiBFYWNoCiAgZXJyb3Igb2JqZWN0IGlzIGEgSmF2YVNjcmlwdCBvYmplY3Qgd2l0aCB0d28ga2V5czoKCiAgLSBgbWVzc2FnZWAgQSBzdHJpbmcgY29udGFpbmluZyB0aGUgZXJyb3IgbWVzc2FnZSBmcm9tIHRoZSBiYWNrZW5kCiAgLSBgYXR0cmlidXRlYCBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZXJyb3IgbWVzc2FnZQoKICBgYGBoYW5kbGViYXJzCiAgPGxhYmVsPlVzZXJuYW1lOiB7e2lucHV0IHZhbHVlPXVzZXJuYW1lfX0gPC9sYWJlbD4KICB7eyNlYWNoIG1vZGVsLmVycm9ycy51c2VybmFtZSBhcyB8ZXJyb3J8fX0KICAgIDxkaXYgY2xhc3M9ImVycm9yIj4KICAgICAge3tlcnJvci5tZXNzYWdlfX0KICAgIDwvZGl2PgogIHt7L2VhY2h9fQoKICA8bGFiZWw+RW1haWw6IHt7aW5wdXQgdmFsdWU9ZW1haWx9fSA8L2xhYmVsPgogIHt7I2VhY2ggbW9kZWwuZXJyb3JzLmVtYWlsIGFzIHxlcnJvcnx9fQogICAgPGRpdiBjbGFzcz0iZXJyb3IiPgogICAgICB7e2Vycm9yLm1lc3NhZ2V9fQogICAgPC9kaXY+CiAge3svZWFjaH19CiAgYGBgCgogIFlvdSBjYW4gYWxzbyBhY2Nlc3MgdGhlIHNwZWNpYWwgYG1lc3NhZ2VzYCBwcm9wZXJ0eSBvbiB0aGUgZXJyb3IKICBvYmplY3QgdG8gZ2V0IGFuIGFycmF5IG9mIGFsbCB0aGUgZXJyb3Igc3RyaW5ncy4KCiAgYGBgaGFuZGxlYmFycwogIHt7I2VhY2ggbW9kZWwuZXJyb3JzLm1lc3NhZ2VzIGFzIHxtZXNzYWdlfH19CiAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgIHt7bWVzc2FnZX19CiAgICA8L2Rpdj4KICB7ey9lYWNofX0KICBgYGAKCiAgQGNsYXNzIEVycm9ycwogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKICBAdXNlcyBFbWJlci5FbnVtZXJhYmxlCiAgQHVzZXMgRW1iZXIuRXZlbnRlZAogKi8KdmFyIEVycm9ycyA9IEVtYmVyLkFycmF5UHJveHkuZXh0ZW5kKEVtYmVyLkV2ZW50ZWQsIHsKICAvKioKICAgIFJlZ2lzdGVyIHdpdGggdGFyZ2V0IGhhbmRsZXIKICAgICBAbWV0aG9kIHJlZ2lzdGVySGFuZGxlcnMKICAgIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGJlY2FtZUludmFsaWQKICAgIEBwYXJhbSB7RnVuY3Rpb259IGJlY2FtZVZhbGlkCiAgICBAZGVwcmVjYXRlZAogICovCiAgcmVnaXN0ZXJIYW5kbGVycyh0YXJnZXQsIGJlY2FtZUludmFsaWQsIGJlY2FtZVZhbGlkKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5kZXByZWNhdGUoYFJlY29yZCBlcnJvcnMgd2lsbCBubyBsb25nZXIgYmUgZXZlbnRlZC5gLCBmYWxzZSwgewogICAgICBpZDogJ2RzLmVycm9ycy5yZWdpc3RlckhhbmRsZXJzJywKICAgICAgdW50aWw6ICczLjAuMCcKICAgIH0pKTsKCgogICAgdGhpcy5fcmVnaXN0ZXJIYW5kbGVycyh0YXJnZXQsIGJlY2FtZUludmFsaWQsIGJlY2FtZVZhbGlkKTsKICB9LAoKICAvKioKICAgIFJlZ2lzdGVyIHdpdGggdGFyZ2V0IGhhbmRsZXIKICAgICBAbWV0aG9kIF9yZWdpc3RlckhhbmRsZXJzCiAgICBAcHJpdmF0ZQogICovCiAgX3JlZ2lzdGVySGFuZGxlcnModGFyZ2V0LCBiZWNhbWVJbnZhbGlkLCBiZWNhbWVWYWxpZCkgewogICAgdGhpcy5vbignYmVjYW1lSW52YWxpZCcsIHRhcmdldCwgYmVjYW1lSW52YWxpZCk7CiAgICB0aGlzLm9uKCdiZWNhbWVWYWxpZCcsIHRhcmdldCwgYmVjYW1lVmFsaWQpOwogIH0sCgogIC8qKgogICAgQHByb3BlcnR5IGVycm9yc0J5QXR0cmlidXRlTmFtZQogICAgQHR5cGUge01hcFdpdGhEZWZhdWx0fQogICAgQHByaXZhdGUKICAqLwogIGVycm9yc0J5QXR0cmlidXRlTmFtZTogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBNYXBXaXRoRGVmYXVsdCh7CiAgICAgIGRlZmF1bHRWYWx1ZSgpIHsKICAgICAgICByZXR1cm4gRW1iZXIuQSgpOwogICAgICB9CiAgICB9KTsKICB9KSwKCiAgLyoqCiAgICBSZXR1cm5zIGVycm9ycyBmb3IgYSBnaXZlbiBhdHRyaWJ1dGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgdXNlciA9IHN0b3JlLmNyZWF0ZVJlY29yZCgndXNlcicsIHsKICAgICAgdXNlcm5hbWU6ICd0b21zdGVyJywKICAgICAgZW1haWw6ICdpbnZhbGlkRW1haWwnCiAgICB9KTsKICAgIHVzZXIuc2F2ZSgpLmNhdGNoKGZ1bmN0aW9uKCl7CiAgICAgIHVzZXIuZ2V0KCdlcnJvcnMnKS5lcnJvcnNGb3IoJ2VtYWlsJyk7IC8vIHJldHVybnM6CiAgICAgIC8vIFt7YXR0cmlidXRlOiAiZW1haWwiLCBtZXNzYWdlOiAiRG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBlbWFpbC4ifV0KICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCBlcnJvcnNGb3IKICAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGUKICAgIEByZXR1cm4ge0FycmF5fQogICovCiAgZXJyb3JzRm9yKGF0dHJpYnV0ZSkgewogICAgcmV0dXJuIEVtYmVyLmdldCh0aGlzLCAnZXJyb3JzQnlBdHRyaWJ1dGVOYW1lJykuZ2V0KGF0dHJpYnV0ZSk7CiAgfSwKCiAgLyoqCiAgICBBbiBhcnJheSBjb250YWluaW5nIGFsbCBvZiB0aGUgZXJyb3IgbWVzc2FnZXMgZm9yIHRoaXMKICAgIHJlY29yZC4gVGhpcyBpcyB1c2VmdWwgZm9yIGRpc3BsYXlpbmcgYWxsIGVycm9ycyB0byB0aGUgdXNlci4KICAgICBgYGBoYW5kbGViYXJzCiAgICB7eyNlYWNoIG1vZGVsLmVycm9ycy5tZXNzYWdlcyBhcyB8bWVzc2FnZXx9fQogICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAge3ttZXNzYWdlfX0KICAgICAgPC9kaXY+CiAgICB7ey9lYWNofX0KICAgIGBgYAogICAgIEBwcm9wZXJ0eSBtZXNzYWdlcwogICAgQHR5cGUge0FycmF5fQogICovCiAgbWVzc2FnZXM6IEVtYmVyLmNvbXB1dGVkLm1hcEJ5KCdjb250ZW50JywgJ21lc3NhZ2UnKSwKCiAgLyoqCiAgICBAcHJvcGVydHkgY29udGVudAogICAgQHR5cGUge0FycmF5fQogICAgQHByaXZhdGUKICAqLwogIGNvbnRlbnQ6IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBFbWJlci5BKCk7CiAgfSksCgogIC8qKgogICAgQG1ldGhvZCB1bmtub3duUHJvcGVydHkKICAgIEBwcml2YXRlCiAgKi8KICB1bmtub3duUHJvcGVydHkoYXR0cmlidXRlKSB7CiAgICB2YXIgZXJyb3JzID0gdGhpcy5lcnJvcnNGb3IoYXR0cmlidXRlKTsKICAgIGlmIChlcnJvcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgICByZXR1cm4gZXJyb3JzOwogIH0sCgogIC8qKgogICAgVG90YWwgbnVtYmVyIG9mIGVycm9ycy4KICAgICBAcHJvcGVydHkgbGVuZ3RoCiAgICBAdHlwZSB7TnVtYmVyfQogICAgQHJlYWRPbmx5CiAgKi8KCiAgLyoqCiAgICBAcHJvcGVydHkgaXNFbXB0eQogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzRW1wdHk6IEVtYmVyLmNvbXB1dGVkLm5vdCgnbGVuZ3RoJykucmVhZE9ubHkoKSwKCiAgLyoqCiAgICBBZGRzIGVycm9yIG1lc3NhZ2VzIHRvIGEgZ2l2ZW4gYXR0cmlidXRlIGFuZCBzZW5kcwogICAgYGJlY2FtZUludmFsaWRgIGV2ZW50IHRvIHRoZSByZWNvcmQuCiAgICAgRXhhbXBsZToKICAgICBgYGBqYXZhc2NyaXB0CiAgICBpZiAoIXVzZXIuZ2V0KCd1c2VybmFtZScpIHsKICAgICAgdXNlci5nZXQoJ2Vycm9ycycpLmFkZCgndXNlcm5hbWUnLCAnVGhpcyBmaWVsZCBpcyByZXF1aXJlZCcpOwogICAgfQogICAgYGBgCiAgICAgQG1ldGhvZCBhZGQKICAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGUKICAgIEBwYXJhbSB7KEFycmF5fFN0cmluZyl9IG1lc3NhZ2VzCiAgICBAZGVwcmVjYXRlZAogICovCiAgYWRkKGF0dHJpYnV0ZSwgbWVzc2FnZXMpIHsKICAgICh0cnVlICYmIEVtYmVyLndhcm4oYEludGVyYWN0aW5nIHdpdGggYSByZWNvcmQgZXJyb3JzIG9iamVjdCB3aWxsIG5vIGxvbmdlciBjaGFuZ2UgdGhlIHJlY29yZCBzdGF0ZS5gLCBmYWxzZSwgewogICAgICBpZDogJ2RzLmVycm9ycy5hZGQnCiAgICB9KSk7CgoKICAgIHZhciB3YXNFbXB0eSA9IEVtYmVyLmdldCh0aGlzLCAnaXNFbXB0eScpOwoKICAgIHRoaXMuX2FkZChhdHRyaWJ1dGUsIG1lc3NhZ2VzKTsKCiAgICBpZiAod2FzRW1wdHkgJiYgIUVtYmVyLmdldCh0aGlzLCAnaXNFbXB0eScpKSB7CiAgICAgIHRoaXMudHJpZ2dlcignYmVjYW1lSW52YWxpZCcpOwogICAgfQogIH0sCgogIC8qKgogICAgQWRkcyBlcnJvciBtZXNzYWdlcyB0byBhIGdpdmVuIGF0dHJpYnV0ZSB3aXRob3V0IHNlbmRpbmcgZXZlbnQuCiAgICAgQG1ldGhvZCBfYWRkCiAgICBAcHJpdmF0ZQogICovCiAgX2FkZChhdHRyaWJ1dGUsIG1lc3NhZ2VzKSB7CiAgICBtZXNzYWdlcyA9IHRoaXMuX2ZpbmRPckNyZWF0ZU1lc3NhZ2VzKGF0dHJpYnV0ZSwgbWVzc2FnZXMpOwogICAgdGhpcy5hZGRPYmplY3RzKG1lc3NhZ2VzKTsKICAgIEVtYmVyLmdldCh0aGlzLCAnZXJyb3JzQnlBdHRyaWJ1dGVOYW1lJykuZ2V0KGF0dHJpYnV0ZSkuYWRkT2JqZWN0cyhtZXNzYWdlcyk7CgogICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShhdHRyaWJ1dGUpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBfZmluZE9yQ3JlYXRlTWVzc2FnZXMKICAgIEBwcml2YXRlCiAgKi8KICBfZmluZE9yQ3JlYXRlTWVzc2FnZXMoYXR0cmlidXRlLCBtZXNzYWdlcykgewogICAgdmFyIGVycm9ycyA9IHRoaXMuZXJyb3JzRm9yKGF0dHJpYnV0ZSk7CiAgICB2YXIgbWVzc2FnZXNBcnJheSA9IEVtYmVyLm1ha2VBcnJheShtZXNzYWdlcyk7CiAgICB2YXIgX21lc3NhZ2VzID0gbmV3IEFycmF5KG1lc3NhZ2VzQXJyYXkubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lc3NhZ2VzQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1lc3NhZ2UgPSBtZXNzYWdlc0FycmF5W2ldOwogICAgICB2YXIgZXJyID0gZXJyb3JzLmZpbmRCeSgnbWVzc2FnZScsIG1lc3NhZ2UpOwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgX21lc3NhZ2VzW2ldID0gZXJyOwogICAgICB9IGVsc2UgewogICAgICAgIF9tZXNzYWdlc1tpXSA9IHsKICAgICAgICAgIGF0dHJpYnV0ZTogYXR0cmlidXRlLAogICAgICAgICAgbWVzc2FnZTogbWVzc2FnZQogICAgICAgIH07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gX21lc3NhZ2VzOwogIH0sCgogIC8qKgogICAgUmVtb3ZlcyBhbGwgZXJyb3IgbWVzc2FnZXMgZnJvbSB0aGUgZ2l2ZW4gYXR0cmlidXRlIGFuZCBzZW5kcwogICAgYGJlY2FtZVZhbGlkYCBldmVudCB0byB0aGUgcmVjb3JkIGlmIHRoZXJlIG5vIG1vcmUgZXJyb3JzIGxlZnQuCiAgICAgRXhhbXBsZToKICAgICBgYGBhcHAvbW9kZWxzL3VzZXIuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICBlbWFpbDogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIHR3b0ZhY3RvckF1dGg6IERTLmF0dHIoJ2Jvb2xlYW4nKSwKICAgICAgcGhvbmU6IERTLmF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgIGBgYAogICAgIGBgYGFwcC9yb3V0ZXMvdXNlci9lZGl0LmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBzYXZlOiBmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgICBpZiAoIXVzZXIuZ2V0KCd0d29GYWN0b3JBdXRoJykpIHsKICAgICAgICAgICAgdXNlci5nZXQoJ2Vycm9ycycpLnJlbW92ZSgncGhvbmUnKTsKICAgICAgICAgIH0KICAgICAgICAgIHVzZXIuc2F2ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIHJlbW92ZQogICAgQHBhcmFtIHtTdHJpbmd9IGF0dHJpYnV0ZQogICAgQGRlcHJlY2F0ZWQKICAqLwogIHJlbW92ZShhdHRyaWJ1dGUpIHsKICAgICh0cnVlICYmIEVtYmVyLndhcm4oYEludGVyYWN0aW5nIHdpdGggYSByZWNvcmQgZXJyb3JzIG9iamVjdCB3aWxsIG5vIGxvbmdlciBjaGFuZ2UgdGhlIHJlY29yZCBzdGF0ZS5gLCBmYWxzZSwgewogICAgICBpZDogJ2RzLmVycm9ycy5yZW1vdmUnCiAgICB9KSk7CgoKICAgIGlmIChFbWJlci5nZXQodGhpcywgJ2lzRW1wdHknKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5fcmVtb3ZlKGF0dHJpYnV0ZSk7CgogICAgaWYgKEVtYmVyLmdldCh0aGlzLCAnaXNFbXB0eScpKSB7CiAgICAgIHRoaXMudHJpZ2dlcignYmVjYW1lVmFsaWQnKTsKICAgIH0KICB9LAoKICAvKioKICAgIFJlbW92ZXMgYWxsIGVycm9yIG1lc3NhZ2VzIGZyb20gdGhlIGdpdmVuIGF0dHJpYnV0ZSB3aXRob3V0IHNlbmRpbmcgZXZlbnQuCiAgICAgQG1ldGhvZCBfcmVtb3ZlCiAgICBAcHJpdmF0ZQogICovCiAgX3JlbW92ZShhdHRyaWJ1dGUpIHsKICAgIGlmIChFbWJlci5nZXQodGhpcywgJ2lzRW1wdHknKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNvbnRlbnQgPSB0aGlzLnJlamVjdEJ5KCdhdHRyaWJ1dGUnLCBhdHRyaWJ1dGUpOwogICAgRW1iZXIuc2V0KHRoaXMsICdjb250ZW50JywgY29udGVudCk7CiAgICBFbWJlci5nZXQodGhpcywgJ2Vycm9yc0J5QXR0cmlidXRlTmFtZScpLmRlbGV0ZShhdHRyaWJ1dGUpOwoKICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoYXR0cmlidXRlKTsKICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2UoJ2xlbmd0aCcpOwogIH0sCgogIC8qKgogICAgUmVtb3ZlcyBhbGwgZXJyb3IgbWVzc2FnZXMgYW5kIHNlbmRzIGBiZWNhbWVWYWxpZGAgZXZlbnQKICAgIHRvIHRoZSByZWNvcmQuCiAgICAgRXhhbXBsZToKICAgICBgYGBhcHAvcm91dGVzL3VzZXIvZWRpdC5qcwogIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHJldHJ5U2F2ZTogZnVuY3Rpb24odXNlcikgewogICAgICAgICAgdXNlci5nZXQoJ2Vycm9ycycpLmNsZWFyKCk7CiAgICAgICAgICB1c2VyLnNhdmUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCBjbGVhcgogICAgQGRlcHJlY2F0ZWQKICAqLwogIGNsZWFyKCkgewogICAgKHRydWUgJiYgRW1iZXIud2FybihgSW50ZXJhY3Rpbmcgd2l0aCBhIHJlY29yZCBlcnJvcnMgb2JqZWN0IHdpbGwgbm8gbG9uZ2VyIGNoYW5nZSB0aGUgcmVjb3JkIHN0YXRlLmAsIGZhbHNlLCB7CiAgICAgIGlkOiAnZHMuZXJyb3JzLmNsZWFyJwogICAgfSkpOwoKCiAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX2NsZWFyKCk7CiAgICB0aGlzLnRyaWdnZXIoJ2JlY2FtZVZhbGlkJyk7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGFsbCBlcnJvciBtZXNzYWdlcy4KICAgIHRvIHRoZSByZWNvcmQuCiAgICAgQG1ldGhvZCBfY2xlYXIKICAgIEBwcml2YXRlCiAgKi8KICBfY2xlYXIoKSB7CiAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc0VtcHR5JykpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBlcnJvcnNCeUF0dHJpYnV0ZU5hbWUgPSBFbWJlci5nZXQodGhpcywgJ2Vycm9yc0J5QXR0cmlidXRlTmFtZScpOwogICAgdmFyIGF0dHJpYnV0ZXMgPSBFbWJlci5BKCk7CgogICAgZXJyb3JzQnlBdHRyaWJ1dGVOYW1lLmZvckVhY2goZnVuY3Rpb24gKF8sIGF0dHJpYnV0ZSkgewogICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cmlidXRlKTsKICAgIH0pOwoKICAgIGVycm9yc0J5QXR0cmlidXRlTmFtZS5jbGVhcigpOwogICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHsKICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShhdHRyaWJ1dGUpOwogICAgfSwgdGhpcyk7CgogICAgRW1iZXIuQXJyYXlQcm94eS5wcm90b3R5cGUuY2xlYXIuY2FsbCh0aGlzKTsKICB9LAoKICAvKioKICAgIENoZWNrcyBpZiB0aGVyZSBpcyBlcnJvciBtZXNzYWdlcyBmb3IgdGhlIGdpdmVuIGF0dHJpYnV0ZS4KICAgICBgYGBhcHAvcm91dGVzL3VzZXIvZWRpdC5qcwogICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICBhY3Rpb25zOiB7CiAgICAgICAgc2F2ZTogZnVuY3Rpb24odXNlcikgewogICAgICAgICAgaWYgKHVzZXIuZ2V0KCdlcnJvcnMnKS5oYXMoJ2VtYWlsJykpIHsKICAgICAgICAgICAgcmV0dXJuIGFsZXJ0KCdQbGVhc2UgdXBkYXRlIHlvdXIgZW1haWwgYmVmb3JlIGF0dGVtcHRpbmcgdG8gc2F2ZS4nKTsKICAgICAgICAgIH0KICAgICAgICAgIHVzZXIuc2F2ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIGhhcwogICAgQHBhcmFtIHtTdHJpbmd9IGF0dHJpYnV0ZQogICAgQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGVyZSBzb21lIGVycm9ycyBvbiBnaXZlbiBhdHRyaWJ1dGUKICAqLwogIGhhcyhhdHRyaWJ1dGUpIHsKICAgIHJldHVybiB0aGlzLmVycm9yc0ZvcihhdHRyaWJ1dGUpLmxlbmd0aCA+IDA7CiAgfQp9KTsKCi8qCiAgVGhpcyBmaWxlIGVuY2Fwc3VsYXRlcyB0aGUgdmFyaW91cyBzdGF0ZXMgdGhhdCBhIHJlY29yZCBjYW4gdHJhbnNpdGlvbgogIHRocm91Z2ggZHVyaW5nIGl0cyBsaWZlY3ljbGUuCiovCi8qKgogICMjIyBTdGF0ZQoKICBFYWNoIHJlY29yZCBoYXMgYSBgY3VycmVudFN0YXRlYCBwcm9wZXJ0eSB0aGF0IGV4cGxpY2l0bHkgdHJhY2tzIHdoYXQKICBzdGF0ZSBhIHJlY29yZCBpcyBpbiBhdCBhbnkgZ2l2ZW4gdGltZS4gRm9yIGluc3RhbmNlLCBpZiBhIHJlY29yZCBpcwogIG5ld2x5IGNyZWF0ZWQgYW5kIGhhcyBub3QgeWV0IGJlZW4gc2VudCB0byB0aGUgYWRhcHRlciB0byBiZSBzYXZlZCwKICBpdCB3b3VsZCBiZSBpbiB0aGUgYHJvb3QubG9hZGVkLmNyZWF0ZWQudW5jb21taXR0ZWRgIHN0YXRlLiAgSWYgYQogIHJlY29yZCBoYXMgaGFkIGxvY2FsIG1vZGlmaWNhdGlvbnMgbWFkZSB0byBpdCB0aGF0IGFyZSBpbiB0aGUKICBwcm9jZXNzIG9mIGJlaW5nIHNhdmVkLCB0aGUgcmVjb3JkIHdvdWxkIGJlIGluIHRoZQogIGByb290LmxvYWRlZC51cGRhdGVkLmluRmxpZ2h0YCBzdGF0ZS4gKFRoaXMgc3RhdGUgcGF0aHMgd2lsbCBiZQogIGV4cGxhaW5lZCBpbiBtb3JlIGRldGFpbCBiZWxvdy4pCgogIEV2ZW50cyBhcmUgc2VudCBieSB0aGUgcmVjb3JkIG9yIGl0cyBzdG9yZSB0byB0aGUgcmVjb3JkJ3MKICBgY3VycmVudFN0YXRlYCBwcm9wZXJ0eS4gSG93IHRoZSBzdGF0ZSByZWFjdHMgdG8gdGhlc2UgZXZlbnRzIGlzCiAgZGVwZW5kZW50IG9uIHdoaWNoIHN0YXRlIGl0IGlzIGluLiBJbiBzb21lIHN0YXRlcywgY2VydGFpbiBldmVudHMKICB3aWxsIGJlIGludmFsaWQgYW5kIHdpbGwgY2F1c2UgYW4gZXhjZXB0aW9uIHRvIGJlIHJhaXNlZC4KCiAgU3RhdGVzIGFyZSBoaWVyYXJjaGljYWwgYW5kIGV2ZXJ5IHN0YXRlIGlzIGEgc3Vic3RhdGUgb2YgdGhlCiAgYFJvb3RTdGF0ZWAuIEZvciBleGFtcGxlLCBhIHJlY29yZCBjYW4gYmUgaW4gdGhlCiAgYHJvb3QuZGVsZXRlZC51bmNvbW1pdHRlZGAgc3RhdGUsIHRoZW4gdHJhbnNpdGlvbiBpbnRvIHRoZQogIGByb290LmRlbGV0ZWQuaW5GbGlnaHRgIHN0YXRlLiBJZiBhIGNoaWxkIHN0YXRlIGRvZXMgbm90IGltcGxlbWVudAogIGFuIGV2ZW50IGhhbmRsZXIsIHRoZSBzdGF0ZSBtYW5hZ2VyIHdpbGwgYXR0ZW1wdCB0byBpbnZva2UgdGhlIGV2ZW50CiAgb24gYWxsIHBhcmVudCBzdGF0ZXMgdW50aWwgdGhlIHJvb3Qgc3RhdGUgaXMgcmVhY2hlZC4gVGhlIHN0YXRlCiAgaGllcmFyY2h5IG9mIGEgcmVjb3JkIGlzIGRlc2NyaWJlZCBpbiB0ZXJtcyBvZiBhIHBhdGggc3RyaW5nLiBZb3UKICBjYW4gZGV0ZXJtaW5lIGEgcmVjb3JkJ3MgY3VycmVudCBzdGF0ZSBieSBnZXR0aW5nIHRoZSBzdGF0ZSdzCiAgYHN0YXRlTmFtZWAgcHJvcGVydHk6CgogIGBgYGphdmFzY3JpcHQKICByZWNvcmQuZ2V0KCdjdXJyZW50U3RhdGUuc3RhdGVOYW1lJyk7CiAgLy89PiAicm9vdC5jcmVhdGVkLnVuY29tbWl0dGVkIgogICBgYGAKCiAgVGhlIGhpZXJhcmNoeSBvZiB2YWxpZCBzdGF0ZXMgdGhhdCBzaGlwIHdpdGggZW1iZXIgZGF0YSBsb29rcyBsaWtlCiAgdGhpczoKCiAgYGBgdGV4dAogICogcm9vdAogICAgKiBkZWxldGVkCiAgICAgICogc2F2ZWQKICAgICAgKiB1bmNvbW1pdHRlZAogICAgICAqIGluRmxpZ2h0CiAgICAqIGVtcHR5CiAgICAqIGxvYWRlZAogICAgICAqIGNyZWF0ZWQKICAgICAgICAqIHVuY29tbWl0dGVkCiAgICAgICAgKiBpbkZsaWdodAogICAgICAqIHNhdmVkCiAgICAgICogdXBkYXRlZAogICAgICAgICogdW5jb21taXR0ZWQKICAgICAgICAqIGluRmxpZ2h0CiAgICAqIGxvYWRpbmcKICBgYGAKCiAgVGhlIGBEUy5Nb2RlbGAgc3RhdGVzIGFyZSB0aGVtc2VsdmVzIHN0YXRlbGVzcy4gV2hhdCB0aGF0IG1lYW5zIGlzCiAgdGhhdCwgdGhlIGhpZXJhcmNoaWNhbCBzdGF0ZXMgdGhhdCBlYWNoIG9mICp0aG9zZSogcG9pbnRzIHRvIGlzIGEKICBzaGFyZWQgZGF0YSBzdHJ1Y3R1cmUuIEZvciBwZXJmb3JtYW5jZSByZWFzb25zLCBpbnN0ZWFkIG9mIGVhY2gKICByZWNvcmQgZ2V0dGluZyBpdHMgb3duIGNvcHkgb2YgdGhlIGhpZXJhcmNoeSBvZiBzdGF0ZXMsIGVhY2ggcmVjb3JkCiAgcG9pbnRzIHRvIHRoaXMgZ2xvYmFsLCBpbW11dGFibGUgc2hhcmVkIGluc3RhbmNlLiBIb3cgZG9lcyBhIHN0YXRlCiAga25vdyB3aGljaCByZWNvcmQgaXQgc2hvdWxkIGJlIGFjdGluZyBvbj8gV2UgcGFzcyB0aGUgcmVjb3JkCiAgaW5zdGFuY2UgaW50byB0aGUgc3RhdGUncyBldmVudCBoYW5kbGVycyBhcyB0aGUgZmlyc3QgYXJndW1lbnQuCgogIFRoZSByZWNvcmQgcGFzc2VkIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIgaXMgd2hlcmUgeW91IHNob3VsZCBzdGFzaAogIHN0YXRlIGFib3V0IHRoZSByZWNvcmQgaWYgbmVlZGVkOyB5b3Ugc2hvdWxkIG5ldmVyIHN0b3JlIGRhdGEgb24gdGhlIHN0YXRlCiAgb2JqZWN0IGl0c2VsZi4KCiAgIyMjIEV2ZW50cyBhbmQgRmxhZ3MKCiAgQSBzdGF0ZSBtYXkgaW1wbGVtZW50IHplcm8gb3IgbW9yZSBldmVudHMgYW5kIGZsYWdzLgoKICAjIyMjIEV2ZW50cwoKICBFdmVudHMgYXJlIG5hbWVkIGZ1bmN0aW9ucyB0aGF0IGFyZSBpbnZva2VkIHdoZW4gc2VudCB0byBhIHJlY29yZC4gVGhlCiAgcmVjb3JkIHdpbGwgZmlyc3QgbG9vayBmb3IgYSBtZXRob2Qgd2l0aCB0aGUgZ2l2ZW4gbmFtZSBvbiB0aGUKICBjdXJyZW50IHN0YXRlLiBJZiBubyBtZXRob2QgaXMgZm91bmQsIGl0IHdpbGwgc2VhcmNoIHRoZSBjdXJyZW50CiAgc3RhdGUncyBwYXJlbnQsIGFuZCB0aGVuIGl0cyBncmFuZHBhcmVudCwgYW5kIHNvIG9uIHVudGlsIHJlYWNoaW5nCiAgdGhlIHRvcCBvZiB0aGUgaGllcmFyY2h5LiBJZiB0aGUgcm9vdCBpcyByZWFjaGVkIHdpdGhvdXQgYW4gZXZlbnQKICBoYW5kbGVyIGJlaW5nIGZvdW5kLCBhbiBleGNlcHRpb24gd2lsbCBiZSByYWlzZWQuIFRoaXMgY2FuIGJlIHZlcnkKICBoZWxwZnVsIHdoZW4gZGVidWdnaW5nIG5ldyBmZWF0dXJlcy4KCiAgSGVyZSdzIGFuIGV4YW1wbGUgaW1wbGVtZW50YXRpb24gb2YgYSBzdGF0ZSB3aXRoIGEgYG15RXZlbnRgIGV2ZW50IGhhbmRsZXI6CgogIGBgYGphdmFzY3JpcHQKICBhU3RhdGU6IERTLlN0YXRlLmNyZWF0ZSh7CiAgICBteUV2ZW50OiBmdW5jdGlvbihtYW5hZ2VyLCBwYXJhbSkgewogICAgICBjb25zb2xlLmxvZygiUmVjZWl2ZWQgbXlFdmVudCB3aXRoIiwgcGFyYW0pOwogICAgfQogIH0pCiAgYGBgCgogIFRvIHRyaWdnZXIgdGhpcyBldmVudDoKCiAgYGBgamF2YXNjcmlwdAogIHJlY29yZC5zZW5kKCdteUV2ZW50JywgJ2ZvbycpOwogIC8vPT4gIlJlY2VpdmVkIG15RXZlbnQgd2l0aCBmb28iCiAgYGBgCgogIE5vdGUgdGhhdCBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgY2FuIGJlIHNlbnQgdG8gYSByZWNvcmQncyBgc2VuZCgpYCBtZXRob2QsCiAgd2hpY2ggd2lsbCBiZSBwYXNzZWQgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIgdG8gdGhlIGV2ZW50IGhhbmRsZXIuCgogIEV2ZW50cyBzaG91bGQgdHJhbnNpdGlvbiB0byBhIGRpZmZlcmVudCBzdGF0ZSBpZiBhcHByb3ByaWF0ZS4gVGhpcyBjYW4gYmUKICBkb25lIGJ5IGNhbGxpbmcgdGhlIHJlY29yZCdzIGB0cmFuc2l0aW9uVG8oKWAgbWV0aG9kIHdpdGggYSBwYXRoIHRvIHRoZQogIGRlc2lyZWQgc3RhdGUuIFRoZSBzdGF0ZSBtYW5hZ2VyIHdpbGwgYXR0ZW1wdCB0byByZXNvbHZlIHRoZSBzdGF0ZSBwYXRoCiAgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgc3RhdGUuIElmIG5vIHN0YXRlIGlzIGZvdW5kIGF0IHRoYXQgcGF0aCwgaXQgd2lsbAogIGF0dGVtcHQgdG8gcmVzb2x2ZSBpdCByZWxhdGl2ZSB0byB0aGUgY3VycmVudCBzdGF0ZSdzIHBhcmVudCwgYW5kIHRoZW4gaXRzCiAgcGFyZW50LCBhbmQgc28gb24gdW50aWwgdGhlIHJvb3QgaXMgcmVhY2hlZC4gRm9yIGV4YW1wbGUsIGltYWdpbmUgYSBoaWVyYXJjaHkKICBsaWtlIHRoaXM6CgogICAgICAqIGNyZWF0ZWQKICAgICAgICAqIHVuY29tbWl0dGVkIDwtLSBjdXJyZW50U3RhdGUKICAgICAgICAqIGluRmxpZ2h0CiAgICAgICogdXBkYXRlZAogICAgICAgICogaW5GbGlnaHQKCiAgSWYgd2UgYXJlIGN1cnJlbnRseSBpbiB0aGUgYHVuY29tbWl0dGVkYCBzdGF0ZSwgY2FsbGluZwogIGB0cmFuc2l0aW9uVG8oJ2luRmxpZ2h0JylgIHdvdWxkIHRyYW5zaXRpb24gdG8gdGhlIGBjcmVhdGVkLmluRmxpZ2h0YCBzdGF0ZSwKICB3aGlsZSBjYWxsaW5nIGB0cmFuc2l0aW9uVG8oJ3VwZGF0ZWQuaW5GbGlnaHQnKWAgd291bGQgdHJhbnNpdGlvbiB0bwogIHRoZSBgdXBkYXRlZC5pbkZsaWdodGAgc3RhdGUuCgogIFJlbWVtYmVyIHRoYXQgKm9ubHkgZXZlbnRzKiBzaG91bGQgZXZlciBjYXVzZSBhIHN0YXRlIHRyYW5zaXRpb24uIFlvdSBzaG91bGQKICBuZXZlciBjYWxsIGB0cmFuc2l0aW9uVG8oKWAgZnJvbSBvdXRzaWRlIGEgc3RhdGUncyBldmVudCBoYW5kbGVyLiBJZiB5b3UgYXJlCiAgdGVtcHRlZCB0byBkbyBzbywgY3JlYXRlIGEgbmV3IGV2ZW50IGFuZCBzZW5kIHRoYXQgdG8gdGhlIHN0YXRlIG1hbmFnZXIuCgogICMjIyMgRmxhZ3MKCiAgRmxhZ3MgYXJlIEJvb2xlYW4gdmFsdWVzIHRoYXQgY2FuIGJlIHVzZWQgdG8gaW50cm9zcGVjdCBhIHJlY29yZCdzIGN1cnJlbnQKICBzdGF0ZSBpbiBhIG1vcmUgdXNlci1mcmllbmRseSB3YXkgdGhhbiBleGFtaW5pbmcgaXRzIHN0YXRlIHBhdGguIEZvciBleGFtcGxlLAogIGluc3RlYWQgb2YgZG9pbmcgdGhpczoKCiAgYGBgamF2YXNjcmlwdAogIHZhciBzdGF0ZVBhdGggPSByZWNvcmQuZ2V0KCdzdGF0ZU1hbmFnZXIuY3VycmVudFBhdGgnKTsKICBpZiAoc3RhdGVQYXRoID09PSAnY3JlYXRlZC5pbkZsaWdodCcpIHsKICAgIGRvU29tZXRoaW5nKCk7CiAgfQogIGBgYAoKICBZb3UgY2FuIHNheToKCiAgYGBgamF2YXNjcmlwdAogIGlmIChyZWNvcmQuZ2V0KCdpc05ldycpICYmIHJlY29yZC5nZXQoJ2lzU2F2aW5nJykpIHsKICAgIGRvU29tZXRoaW5nKCk7CiAgfQogIGBgYAoKICBJZiB5b3VyIHN0YXRlIGRvZXMgbm90IHNldCBhIHZhbHVlIGZvciBhIGdpdmVuIGZsYWcsIHRoZSB2YWx1ZSB3aWxsCiAgYmUgaW5oZXJpdGVkIGZyb20gaXRzIHBhcmVudCAob3IgdGhlIGZpcnN0IHBsYWNlIGluIHRoZSBzdGF0ZSBoaWVyYXJjaHkKICB3aGVyZSBpdCBpcyBkZWZpbmVkKS4KCiAgVGhlIGN1cnJlbnQgc2V0IG9mIGZsYWdzIGFyZSBkZWZpbmVkIGJlbG93LiBJZiB5b3Ugd2FudCB0byBhZGQgYSBuZXcgZmxhZywKICBpbiBhZGRpdGlvbiB0byB0aGUgYXJlYSBiZWxvdywgeW91IHdpbGwgYWxzbyBuZWVkIHRvIGRlY2xhcmUgaXQgaW4gdGhlCiAgYERTLk1vZGVsYCBjbGFzcy4KCgogICAqIFtpc0VtcHR5XShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzRW1wdHkpCiAgICogW2lzTG9hZGluZ10oRFMuTW9kZWwuaHRtbCNwcm9wZXJ0eV9pc0xvYWRpbmcpCiAgICogW2lzTG9hZGVkXShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzTG9hZGVkKQogICAqIFtoYXNEaXJ0eUF0dHJpYnV0ZXNdKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaGFzRGlydHlBdHRyaWJ1dGVzKQogICAqIFtpc1NhdmluZ10oRFMuTW9kZWwuaHRtbCNwcm9wZXJ0eV9pc1NhdmluZykKICAgKiBbaXNEZWxldGVkXShEUy5Nb2RlbC5odG1sI3Byb3BlcnR5X2lzRGVsZXRlZCkKICAgKiBbaXNOZXddKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNOZXcpCiAgICogW2lzVmFsaWRdKERTLk1vZGVsLmh0bWwjcHJvcGVydHlfaXNWYWxpZCkKCiAgQG5hbWVzcGFjZSBEUwogIEBjbGFzcyBSb290U3RhdGUKKi8KCmZ1bmN0aW9uIGRpZFNldFByb3BlcnR5KGludGVybmFsTW9kZWwsIGNvbnRleHQpIHsKICBpZiAoY29udGV4dC52YWx1ZSA9PT0gY29udGV4dC5vcmlnaW5hbFZhbHVlKSB7CiAgICBkZWxldGUgaW50ZXJuYWxNb2RlbC5fYXR0cmlidXRlc1tjb250ZXh0Lm5hbWVdOwogICAgaW50ZXJuYWxNb2RlbC5zZW5kKCdwcm9wZXJ0eVdhc1Jlc2V0JywgY29udGV4dC5uYW1lKTsKICB9IGVsc2UgaWYgKGNvbnRleHQudmFsdWUgIT09IGNvbnRleHQub2xkVmFsdWUpIHsKICAgIGludGVybmFsTW9kZWwuc2VuZCgnYmVjb21lRGlydHknKTsKICB9CgogIGludGVybmFsTW9kZWwudXBkYXRlUmVjb3JkQXJyYXlzKCk7Cn0KCi8vIEltcGxlbWVudGF0aW9uIG5vdGVzOgovLwovLyBFYWNoIHN0YXRlIGhhcyBhIGJvb2xlYW4gdmFsdWUgZm9yIGFsbCBvZiB0aGUgZm9sbG93aW5nIGZsYWdzOgovLwovLyAqIGlzTG9hZGVkOiBUaGUgcmVjb3JkIGhhcyBhIHBvcHVsYXRlZCBgZGF0YWAgcHJvcGVydHkuIFdoZW4gYQovLyAgIHJlY29yZCBpcyBsb2FkZWQgdmlhIGBzdG9yZS5maW5kYCwgYGlzTG9hZGVkYCBpcyBmYWxzZQovLyAgIHVudGlsIHRoZSBhZGFwdGVyIHNldHMgaXQuIFdoZW4gYSByZWNvcmQgaXMgY3JlYXRlZCBsb2NhbGx5LAovLyAgIGl0cyBgaXNMb2FkZWRgIHByb3BlcnR5IGlzIGFsd2F5cyB0cnVlLgovLyAqIGlzRGlydHk6IFRoZSByZWNvcmQgaGFzIGxvY2FsIGNoYW5nZXMgdGhhdCBoYXZlIG5vdCB5ZXQgYmVlbgovLyAgIHNhdmVkIGJ5IHRoZSBhZGFwdGVyLiBUaGlzIGluY2x1ZGVzIHJlY29yZHMgdGhhdCBoYXZlIGJlZW4KLy8gICBjcmVhdGVkIChidXQgbm90IHlldCBzYXZlZCkgb3IgZGVsZXRlZC4KLy8gKiBpc1NhdmluZzogVGhlIHJlY29yZCBoYXMgYmVlbiBjb21taXR0ZWQsIGJ1dAovLyAgIHRoZSBhZGFwdGVyIGhhcyBub3QgeWV0IGFja25vd2xlZGdlZCB0aGF0IHRoZSBjaGFuZ2VzIGhhdmUKLy8gICBiZWVuIHBlcnNpc3RlZCB0byB0aGUgYmFja2VuZC4KLy8gKiBpc0RlbGV0ZWQ6IFRoZSByZWNvcmQgd2FzIG1hcmtlZCBmb3IgZGVsZXRpb24uIFdoZW4gYGlzRGVsZXRlZGAKLy8gICBpcyB0cnVlIGFuZCBgaXNEaXJ0eWAgaXMgdHJ1ZSwgdGhlIHJlY29yZCBpcyBkZWxldGVkIGxvY2FsbHkKLy8gICBidXQgdGhlIGRlbGV0aW9uIHdhcyBub3QgeWV0IHBlcnNpc3RlZC4gV2hlbiBgaXNTYXZpbmdgIGlzCi8vICAgdHJ1ZSwgdGhlIGNoYW5nZSBpcyBpbi1mbGlnaHQuIFdoZW4gYm90aCBgaXNEaXJ0eWAgYW5kCi8vICAgYGlzU2F2aW5nYCBhcmUgZmFsc2UsIHRoZSBjaGFuZ2UgaGFzIHBlcnNpc3RlZC4KLy8gKiBpc05ldzogVGhlIHJlY29yZCB3YXMgY3JlYXRlZCBvbiB0aGUgY2xpZW50IGFuZCB0aGUgYWRhcHRlcgovLyAgIGRpZCBub3QgeWV0IHJlcG9ydCB0aGF0IGl0IHdhcyBzdWNjZXNzZnVsbHkgc2F2ZWQuCi8vICogaXNWYWxpZDogVGhlIGFkYXB0ZXIgZGlkIG5vdCByZXBvcnQgYW55IHNlcnZlci1zaWRlIHZhbGlkYXRpb24KLy8gICBmYWlsdXJlcy4KCi8vIFRoZSBkaXJ0eSBzdGF0ZSBpcyBhIGFic3RyYWN0IHN0YXRlIHdob3NlIGZ1bmN0aW9uYWxpdHkgaXMKLy8gc2hhcmVkIGJldHdlZW4gdGhlIGBjcmVhdGVkYCBhbmQgYHVwZGF0ZWRgIHN0YXRlcy4KLy8KLy8gVGhlIGRlbGV0ZWQgc3RhdGUgc2hhcmVzIHRoZSBgaXNEaXJ0eWAgZmxhZyB3aXRoIHRoZQovLyBzdWJjbGFzc2VzIG9mIGBEaXJ0eVN0YXRlYCwgYnV0IHdpdGggYSB2ZXJ5IGRpZmZlcmVudAovLyBpbXBsZW1lbnRhdGlvbi4KLy8KLy8gRGlydHkgc3RhdGVzIGhhdmUgdGhyZWUgY2hpbGQgc3RhdGVzOgovLwovLyBgdW5jb21taXR0ZWRgOiB0aGUgc3RvcmUgaGFzIG5vdCB5ZXQgaGFuZGVkIG9mZiB0aGUgcmVjb3JkCi8vICAgdG8gYmUgc2F2ZWQuCi8vIGBpbkZsaWdodGA6IHRoZSBzdG9yZSBoYXMgaGFuZGVkIG9mZiB0aGUgcmVjb3JkIHRvIGJlIHNhdmVkLAovLyAgIGJ1dCB0aGUgYWRhcHRlciBoYXMgbm90IHlldCBhY2tub3dsZWRnZWQgc3VjY2Vzcy4KLy8gYGludmFsaWRgOiB0aGUgcmVjb3JkIGhhcyBpbnZhbGlkIGluZm9ybWF0aW9uIGFuZCBjYW5ub3QgYmUKLy8gICBzZW50IHRvIHRoZSBhZGFwdGVyIHlldC4KLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCnZhciBEaXJ0eVN0YXRlID0gewogIGluaXRpYWxTdGF0ZTogJ3VuY29tbWl0dGVkJywKCiAgLy8gRkxBR1MKICBpc0RpcnR5OiB0cnVlLAoKICAvLyBTVUJTVEFURVMKCiAgLy8gV2hlbiBhIHJlY29yZCBmaXJzdCBiZWNvbWVzIGRpcnR5LCBpdCBpcyBgdW5jb21taXR0ZWRgLgogIC8vIFRoaXMgbWVhbnMgdGhhdCB0aGVyZSBhcmUgbG9jYWwgcGVuZGluZyBjaGFuZ2VzLCBidXQgdGhleQogIC8vIGhhdmUgbm90IHlldCBiZWd1biB0byBiZSBzYXZlZCwgYW5kIGFyZSBub3QgaW52YWxpZC4KICB1bmNvbW1pdHRlZDogewogICAgLy8gRVZFTlRTCiAgICBkaWRTZXRQcm9wZXJ0eSwKCiAgICAvL1RPRE8oSWdvcikgcmVsb2FkaW5nIG5vdyB0cmlnZ2VycyBhCiAgICAvL2xvYWRpbmdEYXRhIGV2ZW50LCB0aG91Z2ggaXQgc2VlbXMgZmluZT8KICAgIGxvYWRpbmdEYXRhKCkge30sCgogICAgcHJvcGVydHlXYXNSZXNldChpbnRlcm5hbE1vZGVsLCBuYW1lKSB7CiAgICAgIGlmICghaW50ZXJuYWxNb2RlbC5oYXNDaGFuZ2VkQXR0cmlidXRlcygpKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5zZW5kKCdyb2xsZWRCYWNrJyk7CiAgICAgIH0KICAgIH0sCgogICAgcHVzaGVkRGF0YShpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudXBkYXRlQ2hhbmdlZEF0dHJpYnV0ZXMoKTsKCiAgICAgIGlmICghaW50ZXJuYWxNb2RlbC5oYXNDaGFuZ2VkQXR0cmlidXRlcygpKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgICB9CiAgICB9LAoKICAgIGJlY29tZURpcnR5KCkge30sCgogICAgd2lsbENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdpbkZsaWdodCcpOwogICAgfSwKCiAgICByZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgeyByZXNvbHZlLCBvcHRpb25zIH0pIHsKICAgICAgcmVzb2x2ZShpbnRlcm5hbE1vZGVsLnN0b3JlLl9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykpOwogICAgfSwKCiAgICByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncm9sbGVkQmFjaycpOwogICAgfSwKCiAgICBiZWNhbWVJbnZhbGlkKGludGVybmFsTW9kZWwpIHsKICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2ludmFsaWQnKTsKICAgIH0sCgogICAgcm9sbGJhY2soaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnJvbGxiYWNrQXR0cmlidXRlcygpOwogICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncmVhZHknKTsKICAgIH0KICB9LAoKICAvLyBPbmNlIGEgcmVjb3JkIGhhcyBiZWVuIGhhbmRlZCBvZmYgdG8gdGhlIGFkYXB0ZXIgdG8gYmUKICAvLyBzYXZlZCwgaXQgaXMgaW4gdGhlICdpbiBmbGlnaHQnIHN0YXRlLiBDaGFuZ2VzIHRvIHRoZQogIC8vIHJlY29yZCBjYW5ub3QgYmUgbWFkZSBkdXJpbmcgdGhpcyB3aW5kb3cuCiAgaW5GbGlnaHQ6IHsKICAgIC8vIEZMQUdTCiAgICBpc1NhdmluZzogdHJ1ZSwKCiAgICAvLyBFVkVOVFMKICAgIGRpZFNldFByb3BlcnR5LAogICAgYmVjb21lRGlydHkoKSB7fSwKICAgIHB1c2hlZERhdGEoKSB7fSwKCiAgICB1bmxvYWRSZWNvcmQ6IGFzc2VydEFnYWluc3RVbmxvYWRSZWNvcmQsCgogICAgLy8gVE9ETzogTW9yZSByb2J1c3Qgc2VtYW50aWNzIGFyb3VuZCBzYXZlLXdoaWxlLWluLWZsaWdodAogICAgd2lsbENvbW1pdCgpIHt9LAoKICAgIGRpZENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdzYXZlZCcpOwogICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycsIHRoaXMuZGlydHlUeXBlKTsKICAgIH0sCgogICAgcm9sbGVkQmFjayhpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyb2xsZWRCYWNrJyk7CiAgICB9LAoKICAgIGJlY2FtZUludmFsaWQoaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnaW52YWxpZCcpOwogICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycpOwogICAgfSwKCiAgICBiZWNhbWVFcnJvcihpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1bmNvbW1pdHRlZCcpOwogICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignYmVjYW1lRXJyb3InLCBpbnRlcm5hbE1vZGVsKTsKICAgIH0KICB9LAoKICAvLyBBIHJlY29yZCBpcyBpbiB0aGUgYGludmFsaWRgIGlmIHRoZSBhZGFwdGVyIGhhcyBpbmRpY2F0ZWQKICAvLyB0aGUgdGhlIHJlY29yZCBmYWlsZWQgc2VydmVyLXNpZGUgaW52YWxpZGF0aW9ucy4KICBpbnZhbGlkOiB7CiAgICAvLyBGTEFHUwogICAgaXNWYWxpZDogZmFsc2UsCgogICAgLy8gRVZFTlRTCiAgICBkZWxldGVSZWNvcmQoaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnZGVsZXRlZC51bmNvbW1pdHRlZCcpOwogICAgfSwKCiAgICBkaWRTZXRQcm9wZXJ0eShpbnRlcm5hbE1vZGVsLCBjb250ZXh0KSB7CiAgICAgIGludGVybmFsTW9kZWwucmVtb3ZlRXJyb3JNZXNzYWdlRnJvbUF0dHJpYnV0ZShjb250ZXh0Lm5hbWUpOwoKICAgICAgZGlkU2V0UHJvcGVydHkoaW50ZXJuYWxNb2RlbCwgY29udGV4dCk7CgogICAgICBpZiAoIWludGVybmFsTW9kZWwuaGFzRXJyb3JzKCkpIHsKICAgICAgICB0aGlzLmJlY2FtZVZhbGlkKGludGVybmFsTW9kZWwpOwogICAgICB9CiAgICB9LAoKICAgIGJlY2FtZUludmFsaWQoKSB7fSwKICAgIGJlY29tZURpcnR5KCkge30sCiAgICBwdXNoZWREYXRhKCkge30sCgogICAgd2lsbENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwuY2xlYXJFcnJvck1lc3NhZ2VzKCk7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdpbkZsaWdodCcpOwogICAgfSwKCiAgICByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwogICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncmVhZHknKTsKICAgIH0sCgogICAgYmVjYW1lVmFsaWQoaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygndW5jb21taXR0ZWQnKTsKICAgIH0sCgogICAgaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzKGludGVybmFsTW9kZWwpIHsKICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUludmFsaWQnLCBpbnRlcm5hbE1vZGVsKTsKICAgIH0KICB9Cn07CgovLyBUaGUgY3JlYXRlZCBhbmQgdXBkYXRlZCBzdGF0ZXMgYXJlIGNyZWF0ZWQgb3V0c2lkZSB0aGUgc3RhdGUKLy8gY2hhcnQgc28gd2UgY2FuIHJlb3BlbiB0aGVpciBzdWJzdGF0ZXMgYW5kIGFkZCBtaXhpbnMgYXMKLy8gbmVjZXNzYXJ5LgoKZnVuY3Rpb24gZGVlcENsb25lKG9iamVjdCkgewogIHZhciBjbG9uZSA9IHt9OwogIHZhciB2YWx1ZSA9IHZvaWQgMDsKCiAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIHsKICAgIHZhbHVlID0gb2JqZWN0W3Byb3BdOwogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgY2xvbmVbcHJvcF0gPSBkZWVwQ2xvbmUodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgY2xvbmVbcHJvcF0gPSB2YWx1ZTsKICAgIH0KICB9CgogIHJldHVybiBjbG9uZTsKfQoKZnVuY3Rpb24gbWl4aW4ob3JpZ2luYWwsIGhhc2gpIHsKICBmb3IgKHZhciBwcm9wIGluIGhhc2gpIHsKICAgIG9yaWdpbmFsW3Byb3BdID0gaGFzaFtwcm9wXTsKICB9CgogIHJldHVybiBvcmlnaW5hbDsKfQoKZnVuY3Rpb24gZGlydHlTdGF0ZShvcHRpb25zKSB7CiAgdmFyIG5ld1N0YXRlID0gZGVlcENsb25lKERpcnR5U3RhdGUpOwogIHJldHVybiBtaXhpbihuZXdTdGF0ZSwgb3B0aW9ucyk7Cn0KCnZhciBjcmVhdGVkU3RhdGUgPSBkaXJ0eVN0YXRlKHsKICBkaXJ0eVR5cGU6ICdjcmVhdGVkJywKICAvLyBGTEFHUwogIGlzTmV3OiB0cnVlCn0pOwoKY3JlYXRlZFN0YXRlLmludmFsaWQucm9sbGVkQmFjayA9IGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncm9sbGVkQmFjaycpOwp9OwoKY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLnJvbGxlZEJhY2sgPSBmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdkZWxldGVkLnNhdmVkJyk7CiAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKfTsKCnZhciB1cGRhdGVkU3RhdGUgPSBkaXJ0eVN0YXRlKHsKICBkaXJ0eVR5cGU6ICd1cGRhdGVkJwp9KTsKCmZ1bmN0aW9uIGNyZWF0ZWRTdGF0ZURlbGV0ZVJlY29yZChpbnRlcm5hbE1vZGVsKSB7CiAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKICBpbnRlcm5hbE1vZGVsLnNlbmQoJ2ludm9rZUxpZmVjeWNsZUNhbGxiYWNrcycpOwp9CgpjcmVhdGVkU3RhdGUudW5jb21taXR0ZWQuZGVsZXRlUmVjb3JkID0gY3JlYXRlZFN0YXRlRGVsZXRlUmVjb3JkOwoKY3JlYXRlZFN0YXRlLmludmFsaWQuZGVsZXRlUmVjb3JkID0gY3JlYXRlZFN0YXRlRGVsZXRlUmVjb3JkOwoKY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLnJvbGxiYWNrID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICBEaXJ0eVN0YXRlLnVuY29tbWl0dGVkLnJvbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2RlbGV0ZWQuc2F2ZWQnKTsKfTsKCmNyZWF0ZWRTdGF0ZS51bmNvbW1pdHRlZC5wdXNoZWREYXRhID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnVwZGF0ZWQudW5jb21taXR0ZWQnKTsKICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkTG9hZCcpOwp9OwoKY3JlYXRlZFN0YXRlLnVuY29tbWl0dGVkLnByb3BlcnR5V2FzUmVzZXQgPSBmdW5jdGlvbiAoKSB7fTsKCmZ1bmN0aW9uIGFzc2VydEFnYWluc3RVbmxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCkgewogICh0cnVlICYmICEoZmFsc2UpICYmIEVtYmVyLmFzc2VydCgiWW91IGNhbiBvbmx5IHVubG9hZCBhIHJlY29yZCB3aGljaCBpcyBub3QgaW5GbGlnaHQuIGAiICsgaW50ZXJuYWxNb2RlbCArICJgIiwgZmFsc2UpKTsKfQoKdXBkYXRlZFN0YXRlLmludmFsaWQuYmVjYW1lVmFsaWQgPSBmdW5jdGlvbiAoaW50ZXJuYWxNb2RlbCkgewogIC8vIHdlJ3JlIGVhZ2VybHkgdHJhbnNpdGlvbiBpbnRvIHRoZSBsb2FkZWQuc2F2ZWQgc3RhdGUsIGV2ZW4gdGhvdWdoIHdlIGNvdWxkCiAgLy8gYmUgc3RpbGwgZGlydHk7IGJ1dCB0aGUgc2V0dXAgaG9vayBvZiB0aGUgbG9hZGVkLnNhdmVkIHN0YXRlIGNoZWNrcyBmb3IKICAvLyBkaXJ0eSBhdHRyaWJ1dGVzIGFuZCB0cmFuc2l0aW9ucyBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGRpcnR5IHN0YXRlCiAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2xvYWRlZC5zYXZlZCcpOwp9OwoKdXBkYXRlZFN0YXRlLmluRmxpZ2h0LnVubG9hZFJlY29yZCA9IGFzc2VydEFnYWluc3RVbmxvYWRSZWNvcmQ7Cgp1cGRhdGVkU3RhdGUudW5jb21taXR0ZWQuZGVsZXRlUmVjb3JkID0gZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnZGVsZXRlZC51bmNvbW1pdHRlZCcpOwp9OwoKdXBkYXRlZFN0YXRlLmludmFsaWQucm9sbGVkQmFjayA9IGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKfTsKCnZhciBSb290U3RhdGUgPSB7CiAgLy8gRkxBR1MKICBpc0VtcHR5OiBmYWxzZSwKICBpc0xvYWRpbmc6IGZhbHNlLAogIGlzTG9hZGVkOiBmYWxzZSwKICBpc0RpcnR5OiBmYWxzZSwKICBpc1NhdmluZzogZmFsc2UsCiAgaXNEZWxldGVkOiBmYWxzZSwKICBpc05ldzogZmFsc2UsCiAgaXNWYWxpZDogdHJ1ZSwKCiAgLy8gREVGQVVMVCBFVkVOVFMKCiAgLy8gVHJ5aW5nIHRvIHJvbGwgYmFjayBpZiB5b3UncmUgbm90IGluIHRoZSBkaXJ0eSBzdGF0ZQogIC8vIGRvZXNuJ3QgY2hhbmdlIHlvdXIgc3RhdGUuIEZvciBleGFtcGxlLCBpZiB5b3UncmUgaW4gdGhlCiAgLy8gaW4tZmxpZ2h0IHN0YXRlLCByb2xsaW5nIGJhY2sgdGhlIHJlY29yZCBkb2Vzbid0IG1vdmUKICAvLyB5b3Ugb3V0IG9mIHRoZSBpbi1mbGlnaHQgc3RhdGUuCiAgcm9sbGVkQmFjaygpIHt9LAogIHVubG9hZFJlY29yZChpbnRlcm5hbE1vZGVsKSB7fSwKCiAgcHJvcGVydHlXYXNSZXNldCgpIHt9LAoKICAvLyBTVUJTVEFURVMKCiAgLy8gQSByZWNvcmQgYmVnaW5zIGl0cyBsaWZlY3ljbGUgaW4gdGhlIGBlbXB0eWAgc3RhdGUuCiAgLy8gSWYgaXRzIGRhdGEgd2lsbCBjb21lIGZyb20gdGhlIGFkYXB0ZXIsIGl0IHdpbGwKICAvLyB0cmFuc2l0aW9uIGludG8gdGhlIGBsb2FkaW5nYCBzdGF0ZS4gT3RoZXJ3aXNlLCBpZgogIC8vIHRoZSByZWNvcmQgaXMgYmVpbmcgY3JlYXRlZCBvbiB0aGUgY2xpZW50LCBpdCB3aWxsCiAgLy8gdHJhbnNpdGlvbiBpbnRvIHRoZSBgY3JlYXRlZGAgc3RhdGUuCiAgZW1wdHk6IHsKICAgIGlzRW1wdHk6IHRydWUsCgogICAgLy8gRVZFTlRTCiAgICBsb2FkaW5nRGF0YShpbnRlcm5hbE1vZGVsLCBwcm9taXNlKSB7CiAgICAgIGludGVybmFsTW9kZWwuX3Byb21pc2VQcm94eSA9IHByb21pc2U7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkaW5nJyk7CiAgICB9LAoKICAgIGxvYWRlZERhdGEoaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLmNyZWF0ZWQudW5jb21taXR0ZWQnKTsKICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICB9LAoKICAgIHB1c2hlZERhdGEoaW50ZXJuYWxNb2RlbCkgewogICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdkaWRMb2FkJyk7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdyZWFkeScpOwogICAgfQogIH0sCgogIC8vIEEgcmVjb3JkIGVudGVycyB0aGlzIHN0YXRlIHdoZW4gdGhlIHN0b3JlIGFza3MKICAvLyB0aGUgYWRhcHRlciBmb3IgaXRzIGRhdGEuIEl0IHJlbWFpbnMgaW4gdGhpcyBzdGF0ZQogIC8vIHVudGlsIHRoZSBhZGFwdGVyIHByb3ZpZGVzIHRoZSByZXF1ZXN0ZWQgZGF0YS4KICAvLwogIC8vIFVzdWFsbHksIHRoaXMgcHJvY2VzcyBpcyBhc3luY2hyb25vdXMsIHVzaW5nIGFuCiAgLy8gWEhSIHRvIHJldHJpZXZlIHRoZSBkYXRhLgogIGxvYWRpbmc6IHsKICAgIC8vIEZMQUdTCiAgICBpc0xvYWRpbmc6IHRydWUsCgogICAgZXhpdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwuX3Byb21pc2VQcm94eSA9IG51bGw7CiAgICB9LAoKICAgIC8vIEVWRU5UUwogICAgcHVzaGVkRGF0YShpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdsb2FkZWQuc2F2ZWQnKTsKICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZExvYWQnKTsKICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgIC8vVE9ETyB0aGlzIHNlZW1zIG91dCBvZiBwbGFjZSBoZXJlCiAgICAgIGludGVybmFsTW9kZWwuZGlkQ2xlYW5FcnJvcigpOwogICAgfSwKCiAgICBiZWNhbWVFcnJvcihpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdiZWNhbWVFcnJvcicsIGludGVybmFsTW9kZWwpOwogICAgfSwKCiAgICBub3RGb3VuZChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdlbXB0eScpOwogICAgfQogIH0sCgogIC8vIEEgcmVjb3JkIGVudGVycyB0aGlzIHN0YXRlIHdoZW4gaXRzIGRhdGEgaXMgcG9wdWxhdGVkLgogIC8vIE1vc3Qgb2YgYSByZWNvcmQncyBsaWZlY3ljbGUgaXMgc3BlbnQgaW5zaWRlIHN1YnN0YXRlcwogIC8vIG9mIHRoZSBgbG9hZGVkYCBzdGF0ZS4KICBsb2FkZWQ6IHsKICAgIGluaXRpYWxTdGF0ZTogJ3NhdmVkJywKCiAgICAvLyBGTEFHUwogICAgaXNMb2FkZWQ6IHRydWUsCgogICAgLy9UT0RPKElnb3IpIFJlbG9hZGluZyBub3cgdHJpZ2dlcnMgYSBsb2FkaW5nRGF0YSBldmVudCwKICAgIC8vYnV0IGl0IHNob3VsZCBiZSBvaz8KICAgIGxvYWRpbmdEYXRhKCkge30sCgogICAgLy8gU1VCU1RBVEVTCgogICAgLy8gSWYgdGhlcmUgYXJlIG5vIGxvY2FsIGNoYW5nZXMgdG8gYSByZWNvcmQsIGl0IHJlbWFpbnMKICAgIC8vIGluIHRoZSBgc2F2ZWRgIHN0YXRlLgogICAgc2F2ZWQ6IHsKICAgICAgc2V0dXAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGlmIChpbnRlcm5hbE1vZGVsLmhhc0NoYW5nZWRBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwuYWRhcHRlckRpZERpcnR5KCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLy8gRVZFTlRTCiAgICAgIGRpZFNldFByb3BlcnR5LAoKICAgICAgcHVzaGVkRGF0YSgpIHt9LAoKICAgICAgYmVjb21lRGlydHkoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCd1cGRhdGVkLnVuY29tbWl0dGVkJyk7CiAgICAgIH0sCgogICAgICB3aWxsQ29tbWl0KGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygndXBkYXRlZC5pbkZsaWdodCcpOwogICAgICB9LAoKICAgICAgcmVsb2FkUmVjb3JkKGludGVybmFsTW9kZWwsIHsgcmVzb2x2ZSwgb3B0aW9ucyB9KSB7CiAgICAgICAgcmVzb2x2ZShpbnRlcm5hbE1vZGVsLnN0b3JlLl9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykpOwogICAgICB9LAoKICAgICAgZGVsZXRlUmVjb3JkKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnZGVsZXRlZC51bmNvbW1pdHRlZCcpOwogICAgICB9LAoKICAgICAgdW5sb2FkUmVjb3JkKGludGVybmFsTW9kZWwpIHt9LAoKICAgICAgZGlkQ29tbWl0KCkge30sCgogICAgICAvLyBsb2FkZWQuc2F2ZWQubm90Rm91bmQgd291bGQgYmUgdHJpZ2dlcmVkIGJ5IGEgZmFpbGVkCiAgICAgIC8vIGByZWxvYWQoKWAgb24gYW4gdW5jaGFuZ2VkIHJlY29yZAogICAgICBub3RGb3VuZCgpIHt9CiAgICB9LAoKICAgIC8vIEEgcmVjb3JkIGlzIGluIHRoaXMgc3RhdGUgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9jYWxseQogICAgLy8gY3JlYXRlZCBidXQgYmVmb3JlIHRoZSBhZGFwdGVyIGhhcyBpbmRpY2F0ZWQgdGhhdAogICAgLy8gaXQgaGFzIGJlZW4gc2F2ZWQuCiAgICBjcmVhdGVkOiBjcmVhdGVkU3RhdGUsCgogICAgLy8gQSByZWNvcmQgaXMgaW4gdGhpcyBzdGF0ZSBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAvLyBzYXZlZCB0byB0aGUgc2VydmVyLCBidXQgdGhlcmUgYXJlIG5ldyBsb2NhbCBjaGFuZ2VzCiAgICAvLyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHNhdmVkLgogICAgdXBkYXRlZDogdXBkYXRlZFN0YXRlCiAgfSwKCiAgLy8gQSByZWNvcmQgaXMgaW4gdGhpcyBzdGF0ZSBpZiBpdCB3YXMgZGVsZXRlZCBmcm9tIHRoZSBzdG9yZS4KICBkZWxldGVkOiB7CiAgICBpbml0aWFsU3RhdGU6ICd1bmNvbW1pdHRlZCcsCiAgICBkaXJ0eVR5cGU6ICdkZWxldGVkJywKCiAgICAvLyBGTEFHUwogICAgaXNEZWxldGVkOiB0cnVlLAogICAgaXNMb2FkZWQ6IHRydWUsCiAgICBpc0RpcnR5OiB0cnVlLAoKICAgIC8vIFRSQU5TSVRJT05TCiAgICBzZXR1cChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGludGVybmFsTW9kZWwudXBkYXRlUmVjb3JkQXJyYXlzKCk7CiAgICB9LAoKICAgIC8vIFNVQlNUQVRFUwoKICAgIC8vIFdoZW4gYSByZWNvcmQgaXMgZGVsZXRlZCwgaXQgZW50ZXJzIHRoZSBgc3RhcnRgCiAgICAvLyBzdGF0ZS4gSXQgd2lsbCBleGl0IHRoaXMgc3RhdGUgd2hlbiB0aGUgcmVjb3JkCiAgICAvLyBzdGFydHMgdG8gY29tbWl0LgogICAgdW5jb21taXR0ZWQ6IHsKCiAgICAgIC8vIEVWRU5UUwoKICAgICAgd2lsbENvbW1pdChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ2luRmxpZ2h0Jyk7CiAgICAgIH0sCgogICAgICByb2xsYmFjayhpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5yb2xsYmFja0F0dHJpYnV0ZXMoKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcigncmVhZHknKTsKICAgICAgfSwKCiAgICAgIHB1c2hlZERhdGEoKSB7fSwKICAgICAgYmVjb21lRGlydHkoKSB7fSwKICAgICAgZGVsZXRlUmVjb3JkKCkge30sCgogICAgICByb2xsZWRCYWNrKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JvbGxlZEJhY2snKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBBZnRlciBhIHJlY29yZCBzdGFydHMgY29tbWl0dGluZywgYnV0CiAgICAvLyBiZWZvcmUgdGhlIGFkYXB0ZXIgaW5kaWNhdGVzIHRoYXQgdGhlIGRlbGV0aW9uCiAgICAvLyBoYXMgc2F2ZWQgdG8gdGhlIHNlcnZlciwgYSByZWNvcmQgaXMgaW4gdGhlCiAgICAvLyBgaW5GbGlnaHRgIHN1YnN0YXRlIG9mIGBkZWxldGVkYC4KICAgIGluRmxpZ2h0OiB7CiAgICAgIC8vIEZMQUdTCiAgICAgIGlzU2F2aW5nOiB0cnVlLAoKICAgICAgLy8gRVZFTlRTCgogICAgICB1bmxvYWRSZWNvcmQ6IGFzc2VydEFnYWluc3RVbmxvYWRSZWNvcmQsCgogICAgICAvLyBUT0RPOiBNb3JlIHJvYnVzdCBzZW1hbnRpY3MgYXJvdW5kIHNhdmUtd2hpbGUtaW4tZmxpZ2h0CiAgICAgIHdpbGxDb21taXQoKSB7fSwKICAgICAgZGlkQ29tbWl0KGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25Ubygnc2F2ZWQnKTsKCiAgICAgICAgaW50ZXJuYWxNb2RlbC5zZW5kKCdpbnZva2VMaWZlY3ljbGVDYWxsYmFja3MnKTsKICAgICAgfSwKCiAgICAgIGJlY2FtZUVycm9yKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygndW5jb21taXR0ZWQnKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignYmVjYW1lRXJyb3InLCBpbnRlcm5hbE1vZGVsKTsKICAgICAgfSwKCiAgICAgIGJlY2FtZUludmFsaWQoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIGludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKCdpbnZhbGlkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2JlY2FtZUludmFsaWQnLCBpbnRlcm5hbE1vZGVsKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBPbmNlIHRoZSBhZGFwdGVyIGluZGljYXRlcyB0aGF0IHRoZSBkZWxldGlvbiBoYXMKICAgIC8vIGJlZW4gc2F2ZWQsIHRoZSByZWNvcmQgZW50ZXJzIHRoZSBgc2F2ZWRgIHN1YnN0YXRlCiAgICAvLyBvZiBgZGVsZXRlZGAuCiAgICBzYXZlZDogewogICAgICAvLyBGTEFHUwogICAgICBpc0RpcnR5OiBmYWxzZSwKCiAgICAgIHNldHVwKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcygpOwogICAgICB9LAoKICAgICAgaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzKGludGVybmFsTW9kZWwpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkRGVsZXRlJywgaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ2RpZENvbW1pdCcsIGludGVybmFsTW9kZWwpOwogICAgICB9LAoKICAgICAgd2lsbENvbW1pdCgpIHt9LAogICAgICBkaWRDb21taXQoKSB7fSwKICAgICAgcHVzaGVkRGF0YSgpIHt9CiAgICB9LAoKICAgIGludmFsaWQ6IHsKICAgICAgaXNWYWxpZDogZmFsc2UsCgogICAgICBkaWRTZXRQcm9wZXJ0eShpbnRlcm5hbE1vZGVsLCBjb250ZXh0KSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5yZW1vdmVFcnJvck1lc3NhZ2VGcm9tQXR0cmlidXRlKGNvbnRleHQubmFtZSk7CgogICAgICAgIGRpZFNldFByb3BlcnR5KGludGVybmFsTW9kZWwsIGNvbnRleHQpOwoKICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuaGFzRXJyb3JzKCkpIHsKICAgICAgICAgIHRoaXMuYmVjYW1lVmFsaWQoaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgYmVjYW1lSW52YWxpZCgpIHt9LAogICAgICBiZWNvbWVEaXJ0eSgpIHt9LAogICAgICBkZWxldGVSZWNvcmQoKSB7fSwKICAgICAgd2lsbENvbW1pdCgpIHt9LAoKICAgICAgcm9sbGVkQmFjayhpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC5jbGVhckVycm9yTWVzc2FnZXMoKTsKICAgICAgICBpbnRlcm5hbE1vZGVsLnRyYW5zaXRpb25UbygnbG9hZGVkLnNhdmVkJyk7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmlnZ2VyTGF0ZXIoJ3JlYWR5Jyk7CiAgICAgIH0sCgogICAgICBiZWNhbWVWYWxpZChpbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgaW50ZXJuYWxNb2RlbC50cmFuc2l0aW9uVG8oJ3VuY29tbWl0dGVkJyk7CiAgICAgIH0KCiAgICB9CiAgfSwKCiAgaW52b2tlTGlmZWN5Y2xlQ2FsbGJhY2tzKGludGVybmFsTW9kZWwsIGRpcnR5VHlwZSkgewogICAgaWYgKGRpcnR5VHlwZSA9PT0gJ2NyZWF0ZWQnKSB7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdkaWRDcmVhdGUnLCBpbnRlcm5hbE1vZGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIGludGVybmFsTW9kZWwudHJpZ2dlckxhdGVyKCdkaWRVcGRhdGUnLCBpbnRlcm5hbE1vZGVsKTsKICAgIH0KCiAgICBpbnRlcm5hbE1vZGVsLnRyaWdnZXJMYXRlcignZGlkQ29tbWl0JywgaW50ZXJuYWxNb2RlbCk7CiAgfQp9OwoKZnVuY3Rpb24gd2lyZVN0YXRlKG9iamVjdCwgcGFyZW50LCBuYW1lKSB7CiAgLy8gVE9ETzogVXNlIE9iamVjdC5jcmVhdGUgYW5kIGNvcHkgaW5zdGVhZAogIG9iamVjdCA9IG1peGluKHBhcmVudCA/IE9iamVjdC5jcmVhdGUocGFyZW50KSA6IHt9LCBvYmplY3QpOwogIG9iamVjdC5wYXJlbnRTdGF0ZSA9IHBhcmVudDsKICBvYmplY3Quc3RhdGVOYW1lID0gbmFtZTsKCiAgZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIHsKICAgIGlmICghb2JqZWN0Lmhhc093blByb3BlcnR5KHByb3ApIHx8IHByb3AgPT09ICdwYXJlbnRTdGF0ZScgfHwgcHJvcCA9PT0gJ3N0YXRlTmFtZScpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBpZiAodHlwZW9mIG9iamVjdFtwcm9wXSA9PT0gJ29iamVjdCcpIHsKICAgICAgb2JqZWN0W3Byb3BdID0gd2lyZVN0YXRlKG9iamVjdFtwcm9wXSwgb2JqZWN0LCBuYW1lICsgJy4nICsgcHJvcCk7CiAgICB9CiAgfQoKICByZXR1cm4gb2JqZWN0Owp9Cgp2YXIgUm9vdFN0YXRlJDEgPSB3aXJlU3RhdGUoUm9vdFN0YXRlLCBudWxsLCAncm9vdCcpOwoKLy8gQWxsIG1vZGVsTmFtZXMgYXJlIGRhc2hlcml6ZWQgaW50ZXJuYWxseS4gQ2hhbmdpbmcgdGhpcyBmdW5jdGlvbiBtYXkKLy8gcmVxdWlyZSBjaGFuZ2VzIHRvIG90aGVyIG5vcm1hbGl6YXRpb24gaG9va3MgKHN1Y2ggYXMgdHlwZUZvclJvb3QpLgoKLyoqCiBUaGlzIG1ldGhvZCBub3JtYWxpemVzIGEgbW9kZWxOYW1lIGludG8gdGhlIGZvcm1hdCBFbWJlciBEYXRhIHVzZXMKIGludGVybmFsbHkuCgogIEBtZXRob2Qgbm9ybWFsaXplTW9kZWxOYW1lCiAgQHB1YmxpYwogIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICBAcmV0dXJuIHtTdHJpbmd9IG5vcm1hbGl6ZWRNb2RlbE5hbWUKICBAZm9yIERTCiovCmZ1bmN0aW9uIG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpIHsKICByZXR1cm4gRW1iZXIuU3RyaW5nLmRhc2hlcml6ZShtb2RlbE5hbWUpOwp9CgpmdW5jdGlvbiB0eXBlRm9yUmVsYXRpb25zaGlwTWV0YShtZXRhKSB7CiAgdmFyIG1vZGVsTmFtZSA9IHZvaWQgMDsKCiAgbW9kZWxOYW1lID0gbWV0YS50eXBlIHx8IG1ldGEua2V5OwogIGlmIChtZXRhLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgbW9kZWxOYW1lID0gZW1iZXJJbmZsZWN0b3Iuc2luZ3VsYXJpemUobm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSkpOwogIH0KICByZXR1cm4gbW9kZWxOYW1lOwp9CgpmdW5jdGlvbiByZWxhdGlvbnNoaXBGcm9tTWV0YShtZXRhKSB7CiAgcmV0dXJuIHsKICAgIGtleTogbWV0YS5rZXksCiAgICBraW5kOiBtZXRhLmtpbmQsCiAgICB0eXBlOiB0eXBlRm9yUmVsYXRpb25zaGlwTWV0YShtZXRhKSwKICAgIG9wdGlvbnM6IG1ldGEub3B0aW9ucywKICAgIG5hbWU6IG1ldGEubmFtZSwKICAgIHBhcmVudFR5cGU6IG1ldGEucGFyZW50VHlwZSwKICAgIGlzUmVsYXRpb25zaGlwOiB0cnVlCiAgfTsKfQoKdmFyIHJlbGF0aW9uc2hpcHNEZXNjcmlwdG9yID0gRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogIHZhciBtYXAgPSBuZXcgTWFwV2l0aERlZmF1bHQoewogICAgZGVmYXVsdFZhbHVlKCkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgfSk7CgogIC8vIExvb3AgdGhyb3VnaCBlYWNoIGNvbXB1dGVkIHByb3BlcnR5IG9uIHRoZSBjbGFzcwogIHRoaXMuZWFjaENvbXB1dGVkUHJvcGVydHkoKG5hbWUsIG1ldGEpID0+IHsKICAgIC8vIElmIHRoZSBjb21wdXRlZCBwcm9wZXJ0eSBpcyBhIHJlbGF0aW9uc2hpcCwgYWRkCiAgICAvLyBpdCB0byB0aGUgbWFwLgogICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgbWV0YS5rZXkgPSBuYW1lOwogICAgICB2YXIgcmVsYXRpb25zaGlwc0ZvclR5cGUgPSBtYXAuZ2V0KHR5cGVGb3JSZWxhdGlvbnNoaXBNZXRhKG1ldGEpKTsKCiAgICAgIHJlbGF0aW9uc2hpcHNGb3JUeXBlLnB1c2goewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAga2luZDogbWV0YS5raW5kCiAgICAgIH0pOwogICAgfQogIH0pOwoKICByZXR1cm4gbWFwOwp9KS5yZWFkT25seSgpOwoKdmFyIHJlbGF0ZWRUeXBlc0Rlc2NyaXB0b3IgPSBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgdmFyIG1vZGVsTmFtZSA9IHZvaWQgMDsKICB2YXIgdHlwZXMgPSBFbWJlci5BKCk7CgogIC8vIExvb3AgdGhyb3VnaCBlYWNoIGNvbXB1dGVkIHByb3BlcnR5IG9uIHRoZSBjbGFzcywKICAvLyBhbmQgY3JlYXRlIGFuIGFycmF5IG9mIHRoZSB1bmlxdWUgdHlwZXMgaW52b2x2ZWQKICAvLyBpbiByZWxhdGlvbnNoaXBzCiAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eSgobmFtZSwgbWV0YSkgPT4gewogICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgbWV0YS5rZXkgPSBuYW1lOwogICAgICBtb2RlbE5hbWUgPSB0eXBlRm9yUmVsYXRpb25zaGlwTWV0YShtZXRhKTsKCiAgICAgICh0cnVlICYmICEobW9kZWxOYW1lKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBzcGVjaWZpZWQgYSBoYXNNYW55ICgke21ldGEudHlwZX0pIG9uICR7bWV0YS5wYXJlbnRUeXBlfSBidXQgJHttZXRhLnR5cGV9IHdhcyBub3QgZm91bmQuYCwgbW9kZWxOYW1lKSk7CgoKICAgICAgaWYgKCF0eXBlcy5pbmNsdWRlcyhtb2RlbE5hbWUpKSB7CiAgICAgICAgKHRydWUgJiYgISghIW1vZGVsTmFtZSkgJiYgRW1iZXIuYXNzZXJ0KGBUcnlpbmcgdG8gc2lkZWxvYWQgJHtuYW1lfSBvbiAke3RoaXMudG9TdHJpbmcoKX0gYnV0IHRoZSB0eXBlIGRvZXNuJ3QgZXhpc3QuYCwgISFtb2RlbE5hbWUpKTsKCiAgICAgICAgdHlwZXMucHVzaChtb2RlbE5hbWUpOwogICAgICB9CiAgICB9CiAgfSk7CgogIHJldHVybiB0eXBlczsKfSkucmVhZE9ubHkoKTsKCnZhciByZWxhdGlvbnNoaXBzQnlOYW1lRGVzY3JpcHRvciA9IEVtYmVyLmNvbXB1dGVkKGZ1bmN0aW9uICgpIHsKICB2YXIgbWFwID0gbmV3IE1hcFdpdGhEZXByZWNhdGlvbnMoKTsKCiAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eSgobmFtZSwgbWV0YSkgPT4gewogICAgaWYgKG1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgbWV0YS5rZXkgPSBuYW1lOwogICAgICB2YXIgcmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwRnJvbU1ldGEobWV0YSk7CiAgICAgIHJlbGF0aW9uc2hpcC50eXBlID0gdHlwZUZvclJlbGF0aW9uc2hpcE1ldGEobWV0YSk7CiAgICAgIG1hcC5zZXQobmFtZSwgcmVsYXRpb25zaGlwKTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIG1hcDsKfSkucmVhZE9ubHkoKTsKCnZhciB7IGNoYW5nZVByb3BlcnRpZXMgfSA9IEVtYmVyOwoKLyoqCiAgQG1vZHVsZSBlbWJlci1kYXRhCiovCgpmdW5jdGlvbiBmaW5kUG9zc2libGVJbnZlcnNlcyh0eXBlLCBpbnZlcnNlVHlwZSwgbmFtZSwgcmVsYXRpb25zaGlwc1NvRmFyKSB7CiAgdmFyIHBvc3NpYmxlUmVsYXRpb25zaGlwcyA9IHJlbGF0aW9uc2hpcHNTb0ZhciB8fCBbXTsKCiAgdmFyIHJlbGF0aW9uc2hpcE1hcCA9IEVtYmVyLmdldChpbnZlcnNlVHlwZSwgJ3JlbGF0aW9uc2hpcHMnKTsKICBpZiAoIXJlbGF0aW9uc2hpcE1hcCkgewogICAgcmV0dXJuIHBvc3NpYmxlUmVsYXRpb25zaGlwczsKICB9CgogIHZhciByZWxhdGlvbnNoaXBzID0gcmVsYXRpb25zaGlwTWFwLmdldCh0eXBlLm1vZGVsTmFtZSkuZmlsdGVyKHJlbGF0aW9uc2hpcCA9PiB7CiAgICB2YXIgb3B0aW9uc0ZvclJlbGF0aW9uc2hpcCA9IGludmVyc2VUeXBlLm1ldGFGb3JQcm9wZXJ0eShyZWxhdGlvbnNoaXAubmFtZSkub3B0aW9uczsKCiAgICBpZiAoIW9wdGlvbnNGb3JSZWxhdGlvbnNoaXAuaW52ZXJzZSAmJiBvcHRpb25zRm9yUmVsYXRpb25zaGlwLmludmVyc2UgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIG5hbWUgPT09IG9wdGlvbnNGb3JSZWxhdGlvbnNoaXAuaW52ZXJzZTsKICB9KTsKCiAgaWYgKHJlbGF0aW9uc2hpcHMpIHsKICAgIHBvc3NpYmxlUmVsYXRpb25zaGlwcy5wdXNoLmFwcGx5KHBvc3NpYmxlUmVsYXRpb25zaGlwcywgcmVsYXRpb25zaGlwcyk7CiAgfQoKICAvL1JlY3Vyc2UgdG8gc3VwcG9ydCBwb2x5bW9ycGhpc20KICBpZiAodHlwZS5zdXBlcmNsYXNzKSB7CiAgICBmaW5kUG9zc2libGVJbnZlcnNlcyh0eXBlLnN1cGVyY2xhc3MsIGludmVyc2VUeXBlLCBuYW1lLCBwb3NzaWJsZVJlbGF0aW9uc2hpcHMpOwogIH0KCiAgcmV0dXJuIHBvc3NpYmxlUmVsYXRpb25zaGlwczsKfQoKZnVuY3Rpb24gaW50ZXJzZWN0aW9uKGFycmF5MSwgYXJyYXkyKSB7CiAgdmFyIHJlc3VsdCA9IFtdOwogIGFycmF5MS5mb3JFYWNoKGVsZW1lbnQgPT4gewogICAgaWYgKGFycmF5Mi5pbmRleE9mKGVsZW1lbnQpID49IDApIHsKICAgICAgcmVzdWx0LnB1c2goZWxlbWVudCk7CiAgICB9CiAgfSk7CgogIHJldHVybiByZXN1bHQ7Cn0KCnZhciBSRVNFUlZFRF9NT0RFTF9QUk9QUyA9IFsnY3VycmVudFN0YXRlJywgJ2RhdGEnLCAnc3RvcmUnXTsKCnZhciByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUgPSBFbWJlci5jb21wdXRlZCgnY3VycmVudFN0YXRlJywgZnVuY3Rpb24gKGtleSkgewogIHJldHVybiBFbWJlci5nZXQodGhpcy5faW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUsIGtleSk7Cn0pLnJlYWRPbmx5KCk7CgovKioKCiAgVGhlIG1vZGVsIGNsYXNzIHRoYXQgYWxsIEVtYmVyIERhdGEgcmVjb3JkcyBkZXNjZW5kIGZyb20uCiAgVGhpcyBpcyB0aGUgcHVibGljIEFQSSBvZiBFbWJlciBEYXRhIG1vZGVscy4gSWYgeW91IGFyZSB1c2luZyBFbWJlciBEYXRhCiAgaW4geW91ciBhcHBsaWNhdGlvbiwgdGhpcyBpcyB0aGUgY2xhc3MgeW91IHNob3VsZCB1c2UuCiAgSWYgeW91IGFyZSB3b3JraW5nIG9uIEVtYmVyIERhdGEgaW50ZXJuYWxzLCB5b3UgbW9zdCBsaWtlbHkgd2FudCB0byBiZSBkZWFsaW5nCiAgd2l0aCBgSW50ZXJuYWxNb2RlbGAKCiAgQGNsYXNzIE1vZGVsCiAgQG5hbWVzcGFjZSBEUwogIEBleHRlbmRzIEVtYmVyLk9iamVjdAogIEB1c2VzIEVtYmVyLkV2ZW50ZWQKKi8KdmFyIE1vZGVsID0gRW1iZXIuT2JqZWN0LmV4dGVuZChFbWJlci5FdmVudGVkLCB7CiAgX2ludGVybmFsTW9kZWw6IG51bGwsCiAgc3RvcmU6IG51bGwsCiAgX19kZWZpbmVOb25FbnVtZXJhYmxlKHByb3BlcnR5KSB7CiAgICB0aGlzW3Byb3BlcnR5Lm5hbWVdID0gcHJvcGVydHkuZGVzY3JpcHRvci52YWx1ZTsKICB9LAoKICAvKioKICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBlbXB0eWAKICAgIHN0YXRlLiBFbXB0eSBpcyB0aGUgZmlyc3Qgc3RhdGUgYWxsIHJlY29yZHMgZW50ZXIgYWZ0ZXIgdGhleSBoYXZlCiAgICBiZWVuIGNyZWF0ZWQuIE1vc3QgcmVjb3JkcyBjcmVhdGVkIGJ5IHRoZSBzdG9yZSB3aWxsIHF1aWNrbHkKICAgIHRyYW5zaXRpb24gdG8gdGhlIGBsb2FkaW5nYCBzdGF0ZSBpZiBkYXRhIG5lZWRzIHRvIGJlIGZldGNoZWQgZnJvbQogICAgdGhlIHNlcnZlciBvciB0aGUgYGNyZWF0ZWRgIHN0YXRlIGlmIHRoZSByZWNvcmQgaXMgY3JlYXRlZCBvbiB0aGUKICAgIGNsaWVudC4gQSByZWNvcmQgY2FuIGFsc28gZW50ZXIgdGhlIGVtcHR5IHN0YXRlIGlmIHRoZSBhZGFwdGVyIGlzCiAgICB1bmFibGUgdG8gbG9jYXRlIHRoZSByZWNvcmQuCiAgICAgQHByb3BlcnR5IGlzRW1wdHkKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0VtcHR5OiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgbG9hZGluZ2Agc3RhdGUuIEEKICAgIHJlY29yZCBlbnRlcnMgdGhpcyBzdGF0ZSB3aGVuIHRoZSBzdG9yZSBhc2tzIHRoZSBhZGFwdGVyIGZvciBpdHMKICAgIGRhdGEuIEl0IHJlbWFpbnMgaW4gdGhpcyBzdGF0ZSB1bnRpbCB0aGUgYWRhcHRlciBwcm92aWRlcyB0aGUKICAgIHJlcXVlc3RlZCBkYXRhLgogICAgIEBwcm9wZXJ0eSBpc0xvYWRpbmcKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0xvYWRpbmc6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKICAvKioKICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBsb2FkZWRgIHN0YXRlLiBBCiAgICByZWNvcmQgZW50ZXJzIHRoaXMgc3RhdGUgd2hlbiBpdHMgZGF0YSBpcyBwb3B1bGF0ZWQuIE1vc3Qgb2YgYQogICAgcmVjb3JkJ3MgbGlmZWN5Y2xlIGlzIHNwZW50IGluc2lkZSBzdWJzdGF0ZXMgb2YgdGhlIGBsb2FkZWRgCiAgICBzdGF0ZS4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2lzTG9hZGVkJyk7IC8vIHRydWUKICAgICBzdG9yZS5maW5kUmVjb3JkKCdtb2RlbCcsIDEpLnRoZW4oZnVuY3Rpb24obW9kZWwpIHsKICAgICAgbW9kZWwuZ2V0KCdpc0xvYWRlZCcpOyAvLyB0cnVlCiAgICB9KTsKICAgIGBgYAogICAgIEBwcm9wZXJ0eSBpc0xvYWRlZAogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzTG9hZGVkOiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgZGlydHlgIHN0YXRlLiBUaGUKICAgIHJlY29yZCBoYXMgbG9jYWwgY2hhbmdlcyB0aGF0IGhhdmUgbm90IHlldCBiZWVuIHNhdmVkIGJ5IHRoZQogICAgYWRhcHRlci4gVGhpcyBpbmNsdWRlcyByZWNvcmRzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQgKGJ1dCBub3QgeWV0CiAgICBzYXZlZCkgb3IgZGVsZXRlZC4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2hhc0RpcnR5QXR0cmlidXRlcycpOyAvLyB0cnVlCiAgICAgc3RvcmUuZmluZFJlY29yZCgnbW9kZWwnLCAxKS50aGVuKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIG1vZGVsLmdldCgnaGFzRGlydHlBdHRyaWJ1dGVzJyk7IC8vIGZhbHNlCiAgICAgIG1vZGVsLnNldCgnZm9vJywgJ3NvbWUgdmFsdWUnKTsKICAgICAgbW9kZWwuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKTsgLy8gdHJ1ZQogICAgfSk7CiAgICBgYGAKICAgICBAc2luY2UgMS4xMy4wCiAgICBAcHJvcGVydHkgaGFzRGlydHlBdHRyaWJ1dGVzCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaGFzRGlydHlBdHRyaWJ1dGVzOiBFbWJlci5jb21wdXRlZCgnY3VycmVudFN0YXRlLmlzRGlydHknLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXQoJ2N1cnJlbnRTdGF0ZS5pc0RpcnR5Jyk7CiAgfSksCiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgc2F2aW5nYCBzdGF0ZS4gQQogICAgcmVjb3JkIGVudGVycyB0aGUgc2F2aW5nIHN0YXRlIHdoZW4gYHNhdmVgIGlzIGNhbGxlZCwgYnV0IHRoZQogICAgYWRhcHRlciBoYXMgbm90IHlldCBhY2tub3dsZWRnZWQgdGhhdCB0aGUgY2hhbmdlcyBoYXZlIGJlZW4KICAgIHBlcnNpc3RlZCB0byB0aGUgYmFja2VuZC4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2lzU2F2aW5nJyk7IC8vIGZhbHNlCiAgICBsZXQgcHJvbWlzZSA9IHJlY29yZC5zYXZlKCk7CiAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAvLyB0cnVlCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJlY29yZC5nZXQoJ2lzU2F2aW5nJyk7IC8vIGZhbHNlCiAgICB9KTsKICAgIGBgYAogICAgIEBwcm9wZXJ0eSBpc1NhdmluZwogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzU2F2aW5nOiByZXRyaWV2ZUZyb21DdXJyZW50U3RhdGUsCiAgLyoqCiAgICBJZiB0aGlzIHByb3BlcnR5IGlzIGB0cnVlYCB0aGUgcmVjb3JkIGlzIGluIHRoZSBgZGVsZXRlZGAgc3RhdGUKICAgIGFuZCBoYXMgYmVlbiBtYXJrZWQgZm9yIGRlbGV0aW9uLiBXaGVuIGBpc0RlbGV0ZWRgIGlzIHRydWUgYW5kCiAgICBgaGFzRGlydHlBdHRyaWJ1dGVzYCBpcyB0cnVlLCB0aGUgcmVjb3JkIGlzIGRlbGV0ZWQgbG9jYWxseSBidXQgdGhlIGRlbGV0aW9uCiAgICB3YXMgbm90IHlldCBwZXJzaXN0ZWQuIFdoZW4gYGlzU2F2aW5nYCBpcyB0cnVlLCB0aGUgY2hhbmdlIGlzCiAgICBpbi1mbGlnaHQuIFdoZW4gYm90aCBgaGFzRGlydHlBdHRyaWJ1dGVzYCBhbmQgYGlzU2F2aW5nYCBhcmUgZmFsc2UsIHRoZQogICAgY2hhbmdlIGhhcyBwZXJzaXN0ZWQuCiAgICAgRXhhbXBsZQogICAgIGBgYGphdmFzY3JpcHQKICAgIGxldCByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQoJ21vZGVsJyk7CiAgICByZWNvcmQuZ2V0KCdpc0RlbGV0ZWQnKTsgICAgLy8gZmFsc2UKICAgIHJlY29yZC5kZWxldGVSZWNvcmQoKTsKICAgICAvLyBMb2NhbGx5IGRlbGV0ZWQKICAgIHJlY29yZC5nZXQoJ2lzRGVsZXRlZCcpOyAgICAgICAgICAgLy8gdHJ1ZQogICAgcmVjb3JkLmdldCgnaGFzRGlydHlBdHRyaWJ1dGVzJyk7ICAvLyB0cnVlCiAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAgICAgICAgICAgIC8vIGZhbHNlCiAgICAgLy8gUGVyc2lzdGluZyB0aGUgZGVsZXRpb24KICAgIGxldCBwcm9taXNlID0gcmVjb3JkLnNhdmUoKTsKICAgIHJlY29yZC5nZXQoJ2lzRGVsZXRlZCcpOyAgICAvLyB0cnVlCiAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAgICAgLy8gdHJ1ZQogICAgIC8vIERlbGV0aW9uIFBlcnNpc3RlZAogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZWNvcmQuZ2V0KCdpc0RlbGV0ZWQnKTsgICAgICAgICAgLy8gdHJ1ZQogICAgICByZWNvcmQuZ2V0KCdpc1NhdmluZycpOyAgICAgICAgICAgLy8gZmFsc2UKICAgICAgcmVjb3JkLmdldCgnaGFzRGlydHlBdHRyaWJ1dGVzJyk7IC8vIGZhbHNlCiAgICB9KTsKICAgIGBgYAogICAgIEBwcm9wZXJ0eSBpc0RlbGV0ZWQKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0RlbGV0ZWQ6IHJldHJpZXZlRnJvbUN1cnJlbnRTdGF0ZSwKICAvKioKICAgIElmIHRoaXMgcHJvcGVydHkgaXMgYHRydWVgIHRoZSByZWNvcmQgaXMgaW4gdGhlIGBuZXdgIHN0YXRlLiBBCiAgICByZWNvcmQgd2lsbCBiZSBpbiB0aGUgYG5ld2Agc3RhdGUgd2hlbiBpdCBoYXMgYmVlbiBjcmVhdGVkIG9uIHRoZQogICAgY2xpZW50IGFuZCB0aGUgYWRhcHRlciBoYXMgbm90IHlldCByZXBvcnQgdGhhdCBpdCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICBzYXZlZC4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2lzTmV3Jyk7IC8vIHRydWUKICAgICByZWNvcmQuc2F2ZSgpLnRoZW4oZnVuY3Rpb24obW9kZWwpIHsKICAgICAgbW9kZWwuZ2V0KCdpc05ldycpOyAvLyBmYWxzZQogICAgfSk7CiAgICBgYGAKICAgICBAcHJvcGVydHkgaXNOZXcKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc05ldzogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhpcyBwcm9wZXJ0eSBpcyBgdHJ1ZWAgdGhlIHJlY29yZCBpcyBpbiB0aGUgYHZhbGlkYCBzdGF0ZS4KICAgICBBIHJlY29yZCB3aWxsIGJlIGluIHRoZSBgdmFsaWRgIHN0YXRlIHdoZW4gdGhlIGFkYXB0ZXIgZGlkIG5vdCByZXBvcnQgYW55CiAgICBzZXJ2ZXItc2lkZSB2YWxpZGF0aW9uIGZhaWx1cmVzLgogICAgIEBwcm9wZXJ0eSBpc1ZhbGlkCiAgICBAdHlwZSB7Qm9vbGVhbn0KICAgIEByZWFkT25seQogICovCiAgaXNWYWxpZDogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAogIC8qKgogICAgSWYgdGhlIHJlY29yZCBpcyBpbiB0aGUgZGlydHkgc3RhdGUgdGhpcyBwcm9wZXJ0eSB3aWxsIHJlcG9ydCB3aGF0CiAgICBraW5kIG9mIGNoYW5nZSBoYXMgY2F1c2VkIGl0IHRvIG1vdmUgaW50byB0aGUgZGlydHkKICAgIHN0YXRlLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAgIC0gYGNyZWF0ZWRgIFRoZSByZWNvcmQgaGFzIGJlZW4gY3JlYXRlZCBieSB0aGUgY2xpZW50IGFuZCBub3QgeWV0IHNhdmVkIHRvIHRoZSBhZGFwdGVyLgogICAgLSBgdXBkYXRlZGAgVGhlIHJlY29yZCBoYXMgYmVlbiB1cGRhdGVkIGJ5IHRoZSBjbGllbnQgYW5kIG5vdCB5ZXQgc2F2ZWQgdG8gdGhlIGFkYXB0ZXIuCiAgICAtIGBkZWxldGVkYCBUaGUgcmVjb3JkIGhhcyBiZWVuIGRlbGV0ZWQgYnkgdGhlIGNsaWVudCBhbmQgbm90IHlldCBzYXZlZCB0byB0aGUgYWRhcHRlci4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2RpcnR5VHlwZScpOyAvLyAnY3JlYXRlZCcKICAgIGBgYAogICAgIEBwcm9wZXJ0eSBkaXJ0eVR5cGUKICAgIEB0eXBlIHtTdHJpbmd9CiAgICBAcmVhZE9ubHkKICAqLwogIGRpcnR5VHlwZTogcmV0cmlldmVGcm9tQ3VycmVudFN0YXRlLAoKICAvKioKICAgIElmIGB0cnVlYCB0aGUgYWRhcHRlciByZXBvcnRlZCB0aGF0IGl0IHdhcyB1bmFibGUgdG8gc2F2ZSBsb2NhbAogICAgY2hhbmdlcyB0byB0aGUgYmFja2VuZCBmb3IgYW55IHJlYXNvbiBvdGhlciB0aGFuIGEgc2VydmVyLXNpZGUKICAgIHZhbGlkYXRpb24gZXJyb3IuCiAgICAgRXhhbXBsZQogICAgIGBgYGphdmFzY3JpcHQKICAgIHJlY29yZC5nZXQoJ2lzRXJyb3InKTsgLy8gZmFsc2UKICAgIHJlY29yZC5zZXQoJ2ZvbycsICd2YWxpZCB2YWx1ZScpOwogICAgcmVjb3JkLnNhdmUoKS50aGVuKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICByZWNvcmQuZ2V0KCdpc0Vycm9yJyk7IC8vIHRydWUKICAgIH0pOwogICAgYGBgCiAgICAgQHByb3BlcnR5IGlzRXJyb3IKICAgIEB0eXBlIHtCb29sZWFufQogICAgQHJlYWRPbmx5CiAgKi8KICBpc0Vycm9yOiBmYWxzZSwKCiAgLyoqCiAgICBJZiBgdHJ1ZWAgdGhlIHN0b3JlIGlzIGF0dGVtcHRpbmcgdG8gcmVsb2FkIHRoZSByZWNvcmQgZnJvbSB0aGUgYWRhcHRlci4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLmdldCgnaXNSZWxvYWRpbmcnKTsgLy8gZmFsc2UKICAgIHJlY29yZC5yZWxvYWQoKTsKICAgIHJlY29yZC5nZXQoJ2lzUmVsb2FkaW5nJyk7IC8vIHRydWUKICAgIGBgYAogICAgIEBwcm9wZXJ0eSBpc1JlbG9hZGluZwogICAgQHR5cGUge0Jvb2xlYW59CiAgICBAcmVhZE9ubHkKICAqLwogIGlzUmVsb2FkaW5nOiBmYWxzZSwKCiAgLyoqCiAgICBBbGwgZW1iZXIgbW9kZWxzIGhhdmUgYW4gaWQgcHJvcGVydHkuIFRoaXMgaXMgYW4gaWRlbnRpZmllcgogICAgbWFuYWdlZCBieSBhbiBleHRlcm5hbCBzb3VyY2UuIFRoZXNlIGFyZSBhbHdheXMgY29lcmNlZCB0byBiZQogICAgc3RyaW5ncyBiZWZvcmUgYmVpbmcgdXNlZCBpbnRlcm5hbGx5LiBOb3RlIHdoZW4gZGVjbGFyaW5nIHRoZQogICAgYXR0cmlidXRlcyBmb3IgYSBtb2RlbCBpdCBpcyBhbiBlcnJvciB0byBkZWNsYXJlIGFuIGlkCiAgICBhdHRyaWJ1dGUuCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IHJlY29yZCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgnbW9kZWwnKTsKICAgIHJlY29yZC5nZXQoJ2lkJyk7IC8vIG51bGwKICAgICBzdG9yZS5maW5kUmVjb3JkKCdtb2RlbCcsIDEpLnRoZW4oZnVuY3Rpb24obW9kZWwpIHsKICAgICAgbW9kZWwuZ2V0KCdpZCcpOyAvLyAnMScKICAgIH0pOwogICAgYGBgCiAgICAgQHByb3BlcnR5IGlkCiAgICBAdHlwZSB7U3RyaW5nfQogICovCgogIC8qKgogICAgQHByb3BlcnR5IGN1cnJlbnRTdGF0ZQogICAgQHByaXZhdGUKICAgIEB0eXBlIHtPYmplY3R9CiAgKi8KICBjdXJyZW50U3RhdGU6IFJvb3RTdGF0ZSQxLmVtcHR5LAoKICAvKioKICAgIFdoZW4gdGhlIHJlY29yZCBpcyBpbiB0aGUgYGludmFsaWRgIHN0YXRlIHRoaXMgb2JqZWN0IHdpbGwgY29udGFpbgogICAgYW55IGVycm9ycyByZXR1cm5lZCBieSB0aGUgYWRhcHRlci4gV2hlbiBwcmVzZW50IHRoZSBlcnJvcnMgaGFzaAogICAgY29udGFpbnMga2V5cyBjb3JyZXNwb25kaW5nIHRvIHRoZSBpbnZhbGlkIHByb3BlcnR5IG5hbWVzCiAgICBhbmQgdmFsdWVzIHdoaWNoIGFyZSBhcnJheXMgb2YgSmF2YXNjcmlwdCBvYmplY3RzIHdpdGggdHdvIGtleXM6CiAgICAgLSBgbWVzc2FnZWAgQSBzdHJpbmcgY29udGFpbmluZyB0aGUgZXJyb3IgbWVzc2FnZSBmcm9tIHRoZSBiYWNrZW5kCiAgICAtIGBhdHRyaWJ1dGVgIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSBhc3NvY2lhdGVkIHdpdGggdGhpcyBlcnJvciBtZXNzYWdlCiAgICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLmdldCgnZXJyb3JzLmxlbmd0aCcpOyAvLyAwCiAgICByZWNvcmQuc2V0KCdmb28nLCAnaW52YWxpZCB2YWx1ZScpOwogICAgcmVjb3JkLnNhdmUoKS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgcmVjb3JkLmdldCgnZXJyb3JzJykuZ2V0KCdmb28nKTsKICAgICAgLy8gW3ttZXNzYWdlOiAnZm9vIHNob3VsZCBiZSBhIG51bWJlci4nLCBhdHRyaWJ1dGU6ICdmb28nfV0KICAgIH0pOwogICAgYGBgCiAgICAgVGhlIGBlcnJvcnNgIHByb3BlcnR5IHVzIHVzZWZ1bCBmb3IgZGlzcGxheWluZyBlcnJvciBtZXNzYWdlcyB0bwogICAgdGhlIHVzZXIuCiAgICAgYGBgaGFuZGxlYmFycwogICAgPGxhYmVsPlVzZXJuYW1lOiB7e2lucHV0IHZhbHVlPXVzZXJuYW1lfX0gPC9sYWJlbD4KICAgIHt7I2VhY2ggbW9kZWwuZXJyb3JzLnVzZXJuYW1lIGFzIHxlcnJvcnx9fQogICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAge3tlcnJvci5tZXNzYWdlfX0KICAgICAgPC9kaXY+CiAgICB7ey9lYWNofX0KICAgIDxsYWJlbD5FbWFpbDoge3tpbnB1dCB2YWx1ZT1lbWFpbH19IDwvbGFiZWw+CiAgICB7eyNlYWNoIG1vZGVsLmVycm9ycy5lbWFpbCBhcyB8ZXJyb3J8fX0KICAgICAgPGRpdiBjbGFzcz0iZXJyb3IiPgogICAgICAgIHt7ZXJyb3IubWVzc2FnZX19CiAgICAgIDwvZGl2PgogICAge3svZWFjaH19CiAgICBgYGAKICAgICAgWW91IGNhbiBhbHNvIGFjY2VzcyB0aGUgc3BlY2lhbCBgbWVzc2FnZXNgIHByb3BlcnR5IG9uIHRoZSBlcnJvcgogICAgb2JqZWN0IHRvIGdldCBhbiBhcnJheSBvZiBhbGwgdGhlIGVycm9yIHN0cmluZ3MuCiAgICAgYGBgaGFuZGxlYmFycwogICAge3sjZWFjaCBtb2RlbC5lcnJvcnMubWVzc2FnZXMgYXMgfG1lc3NhZ2V8fX0KICAgICAgPGRpdiBjbGFzcz0iZXJyb3IiPgogICAgICAgIHt7bWVzc2FnZX19CiAgICAgIDwvZGl2PgogICAge3svZWFjaH19CiAgICBgYGAKICAgICBAcHJvcGVydHkgZXJyb3JzCiAgICBAdHlwZSB7RFMuRXJyb3JzfQogICovCiAgZXJyb3JzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICB2YXIgZXJyb3JzID0gRXJyb3JzLmNyZWF0ZSgpOwoKICAgIGVycm9ycy5fcmVnaXN0ZXJIYW5kbGVycyh0aGlzLl9pbnRlcm5hbE1vZGVsLCBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuc2VuZCgnYmVjYW1lSW52YWxpZCcpOwogICAgfSwgZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnNlbmQoJ2JlY2FtZVZhbGlkJyk7CiAgICB9KTsKICAgIHJldHVybiBlcnJvcnM7CiAgfSkucmVhZE9ubHkoKSwKCiAgLyoqCiAgICBUaGlzIHByb3BlcnR5IGhvbGRzIHRoZSBgRFMuQWRhcHRlckVycm9yYCBvYmplY3Qgd2l0aCB3aGljaAogICAgbGFzdCBhZGFwdGVyIG9wZXJhdGlvbiB3YXMgcmVqZWN0ZWQuCiAgICAgQHByb3BlcnR5IGFkYXB0ZXJFcnJvcgogICAgQHR5cGUge0RTLkFkYXB0ZXJFcnJvcn0KICAqLwogIGFkYXB0ZXJFcnJvcjogbnVsbCwKCiAgLyoqCiAgICBDcmVhdGUgYSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZWNvcmQsIHVzaW5nIHRoZSBzZXJpYWxpemF0aW9uCiAgICBzdHJhdGVneSBvZiB0aGUgc3RvcmUncyBhZGFwdGVyLgogICAgYHNlcmlhbGl6ZWAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHBhcmFtZXRlciwgY3VycmVudGx5CiAgICBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAtIGBpbmNsdWRlSWRgOiBgdHJ1ZWAgaWYgdGhlIHJlY29yZCdzIElEIHNob3VsZCBiZSBpbmNsdWRlZCBpbiB0aGUKICAgICAgSlNPTiByZXByZXNlbnRhdGlvbi4KICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge09iamVjdH0gYW4gb2JqZWN0IHdob3NlIHZhbHVlcyBhcmUgcHJpbWl0aXZlIEpTT04gdmFsdWVzIG9ubHkKICAqLwogIHNlcmlhbGl6ZShvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdCgpLnNlcmlhbGl6ZShvcHRpb25zKTsKICB9LAoKICAvKioKICAgIFVzZSBbRFMuSlNPTlNlcmlhbGl6ZXJdKERTLkpTT05TZXJpYWxpemVyLmh0bWwpIHRvCiAgICBnZXQgdGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSByZWNvcmQuCiAgICAgYHRvSlNPTmAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHBhcmFtZXRlciwgY3VycmVudGx5CiAgICBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAgLSBgaW5jbHVkZUlkYDogYHRydWVgIGlmIHRoZSByZWNvcmQncyBJRCBzaG91bGQgYmUgaW5jbHVkZWQgaW4gdGhlCiAgICAgIEpTT04gcmVwcmVzZW50YXRpb24uCiAgICAgQG1ldGhvZCB0b0pTT04KICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiByZXByZXNlbnRhdGlvbiBvZiB0aGUgb2JqZWN0LgogICovCiAgdG9KU09OKG9wdGlvbnMpIHsKICAgIC8vIGNvbnRhaW5lciBpcyBmb3IgbGF6eSB0cmFuc2Zvcm0gbG9va3VwcwogICAgdmFyIHNlcmlhbGl6ZXIgPSB0aGlzLnN0b3JlLnNlcmlhbGl6ZXJGb3IoJy1kZWZhdWx0Jyk7CiAgICB2YXIgc25hcHNob3QgPSB0aGlzLl9pbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CgogICAgcmV0dXJuIHNlcmlhbGl6ZXIuc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKTsKICB9LAoKICAvKioKICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyByZWFkeSB0byBiZSBpbnRlcmFjdGVkIHdpdGgsCiAgICB0aGF0IGlzIGVpdGhlciBsb2FkZWQgZnJvbSB0aGUgc2VydmVyIG9yIGNyZWF0ZWQgbG9jYWxseS4KICAgICBAZXZlbnQgcmVhZHkKICAqLwogIHJlYWR5OiBudWxsLAoKICAvKioKICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyBsb2FkZWQgZnJvbSB0aGUgc2VydmVyLgogICAgIEBldmVudCBkaWRMb2FkCiAgKi8KICBkaWRMb2FkOiBudWxsLAoKICAvKioKICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyB1cGRhdGVkLgogICAgIEBldmVudCBkaWRVcGRhdGUKICAqLwogIGRpZFVwZGF0ZTogbnVsbCwKCiAgLyoqCiAgICBGaXJlZCB3aGVuIGEgbmV3IHJlY29yZCBpcyBjb21taXRlZCB0byB0aGUgc2VydmVyLgogICAgIEBldmVudCBkaWRDcmVhdGUKICAqLwogIGRpZENyZWF0ZTogbnVsbCwKCiAgLyoqCiAgICBGaXJlZCB3aGVuIHRoZSByZWNvcmQgaXMgZGVsZXRlZC4KICAgICBAZXZlbnQgZGlkRGVsZXRlCiAgKi8KICBkaWREZWxldGU6IG51bGwsCgogIC8qKgogICAgRmlyZWQgd2hlbiB0aGUgcmVjb3JkIGJlY29tZXMgaW52YWxpZC4KICAgICBAZXZlbnQgYmVjYW1lSW52YWxpZAogICovCiAgYmVjYW1lSW52YWxpZDogbnVsbCwKCiAgLyoqCiAgICBGaXJlZCB3aGVuIHRoZSByZWNvcmQgZW50ZXJzIHRoZSBlcnJvciBzdGF0ZS4KICAgICBAZXZlbnQgYmVjYW1lRXJyb3IKICAqLwogIGJlY2FtZUVycm9yOiBudWxsLAoKICAvKioKICAgIEZpcmVkIHdoZW4gdGhlIHJlY29yZCBpcyByb2xsZWQgYmFjay4KICAgICBAZXZlbnQgcm9sbGVkQmFjawogICovCiAgcm9sbGVkQmFjazogbnVsbCwKCiAgLy9UT0RPIERvIHdlIHdhbnQgdG8gZGVwcmVjYXRlIHRoZXNlPwogIC8qKgogICAgQG1ldGhvZCBzZW5kCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0CiAgKi8KICBzZW5kKG5hbWUsIGNvbnRleHQpIHsKICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLnNlbmQobmFtZSwgY29udGV4dCk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIHRyYW5zaXRpb25UbwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgKi8KICB0cmFuc2l0aW9uVG8obmFtZSkgewogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwudHJhbnNpdGlvblRvKG5hbWUpOwogIH0sCgogIC8qKgogICAgTWFya3MgdGhlIHJlY29yZCBhcyBkZWxldGVkIGJ1dCBkb2VzIG5vdCBzYXZlIGl0LiBZb3UgbXVzdCBjYWxsCiAgICBgc2F2ZWAgYWZ0ZXJ3YXJkcyBpZiB5b3Ugd2FudCB0byBwZXJzaXN0IGl0LiBZb3UgbWlnaHQgdXNlIHRoaXMKICAgIG1ldGhvZCBpZiB5b3Ugd2FudCB0byBhbGxvdyB0aGUgdXNlciB0byBzdGlsbCBgcm9sbGJhY2tBdHRyaWJ1dGVzKClgCiAgICBhZnRlciBhIGRlbGV0ZSB3YXMgbWFkZS4KICAgICBFeGFtcGxlCiAgICAgYGBgYXBwL3JvdXRlcy9tb2RlbC9kZWxldGUuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHNvZnREZWxldGUoKSB7CiAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGxlci5tb2RlbCcpLmRlbGV0ZVJlY29yZCgpOwogICAgICAgIH0sCiAgICAgICAgY29uZmlybSgpIHsKICAgICAgICAgIHRoaXMuZ2V0KCdjb250cm9sbGVyLm1vZGVsJykuc2F2ZSgpOwogICAgICAgIH0sCiAgICAgICAgdW5kbygpIHsKICAgICAgICAgIHRoaXMuZ2V0KCdjb250cm9sbGVyLm1vZGVsJykucm9sbGJhY2tBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgZGVsZXRlUmVjb3JkCiAgKi8KICBkZWxldGVSZWNvcmQoKSB7CiAgICB0aGlzLl9pbnRlcm5hbE1vZGVsLmRlbGV0ZVJlY29yZCgpOwogIH0sCgogIC8qKgogICAgU2FtZSBhcyBgZGVsZXRlUmVjb3JkYCwgYnV0IHNhdmVzIHRoZSByZWNvcmQgaW1tZWRpYXRlbHkuCiAgICAgRXhhbXBsZQogICAgIGBgYGFwcC9yb3V0ZXMvbW9kZWwvZGVsZXRlLmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIGFjdGlvbnM6IHsKICAgICAgICBkZWxldGUoKSB7CiAgICAgICAgICB0aGlzLmdldCgnY29udHJvbGxlci5tb2RlbCcpLmRlc3Ryb3lSZWNvcmQoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb250cm9sbGVyLnRyYW5zaXRpb25Ub1JvdXRlKCdtb2RlbC5pbmRleCcpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIElmIHlvdSBwYXNzIGFuIG9iamVjdCBvbiB0aGUgYGFkYXB0ZXJPcHRpb25zYCBwcm9wZXJ0eSBvZiB0aGUgb3B0aW9ucwogICAgYXJndW1lbnQgaXQgd2lsbCBiZSBwYXNzZWQgdG8geW91ciBhZGFwdGVyIHZpYSB0aGUgc25hcHNob3QKICAgICBgYGBqcwogICAgcmVjb3JkLmRlc3Ryb3lSZWNvcmQoeyBhZGFwdGVyT3B0aW9uczogeyBzdWJzY3JpYmU6IGZhbHNlIH0gfSk7CiAgICBgYGAKICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgaW1wb3J0IE15Q3VzdG9tQWRhcHRlciBmcm9tICcuL2N1c3RvbS1hZGFwdGVyJzsKICAgICBleHBvcnQgZGVmYXVsdCBNeUN1c3RvbUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZGVsZXRlUmVjb3JkKHN0b3JlLCB0eXBlLCBzbmFwc2hvdCkgewogICAgICAgIGlmIChzbmFwc2hvdC5hZGFwdGVyT3B0aW9ucy5zdWJzY3JpYmUpIHsKICAgICAgICAgIC8vIC4uLgogICAgICAgIH0KICAgICAgICAvLyAuLi4KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIGRlc3Ryb3lSZWNvcmQKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIGFkYXB0ZXIgcmV0dXJucwogICAgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMgd2l0aCBhbiBlcnJvci4KICAqLwogIGRlc3Ryb3lSZWNvcmQob3B0aW9ucykgewogICAgdGhpcy5kZWxldGVSZWNvcmQoKTsKICAgIHJldHVybiB0aGlzLnNhdmUob3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBVbmxvYWRzIHRoZSByZWNvcmQgZnJvbSB0aGUgc3RvcmUuIFRoaXMgd2lsbCBjYXVzZSB0aGUgcmVjb3JkIHRvIGJlIGRlc3Ryb3llZCBhbmQgZnJlZWQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICBAbWV0aG9kIHVubG9hZFJlY29yZAogICovCiAgdW5sb2FkUmVjb3JkKCkgewogICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5faW50ZXJuYWxNb2RlbC51bmxvYWRSZWNvcmQoKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgX25vdGlmeVByb3BlcnRpZXMKICAgIEBwcml2YXRlCiAgKi8KICBfbm90aWZ5UHJvcGVydGllcyhrZXlzKSB7CiAgICAvLyBjaGFuZ2VQcm9wZXJ0aWVzIGRlZmVycyBub3RpZmljYXRpb25zIHVudGlsIGFmdGVyIHRoZSBkZWxlZ2F0ZQogICAgLy8gYW5kIHByb3RlY3RzIHdpdGggYSB0cnkuLi5maW5hbGx5IGJsb2NrCiAgICAvLyBwcmV2aW91c2x5IHVzZWQgYmVnaW4uLi5lbmRQcm9wZXJ0eUNoYW5nZXMgYnV0IHRoaXMgaXMgcHJpdmF0ZSBBUEkKICAgIGNoYW5nZVByb3BlcnRpZXMoKCkgPT4gewogICAgICB2YXIga2V5ID0gdm9pZCAwOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgdGhpcy5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgIFJldHVybnMgYW4gb2JqZWN0LCB3aG9zZSBrZXlzIGFyZSBjaGFuZ2VkIHByb3BlcnRpZXMsIGFuZCB2YWx1ZSBpcwogICAgYW4gW29sZFByb3AsIG5ld1Byb3BdIGFycmF5LgogICAgIFRoZSBhcnJheSByZXByZXNlbnRzIHRoZSBkaWZmIG9mIHRoZSBjYW5vbmljYWwgc3RhdGUgd2l0aCB0aGUgbG9jYWwgc3RhdGUKICAgIG9mIHRoZSBtb2RlbC4gTm90ZTogaWYgdGhlIG1vZGVsIGlzIGNyZWF0ZWQgbG9jYWxseSwgdGhlIGNhbm9uaWNhbCBzdGF0ZSBpcwogICAgZW1wdHkgc2luY2UgdGhlIGFkYXB0ZXIgaGFzbid0IGFja25vd2xlZGdlZCB0aGUgYXR0cmlidXRlcyB5ZXQ6CiAgICAgRXhhbXBsZQogICAgIGBgYGFwcC9tb2RlbHMvbWFzY290LmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgbmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGlzQWRtaW46IERTLmF0dHIoJ2Jvb2xlYW4nLCB7CiAgICAgICAgZGVmYXVsdFZhbHVlOiBmYWxzZQogICAgICB9KQogICAgfSk7CiAgICBgYGAKICAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgbWFzY290ID0gc3RvcmUuY3JlYXRlUmVjb3JkKCdtYXNjb3QnKTsKICAgICBtYXNjb3QuY2hhbmdlZEF0dHJpYnV0ZXMoKTsgLy8ge30KICAgICBtYXNjb3Quc2V0KCduYW1lJywgJ1RvbXN0ZXInKTsKICAgIG1hc2NvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyB7IG5hbWU6IFt1bmRlZmluZWQsICdUb21zdGVyJ10gfQogICAgIG1hc2NvdC5zZXQoJ2lzQWRtaW4nLCB0cnVlKTsKICAgIG1hc2NvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyB7IGlzQWRtaW46IFt1bmRlZmluZWQsIHRydWVdLCBuYW1lOiBbdW5kZWZpbmVkLCAnVG9tc3RlciddIH0KICAgICBtYXNjb3Quc2F2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIG1hc2NvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyB7fQogICAgICAgbWFzY290LnNldCgnaXNBZG1pbicsIGZhbHNlKTsKICAgICAgbWFzY290LmNoYW5nZWRBdHRyaWJ1dGVzKCk7IC8vIHsgaXNBZG1pbjogW3RydWUsIGZhbHNlXSB9CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgY2hhbmdlZEF0dHJpYnV0ZXMKICAgIEByZXR1cm4ge09iamVjdH0gYW4gb2JqZWN0LCB3aG9zZSBrZXlzIGFyZSBjaGFuZ2VkIHByb3BlcnRpZXMsCiAgICAgIGFuZCB2YWx1ZSBpcyBhbiBbb2xkUHJvcCwgbmV3UHJvcF0gYXJyYXkuCiAgKi8KICBjaGFuZ2VkQXR0cmlidXRlcygpIHsKICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLmNoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgfSwKCiAgLy9UT0RPIGRpc2N1c3Mgd2l0aCB0b21odWRhIGFib3V0IGV2ZW50cy9ob29rcwogIC8vQnJpbmcgYmFjayBhcyBob29rcz8KICAvKioKICAgIEBtZXRob2QgYWRhcHRlcldpbGxDb21taXQKICAgIEBwcml2YXRlCiAgYWRhcHRlcldpbGxDb21taXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZW5kKCd3aWxsQ29tbWl0Jyk7CiAgfSwKICAgLyoqCiAgICBAbWV0aG9kIGFkYXB0ZXJEaWREaXJ0eQogICAgQHByaXZhdGUKICBhZGFwdGVyRGlkRGlydHk6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZW5kKCdiZWNvbWVEaXJ0eScpOwogICAgdGhpcy51cGRhdGVSZWNvcmRBcnJheXNMYXRlcigpOwogIH0sCiAgKi8KCiAgLyoqCiAgICBJZiB0aGUgbW9kZWwgYGhhc0RpcnR5QXR0cmlidXRlc2AgdGhpcyBmdW5jdGlvbiB3aWxsIGRpc2NhcmQgYW55IHVuc2F2ZWQKICAgIGNoYW5nZXMuIElmIHRoZSBtb2RlbCBgaXNOZXdgIGl0IHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBzdG9yZS4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgcmVjb3JkLmdldCgnbmFtZScpOyAvLyAnVW50aXRsZWQgRG9jdW1lbnQnCiAgICByZWNvcmQuc2V0KCduYW1lJywgJ0RvYyAxJyk7CiAgICByZWNvcmQuZ2V0KCduYW1lJyk7IC8vICdEb2MgMScKICAgIHJlY29yZC5yb2xsYmFja0F0dHJpYnV0ZXMoKTsKICAgIHJlY29yZC5nZXQoJ25hbWUnKTsgLy8gJ1VudGl0bGVkIERvY3VtZW50JwogICAgYGBgCiAgICAgQHNpbmNlIDEuMTMuMAogICAgQG1ldGhvZCByb2xsYmFja0F0dHJpYnV0ZXMKICAqLwogIHJvbGxiYWNrQXR0cmlidXRlcygpIHsKICAgIHRoaXMuX2ludGVybmFsTW9kZWwucm9sbGJhY2tBdHRyaWJ1dGVzKCk7CiAgfSwKCiAgLyoKICAgIEBtZXRob2QgX2NyZWF0ZVNuYXBzaG90CiAgICBAcHJpdmF0ZQogICovCiAgX2NyZWF0ZVNuYXBzaG90KCkgewogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3QoKTsKICB9LAoKICB0b1N0cmluZ0V4dGVuc2lvbigpIHsKICAgIC8vIHRoZSBfaW50ZXJuYWxNb2RlbCBndWFyZCBleGlzdHMsIGJlY2F1c2Ugc29tZSBkZXYtb25seSBkZXByZWNhdGlvbiBjb2RlCiAgICAvLyAoYWRkTGlzdGVuZXIgdmlhIHZhbGlkYXRlUHJvcGVydHlJbmplY3Rpb25zKSBpbnZva2VzIHRvU3RyaW5nIGJlZm9yZSB0aGUKICAgIC8vIG9iamVjdCBpcyByZWFsLgogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwgJiYgdGhpcy5faW50ZXJuYWxNb2RlbC5pZDsKICB9LAoKICAvKioKICAgIFNhdmUgdGhlIHJlY29yZCBhbmQgcGVyc2lzdCBhbnkgY2hhbmdlcyB0byB0aGUgcmVjb3JkIHRvIGFuCiAgICBleHRlcm5hbCBzb3VyY2UgdmlhIHRoZSBhZGFwdGVyLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICByZWNvcmQuc2V0KCduYW1lJywgJ1RvbXN0ZXInKTsKICAgIHJlY29yZC5zYXZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgLy8gU3VjY2VzcyBjYWxsYmFjawogICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgIC8vIEVycm9yIGNhbGxiYWNrCiAgICB9KTsKICAgIGBgYAogICAgSWYgeW91IHBhc3MgYW4gb2JqZWN0IHVzaW5nIHRoZSBgYWRhcHRlck9wdGlvbnNgIHByb3BlcnR5IG9mIHRoZSBvcHRpb25zCiAgIGFyZ3VtZW50IGl0IHdpbGwgYmUgcGFzc2VkIHRvIHlvdXIgYWRhcHRlciB2aWEgdGhlIHNuYXBzaG90LgogICAgIGBgYGpzCiAgICByZWNvcmQuc2F2ZSh7IGFkYXB0ZXJPcHRpb25zOiB7IHN1YnNjcmliZTogZmFsc2UgfSB9KTsKICAgIGBgYAogICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICBpbXBvcnQgTXlDdXN0b21BZGFwdGVyIGZyb20gJy4vY3VzdG9tLWFkYXB0ZXInOwogICAgIGV4cG9ydCBkZWZhdWx0IE15Q3VzdG9tQWRhcHRlci5leHRlbmQoewogICAgICB1cGRhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgaWYgKHNuYXBzaG90LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICAgIC8vIC4uLgogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2Qgc2F2ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2hlbiB0aGUgYWRhcHRlciByZXR1cm5zCiAgICBzdWNjZXNzZnVsbHkgb3IgcmVqZWN0ZWQgaWYgdGhlIGFkYXB0ZXIgcmV0dXJucyB3aXRoIGFuIGVycm9yLgogICovCiAgc2F2ZShvcHRpb25zKSB7CiAgICByZXR1cm4gUHJvbWlzZU9iamVjdC5jcmVhdGUoewogICAgICBwcm9taXNlOiB0aGlzLl9pbnRlcm5hbE1vZGVsLnNhdmUob3B0aW9ucykudGhlbigoKSA9PiB0aGlzKQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBSZWxvYWQgdGhlIHJlY29yZCBmcm9tIHRoZSBhZGFwdGVyLgogICAgIFRoaXMgd2lsbCBvbmx5IHdvcmsgaWYgdGhlIHJlY29yZCBoYXMgYWxyZWFkeSBmaW5pc2hlZCBsb2FkaW5nLgogICAgIEV4YW1wbGUKICAgICBgYGBhcHAvcm91dGVzL21vZGVsL3ZpZXcuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgYWN0aW9uczogewogICAgICAgIHJlbG9hZCgpIHsKICAgICAgICAgIHRoaXMuY29udHJvbGxlci5nZXQoJ21vZGVsJykucmVsb2FkKCkudGhlbihmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgICAvLyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcmVsb2FkZWQgbW9kZWwKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIHJlbG9hZAogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgb3B0aW9uYWwsIG1heSBpbmNsdWRlIGBhZGFwdGVyT3B0aW9uc2AgaGFzaCB3aGljaCB3aWxsIGJlIHBhc3NlZCB0byBhZGFwdGVyIHJlcXVlc3QKICAgIEByZXR1cm4ge1Byb21pc2V9IGEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgcmVjb3JkIHdoZW4gdGhlCiAgICBhZGFwdGVyIHJldHVybnMgc3VjY2Vzc2Z1bGx5IG9yIHJlamVjdGVkIGlmIHRoZSBhZGFwdGVyIHJldHVybnMKICAgIHdpdGggYW4gZXJyb3IuCiAgKi8KICByZWxvYWQob3B0aW9ucykgewogICAgdmFyIHdyYXBwZWRBZGFwdGVyT3B0aW9ucyA9IHZvaWQgMDsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucy5hZGFwdGVyT3B0aW9ucykgewogICAgICB3cmFwcGVkQWRhcHRlck9wdGlvbnMgPSB7CiAgICAgICAgYWRhcHRlck9wdGlvbnM6IG9wdGlvbnMuYWRhcHRlck9wdGlvbnMKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZU9iamVjdC5jcmVhdGUoewogICAgICBwcm9taXNlOiB0aGlzLl9pbnRlcm5hbE1vZGVsLnJlbG9hZCh3cmFwcGVkQWRhcHRlck9wdGlvbnMpLnRoZW4oKCkgPT4gdGhpcykKICAgIH0pOwogIH0sCgogIC8qKgogICAgT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZXZlbnQgZmlyaW5nIGZyb20gRW1iZXIuRXZlbnRlZCB0bwogICAgYWxzbyBjYWxsIG1ldGhvZHMgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICBAbWV0aG9kIHRyaWdnZXIKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZQogICovCiAgdHJpZ2dlcihuYW1lKSB7CiAgICB2YXIgZm4gPSB0aGlzW25hbWVdOwoKICAgIGlmICh0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGxlbmd0aCAtIDEpOwoKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICB9CiAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQoKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgfSwKCiAgYXR0cigpIHsKICAgICh0cnVlICYmICEoZmFsc2UpICYmIEVtYmVyLmFzc2VydCgiVGhlIGBhdHRyYCBtZXRob2QgaXMgbm90IGF2YWlsYWJsZSBvbiBEUy5Nb2RlbCwgYSBEUy5TbmFwc2hvdCB3YXMgcHJvYmFibHkgZXhwZWN0ZWQuIEFyZSB5b3UgcGFzc2luZyBhIERTLk1vZGVsIGluc3RlYWQgb2YgYSBEUy5TbmFwc2hvdCB0byB5b3VyIHNlcmlhbGl6ZXI/IiwgZmFsc2UpKTsKICB9LAoKICAvKioKICAgIEdldCB0aGUgcmVmZXJlbmNlIGZvciB0aGUgc3BlY2lmaWVkIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAuCiAgICAgRXhhbXBsZQogICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgIH0pOwogICAgYGBgCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgZGF0YTogewogICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICBpZDogMSwKICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgIGRhdGE6IHsgdHlwZTogJ3VzZXInLCBpZDogMSB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAvLyBjaGVjayBpZiB0aGUgdXNlciByZWxhdGlvbnNoaXAgaXMgbG9hZGVkCiAgICBsZXQgaXNMb2FkZWQgPSB1c2VyUmVmLnZhbHVlKCkgIT09IG51bGw7CiAgICAgLy8gZ2V0IHRoZSByZWNvcmQgb2YgdGhlIHJlZmVyZW5jZSAobnVsbCBpZiBub3QgeWV0IGF2YWlsYWJsZSkKICAgIGxldCB1c2VyID0gdXNlclJlZi52YWx1ZSgpOwogICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICBpZiAodXNlclJlZi5yZW1vdGVUeXBlKCkgPT09ICJpZCIpIHsKICAgICAgbGV0IGlkID0gdXNlclJlZi5pZCgpOwogICAgfSBlbHNlIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gImxpbmsiKSB7CiAgICAgIGxldCBsaW5rID0gdXNlclJlZi5saW5rKCk7CiAgICB9CiAgICAgLy8gbG9hZCB1c2VyICh2aWEgc3RvcmUuZmluZFJlY29yZCBvciBzdG9yZS5maW5kQmVsb25nc1RvKQogICAgdXNlclJlZi5sb2FkKCkudGhlbiguLi4pCiAgICAgLy8gb3IgdHJpZ2dlciBhIHJlbG9hZAogICAgdXNlclJlZi5yZWxvYWQoKS50aGVuKC4uLikKICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgdXNlclJlZi5wdXNoKHsKICAgICAgdHlwZTogJ3VzZXInLAogICAgICBpZDogMSwKICAgICAgYXR0cmlidXRlczogewogICAgICAgIHVzZXJuYW1lOiAiQHVzZXIiCiAgICAgIH0KICAgIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICB1c2VyUmVmLnZhbHVlKCkgPT09IHVzZXI7CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgYmVsb25nc1RvCiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgICBAc2luY2UgMi41LjAKICAgIEByZXR1cm4ge0JlbG9uZ3NUb1JlZmVyZW5jZX0gcmVmZXJlbmNlIGZvciB0aGlzIHJlbGF0aW9uc2hpcAogICovCiAgYmVsb25nc1RvKG5hbWUpIHsKICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLnJlZmVyZW5jZUZvcignYmVsb25nc1RvJywgbmFtZSk7CiAgfSwKCiAgLyoqCiAgICBHZXQgdGhlIHJlZmVyZW5jZSBmb3IgdGhlIHNwZWNpZmllZCBoYXNNYW55IHJlbGF0aW9uc2hpcC4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgLy8gbW9kZWxzL2Jsb2cuanMKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgIH0pOwogICAgIGxldCBibG9nID0gc3RvcmUucHVzaCh7CiAgICAgIGRhdGE6IHsKICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgaWQ6IDEsCiAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgZGF0YTogWwogICAgICAgICAgICAgIHsgdHlwZTogJ2NvbW1lbnQnLCBpZDogMSB9LAogICAgICAgICAgICAgIHsgdHlwZTogJ2NvbW1lbnQnLCBpZDogMiB9CiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgbGV0IGNvbW1lbnRzUmVmID0gYmxvZy5oYXNNYW55KCdjb21tZW50cycpOwogICAgIC8vIGNoZWNrIGlmIHRoZSBjb21tZW50cyBhcmUgbG9hZGVkIGFscmVhZHkKICAgIGxldCBpc0xvYWRlZCA9IGNvbW1lbnRzUmVmLnZhbHVlKCkgIT09IG51bGw7CiAgICAgLy8gZ2V0IHRoZSByZWNvcmRzIG9mIHRoZSByZWZlcmVuY2UgKG51bGwgaWYgbm90IHlldCBhdmFpbGFibGUpCiAgICBsZXQgY29tbWVudHMgPSBjb21tZW50c1JlZi52YWx1ZSgpOwogICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICBpZiAoY29tbWVudHNSZWYucmVtb3RlVHlwZSgpID09PSAiaWRzIikgewogICAgICBsZXQgaWRzID0gY29tbWVudHNSZWYuaWRzKCk7CiAgICB9IGVsc2UgaWYgKGNvbW1lbnRzUmVmLnJlbW90ZVR5cGUoKSA9PT0gImxpbmsiKSB7CiAgICAgIGxldCBsaW5rID0gY29tbWVudHNSZWYubGluaygpOwogICAgfQogICAgIC8vIGxvYWQgY29tbWVudHMgKHZpYSBzdG9yZS5maW5kTWFueSBvciBzdG9yZS5maW5kSGFzTWFueSkKICAgIGNvbW1lbnRzUmVmLmxvYWQoKS50aGVuKC4uLikKICAgICAvLyBvciB0cmlnZ2VyIGEgcmVsb2FkCiAgICBjb21tZW50c1JlZi5yZWxvYWQoKS50aGVuKC4uLikKICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgY29tbWVudHNSZWYucHVzaChbeyB0eXBlOiAnY29tbWVudCcsIGlkOiAxIH0sIHsgdHlwZTogJ2NvbW1lbnQnLCBpZDogMiB9XSkudGhlbihmdW5jdGlvbihjb21tZW50cykgewogICAgICBjb21tZW50c1JlZi52YWx1ZSgpID09PSBjb21tZW50czsKICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCBoYXNNYW55CiAgICBAcGFyYW0ge1N0cmluZ30gbmFtZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgICBAc2luY2UgMi41LjAKICAgIEByZXR1cm4ge0hhc01hbnlSZWZlcmVuY2V9IHJlZmVyZW5jZSBmb3IgdGhpcyByZWxhdGlvbnNoaXAKICAqLwogIGhhc01hbnkobmFtZSkgewogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwucmVmZXJlbmNlRm9yKCdoYXNNYW55JywgbmFtZSk7CiAgfSwKCiAgLyoqCiAgIFByb3ZpZGVzIGluZm8gYWJvdXQgdGhlIG1vZGVsIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMKICAgYnkgZ3JvdXBpbmcgdGhlIHByb3BlcnRpZXMgaW50byBtb3JlIHNlbWFudGljIGdyb3Vwcy4KICAgIE1lYW50IHRvIGJlIHVzZWQgYnkgZGVidWdnaW5nIHRvb2xzIHN1Y2ggYXMgdGhlIENocm9tZSBFbWJlciBFeHRlbnNpb24uCiAgICAtIEdyb3VwcyBhbGwgYXR0cmlidXRlcyBpbiAiQXR0cmlidXRlcyIgZ3JvdXAuCiAgIC0gR3JvdXBzIGFsbCBiZWxvbmdzVG8gcmVsYXRpb25zaGlwcyBpbiAiQmVsb25ncyBUbyIgZ3JvdXAuCiAgIC0gR3JvdXBzIGFsbCBoYXNNYW55IHJlbGF0aW9uc2hpcHMgaW4gIkhhcyBNYW55IiBncm91cC4KICAgLSBHcm91cHMgYWxsIGZsYWdzIGluICJGbGFncyIgZ3JvdXAuCiAgIC0gRmxhZ3MgcmVsYXRpb25zaGlwIENQcyBhcyBleHBlbnNpdmUgcHJvcGVydGllcy4KICAgIEBtZXRob2QgX2RlYnVnSW5mbwogICBAZm9yIERTLk1vZGVsCiAgIEBwcml2YXRlCiAgICovCiAgX2RlYnVnSW5mbygpIHsKICAgIHZhciBhdHRyaWJ1dGVzID0gWydpZCddOwogICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB7fTsKICAgIHZhciBleHBlbnNpdmVQcm9wZXJ0aWVzID0gW107CgogICAgdGhpcy5lYWNoQXR0cmlidXRlKChuYW1lLCBtZXRhKSA9PiBhdHRyaWJ1dGVzLnB1c2gobmFtZSkpOwoKICAgIHZhciBncm91cHMgPSBbewogICAgICBuYW1lOiAnQXR0cmlidXRlcycsCiAgICAgIHByb3BlcnRpZXM6IGF0dHJpYnV0ZXMsCiAgICAgIGV4cGFuZDogdHJ1ZQogICAgfV07CgogICAgdGhpcy5lYWNoUmVsYXRpb25zaGlwKChuYW1lLCByZWxhdGlvbnNoaXApID0+IHsKICAgICAgdmFyIHByb3BlcnRpZXMgPSByZWxhdGlvbnNoaXBzW3JlbGF0aW9uc2hpcC5raW5kXTsKCiAgICAgIGlmIChwcm9wZXJ0aWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBwcm9wZXJ0aWVzID0gcmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXAua2luZF0gPSBbXTsKICAgICAgICBncm91cHMucHVzaCh7CiAgICAgICAgICBuYW1lOiByZWxhdGlvbnNoaXAubmFtZSwKICAgICAgICAgIHByb3BlcnRpZXMsCiAgICAgICAgICBleHBhbmQ6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgICBwcm9wZXJ0aWVzLnB1c2gobmFtZSk7CiAgICAgIGV4cGVuc2l2ZVByb3BlcnRpZXMucHVzaChuYW1lKTsKICAgIH0pOwoKICAgIGdyb3Vwcy5wdXNoKHsKICAgICAgbmFtZTogJ0ZsYWdzJywKICAgICAgcHJvcGVydGllczogWydpc0xvYWRlZCcsICdoYXNEaXJ0eUF0dHJpYnV0ZXMnLCAnaXNTYXZpbmcnLCAnaXNEZWxldGVkJywgJ2lzRXJyb3InLCAnaXNOZXcnLCAnaXNWYWxpZCddCiAgICB9KTsKCiAgICByZXR1cm4gewogICAgICBwcm9wZXJ0eUluZm86IHsKICAgICAgICAvLyBpbmNsdWRlIGFsbCBvdGhlciBtaXhpbnMgLyBwcm9wZXJ0aWVzIChub3QganVzdCB0aGUgZ3JvdXBlZCBvbmVzKQogICAgICAgIGluY2x1ZGVPdGhlclByb3BlcnRpZXM6IHRydWUsCiAgICAgICAgZ3JvdXBzOiBncm91cHMsCiAgICAgICAgLy8gZG9uJ3QgcHJlLWNhbGN1bGF0ZSB1bmxlc3MgY2FjaGVkCiAgICAgICAgZXhwZW5zaXZlUHJvcGVydGllczogZXhwZW5zaXZlUHJvcGVydGllcwogICAgICB9CiAgICB9OwogIH0sCgogIG5vdGlmeUJlbG9uZ3NUb0NoYW5nZShrZXkpIHsKICAgIHRoaXMubm90aWZ5UHJvcGVydHlDaGFuZ2Uoa2V5KTsKICB9LAogIC8qKgogICBHaXZlbiBhIGNhbGxiYWNrLCBpdGVyYXRlcyBvdmVyIGVhY2ggb2YgdGhlIHJlbGF0aW9uc2hpcHMgaW4gdGhlIG1vZGVsLAogICBpbnZva2luZyB0aGUgY2FsbGJhY2sgd2l0aCB0aGUgbmFtZSBvZiBlYWNoIHJlbGF0aW9uc2hpcCBhbmQgaXRzIHJlbGF0aW9uc2hpcAogICBkZXNjcmlwdG9yLgogICAgIFRoZSBjYWxsYmFjayBtZXRob2QgeW91IHByb3ZpZGUgc2hvdWxkIGhhdmUgdGhlIGZvbGxvd2luZyBzaWduYXR1cmUgKGFsbAogICBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbCk6CiAgICBgYGBqYXZhc2NyaXB0CiAgIGZ1bmN0aW9uKG5hbWUsIGRlc2NyaXB0b3IpOwogICBgYGAKICAgIC0gYG5hbWVgIHRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHByb3BlcnR5IGluIHRoZSBpdGVyYXRpb24KICAgLSBgZGVzY3JpcHRvcmAgdGhlIG1ldGEgb2JqZWN0IHRoYXQgZGVzY3JpYmVzIHRoaXMgcmVsYXRpb25zaGlwCiAgICBUaGUgcmVsYXRpb25zaGlwIGRlc2NyaXB0b3IgYXJndW1lbnQgaXMgYW4gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzLgogICAgLSAqKmtleSoqIDxzcGFuIGNsYXNzPSJ0eXBlIj5TdHJpbmc8L3NwYW4+IHRoZSBuYW1lIG9mIHRoaXMgcmVsYXRpb25zaGlwIG9uIHRoZSBNb2RlbAogICAtICoqa2luZCoqIDxzcGFuIGNsYXNzPSJ0eXBlIj5TdHJpbmc8L3NwYW4+ICJoYXNNYW55IiBvciAiYmVsb25nc1RvIgogICAtICoqb3B0aW9ucyoqIDxzcGFuIGNsYXNzPSJ0eXBlIj5PYmplY3Q8L3NwYW4+IHRoZSBvcmlnaW5hbCBvcHRpb25zIGhhc2ggcGFzc2VkIHdoZW4gdGhlIHJlbGF0aW9uc2hpcCB3YXMgZGVjbGFyZWQKICAgLSAqKnBhcmVudFR5cGUqKiA8c3BhbiBjbGFzcz0idHlwZSI+RFMuTW9kZWw8L3NwYW4+IHRoZSB0eXBlIG9mIHRoZSBNb2RlbCB0aGF0IG93bnMgdGhpcyByZWxhdGlvbnNoaXAKICAgLSAqKnR5cGUqKiA8c3BhbiBjbGFzcz0idHlwZSI+U3RyaW5nPC9zcGFuPiB0aGUgdHlwZSBuYW1lIG9mIHRoZSByZWxhdGVkIE1vZGVsCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzIGB0aGlzYCBvbiB0aGUgY29udGV4dC4KICAgIEV4YW1wbGUKICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgc2VyaWFsaXplOiBmdW5jdGlvbihyZWNvcmQsIG9wdGlvbnMpIHsKICAgICAgbGV0IGpzb24gPSB7fTsKICAgICAgIHJlY29yZC5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKG5hbWUsIGRlc2NyaXB0b3IpIHsKICAgICAgICBpZiAoZGVzY3JpcHRvci5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgIGxldCBzZXJpYWxpemVkSGFzTWFueU5hbWUgPSBuYW1lLnRvVXBwZXJDYXNlKCkgKyAnX0lEUyc7CiAgICAgICAgICBqc29uW3NlcmlhbGl6ZWRIYXNNYW55TmFtZV0gPSByZWNvcmQuZ2V0KG5hbWUpLm1hcEJ5KCdpZCcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgICByZXR1cm4ganNvbjsKICAgIH0KICB9KTsKICAgYGBgCiAgICBAbWV0aG9kIGVhY2hSZWxhdGlvbnNoaXAKICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIGludm9rZQogICBAcGFyYW0ge2FueX0gYmluZGluZyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICAqLwogIGVhY2hSZWxhdGlvbnNoaXAoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHRoaXMuY29uc3RydWN0b3IuZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZyk7CiAgfSwKCiAgcmVsYXRpb25zaGlwRm9yKG5hbWUpIHsKICAgIHJldHVybiBFbWJlci5nZXQodGhpcy5jb25zdHJ1Y3RvciwgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKS5nZXQobmFtZSk7CiAgfSwKCiAgaW52ZXJzZUZvcihrZXkpIHsKICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLmludmVyc2VGb3Ioa2V5LCB0aGlzLnN0b3JlKTsKICB9LAoKICBub3RpZnlIYXNNYW55QWRkZWQoa2V5KSB7CiAgICAvL1dlIG5lZWQgdG8gbm90aWZ5UHJvcGVydHlDaGFuZ2UgaW4gdGhlIGFkZGluZyBjYXNlIGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUKICAgIC8vd2UgZmV0Y2ggdGhlIG5ld2x5IGFkZGVkIHJlY29yZCBpbiBjYXNlIGl0IGlzIHVubG9hZGVkCiAgICAvL1RPRE8oSWdvcik6IENvbnNpZGVyIHdoZXRoZXIgd2UgY291bGQgZG8gdGhpcyBvbmx5IGlmIHRoZSByZWNvcmQgc3RhdGUgaXMgdW5sb2FkZWQKCiAgICAvL0dvZXMgYXdheSBvbmNlIGhhc01hbnkgaXMgZG91YmxlIHByb21pc2lmaWVkCiAgICB0aGlzLm5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSk7CiAgfSwKCiAgZWFjaEF0dHJpYnV0ZShjYWxsYmFjaywgYmluZGluZykgewogICAgdGhpcy5jb25zdHJ1Y3Rvci5lYWNoQXR0cmlidXRlKGNhbGxiYWNrLCBiaW5kaW5nKTsKICB9Cn0pOwoKLyoqCiBAcHJvcGVydHkgZGF0YQogQHByaXZhdGUKIEB0eXBlIHtPYmplY3R9CiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoTW9kZWwucHJvdG90eXBlLCAnZGF0YScsIHsKICBjb25maWd1cmFibGU6IGZhbHNlLAogIGdldCgpIHsKICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLl9kYXRhOwogIH0KfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoTW9kZWwucHJvdG90eXBlLCAnaWQnLCB7CiAgY29uZmlndXJhYmxlOiBmYWxzZSwKICBzZXQoaWQpIHsKICAgIHRoaXMuX2ludGVybmFsTW9kZWwuc2V0SWQoaWQpOwogIH0sCgogIGdldCgpIHsKICAgIC8vIHRoZSBfaW50ZXJuYWxNb2RlbCBndWFyZCBleGlzdHMsIGJlY2F1c2Ugc29tZSBkZXYtb25seSBkZXByZWNhdGlvbiBjb2RlCiAgICAvLyAoYWRkTGlzdGVuZXIgdmlhIHZhbGlkYXRlUHJvcGVydHlJbmplY3Rpb25zKSBpbnZva2VzIHRvU3RyaW5nIGJlZm9yZSB0aGUKICAgIC8vIG9iamVjdCBpcyByZWFsLgogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwgJiYgdGhpcy5faW50ZXJuYWxNb2RlbC5pZDsKICB9Cn0pOwoKewogIE1vZGVsLnJlb3Blbih7CiAgICBpbml0KCkgewogICAgICB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwoKICAgICAgaWYgKCF0aGlzLl9pbnRlcm5hbE1vZGVsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCdZb3Ugc2hvdWxkIG5vdCBjYWxsIGBjcmVhdGVgIG9uIGEgbW9kZWwuIEluc3RlYWQsIGNhbGwgYHN0b3JlLmNyZWF0ZVJlY29yZGAgd2l0aCB0aGUgYXR0cmlidXRlcyB5b3Ugd291bGQgbGlrZSB0byBzZXQuJyk7CiAgICAgIH0KICAgIH0KICB9KTsKfQoKTW9kZWwucmVvcGVuQ2xhc3MoewogIGlzTW9kZWw6IHRydWUsCgogIC8qKgogICAgT3ZlcnJpZGUgdGhlIGNsYXNzJyBgY3JlYXRlKClgIG1ldGhvZCB0byByYWlzZSBhbiBlcnJvci4gVGhpcwogICAgcHJldmVudHMgZW5kIHVzZXJzIGZyb20gaW5hZHZlcnRlbnRseSBjYWxsaW5nIGBjcmVhdGUoKWAgaW5zdGVhZAogICAgb2YgYGNyZWF0ZVJlY29yZCgpYC4gVGhlIHN0b3JlIGlzIHN0aWxsIGFibGUgdG8gY3JlYXRlIGluc3RhbmNlcwogICAgYnkgY2FsbGluZyB0aGUgYF9jcmVhdGUoKWAgbWV0aG9kLiBUbyBjcmVhdGUgYW4gaW5zdGFuY2Ugb2YgYQogICAgYERTLk1vZGVsYCB1c2UgW3N0b3JlLmNyZWF0ZVJlY29yZF0oRFMuU3RvcmUuaHRtbCNtZXRob2RfY3JlYXRlUmVjb3JkKS4KICAgICBAbWV0aG9kIGNyZWF0ZQogICAgQHByaXZhdGUKICAgIEBzdGF0aWMKICAqLwogIC8qKgogICBSZXByZXNlbnRzIHRoZSBtb2RlbCdzIGNsYXNzIG5hbWUgYXMgYSBzdHJpbmcuIFRoaXMgY2FuIGJlIHVzZWQgdG8gbG9vayB1cCB0aGUgbW9kZWwncyBjbGFzcyBuYW1lIHRocm91Z2gKICAgYERTLlN0b3JlYCdzIG1vZGVsRm9yIG1ldGhvZC4KICAgIGBtb2RlbE5hbWVgIGlzIGdlbmVyYXRlZCBmb3IgeW91IGJ5IEVtYmVyIERhdGEuIEl0IHdpbGwgYmUgYSBsb3dlcmNhc2VkLCBkYXNoZXJpemVkIHN0cmluZy4KICAgRm9yIGV4YW1wbGU6CiAgICBgYGBqYXZhc2NyaXB0CiAgIHN0b3JlLm1vZGVsRm9yKCdwb3N0JykubW9kZWxOYW1lOyAvLyAncG9zdCcKICAgc3RvcmUubW9kZWxGb3IoJ2Jsb2ctcG9zdCcpLm1vZGVsTmFtZTsgLy8gJ2Jsb2ctcG9zdCcKICAgYGBgCiAgICBUaGUgbW9zdCBjb21tb24gcGxhY2UgeW91J2xsIHdhbnQgdG8gYWNjZXNzIGBtb2RlbE5hbWVgIGlzIGluIHlvdXIgc2VyaWFsaXplcidzIGBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZWAgbWV0aG9kLiBGb3IgZXhhbXBsZSwgdG8gY2hhbmdlIHBheWxvYWQKICAga2V5cyB0byB1bmRlcnNjb3JlIChpbnN0ZWFkIG9mIGRhc2hlcml6ZWQpLCB5b3UgbWlnaHQgdXNlIHRoZSBmb2xsb3dpbmcgY29kZToKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IHsgdW5kZXJzY29yZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgZXhwb3J0IGRlZmF1bHQgY29uc3QgUG9zdFNlcmlhbGl6ZXIgPSBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgIHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lKG1vZGVsTmFtZSkgewogICAgICAgcmV0dXJuIHVuZGVyc2NvcmUobW9kZWxOYW1lKTsKICAgICB9CiAgIH0pOwogICBgYGAKICAgQHByb3BlcnR5IG1vZGVsTmFtZQogICBAdHlwZSBTdHJpbmcKICAgQHJlYWRvbmx5CiAgIEBzdGF0aWMKICAqLwogIG1vZGVsTmFtZTogbnVsbCwKCiAgLyoKICAgVGhlc2UgY2xhc3MgbWV0aG9kcyBiZWxvdyBwcm92aWRlIHJlbGF0aW9uc2hpcAogICBpbnRyb3NwZWN0aW9uIGFiaWxpdGllcyBhYm91dCByZWxhdGlvbnNoaXBzLgogICAgQSBub3RlIGFib3V0IHRoZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGNvbnRhaW5lZCBoZXJlOgogICAgKipUaGVzZSBwcm9wZXJ0aWVzIGFyZSBlZmZlY3RpdmVseSBzZWFsZWQgb25jZSBjYWxsZWQgZm9yIHRoZSBmaXJzdCB0aW1lLioqCiAgIFRvIGF2b2lkIHJlcGVhdGVkbHkgZG9pbmcgZXhwZW5zaXZlIGl0ZXJhdGlvbiBvdmVyIGEgbW9kZWwncyBmaWVsZHMsIHRoZXNlCiAgIHZhbHVlcyBhcmUgY29tcHV0ZWQgb25jZSBhbmQgdGhlbiBjYWNoZWQgZm9yIHRoZSByZW1haW5kZXIgb2YgdGhlIHJ1bnRpbWUgb2YKICAgeW91ciBhcHBsaWNhdGlvbi4KICAgIElmIHlvdXIgYXBwbGljYXRpb24gbmVlZHMgdG8gbW9kaWZ5IGEgY2xhc3MgYWZ0ZXIgaXRzIGluaXRpYWwgZGVmaW5pdGlvbgogICAoZm9yIGV4YW1wbGUsIHVzaW5nIGByZW9wZW4oKWAgdG8gYWRkIGFkZGl0aW9uYWwgYXR0cmlidXRlcyksIG1ha2Ugc3VyZSB5b3UKICAgZG8gaXQgYmVmb3JlIHVzaW5nIHlvdXIgbW9kZWwgd2l0aCB0aGUgc3RvcmUsIHdoaWNoIHVzZXMgdGhlc2UgcHJvcGVydGllcwogICBleHRlbnNpdmVseS4KICAgKi8KCiAgLyoqCiAgIEZvciBhIGdpdmVuIHJlbGF0aW9uc2hpcCBuYW1lLCByZXR1cm5zIHRoZSBtb2RlbCB0eXBlIG9mIHRoZSByZWxhdGlvbnNoaXAuCiAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGRlZmluZSBhIG1vZGVsIGxpa2UgdGhpczoKICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICBjb21tZW50czogRFMuaGFzTWFueSgnY29tbWVudCcpCiAgICB9KTsKICAgYGBgCiAgICBDYWxsaW5nIGBzdG9yZS5tb2RlbEZvcigncG9zdCcpLnR5cGVGb3JSZWxhdGlvbnNoaXAoJ2NvbW1lbnRzJywgc3RvcmUpYCB3aWxsIHJldHVybiBgQ29tbWVudGAuCiAgICBAbWV0aG9kIHR5cGVGb3JSZWxhdGlvbnNoaXAKICAgQHN0YXRpYwogICBAcGFyYW0ge1N0cmluZ30gbmFtZSB0aGUgbmFtZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgIEBwYXJhbSB7c3RvcmV9IHN0b3JlIGFuIGluc3RhbmNlIG9mIERTLlN0b3JlCiAgIEByZXR1cm4ge0RTLk1vZGVsfSB0aGUgdHlwZSBvZiB0aGUgcmVsYXRpb25zaGlwLCBvciB1bmRlZmluZWQKICAgKi8KICB0eXBlRm9yUmVsYXRpb25zaGlwKG5hbWUsIHN0b3JlKSB7CiAgICB2YXIgcmVsYXRpb25zaGlwID0gRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZ2V0KG5hbWUpOwogICAgcmV0dXJuIHJlbGF0aW9uc2hpcCAmJiBzdG9yZS5tb2RlbEZvcihyZWxhdGlvbnNoaXAudHlwZSk7CiAgfSwKCiAgaW52ZXJzZU1hcDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfSksCgogIC8qKgogICBGaW5kIHRoZSByZWxhdGlvbnNoaXAgd2hpY2ggaXMgdGhlIGludmVyc2Ugb2YgdGhlIG9uZSBhc2tlZCBmb3IuCiAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGRlZmluZSBtb2RlbHMgbGlrZSB0aGlzOgogICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KCdtZXNzYWdlJykKICAgIH0pOwogICBgYGAKICAgIGBgYGFwcC9tb2RlbHMvbWVzc2FnZS5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCdwb3N0JykKICAgIH0pOwogICBgYGAKICAgIGBgYCBqcwogICBzdG9yZS5tb2RlbEZvcigncG9zdCcpLmludmVyc2VGb3IoJ2NvbW1lbnRzJywgc3RvcmUpIC8vIHsgdHlwZTogQXBwLk1lc3NhZ2UsIG5hbWU6ICdvd25lcicsIGtpbmQ6ICdiZWxvbmdzVG8nIH0KICAgc3RvcmUubW9kZWxGb3IoJ21lc3NhZ2UnKS5pbnZlcnNlRm9yKCdvd25lcicsIHN0b3JlKSAvLyB7IHR5cGU6IEFwcC5Qb3N0LCBuYW1lOiAnY29tbWVudHMnLCBraW5kOiAnaGFzTWFueScgfQogICBgYGAKICAgIEBtZXRob2QgaW52ZXJzZUZvcgogICBAc3RhdGljCiAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lIHRoZSBuYW1lIG9mIHRoZSByZWxhdGlvbnNoaXAKICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgQHJldHVybiB7T2JqZWN0fSB0aGUgaW52ZXJzZSByZWxhdGlvbnNoaXAsIG9yIG51bGwKICAgKi8KICBpbnZlcnNlRm9yKG5hbWUsIHN0b3JlKSB7CiAgICB2YXIgaW52ZXJzZU1hcCA9IEVtYmVyLmdldCh0aGlzLCAnaW52ZXJzZU1hcCcpOwogICAgaWYgKGludmVyc2VNYXBbbmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gaW52ZXJzZU1hcFtuYW1lXTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXAgPSBFbWJlci5nZXQodGhpcywgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKS5nZXQobmFtZSk7CiAgICAgIGlmICghcmVsYXRpb25zaGlwKSB7CiAgICAgICAgaW52ZXJzZU1hcFtuYW1lXSA9IG51bGw7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHZhciBvcHRpb25zID0gcmVsYXRpb25zaGlwLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaW52ZXJzZSA9PT0gbnVsbCkgewogICAgICAgIC8vIHBvcHVsYXRlIHRoZSBjYWNoZSB3aXRoIGEgbWlzcyBlbnRyeSBzbyB3ZSBjYW4gc2tpcCBnZXR0aW5nIGFuZCBnb2luZwogICAgICAgIC8vIHRocm91Z2ggYHJlbGF0aW9uc2hpcHNCeU5hbWVgCiAgICAgICAgaW52ZXJzZU1hcFtuYW1lXSA9IG51bGw7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBpbnZlcnNlTWFwW25hbWVdID0gdGhpcy5fZmluZEludmVyc2VGb3IobmFtZSwgc3RvcmUpOwogICAgfQogIH0sCgogIC8vQ2FsY3VsYXRlIHRoZSBpbnZlcnNlLCBpZ25vcmluZyB0aGUgY2FjaGUKICBfZmluZEludmVyc2VGb3IobmFtZSwgc3RvcmUpIHsKCiAgICB2YXIgaW52ZXJzZVR5cGUgPSB0aGlzLnR5cGVGb3JSZWxhdGlvbnNoaXAobmFtZSwgc3RvcmUpOwogICAgaWYgKCFpbnZlcnNlVHlwZSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICB2YXIgcHJvcGVydHlNZXRhID0gdGhpcy5tZXRhRm9yUHJvcGVydHkobmFtZSk7CiAgICAvL0lmIGludmVyc2UgaXMgbWFudWFsbHkgc3BlY2lmaWVkIHRvIGJlIG51bGwsIGxpa2UgIGBjb21tZW50czogRFMuaGFzTWFueSgnbWVzc2FnZScsIHsgaW52ZXJzZTogbnVsbCB9KWAKICAgIHZhciBvcHRpb25zID0gcHJvcGVydHlNZXRhLm9wdGlvbnM7CiAgICBpZiAob3B0aW9ucy5pbnZlcnNlID09PSBudWxsKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBpbnZlcnNlTmFtZSA9IHZvaWQgMCwKICAgICAgICBpbnZlcnNlS2luZCA9IHZvaWQgMCwKICAgICAgICBpbnZlcnNlID0gdm9pZCAwOwoKICAgIC8vSWYgaW52ZXJzZSBpcyBzcGVjaWZpZWQgbWFudWFsbHksIHJldHVybiB0aGUgaW52ZXJzZQogICAgaWYgKG9wdGlvbnMuaW52ZXJzZSkgewogICAgICBpbnZlcnNlTmFtZSA9IG9wdGlvbnMuaW52ZXJzZTsKICAgICAgaW52ZXJzZSA9IEVtYmVyLmdldChpbnZlcnNlVHlwZSwgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKS5nZXQoaW52ZXJzZU5hbWUpOwoKICAgICAgKHRydWUgJiYgISghRW1iZXIuaXNOb25lKGludmVyc2UpKSAmJiBFbWJlci5hc3NlcnQoIldlIGZvdW5kIG5vIGludmVyc2UgcmVsYXRpb25zaGlwcyBieSB0aGUgbmFtZSBvZiAnIiArIGludmVyc2VOYW1lICsgIicgb24gdGhlICciICsgaW52ZXJzZVR5cGUubW9kZWxOYW1lICsgIicgbW9kZWwuIFRoaXMgaXMgbW9zdCBsaWtlbHkgZHVlIHRvIGEgbWlzc2luZyBhdHRyaWJ1dGUgb24geW91ciBtb2RlbCBkZWZpbml0aW9uLiIsICFFbWJlci5pc05vbmUoaW52ZXJzZSkpKTsKCgogICAgICBpbnZlcnNlS2luZCA9IGludmVyc2Uua2luZDsKICAgIH0gZWxzZSB7CiAgICAgIC8vTm8gaW52ZXJzZSB3YXMgc3BlY2lmaWVkIG1hbnVhbGx5LCB3ZSBuZWVkIHRvIHVzZSBhIGhldXJpc3RpYyB0byBndWVzcyBvbmUKICAgICAgaWYgKHByb3BlcnR5TWV0YS5wYXJlbnRUeXBlICYmIHByb3BlcnR5TWV0YS50eXBlID09PSBwcm9wZXJ0eU1ldGEucGFyZW50VHlwZS5tb2RlbE5hbWUpIHsKICAgICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKGBEZXRlY3RlZCBhIHJlZmxleGl2ZSByZWxhdGlvbnNoaXAgYnkgdGhlIG5hbWUgb2YgJyR7bmFtZX0nIHdpdGhvdXQgYW4gaW52ZXJzZSBvcHRpb24uIExvb2sgYXQgaHR0cHM6Ly9ndWlkZXMuZW1iZXJqcy5jb20vY3VycmVudC9tb2RlbHMvcmVsYXRpb25zaGlwcy8jdG9jX3JlZmxleGl2ZS1yZWxhdGlvbnMgZm9yIGhvdyB0byBleHBsaWNpdGx5IHNwZWNpZnkgaW52ZXJzZXMuYCwgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZHMubW9kZWwucmVmbGV4aXZlLXJlbGF0aW9uc2hpcC13aXRob3V0LWludmVyc2UnCiAgICAgICAgfSkpOwogICAgICB9CgogICAgICB2YXIgcG9zc2libGVSZWxhdGlvbnNoaXBzID0gZmluZFBvc3NpYmxlSW52ZXJzZXModGhpcywgaW52ZXJzZVR5cGUsIG5hbWUpOwoKICAgICAgaWYgKHBvc3NpYmxlUmVsYXRpb25zaGlwcy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgdmFyIGZpbHRlcmVkUmVsYXRpb25zaGlwcyA9IHBvc3NpYmxlUmVsYXRpb25zaGlwcy5maWx0ZXIocG9zc2libGVSZWxhdGlvbnNoaXAgPT4gewogICAgICAgIHZhciBvcHRpb25zRm9yUmVsYXRpb25zaGlwID0gaW52ZXJzZVR5cGUubWV0YUZvclByb3BlcnR5KHBvc3NpYmxlUmVsYXRpb25zaGlwLm5hbWUpLm9wdGlvbnM7CiAgICAgICAgcmV0dXJuIG5hbWUgPT09IG9wdGlvbnNGb3JSZWxhdGlvbnNoaXAuaW52ZXJzZTsKICAgICAgfSk7CgogICAgICAodHJ1ZSAmJiAhKGZpbHRlcmVkUmVsYXRpb25zaGlwcy5sZW5ndGggPCAyKSAmJiBFbWJlci5hc3NlcnQoIllvdSBkZWZpbmVkIHRoZSAnIiArIG5hbWUgKyAiJyByZWxhdGlvbnNoaXAgb24gIiArIHRoaXMgKyAiLCBidXQgeW91IGRlZmluZWQgdGhlIGludmVyc2UgcmVsYXRpb25zaGlwcyBvZiB0eXBlICIgKyBpbnZlcnNlVHlwZS50b1N0cmluZygpICsgIiBtdWx0aXBsZSB0aW1lcy4gTG9vayBhdCBodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS9jdXJyZW50L21vZGVscy9yZWxhdGlvbnNoaXBzLyN0b2NfZXhwbGljaXQtaW52ZXJzZXMgZm9yIGhvdyB0byBleHBsaWNpdGx5IHNwZWNpZnkgaW52ZXJzZXMiLCBmaWx0ZXJlZFJlbGF0aW9uc2hpcHMubGVuZ3RoIDwgMikpOwoKCiAgICAgIGlmIChmaWx0ZXJlZFJlbGF0aW9uc2hpcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgcG9zc2libGVSZWxhdGlvbnNoaXBzID0gZmlsdGVyZWRSZWxhdGlvbnNoaXBzOwogICAgICB9CgogICAgICAodHJ1ZSAmJiAhKHBvc3NpYmxlUmVsYXRpb25zaGlwcy5sZW5ndGggPT09IDEpICYmIEVtYmVyLmFzc2VydCgiWW91IGRlZmluZWQgdGhlICciICsgbmFtZSArICInIHJlbGF0aW9uc2hpcCBvbiAiICsgdGhpcyArICIsIGJ1dCBtdWx0aXBsZSBwb3NzaWJsZSBpbnZlcnNlIHJlbGF0aW9uc2hpcHMgb2YgdHlwZSAiICsgdGhpcyArICIgd2VyZSBmb3VuZCBvbiAiICsgaW52ZXJzZVR5cGUgKyAiLiBMb29rIGF0IGh0dHBzOi8vZ3VpZGVzLmVtYmVyanMuY29tL2N1cnJlbnQvbW9kZWxzL3JlbGF0aW9uc2hpcHMvI3RvY19leHBsaWNpdC1pbnZlcnNlcyBmb3IgaG93IHRvIGV4cGxpY2l0bHkgc3BlY2lmeSBpbnZlcnNlcyIsIHBvc3NpYmxlUmVsYXRpb25zaGlwcy5sZW5ndGggPT09IDEpKTsKCgogICAgICBpbnZlcnNlTmFtZSA9IHBvc3NpYmxlUmVsYXRpb25zaGlwc1swXS5uYW1lOwogICAgICBpbnZlcnNlS2luZCA9IHBvc3NpYmxlUmVsYXRpb25zaGlwc1swXS5raW5kOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IGludmVyc2VUeXBlLAogICAgICBuYW1lOiBpbnZlcnNlTmFtZSwKICAgICAga2luZDogaW52ZXJzZUtpbmQKICAgIH07CiAgfSwKCiAgLyoqCiAgIFRoZSBtb2RlbCdzIHJlbGF0aW9uc2hpcHMgYXMgYSBtYXAsIGtleWVkIG9uIHRoZSB0eXBlIG9mIHRoZQogICByZWxhdGlvbnNoaXAuIFRoZSB2YWx1ZSBvZiBlYWNoIGVudHJ5IGlzIGFuIGFycmF5IGNvbnRhaW5pbmcgYSBkZXNjcmlwdG9yCiAgIGZvciBlYWNoIHJlbGF0aW9uc2hpcCB3aXRoIHRoYXQgdHlwZSwgZGVzY3JpYmluZyB0aGUgbmFtZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgIGFzIHdlbGwgYXMgdGhlIHR5cGUuCiAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gdGhlIGZvbGxvd2luZyBtb2RlbCBkZWZpbml0aW9uOgogICAgYGBgYXBwL21vZGVscy9ibG9nLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHVzZXJzOiBEUy5oYXNNYW55KCd1c2VyJyksCiAgICAgIG93bmVyOiBEUy5iZWxvbmdzVG8oJ3VzZXInKSwKICAgICAgcG9zdHM6IERTLmhhc01hbnkoJ3Bvc3QnKQogICAgfSk7CiAgIGBgYAogICAgVGhpcyBjb21wdXRlZCBwcm9wZXJ0eSB3b3VsZCByZXR1cm4gYSBtYXAgZGVzY3JpYmluZyB0aGVzZQogICByZWxhdGlvbnNoaXBzLCBsaWtlIHRoaXM6CiAgICBgYGBqYXZhc2NyaXB0CiAgIGltcG9ydCBFbWJlciBmcm9tICdlbWJlcic7CiAgIGltcG9ydCBCbG9nIGZyb20gJ2FwcC9tb2RlbHMvYmxvZyc7CiAgIGltcG9ydCBVc2VyIGZyb20gJ2FwcC9tb2RlbHMvdXNlcic7CiAgIGltcG9ydCBQb3N0IGZyb20gJ2FwcC9tb2RlbHMvcG9zdCc7CiAgICBsZXQgcmVsYXRpb25zaGlwcyA9IEVtYmVyLmdldChCbG9nLCAncmVsYXRpb25zaGlwcycpOwogICByZWxhdGlvbnNoaXBzLmdldChVc2VyKTsKICAgLy89PiBbIHsgbmFtZTogJ3VzZXJzJywga2luZDogJ2hhc01hbnknIH0sCiAgIC8vICAgICB7IG5hbWU6ICdvd25lcicsIGtpbmQ6ICdiZWxvbmdzVG8nIH0gXQogICByZWxhdGlvbnNoaXBzLmdldChQb3N0KTsKICAgLy89PiBbIHsgbmFtZTogJ3Bvc3RzJywga2luZDogJ2hhc01hbnknIH0gXQogICBgYGAKICAgIEBwcm9wZXJ0eSByZWxhdGlvbnNoaXBzCiAgIEBzdGF0aWMKICAgQHR5cGUgTWFwCiAgIEByZWFkT25seQogICAqLwoKICByZWxhdGlvbnNoaXBzOiByZWxhdGlvbnNoaXBzRGVzY3JpcHRvciwKCiAgLyoqCiAgIEEgaGFzaCBjb250YWluaW5nIGxpc3RzIG9mIHRoZSBtb2RlbCdzIHJlbGF0aW9uc2hpcHMsIGdyb3VwZWQKICAgYnkgdGhlIHJlbGF0aW9uc2hpcCBraW5kLiBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMKICAgZGVmaW5pdGlvbjoKICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyczogRFMuaGFzTWFueSgndXNlcicpLAogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCd1c2VyJyksCiAgICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgYGBgCiAgICBUaGlzIHByb3BlcnR5IHdvdWxkIGNvbnRhaW4gdGhlIGZvbGxvd2luZzoKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IEVtYmVyIGZyb20gJ2VtYmVyJzsKICAgaW1wb3J0IEJsb2cgZnJvbSAnYXBwL21vZGVscy9ibG9nJzsKICAgIGxldCByZWxhdGlvbnNoaXBOYW1lcyA9IEVtYmVyLmdldChCbG9nLCAncmVsYXRpb25zaGlwTmFtZXMnKTsKICAgcmVsYXRpb25zaGlwTmFtZXMuaGFzTWFueTsKICAgLy89PiBbJ3VzZXJzJywgJ3Bvc3RzJ10KICAgcmVsYXRpb25zaGlwTmFtZXMuYmVsb25nc1RvOwogICAvLz0+IFsnb3duZXInXQogICBgYGAKICAgIEBwcm9wZXJ0eSByZWxhdGlvbnNoaXBOYW1lcwogICBAc3RhdGljCiAgIEB0eXBlIE9iamVjdAogICBAcmVhZE9ubHkKICAgKi8KICByZWxhdGlvbnNoaXBOYW1lczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgdmFyIG5hbWVzID0gewogICAgICBoYXNNYW55OiBbXSwKICAgICAgYmVsb25nc1RvOiBbXQogICAgfTsKCiAgICB0aGlzLmVhY2hDb21wdXRlZFByb3BlcnR5KChuYW1lLCBtZXRhKSA9PiB7CiAgICAgIGlmIChtZXRhLmlzUmVsYXRpb25zaGlwKSB7CiAgICAgICAgbmFtZXNbbWV0YS5raW5kXS5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gbmFtZXM7CiAgfSksCgogIC8qKgogICBBbiBhcnJheSBvZiB0eXBlcyBkaXJlY3RseSByZWxhdGVkIHRvIGEgbW9kZWwuIEVhY2ggdHlwZSB3aWxsIGJlCiAgIGluY2x1ZGVkIG9uY2UsIHJlZ2FyZGxlc3Mgb2YgdGhlIG51bWJlciBvZiByZWxhdGlvbnNoaXBzIGl0IGhhcyB3aXRoCiAgIHRoZSBtb2RlbC4KICAgIEZvciBleGFtcGxlLCBnaXZlbiBhIG1vZGVsIHdpdGggdGhpcyBkZWZpbml0aW9uOgogICAgYGBgYXBwL21vZGVscy9ibG9nLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHVzZXJzOiBEUy5oYXNNYW55KCd1c2VyJyksCiAgICAgIG93bmVyOiBEUy5iZWxvbmdzVG8oJ3VzZXInKSwKICAgICAgIHBvc3RzOiBEUy5oYXNNYW55KCdwb3N0JykKICAgIH0pOwogICBgYGAKICAgIFRoaXMgcHJvcGVydHkgd291bGQgY29udGFpbiB0aGUgZm9sbG93aW5nOgogICAgYGBgamF2YXNjcmlwdAogICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICBpbXBvcnQgQmxvZyBmcm9tICdhcHAvbW9kZWxzL2Jsb2cnOwogICAgbGV0IHJlbGF0ZWRUeXBlcyA9IEVtYmVyLmdldChCbG9nLCAncmVsYXRlZFR5cGVzJyk7CiAgIC8vPT4gWyBVc2VyLCBQb3N0IF0KICAgYGBgCiAgICBAcHJvcGVydHkgcmVsYXRlZFR5cGVzCiAgIEBzdGF0aWMKICAgQHR5cGUgRW1iZXIuQXJyYXkKICAgQHJlYWRPbmx5CiAgICovCiAgcmVsYXRlZFR5cGVzOiByZWxhdGVkVHlwZXNEZXNjcmlwdG9yLAoKICAvKioKICAgQSBtYXAgd2hvc2Uga2V5cyBhcmUgdGhlIHJlbGF0aW9uc2hpcHMgb2YgYSBtb2RlbCBhbmQgd2hvc2UgdmFsdWVzIGFyZQogICByZWxhdGlvbnNoaXAgZGVzY3JpcHRvcnMuCiAgICBGb3IgZXhhbXBsZSwgZ2l2ZW4gYSBtb2RlbCB3aXRoIHRoaXMKICAgZGVmaW5pdGlvbjoKICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyczogRFMuaGFzTWFueSgndXNlcicpLAogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCd1c2VyJyksCiAgICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgICB9KTsKICAgYGBgCiAgICBUaGlzIHByb3BlcnR5IHdvdWxkIGNvbnRhaW4gdGhlIGZvbGxvd2luZzoKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IEVtYmVyIGZyb20gJ2VtYmVyJzsKICAgaW1wb3J0IEJsb2cgZnJvbSAnYXBwL21vZGVscy9ibG9nJzsKICAgIGxldCByZWxhdGlvbnNoaXBzQnlOYW1lID0gRW1iZXIuZ2V0KEJsb2csICdyZWxhdGlvbnNoaXBzQnlOYW1lJyk7CiAgIHJlbGF0aW9uc2hpcHNCeU5hbWUuZ2V0KCd1c2VycycpOwogICAvLz0+IHsga2V5OiAndXNlcnMnLCBraW5kOiAnaGFzTWFueScsIHR5cGU6ICd1c2VyJywgb3B0aW9uczogT2JqZWN0LCBpc1JlbGF0aW9uc2hpcDogdHJ1ZSB9CiAgIHJlbGF0aW9uc2hpcHNCeU5hbWUuZ2V0KCdvd25lcicpOwogICAvLz0+IHsga2V5OiAnb3duZXInLCBraW5kOiAnYmVsb25nc1RvJywgdHlwZTogJ3VzZXInLCBvcHRpb25zOiBPYmplY3QsIGlzUmVsYXRpb25zaGlwOiB0cnVlIH0KICAgYGBgCiAgICBAcHJvcGVydHkgcmVsYXRpb25zaGlwc0J5TmFtZQogICBAc3RhdGljCiAgIEB0eXBlIE1hcAogICBAcmVhZE9ubHkKICAgKi8KICByZWxhdGlvbnNoaXBzQnlOYW1lOiByZWxhdGlvbnNoaXBzQnlOYW1lRGVzY3JpcHRvciwKCiAgLyoqCiAgIEEgbWFwIHdob3NlIGtleXMgYXJlIHRoZSBmaWVsZHMgb2YgdGhlIG1vZGVsIGFuZCB3aG9zZSB2YWx1ZXMgYXJlIHN0cmluZ3MKICAgZGVzY3JpYmluZyB0aGUga2luZCBvZiB0aGUgZmllbGQuIEEgbW9kZWwncyBmaWVsZHMgYXJlIHRoZSB1bmlvbiBvZiBhbGwgb2YgaXRzCiAgIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMuCiAgICBGb3IgZXhhbXBsZToKICAgIGBgYGFwcC9tb2RlbHMvYmxvZy5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyczogRFMuaGFzTWFueSgndXNlcicpLAogICAgICBvd25lcjogRFMuYmVsb25nc1RvKCd1c2VyJyksCiAgICAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpLAogICAgICAgdGl0bGU6IERTLmF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgYGBgCiAgICBgYGBqcwogICBpbXBvcnQgRW1iZXIgZnJvbSAnZW1iZXInOwogICBpbXBvcnQgQmxvZyBmcm9tICdhcHAvbW9kZWxzL2Jsb2cnOwogICAgbGV0IGZpZWxkcyA9IEVtYmVyLmdldChCbG9nLCAnZmllbGRzJyk7CiAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGtpbmQsIGZpZWxkKSB7CiAgICAgIGNvbnNvbGUubG9nKGZpZWxkLCBraW5kKTsKICAgIH0pOwogICAgLy8gcHJpbnRzOgogICAvLyB1c2VycywgaGFzTWFueQogICAvLyBvd25lciwgYmVsb25nc1RvCiAgIC8vIHBvc3RzLCBoYXNNYW55CiAgIC8vIHRpdGxlLCBhdHRyaWJ1dGUKICAgYGBgCiAgICBAcHJvcGVydHkgZmllbGRzCiAgIEBzdGF0aWMKICAgQHR5cGUgTWFwCiAgIEByZWFkT25seQogICAqLwogIGZpZWxkczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgdmFyIG1hcCA9IG5ldyBNYXBXaXRoRGVwcmVjYXRpb25zKCk7CgogICAgdGhpcy5lYWNoQ29tcHV0ZWRQcm9wZXJ0eSgobmFtZSwgbWV0YSkgPT4gewogICAgICBpZiAobWV0YS5pc1JlbGF0aW9uc2hpcCkgewogICAgICAgIG1hcC5zZXQobmFtZSwgbWV0YS5raW5kKTsKICAgICAgfSBlbHNlIGlmIChtZXRhLmlzQXR0cmlidXRlKSB7CiAgICAgICAgbWFwLnNldChuYW1lLCAnYXR0cmlidXRlJyk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfSkucmVhZE9ubHkoKSwKCiAgLyoqCiAgIEdpdmVuIGEgY2FsbGJhY2ssIGl0ZXJhdGVzIG92ZXIgZWFjaCBvZiB0aGUgcmVsYXRpb25zaGlwcyBpbiB0aGUgbW9kZWwsCiAgIGludm9raW5nIHRoZSBjYWxsYmFjayB3aXRoIHRoZSBuYW1lIG9mIGVhY2ggcmVsYXRpb25zaGlwIGFuZCBpdHMgcmVsYXRpb25zaGlwCiAgIGRlc2NyaXB0b3IuCiAgICBAbWV0aG9kIGVhY2hSZWxhdGlvbnNoaXAKICAgQHN0YXRpYwogICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gaW52b2tlCiAgIEBwYXJhbSB7YW55fSBiaW5kaW5nIHRoZSB2YWx1ZSB0byB3aGljaCB0aGUgY2FsbGJhY2sncyBgdGhpc2Agc2hvdWxkIGJlIGJvdW5kCiAgICovCiAgZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZykgewogICAgRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZm9yRWFjaCgocmVsYXRpb25zaGlwLCBuYW1lKSA9PiB7CiAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgcmVsYXRpb25zaGlwKTsKICAgIH0pOwogIH0sCgogIC8qKgogICBHaXZlbiBhIGNhbGxiYWNrLCBpdGVyYXRlcyBvdmVyIGVhY2ggb2YgdGhlIHR5cGVzIHJlbGF0ZWQgdG8gYSBtb2RlbCwKICAgaW52b2tpbmcgdGhlIGNhbGxiYWNrIHdpdGggdGhlIHJlbGF0ZWQgdHlwZSdzIGNsYXNzLiBFYWNoIHR5cGUgd2lsbCBiZQogICByZXR1cm5lZCBqdXN0IG9uY2UsIHJlZ2FyZGxlc3Mgb2YgaG93IG1hbnkgZGlmZmVyZW50IHJlbGF0aW9uc2hpcHMgaXQgaGFzCiAgIHdpdGggYSBtb2RlbC4KICAgIEBtZXRob2QgZWFjaFJlbGF0ZWRUeXBlCiAgIEBzdGF0aWMKICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIGludm9rZQogICBAcGFyYW0ge2FueX0gYmluZGluZyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGNhbGxiYWNrJ3MgYHRoaXNgIHNob3VsZCBiZSBib3VuZAogICAqLwogIGVhY2hSZWxhdGVkVHlwZShjYWxsYmFjaywgYmluZGluZykgewogICAgdmFyIHJlbGF0aW9uc2hpcFR5cGVzID0gRW1iZXIuZ2V0KHRoaXMsICdyZWxhdGVkVHlwZXMnKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbGF0aW9uc2hpcFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciB0eXBlID0gcmVsYXRpb25zaGlwVHlwZXNbaV07CiAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgdHlwZSk7CiAgICB9CiAgfSwKCiAgZGV0ZXJtaW5lUmVsYXRpb25zaGlwVHlwZShrbm93blNpZGUsIHN0b3JlKSB7CiAgICB2YXIga25vd25LZXkgPSBrbm93blNpZGUua2V5OwogICAgdmFyIGtub3duS2luZCA9IGtub3duU2lkZS5raW5kOwogICAgdmFyIGludmVyc2UgPSB0aGlzLmludmVyc2VGb3Ioa25vd25LZXksIHN0b3JlKTsKICAgIC8vIGxldCBrZXk7CiAgICB2YXIgb3RoZXJLaW5kID0gdm9pZCAwOwoKICAgIGlmICghaW52ZXJzZSkgewogICAgICByZXR1cm4ga25vd25LaW5kID09PSAnYmVsb25nc1RvJyA/ICdvbmVUb05vbmUnIDogJ21hbnlUb05vbmUnOwogICAgfQoKICAgIC8vIGtleSA9IGludmVyc2UubmFtZTsKICAgIG90aGVyS2luZCA9IGludmVyc2Uua2luZDsKCiAgICBpZiAob3RoZXJLaW5kID09PSAnYmVsb25nc1RvJykgewogICAgICByZXR1cm4ga25vd25LaW5kID09PSAnYmVsb25nc1RvJyA/ICdvbmVUb09uZScgOiAnbWFueVRvT25lJzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBrbm93bktpbmQgPT09ICdiZWxvbmdzVG8nID8gJ29uZVRvTWFueScgOiAnbWFueVRvTWFueSc7CiAgICB9CiAgfSwKCiAgLyoqCiAgIEEgbWFwIHdob3NlIGtleXMgYXJlIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCAocHJvcGVydGllcwogICBkZXNjcmliZWQgYnkgRFMuYXR0cikgYW5kIHdob3NlIHZhbHVlcyBhcmUgdGhlIG1ldGEgb2JqZWN0IGZvciB0aGUKICAgcHJvcGVydHkuCiAgICBFeGFtcGxlCiAgICBgYGBhcHAvbW9kZWxzL3BlcnNvbi5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICBsYXN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGJpcnRoZGF5OiBEUy5hdHRyKCdkYXRlJykKICAgIH0pOwogICBgYGAKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IEVtYmVyIGZyb20gJ2VtYmVyJzsKICAgaW1wb3J0IFBlcnNvbiBmcm9tICdhcHAvbW9kZWxzL3BlcnNvbic7CiAgICBsZXQgYXR0cmlidXRlcyA9IEVtYmVyLmdldChQZXJzb24sICdhdHRyaWJ1dGVzJykKICAgIGF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbihtZXRhLCBuYW1lKSB7CiAgICAgIGNvbnNvbGUubG9nKG5hbWUsIG1ldGEpOwogICAgfSk7CiAgICAvLyBwcmludHM6CiAgIC8vIGZpcnN0TmFtZSB7dHlwZTogInN0cmluZyIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAiZmlyc3ROYW1lIn0KICAgLy8gbGFzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImxhc3ROYW1lIn0KICAgLy8gYmlydGhkYXkge3R5cGU6ICJkYXRlIiwgaXNBdHRyaWJ1dGU6IHRydWUsIG9wdGlvbnM6IE9iamVjdCwgcGFyZW50VHlwZTogZnVuY3Rpb24sIG5hbWU6ICJiaXJ0aGRheSJ9CiAgIGBgYAogICAgQHByb3BlcnR5IGF0dHJpYnV0ZXMKICAgQHN0YXRpYwogICBAdHlwZSB7TWFwfQogICBAcmVhZE9ubHkKICAgKi8KICBhdHRyaWJ1dGVzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWFwID0gbmV3IE1hcFdpdGhEZXByZWNhdGlvbnMoKTsKCiAgICB0aGlzLmVhY2hDb21wdXRlZFByb3BlcnR5KChuYW1lLCBtZXRhKSA9PiB7CiAgICAgIGlmIChtZXRhLmlzQXR0cmlidXRlKSB7CiAgICAgICAgKHRydWUgJiYgIShuYW1lICE9PSAnaWQnKSAmJiBFbWJlci5hc3NlcnQoIllvdSBtYXkgbm90IHNldCBgaWRgIGFzIGFuIGF0dHJpYnV0ZSBvbiB5b3VyIG1vZGVsLiBQbGVhc2UgcmVtb3ZlIGFueSBsaW5lcyB0aGF0IGxvb2sgbGlrZTogYGlkOiBEUy5hdHRyKCc8dHlwZT4nKWAgZnJvbSAiICsgdGhpcy50b1N0cmluZygpLCBuYW1lICE9PSAnaWQnKSk7CgoKICAgICAgICBtZXRhLm5hbWUgPSBuYW1lOwogICAgICAgIG1hcC5zZXQobmFtZSwgbWV0YSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfSkucmVhZE9ubHkoKSwKCiAgLyoqCiAgIEEgbWFwIHdob3NlIGtleXMgYXJlIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCAocHJvcGVydGllcwogICBkZXNjcmliZWQgYnkgRFMuYXR0cikgYW5kIHdob3NlIHZhbHVlcyBhcmUgdHlwZSBvZiB0cmFuc2Zvcm1hdGlvbgogICBhcHBsaWVkIHRvIGVhY2ggYXR0cmlidXRlLiBUaGlzIG1hcCBkb2VzIG5vdCBpbmNsdWRlIGFueQogICBhdHRyaWJ1dGVzIHRoYXQgZG8gbm90IGhhdmUgYW4gdHJhbnNmb3JtYXRpb24gdHlwZS4KICAgIEV4YW1wbGUKICAgIGBgYGFwcC9tb2RlbHMvcGVyc29uLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogRFMuYXR0cigpLAogICAgICBsYXN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGJpcnRoZGF5OiBEUy5hdHRyKCdkYXRlJykKICAgIH0pOwogICBgYGAKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IEVtYmVyIGZyb20gJ2VtYmVyJzsKICAgaW1wb3J0IFBlcnNvbiBmcm9tICdhcHAvbW9kZWxzL3BlcnNvbic7CiAgICBsZXQgdHJhbnNmb3JtZWRBdHRyaWJ1dGVzID0gRW1iZXIuZ2V0KFBlcnNvbiwgJ3RyYW5zZm9ybWVkQXR0cmlidXRlcycpCiAgICB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbihmaWVsZCwgdHlwZSkgewogICAgICBjb25zb2xlLmxvZyhmaWVsZCwgdHlwZSk7CiAgICB9KTsKICAgIC8vIHByaW50czoKICAgLy8gbGFzdE5hbWUgc3RyaW5nCiAgIC8vIGJpcnRoZGF5IGRhdGUKICAgYGBgCiAgICBAcHJvcGVydHkgdHJhbnNmb3JtZWRBdHRyaWJ1dGVzCiAgIEBzdGF0aWMKICAgQHR5cGUge01hcH0KICAgQHJlYWRPbmx5CiAgICovCiAgdHJhbnNmb3JtZWRBdHRyaWJ1dGVzOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICB2YXIgbWFwID0gbmV3IE1hcFdpdGhEZXByZWNhdGlvbnMoKTsKCiAgICB0aGlzLmVhY2hBdHRyaWJ1dGUoKGtleSwgbWV0YSkgPT4gewogICAgICBpZiAobWV0YS50eXBlKSB7CiAgICAgICAgbWFwLnNldChrZXksIG1ldGEudHlwZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfSkucmVhZE9ubHkoKSwKCiAgLyoqCiAgIEl0ZXJhdGVzIHRocm91Z2ggdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaAogICBhdHRyaWJ1dGUuCiAgICBUaGUgY2FsbGJhY2sgbWV0aG9kIHlvdSBwcm92aWRlIHNob3VsZCBoYXZlIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIChhbGwKICAgcGFyYW1ldGVycyBhcmUgb3B0aW9uYWwpOgogICAgYGBgamF2YXNjcmlwdAogICBmdW5jdGlvbihuYW1lLCBtZXRhKTsKICAgYGBgCiAgICAtIGBuYW1lYCB0aGUgbmFtZSBvZiB0aGUgY3VycmVudCBwcm9wZXJ0eSBpbiB0aGUgaXRlcmF0aW9uCiAgIC0gYG1ldGFgIHRoZSBtZXRhIG9iamVjdCBmb3IgdGhlIGF0dHJpYnV0ZSBwcm9wZXJ0eSBpbiB0aGUgaXRlcmF0aW9uCiAgICBOb3RlIHRoYXQgaW4gYWRkaXRpb24gdG8gYSBjYWxsYmFjaywgeW91IGNhbiBhbHNvIHBhc3MgYW4gb3B0aW9uYWwgdGFyZ2V0CiAgIG9iamVjdCB0aGF0IHdpbGwgYmUgc2V0IGFzIGB0aGlzYCBvbiB0aGUgY29udGV4dC4KICAgIEV4YW1wbGUKICAgIGBgYGphdmFzY3JpcHQKICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgbGV0IFBlcnNvbiA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGxhc3ROYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgYmlydGhkYXk6IERTLmF0dHIoJ2RhdGUnKQogICAgfSk7CiAgICBQZXJzb24uZWFjaEF0dHJpYnV0ZShmdW5jdGlvbihuYW1lLCBtZXRhKSB7CiAgICAgIGNvbnNvbGUubG9nKG5hbWUsIG1ldGEpOwogICAgfSk7CiAgICAvLyBwcmludHM6CiAgIC8vIGZpcnN0TmFtZSB7dHlwZTogInN0cmluZyIsIGlzQXR0cmlidXRlOiB0cnVlLCBvcHRpb25zOiBPYmplY3QsIHBhcmVudFR5cGU6IGZ1bmN0aW9uLCBuYW1lOiAiZmlyc3ROYW1lIn0KICAgLy8gbGFzdE5hbWUge3R5cGU6ICJzdHJpbmciLCBpc0F0dHJpYnV0ZTogdHJ1ZSwgb3B0aW9uczogT2JqZWN0LCBwYXJlbnRUeXBlOiBmdW5jdGlvbiwgbmFtZTogImxhc3ROYW1lIn0KICAgLy8gYmlydGhkYXkge3R5cGU6ICJkYXRlIiwgaXNBdHRyaWJ1dGU6IHRydWUsIG9wdGlvbnM6IE9iamVjdCwgcGFyZW50VHlwZTogZnVuY3Rpb24sIG5hbWU6ICJiaXJ0aGRheSJ9CiAgIGBgYAogICAgQG1ldGhvZCBlYWNoQXR0cmlidXRlCiAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgQHN0YXRpYwogICAqLwogIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIEVtYmVyLmdldCh0aGlzLCAnYXR0cmlidXRlcycpLmZvckVhY2goKG1ldGEsIG5hbWUpID0+IHsKICAgICAgY2FsbGJhY2suY2FsbChiaW5kaW5nLCBuYW1lLCBtZXRhKTsKICAgIH0pOwogIH0sCgogIC8qKgogICBJdGVyYXRlcyB0aHJvdWdoIHRoZSB0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nCiAgIHRoZSBwYXNzZWQgZnVuY3Rpb24gb24gZWFjaCBhdHRyaWJ1dGUuIE5vdGUgdGhlIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgIGNhbGxlZCBmb3IgYW55IGF0dHJpYnV0ZXMgdGhhdCBkbyBub3QgaGF2ZSBhbiB0cmFuc2Zvcm1hdGlvbiB0eXBlLgogICAgVGhlIGNhbGxiYWNrIG1ldGhvZCB5b3UgcHJvdmlkZSBzaG91bGQgaGF2ZSB0aGUgZm9sbG93aW5nIHNpZ25hdHVyZSAoYWxsCiAgIHBhcmFtZXRlcnMgYXJlIG9wdGlvbmFsKToKICAgIGBgYGphdmFzY3JpcHQKICAgZnVuY3Rpb24obmFtZSwgdHlwZSk7CiAgIGBgYAogICAgLSBgbmFtZWAgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgcHJvcGVydHkgaW4gdGhlIGl0ZXJhdGlvbgogICAtIGB0eXBlYCBhIHN0cmluZyBjb250YWluaW5nIHRoZSBuYW1lIG9mIHRoZSB0eXBlIG9mIHRyYW5zZm9ybWVkCiAgIGFwcGxpZWQgdG8gdGhlIGF0dHJpYnV0ZQogICAgTm90ZSB0aGF0IGluIGFkZGl0aW9uIHRvIGEgY2FsbGJhY2ssIHlvdSBjYW4gYWxzbyBwYXNzIGFuIG9wdGlvbmFsIHRhcmdldAogICBvYmplY3QgdGhhdCB3aWxsIGJlIHNldCBhcyBgdGhpc2Agb24gdGhlIGNvbnRleHQuCiAgICBFeGFtcGxlCiAgICBgYGBqYXZhc2NyaXB0CiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGxldCBQZXJzb24gPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICBmaXJzdE5hbWU6IERTLmF0dHIoKSwKICAgICAgbGFzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICBiaXJ0aGRheTogRFMuYXR0cignZGF0ZScpCiAgICB9KTsKICAgIFBlcnNvbi5lYWNoVHJhbnNmb3JtZWRBdHRyaWJ1dGUoZnVuY3Rpb24obmFtZSwgdHlwZSkgewogICAgICBjb25zb2xlLmxvZyhuYW1lLCB0eXBlKTsKICAgIH0pOwogICAgLy8gcHJpbnRzOgogICAvLyBsYXN0TmFtZSBzdHJpbmcKICAgLy8gYmlydGhkYXkgZGF0ZQogICBgYGAKICAgIEBtZXRob2QgZWFjaFRyYW5zZm9ybWVkQXR0cmlidXRlCiAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAgQHN0YXRpYwogICAqLwogIGVhY2hUcmFuc2Zvcm1lZEF0dHJpYnV0ZShjYWxsYmFjaywgYmluZGluZykgewogICAgRW1iZXIuZ2V0KHRoaXMsICd0cmFuc2Zvcm1lZEF0dHJpYnV0ZXMnKS5mb3JFYWNoKCh0eXBlLCBuYW1lKSA9PiB7CiAgICAgIGNhbGxiYWNrLmNhbGwoYmluZGluZywgbmFtZSwgdHlwZSk7CiAgICB9KTsKICB9Cn0pOwoKewogIE1vZGVsLnJlb3Blbih7CiAgICAvLyBUaGlzIGlzIGEgdGVtcG9yYXJ5IHNvbHV0aW9uIHVudGlsIHdlIHJlZmFjdG9yIERTLk1vZGVsIHRvIG5vdAogICAgLy8gcmVseSBvbiB0aGUgZGF0YSBwcm9wZXJ0eS4KICAgIHdpbGxNZXJnZU1peGluKHByb3BzKSB7CiAgICAgIHZhciBjb25zdHJ1Y3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICh0cnVlICYmICEoIWludGVyc2VjdGlvbihPYmplY3Qua2V5cyhwcm9wcyksIFJFU0VSVkVEX01PREVMX1BST1BTKVswXSkgJiYgRW1iZXIuYXNzZXJ0KCdgJyArIGludGVyc2VjdGlvbihPYmplY3Qua2V5cyhwcm9wcyksIFJFU0VSVkVEX01PREVMX1BST1BTKVswXSArICdgIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHkgbmFtZSBvbiBEUy5Nb2RlbCBvYmplY3RzLiBQbGVhc2UgY2hvb3NlIGEgZGlmZmVyZW50IHByb3BlcnR5IG5hbWUgZm9yICcgKyBjb25zdHJ1Y3Rvci50b1N0cmluZygpLCAhaW50ZXJzZWN0aW9uKE9iamVjdC5rZXlzKHByb3BzKSwgUkVTRVJWRURfTU9ERUxfUFJPUFMpWzBdKSk7CiAgICAgICh0cnVlICYmICEoT2JqZWN0LmtleXMocHJvcHMpLmluZGV4T2YoJ2lkJykgPT09IC0xKSAmJiBFbWJlci5hc3NlcnQoIllvdSBtYXkgbm90IHNldCBgaWRgIGFzIGFuIGF0dHJpYnV0ZSBvbiB5b3VyIG1vZGVsLiBQbGVhc2UgcmVtb3ZlIGFueSBsaW5lcyB0aGF0IGxvb2sgbGlrZTogYGlkOiBEUy5hdHRyKCc8dHlwZT4nKWAgZnJvbSAiICsgY29uc3RydWN0b3IudG9TdHJpbmcoKSwgT2JqZWN0LmtleXMocHJvcHMpLmluZGV4T2YoJ2lkJykgPT09IC0xKSk7CiAgICB9LAoKICAgIC8qKgogICAgIFRoaXMgRW1iZXIuanMgaG9vayBhbGxvd3MgYW4gb2JqZWN0IHRvIGJlIG5vdGlmaWVkIHdoZW4gYSBwcm9wZXJ0eQogICAgIGlzIGRlZmluZWQuCiAgICAgIEluIHRoaXMgY2FzZSwgd2UgdXNlIGl0IHRvIGJlIG5vdGlmaWVkIHdoZW4gYW4gRW1iZXIgRGF0YSB1c2VyIGRlZmluZXMgYQogICAgIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwLiBJbiB0aGF0IGNhc2UsIHdlIG5lZWQgdG8gc2V0IHVwIG9ic2VydmVycyBmb3IKICAgICBlYWNoIG9uZSwgYWxsb3dpbmcgdXMgdG8gdHJhY2sgcmVsYXRpb25zaGlwIGNoYW5nZXMgYW5kIGF1dG9tYXRpY2FsbHkKICAgICByZWZsZWN0IGNoYW5nZXMgaW4gdGhlIGludmVyc2UgaGFzLW1hbnkgYXJyYXkuCiAgICAgIFRoaXMgaG9vayBwYXNzZXMgdGhlIGNsYXNzIGJlaW5nIHNldCB1cCwgYXMgd2VsbCBhcyB0aGUga2V5IGFuZCB2YWx1ZQogICAgIGJlaW5nIGRlZmluZWQuIFNvLCBmb3IgZXhhbXBsZSwgd2hlbiB0aGUgdXNlciBkb2VzIHRoaXM6CiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBEUy5Nb2RlbC5leHRlbmQoewogICAgICBwYXJlbnQ6IERTLmJlbG9uZ3NUbygndXNlcicpCiAgICB9KTsKICAgICBgYGAKICAgICAgVGhpcyBob29rIHdvdWxkIGJlIGNhbGxlZCB3aXRoICJwYXJlbnQiIGFzIHRoZSBrZXkgYW5kIHRoZSBjb21wdXRlZAogICAgIHByb3BlcnR5IHJldHVybmVkIGJ5IGBEUy5iZWxvbmdzVG9gIGFzIHRoZSB2YWx1ZS4KICAgICAgQG1ldGhvZCBkaWREZWZpbmVQcm9wZXJ0eQogICAgIEBwYXJhbSB7T2JqZWN0fSBwcm90bwogICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICBAcGFyYW0ge0VtYmVyLkNvbXB1dGVkUHJvcGVydHl9IHZhbHVlCiAgICAgKi8KICAgIGRpZERlZmluZVByb3BlcnR5KHByb3RvLCBrZXksIHZhbHVlKSB7CiAgICAgIC8vIENoZWNrIGlmIHRoZSB2YWx1ZSBiZWluZyBzZXQgaXMgYSBjb21wdXRlZCBwcm9wZXJ0eS4KICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eSkgewoKICAgICAgICAvLyBJZiBpdCBpcywgZ2V0IHRoZSBtZXRhZGF0YSBmb3IgdGhlIHJlbGF0aW9uc2hpcC4gVGhpcyBpcwogICAgICAgIC8vIHBvcHVsYXRlZCBieSB0aGUgYERTLmJlbG9uZ3NUb2AgaGVscGVyIHdoZW4gaXQgaXMgY3JlYXRpbmcKICAgICAgICAvLyB0aGUgY29tcHV0ZWQgcHJvcGVydHkuCiAgICAgICAgdmFyIG1ldGEgPSB2YWx1ZS5tZXRhKCk7CgogICAgICAgIC8qCiAgICAgICAgICBUaGlzIGlzIGJ1Z2d5IGJlY2F1c2UgaWYgdGhlIHBhcmVudCBoYXMgbmV2ZXIgYmVlbiBsb29rZWQgdXAKICAgICAgICAgIHZpYSBgbW9kZWxGb3JgIGl0IHdpbGwgbm90IGhhdmUgYG1vZGVsTmFtZWAgc2V0LgogICAgICAgICAqLwogICAgICAgIG1ldGEucGFyZW50VHlwZSA9IHByb3RvLmNvbnN0cnVjdG9yOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCnZhciBTT1VSQ0VfUE9JTlRFUl9SRUdFWFAgPSAvXlwvP2RhdGFcLyhhdHRyaWJ1dGVzfHJlbGF0aW9uc2hpcHMpXC8oLiopLzsKdmFyIFNPVVJDRV9QT0lOVEVSX1BSSU1BUllfUkVHRVhQID0gL15cLz9kYXRhLzsKdmFyIFBSSU1BUllfQVRUUklCVVRFX0tFWSA9ICdiYXNlJzsKCi8qKgogIEEgYERTLkFkYXB0ZXJFcnJvcmAgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGFuIGVycm9yIG9jY3VycmVkCiAgZHVyaW5nIGEgcmVxdWVzdCB0byBhbiBleHRlcm5hbCBBUEkuIEl0IGluZGljYXRlcyBhIGdlbmVyaWMgZXJyb3IsIGFuZAogIHN1YmNsYXNzZXMgYXJlIHVzZWQgdG8gaW5kaWNhdGUgc3BlY2lmaWMgZXJyb3Igc3RhdGVzLiBUaGUgZm9sbG93aW5nCiAgc3ViY2xhc3NlcyBhcmUgcHJvdmlkZWQ6CgogIC0gYERTLkludmFsaWRFcnJvcmAKICAtIGBEUy5UaW1lb3V0RXJyb3JgCiAgLSBgRFMuQWJvcnRFcnJvcmAKICAtIGBEUy5VbmF1dGhvcml6ZWRFcnJvcmAKICAtIGBEUy5Gb3JiaWRkZW5FcnJvcmAKICAtIGBEUy5Ob3RGb3VuZEVycm9yYAogIC0gYERTLkNvbmZsaWN0RXJyb3JgCiAgLSBgRFMuU2VydmVyRXJyb3JgCgogIFRvIGNyZWF0ZSBhIGN1c3RvbSBlcnJvciB0byBzaWduYWwgYSBzcGVjaWZpYyBlcnJvciBzdGF0ZSBpbiBjb21tdW5pY2F0aW5nCiAgd2l0aCBhbiBleHRlcm5hbCBBUEksIGV4dGVuZCB0aGUgYERTLkFkYXB0ZXJFcnJvcmAuIEZvciBleGFtcGxlIGlmIHRoZQogIGV4dGVybmFsIEFQSSBleGNsdXNpdmVseSB1c2VkIEhUVFAgYDUwMyBTZXJ2aWNlIFVuYXZhaWxhYmxlYCB0byBpbmRpY2F0ZQogIGl0IHdhcyBjbG9zZWQgZm9yIG1haW50ZW5hbmNlOgoKICBgYGBhcHAvYWRhcHRlcnMvbWFpbnRlbmFuY2UtZXJyb3IuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXJFcnJvci5leHRlbmQoeyBtZXNzYWdlOiAiRG93biBmb3IgbWFpbnRlbmFuY2UuIiB9KTsKICBgYGAKCiAgVGhpcyBlcnJvciB3b3VsZCB0aGVuIGJlIHJldHVybmVkIGJ5IGFuIGFkYXB0ZXIncyBgaGFuZGxlUmVzcG9uc2VgIG1ldGhvZDoKCiAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogIGltcG9ydCBNYWludGVuYW5jZUVycm9yIGZyb20gJy4vbWFpbnRlbmFuY2UtZXJyb3InOwoKICBleHBvcnQgZGVmYXVsdCBEUy5KU09OQVBJQWRhcHRlci5leHRlbmQoewogICAgaGFuZGxlUmVzcG9uc2Uoc3RhdHVzKSB7CiAgICAgIGlmICg1MDMgPT09IHN0YXR1cykgewogICAgICAgIHJldHVybiBuZXcgTWFpbnRlbmFuY2VFcnJvcigpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIH0KICB9KTsKICBgYGAKCiAgQW5kIGNhbiB0aGVuIGJlIGRldGVjdGVkIGluIGFuIGFwcGxpY2F0aW9uIGFuZCB1c2VkIHRvIHNlbmQgdGhlIHVzZXIgdG8gYW4KICBgdW5kZXItbWFpbnRlbmFuY2VgIHJvdXRlOgoKICBgYGBhcHAvcm91dGVzL2FwcGxpY2F0aW9uLmpzCiAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICBpbXBvcnQgTWFpbnRlbmFuY2VFcnJvciBmcm9tICcuLi9hZGFwdGVycy9tYWludGVuYW5jZS1lcnJvcic7CgogIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICBhY3Rpb25zOiB7CiAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTWFpbnRlbmFuY2VFcnJvcikgewogICAgICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ3VuZGVyLW1haW50ZW5hbmNlJyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAuLi5vdGhlciBlcnJvciBoYW5kbGluZyBsb2dpYwogICAgICB9CiAgICB9CiAgfSk7CiAgYGBgCgogIEBjbGFzcyBBZGFwdGVyRXJyb3IKICBAbmFtZXNwYWNlIERTCiovCmZ1bmN0aW9uIEFkYXB0ZXJFcnJvcihlcnJvcnMsIG1lc3NhZ2UgPSAnQWRhcHRlciBvcGVyYXRpb24gZmFpbGVkJykgewogIHRoaXMuaXNBZGFwdGVyRXJyb3IgPSB0cnVlOwogIEVtYmVyLkVycm9yLmNhbGwodGhpcywgbWVzc2FnZSk7CgogIHRoaXMuZXJyb3JzID0gZXJyb3JzIHx8IFt7CiAgICB0aXRsZTogJ0FkYXB0ZXIgRXJyb3InLAogICAgZGV0YWlsOiBtZXNzYWdlCiAgfV07Cn0KCmZ1bmN0aW9uIGV4dGVuZEZuKEVycm9yQ2xhc3MpIHsKICByZXR1cm4gZnVuY3Rpb24gKHsgbWVzc2FnZTogZGVmYXVsdE1lc3NhZ2UgfSA9IHt9KSB7CiAgICByZXR1cm4gZXh0ZW5kKEVycm9yQ2xhc3MsIGRlZmF1bHRNZXNzYWdlKTsKICB9Owp9CgpmdW5jdGlvbiBleHRlbmQoUGFyZW50RXJyb3JDbGFzcywgZGVmYXVsdE1lc3NhZ2UpIHsKICB2YXIgRXJyb3JDbGFzcyA9IGZ1bmN0aW9uIChlcnJvcnMsIG1lc3NhZ2UpIHsKICAgICh0cnVlICYmICEoQXJyYXkuaXNBcnJheShlcnJvcnMgfHwgW10pKSAmJiBFbWJlci5hc3NlcnQoJ2BBZGFwdGVyRXJyb3JgIGV4cGVjdHMganNvbi1hcGkgZm9ybWF0dGVkIGVycm9ycyBhcnJheS4nLCBBcnJheS5pc0FycmF5KGVycm9ycyB8fCBbXSkpKTsKCiAgICBQYXJlbnRFcnJvckNsYXNzLmNhbGwodGhpcywgZXJyb3JzLCBtZXNzYWdlIHx8IGRlZmF1bHRNZXNzYWdlKTsKICB9OwogIEVycm9yQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQYXJlbnRFcnJvckNsYXNzLnByb3RvdHlwZSk7CiAgRXJyb3JDbGFzcy5leHRlbmQgPSBleHRlbmRGbihFcnJvckNsYXNzKTsKCiAgcmV0dXJuIEVycm9yQ2xhc3M7Cn0KCkFkYXB0ZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVtYmVyLkVycm9yLnByb3RvdHlwZSk7CgpBZGFwdGVyRXJyb3IuZXh0ZW5kID0gZXh0ZW5kRm4oQWRhcHRlckVycm9yKTsKCi8qKgogIEEgYERTLkludmFsaWRFcnJvcmAgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGUgZXh0ZXJuYWwgQVBJCiAgd2FzIHVuYWJsZSB0byBwcm9jZXNzIGEgcmVxdWVzdCBiZWNhdXNlIHRoZSBjb250ZW50IHdhcyBub3QKICBzZW1hbnRpY2FsbHkgY29ycmVjdCBvciBtZWFuaW5nZnVsIHBlciB0aGUgQVBJLiBVc3VhbGx5IHRoaXMgbWVhbnMgYQogIHJlY29yZCBmYWlsZWQgc29tZSBmb3JtIG9mIHNlcnZlciBzaWRlIHZhbGlkYXRpb24uIFdoZW4gYSBwcm9taXNlCiAgZnJvbSBhbiBhZGFwdGVyIGlzIHJlamVjdGVkIHdpdGggYSBgRFMuSW52YWxpZEVycm9yYCB0aGUgcmVjb3JkIHdpbGwKICB0cmFuc2l0aW9uIHRvIHRoZSBgaW52YWxpZGAgc3RhdGUgYW5kIHRoZSBlcnJvcnMgd2lsbCBiZSBzZXQgdG8gdGhlCiAgYGVycm9yc2AgcHJvcGVydHkgb24gdGhlIHJlY29yZC4KCiAgRm9yIEVtYmVyIERhdGEgdG8gY29ycmVjdGx5IG1hcCBlcnJvcnMgdG8gdGhlaXIgY29ycmVzcG9uZGluZwogIHByb3BlcnRpZXMgb24gdGhlIG1vZGVsLCBFbWJlciBEYXRhIGV4cGVjdHMgZWFjaCBlcnJvciB0byBiZQogIGEgdmFsaWQganNvbi1hcGkgZXJyb3Igb2JqZWN0IHdpdGggYSBgc291cmNlL3BvaW50ZXJgIHRoYXQgbWF0Y2hlcwogIHRoZSBwcm9wZXJ0eSBuYW1lLiBGb3IgZXhhbXBsZSBpZiB5b3UgaGFkIGEgUG9zdCBtb2RlbCB0aGF0CiAgbG9va2VkIGxpa2UgdGhpcy4KCiAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgdGl0bGU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgY29udGVudDogRFMuYXR0cignc3RyaW5nJykKICB9KTsKICBgYGAKCiAgVG8gc2hvdyBhbiBlcnJvciBmcm9tIHRoZSBzZXJ2ZXIgcmVsYXRlZCB0byB0aGUgYHRpdGxlYCBhbmQKICBgY29udGVudGAgcHJvcGVydGllcyB5b3VyIGFkYXB0ZXIgY291bGQgcmV0dXJuIGEgcHJvbWlzZSB0aGF0CiAgcmVqZWN0cyB3aXRoIGEgYERTLkludmFsaWRFcnJvcmAgb2JqZWN0IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoKICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgIHVwZGF0ZVJlY29yZCgpIHsKICAgICAgLy8gRmljdGlvbmFsIGFkYXB0ZXIgdGhhdCBhbHdheXMgcmVqZWN0cwogICAgICByZXR1cm4gUlNWUC5yZWplY3QobmV3IERTLkludmFsaWRFcnJvcihbCiAgICAgICAgewogICAgICAgICAgZGV0YWlsOiAnTXVzdCBiZSB1bmlxdWUnLAogICAgICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL3RpdGxlJyB9CiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBkZXRhaWw6ICdNdXN0IG5vdCBiZSBibGFuaycsCiAgICAgICAgICBzb3VyY2U6IHsgcG9pbnRlcjogJy9kYXRhL2F0dHJpYnV0ZXMvY29udGVudCd9CiAgICAgICAgfQogICAgICBdKSk7CiAgICB9CiAgfSk7CiAgYGBgCgogIFlvdXIgYmFja2VuZCBtYXkgdXNlIGRpZmZlcmVudCBwcm9wZXJ0eSBuYW1lcyBmb3IgeW91ciByZWNvcmRzIHRoZQogIHN0b3JlIHdpbGwgYXR0ZW1wdCBleHRyYWN0IGFuZCBub3JtYWxpemUgdGhlIGVycm9ycyB1c2luZyB0aGUKICBzZXJpYWxpemVyJ3MgYGV4dHJhY3RFcnJvcnNgIG1ldGhvZCBiZWZvcmUgdGhlIGVycm9ycyBnZXQgYWRkZWQgdG8KICB0aGUgdGhlIG1vZGVsLiBBcyBhIHJlc3VsdCwgaXQgaXMgc2FmZSBmb3IgdGhlIGBJbnZhbGlkRXJyb3JgIHRvCiAgd3JhcCB0aGUgZXJyb3IgcGF5bG9hZCB1bmFsdGVyZWQuCgogIEBjbGFzcyBJbnZhbGlkRXJyb3IKICBAbmFtZXNwYWNlIERTCiovCnZhciBJbnZhbGlkRXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgcmVqZWN0ZWQgdGhlIGNvbW1pdCBiZWNhdXNlIGl0IHdhcyBpbnZhbGlkJyk7CgovKioKICBBIGBEUy5UaW1lb3V0RXJyb3JgIGlzIHVzZWQgYnkgYW4gYWRhcHRlciB0byBzaWduYWwgdGhhdCBhIHJlcXVlc3QKICB0byB0aGUgZXh0ZXJuYWwgQVBJIGhhcyB0aW1lZCBvdXQuIEkuZS4gbm8gcmVzcG9uc2Ugd2FzIHJlY2VpdmVkIGZyb20KICB0aGUgZXh0ZXJuYWwgQVBJIHdpdGhpbiBhbiBhbGxvd2VkIHRpbWUgcGVyaW9kLgoKICBBbiBleGFtcGxlIHVzZSBjYXNlIHdvdWxkIGJlIHRvIHdhcm4gdGhlIHVzZXIgdG8gY2hlY2sgdGhlaXIgaW50ZXJuZXQKICBjb25uZWN0aW9uIGlmIGFuIGFkYXB0ZXIgb3BlcmF0aW9uIGhhcyB0aW1lZCBvdXQ6CgogIGBgYGFwcC9yb3V0ZXMvYXBwbGljYXRpb24uanMKICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgY29uc3QgeyBUaW1lb3V0RXJyb3IgfSA9IERTOwoKICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgYWN0aW9uczogewogICAgICBlcnJvcihlcnJvciwgdHJhbnNpdGlvbikgewogICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFRpbWVvdXRFcnJvcikgewogICAgICAgICAgLy8gYWxlcnQgdGhlIHVzZXIKICAgICAgICAgIGFsZXJ0KCdBcmUgeW91IHN0aWxsIGNvbm5lY3RlZCB0byB0aGUgaW50ZXJuZXQ/Jyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAuLi5vdGhlciBlcnJvciBoYW5kbGluZyBsb2dpYwogICAgICB9CiAgICB9CiAgfSk7CiAgYGBgCgogIEBjbGFzcyBUaW1lb3V0RXJyb3IKICBAbmFtZXNwYWNlIERTCiovCnZhciBUaW1lb3V0RXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgb3BlcmF0aW9uIHRpbWVkIG91dCcpOwoKLyoqCiAgQSBgRFMuQWJvcnRFcnJvcmAgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGEgcmVxdWVzdCB0bwogIHRoZSBleHRlcm5hbCBBUEkgd2FzIGFib3J0ZWQuIEZvciBleGFtcGxlLCB0aGlzIGNhbiBvY2N1ciBpZiB0aGUgdXNlcgogIG5hdmlnYXRlcyBhd2F5IGZyb20gdGhlIGN1cnJlbnQgcGFnZSBhZnRlciBhIHJlcXVlc3QgdG8gdGhlIGV4dGVybmFsIEFQSQogIGhhcyBiZWVuIGluaXRpYXRlZCBidXQgYmVmb3JlIGEgcmVzcG9uc2UgaGFzIGJlZW4gcmVjZWl2ZWQuCgogIEBjbGFzcyBBYm9ydEVycm9yCiAgQG5hbWVzcGFjZSBEUwoqLwp2YXIgQWJvcnRFcnJvciA9IGV4dGVuZChBZGFwdGVyRXJyb3IsICdUaGUgYWRhcHRlciBvcGVyYXRpb24gd2FzIGFib3J0ZWQnKTsKCi8qKgogIEEgYERTLlVuYXV0aG9yaXplZEVycm9yYCBlcXVhdGVzIHRvIGEgSFRUUCBgNDAxIFVuYXV0aG9yaXplZGAgcmVzcG9uc2UKICBzdGF0dXMuIEl0IGlzIHVzZWQgYnkgYW4gYWRhcHRlciB0byBzaWduYWwgdGhhdCBhIHJlcXVlc3QgdG8gdGhlIGV4dGVybmFsCiAgQVBJIHdhcyByZWplY3RlZCBiZWNhdXNlIGF1dGhvcml6YXRpb24gaXMgcmVxdWlyZWQgYW5kIGhhcyBmYWlsZWQgb3IgaGFzIG5vdAogIHlldCBiZWVuIHByb3ZpZGVkLgoKICBBbiBleGFtcGxlIHVzZSBjYXNlIHdvdWxkIGJlIHRvIHJlZGlyZWN0IHRoZSB1c2VyIHRvIGEgbG9nIGluIHJvdXRlIGlmIGEKICByZXF1ZXN0IGlzIHVuYXV0aG9yaXplZDoKCiAgYGBgYXBwL3JvdXRlcy9hcHBsaWNhdGlvbi5qcwogIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBjb25zdCB7IFVuYXV0aG9yaXplZEVycm9yIH0gPSBEUzsKCiAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgIGFjdGlvbnM6IHsKICAgICAgZXJyb3IoZXJyb3IsIHRyYW5zaXRpb24pIHsKICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhvcml6ZWRFcnJvcikgewogICAgICAgICAgLy8gZ28gdG8gdGhlIHNpZ24gaW4gcm91dGUKICAgICAgICAgIHRoaXMudHJhbnNpdGlvblRvKCdsb2dpbicpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gLi4ub3RoZXIgZXJyb3IgaGFuZGxpbmcgbG9naWMKICAgICAgfQogICAgfQogIH0pOwogIGBgYAoKICBAY2xhc3MgVW5hdXRob3JpemVkRXJyb3IKICBAbmFtZXNwYWNlIERTCiovCnZhciBVbmF1dGhvcml6ZWRFcnJvciA9IGV4dGVuZChBZGFwdGVyRXJyb3IsICdUaGUgYWRhcHRlciBvcGVyYXRpb24gaXMgdW5hdXRob3JpemVkJyk7CgovKioKICBBIGBEUy5Gb3JiaWRkZW5FcnJvcmAgZXF1YXRlcyB0byBhIEhUVFAgYDQwMyBGb3JiaWRkZW5gIHJlc3BvbnNlIHN0YXR1cy4KICBJdCBpcyB1c2VkIGJ5IGFuIGFkYXB0ZXIgdG8gc2lnbmFsIHRoYXQgYSByZXF1ZXN0IHRvIHRoZSBleHRlcm5hbCBBUEkgd2FzCiAgdmFsaWQgYnV0IHRoZSBzZXJ2ZXIgaXMgcmVmdXNpbmcgdG8gcmVzcG9uZCB0byBpdC4gSWYgYXV0aG9yaXphdGlvbiB3YXMKICBwcm92aWRlZCBhbmQgaXMgdmFsaWQsIHRoZW4gdGhlIGF1dGhlbnRpY2F0ZWQgdXNlciBkb2VzIG5vdCBoYXZlIHRoZQogIG5lY2Vzc2FyeSBwZXJtaXNzaW9ucyBmb3IgdGhlIHJlcXVlc3QuCgogIEBjbGFzcyBGb3JiaWRkZW5FcnJvcgogIEBuYW1lc3BhY2UgRFMKKi8KdmFyIEZvcmJpZGRlbkVycm9yID0gZXh0ZW5kKEFkYXB0ZXJFcnJvciwgJ1RoZSBhZGFwdGVyIG9wZXJhdGlvbiBpcyBmb3JiaWRkZW4nKTsKCi8qKgogIEEgYERTLk5vdEZvdW5kRXJyb3JgIGVxdWF0ZXMgdG8gYSBIVFRQIGA0MDQgTm90IEZvdW5kYCByZXNwb25zZSBzdGF0dXMuCiAgSXQgaXMgdXNlZCBieSBhbiBhZGFwdGVyIHRvIHNpZ25hbCB0aGF0IGEgcmVxdWVzdCB0byB0aGUgZXh0ZXJuYWwgQVBJCiAgd2FzIHJlamVjdGVkIGJlY2F1c2UgdGhlIHJlc291cmNlIGNvdWxkIG5vdCBiZSBmb3VuZCBvbiB0aGUgQVBJLgoKICBBbiBleGFtcGxlIHVzZSBjYXNlIHdvdWxkIGJlIHRvIGRldGVjdCBpZiB0aGUgdXNlciBoYXMgZW50ZXJlZCBhIHJvdXRlCiAgZm9yIGEgc3BlY2lmaWMgbW9kZWwgdGhhdCBkb2VzIG5vdCBleGlzdC4gRm9yIGV4YW1wbGU6CgogIGBgYGFwcC9yb3V0ZXMvcG9zdC5qcwogIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBjb25zdCB7IE5vdEZvdW5kRXJyb3IgfSA9IERTOwoKICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgbW9kZWwocGFyYW1zKSB7CiAgICAgIHJldHVybiB0aGlzLmdldCgnc3RvcmUnKS5maW5kUmVjb3JkKCdwb3N0JywgcGFyYW1zLnBvc3RfaWQpOwogICAgfSwKCiAgICBhY3Rpb25zOiB7CiAgICAgIGVycm9yKGVycm9yLCB0cmFuc2l0aW9uKSB7CiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTm90Rm91bmRFcnJvcikgewogICAgICAgICAgLy8gcmVkaXJlY3QgdG8gYSBsaXN0IG9mIGFsbCBwb3N0cyBpbnN0ZWFkCiAgICAgICAgICB0aGlzLnRyYW5zaXRpb25UbygncG9zdHMnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gb3RoZXJ3aXNlIGxldCB0aGUgZXJyb3IgYnViYmxlCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBgYGAKCiAgQGNsYXNzIE5vdEZvdW5kRXJyb3IKICBAbmFtZXNwYWNlIERTCiovCnZhciBOb3RGb3VuZEVycm9yID0gZXh0ZW5kKEFkYXB0ZXJFcnJvciwgJ1RoZSBhZGFwdGVyIGNvdWxkIG5vdCBmaW5kIHRoZSByZXNvdXJjZScpOwoKLyoqCiAgQSBgRFMuQ29uZmxpY3RFcnJvcmAgZXF1YXRlcyB0byBhIEhUVFAgYDQwOSBDb25mbGljdGAgcmVzcG9uc2Ugc3RhdHVzLgogIEl0IGlzIHVzZWQgYnkgYW4gYWRhcHRlciB0byBpbmRpY2F0ZSB0aGF0IHRoZSByZXF1ZXN0IGNvdWxkIG5vdCBiZSBwcm9jZXNzZWQKICBiZWNhdXNlIG9mIGEgY29uZmxpY3QgaW4gdGhlIHJlcXVlc3QuIEFuIGV4YW1wbGUgc2NlbmFyaW8gd291bGQgYmUgd2hlbgogIGNyZWF0aW5nIGEgcmVjb3JkIHdpdGggYSBjbGllbnQgZ2VuZXJhdGVkIGlkIGJ1dCB0aGF0IGlkIGlzIGFscmVhZHkga25vd24KICB0byB0aGUgZXh0ZXJuYWwgQVBJLgoKICBAY2xhc3MgQ29uZmxpY3RFcnJvcgogIEBuYW1lc3BhY2UgRFMKKi8KdmFyIENvbmZsaWN0RXJyb3IgPSBleHRlbmQoQWRhcHRlckVycm9yLCAnVGhlIGFkYXB0ZXIgb3BlcmF0aW9uIGZhaWxlZCBkdWUgdG8gYSBjb25mbGljdCcpOwoKLyoqCiAgQSBgRFMuU2VydmVyRXJyb3JgIGVxdWF0ZXMgdG8gYSBIVFRQIGA1MDAgSW50ZXJuYWwgU2VydmVyIEVycm9yYCByZXNwb25zZQogIHN0YXR1cy4gSXQgaXMgdXNlZCBieSB0aGUgYWRhcHRlciB0byBpbmRpY2F0ZSB0aGF0IGEgcmVxdWVzdCBoYXMgZmFpbGVkCiAgYmVjYXVzZSBvZiBhbiBlcnJvciBpbiB0aGUgZXh0ZXJuYWwgQVBJLgoKICBAY2xhc3MgU2VydmVyRXJyb3IKICBAbmFtZXNwYWNlIERTCiovCnZhciBTZXJ2ZXJFcnJvciA9IGV4dGVuZChBZGFwdGVyRXJyb3IsICdUaGUgYWRhcHRlciBvcGVyYXRpb24gZmFpbGVkIGR1ZSB0byBhIHNlcnZlciBlcnJvcicpOwoKLyoqCiAgQ29udmVydCBhbiBoYXNoIG9mIGVycm9ycyBpbnRvIGFuIGFycmF5IHdpdGggZXJyb3JzIGluIEpTT04tQVBJIGZvcm1hdC4KCiAgYGBgamF2YXNjcmlwdAogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgY29uc3QgeyBlcnJvcnNIYXNoVG9BcnJheSB9ID0gRFM7CgogIGxldCBlcnJvcnMgPSB7CiAgICBiYXNlOiAnSW52YWxpZCBhdHRyaWJ1dGVzIG9uIHNhdmluZyB0aGlzIHJlY29yZCcsCiAgICBuYW1lOiAnTXVzdCBiZSBwcmVzZW50JywKICAgIGFnZTogWydNdXN0IGJlIHByZXNlbnQnLCAnTXVzdCBiZSBhIG51bWJlciddCiAgfTsKCiAgbGV0IGVycm9yc0FycmF5ID0gZXJyb3JzSGFzaFRvQXJyYXkoZXJyb3JzKTsKICAvLyBbCiAgLy8gICB7CiAgLy8gICAgIHRpdGxlOiAiSW52YWxpZCBEb2N1bWVudCIsCiAgLy8gICAgIGRldGFpbDogIkludmFsaWQgYXR0cmlidXRlcyBvbiBzYXZpbmcgdGhpcyByZWNvcmQiLAogIC8vICAgICBzb3VyY2U6IHsgcG9pbnRlcjogIi9kYXRhIiB9CiAgLy8gICB9LAogIC8vICAgewogIC8vICAgICB0aXRsZTogIkludmFsaWQgQXR0cmlidXRlIiwKICAvLyAgICAgZGV0YWlsOiAiTXVzdCBiZSBwcmVzZW50IiwKICAvLyAgICAgc291cmNlOiB7IHBvaW50ZXI6ICIvZGF0YS9hdHRyaWJ1dGVzL25hbWUiIH0KICAvLyAgIH0sCiAgLy8gICB7CiAgLy8gICAgIHRpdGxlOiAiSW52YWxpZCBBdHRyaWJ1dGUiLAogIC8vICAgICBkZXRhaWw6ICJNdXN0IGJlIHByZXNlbnQiLAogIC8vICAgICBzb3VyY2U6IHsgcG9pbnRlcjogIi9kYXRhL2F0dHJpYnV0ZXMvYWdlIiB9CiAgLy8gICB9LAogIC8vICAgewogIC8vICAgICB0aXRsZTogIkludmFsaWQgQXR0cmlidXRlIiwKICAvLyAgICAgZGV0YWlsOiAiTXVzdCBiZSBhIG51bWJlciIsCiAgLy8gICAgIHNvdXJjZTogeyBwb2ludGVyOiAiL2RhdGEvYXR0cmlidXRlcy9hZ2UiIH0KICAvLyAgIH0KICAvLyBdCiAgYGBgCgogIEBtZXRob2QgZXJyb3JzSGFzaFRvQXJyYXkKICBAcHVibGljCiAgQG5hbWVzcGFjZQogIEBmb3IgRFMKICBAcGFyYW0ge09iamVjdH0gZXJyb3JzIGhhc2ggd2l0aCBlcnJvcnMgYXMgcHJvcGVydGllcwogIEByZXR1cm4ge0FycmF5fSBhcnJheSBvZiBlcnJvcnMgaW4gSlNPTi1BUEkgZm9ybWF0CiovCmZ1bmN0aW9uIGVycm9yc0hhc2hUb0FycmF5KGVycm9ycykgewogIHZhciBvdXQgPSBbXTsKCiAgaWYgKEVtYmVyLmlzUHJlc2VudChlcnJvcnMpKSB7CiAgICBPYmplY3Qua2V5cyhlcnJvcnMpLmZvckVhY2goa2V5ID0+IHsKICAgICAgdmFyIG1lc3NhZ2VzID0gRW1iZXIubWFrZUFycmF5KGVycm9yc1trZXldKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB0aXRsZSA9ICdJbnZhbGlkIEF0dHJpYnV0ZSc7CiAgICAgICAgdmFyIHBvaW50ZXIgPSBgL2RhdGEvYXR0cmlidXRlcy8ke2tleX1gOwogICAgICAgIGlmIChrZXkgPT09IFBSSU1BUllfQVRUUklCVVRFX0tFWSkgewogICAgICAgICAgdGl0bGUgPSAnSW52YWxpZCBEb2N1bWVudCc7CiAgICAgICAgICBwb2ludGVyID0gYC9kYXRhYDsKICAgICAgICB9CiAgICAgICAgb3V0LnB1c2goewogICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgZGV0YWlsOiBtZXNzYWdlc1tpXSwKICAgICAgICAgIHNvdXJjZTogewogICAgICAgICAgICBwb2ludGVyOiBwb2ludGVyCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgcmV0dXJuIG91dDsKfQoKLyoqCiAgQ29udmVydCBhbiBhcnJheSBvZiBlcnJvcnMgaW4gSlNPTi1BUEkgZm9ybWF0IGludG8gYW4gb2JqZWN0LgoKICBgYGBqYXZhc2NyaXB0CiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBjb25zdCB7IGVycm9yc0FycmF5VG9IYXNoIH0gPSBEUzsKCiAgbGV0IGVycm9yc0FycmF5ID0gWwogICAgewogICAgICB0aXRsZTogJ0ludmFsaWQgQXR0cmlidXRlJywKICAgICAgZGV0YWlsOiAnTXVzdCBiZSBwcmVzZW50JywKICAgICAgc291cmNlOiB7IHBvaW50ZXI6ICcvZGF0YS9hdHRyaWJ1dGVzL25hbWUnIH0KICAgIH0sCiAgICB7CiAgICAgIHRpdGxlOiAnSW52YWxpZCBBdHRyaWJ1dGUnLAogICAgICBkZXRhaWw6ICdNdXN0IGJlIHByZXNlbnQnLAogICAgICBzb3VyY2U6IHsgcG9pbnRlcjogJy9kYXRhL2F0dHJpYnV0ZXMvYWdlJyB9CiAgICB9LAogICAgewogICAgICB0aXRsZTogJ0ludmFsaWQgQXR0cmlidXRlJywKICAgICAgZGV0YWlsOiAnTXVzdCBiZSBhIG51bWJlcicsCiAgICAgIHNvdXJjZTogeyBwb2ludGVyOiAnL2RhdGEvYXR0cmlidXRlcy9hZ2UnIH0KICAgIH0KICBdOwoKICBsZXQgZXJyb3JzID0gZXJyb3JzQXJyYXlUb0hhc2goZXJyb3JzQXJyYXkpOwogIC8vIHsKICAvLyAgICJuYW1lIjogWyJNdXN0IGJlIHByZXNlbnQiXSwKICAvLyAgICJhZ2UiOiAgWyJNdXN0IGJlIHByZXNlbnQiLCAibXVzdCBiZSBhIG51bWJlciJdCiAgLy8gfQogIGBgYAoKICBAbWV0aG9kIGVycm9yc0FycmF5VG9IYXNoCiAgQHB1YmxpYwogIEBuYW1lc3BhY2UKICBAZm9yIERTCiAgQHBhcmFtIHtBcnJheX0gZXJyb3JzIGFycmF5IG9mIGVycm9ycyBpbiBKU09OLUFQSSBmb3JtYXQKICBAcmV0dXJuIHtPYmplY3R9CiovCmZ1bmN0aW9uIGVycm9yc0FycmF5VG9IYXNoKGVycm9ycykgewogIHZhciBvdXQgPSB7fTsKCiAgaWYgKEVtYmVyLmlzUHJlc2VudChlcnJvcnMpKSB7CiAgICBlcnJvcnMuZm9yRWFjaChlcnJvciA9PiB7CiAgICAgIGlmIChlcnJvci5zb3VyY2UgJiYgZXJyb3Iuc291cmNlLnBvaW50ZXIpIHsKICAgICAgICB2YXIga2V5ID0gZXJyb3Iuc291cmNlLnBvaW50ZXIubWF0Y2goU09VUkNFX1BPSU5URVJfUkVHRVhQKTsKCiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAga2V5ID0ga2V5WzJdOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3Iuc291cmNlLnBvaW50ZXIuc2VhcmNoKFNPVVJDRV9QT0lOVEVSX1BSSU1BUllfUkVHRVhQKSAhPT0gLTEpIHsKICAgICAgICAgIGtleSA9IFBSSU1BUllfQVRUUklCVVRFX0tFWTsKICAgICAgICB9CgogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgIG91dFtrZXldID0gb3V0W2tleV0gfHwgW107CiAgICAgICAgICBvdXRba2V5XS5wdXNoKGVycm9yLmRldGFpbCB8fCBlcnJvci50aXRsZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIE9yZGVyZWRTZXQoKSB7CiAgdGhpcy5fc3VwZXIkY29uc3RydWN0b3IoKTsKfQoKT3JkZXJlZFNldC5jcmVhdGUgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIENvbnN0cnVjdG9yID0gdGhpczsKICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKCk7Cn07CgpPcmRlcmVkU2V0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRW1iZXJPcmRlcmVkU2V0LnByb3RvdHlwZSk7Ck9yZGVyZWRTZXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gT3JkZXJlZFNldDsKT3JkZXJlZFNldC5wcm90b3R5cGUuX3N1cGVyJGNvbnN0cnVjdG9yID0gRW1iZXJPcmRlcmVkU2V0OwoKT3JkZXJlZFNldC5wcm90b3R5cGUuYWRkV2l0aEluZGV4ID0gZnVuY3Rpb24gKG9iaiwgaWR4KSB7CiAgdmFyIGd1aWQgPSBFbWJlci5ndWlkRm9yKG9iaik7CiAgdmFyIHByZXNlbmNlU2V0ID0gdGhpcy5wcmVzZW5jZVNldDsKICB2YXIgbGlzdCA9IHRoaXMubGlzdDsKCiAgaWYgKHByZXNlbmNlU2V0W2d1aWRdID09PSB0cnVlKSB7CiAgICByZXR1cm47CiAgfQoKICBwcmVzZW5jZVNldFtndWlkXSA9IHRydWU7CgogIGlmIChpZHggPT09IHVuZGVmaW5lZCB8fCBpZHggPT09IG51bGwpIHsKICAgIGxpc3QucHVzaChvYmopOwogIH0gZWxzZSB7CiAgICBsaXN0LnNwbGljZShpZHgsIDAsIG9iaik7CiAgfQoKICB0aGlzLnNpemUgKz0gMTsKCiAgcmV0dXJuIHRoaXM7Cn07CgovKgogIFRoaXMgbWV0aG9kIG5vcm1hbGl6ZXMgYSBsaW5rIHRvIGFuICJsaW5rcyBvYmplY3QiLiBJZiB0aGUgcGFzc2VkIGxpbmsgaXMKICBhbHJlYWR5IGFuIG9iamVjdCBpdCdzIHJldHVybmVkIHdpdGhvdXQgYW55IG1vZGlmaWNhdGlvbnMuCgogIFNlZSBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1saW5rcyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KCiAgQG1ldGhvZCBfbm9ybWFsaXplTGluawogIEBwcml2YXRlCiAgQHBhcmFtIHtTdHJpbmd9IGxpbmsKICBAcmV0dXJuIHtPYmplY3R8bnVsbH0KICBAZm9yIERTCiovCmZ1bmN0aW9uIF9ub3JtYWxpemVMaW5rKGxpbmspIHsKICBzd2l0Y2ggKHR5cGVvZiBsaW5rKSB7CiAgICBjYXNlICdvYmplY3QnOgogICAgICByZXR1cm4gbGluazsKICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgIHJldHVybiB7IGhyZWY6IGxpbmsgfTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCmNsYXNzIFJlbGF0aW9uc2hpcCB7CiAgY29uc3RydWN0b3Ioc3RvcmUsIGludGVybmFsTW9kZWwsIGludmVyc2VLZXksIHJlbGF0aW9uc2hpcE1ldGEpIHsKICAgIHZhciBhc3luYyA9IHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5hc3luYzsKICAgIHZhciBwb2x5bW9ycGhpYyA9IHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5wb2x5bW9ycGhpYzsKICAgIHRoaXMubWVtYmVycyA9IG5ldyBPcmRlcmVkU2V0KCk7CiAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMgPSBuZXcgT3JkZXJlZFNldCgpOwogICAgdGhpcy5zdG9yZSA9IHN0b3JlOwogICAgdGhpcy5rZXkgPSByZWxhdGlvbnNoaXBNZXRhLmtleTsKICAgIHRoaXMua2luZCA9IHJlbGF0aW9uc2hpcE1ldGEua2luZDsKICAgIHRoaXMuaW52ZXJzZUtleSA9IGludmVyc2VLZXk7CiAgICB0aGlzLmludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsOwogICAgdGhpcy5pc0FzeW5jID0gdHlwZW9mIGFzeW5jID09PSAndW5kZWZpbmVkJyA/IHRydWUgOiBhc3luYzsKICAgIHRoaXMuaXNQb2x5bW9ycGhpYyA9IHR5cGVvZiBwb2x5bW9ycGhpYyA9PT0gJ3VuZGVmaW5lZCcgPyBmYWxzZSA6IHBvbHltb3JwaGljOwogICAgdGhpcy5yZWxhdGlvbnNoaXBNZXRhID0gcmVsYXRpb25zaGlwTWV0YTsKICAgIC8vVGhpcyBwcm9iYWJseSBicmVha3MgZm9yIHBvbHltb3JwaGljIHJlbGF0aW9uc2hpcCBpbiBjb21wbGV4IHNjZW5hcmlvcywgZHVlIHRvCiAgICAvL211bHRpcGxlIHBvc3NpYmxlIG1vZGVsTmFtZXMKICAgIHRoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0ID0gdGhpcy5pbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSArIHRoaXMua2V5OwogICAgdGhpcy5mZXRjaFByb21pc2UgPSBudWxsOwogICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgIHRoaXMubWV0YSA9IG51bGw7CiAgICB0aGlzLl9faW52ZXJzZU1ldGEgPSB1bmRlZmluZWQ7CgogICAgLyoKICAgICAgVGhpcyBmbGFnIGZvcmNlcyBmZXRjaC4gYHRydWVgIGZvciBhIHNpbmdsZSByZXF1ZXN0IG9uY2UgYHJlbG9hZCgpYAogICAgICAgIGhhcyBiZWVuIGNhbGxlZCBgZmFsc2VgIGF0IGFsbCBvdGhlciB0aW1lcy4KICAgICAqLwogICAgdGhpcy5zaG91bGRGb3JjZVJlbG9hZCA9IGZhbHNlOwoKICAgIC8qCiAgICAgICBUaGlzIGZsYWcgaW5kaWNhdGVzIHdoZXRoZXIgd2Ugc2hvdWxkCiAgICAgICAgcmUtZmV0Y2ggdGhlIHJlbGF0aW9uc2hpcCB0aGUgbmV4dCB0aW1lCiAgICAgICAgaXQgaXMgYWNjZXNzZWQuCiAgICAgICAgIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhpcyBmbGFnIGFuZCBgc2hvdWxkRm9yY2VSZWxvYWRgCiAgICAgICAgaXMgaW4gaG93IHdlIHRyZWF0IHRoZSBwcmVzZW5jZSBvZiBwYXJ0aWFsbHkgbWlzc2luZyBkYXRhOgogICAgICAgICAgLSBmb3IgYSBmb3JjZWQgcmVsb2FkLCB3ZSB3aWxsIHJlbG9hZCB0aGUgbGluayBvciBFVkVSWSByZWNvcmQKICAgICAgICAgIC0gZm9yIGEgc3RhbGUgcmVsb2FkLCB3ZSB3aWxsIHJlbG9hZCB0aGUgbGluayAoaWYgcHJlc2VudCkgZWxzZSBvbmx5IE1JU1NJTkcgcmVjb3JkcwogICAgICAgICBJZGVhbGx5IHRoZXNlIGZsYWdzIGNvdWxkIGJlIG1lcmdlZCwgYnV0IGJlY2F1c2Ugd2UgZG9uJ3QgZ2l2ZSB0aGUKICAgICAgICByZXF1ZXN0IGxheWVyIHRoZSBvcHRpb24gb2YgZGVjaWRpbmcgaG93IHRvIHJlc29sdmUgdGhlIGRhdGEgYmVpbmcgcXVlcmllZAogICAgICAgIHdlIGFyZSBmb3JjZWQgdG8gZGlmZmVyZW50aWF0ZSBmb3Igbm93LgogICAgICAgICBJdCBpcyBhbHNvIHBvc3NpYmxlIGZvciBhIHJlbGF0aW9uc2hpcCB0byByZW1haW4gc3RhbGUgYWZ0ZXIgYSBmb3JjZWQgcmVsb2FkOyBob3dldmVyLAogICAgICAgIGluIHRoaXMgY2FzZSBgaGFzRmFpbGVkTG9hZEF0dGVtcHRgIG91Z2h0IHRvIGJlIGB0cnVlYC4KICAgICAgIGZhbHNlIHdoZW4KICAgICAgICA9PiBpbnRlcm5hbE1vZGVsLmlzTmV3KCkgb24gaW5pdGlhbCBzZXR1cAogICAgICAgID0+IGEgcHJldmlvdXNseSB0cmlnZ2VyZWQgcmVxdWVzdCBoYXMgcmVzb2x2ZWQKICAgICAgICA9PiB3ZSBnZXQgcmVsYXRpb25zaGlwIGRhdGEgdmlhIHB1c2gKICAgICAgIHRydWUgd2hlbgogICAgICAgID0+ICFpbnRlcm5hbE1vZGVsLmlzTmV3KCkgb24gaW5pdGlhbCBzZXR1cAogICAgICAgID0+IGFuIGludmVyc2UgaGFzIGJlZW4gdW5sb2FkZWQKICAgICAgICA9PiB3ZSBnZXQgYSBuZXcgbGluayBmb3IgdGhlIHJlbGF0aW9uc2hpcAogICAgICovCiAgICB0aGlzLnJlbGF0aW9uc2hpcElzU3RhbGUgPSAhdGhpcy5pc05ldzsKCiAgICAvKgogICAgICBUaGlzIGZsYWcgaW5kaWNhdGVzIHdoZXRoZXIgd2Ugc2hvdWxkIGNvbnNpZGVyIHRoZSBjb250ZW50CiAgICAgICBvZiB0aGlzIHJlbGF0aW9uc2hpcCAia25vd24iLgogICAgICAgSWYgd2UgaGF2ZSBubyByZWxhdGlvbnNoaXAga25vd2xlZGdlLCBhbmQgdGhlIHJlbGF0aW9uc2hpcAogICAgICAgaXMgYGFzeW5jYCwgd2Ugd2lsbCBhdHRlbXB0IHRvIGZldGNoIHRoZSByZWxhdGlvbnNoaXAgb24KICAgICAgIGFjY2VzcyBpZiBpdCBpcyBhbHNvIHN0YWxlLgogICAgICBTbmFwc2hvdCB1c2VzIHRoaXMgdG8gdGVsbCB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHVua25vd24KICAgICAgKGB1bmRlZmluZWRgKSBvciBlbXB0eSAoYG51bGxgKS4gVGhlIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0CiAgICAgIHdlIHdvdWxkbid0IHdhbnQgdG8gc2VyaWFsaXplICB1bmtub3duIHJlbGF0aW9uc2hpcHMgYXMgYG51bGxgCiAgICAgIGFzIHRoYXQgbWlnaHQgb3ZlcndyaXRlIHJlbW90ZSBzdGF0ZS4KICAgICAgIEFsbCByZWxhdGlvbnNoaXBzIGZvciBhIG5ld2x5IGNyZWF0ZWQgKGBzdG9yZS5jcmVhdGVSZWNvcmQoKWApIGFyZQogICAgICAgY29uc2lkZXJlZCBrbm93biAoYGhhc0FueVJlbGF0aW9uc2hpcERhdGEgPT09IHRydWVgKS4KICAgICAgIHRydWUgd2hlbgogICAgICAgID0+IHdlIHJlY2VpdmUgYSBwdXNoIHdpdGggZWl0aGVyIG5ldyBkYXRhIG9yIGV4cGxpY2l0IGVtcHR5IChgW11gIG9yIGBudWxsYCkKICAgICAgICA9PiB0aGUgcmVsYXRpb25zaGlwIGlzIGEgYmVsb25nc1RvIGFuZCB3ZSBoYXZlIHJlY2VpdmVkIGRhdGEgZnJvbQogICAgICAgICAgICAgdGhlIG90aGVyIHNpZGUuCiAgICAgICBmYWxzZSB3aGVuCiAgICAgICAgPT4gd2UgaGF2ZSByZWNlaXZlZCBubyBzaWduYWwgYWJvdXQgd2hhdCBkYXRhIGJlbG9uZ3MgaW4gdGhpcyByZWxhdGlvbnNoaXAKICAgICAgICA9PiB0aGUgcmVsYXRpb25zaGlwIGlzIGEgaGFzTWFueSBhbmQgd2UgaGF2ZSBvbmx5IHJlY2VpdmVkIGRhdGEgZnJvbQogICAgICAgICAgICB0aGUgb3RoZXIgc2lkZS4KICAgICAqLwogICAgdGhpcy5oYXNBbnlSZWxhdGlvbnNoaXBEYXRhID0gZmFsc2U7CgogICAgLyoKICAgICAgRmxhZyB0aGF0IGluZGljYXRlcyB3aGV0aGVyIGFuIGVtcHR5IHJlbGF0aW9uc2hpcCBpcyBleHBsaWNpdGx5IGVtcHR5CiAgICAgICAgKHNpZ25hbGVkIGJ5IHB1c2ggZ2l2aW5nIHVzIGFuIGVtcHR5IGFycmF5IG9yIG51bGwgcmVsYXRpb25zaGlwKQogICAgICAgIGUuZy4gYW4gQVBJIHJlc3BvbnNlIGhhcyB0b2xkIHVzIHRoYXQgdGhpcyByZWxhdGlvbnNoaXAgaXMgZW1wdHkuCiAgICAgICBUaHVzIGZhciwgaXQgZG9lcyBub3QgYXBwZWFyIHRoYXQgd2UgYWN0dWFsbHkgbmVlZCB0aGlzIGZsYWc7IGhvd2V2ZXIsCiAgICAgICAgQHJ1bnNwaXJlZCBoYXMgZm91bmQgaXQgaW52YWx1YWJsZSB3aGVuIGRlYnVnZ2luZyByZWxhdGlvbnNoaXAgdGVzdHMKICAgICAgICB0byBkZXRlcm1pbmUgd2hldGhlciAoYW5kIHdoeSBpZiBzbykgd2UgYXJlIGluIGFuIGluY29ycmVjdCBzdGF0ZS4KICAgICAgIHRydWUgd2hlbgogICAgICAgID0+IHdlIHJlY2VpdmUgYSBwdXNoIHdpdGggZXhwbGljaXQgZW1wdHkgKGBbXWAgb3IgYG51bGxgKQogICAgICAgID0+IHdlIGhhdmUgcmVjZWl2ZWQgbm8gc2lnbmFsIGFib3V0IHdoYXQgZGF0YSBiZWxvbmdzIGluIHRoaXMgcmVsYXRpb25zaGlwCiAgICAgICAgPT4gb24gaW5pdGlhbCBjcmVhdGUgKGFzIG5vIHNpZ25hbCBpcyBrbm93biB5ZXQpCiAgICAgICBmYWxzZSBhdCBhbGwgb3RoZXIgdGltZXMKICAgICAqLwogICAgdGhpcy5yZWxhdGlvbnNoaXBJc0VtcHR5ID0gdHJ1ZTsKCiAgICAvKgogICAgICBGbGFnIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIgd2UgaGF2ZSBleHBsaWNpdGx5IGF0dGVtcHRlZCBhIGxvYWQgZm9yIHRoZSByZWxhdGlvbnNoaXAKICAgICAgKHdoaWNoIG1heSBoYXZlIGZhaWxlZCkKICAgICAqLwogICAgdGhpcy5oYXNGYWlsZWRMb2FkQXR0ZW1wdCA9IGZhbHNlOwoKICAgIC8qCiAgICAgIHRydWUgd2hlbgogICAgICAgID0+IGhhc0FueVJlbGF0aW9uc2hpcERhdGEgaXMgdHJ1ZQogICAgICAgIEFORAogICAgICAgID0+IG1lbWJlcnMgKE5PVCBjYW5vbmljYWxNZW1iZXJzKSBAZWFjaCAhaXNFbXB0eQogICAgICAgVE9ETywgY29uc2lkZXIgY2hhbmdpbmcgdGhlIGNvbmRpdGlvbmFsIGhlcmUgZnJvbSAhaXNFbXB0eSB0byAhaGlkZGVuRnJvbVJlY29yZEFycmF5cwogICAgICovCiAgfQoKICBnZXQgaXNOZXcoKSB7CiAgICByZXR1cm4gdGhpcy5pbnRlcm5hbE1vZGVsLmlzTmV3KCk7CiAgfQoKICBfaW52ZXJzZUlzU3luYygpIHsKICAgIHZhciBpbnZlcnNlTWV0YSA9IHRoaXMuX2ludmVyc2VNZXRhOwogICAgaWYgKCFpbnZlcnNlTWV0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIGludmVyc2VBc3luYyA9IGludmVyc2VNZXRhLm9wdGlvbnMuYXN5bmM7CiAgICByZXR1cm4gdHlwZW9mIGludmVyc2VBc3luYyA9PT0gJ3VuZGVmaW5lZCcgPyBmYWxzZSA6ICFpbnZlcnNlQXN5bmM7CiAgfQoKICBnZXQgX2ludmVyc2VNZXRhKCkgewogICAgaWYgKHRoaXMuX19pbnZlcnNlTWV0YSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhciBpbnZlcnNlTWV0YSA9IG51bGw7CgogICAgICBpZiAodGhpcy5pbnZlcnNlS2V5KSB7CiAgICAgICAgdmFyIGludmVyc2VNb2RlbENsYXNzID0gdGhpcy5zdG9yZS5tb2RlbEZvcih0aGlzLnJlbGF0aW9uc2hpcE1ldGEudHlwZSk7CiAgICAgICAgdmFyIGludmVyc2VSZWxhdGlvbnNoaXBzID0gRW1iZXIuZ2V0KGludmVyc2VNb2RlbENsYXNzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpOwogICAgICAgIGludmVyc2VNZXRhID0gaW52ZXJzZVJlbGF0aW9uc2hpcHMuZ2V0KHRoaXMuaW52ZXJzZUtleSk7CiAgICAgIH0KCiAgICAgIHRoaXMuX19pbnZlcnNlTWV0YSA9IGludmVyc2VNZXRhOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9faW52ZXJzZU1ldGE7CiAgfQoKICBnZXQgcGFyZW50VHlwZSgpIHsKICAgIHJldHVybiB0aGlzLmludGVybmFsTW9kZWwubW9kZWxOYW1lOwogIH0KCiAgaW50ZXJuYWxNb2RlbERpZERlbWF0ZXJpYWxpemUoKSB7CiAgICBpZiAoIXRoaXMuaW52ZXJzZUtleSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5mb3JBbGxNZW1iZXJzKGludmVyc2VJbnRlcm5hbE1vZGVsID0+IHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IGludmVyc2VJbnRlcm5hbE1vZGVsLl9yZWxhdGlvbnNoaXBzLmdldCh0aGlzLmludmVyc2VLZXkpOwogICAgICByZWxhdGlvbnNoaXAuaW52ZXJzZURpZERlbWF0ZXJpYWxpemUodGhpcy5pbnRlcm5hbE1vZGVsKTsKICAgIH0pOwogIH0KCiAgaW52ZXJzZURpZERlbWF0ZXJpYWxpemUoaW52ZXJzZUludGVybmFsTW9kZWwpIHsKICAgIHRoaXMuZmV0Y2hQcm9taXNlID0gbnVsbDsKICAgIHRoaXMuc2V0UmVsYXRpb25zaGlwSXNTdGFsZSh0cnVlKTsKCiAgICBpZiAoIXRoaXMuaXNBc3luYykgewogICAgICAvLyB1bmxvYWRpbmcgaW52ZXJzZSBvZiBhIHN5bmMgcmVsYXRpb25zaGlwIGlzIHRyZWF0ZWQgYXMgYSBjbGllbnQtc2lkZQogICAgICAvLyBkZWxldGUsIHNvIGFjdHVhbGx5IHJlbW92ZSB0aGUgbW9kZWxzIGRvbid0IG1lcmVseSBpbnZhbGlkYXRlIHRoZSBjcAogICAgICAvLyBjYWNoZS4KICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bihpbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsSW50ZXJuYWxNb2RlbEZyb21Pd24oaW52ZXJzZUludGVybmFsTW9kZWwpOwogICAgfQogIH0KCiAgdXBkYXRlTWV0YShtZXRhKSB7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KCiAgY2xlYXIoKSB7CgogICAgdmFyIG1lbWJlcnMgPSB0aGlzLm1lbWJlcnMubGlzdDsKICAgIHdoaWxlIChtZW1iZXJzLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIG1lbWJlciA9IG1lbWJlcnNbMF07CiAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxNb2RlbChtZW1iZXIpOwogICAgfQoKICAgIHZhciBjYW5vbmljYWxNZW1iZXJzID0gdGhpcy5jYW5vbmljYWxNZW1iZXJzLmxpc3Q7CiAgICB3aGlsZSAoY2Fub25pY2FsTWVtYmVycy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBfbWVtYmVyID0gY2Fub25pY2FsTWVtYmVyc1swXTsKICAgICAgdGhpcy5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsKF9tZW1iZXIpOwogICAgfQogIH0KCiAgcmVtb3ZlQWxsSW50ZXJuYWxNb2RlbHNGcm9tT3duKCkgewogICAgdGhpcy5tZW1iZXJzLmNsZWFyKCk7CiAgICB0aGlzLmludGVybmFsTW9kZWwudXBkYXRlUmVjb3JkQXJyYXlzKCk7CiAgfQoKICByZW1vdmVBbGxDYW5vbmljYWxJbnRlcm5hbE1vZGVsc0Zyb21Pd24oKSB7CiAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuY2xlYXIoKTsKICAgIHRoaXMuZmx1c2hDYW5vbmljYWxMYXRlcigpOwogIH0KCiAgcmVtb3ZlSW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMpIHsKICAgIGludGVybmFsTW9kZWxzLmZvckVhY2goaW50ZXJuYWxNb2RlbCA9PiB0aGlzLnJlbW92ZUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCkpOwogIH0KCiAgYWRkSW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMsIGlkeCkgewogICAgaW50ZXJuYWxNb2RlbHMuZm9yRWFjaChpbnRlcm5hbE1vZGVsID0+IHsKICAgICAgdGhpcy5hZGRJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWwsIGlkeCk7CiAgICAgIGlmIChpZHggIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlkeCsrOwogICAgICB9CiAgICB9KTsKICB9CgogIGFkZENhbm9uaWNhbEludGVybmFsTW9kZWxzKGludGVybmFsTW9kZWxzLCBpZHgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGlkeCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhpcy5hZGRDYW5vbmljYWxJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWxzW2ldLCBpICsgaWR4KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFkZENhbm9uaWNhbEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbHNbaV0pOwogICAgICB9CiAgICB9CiAgfQoKICBhZGRDYW5vbmljYWxJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWwsIGlkeCkgewogICAgaWYgKCF0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKGludGVybmFsTW9kZWwpKSB7CiAgICAgIHRoaXMuY2Fub25pY2FsTWVtYmVycy5hZGQoaW50ZXJuYWxNb2RlbCk7CiAgICAgIHRoaXMuc2V0dXBJbnZlcnNlUmVsYXRpb25zaGlwKGludGVybmFsTW9kZWwpOwogICAgfQogICAgdGhpcy5mbHVzaENhbm9uaWNhbExhdGVyKCk7CiAgICB0aGlzLnNldEhhc0FueVJlbGF0aW9uc2hpcERhdGEodHJ1ZSk7CiAgfQoKICBzZXR1cEludmVyc2VSZWxhdGlvbnNoaXAoaW50ZXJuYWxNb2RlbCkgewogICAgaWYgKHRoaXMuaW52ZXJzZUtleSkgewogICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IGludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHM7CiAgICAgIHZhciByZWxhdGlvbnNoaXBFeGlzdGVkID0gcmVsYXRpb25zaGlwcy5oYXModGhpcy5pbnZlcnNlS2V5KTsKICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcHMuZ2V0KHRoaXMuaW52ZXJzZUtleSk7CiAgICAgIGlmIChyZWxhdGlvbnNoaXBFeGlzdGVkIHx8IHRoaXMuaXNQb2x5bW9ycGhpYykgewogICAgICAgIC8vIGlmIHdlIGhhdmUgb25seSBqdXN0IGluaXRpYWxpemVkIHRoZSBpbnZlcnNlIHJlbGF0aW9uc2hpcCwgdGhlbiBpdAogICAgICAgIC8vIGFscmVhZHkgaGFzIHRoaXMuaW50ZXJuYWxNb2RlbCBpbiBpdHMgY2Fub25pY2FsTWVtYmVycywgc28gc2tpcCB0aGUKICAgICAgICAvLyB1bm5lY2Vzc2FyeSB3b3JrLiAgVGhlIGV4Y2VwdGlvbiB0byB0aGlzIGlzIHBvbHltb3JwaGljCiAgICAgICAgLy8gcmVsYXRpb25zaGlwcyB3aG9zZSBtZW1iZXJzIGFyZSBkZXRlcm1pbmVkIGJ5IHRoZWlyIGludmVyc2UsIGFzIHRob3NlCiAgICAgICAgLy8gcmVsYXRpb25zaGlwcyBjYW5ub3QgZWZmaWNpZW50bHkgZmluZCB0aGVpciBpbnZlcnNlIHBheWxvYWRzLgogICAgICAgIHJlbGF0aW9uc2hpcC5hZGRDYW5vbmljYWxJbnRlcm5hbE1vZGVsKHRoaXMuaW50ZXJuYWxNb2RlbCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBfcmVsYXRpb25zaGlwcyA9IGludGVybmFsTW9kZWwuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgICAgdmFyIF9yZWxhdGlvbnNoaXAgPSBfcmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF07CiAgICAgIGlmICghX3JlbGF0aW9uc2hpcCkgewogICAgICAgIF9yZWxhdGlvbnNoaXAgPSBfcmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0gPSBuZXcgUmVsYXRpb25zaGlwKHRoaXMuc3RvcmUsIGludGVybmFsTW9kZWwsIHRoaXMua2V5LCB7IG9wdGlvbnM6IHsgYXN5bmM6IHRoaXMuaXNBc3luYyB9LCB0eXBlOiB0aGlzLnBhcmVudFR5cGUgfSk7CiAgICAgIH0KICAgICAgX3JlbGF0aW9uc2hpcC5hZGRDYW5vbmljYWxJbnRlcm5hbE1vZGVsKHRoaXMuaW50ZXJuYWxNb2RlbCk7CiAgICB9CiAgfQoKICByZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscywgaWR4KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChpZHggIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsc1tpXSwgaSArIGlkeCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWxzW2ldKTsKICAgICAgfQogICAgfQogIH0KCiAgcmVtb3ZlQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBpZHgpIHsKICAgIGlmICh0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKGludGVybmFsTW9kZWwpKSB7CiAgICAgIHRoaXMucmVtb3ZlQ2Fub25pY2FsSW50ZXJuYWxNb2RlbEZyb21Pd24oaW50ZXJuYWxNb2RlbCk7CiAgICAgIGlmICh0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tSW52ZXJzZShpbnRlcm5hbE1vZGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaW50ZXJuYWxNb2RlbC5faW1wbGljaXRSZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XSkgewogICAgICAgICAgaW50ZXJuYWxNb2RlbC5faW1wbGljaXRSZWxhdGlvbnNoaXBzW3RoaXMuaW52ZXJzZUtleUZvckltcGxpY2l0XS5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsKHRoaXMuaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICB0aGlzLmZsdXNoQ2Fub25pY2FsTGF0ZXIoKTsKICB9CgogIGFkZEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCwgaWR4KSB7CiAgICBpZiAoIXRoaXMubWVtYmVycy5oYXMoaW50ZXJuYWxNb2RlbCkpIHsKICAgICAgdGhpcy5tZW1iZXJzLmFkZFdpdGhJbmRleChpbnRlcm5hbE1vZGVsLCBpZHgpOwogICAgICB0aGlzLm5vdGlmeVJlY29yZFJlbGF0aW9uc2hpcEFkZGVkKGludGVybmFsTW9kZWwsIGlkeCk7CiAgICAgIGlmICh0aGlzLmludmVyc2VLZXkpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsLl9yZWxhdGlvbnNoaXBzLmdldCh0aGlzLmludmVyc2VLZXkpLmFkZEludGVybmFsTW9kZWwodGhpcy5pbnRlcm5hbE1vZGVsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuX2ltcGxpY2l0UmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0pIHsKICAgICAgICAgIGludGVybmFsTW9kZWwuX2ltcGxpY2l0UmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0gPSBuZXcgUmVsYXRpb25zaGlwKHRoaXMuc3RvcmUsIGludGVybmFsTW9kZWwsIHRoaXMua2V5LCB7IG9wdGlvbnM6IHsgYXN5bmM6IHRoaXMuaXNBc3luYyB9LCB0eXBlOiB0aGlzLnBhcmVudFR5cGUgfSk7CiAgICAgICAgfQogICAgICAgIGludGVybmFsTW9kZWwuX2ltcGxpY2l0UmVsYXRpb25zaGlwc1t0aGlzLmludmVyc2VLZXlGb3JJbXBsaWNpdF0uYWRkSW50ZXJuYWxNb2RlbCh0aGlzLmludGVybmFsTW9kZWwpOwogICAgICB9CiAgICAgIHRoaXMuaW50ZXJuYWxNb2RlbC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICAgIH0KICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICB9CgogIHJlbW92ZUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCkgewogICAgaWYgKHRoaXMubWVtYmVycy5oYXMoaW50ZXJuYWxNb2RlbCkpIHsKICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bihpbnRlcm5hbE1vZGVsKTsKICAgICAgaWYgKHRoaXMuaW52ZXJzZUtleSkgewogICAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxNb2RlbEZyb21JbnZlcnNlKGludGVybmFsTW9kZWwpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpbnRlcm5hbE1vZGVsLl9pbXBsaWNpdFJlbGF0aW9uc2hpcHNbdGhpcy5pbnZlcnNlS2V5Rm9ySW1wbGljaXRdKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsLl9pbXBsaWNpdFJlbGF0aW9uc2hpcHNbdGhpcy5pbnZlcnNlS2V5Rm9ySW1wbGljaXRdLnJlbW92ZUludGVybmFsTW9kZWwodGhpcy5pbnRlcm5hbE1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHJlbW92ZUludGVybmFsTW9kZWxGcm9tSW52ZXJzZShpbnRlcm5hbE1vZGVsKSB7CiAgICB2YXIgaW52ZXJzZVJlbGF0aW9uc2hpcCA9IGludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuZ2V0KHRoaXMuaW52ZXJzZUtleSk7CiAgICAvL05lZWQgdG8gY2hlY2sgZm9yIGV4aXN0ZW5jZSwgYXMgdGhlIHJlY29yZCBtaWdodCB1bmxvYWRpbmcgYXQgdGhlIG1vbWVudAogICAgaWYgKGludmVyc2VSZWxhdGlvbnNoaXApIHsKICAgICAgaW52ZXJzZVJlbGF0aW9uc2hpcC5yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bih0aGlzLmludGVybmFsTW9kZWwpOwogICAgfQogIH0KCiAgcmVtb3ZlSW50ZXJuYWxNb2RlbEZyb21Pd24oaW50ZXJuYWxNb2RlbCkgewogICAgdGhpcy5tZW1iZXJzLmRlbGV0ZShpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMuaW50ZXJuYWxNb2RlbC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICB9CgogIHJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tSW52ZXJzZShpbnRlcm5hbE1vZGVsKSB7CiAgICB2YXIgaW52ZXJzZVJlbGF0aW9uc2hpcCA9IGludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuZ2V0KHRoaXMuaW52ZXJzZUtleSk7CiAgICAvL05lZWQgdG8gY2hlY2sgZm9yIGV4aXN0ZW5jZSwgYXMgdGhlIHJlY29yZCBtaWdodCB1bmxvYWRpbmcgYXQgdGhlIG1vbWVudAogICAgaWYgKGludmVyc2VSZWxhdGlvbnNoaXApIHsKICAgICAgaW52ZXJzZVJlbGF0aW9uc2hpcC5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsRnJvbU93bih0aGlzLmludGVybmFsTW9kZWwpOwogICAgfQogIH0KCiAgcmVtb3ZlQ2Fub25pY2FsSW50ZXJuYWxNb2RlbEZyb21Pd24oaW50ZXJuYWxNb2RlbCkgewogICAgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmRlbGV0ZShpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMuZmx1c2hDYW5vbmljYWxMYXRlcigpOwogIH0KCiAgLyoKICAgIENhbGwgdGhpcyBtZXRob2Qgb25jZSBhIHJlY29yZCBkZWxldGlvbiBoYXMgYmVlbiBwZXJzaXN0ZWQKICAgIHRvIHB1cmdlIGl0IGZyb20gQk9USCBjdXJyZW50IGFuZCBjYW5vbmljYWwgc3RhdGUgb2YgYWxsCiAgICByZWxhdGlvbnNoaXBzLgogICAgIEBtZXRob2QgcmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlCiAgICBAcHJpdmF0ZQogICAqLwogIHJlbW92ZUNvbXBsZXRlbHlGcm9tSW52ZXJzZSgpIHsKICAgIGlmICghdGhpcy5pbnZlcnNlS2V5KSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyB3ZSBhY3R1YWxseSB3YW50IGEgdW5pb24gb2YgbWVtYmVycyBhbmQgY2Fub25pY2FsTWVtYmVycwogICAgLy8gdGhleSBzaG91bGQgYmUgZGlzam9pbnQgYnV0IGN1cnJlbnRseSBhcmUgbm90IGR1ZSB0byBhIGJ1ZwogICAgdmFyIHNlZW4gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLmludGVybmFsTW9kZWw7CgogICAgdmFyIHVubG9hZCA9IGludmVyc2VJbnRlcm5hbE1vZGVsID0+IHsKICAgICAgdmFyIGlkID0gRW1iZXIuZ3VpZEZvcihpbnZlcnNlSW50ZXJuYWxNb2RlbCk7CgogICAgICBpZiAoc2VlbltpZF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciByZWxhdGlvbnNoaXAgPSBpbnZlcnNlSW50ZXJuYWxNb2RlbC5fcmVsYXRpb25zaGlwcy5nZXQodGhpcy5pbnZlcnNlS2V5KTsKICAgICAgICByZWxhdGlvbnNoaXAucmVtb3ZlQ29tcGxldGVseUZyb21Pd24oaW50ZXJuYWxNb2RlbCk7CiAgICAgICAgc2VlbltpZF0gPSB0cnVlOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMubWVtYmVycy5mb3JFYWNoKHVubG9hZCk7CiAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuZm9yRWFjaCh1bmxvYWQpOwoKICAgIGlmICghdGhpcy5pc0FzeW5jKSB7CiAgICAgIHRoaXMuY2xlYXIoKTsKICAgIH0KICB9CgogIGZvckFsbE1lbWJlcnMoY2FsbGJhY2spIHsKICAgIHZhciBzZWVuID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWVtYmVycy5saXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBpbnZlcnNlSW50ZXJuYWxNb2RlbCA9IHRoaXMubWVtYmVycy5saXN0W2ldOwogICAgICB2YXIgaWQgPSBFbWJlci5ndWlkRm9yKGludmVyc2VJbnRlcm5hbE1vZGVsKTsKICAgICAgaWYgKCFzZWVuW2lkXSkgewogICAgICAgIHNlZW5baWRdID0gdHJ1ZTsKICAgICAgICBjYWxsYmFjayhpbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmxpc3QubGVuZ3RoOyBfaSsrKSB7CiAgICAgIHZhciBfaW52ZXJzZUludGVybmFsTW9kZWwgPSB0aGlzLmNhbm9uaWNhbE1lbWJlcnMubGlzdFtfaV07CiAgICAgIHZhciBfaWQgPSBFbWJlci5ndWlkRm9yKF9pbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICAgIGlmICghc2VlbltfaWRdKSB7CiAgICAgICAgc2VlbltfaWRdID0gdHJ1ZTsKICAgICAgICBjYWxsYmFjayhfaW52ZXJzZUludGVybmFsTW9kZWwpOwogICAgICB9CiAgICB9CiAgfQoKICAvKgogICAgUmVtb3ZlcyB0aGUgZ2l2ZW4gaW50ZXJuYWxNb2RlbCBmcm9tIEJPVEggY2Fub25pY2FsIEFORCBjdXJyZW50IHN0YXRlLgogICAgIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCB3aGVuIGVpdGhlciBhIGRlbGV0aW9uIG9yIGEgcm9sbGJhY2sgb24gYSBuZXcgcmVjb3JkCiAgICBuZWVkcyB0byBlbnRpcmVseSBwdXJnZSBpdHNlbGYgZnJvbSBhbiBpbnZlcnNlIHJlbGF0aW9uc2hpcC4KICAgKi8KICByZW1vdmVDb21wbGV0ZWx5RnJvbU93bihpbnRlcm5hbE1vZGVsKSB7CiAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuZGVsZXRlKGludGVybmFsTW9kZWwpOwogICAgdGhpcy5tZW1iZXJzLmRlbGV0ZShpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMuaW50ZXJuYWxNb2RlbC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICB9CgogIGZsdXNoQ2Fub25pY2FsKCkgewogICAgdmFyIGxpc3QgPSB0aGlzLm1lbWJlcnMubGlzdDsKICAgIHRoaXMud2lsbFN5bmMgPSBmYWxzZTsKICAgIC8vYSBoYWNrIGZvciBub3QgcmVtb3ZpbmcgbmV3IGludGVybmFsTW9kZWxzCiAgICAvL1RPRE8gcmVtb3ZlIG9uY2Ugd2UgaGF2ZSBwcm9wZXIgZGlmZmluZwogICAgdmFyIG5ld0ludGVybmFsTW9kZWxzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGxpc3RbaV0uaXNOZXcoKSkgewogICAgICAgIG5ld0ludGVybmFsTW9kZWxzLnB1c2gobGlzdFtpXSk7CiAgICAgIH0KICAgIH0KCiAgICAvL1RPRE8oSWdvcikgbWFrZSB0aGlzIGxlc3MgYWJ5c21hbGx5IHNsb3cKICAgIHRoaXMubWVtYmVycyA9IHRoaXMuY2Fub25pY2FsTWVtYmVycy5jb3B5KCk7CiAgICBmb3IgKHZhciBfaTIgPSAwOyBfaTIgPCBuZXdJbnRlcm5hbE1vZGVscy5sZW5ndGg7IF9pMisrKSB7CiAgICAgIHRoaXMubWVtYmVycy5hZGQobmV3SW50ZXJuYWxNb2RlbHNbX2kyXSk7CiAgICB9CiAgfQoKICBmbHVzaENhbm9uaWNhbExhdGVyKCkgewogICAgaWYgKHRoaXMud2lsbFN5bmMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy53aWxsU3luYyA9IHRydWU7CiAgICB0aGlzLnN0b3JlLl91cGRhdGVSZWxhdGlvbnNoaXBTdGF0ZSh0aGlzKTsKICB9CgogIHVwZGF0ZUxpbmsobGluaywgaW5pdGlhbCkgewogICAgKHRydWUgJiYgRW1iZXIud2FybihgWW91IHB1c2hlZCBhIHJlY29yZCBvZiB0eXBlICcke3RoaXMuaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9JyB3aXRoIGEgcmVsYXRpb25zaGlwICcke3RoaXMua2V5fScgY29uZmlndXJlZCBhcyAnYXN5bmM6IGZhbHNlJy4gWW91J3ZlIGluY2x1ZGVkIGEgbGluayBidXQgbm8gcHJpbWFyeSBkYXRhLCB0aGlzIG1heSBiZSBhbiBlcnJvciBpbiB5b3VyIHBheWxvYWQuIEVtYmVyRGF0YSB3aWxsIHRyZWF0IHRoaXMgcmVsYXRpb25zaGlwIGFzIGtub3duLXRvLWJlLWVtcHR5LmAsIHRoaXMuaXNBc3luYyB8fCB0aGlzLmhhc0FueVJlbGF0aW9uc2hpcERhdGEsIHsKICAgICAgaWQ6ICdkcy5zdG9yZS5wdXNoLWxpbmstZm9yLXN5bmMtcmVsYXRpb25zaGlwJwogICAgfSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbGluayA9PT0gJ3N0cmluZycgfHwgbGluayA9PT0gbnVsbCkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgaGF2ZSBwdXNoZWQgYSByZWNvcmQgb2YgdHlwZSAnJHt0aGlzLmludGVybmFsTW9kZWwubW9kZWxOYW1lfScgd2l0aCAnJHt0aGlzLmtleX0nIGFzIGEgbGluaywgYnV0IHRoZSB2YWx1ZSBvZiB0aGF0IGxpbmsgaXMgbm90IGEgc3RyaW5nLmAsIHR5cGVvZiBsaW5rID09PSAnc3RyaW5nJyB8fCBsaW5rID09PSBudWxsKSk7CgoKICAgIHRoaXMubGluayA9IGxpbms7CiAgICB0aGlzLmZldGNoUHJvbWlzZSA9IG51bGw7CiAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzU3RhbGUodHJ1ZSk7CgogICAgaWYgKCFpbml0aWFsKSB7CiAgICAgIHRoaXMuaW50ZXJuYWxNb2RlbC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSh0aGlzLmtleSk7CiAgICB9CiAgfQoKICByZWxvYWQoKSB7CiAgICBpZiAodGhpcy5fcHJvbWlzZVByb3h5KSB7CiAgICAgIGlmICh0aGlzLl9wcm9taXNlUHJveHkuZ2V0KCdpc1BlbmRpbmcnKSkgewogICAgICAgIHJldHVybiB0aGlzLl9wcm9taXNlUHJveHk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnNldEhhc0ZhaWxlZExvYWRBdHRlbXB0KGZhbHNlKTsKICAgIHRoaXMuc2V0U2hvdWxkRm9yY2VSZWxvYWQodHJ1ZSk7CiAgICB0aGlzLmdldERhdGEoKTsKCiAgICByZXR1cm4gdGhpcy5fcHJvbWlzZVByb3h5OwogIH0KCiAgc2hvdWxkTWFrZVJlcXVlc3QoKSB7CiAgICB2YXIgewogICAgICByZWxhdGlvbnNoaXBJc1N0YWxlLAogICAgICBoYXNGYWlsZWRMb2FkQXR0ZW1wdCwKICAgICAgYWxsSW52ZXJzZVJlY29yZHNBcmVMb2FkZWQsCiAgICAgIGhhc0FueVJlbGF0aW9uc2hpcERhdGEsCiAgICAgIHNob3VsZEZvcmNlUmVsb2FkLAogICAgICByZWxhdGlvbnNoaXBJc0VtcHR5LAogICAgICBpc0FzeW5jLAogICAgICBpc05ldywKICAgICAgZmV0Y2hQcm9taXNlCiAgICB9ID0gdGhpczsKCiAgICAvLyBuZXZlciBtYWtlIGEgcmVxdWVzdCBpZiB0aGlzIHJlY29yZCBkb2Vzbid0IGV4aXN0IHNlcnZlciBzaWRlIHlldAogICAgaWYgKGlzTmV3ID09PSB0cnVlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBkbyBub3QgcmUtcmVxdWVzdCBpZiB3ZSBhcmUgYWxyZWFkeSBhd2FpdGluZyBhIHJlcXVlc3QKICAgIGlmIChmZXRjaFByb21pc2UgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFsd2F5cyBtYWtlIGEgcmVxdWVzdCB3aGVuIGZvcmNlZAogICAgLy8gIGZhaWxlZCBhdHRlbXB0cyBtdXN0IGNhbGwgYHJlbG9hZCgpYC4KICAgIC8vCiAgICAvLyBGb3IgbGVnYWN5IHJlYXNvbnMsIHdoZW4gYSByZWxhdGlvbnNoaXAgaXMgbWlzc2luZyBvbmx5CiAgICAvLyAgIHNvbWUgb2YgaXQncyBkYXRhIHdlIHJlbHkgb24gaW5kaXZpZHVhbCBgZmluZFJlY29yZGAKICAgIC8vICAgY2FsbHMgd2hpY2ggbWF5IHJlc29sdmUgZnJvbSBjYWNoZSBpbiB0aGUgbm9uLWxpbmsgY2FzZS4KICAgIC8vICAgVGhpcyBkZXRlcm1pbmF0aW9uIGlzIG1hZGUgZWxzZXdoZXJlLgogICAgLy8KICAgIGlmIChzaG91bGRGb3JjZVJlbG9hZCA9PT0gdHJ1ZSB8fCByZWxhdGlvbnNoaXBJc1N0YWxlID09PSB0cnVlKSB7CiAgICAgIHJldHVybiAhaGFzRmFpbGVkTG9hZEF0dGVtcHQ7CiAgICB9CgogICAgLy8gbmV2ZXIgbWFrZSBhIHJlcXVlc3QgaWYgd2UndmUgZXhwbGljaXRseSBhdHRlbXB0ZWQgdG8gYXQgbGVhc3Qgb25jZQogICAgLy8gc2luY2UgdGhlIGxhc3QgdXBkYXRlIHRvIGNhbm9uaWNhbCBzdGF0ZQogICAgLy8gdGhpcyBpbmNsdWRlcyBmYWlsZWQgYXR0ZW1wdHMKICAgIC8vICBlLmcuIHRvIHJlLWF0dGVtcHQgYHJlbG9hZCgpYCBtdXN0IGJlIGNhbGxlZCBmb3JjZSB0aGUgYXR0ZW1wdC4KICAgIGlmIChoYXNGYWlsZWRMb2FkQXR0ZW1wdCA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gd2Ugd2VyZSBleHBsaWNpdGx5IHRvbGQgdGhhdCB0aGVyZSBpcyBubyBpbnZlcnNlIHJlbGF0aW9uc2hpcAogICAgaWYgKHJlbGF0aW9uc2hpcElzRW1wdHkgPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIHdlIHdlcmUgZXhwbGljaXRseSB0b2xkIHdoYXQgdGhlIGludmVyc2UgaXMsIGFuZCB3ZSBoYXZlIHRoZSBpbnZlcnNlIHJlY29yZHMgYXZhaWxhYmxlCiAgICBpZiAoaGFzQW55UmVsYXRpb25zaGlwRGF0YSA9PT0gdHJ1ZSAmJiBhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gaWYgdGhpcyBpcyBhIHN5bmMgcmVsYXRpb25zaGlwLCB3ZSBzaG91bGQgbm90IG5lZWQgdG8gZmV0Y2gsIHNvIGdldHRpbmcgaGVyZSBpcyBhbiBlcnJvcgogICAgKHRydWUgJiYgIShpc0FzeW5jID09PSB0cnVlKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBsb29rZWQgdXAgdGhlICcke3RoaXMua2V5fScgcmVsYXRpb25zaGlwIG9uIGEgJyR7dGhpcy5pbnRlcm5hbE1vZGVsLnR5cGUubW9kZWxOYW1lfScgd2l0aCBpZCAke3RoaXMuaW50ZXJuYWxNb2RlbC5pZH0gYnV0IHNvbWUgb2YgdGhlIGFzc29jaWF0ZWQgcmVjb3JkcyB3ZXJlIG5vdCBsb2FkZWQuIEVpdGhlciBtYWtlIHN1cmUgdGhleSBhcmUgYWxsIGxvYWRlZCB0b2dldGhlciB3aXRoIHRoZSBwYXJlbnQgcmVjb3JkLCBvciBzcGVjaWZ5IHRoYXQgdGhlIHJlbGF0aW9uc2hpcCBpcyBhc3luYyAoXGBEUy4ke3RoaXMucmVsYXRpb25zaGlwTWV0YS5raW5kfSh7IGFzeW5jOiB0cnVlIH0pXGApYCwgaXNBc3luYyA9PT0gdHJ1ZSkpOwoKCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIF91cGRhdGVMb2FkaW5nUHJvbWlzZShwcm9taXNlLCBjb250ZW50KSB7CiAgICBpZiAodGhpcy5fcHJvbWlzZVByb3h5KSB7CiAgICAgIGlmIChjb250ZW50ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9wcm9taXNlUHJveHkuc2V0KCdjb250ZW50JywgY29udGVudCk7CiAgICAgIH0KICAgICAgdGhpcy5fcHJvbWlzZVByb3h5LnNldCgncHJvbWlzZScsIHByb21pc2UpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gdGhpcy5fY3JlYXRlUHJveHkocHJvbWlzZSwgY29udGVudCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3Byb21pc2VQcm94eTsKICB9CgogIHVwZGF0ZUludGVybmFsTW9kZWxzRnJvbUFkYXB0ZXIoaW50ZXJuYWxNb2RlbHMpIHsKICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgIC8vVE9ETyhJZ29yKSBtb3ZlIHRoaXMgdG8gYSBwcm9wZXIgcGxhY2UKICAgIC8vVE9ETyBPbmNlIHdlIGhhdmUgYWRhcHRlciBzdXBwb3J0LCB3ZSBuZWVkIHRvIGhhbmRsZSB1cGRhdGVkIGFuZCBjYW5vbmljYWwgY2hhbmdlcwogICAgdGhpcy5jb21wdXRlQ2hhbmdlcyhpbnRlcm5hbE1vZGVscyk7CiAgfQoKICBub3RpZnlSZWNvcmRSZWxhdGlvbnNoaXBBZGRlZCgpIHt9CgogIHNldEhhc0FueVJlbGF0aW9uc2hpcERhdGEodmFsdWUpIHsKICAgIHRoaXMuaGFzQW55UmVsYXRpb25zaGlwRGF0YSA9IHZhbHVlOwogIH0KCiAgc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQodmFsdWUpIHsKICAgIHRoaXMuaGFzRmFpbGVkTG9hZEF0dGVtcHQgPSB2YWx1ZTsKICB9CgogIHNldFJlbGF0aW9uc2hpcElzU3RhbGUodmFsdWUpIHsKICAgIHRoaXMucmVsYXRpb25zaGlwSXNTdGFsZSA9IHZhbHVlOwogIH0KCiAgc2V0UmVsYXRpb25zaGlwSXNFbXB0eSh2YWx1ZSkgewogICAgdGhpcy5yZWxhdGlvbnNoaXBJc0VtcHR5ID0gdmFsdWU7CiAgfQoKICBzZXRTaG91bGRGb3JjZVJlbG9hZCh2YWx1ZSkgewogICAgdGhpcy5zaG91bGRGb3JjZVJlbG9hZCA9IHZhbHVlOwogIH0KCiAgLyoKICAgYHB1c2hgIGZvciBhIHJlbGF0aW9uc2hpcCBhbGxvd3MgdGhlIHN0b3JlIHRvIHB1c2ggYSBKU09OIEFQSSBSZWxhdGlvbnNoaXAKICAgT2JqZWN0IG9udG8gdGhlIHJlbGF0aW9uc2hpcC4gVGhlIHJlbGF0aW9uc2hpcCB3aWxsIHRoZW4gZXh0cmFjdCBhbmQgc2V0IHRoZQogICBtZXRhLCBkYXRhIGFuZCBsaW5rcyBvZiB0aGF0IHJlbGF0aW9uc2hpcC4KICAgIGBwdXNoYCB1c2UgYHVwZGF0ZU1ldGFgLCBgdXBkYXRlRGF0YWAgYW5kIGB1cGRhdGVMaW5rYCB0byB1cGRhdGUgdGhlIHN0YXRlCiAgIG9mIHRoZSByZWxhdGlvbnNoaXAuCiAgICovCiAgcHVzaChwYXlsb2FkLCBpbml0aWFsKSB7CgogICAgdmFyIGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSA9IGZhbHNlOwogICAgdmFyIGhhc0xpbmsgPSBmYWxzZTsKCiAgICBpZiAocGF5bG9hZC5tZXRhKSB7CiAgICAgIHRoaXMudXBkYXRlTWV0YShwYXlsb2FkLm1ldGEpOwogICAgfQoKICAgIGlmIChwYXlsb2FkLmRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICBoYXNSZWxhdGlvbnNoaXBEYXRhUHJvcGVydHkgPSB0cnVlOwogICAgICB0aGlzLnVwZGF0ZURhdGEocGF5bG9hZC5kYXRhLCBpbml0aWFsKTsKICAgIH0gZWxzZSBpZiAocGF5bG9hZC5fcGFydGlhbERhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLnVwZGF0ZURhdGEocGF5bG9hZC5fcGFydGlhbERhdGEsIGluaXRpYWwpOwogICAgfSBlbHNlIGlmICh0aGlzLmlzQXN5bmMgPT09IGZhbHNlKSB7CiAgICAgIGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSA9IHRydWU7CiAgICAgIHZhciBkYXRhID0gdGhpcy5raW5kID09PSAnaGFzTWFueScgPyBbXSA6IG51bGw7CgogICAgICB0aGlzLnVwZGF0ZURhdGEoZGF0YSwgaW5pdGlhbCk7CiAgICB9CgogICAgaWYgKHBheWxvYWQubGlua3MgJiYgcGF5bG9hZC5saW5rcy5yZWxhdGVkKSB7CiAgICAgIHZhciByZWxhdGVkTGluayA9IF9ub3JtYWxpemVMaW5rKHBheWxvYWQubGlua3MucmVsYXRlZCk7CiAgICAgIGlmIChyZWxhdGVkTGluayAmJiByZWxhdGVkTGluay5ocmVmICYmIHJlbGF0ZWRMaW5rLmhyZWYgIT09IHRoaXMubGluaykgewogICAgICAgIGhhc0xpbmsgPSB0cnVlOwogICAgICAgIHRoaXMudXBkYXRlTGluayhyZWxhdGVkTGluay5ocmVmLCBpbml0aWFsKTsKICAgICAgfQogICAgfQoKICAgIC8qCiAgICAgRGF0YSBiZWluZyBwdXNoZWQgaW50byB0aGUgcmVsYXRpb25zaGlwIG1pZ2h0IGNvbnRhaW4gb25seSBkYXRhIG9yIGxpbmtzLAogICAgIG9yIGEgY29tYmluYXRpb24gb2YgYm90aC4KICAgICAgSUYgY29udGFpbnMgb25seSBkYXRhCiAgICAgSUYgY29udGFpbnMgYm90aCBsaW5rcyBhbmQgZGF0YQogICAgICByZWxhdGlvbnNoaXBJc0VtcHR5IC0+IHRydWUgaWYgaXMgZW1wdHkgYXJyYXkgKGhhcy1tYW55KSBvciBpcyBudWxsIChiZWxvbmdzLXRvKQogICAgICBoYXNBbnlSZWxhdGlvbnNoaXBEYXRhIC0+IHRydWUKICAgICAgcmVsYXRpb25zaGlwSXNTdGFsZSAtPiBmYWxzZQogICAgICBhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCAtPiBydW4tY2hlY2stdG8tZGV0ZXJtaW5lCiAgICAgIElGIGNvbnRhaW5zIG9ubHkgbGlua3MKICAgICAgcmVsYXRpb25zaGlwSXNTdGFsZSAtPiB0cnVlCiAgICAgKi8KICAgIHRoaXMuc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQoZmFsc2UpOwogICAgaWYgKGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSkgewogICAgICB2YXIgcmVsYXRpb25zaGlwSXNFbXB0eSA9IHBheWxvYWQuZGF0YSA9PT0gbnVsbCB8fCBBcnJheS5pc0FycmF5KHBheWxvYWQuZGF0YSkgJiYgcGF5bG9hZC5kYXRhLmxlbmd0aCA9PT0gMDsKCiAgICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgdGhpcy5zZXRSZWxhdGlvbnNoaXBJc1N0YWxlKGZhbHNlKTsKICAgICAgdGhpcy5zZXRSZWxhdGlvbnNoaXBJc0VtcHR5KHJlbGF0aW9uc2hpcElzRW1wdHkpOwogICAgfSBlbHNlIGlmIChoYXNMaW5rKSB7CiAgICAgIHRoaXMuc2V0UmVsYXRpb25zaGlwSXNTdGFsZSh0cnVlKTsKICAgIH0KICB9CgogIGdldERhdGEoKSB7fQoKICBfY3JlYXRlUHJveHkoKSB7fQoKICB1cGRhdGVEYXRhKCkge30KCiAgZGVzdHJveSgpIHt9Cn0KCmZ1bmN0aW9uIF9iaW5kKGZuLCAuLi5hcmdzKSB7CgogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZm4uYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsKICB9Owp9CgpmdW5jdGlvbiBfZ3VhcmQocHJvbWlzZSwgdGVzdCkgewogIHZhciBndWFyZGVkID0gcHJvbWlzZS5maW5hbGx5KCgpID0+IHsKICAgIGlmICghdGVzdCgpKSB7CiAgICAgIGd1YXJkZWQuX3N1YnNjcmliZXJzLmxlbmd0aCA9IDA7CiAgICB9CiAgfSk7CgogIHJldHVybiBndWFyZGVkOwp9CgpmdW5jdGlvbiBfb2JqZWN0SXNBbGl2ZShvYmplY3QpIHsKICByZXR1cm4gIShFbWJlci5nZXQob2JqZWN0LCAiaXNEZXN0cm95ZWQiKSB8fCBFbWJlci5nZXQob2JqZWN0LCAiaXNEZXN0cm95aW5nIikpOwp9Cgp2YXIgQVNZTkNfUkVRVUVTVF9DT1VOVCA9IDA7CmZ1bmN0aW9uIGluY3JlbWVudFJlcXVlc3RDb3VudCgpIHsKICBBU1lOQ19SRVFVRVNUX0NPVU5UKys7Cn0KCnsKICBFbWJlci5UZXN0LnJlZ2lzdGVyV2FpdGVyKCgpID0+IHsKICAgIHJldHVybiBBU1lOQ19SRVFVRVNUX0NPVU5UID09PSAwOwogIH0pOwp9CgpmdW5jdGlvbiBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCkgewogIHZhciB3cmFwcGVyUHJvbWlzZSA9IEVtYmVyLlJTVlAucmVzb2x2ZShwcm9taXNlLCBsYWJlbCkudGhlbih2ID0+IHByb21pc2UpOwoKICByZXR1cm4gX2d1YXJkKHdyYXBwZXJQcm9taXNlLCAoKSA9PiB7CiAgICB7CiAgICAgIEFTWU5DX1JFUVVFU1RfQ09VTlQtLTsKICAgIH0KICAgIHJldHVybiBfb2JqZWN0SXNBbGl2ZShzdG9yZSk7CiAgfSk7Cn0KCi8qKgogIEBuYW1lc3BhY2UKICBAbWV0aG9kIGRpZmZBcnJheQogIEBwcml2YXRlCiAgQHBhcmFtIHtBcnJheX0gb2xkQXJyYXkgdGhlIG9sZCBhcnJheQogIEBwYXJhbSB7QXJyYXl9IG5ld0FycmF5IHRoZSBuZXcgYXJyYXkKICBAcmV0dXJuIHtoYXNofSB7CiAgICAgIGZpcnN0Q2hhbmdlSW5kZXg6IDxpbnRlZ2VyPiwgIC8vIG51bGwgaWYgbm8gY2hhbmdlCiAgICAgIGFkZGVkQ291bnQ6IDxpbnRlZ2VyPiwgICAgICAgIC8vIDAgaWYgbm8gY2hhbmdlCiAgICAgIHJlbW92ZWRDb3VudDogPGludGVnZXI+ICAgICAgIC8vIDAgaWYgbm8gY2hhbmdlCiAgICB9CiovCmZ1bmN0aW9uIGRpZmZBcnJheShvbGRBcnJheSwgbmV3QXJyYXkpIHsKICB2YXIgb2xkTGVuZ3RoID0gb2xkQXJyYXkubGVuZ3RoOwogIHZhciBuZXdMZW5ndGggPSBuZXdBcnJheS5sZW5ndGg7CgogIHZhciBzaG9ydGVzdExlbmd0aCA9IE1hdGgubWluKG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKICB2YXIgZmlyc3RDaGFuZ2VJbmRleCA9IG51bGw7IC8vIG51bGwgc2lnbmlmaWVzIG5vIGNoYW5nZXMKCiAgLy8gZmluZCB0aGUgZmlyc3QgY2hhbmdlCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaG9ydGVzdExlbmd0aDsgaSsrKSB7CiAgICAvLyBjb21wYXJlIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkKICAgIGlmIChvbGRBcnJheVtpXSAhPT0gbmV3QXJyYXlbaV0pIHsKICAgICAgZmlyc3RDaGFuZ2VJbmRleCA9IGk7CiAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgaWYgKGZpcnN0Q2hhbmdlSW5kZXggPT09IG51bGwgJiYgbmV3TGVuZ3RoICE9PSBvbGRMZW5ndGgpIHsKICAgIC8vIG5vIGNoYW5nZSBmb3VuZCBpbiB0aGUgb3ZlcmxhcHBpbmcgYmxvY2sKICAgIC8vIGFuZCBhcnJheSBsZW5ndGhzIGRpZmZlciwKICAgIC8vIHNvIGNoYW5nZSBzdGFydHMgYXQgZW5kIG9mIG92ZXJsYXAKICAgIGZpcnN0Q2hhbmdlSW5kZXggPSBzaG9ydGVzdExlbmd0aDsKICB9CgogIHZhciBhZGRlZENvdW50ID0gMDsKICB2YXIgcmVtb3ZlZENvdW50ID0gMDsKICBpZiAoZmlyc3RDaGFuZ2VJbmRleCAhPT0gbnVsbCkgewogICAgLy8gd2UgZm91bmQgYSBjaGFuZ2UsIGZpbmQgdGhlIGVuZCBvZiB0aGUgY2hhbmdlCiAgICB2YXIgdW5jaGFuZ2VkRW5kQmxvY2tMZW5ndGggPSBzaG9ydGVzdExlbmd0aCAtIGZpcnN0Q2hhbmdlSW5kZXg7CiAgICAvLyB3YWxrIGJhY2sgZnJvbSB0aGUgZW5kIG9mIGJvdGggYXJyYXlzIHVudGlsIHdlIGZpbmQgYSBjaGFuZ2UKICAgIGZvciAodmFyIF9pID0gMTsgX2kgPD0gc2hvcnRlc3RMZW5ndGg7IF9pKyspIHsKICAgICAgLy8gY29tcGFyZSBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5CiAgICAgIGlmIChvbGRBcnJheVtvbGRMZW5ndGggLSBfaV0gIT09IG5ld0FycmF5W25ld0xlbmd0aCAtIF9pXSkgewogICAgICAgIHVuY2hhbmdlZEVuZEJsb2NrTGVuZ3RoID0gX2kgLSAxOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBhZGRlZENvdW50ID0gbmV3TGVuZ3RoIC0gdW5jaGFuZ2VkRW5kQmxvY2tMZW5ndGggLSBmaXJzdENoYW5nZUluZGV4OwogICAgcmVtb3ZlZENvdW50ID0gb2xkTGVuZ3RoIC0gdW5jaGFuZ2VkRW5kQmxvY2tMZW5ndGggLSBmaXJzdENoYW5nZUluZGV4OwogIH0KCiAgcmV0dXJuIHsKICAgIGZpcnN0Q2hhbmdlSW5kZXgsCiAgICBhZGRlZENvdW50LAogICAgcmVtb3ZlZENvdW50CiAgfTsKfQoKLyoqCiAgQSBgTWFueUFycmF5YCBpcyBhIGBNdXRhYmxlQXJyYXlgIHRoYXQgcmVwcmVzZW50cyB0aGUgY29udGVudHMgb2YgYSBoYXMtbWFueQogIHJlbGF0aW9uc2hpcC4KCiAgVGhlIGBNYW55QXJyYXlgIGlzIGluc3RhbnRpYXRlZCBsYXppbHkgdGhlIGZpcnN0IHRpbWUgdGhlIHJlbGF0aW9uc2hpcCBpcwogIHJlcXVlc3RlZC4KCiAgIyMjIEludmVyc2VzCgogIE9mdGVuLCB0aGUgcmVsYXRpb25zaGlwcyBpbiBFbWJlciBEYXRhIGFwcGxpY2F0aW9ucyB3aWxsIGhhdmUKICBhbiBpbnZlcnNlLiBGb3IgZXhhbXBsZSwgaW1hZ2luZSB0aGUgZm9sbG93aW5nIG1vZGVscyBhcmUKICBkZWZpbmVkOgoKICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICBjb21tZW50czogRFMuaGFzTWFueSgnY29tbWVudCcpCiAgfSk7CiAgYGBgCgogIGBgYGFwcC9tb2RlbHMvY29tbWVudC5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHBvc3Q6IERTLmJlbG9uZ3NUbygncG9zdCcpCiAgfSk7CiAgYGBgCgogIElmIHlvdSBjcmVhdGVkIGEgbmV3IGluc3RhbmNlIG9mIGBBcHAuUG9zdGAgYW5kIGFkZGVkCiAgYSBgQXBwLkNvbW1lbnRgIHJlY29yZCB0byBpdHMgYGNvbW1lbnRzYCBoYXMtbWFueQogIHJlbGF0aW9uc2hpcCwgeW91IHdvdWxkIGV4cGVjdCB0aGUgY29tbWVudCdzIGBwb3N0YAogIHByb3BlcnR5IHRvIGJlIHNldCB0byB0aGUgcG9zdCB0aGF0IGNvbnRhaW5lZAogIHRoZSBoYXMtbWFueS4KCiAgV2UgY2FsbCB0aGUgcmVjb3JkIHRvIHdoaWNoIGEgcmVsYXRpb25zaGlwIGJlbG9uZ3MgdGhlCiAgcmVsYXRpb25zaGlwJ3MgX293bmVyXy4KCiAgQGNsYXNzIE1hbnlBcnJheQogIEBuYW1lc3BhY2UgRFMKICBAZXh0ZW5kcyBFbWJlci5PYmplY3QKICBAdXNlcyBFbWJlci5NdXRhYmxlQXJyYXksIEVtYmVyLkV2ZW50ZWQKKi8KdmFyIE1hbnlBcnJheSA9IEVtYmVyLk9iamVjdC5leHRlbmQoRW1iZXIuTXV0YWJsZUFycmF5LCBFbWJlci5FdmVudGVkLCB7CiAgaW5pdCgpIHsKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CgogICAgLyoqCiAgICBUaGUgbG9hZGluZyBzdGF0ZSBvZiB0aGlzIGFycmF5CiAgICAgQHByb3BlcnR5IHtCb29sZWFufSBpc0xvYWRlZAogICAgKi8KICAgIHRoaXMuaXNMb2FkZWQgPSB0aGlzLmlzTG9hZGVkIHx8IGZhbHNlOwogICAgdGhpcy5sZW5ndGggPSAwOwoKICAgIC8qKgogICAgVXNlZCBmb3IgYXN5bmMgYGhhc01hbnlgIGFycmF5cwogICAgdG8ga2VlcCB0cmFjayBvZiB3aGVuIHRoZXkgd2lsbCByZXNvbHZlLgogICAgIEBwcm9wZXJ0eSB7RW1iZXIuUlNWUC5Qcm9taXNlfSBwcm9taXNlCiAgICBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMucHJvbWlzZSA9IG51bGw7CgogICAgLyoqCiAgICBNZXRhZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIHJlcXVlc3QgZm9yIGFzeW5jIGhhc01hbnkgcmVsYXRpb25zaGlwcy4KICAgICBFeGFtcGxlCiAgICAgR2l2ZW4gdGhhdCB0aGUgc2VydmVyIHJldHVybnMgdGhlIGZvbGxvd2luZyBKU09OIHBheWxvYWQgd2hlbiBmZXRjaGluZyBhCiAgICBoYXNNYW55IHJlbGF0aW9uc2hpcDoKICAgICBgYGBqcwogICAgewogICAgICAiY29tbWVudHMiOiBbewogICAgICAgICJpZCI6IDEsCiAgICAgICAgImNvbW1lbnQiOiAiVGhpcyBpcyB0aGUgZmlyc3QgY29tbWVudCIsCiAgICAgIH0sIHsKICAgIC8vIC4uLgogICAgICB9XSwKICAgICAgICJtZXRhIjogewogICAgICAgICJwYWdlIjogMSwKICAgICAgICAidG90YWwiOiA1CiAgICAgIH0KICAgIH0KICAgIGBgYAogICAgIFlvdSBjYW4gdGhlbiBhY2Nlc3MgdGhlIG1ldGFkYXRhIHZpYSB0aGUgYG1ldGFgIHByb3BlcnR5OgogICAgIGBgYGpzCiAgICBwb3N0LmdldCgnY29tbWVudHMnKS50aGVuKGZ1bmN0aW9uKGNvbW1lbnRzKSB7CiAgICAgIHZhciBtZXRhID0gY29tbWVudHMuZ2V0KCdtZXRhJyk7CiAgICAgLy8gbWV0YS5wYWdlID0+IDEKICAgIC8vIG1ldGEudG90YWwgPT4gNQogICAgfSk7CiAgICBgYGAKICAgICBAcHJvcGVydHkge09iamVjdH0gbWV0YQogICAgQHB1YmxpYwogICAgKi8KICAgIHRoaXMubWV0YSA9IHRoaXMubWV0YSB8fCBudWxsOwoKICAgIC8qKgogICAgYHRydWVgIGlmIHRoZSByZWxhdGlvbnNoaXAgaXMgcG9seW1vcnBoaWMsIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAgIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gaXNQb2x5bW9ycGhpYwogICAgQHByaXZhdGUKICAgICovCiAgICB0aGlzLmlzUG9seW1vcnBoaWMgPSB0aGlzLmlzUG9seW1vcnBoaWMgfHwgZmFsc2U7CgogICAgLyoqCiAgICBUaGUgcmVsYXRpb25zaGlwIHdoaWNoIG1hbmFnZXMgdGhpcyBhcnJheS4KICAgICBAcHJvcGVydHkge01hbnlSZWxhdGlvbnNoaXB9IHJlbGF0aW9uc2hpcAogICAgQHByaXZhdGUKICAgICovCiAgICB0aGlzLnJlbGF0aW9uc2hpcCA9IHRoaXMucmVsYXRpb25zaGlwIHx8IG51bGw7CgogICAgdGhpcy5jdXJyZW50U3RhdGUgPSBbXTsKICAgIHRoaXMuZmx1c2hDYW5vbmljYWwoZmFsc2UpOwogIH0sCgogIG9iamVjdEF0KGluZGV4KSB7CiAgICBpZiAodGhpcy5yZWxhdGlvbnNoaXAuX3dpbGxVcGRhdGVNYW55QXJyYXkpIHsKICAgICAgdGhpcy5yZWxhdGlvbnNoaXAuX2ZsdXNoUGVuZGluZ01hbnlBcnJheVVwZGF0ZXMoKTsKICAgIH0KICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpcy5jdXJyZW50U3RhdGVbaW5kZXhdOwogICAgaWYgKGludGVybmFsTW9kZWwgPT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgcmV0dXJuIGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCk7CiAgfSwKCiAgZmx1c2hDYW5vbmljYWwoaXNJbml0aWFsaXplZCA9IHRydWUpIHsKICAgIC8vIEl04oCZcyBwb3NzaWJsZSB0aGUgcGFyZW50IHNpZGUgb2YgdGhlIHJlbGF0aW9uc2hpcCBtYXkgaGF2ZSBiZWVuIHVubG9hZGVkIGJ5IHRoaXMgcG9pbnQKICAgIGlmICghX29iamVjdElzQWxpdmUodGhpcykpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHRvU2V0ID0gdGhpcy5jYW5vbmljYWxTdGF0ZTsKCiAgICAvL2EgaGFjayBmb3Igbm90IHJlbW92aW5nIG5ldyByZWNvcmRzCiAgICAvL1RPRE8gcmVtb3ZlIG9uY2Ugd2UgaGF2ZSBwcm9wZXIgZGlmZmluZwogICAgdmFyIG5ld0ludGVybmFsTW9kZWxzID0gdGhpcy5jdXJyZW50U3RhdGUuZmlsdGVyKAogICAgLy8gb25seSBhZGQgbmV3IGludGVybmFsTW9kZWxzIHdoaWNoIGFyZSBub3QgeWV0IGluIHRoZSBjYW5vbmljYWwgc3RhdGUgb2YgdGhpcwogICAgLy8gcmVsYXRpb25zaGlwIChhIG5ldyBpbnRlcm5hbE1vZGVsIGNhbiBiZSBpbiB0aGUgY2Fub25pY2FsIHN0YXRlIGlmIGl0IGhhcwogICAgLy8gYmVlbiAnYWNrbm93bGVnZWQnIHRvIGJlIGluIHRoZSByZWxhdGlvbnNoaXAgdmlhIGEgc3RvcmUucHVzaCkKICAgIGludGVybmFsTW9kZWwgPT4gaW50ZXJuYWxNb2RlbC5pc05ldygpICYmIHRvU2V0LmluZGV4T2YoaW50ZXJuYWxNb2RlbCkgPT09IC0xKTsKICAgIHRvU2V0ID0gdG9TZXQuY29uY2F0KG5ld0ludGVybmFsTW9kZWxzKTsKCiAgICAvLyBkaWZmIHRvIGZpbmQgY2hhbmdlcwogICAgdmFyIGRpZmYgPSBkaWZmQXJyYXkodGhpcy5jdXJyZW50U3RhdGUsIHRvU2V0KTsKCiAgICBpZiAoZGlmZi5maXJzdENoYW5nZUluZGV4ICE9PSBudWxsKSB7CiAgICAgIC8vIGl0J3MgbnVsbCBpZiBubyBjaGFuZ2UgZm91bmQKICAgICAgLy8gd2UgZm91bmQgYSBjaGFuZ2UKICAgICAgdGhpcy5hcnJheUNvbnRlbnRXaWxsQ2hhbmdlKGRpZmYuZmlyc3RDaGFuZ2VJbmRleCwgZGlmZi5yZW1vdmVkQ291bnQsIGRpZmYuYWRkZWRDb3VudCk7CiAgICAgIHRoaXMuc2V0KCdsZW5ndGgnLCB0b1NldC5sZW5ndGgpOwogICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHRvU2V0OwogICAgICB0aGlzLmFycmF5Q29udGVudERpZENoYW5nZShkaWZmLmZpcnN0Q2hhbmdlSW5kZXgsIGRpZmYucmVtb3ZlZENvdW50LCBkaWZmLmFkZGVkQ291bnQpOwogICAgICBpZiAoaXNJbml0aWFsaXplZCAmJiBkaWZmLmFkZGVkQ291bnQgPiAwKSB7CiAgICAgICAgLy9ub3RpZnkgb25seSBvbiBhZGRpdGlvbnMKICAgICAgICAvL1RPRE8gb25seSBub3RpZnkgaWYgdW5sb2FkZWQKICAgICAgICB0aGlzLnJlbGF0aW9uc2hpcC5ub3RpZnlIYXNNYW55Q2hhbmdlKCk7CiAgICAgIH0KICAgIH0KICB9LAoKICBpbnRlcm5hbFJlcGxhY2UoaWR4LCBhbXQsIG9iamVjdHMpIHsKICAgIGlmICghb2JqZWN0cykgewogICAgICBvYmplY3RzID0gW107CiAgICB9CiAgICB0aGlzLmFycmF5Q29udGVudFdpbGxDaGFuZ2UoaWR4LCBhbXQsIG9iamVjdHMubGVuZ3RoKTsKICAgIHRoaXMuY3VycmVudFN0YXRlLnNwbGljZS5hcHBseSh0aGlzLmN1cnJlbnRTdGF0ZSwgW2lkeCwgYW10XS5jb25jYXQob2JqZWN0cykpOwogICAgdGhpcy5zZXQoJ2xlbmd0aCcsIHRoaXMuY3VycmVudFN0YXRlLmxlbmd0aCk7CiAgICB0aGlzLmFycmF5Q29udGVudERpZENoYW5nZShpZHgsIGFtdCwgb2JqZWN0cy5sZW5ndGgpOwogIH0sCgogIC8vVE9ETyhJZ29yKSBvcHRpbWl6ZQogIF9yZW1vdmVJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgaW5kZXggPSB0aGlzLmN1cnJlbnRTdGF0ZS5pbmRleE9mKGludGVybmFsTW9kZWxzW2ldKTsKICAgICAgdGhpcy5pbnRlcm5hbFJlcGxhY2UoaW5kZXgsIDEpOwogICAgfQogIH0sCgogIC8vVE9ETyhJZ29yKSBvcHRpbWl6ZQogIF9hZGRJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscywgaWR4KSB7CiAgICBpZiAoaWR4ID09PSB1bmRlZmluZWQpIHsKICAgICAgaWR4ID0gdGhpcy5jdXJyZW50U3RhdGUubGVuZ3RoOwogICAgfQogICAgdGhpcy5pbnRlcm5hbFJlcGxhY2UoaWR4LCAwLCBpbnRlcm5hbE1vZGVscyk7CiAgfSwKCiAgcmVwbGFjZShpZHgsIGFtdCwgb2JqZWN0cykgewogICAgdmFyIGludGVybmFsTW9kZWxzID0gdm9pZCAwOwogICAgaWYgKGFtdCA+IDApIHsKICAgICAgaW50ZXJuYWxNb2RlbHMgPSB0aGlzLmN1cnJlbnRTdGF0ZS5zbGljZShpZHgsIGlkeCArIGFtdCk7CiAgICAgIHRoaXMuZ2V0KCdyZWxhdGlvbnNoaXAnKS5yZW1vdmVJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscyk7CiAgICB9CiAgICBpZiAob2JqZWN0cykgewogICAgICB0aGlzLmdldCgncmVsYXRpb25zaGlwJykuYWRkSW50ZXJuYWxNb2RlbHMob2JqZWN0cy5tYXAob2JqID0+IG9iai5faW50ZXJuYWxNb2RlbCksIGlkeCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBSZWxvYWRzIGFsbCBvZiB0aGUgcmVjb3JkcyBpbiB0aGUgbWFueUFycmF5LiBJZiB0aGUgbWFueUFycmF5CiAgICBob2xkcyBhIHJlbGF0aW9uc2hpcCB0aGF0IHdhcyBvcmlnaW5hbGx5IGZldGNoZWQgdXNpbmcgYSBsaW5rcyB1cmwKICAgIEVtYmVyIERhdGEgd2lsbCByZXZpc2l0IHRoZSBvcmlnaW5hbCBsaW5rcyB1cmwgdG8gcmVwb3B1bGF0ZSB0aGUKICAgIHJlbGF0aW9uc2hpcC4KICAgICBJZiB0aGUgbWFueUFycmF5IGhvbGRzIHRoZSByZXN1bHQgb2YgYSBgc3RvcmUucXVlcnkoKWAgcmVsb2FkIHdpbGwKICAgIHJlLXJ1biB0aGUgb3JpZ2luYWwgcXVlcnkuCiAgICAgRXhhbXBsZQogICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciB1c2VyID0gc3RvcmUucGVla1JlY29yZCgndXNlcicsIDEpCiAgICB1c2VyLmxvZ2luKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgdXNlci5nZXQoJ3Blcm1pc3Npb25zJykudGhlbihmdW5jdGlvbihwZXJtaXNzaW9ucykgewogICAgICAgIHJldHVybiBwZXJtaXNzaW9ucy5yZWxvYWQoKTsKICAgICAgfSk7CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgcmVsb2FkCiAgICBAcHVibGljCiAgKi8KICByZWxvYWQoKSB7CiAgICByZXR1cm4gdGhpcy5yZWxhdGlvbnNoaXAucmVsb2FkKCk7CiAgfSwKCiAgLyoqCiAgICBTYXZlcyBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhlIGBNYW55QXJyYXlgLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS5maW5kUmVjb3JkKCdpbmJveCcsIDEpLnRoZW4oZnVuY3Rpb24oaW5ib3gpIHsKICAgICAgaW5ib3guZ2V0KCdtZXNzYWdlcycpLnRoZW4oZnVuY3Rpb24obWVzc2FnZXMpIHsKICAgICAgICBtZXNzYWdlcy5mb3JFYWNoKGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgIG1lc3NhZ2Uuc2V0KCdpc1JlYWQnLCB0cnVlKTsKICAgICAgICB9KTsKICAgICAgICBtZXNzYWdlcy5zYXZlKCkKICAgICAgfSk7CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2Qgc2F2ZQogICAgQHJldHVybiB7RFMuUHJvbWlzZUFycmF5fSBwcm9taXNlCiAgKi8KICBzYXZlKCkgewogICAgdmFyIG1hbnlBcnJheSA9IHRoaXM7CiAgICB2YXIgcHJvbWlzZUxhYmVsID0gJ0RTOiBNYW55QXJyYXkjc2F2ZSAnICsgRW1iZXIuZ2V0KHRoaXMsICd0eXBlJyk7CiAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuYWxsKHRoaXMuaW52b2tlKCJzYXZlIiksIHByb21pc2VMYWJlbCkudGhlbigoKSA9PiBtYW55QXJyYXksIG51bGwsICdEUzogTWFueUFycmF5I3NhdmUgcmV0dXJuIE1hbnlBcnJheScpOwoKICAgIHJldHVybiBQcm9taXNlQXJyYXkuY3JlYXRlKHsgcHJvbWlzZSB9KTsKICB9LAoKICAvKioKICAgIENyZWF0ZSBhIGNoaWxkIHJlY29yZCB3aXRoaW4gdGhlIG93bmVyCiAgICAgQG1ldGhvZCBjcmVhdGVSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgQHJldHVybiB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgY3JlYXRlUmVjb3JkKGhhc2gpIHsKICAgIHZhciBzdG9yZSA9IEVtYmVyLmdldCh0aGlzLCAnc3RvcmUnKTsKICAgIHZhciB0eXBlID0gRW1iZXIuZ2V0KHRoaXMsICd0eXBlJyk7CgogICAgKHRydWUgJiYgISghRW1iZXIuZ2V0KHRoaXMsICdpc1BvbHltb3JwaGljJykpICYmIEVtYmVyLmFzc2VydChgWW91IGNhbm5vdCBhZGQgJyR7dHlwZS5tb2RlbE5hbWV9JyByZWNvcmRzIHRvIHRoaXMgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwLmAsICFFbWJlci5nZXQodGhpcywgJ2lzUG9seW1vcnBoaWMnKSkpOwoKICAgIHZhciByZWNvcmQgPSBzdG9yZS5jcmVhdGVSZWNvcmQodHlwZS5tb2RlbE5hbWUsIGhhc2gpOwogICAgdGhpcy5wdXNoT2JqZWN0KHJlY29yZCk7CgogICAgcmV0dXJuIHJlY29yZDsKICB9Cn0pOwoKY2xhc3MgTWFueVJlbGF0aW9uc2hpcCBleHRlbmRzIFJlbGF0aW9uc2hpcCB7CiAgY29uc3RydWN0b3Ioc3RvcmUsIGludGVybmFsTW9kZWwsIGludmVyc2VLZXksIHJlbGF0aW9uc2hpcE1ldGEpIHsKICAgIHN1cGVyKHN0b3JlLCBpbnRlcm5hbE1vZGVsLCBpbnZlcnNlS2V5LCByZWxhdGlvbnNoaXBNZXRhKTsKICAgIHRoaXMuYmVsb25nc1RvVHlwZSA9IHJlbGF0aW9uc2hpcE1ldGEudHlwZTsKICAgIHRoaXMuY2Fub25pY2FsU3RhdGUgPSBbXTsKICAgIC8vIFRoZSBNYW55QXJyYXkgZm9yIHRoaXMgcmVsYXRpb25zaGlwCiAgICB0aGlzLl9tYW55QXJyYXkgPSBudWxsOwogICAgLy8gVGhlIHByZXZpb3VzIE1hbnlBcnJheSBmb3IgdGhpcyByZWxhdGlvbnNoaXAuICBJdCB3aWxsIGJlIGRlc3Ryb3llZCB3aGVuCiAgICAvLyB3ZSBjcmVhdGUgYSBuZXcgbWFueSBhcnJheSwgYnV0IGluIHRoZSBpbnRlcmltIGl0IHdpbGwgYmUgdXBkYXRlZCBpZgogICAgLy8gaW52ZXJzZSBpbnRlcm5hbCBtb2RlbHMgYXJlIHVubG9hZGVkLgogICAgdGhpcy5fcmV0YWluZWRNYW55QXJyYXkgPSBudWxsOwogICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgIHRoaXMuX3dpbGxVcGRhdGVNYW55QXJyYXkgPSBmYWxzZTsKICAgIHRoaXMuX3BlbmRpbmdNYW55QXJyYXlVcGRhdGVzID0gbnVsbDsKICB9CgogIGdldCBjdXJyZW50U3RhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5tZW1iZXJzLmxpc3Q7CiAgfQoKICAvKioKICAgKiBGbGFnIGluZGljYXRpbmcgd2hldGhlciBhbGwgaW52ZXJzZSByZWNvcmRzIGFyZSBhdmFpbGFibGUKICAgKgogICAqIHRydWUgaWYgaW52ZXJzZSByZWNvcmRzIGV4aXN0IGFuZCBhcmUgYWxsIGxvYWRlZCAoYWxsIG5vdCBlbXB0eSkKICAgKiB0cnVlIGlmIHRoZXJlIGFyZSBubyBpbnZlcnNlIHJlY29yZHMKICAgKiBmYWxzZSBpZiB0aGUgaW52ZXJzZSByZWNvcmRzIGV4aXN0IGFuZCBhbnkgYXJlIG5vdCBsb2FkZWQgKGFueSBlbXB0eSkKICAgKgogICAqIEByZXR1cm5zIHtib29sZWFufQogICAqLwogIGdldCBhbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZCgpIHsKICAgIC8vIGNoZWNrIGN1cnJlbnRTdGF0ZSBmb3IgdW5sb2FkZWQgcmVjb3JkcwogICAgdmFyIGhhc0VtcHR5UmVjb3JkcyA9IHRoaXMuY3VycmVudFN0YXRlLnJlZHVjZSgoaGFzRW1wdHlNb2RlbCwgaSkgPT4gewogICAgICByZXR1cm4gaGFzRW1wdHlNb2RlbCB8fCBpLmlzRW1wdHkoKTsKICAgIH0sIGZhbHNlKTsKCiAgICAvLyBjaGVjayB1bi1zeW5jZWQgc3RhdGUgZm9yIHVubG9hZGVkIHJlY29yZHMKICAgIGlmICghaGFzRW1wdHlSZWNvcmRzICYmIHRoaXMud2lsbFN5bmMpIHsKICAgICAgaGFzRW1wdHlSZWNvcmRzID0gdGhpcy5jYW5vbmljYWxTdGF0ZS5yZWR1Y2UoKGhhc0VtcHR5TW9kZWwsIGkpID0+IHsKICAgICAgICByZXR1cm4gaGFzRW1wdHlNb2RlbCB8fCAhaS5pc0VtcHR5KCk7CiAgICAgIH0sIGZhbHNlKTsKICAgIH0KCiAgICByZXR1cm4gIWhhc0VtcHR5UmVjb3JkczsKICB9CgogIF9jcmVhdGVQcm94eShwcm9taXNlLCBjb250ZW50KSB7CiAgICByZXR1cm4gUHJvbWlzZU1hbnlBcnJheS5jcmVhdGUoewogICAgICBwcm9taXNlLAogICAgICBjb250ZW50CiAgICB9KTsKICB9CgogIGdldCBtYW55QXJyYXkoKSB7CiAgICAodHJ1ZSAmJiAhKHRoaXMuX21hbnlBcnJheSA9PT0gbnVsbCB8fCB0aGlzLl9yZXRhaW5lZE1hbnlBcnJheSA9PT0gbnVsbCkgJiYgRW1iZXIuYXNzZXJ0KGBFcnJvcjogcmVsYXRpb25zaGlwICR7dGhpcy5wYXJlbnRUeXBlfToke3RoaXMua2V5fSBoYXMgYm90aCBtYW55IGFycmF5IGFuZCByZXRhaW5lZCBtYW55IGFycmF5YCwgdGhpcy5fbWFueUFycmF5ID09PSBudWxsIHx8IHRoaXMuX3JldGFpbmVkTWFueUFycmF5ID09PSBudWxsKSk7CgoKICAgIGlmICghdGhpcy5fbWFueUFycmF5ICYmICF0aGlzLmlzRGVzdHJveWluZykgewogICAgICB2YXIgaXNMb2FkZWQgPSB0aGlzLmhhc0ZhaWxlZExvYWRBdHRlbXB0IHx8IHRoaXMuaXNOZXcgfHwgdGhpcy5hbGxJbnZlcnNlUmVjb3Jkc0FyZUxvYWRlZDsKCiAgICAgIHRoaXMuX21hbnlBcnJheSA9IE1hbnlBcnJheS5jcmVhdGUoewogICAgICAgIGNhbm9uaWNhbFN0YXRlOiB0aGlzLmNhbm9uaWNhbFN0YXRlLAogICAgICAgIHN0b3JlOiB0aGlzLnN0b3JlLAogICAgICAgIHJlbGF0aW9uc2hpcDogdGhpcywKICAgICAgICB0eXBlOiB0aGlzLnN0b3JlLm1vZGVsRm9yKHRoaXMuYmVsb25nc1RvVHlwZSksCiAgICAgICAgcmVjb3JkOiB0aGlzLmludGVybmFsTW9kZWwsCiAgICAgICAgbWV0YTogdGhpcy5tZXRhLAogICAgICAgIGlzUG9seW1vcnBoaWM6IHRoaXMuaXNQb2x5bW9ycGhpYywKICAgICAgICBpc0xvYWRlZAogICAgICB9KTsKCiAgICAgIGlmICh0aGlzLl9yZXRhaW5lZE1hbnlBcnJheSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuX3JldGFpbmVkTWFueUFycmF5LmRlc3Ryb3koKTsKICAgICAgICB0aGlzLl9yZXRhaW5lZE1hbnlBcnJheSA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpcy5fbWFueUFycmF5OwogIH0KCiAgcmVtb3ZlSW52ZXJzZVJlbGF0aW9uc2hpcHMoKSB7CiAgICBzdXBlci5yZW1vdmVJbnZlcnNlUmVsYXRpb25zaGlwcygpOwogICAgaWYgKHRoaXMuX21hbnlBcnJheSkgewogICAgICB0aGlzLl9tYW55QXJyYXkuZGVzdHJveSgpOwogICAgICB0aGlzLl9tYW55QXJyYXkgPSBudWxsOwogICAgfQoKICAgIGlmICh0aGlzLl9wcm9taXNlUHJveHkpIHsKICAgICAgdGhpcy5fcHJvbWlzZVByb3h5LmRlc3Ryb3koKTsKICAgIH0KICB9CgogIHVwZGF0ZU1ldGEobWV0YSkgewogICAgc3VwZXIudXBkYXRlTWV0YShtZXRhKTsKICAgIGlmICh0aGlzLl9tYW55QXJyYXkpIHsKICAgICAgdGhpcy5fbWFueUFycmF5LnNldCgnbWV0YScsIG1ldGEpOwogICAgfQogIH0KCiAgYWRkQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBpZHgpIHsKICAgIGlmICh0aGlzLmNhbm9uaWNhbE1lbWJlcnMuaGFzKGludGVybmFsTW9kZWwpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpZHggIT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlLnNwbGljZShpZHgsIDAsIGludGVybmFsTW9kZWwpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5jYW5vbmljYWxTdGF0ZS5wdXNoKGludGVybmFsTW9kZWwpOwogICAgfQogICAgc3VwZXIuYWRkQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBpZHgpOwogIH0KCiAgaW52ZXJzZURpZERlbWF0ZXJpYWxpemUoaW52ZXJzZUludGVybmFsTW9kZWwpIHsKICAgIHN1cGVyLmludmVyc2VEaWREZW1hdGVyaWFsaXplKGludmVyc2VJbnRlcm5hbE1vZGVsKTsKICAgIGlmICh0aGlzLmlzQXN5bmMpIHsKICAgICAgaWYgKHRoaXMuX21hbnlBcnJheSkgewogICAgICAgIHRoaXMuX3JldGFpbmVkTWFueUFycmF5ID0gdGhpcy5fbWFueUFycmF5OwogICAgICAgIHRoaXMuX21hbnlBcnJheSA9IG51bGw7CiAgICAgIH0KICAgICAgdGhpcy5fcmVtb3ZlSW50ZXJuYWxNb2RlbEZyb21NYW55QXJyYXkodGhpcy5fcmV0YWluZWRNYW55QXJyYXksIGludmVyc2VJbnRlcm5hbE1vZGVsKTsKICAgIH0KICAgIHRoaXMubm90aWZ5SGFzTWFueUNoYW5nZSgpOwogIH0KCiAgYWRkSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBpZHgpIHsKICAgIGlmICh0aGlzLm1lbWJlcnMuaGFzKGludGVybmFsTW9kZWwpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBlbWJlckRhdGFfRGVidWcuYXNzZXJ0UG9seW1vcnBoaWNUeXBlKHRoaXMuaW50ZXJuYWxNb2RlbCwgdGhpcy5yZWxhdGlvbnNoaXBNZXRhLCBpbnRlcm5hbE1vZGVsKTsKICAgIHN1cGVyLmFkZEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCwgaWR4KTsKICAgIHRoaXMuc2NoZWR1bGVNYW55QXJyYXlVcGRhdGUoaW50ZXJuYWxNb2RlbCwgaWR4KTsKICB9CgogIHNjaGVkdWxlTWFueUFycmF5VXBkYXRlKGludGVybmFsTW9kZWwsIGlkeCkgewogICAgLy8gaWRlYWxseSB3ZSB3b3VsZCBlYXJseSBleGl0IGhlcmUsIGJ1dCBzb21lIHRlc3RzCiAgICAvLyAgIGN1cnJlbnRseSBzdWdnZXN0IHRoYXQgd2UgY2Fubm90LgogICAgLy8gaWYgKCF0aGlzLl9tYW55QXJyYXkpIHsKICAgIC8vICAgcmV0dXJuOwogICAgLy8gfQoKICAgIHZhciBwZW5kaW5nID0gdGhpcy5fcGVuZGluZ01hbnlBcnJheVVwZGF0ZXMgPSB0aGlzLl9wZW5kaW5nTWFueUFycmF5VXBkYXRlcyB8fCBbXTsKICAgIHBlbmRpbmcucHVzaChpbnRlcm5hbE1vZGVsLCBpZHgpOwoKICAgIGlmICh0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5ID09PSB0cnVlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5ID0gdHJ1ZTsKICAgIHZhciBiYWNrYnVybmVyID0gdGhpcy5zdG9yZS5fYmFja2J1cm5lcjsKCiAgICBiYWNrYnVybmVyLmpvaW4oKCkgPT4gewogICAgICBiYWNrYnVybmVyLnNjaGVkdWxlKCdzeW5jUmVsYXRpb25zaGlwcycsIHRoaXMsIHRoaXMuX2ZsdXNoUGVuZGluZ01hbnlBcnJheVVwZGF0ZXMpOwogICAgfSk7CiAgfQoKICBfZmx1c2hQZW5kaW5nTWFueUFycmF5VXBkYXRlcygpIHsKICAgIGlmICh0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5ID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHBlbmRpbmcgPSB0aGlzLl9wZW5kaW5nTWFueUFycmF5VXBkYXRlczsKICAgIHRoaXMuX3BlbmRpbmdNYW55QXJyYXlVcGRhdGVzID0gW107CiAgICB0aGlzLl93aWxsVXBkYXRlTWFueUFycmF5ID0gZmFsc2U7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwZW5kaW5nLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gcGVuZGluZ1tpXTsKICAgICAgdmFyIGlkeCA9IHBlbmRpbmdbaSArIDFdOwoKICAgICAgdGhpcy5tYW55QXJyYXkuX2FkZEludGVybmFsTW9kZWxzKFtpbnRlcm5hbE1vZGVsXSwgaWR4KTsKICAgIH0KICB9CgogIHJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tT3duKGludGVybmFsTW9kZWwsIGlkeCkgewogICAgdmFyIGkgPSBpZHg7CiAgICBpZiAoIXRoaXMuY2Fub25pY2FsTWVtYmVycy5oYXMoaW50ZXJuYWxNb2RlbCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGkgPT09IHVuZGVmaW5lZCkgewogICAgICBpID0gdGhpcy5jYW5vbmljYWxTdGF0ZS5pbmRleE9mKGludGVybmFsTW9kZWwpOwogICAgfQogICAgaWYgKGkgPiAtMSkgewogICAgICB0aGlzLmNhbm9uaWNhbFN0YXRlLnNwbGljZShpLCAxKTsKICAgIH0KICAgIHN1cGVyLnJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tT3duKGludGVybmFsTW9kZWwsIGlkeCk7CiAgfQoKICByZW1vdmVBbGxDYW5vbmljYWxJbnRlcm5hbE1vZGVsc0Zyb21Pd24oKSB7CiAgICBzdXBlci5yZW1vdmVBbGxDYW5vbmljYWxJbnRlcm5hbE1vZGVsc0Zyb21Pd24oKTsKICAgIHRoaXMuY2Fub25pY2FsTWVtYmVycy5jbGVhcigpOwogICAgdGhpcy5jYW5vbmljYWxTdGF0ZS5zcGxpY2UoMCwgdGhpcy5jYW5vbmljYWxTdGF0ZS5sZW5ndGgpOwogIH0KCiAgcmVtb3ZlQ29tcGxldGVseUZyb21Pd24oaW50ZXJuYWxNb2RlbCkgewogICAgc3VwZXIucmVtb3ZlQ29tcGxldGVseUZyb21Pd24oaW50ZXJuYWxNb2RlbCk7CgogICAgdmFyIGNhbm9uaWNhbEluZGV4ID0gdGhpcy5jYW5vbmljYWxTdGF0ZS5pbmRleE9mKGludGVybmFsTW9kZWwpOwoKICAgIGlmIChjYW5vbmljYWxJbmRleCAhPT0gLTEpIHsKICAgICAgdGhpcy5jYW5vbmljYWxTdGF0ZS5zcGxpY2UoY2Fub25pY2FsSW5kZXgsIDEpOwogICAgfQoKICAgIHZhciBtYW55QXJyYXkgPSB0aGlzLl9tYW55QXJyYXk7CgogICAgaWYgKG1hbnlBcnJheSkgewogICAgICB2YXIgaWR4ID0gbWFueUFycmF5LmN1cnJlbnRTdGF0ZS5pbmRleE9mKGludGVybmFsTW9kZWwpOwoKICAgICAgaWYgKGlkeCAhPT0gLTEpIHsKICAgICAgICBtYW55QXJyYXkuaW50ZXJuYWxSZXBsYWNlKGlkeCwgMSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZsdXNoQ2Fub25pY2FsKCkgewogICAgaWYgKHRoaXMuX21hbnlBcnJheSkgewogICAgICB0aGlzLl9tYW55QXJyYXkuZmx1c2hDYW5vbmljYWwoKTsKICAgIH0KICAgIHN1cGVyLmZsdXNoQ2Fub25pY2FsKCk7CiAgfQoKICByZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bihpbnRlcm5hbE1vZGVsLCBpZHgpIHsKICAgIGlmICghdGhpcy5tZW1iZXJzLmhhcyhpbnRlcm5hbE1vZGVsKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bihpbnRlcm5hbE1vZGVsLCBpZHgpOwogICAgLy8gbm90ZSB0aGF0IGVuc3VyaW5nIHRoZSBtYW55IGFycmF5IGlzIGNyZWF0ZWQsIHZpYSBgdGhpcy5tYW55QXJyYXlgCiAgICAvLyAoaW5zdGVhZCBvZiBgdGhpcy5fbWFueUFycmF5YCkgaXMgaW50ZW50aW9uYWwuCiAgICAvLwogICAgLy8gQmVjYXVzZSB3ZSdyZSByZW1vdmluZyBmcm9tIGxvY2FsLCBhbmQgbm90IGNhbm9uaWNhbCwgc3RhdGUsIGl0IGlzCiAgICAvLyBpbXBvcnRhbnQgdGhhdCB0aGUgbWFueSBhcnJheSBpcyBpbml0aWFsaXplZCBub3cgd2l0aCB0aG9zZSBjaGFuZ2VzLAogICAgLy8gb3RoZXJ3aXNlIGl0IHdpbGwgYmUgaW5pdGlhbGl6ZWQgd2l0aCBjYW5vbmljYWwgc3RhdGUgYW5kIHdlJ2xsIGhhdmUKICAgIC8vIGxvc3QgdGhlIGZhY3QgdGhhdCB0aGlzIGludGVybmFsTW9kZWwgd2FzIHJlbW92ZWQuCiAgICB0aGlzLl9yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU1hbnlBcnJheSh0aGlzLm1hbnlBcnJheSwgaW50ZXJuYWxNb2RlbCwgaWR4KTsKICAgIHRoaXMuX3JlbW92ZUludGVybmFsTW9kZWxGcm9tTWFueUFycmF5KHRoaXMuX3JldGFpbmVkTWFueUFycmF5LCBpbnRlcm5hbE1vZGVsLCBpZHgpOwogIH0KCiAgcmVtb3ZlQWxsSW50ZXJuYWxNb2RlbHNGcm9tT3duKCkgewogICAgc3VwZXIucmVtb3ZlQWxsSW50ZXJuYWxNb2RlbHNGcm9tT3duKCk7CiAgICAvLyBhcyB3aXRoIHJlbW92ZUludGVybmFsTW9kZWxGcm9tT3duLCB3ZSBtYWtlIHN1cmUgdGhlIG1hbnkgYXJyYXkgaXMKICAgIC8vIGluc3RhbnRpYXRlZCwgb3Igd2UnbGwgbG9zZSBsb2NhbCByZW1vdmFscywgYXMgd2UncmUgbm90IHVwZGF0aW5nCiAgICAvLyBjYW5vbmljYWwgc3RhdGUgaGVyZS4KICAgIHRoaXMubWFueUFycmF5LmNsZWFyKCk7CiAgICBpZiAodGhpcy5fcmV0YWluZWRNYW55QXJyYXkpIHsKICAgICAgdGhpcy5fcmV0YWluZWRNYW55QXJyYXkuY2xlYXIoKTsKICAgIH0KICB9CgogIF9yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU1hbnlBcnJheShtYW55QXJyYXksIGludGVybmFsTW9kZWwsIGlkeCkgewogICAgaWYgKG1hbnlBcnJheSA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGlkeCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vVE9ETyhJZ29yKSBub3QgdXNlZCBjdXJyZW50bHksIGZpeAogICAgICBtYW55QXJyYXkuY3VycmVudFN0YXRlLnJlbW92ZUF0KGlkeCk7CiAgICB9IGVsc2UgewogICAgICBtYW55QXJyYXkuX3JlbW92ZUludGVybmFsTW9kZWxzKFtpbnRlcm5hbE1vZGVsXSk7CiAgICB9CiAgfQoKICBub3RpZnlSZWNvcmRSZWxhdGlvbnNoaXBBZGRlZChpbnRlcm5hbE1vZGVsLCBpZHgpIHsKICAgIHRoaXMuaW50ZXJuYWxNb2RlbC5ub3RpZnlIYXNNYW55QWRkZWQodGhpcy5rZXksIGludGVybmFsTW9kZWwsIGlkeCk7CiAgfQoKICBjb21wdXRlQ2hhbmdlcyhpbnRlcm5hbE1vZGVscyA9IFtdKSB7CiAgICB2YXIgbWVtYmVycyA9IHRoaXMuY2Fub25pY2FsTWVtYmVyczsKICAgIHZhciBpbnRlcm5hbE1vZGVsc1RvUmVtb3ZlID0gW107CiAgICB2YXIgaW50ZXJuYWxNb2RlbFNldCA9IHNldEZvckFycmF5KGludGVybmFsTW9kZWxzKTsKCiAgICBtZW1iZXJzLmZvckVhY2gobWVtYmVyID0+IHsKICAgICAgaWYgKGludGVybmFsTW9kZWxTZXQuaGFzKG1lbWJlcikpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGludGVybmFsTW9kZWxzVG9SZW1vdmUucHVzaChtZW1iZXIpOwogICAgfSk7CgogICAgdGhpcy5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVsc1RvUmVtb3ZlKTsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2ldOwogICAgICB0aGlzLnJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCk7CiAgICAgIHRoaXMuYWRkQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBpKTsKICAgIH0KICB9CgogIHNldEluaXRpYWxJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscykgewogICAgaWYgKEFycmF5LmlzQXJyYXkoaW50ZXJuYWxNb2RlbHMpID09PSBmYWxzZSB8fCBpbnRlcm5hbE1vZGVscy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsc1tpXTsKICAgICAgaWYgKHRoaXMuY2Fub25pY2FsTWVtYmVycy5oYXMoaW50ZXJuYWxNb2RlbCkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdGhpcy5jYW5vbmljYWxNZW1iZXJzLmFkZChpbnRlcm5hbE1vZGVsKTsKICAgICAgdGhpcy5tZW1iZXJzLmFkZChpbnRlcm5hbE1vZGVsKTsKICAgICAgdGhpcy5zZXR1cEludmVyc2VSZWxhdGlvbnNoaXAoaW50ZXJuYWxNb2RlbCk7CiAgICB9CgogICAgdGhpcy5jYW5vbmljYWxTdGF0ZSA9IHRoaXMuY2Fub25pY2FsTWVtYmVycy50b0FycmF5KCk7CiAgfQoKICAvLyBjYWxsZWQgYnkgYGdldERhdGEoKWAgd2hlbiBhIHJlcXVlc3QgaXMgbmVlZGVkCiAgLy8gICBidXQgbm8gbGluayBpcyBhdmFpbGFibGUKICBfZmV0Y2hSZWNvcmRzKCkgewogICAgdmFyIGludGVybmFsTW9kZWxzID0gdGhpcy5jdXJyZW50U3RhdGU7CiAgICB2YXIgeyBzaG91bGRGb3JjZVJlbG9hZCB9ID0gdGhpczsKICAgIHZhciBwcm9taXNlID0gdm9pZCAwOwoKICAgIGlmIChzaG91bGRGb3JjZVJlbG9hZCA9PT0gdHJ1ZSkgewogICAgICBwcm9taXNlID0gdGhpcy5zdG9yZS5fc2NoZWR1bGVGZXRjaE1hbnkoaW50ZXJuYWxNb2RlbHMpOwogICAgfSBlbHNlIHsKICAgICAgcHJvbWlzZSA9IHRoaXMuc3RvcmUuZmluZE1hbnkoaW50ZXJuYWxNb2RlbHMpOwogICAgfQoKICAgIHJldHVybiBwcm9taXNlOwogIH0KCiAgLy8gY2FsbGVkIGJ5IGBnZXREYXRhKClgIHdoZW4gYSByZXF1ZXN0IGlzIG5lZWRlZAogIC8vICAgYW5kIGEgbGluayBpcyBhdmFpbGFibGUKICBfZmV0Y2hMaW5rKCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEhhc01hbnkodGhpcy5pbnRlcm5hbE1vZGVsLCB0aGlzLmxpbmssIHRoaXMucmVsYXRpb25zaGlwTWV0YSkudGhlbihyZWNvcmRzID0+IHsKICAgICAgaWYgKHJlY29yZHMuaGFzT3duUHJvcGVydHkoJ21ldGEnKSkgewogICAgICAgIHRoaXMudXBkYXRlTWV0YShyZWNvcmRzLm1ldGEpOwogICAgICB9CiAgICAgIHRoaXMuc3RvcmUuX2JhY2tidXJuZXIuam9pbigoKSA9PiB7CiAgICAgICAgdGhpcy51cGRhdGVJbnRlcm5hbE1vZGVsc0Zyb21BZGFwdGVyKHJlY29yZHMpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICB9KTsKICB9CgogIGdldERhdGEoKSB7CiAgICAvL1RPRE8oSWdvcikgc3luYyBzZXJ2ZXIgaGVyZSwgb25jZSBvdXIgc3luY2luZyBpcyBub3Qgc3R1cGlkCiAgICB2YXIgbWFueUFycmF5ID0gdGhpcy5tYW55QXJyYXk7CgogICAgaWYgKHRoaXMuc2hvdWxkTWFrZVJlcXVlc3QoKSkgewogICAgICB2YXIgcHJvbWlzZSA9IHZvaWQgMDsKCiAgICAgIGlmICh0aGlzLmxpbmspIHsKICAgICAgICBwcm9taXNlID0gdGhpcy5fZmV0Y2hMaW5rKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZSA9IHRoaXMuX2ZldGNoUmVjb3JkcygpOwogICAgICB9CgogICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKCgpID0+IGhhbmRsZUNvbXBsZXRlZFJlcXVlc3QodGhpcyksIGUgPT4gaGFuZGxlQ29tcGxldGVkUmVxdWVzdCh0aGlzLCBlKSk7CgogICAgICB0aGlzLmZldGNoUHJvbWlzZSA9IHByb21pc2U7CiAgICAgIHRoaXMuX3VwZGF0ZUxvYWRpbmdQcm9taXNlKHByb21pc2UsIG1hbnlBcnJheSk7CiAgICB9CgogICAgaWYgKHRoaXMuaXNBc3luYykgewogICAgICBpZiAodGhpcy5fcHJvbWlzZVByb3h5ID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlTG9hZGluZ1Byb21pc2UoRW1iZXIuUlNWUC5yZXNvbHZlKG1hbnlBcnJheSksIG1hbnlBcnJheSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9wcm9taXNlUHJveHk7CiAgICB9IGVsc2UgewogICAgICAodHJ1ZSAmJiAhKHRoaXMuYWxsSW52ZXJzZVJlY29yZHNBcmVMb2FkZWQpICYmIEVtYmVyLmFzc2VydChgWW91IGxvb2tlZCB1cCB0aGUgJyR7dGhpcy5rZXl9JyByZWxhdGlvbnNoaXAgb24gYSAnJHt0aGlzLmludGVybmFsTW9kZWwudHlwZS5tb2RlbE5hbWV9JyB3aXRoIGlkICR7dGhpcy5pbnRlcm5hbE1vZGVsLmlkfSBidXQgc29tZSBvZiB0aGUgYXNzb2NpYXRlZCByZWNvcmRzIHdlcmUgbm90IGxvYWRlZC4gRWl0aGVyIG1ha2Ugc3VyZSB0aGV5IGFyZSBhbGwgbG9hZGVkIHRvZ2V0aGVyIHdpdGggdGhlIHBhcmVudCByZWNvcmQsIG9yIHNwZWNpZnkgdGhhdCB0aGUgcmVsYXRpb25zaGlwIGlzIGFzeW5jIChcYERTLmhhc01hbnkoeyBhc3luYzogdHJ1ZSB9KVxgKWAsIHRoaXMuYWxsSW52ZXJzZVJlY29yZHNBcmVMb2FkZWQpKTsKCgogICAgICByZXR1cm4gbWFueUFycmF5OwogICAgfQogIH0KCiAgbm90aWZ5SGFzTWFueUNoYW5nZSgpIHsKICAgIHRoaXMuaW50ZXJuYWxNb2RlbC5ub3RpZnlIYXNNYW55QWRkZWQodGhpcy5rZXkpOwogIH0KCiAgdXBkYXRlRGF0YShkYXRhLCBpbml0aWFsKSB7CiAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSB0aGlzLnN0b3JlLl9wdXNoUmVzb3VyY2VJZGVudGlmaWVycyh0aGlzLCBkYXRhKTsKICAgIGlmIChpbml0aWFsKSB7CiAgICAgIHRoaXMuc2V0SW5pdGlhbEludGVybmFsTW9kZWxzKGludGVybmFsTW9kZWxzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudXBkYXRlSW50ZXJuYWxNb2RlbHNGcm9tQWRhcHRlcihpbnRlcm5hbE1vZGVscyk7CiAgICB9CiAgfQoKICBkZXN0cm95KCkgewogICAgc3VwZXIuZGVzdHJveSgpOwogICAgdmFyIG1hbnlBcnJheSA9IHRoaXMuX21hbnlBcnJheTsKICAgIGlmIChtYW55QXJyYXkpIHsKICAgICAgbWFueUFycmF5LmRlc3Ryb3koKTsKICAgICAgdGhpcy5fbWFueUFycmF5ID0gbnVsbDsKICAgIH0KCiAgICB2YXIgcHJveHkgPSB0aGlzLl9wcm9taXNlUHJveHk7CgogICAgaWYgKHByb3h5KSB7CiAgICAgIHByb3h5LmRlc3Ryb3koKTsKICAgICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGhhbmRsZUNvbXBsZXRlZFJlcXVlc3QocmVsYXRpb25zaGlwLCBlcnJvcikgewogIHZhciBtYW55QXJyYXkgPSByZWxhdGlvbnNoaXAubWFueUFycmF5OwoKICAvL0dvZXMgYXdheSBhZnRlciB0aGUgbWFueUFycmF5IHJlZmFjdG9yCiAgaWYgKCFtYW55QXJyYXkuZ2V0KCdpc0Rlc3Ryb3llZCcpKSB7CiAgICByZWxhdGlvbnNoaXAubWFueUFycmF5LnNldCgnaXNMb2FkZWQnLCB0cnVlKTsKICB9CgogIHJlbGF0aW9uc2hpcC5mZXRjaFByb21pc2UgPSBudWxsOwogIHJlbGF0aW9uc2hpcC5zZXRTaG91bGRGb3JjZVJlbG9hZChmYWxzZSk7CgogIGlmIChlcnJvcikgewogICAgcmVsYXRpb25zaGlwLnNldEhhc0ZhaWxlZExvYWRBdHRlbXB0KHRydWUpOwogICAgdGhyb3cgZXJyb3I7CiAgfQoKICByZWxhdGlvbnNoaXAuc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQoZmFsc2UpOwogIC8vIG9ubHkgc2V0IHRvIG5vdCBzdGFsZSBpZiBubyBlcnJvciBpcyB0aHJvd24KICByZWxhdGlvbnNoaXAuc2V0UmVsYXRpb25zaGlwSXNTdGFsZShmYWxzZSk7CgogIHJldHVybiBtYW55QXJyYXk7Cn0KCmZ1bmN0aW9uIHNldEZvckFycmF5KGFycmF5KSB7CiAgdmFyIHNldCA9IG5ldyBPcmRlcmVkU2V0KCk7CgogIGlmIChhcnJheSkgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgc2V0LmFkZChhcnJheVtpXSk7CiAgICB9CiAgfQoKICByZXR1cm4gc2V0Owp9CgpjbGFzcyBCZWxvbmdzVG9SZWxhdGlvbnNoaXAgZXh0ZW5kcyBSZWxhdGlvbnNoaXAgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBpbnRlcm5hbE1vZGVsLCBpbnZlcnNlS2V5LCByZWxhdGlvbnNoaXBNZXRhKSB7CiAgICBzdXBlcihzdG9yZSwgaW50ZXJuYWxNb2RlbCwgaW52ZXJzZUtleSwgcmVsYXRpb25zaGlwTWV0YSk7CiAgICB0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsID0gbnVsbDsKICAgIHRoaXMuY2Fub25pY2FsU3RhdGUgPSBudWxsOwogICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICB9CgogIC8qKgogICAqIEZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGFsbCBpbnZlcnNlIHJlY29yZHMgYXJlIGF2YWlsYWJsZQogICAqCiAgICogdHJ1ZSBpZiB0aGUgaW52ZXJzZSBleGlzdHMgYW5kIGlzIGxvYWRlZCAobm90IGVtcHR5KQogICAqIHRydWUgaWYgdGhlcmUgaXMgbm8gaW52ZXJzZQogICAqIGZhbHNlIGlmIHRoZSBpbnZlcnNlIGV4aXN0cyBhbmQgaXMgbm90IGxvYWRlZCAoZW1wdHkpCiAgICoKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgKi8KICBnZXQgYWxsSW52ZXJzZVJlY29yZHNBcmVMb2FkZWQoKSB7CiAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWw7CiAgICB2YXIgaXNFbXB0eSA9IGludGVybmFsTW9kZWwgIT09IG51bGwgJiYgaW50ZXJuYWxNb2RlbC5pc0VtcHR5KCk7CgogICAgcmV0dXJuICFpc0VtcHR5OwogIH0KCiAgc2V0SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKSB7CiAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICB0aGlzLmFkZEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwpIHsKICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbE1vZGVsKHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwpOwogICAgfQoKICAgIHRoaXMuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgIHRoaXMuc2V0UmVsYXRpb25zaGlwSXNTdGFsZShmYWxzZSk7CiAgICB0aGlzLnNldFJlbGF0aW9uc2hpcElzRW1wdHkoZmFsc2UpOwogIH0KCiAgc2V0Q2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKSB7CiAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICB0aGlzLmFkZENhbm9uaWNhbEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuY2Fub25pY2FsU3RhdGUpIHsKICAgICAgdGhpcy5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsKHRoaXMuY2Fub25pY2FsU3RhdGUpOwogICAgfQogICAgdGhpcy5mbHVzaENhbm9uaWNhbExhdGVyKCk7CiAgfQoKICBzZXRJbml0aWFsQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKSB7CiAgICBpZiAoIWludGVybmFsTW9kZWwpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIFdoZW4gd2UgaW5pdGlhbGl6ZSBhIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAsIHdlIHdhbnQgdG8gYXZvaWQgd29yayBsaWtlCiAgICAvLyBub3RpZnlpbmcgb3VyIGludGVybmFsTW9kZWwgdGhhdCB3ZSd2ZSAiY2hhbmdlZCIgYW5kIGV4Y2Vzc2l2ZSB0aHJhc2ggb24KICAgIC8vIHNldHRpbmcgdXAgaW52ZXJzZSByZWxhdGlvbnNoaXBzCiAgICB0aGlzLmNhbm9uaWNhbE1lbWJlcnMuYWRkKGludGVybmFsTW9kZWwpOwogICAgdGhpcy5tZW1iZXJzLmFkZChpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwgPSB0aGlzLmNhbm9uaWNhbFN0YXRlID0gaW50ZXJuYWxNb2RlbDsKICAgIHRoaXMuc2V0dXBJbnZlcnNlUmVsYXRpb25zaGlwKGludGVybmFsTW9kZWwpOwogIH0KCiAgYWRkQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKSB7CiAgICBpZiAodGhpcy5jYW5vbmljYWxNZW1iZXJzLmhhcyhpbnRlcm5hbE1vZGVsKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHRoaXMuY2Fub25pY2FsU3RhdGUpIHsKICAgICAgdGhpcy5yZW1vdmVDYW5vbmljYWxJbnRlcm5hbE1vZGVsKHRoaXMuY2Fub25pY2FsU3RhdGUpOwogICAgfQoKICAgIHRoaXMuY2Fub25pY2FsU3RhdGUgPSBpbnRlcm5hbE1vZGVsOwogICAgc3VwZXIuYWRkQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKTsKICB9CgogIGludmVyc2VEaWREZW1hdGVyaWFsaXplKCkgewogICAgc3VwZXIuaW52ZXJzZURpZERlbWF0ZXJpYWxpemUodGhpcy5pbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICB0aGlzLm5vdGlmeUJlbG9uZ3NUb0NoYW5nZSgpOwogIH0KCiAgcmVtb3ZlQ29tcGxldGVseUZyb21Pd24oaW50ZXJuYWxNb2RlbCkgewogICAgc3VwZXIucmVtb3ZlQ29tcGxldGVseUZyb21Pd24oaW50ZXJuYWxNb2RlbCk7CgogICAgaWYgKHRoaXMuY2Fub25pY2FsU3RhdGUgPT09IGludGVybmFsTW9kZWwpIHsKICAgICAgdGhpcy5jYW5vbmljYWxTdGF0ZSA9IG51bGw7CiAgICB9CgogICAgaWYgKHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwgPT09IGludGVybmFsTW9kZWwpIHsKICAgICAgdGhpcy5pbnZlcnNlSW50ZXJuYWxNb2RlbCA9IG51bGw7CiAgICAgIHRoaXMubm90aWZ5QmVsb25nc1RvQ2hhbmdlKCk7CiAgICB9CiAgfQoKICByZW1vdmVDb21wbGV0ZWx5RnJvbUludmVyc2UoKSB7CiAgICBzdXBlci5yZW1vdmVDb21wbGV0ZWx5RnJvbUludmVyc2UoKTsKCiAgICB0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsID0gbnVsbDsKICB9CgogIGZsdXNoQ2Fub25pY2FsKCkgewogICAgLy90ZW1wb3JhcnkgZml4IHRvIG5vdCByZW1vdmUgbmV3bHkgY3JlYXRlZCByZWNvcmRzIGlmIHNlcnZlciByZXR1cm5lZCBudWxsLgogICAgLy9UT0RPIHJlbW92ZSBvbmNlIHdlIGhhdmUgcHJvcGVyIGRpZmZpbmcKICAgIGlmICh0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsICYmIHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwuaXNOZXcoKSAmJiAhdGhpcy5jYW5vbmljYWxTdGF0ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5pbnZlcnNlSW50ZXJuYWxNb2RlbCAhPT0gdGhpcy5jYW5vbmljYWxTdGF0ZSkgewogICAgICB0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsID0gdGhpcy5jYW5vbmljYWxTdGF0ZTsKICAgICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgICAgdGhpcy5ub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKTsKICAgIH0KCiAgICBzdXBlci5mbHVzaENhbm9uaWNhbCgpOwogIH0KCiAgYWRkSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKSB7CiAgICBpZiAodGhpcy5tZW1iZXJzLmhhcyhpbnRlcm5hbE1vZGVsKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgZW1iZXJEYXRhX0RlYnVnLmFzc2VydFBvbHltb3JwaGljVHlwZSh0aGlzLmludGVybmFsTW9kZWwsIHRoaXMucmVsYXRpb25zaGlwTWV0YSwgaW50ZXJuYWxNb2RlbCk7CgogICAgaWYgKHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwpIHsKICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbE1vZGVsKHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwpOwogICAgfQoKICAgIHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsOwogICAgc3VwZXIuYWRkSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMubm90aWZ5QmVsb25nc1RvQ2hhbmdlKCk7CiAgfQoKICBzZXRSZWNvcmRQcm9taXNlKGJlbG9uZ3NUb1Byb21pc2UpIHsKICAgICh0cnVlICYmICEoYmVsb25nc1RvUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2VPYmplY3QpICYmIEVtYmVyLmFzc2VydCgnWW91IHBhc3NlZCBpbiBhIHByb21pc2UgdGhhdCBkaWQgbm90IG9yaWdpbmF0ZSBmcm9tIGFuIEVtYmVyRGF0YSByZWxhdGlvbnNoaXAuIFlvdSBjYW4gb25seSBwYXNzIHByb21pc2VzIHRoYXQgY29tZSBmcm9tIGEgYmVsb25nc1RvIG9yIGhhc01hbnkgcmVsYXRpb25zaGlwIHRvIHRoZSBnZXQgY2FsbC4nLCBiZWxvbmdzVG9Qcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZU9iamVjdCkpOwoKCiAgICB2YXIgY29udGVudCA9IGJlbG9uZ3NUb1Byb21pc2UuZ2V0KCdjb250ZW50Jyk7CiAgICB2YXIgcHJvbWlzZSA9IGJlbG9uZ3NUb1Byb21pc2UuZ2V0KCdwcm9taXNlJyk7CgogICAgdGhpcy5zZXRJbnRlcm5hbE1vZGVsKGNvbnRlbnQgPyBjb250ZW50Ll9pbnRlcm5hbE1vZGVsIDogY29udGVudCk7CiAgICB0aGlzLl91cGRhdGVMb2FkaW5nUHJvbWlzZShwcm9taXNlLCBjb250ZW50KTsKICB9CgogIHJlbW92ZUludGVybmFsTW9kZWxGcm9tT3duKGludGVybmFsTW9kZWwpIHsKICAgIGlmICghdGhpcy5tZW1iZXJzLmhhcyhpbnRlcm5hbE1vZGVsKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsID0gbnVsbDsKICAgIHRoaXMuX3Byb21pc2VQcm94eSA9IG51bGw7CiAgICBzdXBlci5yZW1vdmVJbnRlcm5hbE1vZGVsRnJvbU93bihpbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMubm90aWZ5QmVsb25nc1RvQ2hhbmdlKCk7CiAgfQoKICByZW1vdmVBbGxJbnRlcm5hbE1vZGVsc0Zyb21Pd24oKSB7CiAgICBzdXBlci5yZW1vdmVBbGxJbnRlcm5hbE1vZGVsc0Zyb21Pd24oKTsKICAgIHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwgPSBudWxsOwogICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgIHRoaXMubm90aWZ5QmVsb25nc1RvQ2hhbmdlKCk7CiAgfQoKICBub3RpZnlCZWxvbmdzVG9DaGFuZ2UoKSB7CiAgICBpZiAodGhpcy5fcHJvbWlzZVByb3h5ICE9PSBudWxsKSB7CiAgICAgIHZhciBpTSA9IHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWw7CgogICAgICB0aGlzLl91cGRhdGVMb2FkaW5nUHJvbWlzZShwcm94eVJlY29yZChpTSksIGlNID8gaU0uZ2V0UmVjb3JkKCkgOiBudWxsKTsKICAgIH0KCiAgICB0aGlzLmludGVybmFsTW9kZWwubm90aWZ5QmVsb25nc1RvQ2hhbmdlKHRoaXMua2V5KTsKICB9CgogIHJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tT3duKGludGVybmFsTW9kZWwpIHsKICAgIGlmICghdGhpcy5jYW5vbmljYWxNZW1iZXJzLmhhcyhpbnRlcm5hbE1vZGVsKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNhbm9uaWNhbFN0YXRlID0gbnVsbDsKICAgIHN1cGVyLnJlbW92ZUNhbm9uaWNhbEludGVybmFsTW9kZWxGcm9tT3duKGludGVybmFsTW9kZWwpOwogIH0KCiAgcmVtb3ZlQWxsQ2Fub25pY2FsSW50ZXJuYWxNb2RlbHNGcm9tT3duKCkgewogICAgc3VwZXIucmVtb3ZlQWxsQ2Fub25pY2FsSW50ZXJuYWxNb2RlbHNGcm9tT3duKCk7CiAgICB0aGlzLmNhbm9uaWNhbFN0YXRlID0gbnVsbDsKICB9CgogIC8vIGNhbGxlZCBieSBgZ2V0RGF0YSgpYCB3aGVuIGEgcmVxdWVzdCBpcyBuZWVkZWQKICAvLyAgIGJ1dCBubyBsaW5rIGlzIGF2YWlsYWJsZQogIF9mZXRjaFJlY29yZCgpIHsKICAgIHZhciB7IGludmVyc2VJbnRlcm5hbE1vZGVsLCBzaG91bGRGb3JjZVJlbG9hZCB9ID0gdGhpczsKCiAgICBpZiAoaW52ZXJzZUludGVybmFsTW9kZWwpIHsKICAgICAgdmFyIHByb21pc2UgPSB2b2lkIDA7CgogICAgICBpZiAoc2hvdWxkRm9yY2VSZWxvYWQgJiYgIWludmVyc2VJbnRlcm5hbE1vZGVsLmlzRW1wdHkoKSAmJiBpbnZlcnNlSW50ZXJuYWxNb2RlbC5oYXNSZWNvcmQpIHsKICAgICAgICAvLyByZWxvYWQgcmVjb3JkLCBpZiBpdCBpcyBhbHJlYWR5IGxvYWRlZAogICAgICAgIC8vICAgaWYgd2UgaGF2ZSBhIGxpbmssIHdlIHdvdWxkIGFscmVhZHkgYmUgaW4gYGZpbmRMaW5rKClgCiAgICAgICAgcHJvbWlzZSA9IGludmVyc2VJbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpLnJlbG9hZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHByb21pc2UgPSB0aGlzLnN0b3JlLl9maW5kQnlJbnRlcm5hbE1vZGVsKGludmVyc2VJbnRlcm5hbE1vZGVsKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CgogICAgLy8gVE9ETyBpcyB0aGlzIGFjdHVhbGx5IGFuIGVycm9yIGNhc2U/CiAgICByZXR1cm4gRW1iZXIuUlNWUC5yZXNvbHZlKG51bGwpOwogIH0KCiAgLy8gY2FsbGVkIGJ5IGBnZXREYXRhKClgIHdoZW4gYSByZXF1ZXN0IGlzIG5lZWRlZAogIC8vICAgYW5kIGEgbGluayBpcyBhdmFpbGFibGUKICBfZmV0Y2hMaW5rKCkgewogICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEJlbG9uZ3NUbyh0aGlzLmludGVybmFsTW9kZWwsIHRoaXMubGluaywgdGhpcy5yZWxhdGlvbnNoaXBNZXRhKS50aGVuKGludGVybmFsTW9kZWwgPT4gewogICAgICBpZiAoaW50ZXJuYWxNb2RlbCkgewogICAgICAgIHRoaXMuYWRkSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgIH0pOwogIH0KCiAgZ2V0RGF0YSgpIHsKICAgIC8vVE9ETyhJZ29yKSBmbHVzaENhbm9uaWNhbCBoZXJlIG9uY2Ugb3VyIHN5bmNpbmcgaXMgbm90IHN0dXBpZAogICAgdmFyIHJlY29yZCA9IHRoaXMuaW52ZXJzZUludGVybmFsTW9kZWwgPyB0aGlzLmludmVyc2VJbnRlcm5hbE1vZGVsLmdldFJlY29yZCgpIDogbnVsbDsKCiAgICBpZiAodGhpcy5zaG91bGRNYWtlUmVxdWVzdCgpKSB7CiAgICAgIHZhciBwcm9taXNlID0gdm9pZCAwOwoKICAgICAgaWYgKHRoaXMubGluaykgewogICAgICAgIHByb21pc2UgPSB0aGlzLl9mZXRjaExpbmsoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9taXNlID0gdGhpcy5fZmV0Y2hSZWNvcmQoKTsKICAgICAgfQoKICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbigoKSA9PiBoYW5kbGVDb21wbGV0ZWRGaW5kKHRoaXMpLCBlID0+IGhhbmRsZUNvbXBsZXRlZEZpbmQodGhpcywgZSkpOwoKICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbihpbnRlcm5hbE1vZGVsID0+IHsKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbCA/IGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCkgOiBudWxsOwogICAgICB9KTsKCiAgICAgIHRoaXMuZmV0Y2hQcm9taXNlID0gcHJvbWlzZTsKICAgICAgdGhpcy5fdXBkYXRlTG9hZGluZ1Byb21pc2UocHJvbWlzZSk7CiAgICB9CgogICAgaWYgKHRoaXMuaXNBc3luYykgewogICAgICBpZiAodGhpcy5fcHJvbWlzZVByb3h5ID09PSBudWxsKSB7CiAgICAgICAgdmFyIF9wcm9taXNlID0gcHJveHlSZWNvcmQodGhpcy5pbnZlcnNlSW50ZXJuYWxNb2RlbCk7CiAgICAgICAgdGhpcy5fdXBkYXRlTG9hZGluZ1Byb21pc2UoX3Byb21pc2UsIHJlY29yZCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9wcm9taXNlUHJveHk7CiAgICB9IGVsc2UgewogICAgICAodHJ1ZSAmJiAhKHJlY29yZCA9PT0gbnVsbCB8fCAhcmVjb3JkLmdldCgnaXNFbXB0eScpKSAmJiBFbWJlci5hc3NlcnQoIllvdSBsb29rZWQgdXAgdGhlICciICsgdGhpcy5rZXkgKyAiJyByZWxhdGlvbnNoaXAgb24gYSAnIiArIHRoaXMuaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUgKyAiJyB3aXRoIGlkICIgKyB0aGlzLmludGVybmFsTW9kZWwuaWQgKyAnIGJ1dCBzb21lIG9mIHRoZSBhc3NvY2lhdGVkIHJlY29yZHMgd2VyZSBub3QgbG9hZGVkLiBFaXRoZXIgbWFrZSBzdXJlIHRoZXkgYXJlIGFsbCBsb2FkZWQgdG9nZXRoZXIgd2l0aCB0aGUgcGFyZW50IHJlY29yZCwgb3Igc3BlY2lmeSB0aGF0IHRoZSByZWxhdGlvbnNoaXAgaXMgYXN5bmMgKGBEUy5iZWxvbmdzVG8oeyBhc3luYzogdHJ1ZSB9KWApJywgcmVjb3JkID09PSBudWxsIHx8ICFyZWNvcmQuZ2V0KCdpc0VtcHR5JykpKTsKCiAgICAgIHJldHVybiByZWNvcmQ7CiAgICB9CiAgfQoKICBfY3JlYXRlUHJveHkocHJvbWlzZSwgY29udGVudCkgewogICAgcmV0dXJuIFByb21pc2VCZWxvbmdzVG8uY3JlYXRlKHsKICAgICAgX2JlbG9uZ3NUb1N0YXRlOiB0aGlzLAogICAgICBwcm9taXNlLAogICAgICBjb250ZW50CiAgICB9KTsKICB9CgogIHVwZGF0ZURhdGEoZGF0YSwgaW5pdGlhbCkgewogICAgKHRydWUgJiYgIShkYXRhID09PSBudWxsIHx8IGRhdGEuaWQgIT09IHVuZGVmaW5lZCAmJiBkYXRhLnR5cGUgIT09IHVuZGVmaW5lZCkgJiYgRW1iZXIuYXNzZXJ0KGBFbWJlciBEYXRhIGV4cGVjdGVkIHRoZSBkYXRhIGZvciB0aGUgJHt0aGlzLmtleX0gcmVsYXRpb25zaGlwIG9uIGEgJHt0aGlzLmludGVybmFsTW9kZWwudG9TdHJpbmcoKX0gdG8gYmUgaW4gYSBKU09OIEFQSSBmb3JtYXQgYW5kIGluY2x1ZGUgYW4gXGBpZFxgIGFuZCBcYHR5cGVcYCBwcm9wZXJ0eSBidXQgaXQgZm91bmQgJHtFbWJlci5pbnNwZWN0KGRhdGEpfS4gUGxlYXNlIGNoZWNrIHlvdXIgc2VyaWFsaXplciBhbmQgbWFrZSBzdXJlIGl0IGlzIHNlcmlhbGl6aW5nIHRoZSByZWxhdGlvbnNoaXAgcGF5bG9hZCBpbnRvIGEgSlNPTiBBUEkgZm9ybWF0LmAsIGRhdGEgPT09IG51bGwgfHwgZGF0YS5pZCAhPT0gdW5kZWZpbmVkICYmIGRhdGEudHlwZSAhPT0gdW5kZWZpbmVkKSk7CgogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLnN0b3JlLl9wdXNoUmVzb3VyY2VJZGVudGlmaWVyKHRoaXMsIGRhdGEpOwogICAgaWYgKGluaXRpYWwpIHsKICAgICAgdGhpcy5zZXRJbml0aWFsQ2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2V0Q2Fub25pY2FsSW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHByb3h5UmVjb3JkKGludGVybmFsTW9kZWwpIHsKICByZXR1cm4gRW1iZXIuUlNWUC5yZXNvbHZlKGludGVybmFsTW9kZWwpLnRoZW4ocmVzb2x2ZWRJbnRlcm5hbE1vZGVsID0+IHsKICAgIHJldHVybiByZXNvbHZlZEludGVybmFsTW9kZWwgPyByZXNvbHZlZEludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCkgOiBudWxsOwogIH0pOwp9CgpmdW5jdGlvbiBoYW5kbGVDb21wbGV0ZWRGaW5kKHJlbGF0aW9uc2hpcCwgZXJyb3IpIHsKICB2YXIgaW50ZXJuYWxNb2RlbCA9IHJlbGF0aW9uc2hpcC5pbnZlcnNlSW50ZXJuYWxNb2RlbDsKCiAgcmVsYXRpb25zaGlwLmZldGNoUHJvbWlzZSA9IG51bGw7CiAgcmVsYXRpb25zaGlwLnNldFNob3VsZEZvcmNlUmVsb2FkKGZhbHNlKTsKCiAgaWYgKGVycm9yKSB7CiAgICByZWxhdGlvbnNoaXAuc2V0SGFzRmFpbGVkTG9hZEF0dGVtcHQodHJ1ZSk7CiAgICB0aHJvdyBlcnJvcjsKICB9CgogIHJlbGF0aW9uc2hpcC5zZXRIYXNGYWlsZWRMb2FkQXR0ZW1wdChmYWxzZSk7CiAgLy8gb25seSBzZXQgdG8gbm90IHN0YWxlIGlmIG5vIGVycm9yIGlzIHRocm93bgogIHJlbGF0aW9uc2hpcC5zZXRSZWxhdGlvbnNoaXBJc1N0YWxlKGZhbHNlKTsKCiAgcmV0dXJuIGludGVybmFsTW9kZWw7Cn0KCmZ1bmN0aW9uIHNob3VsZEZpbmRJbnZlcnNlKHJlbGF0aW9uc2hpcE1ldGEpIHsKICB2YXIgb3B0aW9ucyA9IHJlbGF0aW9uc2hpcE1ldGEub3B0aW9uczsKICByZXR1cm4gIShvcHRpb25zICYmIG9wdGlvbnMuaW52ZXJzZSA9PT0gbnVsbCk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVJlbGF0aW9uc2hpcEZvcihpbnRlcm5hbE1vZGVsLCByZWxhdGlvbnNoaXBNZXRhLCBzdG9yZSkgewogIHZhciBpbnZlcnNlS2V5ID0gdm9pZCAwOwogIHZhciBpbnZlcnNlID0gbnVsbDsKCiAgaWYgKHNob3VsZEZpbmRJbnZlcnNlKHJlbGF0aW9uc2hpcE1ldGEpKSB7CiAgICBpbnZlcnNlID0gaW50ZXJuYWxNb2RlbC50eXBlLmludmVyc2VGb3IocmVsYXRpb25zaGlwTWV0YS5rZXksIHN0b3JlKTsKICB9IGVsc2UgewogICAgaW50ZXJuYWxNb2RlbC50eXBlLnR5cGVGb3JSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTWV0YS5rZXksIHN0b3JlKTsKICB9CgogIGlmIChpbnZlcnNlKSB7CiAgICBpbnZlcnNlS2V5ID0gaW52ZXJzZS5uYW1lOwogIH0KCiAgaWYgKHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICByZXR1cm4gbmV3IE1hbnlSZWxhdGlvbnNoaXAoc3RvcmUsIGludGVybmFsTW9kZWwsIGludmVyc2VLZXksIHJlbGF0aW9uc2hpcE1ldGEpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gbmV3IEJlbG9uZ3NUb1JlbGF0aW9uc2hpcChzdG9yZSwgaW50ZXJuYWxNb2RlbCwgaW52ZXJzZUtleSwgcmVsYXRpb25zaGlwTWV0YSk7CiAgfQp9CgpjbGFzcyBSZWxhdGlvbnNoaXBzIHsKICBjb25zdHJ1Y3RvcihpbnRlcm5hbE1vZGVsKSB7CiAgICB0aGlzLmludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsOwogICAgdGhpcy5pbml0aWFsaXplZFJlbGF0aW9uc2hpcHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIH0KCiAgLy8gVE9ETyBAcnVuc3BpcmVkIGRlcHJlY2F0ZSB0aGlzIGFzIGl0IHdhcyBuZXZlciB0cnVseSBhIHJlY29yZCBpbnN0YW5jZQogIGdldCByZWNvcmQoKSB7CiAgICByZXR1cm4gdGhpcy5pbnRlcm5hbE1vZGVsOwogIH0KCiAgaGFzKGtleSkgewogICAgcmV0dXJuICEhdGhpcy5pbml0aWFsaXplZFJlbGF0aW9uc2hpcHNba2V5XTsKICB9CgogIGZvckVhY2goY2IpIHsKICAgIHZhciByZWxzID0gdGhpcy5pbml0aWFsaXplZFJlbGF0aW9uc2hpcHM7CiAgICBPYmplY3Qua2V5cyhyZWxzKS5mb3JFYWNoKG5hbWUgPT4gewogICAgICBjYihuYW1lLCByZWxzW25hbWVdKTsKICAgIH0pOwogIH0KCiAgZ2V0KGtleSkgewogICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB0aGlzLmluaXRpYWxpemVkUmVsYXRpb25zaGlwczsKICAgIHZhciByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBzW2tleV07CiAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuaW50ZXJuYWxNb2RlbDsKCiAgICBpZiAoIXJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgcmVsYXRpb25zaGlwc0J5TmFtZSA9IEVtYmVyLmdldChpbnRlcm5hbE1vZGVsLnR5cGUsICdyZWxhdGlvbnNoaXBzQnlOYW1lJyk7CiAgICAgIHZhciByZWwgPSByZWxhdGlvbnNoaXBzQnlOYW1lLmdldChrZXkpOwoKICAgICAgaWYgKCFyZWwpIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CgogICAgICB2YXIgcmVsYXRpb25zaGlwUGF5bG9hZCA9IGludGVybmFsTW9kZWwuc3RvcmUuX3JlbGF0aW9uc2hpcHNQYXlsb2Fkcy5nZXQoaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUsIGludGVybmFsTW9kZWwuaWQsIGtleSk7CgogICAgICByZWxhdGlvbnNoaXAgPSByZWxhdGlvbnNoaXBzW2tleV0gPSBjcmVhdGVSZWxhdGlvbnNoaXBGb3IoaW50ZXJuYWxNb2RlbCwgcmVsLCBpbnRlcm5hbE1vZGVsLnN0b3JlKTsKCiAgICAgIGlmIChyZWxhdGlvbnNoaXBQYXlsb2FkKSB7CiAgICAgICAgcmVsYXRpb25zaGlwLnB1c2gocmVsYXRpb25zaGlwUGF5bG9hZCwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVsYXRpb25zaGlwOwogIH0KfQoKLyoqCiAgQGNsYXNzIFNuYXBzaG90CiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnVjdG9yCiAgQHBhcmFtIHtEUy5Nb2RlbH0gaW50ZXJuYWxNb2RlbCBUaGUgbW9kZWwgdG8gY3JlYXRlIGEgc25hcHNob3QgZnJvbQoqLwovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KY2xhc3MgU25hcHNob3QgewogIGNvbnN0cnVjdG9yKGludGVybmFsTW9kZWwsIG9wdGlvbnMgPSB7fSkgewogICAgdGhpcy5fX2F0dHJpYnV0ZXMgPSBudWxsOwogICAgdGhpcy5fYmVsb25nc1RvUmVsYXRpb25zaGlwcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB0aGlzLl9iZWxvbmdzVG9JZHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5faGFzTWFueVJlbGF0aW9uc2hpcHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5faGFzTWFueUlkcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB0aGlzLl9pbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbDsKCiAgICAvKgogICAgICBJZiB0aGUgaW50ZXJuYWxNb2RlbCBkb2VzIG5vdCB5ZXQgaGF2ZSBhIHJlY29yZCwgdGhlbiB3ZSBhcmUKICAgICAgbGlrZWx5IGEgc25hcHNob3QgYmVpbmcgcHJvdmlkZWQgdG8gYSBmaW5kIHJlcXVlc3QsIHNvIHdlCiAgICAgIHBvcHVsYXRlIF9fYXR0cmlidXRlcyBsYXppbHkuIEVsc2UsIHRvIHByZXNlcnZlIHRoZSAibW9tZW50CiAgICAgIGluIHRpbWUiIGluIHdoaWNoIGEgc25hcHNob3QgaXMgY3JlYXRlZCwgd2UgZ3JlZWRpbHkgZ3JhYgogICAgICB0aGUgdmFsdWVzLgogICAgICovCiAgICBpZiAoaW50ZXJuYWxNb2RlbC5oYXNSZWNvcmQpIHsKICAgICAgdGhpcy5fYXR0cmlidXRlczsKICAgIH0KCiAgICAvKipPCiAgICAgVGhlIGlkIG9mIHRoZSBzbmFwc2hvdCdzIHVuZGVybHlpbmcgcmVjb3JkCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIC8vIHN0b3JlLnB1c2goJ3Bvc3QnLCB7IGlkOiAxLCBhdXRob3I6ICdUb21zdGVyJywgdGl0bGU6ICdFbWJlci5qcyByb2NrcycgfSk7CiAgICAgcG9zdFNuYXBzaG90LmlkOyAvLyA9PiAnMScKICAgICBgYGAKICAgICAgQHByb3BlcnR5IGlkCiAgICAgQHR5cGUge1N0cmluZ30KICAgICAqLwogICAgdGhpcy5pZCA9IGludGVybmFsTW9kZWwuaWQ7CgogICAgLyoqCiAgICAgQSBoYXNoIG9mIGFkYXB0ZXIgb3B0aW9ucwogICAgIEBwcm9wZXJ0eSBhZGFwdGVyT3B0aW9ucwogICAgIEB0eXBlIHtPYmplY3R9CiAgICAgKi8KICAgIHRoaXMuYWRhcHRlck9wdGlvbnMgPSBvcHRpb25zLmFkYXB0ZXJPcHRpb25zOwogICAgdGhpcy5pbmNsdWRlID0gb3B0aW9ucy5pbmNsdWRlOwoKICAgIC8qKgogICAgIFRoZSBuYW1lIG9mIHRoZSB0eXBlIG9mIHRoZSB1bmRlcmx5aW5nIHJlY29yZCBmb3IgdGhpcyBzbmFwc2hvdCwgYXMgYSBzdHJpbmcuCiAgICAgIEBwcm9wZXJ0eSBtb2RlbE5hbWUKICAgICBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICB0aGlzLm1vZGVsTmFtZSA9IGludGVybmFsTW9kZWwubW9kZWxOYW1lOwoKICAgIHRoaXMuX2NoYW5nZWRBdHRyaWJ1dGVzID0gaW50ZXJuYWxNb2RlbC5jaGFuZ2VkQXR0cmlidXRlcygpOwogIH0KCiAgLyoqCiAgIFRoZSB1bmRlcmx5aW5nIHJlY29yZCBmb3IgdGhpcyBzbmFwc2hvdC4gQ2FuIGJlIHVzZWQgdG8gYWNjZXNzIG1ldGhvZHMgYW5kCiAgIHByb3BlcnRpZXMgZGVmaW5lZCBvbiB0aGUgcmVjb3JkLgogICAgRXhhbXBsZQogICAgYGBgamF2YXNjcmlwdAogICBsZXQganNvbiA9IHNuYXBzaG90LnJlY29yZC50b0pTT04oKTsKICAgYGBgCiAgICBAcHJvcGVydHkgcmVjb3JkCiAgIEB0eXBlIHtEUy5Nb2RlbH0KICAgKi8KICBnZXQgcmVjb3JkKCkgewogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCk7CiAgfQoKICBnZXQgX2F0dHJpYnV0ZXMoKSB7CiAgICB2YXIgYXR0cmlidXRlcyA9IHRoaXMuX19hdHRyaWJ1dGVzOwoKICAgIGlmIChhdHRyaWJ1dGVzID09PSBudWxsKSB7CiAgICAgIHZhciByZWNvcmQgPSB0aGlzLnJlY29yZDsKICAgICAgYXR0cmlidXRlcyA9IHRoaXMuX19hdHRyaWJ1dGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGtleU5hbWUgPT4gYXR0cmlidXRlc1trZXlOYW1lXSA9IEVtYmVyLmdldChyZWNvcmQsIGtleU5hbWUpKTsKICAgIH0KCiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CgogIC8qKgogICBUaGUgdHlwZSBvZiB0aGUgdW5kZXJseWluZyByZWNvcmQgZm9yIHRoaXMgc25hcHNob3QsIGFzIGEgRFMuTW9kZWwuCiAgICBAcHJvcGVydHkgdHlwZQogICBAdHlwZSB7RFMuTW9kZWx9CiAgICovCiAgZ2V0IHR5cGUoKSB7CiAgICAvLyBUT0RPIEBydW5zcGlyZWQgd2Ugc2hvdWxkIGRlcHJlY2F0ZSB0aGlzIGluIGZhdm9yIG9mIG1vZGVsQ2xhc3MgYnV0IG9ubHkgb25jZQogICAgLy8gd2UndmUgY2xlYW5lZCB1cCB0aGUgaW50ZXJuYWxzIGVub3VnaCB0aGF0IGEgcHVibGljIGNoYW5nZSB0byBmb2xsb3cgc3VpdGUgaXMKICAgIC8vIHVuY29udHJvdmVyc2lhbC4KICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLm1vZGVsQ2xhc3M7CiAgfQoKICAvKioKICAgUmV0dXJucyB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgRXhhbXBsZQogICAgYGBgamF2YXNjcmlwdAogICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0pOwogICBwb3N0U25hcHNob3QuYXR0cignYXV0aG9yJyk7IC8vID0+ICdUb21zdGVyJwogICBwb3N0U25hcHNob3QuYXR0cigndGl0bGUnKTsgLy8gPT4gJ0VtYmVyLmpzIHJvY2tzJwogICBgYGAKICAgIE5vdGU6IFZhbHVlcyBhcmUgbG9hZGVkIGVhZ2VybHkgYW5kIGNhY2hlZCB3aGVuIHRoZSBzbmFwc2hvdCBpcyBjcmVhdGVkLgogICAgQG1ldGhvZCBhdHRyCiAgIEBwYXJhbSB7U3RyaW5nfSBrZXlOYW1lCiAgIEByZXR1cm4ge09iamVjdH0gVGhlIGF0dHJpYnV0ZSB2YWx1ZSBvciB1bmRlZmluZWQKICAgKi8KICBhdHRyKGtleU5hbWUpIHsKICAgIGlmIChrZXlOYW1lIGluIHRoaXMuX2F0dHJpYnV0ZXMpIHsKICAgICAgcmV0dXJuIHRoaXMuX2F0dHJpYnV0ZXNba2V5TmFtZV07CiAgICB9CiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk1vZGVsICciICsgRW1iZXIuaW5zcGVjdCh0aGlzLnJlY29yZCkgKyAiJyBoYXMgbm8gYXR0cmlidXRlIG5hbWVkICciICsga2V5TmFtZSArICInIGRlZmluZWQuIik7CiAgfQoKICAvKioKICAgUmV0dXJucyBhbGwgYXR0cmlidXRlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICBFeGFtcGxlCiAgICBgYGBqYXZhc2NyaXB0CiAgIC8vIHN0b3JlLnB1c2goJ3Bvc3QnLCB7IGlkOiAxLCBhdXRob3I6ICdUb21zdGVyJywgdGl0bGU6ICdFbWJlci5qcyByb2NrcycgfSk7CiAgIHBvc3RTbmFwc2hvdC5hdHRyaWJ1dGVzKCk7IC8vID0+IHsgYXV0aG9yOiAnVG9tc3RlcicsIHRpdGxlOiAnRW1iZXIuanMgcm9ja3MnIH0KICAgYGBgCiAgICBAbWV0aG9kIGF0dHJpYnV0ZXMKICAgQHJldHVybiB7T2JqZWN0fSBBbGwgYXR0cmlidXRlcyBvZiB0aGUgY3VycmVudCBzbmFwc2hvdAogICAqLwogIGF0dHJpYnV0ZXMoKSB7CiAgICByZXR1cm4gRW1iZXIuYXNzaWduKHt9LCB0aGlzLl9hdHRyaWJ1dGVzKTsKICB9CgogIC8qKgogICBSZXR1cm5zIGFsbCBjaGFuZ2VkIGF0dHJpYnV0ZXMgYW5kIHRoZWlyIG9sZCBhbmQgbmV3IHZhbHVlcy4KICAgIEV4YW1wbGUKICAgIGBgYGphdmFzY3JpcHQKICAgLy8gc3RvcmUucHVzaCgncG9zdCcsIHsgaWQ6IDEsIGF1dGhvcjogJ1RvbXN0ZXInLCB0aXRsZTogJ0VtYmVyLmpzIHJvY2tzJyB9KTsKICAgcG9zdE1vZGVsLnNldCgndGl0bGUnLCAnRW1iZXIuanMgcm9ja3MhJyk7CiAgIHBvc3RTbmFwc2hvdC5jaGFuZ2VkQXR0cmlidXRlcygpOyAvLyA9PiB7IHRpdGxlOiBbJ0VtYmVyLmpzIHJvY2tzJywgJ0VtYmVyLmpzIHJvY2tzISddIH0KICAgYGBgCiAgICBAbWV0aG9kIGNoYW5nZWRBdHRyaWJ1dGVzCiAgIEByZXR1cm4ge09iamVjdH0gQWxsIGNoYW5nZWQgYXR0cmlidXRlcyBvZiB0aGUgY3VycmVudCBzbmFwc2hvdAogICAqLwogIGNoYW5nZWRBdHRyaWJ1dGVzKCkgewogICAgdmFyIGNoYW5nZWRBdHRyaWJ1dGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBjaGFuZ2VkQXR0cmlidXRlS2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX2NoYW5nZWRBdHRyaWJ1dGVzKTsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gY2hhbmdlZEF0dHJpYnV0ZUtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGNoYW5nZWRBdHRyaWJ1dGVLZXlzW2ldOwogICAgICBjaGFuZ2VkQXR0cmlidXRlc1trZXldID0gdGhpcy5fY2hhbmdlZEF0dHJpYnV0ZXNba2V5XS5zbGljZSgpOwogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkQXR0cmlidXRlczsKICB9CgogIC8qKgogICBSZXR1cm5zIHRoZSBjdXJyZW50IHZhbHVlIG9mIGEgYmVsb25nc1RvIHJlbGF0aW9uc2hpcC4KICAgIGBiZWxvbmdzVG9gIHRha2VzIGFuIG9wdGlvbmFsIGhhc2ggb2Ygb3B0aW9ucyBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsCiAgIGN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAtIGBpZGA6IHNldCB0byBgdHJ1ZWAgaWYgeW91IG9ubHkgd2FudCB0aGUgSUQgb2YgdGhlIHJlbGF0ZWQgcmVjb3JkIHRvIGJlCiAgIHJldHVybmVkLgogICAgRXhhbXBsZQogICAgYGBgamF2YXNjcmlwdAogICAvLyBzdG9yZS5wdXNoKCdwb3N0JywgeyBpZDogMSwgdGl0bGU6ICdIZWxsbyBXb3JsZCcgfSk7CiAgIC8vIHN0b3JlLmNyZWF0ZVJlY29yZCgnY29tbWVudCcsIHsgYm9keTogJ0xvcmVtIGlwc3VtJywgcG9zdDogcG9zdCB9KTsKICAgY29tbWVudFNuYXBzaG90LmJlbG9uZ3NUbygncG9zdCcpOyAvLyA9PiBEUy5TbmFwc2hvdAogICBjb21tZW50U25hcHNob3QuYmVsb25nc1RvKCdwb3N0JywgeyBpZDogdHJ1ZSB9KTsgLy8gPT4gJzEnCiAgICAvLyBzdG9yZS5wdXNoKCdjb21tZW50JywgeyBpZDogMSwgYm9keTogJ0xvcmVtIGlwc3VtJyB9KTsKICAgY29tbWVudFNuYXBzaG90LmJlbG9uZ3NUbygncG9zdCcpOyAvLyA9PiB1bmRlZmluZWQKICAgYGBgCiAgICBDYWxsaW5nIGBiZWxvbmdzVG9gIHdpbGwgcmV0dXJuIGEgbmV3IFNuYXBzaG90IGFzIGxvbmcgYXMgdGhlcmUncyBhbnkga25vd24KICAgZGF0YSBmb3IgdGhlIHJlbGF0aW9uc2hpcCBhdmFpbGFibGUsIHN1Y2ggYXMgYW4gSUQuIElmIHRoZSByZWxhdGlvbnNoaXAgaXMKICAga25vd24gYnV0IHVuc2V0LCBgYmVsb25nc1RvYCB3aWxsIHJldHVybiBgbnVsbGAuIElmIHRoZSBjb250ZW50cyBvZiB0aGUKICAgcmVsYXRpb25zaGlwIGlzIHVua25vd24gYGJlbG9uZ3NUb2Agd2lsbCByZXR1cm4gYHVuZGVmaW5lZGAuCiAgICBOb3RlOiBSZWxhdGlvbnNoaXBzIGFyZSBsb2FkZWQgbGF6aWx5IGFuZCBjYWNoZWQgdXBvbiBmaXJzdCBhY2Nlc3MuCiAgICBAbWV0aG9kIGJlbG9uZ3NUbwogICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZQogICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCiAgIEByZXR1cm4geyhEUy5TbmFwc2hvdHxTdHJpbmd8bnVsbHx1bmRlZmluZWQpfSBBIHNuYXBzaG90IG9yIElEIG9mIGEga25vd24KICAgcmVsYXRpb25zaGlwIG9yIG51bGwgaWYgdGhlIHJlbGF0aW9uc2hpcCBpcyBrbm93biBidXQgdW5zZXQuIHVuZGVmaW5lZAogICB3aWxsIGJlIHJldHVybmVkIGlmIHRoZSBjb250ZW50cyBvZiB0aGUgcmVsYXRpb25zaGlwIGlzIHVua25vd24uCiAgICovCiAgYmVsb25nc1RvKGtleU5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciBpZCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pZDsKICAgIHZhciByZWxhdGlvbnNoaXAgPSB2b2lkIDA7CiAgICB2YXIgcmVzdWx0ID0gdm9pZCAwOwoKICAgIGlmIChpZCAmJiBrZXlOYW1lIGluIHRoaXMuX2JlbG9uZ3NUb0lkcykgewogICAgICByZXR1cm4gdGhpcy5fYmVsb25nc1RvSWRzW2tleU5hbWVdOwogICAgfQoKICAgIGlmICghaWQgJiYga2V5TmFtZSBpbiB0aGlzLl9iZWxvbmdzVG9SZWxhdGlvbnNoaXBzKSB7CiAgICAgIHJldHVybiB0aGlzLl9iZWxvbmdzVG9SZWxhdGlvbnNoaXBzW2tleU5hbWVdOwogICAgfQoKICAgIHJlbGF0aW9uc2hpcCA9IHRoaXMuX2ludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleU5hbWUpOwogICAgaWYgKCEocmVsYXRpb25zaGlwICYmIHJlbGF0aW9uc2hpcC5yZWxhdGlvbnNoaXBNZXRhLmtpbmQgPT09ICdiZWxvbmdzVG8nKSkgewogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk1vZGVsICciICsgRW1iZXIuaW5zcGVjdCh0aGlzLnJlY29yZCkgKyAiJyBoYXMgbm8gYmVsb25nc1RvIHJlbGF0aW9uc2hpcCBuYW1lZCAnIiArIGtleU5hbWUgKyAiJyBkZWZpbmVkLiIpOwogICAgfQoKICAgIHZhciB7CiAgICAgIGhhc0FueVJlbGF0aW9uc2hpcERhdGEsCiAgICAgIGludmVyc2VJbnRlcm5hbE1vZGVsCiAgICB9ID0gcmVsYXRpb25zaGlwOwoKICAgIGlmIChoYXNBbnlSZWxhdGlvbnNoaXBEYXRhKSB7CiAgICAgIGlmIChpbnZlcnNlSW50ZXJuYWxNb2RlbCAmJiAhaW52ZXJzZUludGVybmFsTW9kZWwuaXNEZWxldGVkKCkpIHsKICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgIHJlc3VsdCA9IEVtYmVyLmdldChpbnZlcnNlSW50ZXJuYWxNb2RlbCwgJ2lkJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IGludmVyc2VJbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaWQpIHsKICAgICAgdGhpcy5fYmVsb25nc1RvSWRzW2tleU5hbWVdID0gcmVzdWx0OwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fYmVsb25nc1RvUmVsYXRpb25zaGlwc1trZXlOYW1lXSA9IHJlc3VsdDsKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyoqCiAgIFJldHVybnMgdGhlIGN1cnJlbnQgdmFsdWUgb2YgYSBoYXNNYW55IHJlbGF0aW9uc2hpcC4KICAgIGBoYXNNYW55YCB0YWtlcyBhbiBvcHRpb25hbCBoYXNoIG9mIG9wdGlvbnMgYXMgYSBzZWNvbmQgcGFyYW1ldGVyLAogICBjdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgLSBgaWRzYDogc2V0IHRvIGB0cnVlYCBpZiB5b3Ugb25seSB3YW50IHRoZSBJRHMgb2YgdGhlIHJlbGF0ZWQgcmVjb3JkcyB0byBiZQogICByZXR1cm5lZC4KICAgIEV4YW1wbGUKICAgIGBgYGphdmFzY3JpcHQKICAgLy8gc3RvcmUucHVzaCgncG9zdCcsIHsgaWQ6IDEsIHRpdGxlOiAnSGVsbG8gV29ybGQnLCBjb21tZW50czogWzIsIDNdIH0pOwogICBwb3N0U25hcHNob3QuaGFzTWFueSgnY29tbWVudHMnKTsgLy8gPT4gW0RTLlNuYXBzaG90LCBEUy5TbmFwc2hvdF0KICAgcG9zdFNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJywgeyBpZHM6IHRydWUgfSk7IC8vID0+IFsnMicsICczJ10KICAgIC8vIHN0b3JlLnB1c2goJ3Bvc3QnLCB7IGlkOiAxLCB0aXRsZTogJ0hlbGxvIFdvcmxkJyB9KTsKICAgcG9zdFNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJyk7IC8vID0+IHVuZGVmaW5lZAogICBgYGAKICAgIE5vdGU6IFJlbGF0aW9uc2hpcHMgYXJlIGxvYWRlZCBsYXppbHkgYW5kIGNhY2hlZCB1cG9uIGZpcnN0IGFjY2Vzcy4KICAgIEBtZXRob2QgaGFzTWFueQogICBAcGFyYW0ge1N0cmluZ30ga2V5TmFtZQogICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCiAgIEByZXR1cm4geyhBcnJheXx1bmRlZmluZWQpfSBBbiBhcnJheSBvZiBzbmFwc2hvdHMgb3IgSURzIG9mIGEga25vd24KICAgcmVsYXRpb25zaGlwIG9yIGFuIGVtcHR5IGFycmF5IGlmIHRoZSByZWxhdGlvbnNoaXAgaXMga25vd24gYnV0IHVuc2V0LgogICB1bmRlZmluZWQgd2lsbCBiZSByZXR1cm5lZCBpZiB0aGUgY29udGVudHMgb2YgdGhlIHJlbGF0aW9uc2hpcCBpcyB1bmtub3duLgogICAqLwogIGhhc01hbnkoa2V5TmFtZSwgb3B0aW9ucykgewogICAgdmFyIGlkcyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pZHM7CiAgICB2YXIgcmVsYXRpb25zaGlwID0gdm9pZCAwOwogICAgdmFyIHJlc3VsdHMgPSB2b2lkIDA7CgogICAgaWYgKGlkcyAmJiBrZXlOYW1lIGluIHRoaXMuX2hhc01hbnlJZHMpIHsKICAgICAgcmV0dXJuIHRoaXMuX2hhc01hbnlJZHNba2V5TmFtZV07CiAgICB9CgogICAgaWYgKCFpZHMgJiYga2V5TmFtZSBpbiB0aGlzLl9oYXNNYW55UmVsYXRpb25zaGlwcykgewogICAgICByZXR1cm4gdGhpcy5faGFzTWFueVJlbGF0aW9uc2hpcHNba2V5TmFtZV07CiAgICB9CgogICAgcmVsYXRpb25zaGlwID0gdGhpcy5faW50ZXJuYWxNb2RlbC5fcmVsYXRpb25zaGlwcy5nZXQoa2V5TmFtZSk7CiAgICBpZiAoIShyZWxhdGlvbnNoaXAgJiYgcmVsYXRpb25zaGlwLnJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2hhc01hbnknKSkgewogICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoIk1vZGVsICciICsgRW1iZXIuaW5zcGVjdCh0aGlzLnJlY29yZCkgKyAiJyBoYXMgbm8gaGFzTWFueSByZWxhdGlvbnNoaXAgbmFtZWQgJyIgKyBrZXlOYW1lICsgIicgZGVmaW5lZC4iKTsKICAgIH0KCiAgICB2YXIgewogICAgICBoYXNBbnlSZWxhdGlvbnNoaXBEYXRhLAogICAgICBtZW1iZXJzCiAgICB9ID0gcmVsYXRpb25zaGlwOwoKICAgIGlmIChoYXNBbnlSZWxhdGlvbnNoaXBEYXRhKSB7CiAgICAgIHJlc3VsdHMgPSBbXTsKICAgICAgbWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7CiAgICAgICAgaWYgKCFtZW1iZXIuaXNEZWxldGVkKCkpIHsKICAgICAgICAgIGlmIChpZHMpIHsKICAgICAgICAgICAgcmVzdWx0cy5wdXNoKG1lbWJlci5pZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRzLnB1c2gobWVtYmVyLmNyZWF0ZVNuYXBzaG90KCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKGlkcykgewogICAgICB0aGlzLl9oYXNNYW55SWRzW2tleU5hbWVdID0gcmVzdWx0czsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2hhc01hbnlSZWxhdGlvbnNoaXBzW2tleU5hbWVdID0gcmVzdWx0czsKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0czsKICB9CgogIC8qKgogICAgSXRlcmF0ZXMgdGhyb3VnaCBhbGwgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsLCBjYWxsaW5nIHRoZSBwYXNzZWQKICAgIGZ1bmN0aW9uIG9uIGVhY2ggYXR0cmlidXRlLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKG5hbWUsIG1ldGEpIHsKICAgICAgLy8gLi4uCiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgZWFjaEF0dHJpYnV0ZQogICAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUKICAgIEBwYXJhbSB7T2JqZWN0fSBbYmluZGluZ10gdGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBjYWxsYmFjaydzIGB0aGlzYCBzaG91bGQgYmUgYm91bmQKICAqLwogIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHRoaXMucmVjb3JkLmVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpOwogIH0KCiAgLyoqCiAgICBJdGVyYXRlcyB0aHJvdWdoIGFsbCB0aGUgcmVsYXRpb25zaGlwcyBvZiB0aGUgbW9kZWwsIGNhbGxpbmcgdGhlIHBhc3NlZAogICAgZnVuY3Rpb24gb24gZWFjaCByZWxhdGlvbnNoaXAuCiAgICAgRXhhbXBsZQogICAgIGBgYGphdmFzY3JpcHQKICAgIHNuYXBzaG90LmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgIC8vIC4uLgogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIGVhY2hSZWxhdGlvbnNoaXAKICAgIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBleGVjdXRlCiAgICBAcGFyYW0ge09iamVjdH0gW2JpbmRpbmddIHRoZSB2YWx1ZSB0byB3aGljaCB0aGUgY2FsbGJhY2sncyBgdGhpc2Agc2hvdWxkIGJlIGJvdW5kCiAgKi8KICBlYWNoUmVsYXRpb25zaGlwKGNhbGxiYWNrLCBiaW5kaW5nKSB7CiAgICB0aGlzLnJlY29yZC5lYWNoUmVsYXRpb25zaGlwKGNhbGxiYWNrLCBiaW5kaW5nKTsKICB9CgogIC8qKgogICAgU2VyaWFsaXplcyB0aGUgc25hcHNob3QgdXNpbmcgdGhlIHNlcmlhbGl6ZXIgZm9yIHRoZSBtb2RlbC4KICAgICBFeGFtcGxlCiAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgRFMuQWRhcHRlci5leHRlbmQoewogICAgICBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgdmFyIGRhdGEgPSBzbmFwc2hvdC5zZXJpYWxpemUoeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgdmFyIHVybCA9IGAvJHt0eXBlLm1vZGVsTmFtZX1gOwogICAgICAgICByZXR1cm4gZmV0Y2godXJsLCB7CiAgICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICAgIGJvZHk6IGRhdGEsCiAgICAgICAgfSkudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSkKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge09iamVjdH0gYW4gb2JqZWN0IHdob3NlIHZhbHVlcyBhcmUgcHJpbWl0aXZlIEpTT04gdmFsdWVzIG9ubHkKICAgKi8KICBzZXJpYWxpemUob3B0aW9ucykgewogICAgcmV0dXJuIHRoaXMucmVjb3JkLnN0b3JlLnNlcmlhbGl6ZXJGb3IodGhpcy5tb2RlbE5hbWUpLnNlcmlhbGl6ZSh0aGlzLCBvcHRpb25zKTsKICB9Cn0KCi8qCiAgV2UncmUgdXNpbmcgdGhpcyB0byBkZXRlY3QgYXJyYXlzIGFuZCAiYXJyYXktbGlrZSIgb2JqZWN0cy4KCiAgVGhpcyBpcyBhIGNvcHkgb2YgdGhlIGBpc0FycmF5YCBtZXRob2QgZm91bmQgaW4gYGVtYmVyLXJ1bnRpbWUvdXRpbHNgIGFzIHdlJ3JlCiAgY3VycmVudGx5IHVuYWJsZSB0byBpbXBvcnQgbm9uLWV4cG9zZWQgbW9kdWxlcy4KCiAgVGhpcyBtZXRob2Qgd2FzIHByZXZpb3VzbHkgZXhwb3NlZCBhcyBgRW1iZXIuaXNBcnJheWAgYnV0IHNpbmNlCiAgaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXIuanMvcHVsbC8xMTQ2MyBgRW1iZXIuaXNBcnJheWAgaXMgYW4gYWxpYXMgb2YKICBgQXJyYXkuaXNBcnJheWAgaGVuY2UgcmVtb3ZpbmcgdGhlICJhcnJheS1saWtlIiBwYXJ0LgogKi8KZnVuY3Rpb24gaXNBcnJheUxpa2Uob2JqKSB7CiAgaWYgKCFvYmogfHwgb2JqLnNldEludGVydmFsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoRW1iZXIuQXJyYXkuZGV0ZWN0KG9iaikpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIHR5cGUgPSBFbWJlci50eXBlT2Yob2JqKTsKICBpZiAoJ2FycmF5JyA9PT0gdHlwZSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChvYmoubGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgJ29iamVjdCcgPT09IHR5cGUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8qCiAgQ2hlY2sgaWYgdGhlIHBhc3NlZCBtb2RlbCBoYXMgYSBgdHlwZWAgYXR0cmlidXRlIG9yIGEgcmVsYXRpb25zaGlwIG5hbWVkIGB0eXBlYC4KCiAgQG1ldGhvZCBtb2RlbEhhc0F0dHJpYnV0ZU9yUmVsYXRpb25zaGlwTmFtZWRUeXBlCiAgQHBhcmFtIG1vZGVsQ2xhc3MKICovCmZ1bmN0aW9uIG1vZGVsSGFzQXR0cmlidXRlT3JSZWxhdGlvbnNoaXBOYW1lZFR5cGUobW9kZWxDbGFzcykgewogIHJldHVybiBFbWJlci5nZXQobW9kZWxDbGFzcywgJ2F0dHJpYnV0ZXMnKS5oYXMoJ3R5cGUnKSB8fCBFbWJlci5nZXQobW9kZWxDbGFzcywgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKS5oYXMoJ3R5cGUnKTsKfQoKLyoKICBlbWJlci1jb250YWluZXItaW5qZWN0LW93bmVyIGlzIGEgbmV3IGZlYXR1cmUgaW4gRW1iZXIgMi4zIHRoYXQgZmluYWxseSBwcm92aWRlcyBhIHB1YmxpYwogIEFQSSBmb3IgbG9va2luZyBpdGVtcyB1cC4gIFRoaXMgZnVuY3Rpb24gc2VydmVzIGFzIGEgc3VwZXIgc2ltcGxlIHBvbHlmaWxsIHRvIGF2b2lkCiAgdHJpZ2dlcmluZyBkZXByZWNhdGlvbnMuCiAqLwpmdW5jdGlvbiBnZXRPd25lcihjb250ZXh0KSB7CiAgdmFyIG93bmVyID0gdm9pZCAwOwoKICBpZiAoRW1iZXIuZ2V0T3duZXIpIHsKICAgIG93bmVyID0gRW1iZXIuZ2V0T3duZXIoY29udGV4dCk7CiAgfSBlbHNlIGlmIChjb250ZXh0LmNvbnRhaW5lcikgewogICAgb3duZXIgPSBjb250ZXh0LmNvbnRhaW5lcjsKICB9CgogIGlmIChvd25lciAmJiBvd25lci5sb29rdXBGYWN0b3J5ICYmICFvd25lci5fbG9va3VwRmFjdG9yeSkgewogICAgLy8gYG93bmVyYCBpcyBhIGNvbnRhaW5lciwgd2UgYXJlIGp1c3QgbWFraW5nIHRoaXMgd29yawogICAgb3duZXIuX2xvb2t1cEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBvd25lci5sb29rdXBGYWN0b3J5KC4uLmFyZ3VtZW50cyk7CiAgICB9OwoKICAgIG93bmVyLnJlZ2lzdGVyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgcmVnaXN0cnkgPSBvd25lci5yZWdpc3RyeSB8fCBvd25lci5fcmVnaXN0cnkgfHwgb3duZXI7CgogICAgICByZXR1cm4gcmVnaXN0cnkucmVnaXN0ZXIoLi4uYXJndW1lbnRzKTsKICAgIH07CiAgfQoKICByZXR1cm4gb3duZXI7Cn0KCnZhciBSZWZlcmVuY2UgPSBmdW5jdGlvbiAoc3RvcmUsIGludGVybmFsTW9kZWwpIHsKICB0aGlzLnN0b3JlID0gc3RvcmU7CiAgdGhpcy5pbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbDsKfTsKClJlZmVyZW5jZS5wcm90b3R5cGUgPSB7CiAgY29uc3RydWN0b3I6IFJlZmVyZW5jZQp9OwoKLyoqCiAgIEFuIFJlY29yZFJlZmVyZW5jZSBpcyBhIGxvdyBsZXZlbCBBUEkgdGhhdCBhbGxvd3MgdXNlcnMgYW5kCiAgIGFkZG9uIGF1dGhvciB0byBwZXJmb3JtIG1ldGEtb3BlcmF0aW9ucyBvbiBhIHJlY29yZC4KCiAgIEBjbGFzcyBSZWNvcmRSZWZlcmVuY2UKICAgQG5hbWVzcGFjZSBEUwoqLwpjbGFzcyBSZWNvcmRSZWZlcmVuY2UgZXh0ZW5kcyBSZWZlcmVuY2UgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBpbnRlcm5hbE1vZGVsKSB7CiAgICBzdXBlcihzdG9yZSwgaW50ZXJuYWxNb2RlbCk7CiAgICB0aGlzLnR5cGUgPSBpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZTsKICAgIHRoaXMuX2lkID0gaW50ZXJuYWxNb2RlbC5pZDsKICB9CgogIC8qKgogICAgIFRoZSBgaWRgIG9mIHRoZSByZWNvcmQgdGhhdCB0aGlzIHJlZmVyZW5jZSByZWZlcnMgdG8uCiAgICAgIFRvZ2V0aGVyLCB0aGUgYHR5cGVgIGFuZCBgaWRgIHByb3BlcnRpZXMgZm9ybSBhIGNvbXBvc2l0ZSBrZXkgZm9yCiAgICAgdGhlIGlkZW50aXR5IG1hcC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgdXNlclJlZi5pZCgpOyAvLyAnMScKICAgICBgYGAKICAgICAgQG1ldGhvZCBpZAogICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGlkIG9mIHRoZSByZWNvcmQuCiAgKi8KICBpZCgpIHsKICAgIHJldHVybiB0aGlzLl9pZDsKICB9CgogIC8qKgogICAgIEhvdyB0aGUgcmVmZXJlbmNlIHdpbGwgYmUgbG9va2VkIHVwIHdoZW4gaXQgaXMgbG9hZGVkOiBDdXJyZW50bHkKICAgICB0aGlzIGFsd2F5cyByZXR1cm4gYGlkZW50aXR5YCB0byBzaWduaWZ5aW5nIHRoYXQgYSByZWNvcmQgd2lsbCBiZQogICAgIGxvYWRlZCBieSB0aGUgYHR5cGVgIGFuZCBgaWRgLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBjb25zdCB1c2VyUmVmID0gc3RvcmUuZ2V0UmVmZXJlbmNlKCd1c2VyJywgMSk7CiAgICAgIHVzZXJSZWYucmVtb3RlVHlwZSgpOyAvLyAnaWRlbnRpdHknCiAgICAgYGBgCiAgICAgIEBtZXRob2QgcmVtb3RlVHlwZQogICAgIEByZXR1cm4ge1N0cmluZ30gJ2lkZW50aXR5JwogICovCiAgcmVtb3RlVHlwZSgpIHsKICAgIHJldHVybiAnaWRlbnRpdHknOwogIH0KCiAgLyoqCiAgICBUaGlzIEFQSSBhbGxvd3MgeW91IHRvIHByb3ZpZGUgYSByZWZlcmVuY2Ugd2l0aCBuZXcgZGF0YS4gVGhlCiAgICBzaW1wbGVzdCB1c2FnZSBvZiB0aGlzIEFQSSBpcyBzaW1pbGFyIHRvIGBzdG9yZS5wdXNoYDogeW91IHByb3ZpZGUgYQogICAgbm9ybWFsaXplZCBoYXNoIG9mIGRhdGEgYW5kIHRoZSBvYmplY3QgcmVwcmVzZW50ZWQgYnkgdGhlIHJlZmVyZW5jZQogICAgd2lsbCB1cGRhdGUuCiAgICAgSWYgeW91IHBhc3MgYSBwcm9taXNlIHRvIGBwdXNoYCwgRW1iZXIgRGF0YSB3aWxsIG5vdCBhc2sgdGhlIGFkYXB0ZXIKICAgIGZvciB0aGUgZGF0YSBpZiBhbm90aGVyIGF0dGVtcHQgdG8gZmV0Y2ggaXQgaXMgbWFkZSBpbiB0aGUKICAgIGludGVyaW0uIFdoZW4gdGhlIHByb21pc2UgcmVzb2x2ZXMsIHRoZSB1bmRlcmx5aW5nIG9iamVjdCBpcyB1cGRhdGVkCiAgICB3aXRoIHRoZSBuZXcgZGF0YSwgYW5kIHRoZSBwcm9taXNlIHJldHVybmVkIGJ5ICp0aGlzIGZ1bmN0aW9uKiBpcyByZXNvbHZlZAogICAgd2l0aCB0aGF0IG9iamVjdC4KICAgICBGb3IgZXhhbXBsZSwgYHJlY29yZFJlZmVyZW5jZS5wdXNoKHByb21pc2UpYCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYQogICAgcmVjb3JkLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgdXNlclJlZiA9IHN0b3JlLmdldFJlZmVyZW5jZSgndXNlcicsIDEpOwogICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgIHVzZXJSZWYucHVzaCh7IGRhdGE6IHsgaWQ6IDEsIHVzZXJuYW1lOiAiQHVzZXIiIH19KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgIHVzZXJSZWYudmFsdWUoKSA9PT0gdXNlcjsKICAgICB9KTsKICAgICBgYGAKICAgICBAbWV0aG9kIHB1c2gKICAgIEBwYXJhbSBvYmplY3RPclByb21pc2Uge1Byb21pc2V8T2JqZWN0fQogICAgQHJldHVybiBQcm9taXNlPHJlY29yZD4gYSBwcm9taXNlIGZvciB0aGUgdmFsdWUgKHJlY29yZCBvciByZWxhdGlvbnNoaXApCiAgKi8KICBwdXNoKG9iamVjdE9yUHJvbWlzZSkgewogICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShvYmplY3RPclByb21pc2UpLnRoZW4oZGF0YSA9PiB7CiAgICAgIHJldHVybiB0aGlzLnN0b3JlLnB1c2goZGF0YSk7CiAgICB9KTsKICB9CgogIC8qKgogICAgSWYgdGhlIGVudGl0eSByZWZlcnJlZCB0byBieSB0aGUgcmVmZXJlbmNlIGlzIGFscmVhZHkgbG9hZGVkLCBpdCBpcwogICAgcHJlc2VudCBhcyBgcmVmZXJlbmNlLnZhbHVlYC4gT3RoZXJ3aXNlIHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGlzIGZ1bmN0aW9uCiAgICBpcyBgbnVsbGAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCB1c2VyUmVmID0gc3RvcmUuZ2V0UmVmZXJlbmNlKCd1c2VyJywgMSk7CiAgICAgIHVzZXJSZWYudmFsdWUoKTsgLy8gdXNlcgogICAgIGBgYAogICAgICBAbWV0aG9kIHZhbHVlCiAgICAgQHJldHVybiB7RFMuTW9kZWx9IHRoZSByZWNvcmQgZm9yIHRoaXMgUmVjb3JkUmVmZXJlbmNlCiAgKi8KICB2YWx1ZSgpIHsKICAgIGlmICh0aGlzLmludGVybmFsTW9kZWwuaGFzUmVjb3JkKSB7CiAgICAgIHJldHVybiB0aGlzLmludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAgIFRyaWdnZXJzIGEgZmV0Y2ggZm9yIHRoZSBiYWNraW5nIGVudGl0eSBiYXNlZCBvbiBpdHMgYHJlbW90ZVR5cGVgCiAgICAgKHNlZSBgcmVtb3RlVHlwZWAgZGVmaW5pdGlvbnMgcGVyIHJlZmVyZW5jZSB0eXBlKS4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgLy8gbG9hZCB1c2VyICh2aWEgc3RvcmUuZmluZCkKICAgICB1c2VyUmVmLmxvYWQoKS50aGVuKC4uLikKICAgICBgYGAKICAgICAgQG1ldGhvZCBsb2FkCiAgICAgQHJldHVybiB7UHJvbWlzZTxyZWNvcmQ+fSB0aGUgcmVjb3JkIGZvciB0aGlzIFJlY29yZFJlZmVyZW5jZQogICovCiAgbG9hZCgpIHsKICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRSZWNvcmQodGhpcy50eXBlLCB0aGlzLl9pZCk7CiAgfQoKICAvKioKICAgICBSZWxvYWRzIHRoZSByZWNvcmQgaWYgaXQgaXMgYWxyZWFkeSBsb2FkZWQuIElmIHRoZSByZWNvcmQgaXMgbm90CiAgICAgbG9hZGVkIGl0IHdpbGwgbG9hZCB0aGUgcmVjb3JkIHZpYSBgc3RvcmUuZmluZFJlY29yZGAKICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHVzZXJSZWYgPSBzdG9yZS5nZXRSZWZlcmVuY2UoJ3VzZXInLCAxKTsKICAgICAgLy8gb3IgdHJpZ2dlciBhIHJlbG9hZAogICAgIHVzZXJSZWYucmVsb2FkKCkudGhlbiguLi4pCiAgICAgYGBgCiAgICAgIEBtZXRob2QgcmVsb2FkCiAgICAgQHJldHVybiB7UHJvbWlzZTxyZWNvcmQ+fSB0aGUgcmVjb3JkIGZvciB0aGlzIFJlY29yZFJlZmVyZW5jZQogICovCiAgcmVsb2FkKCkgewogICAgdmFyIHJlY29yZCA9IHRoaXMudmFsdWUoKTsKICAgIGlmIChyZWNvcmQpIHsKICAgICAgcmV0dXJuIHJlY29yZC5yZWxvYWQoKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5sb2FkKCk7CiAgfQoKfQoKLyoqCiAgIEEgQmVsb25nc1RvUmVmZXJlbmNlIGlzIGEgbG93IGxldmVsIEFQSSB0aGF0IGFsbG93cyB1c2VycyBhbmQKICAgYWRkb24gYXV0aG9yIHRvIHBlcmZvcm0gbWV0YS1vcGVyYXRpb25zIG9uIGEgYmVsb25ncy10bwogICByZWxhdGlvbnNoaXAuCgogICBAY2xhc3MgQmVsb25nc1RvUmVmZXJlbmNlCiAgIEBuYW1lc3BhY2UgRFMKICAgQGV4dGVuZHMgRFMuUmVmZXJlbmNlCiovCmNsYXNzIEJlbG9uZ3NUb1JlZmVyZW5jZSBleHRlbmRzIFJlZmVyZW5jZSB7CgogIGNvbnN0cnVjdG9yKHN0b3JlLCBwYXJlbnRJbnRlcm5hbE1vZGVsLCBiZWxvbmdzVG9SZWxhdGlvbnNoaXApIHsKICAgIHN1cGVyKHN0b3JlLCBwYXJlbnRJbnRlcm5hbE1vZGVsKTsKICAgIHRoaXMuYmVsb25nc1RvUmVsYXRpb25zaGlwID0gYmVsb25nc1RvUmVsYXRpb25zaGlwOwogICAgdGhpcy50eXBlID0gYmVsb25nc1RvUmVsYXRpb25zaGlwLnJlbGF0aW9uc2hpcE1ldGEudHlwZTsKICAgIHRoaXMucGFyZW50ID0gcGFyZW50SW50ZXJuYWxNb2RlbC5yZWNvcmRSZWZlcmVuY2U7CiAgICAvLyBUT0RPIGludmVyc2UKICB9CgogIC8qKgogICAgIFRoaXMgcmV0dXJucyBhIHN0cmluZyB0aGF0IHJlcHJlc2VudHMgaG93IHRoZSByZWZlcmVuY2Ugd2lsbCBiZQogICAgIGxvb2tlZCB1cCB3aGVuIGl0IGlzIGxvYWRlZC4gSWYgdGhlIHJlbGF0aW9uc2hpcCBoYXMgYSBsaW5rIGl0IHdpbGwKICAgICB1c2UgdGhlICJsaW5rIiBvdGhlcndpc2UgaXQgZGVmYXVsdHMgdG8gImlkIi4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICBpZDogMSwKICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgIGRhdGE6IHsgdHlwZTogJ3VzZXInLCBpZDogMSB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICAgLy8gZ2V0IHRoZSBpZGVudGlmaWVyIG9mIHRoZSByZWZlcmVuY2UKICAgICAgaWYgKHVzZXJSZWYucmVtb3RlVHlwZSgpID09PSAiaWQiKSB7CiAgICAgICAgbGV0IGlkID0gdXNlclJlZi5pZCgpOwogICAgICB9IGVsc2UgaWYgKHVzZXJSZWYucmVtb3RlVHlwZSgpID09PSAibGluayIpIHsKICAgICAgICBsZXQgbGluayA9IHVzZXJSZWYubGluaygpOwogICAgICB9CiAgICAgIGBgYAogICAgICBAbWV0aG9kIHJlbW90ZVR5cGUKICAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSByZW1vdGUgdHlwZS4gVGhpcyBzaG91bGQgZWl0aGVyIGJlICJsaW5rIiBvciAiaWQiCiAgKi8KICByZW1vdGVUeXBlKCkgewogICAgaWYgKHRoaXMuYmVsb25nc1RvUmVsYXRpb25zaGlwLmxpbmspIHsKICAgICAgcmV0dXJuICJsaW5rIjsKICAgIH0KCiAgICByZXR1cm4gImlkIjsKICB9CgogIC8qKgogICAgIFRoZSBgaWRgIG9mIHRoZSByZWNvcmQgdGhhdCB0aGlzIHJlZmVyZW5jZSByZWZlcnMgdG8uIFRvZ2V0aGVyLCB0aGUKICAgICBgdHlwZSgpYCBhbmQgYGlkKClgIG1ldGhvZHMgZm9ybSBhIGNvbXBvc2l0ZSBrZXkgZm9yIHRoZSBpZGVudGl0eQogICAgIG1hcC4gVGhpcyBjYW4gYmUgdXNlZCB0byBhY2Nlc3MgdGhlIGlkIG9mIGFuIGFzeW5jIHJlbGF0aW9uc2hpcAogICAgIHdpdGhvdXQgdHJpZ2dlcmluZyBhIGZldGNoIHRoYXQgd291bGQgbm9ybWFsbHkgaGFwcGVuIGlmIHlvdQogICAgIGF0dGVtcHRlZCB0byB1c2UgYHJlY29yZC5nZXQoJ3JlbGF0aW9uc2hpcC5pZCcpYC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICAgIGlmICh1c2VyUmVmLnJlbW90ZVR5cGUoKSA9PT0gImlkIikgewogICAgICAgIGxldCBpZCA9IHVzZXJSZWYuaWQoKTsKICAgICAgfQogICAgICBgYGAKICAgICAgQG1ldGhvZCBpZAogICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGlkIG9mIHRoZSByZWNvcmQgaW4gdGhpcyBiZWxvbmdzVG8gcmVsYXRpb25zaGlwLgogICovCiAgaWQoKSB7CiAgICB2YXIgaW52ZXJzZUludGVybmFsTW9kZWwgPSB0aGlzLmJlbG9uZ3NUb1JlbGF0aW9uc2hpcC5pbnZlcnNlSW50ZXJuYWxNb2RlbDsKICAgIHJldHVybiBpbnZlcnNlSW50ZXJuYWxNb2RlbCAmJiBpbnZlcnNlSW50ZXJuYWxNb2RlbC5pZDsKICB9CgogIC8qKgogICAgIFRoZSBsaW5rIEVtYmVyIERhdGEgd2lsbCB1c2UgdG8gZmV0Y2ggb3IgcmVsb2FkIHRoaXMgYmVsb25ncy10bwogICAgIHJlbGF0aW9uc2hpcC4KICAgICAgRXhhbXBsZQogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgbGlua3M6IHsKICAgICAgICAgICAgICAgIHJlbGF0ZWQ6ICcvYXJ0aWNsZXMvMS9hdXRob3InCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbGV0IHVzZXJSZWYgPSBibG9nLmJlbG9uZ3NUbygndXNlcicpOwogICAgICAgLy8gZ2V0IHRoZSBpZGVudGlmaWVyIG9mIHRoZSByZWZlcmVuY2UKICAgICAgaWYgKHVzZXJSZWYucmVtb3RlVHlwZSgpID09PSAibGluayIpIHsKICAgICAgICBsZXQgbGluayA9IHVzZXJSZWYubGluaygpOwogICAgICB9CiAgICAgIGBgYAogICAgICBAbWV0aG9kIGxpbmsKICAgICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBsaW5rIEVtYmVyIERhdGEgd2lsbCB1c2UgdG8gZmV0Y2ggb3IgcmVsb2FkIHRoaXMgYmVsb25ncy10byByZWxhdGlvbnNoaXAuCiAgKi8KICBsaW5rKCkgewogICAgcmV0dXJuIHRoaXMuYmVsb25nc1RvUmVsYXRpb25zaGlwLmxpbms7CiAgfQoKICAvKioKICAgICBUaGUgbWV0YSBkYXRhIGZvciB0aGUgYmVsb25ncy10byByZWxhdGlvbnNoaXAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBtb2RlbHMvYmxvZy5qcwogICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIHVzZXI6IERTLmJlbG9uZ3NUbyh7IGFzeW5jOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGxpbmtzOiB7CiAgICAgICAgICAgICAgICByZWxhdGVkOiB7CiAgICAgICAgICAgICAgICAgIGhyZWY6ICcvYXJ0aWNsZXMvMS9hdXRob3InLAogICAgICAgICAgICAgICAgICBtZXRhOiB7CiAgICAgICAgICAgICAgICAgICAgbGFzdFVwZGF0ZWQ6IDE0NTgwMTQ0MDAwMDAKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgICBsZXQgdXNlclJlZiA9IGJsb2cuYmVsb25nc1RvKCd1c2VyJyk7CiAgICAgICB1c2VyUmVmLm1ldGEoKSAvLyB7IGxhc3RVcGRhdGVkOiAxNDU4MDE0NDAwMDAwIH0KICAgICAgYGBgCiAgICAgIEBtZXRob2QgbWV0YQogICAgIEByZXR1cm4ge09iamVjdH0gVGhlIG1ldGEgaW5mb3JtYXRpb24gZm9yIHRoZSBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcC4KICAqLwogIG1ldGEoKSB7CiAgICByZXR1cm4gdGhpcy5iZWxvbmdzVG9SZWxhdGlvbnNoaXAubWV0YTsKICB9CgogIC8qKgogICAgIGBwdXNoYCBjYW4gYmUgdXNlZCB0byB1cGRhdGUgdGhlIGRhdGEgaW4gdGhlIHJlbGF0aW9uc2hpcCBhbmQgRW1iZXIKICAgICBEYXRhIHdpbGwgdHJlYXQgdGhlIG5ldyBkYXRhIGFzIHRoZSBjb25hbmljYWwgdmFsdWUgb2YgdGhpcwogICAgIHJlbGF0aW9uc2hpcCBvbiB0aGUgYmFja2VuZC4KICAgICAgRXhhbXBsZQogICAgICAgYGBgamF2YXNjcmlwdAogICAgICAvLyBtb2RlbHMvYmxvZy5qcwogICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIHVzZXI6IERTLmJlbG9uZ3NUbyh7IGFzeW5jOiB0cnVlIH0pCiAgICAgIH0pOwogICAgICAgbGV0IGJsb2cgPSBzdG9yZS5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAnYmxvZycsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgdXNlcjogewogICAgICAgICAgICAgIGRhdGE6IHsgdHlwZTogJ3VzZXInLCBpZDogMSB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBsZXQgdXNlclJlZiA9IGJsb2cuYmVsb25nc1RvKCd1c2VyJyk7CiAgICAgICAvLyBwcm92aWRlIGRhdGEgZm9yIHJlZmVyZW5jZQogICAgICB1c2VyUmVmLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICd1c2VyJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICB1c2VybmFtZTogIkB1c2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyOwogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBtZXRob2QgcHVzaAogICAgIEBwYXJhbSB7T2JqZWN0fFByb21pc2V9IG9iamVjdE9yUHJvbWlzZSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIEpTT05BUEkgZG9jdW1lbnQgb2JqZWN0IGRlc2NyaWJpbmcgdGhlIG5ldyB2YWx1ZSBvZiB0aGlzIHJlbGF0aW9uc2hpcC4KICAgICBAcmV0dXJuIHtQcm9taXNlPHJlY29yZD59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggdGhlIG5ldyB2YWx1ZSBpbiB0aGlzIGJlbG9uZ3MtdG8gcmVsYXRpb25zaGlwLgogICovCiAgcHVzaChvYmplY3RPclByb21pc2UpIHsKICAgIHJldHVybiBFbWJlci5SU1ZQLnJlc29sdmUob2JqZWN0T3JQcm9taXNlKS50aGVuKGRhdGEgPT4gewogICAgICB2YXIgcmVjb3JkID0gdm9pZCAwOwoKICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIHJlY29yZCA9IGRhdGE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVjb3JkID0gdGhpcy5zdG9yZS5wdXNoKGRhdGEpOwogICAgICB9CgogICAgICBlbWJlckRhdGFfRGVidWcuYXNzZXJ0UG9seW1vcnBoaWNUeXBlKHRoaXMuaW50ZXJuYWxNb2RlbCwgdGhpcy5iZWxvbmdzVG9SZWxhdGlvbnNoaXAucmVsYXRpb25zaGlwTWV0YSwgcmVjb3JkLl9pbnRlcm5hbE1vZGVsKTsKCiAgICAgIHRoaXMuYmVsb25nc1RvUmVsYXRpb25zaGlwLnNldENhbm9uaWNhbEludGVybmFsTW9kZWwocmVjb3JkLl9pbnRlcm5hbE1vZGVsKTsKCiAgICAgIHJldHVybiByZWNvcmQ7CiAgICB9KTsKICB9CgogIC8qKgogICAgIGB2YWx1ZSgpYCBzeW5jaHJvbm91c2x5IHJldHVybnMgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJlbG9uZ3MtdG8KICAgICByZWxhdGlvbnNoaXAuIFVubGlrZSBgcmVjb3JkLmdldCgncmVsYXRpb25zaGlwTmFtZScpYCwgY2FsbGluZwogICAgIGB2YWx1ZSgpYCBvbiBhIHJlZmVyZW5jZSBkb2VzIG5vdCB0cmlnZ2VyIGEgZmV0Y2ggaWYgdGhlIGFzeW5jCiAgICAgcmVsYXRpb25zaGlwIGlzIG5vdCB5ZXQgbG9hZGVkLiBJZiB0aGUgcmVsYXRpb25zaGlwIGlzIG5vdCBsb2FkZWQKICAgICBpdCB3aWxsIGFsd2F5cyByZXR1cm4gYG51bGxgLgogICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgIHVzZXJSZWYudmFsdWUoKTsgLy8gbnVsbAogICAgICAgLy8gcHJvdmlkZSBkYXRhIGZvciByZWZlcmVuY2UKICAgICAgdXNlclJlZi5wdXNoKHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICB0eXBlOiAndXNlcicsCiAgICAgICAgICBpZDogMSwKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgdXNlcm5hbWU6ICJAdXNlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24odXNlcikgewogICAgICAgIHVzZXJSZWYudmFsdWUoKTsgLy8gdXNlcgogICAgICB9KTsKICAgICAgYGBgCiAgICAgIEBtZXRob2QgdmFsdWUKICAgICBAcmV0dXJuIHtEUy5Nb2RlbH0gdGhlIHJlY29yZCBpbiB0aGlzIHJlbGF0aW9uc2hpcAogICovCiAgdmFsdWUoKSB7CiAgICB2YXIgaW52ZXJzZUludGVybmFsTW9kZWwgPSB0aGlzLmJlbG9uZ3NUb1JlbGF0aW9uc2hpcC5pbnZlcnNlSW50ZXJuYWxNb2RlbDsKCiAgICBpZiAoaW52ZXJzZUludGVybmFsTW9kZWwgJiYgaW52ZXJzZUludGVybmFsTW9kZWwuaXNMb2FkZWQoKSkgewogICAgICByZXR1cm4gaW52ZXJzZUludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCk7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvKioKICAgICBMb2FkcyBhIHJlY29yZCBpbiBhIGJlbG9uZ3MgdG8gcmVsYXRpb25zaGlwIGlmIGl0IGlzIG5vdCBhbHJlYWR5CiAgICAgbG9hZGVkLiBJZiB0aGUgcmVsYXRpb25zaGlwIGlzIGFscmVhZHkgbG9hZGVkIHRoaXMgbWV0aG9kIGRvZXMgbm90CiAgICAgdHJpZ2dlciBhIG5ldyBsb2FkLgogICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgIHVzZXJSZWYudmFsdWUoKTsgLy8gbnVsbAogICAgICAgdXNlclJlZi5sb2FkKCkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgQG1ldGhvZCBsb2FkCiAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgcmVjb3JkIGluIHRoaXMgYmVsb25ncy10byByZWxhdGlvbnNoaXAuCiAgKi8KICBsb2FkKCkgewogICAgdmFyIHJlbCA9IHRoaXMuYmVsb25nc1RvUmVsYXRpb25zaGlwOwoKICAgIHJlbC5nZXREYXRhKCk7CgogICAgaWYgKHJlbC5mZXRjaFByb21pc2UgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIHJlbC5mZXRjaFByb21pc2UudGhlbigoKSA9PiB7CiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWUoKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZSh0aGlzLnZhbHVlKCkpOwogIH0KCiAgLyoqCiAgICAgVHJpZ2dlcnMgYSByZWxvYWQgb2YgdGhlIHZhbHVlIGluIHRoaXMgcmVsYXRpb25zaGlwLiBJZiB0aGUKICAgICByZW1vdGVUeXBlIGlzIGAibGluayJgIEVtYmVyIERhdGEgd2lsbCB1c2UgdGhlIHJlbGF0aW9uc2hpcCBsaW5rIHRvCiAgICAgcmVsb2FkIHRoZSByZWxhdGlvbnNoaXAuIE90aGVyd2lzZSBpdCB3aWxsIHJlbG9hZCB0aGUgcmVjb3JkIGJ5IGl0cwogICAgIGlkLgogICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIC8vIG1vZGVscy9ibG9nLmpzCiAgICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgdXNlcjogRFMuYmVsb25nc1RvKHsgYXN5bmM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBsZXQgYmxvZyA9IHN0b3JlLnB1c2goewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHR5cGU6ICdibG9nJywKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgICAgZGF0YTogeyB0eXBlOiAndXNlcicsIGlkOiAxIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGxldCB1c2VyUmVmID0gYmxvZy5iZWxvbmdzVG8oJ3VzZXInKTsKICAgICAgIHVzZXJSZWYucmVsb2FkKCkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgQG1ldGhvZCByZWxvYWQKICAgICBAcmV0dXJuIHtQcm9taXNlfSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSByZWNvcmQgaW4gdGhpcyBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcCBhZnRlciB0aGUgcmVsb2FkIGhhcyBjb21wbGV0ZWQuCiAgKi8KICByZWxvYWQoKSB7CiAgICByZXR1cm4gdGhpcy5iZWxvbmdzVG9SZWxhdGlvbnNoaXAucmVsb2FkKCkudGhlbihpbnRlcm5hbE1vZGVsID0+IHsKICAgICAgcmV0dXJuIHRoaXMudmFsdWUoKTsKICAgIH0pOwogIH0KCn0KCi8qKgogICBBIEhhc01hbnlSZWZlcmVuY2UgaXMgYSBsb3cgbGV2ZWwgQVBJIHRoYXQgYWxsb3dzIHVzZXJzIGFuZCBhZGRvbgogICBhdXRob3IgdG8gcGVyZm9ybSBtZXRhLW9wZXJhdGlvbnMgb24gYSBoYXMtbWFueSByZWxhdGlvbnNoaXAuCgogICBAY2xhc3MgSGFzTWFueVJlZmVyZW5jZQogICBAbmFtZXNwYWNlIERTCiovCmNsYXNzIEhhc01hbnlSZWZlcmVuY2UgZXh0ZW5kcyBSZWZlcmVuY2UgewogIGNvbnN0cnVjdG9yKHN0b3JlLCBwYXJlbnRJbnRlcm5hbE1vZGVsLCBoYXNNYW55UmVsYXRpb25zaGlwKSB7CiAgICBzdXBlcihzdG9yZSwgcGFyZW50SW50ZXJuYWxNb2RlbCk7CiAgICB0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAgPSBoYXNNYW55UmVsYXRpb25zaGlwOwogICAgdGhpcy50eXBlID0gaGFzTWFueVJlbGF0aW9uc2hpcC5yZWxhdGlvbnNoaXBNZXRhLnR5cGU7CiAgICB0aGlzLnBhcmVudCA9IHBhcmVudEludGVybmFsTW9kZWwucmVjb3JkUmVmZXJlbmNlOwogICAgLy8gVE9ETyBpbnZlcnNlCiAgfQoKICAvKioKICAgICBUaGlzIHJldHVybnMgYSBzdHJpbmcgdGhhdCByZXByZXNlbnRzIGhvdyB0aGUgcmVmZXJlbmNlIHdpbGwgYmUKICAgICBsb29rZWQgdXAgd2hlbiBpdCBpcyBsb2FkZWQuIElmIHRoZSByZWxhdGlvbnNoaXAgaGFzIGEgbGluayBpdCB3aWxsCiAgICAgdXNlIHRoZSAibGluayIgb3RoZXJ3aXNlIGl0IGRlZmF1bHRzIHRvICJpZCIuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBwb3N0ID0gc3RvcmUucHVzaCh7CiAgICAgICBkYXRhOiB7CiAgICAgICAgIHR5cGU6ICdwb3N0JywKICAgICAgICAgaWQ6IDEsCiAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICBjb21tZW50czogewogICAgICAgICAgICAgZGF0YTogW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMSB9XQogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgICBsZXQgY29tbWVudHNSZWYgPSBwb3N0Lmhhc01hbnkoJ2NvbW1lbnRzJyk7CiAgICAgIC8vIGdldCB0aGUgaWRlbnRpZmllciBvZiB0aGUgcmVmZXJlbmNlCiAgICAgaWYgKGNvbW1lbnRzUmVmLnJlbW90ZVR5cGUoKSA9PT0gImlkcyIpIHsKICAgICAgIGxldCBpZHMgPSBjb21tZW50c1JlZi5pZHMoKTsKICAgICB9IGVsc2UgaWYgKGNvbW1lbnRzUmVmLnJlbW90ZVR5cGUoKSA9PT0gImxpbmsiKSB7CiAgICAgICBsZXQgbGluayA9IGNvbW1lbnRzUmVmLmxpbmsoKTsKICAgICB9CiAgICAgYGBgCiAgICAgIEBtZXRob2QgcmVtb3RlVHlwZQogICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIHJlbW90ZSB0eXBlLiBUaGlzIHNob3VsZCBlaXRoZXIgYmUgImxpbmsiIG9yICJpZHMiCiAgKi8KICByZW1vdGVUeXBlKCkgewogICAgaWYgKHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5saW5rKSB7CiAgICAgIHJldHVybiAibGluayI7CiAgICB9CgogICAgcmV0dXJuICJpZHMiOwogIH0KCiAgLyoqCiAgICAgVGhlIGxpbmsgRW1iZXIgRGF0YSB3aWxsIHVzZSB0byBmZXRjaCBvciByZWxvYWQgdGhpcyBoYXMtbWFueQogICAgIHJlbGF0aW9uc2hpcC4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgY29tbWVudHM6IERTLmhhc01hbnkoeyBhc3luYzogdHJ1ZSB9KQogICAgIH0pOwogICAgIGBgYAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHBvc3QgPSBzdG9yZS5wdXNoKHsKICAgICAgIGRhdGE6IHsKICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICBpZDogMSwKICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgIGNvbW1lbnRzOiB7CiAgICAgICAgICAgICBsaW5rczogewogICAgICAgICAgICAgICByZWxhdGVkOiAnL3Bvc3RzLzEvY29tbWVudHMnCiAgICAgICAgICAgICB9CiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgfSk7CiAgICAgIGxldCBjb21tZW50c1JlZiA9IHBvc3QuaGFzTWFueSgnY29tbWVudHMnKTsKICAgICAgY29tbWVudHNSZWYubGluaygpOyAvLyAnL3Bvc3RzLzEvY29tbWVudHMnCiAgICAgYGBgCiAgICAgIEBtZXRob2QgbGluawogICAgIEByZXR1cm4ge1N0cmluZ30gVGhlIGxpbmsgRW1iZXIgRGF0YSB3aWxsIHVzZSB0byBmZXRjaCBvciByZWxvYWQgdGhpcyBoYXMtbWFueSByZWxhdGlvbnNoaXAuCiAgKi8KICBsaW5rKCkgewogICAgcmV0dXJuIHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5saW5rOwogIH0KCiAgLyoqCiAgICAgYGlkcygpYCByZXR1cm5zIGFuIGFycmF5IG9mIHRoZSByZWNvcmQgaWRzIGluIHRoaXMgcmVsYXRpb25zaGlwLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogRFMuaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICBjb21tZW50c1JlZi5pZHMoKTsgLy8gWycxJ10KICAgICBgYGAKICAgICAgQG1ldGhvZCBpZHMKICAgICBAcmV0dXJuIHtBcnJheX0gVGhlIGlkcyBpbiB0aGlzIGhhcy1tYW55IHJlbGF0aW9uc2hpcAogICovCiAgaWRzKCkgewogICAgdmFyIG1lbWJlcnMgPSB0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAubWVtYmVycy50b0FycmF5KCk7CgogICAgcmV0dXJuIG1lbWJlcnMubWFwKGZ1bmN0aW9uIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmlkOwogICAgfSk7CiAgfQoKICAvKioKICAgICBUaGUgbWV0YSBkYXRhIGZvciB0aGUgaGFzLW1hbnkgcmVsYXRpb25zaGlwLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogRFMuaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGxpbmtzOiB7CiAgICAgICAgICAgICAgIHJlbGF0ZWQ6IHsKICAgICAgICAgICAgICAgICBocmVmOiAnL3Bvc3RzLzEvY29tbWVudHMnLAogICAgICAgICAgICAgICAgIG1ldGE6IHsKICAgICAgICAgICAgICAgICAgIGNvdW50OiAxMAogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgICBsZXQgY29tbWVudHNSZWYgPSBwb3N0Lmhhc01hbnkoJ2NvbW1lbnRzJyk7CiAgICAgIGNvbW1lbnRzUmVmLm1ldGEoKTsgLy8geyBjb3VudDogMTAgfQogICAgIGBgYAogICAgICBAbWV0aG9kIG1ldGEKICAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBtZXRhIGluZm9ybWF0aW9uIGZvciB0aGUgaGFzLW1hbnkgcmVsYXRpb25zaGlwLgogICovCiAgbWV0YSgpIHsKICAgIHJldHVybiB0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAubWV0YTsKICB9CgogIC8qKgogICAgIGBwdXNoYCBjYW4gYmUgdXNlZCB0byB1cGRhdGUgdGhlIGRhdGEgaW4gdGhlIHJlbGF0aW9uc2hpcCBhbmQgRW1iZXIKICAgICBEYXRhIHdpbGwgdHJlYXQgdGhlIG5ldyBkYXRhIGFzIHRoZSBjYW5vbmljYWwgdmFsdWUgb2YgdGhpcwogICAgIHJlbGF0aW9uc2hpcCBvbiB0aGUgYmFja2VuZC4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgY29tbWVudHM6IERTLmhhc01hbnkoeyBhc3luYzogdHJ1ZSB9KQogICAgIH0pOwogICAgIGBgYAogICAgICBgYGAKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICBjb21tZW50c1JlZi5pZHMoKTsgLy8gWycxJ10KICAgICAgY29tbWVudHNSZWYucHVzaChbCiAgICAgICBbeyB0eXBlOiAnY29tbWVudCcsIGlkOiAyIH1dLAogICAgICAgW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMyB9XSwKICAgICBdKQogICAgICBjb21tZW50c1JlZi5pZHMoKTsgLy8gWycyJywgJzMnXQogICAgIGBgYAogICAgICBAbWV0aG9kIHB1c2gKICAgICBAcGFyYW0ge0FycmF5fFByb21pc2V9IG9iamVjdE9yUHJvbWlzZSBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIEpTT05BUEkgZG9jdW1lbnQgb2JqZWN0IGRlc2NyaWJpbmcgdGhlIG5ldyB2YWx1ZSBvZiB0aGlzIHJlbGF0aW9uc2hpcC4KICAgICBAcmV0dXJuIHtEUy5NYW55QXJyYXl9CiAgKi8KICBwdXNoKG9iamVjdE9yUHJvbWlzZSkgewogICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZShvYmplY3RPclByb21pc2UpLnRoZW4ocGF5bG9hZCA9PiB7CiAgICAgIHZhciBhcnJheSA9IHBheWxvYWQ7CgogICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICJvYmplY3QiICYmIHBheWxvYWQuZGF0YSkgewogICAgICAgIGFycmF5ID0gcGF5bG9hZC5kYXRhOwogICAgICB9CgogICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSB2b2lkIDA7CiAgICAgIGludGVybmFsTW9kZWxzID0gYXJyYXkubWFwKG9iaiA9PiB7CiAgICAgICAgdmFyIHJlY29yZCA9IHRoaXMuc3RvcmUucHVzaChvYmopOwoKICAgICAgICB7CiAgICAgICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5yZWxhdGlvbnNoaXBNZXRhOwogICAgICAgICAgZW1iZXJEYXRhX0RlYnVnLmFzc2VydFBvbHltb3JwaGljVHlwZSh0aGlzLmludGVybmFsTW9kZWwsIHJlbGF0aW9uc2hpcE1ldGEsIHJlY29yZC5faW50ZXJuYWxNb2RlbCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVjb3JkLl9pbnRlcm5hbE1vZGVsOwogICAgICB9KTsKCiAgICAgIHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5jb21wdXRlQ2hhbmdlcyhpbnRlcm5hbE1vZGVscyk7CgogICAgICByZXR1cm4gdGhpcy5oYXNNYW55UmVsYXRpb25zaGlwLm1hbnlBcnJheTsKICAgIH0pOwogIH0KCiAgX2lzTG9hZGVkKCkgewogICAgdmFyIGhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSA9IEVtYmVyLmdldCh0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAsICdoYXNBbnlSZWxhdGlvbnNoaXBEYXRhJyk7CiAgICBpZiAoIWhhc1JlbGF0aW9uc2hpcERhdGFQcm9wZXJ0eSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIG1lbWJlcnMgPSB0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAubWVtYmVycy50b0FycmF5KCk7CgogICAgcmV0dXJuIG1lbWJlcnMuZXZlcnkoZnVuY3Rpb24gKGludGVybmFsTW9kZWwpIHsKICAgICAgcmV0dXJuIGludGVybmFsTW9kZWwuaXNMb2FkZWQoKSA9PT0gdHJ1ZTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICAgYHZhbHVlKClgIHN5bmNocm9ub3VzbHkgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgaGFzLW1hbnkKICAgICAgcmVsYXRpb25zaGlwLiBVbmxpa2UgYHJlY29yZC5nZXQoJ3JlbGF0aW9uc2hpcE5hbWUnKWAsIGNhbGxpbmcKICAgICAgYHZhbHVlKClgIG9uIGEgcmVmZXJlbmNlIGRvZXMgbm90IHRyaWdnZXIgYSBmZXRjaCBpZiB0aGUgYXN5bmMKICAgICAgcmVsYXRpb25zaGlwIGlzIG5vdCB5ZXQgbG9hZGVkLiBJZiB0aGUgcmVsYXRpb25zaGlwIGlzIG5vdCBsb2FkZWQKICAgICAgaXQgd2lsbCBhbHdheXMgcmV0dXJuIGBudWxsYC4KICAgICAgRXhhbXBsZQogICAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgY29tbWVudHM6IERTLmhhc01hbnkoeyBhc3luYzogdHJ1ZSB9KQogICAgIH0pOwogICAgIGBgYAogICAgICBgYGBqYXZhc2NyaXB0CiAgICAgbGV0IHBvc3QgPSBzdG9yZS5wdXNoKHsKICAgICAgIGRhdGE6IHsKICAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgICBpZDogMSwKICAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgIGNvbW1lbnRzOiB7CiAgICAgICAgICAgICBkYXRhOiBbeyB0eXBlOiAnY29tbWVudCcsIGlkOiAxIH1dCiAgICAgICAgICAgfQogICAgICAgICB9CiAgICAgICB9CiAgICAgfSk7CiAgICAgIGxldCBjb21tZW50c1JlZiA9IHBvc3QuaGFzTWFueSgnY29tbWVudHMnKTsKICAgICAgcG9zdC5nZXQoJ2NvbW1lbnRzJykudGhlbihmdW5jdGlvbihjb21tZW50cykgewogICAgICAgY29tbWVudHNSZWYudmFsdWUoKSA9PT0gY29tbWVudHMKICAgICB9KQogICAgIGBgYAogICAgICBAbWV0aG9kIHZhbHVlCiAgICAgQHJldHVybiB7RFMuTWFueUFycmF5fQogICovCiAgdmFsdWUoKSB7CiAgICBpZiAodGhpcy5faXNMb2FkZWQoKSkgewogICAgICByZXR1cm4gdGhpcy5oYXNNYW55UmVsYXRpb25zaGlwLm1hbnlBcnJheTsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAgIExvYWRzIHRoZSByZWxhdGlvbnNoaXAgaWYgaXQgaXMgbm90IGFscmVhZHkgbG9hZGVkLiAgSWYgdGhlCiAgICAgcmVsYXRpb25zaGlwIGlzIGFscmVhZHkgbG9hZGVkIHRoaXMgbWV0aG9kIGRvZXMgbm90IHRyaWdnZXIgYSBuZXcKICAgICBsb2FkLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICBjb21tZW50czogRFMuaGFzTWFueSh7IGFzeW5jOiB0cnVlIH0pCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIGBgYGphdmFzY3JpcHQKICAgICBsZXQgcG9zdCA9IHN0b3JlLnB1c2goewogICAgICAgZGF0YTogewogICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgIGlkOiAxLAogICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgIGRhdGE6IFt7IHR5cGU6ICdjb21tZW50JywgaWQ6IDEgfV0KICAgICAgICAgICB9CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICAgbGV0IGNvbW1lbnRzUmVmID0gcG9zdC5oYXNNYW55KCdjb21tZW50cycpOwogICAgICBjb21tZW50c1JlZi5sb2FkKCkudGhlbihmdW5jdGlvbihjb21tZW50cykgewogICAgICAgLy8uLi4KICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCBsb2FkCiAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgTWFueUFycmF5IGluCiAgICAgdGhpcyBoYXMtbWFueSByZWxhdGlvbnNoaXAuCiAgKi8KICBsb2FkKCkgewogICAgLy8gVE9ETyB0aGlzIGNhbiBiZSBzaW1wbGlmaWVkCiAgICBpZiAoIXRoaXMuX2lzTG9hZGVkKCkpIHsKICAgICAgcmV0dXJuIHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5nZXREYXRhKCk7CiAgICB9CgogICAgcmV0dXJuIEVtYmVyLlJTVlAucmVzb2x2ZSh0aGlzLmhhc01hbnlSZWxhdGlvbnNoaXAubWFueUFycmF5KTsKICB9CgogIC8qKgogICAgIFJlbG9hZHMgdGhpcyBoYXMtbWFueSByZWxhdGlvbnNoaXAuCiAgICAgIEV4YW1wbGUKICAgICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KHsgYXN5bmM6IHRydWUgfSkKICAgICB9KTsKICAgICBgYGAKICAgICAgYGBgamF2YXNjcmlwdAogICAgIGxldCBwb3N0ID0gc3RvcmUucHVzaCh7CiAgICAgICBkYXRhOiB7CiAgICAgICAgIHR5cGU6ICdwb3N0JywKICAgICAgICAgaWQ6IDEsCiAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICBjb21tZW50czogewogICAgICAgICAgICAgZGF0YTogW3sgdHlwZTogJ2NvbW1lbnQnLCBpZDogMSB9XQogICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgfQogICAgIH0pOwogICAgICBsZXQgY29tbWVudHNSZWYgPSBwb3N0Lmhhc01hbnkoJ2NvbW1lbnRzJyk7CiAgICAgIGNvbW1lbnRzUmVmLnJlbG9hZCgpLnRoZW4oZnVuY3Rpb24oY29tbWVudHMpIHsKICAgICAgIC8vLi4uCiAgICAgfSk7CiAgICAgYGBgCiAgICAgIEBtZXRob2QgcmVsb2FkCiAgICAgQHJldHVybiB7UHJvbWlzZX0gYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCB0aGUgTWFueUFycmF5IGluIHRoaXMgaGFzLW1hbnkgcmVsYXRpb25zaGlwLgogICovCiAgcmVsb2FkKCkgewogICAgcmV0dXJuIHRoaXMuaGFzTWFueVJlbGF0aW9uc2hpcC5yZWxvYWQoKTsKICB9Cgp9CgovKgogIFRoZSBUcmFuc2l0aW9uQ2hhaW5NYXAgY2FjaGVzIHRoZSBgc3RhdGUuZW50ZXJzYCwgYHN0YXRlLnNldHVwc2AsIGFuZCBmaW5hbCBzdGF0ZSByZWFjaGVkCiAgd2hlbiB0cmFuc2l0aW9uaW5nIGZyb20gb25lIHN0YXRlIHRvIGFub3RoZXIsIHNvIHRoYXQgZnV0dXJlIHRyYW5zaXRpb25zIGNhbiByZXBsYXkgdGhlCiAgdHJhbnNpdGlvbiB3aXRob3V0IG5lZWRpbmcgdG8gd2FsayB0aGUgc3RhdGUgdHJlZSwgY29sbGVjdCB0aGVzZSBob29rIGNhbGxzIGFuZCBkZXRlcm1pbmUKICAgdGhlIHN0YXRlIHRvIHRyYW5zaXRpb24gaW50by4KCiAgIEEgZnV0dXJlIG9wdGltaXphdGlvbiB3b3VsZCBiZSB0byBidWlsZCBhIHNpbmdsZSBjaGFpbmVkIG1ldGhvZCBvdXQgb2YgdGhlIGNvbGxlY3RlZCBlbnRlcnMKICAgYW5kIHNldHVwcy4gSXQgbWF5IGFsc28gYmUgZmFzdGVyIHRvIGRvIGEgdHdvIGxldmVsIGNhY2hlIChmcm9tOiB7IHRvIH0pIGluc3RlYWQgb2YgY2FjaGluZyBiYXNlZAogICBvbiBhIGtleSB0aGF0IGFkZHMgdGhlIHR3byB0b2dldGhlci4KICovCnZhciBUcmFuc2l0aW9uQ2hhaW5NYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKdmFyIF9leHRyYWN0UGl2b3ROYW1lQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwp2YXIgX3NwbGl0T25Eb3RDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgpmdW5jdGlvbiBzcGxpdE9uRG90KG5hbWUpIHsKICByZXR1cm4gX3NwbGl0T25Eb3RDYWNoZVtuYW1lXSB8fCAoX3NwbGl0T25Eb3RDYWNoZVtuYW1lXSA9IG5hbWUuc3BsaXQoJy4nKSk7Cn0KCmZ1bmN0aW9uIGV4dHJhY3RQaXZvdE5hbWUobmFtZSkgewogIHJldHVybiBfZXh0cmFjdFBpdm90TmFtZUNhY2hlW25hbWVdIHx8IChfZXh0cmFjdFBpdm90TmFtZUNhY2hlW25hbWVdID0gc3BsaXRPbkRvdChuYW1lKVswXSk7Cn0KCmZ1bmN0aW9uIGFyZUFsbE1vZGVsc1VubG9hZGVkKGludGVybmFsTW9kZWxzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7ICsraSkgewogICAgdmFyIHJlY29yZCA9IGludGVybmFsTW9kZWxzW2ldLl9yZWNvcmQ7CiAgICBpZiAocmVjb3JkICYmICEocmVjb3JkLmdldCgnaXNEZXN0cm95ZWQnKSB8fCByZWNvcmQuZ2V0KCdpc0Rlc3Ryb3lpbmcnKSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQoKLy8gSGFuZGxlIGRlbWF0ZXJpYWxpemF0aW9uIGZvciByZWxhdGlvbnNoaXAgYHJlbGAuICBJbiBhbGwgY2FzZXMsIG5vdGlmeSB0aGUKLy8gcmVsYXRpbm9zaGlwIG9mIHRoZSBkZW1hdGVyaWFsaXphdGlvbjogdGhpcyBpcyBkb25lIHNvIHRoZSByZWxhdGlvbnNoaXAgY2FuCi8vIG5vdGlmeSBpdHMgaW52ZXJzZSB3aGljaCBuZWVkcyB0byB1cGRhdGUgc3RhdGUKLy8KLy8gSWYgdGhlIGludmVyc2UgaXMgc3luYywgdW5sb2FkaW5nIHRoaXMgcmVjb3JkIGlzIHRyZWF0ZWQgYXMgYSBjbGllbnQtc2lkZQovLyBkZWxldGUsIHNvIHdlIHJlbW92ZSB0aGUgaW52ZXJzZSByZWNvcmRzIGZyb20gdGhpcyByZWxhdGlvbnNoaXAgdG8KLy8gZGlzY29ubmVjdCB0aGUgZ3JhcGguICBCZWNhdXNlIGl0J3Mgbm90IGFzeW5jLCB3ZSBkb24ndCBuZWVkIHRvIGtlZXAgYXJvdW5kCi8vIHRoZSBpbnRlcm5hbE1vZGVsIGFzIGFuIGlkLXdyYXBwZXIgZm9yIHJlZmVyZW5jZXMgYW5kIGJlY2F1c2UgdGhlIGdyYXBoIGlzCi8vIGRpc2Nvbm5lY3RlZCB3ZSBjYW4gYWN0dWFsbHkgZGVzdHJveSB0aGUgaW50ZXJuYWxNb2RlbCB3aGVuIGNoZWNraW5nIGZvcgovLyBvcnBoYW5lZCBtb2RlbHMuCmZ1bmN0aW9uIGRlc3Ryb3lSZWxhdGlvbnNoaXAocmVsKSB7CiAgcmVsLmludGVybmFsTW9kZWxEaWREZW1hdGVyaWFsaXplKCk7CgogIGlmIChyZWwuX2ludmVyc2VJc1N5bmMoKSkgewogICAgLy8gZGlzY29ubmVjdCB0aGUgZ3JhcGggc28gdGhhdCB0aGUgc3luYyBpbnZlcnNlIHJlbGF0aW9uc2hpcCBkb2VzIG5vdAogICAgLy8gcHJldmVudCB1cyBmcm9tIGNsZWFuaW5nIHVwIGR1cmluZyBgX2NsZWFudXBPcnBoYW5lZEludGVybmFsTW9kZWxzYAogICAgcmVsLnJlbW92ZUFsbEludGVybmFsTW9kZWxzRnJvbU93bigpOwogICAgcmVsLnJlbW92ZUFsbENhbm9uaWNhbEludGVybmFsTW9kZWxzRnJvbU93bigpOwogIH0KfQovLyB0aGlzIChhbmQgYWxsIGhlaW1kYWxsIGluc3RydW1lbnRhdGlvbikgd2lsbCBiZSBzdHJpcHBlZCBieSBhIGJhYmVsIHRyYW5zZm9ybQovLyAgaHR0cHM6Ly9naXRodWIuY29tL2hlaW1kYWxsanMvYmFiZWw1LXBsdWdpbi1zdHJpcC1oZWltZGFsbAoKCnZhciBJbnRlcm5hbE1vZGVsUmVmZXJlbmNlSWQgPSAxOwp2YXIgbmV4dEJmc0lkID0gMTsKCi8qCiAgYEludGVybmFsTW9kZWxgIGlzIHRoZSBNb2RlbCBjbGFzcyB0aGF0IHdlIHVzZSBpbnRlcm5hbGx5IGluc2lkZSBFbWJlciBEYXRhIHRvIHJlcHJlc2VudCBtb2RlbHMuCiAgSW50ZXJuYWwgRUQgbWV0aG9kcyBzaG91bGQgb25seSBkZWFsIHdpdGggYEludGVybmFsTW9kZWxgIG9iamVjdHMuIEl0IGlzIGEgZmFzdCwgcGxhaW4gSmF2YXNjcmlwdCBjbGFzcy4KCiAgV2UgZXhwb3NlIGBEUy5Nb2RlbGAgdG8gYXBwbGljYXRpb24gY29kZSwgYnkgbWF0ZXJpYWxpemluZyBhIGBEUy5Nb2RlbGAgZnJvbSBgSW50ZXJuYWxNb2RlbGAgbGF6aWx5LCBhcwogIGEgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uLgoKICBgSW50ZXJuYWxNb2RlbGAgc2hvdWxkIG5ldmVyIGJlIGV4cG9zZWQgdG8gYXBwbGljYXRpb24gY29kZS4gQXQgdGhlIGJvdW5kYXJpZXMgb2YgdGhlIHN5c3RlbSwgaW4gcGxhY2VzCiAgbGlrZSBgZmluZGAsIGBwdXNoYCwgZXRjLiB3ZSBjb252ZXJ0IGJldHdlZW4gTW9kZWxzIGFuZCBJbnRlcm5hbE1vZGVscy4KCiAgV2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCB0aGUgcHJvcGVydGllcyBmcm9tIGBJbnRlcm5hbE1vZGVsYCBhcmUgY29ycmVjdGx5IGV4cG9zZWQvcHJveGllZCBvbiBgTW9kZWxgCiAgaWYgdGhleSBhcmUgbmVlZGVkLgoKICBAcHJpdmF0ZQogIEBjbGFzcyBJbnRlcm5hbE1vZGVsCiovCmNsYXNzIEludGVybmFsTW9kZWwgewogIGNvbnN0cnVjdG9yKG1vZGVsTmFtZSwgaWQsIHN0b3JlLCBkYXRhKSB7CiAgICB0aGlzLmlkID0gaWQ7CgogICAgLy8gdGhpcyBlbnN1cmUgb3JkZXJlZCBzZXQgY2FuIHF1aWNrbHkgaWRlbnRpZnkgdGhpcyBhcyB1bmlxdWUKICAgIHRoaXNbRW1iZXIuR1VJRF9LRVldID0gSW50ZXJuYWxNb2RlbFJlZmVyZW5jZUlkKysgKyAnaW50ZXJuYWwtbW9kZWwnOwoKICAgIHRoaXMuc3RvcmUgPSBzdG9yZTsKICAgIHRoaXMubW9kZWxOYW1lID0gbW9kZWxOYW1lOwogICAgdGhpcy5fcHJvbWlzZVByb3h5ID0gbnVsbDsKICAgIHRoaXMuX3JlY29yZCA9IG51bGw7CiAgICB0aGlzLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogICAgdGhpcy5pc0Vycm9yID0gZmFsc2U7CiAgICB0aGlzLl9pc1VwZGF0aW5nUmVjb3JkQXJyYXlzID0gZmFsc2U7IC8vIHVzZWQgYnkgdGhlIHJlY29yZEFycmF5TWFuYWdlcgoKICAgIC8vIER1cmluZyBkZW1hdGVyaWFsaXphdGlvbiB3ZSBkb24ndCB3YW50IHRvIHJlbWF0ZXJpYWxpemUgdGhlIHJlY29yZC4gIFRoZQogICAgLy8gcmVhc29uIHRoaXMgbWlnaHQgaGFwcGVuIGlzIHRoYXQgZGVtYXRlcmlhbGl6YXRpb24gcmVtb3ZlcyByZWNvcmRzIGZyb20KICAgIC8vIHJlY29yZCBhcnJheXMsICBhbmQgRW1iZXIgYXJyYXlzIHdpbGwgYWx3YXlzIGBvYmplY3RBdCgwKWAgYW5kCiAgICAvLyBgb2JqZWN0QXQobGVuIC0gMSlgIHRvIHRlc3Qgd2hldGhlciBvciBub3QgYGZpcnN0T2JqZWN0YCBvciBgbGFzdE9iamVjdGAKICAgIC8vIGhhdmUgY2hhbmdlZC4KICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gZmFsc2U7CiAgICB0aGlzLl9zY2hlZHVsZWREZXN0cm95ID0gbnVsbDsKCiAgICB0aGlzLnJlc2V0UmVjb3JkKCk7CgogICAgaWYgKGRhdGEpIHsKICAgICAgdGhpcy5fX2RhdGEgPSBkYXRhOwogICAgfQoKICAgIC8vIGNhY2hlcyBmb3IgbGF6eSBnZXR0ZXJzCiAgICB0aGlzLl9tb2RlbENsYXNzID0gbnVsbDsKICAgIHRoaXMuX19kZWZlcnJlZFRyaWdnZXJzID0gbnVsbDsKICAgIHRoaXMuX19yZWNvcmRBcnJheXMgPSBudWxsOwogICAgdGhpcy5fcmVmZXJlbmNlcyA9IG51bGw7CiAgICB0aGlzLl9yZWNvcmRSZWZlcmVuY2UgPSBudWxsOwogICAgdGhpcy5fX3JlbGF0aW9uc2hpcHMgPSBudWxsOwogICAgdGhpcy5fX2ltcGxpY2l0UmVsYXRpb25zaGlwcyA9IG51bGw7CgogICAgLy8gVXNlZCBkdXJpbmcgdGhlIG1hcmsgcGhhc2Ugb2YgdW5sb2FkaW5nIHRvIGF2b2lkIGNoZWNraW5nIHRoZSBzYW1lIGludGVybmFsCiAgICAvLyBtb2RlbCB0d2ljZSBpbiB0aGUgc2FtZSBzY2FuCiAgICB0aGlzLl9iZnNJZCA9IDA7CiAgfQoKICBnZXQgbW9kZWxDbGFzcygpIHsKICAgIHJldHVybiB0aGlzLl9tb2RlbENsYXNzIHx8ICh0aGlzLl9tb2RlbENsYXNzID0gdGhpcy5zdG9yZS5fbW9kZWxGb3IodGhpcy5tb2RlbE5hbWUpKTsKICB9CgogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIHRoaXMubW9kZWxDbGFzczsKICB9CgogIGdldCByZWNvcmRSZWZlcmVuY2UoKSB7CiAgICBpZiAodGhpcy5fcmVjb3JkUmVmZXJlbmNlID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3JlY29yZFJlZmVyZW5jZSA9IG5ldyBSZWNvcmRSZWZlcmVuY2UodGhpcy5zdG9yZSwgdGhpcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fcmVjb3JkUmVmZXJlbmNlOwogIH0KCiAgZ2V0IF9yZWNvcmRBcnJheXMoKSB7CiAgICBpZiAodGhpcy5fX3JlY29yZEFycmF5cyA9PT0gbnVsbCkgewogICAgICB0aGlzLl9fcmVjb3JkQXJyYXlzID0gT3JkZXJlZFNldC5jcmVhdGUoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9fcmVjb3JkQXJyYXlzOwogIH0KCiAgZ2V0IHJlZmVyZW5jZXMoKSB7CiAgICBpZiAodGhpcy5fcmVmZXJlbmNlcyA9PT0gbnVsbCkgewogICAgICB0aGlzLl9yZWZlcmVuY2VzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9yZWZlcmVuY2VzOwogIH0KCiAgZ2V0IF9kZWZlcnJlZFRyaWdnZXJzKCkgewogICAgaWYgKHRoaXMuX19kZWZlcnJlZFRyaWdnZXJzID09PSBudWxsKSB7CiAgICAgIHRoaXMuX19kZWZlcnJlZFRyaWdnZXJzID0gW107CiAgICB9CiAgICByZXR1cm4gdGhpcy5fX2RlZmVycmVkVHJpZ2dlcnM7CiAgfQoKICBnZXQgX2F0dHJpYnV0ZXMoKSB7CiAgICBpZiAodGhpcy5fX2F0dHJpYnV0ZXMgPT09IG51bGwpIHsKICAgICAgdGhpcy5fX2F0dHJpYnV0ZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX19hdHRyaWJ1dGVzOwogIH0KCiAgc2V0IF9hdHRyaWJ1dGVzKHYpIHsKICAgIHRoaXMuX19hdHRyaWJ1dGVzID0gdjsKICB9CgogIGdldCBfcmVsYXRpb25zaGlwcygpIHsKICAgIGlmICh0aGlzLl9fcmVsYXRpb25zaGlwcyA9PT0gbnVsbCkgewogICAgICB0aGlzLl9fcmVsYXRpb25zaGlwcyA9IG5ldyBSZWxhdGlvbnNoaXBzKHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9fcmVsYXRpb25zaGlwczsKICB9CgogIGdldCBfaW5GbGlnaHRBdHRyaWJ1dGVzKCkgewogICAgaWYgKHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPT09IG51bGwpIHsKICAgICAgdGhpcy5fX2luRmxpZ2h0QXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fX2luRmxpZ2h0QXR0cmlidXRlczsKICB9CgogIHNldCBfaW5GbGlnaHRBdHRyaWJ1dGVzKHYpIHsKICAgIHRoaXMuX19pbkZsaWdodEF0dHJpYnV0ZXMgPSB2OwogIH0KCiAgZ2V0IF9kYXRhKCkgewogICAgaWYgKHRoaXMuX19kYXRhID09PSBudWxsKSB7CiAgICAgIHRoaXMuX19kYXRhID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9fZGF0YTsKICB9CgogIHNldCBfZGF0YSh2KSB7CiAgICB0aGlzLl9fZGF0YSA9IHY7CiAgfQoKICAvKgogICBpbXBsaWNpdCByZWxhdGlvbnNoaXBzIGFyZSByZWxhdGlvbnNoaXAgd2hpY2ggaGF2ZSBub3QgYmVlbiBkZWNsYXJlZCBidXQgdGhlIGludmVyc2Ugc2lkZSBleGlzdHMgb24KICAgYW5vdGhlciByZWNvcmQgc29tZXdoZXJlCiAgIEZvciBleGFtcGxlIGlmIHRoZXJlIHdhcwogICAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgIG5hbWU6IERTLmF0dHIoKQogICB9KQogICBgYGAKICAgIGJ1dCB0aGVyZSBpcyBhbHNvCiAgICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgbmFtZTogRFMuYXR0cigpLAogICBjb21tZW50czogRFMuaGFzTWFueSgnY29tbWVudCcpCiAgIH0pCiAgIGBgYAogICAgd291bGQgaGF2ZSBhIGltcGxpY2l0IHBvc3QgcmVsYXRpb25zaGlwIGluIG9yZGVyIHRvIGJlIGRvIHRoaW5ncyBsaWtlIHJlbW92ZSBvdXJzZWx2ZXMgZnJvbSB0aGUgcG9zdAogICB3aGVuIHdlIGFyZSBkZWxldGVkCiAgKi8KICBnZXQgX2ltcGxpY2l0UmVsYXRpb25zaGlwcygpIHsKICAgIGlmICh0aGlzLl9faW1wbGljaXRSZWxhdGlvbnNoaXBzID09PSBudWxsKSB7CiAgICAgIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHM7CiAgfQoKICBpc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKSB7CiAgICAvLyBEdXJpbmcgZGVtYXRlcmlhbGl6YXRpb24gd2UgZG9uJ3Qgd2FudCB0byByZW1hdGVyaWFsaXplIHRoZSByZWNvcmQuCiAgICAvLyByZWNvcmRXYXNEZWxldGVkIGNhbiBjYXVzZSBvdGhlciByZWNvcmRzIHRvIHJlbWF0ZXJpYWxpemUgYmVjYXVzZSBpdAogICAgLy8gcmVtb3ZlcyB0aGUgaW50ZXJuYWwgbW9kZWwgZnJvbSB0aGUgYXJyYXkgYW5kIEVtYmVyIGFycmF5cyB3aWxsIGFsd2F5cwogICAgLy8gYG9iamVjdEF0KDApYCBhbmQgYG9iamVjdEF0KGxlbiAtMSlgIHRvIGNoZWNrIHdoZXRoZXIgYGZpcnN0T2JqZWN0YCBvcgogICAgLy8gYGxhc3RPYmplY3RgIGhhdmUgY2hhbmdlZC4gIFdoZW4gdGhpcyBoYXBwZW5zIHdlIGRvbid0IHdhbnQgdGhvc2UKICAgIC8vIG1vZGVscyB0byByZW1hdGVyaWFsaXplIHRoZWlyIHJlY29yZHMuCgogICAgcmV0dXJuIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nIHx8IHRoaXMuaGFzU2NoZWR1bGVkRGVzdHJveSgpIHx8IHRoaXMuaXNEZXN0cm95ZWQgfHwgdGhpcy5jdXJyZW50U3RhdGUuc3RhdGVOYW1lID09PSAncm9vdC5kZWxldGVkLnNhdmVkJyB8fCB0aGlzLmlzRW1wdHkoKTsKICB9CgogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuaXNFbXB0eTsKICB9CgogIGlzTG9hZGluZygpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc0xvYWRpbmc7CiAgfQoKICBpc0xvYWRlZCgpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc0xvYWRlZDsKICB9CgogIGhhc0RpcnR5QXR0cmlidXRlcygpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNEaXJ0eUF0dHJpYnV0ZXM7CiAgfQoKICBpc1NhdmluZygpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc1NhdmluZzsKICB9CgogIGlzRGVsZXRlZCgpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc0RlbGV0ZWQ7CiAgfQoKICBpc05ldygpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5pc05ldzsKICB9CgogIGlzVmFsaWQoKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50U3RhdGUuaXNWYWxpZDsKICB9CgogIGRpcnR5VHlwZSgpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRTdGF0ZS5kaXJ0eVR5cGU7CiAgfQoKICBnZXRSZWNvcmQocHJvcGVydGllcykgewogICAgaWYgKCF0aGlzLl9yZWNvcmQgJiYgIXRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nKSB7CgogICAgICAvLyBsb29rdXBGYWN0b3J5IHNob3VsZCByZWFsbHkgcmV0dXJuIGFuIG9iamVjdCB0aGF0IGNyZWF0ZXMKICAgICAgLy8gaW5zdGFuY2VzIHdpdGggdGhlIGluamVjdGlvbnMgYXBwbGllZAogICAgICB2YXIgY3JlYXRlT3B0aW9ucyA9IHsKICAgICAgICBzdG9yZTogdGhpcy5zdG9yZSwKICAgICAgICBfaW50ZXJuYWxNb2RlbDogdGhpcywKICAgICAgICBjdXJyZW50U3RhdGU6IHRoaXMuY3VycmVudFN0YXRlLAogICAgICAgIGlzRXJyb3I6IHRoaXMuaXNFcnJvciwKICAgICAgICBhZGFwdGVyRXJyb3I6IHRoaXMuZXJyb3IKICAgICAgfTsKCiAgICAgIGlmIChwcm9wZXJ0aWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBwcm9wZXJ0aWVzID09PSAnb2JqZWN0JyAmJiBwcm9wZXJ0aWVzICE9PSBudWxsKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBwYXNzZWQgJyR7cHJvcGVydGllc30nIGFzIHByb3BlcnRpZXMgZm9yIHJlY29yZCBjcmVhdGlvbiBpbnN0ZWFkIG9mIGFuIG9iamVjdC5gLCB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcgJiYgcHJvcGVydGllcyAhPT0gbnVsbCkpOwoKICAgICAgICB2YXIgY2xhc3NGaWVsZHMgPSB0aGlzLmdldEZpZWxkcygpOwogICAgICAgIHZhciByZWxhdGlvbnNoaXBzID0gdGhpcy5fcmVsYXRpb25zaGlwczsKICAgICAgICB2YXIgcHJvcGVydHlOYW1lcyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BlcnR5TmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gcHJvcGVydHlOYW1lc1tpXTsKICAgICAgICAgIHZhciBmaWVsZFR5cGUgPSBjbGFzc0ZpZWxkcy5nZXQobmFtZSk7CiAgICAgICAgICB2YXIgcHJvcGVydHlWYWx1ZSA9IHByb3BlcnRpZXNbbmFtZV07CgogICAgICAgICAgaWYgKG5hbWUgPT09ICdpZCcpIHsKICAgICAgICAgICAgdGhpcy5zZXRJZChwcm9wZXJ0eVZhbHVlKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgc3dpdGNoIChmaWVsZFR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnYXR0cmlidXRlJzoKICAgICAgICAgICAgICB0aGlzLnNldERpcnR5QXR0cmlidXRlKG5hbWUsIHByb3BlcnR5VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdiZWxvbmdzVG8nOgogICAgICAgICAgICAgIHRoaXMuc2V0RGlydHlCZWxvbmdzVG8obmFtZSwgcHJvcGVydHlWYWx1ZSk7CiAgICAgICAgICAgICAgcmVsYXRpb25zaGlwcy5nZXQobmFtZSkuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXBzLmdldChuYW1lKS5zZXRSZWxhdGlvbnNoaXBJc0VtcHR5KGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnaGFzTWFueSc6CiAgICAgICAgICAgICAgdGhpcy5zZXREaXJ0eUhhc01hbnkobmFtZSwgcHJvcGVydHlWYWx1ZSk7CiAgICAgICAgICAgICAgcmVsYXRpb25zaGlwcy5nZXQobmFtZSkuc2V0SGFzQW55UmVsYXRpb25zaGlwRGF0YSh0cnVlKTsKICAgICAgICAgICAgICByZWxhdGlvbnNoaXBzLmdldChuYW1lKS5zZXRSZWxhdGlvbnNoaXBJc0VtcHR5KGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBjcmVhdGVPcHRpb25zW25hbWVdID0gcHJvcGVydHlWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChFbWJlci5zZXRPd25lcikgewogICAgICAgIC8vIGVuc3VyZSB0aGF0IGBnZXRPd25lcih0aGlzKWAgd29ya3MgaW5zaWRlIGEgbW9kZWwgaW5zdGFuY2UKICAgICAgICBFbWJlci5zZXRPd25lcihjcmVhdGVPcHRpb25zLCBnZXRPd25lcih0aGlzLnN0b3JlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3JlYXRlT3B0aW9ucy5jb250YWluZXIgPSB0aGlzLnN0b3JlLmNvbnRhaW5lcjsKICAgICAgfQoKICAgICAgdGhpcy5fcmVjb3JkID0gdGhpcy5zdG9yZS5tb2RlbEZhY3RvcnlGb3IodGhpcy5tb2RlbE5hbWUpLmNyZWF0ZShjcmVhdGVPcHRpb25zKTsKCiAgICAgIHRoaXMuX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzKCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3JlY29yZDsKICB9CgogIGdldEZpZWxkcygpIHsKICAgIHJldHVybiBFbWJlci5nZXQodGhpcy5tb2RlbENsYXNzLCAnZmllbGRzJyk7CiAgfQoKICByZXNldFJlY29yZCgpIHsKICAgIHRoaXMuX3JlY29yZCA9IG51bGw7CiAgICB0aGlzLmlzUmVsb2FkaW5nID0gZmFsc2U7CiAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgIHRoaXMuY3VycmVudFN0YXRlID0gUm9vdFN0YXRlJDEuZW1wdHk7CiAgICB0aGlzLl9fYXR0cmlidXRlcyA9IG51bGw7CiAgICB0aGlzLl9faW5GbGlnaHRBdHRyaWJ1dGVzID0gbnVsbDsKICAgIHRoaXMuX2RhdGEgPSBudWxsOwogIH0KCiAgZGVtYXRlcmlhbGl6ZVJlY29yZCgpIHsKICAgIGlmICh0aGlzLl9yZWNvcmQpIHsKICAgICAgdGhpcy5faXNEZW1hdGVyaWFsaXppbmcgPSB0cnVlOwogICAgICB0aGlzLl9yZWNvcmQuZGVzdHJveSgpOwogICAgICB0aGlzLmRlc3Ryb3lSZWxhdGlvbnNoaXBzKCk7CiAgICAgIHRoaXMucmVzZXRSZWNvcmQoKTsKICAgIH0KCiAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogIH0KCiAgZGVsZXRlUmVjb3JkKCkgewogICAgdGhpcy5zZW5kKCdkZWxldGVSZWNvcmQnKTsKICB9CgogIHNhdmUob3B0aW9ucykgewogICAgdmFyIHByb21pc2VMYWJlbCA9ICJEUzogTW9kZWwjc2F2ZSAiICsgdGhpczsKICAgIHZhciByZXNvbHZlciA9IEVtYmVyLlJTVlAuZGVmZXIocHJvbWlzZUxhYmVsKTsKCiAgICB0aGlzLnN0b3JlLnNjaGVkdWxlU2F2ZSh0aGlzLCByZXNvbHZlciwgb3B0aW9ucyk7CiAgICByZXR1cm4gcmVzb2x2ZXIucHJvbWlzZTsKICB9CgogIHN0YXJ0ZWRSZWxvYWRpbmcoKSB7CiAgICB0aGlzLmlzUmVsb2FkaW5nID0gdHJ1ZTsKICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICBFbWJlci5zZXQodGhpcy5fcmVjb3JkLCAnaXNSZWxvYWRpbmcnLCB0cnVlKTsKICAgIH0KICB9CgogIGZpbmlzaGVkUmVsb2FkaW5nKCkgewogICAgdGhpcy5pc1JlbG9hZGluZyA9IGZhbHNlOwogICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIEVtYmVyLnNldCh0aGlzLl9yZWNvcmQsICdpc1JlbG9hZGluZycsIGZhbHNlKTsKICAgIH0KICB9CgogIHJlbG9hZChvcHRpb25zKSB7CiAgICB0aGlzLnN0YXJ0ZWRSZWxvYWRpbmcoKTsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpczsKICAgIHZhciBwcm9taXNlTGFiZWwgPSAiRFM6IE1vZGVsI3JlbG9hZCBvZiAiICsgdGhpczsKCiAgICByZXR1cm4gbmV3IEVtYmVyLlJTVlAuUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICBpbnRlcm5hbE1vZGVsLnNlbmQoJ3JlbG9hZFJlY29yZCcsIHsgcmVzb2x2ZSwgb3B0aW9ucyB9KTsKICAgIH0sIHByb21pc2VMYWJlbCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIGludGVybmFsTW9kZWwuZGlkQ2xlYW5FcnJvcigpOwogICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICBpbnRlcm5hbE1vZGVsLmRpZEVycm9yKGVycm9yKTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9LCAiRFM6IE1vZGVsI3JlbG9hZCBjb21wbGV0ZSwgdXBkYXRlIGZsYWdzIikuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgIGludGVybmFsTW9kZWwuZmluaXNoZWRSZWxvYWRpbmcoKTsKICAgICAgaW50ZXJuYWxNb2RlbC51cGRhdGVSZWNvcmRBcnJheXMoKTsKICAgIH0pOwogIH0KCiAgLyoKICAgIENvbXB1dGVzIHRoZSBzZXQgb2YgaW50ZXJuYWwgbW9kZWxzIHJlYWNoYWJsZSBmcm9tIGB0aGlzYCBhY3Jvc3MgZXhhY3RseSBvbmUKICAgIHJlbGF0aW9uc2hpcC4KICAgICBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgY29udGFpbmluZyB0aGUgaW50ZXJuYWwgbW9kZWxzIHRoYXQgYHRoaXNgIGJlbG9uZ3MKICAgIHRvIG9yIGhhcyBtYW55LgogICovCiAgX2RpcmVjdGx5UmVsYXRlZEludGVybmFsTW9kZWxzKCkgewogICAgdmFyIGFycmF5ID0gW107CgogICAgdGhpcy5fcmVsYXRpb25zaGlwcy5mb3JFYWNoKChuYW1lLCByZWwpID0+IHsKICAgICAgYXJyYXkgPSBhcnJheS5jb25jYXQocmVsLm1lbWJlcnMubGlzdCwgcmVsLmNhbm9uaWNhbE1lbWJlcnMubGlzdCk7CiAgICB9KTsKICAgIHJldHVybiBhcnJheTsKICB9CgogIC8qCiAgICBDb21wdXRlcyB0aGUgc2V0IG9mIGludGVybmFsIG1vZGVscyByZWFjaGFibGUgZnJvbSB0aGlzIGludGVybmFsIG1vZGVsLgogICAgIFJlYWNoYWJpbGl0eSBpcyBkZXRlcm1pbmVkIG92ZXIgdGhlIHJlbGF0aW9uc2hpcCBncmFwaCAoaWUgYSBncmFwaCB3aGVyZQogICAgbm9kZXMgYXJlIGludGVybmFsIG1vZGVscyBhbmQgZWRnZXMgYXJlIGJlbG9uZ3MgdG8gb3IgaGFzIG1hbnkKICAgIHJlbGF0aW9uc2hpcHMpLgogICAgIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBpbmNsdWRpbmcgYHRoaXNgIGFuZCBhbGwgaW50ZXJuYWwgbW9kZWxzIHJlYWNoYWJsZQogICAgZnJvbSBgdGhpc2AuCiAgKi8KICBfYWxsUmVsYXRlZEludGVybmFsTW9kZWxzKCkgewogICAgdmFyIGFycmF5ID0gW107CiAgICB2YXIgcXVldWUgPSBbXTsKICAgIHZhciBiZnNJZCA9IG5leHRCZnNJZCsrOwogICAgcXVldWUucHVzaCh0aGlzKTsKICAgIHRoaXMuX2Jmc0lkID0gYmZzSWQ7CiAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkgewogICAgICB2YXIgbm9kZSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgIGFycmF5LnB1c2gobm9kZSk7CiAgICAgIHZhciByZWxhdGVkID0gbm9kZS5fZGlyZWN0bHlSZWxhdGVkSW50ZXJuYWxNb2RlbHMoKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWxhdGVkLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSByZWxhdGVkW2ldOwogICAgICAgICh0cnVlICYmICEoaW50ZXJuYWxNb2RlbC5fYmZzSWQgPD0gYmZzSWQpICYmIEVtYmVyLmFzc2VydCgnSW50ZXJuYWwgRXJyb3I6IHNlZW4gYSBmdXR1cmUgYmZzIGl0ZXJhdGlvbicsIGludGVybmFsTW9kZWwuX2Jmc0lkIDw9IGJmc0lkKSk7CgogICAgICAgIGlmIChpbnRlcm5hbE1vZGVsLl9iZnNJZCA8IGJmc0lkKSB7CiAgICAgICAgICBxdWV1ZS5wdXNoKGludGVybmFsTW9kZWwpOwogICAgICAgICAgaW50ZXJuYWxNb2RlbC5fYmZzSWQgPSBiZnNJZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhcnJheTsKICB9CgogIC8qCiAgICBVbmxvYWQgdGhlIHJlY29yZCBmb3IgdGhpcyBpbnRlcm5hbCBtb2RlbC4gVGhpcyB3aWxsIGNhdXNlIHRoZSByZWNvcmQgdG8gYmUKICAgIGRlc3Ryb3llZCBhbmQgZnJlZWQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4gSXQgd2lsbCBhbHNvIGRvIGEgY2hlY2sKICAgIGZvciBjbGVhbmluZyB1cCBpbnRlcm5hbCBtb2RlbHMuCiAgICAgVGhpcyBjaGVjayBpcyBwZXJmb3JtZWQgYnkgZmlyc3QgY29tcHV0aW5nIHRoZSBzZXQgb2YgcmVsYXRlZCBpbnRlcm5hbAogICAgbW9kZWxzLiBJZiBhbGwgcmVjb3JkcyBpbiB0aGlzIHNldCBhcmUgdW5sb2FkZWQsIHRoZW4gdGhlIGVudGlyZSBzZXQgaXMKICAgIGRlc3Ryb3llZC4gT3RoZXJ3aXNlLCBub3RoaW5nIGluIHRoZSBzZXQgaXMgZGVzdHJveWVkLgogICAgIFRoaXMgbWVhbnMgdGhhdCB0aGlzIGludGVybmFsIG1vZGVsIHdpbGwgYmUgZnJlZWQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbgogICAgb25jZSBhbGwgbW9kZWxzIHRoYXQgcmVmZXIgdG8gaXQgdmlhIHNvbWUgcmVsYXRpb25zaGlwIGFyZSBhbHNvIHVubG9hZGVkLgogICovCiAgdW5sb2FkUmVjb3JkKCkgewogICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5zZW5kKCd1bmxvYWRSZWNvcmQnKTsKICAgIHRoaXMuZGVtYXRlcmlhbGl6ZVJlY29yZCgpOwoKICAgIGlmICh0aGlzLl9zY2hlZHVsZWREZXN0cm95ID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBFbWJlci5ydW4uYmFja2J1cm5lci5zY2hlZHVsZSgnZGVzdHJveScsIHRoaXMsICdfY2hlY2tGb3JPcnBoYW5lZEludGVybmFsTW9kZWxzJyk7CiAgICB9CiAgfQoKICBoYXNTY2hlZHVsZWREZXN0cm95KCkgewogICAgcmV0dXJuICEhdGhpcy5fc2NoZWR1bGVkRGVzdHJveTsKICB9CgogIGNhbmNlbERlc3Ryb3koKSB7CiAgICAodHJ1ZSAmJiAhKCF0aGlzLmlzRGVzdHJveWVkKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBjYW5ub3QgY2FuY2VsIHRoZSBkZXN0cnVjdGlvbiBvZiBhbiBJbnRlcm5hbE1vZGVsIG9uY2UgaXQgaGFzIGFscmVhZHkgYmVlbiBkZXN0cm95ZWRgLCAhdGhpcy5pc0Rlc3Ryb3llZCkpOwoKCiAgICB0aGlzLl9pc0RlbWF0ZXJpYWxpemluZyA9IGZhbHNlOwogICAgRW1iZXIucnVuLmNhbmNlbCh0aGlzLl9zY2hlZHVsZWREZXN0cm95KTsKICAgIHRoaXMuX3NjaGVkdWxlZERlc3Ryb3kgPSBudWxsOwogIH0KCiAgLy8gdHlwaWNhbGx5LCB3ZSBwcmVmZXIgdG8gYXN5bmMgZGVzdHJveSB0aGlzIGxldHMgdXMgYmF0Y2ggY2xlYW51cCB3b3JrLgogIC8vIFVuZm9ydHVuYXRlbHksIHNvbWUgc2NlbmFyaW9zIHdoZXJlIHRoYXQgaXMgbm90IHBvc3NpYmxlLiBTdWNoIGFzOgogIC8vCiAgLy8gYGBganMKICAvLyBjb25zdCByZWNvcmQgPSBzdG9yZS5maW5kKOKAmHJlY29yZOKAmSwgMSk7CiAgLy8gcmVjb3JkLnVubG9hZFJlY29yZCgpOwogIC8vIHN0b3JlLmNyZWF0ZVJlY29yZCjigJhyZWNvcmTigJksIDEpOwogIC8vIGBgYAogIC8vCiAgLy8gSW4gdGhvc2Ugc2NlbmFyaW9zLCB3ZSBtYWtlIHRoYXQgbW9kZWwncyBjbGVhbnVwIHdvcmssIHN5bmMuCiAgLy8KICBkZXN0cm95U3luYygpIHsKICAgIGlmICh0aGlzLl9pc0RlbWF0ZXJpYWxpemluZykgewogICAgICB0aGlzLmNhbmNlbERlc3Ryb3koKTsKICAgIH0KICAgIHRoaXMuX2NoZWNrRm9yT3JwaGFuZWRJbnRlcm5hbE1vZGVscygpOwogICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQgfHwgdGhpcy5pc0Rlc3Ryb3lpbmcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGp1c3QgaW4tY2FzZSB3ZSBhcmUgbm90IG9uZSBvZiB0aGUgb3JwaGFuZWQsIHdlIHNob3VsZCBzdGlsbAogICAgLy8gc3RpbGwgZGVzdHJveSBvdXJzZWx2ZXMKICAgIHRoaXMuZGVzdHJveSgpOwogIH0KCiAgX2NoZWNrRm9yT3JwaGFuZWRJbnRlcm5hbE1vZGVscygpIHsKICAgIHRoaXMuX2lzRGVtYXRlcmlhbGl6aW5nID0gZmFsc2U7CiAgICB0aGlzLl9zY2hlZHVsZWREZXN0cm95ID0gbnVsbDsKICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9jbGVhbnVwT3JwaGFuZWRJbnRlcm5hbE1vZGVscygpOwogIH0KCiAgX2NsZWFudXBPcnBoYW5lZEludGVybmFsTW9kZWxzKCkgewogICAgdmFyIHJlbGF0ZWRJbnRlcm5hbE1vZGVscyA9IHRoaXMuX2FsbFJlbGF0ZWRJbnRlcm5hbE1vZGVscygpOwogICAgaWYgKGFyZUFsbE1vZGVsc1VubG9hZGVkKHJlbGF0ZWRJbnRlcm5hbE1vZGVscykpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWxhdGVkSW50ZXJuYWxNb2RlbHMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHJlbGF0ZWRJbnRlcm5hbE1vZGVsc1tpXTsKICAgICAgICBpZiAoIWludGVybmFsTW9kZWwuaXNEZXN0cm95ZWQpIHsKICAgICAgICAgIGludGVybmFsTW9kZWwuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZWFjaFJlbGF0aW9uc2hpcChjYWxsYmFjaywgYmluZGluZykgewogICAgcmV0dXJuIHRoaXMubW9kZWxDbGFzcy5lYWNoUmVsYXRpb25zaGlwKGNhbGxiYWNrLCBiaW5kaW5nKTsKICB9CgogIGRlc3Ryb3koKSB7CiAgICAodHJ1ZSAmJiAhKCF0aGlzLl9yZWNvcmQgfHwgdGhpcy5fcmVjb3JkLmdldCgnaXNEZXN0cm95ZWQnKSB8fCB0aGlzLl9yZWNvcmQuZ2V0KCdpc0Rlc3Ryb3lpbmcnKSkgJiYgRW1iZXIuYXNzZXJ0KCJDYW5ub3QgZGVzdHJveSBhbiBpbnRlcm5hbE1vZGVsIHdoaWxlIGl0cyByZWNvcmQgaXMgbWF0ZXJpYWxpemVkIiwgIXRoaXMuX3JlY29yZCB8fCB0aGlzLl9yZWNvcmQuZ2V0KCdpc0Rlc3Ryb3llZCcpIHx8IHRoaXMuX3JlY29yZC5nZXQoJ2lzRGVzdHJveWluZycpKSk7CgoKICAgIHRoaXMuc3RvcmUuX2ludGVybmFsTW9kZWxEZXN0cm95ZWQodGhpcyk7CgogICAgdGhpcy5fcmVsYXRpb25zaGlwcy5mb3JFYWNoKChuYW1lLCByZWwpID0+IHJlbC5kZXN0cm95KCkpOwoKICAgIHRoaXMuX2lzRGVzdHJveWVkID0gdHJ1ZTsKICB9CgogIGVhY2hBdHRyaWJ1dGUoY2FsbGJhY2ssIGJpbmRpbmcpIHsKICAgIHJldHVybiB0aGlzLm1vZGVsQ2xhc3MuZWFjaEF0dHJpYnV0ZShjYWxsYmFjaywgYmluZGluZyk7CiAgfQoKICBpbnZlcnNlRm9yKGtleSkgewogICAgcmV0dXJuIHRoaXMubW9kZWxDbGFzcy5pbnZlcnNlRm9yKGtleSk7CiAgfQoKICBzZXR1cERhdGEoZGF0YSkgewogICAgdGhpcy5zdG9yZS5faW50ZXJuYWxNb2RlbERpZFJlY2VpdmVSZWxhdGlvbnNoaXBEYXRhKHRoaXMubW9kZWxOYW1lLCB0aGlzLmlkLCBkYXRhLnJlbGF0aW9uc2hpcHMpOwoKICAgIHZhciBjaGFuZ2VkS2V5cyA9IHZvaWQgMDsKCiAgICBpZiAodGhpcy5oYXNSZWNvcmQpIHsKICAgICAgY2hhbmdlZEtleXMgPSB0aGlzLl9jaGFuZ2VkS2V5cyhkYXRhLmF0dHJpYnV0ZXMpOwogICAgfQoKICAgIEVtYmVyLmFzc2lnbih0aGlzLl9kYXRhLCBkYXRhLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5wdXNoZWREYXRhKCk7CgogICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIHRoaXMuX3JlY29yZC5fbm90aWZ5UHJvcGVydGllcyhjaGFuZ2VkS2V5cyk7CiAgICB9CiAgfQoKICBnZXRBdHRyaWJ1dGVWYWx1ZShrZXkpIHsKICAgIGlmIChrZXkgaW4gdGhpcy5fYXR0cmlidXRlcykgewogICAgICByZXR1cm4gdGhpcy5fYXR0cmlidXRlc1trZXldOwogICAgfSBlbHNlIGlmIChrZXkgaW4gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXNba2V5XTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLl9kYXRhW2tleV07CiAgICB9CiAgfQoKICBzZXREaXJ0eUhhc01hbnkoa2V5LCByZWNvcmRzKSB7CiAgICAodHJ1ZSAmJiAhKGlzQXJyYXlMaWtlKHJlY29yZHMpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBtdXN0IHBhc3MgYW4gYXJyYXkgb2YgcmVjb3JkcyB0byBzZXQgYSBoYXNNYW55IHJlbGF0aW9uc2hpcGAsIGlzQXJyYXlMaWtlKHJlY29yZHMpKSk7CiAgICAodHJ1ZSAmJiAhKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEVtYmVyLkEocmVjb3JkcykuZXZlcnkocmVjb3JkID0+IHJlY29yZC5oYXNPd25Qcm9wZXJ0eSgnX2ludGVybmFsTW9kZWwnKSA9PT0gdHJ1ZSk7CiAgICB9KCkpICYmIEVtYmVyLmFzc2VydChgQWxsIGVsZW1lbnRzIG9mIGEgaGFzTWFueSByZWxhdGlvbnNoaXAgbXVzdCBiZSBpbnN0YW5jZXMgb2YgRFMuTW9kZWwsIHlvdSBwYXNzZWQgJHtFbWJlci5pbnNwZWN0KHJlY29yZHMpfWAsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEVtYmVyLkEocmVjb3JkcykuZXZlcnkocmVjb3JkID0+IHJlY29yZC5oYXNPd25Qcm9wZXJ0eSgnX2ludGVybmFsTW9kZWwnKSA9PT0gdHJ1ZSk7CiAgICB9KCkpKTsKCgogICAgdmFyIHJlbGF0aW9uc2hpcCA9IHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSk7CiAgICByZWxhdGlvbnNoaXAuY2xlYXIoKTsKICAgIHJlbGF0aW9uc2hpcC5hZGRJbnRlcm5hbE1vZGVscyhyZWNvcmRzLm1hcChyZWNvcmQgPT4gRW1iZXIuZ2V0KHJlY29yZCwgJ19pbnRlcm5hbE1vZGVsJykpKTsKICB9CgogIHNldERpcnR5QmVsb25nc1RvKGtleSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbHVlID0gbnVsbDsKICAgIH0KICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS50aGVuKSB7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuc2V0UmVjb3JkUHJvbWlzZSh2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKHZhbHVlKSB7CiAgICAgIHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuc2V0SW50ZXJuYWxNb2RlbCh2YWx1ZS5faW50ZXJuYWxNb2RlbCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzLmdldChrZXkpLnNldEludGVybmFsTW9kZWwodmFsdWUpOwogICAgfQogIH0KCiAgc2V0RGlydHlBdHRyaWJ1dGUoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuaXNEZWxldGVkKCkpIHsKICAgICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKGBBdHRlbXB0ZWQgdG8gc2V0ICcke2tleX0nIHRvICcke3ZhbHVlfScgb24gdGhlIGRlbGV0ZWQgcmVjb3JkICR7dGhpc31gKTsKICAgIH0KCiAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZVZhbHVlKGtleSk7CiAgICB2YXIgb3JpZ2luYWxWYWx1ZSA9IHZvaWQgMDsKCiAgICBpZiAodmFsdWUgIT09IG9sZFZhbHVlKSB7CiAgICAgIC8vIEFkZCB0aGUgbmV3IHZhbHVlIHRvIHRoZSBjaGFuZ2VkIGF0dHJpYnV0ZXMgaGFzaDsgaXQgd2lsbCBnZXQgZGVsZXRlZCBieQogICAgICAvLyB0aGUgJ2RpZFNldFByb3BlcnR5JyBoYW5kbGVyIGlmIGl0IGlzIG5vIGRpZmZlcmVudCBmcm9tIHRoZSBvcmlnaW5hbCB2YWx1ZQogICAgICB0aGlzLl9hdHRyaWJ1dGVzW2tleV0gPSB2YWx1ZTsKCiAgICAgIGlmIChrZXkgaW4gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzKSB7CiAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlc1trZXldOwogICAgICB9IGVsc2UgewogICAgICAgIG9yaWdpbmFsVmFsdWUgPSB0aGlzLl9kYXRhW2tleV07CiAgICAgIH0KCiAgICAgIHRoaXMuc2VuZCgnZGlkU2V0UHJvcGVydHknLCB7CiAgICAgICAgbmFtZToga2V5LAogICAgICAgIG9sZFZhbHVlOiBvbGRWYWx1ZSwKICAgICAgICBvcmlnaW5hbFZhbHVlOiBvcmlnaW5hbFZhbHVlLAogICAgICAgIHZhbHVlOiB2YWx1ZQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICBnZXQgaXNEZXN0cm95ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNEZXN0cm95ZWQ7CiAgfQoKICBnZXQgaGFzUmVjb3JkKCkgewogICAgcmV0dXJuICEhdGhpcy5fcmVjb3JkOwogIH0KCiAgLyoKICAgIEBtZXRob2QgY3JlYXRlU25hcHNob3QKICAgIEBwcml2YXRlCiAgKi8KICBjcmVhdGVTbmFwc2hvdChvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFNuYXBzaG90KHRoaXMsIG9wdGlvbnMpOwogIH0KCiAgLyoKICAgIEBtZXRob2QgbG9hZGluZ0RhdGEKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGxvYWRpbmdEYXRhKHByb21pc2UpIHsKICAgIHRoaXMuc2VuZCgnbG9hZGluZ0RhdGEnLCBwcm9taXNlKTsKICB9CgogIC8qCiAgICBAbWV0aG9kIGxvYWRlZERhdGEKICAgIEBwcml2YXRlCiAgKi8KICBsb2FkZWREYXRhKCkgewogICAgdGhpcy5zZW5kKCdsb2FkZWREYXRhJyk7CiAgfQoKICAvKgogICAgQG1ldGhvZCBub3RGb3VuZAogICAgQHByaXZhdGUKICAqLwogIG5vdEZvdW5kKCkgewogICAgdGhpcy5zZW5kKCdub3RGb3VuZCcpOwogIH0KCiAgLyoKICAgIEBtZXRob2QgcHVzaGVkRGF0YQogICAgQHByaXZhdGUKICAqLwogIHB1c2hlZERhdGEoKSB7CiAgICB0aGlzLnNlbmQoJ3B1c2hlZERhdGEnKTsKICB9CgogIGZsdXNoQ2hhbmdlZEF0dHJpYnV0ZXMoKSB7CiAgICB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMgPSB0aGlzLl9hdHRyaWJ1dGVzOwogICAgdGhpcy5fYXR0cmlidXRlcyA9IG51bGw7CiAgfQoKICBoYXNDaGFuZ2VkQXR0cmlidXRlcygpIHsKICAgIHJldHVybiB0aGlzLl9fYXR0cmlidXRlcyAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0aGlzLl9fYXR0cmlidXRlcykubGVuZ3RoID4gMDsKICB9CgogIC8qCiAgICBDaGVja3MgaWYgdGhlIGF0dHJpYnV0ZXMgd2hpY2ggYXJlIGNvbnNpZGVyZWQgYXMgY2hhbmdlZCBhcmUgc3RpbGwKICAgIGRpZmZlcmVudCB0byB0aGUgc3RhdGUgd2hpY2ggaXMgYWNrbm93bGVkZ2VkIGJ5IHRoZSBzZXJ2ZXIuCiAgICAgVGhpcyBtZXRob2QgaXMgbmVlZGVkIHdoZW4gZGF0YSBmb3IgdGhlIGludGVybmFsIG1vZGVsIGlzIHB1c2hlZCBhbmQgdGhlCiAgICBwdXNoZWQgZGF0YSBtaWdodCBhY2tub3dsZWRnZSBkaXJ0eSBhdHRyaWJ1dGVzIGFzIGNvbmZpcm1lZC4KICAgICBAbWV0aG9kIHVwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzCiAgICBAcHJpdmF0ZQogICAqLwogIHVwZGF0ZUNoYW5nZWRBdHRyaWJ1dGVzKCkgewogICAgdmFyIGNoYW5nZWRBdHRyaWJ1dGVzID0gdGhpcy5jaGFuZ2VkQXR0cmlidXRlcygpOwogICAgdmFyIGNoYW5nZWRBdHRyaWJ1dGVOYW1lcyA9IE9iamVjdC5rZXlzKGNoYW5nZWRBdHRyaWJ1dGVzKTsKICAgIHZhciBhdHRycyA9IHRoaXMuX2F0dHJpYnV0ZXM7CgogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGNoYW5nZWRBdHRyaWJ1dGVOYW1lcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgYXR0cmlidXRlID0gY2hhbmdlZEF0dHJpYnV0ZU5hbWVzW2ldOwogICAgICB2YXIgZGF0YSA9IGNoYW5nZWRBdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgIHZhciBvbGREYXRhID0gZGF0YVswXTsKICAgICAgdmFyIG5ld0RhdGEgPSBkYXRhWzFdOwoKICAgICAgaWYgKG9sZERhdGEgPT09IG5ld0RhdGEpIHsKICAgICAgICBkZWxldGUgYXR0cnNbYXR0cmlidXRlXTsKICAgICAgfQogICAgfQogIH0KCiAgLyoKICAgIFJldHVybnMgYW4gb2JqZWN0LCB3aG9zZSBrZXlzIGFyZSBjaGFuZ2VkIHByb3BlcnRpZXMsIGFuZCB2YWx1ZSBpcyBhbgogICAgW29sZFByb3AsIG5ld1Byb3BdIGFycmF5LgogICAgIEBtZXRob2QgY2hhbmdlZEF0dHJpYnV0ZXMKICAgIEBwcml2YXRlCiAgKi8KICBjaGFuZ2VkQXR0cmlidXRlcygpIHsKICAgIHZhciBvbGREYXRhID0gdGhpcy5fZGF0YTsKICAgIHZhciBjdXJyZW50RGF0YSA9IHRoaXMuX2F0dHJpYnV0ZXM7CiAgICB2YXIgaW5GbGlnaHREYXRhID0gdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzOwogICAgdmFyIG5ld0RhdGEgPSBFbWJlci5hc3NpZ24oe30sIGluRmxpZ2h0RGF0YSwgY3VycmVudERhdGEpOwogICAgdmFyIGRpZmZEYXRhID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBuZXdEYXRhS2V5cyA9IE9iamVjdC5rZXlzKG5ld0RhdGEpOwoKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBuZXdEYXRhS2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0gbmV3RGF0YUtleXNbaV07CiAgICAgIGRpZmZEYXRhW2tleV0gPSBbb2xkRGF0YVtrZXldLCBuZXdEYXRhW2tleV1dOwogICAgfQoKICAgIHJldHVybiBkaWZmRGF0YTsKICB9CgogIC8qCiAgICBAbWV0aG9kIGFkYXB0ZXJXaWxsQ29tbWl0CiAgICBAcHJpdmF0ZQogICovCiAgYWRhcHRlcldpbGxDb21taXQoKSB7CiAgICB0aGlzLnNlbmQoJ3dpbGxDb21taXQnKTsKICB9CgogIC8qCiAgICBAbWV0aG9kIGFkYXB0ZXJEaWREaXJ0eQogICAgQHByaXZhdGUKICAqLwogIGFkYXB0ZXJEaWREaXJ0eSgpIHsKICAgIHRoaXMuc2VuZCgnYmVjb21lRGlydHknKTsKICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzKCk7CiAgfQoKICAvKgogICAgQG1ldGhvZCBzZW5kCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG5hbWUKICAgIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0CiAgKi8KICBzZW5kKG5hbWUsIGNvbnRleHQpIHsKICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzLmN1cnJlbnRTdGF0ZTsKCiAgICBpZiAoIWN1cnJlbnRTdGF0ZVtuYW1lXSkgewogICAgICB0aGlzLl91bmhhbmRsZWRFdmVudChjdXJyZW50U3RhdGUsIG5hbWUsIGNvbnRleHQpOwogICAgfQoKICAgIHJldHVybiBjdXJyZW50U3RhdGVbbmFtZV0odGhpcywgY29udGV4dCk7CiAgfQoKICBub3RpZnlIYXNNYW55QWRkZWQoa2V5LCByZWNvcmQsIGlkeCkgewogICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIHRoaXMuX3JlY29yZC5ub3RpZnlIYXNNYW55QWRkZWQoa2V5LCByZWNvcmQsIGlkeCk7CiAgICB9CiAgfQoKICBub3RpZnlCZWxvbmdzVG9DaGFuZ2Uoa2V5LCByZWNvcmQpIHsKICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICB0aGlzLl9yZWNvcmQubm90aWZ5QmVsb25nc1RvQ2hhbmdlKGtleSwgcmVjb3JkKTsKICAgIH0KICB9CgogIG5vdGlmeVByb3BlcnR5Q2hhbmdlKGtleSkgewogICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIHRoaXMuX3JlY29yZC5ub3RpZnlQcm9wZXJ0eUNoYW5nZShrZXkpOwogICAgfQogIH0KCiAgcm9sbGJhY2tBdHRyaWJ1dGVzKCkgewogICAgdmFyIGRpcnR5S2V5cyA9IHZvaWQgMDsKICAgIGlmICh0aGlzLmhhc0NoYW5nZWRBdHRyaWJ1dGVzKCkpIHsKICAgICAgZGlydHlLZXlzID0gT2JqZWN0LmtleXModGhpcy5fYXR0cmlidXRlcyk7CiAgICAgIHRoaXMuX2F0dHJpYnV0ZXMgPSBudWxsOwogICAgfQoKICAgIGlmIChFbWJlci5nZXQodGhpcywgJ2lzRXJyb3InKSkgewogICAgICB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMgPSBudWxsOwogICAgICB0aGlzLmRpZENsZWFuRXJyb3IoKTsKICAgIH0KCiAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgIHRoaXMucmVtb3ZlRnJvbUludmVyc2VSZWxhdGlvbnNoaXBzKCk7CiAgICB9CgogICAgaWYgKHRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IG51bGw7CiAgICB9CgogICAgdGhpcy5zZW5kKCdyb2xsZWRCYWNrJyk7CgogICAgaWYgKGRpcnR5S2V5cyAmJiBkaXJ0eUtleXMubGVuZ3RoID4gMCkgewogICAgICB0aGlzLl9yZWNvcmQuX25vdGlmeVByb3BlcnRpZXMoZGlydHlLZXlzKTsKICAgIH0KICB9CgogIC8qCiAgICBAbWV0aG9kIHRyYW5zaXRpb25UbwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBuYW1lCiAgKi8KICB0cmFuc2l0aW9uVG8obmFtZSkgewogICAgLy8gUE9TU0lCTEUgVE9ETzogUmVtb3ZlIHRoaXMgY29kZSBhbmQgcmVwbGFjZSB3aXRoCiAgICAvLyBhbHdheXMgaGF2aW5nIGRpcmVjdCByZWZlcmVuY2UgdG8gc3RhdGUgb2JqZWN0cwoKICAgIHZhciBwaXZvdE5hbWUgPSBleHRyYWN0UGl2b3ROYW1lKG5hbWUpOwogICAgdmFyIHN0YXRlID0gdGhpcy5jdXJyZW50U3RhdGU7CiAgICB2YXIgdHJhbnNpdGlvbk1hcElkID0gYCR7c3RhdGUuc3RhdGVOYW1lfS0+JHtuYW1lfWA7CgogICAgZG8gewogICAgICBpZiAoc3RhdGUuZXhpdCkgewogICAgICAgIHN0YXRlLmV4aXQodGhpcyk7CiAgICAgIH0KICAgICAgc3RhdGUgPSBzdGF0ZS5wYXJlbnRTdGF0ZTsKICAgIH0gd2hpbGUgKCFzdGF0ZVtwaXZvdE5hbWVdKTsKCiAgICB2YXIgc2V0dXBzID0gdm9pZCAwOwogICAgdmFyIGVudGVycyA9IHZvaWQgMDsKICAgIHZhciBpID0gdm9pZCAwOwogICAgdmFyIGwgPSB2b2lkIDA7CiAgICB2YXIgbWFwID0gVHJhbnNpdGlvbkNoYWluTWFwW3RyYW5zaXRpb25NYXBJZF07CgogICAgaWYgKG1hcCkgewogICAgICBzZXR1cHMgPSBtYXAuc2V0dXBzOwogICAgICBlbnRlcnMgPSBtYXAuZW50ZXJzOwogICAgICBzdGF0ZSA9IG1hcC5zdGF0ZTsKICAgIH0gZWxzZSB7CiAgICAgIHNldHVwcyA9IFtdOwogICAgICBlbnRlcnMgPSBbXTsKCiAgICAgIHZhciBwYXRoID0gc3BsaXRPbkRvdChuYW1lKTsKCiAgICAgIGZvciAoaSA9IDAsIGwgPSBwYXRoLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHN0YXRlID0gc3RhdGVbcGF0aFtpXV07CgogICAgICAgIGlmIChzdGF0ZS5lbnRlcikgewogICAgICAgICAgZW50ZXJzLnB1c2goc3RhdGUpOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhdGUuc2V0dXApIHsKICAgICAgICAgIHNldHVwcy5wdXNoKHN0YXRlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIFRyYW5zaXRpb25DaGFpbk1hcFt0cmFuc2l0aW9uTWFwSWRdID0geyBzZXR1cHMsIGVudGVycywgc3RhdGUgfTsKICAgIH0KCiAgICBmb3IgKGkgPSAwLCBsID0gZW50ZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBlbnRlcnNbaV0uZW50ZXIodGhpcyk7CiAgICB9CgogICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZTsKICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICBFbWJlci5zZXQodGhpcy5fcmVjb3JkLCAnY3VycmVudFN0YXRlJywgc3RhdGUpOwogICAgfQoKICAgIGZvciAoaSA9IDAsIGwgPSBzZXR1cHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHNldHVwc1tpXS5zZXR1cCh0aGlzKTsKICAgIH0KCiAgICB0aGlzLnVwZGF0ZVJlY29yZEFycmF5cygpOwogIH0KCiAgX3VuaGFuZGxlZEV2ZW50KHN0YXRlLCBuYW1lLCBjb250ZXh0KSB7CiAgICB2YXIgZXJyb3JNZXNzYWdlID0gIkF0dGVtcHRlZCB0byBoYW5kbGUgZXZlbnQgYCIgKyBuYW1lICsgImAgIjsKICAgIGVycm9yTWVzc2FnZSArPSAib24gIiArIFN0cmluZyh0aGlzKSArICIgd2hpbGUgaW4gc3RhdGUgIjsKICAgIGVycm9yTWVzc2FnZSArPSBzdGF0ZS5zdGF0ZU5hbWUgKyAiLiAiOwoKICAgIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgZXJyb3JNZXNzYWdlICs9ICJDYWxsZWQgd2l0aCAiICsgRW1iZXIuaW5zcGVjdChjb250ZXh0KSArICIuIjsKICAgIH0KCiAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9CgogIHRyaWdnZXJMYXRlciguLi5hcmdzKSB7CiAgICBpZiAodGhpcy5fZGVmZXJyZWRUcmlnZ2Vycy5wdXNoKGFyZ3MpICE9PSAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnN0b3JlLl91cGRhdGVJbnRlcm5hbE1vZGVsKHRoaXMpOwogIH0KCiAgX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzKCkgewogICAgLy9UT0RPOiBCZWZvcmUgMS4wIHdlIHdhbnQgdG8gcmVtb3ZlIGFsbCB0aGUgZXZlbnRzIHRoYXQgaGFwcGVuIG9uIHRoZSBwcmUgbWF0ZXJpYWxpemVkIHJlY29yZCwKICAgIC8vYnV0IGZvciBub3csIHdlIHF1ZXVlIHVwIGFsbCB0aGUgZXZlbnRzIHRyaWdnZXJlZCBiZWZvcmUgdGhlIHJlY29yZCB3YXMgbWF0ZXJpYWxpemVkLCBhbmQgZmx1c2gKICAgIC8vdGhlbSBvbmNlIHdlIGhhdmUgdGhlIHJlY29yZAogICAgaWYgKCF0aGlzLmhhc1JlY29yZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLl9kZWZlcnJlZFRyaWdnZXJzOwogICAgdmFyIHJlY29yZCA9IHRoaXMuX3JlY29yZDsKICAgIHZhciB0cmlnZ2VyID0gcmVjb3JkLnRyaWdnZXI7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRyaWdnZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB0cmlnZ2VyLmFwcGx5KHJlY29yZCwgdHJpZ2dlcnNbaV0pOwogICAgfQoKICAgIHRyaWdnZXJzLmxlbmd0aCA9IDA7CiAgfQoKICAvKgogICBUaGlzIG1ldGhvZCBzaG91bGQgb25seSBiZSBjYWxsZWQgYnkgcmVjb3JkcyBpbiB0aGUgYGlzTmV3KClgIHN0YXRlIE9SIG9uY2UgdGhlIHJlY29yZAogICBoYXMgYmVlbiBkZWxldGVkIGFuZCB0aGF0IGRlbGV0aW9uIGhhcyBiZWVuIHBlcnNpc3RlZC4KICAgIEl0IHdpbGwgcmVtb3ZlIHRoaXMgcmVjb3JkIGZyb20gYW55IGFzc29jaWF0ZWQgcmVsYXRpb25zaGlwcy4KICAgICBAbWV0aG9kIHJlbW92ZUZyb21JbnZlcnNlUmVsYXRpb25zaGlwcwogICAgQHByaXZhdGUKICAgKi8KICByZW1vdmVGcm9tSW52ZXJzZVJlbGF0aW9uc2hpcHMoKSB7CiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzLmZvckVhY2goKG5hbWUsIHJlbCkgPT4gewogICAgICByZWwucmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlKCk7CiAgICAgIHJlbC5jbGVhcigpOwogICAgfSk7CgogICAgdmFyIGltcGxpY2l0UmVsYXRpb25zaGlwcyA9IHRoaXMuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPSBudWxsOwoKICAgIE9iamVjdC5rZXlzKGltcGxpY2l0UmVsYXRpb25zaGlwcykuZm9yRWFjaChrZXkgPT4gewogICAgICB2YXIgcmVsID0gaW1wbGljaXRSZWxhdGlvbnNoaXBzW2tleV07CgogICAgICByZWwucmVtb3ZlQ29tcGxldGVseUZyb21JbnZlcnNlKCk7CiAgICAgIHJlbC5jbGVhcigpOwogICAgfSk7CiAgfQoKICAvKgogICAgTm90aWZ5IGFsbCBpbnZlcnNlcyB0aGF0IHRoaXMgaW50ZXJuYWxNb2RlbCBoYXMgYmVlbiBkZW1hdGVyaWFsaXplZAogICAgYW5kIGRlc3Ryb3lzIGFueSBNYW55QXJyYXlzLgogICAqLwogIGRlc3Ryb3lSZWxhdGlvbnNoaXBzKCkgewogICAgdmFyIHJlbGF0aW9uc2hpcHMgPSB0aGlzLl9yZWxhdGlvbnNoaXBzOwogICAgcmVsYXRpb25zaGlwcy5mb3JFYWNoKChuYW1lLCByZWwpID0+IGRlc3Ryb3lSZWxhdGlvbnNoaXAocmVsKSk7CgogICAgdmFyIGltcGxpY2l0UmVsYXRpb25zaGlwcyA9IHRoaXMuX2ltcGxpY2l0UmVsYXRpb25zaGlwczsKICAgIHRoaXMuX19pbXBsaWNpdFJlbGF0aW9uc2hpcHMgPSBudWxsOwogICAgT2JqZWN0LmtleXMoaW1wbGljaXRSZWxhdGlvbnNoaXBzKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIHZhciByZWwgPSBpbXBsaWNpdFJlbGF0aW9uc2hpcHNba2V5XTsKICAgICAgZGVzdHJveVJlbGF0aW9uc2hpcChyZWwpOwogICAgfSk7CiAgfQoKICAvKgogICAgV2hlbiBhIGZpbmQgcmVxdWVzdCBpcyB0cmlnZ2VyZWQgb24gdGhlIHN0b3JlLCB0aGUgdXNlciBjYW4gb3B0aW9uYWxseSBwYXNzIGluCiAgICBhdHRyaWJ1dGVzIGFuZCByZWxhdGlvbnNoaXBzIHRvIGJlIHByZWxvYWRlZC4gVGhlc2UgYXJlIG1lYW50IHRvIGJlaGF2ZSBhcyBpZiB0aGV5CiAgICBjYW1lIGJhY2sgZnJvbSB0aGUgc2VydmVyLCBleGNlcHQgdGhlIHVzZXIgb2J0YWluZWQgdGhlbSBvdXQgb2YgYmFuZCBhbmQgaXMgaW5mb3JtaW5nCiAgICB0aGUgc3RvcmUgb2YgdGhlaXIgZXhpc3RlbmNlLiBUaGUgbW9zdCBjb21tb24gdXNlIGNhc2UgaXMgZm9yIHN1cHBvcnRpbmcgY2xpZW50IHNpZGUKICAgIG5lc3RlZCBVUkxzLCBzdWNoIGFzIGAvcG9zdHMvMS9jb21tZW50cy8yYCBzbyB0aGUgdXNlciBjYW4gZG8KICAgIGBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMiwgeyBwcmVsb2FkOiB7IHBvc3Q6IDEgfSB9KWAgd2l0aG91dCBoYXZpbmcgdG8gZmV0Y2ggdGhlIHBvc3QuCiAgICAgUHJlbG9hZGVkIGRhdGEgY2FuIGJlIGF0dHJpYnV0ZXMgYW5kIHJlbGF0aW9uc2hpcHMgcGFzc2VkIGluIGVpdGhlciBhcyBJRHMgb3IgYXMgYWN0dWFsCiAgICBtb2RlbHMuCiAgICAgQG1ldGhvZCBwcmVsb2FkRGF0YQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7T2JqZWN0fSBwcmVsb2FkCiAgKi8KICBwcmVsb2FkRGF0YShwcmVsb2FkKSB7CiAgICAvL1RPRE8oSWdvcikgY29uc2lkZXIgdGhlIHBvbHltb3JwaGljIGNhc2UKICAgIE9iamVjdC5rZXlzKHByZWxvYWQpLmZvckVhY2goa2V5ID0+IHsKICAgICAgdmFyIHByZWxvYWRWYWx1ZSA9IEVtYmVyLmdldChwcmVsb2FkLCBrZXkpOwogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IHRoaXMubW9kZWxDbGFzcy5tZXRhRm9yUHJvcGVydHkoa2V5KTsKICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEuaXNSZWxhdGlvbnNoaXApIHsKICAgICAgICB0aGlzLl9wcmVsb2FkUmVsYXRpb25zaGlwKGtleSwgcHJlbG9hZFZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9kYXRhW2tleV0gPSBwcmVsb2FkVmFsdWU7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgX3ByZWxvYWRSZWxhdGlvbnNoaXAoa2V5LCBwcmVsb2FkVmFsdWUpIHsKICAgIHZhciByZWxhdGlvbnNoaXBNZXRhID0gdGhpcy5tb2RlbENsYXNzLm1ldGFGb3JQcm9wZXJ0eShrZXkpOwogICAgdmFyIG1vZGVsQ2xhc3MgPSByZWxhdGlvbnNoaXBNZXRhLnR5cGU7CiAgICBpZiAocmVsYXRpb25zaGlwTWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgdGhpcy5fcHJlbG9hZEhhc01hbnkoa2V5LCBwcmVsb2FkVmFsdWUsIG1vZGVsQ2xhc3MpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcHJlbG9hZEJlbG9uZ3NUbyhrZXksIHByZWxvYWRWYWx1ZSwgbW9kZWxDbGFzcyk7CiAgICB9CiAgfQoKICBfcHJlbG9hZEhhc01hbnkoa2V5LCBwcmVsb2FkVmFsdWUsIG1vZGVsQ2xhc3MpIHsKICAgICh0cnVlICYmICEoQXJyYXkuaXNBcnJheShwcmVsb2FkVmFsdWUpKSAmJiBFbWJlci5hc3NlcnQoIllvdSBuZWVkIHRvIHBhc3MgaW4gYW4gYXJyYXkgdG8gc2V0IGEgaGFzTWFueSBwcm9wZXJ0eSBvbiBhIHJlY29yZCIsIEFycmF5LmlzQXJyYXkocHJlbG9hZFZhbHVlKSkpOwoKICAgIHZhciByZWNvcmRzVG9TZXQgPSBuZXcgQXJyYXkocHJlbG9hZFZhbHVlLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmVsb2FkVmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHJlY29yZFRvUHVzaCA9IHByZWxvYWRWYWx1ZVtpXTsKICAgICAgcmVjb3Jkc1RvU2V0W2ldID0gdGhpcy5fY29udmVydFN0cmluZ09yTnVtYmVySW50b0ludGVybmFsTW9kZWwocmVjb3JkVG9QdXNoLCBtb2RlbENsYXNzKTsKICAgIH0KCiAgICAvL1dlIHVzZSB0aGUgcGF0aHdheSBvZiBzZXR0aW5nIHRoZSBoYXNNYW55IGFzIGlmIGl0IGNhbWUgZnJvbSB0aGUgYWRhcHRlcgogICAgLy9iZWNhdXNlIHRoZSB1c2VyIHRvbGQgdXMgdGhhdCB0aGV5IGtub3cgdGhpcyByZWxhdGlvbnNoaXBzIGV4aXN0cyBhbHJlYWR5CiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzLmdldChrZXkpLnVwZGF0ZUludGVybmFsTW9kZWxzRnJvbUFkYXB0ZXIocmVjb3Jkc1RvU2V0KTsKICB9CgogIF9wcmVsb2FkQmVsb25nc1RvKGtleSwgcHJlbG9hZFZhbHVlLCBtb2RlbENsYXNzKSB7CiAgICB2YXIgaW50ZXJuYWxNb2RlbFRvU2V0ID0gdGhpcy5fY29udmVydFN0cmluZ09yTnVtYmVySW50b0ludGVybmFsTW9kZWwocHJlbG9hZFZhbHVlLCBtb2RlbENsYXNzKTsKCiAgICAvL1dlIHVzZSB0aGUgcGF0aHdheSBvZiBzZXR0aW5nIHRoZSBoYXNNYW55IGFzIGlmIGl0IGNhbWUgZnJvbSB0aGUgYWRhcHRlcgogICAgLy9iZWNhdXNlIHRoZSB1c2VyIHRvbGQgdXMgdGhhdCB0aGV5IGtub3cgdGhpcyByZWxhdGlvbnNoaXBzIGV4aXN0cyBhbHJlYWR5CiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzLmdldChrZXkpLnNldEludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbFRvU2V0KTsKICB9CgogIF9jb252ZXJ0U3RyaW5nT3JOdW1iZXJJbnRvSW50ZXJuYWxNb2RlbCh2YWx1ZSwgbW9kZWxDbGFzcykgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICByZXR1cm4gdGhpcy5zdG9yZS5faW50ZXJuYWxNb2RlbEZvcklkKG1vZGVsQ2xhc3MsIHZhbHVlKTsKICAgIH0KICAgIGlmICh2YWx1ZS5faW50ZXJuYWxNb2RlbCkgewogICAgICByZXR1cm4gdmFsdWUuX2ludGVybmFsTW9kZWw7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICAvKgogICAgVXNlZCB0byBub3RpZnkgdGhlIHN0b3JlIHRvIHVwZGF0ZSBGaWx0ZXJlZFJlY29yZEFycmF5IG1lbWJlcnNoaXAuCiAgICAgQG1ldGhvZCB1cGRhdGVSZWNvcmRBcnJheXMKICAgIEBwcml2YXRlCiAgKi8KICB1cGRhdGVSZWNvcmRBcnJheXMoKSB7CiAgICB0aGlzLnN0b3JlLnJlY29yZEFycmF5TWFuYWdlci5yZWNvcmREaWRDaGFuZ2UodGhpcyk7CiAgfQoKICBzZXRJZChpZCkgewogICAgKHRydWUgJiYgISh0aGlzLmlkID09PSBudWxsIHx8IHRoaXMuaWQgPT09IGlkIHx8IHRoaXMuaXNOZXcoKSkgJiYgRW1iZXIuYXNzZXJ0KCdBIHJlY29yZFwncyBpZCBjYW5ub3QgYmUgY2hhbmdlZCBvbmNlIGl0IGlzIGluIHRoZSBsb2FkZWQgc3RhdGUnLCB0aGlzLmlkID09PSBudWxsIHx8IHRoaXMuaWQgPT09IGlkIHx8IHRoaXMuaXNOZXcoKSkpOwoKICAgIHZhciBkaWRDaGFuZ2UgPSBpZCAhPT0gdGhpcy5pZDsKICAgIHRoaXMuaWQgPSBpZDsKCiAgICBpZiAoZGlkQ2hhbmdlICYmIHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIHRoaXMuX3JlY29yZC5ub3RpZnlQcm9wZXJ0eUNoYW5nZSgnaWQnKTsKICAgIH0KICB9CgogIGRpZEVycm9yKGVycm9yKSB7CiAgICB0aGlzLmVycm9yID0gZXJyb3I7CiAgICB0aGlzLmlzRXJyb3IgPSB0cnVlOwoKICAgIGlmICh0aGlzLmhhc1JlY29yZCkgewogICAgICB0aGlzLl9yZWNvcmQuc2V0UHJvcGVydGllcyh7CiAgICAgICAgaXNFcnJvcjogdHJ1ZSwKICAgICAgICBhZGFwdGVyRXJyb3I6IGVycm9yCiAgICAgIH0pOwogICAgfQogIH0KCiAgZGlkQ2xlYW5FcnJvcigpIHsKICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgdGhpcy5pc0Vycm9yID0gZmFsc2U7CgogICAgaWYgKHRoaXMuaGFzUmVjb3JkKSB7CiAgICAgIHRoaXMuX3JlY29yZC5zZXRQcm9wZXJ0aWVzKHsKICAgICAgICBpc0Vycm9yOiBmYWxzZSwKICAgICAgICBhZGFwdGVyRXJyb3I6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQoKICAvKgogICAgSWYgdGhlIGFkYXB0ZXIgZGlkIG5vdCByZXR1cm4gYSBoYXNoIGluIHJlc3BvbnNlIHRvIGEgY29tbWl0LAogICAgbWVyZ2UgdGhlIGNoYW5nZWQgYXR0cmlidXRlcyBhbmQgcmVsYXRpb25zaGlwcyBpbnRvIHRoZSBleGlzdGluZwogICAgc2F2ZWQgZGF0YS4KICAgICBAbWV0aG9kIGFkYXB0ZXJEaWRDb21taXQKICAqLwogIGFkYXB0ZXJEaWRDb21taXQoZGF0YSkgewogICAgaWYgKGRhdGEpIHsKICAgICAgdGhpcy5zdG9yZS5faW50ZXJuYWxNb2RlbERpZFJlY2VpdmVSZWxhdGlvbnNoaXBEYXRhKHRoaXMubW9kZWxOYW1lLCB0aGlzLmlkLCBkYXRhLnJlbGF0aW9uc2hpcHMpOwoKICAgICAgZGF0YSA9IGRhdGEuYXR0cmlidXRlczsKICAgIH0KCiAgICB0aGlzLmRpZENsZWFuRXJyb3IoKTsKICAgIHZhciBjaGFuZ2VkS2V5cyA9IHRoaXMuX2NoYW5nZWRLZXlzKGRhdGEpOwoKICAgIEVtYmVyLmFzc2lnbih0aGlzLl9kYXRhLCB0aGlzLl9pbkZsaWdodEF0dHJpYnV0ZXMpOwogICAgaWYgKGRhdGEpIHsKICAgICAgRW1iZXIuYXNzaWduKHRoaXMuX2RhdGEsIGRhdGEpOwogICAgfQoKICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IG51bGw7CgogICAgdGhpcy5zZW5kKCdkaWRDb21taXQnKTsKICAgIHRoaXMudXBkYXRlUmVjb3JkQXJyYXlzKCk7CgogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9yZWNvcmQuX25vdGlmeVByb3BlcnRpZXMoY2hhbmdlZEtleXMpOwogIH0KCiAgYWRkRXJyb3JNZXNzYWdlVG9BdHRyaWJ1dGUoYXR0cmlidXRlLCBtZXNzYWdlKSB7CiAgICBFbWJlci5nZXQodGhpcy5nZXRSZWNvcmQoKSwgJ2Vycm9ycycpLl9hZGQoYXR0cmlidXRlLCBtZXNzYWdlKTsKICB9CgogIHJlbW92ZUVycm9yTWVzc2FnZUZyb21BdHRyaWJ1dGUoYXR0cmlidXRlKSB7CiAgICBFbWJlci5nZXQodGhpcy5nZXRSZWNvcmQoKSwgJ2Vycm9ycycpLl9yZW1vdmUoYXR0cmlidXRlKTsKICB9CgogIGNsZWFyRXJyb3JNZXNzYWdlcygpIHsKICAgIEVtYmVyLmdldCh0aGlzLmdldFJlY29yZCgpLCAnZXJyb3JzJykuX2NsZWFyKCk7CiAgfQoKICBoYXNFcnJvcnMoKSB7CiAgICB2YXIgZXJyb3JzID0gRW1iZXIuZ2V0KHRoaXMuZ2V0UmVjb3JkKCksICdlcnJvcnMnKTsKCiAgICByZXR1cm4gZXJyb3JzLmdldCgnbGVuZ3RoJykgPiAwOwogIH0KCiAgLy8gRk9SIFVTRSBEVVJJTkcgQ09NTUlUIFBST0NFU1MKCiAgLyoKICAgIEBtZXRob2QgYWRhcHRlckRpZEludmFsaWRhdGUKICAgIEBwcml2YXRlCiAgKi8KICBhZGFwdGVyRGlkSW52YWxpZGF0ZShlcnJvcnMpIHsKICAgIHZhciBhdHRyaWJ1dGUgPSB2b2lkIDA7CgogICAgZm9yIChhdHRyaWJ1dGUgaW4gZXJyb3JzKSB7CiAgICAgIGlmIChlcnJvcnMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlKSkgewogICAgICAgIHRoaXMuYWRkRXJyb3JNZXNzYWdlVG9BdHRyaWJ1dGUoYXR0cmlidXRlLCBlcnJvcnNbYXR0cmlidXRlXSk7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnNlbmQoJ2JlY2FtZUludmFsaWQnKTsKCiAgICB0aGlzLl9zYXZlV2FzUmVqZWN0ZWQoKTsKICB9CgogIC8qCiAgICBAbWV0aG9kIGFkYXB0ZXJEaWRFcnJvcgogICAgQHByaXZhdGUKICAqLwogIGFkYXB0ZXJEaWRFcnJvcihlcnJvcikgewogICAgdGhpcy5zZW5kKCdiZWNhbWVFcnJvcicpOwogICAgdGhpcy5kaWRFcnJvcihlcnJvcik7CiAgICB0aGlzLl9zYXZlV2FzUmVqZWN0ZWQoKTsKICB9CgogIF9zYXZlV2FzUmVqZWN0ZWQoKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyk7CiAgICBpZiAoa2V5cy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBhdHRycyA9IHRoaXMuX2F0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChhdHRyc1trZXlzW2ldXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhdHRyc1trZXlzW2ldXSA9IHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlc1trZXlzW2ldXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX2luRmxpZ2h0QXR0cmlidXRlcyA9IG51bGw7CiAgfQoKICAvKgogICAgRW1iZXIgRGF0YSBoYXMgMyBidWNrZXRzIGZvciBzdG9yaW5nIHRoZSB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUgb24gYW4gaW50ZXJuYWxNb2RlbC4KICAgICBgX2RhdGFgIGhvbGRzIGFsbCBvZiB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgYmVlbiBhY2tub3dsZWRnZWQgYnkKICAgIGEgYmFja2VuZCB2aWEgdGhlIGFkYXB0ZXIuIFdoZW4gcm9sbGJhY2tBdHRyaWJ1dGVzIGlzIGNhbGxlZCBvbiBhIG1vZGVsIGFsbAogICAgYXR0cmlidXRlcyB3aWxsIHJldmVydCB0byB0aGUgcmVjb3JkJ3Mgc3RhdGUgaW4gYF9kYXRhYC4KICAgICBgX2F0dHJpYnV0ZXNgIGhvbGRzIGFueSBjaGFuZ2UgdGhlIHVzZXIgaGFzIG1hZGUgdG8gYW4gYXR0cmlidXRlCiAgICB0aGF0IGhhcyBub3QgYmVlbiBhY2tub3dsZWRnZWQgYnkgdGhlIGFkYXB0ZXIuIEFueSB2YWx1ZXMgaW4KICAgIGBfYXR0cmlidXRlc2AgYXJlIGhhdmUgcHJpb3JpdHkgb3ZlciB2YWx1ZXMgaW4gYF9kYXRhYC4KICAgICBgX2luRmxpZ2h0QXR0cmlidXRlc2AuIFdoZW4gYSByZWNvcmQgaXMgYmVpbmcgc3luY2VkIHdpdGggdGhlCiAgICBiYWNrZW5kIHRoZSB2YWx1ZXMgaW4gYF9hdHRyaWJ1dGVzYCBhcmUgY29waWVkIHRvCiAgICBgX2luRmxpZ2h0QXR0cmlidXRlc2AuIFRoaXMgd2F5IGlmIHRoZSBiYWNrZW5kIGFja25vd2xlZGdlcyB0aGUKICAgIHNhdmUgYnV0IGRvZXMgbm90IHJldHVybiB0aGUgbmV3IHN0YXRlIEVtYmVyIERhdGEgY2FuIGNvcHkgdGhlCiAgICB2YWx1ZXMgZnJvbSBgX2luRmxpZ2h0QXR0cmlidXRlc2AgdG8gYF9kYXRhYC4gV2l0aG91dCBoYXZpbmcgdG8KICAgIHdvcnJ5IGFib3V0IGNoYW5nZXMgbWFkZSB0byBgX2F0dHJpYnV0ZXNgIHdoaWxlIHRoZSBzYXZlIHdhcwogICAgaGFwcGVuaWduLgogICAgICBDaGFuZ2VkIGtleXMgYnVpbGRzIGEgbGlzdCBvZiBhbGwgb2YgdGhlIHZhbHVlcyB0aGF0IG1heSBoYXZlIGJlZW4KICAgIGNoYW5nZWQgYnkgdGhlIGJhY2tlbmQgYWZ0ZXIgYSBzdWNjZXNzZnVsIHNhdmUuCiAgICAgSXQgZG9lcyB0aGlzIGJ5IGl0ZXJhdGluZyBvdmVyIGVhY2gga2V5LCB2YWx1ZSBwYWlyIGluIHRoZSBwYXlsb2FkCiAgICByZXR1cm5lZCBmcm9tIHRoZSBzZXJ2ZXIgYWZ0ZXIgYSBzYXZlLiBJZiB0aGUgYGtleWAgaXMgZm91bmQgaW4KICAgIGBfYXR0cmlidXRlc2AgdGhlbiB0aGUgdXNlciBoYXMgYSBsb2NhbCBjaGFuZ2VkIHRvIHRoZSBhdHRyaWJ1dGUKICAgIHRoYXQgaGFzIG5vdCBiZWVuIHN5bmNlZCB3aXRoIHRoZSBzZXJ2ZXIgYW5kIHRoZSBrZXkgaXMgbm90CiAgICBpbmNsdWRlZCBpbiB0aGUgbGlzdCBvZiBjaGFuZ2VkIGtleXMuCiAgCiAgICBJZiB0aGUgdmFsdWUsIGZvciBhIGtleSBkaWZmZXJzIGZyb20gdGhlIHZhbHVlIGluIHdoYXQgRW1iZXIgRGF0YQogICAgYmVsaWV2ZXMgdG8gYmUgdGhlIHRydXRoIGFib3V0IHRoZSBiYWNrZW5kIHN0YXRlIChBIG1lcmdlciBvZiB0aGUKICAgIGBfZGF0YWAgYW5kIGBfaW5GbGlnaHRBdHRyaWJ1dGVzYCBvYmplY3RzIHdoZXJlCiAgICBgX2luRmxpZ2h0QXR0cmlidXRlc2AgaGFzIHByaW9yaXR5KSB0aGVuIHRoYXQgbWVhbnMgdGhlIGJhY2tlbmQKICAgIGhhcyB1cGRhdGVkIHRoZSB2YWx1ZSBhbmQgdGhlIGtleSBpcyBhZGRlZCB0byB0aGUgbGlzdCBvZiBjaGFuZ2VkCiAgICBrZXlzLgogICAgIEBtZXRob2QgX2NoYW5nZWRLZXlzCiAgICBAcHJpdmF0ZQogICovCiAgX2NoYW5nZWRLZXlzKHVwZGF0ZXMpIHsKICAgIHZhciBjaGFuZ2VkS2V5cyA9IFtdOwoKICAgIGlmICh1cGRhdGVzKSB7CiAgICAgIHZhciBvcmlnaW5hbCA9IHZvaWQgMCwKICAgICAgICAgIGkgPSB2b2lkIDAsCiAgICAgICAgICB2YWx1ZSA9IHZvaWQgMCwKICAgICAgICAgIGtleSA9IHZvaWQgMDsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh1cGRhdGVzKTsKICAgICAgdmFyIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgICB2YXIgaGFzQXR0cnMgPSB0aGlzLmhhc0NoYW5nZWRBdHRyaWJ1dGVzKCk7CiAgICAgIHZhciBhdHRycyA9IHZvaWQgMDsKICAgICAgaWYgKGhhc0F0dHJzKSB7CiAgICAgICAgYXR0cnMgPSB0aGlzLl9hdHRyaWJ1dGVzOwogICAgICB9CgogICAgICBvcmlnaW5hbCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIEVtYmVyLmFzc2lnbihvcmlnaW5hbCwgdGhpcy5fZGF0YSwgdGhpcy5faW5GbGlnaHRBdHRyaWJ1dGVzKTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgdmFsdWUgPSB1cGRhdGVzW2tleV07CgogICAgICAgIC8vIEEgdmFsdWUgaW4gX2F0dHJpYnV0ZXMgbWVhbnMgdGhlIHVzZXIgaGFzIGEgbG9jYWwgY2hhbmdlIHRvCiAgICAgICAgLy8gdGhpcyBhdHRyaWJ1dGVzLiBXZSBuZXZlciBvdmVycmlkZSB0aGlzIHZhbHVlIHdoZW4gbWVyZ2luZwogICAgICAgIC8vIHVwZGF0ZXMgZnJvbSB0aGUgYmFja2VuZCBzbyB3ZSBzaG91bGQgbm90IHNlbnQgYSBjaGFuZ2UKICAgICAgICAvLyBub3RpZmljYXRpb24gaWYgdGhlIHNlcnZlciB2YWx1ZSBkaWZmZXJzIGZyb20gdGhlIG9yaWdpbmFsLgogICAgICAgIGlmIChoYXNBdHRycyA9PT0gdHJ1ZSAmJiBhdHRyc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFFbWJlci5pc0VxdWFsKG9yaWdpbmFsW2tleV0sIHZhbHVlKSkgewogICAgICAgICAgY2hhbmdlZEtleXMucHVzaChrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBjaGFuZ2VkS2V5czsKICB9CgogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIGA8JHt0aGlzLm1vZGVsTmFtZX06JHt0aGlzLmlkfT5gOwogIH0KCiAgcmVmZXJlbmNlRm9yKGtpbmQsIG5hbWUpIHsKICAgIHZhciByZWZlcmVuY2UgPSB0aGlzLnJlZmVyZW5jZXNbbmFtZV07CgogICAgaWYgKCFyZWZlcmVuY2UpIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcCA9IHRoaXMuX3JlbGF0aW9uc2hpcHMuZ2V0KG5hbWUpOwoKICAgICAgewogICAgICAgIHZhciBtb2RlbE5hbWUgPSB0aGlzLm1vZGVsTmFtZTsKICAgICAgICAodHJ1ZSAmJiAhKHJlbGF0aW9uc2hpcCkgJiYgRW1iZXIuYXNzZXJ0KGBUaGVyZSBpcyBubyAke2tpbmR9IHJlbGF0aW9uc2hpcCBuYW1lZCAnJHtuYW1lfScgb24gYSBtb2RlbCBvZiBtb2RlbENsYXNzICcke21vZGVsTmFtZX0nYCwgcmVsYXRpb25zaGlwKSk7CgoKICAgICAgICB2YXIgYWN0dWFsUmVsYXRpb25zaGlwS2luZCA9IHJlbGF0aW9uc2hpcC5yZWxhdGlvbnNoaXBNZXRhLmtpbmQ7CiAgICAgICAgKHRydWUgJiYgIShhY3R1YWxSZWxhdGlvbnNoaXBLaW5kID09PSBraW5kKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBnZXQgdGhlICcke25hbWV9JyByZWxhdGlvbnNoaXAgb24gYSAnJHttb2RlbE5hbWV9JyB2aWEgcmVjb3JkLiR7a2luZH0oJyR7bmFtZX0nKSwgYnV0IHRoZSByZWxhdGlvbnNoaXAgaXMgb2Yga2luZCAnJHthY3R1YWxSZWxhdGlvbnNoaXBLaW5kfScuIFVzZSByZWNvcmQuJHthY3R1YWxSZWxhdGlvbnNoaXBLaW5kfSgnJHtuYW1lfScpIGluc3RlYWQuYCwgYWN0dWFsUmVsYXRpb25zaGlwS2luZCA9PT0ga2luZCkpOwogICAgICB9CgogICAgICBpZiAoa2luZCA9PT0gImJlbG9uZ3NUbyIpIHsKICAgICAgICByZWZlcmVuY2UgPSBuZXcgQmVsb25nc1RvUmVmZXJlbmNlKHRoaXMuc3RvcmUsIHRoaXMsIHJlbGF0aW9uc2hpcCk7CiAgICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gImhhc01hbnkiKSB7CiAgICAgICAgcmVmZXJlbmNlID0gbmV3IEhhc01hbnlSZWZlcmVuY2UodGhpcy5zdG9yZSwgdGhpcywgcmVsYXRpb25zaGlwKTsKICAgICAgfQoKICAgICAgdGhpcy5yZWZlcmVuY2VzW25hbWVdID0gcmVmZXJlbmNlOwogICAgfQoKICAgIHJldHVybiByZWZlcmVuY2U7CiAgfQp9CgovKioKIGBJbnRlcm5hbE1vZGVsTWFwYCBpcyBhIGN1c3RvbSBzdG9yYWdlIG1hcCBmb3IgaW50ZXJuYWxNb2RlbHMgb2YgYSBnaXZlbiBtb2RlbE5hbWUKIHVzZWQgYnkgYElkZW50aXR5TWFwYC4KCiBJdCB3YXMgZXh0cmFjdGVkIGZyb20gYW4gaW1wbGljaXQgcG9qbyBiYXNlZCAiaW50ZXJuYWxNb2RlbCBtYXAiIGFuZCBwcmVzZXJ2ZXMKIHRoYXQgaW50ZXJmYWNlIHdoaWxlIHdlIHdvcmsgdG93YXJkcyBhIG1vcmUgb2ZmaWNpYWwgQVBJLgoKIEBjbGFzcyBJbnRlcm5hbE1vZGVsTWFwCiBAcHJpdmF0ZQogKi8KY2xhc3MgSW50ZXJuYWxNb2RlbE1hcCB7CiAgY29uc3RydWN0b3IobW9kZWxOYW1lKSB7CiAgICB0aGlzLm1vZGVsTmFtZSA9IG1vZGVsTmFtZTsKICAgIHRoaXMuX2lkVG9Nb2RlbCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB0aGlzLl9tb2RlbHMgPSBbXTsKICAgIHRoaXMuX21ldGFkYXRhID0gbnVsbDsKICB9CgogIC8qKgogICAqIEBtZXRob2QgZ2V0CiAgICogQHBhcmFtIGlkIHtTdHJpbmd9CiAgICogQHJldHVybiB7SW50ZXJuYWxNb2RlbH0KICAgKi8KICBnZXQoaWQpIHsKICAgIHJldHVybiB0aGlzLl9pZFRvTW9kZWxbaWRdOwogIH0KCiAgaGFzKGlkKSB7CiAgICByZXR1cm4gISF0aGlzLl9pZFRvTW9kZWxbaWRdOwogIH0KCiAgZ2V0IGxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9tb2RlbHMubGVuZ3RoOwogIH0KCiAgc2V0KGlkLCBpbnRlcm5hbE1vZGVsKSB7CiAgICAodHJ1ZSAmJiAhKGlkKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBjYW5ub3QgaW5kZXggYW4gaW50ZXJuYWxNb2RlbCBieSBhbiBlbXB0eSBpZCdgLCBpZCkpOwogICAgKHRydWUgJiYgIShpbnRlcm5hbE1vZGVsIGluc3RhbmNlb2YgSW50ZXJuYWxNb2RlbCkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgY2Fubm90IHNldCBhbiBpbmRleCBmb3IgYW4gaW50ZXJuYWxNb2RlbCB0byBzb21ldGhpbmcgb3RoZXIgdGhhbiBhbiBpbnRlcm5hbE1vZGVsYCwgaW50ZXJuYWxNb2RlbCBpbnN0YW5jZW9mIEludGVybmFsTW9kZWwpKTsKICAgICh0cnVlICYmICEodGhpcy5jb250YWlucyhpbnRlcm5hbE1vZGVsKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgY2Fubm90IHNldCBhbiBpbmRleCBmb3IgYW4gaW50ZXJuYWxNb2RlbCB0aGF0IGlzIG5vdCBpbiB0aGUgSW50ZXJuYWxNb2RlbE1hcGAsIHRoaXMuY29udGFpbnMoaW50ZXJuYWxNb2RlbCkpKTsKICAgICh0cnVlICYmICEoIXRoaXMuaGFzKGlkKSB8fCB0aGlzLmdldChpZCkgPT09IGludGVybmFsTW9kZWwpICYmIEVtYmVyLmFzc2VydChgWW91IGNhbm5vdCB1cGRhdGUgdGhlIGlkIGluZGV4IG9mIGFuIEludGVybmFsTW9kZWwgb25jZSBzZXQuIEF0dGVtcHRlZCB0byB1cGRhdGUgJHtpZH0uYCwgIXRoaXMuaGFzKGlkKSB8fCB0aGlzLmdldChpZCkgPT09IGludGVybmFsTW9kZWwpKTsKCgogICAgdGhpcy5faWRUb01vZGVsW2lkXSA9IGludGVybmFsTW9kZWw7CiAgfQoKICBhZGQoaW50ZXJuYWxNb2RlbCwgaWQpIHsKICAgICh0cnVlICYmICEoIXRoaXMuY29udGFpbnMoaW50ZXJuYWxNb2RlbCkpICYmIEVtYmVyLmFzc2VydChgWW91IGNhbm5vdCByZS1hZGQgYW4gYWxyZWFkeSBwcmVzZW50IEludGVybmFsTW9kZWwgdG8gdGhlIEludGVybmFsTW9kZWxNYXAuYCwgIXRoaXMuY29udGFpbnMoaW50ZXJuYWxNb2RlbCkpKTsKCgogICAgaWYgKGlkKSB7CiAgICAgIHRoaXMuX2lkVG9Nb2RlbFtpZF0gPSBpbnRlcm5hbE1vZGVsOwogICAgfQoKICAgIHRoaXMuX21vZGVscy5wdXNoKGludGVybmFsTW9kZWwpOwogIH0KCiAgcmVtb3ZlKGludGVybmFsTW9kZWwsIGlkKSB7CiAgICBkZWxldGUgdGhpcy5faWRUb01vZGVsW2lkXTsKCiAgICB2YXIgbG9jID0gdGhpcy5fbW9kZWxzLmluZGV4T2YoaW50ZXJuYWxNb2RlbCk7CgogICAgaWYgKGxvYyAhPT0gLTEpIHsKICAgICAgdGhpcy5fbW9kZWxzLnNwbGljZShsb2MsIDEpOwogICAgfQogIH0KCiAgY29udGFpbnMoaW50ZXJuYWxNb2RlbCkgewogICAgcmV0dXJuIHRoaXMuX21vZGVscy5pbmRleE9mKGludGVybmFsTW9kZWwpICE9PSAtMTsKICB9CgogIC8qKgogICBBbiBhcnJheSBvZiBhbGwgbW9kZWxzIG9mIHRoaXMgbW9kZWxOYW1lCiAgIEBwcm9wZXJ0eSBtb2RlbHMKICAgQHR5cGUgQXJyYXkKICAgKi8KICBnZXQgbW9kZWxzKCkgewogICAgcmV0dXJuIHRoaXMuX21vZGVsczsKICB9CgogIC8qKgogICAqIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgaW50ZXJuYWxNb2RlbHMKICAgKiBAcHJvcGVydHkgbWV0YWRhdGEKICAgKiBAdHlwZSBPYmplY3QKICAgKi8KICBnZXQgbWV0YWRhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5fbWV0YWRhdGEgfHwgKHRoaXMuX21ldGFkYXRhID0gT2JqZWN0LmNyZWF0ZShudWxsKSk7CiAgfQoKICAvKioKICAgZGVwcmVjYXRlZCAoYW5kIHVuc3VwcG9ydGVkKSB3YXkgb2YgYWNjZXNzaW5nIG1vZGVsQ2xhc3MKICAgIEBwcm9wZXJ0eSB0eXBlCiAgIEBkZXByZWNhdGVkCiAgICovCiAgZ2V0IHR5cGUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludGVybmFsTW9kZWxNYXAudHlwZSBpcyBubyBsb25nZXIgYXZhaWxhYmxlJyk7CiAgfQoKICAvKioKICAgRGVzdHJveSBhbGwgbW9kZWxzIGluIHRoZSBpbnRlcm5hbE1vZGVsVGVzdCBhbmQgd2lwZSBtZXRhZGF0YS4KICAgIEBtZXRob2QgY2xlYXIKICAgKi8KICBjbGVhcigpIHsKICAgIHZhciBtb2RlbHMgPSB0aGlzLl9tb2RlbHM7CiAgICB0aGlzLl9tb2RlbHMgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgbW9kZWwgPSBtb2RlbHNbaV07CiAgICAgIG1vZGVsLnVubG9hZFJlY29yZCgpOwogICAgfQoKICAgIHRoaXMuX21ldGFkYXRhID0gbnVsbDsKICB9Cgp9CgovKioKIGBJZGVudGl0eU1hcGAgaXMgYSBjdXN0b20gc3RvcmFnZSBtYXAgZm9yIHJlY29yZHMgYnkgbW9kZWxOYW1lCiB1c2VkIGJ5IGBEUy5TdG9yZWAuCgogQGNsYXNzIElkZW50aXR5TWFwCiBAcHJpdmF0ZQogKi8KY2xhc3MgSWRlbnRpdHlNYXAgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CgogIC8qKgogICBSZXRyaWV2ZXMgdGhlIGBJbnRlcm5hbE1vZGVsTWFwYCBmb3IgYSBnaXZlbiBtb2RlbE5hbWUsCiAgIGNyZWF0aW5nIG9uZSBpZiBvbmUgZGlkIG5vdCBhbHJlYWR5IGV4aXN0LiBUaGlzIGlzCiAgIHNpbWlsYXIgdG8gYGdldFdpdGhEZWZhdWx0YCBvciBgZ2V0YCBvbiBhIGBNYXBXaXRoRGVmYXVsdGAKICAgIEBtZXRob2QgcmV0cmlldmUKICAgQHBhcmFtIG1vZGVsTmFtZSBhIHByZXZpb3VzbHkgbm9ybWFsaXplZCBtb2RlbE5hbWUKICAgQHJldHVybiB7SW50ZXJuYWxNb2RlbE1hcH0gdGhlIEludGVybmFsTW9kZWxNYXAgZm9yIHRoZSBnaXZlbiBtb2RlbE5hbWUKICAgKi8KICByZXRyaWV2ZShtb2RlbE5hbWUpIHsKICAgIHZhciBtYXAgPSB0aGlzLl9tYXBbbW9kZWxOYW1lXTsKCiAgICBpZiAobWFwID09PSB1bmRlZmluZWQpIHsKICAgICAgbWFwID0gdGhpcy5fbWFwW21vZGVsTmFtZV0gPSBuZXcgSW50ZXJuYWxNb2RlbE1hcChtb2RlbE5hbWUpOwogICAgfQoKICAgIHJldHVybiBtYXA7CiAgfQoKICAvKioKICAgQ2xlYXJzIHRoZSBjb250ZW50cyBvZiBhbGwga25vd24gYFJlY29yZE1hcHNgLCBidXQgZG9lcwogICBub3QgcmVtb3ZlIHRoZSBJbnRlcm5hbE1vZGVsTWFwIGluc3RhbmNlcy4KICAgIEBtZXRob2QgY2xlYXIKICAgKi8KICBjbGVhcigpIHsKICAgIHZhciBtYXAgPSB0aGlzLl9tYXA7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG1hcCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBtYXBba2V5XS5jbGVhcigpOwogICAgfQogIH0KfQoKLyoKICBUaGlzIGlzIGEgaGVscGVyIG1ldGhvZCB0aGF0IHZhbGlkYXRlcyBhIEpTT04gQVBJIHRvcC1sZXZlbCBkb2N1bWVudAoKICBUaGUgZm9ybWF0IG9mIGEgZG9jdW1lbnQgaXMgZGVzY3JpYmVkIGhlcmU6CiAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtdG9wLWxldmVsCgogIEBtZXRob2QgdmFsaWRhdGVEb2N1bWVudFN0cnVjdHVyZQogIEBwYXJhbSB7T2JqZWN0fSBkb2MgSlNPTiBBUEkgZG9jdW1lbnQKICBAcmV0dXJuIHthcnJheX0gQW4gYXJyYXkgb2YgZXJyb3JzIGZvdW5kIGluIHRoZSBkb2N1bWVudCBzdHJ1Y3R1cmUKKi8KZnVuY3Rpb24gdmFsaWRhdGVEb2N1bWVudFN0cnVjdHVyZShkb2MpIHsKICB2YXIgZXJyb3JzID0gW107CiAgaWYgKCFkb2MgfHwgdHlwZW9mIGRvYyAhPT0gJ29iamVjdCcpIHsKICAgIGVycm9ycy5wdXNoKCdUb3AgbGV2ZWwgb2YgYSBKU09OIEFQSSBkb2N1bWVudCBtdXN0IGJlIGFuIG9iamVjdCcpOwogIH0gZWxzZSB7CiAgICBpZiAoISgnZGF0YScgaW4gZG9jKSAmJiAhKCdlcnJvcnMnIGluIGRvYykgJiYgISgnbWV0YScgaW4gZG9jKSkgewogICAgICBlcnJvcnMucHVzaCgnT25lIG9yIG1vcmUgb2YgdGhlIGZvbGxvd2luZyBrZXlzIG11c3QgYmUgcHJlc2VudDogImRhdGEiLCAiZXJyb3JzIiwgIm1ldGEiLicpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKCdkYXRhJyBpbiBkb2MgJiYgJ2Vycm9ycycgaW4gZG9jKSB7CiAgICAgICAgZXJyb3JzLnB1c2goJ1RvcCBsZXZlbCBrZXlzICJlcnJvcnMiIGFuZCAiZGF0YSIgY2Fubm90IGJvdGggYmUgcHJlc2VudCBpbiBhIEpTT04gQVBJIGRvY3VtZW50Jyk7CiAgICAgIH0KICAgIH0KICAgIGlmICgnZGF0YScgaW4gZG9jKSB7CiAgICAgIGlmICghKGRvYy5kYXRhID09PSBudWxsIHx8IEFycmF5LmlzQXJyYXkoZG9jLmRhdGEpIHx8IHR5cGVvZiBkb2MuZGF0YSA9PT0gJ29iamVjdCcpKSB7CiAgICAgICAgZXJyb3JzLnB1c2goJ2RhdGEgbXVzdCBiZSBudWxsLCBhbiBvYmplY3QsIG9yIGFuIGFycmF5Jyk7CiAgICAgIH0KICAgIH0KICAgIGlmICgnbWV0YScgaW4gZG9jKSB7CiAgICAgIGlmICh0eXBlb2YgZG9jLm1ldGEgIT09ICdvYmplY3QnKSB7CiAgICAgICAgZXJyb3JzLnB1c2goJ21ldGEgbXVzdCBiZSBhbiBvYmplY3QnKTsKICAgICAgfQogICAgfQogICAgaWYgKCdlcnJvcnMnIGluIGRvYykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZG9jLmVycm9ycykpIHsKICAgICAgICBlcnJvcnMucHVzaCgnZXJyb3JzIG11c3QgYmUgYW4gYXJyYXknKTsKICAgICAgfQogICAgfQogICAgaWYgKCdsaW5rcycgaW4gZG9jKSB7CiAgICAgIGlmICh0eXBlb2YgZG9jLmxpbmtzICE9PSAnb2JqZWN0JykgewogICAgICAgIGVycm9ycy5wdXNoKCdsaW5rcyBtdXN0IGJlIGFuIG9iamVjdCcpOwogICAgICB9CiAgICB9CiAgICBpZiAoJ2pzb25hcGknIGluIGRvYykgewogICAgICBpZiAodHlwZW9mIGRvYy5qc29uYXBpICE9PSAnb2JqZWN0JykgewogICAgICAgIGVycm9ycy5wdXNoKCdqc29uYXBpIG11c3QgYmUgYW4gb2JqZWN0Jyk7CiAgICAgIH0KICAgIH0KICAgIGlmICgnaW5jbHVkZWQnIGluIGRvYykgewogICAgICBpZiAodHlwZW9mIGRvYy5pbmNsdWRlZCAhPT0gJ29iamVjdCcpIHsKICAgICAgICBlcnJvcnMucHVzaCgnaW5jbHVkZWQgbXVzdCBiZSBhbiBhcnJheScpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZXJyb3JzOwp9CgovKgogIFRoaXMgaXMgYSBoZWxwZXIgbWV0aG9kIHRoYXQgYWx3YXlzIHJldHVybnMgYSBKU09OLUFQSSBEb2N1bWVudC4KCiAgQG1ldGhvZCBub3JtYWxpemVSZXNwb25zZUhlbHBlcgogIEBwYXJhbSB7RFMuU2VyaWFsaXplcn0gc2VyaWFsaXplcgogIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgQHBhcmFtIHtzdWJjbGFzcyBvZiBEUy5Nb2RlbH0gbW9kZWxDbGFzcwogIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKKi8KZnVuY3Rpb24gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogIHZhciBub3JtYWxpemVkUmVzcG9uc2UgPSBzZXJpYWxpemVyLm5vcm1hbGl6ZVJlc3BvbnNlKHN0b3JlLCBtb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpOwogIHZhciB2YWxpZGF0aW9uRXJyb3JzID0gW107CiAgewogICAgdmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRlRG9jdW1lbnRTdHJ1Y3R1cmUobm9ybWFsaXplZFJlc3BvbnNlKTsKICB9CiAgKHRydWUgJiYgISh2YWxpZGF0aW9uRXJyb3JzLmxlbmd0aCA9PT0gMCkgJiYgRW1iZXIuYXNzZXJ0KGBub3JtYWxpemVSZXNwb25zZSBtdXN0IHJldHVybiBhIHZhbGlkIEpTT04gQVBJIGRvY3VtZW50OlxuXHQqICR7dmFsaWRhdGlvbkVycm9ycy5qb2luKCdcblx0KiAnKX1gLCB2YWxpZGF0aW9uRXJyb3JzLmxlbmd0aCA9PT0gMCkpOwoKCiAgcmV0dXJuIG5vcm1hbGl6ZWRSZXNwb25zZTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplckZvckFkYXB0ZXIoc3RvcmUsIGFkYXB0ZXIsIG1vZGVsTmFtZSkgewogIHZhciBzZXJpYWxpemVyID0gYWRhcHRlci5zZXJpYWxpemVyOwoKICBpZiAoc2VyaWFsaXplciA9PT0gdW5kZWZpbmVkKSB7CiAgICBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihtb2RlbE5hbWUpOwogIH0KCiAgaWYgKHNlcmlhbGl6ZXIgPT09IG51bGwgfHwgc2VyaWFsaXplciA9PT0gdW5kZWZpbmVkKSB7CiAgICBzZXJpYWxpemVyID0gewogICAgICBleHRyYWN0KHN0b3JlLCB0eXBlLCBwYXlsb2FkKSB7CiAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgIH0KICAgIH07CiAgfQoKICByZXR1cm4gc2VyaWFsaXplcjsKfQoKLyoqCiAqIE1lcmdlIGRhdGEsbWV0YSxsaW5rcyBpbmZvcm1hdGlvbiBmb3J3YXJkIHRvIHRoZSBuZXh0IHBheWxvYWQKICogaWYgcmVxdWlyZWQuIExhdGVzdCBkYXRhIHdpbGwgYWx3YXlzIHdpbi4KICoKICogQHBhcmFtIG9sZFBheWxvYWQKICogQHBhcmFtIG5ld1BheWxvYWQKICovCmZ1bmN0aW9uIG1lcmdlRm9yd2FyZFBheWxvYWQob2xkUGF5bG9hZCwgbmV3UGF5bG9hZCkgewogIGlmIChvbGRQYXlsb2FkICYmIG9sZFBheWxvYWQuZGF0YSAhPT0gdW5kZWZpbmVkICYmIG5ld1BheWxvYWQuZGF0YSA9PT0gdW5kZWZpbmVkKSB7CiAgICBuZXdQYXlsb2FkLmRhdGEgPSBvbGRQYXlsb2FkLmRhdGE7CiAgfQoKICAvKgogICAgX3BhcnRpYWxEYXRhIGlzIGhhcy1tYW55IHJlbGF0aW9uc2hpcCBkYXRhIHRoYXQgaGFzIGJlZW4gZGlzY292ZXJlZCB2aWEKICAgICBpbnZlcnNlcyBpbiB0aGUgYWJzZW5jZSBvZiBjYW5vbmljYWwgYGRhdGFgIGF2YWlsYWJpbGl0eSBmcm9tIHRoZSBwcmltYXJ5CiAgICAgcGF5bG9hZC4KICAgICBXZSBjYW4ndCBtZXJnZSB0aGlzIGRhdGEgaW50byBgZGF0YWAgYXMgdGhhdCB3b3VsZCB0cmljayBoYXMtbWFueSByZWxhdGlvbnNoaXBzCiAgICAgaW50byBiZWxpZXZpbmcgdGhleSBrbm93IHRoZWlyIGNvbXBsZXRlIG1lbWJlcnNoaXAuIEFueXRpbWUgd2UgZmluZCBjYW5vbmljYWwKICAgICBkYXRhIGZyb20gdGhlIHByaW1hcnkgcmVjb3JkLCB0aGlzIHBhcnRpYWwgZGF0YSBpcyBkaXNjYXJkZWQuIElmIG5vIGNhbm9uaWNhbAogICAgIGRhdGEgaXMgZXZlciBkaXNjb3ZlcmVkLCB0aGUgcGFydGlhbCBkYXRhIHdpbGwgYmUgbG9hZGVkIGJ5IHRoZSByZWxhdGlvbnNoaXAKICAgICBpbiBhIHdheSB0aGF0IGNvcnJlY3RseSBwcmVzZXJ2ZXMgdGhlIGBzdGFsZWAgcmVsYXRpb25zaGlwIHN0YXRlLgogICAqLwogIGlmIChuZXdQYXlsb2FkLmRhdGEgPT09IHVuZGVmaW5lZCAmJiBvbGRQYXlsb2FkICYmIG9sZFBheWxvYWQuX3BhcnRpYWxEYXRhICE9PSB1bmRlZmluZWQpIHsKICAgIG5ld1BheWxvYWQuX3BhcnRpYWxEYXRhID0gb2xkUGF5bG9hZC5fcGFydGlhbERhdGE7CiAgfQoKICBpZiAob2xkUGF5bG9hZCAmJiBvbGRQYXlsb2FkLm1ldGEgIT09IHVuZGVmaW5lZCAmJiBuZXdQYXlsb2FkLm1ldGEgPT09IHVuZGVmaW5lZCkgewogICAgbmV3UGF5bG9hZC5tZXRhID0gb2xkUGF5bG9hZC5tZXRhOwogIH0KCiAgaWYgKG9sZFBheWxvYWQgJiYgb2xkUGF5bG9hZC5saW5rcyAhPT0gdW5kZWZpbmVkICYmIG5ld1BheWxvYWQubGlua3MgPT09IHVuZGVmaW5lZCkgewogICAgbmV3UGF5bG9hZC5saW5rcyA9IG9sZFBheWxvYWQubGlua3M7CiAgfQp9CgovLyBUT0RPIHRoaXMgaXMgbm93IFZFUlkgc2ltaWxhciB0byB0aGUgaWRlbnRpdHkvaW50ZXJuYWwtbW9kZWwgbWFwCi8vICBzbyB3ZSBzaG91bGQgcHJvYmFibHkgZ2VuZXJhbGl6ZQpjbGFzcyBUeXBlQ2FjaGUgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy50eXBlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQogIGdldChtb2RlbE5hbWUsIGlkKSB7CiAgICB2YXIgeyB0eXBlcyB9ID0gdGhpczsKCiAgICBpZiAodHlwZXNbbW9kZWxOYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB0eXBlc1ttb2RlbE5hbWVdW2lkXTsKICAgIH0KICB9CgogIHNldChtb2RlbE5hbWUsIGlkLCBwYXlsb2FkKSB7CiAgICB2YXIgeyB0eXBlcyB9ID0gdGhpczsKICAgIHZhciB0eXBlTWFwID0gdHlwZXNbbW9kZWxOYW1lXTsKCiAgICBpZiAodHlwZU1hcCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHR5cGVNYXAgPSB0eXBlc1ttb2RlbE5hbWVdID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KCiAgICB0eXBlTWFwW2lkXSA9IHBheWxvYWQ7CiAgfQoKICBkZWxldGUobW9kZWxOYW1lLCBpZCkgewogICAgdmFyIHsgdHlwZXMgfSA9IHRoaXM7CgogICAgaWYgKHR5cGVzW21vZGVsTmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICBkZWxldGUgdHlwZXNbbW9kZWxOYW1lXVtpZF07CiAgICB9CiAgfQp9CgovKioKIE1hbmFnZXMgdGhlIHBheWxvYWRzIGZvciBib3RoIHNpZGVzIG9mIGEgc2luZ2xlIHJlbGF0aW9uc2hpcCwgYWNyb3NzIGFsbCBtb2RlbAogaW5zdGFuY2VzLgoKIEZvciBleGFtcGxlLCB3aXRoCgogY29uc3QgVXNlciA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGhvYmJpZXM6IERTLmhhc01hbnkoJ2hvYmJ5JykKICAgIH0pOwoKIGNvbnN0IEhvYmJ5ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgdXNlcjogRFMuYmVsb25nc1RvKCd1c2VyJykKICAgIH0pOwoKIGxldCByZWxhdGlvbnNoaXBQYXlsb2FkcyA9IG5ldyBSZWxhdGlvbnNoaXBQYXlsb2FkcygndXNlcicsICdob2JiaWVzJywgJ2hvYmJ5JywgJ3VzZXInKTsKCiBsZXQgdXNlclBheWxvYWQgPSB7CiAgICAgIGRhdGE6IHsKICAgICAgICBpZDogMSwKICAgICAgICB0eXBlOiAndXNlcicsCiAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgaG9iYmllczogewogICAgICAgICAgICBkYXRhOiBbewogICAgICAgICAgICAgIGlkOiAyLAogICAgICAgICAgICAgIHR5cGU6ICdob2JieScsCiAgICAgICAgICAgIH1dCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKIC8vIGhlcmUgd2UgZXhwZWN0IHRoZSBwYXlsb2FkIG9mIHRoZSBpbmRpdmlkdWFsIHJlbGF0aW9uc2hpcAogcmVsYXRpb25zaGlwUGF5bG9hZHMucHVzaCgndXNlcicsIDEsICdob2JiaWVzJywgdXNlclBheWxvYWQuZGF0YS5yZWxhdGlvbnNoaXBzLmhvYmJpZXMpOwoKIHJlbGF0aW9uc2hpcFBheWxvYWRzLmdldCgndXNlcicsIDEsICdob2JiaWVzJyk7CiByZWxhdGlvbnNoaXBQYXlsb2Fkcy5nZXQoJ2hvYmJ5JywgMiwgJ3VzZXInKTsKCiBAY2xhc3MgUmVsYXRpb25zaGlwUGF5bG9hZHMKIEBwcml2YXRlCiAqLwpjbGFzcyBSZWxhdGlvbnNoaXBQYXlsb2FkcyB7CiAgY29uc3RydWN0b3IocmVsSW5mbykgewogICAgdGhpcy5fcmVsSW5mbyA9IHJlbEluZm87CgogICAgLy8gYSBtYXAgb2YgaWQgLT4gcGF5bG9hZHMgZm9yIHRoZSBsZWZ0IGhhbmQgc2lkZSBvZiB0aGUgcmVsYXRpb25zaGlwLgogICAgdGhpcy5saHNfcGF5bG9hZHMgPSBuZXcgVHlwZUNhY2hlKCk7CiAgICB0aGlzLnJoc19wYXlsb2FkcyA9IHJlbEluZm8uaXNSZWZsZXhpdmUgPyB0aGlzLmxoc19wYXlsb2FkcyA6IG5ldyBUeXBlQ2FjaGUoKTsKCiAgICAvLyBXaGVuIHdlIHB1c2ggcmVsYXRpb25zaGlwIHBheWxvYWRzLCBqdXN0IHN0YXNoIHRoZW0gaW4gYSBxdWV1ZSB1bnRpbAogICAgLy8gc29tZWJvZHkgYWN0dWFsbHkgYXNrcyBmb3Igb25lIG9mIHRoZW0uCiAgICAvLwogICAgLy8gVGhpcyBpcyBhIHF1ZXVlIG9mIHRoZSByZWxhdGlvbnNoaXAgcGF5bG9hZHMgdGhhdCBoYXZlIGJlZW4gcHVzaGVkIGZvcgogICAgLy8gZWl0aGVyIHNpZGUgb2YgdGhpcyByZWxhdGlvbnNoaXAKICAgIHRoaXMuX3BlbmRpbmdQYXlsb2FkcyA9IFtdOwogIH0KCiAgLyoqCiAgIEdldCB0aGUgcGF5bG9hZCBmb3IgdGhlIHJlbGF0aW9uc2hpcCBvZiBhbiBpbmRpdmlkdWFsIHJlY29yZC4KICAgIFRoaXMgbWlnaHQgcmV0dXJuIHRoZSByYXcgcGF5bG9hZCBhcyBwdXNoZWQgaW50byB0aGUgc3RvcmUsIG9yIG9uZSBjb21wdXRlZAogICBmcm9tIHRoZSBwYXlsb2FkIG9mIHRoZSBpbnZlcnNlIHJlbGF0aW9uc2hpcC4KICAgIEBtZXRob2QKICAgKi8KICBnZXQobW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwTmFtZSkgewogICAgdGhpcy5fZmx1c2hQZW5kaW5nKCk7CgogICAgaWYgKHRoaXMuX2lzTEhTKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkpIHsKICAgICAgcmV0dXJuIHRoaXMubGhzX3BheWxvYWRzLmdldChtb2RlbE5hbWUsIGlkKTsKICAgIH0gZWxzZSB7CiAgICAgICh0cnVlICYmICEodGhpcy5faXNSSFMobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGAke21vZGVsTmFtZX06JHtyZWxhdGlvbnNoaXBOYW1lfSBpcyBub3QgZWl0aGVyIHNpZGUgb2YgdGhpcyByZWxhdGlvbnNoaXAsICR7dGhpcy5fcmVsSW5mby5saHNfa2V5fTwtPiR7dGhpcy5fcmVsSW5mby5yaHNfa2V5fWAsIHRoaXMuX2lzUkhTKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkpKTsKCiAgICAgIHJldHVybiB0aGlzLnJoc19wYXlsb2Fkcy5nZXQobW9kZWxOYW1lLCBpZCk7CiAgICB9CiAgfQoKICAvKioKICAgUHVzaCBhIHJlbGF0aW9uc2hpcCBwYXlsb2FkIGZvciBhbiBpbmRpdmlkdWFsIHJlY29yZC4KICAgIFRoaXMgd2lsbCBtYWtlIHRoZSBwYXlsb2FkIGF2YWlsYWJsZSBsYXRlciBmb3IgYm90aCB0aGlzIHJlbGF0aW9uc2hpcCBhbmQgaXRzIGludmVyc2UuCiAgICBAbWV0aG9kCiAgICovCiAgcHVzaChtb2RlbE5hbWUsIGlkLCByZWxhdGlvbnNoaXBOYW1lLCByZWxhdGlvbnNoaXBEYXRhKSB7CiAgICB0aGlzLl9wZW5kaW5nUGF5bG9hZHMucHVzaChbbW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwTmFtZSwgcmVsYXRpb25zaGlwRGF0YV0pOwogIH0KCiAgLyoqCiAgIFVubG9hZCB0aGUgcmVsYXRpb25zaGlwIHBheWxvYWQgZm9yIGFuIGluZGl2aWR1YWwgcmVjb3JkLgogICAgVGhpcyBkb2VzIG5vdCB1bmxvYWQgdGhlIGludmVyc2UgcmVsYXRpb25zaGlwIHBheWxvYWQuCiAgICBAbWV0aG9kCiAgICovCiAgdW5sb2FkKG1vZGVsTmFtZSwgaWQsIHJlbGF0aW9uc2hpcE5hbWUpIHsKICAgIHRoaXMuX2ZsdXNoUGVuZGluZygpOwoKICAgIGlmICh0aGlzLl9pc0xIUyhtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcE5hbWUpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLmxoc19wYXlsb2Fkcy5kZWxldGUobW9kZWxOYW1lLCBpZCk7CiAgICB9IGVsc2UgewogICAgICAodHJ1ZSAmJiAhKHRoaXMuX2lzUkhTKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkpICYmIEVtYmVyLmFzc2VydChgJHttb2RlbE5hbWV9OiR7cmVsYXRpb25zaGlwTmFtZX0gaXMgbm90IGVpdGhlciBzaWRlIG9mIHRoaXMgcmVsYXRpb25zaGlwLCAke3RoaXMuX3JlbEluZm8ubGhzX2Jhc2VNb2RlbE5hbWV9OiR7dGhpcy5fcmVsSW5mby5saHNfcmVsYXRpb25zaGlwTmFtZX08LT4ke3RoaXMuX3JlbEluZm8ucmhzX2Jhc2VNb2RlbE5hbWV9OiR7dGhpcy5fcmVsSW5mby5yaHNfcmVsYXRpb25zaGlwTmFtZX1gLCB0aGlzLl9pc1JIUyhtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcE5hbWUpKSk7CgogICAgICBkZWxldGUgdGhpcy5yaHNfcGF5bG9hZHMuZGVsZXRlKG1vZGVsTmFtZSwgaWQpOwogICAgfQogIH0KCiAgLyoqCiAgIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWZmIGBtb2RlbE5hbWVgIGFuZCBgcmVsYXRpb25zaGlwTmFtZWAgcmVmZXIgdG8gdGhlCiAgIGxlZnQgaGFuZCBzaWRlIG9mIHRoaXMgcmVsYXRpb25zaGlwLCBhcyBvcHBvc2VkIHRvIHRoZSByaWdodCBoYW5kIHNpZGUuCiAgICBAbWV0aG9kCiAgICovCiAgX2lzTEhTKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkgewogICAgdmFyIHJlbEluZm8gPSB0aGlzLl9yZWxJbmZvOwogICAgdmFyIGlzU2VsZlJlZmVyZW50aWFsID0gcmVsSW5mby5pc1NlbGZSZWZlcmVudGlhbDsKICAgIHZhciBpc1JlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcE5hbWUgPT09IHJlbEluZm8ubGhzX3JlbGF0aW9uc2hpcE5hbWU7CgogICAgaWYgKGlzUmVsYXRpb25zaGlwID09PSB0cnVlKSB7CiAgICAgIHJldHVybiBpc1NlbGZSZWZlcmVudGlhbCA9PT0gdHJ1ZSB8fCAvLyBpdHNlbGYKICAgICAgbW9kZWxOYW1lID09PSByZWxJbmZvLmxoc19iYXNlTW9kZWxOYW1lIHx8IC8vIGJhc2Ugb3Igbm9uLXBvbHltb3JwaGljCiAgICAgIHJlbEluZm8ubGhzX21vZGVsTmFtZXMuaW5kZXhPZihtb2RlbE5hbWUpICE9PSAtMTsgLy8gcG9seW1vcnBoaWMKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvKioKICAgQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZmYgYG1vZGVsTmFtZWAgYW5kIGByZWxhdGlvbnNoaXBOYW1lYCByZWZlciB0byB0aGUKICAgcmlnaHQgaGFuZCBzaWRlIG9mIHRoaXMgcmVsYXRpb25zaGlwLCBhcyBvcHBvc2VkIHRvIHRoZSBsZWZ0IGhhbmQgc2lkZS4KICAgIEBtZXRob2QKICAgKi8KICBfaXNSSFMobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKSB7CiAgICB2YXIgcmVsSW5mbyA9IHRoaXMuX3JlbEluZm87CiAgICB2YXIgaXNTZWxmUmVmZXJlbnRpYWwgPSByZWxJbmZvLmlzU2VsZlJlZmVyZW50aWFsOwogICAgdmFyIGlzUmVsYXRpb25zaGlwID0gcmVsYXRpb25zaGlwTmFtZSA9PT0gcmVsSW5mby5yaHNfcmVsYXRpb25zaGlwTmFtZTsKCiAgICBpZiAoaXNSZWxhdGlvbnNoaXAgPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGlzU2VsZlJlZmVyZW50aWFsID09PSB0cnVlIHx8IC8vIGl0c2VsZgogICAgICBtb2RlbE5hbWUgPT09IHJlbEluZm8ucmhzX2Jhc2VNb2RlbE5hbWUgfHwgLy8gYmFzZSBvciBub24tcG9seW1vcnBoaWMKICAgICAgcmVsSW5mby5yaHNfbW9kZWxOYW1lcy5pbmRleE9mKG1vZGVsTmFtZSkgIT09IC0xOyAvLyBwb2x5bW9ycGhpYwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIF9mbHVzaFBlbmRpbmcoKSB7CiAgICBpZiAodGhpcy5fcGVuZGluZ1BheWxvYWRzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHBheWxvYWRzVG9CZVByb2Nlc3NlZCA9IHRoaXMuX3BlbmRpbmdQYXlsb2Fkcy5zcGxpY2UoMCwgdGhpcy5fcGVuZGluZ1BheWxvYWRzLmxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBheWxvYWRzVG9CZVByb2Nlc3NlZC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgbW9kZWxOYW1lID0gcGF5bG9hZHNUb0JlUHJvY2Vzc2VkW2ldWzBdOwogICAgICB2YXIgaWQgPSBwYXlsb2Fkc1RvQmVQcm9jZXNzZWRbaV1bMV07CiAgICAgIHZhciByZWxhdGlvbnNoaXBOYW1lID0gcGF5bG9hZHNUb0JlUHJvY2Vzc2VkW2ldWzJdOwogICAgICB2YXIgcmVsYXRpb25zaGlwRGF0YSA9IHBheWxvYWRzVG9CZVByb2Nlc3NlZFtpXVszXTsKCiAgICAgIC8vIFRPRE86IG1heWJlIGRlbGF5IHRoaXMgYWxsb2NhdGlvbiBzbGlnaHRseT8KICAgICAgdmFyIGludmVyc2VSZWxhdGlvbnNoaXBEYXRhID0gewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgIHR5cGU6IG1vZGVsTmFtZQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8vIHN0YXJ0IGZsdXNoaW5nIHRoaXMgaW5kaXZpZHVhbCBwYXlsb2FkLiAgVGhlIGxvZ2ljIGlzIHRoZSBzYW1lIHdoZXRoZXIKICAgICAgLy8gaXQncyBmb3IgdGhlIGxlZnQgaGFuZCBzaWRlIG9mIHRoZSByZWxhdGlvbnNoaXAgb3IgdGhlIHJpZ2h0IGhhbmQgc2lkZSwKICAgICAgLy8gZXhjZXB0IHRoZSByb2xlIG9mIHByaW1hcnkgYW5kIGludmVyc2UgaWRUb1BheWxvYWRzIGlzIHJldmVyc2VkCiAgICAgIC8vCiAgICAgIHZhciBwcmV2aW91c1BheWxvYWQgPSB2b2lkIDA7CiAgICAgIHZhciBwYXlsb2FkTWFwID0gdm9pZCAwOwogICAgICB2YXIgaW52ZXJzZVBheWxvYWRNYXAgPSB2b2lkIDA7CiAgICAgIHZhciBpbnZlcnNlSXNNYW55ID0gdm9pZCAwOwogICAgICBpZiAodGhpcy5faXNMSFMobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKSkgewogICAgICAgIHByZXZpb3VzUGF5bG9hZCA9IHRoaXMubGhzX3BheWxvYWRzLmdldChtb2RlbE5hbWUsIGlkKTsKICAgICAgICBwYXlsb2FkTWFwID0gdGhpcy5saHNfcGF5bG9hZHM7CiAgICAgICAgaW52ZXJzZVBheWxvYWRNYXAgPSB0aGlzLnJoc19wYXlsb2FkczsKICAgICAgICBpbnZlcnNlSXNNYW55ID0gdGhpcy5fcmhzUmVsYXRpb25zaGlwSXNNYW55OwogICAgICB9IGVsc2UgewogICAgICAgICh0cnVlICYmICEodGhpcy5faXNSSFMobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGAke21vZGVsTmFtZX06JHtyZWxhdGlvbnNoaXBOYW1lfSBpcyBub3QgZWl0aGVyIHNpZGUgb2YgdGhpcyByZWxhdGlvbnNoaXAsICR7dGhpcy5fcmVsSW5mby5saHNfa2V5fTwtPiR7dGhpcy5fcmVsSW5mby5yaHNfa2V5fWAsIHRoaXMuX2lzUkhTKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkpKTsKCiAgICAgICAgcHJldmlvdXNQYXlsb2FkID0gdGhpcy5yaHNfcGF5bG9hZHMuZ2V0KG1vZGVsTmFtZSwgaWQpOwogICAgICAgIHBheWxvYWRNYXAgPSB0aGlzLnJoc19wYXlsb2FkczsKICAgICAgICBpbnZlcnNlUGF5bG9hZE1hcCA9IHRoaXMubGhzX3BheWxvYWRzOwogICAgICAgIGludmVyc2VJc01hbnkgPSB0aGlzLl9saHNSZWxhdGlvbnNoaXBJc01hbnk7CiAgICAgIH0KCiAgICAgIC8vIGFjdHVhbGx5IGZsdXNoIHRoaXMgaW5kaXZpZHVhbCBwYXlsb2FkCiAgICAgIC8vCiAgICAgIC8vIFdlIHJlbW92ZSB0aGUgcHJldmlvdXMgaW52ZXJzZSBiZWZvcmUgcG9wdWxhdGluZyBvdXIgY3VycmVudCBvbmUKICAgICAgLy8gYmVjYXVzZSB3ZSBtYXkgaGF2ZSBtdWx0aXBsZSBwYXlsb2FkcyBmb3IgdGhlIHNhbWUgcmVsYXRpb25zaGlwLCBpbgogICAgICAvLyB3aGljaCBjYXNlIHRoZSBsYXN0IG9uZSB3aW5zLgogICAgICAvLwogICAgICAvLyBlZyBpZiB1c2VyIGhhc01hbnkgaGVsaWNvcHRlcnMsIGFuZCBoZWxpY29wdGVyIGJlbG9uZ3NUbyB1c2VyIGFuZCB3ZSBzZWUKICAgICAgLy8KICAgICAgLy8gIFt7CiAgICAgIC8vICAgIGRhdGE6IHsKICAgICAgLy8gICAgICBpZDogMSwKICAgICAgLy8gICAgICB0eXBlOiAnaGVsaWNvcHRlcicsCiAgICAgIC8vICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAvLyAgICAgICAgdXNlcjogewogICAgICAvLyAgICAgICAgICBpZDogMiwKICAgICAgLy8gICAgICAgICAgdHlwZTogJ3VzZXInCiAgICAgIC8vICAgICAgICB9CiAgICAgIC8vICAgICAgfQogICAgICAvLyAgICB9CiAgICAgIC8vICB9LCB7CiAgICAgIC8vICAgIGRhdGE6IHsKICAgICAgLy8gICAgICBpZDogMSwKICAgICAgLy8gICAgICB0eXBlOiAnaGVsaWNvcHRlcicsCiAgICAgIC8vICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAvLyAgICAgICAgdXNlcjogewogICAgICAvLyAgICAgICAgICBpZDogNCwKICAgICAgLy8gICAgICAgICAgdHlwZTogJ3VzZXInCiAgICAgIC8vICAgICAgICB9CiAgICAgIC8vICAgICAgfQogICAgICAvLyAgICB9CiAgICAgIC8vICB9XQogICAgICAvLwogICAgICAvLyBUaGVuIHdlIHdpbGwgaW5pdGlhbGx5IGhhdmUgc2V0IHVzZXI6MiBhcyBoYXZpbmcgaGVsaWNvcHRlcjoxLCB3aGljaCB3ZQogICAgICAvLyBuZWVkIHRvIHJlbW92ZSBiZWZvcmUgYWRkaW5nIGhlbGljb3B0ZXI6MSB0byB1c2VyOjQKICAgICAgLy8KICAgICAgLy8gb25seSByZW1vdmUgcmVsYXRpb25zaGlwIGluZm9ybWF0aW9uIGJlZm9yZSBhZGRpbmcgaWYgdGhlcmUgaXMgcmVsYXRpb25zaGlwRGF0YS5kYXRhCiAgICAgIC8vICogbnVsbCBpcyBjb25zaWRlcmVkIG5ldyBpbmZvcm1hdGlvbiAiZW1wdHkiLCBhbmQgaXQgc2hvdWxkIHdpbgogICAgICAvLyAqIHVuZGVmaW5lZCBpcyBOT1QgY29uc2lkZXJlZCBuZXcgaW5mb3JtYXRpb24sIHdlIHNob3VsZCBrZWVwIG9yaWdpbmFsIHN0YXRlCiAgICAgIC8vICogYW55dGhpbmcgZWxzZSBpcyBjb25zaWRlcmVkIG5ldyBpbmZvcm1hdGlvbiwgYW5kIGl0IHNob3VsZCB3aW4KICAgICAgdmFyIGlzTWF0Y2hpbmdJZGVudGlmaWVyID0gdGhpcy5faXNNYXRjaGluZ0lkZW50aWZpZXIocmVsYXRpb25zaGlwRGF0YSAmJiByZWxhdGlvbnNoaXBEYXRhLmRhdGEsIHByZXZpb3VzUGF5bG9hZCAmJiBwcmV2aW91c1BheWxvYWQuZGF0YSk7CgogICAgICBpZiAocmVsYXRpb25zaGlwRGF0YS5kYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIWlzTWF0Y2hpbmdJZGVudGlmaWVyKSB7CiAgICAgICAgICB0aGlzLl9yZW1vdmVJbnZlcnNlKGlkLCBwcmV2aW91c1BheWxvYWQsIGludmVyc2VQYXlsb2FkTWFwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1lcmdlRm9yd2FyZFBheWxvYWQocHJldmlvdXNQYXlsb2FkLCByZWxhdGlvbnNoaXBEYXRhKTsKICAgICAgcGF5bG9hZE1hcC5zZXQobW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwRGF0YSk7CgogICAgICBpZiAoIWlzTWF0Y2hpbmdJZGVudGlmaWVyKSB7CiAgICAgICAgdGhpcy5fcG9wdWxhdGVJbnZlcnNlKHJlbGF0aW9uc2hpcERhdGEsIGludmVyc2VSZWxhdGlvbnNoaXBEYXRhLCBpbnZlcnNlUGF5bG9hZE1hcCwgaW52ZXJzZUlzTWFueSk7CiAgICAgIH0KICAgIH0KICB9CgogIF9pc01hdGNoaW5nSWRlbnRpZmllcihhLCBiKSB7CiAgICByZXR1cm4gYSAmJiBiICYmIGEudHlwZSA9PT0gYi50eXBlICYmIGEuaWQgPT09IGIuaWQgJiYgIUFycmF5LmlzQXJyYXkoYSkgJiYgIUFycmF5LmlzQXJyYXkoYik7CiAgfQoKICAvKioKICAgUG9wdWxhdGUgdGhlIGludmVyc2UgcmVsYXRpb25zaGlwIGZvciBgcmVsYXRpb25zaGlwRGF0YWAuCiAgICBJZiBgcmVsYXRpb25zaGlwRGF0YWAgaXMgYW4gYXJyYXkgKGVnIGJlY2F1c2UgdGhlIHJlbGF0aW9uc2hpcCBpcyBoYXNNYW55KQogICB0aGlzIG1lYW5zIHBvcHVsYXRlIGVhY2ggaW52ZXJzZSwgb3RoZXJ3aXNlIHBvcHVsYXRlIG9ubHkgdGhlIHNpbmdsZQogICBpbnZlcnNlLgogICAgQHByaXZhdGUKICAgQG1ldGhvZAogICAqLwogIF9wb3B1bGF0ZUludmVyc2UocmVsYXRpb25zaGlwRGF0YSwgaW52ZXJzZVBheWxvYWQsIGludmVyc2VQYXlsb2FkTWFwLCBpbnZlcnNlSXNNYW55KSB7CiAgICBpZiAoIXJlbGF0aW9uc2hpcERhdGEuZGF0YSkgewogICAgICAvLyBUaGlzIGlkIGRvZXNuJ3QgaGF2ZSBhbiBpbnZlcnNlLCBlZyBhIGJlbG9uZ3NUbyB3aXRoIGEgcGF5bG9hZAogICAgICAvLyB7IGRhdGE6IG51bGwgfSwgc28gdGhlcmUncyBub3RoaW5nIHRvIHBvcHVsYXRlCiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoQXJyYXkuaXNBcnJheShyZWxhdGlvbnNoaXBEYXRhLmRhdGEpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVsYXRpb25zaGlwRGF0YS5kYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHJlc291cmNlSWRlbnRpZmllciA9IHJlbGF0aW9uc2hpcERhdGEuZGF0YVtpXTsKICAgICAgICB0aGlzLl9hZGRUb0ludmVyc2UoaW52ZXJzZVBheWxvYWQsIHJlc291cmNlSWRlbnRpZmllciwgaW52ZXJzZVBheWxvYWRNYXAsIGludmVyc2VJc01hbnkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgX3Jlc291cmNlSWRlbnRpZmllciA9IHJlbGF0aW9uc2hpcERhdGEuZGF0YTsKICAgICAgdGhpcy5fYWRkVG9JbnZlcnNlKGludmVyc2VQYXlsb2FkLCBfcmVzb3VyY2VJZGVudGlmaWVyLCBpbnZlcnNlUGF5bG9hZE1hcCwgaW52ZXJzZUlzTWFueSk7CiAgICB9CiAgfQoKICAvKioKICAgQWN0dWFsbHkgYWRkIGBpbnZlcnNlUGF5bG9hZGAgdG8gYGludmVyc2VJZFRvUGF5bG9hZHNgLiAgVGhpcyBpcyBwYXJ0IG9mCiAgIGBfcG9wdWxhdGVJbnZlcnNlYCBhZnRlciB3ZSd2ZSBub3JtYWxpemVkIHRoZSBjYXNlIG9mIGByZWxhdGlvbnNoaXBEYXRhYAogICBiZWluZyBlaXRoZXIgYW4gYXJyYXkgb3IgYSBwb2pvLgogICAgV2Ugc3RpbGwgaGF2ZSB0byBoYW5kbGUgdGhlIGNhc2UgdGhhdCB0aGUgKmludmVyc2UqIHJlbGF0aW9uc2hpcCBwYXlsb2FkIG1heQogICBiZSBhbiBhcnJheSBvciBwb2pvLgogICAgQHByaXZhdGUKICAgQG1ldGhvZAogICAqLwogIF9hZGRUb0ludmVyc2UoaW52ZXJzZVBheWxvYWQsIHJlc291cmNlSWRlbnRpZmllciwgaW52ZXJzZVBheWxvYWRNYXAsIGludmVyc2VJc01hbnkpIHsKICAgIHZhciByZWxJbmZvID0gdGhpcy5fcmVsSW5mbzsKICAgIHZhciBpbnZlcnNlRGF0YSA9IGludmVyc2VQYXlsb2FkLmRhdGE7CgogICAgaWYgKHJlbEluZm8uaXNSZWZsZXhpdmUgJiYgaW52ZXJzZURhdGEgJiYgaW52ZXJzZURhdGEuaWQgPT09IHJlc291cmNlSWRlbnRpZmllci5pZCkgewogICAgICAvLyBlZyA8dXNlcjoxPi5mcmllbmRzID0gW3sgaWQ6IDEsIHR5cGU6ICd1c2VyJyB9XQogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGV4aXN0aW5nUGF5bG9hZCA9IGludmVyc2VQYXlsb2FkTWFwLmdldChyZXNvdXJjZUlkZW50aWZpZXIudHlwZSwgcmVzb3VyY2VJZGVudGlmaWVyLmlkKTsKCiAgICBpZiAoZXhpc3RpbmdQYXlsb2FkKSB7CiAgICAgIC8vIFRoZXJlIGFscmVhZHkgaXMgYW4gaW52ZXJzZSwgZWl0aGVyIGFkZCBvciBvdmVyd3JpdGUgZGVwZW5kaW5nIG9uCiAgICAgIC8vIHdoZXRoZXIgdGhlIGludmVyc2UgaXMgYSBtYW55IHJlbGF0aW9uc2hpcCBvciBub3QKICAgICAgLy8KICAgICAgaWYgKGludmVyc2VJc01hbnkpIHsKICAgICAgICB2YXIgZXhpc3RpbmdEYXRhID0gZXhpc3RpbmdQYXlsb2FkLmRhdGE7CgogICAgICAgIC8vIGluIHRoZSBjYXNlIG9mIGEgaGFzTWFueQogICAgICAgIC8vIHdlIGRvIG5vdCB3YW50IGNyZWF0ZSBhIGBkYXRhYCBhcnJheSB3aGVyZSB0aGVyZSB3YXMgbm9uZSBiZWZvcmUKICAgICAgICAvLyBpZiB3ZSBhbHNvIGhhdmUgbGlua3MsIHdoaWNoIHRoaXMgd291bGQgaW5kaWNhdGUKICAgICAgICBpZiAoZXhpc3RpbmdEYXRhKSB7CiAgICAgICAgICBleGlzdGluZ0RhdGEucHVzaChpbnZlcnNlUGF5bG9hZC5kYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhpc3RpbmdQYXlsb2FkLl9wYXJ0aWFsRGF0YSA9IGV4aXN0aW5nUGF5bG9hZC5fcGFydGlhbERhdGEgfHwgW107CiAgICAgICAgICBleGlzdGluZ1BheWxvYWQuX3BhcnRpYWxEYXRhLnB1c2goaW52ZXJzZVBheWxvYWQuZGF0YSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG1lcmdlRm9yd2FyZFBheWxvYWQoZXhpc3RpbmdQYXlsb2FkLCBpbnZlcnNlUGF5bG9hZCk7CiAgICAgICAgaW52ZXJzZVBheWxvYWRNYXAuc2V0KHJlc291cmNlSWRlbnRpZmllci50eXBlLCByZXNvdXJjZUlkZW50aWZpZXIuaWQsIGludmVyc2VQYXlsb2FkKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gZmlyc3QgdGltZSB3ZSdyZSBwb3B1bGF0aW5nIHRoZSBpbnZlcnNlIHNpZGUKICAgICAgLy8KICAgICAgaWYgKGludmVyc2VJc01hbnkpIHsKICAgICAgICBpbnZlcnNlUGF5bG9hZE1hcC5zZXQocmVzb3VyY2VJZGVudGlmaWVyLnR5cGUsIHJlc291cmNlSWRlbnRpZmllci5pZCwgewogICAgICAgICAgX3BhcnRpYWxEYXRhOiBbaW52ZXJzZVBheWxvYWQuZGF0YV0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnZlcnNlUGF5bG9hZE1hcC5zZXQocmVzb3VyY2VJZGVudGlmaWVyLnR5cGUsIHJlc291cmNlSWRlbnRpZmllci5pZCwgaW52ZXJzZVBheWxvYWQpOwogICAgICB9CiAgICB9CiAgfQoKICBnZXQgX2xoc1JlbGF0aW9uc2hpcElzTWFueSgpIHsKICAgIHZhciBtZXRhID0gdGhpcy5fcmVsSW5mby5saHNfcmVsYXRpb25zaGlwTWV0YTsKICAgIHJldHVybiBtZXRhICE9PSBudWxsICYmIG1ldGEua2luZCA9PT0gJ2hhc01hbnknOwogIH0KCiAgZ2V0IF9yaHNSZWxhdGlvbnNoaXBJc01hbnkoKSB7CiAgICB2YXIgbWV0YSA9IHRoaXMuX3JlbEluZm8ucmhzX3JlbGF0aW9uc2hpcE1ldGE7CiAgICByZXR1cm4gbWV0YSAhPT0gbnVsbCAmJiBtZXRhLmtpbmQgPT09ICdoYXNNYW55JzsKICB9CgogIC8qKgogICBSZW1vdmUgdGhlIHJlbGF0aW9uc2hpcCBpbiBgcHJldmlvdXNQYXlsb2FkYCBmcm9tIGl0cyBpbnZlcnNlKHMpLCBiZWNhdXNlCiAgIHRoaXMgcmVsYXRpb25zaGlwIHBheWxvYWQgaGFzIGp1c3QgYmVlbiB1cGRhdGVkIChlZyBiZWNhdXNlIHRoZSBzYW1lCiAgIHJlbGF0aW9uc2hpcCBoYWQgbXVsdGlwbGUgcGF5bG9hZHMgcHVzaGVkIGJlZm9yZSB0aGUgcmVsYXRpb25zaGlwIHdhcwogICBpbml0aWFsaXplZCkuCiAgICBAbWV0aG9kCiAgICovCiAgX3JlbW92ZUludmVyc2UoaWQsIHByZXZpb3VzUGF5bG9hZCwgaW52ZXJzZVBheWxvYWRNYXApIHsKICAgIHZhciBkYXRhID0gcHJldmlvdXNQYXlsb2FkICYmIHByZXZpb3VzUGF5bG9hZC5kYXRhOwogICAgdmFyIHBhcnRpYWxEYXRhID0gcHJldmlvdXNQYXlsb2FkICYmIHByZXZpb3VzUGF5bG9hZC5fcGFydGlhbERhdGE7CiAgICB2YXIgbWF5YmVEYXRhID0gZGF0YSB8fCBwYXJ0aWFsRGF0YTsKCiAgICBpZiAoIW1heWJlRGF0YSkgewogICAgICAvLyBlaXRoZXIgdGhpcyBpcyB0aGUgZmlyc3QgdGltZSB3ZSd2ZSBzZWVuIGEgcGF5bG9hZCBmb3IgdGhpcyBpZCwgb3IgaXRzCiAgICAgIC8vIHByZXZpb3VzIHBheWxvYWQgaW5kaWNhdGVkIHRoYXQgaXQgaGFkIG5vIGludmVyc2UsIGVnIGEgYmVsb25nc1RvCiAgICAgIC8vIHJlbGF0aW9uc2hpcCB3aXRoIHBheWxvYWQgeyBkYXRhOiBudWxsIH0KICAgICAgLy8KICAgICAgLy8gSW4gZWl0aGVyIGNhc2UgdGhlcmUncyBub3RoaW5nIHRoYXQgbmVlZHMgdG8gYmUgcmVtb3ZlZCBmcm9tIHRoZQogICAgICAvLyBpbnZlcnNlIG1hcCBvZiBwYXlsb2FkcwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKEFycmF5LmlzQXJyYXkobWF5YmVEYXRhKSkgewogICAgICAvLyBUT0RPOiBkaWZmIHJhdGhlciB0aGFuIHJlbW92ZWFsbCBhZGRhbGw/CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWF5YmVEYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHJlc291cmNlSWRlbnRpZmllciA9IG1heWJlRGF0YVtpXTsKICAgICAgICB0aGlzLl9yZW1vdmVGcm9tSW52ZXJzZShpZCwgcmVzb3VyY2VJZGVudGlmaWVyLCBpbnZlcnNlUGF5bG9hZE1hcCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3JlbW92ZUZyb21JbnZlcnNlKGlkLCBkYXRhLCBpbnZlcnNlUGF5bG9hZE1hcCk7CiAgICB9CiAgfQoKICAvKioKICAgUmVtb3ZlIGBpZGAgZnJvbSBpdHMgaW52ZXJzZSByZWNvcmQgd2l0aCBpZCBgaW52ZXJzZUlkYC4gIElmIHRoZSBpbnZlcnNlCiAgIHJlbGF0aW9uc2hpcCBpcyBhIGJlbG9uZ3NUbywgdGhpcyBtZWFucyBqdXN0IHNldHRpbmcgaXQgdG8gbnVsbCwgaWYgdGhlCiAgIGludmVyc2UgcmVsYXRpb25zaGlwIGlzIGEgaGFzTWFueSwgdGhlbiByZW1vdmUgdGhhdCBpZCBmcm9tIGl0cyBhcnJheSBvZiBpZHMuCiAgICBAbWV0aG9kCiAgICovCiAgX3JlbW92ZUZyb21JbnZlcnNlKGlkLCByZXNvdXJjZUlkZW50aWZpZXIsIGludmVyc2VQYXlsb2FkcykgewogICAgdmFyIGludmVyc2VQYXlsb2FkID0gaW52ZXJzZVBheWxvYWRzLmdldChyZXNvdXJjZUlkZW50aWZpZXIudHlwZSwgcmVzb3VyY2VJZGVudGlmaWVyLmlkKTsKICAgIHZhciBkYXRhID0gaW52ZXJzZVBheWxvYWQgJiYgaW52ZXJzZVBheWxvYWQuZGF0YTsKICAgIHZhciBwYXJ0aWFsRGF0YSA9IGludmVyc2VQYXlsb2FkICYmIGludmVyc2VQYXlsb2FkLl9wYXJ0aWFsRGF0YTsKCiAgICBpZiAoIWRhdGEgJiYgIXBhcnRpYWxEYXRhKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgewogICAgICBpbnZlcnNlUGF5bG9hZC5kYXRhID0gZGF0YS5maWx0ZXIoeCA9PiB4LmlkICE9PSBpZCk7CiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocGFydGlhbERhdGEpKSB7CiAgICAgIGludmVyc2VQYXlsb2FkLl9wYXJ0aWFsRGF0YSA9IHBhcnRpYWxEYXRhLmZpbHRlcih4ID0+IHguaWQgIT09IGlkKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRoaXMgbWVyZ2VzIGZvcndhcmQgbGlua3MgYW5kIG1ldGEKICAgICAgaW52ZXJzZVBheWxvYWQuZGF0YSA9IG51bGw7CiAgICB9CiAgfQp9CgovKioKICBNYW5hZ2VzIHJlbGF0aW9uc2hpcCBwYXlsb2FkcyBmb3IgYSBnaXZlbiBzdG9yZSwgZm9yIHVuaW5pdGlhbGl6ZWQKICByZWxhdGlvbnNoaXBzLiAgQWN0cyBhcyBhIHNpbmdsZSBzb3VyY2Ugb2YgdHJ1dGggKG9mIHBheWxvYWRzKSBmb3IgYm90aCBzaWRlcwogIG9mIGFuIHVuaW5pdGlhbGl6ZWQgcmVsYXRpb25zaGlwIHNvIHRoZXkgY2FuIGFncmVlIG9uIHRoZSBtb3N0IHVwLXRvLWRhdGUKICBwYXlsb2FkIHJlY2VpdmVkIHdpdGhvdXQgbmVlZGluZyB0b28gbXVjaCBlYWdlciBwcm9jZXNzaW5nIHdoZW4gdGhvc2UgcGF5bG9hZHMKICBhcmUgcHVzaGVkIGludG8gdGhlIHN0b3JlLgoKICBUaGlzIG1pbmltaXplcyB0aGUgd29yayBzcGVudCBvbiByZWxhdGlvbnNoaXBzIHRoYXQgYXJlIG5ldmVyIGluaXRpYWxpemVkLgoKICBPbmNlIHJlbGF0aW9uc2hpcHMgYXJlIGluaXRpYWxpemVkLCB0aGVpciBzdGF0ZSBpcyBtYW5hZ2VkIGluIGEgcmVsYXRpb25zaGlwCiAgc3RhdGUgb2JqZWN0IChlZyBCZWxvbmdzVG9SZWxhdGlvbnNoaXAgb3IgTWFueVJlbGF0aW9uc2hpcCkuCgoKICBAZXhhbXBsZQoKICAgIGxldCByZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXIgPSBuZXcgUmVsYXRpb25zaGlwUGF5bG9hZHNNYW5hZ2VyKHN0b3JlKTsKCiAgICBjb25zdCBVc2VyID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgaG9iYmllczogRFMuaGFzTWFueSgnaG9iYnknKQogICAgfSk7CgogICAgY29uc3QgSG9iYnkgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VyOiBEUy5iZWxvbmdzVG8oJ3VzZXInKQogICAgfSk7CgogICAgbGV0IHVzZXJQYXlsb2FkID0gewogICAgICBkYXRhOiB7CiAgICAgICAgaWQ6IDEsCiAgICAgICAgdHlwZTogJ3VzZXInLAogICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgIGhvYmJpZXM6IHsKICAgICAgICAgICAgZGF0YTogW3sKICAgICAgICAgICAgICBpZDogMiwKICAgICAgICAgICAgICB0eXBlOiAnaG9iYnknCiAgICAgICAgICAgIH1dCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgfTsKICAgIHJlbGF0aW9uc2hpcFBheWxvYWRzTWFuYWdlci5wdXNoKCd1c2VyJywgMSwgdXNlclBheWxvYWQuZGF0YS5yZWxhdGlvbnNoaXBzKTsKCiAgICByZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXIuZ2V0KCdob2JieScsIDIsICd1c2VyJykgPT09IHsKICAgICAgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkOiAxLAogICAgICAgICAgdHlwZTogJ3VzZXInCiAgICAgICAgfQogICAgICB9CiAgICB9CgogIEBwcml2YXRlCiAgQGNsYXNzIFJlbGF0aW9uc2hpcFBheWxvYWRzTWFuYWdlcgoqLwoKLy8gaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnOwpjbGFzcyBSZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXIgewogIGNvbnN0cnVjdG9yKHN0b3JlKSB7CiAgICB0aGlzLl9zdG9yZSA9IHN0b3JlOwogICAgLy8gY2FjaGUgb2YgYFJlbGF0aW9uc2hpcFBheWxvYWRgcwogICAgdGhpcy5fY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5faW52ZXJzZUxvb2t1cENhY2hlID0gbmV3IFR5cGVDYWNoZSgpOwogIH0KCiAgLyoqCiAgICBGaW5kIHRoZSBwYXlsb2FkIGZvciB0aGUgZ2l2ZW4gcmVsYXRpb25zaGlwIG9mIHRoZSBnaXZlbiBtb2RlbC4KICAgICBSZXR1cm5zIHRoZSBwYXlsb2FkIGZvciB0aGUgZ2l2ZW4gcmVsYXRpb25zaGlwLCB3aGV0aGVyIHJhdyBvciBjb21wdXRlZCBmcm9tCiAgICB0aGUgcGF5bG9hZCBvZiB0aGUgaW52ZXJzZSByZWxhdGlvbnNoaXAuCiAgICAgQGV4YW1wbGUKICAgICAgIHJlbGF0aW9uc2hpcFBheWxvYWRzTWFuYWdlci5nZXQoJ2hvYmJ5JywgMiwgJ3VzZXInKSA9PT0gewogICAgICAgIHsKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgaWQ6IDEsCiAgICAgICAgICAgIHR5cGU6ICd1c2VyJwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgIEBtZXRob2QKICAqLwogIGdldChtb2RlbE5hbWUsIGlkLCByZWxhdGlvbnNoaXBOYW1lKSB7CiAgICB2YXIgcmVsYXRpb25zaGlwUGF5bG9hZHMgPSB0aGlzLl9nZXRSZWxhdGlvbnNoaXBQYXlsb2Fkcyhtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcE5hbWUsIGZhbHNlKTsKICAgIHJldHVybiByZWxhdGlvbnNoaXBQYXlsb2FkcyAmJiByZWxhdGlvbnNoaXBQYXlsb2Fkcy5nZXQobW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwTmFtZSk7CiAgfQoKICAvKioKICAgIFB1c2ggYSBtb2RlbCdzIHJlbGF0aW9uc2hpcHMgcGF5bG9hZCBpbnRvIHRoaXMgY2FjaGUuCiAgICAgQGV4YW1wbGUKICAgICAgIGxldCB1c2VyUGF5bG9hZCA9IHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpZDogMSwKICAgICAgICAgIHR5cGU6ICd1c2VyJywKICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHsKICAgICAgICAgICAgaG9iYmllczogewogICAgICAgICAgICAgIGRhdGE6IFt7CiAgICAgICAgICAgICAgICBpZDogMiwKICAgICAgICAgICAgICAgIHR5cGU6ICdob2JieScKICAgICAgICAgICAgICB9XQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgfTsKICAgICAgcmVsYXRpb25zaGlwUGF5bG9hZHNNYW5hZ2VyLnB1c2goJ3VzZXInLCAxLCB1c2VyUGF5bG9hZC5kYXRhLnJlbGF0aW9uc2hpcHMpOwogICAgIEBtZXRob2QKICAqLwogIHB1c2gobW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwc0RhdGEpIHsKICAgIGlmICghcmVsYXRpb25zaGlwc0RhdGEpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIE9iamVjdC5rZXlzKHJlbGF0aW9uc2hpcHNEYXRhKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBQYXlsb2FkcyA9IHRoaXMuX2dldFJlbGF0aW9uc2hpcFBheWxvYWRzKG1vZGVsTmFtZSwga2V5LCB0cnVlKTsKICAgICAgaWYgKHJlbGF0aW9uc2hpcFBheWxvYWRzKSB7CiAgICAgICAgcmVsYXRpb25zaGlwUGF5bG9hZHMucHVzaChtb2RlbE5hbWUsIGlkLCBrZXksIHJlbGF0aW9uc2hpcHNEYXRhW2tleV0pOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qKgogICAgVW5sb2FkIGEgbW9kZWwncyByZWxhdGlvbnNoaXBzIHBheWxvYWQuCiAgICAgQG1ldGhvZAogICovCiAgdW5sb2FkKG1vZGVsTmFtZSwgaWQpIHsKICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5fc3RvcmUuX21vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICB2YXIgcmVsYXRpb25zaGlwc0J5TmFtZSA9IEVtYmVyLmdldChtb2RlbENsYXNzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpOwogICAgcmVsYXRpb25zaGlwc0J5TmFtZS5mb3JFYWNoKChfLCByZWxhdGlvbnNoaXBOYW1lKSA9PiB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBQYXlsb2FkcyA9IHRoaXMuX2dldFJlbGF0aW9uc2hpcFBheWxvYWRzKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSwgZmFsc2UpOwogICAgICBpZiAocmVsYXRpb25zaGlwUGF5bG9hZHMpIHsKICAgICAgICByZWxhdGlvbnNoaXBQYXlsb2Fkcy51bmxvYWQobW9kZWxOYW1lLCBpZCwgcmVsYXRpb25zaGlwTmFtZSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICBGaW5kIHRoZSBSZWxhdGlvbnNoaXBQYXlsb2FkcyBvYmplY3QgZm9yIHRoZSBnaXZlbiByZWxhdGlvbnNoaXAuICBUaGUgc2FtZQogICAgUmVsYXRpb25zaGlwUGF5bG9hZHMgb2JqZWN0IGlzIHJldHVybmVkIGZvciBlaXRoZXIgc2lkZSBvZiBhIHJlbGF0aW9uc2hpcC4KICAgICBAZXhhbXBsZQogICAgICAgY29uc3QgVXNlciA9IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgICAgaG9iYmllczogRFMuaGFzTWFueSgnaG9iYnknKQogICAgICB9KTsKICAgICAgIGNvbnN0IEhvYmJ5ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgICB1c2VyOiBEUy5iZWxvbmdzVG8oJ3VzZXInKQogICAgICB9KTsKICAgICAgIHJlbGF0aW9uc2hpcFBheWxvYWRzLmdldCgndXNlcicsICdob2JiaWVzJykgPT09IHJlbGF0aW9uc2hpcFBheWxvYWRzLmdldCgnaG9iYnknLCAndXNlcicpOwogICAgIFRoZSBzaWduYXR1cmUgaGFzIGEgc29tZXdoYXQgbGFyZ2UgYXJpdHkgdG8gYXZvaWQgZXh0cmEgd29yaywgc3VjaCBhcwogICAgICBhKSAgc3RyaW5nIG1hbmlwdWxhdGlvbiAmIGFsbG9jYXRpb24gd2l0aCBgbW9kZWxOYW1lYCBhbmQKICAgICAgICAgYHJlbGF0aW9uc2hpcE5hbWVgCiAgICAgIGIpICByZXBlYXRlZGx5IGdldHRpbmcgYHJlbGF0aW9uc2hpcHNCeU5hbWVgIHZpYSBgRW1iZXIuZ2V0YAogICAgICBAcHJpdmF0ZQogICAgQG1ldGhvZAogICovCiAgX2dldFJlbGF0aW9uc2hpcFBheWxvYWRzKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSwgaW5pdCkgewogICAgdmFyIHJlbEluZm8gPSB0aGlzLmdldFJlbGF0aW9uc2hpcEluZm8obW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKTsKCiAgICBpZiAocmVsSW5mbyA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGNhY2hlID0gdGhpcy5fY2FjaGVbcmVsSW5mby5saHNfa2V5XTsKCiAgICBpZiAoIWNhY2hlICYmIGluaXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVSZWxhdGlvbnNoaXBQYXlsb2FkcyhyZWxJbmZvKTsKICAgIH0KCiAgICByZXR1cm4gY2FjaGU7CiAgfQoKICBnZXRSZWxhdGlvbnNoaXBJbmZvKG1vZGVsTmFtZSwgcmVsYXRpb25zaGlwTmFtZSkgewogICAgdmFyIGludmVyc2VDYWNoZSA9IHRoaXMuX2ludmVyc2VMb29rdXBDYWNoZTsKICAgIHZhciBzdG9yZSA9IHRoaXMuX3N0b3JlOwogICAgdmFyIGNhY2hlZCA9IGludmVyc2VDYWNoZS5nZXQobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKTsKCiAgICAvLyBDQVNFOiBXZSBoYXZlIGEgY2FjaGVkIHJlc29sdXRpb24gKG51bGwgaWYgbm8gcmVsYXRpb25zaGlwIGV4aXN0cykKICAgIGlmIChjYWNoZWQgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQoKICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUuX21vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICB2YXIgcmVsYXRpb25zaGlwc0J5TmFtZSA9IEVtYmVyLmdldChtb2RlbENsYXNzLCAncmVsYXRpb25zaGlwc0J5TmFtZScpOwoKICAgIC8vIENBU0U6IFdlIGRvbid0IGhhdmUgYSByZWxhdGlvbnNoaXAgYXQgYWxsCiAgICBpZiAoIXJlbGF0aW9uc2hpcHNCeU5hbWUuaGFzKHJlbGF0aW9uc2hpcE5hbWUpKSB7CiAgICAgIGludmVyc2VDYWNoZS5zZXQobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lLCBudWxsKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIGludmVyc2VNZXRhID0gbW9kZWxDbGFzcy5pbnZlcnNlRm9yKHJlbGF0aW9uc2hpcE5hbWUsIHN0b3JlKTsKICAgIHZhciByZWxhdGlvbnNoaXBNZXRhID0gcmVsYXRpb25zaGlwc0J5TmFtZS5nZXQocmVsYXRpb25zaGlwTmFtZSk7CiAgICB2YXIgc2VsZklzUG9seW1vcnBoaWMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMucG9seW1vcnBoaWMgPT09IHRydWU7CiAgICB2YXIgaW52ZXJzZUJhc2VNb2RlbE5hbWUgPSByZWxhdGlvbnNoaXBNZXRhLnR5cGU7CgogICAgLy8gQ0FTRTogV2UgaGF2ZSBubyBpbnZlcnNlCiAgICBpZiAoIWludmVyc2VNZXRhKSB7CiAgICAgIHZhciBfaW5mbyA9IHsKICAgICAgICBsaHNfa2V5OiBgJHttb2RlbE5hbWV9OiR7cmVsYXRpb25zaGlwTmFtZX1gLAogICAgICAgIGxoc19tb2RlbE5hbWVzOiBbbW9kZWxOYW1lXSwKICAgICAgICBsaHNfYmFzZU1vZGVsTmFtZTogbW9kZWxOYW1lLAogICAgICAgIGxoc19yZWxhdGlvbnNoaXBOYW1lOiByZWxhdGlvbnNoaXBOYW1lLAogICAgICAgIGxoc19yZWxhdGlvbnNoaXBNZXRhOiByZWxhdGlvbnNoaXBNZXRhLAogICAgICAgIGxoc19pc1BvbHltb3JwaGljOiBzZWxmSXNQb2x5bW9ycGhpYywKICAgICAgICByaHNfa2V5OiAnJywKICAgICAgICByaHNfbW9kZWxOYW1lczogW10sCiAgICAgICAgcmhzX2Jhc2VNb2RlbE5hbWU6IGludmVyc2VCYXNlTW9kZWxOYW1lLAogICAgICAgIHJoc19yZWxhdGlvbnNoaXBOYW1lOiAnJywKICAgICAgICByaHNfcmVsYXRpb25zaGlwTWV0YTogbnVsbCwKICAgICAgICByaHNfaXNQb2x5bW9ycGhpYzogZmFsc2UsCiAgICAgICAgaGFzSW52ZXJzZTogZmFsc2UsCiAgICAgICAgaXNTZWxmUmVmZXJlbnRpYWw6IGZhbHNlLCAvLyBtb2RlbE5hbWUgPT09IGludmVyc2VCYXNlTW9kZWxOYW1lLAogICAgICAgIGlzUmVmbGV4aXZlOiBmYWxzZQogICAgICB9OwoKICAgICAgaW52ZXJzZUNhY2hlLnNldChtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcE5hbWUsIF9pbmZvKTsKCiAgICAgIHJldHVybiBfaW5mbzsKICAgIH0KCiAgICAvLyBDQVNFOiBXZSBkbyBoYXZlIGFuIGludmVyc2UKCiAgICB2YXIgaW52ZXJzZVJlbGF0aW9uc2hpcE5hbWUgPSBpbnZlcnNlTWV0YS5uYW1lOwogICAgdmFyIGludmVyc2VSZWxhdGlvbnNoaXBNZXRhID0gRW1iZXIuZ2V0KGludmVyc2VNZXRhLnR5cGUsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZ2V0KGludmVyc2VSZWxhdGlvbnNoaXBOYW1lKTsKICAgIHZhciBiYXNlTW9kZWxOYW1lID0gaW52ZXJzZVJlbGF0aW9uc2hpcE1ldGEudHlwZTsKICAgIHZhciBpc1NlbGZSZWZlcmVudGlhbCA9IGJhc2VNb2RlbE5hbWUgPT09IGludmVyc2VCYXNlTW9kZWxOYW1lOwoKICAgIC8vIFRPRE8gd2Ugd2FudCB0byBhc3NlcnQgdGhpcyBidXQgdGhpcyBicmVha3MgYWxsIG9mIG91ciBzaG9kZGlseSB3cml0dGVuIHRlc3RzCiAgICAvKgogICAgaWYgKERFQlVHKSB7CiAgICAgIGxldCBpbnZlcnNlRG91YmxlQ2hlY2sgPSBpbnZlcnNlTWV0YS50eXBlLmludmVyc2VGb3IoaW52ZXJzZVJlbGF0aW9uc2hpcE5hbWUsIHN0b3JlKTsKICAgICAgIGFzc2VydChgVGhlICR7aW52ZXJzZUJhc2VNb2RlbE5hbWV9OiR7aW52ZXJzZVJlbGF0aW9uc2hpcE5hbWV9IHJlbGF0aW9uc2hpcCBkZWNsYXJlcyAnaW52ZXJzZTogbnVsbCcsIGJ1dCBpdCB3YXMgcmVzb2x2ZWQgYXMgdGhlIGludmVyc2UgZm9yICR7YmFzZU1vZGVsTmFtZX06JHtyZWxhdGlvbnNoaXBOYW1lfS5gLCBpbnZlcnNlRG91YmxlQ2hlY2spOwogICAgfQogICAgKi8KCiAgICAvLyBDQVNFOiBXZSBtYXkgaGF2ZSBhbHJlYWR5IGRpc2NvdmVyZWQgdGhlIGludmVyc2UgZm9yIHRoZSBiYXNlTW9kZWxOYW1lCiAgICAvLyBDQVNFOiBXZSBoYXZlIGFscmVhZHkgZGlzY292ZXJlZCB0aGUgaW52ZXJzZQogICAgY2FjaGVkID0gaW52ZXJzZUNhY2hlLmdldChiYXNlTW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lKSB8fCBpbnZlcnNlQ2FjaGUuZ2V0KGludmVyc2VCYXNlTW9kZWxOYW1lLCBpbnZlcnNlUmVsYXRpb25zaGlwTmFtZSk7CiAgICBpZiAoY2FjaGVkKSB7CiAgICAgIC8vIFRPRE8gdGhpcyBhc3NlcnQgY2FuIGJlIHJlbW92ZWQgaWYgdGhlIGFib3ZlIGFzc2VydCBpcyBlbmFibGVkCiAgICAgICh0cnVlICYmICEoY2FjaGVkLmhhc0ludmVyc2UgIT09IGZhbHNlKSAmJiBFbWJlci5hc3NlcnQoYFRoZSAke2ludmVyc2VCYXNlTW9kZWxOYW1lfToke2ludmVyc2VSZWxhdGlvbnNoaXBOYW1lfSByZWxhdGlvbnNoaXAgZGVjbGFyZXMgJ2ludmVyc2U6IG51bGwnLCBidXQgaXQgd2FzIHJlc29sdmVkIGFzIHRoZSBpbnZlcnNlIGZvciAke2Jhc2VNb2RlbE5hbWV9OiR7cmVsYXRpb25zaGlwTmFtZX0uYCwgY2FjaGVkLmhhc0ludmVyc2UgIT09IGZhbHNlKSk7CgoKICAgICAgdmFyIGlzTEhTID0gY2FjaGVkLmxoc19iYXNlTW9kZWxOYW1lID09PSBiYXNlTW9kZWxOYW1lOwogICAgICB2YXIgbW9kZWxOYW1lcyA9IGlzTEhTID8gY2FjaGVkLmxoc19tb2RlbE5hbWVzIDogY2FjaGVkLnJoc19tb2RlbE5hbWVzOwogICAgICAvLyBtYWtlIHRoaXMgbG9va3VwIGVhc2llciBpbiB0aGUgZnV0dXJlIGJ5IGNhY2hpbmcgdGhlIGtleQogICAgICBtb2RlbE5hbWVzLnB1c2gobW9kZWxOYW1lKTsKICAgICAgaW52ZXJzZUNhY2hlLnNldChtb2RlbE5hbWUsIHJlbGF0aW9uc2hpcE5hbWUsIGNhY2hlZCk7CgogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQoKICAgIHZhciBpbmZvID0gewogICAgICBsaHNfa2V5OiBgJHtiYXNlTW9kZWxOYW1lfToke3JlbGF0aW9uc2hpcE5hbWV9YCwKICAgICAgbGhzX21vZGVsTmFtZXM6IFttb2RlbE5hbWVdLAogICAgICBsaHNfYmFzZU1vZGVsTmFtZTogYmFzZU1vZGVsTmFtZSwKICAgICAgbGhzX3JlbGF0aW9uc2hpcE5hbWU6IHJlbGF0aW9uc2hpcE5hbWUsCiAgICAgIGxoc19yZWxhdGlvbnNoaXBNZXRhOiByZWxhdGlvbnNoaXBNZXRhLAogICAgICBsaHNfaXNQb2x5bW9ycGhpYzogc2VsZklzUG9seW1vcnBoaWMsCiAgICAgIHJoc19rZXk6IGAke2ludmVyc2VCYXNlTW9kZWxOYW1lfToke2ludmVyc2VSZWxhdGlvbnNoaXBOYW1lfWAsCiAgICAgIHJoc19tb2RlbE5hbWVzOiBbXSwKICAgICAgcmhzX2Jhc2VNb2RlbE5hbWU6IGludmVyc2VCYXNlTW9kZWxOYW1lLAogICAgICByaHNfcmVsYXRpb25zaGlwTmFtZTogaW52ZXJzZVJlbGF0aW9uc2hpcE5hbWUsCiAgICAgIHJoc19yZWxhdGlvbnNoaXBNZXRhOiBpbnZlcnNlUmVsYXRpb25zaGlwTWV0YSwKICAgICAgcmhzX2lzUG9seW1vcnBoaWM6IGludmVyc2VSZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiBpbnZlcnNlUmVsYXRpb25zaGlwTWV0YS5vcHRpb25zLnBvbHltb3JwaGljID09PSB0cnVlLAogICAgICBoYXNJbnZlcnNlOiB0cnVlLAogICAgICBpc1NlbGZSZWZlcmVudGlhbCwKICAgICAgaXNSZWZsZXhpdmU6IGlzU2VsZlJlZmVyZW50aWFsICYmIHJlbGF0aW9uc2hpcE5hbWUgPT09IGludmVyc2VSZWxhdGlvbnNoaXBOYW1lCiAgICB9OwoKICAgIC8vIENyZWF0ZSBlbnRyaWVzIGZvciB0aGUgYmFzZU1vZGVsTmFtZSBhcyB3ZWxsIGFzIG1vZGVsTmFtZSB0byBzcGVlZCB1cAogICAgLy8gIGludmVyc2UgbG9va3VwcwogICAgaW52ZXJzZUNhY2hlLnNldChiYXNlTW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lLCBpbmZvKTsKICAgIGludmVyc2VDYWNoZS5zZXQobW9kZWxOYW1lLCByZWxhdGlvbnNoaXBOYW1lLCBpbmZvKTsKCiAgICAvLyBHcmVlZGlseSBwb3B1bGF0ZSB0aGUgaW52ZXJzZQogICAgaW52ZXJzZUNhY2hlLnNldChpbnZlcnNlQmFzZU1vZGVsTmFtZSwgaW52ZXJzZVJlbGF0aW9uc2hpcE5hbWUsIGluZm8pOwoKICAgIHJldHVybiBpbmZvOwogIH0KCiAgLyoqCiAgICBDcmVhdGUgdGhlIGBSZWxhdGlvbnNoaXBzUGF5bG9hZGAgZm9yIHRoZSByZWxhdGlvbnNoaXAgYG1vZGVsTmFtZWAsIGByZWxhdGlvbnNoaXBOYW1lYCwgYW5kIGl0cyBpbnZlcnNlLgogICAgIEBwcml2YXRlCiAgICBAbWV0aG9kCiAgKi8KICBfaW5pdGlhbGl6ZVJlbGF0aW9uc2hpcFBheWxvYWRzKHJlbEluZm8pIHsKICAgIHZhciBsaHNLZXkgPSByZWxJbmZvLmxoc19rZXk7CiAgICB2YXIgcmhzS2V5ID0gcmVsSW5mby5yaHNfa2V5OwogICAgdmFyIGV4aXN0aW5nUGF5bG9hZHMgPSB0aGlzLl9jYWNoZVtsaHNLZXldOwoKICAgIGlmIChyZWxJbmZvLmhhc0ludmVyc2UgPT09IHRydWUgJiYgcmVsSW5mby5yaHNfaXNQb2x5bW9ycGhpYyA9PT0gdHJ1ZSkgewogICAgICBleGlzdGluZ1BheWxvYWRzID0gdGhpcy5fY2FjaGVbcmhzS2V5XTsKCiAgICAgIGlmIChleGlzdGluZ1BheWxvYWRzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLl9jYWNoZVtsaHNLZXldID0gZXhpc3RpbmdQYXlsb2FkczsKICAgICAgICByZXR1cm4gZXhpc3RpbmdQYXlsb2FkczsKICAgICAgfQogICAgfQoKICAgIC8vIHBvcHVsYXRlIHRoZSBjYWNoZSBmb3IgYm90aCBzaWRlcyBvZiB0aGUgcmVsYXRpb25zaGlwLCBhcyB0aGV5IGJvdGggdXNlCiAgICAvLyB0aGUgc2FtZSBgUmVsYXRpb25zaGlwUGF5bG9hZHNgLgogICAgLy8KICAgIC8vIFRoaXMgd29ya3Mgb3V0IGJldHRlciB0aGFuIGNyZWF0aW5nIGEgc2luZ2xlIGNvbW1vbiBrZXksIGJlY2F1c2UgdG8KICAgIC8vIGNvbXB1dGUgdGhhdCBrZXkgd2Ugd291bGQgbmVlZCB0byBkbyB3b3JrIHRvIGxvb2sgdXAgdGhlIGludmVyc2UKICAgIC8vCiAgICB2YXIgY2FjaGUgPSB0aGlzLl9jYWNoZVtsaHNLZXldID0gbmV3IFJlbGF0aW9uc2hpcFBheWxvYWRzKHJlbEluZm8pOwoKICAgIGlmIChyZWxJbmZvLmhhc0ludmVyc2UgPT09IHRydWUpIHsKICAgICAgdGhpcy5fY2FjaGVbcmhzS2V5XSA9IGNhY2hlOwogICAgfQoKICAgIHJldHVybiBjYWNoZTsKICB9Cn0KCmZ1bmN0aW9uIHBheWxvYWRJc05vdEJsYW5rKGFkYXB0ZXJQYXlsb2FkKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYWRhcHRlclBheWxvYWQpKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9IGVsc2UgewogICAgcmV0dXJuIE9iamVjdC5rZXlzKGFkYXB0ZXJQYXlsb2FkIHx8IHt9KS5sZW5ndGg7CiAgfQp9CgpmdW5jdGlvbiBfZmluZChhZGFwdGVyLCBzdG9yZSwgbW9kZWxDbGFzcywgaWQsIGludGVybmFsTW9kZWwsIG9wdGlvbnMpIHsKICB7CiAgICBpbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTsKICB9CiAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKICB2YXIgeyBtb2RlbE5hbWUgfSA9IGludGVybmFsTW9kZWw7CiAgdmFyIHByb21pc2UgPSBFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gewogICAgcmV0dXJuIGFkYXB0ZXIuZmluZFJlY29yZChzdG9yZSwgbW9kZWxDbGFzcywgaWQsIHNuYXBzaG90KTsKICB9KTsKICB2YXIgbGFiZWwgPSBgRFM6IEhhbmRsZSBBZGFwdGVyI2ZpbmRSZWNvcmQgb2YgJyR7bW9kZWxOYW1lfScgd2l0aCBpZDogJyR7aWR9J2A7CgogIHByb21pc2UgPSBndWFyZERlc3Ryb3llZFN0b3JlKHByb21pc2UsIHN0b3JlLCBsYWJlbCk7CgogIHJldHVybiBwcm9taXNlLnRoZW4oYWRhcHRlclBheWxvYWQgPT4gewogICAgKHRydWUgJiYgIShwYXlsb2FkSXNOb3RCbGFuayhhZGFwdGVyUGF5bG9hZCkpICYmIEVtYmVyLmFzc2VydChgWW91IG1hZGUgYSAnZmluZFJlY29yZCcgcmVxdWVzdCBmb3IgYSAnJHttb2RlbE5hbWV9JyB3aXRoIGlkICcke2lkfScsIGJ1dCB0aGUgYWRhcHRlcidzIHJlc3BvbnNlIGRpZCBub3QgaGF2ZSBhbnkgZGF0YWAsIHBheWxvYWRJc05vdEJsYW5rKGFkYXB0ZXJQYXlsb2FkKSkpOwoKICAgIHZhciBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoc3RvcmUsIGFkYXB0ZXIsIG1vZGVsTmFtZSk7CiAgICB2YXIgcGF5bG9hZCA9IG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgaWQsICdmaW5kUmVjb3JkJyk7CiAgICAodHJ1ZSAmJiAhKCFBcnJheS5pc0FycmF5KHBheWxvYWQuZGF0YSkpICYmIEVtYmVyLmFzc2VydChgRW1iZXIgRGF0YSBleHBlY3RlZCB0aGUgcHJpbWFyeSBkYXRhIHJldHVybmVkIGZyb20gYSAnZmluZFJlY29yZCcgcmVzcG9uc2UgdG8gYmUgYW4gb2JqZWN0IGJ1dCBpbnN0ZWFkIGl0IGZvdW5kIGFuIGFycmF5LmAsICFBcnJheS5pc0FycmF5KHBheWxvYWQuZGF0YSkpKTsKICAgICh0cnVlICYmIEVtYmVyLndhcm4oYFlvdSByZXF1ZXN0ZWQgYSByZWNvcmQgb2YgdHlwZSAnJHttb2RlbE5hbWV9JyB3aXRoIGlkICcke2lkfScgYnV0IHRoZSBhZGFwdGVyIHJldHVybmVkIGEgcGF5bG9hZCB3aXRoIHByaW1hcnkgZGF0YSBoYXZpbmcgYW4gaWQgb2YgJyR7cGF5bG9hZC5kYXRhLmlkfScuIFVzZSAnc3RvcmUuZmluZFJlY29yZCgpJyB3aGVuIHRoZSByZXF1ZXN0ZWQgaWQgaXMgdGhlIHNhbWUgYXMgdGhlIG9uZSByZXR1cm5lZCBieSB0aGUgYWRhcHRlci4gSW4gb3RoZXIgY2FzZXMgdXNlICdzdG9yZS5xdWVyeVJlY29yZCgpJyBpbnN0ZWFkIGh0dHBzOi8vZW1iZXJqcy5jb20vYXBpL2RhdGEvY2xhc3Nlcy9EUy5TdG9yZS5odG1sI21ldGhvZF9xdWVyeVJlY29yZGAsIHBheWxvYWQuZGF0YS5pZCA9PT0gaWQsIHsKICAgICAgaWQ6ICdkcy5zdG9yZS5maW5kUmVjb3JkLmlkLW1pc21hdGNoJwogICAgfSkpOwoKCiAgICByZXR1cm4gc3RvcmUuX3B1c2gocGF5bG9hZCk7CiAgfSwgZXJyb3IgPT4gewogICAgaW50ZXJuYWxNb2RlbC5ub3RGb3VuZCgpOwogICAgaWYgKGludGVybmFsTW9kZWwuaXNFbXB0eSgpKSB7CiAgICAgIGludGVybmFsTW9kZWwudW5sb2FkUmVjb3JkKCk7CiAgICB9CgogICAgdGhyb3cgZXJyb3I7CiAgfSwgYERTOiBFeHRyYWN0IHBheWxvYWQgb2YgJyR7bW9kZWxOYW1lfSdgKTsKfQoKZnVuY3Rpb24gX2ZpbmRNYW55KGFkYXB0ZXIsIHN0b3JlLCBtb2RlbE5hbWUsIGlkcywgaW50ZXJuYWxNb2RlbHMpIHsKICB7CiAgICBpbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTsKICB9CiAgdmFyIHNuYXBzaG90cyA9IEVtYmVyLkEoaW50ZXJuYWxNb2RlbHMpLmludm9rZSgnY3JlYXRlU25hcHNob3QnKTsKICB2YXIgbW9kZWxDbGFzcyA9IHN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7IC8vIGBhZGFwdGVyLmZpbmRNYW55YCBnZXRzIHRoZSBtb2RlbENsYXNzIHN0aWxsCiAgdmFyIHByb21pc2UgPSBhZGFwdGVyLmZpbmRNYW55KHN0b3JlLCBtb2RlbENsYXNzLCBpZHMsIHNuYXBzaG90cyk7CiAgdmFyIGxhYmVsID0gYERTOiBIYW5kbGUgQWRhcHRlciNmaW5kTWFueSBvZiAnJHttb2RlbE5hbWV9J2A7CgogIGlmIChwcm9taXNlID09PSB1bmRlZmluZWQpIHsKICAgIHRocm93IG5ldyBFcnJvcignYWRhcHRlci5maW5kTWFueSByZXR1cm5lZCB1bmRlZmluZWQsIHRoaXMgd2FzIHZlcnkgbGlrZWx5IGEgbWlzdGFrZScpOwogIH0KCiAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICAodHJ1ZSAmJiAhKHBheWxvYWRJc05vdEJsYW5rKGFkYXB0ZXJQYXlsb2FkKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbWFkZSBhICdmaW5kTWFueScgcmVxdWVzdCBmb3IgJyR7bW9kZWxOYW1lfScgcmVjb3JkcyB3aXRoIGlkcyAnWyR7aWRzfV0nLCBidXQgdGhlIGFkYXB0ZXIncyByZXNwb25zZSBkaWQgbm90IGhhdmUgYW55IGRhdGFgLCBwYXlsb2FkSXNOb3RCbGFuayhhZGFwdGVyUGF5bG9hZCkpKTsKCiAgICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCBtb2RlbE5hbWUpOwogICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIG51bGwsICdmaW5kTWFueScpOwogICAgcmV0dXJuIHN0b3JlLl9wdXNoKHBheWxvYWQpOwogIH0sIG51bGwsIGBEUzogRXh0cmFjdCBwYXlsb2FkIG9mICR7bW9kZWxOYW1lfWApOwp9CgpmdW5jdGlvbiBfZmluZEhhc01hbnkoYWRhcHRlciwgc3RvcmUsIGludGVybmFsTW9kZWwsIGxpbmssIHJlbGF0aW9uc2hpcCkgewogIHsKICAgIGluY3JlbWVudFJlcXVlc3RDb3VudCgpOwogIH0KICB2YXIgc25hcHNob3QgPSBpbnRlcm5hbE1vZGVsLmNyZWF0ZVNuYXBzaG90KCk7CiAgdmFyIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihyZWxhdGlvbnNoaXAudHlwZSk7CiAgdmFyIHByb21pc2UgPSBhZGFwdGVyLmZpbmRIYXNNYW55KHN0b3JlLCBzbmFwc2hvdCwgbGluaywgcmVsYXRpb25zaGlwKTsKICB2YXIgbGFiZWwgPSBgRFM6IEhhbmRsZSBBZGFwdGVyI2ZpbmRIYXNNYW55IG9mICcke2ludGVybmFsTW9kZWwubW9kZWxOYW1lfScgOiAnJHtyZWxhdGlvbnNoaXAudHlwZX0nYDsKCiAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKICBwcm9taXNlID0gX2d1YXJkKHByb21pc2UsIF9iaW5kKF9vYmplY3RJc0FsaXZlLCBpbnRlcm5hbE1vZGVsKSk7CgogIHJldHVybiBwcm9taXNlLnRoZW4oYWRhcHRlclBheWxvYWQgPT4gewogICAgKHRydWUgJiYgIShwYXlsb2FkSXNOb3RCbGFuayhhZGFwdGVyUGF5bG9hZCkpICYmIEVtYmVyLmFzc2VydChgWW91IG1hZGUgYSAnZmluZEhhc01hbnknIHJlcXVlc3QgZm9yIGEgJHtpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZX0ncyAnJHtyZWxhdGlvbnNoaXAua2V5fScgcmVsYXRpb25zaGlwLCB1c2luZyBsaW5rICcke2xpbmt9JyAsIGJ1dCB0aGUgYWRhcHRlcidzIHJlc3BvbnNlIGRpZCBub3QgaGF2ZSBhbnkgZGF0YWAsIHBheWxvYWRJc05vdEJsYW5rKGFkYXB0ZXJQYXlsb2FkKSkpOwoKICAgIHZhciBzZXJpYWxpemVyID0gc2VyaWFsaXplckZvckFkYXB0ZXIoc3RvcmUsIGFkYXB0ZXIsIHJlbGF0aW9uc2hpcC50eXBlKTsKICAgIHZhciBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIGFkYXB0ZXJQYXlsb2FkLCBudWxsLCAnZmluZEhhc01hbnknKTsKICAgIHZhciBpbnRlcm5hbE1vZGVsQXJyYXkgPSBzdG9yZS5fcHVzaChwYXlsb2FkKTsKCiAgICBpbnRlcm5hbE1vZGVsQXJyYXkubWV0YSA9IHBheWxvYWQubWV0YTsKICAgIHJldHVybiBpbnRlcm5hbE1vZGVsQXJyYXk7CiAgfSwgbnVsbCwgYERTOiBFeHRyYWN0IHBheWxvYWQgb2YgJyR7aW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9JyA6IGhhc01hbnkgJyR7cmVsYXRpb25zaGlwLnR5cGV9J2ApOwp9CgpmdW5jdGlvbiBfZmluZEJlbG9uZ3NUbyhhZGFwdGVyLCBzdG9yZSwgaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwKSB7CiAgewogICAgaW5jcmVtZW50UmVxdWVzdENvdW50KCk7CiAgfQogIHZhciBzbmFwc2hvdCA9IGludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3QoKTsKICB2YXIgbW9kZWxDbGFzcyA9IHN0b3JlLm1vZGVsRm9yKHJlbGF0aW9uc2hpcC50eXBlKTsKICB2YXIgcHJvbWlzZSA9IGFkYXB0ZXIuZmluZEJlbG9uZ3NUbyhzdG9yZSwgc25hcHNob3QsIGxpbmssIHJlbGF0aW9uc2hpcCk7CiAgdmFyIGxhYmVsID0gYERTOiBIYW5kbGUgQWRhcHRlciNmaW5kQmVsb25nc1RvIG9mICR7aW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9IDogJHtyZWxhdGlvbnNoaXAudHlwZX1gOwoKICBwcm9taXNlID0gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCBzdG9yZSwgbGFiZWwpOwogIHByb21pc2UgPSBfZ3VhcmQocHJvbWlzZSwgX2JpbmQoX29iamVjdElzQWxpdmUsIGludGVybmFsTW9kZWwpKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCByZWxhdGlvbnNoaXAudHlwZSk7CiAgICB2YXIgcGF5bG9hZCA9IG5vcm1hbGl6ZVJlc3BvbnNlSGVscGVyKHNlcmlhbGl6ZXIsIHN0b3JlLCBtb2RlbENsYXNzLCBhZGFwdGVyUGF5bG9hZCwgbnVsbCwgJ2ZpbmRCZWxvbmdzVG8nKTsKCiAgICBpZiAoIXBheWxvYWQuZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gc3RvcmUuX3B1c2gocGF5bG9hZCk7CiAgfSwgbnVsbCwgYERTOiBFeHRyYWN0IHBheWxvYWQgb2YgJHtpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZX0gOiAke3JlbGF0aW9uc2hpcC50eXBlfWApOwp9CgpmdW5jdGlvbiBfZmluZEFsbChhZGFwdGVyLCBzdG9yZSwgbW9kZWxOYW1lLCBzaW5jZVRva2VuLCBvcHRpb25zKSB7CiAgewogICAgaW5jcmVtZW50UmVxdWVzdENvdW50KCk7CiAgfQogIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsgLy8gYWRhcHRlci5maW5kQWxsIGRlcGVuZHMgb24gdGhlIGNsYXNzCiAgdmFyIHJlY29yZEFycmF5ID0gc3RvcmUucGVla0FsbChtb2RlbE5hbWUpOwogIHZhciBzbmFwc2hvdEFycmF5ID0gcmVjb3JkQXJyYXkuX2NyZWF0ZVNuYXBzaG90KG9wdGlvbnMpOwogIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGFkYXB0ZXIuZmluZEFsbChzdG9yZSwgbW9kZWxDbGFzcywgc2luY2VUb2tlbiwgc25hcHNob3RBcnJheSkpOwogIHZhciBsYWJlbCA9ICJEUzogSGFuZGxlIEFkYXB0ZXIjZmluZEFsbCBvZiAiICsgbW9kZWxDbGFzczsKCiAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICAodHJ1ZSAmJiAhKHBheWxvYWRJc05vdEJsYW5rKGFkYXB0ZXJQYXlsb2FkKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbWFkZSBhICdmaW5kQWxsJyByZXF1ZXN0IGZvciAnJHttb2RlbE5hbWV9JyByZWNvcmRzLCBidXQgdGhlIGFkYXB0ZXIncyByZXNwb25zZSBkaWQgbm90IGhhdmUgYW55IGRhdGFgLCBwYXlsb2FkSXNOb3RCbGFuayhhZGFwdGVyUGF5bG9hZCkpKTsKCiAgICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCBtb2RlbE5hbWUpOwogICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIG51bGwsICdmaW5kQWxsJyk7CgogICAgc3RvcmUuX3B1c2gocGF5bG9hZCk7CiAgICBzdG9yZS5fZGlkVXBkYXRlQWxsKG1vZGVsTmFtZSk7CgogICAgcmV0dXJuIHJlY29yZEFycmF5OwogIH0sIG51bGwsICdEUzogRXh0cmFjdCBwYXlsb2FkIG9mIGZpbmRBbGwgJHttb2RlbE5hbWV9Jyk7Cn0KCmZ1bmN0aW9uIF9xdWVyeShhZGFwdGVyLCBzdG9yZSwgbW9kZWxOYW1lLCBxdWVyeSwgcmVjb3JkQXJyYXksIG9wdGlvbnMpIHsKICB7CiAgICBpbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTsKICB9CiAgdmFyIG1vZGVsQ2xhc3MgPSBzdG9yZS5tb2RlbEZvcihtb2RlbE5hbWUpOyAvLyBhZGFwdGVyLnF1ZXJ5IG5lZWRzIHRoZSBjbGFzcwoKICB2YXIgcHJvbWlzZSA9IHZvaWQgMDsKICB2YXIgY3JlYXRlUmVjb3JkQXJyYXkgPSBhZGFwdGVyLnF1ZXJ5Lmxlbmd0aCA+IDMgfHwgYWRhcHRlci5xdWVyeS53cmFwcGVkRnVuY3Rpb24gJiYgYWRhcHRlci5xdWVyeS53cmFwcGVkRnVuY3Rpb24ubGVuZ3RoID4gMzsKCiAgaWYgKGNyZWF0ZVJlY29yZEFycmF5KSB7CiAgICByZWNvcmRBcnJheSA9IHJlY29yZEFycmF5IHx8IHN0b3JlLnJlY29yZEFycmF5TWFuYWdlci5jcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkobW9kZWxOYW1lLCBxdWVyeSk7CiAgICBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGFkYXB0ZXIucXVlcnkoc3RvcmUsIG1vZGVsQ2xhc3MsIHF1ZXJ5LCByZWNvcmRBcnJheSwgb3B0aW9ucykpOwogIH0gZWxzZSB7CiAgICBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGFkYXB0ZXIucXVlcnkoc3RvcmUsIG1vZGVsQ2xhc3MsIHF1ZXJ5KSk7CiAgfQoKICB2YXIgbGFiZWwgPSBgRFM6IEhhbmRsZSBBZGFwdGVyI3F1ZXJ5IG9mICR7bW9kZWxOYW1lfWA7CiAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCBtb2RlbE5hbWUpOwoKICAgIHZhciBwYXlsb2FkID0gbm9ybWFsaXplUmVzcG9uc2VIZWxwZXIoc2VyaWFsaXplciwgc3RvcmUsIG1vZGVsQ2xhc3MsIGFkYXB0ZXJQYXlsb2FkLCBudWxsLCAncXVlcnknKTsKCiAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSBzdG9yZS5fcHVzaChwYXlsb2FkKTsKCiAgICAodHJ1ZSAmJiAhKEFycmF5LmlzQXJyYXkoaW50ZXJuYWxNb2RlbHMpKSAmJiBFbWJlci5hc3NlcnQoJ1RoZSByZXNwb25zZSB0byBzdG9yZS5xdWVyeSBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheSBidXQgaXQgd2FzIGEgc2luZ2xlIHJlY29yZC4gUGxlYXNlIHdyYXAgeW91ciByZXNwb25zZSBpbiBhbiBhcnJheSBvciB1c2UgYHN0b3JlLnF1ZXJ5UmVjb3JkYCB0byBxdWVyeSBmb3IgYSBzaW5nbGUgcmVjb3JkLicsIEFycmF5LmlzQXJyYXkoaW50ZXJuYWxNb2RlbHMpKSk7CgogICAgaWYgKHJlY29yZEFycmF5KSB7CiAgICAgIHJlY29yZEFycmF5Ll9zZXRJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscywgcGF5bG9hZCk7CiAgICB9IGVsc2UgewogICAgICByZWNvcmRBcnJheSA9IHN0b3JlLnJlY29yZEFycmF5TWFuYWdlci5jcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkobW9kZWxOYW1lLCBxdWVyeSwgaW50ZXJuYWxNb2RlbHMsIHBheWxvYWQpOwogICAgfQoKICAgIHJldHVybiByZWNvcmRBcnJheTsKICB9LCBudWxsLCBgRFM6IEV4dHJhY3QgcGF5bG9hZCBvZiBxdWVyeSAke21vZGVsTmFtZX1gKTsKfQoKZnVuY3Rpb24gX3F1ZXJ5UmVjb3JkKGFkYXB0ZXIsIHN0b3JlLCBtb2RlbE5hbWUsIHF1ZXJ5LCBvcHRpb25zKSB7CiAgewogICAgaW5jcmVtZW50UmVxdWVzdENvdW50KCk7CiAgfQogIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsgLy8gYWRhcHRlci5xdWVyeVJlY29yZCBuZWVkcyB0aGUgY2xhc3MKICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBhZGFwdGVyLnF1ZXJ5UmVjb3JkKHN0b3JlLCBtb2RlbENsYXNzLCBxdWVyeSwgb3B0aW9ucykpOwoKICB2YXIgbGFiZWwgPSBgRFM6IEhhbmRsZSBBZGFwdGVyI3F1ZXJ5UmVjb3JkIG9mICR7bW9kZWxOYW1lfWA7CiAgcHJvbWlzZSA9IGd1YXJkRGVzdHJveWVkU3RvcmUocHJvbWlzZSwgc3RvcmUsIGxhYmVsKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCBtb2RlbE5hbWUpOwogICAgdmFyIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIG51bGwsICdxdWVyeVJlY29yZCcpOwoKICAgICh0cnVlICYmICEoIUFycmF5LmlzQXJyYXkocGF5bG9hZC5kYXRhKSkgJiYgRW1iZXIuYXNzZXJ0KGBFeHBlY3RlZCB0aGUgcHJpbWFyeSBkYXRhIHJldHVybmVkIGJ5IHRoZSBzZXJpYWxpemVyIGZvciBhICdxdWVyeVJlY29yZCcgcmVzcG9uc2UgdG8gYmUgYSBzaW5nbGUgb2JqZWN0IG9yIG51bGwgYnV0IGluc3RlYWQgaXQgd2FzIGFuIGFycmF5LmAsICFBcnJheS5pc0FycmF5KHBheWxvYWQuZGF0YSksIHsKICAgICAgaWQ6ICdkcy5zdG9yZS5xdWVyeVJlY29yZC1hcnJheS1yZXNwb25zZScKICAgIH0pKTsKCgogICAgcmV0dXJuIHN0b3JlLl9wdXNoKHBheWxvYWQpOwogIH0sIG51bGwsIGBEUzogRXh0cmFjdCBwYXlsb2FkIG9mIHF1ZXJ5UmVjb3JkICR7bW9kZWxOYW1lfWApOwp9CgovLyBVc2VkIGJ5IHRoZSBzdG9yZSB0byBub3JtYWxpemUgSURzIGVudGVyaW5nIHRoZSBzdG9yZS4gIERlc3BpdGUgdGhlIGZhY3QKLy8gdGhhdCBkZXZlbG9wZXJzIG1heSBwcm92aWRlIElEcyBhcyBudW1iZXJzIChlLmcuLCBgc3RvcmUuZmluZFJlY29yZCgncGVyc29uJywgMSlgKSwKLy8gaXQgaXMgaW1wb3J0YW50IHRoYXQgaW50ZXJuYWxseSB3ZSB1c2Ugc3RyaW5ncywgc2luY2UgSURzIG1heSBiZSBzZXJpYWxpemVkCi8vIGFuZCBsb3NlIHR5cGUgaW5mb3JtYXRpb24uICBGb3IgZXhhbXBsZSwgRW1iZXIncyByb3V0ZXIgbWF5IHB1dCBhIHJlY29yZCdzCi8vIElEIGludG8gdGhlIFVSTCwgYW5kIGlmIHdlIGxhdGVyIHRyeSB0byBkZXNlcmlhbGl6ZSB0aGF0IFVSTCBhbmQgZmluZCB0aGUKLy8gY29ycmVzcG9uZGluZyByZWNvcmQsIHdlIHdpbGwgbm90IGtub3cgaWYgaXQgaXMgYSBzdHJpbmcgb3IgYSBudW1iZXIuCmZ1bmN0aW9uIGNvZXJjZUlkKGlkKSB7CiAgaWYgKGlkID09PSBudWxsIHx8IGlkID09PSB1bmRlZmluZWQgfHwgaWQgPT09ICcnKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHR5cGVvZiBpZCA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBpZDsKICB9CiAgcmV0dXJuICcnICsgaWQ7Cn0KCmZ1bmN0aW9uIGNsb25lTnVsbChzb3VyY2UpIHsKICB2YXIgY2xvbmUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHsKICAgIGNsb25lW2tleV0gPSBzb3VyY2Vba2V5XTsKICB9CiAgcmV0dXJuIGNsb25lOwp9CgovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCi8qKgogIEBjbGFzcyBTbmFwc2hvdFJlY29yZEFycmF5CiAgQG5hbWVzcGFjZSBEUwogIEBwcml2YXRlCiAgQGNvbnN0cnVjdG9yCiAgQHBhcmFtIHtBcnJheX0gc25hcHNob3RzIEFuIGFycmF5IG9mIHNuYXBzaG90cwogIEBwYXJhbSB7T2JqZWN0fSBtZXRhCiovCmNsYXNzIFNuYXBzaG90UmVjb3JkQXJyYXkgewogIGNvbnN0cnVjdG9yKHJlY29yZEFycmF5LCBtZXRhLCBvcHRpb25zID0ge30pIHsKICAgIC8qKgogICAgICBBbiBhcnJheSBvZiBzbmFwc2hvdHMKICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5IF9zbmFwc2hvdHMKICAgICAgQHR5cGUge0FycmF5fQogICAgKi8KICAgIHRoaXMuX3NuYXBzaG90cyA9IG51bGw7CgogICAgLyoqCiAgICAgIEFuIGFycmF5IG9mIHJlY29yZHMKICAgICAgQHByaXZhdGUKICAgICAgQHByb3BlcnR5IF9yZWNvcmRBcnJheQogICAgICBAdHlwZSB7QXJyYXl9CiAgICAqLwogICAgdGhpcy5fcmVjb3JkQXJyYXkgPSByZWNvcmRBcnJheTsKCiAgICAvKioKICAgICAgTnVtYmVyIG9mIHJlY29yZHMgaW4gdGhlIGFycmF5CiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YScKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgc2hvdWxkUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gIXNuYXBzaG90UmVjb3JkQXJyYXkubGVuZ3RoOwogICAgICAgIH0sCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBsZW5ndGgKICAgICAgQHR5cGUge051bWJlcn0KICAgICovCiAgICB0aGlzLmxlbmd0aCA9IHJlY29yZEFycmF5LmdldCgnbGVuZ3RoJyk7CgogICAgdGhpcy5fdHlwZSA9IG51bGw7CgogICAgLyoqCiAgICAgIE1ldGEgb2JqZWN0cyBmb3IgdGhlIHJlY29yZCBhcnJheS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTkFQSUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBzaG91bGRSZWxvYWRBbGwoc3RvcmUsIHNuYXBzaG90UmVjb3JkQXJyYXkpIHsKICAgICAgICAgIHZhciBsYXN0UmVxdWVzdFRpbWUgPSBzbmFwc2hvdFJlY29yZEFycmF5Lm1ldGEubGFzdFJlcXVlc3RUaW1lOwogICAgICAgICAgdmFyIHR3ZW50eU1pbnV0ZXMgPSAyMCAqIDYwICogMTAwMDsKICAgICAgICAgIHJldHVybiBEYXRlLm5vdygpID4gbGFzdFJlcXVlc3RUaW1lICsgdHdlbnR5TWludXRlczsKICAgICAgICB9LAogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgbWV0YQogICAgICBAdHlwZSB7T2JqZWN0fQogICAgKi8KICAgIHRoaXMubWV0YSA9IG1ldGE7CgogICAgLyoqCiAgICAgIEEgaGFzaCBvZiBhZGFwdGVyIG9wdGlvbnMgcGFzc2VkIGludG8gdGhlIHN0b3JlIG1ldGhvZCBmb3IgdGhpcyByZXF1ZXN0LgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IE15Q3VzdG9tQWRhcHRlciBmcm9tICcuL2N1c3RvbS1hZGFwdGVyJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IE15Q3VzdG9tQWRhcHRlci5leHRlbmQoewogICAgICAgIGZpbmRBbGwoc3RvcmUsIHR5cGUsIHNpbmNlVG9rZW4sIHNuYXBzaG90UmVjb3JkQXJyYXkpIHsKICAgICAgICAgIGlmIChzbmFwc2hvdFJlY29yZEFycmF5LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgICAvLyAuLi4KICAgICAgICAgIH0KICAgICAgICAgIC8vIC4uLgogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGFkYXB0ZXJPcHRpb25zCiAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAqLwogICAgdGhpcy5hZGFwdGVyT3B0aW9ucyA9IG9wdGlvbnMuYWRhcHRlck9wdGlvbnM7CgogICAgLyoqCiAgICAgIFRoZSByZWxhdGlvbnNoaXBzIHRvIGluY2x1ZGUgZm9yIHRoaXMgcmVxdWVzdC4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICAgICAgdmFyIHVybCA9IGAvJHt0eXBlLm1vZGVsTmFtZX0/aW5jbHVkZT0ke2VuY29kZVVSSUNvbXBvbmVudChzbmFwc2hvdFJlY29yZEFycmF5LmluY2x1ZGUpfWA7CiAgICAgICAgICAgcmV0dXJuIGZldGNoKHVybCkudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSkKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgQHByb3BlcnR5IGluY2x1ZGUKICAgICAgQHR5cGUge1N0cmluZ3xBcnJheX0KICAgICovCiAgICB0aGlzLmluY2x1ZGUgPSBvcHRpb25zLmluY2x1ZGU7CiAgfQoKICAvKioKICAgIFRoZSB0eXBlIG9mIHRoZSB1bmRlcmx5aW5nIHJlY29yZHMgZm9yIHRoZSBzbmFwc2hvdHMgaW4gdGhlIGFycmF5LCBhcyBhIERTLk1vZGVsCiAgICBAcHJvcGVydHkgdHlwZQogICAgQHR5cGUge0RTLk1vZGVsfQogICovCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gdGhpcy5fdHlwZSB8fCAodGhpcy5fdHlwZSA9IHRoaXMuX3JlY29yZEFycmF5LmdldCgndHlwZScpKTsKICB9CgogIC8qKgogICAgR2V0IHNuYXBzaG90cyBvZiB0aGUgdW5kZXJseWluZyByZWNvcmQgYXJyYXkKICAgICBFeGFtcGxlCiAgICAgYGBgYXBwL2FkYXB0ZXJzL3Bvc3QuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJwogICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgIHNob3VsZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RBcnJheSkgewogICAgICAgIHZhciBzbmFwc2hvdHMgPSBzbmFwc2hvdEFycmF5LnNuYXBzaG90cygpOwogICAgICAgICByZXR1cm4gc25hcHNob3RzLmFueShmdW5jdGlvbih0aWNrZXRTbmFwc2hvdCkgewogICAgICAgICAgdmFyIHRpbWVEaWZmID0gbW9tZW50KCkuZGlmZih0aWNrZXRTbmFwc2hvdC5hdHRyKCdsYXN0QWNjZXNzZWRBdCcpLCAnbWludXRlcycpOwogICAgICAgICAgaWYgKHRpbWVEaWZmID4gMjApIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCBzbmFwc2hvdHMKICAgIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBzbmFwc2hvdHMKICAqLwogIHNuYXBzaG90cygpIHsKICAgIGlmICh0aGlzLl9zbmFwc2hvdHMgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NuYXBzaG90czsKICAgIH0KCiAgICB0aGlzLl9zbmFwc2hvdHMgPSB0aGlzLl9yZWNvcmRBcnJheS5fdGFrZVNuYXBzaG90KCk7CgogICAgcmV0dXJuIHRoaXMuX3NuYXBzaG90czsKICB9Cn0KCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKLyoqCiAgQSByZWNvcmQgYXJyYXkgaXMgYW4gYXJyYXkgdGhhdCBjb250YWlucyByZWNvcmRzIG9mIGEgY2VydGFpbiBtb2RlbE5hbWUuIFRoZSByZWNvcmQKICBhcnJheSBtYXRlcmlhbGl6ZXMgcmVjb3JkcyBhcyBuZWVkZWQgd2hlbiB0aGV5IGFyZSByZXRyaWV2ZWQgZm9yIHRoZSBmaXJzdAogIHRpbWUuIFlvdSBzaG91bGQgbm90IGNyZWF0ZSByZWNvcmQgYXJyYXlzIHlvdXJzZWxmLiBJbnN0ZWFkLCBhbiBpbnN0YW5jZSBvZgogIGBEUy5SZWNvcmRBcnJheWAgb3IgaXRzIHN1YmNsYXNzZXMgd2lsbCBiZSByZXR1cm5lZCBieSB5b3VyIGFwcGxpY2F0aW9uJ3Mgc3RvcmUKICBpbiByZXNwb25zZSB0byBxdWVyaWVzLgoKICBAY2xhc3MgUmVjb3JkQXJyYXkKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRW1iZXIuQXJyYXlQcm94eQogIEB1c2VzIEVtYmVyLkV2ZW50ZWQKKi8KCnZhciBSZWNvcmRBcnJheSA9IEVtYmVyLkFycmF5UHJveHkuZXh0ZW5kKEVtYmVyLkV2ZW50ZWQsIHsKICBpbml0KCkgewogICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKCiAgICAvKioKICAgICAgVGhlIGFycmF5IG9mIGNsaWVudCBpZHMgYmFja2luZyB0aGUgcmVjb3JkIGFycmF5LiBXaGVuIGEKICAgICAgcmVjb3JkIGlzIHJlcXVlc3RlZCBmcm9tIHRoZSByZWNvcmQgYXJyYXksIHRoZSByZWNvcmQKICAgICAgZm9yIHRoZSBjbGllbnQgaWQgYXQgdGhlIHNhbWUgaW5kZXggaXMgbWF0ZXJpYWxpemVkLCBpZgogICAgICBuZWNlc3NhcnksIGJ5IHRoZSBzdG9yZS4KICAgICAgIEBwcm9wZXJ0eSBjb250ZW50CiAgICAgIEBwcml2YXRlCiAgICAgIEB0eXBlIEVtYmVyLkFycmF5CiAgICAgICovCiAgICB0aGlzLnNldCgnY29udGVudCcsIHRoaXMuY29udGVudCB8fCBudWxsKTsKCiAgICAvKioKICAgIFRoZSBmbGFnIHRvIHNpZ25hbCBhIGBSZWNvcmRBcnJheWAgaXMgZmluaXNoZWQgbG9hZGluZyBkYXRhLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgcGVvcGxlID0gc3RvcmUucGVla0FsbCgncGVyc29uJyk7CiAgICBwZW9wbGUuZ2V0KCdpc0xvYWRlZCcpOyAvLyB0cnVlCiAgICBgYGAKICAgICBAcHJvcGVydHkgaXNMb2FkZWQKICAgIEB0eXBlIEJvb2xlYW4KICAgICovCiAgICB0aGlzLmlzTG9hZGVkID0gdGhpcy5pc0xvYWRlZCB8fCBmYWxzZTsKICAgIC8qKgogICAgVGhlIGZsYWcgdG8gc2lnbmFsIGEgYFJlY29yZEFycmF5YCBpcyBjdXJyZW50bHkgbG9hZGluZyBkYXRhLgogICAgRXhhbXBsZQogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHBlb3BsZSA9IHN0b3JlLnBlZWtBbGwoJ3BlcnNvbicpOwogICAgcGVvcGxlLmdldCgnaXNVcGRhdGluZycpOyAvLyBmYWxzZQogICAgcGVvcGxlLnVwZGF0ZSgpOwogICAgcGVvcGxlLmdldCgnaXNVcGRhdGluZycpOyAvLyB0cnVlCiAgICBgYGAKICAgIEBwcm9wZXJ0eSBpc1VwZGF0aW5nCiAgICBAdHlwZSBCb29sZWFuCiAgICAqLwogICAgdGhpcy5pc1VwZGF0aW5nID0gZmFsc2U7CgogICAgLyoqCiAgICBUaGUgc3RvcmUgdGhhdCBjcmVhdGVkIHRoaXMgcmVjb3JkIGFycmF5LgogICAgQHByb3BlcnR5IHN0b3JlCiAgICBAcHJpdmF0ZQogICAgQHR5cGUgRFMuU3RvcmUKICAgICovCiAgICB0aGlzLnN0b3JlID0gdGhpcy5zdG9yZSB8fCBudWxsOwogICAgdGhpcy5fdXBkYXRpbmdQcm9taXNlID0gbnVsbDsKICB9LAoKICByZXBsYWNlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVzdWx0IG9mIGEgc2VydmVyIHF1ZXJ5IChmb3IgYWxsICR7dGhpcy5tb2RlbE5hbWV9IHR5cGVzKSBpcyBpbW11dGFibGUuIFRvIG1vZGlmeSBjb250ZW50cywgdXNlIHRvQXJyYXkoKWApOwogIH0sCgogIC8qKgogICBUaGUgbW9kZWxDbGFzcyByZXByZXNlbnRlZCBieSB0aGlzIHJlY29yZCBhcnJheS4KICAgIEBwcm9wZXJ0eSB0eXBlCiAgIEB0eXBlIERTLk1vZGVsCiAgICovCiAgdHlwZTogRW1iZXIuY29tcHV0ZWQoJ21vZGVsTmFtZScsIGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5tb2RlbE5hbWUpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5zdG9yZS5fbW9kZWxGb3IodGhpcy5tb2RlbE5hbWUpOwogIH0pLnJlYWRPbmx5KCksCgogIC8qKgogICAgUmV0cmlldmVzIGFuIG9iamVjdCBmcm9tIHRoZSBjb250ZW50IGJ5IGluZGV4LgogICAgIEBtZXRob2Qgb2JqZWN0QXRDb250ZW50CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtOdW1iZXJ9IGluZGV4CiAgICBAcmV0dXJuIHtEUy5Nb2RlbH0gcmVjb3JkCiAgKi8KICBvYmplY3RBdENvbnRlbnQoaW5kZXgpIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50Jykub2JqZWN0QXQoaW5kZXgpOwogICAgcmV0dXJuIGludGVybmFsTW9kZWwgJiYgaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICB9LAoKICAvKioKICAgIFVzZWQgdG8gZ2V0IHRoZSBsYXRlc3QgdmVyc2lvbiBvZiBhbGwgb2YgdGhlIHJlY29yZHMgaW4gdGhpcyBhcnJheQogICAgZnJvbSB0aGUgYWRhcHRlci4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHBlb3BsZSA9IHN0b3JlLnBlZWtBbGwoJ3BlcnNvbicpOwogICAgcGVvcGxlLmdldCgnaXNVcGRhdGluZycpOyAvLyBmYWxzZQogICAgIHBlb3BsZS51cGRhdGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBwZW9wbGUuZ2V0KCdpc1VwZGF0aW5nJyk7IC8vIGZhbHNlCiAgICB9KTsKICAgICBwZW9wbGUuZ2V0KCdpc1VwZGF0aW5nJyk7IC8vIHRydWUKICAgIGBgYAogICAgIEBtZXRob2QgdXBkYXRlCiAgKi8KICB1cGRhdGUoKSB7CiAgICBpZiAoRW1iZXIuZ2V0KHRoaXMsICdpc1VwZGF0aW5nJykpIHsKICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0aW5nUHJvbWlzZTsKICAgIH0KCiAgICB0aGlzLnNldCgnaXNVcGRhdGluZycsIHRydWUpOwoKICAgIHZhciB1cGRhdGluZ1Byb21pc2UgPSB0aGlzLl91cGRhdGUoKS5maW5hbGx5KCgpID0+IHsKICAgICAgdGhpcy5fdXBkYXRpbmdQcm9taXNlID0gbnVsbDsKICAgICAgaWYgKHRoaXMuZ2V0KCdpc0Rlc3Ryb3lpbmcnKSB8fCB0aGlzLmdldCgnaXNEZXN0cm95ZWQnKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnNldCgnaXNVcGRhdGluZycsIGZhbHNlKTsKICAgIH0pOwoKICAgIHRoaXMuX3VwZGF0aW5nUHJvbWlzZSA9IHVwZGF0aW5nUHJvbWlzZTsKCiAgICByZXR1cm4gdXBkYXRpbmdQcm9taXNlOwogIH0sCgogIC8qCiAgICBVcGRhdGUgdGhpcyBSZWNvcmRBcnJheSBhbmQgcmV0dXJuIGEgcHJvbWlzZSB3aGljaCByZXNvbHZlcyBvbmNlIHRoZSB1cGRhdGUKICAgIGlzIGZpbmlzaGVkLgogICAqLwogIF91cGRhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5maW5kQWxsKHRoaXMubW9kZWxOYW1lLCB7IHJlbG9hZDogdHJ1ZSB9KTsKICB9LAoKICAvKioKICAgIEFkZHMgYW4gaW50ZXJuYWwgbW9kZWwgdG8gdGhlIGBSZWNvcmRBcnJheWAgd2l0aG91dCBkdXBsaWNhdGVzCiAgICAgQG1ldGhvZCBfcHVzaEludGVybmFsTW9kZWxzCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgKi8KICBfcHVzaEludGVybmFsTW9kZWxzKGludGVybmFsTW9kZWxzKSB7CiAgICAvLyBwdXNoT2JqZWN0cyBiZWNhdXNlIHRoZSBpbnRlcm5hbE1vZGVscy5fcmVjb3JkQXJyYXlzIHNldCB3YXMgYWxyZWFkeQogICAgLy8gY29uc3VsdGVkIGZvciBpbmNsdXNpb24sIHNvIGFkZE9iamVjdCBhbmQgaXRzIG9uIC5jb250YWlucyBjYWxsIGlzIG5vdAogICAgLy8gcmVxdWlyZWQuCiAgICBFbWJlci5nZXQodGhpcywgJ2NvbnRlbnQnKS5wdXNoT2JqZWN0cyhpbnRlcm5hbE1vZGVscyk7CiAgfSwKCiAgLyoqCiAgICBSZW1vdmVzIGFuIGludGVybmFsTW9kZWwgdG8gdGhlIGBSZWNvcmRBcnJheWAuCiAgICAgQG1ldGhvZCByZW1vdmVJbnRlcm5hbE1vZGVsCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgKi8KICBfcmVtb3ZlSW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMpIHsKICAgIEVtYmVyLmdldCh0aGlzLCAnY29udGVudCcpLnJlbW92ZU9iamVjdHMoaW50ZXJuYWxNb2RlbHMpOwogIH0sCgogIC8qKgogICAgU2F2ZXMgYWxsIG9mIHRoZSByZWNvcmRzIGluIHRoZSBgUmVjb3JkQXJyYXlgLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICB2YXIgbWVzc2FnZXMgPSBzdG9yZS5wZWVrQWxsKCdtZXNzYWdlJyk7CiAgICBtZXNzYWdlcy5mb3JFYWNoKGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgbWVzc2FnZS5zZXQoJ2hhc0JlZW5TZWVuJywgdHJ1ZSk7CiAgICB9KTsKICAgIG1lc3NhZ2VzLnNhdmUoKTsKICAgIGBgYAogICAgIEBtZXRob2Qgc2F2ZQogICAgQHJldHVybiB7RFMuUHJvbWlzZUFycmF5fSBwcm9taXNlCiAgKi8KICBzYXZlKCkgewogICAgdmFyIHByb21pc2VMYWJlbCA9IGBEUzogUmVjb3JkQXJyYXkjc2F2ZSAke3RoaXMubW9kZWxOYW1lfWA7CiAgICB2YXIgcHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZS5hbGwodGhpcy5pbnZva2UoJ3NhdmUnKSwgcHJvbWlzZUxhYmVsKS50aGVuKCgpID0+IHRoaXMsIG51bGwsICdEUzogUmVjb3JkQXJyYXkjc2F2ZSByZXR1cm4gUmVjb3JkQXJyYXknKTsKCiAgICByZXR1cm4gUHJvbWlzZUFycmF5LmNyZWF0ZSh7IHByb21pc2UgfSk7CiAgfSwKCiAgX2Rpc3NvY2lhdGVGcm9tT3duUmVjb3JkcygpIHsKICAgIHRoaXMuZ2V0KCdjb250ZW50JykuZm9yRWFjaChpbnRlcm5hbE1vZGVsID0+IHsKICAgICAgdmFyIHJlY29yZEFycmF5cyA9IGludGVybmFsTW9kZWwuX19yZWNvcmRBcnJheXM7CgogICAgICBpZiAocmVjb3JkQXJyYXlzKSB7CiAgICAgICAgcmVjb3JkQXJyYXlzLmRlbGV0ZSh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIF91bnJlZ2lzdGVyRnJvbU1hbmFnZXIKICAgIEBwcml2YXRlCiAgKi8KICBfdW5yZWdpc3RlckZyb21NYW5hZ2VyKCkgewogICAgdGhpcy5tYW5hZ2VyLnVucmVnaXN0ZXJSZWNvcmRBcnJheSh0aGlzKTsKICB9LAoKICB3aWxsRGVzdHJveSgpIHsKICAgIHRoaXMuX3VucmVnaXN0ZXJGcm9tTWFuYWdlcigpOwogICAgdGhpcy5fZGlzc29jaWF0ZUZyb21Pd25SZWNvcmRzKCk7CiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgbm90IGRvIHdvcmsgZHVyaW5nIGRlc3Ryb3k6CiAgICAvLyAgICogd2hlbiBvYmplY3RzIGFyZSBkZXN0cm95ZWQsIHRoZXkgc2hvdWxkIHNpbXBseSBiZSBsZWZ0IHRvIGRvCiAgICAvLyAgICogaWYgbG9naWMgZXJyb3JzIGRvIHRvIHRoaXMsIHRoYXQgbG9naWMgbmVlZHMgdG8gYmUgbW9yZSBjYXJlZnVsIGR1cmluZwogICAgLy8gICAgdGVhcmRvd24gKGVtYmVyIHByb3ZpZGVzIGlzRGVzdHJveWluZy9pc0Rlc3Ryb3llZCkgZm9yIHRoaXMgcmVhc29uCiAgICAvLyAgICogdGhlIGV4Y2VwdGlvbiBiZWluZzogaWYgYW4gZG9taW5hdG9yIGhhcyBhIHJlZmVyZW5jZSB0byB0aGlzIG9iamVjdCwKICAgIC8vICAgICBhbmQgbXVzdCBiZSBpbmZvcm1lZCB0byByZWxlYXNlIGUuZy4gZS5nLiByZW1vdmluZyBpdHNlbGYgZnJvbSB0aAogICAgLy8gICAgIHJlY29yZEFycmF5TWFuYW5nZXIKICAgIEVtYmVyLnNldCh0aGlzLCAnY29udGVudCcsIG51bGwpOwogICAgRW1iZXIuc2V0KHRoaXMsICdsZW5ndGgnLCAwKTsKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgfSwKCiAgLyoKICAgIEBtZXRob2QgX2NyZWF0ZVNuYXBzaG90CiAgICBAcHJpdmF0ZQogICovCiAgX2NyZWF0ZVNuYXBzaG90KG9wdGlvbnMpIHsKICAgIC8vIHRoaXMgaXMgcHJpdmF0ZSBmb3IgdXNlcnMsIGJ1dCBwdWJsaWMgZm9yIGVtYmVyLWRhdGEgaW50ZXJuYWxzCiAgICByZXR1cm4gbmV3IFNuYXBzaG90UmVjb3JkQXJyYXkodGhpcywgdGhpcy5nZXQoJ21ldGEnKSwgb3B0aW9ucyk7CiAgfSwKCiAgLyoKICAgIEBtZXRob2QgX3Rha2VTbmFwc2hvdAogICAgQHByaXZhdGUKICAqLwogIF90YWtlU25hcHNob3QoKSB7CiAgICByZXR1cm4gRW1iZXIuZ2V0KHRoaXMsICdjb250ZW50JykubWFwKGludGVybmFsTW9kZWwgPT4gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdCgpKTsKICB9Cn0pOwoKLyoqCiAgUmVwcmVzZW50cyBhbiBvcmRlcmVkIGxpc3Qgb2YgcmVjb3JkcyB3aG9zZSBvcmRlciBhbmQgbWVtYmVyc2hpcCBpcwogIGRldGVybWluZWQgYnkgdGhlIGFkYXB0ZXIuIEZvciBleGFtcGxlLCBhIHF1ZXJ5IHNlbnQgdG8gdGhlIGFkYXB0ZXIKICBtYXkgdHJpZ2dlciBhIHNlYXJjaCBvbiB0aGUgc2VydmVyLCB3aG9zZSByZXN1bHRzIHdvdWxkIGJlIGxvYWRlZAogIGludG8gYW4gaW5zdGFuY2Ugb2YgdGhlIGBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgLgoKICAtLS0KCiAgSWYgeW91IHdhbnQgdG8gdXBkYXRlIHRoZSBhcnJheSBhbmQgZ2V0IHRoZSBsYXRlc3QgcmVjb3JkcyBmcm9tIHRoZQogIGFkYXB0ZXIsIHlvdSBjYW4gaW52b2tlIFtgdXBkYXRlKClgXSgjbWV0aG9kX3VwZGF0ZSk6CgogIEV4YW1wbGUKCiAgYGBgamF2YXNjcmlwdAogIC8vIEdFVCAvdXNlcnM/aXNBZG1pbj10cnVlCiAgdmFyIGFkbWlucyA9IHN0b3JlLnF1ZXJ5KCd1c2VyJywgeyBpc0FkbWluOiB0cnVlIH0pOwoKICBhZG1pbnMudGhlbihmdW5jdGlvbigpIHsKICAgIGNvbnNvbGUubG9nKGFkbWlucy5nZXQoImxlbmd0aCIpKTsgLy8gNDIKICB9KTsKCiAgLy8gc29tZXdoZXJlIGxhdGVyIGluIHRoZSBhcHAgY29kZSwgd2hlbiBuZXcgYWRtaW5zIGhhdmUgYmVlbiBjcmVhdGVkCiAgLy8gaW4gdGhlIG1lYW50aW1lCiAgLy8KICAvLyBHRVQgL3VzZXJzP2lzQWRtaW49dHJ1ZQogIGFkbWlucy51cGRhdGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgYWRtaW5zLmdldCgnaXNVcGRhdGluZycpOyAvLyBmYWxzZQogICAgY29uc29sZS5sb2coYWRtaW5zLmdldCgibGVuZ3RoIikpOyAvLyAxMjMKICB9KTsKCiAgYWRtaW5zLmdldCgnaXNVcGRhdGluZycpOyAvLyB0cnVlCiAgYGBgCgogIEBjbGFzcyBBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRFMuUmVjb3JkQXJyYXkKKi8KdmFyIEFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheSA9IFJlY29yZEFycmF5LmV4dGVuZCh7CiAgaW5pdCgpIHsKICAgIC8vIHllcyB3ZSBhcmUgdG91Y2hpbmcgYHRoaXNgIGJlZm9yZSBzdXBlciwgYnV0IEFycmF5UHJveHkgaGFzIGEgYnVnIHRoYXQgcmVxdWlyZXMgdGhpcy4KICAgIHRoaXMuc2V0KCdjb250ZW50JywgdGhpcy5nZXQoJ2NvbnRlbnQnKSB8fCBFbWJlci5BKCkpOwoKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICB0aGlzLnF1ZXJ5ID0gdGhpcy5xdWVyeSB8fCBudWxsOwogICAgdGhpcy5saW5rcyA9IHRoaXMubGlua3MgfHwgbnVsbDsKICB9LAoKICByZXBsYWNlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVzdWx0IG9mIGEgc2VydmVyIHF1ZXJ5IChvbiAke3RoaXMubW9kZWxOYW1lfSkgaXMgaW1tdXRhYmxlLmApOwogIH0sCgogIF91cGRhdGUoKSB7CiAgICB2YXIgc3RvcmUgPSBFbWJlci5nZXQodGhpcywgJ3N0b3JlJyk7CiAgICB2YXIgcXVlcnkgPSBFbWJlci5nZXQodGhpcywgJ3F1ZXJ5Jyk7CgogICAgcmV0dXJuIHN0b3JlLl9xdWVyeSh0aGlzLm1vZGVsTmFtZSwgcXVlcnksIHRoaXMpOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBfc2V0SW50ZXJuYWxNb2RlbHMKICAgIEBwYXJhbSB7QXJyYXl9IGludGVybmFsTW9kZWxzCiAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZCBub3JtYWxpemVkIHBheWxvYWQKICAgIEBwcml2YXRlCiAgKi8KICBfc2V0SW50ZXJuYWxNb2RlbHMoaW50ZXJuYWxNb2RlbHMsIHBheWxvYWQpIHsKCiAgICAvLyBUT0RPOiBpbml0aWFsIGxvYWQgc2hvdWxkIG5vdCBjYXVzZSBjaGFuZ2UgZXZlbnRzIGF0IGFsbCwgb25seQogICAgLy8gc3Vic2VxdWVudC4gVGhpcyByZXF1aXJlcyBjaGFuZ2luZyB0aGUgcHVibGljIGFwaSBvZiBhZGFwdGVyLnF1ZXJ5LCBidXQKICAgIC8vIGhvcGVmdWxseSB3ZSBjYW4gZG8gdGhhdCBzb29uLgogICAgdGhpcy5nZXQoJ2NvbnRlbnQnKS5zZXRPYmplY3RzKGludGVybmFsTW9kZWxzKTsKCiAgICB0aGlzLnNldFByb3BlcnRpZXMoewogICAgICBpc0xvYWRlZDogdHJ1ZSwKICAgICAgaXNVcGRhdGluZzogZmFsc2UsCiAgICAgIG1ldGE6IGNsb25lTnVsbChwYXlsb2FkLm1ldGEpLAogICAgICBsaW5rczogY2xvbmVOdWxsKHBheWxvYWQubGlua3MpCiAgICB9KTsKCiAgICBhc3NvY2lhdGVXaXRoUmVjb3JkQXJyYXkoaW50ZXJuYWxNb2RlbHMsIHRoaXMpOwoKICAgIC8vIFRPRE86IHNob3VsZCB0cmlnZ2VyaW5nIGRpZExvYWQgZXZlbnQgYmUgdGhlIGxhc3QgYWN0aW9uIG9mIHRoZSBydW5Mb29wPwogICAgRW1iZXIucnVuLm9uY2UodGhpcywgJ3RyaWdnZXInLCAnZGlkTG9hZCcpOwogIH0KfSk7CgovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGVtYmVyUnVuJDEgPSBFbWJlci5ydW4uYmFja2J1cm5lcjsKCi8qKgogIEBjbGFzcyBSZWNvcmRBcnJheU1hbmFnZXIKICBAbmFtZXNwYWNlIERTCiAgQHByaXZhdGUKKi8KY2xhc3MgUmVjb3JkQXJyYXlNYW5hZ2VyIHsKICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICB0aGlzLnN0b3JlID0gb3B0aW9ucy5zdG9yZTsKICAgIHRoaXMuaXNEZXN0cm95aW5nID0gZmFsc2U7CiAgICB0aGlzLmlzRGVzdHJveWVkID0gZmFsc2U7CiAgICB0aGlzLl9saXZlUmVjb3JkQXJyYXlzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMuX3BlbmRpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5fYWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5cyA9IFtdOwogIH0KCiAgcmVjb3JkRGlkQ2hhbmdlKGludGVybmFsTW9kZWwpIHsKICAgIC8vIFRPRE86IGNoYW5nZSBuYW1lCiAgICAvLyBUT0RPOiB0cmFjayB0aGF0IGl0IHdhcyBhbHNvIGEgY2hhbmdlCiAgICB0aGlzLmludGVybmFsTW9kZWxEaWRDaGFuZ2UoaW50ZXJuYWxNb2RlbCk7CiAgfQoKICByZWNvcmRXYXNMb2FkZWQoaW50ZXJuYWxNb2RlbCkgewogICAgLy8gVE9ETzogY2hhbmdlIG5hbWUKICAgIC8vIFRPRE86IHRyYWNrIHRoYXQgaXQgd2FzIGFsc28gdGhhdCBpdCB3YXMgZmlyc3QgbG9hZGVkCiAgICB0aGlzLmludGVybmFsTW9kZWxEaWRDaGFuZ2UoaW50ZXJuYWxNb2RlbCk7CiAgfQoKICBpbnRlcm5hbE1vZGVsRGlkQ2hhbmdlKGludGVybmFsTW9kZWwpIHsKCiAgICB2YXIgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CgogICAgaWYgKGludGVybmFsTW9kZWwuX3BlbmRpbmdSZWNvcmRBcnJheU1hbmFnZXJGbHVzaCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaW50ZXJuYWxNb2RlbC5fcGVuZGluZ1JlY29yZEFycmF5TWFuYWdlckZsdXNoID0gdHJ1ZTsKCiAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmc7CiAgICB2YXIgbW9kZWxzID0gcGVuZGluZ1ttb2RlbE5hbWVdID0gcGVuZGluZ1ttb2RlbE5hbWVdIHx8IFtdOwogICAgaWYgKG1vZGVscy5wdXNoKGludGVybmFsTW9kZWwpICE9PSAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBlbWJlclJ1biQxLnNjaGVkdWxlKCdhY3Rpb25zJywgdGhpcywgdGhpcy5fZmx1c2gpOwogIH0KCiAgX2ZsdXNoUGVuZGluZ0ludGVybmFsTW9kZWxzRm9yTW9kZWxOYW1lKG1vZGVsTmFtZSwgaW50ZXJuYWxNb2RlbHMpIHsKICAgIHZhciBtb2RlbHNUb1JlbW92ZSA9IFtdOwoKICAgIGZvciAodmFyIGogPSAwOyBqIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBqKyspIHsKICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBpbnRlcm5hbE1vZGVsc1tqXTsKICAgICAgLy8gbWFyayBpbnRlcm5hbE1vZGVscywgc28gdGhleSBjYW4gb25jZSBhZ2FpbiBiZSBwcm9jZXNzZWQgYnkgdGhlCiAgICAgIC8vIHJlY29yZEFycmF5TWFuYWdlcgogICAgICBpbnRlcm5hbE1vZGVsLl9wZW5kaW5nUmVjb3JkQXJyYXlNYW5hZ2VyRmx1c2ggPSBmYWxzZTsKICAgICAgLy8gYnVpbGQgdXAgYSBzZXQgb2YgbW9kZWxzIHRvIGVuc3VyZSB3ZSBoYXZlIHB1cmdlZCBjb3JyZWN0bHk7CiAgICAgIGlmIChpbnRlcm5hbE1vZGVsLmlzSGlkZGVuRnJvbVJlY29yZEFycmF5cygpKSB7CiAgICAgICAgbW9kZWxzVG9SZW1vdmUucHVzaChpbnRlcm5hbE1vZGVsKTsKICAgICAgfQogICAgfQoKICAgIHZhciBhcnJheSA9IHRoaXMuX2xpdmVSZWNvcmRBcnJheXNbbW9kZWxOYW1lXTsKICAgIGlmIChhcnJheSkgewogICAgICAvLyBUT0RPOiBza2lwIGlmIGl0IG9ubHkgY2hhbmdlZAogICAgICAvLyBwcm9jZXNzIGxpdmVSZWNvcmRBcnJheXMKICAgICAgdGhpcy51cGRhdGVMaXZlUmVjb3JkQXJyYXkoYXJyYXksIGludGVybmFsTW9kZWxzKTsKICAgIH0KCiAgICAvLyBwcm9jZXNzIGFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMKICAgIGlmIChtb2RlbHNUb1JlbW92ZS5sZW5ndGggPiAwKSB7CiAgICAgIHJlbW92ZUZyb21BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlzKG1vZGVsc1RvUmVtb3ZlKTsKICAgIH0KICB9CgogIF9mbHVzaCgpIHsKCiAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmc7CiAgICB0aGlzLl9wZW5kaW5nID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICBmb3IgKHZhciBtb2RlbE5hbWUgaW4gcGVuZGluZykgewogICAgICB0aGlzLl9mbHVzaFBlbmRpbmdJbnRlcm5hbE1vZGVsc0Zvck1vZGVsTmFtZShtb2RlbE5hbWUsIHBlbmRpbmdbbW9kZWxOYW1lXSk7CiAgICB9CiAgfQoKICB1cGRhdGVMaXZlUmVjb3JkQXJyYXkoYXJyYXksIGludGVybmFsTW9kZWxzKSB7CiAgICByZXR1cm4gdXBkYXRlTGl2ZVJlY29yZEFycmF5KGFycmF5LCBpbnRlcm5hbE1vZGVscyk7CiAgfQoKICBfc3luY0xpdmVSZWNvcmRBcnJheShhcnJheSwgbW9kZWxOYW1lKSB7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSAmJiBFbWJlci5hc3NlcnQoYHJlY29yZEFycmF5TWFuZ2VyLnN5bmNMaXZlUmVjb3JkQXJyYXkgZXhwZWN0cyBtb2RlbE5hbWUgbm90IG1vZGVsQ2xhc3MgYXMgdGhlIHNlY29uZCBwYXJhbWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgogICAgdmFyIHBlbmRpbmcgPSB0aGlzLl9wZW5kaW5nW21vZGVsTmFtZV07CiAgICB2YXIgaGFzUGVuZGluZ0NoYW5nZXMgPSBBcnJheS5pc0FycmF5KHBlbmRpbmcpOwogICAgdmFyIGhhc05vUG90ZW50aWFsRGVsZXRpb25zID0gIWhhc1BlbmRpbmdDaGFuZ2VzIHx8IHBlbmRpbmcubGVuZ3RoID09PSAwOwogICAgdmFyIG1hcCA9IHRoaXMuc3RvcmUuX2ludGVybmFsTW9kZWxzRm9yKG1vZGVsTmFtZSk7CiAgICB2YXIgaGFzTm9JbnNlcnRpb25zT3JSZW1vdmFscyA9IEVtYmVyLmdldChtYXAsICdsZW5ndGgnKSA9PT0gRW1iZXIuZ2V0KGFycmF5LCAnbGVuZ3RoJyk7CgogICAgLyoKICAgICAgSWRlYWxseSB0aGUgcmVjb3JkQXJyYXlNYW5hZ2VyIGhhcyBrbm93bGVkZ2Ugb2YgdGhlIGNoYW5nZXMgdG8gYmUgYXBwbGllZCB0bwogICAgICBsaXZlUmVjb3JkQXJyYXlzLCBhbmQgaXMgY2FwYWJsZSBvZiBzdHJhdGVnaWNhbGx5IGZsdXNoaW5nIHRob3NlIGNoYW5nZXMgYW5kIGFwcGx5aW5nCiAgICAgIHNtYWxsIGRpZmZzIGlmIGRlc2lyZWQuICBIb3dldmVyLCB1bnRpbCB3ZSd2ZSByZWZhY3RvcmVkIHJlY29yZEFycmF5TWFuYWdlciwgdGhpcyBkaXJ0eQogICAgICBjaGVjayBwcmV2ZW50cyB1cyBmcm9tIHVubmVjZXNzYXJpbHkgd2lwaW5nIG91dCBsaXZlIHJlY29yZCBhcnJheXMgcmV0dXJuZWQgYnkgcGVla0FsbC4KICAgICAgKi8KICAgIGlmIChoYXNOb1BvdGVudGlhbERlbGV0aW9ucyAmJiBoYXNOb0luc2VydGlvbnNPclJlbW92YWxzKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaGFzUGVuZGluZ0NoYW5nZXMpIHsKICAgICAgdGhpcy5fZmx1c2hQZW5kaW5nSW50ZXJuYWxNb2RlbHNGb3JNb2RlbE5hbWUobW9kZWxOYW1lLCBwZW5kaW5nKTsKICAgICAgZGVsZXRlIHBlbmRpbmdbbW9kZWxOYW1lXTsKICAgIH0KCiAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSB0aGlzLl92aXNpYmxlSW50ZXJuYWxNb2RlbHNCeVR5cGUobW9kZWxOYW1lKTsKICAgIHZhciBtb2RlbHNUb0FkZCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2ldOwogICAgICB2YXIgcmVjb3JkQXJyYXlzID0gaW50ZXJuYWxNb2RlbC5fcmVjb3JkQXJyYXlzOwogICAgICBpZiAocmVjb3JkQXJyYXlzLmhhcyhhcnJheSkgPT09IGZhbHNlKSB7CiAgICAgICAgcmVjb3JkQXJyYXlzLmFkZChhcnJheSk7CiAgICAgICAgbW9kZWxzVG9BZGQucHVzaChpbnRlcm5hbE1vZGVsKTsKICAgICAgfQogICAgfQoKICAgIGlmIChtb2RlbHNUb0FkZC5sZW5ndGgpIHsKICAgICAgYXJyYXkuX3B1c2hJbnRlcm5hbE1vZGVscyhtb2RlbHNUb0FkZCk7CiAgICB9CiAgfQoKICBfZGlkVXBkYXRlQWxsKG1vZGVsTmFtZSkgewogICAgdmFyIHJlY29yZEFycmF5ID0gdGhpcy5fbGl2ZVJlY29yZEFycmF5c1ttb2RlbE5hbWVdOwogICAgaWYgKHJlY29yZEFycmF5KSB7CiAgICAgIEVtYmVyLnNldChyZWNvcmRBcnJheSwgJ2lzVXBkYXRpbmcnLCBmYWxzZSk7CiAgICB9CiAgfQoKICAvKioKICAgIEdldCB0aGUgYERTLlJlY29yZEFycmF5YCBmb3IgYSBtb2RlbE5hbWUsIHdoaWNoIGNvbnRhaW5zIGFsbCBsb2FkZWQgcmVjb3JkcyBvZgogICAgZ2l2ZW4gbW9kZWxOYW1lLgogICAgIEBtZXRob2QgbGl2ZVJlY29yZEFycmF5Rm9yCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcmV0dXJuIHtEUy5SZWNvcmRBcnJheX0KICAqLwogIGxpdmVSZWNvcmRBcnJheUZvcihtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgcmVjb3JkQXJyYXlNYW5nZXIubGl2ZVJlY29yZEFycmF5Rm9yIGV4cGVjdHMgbW9kZWxOYW1lIG5vdCBtb2RlbENsYXNzIGFzIHRoZSBwYXJhbWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgoKICAgIHZhciBhcnJheSA9IHRoaXMuX2xpdmVSZWNvcmRBcnJheXNbbW9kZWxOYW1lXTsKCiAgICBpZiAoYXJyYXkpIHsKICAgICAgLy8gaWYgdGhlIGFycmF5IGFscmVhZHkgZXhpc3RzLCBzeW5jaHJvbml6ZQogICAgICB0aGlzLl9zeW5jTGl2ZVJlY29yZEFycmF5KGFycmF5LCBtb2RlbE5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgdGhlIGFycmF5IGlzIGJlaW5nIG5ld2x5IGNyZWF0ZWQgbWVyZWx5IGNyZWF0ZSBpdCB3aXRoIGl0cyBpbml0aWFsCiAgICAgIC8vIGNvbnRlbnQgYWxyZWFkeSBzZXQuIFRoaXMgcHJldmVudHMgdW5uZWVkZWQgY2hhbmdlIGV2ZW50cy4KICAgICAgdmFyIGludGVybmFsTW9kZWxzID0gdGhpcy5fdmlzaWJsZUludGVybmFsTW9kZWxzQnlUeXBlKG1vZGVsTmFtZSk7CiAgICAgIGFycmF5ID0gdGhpcy5jcmVhdGVSZWNvcmRBcnJheShtb2RlbE5hbWUsIGludGVybmFsTW9kZWxzKTsKICAgICAgdGhpcy5fbGl2ZVJlY29yZEFycmF5c1ttb2RlbE5hbWVdID0gYXJyYXk7CiAgICB9CgogICAgcmV0dXJuIGFycmF5OwogIH0KCiAgX3Zpc2libGVJbnRlcm5hbE1vZGVsc0J5VHlwZShtb2RlbE5hbWUpIHsKICAgIHZhciBhbGwgPSB0aGlzLnN0b3JlLl9pbnRlcm5hbE1vZGVsc0Zvcihtb2RlbE5hbWUpLl9tb2RlbHM7CiAgICB2YXIgdmlzaWJsZSA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbGwubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1vZGVsID0gYWxsW2ldOwogICAgICBpZiAobW9kZWwuaXNIaWRkZW5Gcm9tUmVjb3JkQXJyYXlzKCkgPT09IGZhbHNlKSB7CiAgICAgICAgdmlzaWJsZS5wdXNoKG1vZGVsKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZpc2libGU7CiAgfQoKICAvKioKICAgIENyZWF0ZSBhIGBEUy5SZWNvcmRBcnJheWAgZm9yIGEgbW9kZWxOYW1lLgogICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkQXJyYXkKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEBwYXJhbSB7QXJyYXl9IF9jb250ZW50IChvcHRpb25hbHxwcml2YXRlKQogICAgQHJldHVybiB7RFMuUmVjb3JkQXJyYXl9CiAgKi8KICBjcmVhdGVSZWNvcmRBcnJheShtb2RlbE5hbWUsIGNvbnRlbnQpIHsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgcmVjb3JkQXJyYXlNYW5nZXIuY3JlYXRlUmVjb3JkQXJyYXkgZXhwZWN0cyBtb2RlbE5hbWUgbm90IG1vZGVsQ2xhc3MgYXMgdGhlIHBhcmFtYCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIGFycmF5ID0gUmVjb3JkQXJyYXkuY3JlYXRlKHsKICAgICAgbW9kZWxOYW1lLAogICAgICBjb250ZW50OiBFbWJlci5BKGNvbnRlbnQgfHwgW10pLAogICAgICBzdG9yZTogdGhpcy5zdG9yZSwKICAgICAgaXNMb2FkZWQ6IHRydWUsCiAgICAgIG1hbmFnZXI6IHRoaXMKICAgIH0pOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGNvbnRlbnQpKSB7CiAgICAgIGFzc29jaWF0ZVdpdGhSZWNvcmRBcnJheShjb250ZW50LCBhcnJheSk7CiAgICB9CgogICAgcmV0dXJuIGFycmF5OwogIH0KCiAgLyoqCiAgICBDcmVhdGUgYSBgRFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5YCBmb3IgYSBtb2RlbE5hbWUgd2l0aCBnaXZlbiBxdWVyeS4KICAgICBAbWV0aG9kIGNyZWF0ZUFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheQogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICBAcmV0dXJuIHtEUy5BZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXl9CiAgKi8KICBjcmVhdGVBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXkobW9kZWxOYW1lLCBxdWVyeSwgaW50ZXJuYWxNb2RlbHMsIHBheWxvYWQpIHsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgcmVjb3JkQXJyYXlNYW5nZXIuY3JlYXRlQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5IGV4cGVjdHMgbW9kZWxOYW1lIG5vdCBtb2RlbENsYXNzIGFzIHRoZSBmaXJzdCBwYXJhbSwgcmVjZWl2ZWQgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIGFycmF5ID0gdm9pZCAwOwogICAgaWYgKEFycmF5LmlzQXJyYXkoaW50ZXJuYWxNb2RlbHMpKSB7CiAgICAgIGFycmF5ID0gQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgICAgbW9kZWxOYW1lLAogICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICBjb250ZW50OiBFbWJlci5BKGludGVybmFsTW9kZWxzKSwKICAgICAgICBzdG9yZTogdGhpcy5zdG9yZSwKICAgICAgICBtYW5hZ2VyOiB0aGlzLAogICAgICAgIGlzTG9hZGVkOiB0cnVlLAogICAgICAgIGlzVXBkYXRpbmc6IGZhbHNlLAogICAgICAgIG1ldGE6IGNsb25lTnVsbChwYXlsb2FkLm1ldGEpLAogICAgICAgIGxpbmtzOiBjbG9uZU51bGwocGF5bG9hZC5saW5rcykKICAgICAgfSk7CgogICAgICBhc3NvY2lhdGVXaXRoUmVjb3JkQXJyYXkoaW50ZXJuYWxNb2RlbHMsIGFycmF5KTsKICAgIH0gZWxzZSB7CiAgICAgIGFycmF5ID0gQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5LmNyZWF0ZSh7CiAgICAgICAgbW9kZWxOYW1lLAogICAgICAgIHF1ZXJ5OiBxdWVyeSwKICAgICAgICBjb250ZW50OiBFbWJlci5BKCksCiAgICAgICAgc3RvcmU6IHRoaXMuc3RvcmUsCiAgICAgICAgbWFuYWdlcjogdGhpcwogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLl9hZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlzLnB1c2goYXJyYXkpOwoKICAgIHJldHVybiBhcnJheTsKICB9CgogIC8qKgogICAgVW5yZWdpc3RlciBhIFJlY29yZEFycmF5LgogICAgU28gbWFuYWdlciB3aWxsIG5vdCB1cGRhdGUgdGhpcyBhcnJheS4KICAgICBAbWV0aG9kIHVucmVnaXN0ZXJSZWNvcmRBcnJheQogICAgQHBhcmFtIHtEUy5SZWNvcmRBcnJheX0gYXJyYXkKICAqLwogIHVucmVnaXN0ZXJSZWNvcmRBcnJheShhcnJheSkgewoKICAgIHZhciBtb2RlbE5hbWUgPSBhcnJheS5tb2RlbE5hbWU7CgogICAgLy8gcmVtb3ZlIGZyb20gYWRhcHRlciBwb3B1bGF0ZWQgcmVjb3JkIGFycmF5CiAgICB2YXIgcmVtb3ZlZEZyb21BZGFwdGVyUG9wdWxhdGVkID0gcmVtb3ZlKHRoaXMuX2FkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMsIGFycmF5KTsKCiAgICBpZiAoIXJlbW92ZWRGcm9tQWRhcHRlclBvcHVsYXRlZCkgewoKICAgICAgdmFyIGxpdmVSZWNvcmRBcnJheUZvclR5cGUgPSB0aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV07CiAgICAgIC8vIHVucmVnaXN0ZXIgbGl2ZSByZWNvcmQgYXJyYXkKICAgICAgaWYgKGxpdmVSZWNvcmRBcnJheUZvclR5cGUpIHsKICAgICAgICBpZiAoYXJyYXkgPT09IGxpdmVSZWNvcmRBcnJheUZvclR5cGUpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl9saXZlUmVjb3JkQXJyYXlzW21vZGVsTmFtZV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB3aWxsRGVzdHJveSgpIHsKICAgIE9iamVjdC5rZXlzKHRoaXMuX2xpdmVSZWNvcmRBcnJheXMpLmZvckVhY2gobW9kZWxOYW1lID0+IHRoaXMuX2xpdmVSZWNvcmRBcnJheXNbbW9kZWxOYW1lXS5kZXN0cm95KCkpOwogICAgdGhpcy5fYWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5cy5mb3JFYWNoKGRlc3Ryb3kpOwogICAgdGhpcy5pc0Rlc3Ryb3llZCA9IHRydWU7CiAgfQoKICBkZXN0cm95KCkgewogICAgdGhpcy5pc0Rlc3Ryb3lpbmcgPSB0cnVlOwogICAgZW1iZXJSdW4kMS5zY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMud2lsbERlc3Ryb3kpOwogIH0KfQoKZnVuY3Rpb24gZGVzdHJveShlbnRyeSkgewogIGVudHJ5LmRlc3Ryb3koKTsKfQoKZnVuY3Rpb24gcmVtb3ZlKGFycmF5LCBpdGVtKSB7CiAgdmFyIGluZGV4ID0gYXJyYXkuaW5kZXhPZihpdGVtKTsKCiAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiB1cGRhdGVMaXZlUmVjb3JkQXJyYXkoYXJyYXksIGludGVybmFsTW9kZWxzKSB7CiAgdmFyIG1vZGVsc1RvQWRkID0gW107CiAgdmFyIG1vZGVsc1RvUmVtb3ZlID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbHNbaV07CiAgICB2YXIgaXNEZWxldGVkID0gaW50ZXJuYWxNb2RlbC5pc0hpZGRlbkZyb21SZWNvcmRBcnJheXMoKTsKICAgIHZhciByZWNvcmRBcnJheXMgPSBpbnRlcm5hbE1vZGVsLl9yZWNvcmRBcnJheXM7CgogICAgaWYgKCFpc0RlbGV0ZWQgJiYgIWludGVybmFsTW9kZWwuaXNFbXB0eSgpKSB7CiAgICAgIGlmICghcmVjb3JkQXJyYXlzLmhhcyhhcnJheSkpIHsKICAgICAgICBtb2RlbHNUb0FkZC5wdXNoKGludGVybmFsTW9kZWwpOwogICAgICAgIHJlY29yZEFycmF5cy5hZGQoYXJyYXkpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVsZXRlZCkgewogICAgICBtb2RlbHNUb1JlbW92ZS5wdXNoKGludGVybmFsTW9kZWwpOwogICAgICByZWNvcmRBcnJheXMuZGVsZXRlKGFycmF5KTsKICAgIH0KICB9CgogIGlmIChtb2RlbHNUb0FkZC5sZW5ndGggPiAwKSB7CiAgICBhcnJheS5fcHVzaEludGVybmFsTW9kZWxzKG1vZGVsc1RvQWRkKTsKICB9CiAgaWYgKG1vZGVsc1RvUmVtb3ZlLmxlbmd0aCA+IDApIHsKICAgIGFycmF5Ll9yZW1vdmVJbnRlcm5hbE1vZGVscyhtb2RlbHNUb1JlbW92ZSk7CiAgfQoKICAvLyByZXR1cm4gd2hldGhlciB3ZSBwZXJmb3JtZWQgYW4gdXBkYXRlLgogIC8vIE5lY2Vzc2FyeSB1bnRpbCAzLjUgYWxsb3dzIHVzIHRvIGZpbmlzaCBvZmYgZW1iZXItZGF0YS1maWx0ZXIgc3VwcG9ydC4KICByZXR1cm4gKG1vZGVsc1RvQWRkLmxlbmd0aCB8fCBtb2RlbHNUb1JlbW92ZS5sZW5ndGgpID4gMDsKfQoKZnVuY3Rpb24gcmVtb3ZlRnJvbUFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheXMoaW50ZXJuYWxNb2RlbHMpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IGludGVybmFsTW9kZWxzW2ldOwogICAgdmFyIGxpc3QgPSBpbnRlcm5hbE1vZGVsLl9yZWNvcmRBcnJheXMubGlzdDsKCiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKyspIHsKICAgICAgLy8gVE9ETzogZ3JvdXAgYnkgYXJyYXlzLCBzbyB3ZSBjYW4gYmF0Y2ggcmVtb3ZlCiAgICAgIGxpc3Rbal0uX3JlbW92ZUludGVybmFsTW9kZWxzKFtpbnRlcm5hbE1vZGVsXSk7CiAgICB9CgogICAgaW50ZXJuYWxNb2RlbC5fcmVjb3JkQXJyYXlzLmNsZWFyKCk7CiAgfQp9CgpmdW5jdGlvbiBhc3NvY2lhdGVXaXRoUmVjb3JkQXJyYXkoaW50ZXJuYWxNb2RlbHMsIGFycmF5KSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBpbnRlcm5hbE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gaW50ZXJuYWxNb2RlbHNbaV07CiAgICBpbnRlcm5hbE1vZGVsLl9yZWNvcmRBcnJheXMuYWRkKGFycmF5KTsKICB9Cn0KCnZhciBiYWNrYnVybmVyID0gbmV3IEVtYmVyLl9CYWNrYnVybmVyKFsnbm9ybWFsaXplUmVsYXRpb25zaGlwcycsICdzeW5jUmVsYXRpb25zaGlwcycsICdmaW5pc2hlZCddKTsKCnsKICBFbWJlci5UZXN0LnJlZ2lzdGVyV2FpdGVyKCgpID0+IHsKICAgIHJldHVybiAhYmFja2J1cm5lci5jdXJyZW50SW5zdGFuY2UgJiYgIWJhY2tidXJuZXIuaGFzVGltZXJzKCk7CiAgfSk7Cn0KCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKdmFyIGJhZElkRm9ybWF0QXNzZXJ0aW9uID0gJ2BpZGAgcGFzc2VkIHRvIGBmaW5kUmVjb3JkKClgIGhhcyB0byBiZSBub24tZW1wdHkgc3RyaW5nIG9yIG51bWJlcic7CnZhciBlbWJlclJ1biA9IEVtYmVyLnJ1bi5iYWNrYnVybmVyOwp2YXIgeyBFTlYgfSA9IEVtYmVyOwoKLy9HZXQgdGhlIG1hdGVyaWFsaXplZCBtb2RlbCBmcm9tIHRoZSBpbnRlcm5hbE1vZGVsL3Byb21pc2UgdGhhdCByZXR1cm5zCi8vYW4gaW50ZXJuYWwgbW9kZWwgYW5kIHJldHVybiBpdCBpbiBhIHByb21pc2VPYmplY3QuIFVzZWZ1bCBmb3IgcmV0dXJuaW5nCi8vZnJvbSBmaW5kIG1ldGhvZHMKZnVuY3Rpb24gcHJvbWlzZVJlY29yZChpbnRlcm5hbE1vZGVsUHJvbWlzZSwgbGFiZWwpIHsKICB2YXIgdG9SZXR1cm4gPSBpbnRlcm5hbE1vZGVsUHJvbWlzZS50aGVuKGludGVybmFsTW9kZWwgPT4gaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKSk7CgogIHJldHVybiBwcm9taXNlT2JqZWN0KHRvUmV0dXJuLCBsYWJlbCk7Cn0KCnZhciBTdG9yZSA9IHZvaWQgMDsKCi8vIEltcGxlbWVudG9ycyBOb3RlOgovLwovLyAgIFRoZSB2YXJpYWJsZXMgaW4gdGhpcyBmaWxlIGFyZSBjb25zaXN0ZW50bHkgbmFtZWQgYWNjb3JkaW5nIHRvIHRoZSBmb2xsb3dpbmcKLy8gICBzY2hlbWU6Ci8vCi8vICAgKiAraWQrIG1lYW5zIGFuIGlkZW50aWZpZXIgbWFuYWdlZCBieSBhbiBleHRlcm5hbCBzb3VyY2UsIHByb3ZpZGVkIGluc2lkZQovLyAgICAgdGhlIGRhdGEgcHJvdmlkZWQgYnkgdGhhdCBzb3VyY2UuIFRoZXNlIGFyZSBhbHdheXMgY29lcmNlZCB0byBiZSBzdHJpbmdzCi8vICAgICBiZWZvcmUgYmVpbmcgdXNlZCBpbnRlcm5hbGx5LgovLyAgICogK2NsaWVudElkKyBtZWFucyBhIHRyYW5zaWVudCBudW1lcmljYWwgaWRlbnRpZmllciBnZW5lcmF0ZWQgYXQgcnVudGltZSBieQovLyAgICAgdGhlIGRhdGEgc3RvcmUuIEl0IGlzIGltcG9ydGFudCBwcmltYXJpbHkgYmVjYXVzZSBuZXdseSBjcmVhdGVkIG9iamVjdHMgbWF5Ci8vICAgICBub3QgeWV0IGhhdmUgYW4gZXh0ZXJuYWxseSBnZW5lcmF0ZWQgaWQuCi8vICAgKiAraW50ZXJuYWxNb2RlbCsgbWVhbnMgYSByZWNvcmQgaW50ZXJuYWxNb2RlbCBvYmplY3QsIHdoaWNoIGhvbGRzIG1ldGFkYXRhIGFib3V0IGEKLy8gICAgIHJlY29yZCwgZXZlbiBpZiBpdCBoYXMgbm90IHlldCBiZWVuIGZ1bGx5IG1hdGVyaWFsaXplZC4KLy8gICAqICt0eXBlKyBtZWFucyBhIERTLk1vZGVsLgoKLyoqCiAgVGhlIHN0b3JlIGNvbnRhaW5zIGFsbCBvZiB0aGUgZGF0YSBmb3IgcmVjb3JkcyBsb2FkZWQgZnJvbSB0aGUgc2VydmVyLgogIEl0IGlzIGFsc28gcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGluc3RhbmNlcyBvZiBgRFMuTW9kZWxgIHRoYXQgd3JhcAogIHRoZSBpbmRpdmlkdWFsIGRhdGEgZm9yIGEgcmVjb3JkLCBzbyB0aGF0IHRoZXkgY2FuIGJlIGJvdW5kIHRvIGluIHlvdXIKICBIYW5kbGViYXJzIHRlbXBsYXRlcy4KCiAgRGVmaW5lIHlvdXIgYXBwbGljYXRpb24ncyBzdG9yZSBsaWtlIHRoaXM6CgogIGBgYGFwcC9zZXJ2aWNlcy9zdG9yZS5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuU3RvcmUuZXh0ZW5kKHsKICB9KTsKICBgYGAKCiAgTW9zdCBFbWJlci5qcyBhcHBsaWNhdGlvbnMgd2lsbCBvbmx5IGhhdmUgYSBzaW5nbGUgYERTLlN0b3JlYCB0aGF0IGlzCiAgYXV0b21hdGljYWxseSBjcmVhdGVkIGJ5IHRoZWlyIGBFbWJlci5BcHBsaWNhdGlvbmAuCgogIFlvdSBjYW4gcmV0cmlldmUgbW9kZWxzIGZyb20gdGhlIHN0b3JlIGluIHNldmVyYWwgd2F5cy4gVG8gcmV0cmlldmUgYSByZWNvcmQKICBmb3IgYSBzcGVjaWZpYyBpZCwgdXNlIGBEUy5TdG9yZWAncyBgZmluZFJlY29yZCgpYCBtZXRob2Q6CgogIGBgYGphdmFzY3JpcHQKICBzdG9yZS5maW5kUmVjb3JkKCdwZXJzb24nLCAxMjMpLnRoZW4oZnVuY3Rpb24gKHBlcnNvbikgewogIH0pOwogIGBgYAoKICBCeSBkZWZhdWx0LCB0aGUgc3RvcmUgd2lsbCB0YWxrIHRvIHlvdXIgYmFja2VuZCB1c2luZyBhIHN0YW5kYXJkCiAgUkVTVCBtZWNoYW5pc20uIFlvdSBjYW4gY3VzdG9taXplIGhvdyB0aGUgc3RvcmUgdGFsa3MgdG8geW91cgogIGJhY2tlbmQgYnkgc3BlY2lmeWluZyBhIGN1c3RvbSBhZGFwdGVyOgoKICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICB9KTsKICBgYGAKCiAgWW91IGNhbiBsZWFybiBtb3JlIGFib3V0IHdyaXRpbmcgYSBjdXN0b20gYWRhcHRlciBieSByZWFkaW5nIHRoZSBgRFMuQWRhcHRlcmAKICBkb2N1bWVudGF0aW9uLgoKICAjIyMgU3RvcmUgY3JlYXRlUmVjb3JkKCkgdnMuIHB1c2goKSB2cy4gcHVzaFBheWxvYWQoKQoKICBUaGUgc3RvcmUgcHJvdmlkZXMgbXVsdGlwbGUgd2F5cyB0byBjcmVhdGUgbmV3IHJlY29yZCBvYmplY3RzLiBUaGV5IGhhdmUKICBzb21lIHN1YnRsZSBkaWZmZXJlbmNlcyBpbiB0aGVpciB1c2Ugd2hpY2ggYXJlIGRldGFpbGVkIGJlbG93OgoKICBbY3JlYXRlUmVjb3JkXSgjbWV0aG9kX2NyZWF0ZVJlY29yZCkgaXMgdXNlZCBmb3IgY3JlYXRpbmcgbmV3CiAgcmVjb3JkcyBvbiB0aGUgY2xpZW50IHNpZGUuIFRoaXMgd2lsbCByZXR1cm4gYSBuZXcgcmVjb3JkIGluIHRoZQogIGBjcmVhdGVkLnVuY29tbWl0dGVkYCBzdGF0ZS4gSW4gb3JkZXIgdG8gcGVyc2lzdCB0aGlzIHJlY29yZCB0byB0aGUKICBiYWNrZW5kIHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBgcmVjb3JkLnNhdmUoKWAuCgogIFtwdXNoXSgjbWV0aG9kX3B1c2gpIGlzIHVzZWQgdG8gbm90aWZ5IEVtYmVyIERhdGEncyBzdG9yZSBvZiBuZXcgb3IKICB1cGRhdGVkIHJlY29yZHMgdGhhdCBleGlzdCBpbiB0aGUgYmFja2VuZC4gVGhpcyB3aWxsIHJldHVybiBhIHJlY29yZAogIGluIHRoZSBgbG9hZGVkLnNhdmVkYCBzdGF0ZS4gVGhlIHByaW1hcnkgdXNlLWNhc2UgZm9yIGBzdG9yZSNwdXNoYCBpcwogIHRvIG5vdGlmeSBFbWJlciBEYXRhIGFib3V0IHJlY29yZCB1cGRhdGVzIChmdWxsIG9yIHBhcnRpYWwpIHRoYXQgaGFwcGVuCiAgb3V0c2lkZSBvZiB0aGUgbm9ybWFsIGFkYXB0ZXIgbWV0aG9kcyAoZm9yIGV4YW1wbGUKICBbU1NFXShodHRwOi8vZGV2LnczLm9yZy9odG1sNS9ldmVudHNvdXJjZS8pIG9yIFtXZWIKICBTb2NrZXRzXShodHRwOi8vd3d3LnczLm9yZy9UUi8yMDA5L1dELXdlYnNvY2tldHMtMjAwOTEyMjIvKSkuCgogIFtwdXNoUGF5bG9hZF0oI21ldGhvZF9wdXNoUGF5bG9hZCkgaXMgYSBjb252ZW5pZW5jZSB3cmFwcGVyIGZvcgogIGBzdG9yZSNwdXNoYCB0aGF0IHdpbGwgZGVzZXJpYWxpemUgcGF5bG9hZHMgaWYgdGhlCiAgU2VyaWFsaXplciBpbXBsZW1lbnRzIGEgYHB1c2hQYXlsb2FkYCBtZXRob2QuCgogIE5vdGU6IFdoZW4gY3JlYXRpbmcgYSBuZXcgcmVjb3JkIHVzaW5nIGFueSBvZiB0aGUgYWJvdmUgbWV0aG9kcwogIEVtYmVyIERhdGEgd2lsbCB1cGRhdGUgYERTLlJlY29yZEFycmF5YHMgc3VjaCBhcyB0aG9zZSByZXR1cm5lZCBieQogIGBzdG9yZSNwZWVrQWxsKClgIG9yIGBzdG9yZSNmaW5kQWxsKClgLiBUaGlzIG1lYW5zIGFueQogIGRhdGEgYmluZGluZ3Mgb3IgY29tcHV0ZWQgcHJvcGVydGllcyB0aGF0IGRlcGVuZCBvbiB0aGUgUmVjb3JkQXJyYXkKICB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgc3luY2VkIHRvIGluY2x1ZGUgdGhlIG5ldyBvciB1cGRhdGVkIHJlY29yZAogIHZhbHVlcy4KCiAgQGNsYXNzIFN0b3JlCiAgQG5hbWVzcGFjZSBEUwogIEBleHRlbmRzIEVtYmVyLlNlcnZpY2UKKi8KU3RvcmUgPSBFbWJlci5TZXJ2aWNlLmV4dGVuZCh7CgogIC8qKgogICAgQG1ldGhvZCBpbml0CiAgICBAcHJpdmF0ZQogICovCiAgaW5pdCgpIHsKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICB0aGlzLl9iYWNrYnVybmVyID0gYmFja2J1cm5lcjsKICAgIC8vIGludGVybmFsIGJvb2trZWVwaW5nOyBub3Qgb2JzZXJ2YWJsZQogICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIgPSBuZXcgUmVjb3JkQXJyYXlNYW5hZ2VyKHsgc3RvcmU6IHRoaXMgfSk7CiAgICB0aGlzLl9pZGVudGl0eU1hcCA9IG5ldyBJZGVudGl0eU1hcCgpOwogICAgdGhpcy5fcGVuZGluZ1NhdmUgPSBbXTsKICAgIHRoaXMuX21vZGVsRmFjdG9yeUNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMuX3JlbGF0aW9uc2hpcHNQYXlsb2FkcyA9IG5ldyBSZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXIodGhpcyk7CgogICAgLyoKICAgICAgRW1iZXIgRGF0YSB1c2VzIHNldmVyYWwgc3BlY2lhbGl6ZWQgbWljcm8tcXVldWVzIGZvciBvcmdhbml6aW5nCiAgICAgIGFuZCBjb2FsZXNjaW5nIHNpbWlsYXIgYXN5bmMgd29yay4KICAgICAgIFRoZXNlIHF1ZXVlcyBhcmUgY3VycmVudGx5IGNvbnRyb2xsZWQgYnkgYSBmbHVzaCBzY2hlZHVsZWQgaW50bwogICAgICBlbWJlci1kYXRhJ3MgY3VzdG9tIGJhY2tidXJuZXIgaW5zdGFuY2UuCiAgICAgKi8KICAgIC8vIHVzZWQgZm9yIGNvYWxlc2NpbmcgcmVjb3JkIHNhdmUgcmVxdWVzdHMKICAgIHRoaXMuX3BlbmRpbmdTYXZlID0gW107CiAgICAvLyB1c2VkIGZvciBjb2FsZXNjaW5nIHJlbGF0aW9uc2hpcCB1cGRhdGVzCiAgICB0aGlzLl91cGRhdGVkUmVsYXRpb25zaGlwcyA9IFtdOwogICAgLy8gdXNlZCBmb3IgY29hbGVzY2luZyByZWxhdGlvbnNoaXAgc2V0dXAgbmVlZHMKICAgIHRoaXMuX3B1c2hlZEludGVybmFsTW9kZWxzID0gW107CiAgICAvLyB1c2VkIGZvciBjb2FsZXNjaW5nIGludGVybmFsIG1vZGVsIHVwZGF0ZXMKICAgIHRoaXMuX3VwZGF0ZWRJbnRlcm5hbE1vZGVscyA9IFtdOwoKICAgIC8vIHVzZWQgdG8ga2VlcCB0cmFjayBvZiBhbGwgdGhlIGZpbmQgcmVxdWVzdHMgdGhhdCBuZWVkIHRvIGJlIGNvYWxlc2NlZAogICAgdGhpcy5fcGVuZGluZ0ZldGNoID0gbmV3IE1hcFdpdGhEZWZhdWx0KHsgZGVmYXVsdFZhbHVlKCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfSB9KTsKCiAgICB0aGlzLl9hZGFwdGVyQ2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5fc2VyaWFsaXplckNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9LAoKICAvKioKICAgIFRoZSBkZWZhdWx0IGFkYXB0ZXIgdG8gdXNlIHRvIGNvbW11bmljYXRlIHRvIGEgYmFja2VuZCBzZXJ2ZXIgb3IKICAgIG90aGVyIHBlcnNpc3RlbmNlIGxheWVyLiBUaGlzIHdpbGwgYmUgb3ZlcnJpZGRlbiBieSBhbiBhcHBsaWNhdGlvbgogICAgYWRhcHRlciBpZiBwcmVzZW50LgogICAgIElmIHlvdSB3YW50IHRvIHNwZWNpZnkgYGFwcC9hZGFwdGVycy9jdXN0b20uanNgIGFzIGEgc3RyaW5nLCBkbzoKICAgICBgYGBqcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgIGV4cG9ydCBkZWZhdWx0IERTLlN0b3JlLmV4dGVuZCh7CiAgICAgIGFkYXB0ZXI6ICdjdXN0b20nLAogICAgfSk7CiAgICBgYGAKICAgICBAcHJvcGVydHkgYWRhcHRlcgogICAgQGRlZmF1bHQgJy1qc29uLWFwaScKICAgIEB0eXBlIHtTdHJpbmd9CiAgKi8KICBhZGFwdGVyOiAnLWpzb24tYXBpJywKCiAgLyoqCiAgICBSZXR1cm5zIGEgSlNPTiByZXByZXNlbnRhdGlvbiBvZiB0aGUgcmVjb3JkIHVzaW5nIGEgY3VzdG9tCiAgICB0eXBlLXNwZWNpZmljIHNlcmlhbGl6ZXIsIGlmIG9uZSBleGlzdHMuCiAgICAgVGhlIGF2YWlsYWJsZSBvcHRpb25zIGFyZToKICAgICAqIGBpbmNsdWRlSWRgOiBgdHJ1ZWAgaWYgdGhlIHJlY29yZCdzIElEIHNob3VsZCBiZSBpbmNsdWRlZCBpbgogICAgICB0aGUgSlNPTiByZXByZXNlbnRhdGlvbgogICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICBAcHJpdmF0ZQogICAgQGRlcHJlY2F0ZWQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZCB0aGUgcmVjb3JkIHRvIHNlcmlhbGl6ZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgYW4gb3B0aW9ucyBoYXNoCiAgKi8KICBzZXJpYWxpemUocmVjb3JkLCBvcHRpb25zKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5kZXByZWNhdGUoJ1VzZSBvZiBzdG9yZS5zZXJpYWxpemUgaXMgZGVwcmVjYXRlZCwgdXNlIHJlY29yZC5zZXJpYWxpemUgaW5zdGVhZC4nLCBmYWxzZSwgewogICAgICBpZDogJ2RzLnN0b3JlLnNlcmlhbGl6ZScsCiAgICAgIHVudGlsOiAnMy4wJwogICAgfSkpOwoKCiAgICB2YXIgc25hcHNob3QgPSByZWNvcmQuX2ludGVybmFsTW9kZWwuY3JlYXRlU25hcHNob3QoKTsKICAgIHJldHVybiBzbmFwc2hvdC5zZXJpYWxpemUob3B0aW9ucyk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIHByb3BlcnR5IHJldHVybnMgdGhlIGFkYXB0ZXIsIGFmdGVyIHJlc29sdmluZyBhIHBvc3NpYmxlCiAgICBzdHJpbmcga2V5LgogICAgIElmIHRoZSBzdXBwbGllZCBgYWRhcHRlcmAgd2FzIGEgY2xhc3MsIG9yIGEgU3RyaW5nIHByb3BlcnR5CiAgICBwYXRoIHJlc29sdmVkIHRvIGEgY2xhc3MsIHRoaXMgcHJvcGVydHkgd2lsbCBpbnN0YW50aWF0ZSB0aGUKICAgIGNsYXNzLgogICAgIFRoaXMgcHJvcGVydHkgaXMgY2FjaGVhYmxlLCBzbyB0aGUgc2FtZSBpbnN0YW5jZSBvZiBhIHNwZWNpZmllZAogICAgYWRhcHRlciBjbGFzcyBzaG91bGQgYmUgdXNlZCBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBzdG9yZS4KICAgICBAcHJvcGVydHkgZGVmYXVsdEFkYXB0ZXIKICAgIEBwcml2YXRlCiAgICBAcmV0dXJuIERTLkFkYXB0ZXIKICAqLwogIGRlZmF1bHRBZGFwdGVyOiBFbWJlci5jb21wdXRlZCgnYWRhcHRlcicsIGZ1bmN0aW9uICgpIHsKICAgIHZhciBhZGFwdGVyID0gRW1iZXIuZ2V0KHRoaXMsICdhZGFwdGVyJyk7CgogICAgKHRydWUgJiYgISh0eXBlb2YgYWRhcHRlciA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydCgnWW91IHRyaWVkIHRvIHNldCBgYWRhcHRlcmAgcHJvcGVydHkgdG8gYW4gaW5zdGFuY2Ugb2YgYERTLkFkYXB0ZXJgLCB3aGVyZSBpdCBzaG91bGQgYmUgYSBuYW1lJywgdHlwZW9mIGFkYXB0ZXIgPT09ICdzdHJpbmcnKSk7CgoKICAgIHJldHVybiB0aGlzLmFkYXB0ZXJGb3IoYWRhcHRlcik7CiAgfSksCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIC4gQ1JFQVRFIE5FVyBSRUNPUkQgLgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLgoKICAvKioKICAgIENyZWF0ZSBhIG5ldyByZWNvcmQgaW4gdGhlIGN1cnJlbnQgc3RvcmUuIFRoZSBwcm9wZXJ0aWVzIHBhc3NlZAogICAgdG8gdGhpcyBtZXRob2QgYXJlIHNldCBvbiB0aGUgbmV3bHkgY3JlYXRlZCByZWNvcmQuCiAgICAgVG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgYFBvc3RgOgogICAgIGBgYGpzCiAgICBzdG9yZS5jcmVhdGVSZWNvcmQoJ3Bvc3QnLCB7CiAgICAgIHRpdGxlOiAnUmFpbHMgaXMgb21ha2FzZScKICAgIH0pOwogICAgYGBgCiAgICAgVG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgYFBvc3RgIHRoYXQgaGFzIGEgcmVsYXRpb25zaGlwIHdpdGggYSBgVXNlcmAgcmVjb3JkOgogICAgIGBgYGpzCiAgICBsZXQgdXNlciA9IHRoaXMuc3RvcmUucGVla1JlY29yZCgndXNlcicsIDEpOwogICAgc3RvcmUuY3JlYXRlUmVjb3JkKCdwb3N0JywgewogICAgICB0aXRsZTogJ1JhaWxzIGlzIG9tYWthc2UnLAogICAgICB1c2VyOiB1c2VyCiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0ge09iamVjdH0gaW5wdXRQcm9wZXJ0aWVzIGEgaGFzaCBvZiBwcm9wZXJ0aWVzIHRvIHNldCBvbiB0aGUKICAgICAgbmV3bHkgY3JlYXRlZCByZWNvcmQuCiAgICBAcmV0dXJuIHtEUy5Nb2RlbH0gcmVjb3JkCiAgKi8KICBjcmVhdGVSZWNvcmQobW9kZWxOYW1lLCBpbnB1dFByb3BlcnRpZXMpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgY3JlYXRlUmVjb3JkIG1ldGhvZGAsIEVtYmVyLmlzUHJlc2VudChtb2RlbE5hbWUpKSk7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSAmJiBFbWJlci5hc3NlcnQoYFBhc3NpbmcgY2xhc3NlcyB0byBzdG9yZSBtZXRob2RzIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSBwYXNzIGEgZGFzaGVyaXplZCBzdHJpbmcgaW5zdGVhZCBvZiAke21vZGVsTmFtZX1gLCB0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykpOwoKICAgIC8vIFRoaXMgaXMgd3JhcHBlZCBpbiBhIGBydW4uam9pbmAgc28gdGhhdCBpbiB0ZXN0IGVudmlyb25tZW50cyB1c2VycyBkbyBub3QgbmVlZCB0byBtYW51YWxseSB3cmFwCiAgICAvLyAgIGNhbGxzIHRvIGBjcmVhdGVSZWNvcmRgLiBUaGUgcnVuIGxvb3AgdXNhZ2UgaGVyZSBpcyBiZWNhdXNlIHdlIGJhdGNoIHRoZSBqb2luaW5nIGFuZCB1cGRhdGluZwogICAgLy8gICBvZiByZWNvcmQtYXJyYXlzIHZpYSBlbWJlcidzIHJ1biBsb29wLCBub3Qgb3VyIG93bi4KICAgIC8vCiAgICAvLyAgIHRvIHJlbW92ZSB0aGlzLCB3ZSB3b3VsZCBuZWVkIHRvIG1vdmUgdG8gYSBuZXcgYGFzeW5jYCBBUEkuCgogICAgcmV0dXJuIGVtYmVyUnVuLmpvaW4oKCkgPT4gewogICAgICByZXR1cm4gdGhpcy5fYmFja2J1cm5lci5qb2luKCgpID0+IHsKICAgICAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgICAgIHZhciBwcm9wZXJ0aWVzID0gRW1iZXIuYXNzaWduKHt9LCBpbnB1dFByb3BlcnRpZXMpOwoKICAgICAgICAvLyBJZiB0aGUgcGFzc2VkIHByb3BlcnRpZXMgZG8gbm90IGluY2x1ZGUgYSBwcmltYXJ5IGtleSwKICAgICAgICAvLyBnaXZlIHRoZSBhZGFwdGVyIGFuIG9wcG9ydHVuaXR5IHRvIGdlbmVyYXRlIG9uZS4gVHlwaWNhbGx5LAogICAgICAgIC8vIGNsaWVudC1zaWRlIElEIGdlbmVyYXRvcnMgd2lsbCB1c2Ugc29tZXRoaW5nIGxpa2UgdXVpZC5qcwogICAgICAgIC8vIHRvIGF2b2lkIGNvbmZsaWN0cy4KCiAgICAgICAgaWYgKEVtYmVyLmlzTm9uZShwcm9wZXJ0aWVzLmlkKSkgewogICAgICAgICAgcHJvcGVydGllcy5pZCA9IHRoaXMuX2dlbmVyYXRlSWQobm9ybWFsaXplZE1vZGVsTmFtZSwgcHJvcGVydGllcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBDb2VyY2UgSUQgdG8gYSBzdHJpbmcKICAgICAgICBwcm9wZXJ0aWVzLmlkID0gY29lcmNlSWQocHJvcGVydGllcy5pZCk7CgogICAgICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpcy5fYnVpbGRJbnRlcm5hbE1vZGVsKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIHByb3BlcnRpZXMuaWQpOwogICAgICAgIGludGVybmFsTW9kZWwubG9hZGVkRGF0YSgpOwogICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmdldFJlY29yZChwcm9wZXJ0aWVzKTsKICAgICAgfSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgIElmIHBvc3NpYmxlLCB0aGlzIG1ldGhvZCBhc2tzIHRoZSBhZGFwdGVyIHRvIGdlbmVyYXRlIGFuIElEIGZvcgogICAgYSBuZXdseSBjcmVhdGVkIHJlY29yZC4KICAgICBAbWV0aG9kIF9nZW5lcmF0ZUlkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtPYmplY3R9IHByb3BlcnRpZXMgZnJvbSB0aGUgbmV3IHJlY29yZAogICAgQHJldHVybiB7U3RyaW5nfSBpZiB0aGUgYWRhcHRlciBjYW4gZ2VuZXJhdGUgb25lLCBhbiBJRAogICovCiAgX2dlbmVyYXRlSWQobW9kZWxOYW1lLCBwcm9wZXJ0aWVzKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihtb2RlbE5hbWUpOwoKICAgIGlmIChhZGFwdGVyICYmIGFkYXB0ZXIuZ2VuZXJhdGVJZEZvclJlY29yZCkgewogICAgICByZXR1cm4gYWRhcHRlci5nZW5lcmF0ZUlkRm9yUmVjb3JkKHRoaXMsIG1vZGVsTmFtZSwgcHJvcGVydGllcyk7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4KICAvLyAuIERFTEVURSBSRUNPUkQgLgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uCgogIC8qKgogICAgRm9yIHN5bW1ldHJ5LCBhIHJlY29yZCBjYW4gYmUgZGVsZXRlZCB2aWEgdGhlIHN0b3JlLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgcG9zdCA9IHN0b3JlLmNyZWF0ZVJlY29yZCgncG9zdCcsIHsKICAgICAgdGl0bGU6ICdSYWlscyBpcyBvbWFrYXNlJwogICAgfSk7CiAgICAgc3RvcmUuZGVsZXRlUmVjb3JkKHBvc3QpOwogICAgYGBgCiAgICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgIEBwYXJhbSB7RFMuTW9kZWx9IHJlY29yZAogICovCiAgZGVsZXRlUmVjb3JkKHJlY29yZCkgewogICAgcmVjb3JkLmRlbGV0ZVJlY29yZCgpOwogIH0sCgogIC8qKgogICAgRm9yIHN5bW1ldHJ5LCBhIHJlY29yZCBjYW4gYmUgdW5sb2FkZWQgdmlhIHRoZSBzdG9yZS4KICAgIFRoaXMgd2lsbCBjYXVzZSB0aGUgcmVjb3JkIHRvIGJlIGRlc3Ryb3llZCBhbmQgZnJlZWQgdXAgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIDEpLnRoZW4oZnVuY3Rpb24ocG9zdCkgewogICAgICBzdG9yZS51bmxvYWRSZWNvcmQocG9zdCk7CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2QgdW5sb2FkUmVjb3JkCiAgICBAcGFyYW0ge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIHVubG9hZFJlY29yZChyZWNvcmQpIHsKICAgIHJlY29yZC51bmxvYWRSZWNvcmQoKTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uCiAgLy8gLiBGSU5EIFJFQ09SRFMgLgogIC8vIC4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBAbWV0aG9kIGZpbmQKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEBwYXJhbSB7U3RyaW5nfEludGVnZXJ9IGlkCiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgQHByaXZhdGUKICAqLwogIGZpbmQobW9kZWxOYW1lLCBpZCwgb3B0aW9ucykgewogICAgLy8gVGhlIGRlZmF1bHQgYG1vZGVsYCBob29rIGluIFJvdXRlIGNhbGxzIGBmaW5kKG1vZGVsTmFtZSwgaWQpYCwKICAgIC8vIHRoYXQncyB3aHkgd2UgaGF2ZSB0byBrZWVwIHRoaXMgbWV0aG9kIGFyb3VuZCBldmVuIHRob3VnaCBgZmluZFJlY29yZGAgaXMKICAgIC8vIHRoZSBwdWJsaWMgd2F5IHRvIGdldCBhIHJlY29yZCBieSBtb2RlbE5hbWUgYW5kIGlkLgogICAgKHRydWUgJiYgIShhcmd1bWVudHMubGVuZ3RoICE9PSAxKSAmJiBFbWJlci5hc3NlcnQoYFVzaW5nIHN0b3JlLmZpbmQodHlwZSkgaGFzIGJlZW4gcmVtb3ZlZC4gVXNlIHN0b3JlLmZpbmRBbGwobW9kZWxOYW1lKSB0byByZXRyaWV2ZSBhbGwgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLmAsIGFyZ3VtZW50cy5sZW5ndGggIT09IDEpKTsKICAgICh0cnVlICYmICEoIW9wdGlvbnMpICYmIEVtYmVyLmFzc2VydChgQ2FsbGluZyBzdG9yZS5maW5kKG1vZGVsTmFtZSwgaWQsIHsgcHJlbG9hZDogcHJlbG9hZCB9KSBpcyBubyBsb25nZXIgc3VwcG9ydGVkLiBVc2Ugc3RvcmUuZmluZFJlY29yZChtb2RlbE5hbWUsIGlkLCB7IHByZWxvYWQ6IHByZWxvYWQgfSkgaW5zdGVhZC5gLCAhb3B0aW9ucykpOwogICAgKHRydWUgJiYgIShhcmd1bWVudHMubGVuZ3RoID09PSAyKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBuZWVkIHRvIHBhc3MgdGhlIG1vZGVsIG5hbWUgYW5kIGlkIHRvIHRoZSBzdG9yZSdzIGZpbmQgbWV0aG9kYCwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikpOwogICAgKHRydWUgJiYgISh0eXBlb2YgaWQgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBpZCA9PT0gJ251bWJlcicpICYmIEVtYmVyLmFzc2VydChgWW91IGNhbm5vdCBwYXNzICcke2lkfScgYXMgaWQgdG8gdGhlIHN0b3JlJ3MgZmluZCBtZXRob2RgLCB0eXBlb2YgaWQgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiBpZCA9PT0gJ251bWJlcicpKTsKICAgICh0cnVlICYmICEodHlwZW9mIGlkICE9PSAnb2JqZWN0JykgJiYgRW1iZXIuYXNzZXJ0KGBDYWxsaW5nIHN0b3JlLmZpbmQoKSB3aXRoIGEgcXVlcnkgb2JqZWN0IGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQuIFVzZSBzdG9yZS5xdWVyeSgpIGluc3RlYWQuYCwgdHlwZW9mIGlkICE9PSAnb2JqZWN0JykpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgcmV0dXJuIHRoaXMuZmluZFJlY29yZChtb2RlbE5hbWUsIGlkKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSByZWNvcmQgZm9yIGEgZ2l2ZW4gdHlwZSBhbmQgaWQgY29tYmluYXRpb24uCiAgICAgVGhlIGBmaW5kUmVjb3JkYCBtZXRob2Qgd2lsbCBhbHdheXMgcmVzb2x2ZSBpdHMgcHJvbWlzZSB3aXRoIHRoZSBzYW1lCiAgICBvYmplY3QgZm9yIGEgZ2l2ZW4gdHlwZSBhbmQgYGlkYC4KICAgICBUaGUgYGZpbmRSZWNvcmRgIG1ldGhvZCB3aWxsIGFsd2F5cyByZXR1cm4gYSAqKnByb21pc2UqKiB0aGF0IHdpbGwgYmUKICAgIHJlc29sdmVkIHdpdGggdGhlIHJlY29yZC4KICAgICBFeGFtcGxlCiAgICAgYGBgYXBwL3JvdXRlcy9wb3N0LmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIG1vZGVsKHBhcmFtcykgewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRSZWNvcmQoJ3Bvc3QnLCBwYXJhbXMucG9zdF9pZCk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgSWYgdGhlIHJlY29yZCBpcyBub3QgeWV0IGF2YWlsYWJsZSwgdGhlIHN0b3JlIHdpbGwgYXNrIHRoZSBhZGFwdGVyJ3MgYGZpbmRgCiAgICBtZXRob2QgdG8gZmluZCB0aGUgbmVjZXNzYXJ5IGRhdGEuIElmIHRoZSByZWNvcmQgaXMgYWxyZWFkeSBwcmVzZW50IGluIHRoZQogICAgc3RvcmUsIGl0IGRlcGVuZHMgb24gdGhlIHJlbG9hZCBiZWhhdmlvciBfd2hlbl8gdGhlIHJldHVybmVkIHByb21pc2UKICAgIHJlc29sdmVzLgogICAgICMjIyBQcmVsb2FkaW5nCiAgICAgWW91IGNhbiBvcHRpb25hbGx5IGBwcmVsb2FkYCBzcGVjaWZpYyBhdHRyaWJ1dGVzIGFuZCByZWxhdGlvbnNoaXBzIHRoYXQgeW91IGtub3cgb2YKICAgIGJ5IHBhc3NpbmcgdGhlbSB2aWEgdGhlIHBhc3NlZCBgb3B0aW9uc2AuCiAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgRW1iZXIgcm91dGUgbG9va3MgbGlrZSBgL3Bvc3RzLzEvY29tbWVudHMvMmAgYW5kIHlvdXIgQVBJIHJvdXRlCiAgICBmb3IgdGhlIGNvbW1lbnQgYWxzbyBsb29rcyBsaWtlIGAvcG9zdHMvMS9jb21tZW50cy8yYCBpZiB5b3Ugd2FudCB0byBmZXRjaCB0aGUgY29tbWVudAogICAgd2l0aG91dCBmZXRjaGluZyB0aGUgcG9zdCB5b3UgY2FuIHBhc3MgaW4gdGhlIHBvc3QgdG8gdGhlIGBmaW5kUmVjb3JkYCBjYWxsOgogICAgIGBgYGphdmFzY3JpcHQKICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyLCB7IHByZWxvYWQ6IHsgcG9zdDogMSB9IH0pOwogICAgYGBgCiAgICAgSWYgeW91IGhhdmUgYWNjZXNzIHRvIHRoZSBwb3N0IG1vZGVsIHlvdSBjYW4gYWxzbyBwYXNzIHRoZSBtb2RlbCBpdHNlbGY6CiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIDEpLnRoZW4oZnVuY3Rpb24gKG15UG9zdE1vZGVsKSB7CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyLCB7IHBvc3Q6IG15UG9zdE1vZGVsIH0pOwogICAgfSk7CiAgICBgYGAKICAgICAjIyMgUmVsb2FkaW5nCiAgICAgVGhlIHJlbG9hZCBiZWhhdmlvciBpcyBjb25maWd1cmVkIGVpdGhlciB2aWEgdGhlIHBhc3NlZCBgb3B0aW9uc2AgaGFzaCBvcgogICAgdGhlIHJlc3VsdCBvZiB0aGUgYWRhcHRlcidzIGBzaG91bGRSZWxvYWRSZWNvcmRgLgogICAgIElmIGB7IHJlbG9hZDogdHJ1ZSB9YCBpcyBwYXNzZWQgb3IgYGFkYXB0ZXIuc2hvdWxkUmVsb2FkUmVjb3JkYCBldmFsdWF0ZXMKICAgIHRvIGB0cnVlYCwgdGhlbiB0aGUgcmV0dXJuZWQgcHJvbWlzZSByZXNvbHZlcyBvbmNlIHRoZSBhZGFwdGVyIHJldHVybnMKICAgIGRhdGEsIHJlZ2FyZGxlc3MgaWYgdGhlIHJlcXVlc3RlZCByZWNvcmQgaXMgYWxyZWFkeSBpbiB0aGUgc3RvcmU6CiAgICAgYGBganMKICAgIHN0b3JlLnB1c2goewogICAgICBkYXRhOiB7CiAgICAgICAgaWQ6IDEsCiAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgIHJldmlzaW9uOiAxCiAgICAgIH0KICAgIH0pOwogICAgIC8vIGFkYXB0ZXIjZmluZFJlY29yZCByZXNvbHZlcyB3aXRoCiAgICAvLyBbCiAgICAvLyAgIHsKICAgIC8vICAgICBpZDogMSwKICAgIC8vICAgICB0eXBlOiAncG9zdCcsCiAgICAvLyAgICAgcmV2aXNpb246IDIKICAgIC8vICAgfQogICAgLy8gXQogICAgc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIDEsIHsgcmVsb2FkOiB0cnVlIH0pLnRoZW4oZnVuY3Rpb24ocG9zdCkgewogICAgICBwb3N0LmdldCgncmV2aXNpb24nKTsgLy8gMgogICAgfSk7CiAgICBgYGAKICAgICBJZiBubyByZWxvYWQgaXMgaW5kaWNhdGVkIHZpYSB0aGUgYWJvdmVtZW50aW9uZWQgd2F5cywgdGhlbiB0aGUgcHJvbWlzZQogICAgaW1tZWRpYXRlbHkgcmVzb2x2ZXMgd2l0aCB0aGUgY2FjaGVkIHZlcnNpb24gaW4gdGhlIHN0b3JlLgogICAgICMjIyBCYWNrZ3JvdW5kIFJlbG9hZGluZwogICAgIE9wdGlvbmFsbHksIGlmIGBhZGFwdGVyLnNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmRgIGV2YWx1YXRlcyB0byBgdHJ1ZWAsCiAgICB0aGVuIGEgYmFja2dyb3VuZCByZWxvYWQgaXMgc3RhcnRlZCwgd2hpY2ggdXBkYXRlcyB0aGUgcmVjb3JkcycgZGF0YSwgb25jZQogICAgaXQgaXMgYXZhaWxhYmxlOgogICAgIGBgYGpzCiAgICAvLyBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgaW1wb3J0IEFwcGxpY2F0aW9uQWRhcHRlciBmcm9tICIuL2FwcGxpY2F0aW9uIjsKICAgICBleHBvcnQgZGVmYXVsdCBBcHBsaWNhdGlvbkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgc2hvdWxkUmVsb2FkUmVjb3JkKHN0b3JlLCBzbmFwc2hvdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmQoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgIC8vIC4uLgogICAgIHN0b3JlLnB1c2goewogICAgICBkYXRhOiB7CiAgICAgICAgaWQ6IDEsCiAgICAgICAgdHlwZTogJ3Bvc3QnLAogICAgICAgIHJldmlzaW9uOiAxCiAgICAgIH0KICAgIH0pOwogICAgIGxldCBibG9nUG9zdCA9IHN0b3JlLmZpbmRSZWNvcmQoJ3Bvc3QnLCAxKS50aGVuKGZ1bmN0aW9uKHBvc3QpIHsKICAgICAgcG9zdC5nZXQoJ3JldmlzaW9uJyk7IC8vIDEKICAgIH0pOwogICAgIC8vIGxhdGVyLCBvbmNlIGFkYXB0ZXIjZmluZFJlY29yZCByZXNvbHZlZCB3aXRoCiAgICAvLyBbCiAgICAvLyAgIHsKICAgIC8vICAgICBpZDogMSwKICAgIC8vICAgICB0eXBlOiAncG9zdCcsCiAgICAvLyAgICAgcmV2aXNpb246IDIKICAgIC8vICAgfQogICAgLy8gXQogICAgIGJsb2dQb3N0LmdldCgncmV2aXNpb24nKTsgLy8gMgogICAgYGBgCiAgICAgSWYgeW91IHdvdWxkIGxpa2UgdG8gZm9yY2Ugb3IgcHJldmVudCBiYWNrZ3JvdW5kIHJlbG9hZGluZywgeW91IGNhbiBzZXQgYQogICAgYm9vbGVhbiB2YWx1ZSBmb3IgYGJhY2tncm91bmRSZWxvYWRgIGluIHRoZSBvcHRpb25zIG9iamVjdCBmb3IKICAgIGBmaW5kUmVjb3JkYC4KICAgICBgYGBhcHAvcm91dGVzL3Bvc3QvZWRpdC5qcwogICAgaW1wb3J0IFJvdXRlIGZyb20gJ0BlbWJlci9yb3V0aW5nL3JvdXRlJzsKICAgICBleHBvcnQgZGVmYXVsdCBSb3V0ZS5leHRlbmQoewogICAgICBtb2RlbChwYXJhbXMpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgcGFyYW1zLnBvc3RfaWQsIHsgYmFja2dyb3VuZFJlbG9hZDogZmFsc2UgfSk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgSWYgeW91IHBhc3MgYW4gb2JqZWN0IG9uIHRoZSBgYWRhcHRlck9wdGlvbnNgIHByb3BlcnR5IG9mIHRoZSBvcHRpb25zCiAgICBhcmd1bWVudCBpdCB3aWxsIGJlIHBhc3NlZCB0byB5b3UgYWRhcHRlciB2aWEgdGhlIHNuYXBzaG90CiAgICAgYGBgYXBwL3JvdXRlcy9wb3N0L2VkaXQuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkLCB7CiAgICAgICAgICBhZGFwdGVyT3B0aW9uczogeyBzdWJzY3JpYmU6IGZhbHNlIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgaW1wb3J0IE15Q3VzdG9tQWRhcHRlciBmcm9tICcuL2N1c3RvbS1hZGFwdGVyJzsKICAgICBleHBvcnQgZGVmYXVsdCBNeUN1c3RvbUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZmluZFJlY29yZChzdG9yZSwgdHlwZSwgaWQsIHNuYXBzaG90KSB7CiAgICAgICAgaWYgKHNuYXBzaG90LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICAgIC8vIC4uLgogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIFNlZSBbcGVla1JlY29yZF0oI21ldGhvZF9wZWVrUmVjb3JkKSB0byBnZXQgdGhlIGNhY2hlZCB2ZXJzaW9uIG9mIGEgcmVjb3JkLgogICAgICMjIyBSZXRyaWV2aW5nIFJlbGF0ZWQgTW9kZWwgUmVjb3JkcwogICAgIElmIHlvdSB1c2UgYW4gYWRhcHRlciBzdWNoIGFzIEVtYmVyJ3MgZGVmYXVsdAogICAgW2BKU09OQVBJQWRhcHRlcmBdKGh0dHBzOi8vZW1iZXJqcy5jb20vYXBpL2RhdGEvY2xhc3Nlcy9EUy5KU09OQVBJQWRhcHRlci5odG1sKQogICAgdGhhdCBzdXBwb3J0cyB0aGUgW0pTT04gQVBJIHNwZWNpZmljYXRpb25dKGh0dHA6Ly9qc29uYXBpLm9yZy8pIGFuZCBpZiB5b3VyIHNlcnZlcgogICAgZW5kcG9pbnQgc3VwcG9ydHMgdGhlIHVzZSBvZiBhbgogICAgWydpbmNsdWRlJyBxdWVyeSBwYXJhbWV0ZXJdKGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2ZldGNoaW5nLWluY2x1ZGVzKSwKICAgIHlvdSBjYW4gdXNlIGBmaW5kUmVjb3JkKClgIHRvIGF1dG9tYXRpY2FsbHkgcmV0cmlldmUgYWRkaXRpb25hbCByZWNvcmRzIHJlbGF0ZWQgdG8KICAgIHRoZSBvbmUgeW91IHJlcXVlc3QgYnkgc3VwcGx5aW5nIGFuIGBpbmNsdWRlYCBwYXJhbWV0ZXIgaW4gdGhlIGBvcHRpb25zYCBvYmplY3QuCiAgICAgRm9yIGV4YW1wbGUsIGdpdmVuIGEgYHBvc3RgIG1vZGVsIHRoYXQgaGFzIGEgYGhhc01hbnlgIHJlbGF0aW9uc2hpcCB3aXRoIGEgYGNvbW1lbnRgCiAgICBtb2RlbCwgd2hlbiB3ZSByZXRyaWV2ZSBhIHNwZWNpZmljIHBvc3Qgd2UgY2FuIGhhdmUgdGhlIHNlcnZlciBhbHNvIHJldHVybiB0aGF0IHBvc3QncwogICAgY29tbWVudHMgaW4gdGhlIHNhbWUgcmVxdWVzdDoKICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkLCB7IGluY2x1ZGU6ICdjb21tZW50cycgfSk7CiAgICAgIH0KICAgIH0pOwogICAgIGBgYAogICAgSW4gdGhpcyBjYXNlLCB0aGUgcG9zdCdzIGNvbW1lbnRzIHdvdWxkIHRoZW4gYmUgYXZhaWxhYmxlIGluIHlvdXIgdGVtcGxhdGUgYXMKICAgIGBtb2RlbC5jb21tZW50c2AuCiAgICAgTXVsdGlwbGUgcmVsYXRpb25zaGlwcyBjYW4gYmUgcmVxdWVzdGVkIHVzaW5nIGFuIGBpbmNsdWRlYCBwYXJhbWV0ZXIgY29uc2lzdGluZyBvZiBhCiAgICBjb21tYS1zZXBhcmF0ZWQgbGlzdCAod2l0aG91dCB3aGl0ZS1zcGFjZSkgd2hpbGUgbmVzdGVkIHJlbGF0aW9uc2hpcHMgY2FuIGJlIHNwZWNpZmllZAogICAgdXNpbmcgYSBkb3Qtc2VwYXJhdGVkIHNlcXVlbmNlIG9mIHJlbGF0aW9uc2hpcCBuYW1lcy4gU28gdG8gcmVxdWVzdCBib3RoIHRoZSBwb3N0J3MKICAgIGNvbW1lbnRzIGFuZCB0aGUgYXV0aG9ycyBvZiB0aG9zZSBjb21tZW50cyB0aGUgcmVxdWVzdCB3b3VsZCBsb29rIGxpa2UgdGhpczoKICAgICBgYGBhcHAvcm91dGVzL3Bvc3QuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWwocGFyYW1zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZFJlY29yZCgncG9zdCcsIHBhcmFtcy5wb3N0X2lkLCB7IGluY2x1ZGU6ICdjb21tZW50cyxjb21tZW50cy5hdXRob3InIH0pOwogICAgICB9CiAgICB9KTsKICAgICBgYGAKICAgICBAc2luY2UgMS4xMy4wCiAgICBAbWV0aG9kIGZpbmRSZWNvcmQKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEBwYXJhbSB7KFN0cmluZ3xJbnRlZ2VyKX0gaWQKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBmaW5kUmVjb3JkKG1vZGVsTmFtZSwgaWQsIG9wdGlvbnMpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgZmluZFJlY29yZCBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKICAgICh0cnVlICYmICEodHlwZW9mIGlkID09PSAnc3RyaW5nJyAmJiBpZC5sZW5ndGggPiAwIHx8IHR5cGVvZiBpZCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKGlkKSkgJiYgRW1iZXIuYXNzZXJ0KGJhZElkRm9ybWF0QXNzZXJ0aW9uLCB0eXBlb2YgaWQgPT09ICdzdHJpbmcnICYmIGlkLmxlbmd0aCA+IDAgfHwgdHlwZW9mIGlkID09PSAnbnVtYmVyJyAmJiAhaXNOYU4oaWQpKSk7CgoKICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CgogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9pbnRlcm5hbE1vZGVsRm9ySWQobm9ybWFsaXplZE1vZGVsTmFtZSwgaWQpOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCF0aGlzLmhhc1JlY29yZEZvcklkKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIGlkKSkgewogICAgICByZXR1cm4gdGhpcy5fZmluZEJ5SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKICAgIH0KCiAgICB2YXIgZmV0Y2hlZEludGVybmFsTW9kZWwgPSB0aGlzLl9maW5kUmVjb3JkKGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwoKICAgIHJldHVybiBwcm9taXNlUmVjb3JkKGZldGNoZWRJbnRlcm5hbE1vZGVsLCBgRFM6IFN0b3JlI2ZpbmRSZWNvcmQgJHtub3JtYWxpemVkTW9kZWxOYW1lfSB3aXRoIGlkOiAke2lkfWApOwogIH0sCgogIF9maW5kUmVjb3JkKGludGVybmFsTW9kZWwsIG9wdGlvbnMpIHsKICAgIC8vIFJlZmV0Y2ggaWYgdGhlIHJlbG9hZCBvcHRpb24gaXMgcGFzc2VkCiAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICB9CgogICAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKGludGVybmFsTW9kZWwubW9kZWxOYW1lKTsKCiAgICAvLyBSZWZldGNoIHRoZSByZWNvcmQgaWYgdGhlIGFkYXB0ZXIgdGhpbmtzIHRoZSByZWNvcmQgaXMgc3RhbGUKICAgIGlmIChhZGFwdGVyLnNob3VsZFJlbG9hZFJlY29yZCh0aGlzLCBzbmFwc2hvdCkpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuYmFja2dyb3VuZFJlbG9hZCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGludGVybmFsTW9kZWwpOwogICAgfQoKICAgIC8vIFRyaWdnZXIgdGhlIGJhY2tncm91bmQgcmVmZXRjaCBpZiBiYWNrZ3JvdW5kUmVsb2FkIG9wdGlvbiBpcyBwYXNzZWQKICAgIGlmIChvcHRpb25zLmJhY2tncm91bmRSZWxvYWQgfHwgYWRhcHRlci5zaG91bGRCYWNrZ3JvdW5kUmVsb2FkUmVjb3JkKHRoaXMsIHNuYXBzaG90KSkgewogICAgICB0aGlzLl9zY2hlZHVsZUZldGNoKGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwogICAgfQoKICAgIC8vIFJldHVybiB0aGUgY2FjaGVkIHJlY29yZAogICAgcmV0dXJuIEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGludGVybmFsTW9kZWwpOwogIH0sCgogIF9maW5kQnlJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWwsIG9wdGlvbnMgPSB7fSkgewogICAgaWYgKG9wdGlvbnMucHJlbG9hZCkgewogICAgICBpbnRlcm5hbE1vZGVsLnByZWxvYWREYXRhKG9wdGlvbnMucHJlbG9hZCk7CiAgICB9CgogICAgdmFyIGZldGNoZWRJbnRlcm5hbE1vZGVsID0gdGhpcy5fZmluZEVtcHR5SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKTsKCiAgICByZXR1cm4gcHJvbWlzZVJlY29yZChmZXRjaGVkSW50ZXJuYWxNb2RlbCwgYERTOiBTdG9yZSNmaW5kUmVjb3JkICR7aW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9IHdpdGggaWQ6ICR7aW50ZXJuYWxNb2RlbC5pZH1gKTsKICB9LAoKICBfZmluZEVtcHR5SW50ZXJuYWxNb2RlbChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKSB7CiAgICBpZiAoaW50ZXJuYWxNb2RlbC5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIHRoaXMuX3NjaGVkdWxlRmV0Y2goaW50ZXJuYWxNb2RlbCwgb3B0aW9ucyk7CiAgICB9CgogICAgLy9UT0RPIGRvdWJsZSBjaGVjayBhYm91dCByZWxvYWRpbmcKICAgIGlmIChpbnRlcm5hbE1vZGVsLmlzTG9hZGluZygpKSB7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLl9wcm9taXNlUHJveHk7CiAgICB9CgogICAgcmV0dXJuIEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGludGVybmFsTW9kZWwpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgbWFrZXMgYSBzZXJpZXMgb2YgcmVxdWVzdHMgdG8gdGhlIGFkYXB0ZXIncyBgZmluZGAgbWV0aG9kCiAgICBhbmQgcmV0dXJucyBhIHByb21pc2UgdGhhdCByZXNvbHZlcyBvbmNlIHRoZXkgYXJlIGFsbCBsb2FkZWQuCiAgICAgQHByaXZhdGUKICAgIEBtZXRob2QgZmluZEJ5SWRzCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0ge0FycmF5fSBpZHMKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRCeUlkcyhtb2RlbE5hbWUsIGlkcykgewogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgbW9kZWwgbmFtZSB0byB0aGUgc3RvcmUncyBmaW5kQnlJZHMgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpKTsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgUGFzc2luZyBjbGFzc2VzIHRvIHN0b3JlIG1ldGhvZHMgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHBhc3MgYSBkYXNoZXJpemVkIHN0cmluZyBpbnN0ZWFkIG9mICR7bW9kZWxOYW1lfWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgoKICAgIHZhciBwcm9taXNlcyA9IG5ldyBBcnJheShpZHMubGVuZ3RoKTsKCiAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHByb21pc2VzW2ldID0gdGhpcy5maW5kUmVjb3JkKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIGlkc1tpXSk7CiAgICB9CgogICAgcmV0dXJuIHByb21pc2VBcnJheShFbWJlci5SU1ZQLmFsbChwcm9taXNlcykudGhlbihFbWJlci5BLCBudWxsLCBgRFM6IFN0b3JlI2ZpbmRCeUlkcyBvZiAke25vcm1hbGl6ZWRNb2RlbE5hbWV9IGNvbXBsZXRlYCkpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGJ5IGBmaW5kUmVjb3JkYCBpZiBpdCBkaXNjb3ZlcnMgdGhhdCBhIHBhcnRpY3VsYXIKICAgIHR5cGUvaWQgcGFpciBoYXNuJ3QgYmVlbiBsb2FkZWQgeWV0IHRvIGtpY2sgb2ZmIGEgcmVxdWVzdCB0byB0aGUKICAgIGFkYXB0ZXIuCiAgICAgQG1ldGhvZCBfZmV0Y2hSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwgbW9kZWwKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgKi8KICBfZmV0Y2hSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgdmFyIG1vZGVsTmFtZSA9IGludGVybmFsTW9kZWwubW9kZWxOYW1lOwogICAgdmFyIGFkYXB0ZXIgPSB0aGlzLmFkYXB0ZXJGb3IobW9kZWxOYW1lKTsKCiAgICAodHJ1ZSAmJiAhKGFkYXB0ZXIpICYmIEVtYmVyLmFzc2VydChgWW91IHRyaWVkIHRvIGZpbmQgYSByZWNvcmQgYnV0IHlvdSBoYXZlIG5vIGFkYXB0ZXIgKGZvciAke21vZGVsTmFtZX0pYCwgYWRhcHRlcikpOwogICAgKHRydWUgJiYgISh0eXBlb2YgYWRhcHRlci5maW5kUmVjb3JkID09PSAnZnVuY3Rpb24nKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBmaW5kIGEgcmVjb3JkIGJ1dCB5b3VyIGFkYXB0ZXIgKGZvciAke21vZGVsTmFtZX0pIGRvZXMgbm90IGltcGxlbWVudCAnZmluZFJlY29yZCdgLCB0eXBlb2YgYWRhcHRlci5maW5kUmVjb3JkID09PSAnZnVuY3Rpb24nKSk7CgoKICAgIHJldHVybiBfZmluZChhZGFwdGVyLCB0aGlzLCBpbnRlcm5hbE1vZGVsLnR5cGUsIGludGVybmFsTW9kZWwuaWQsIGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwogIH0sCgogIF9zY2hlZHVsZUZldGNoTWFueShpbnRlcm5hbE1vZGVscykgewogICAgdmFyIGZldGNoZXMgPSBuZXcgQXJyYXkoaW50ZXJuYWxNb2RlbHMubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGludGVybmFsTW9kZWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGZldGNoZXNbaV0gPSB0aGlzLl9zY2hlZHVsZUZldGNoKGludGVybmFsTW9kZWxzW2ldKTsKICAgIH0KCiAgICByZXR1cm4gRW1iZXIuUlNWUC5Qcm9taXNlLmFsbChmZXRjaGVzKTsKICB9LAoKICBfc2NoZWR1bGVGZXRjaChpbnRlcm5hbE1vZGVsLCBvcHRpb25zKSB7CiAgICBpZiAoaW50ZXJuYWxNb2RlbC5fcHJvbWlzZVByb3h5KSB7CiAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLl9wcm9taXNlUHJveHk7CiAgICB9CgogICAgdmFyIHsgaWQsIG1vZGVsTmFtZSB9ID0gaW50ZXJuYWxNb2RlbDsKICAgIHZhciByZXNvbHZlciA9IEVtYmVyLlJTVlAuZGVmZXIoYEZldGNoaW5nICR7bW9kZWxOYW1lfScgd2l0aCBpZDogJHtpZH1gKTsKICAgIHZhciBwZW5kaW5nRmV0Y2hJdGVtID0gewogICAgICBpbnRlcm5hbE1vZGVsLAogICAgICByZXNvbHZlciwKICAgICAgb3B0aW9ucwogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IHJlc29sdmVyLnByb21pc2U7CgogICAgaW50ZXJuYWxNb2RlbC5sb2FkaW5nRGF0YShwcm9taXNlKTsKICAgIGlmICh0aGlzLl9wZW5kaW5nRmV0Y2guc2l6ZSA9PT0gMCkgewogICAgICBlbWJlclJ1bi5zY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMuZmx1c2hBbGxQZW5kaW5nRmV0Y2hlcyk7CiAgICB9CgogICAgdGhpcy5fcGVuZGluZ0ZldGNoLmdldChtb2RlbE5hbWUpLnB1c2gocGVuZGluZ0ZldGNoSXRlbSk7CgogICAgcmV0dXJuIHByb21pc2U7CiAgfSwKCiAgZmx1c2hBbGxQZW5kaW5nRmV0Y2hlcygpIHsKICAgIGlmICh0aGlzLmlzRGVzdHJveWVkIHx8IHRoaXMuaXNEZXN0cm95aW5nKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9wZW5kaW5nRmV0Y2guZm9yRWFjaCh0aGlzLl9mbHVzaFBlbmRpbmdGZXRjaEZvclR5cGUsIHRoaXMpOwogICAgdGhpcy5fcGVuZGluZ0ZldGNoLmNsZWFyKCk7CiAgfSwKCiAgX2ZsdXNoUGVuZGluZ0ZldGNoRm9yVHlwZShwZW5kaW5nRmV0Y2hJdGVtcywgbW9kZWxOYW1lKSB7CiAgICB2YXIgc3RvcmUgPSB0aGlzOwogICAgdmFyIGFkYXB0ZXIgPSBzdG9yZS5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CiAgICB2YXIgc2hvdWxkQ29hbGVzY2UgPSAhIWFkYXB0ZXIuZmluZE1hbnkgJiYgYWRhcHRlci5jb2FsZXNjZUZpbmRSZXF1ZXN0czsKICAgIHZhciB0b3RhbEl0ZW1zID0gcGVuZGluZ0ZldGNoSXRlbXMubGVuZ3RoOwogICAgdmFyIGludGVybmFsTW9kZWxzID0gbmV3IEFycmF5KHRvdGFsSXRlbXMpOwogICAgdmFyIHNlZWtpbmcgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCB0b3RhbEl0ZW1zOyBfaSsrKSB7CiAgICAgIHZhciBwZW5kaW5nSXRlbSA9IHBlbmRpbmdGZXRjaEl0ZW1zW19pXTsKICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsID0gcGVuZGluZ0l0ZW0uaW50ZXJuYWxNb2RlbDsKICAgICAgaW50ZXJuYWxNb2RlbHNbX2ldID0gX2ludGVybmFsTW9kZWw7CiAgICAgIHNlZWtpbmdbX2ludGVybmFsTW9kZWwuaWRdID0gcGVuZGluZ0l0ZW07CiAgICB9CgogICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgdG90YWxJdGVtczsgX2kyKyspIHsKICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsMiA9IGludGVybmFsTW9kZWxzW19pMl07CiAgICAgIC8vIFdlIG1heSBoYXZlIHVubG9hZGVkIHRoZSByZWNvcmQgYWZ0ZXIgc2NoZWR1bGluZyB0aGlzIGZldGNoLCBpbiB3aGljaAogICAgICAvLyBjYXNlIHdlIG11c3QgY2FuY2VsIHRoZSBkZXN0cm95LiAgVGhpcyBpcyBiZWNhdXNlIHdlIHJlcXVpcmUgYSByZWNvcmQKICAgICAgLy8gdG8gYnVpbGQgYSBzbmFwc2hvdC4gIFRoaXMgaXMgbm90IGZ1bmRhbWVudGFsOiB0aGlzIGNhbmNlbGF0aW9uIGNvZGUKICAgICAgLy8gY2FuIGJlIHJlbW92ZWQgd2hlbiBzbmFwc2hvdHMgY2FuIGJlIGNyZWF0ZWQgZm9yIGludGVybmFsIG1vZGVscyB0aGF0CiAgICAgIC8vIGhhdmUgbm8gcmVjb3Jkcy4KICAgICAgaWYgKF9pbnRlcm5hbE1vZGVsMi5oYXNTY2hlZHVsZWREZXN0cm95KCkpIHsKICAgICAgICBpbnRlcm5hbE1vZGVsc1tfaTJdLmNhbmNlbERlc3Ryb3koKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIF9mZXRjaFJlY29yZChyZWNvcmRSZXNvbHZlclBhaXIpIHsKICAgICAgdmFyIHJlY29yZEZldGNoID0gc3RvcmUuX2ZldGNoUmVjb3JkKHJlY29yZFJlc29sdmVyUGFpci5pbnRlcm5hbE1vZGVsLCByZWNvcmRSZXNvbHZlclBhaXIub3B0aW9ucyk7IC8vIFRPRE8gYWRhcHRlciBvcHRpb25zCgogICAgICByZWNvcmRSZXNvbHZlclBhaXIucmVzb2x2ZXIucmVzb2x2ZShyZWNvcmRGZXRjaCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlRm91bmRSZWNvcmRzKGZvdW5kSW50ZXJuYWxNb2RlbHMsIGV4cGVjdGVkSW50ZXJuYWxNb2RlbHMpIHsKICAgICAgLy8gcmVzb2x2ZSBmb3VuZCByZWNvcmRzCiAgICAgIHZhciBmb3VuZCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIGZvciAodmFyIF9pMyA9IDAsIF9sID0gZm91bmRJbnRlcm5hbE1vZGVscy5sZW5ndGg7IF9pMyA8IF9sOyBfaTMrKykgewogICAgICAgIHZhciBfaW50ZXJuYWxNb2RlbDMgPSBmb3VuZEludGVybmFsTW9kZWxzW19pM107CiAgICAgICAgdmFyIF9wYWlyID0gc2Vla2luZ1tfaW50ZXJuYWxNb2RlbDMuaWRdOwogICAgICAgIGZvdW5kW19pbnRlcm5hbE1vZGVsMy5pZF0gPSBfaW50ZXJuYWxNb2RlbDM7CgogICAgICAgIGlmIChfcGFpcikgewogICAgICAgICAgdmFyIHJlc29sdmVyID0gX3BhaXIucmVzb2x2ZXI7CiAgICAgICAgICByZXNvbHZlci5yZXNvbHZlKF9pbnRlcm5hbE1vZGVsMyk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyByZWplY3QgbWlzc2luZyByZWNvcmRzCiAgICAgIHZhciBtaXNzaW5nSW50ZXJuYWxNb2RlbHMgPSBbXTsKCiAgICAgIGZvciAodmFyIF9pNCA9IDAsIF9sMiA9IGV4cGVjdGVkSW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBfaTQgPCBfbDI7IF9pNCsrKSB7CiAgICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsNCA9IGV4cGVjdGVkSW50ZXJuYWxNb2RlbHNbX2k0XTsKCiAgICAgICAgaWYgKCFmb3VuZFtfaW50ZXJuYWxNb2RlbDQuaWRdKSB7CiAgICAgICAgICBtaXNzaW5nSW50ZXJuYWxNb2RlbHMucHVzaChfaW50ZXJuYWxNb2RlbDQpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1pc3NpbmdJbnRlcm5hbE1vZGVscy5sZW5ndGgpIHsKICAgICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKCdFbWJlciBEYXRhIGV4cGVjdGVkIHRvIGZpbmQgcmVjb3JkcyB3aXRoIHRoZSBmb2xsb3dpbmcgaWRzIGluIHRoZSBhZGFwdGVyIHJlc3BvbnNlIGJ1dCB0aGV5IHdlcmUgbWlzc2luZzogWyAiJyArIG1pc3NpbmdJbnRlcm5hbE1vZGVscy5tYXAociA9PiByLmlkKS5qb2luKCciLCAiJykgKyAnIiBdJywgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZHMuc3RvcmUubWlzc2luZy1yZWNvcmRzLWZyb20tYWRhcHRlcicKICAgICAgICB9KSk7CgogICAgICAgIHJlamVjdEludGVybmFsTW9kZWxzKG1pc3NpbmdJbnRlcm5hbE1vZGVscyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZWplY3RJbnRlcm5hbE1vZGVscyhpbnRlcm5hbE1vZGVscywgZXJyb3IpIHsKICAgICAgZm9yICh2YXIgX2k1ID0gMCwgX2wzID0gaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBfaTUgPCBfbDM7IF9pNSsrKSB7CiAgICAgICAgdmFyIF9pbnRlcm5hbE1vZGVsNSA9IGludGVybmFsTW9kZWxzW19pNV07CiAgICAgICAgdmFyIF9wYWlyMiA9IHNlZWtpbmdbX2ludGVybmFsTW9kZWw1LmlkXTsKCiAgICAgICAgaWYgKF9wYWlyMikgewogICAgICAgICAgX3BhaXIyLnJlc29sdmVyLnJlamVjdChlcnJvciB8fCBuZXcgRXJyb3IoYEV4cGVjdGVkOiAnJHtfaW50ZXJuYWxNb2RlbDV9JyB0byBiZSBwcmVzZW50IGluIHRoZSBhZGFwdGVyIHByb3ZpZGVkIHBheWxvYWQsIGJ1dCBpdCB3YXMgbm90IGZvdW5kLmApKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2hvdWxkQ29hbGVzY2UpIHsKICAgICAgLy8gVE9ETzogSW1wcm92ZSByZWNvcmRzID0+IHNuYXBzaG90cyA9PiByZWNvcmRzID0+IHNuYXBzaG90cwogICAgICAvLwogICAgICAvLyBXZSB3YW50IHRvIHByb3ZpZGUgcmVjb3JkcyB0byBhbGwgc3RvcmUgbWV0aG9kcyBhbmQgc25hcHNob3RzIHRvIGFsbAogICAgICAvLyBhZGFwdGVyIG1ldGhvZHMuIFRvIG1ha2Ugc3VyZSB3ZSdyZSBkb2luZyB0aGF0IHdlJ3JlIHByb3ZpZGluZyBhbiBhcnJheQogICAgICAvLyBvZiBzbmFwc2hvdHMgdG8gYWRhcHRlci5ncm91cFJlY29yZHNGb3JGaW5kTWFueSgpLCB3aGljaCBpbiB0dXJuIHdpbGwKICAgICAgLy8gcmV0dXJuIGdyb3VwZWQgc25hcHNob3RzIGluc3RlYWQgb2YgZ3JvdXBlZCByZWNvcmRzLgogICAgICAvLwogICAgICAvLyBCdXQgc2luY2UgdGhlIF9maW5kTWFueSgpIGZpbmRlciBpcyBhIHN0b3JlIG1ldGhvZCB3ZSBuZWVkIHRvIGdldCB0aGUKICAgICAgLy8gcmVjb3JkcyBmcm9tIHRoZSBncm91cGVkIHNuYXBzaG90cyBldmVuIHRob3VnaCB0aGUgX2ZpbmRNYW55KCkgZmluZGVyCiAgICAgIC8vIHdpbGwgb25jZSBhZ2FpbiBjb252ZXJ0IHRoZSByZWNvcmRzIHRvIHNuYXBzaG90cyBmb3IgYWRhcHRlci5maW5kTWFueSgpCiAgICAgIHZhciBzbmFwc2hvdHMgPSBuZXcgQXJyYXkodG90YWxJdGVtcyk7CiAgICAgIGZvciAodmFyIF9pNiA9IDA7IF9pNiA8IHRvdGFsSXRlbXM7IF9pNisrKSB7CiAgICAgICAgc25hcHNob3RzW19pNl0gPSBpbnRlcm5hbE1vZGVsc1tfaTZdLmNyZWF0ZVNuYXBzaG90KCk7CiAgICAgIH0KCiAgICAgIHZhciBncm91cHMgPSBhZGFwdGVyLmdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHRoaXMsIHNuYXBzaG90cyk7CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgZ3JvdXAgPSBncm91cHNbaV07CiAgICAgICAgdmFyIHRvdGFsSW5Hcm91cCA9IGdyb3Vwc1tpXS5sZW5ndGg7CiAgICAgICAgdmFyIGlkcyA9IG5ldyBBcnJheSh0b3RhbEluR3JvdXApOwogICAgICAgIHZhciBncm91cGVkSW50ZXJuYWxNb2RlbHMgPSBuZXcgQXJyYXkodG90YWxJbkdyb3VwKTsKCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0b3RhbEluR3JvdXA7IGorKykgewogICAgICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBncm91cFtqXS5faW50ZXJuYWxNb2RlbDsKCiAgICAgICAgICBncm91cGVkSW50ZXJuYWxNb2RlbHNbal0gPSBpbnRlcm5hbE1vZGVsOwogICAgICAgICAgaWRzW2pdID0gaW50ZXJuYWxNb2RlbC5pZDsKICAgICAgICB9CgogICAgICAgIGlmICh0b3RhbEluR3JvdXAgPiAxKSB7CiAgICAgICAgICAoZnVuY3Rpb24gKGdyb3VwZWRJbnRlcm5hbE1vZGVscykgewogICAgICAgICAgICBfZmluZE1hbnkoYWRhcHRlciwgc3RvcmUsIG1vZGVsTmFtZSwgaWRzLCBncm91cGVkSW50ZXJuYWxNb2RlbHMpLnRoZW4oZnVuY3Rpb24gKGZvdW5kSW50ZXJuYWxNb2RlbHMpIHsKICAgICAgICAgICAgICBoYW5kbGVGb3VuZFJlY29yZHMoZm91bmRJbnRlcm5hbE1vZGVscywgZ3JvdXBlZEludGVybmFsTW9kZWxzKTsKICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgcmVqZWN0SW50ZXJuYWxNb2RlbHMoZ3JvdXBlZEludGVybmFsTW9kZWxzLCBlcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkoZ3JvdXBlZEludGVybmFsTW9kZWxzKTsKICAgICAgICB9IGVsc2UgaWYgKGlkcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIHZhciBwYWlyID0gc2Vla2luZ1tncm91cGVkSW50ZXJuYWxNb2RlbHNbMF0uaWRdOwogICAgICAgICAgX2ZldGNoUmVjb3JkKHBhaXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5hc3NlcnQoIllvdSBjYW5ub3QgcmV0dXJuIGFuIGVtcHR5IGFycmF5IGZyb20gYWRhcHRlcidzIG1ldGhvZCBncm91cFJlY29yZHNGb3JGaW5kTWFueSIsIGZhbHNlKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBfaTcgPSAwOyBfaTcgPCB0b3RhbEl0ZW1zOyBfaTcrKykgewogICAgICAgIF9mZXRjaFJlY29yZChwZW5kaW5nRmV0Y2hJdGVtc1tfaTddKTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAgR2V0IHRoZSByZWZlcmVuY2UgZm9yIHRoZSBzcGVjaWZpZWQgcmVjb3JkLgogICAgIEV4YW1wbGUKICAgICBgYGBqYXZhc2NyaXB0CiAgICBsZXQgdXNlclJlZiA9IHN0b3JlLmdldFJlZmVyZW5jZSgndXNlcicsIDEpOwogICAgIC8vIGNoZWNrIGlmIHRoZSB1c2VyIGlzIGxvYWRlZAogICAgbGV0IGlzTG9hZGVkID0gdXNlclJlZi52YWx1ZSgpICE9PSBudWxsOwogICAgIC8vIGdldCB0aGUgcmVjb3JkIG9mIHRoZSByZWZlcmVuY2UgKG51bGwgaWYgbm90IHlldCBhdmFpbGFibGUpCiAgICBsZXQgdXNlciA9IHVzZXJSZWYudmFsdWUoKTsKICAgICAvLyBnZXQgdGhlIGlkZW50aWZpZXIgb2YgdGhlIHJlZmVyZW5jZQogICAgaWYgKHVzZXJSZWYucmVtb3RlVHlwZSgpID09PSAnaWQnKSB7CiAgICBsZXQgaWQgPSB1c2VyUmVmLmlkKCk7CiAgICB9CiAgICAgLy8gbG9hZCB1c2VyICh2aWEgc3RvcmUuZmluZCkKICAgIHVzZXJSZWYubG9hZCgpLnRoZW4oLi4uKQogICAgIC8vIG9yIHRyaWdnZXIgYSByZWxvYWQKICAgIHVzZXJSZWYucmVsb2FkKCkudGhlbiguLi4pCiAgICAgLy8gcHJvdmlkZSBkYXRhIGZvciByZWZlcmVuY2UKICAgIHVzZXJSZWYucHVzaCh7IGlkOiAxLCB1c2VybmFtZTogJ0B1c2VyJyB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgdXNlclJlZi52YWx1ZSgpID09PSB1c2VyOwogICAgfSk7CiAgICBgYGAKICAgICBAbWV0aG9kIGdldFJlZmVyZW5jZQogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtTdHJpbmd8SW50ZWdlcn0gaWQKICAgIEBzaW5jZSAyLjUuMAogICAgQHJldHVybiB7UmVjb3JkUmVmZXJlbmNlfQogICovCiAgZ2V0UmVmZXJlbmNlKG1vZGVsTmFtZSwgaWQpIHsKICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CgogICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWxGb3JJZChub3JtYWxpemVkTW9kZWxOYW1lLCBpZCkucmVjb3JkUmVmZXJlbmNlOwogIH0sCgogIC8qKgogICAgR2V0IGEgcmVjb3JkIGJ5IGEgZ2l2ZW4gdHlwZSBhbmQgSUQgd2l0aG91dCB0cmlnZ2VyaW5nIGEgZmV0Y2guCiAgICAgVGhpcyBtZXRob2Qgd2lsbCBzeW5jaHJvbm91c2x5IHJldHVybiB0aGUgcmVjb3JkIGlmIGl0IGlzIGF2YWlsYWJsZSBpbiB0aGUgc3RvcmUsCiAgICBvdGhlcndpc2UgaXQgd2lsbCByZXR1cm4gYG51bGxgLiBBIHJlY29yZCBpcyBhdmFpbGFibGUgaWYgaXQgaGFzIGJlZW4gZmV0Y2hlZCBlYXJsaWVyLCBvcgogICAgcHVzaGVkIG1hbnVhbGx5IGludG8gdGhlIHN0b3JlLgogICAgIFNlZSBbZmluZFJlY29yZF0oI21ldGhvZF9maW5kUmVjb3JkKSBpZiB5b3Ugd291bGQgbGlrZSB0byByZXF1ZXN0IHRoaXMgcmVjb3JkIGZyb20gdGhlIGJhY2tlbmQuCiAgICAgX05vdGU6IFRoaXMgaXMgYSBzeW5jaHJvbm91cyBtZXRob2QgYW5kIGRvZXMgbm90IHJldHVybiBhIHByb21pc2UuXwogICAgIGBgYGpzCiAgICBsZXQgcG9zdCA9IHN0b3JlLnBlZWtSZWNvcmQoJ3Bvc3QnLCAxKTsKICAgICBwb3N0LmdldCgnaWQnKTsgLy8gMQogICAgYGBgCiAgICAgQHNpbmNlIDEuMTMuMAogICAgQG1ldGhvZCBwZWVrUmVjb3JkCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0ge1N0cmluZ3xJbnRlZ2VyfSBpZAogICAgQHJldHVybiB7RFMuTW9kZWx8bnVsbH0gcmVjb3JkCiAgKi8KICBwZWVrUmVjb3JkKG1vZGVsTmFtZSwgaWQpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgcGVla1JlY29yZCBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSAmJiBFbWJlci5pc1ByZXNlbnQoaWQpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBuZWVkIHRvIHBhc3MgYm90aCBhIG1vZGVsIG5hbWUgYW5kIGlkIHRvIHRoZSBzdG9yZSdzIHBlZWtSZWNvcmQgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkgJiYgRW1iZXIuaXNQcmVzZW50KGlkKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCiAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwoKICAgIGlmICh0aGlzLmhhc1JlY29yZEZvcklkKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIGlkKSkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbEZvcklkKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIGlkKS5nZXRSZWNvcmQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIGJ5IHRoZSByZWNvcmQncyBgcmVsb2FkYCBtZXRob2QuCiAgICAgVGhpcyBtZXRob2QgY2FsbHMgdGhlIGFkYXB0ZXIncyBgZmluZGAgbWV0aG9kLCB3aGljaCByZXR1cm5zIGEgcHJvbWlzZS4gV2hlbgogICAgKip0aGF0KiogcHJvbWlzZSByZXNvbHZlcywgYF9yZWxvYWRSZWNvcmRgIHdpbGwgcmVzb2x2ZSB0aGUgcHJvbWlzZSByZXR1cm5lZAogICAgYnkgdGhlIHJlY29yZCdzIGByZWxvYWRgLgogICAgIEBtZXRob2QgX3JlbG9hZFJlY29yZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7RFMuTW9kZWx9IGludGVybmFsTW9kZWwKICAgIEBwYXJhbSBvcHRpb25zIG9wdGlvbmFsIHRvIGluY2x1ZGUgYWRhcHRlck9wdGlvbnMKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIF9yZWxvYWRSZWNvcmQoaW50ZXJuYWxNb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHsgaWQsIG1vZGVsTmFtZSB9ID0gaW50ZXJuYWxNb2RlbDsKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG1vZGVsTmFtZSk7CgogICAgKHRydWUgJiYgIShpZCkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgY2Fubm90IHJlbG9hZCBhIHJlY29yZCB3aXRob3V0IGFuIElEYCwgaWQpKTsKICAgICh0cnVlICYmICEoYWRhcHRlcikgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gcmVsb2FkIGEgcmVjb3JkIGJ1dCB5b3UgaGF2ZSBubyBhZGFwdGVyIChmb3IgJHttb2RlbE5hbWV9KWAsIGFkYXB0ZXIpKTsKICAgICh0cnVlICYmICEodHlwZW9mIGFkYXB0ZXIuZmluZFJlY29yZCA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgYWRhcHRlci5maW5kID09PSAnZnVuY3Rpb24nKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byByZWxvYWQgYSByZWNvcmQgYnV0IHlvdXIgYWRhcHRlciBkb2VzIG5vdCBpbXBsZW1lbnQgJ2ZpbmRSZWNvcmQnYCwgdHlwZW9mIGFkYXB0ZXIuZmluZFJlY29yZCA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgYWRhcHRlci5maW5kID09PSAnZnVuY3Rpb24nKSk7CgoKICAgIHJldHVybiB0aGlzLl9zY2hlZHVsZUZldGNoKGludGVybmFsTW9kZWwsIG9wdGlvbnMpOwogIH0sCgogIC8qKgogICBUaGlzIG1ldGhvZCByZXR1cm5zIHRydWUgaWYgYSByZWNvcmQgZm9yIGEgZ2l2ZW4gbW9kZWxOYW1lIGFuZCBpZCBpcyBhbHJlYWR5CiAgIGxvYWRlZCBpbiB0aGUgc3RvcmUuIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIGtub3cgYmVmb3JlaGFuZCBpZiBhIGZpbmRSZWNvcmQoKQogICB3aWxsIHJlc3VsdCBpbiBhIHJlcXVlc3Qgb3IgdGhhdCBpdCB3aWxsIGJlIGEgY2FjaGUgaGl0LgogICAgRXhhbXBsZQogICAgYGBgamF2YXNjcmlwdAogICBzdG9yZS5oYXNSZWNvcmRGb3JJZCgncG9zdCcsIDEpOyAvLyBmYWxzZQogICBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMSkudGhlbihmdW5jdGlvbigpIHsKICAgICBzdG9yZS5oYXNSZWNvcmRGb3JJZCgncG9zdCcsIDEpOyAvLyB0cnVlCiAgIH0pOwogICBgYGAKICAgICBAbWV0aG9kIGhhc1JlY29yZEZvcklkCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0geyhTdHJpbmd8SW50ZWdlcil9IGlkCiAgICBAcmV0dXJuIHtCb29sZWFufQogICovCiAgaGFzUmVjb3JkRm9ySWQobW9kZWxOYW1lLCBpZCkgewogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgbW9kZWwgbmFtZSB0byB0aGUgc3RvcmUncyBoYXNSZWNvcmRGb3JJZCBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICB2YXIgdHJ1ZUlkID0gY29lcmNlSWQoaWQpOwogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9pbnRlcm5hbE1vZGVsc0Zvcihub3JtYWxpemVkTW9kZWxOYW1lKS5nZXQodHJ1ZUlkKTsKCiAgICByZXR1cm4gISFpbnRlcm5hbE1vZGVsICYmIGludGVybmFsTW9kZWwuaXNMb2FkZWQoKTsKICB9LAoKICAvKioKICAgIFJldHVybnMgaWQgcmVjb3JkIGZvciBhIGdpdmVuIHR5cGUgYW5kIElELiBJZiBvbmUgaXNuJ3QgYWxyZWFkeSBsb2FkZWQsCiAgICBpdCBidWlsZHMgYSBuZXcgcmVjb3JkIGFuZCBsZWF2ZXMgaXQgaW4gdGhlIGBlbXB0eWAgc3RhdGUuCiAgICAgQG1ldGhvZCByZWNvcmRGb3JJZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEBwYXJhbSB7KFN0cmluZ3xJbnRlZ2VyKX0gaWQKICAgIEByZXR1cm4ge0RTLk1vZGVsfSByZWNvcmQKICAqLwogIHJlY29yZEZvcklkKG1vZGVsTmFtZSwgaWQpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgcmVjb3JkRm9ySWQgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpKTsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgUGFzc2luZyBjbGFzc2VzIHRvIHN0b3JlIG1ldGhvZHMgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHBhc3MgYSBkYXNoZXJpemVkIHN0cmluZyBpbnN0ZWFkIG9mICR7bW9kZWxOYW1lfWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgoKICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsRm9ySWQobW9kZWxOYW1lLCBpZCkuZ2V0UmVjb3JkKCk7CiAgfSwKCiAgX2ludGVybmFsTW9kZWxGb3JJZChtb2RlbE5hbWUsIGlkKSB7CiAgICB2YXIgdHJ1ZUlkID0gY29lcmNlSWQoaWQpOwogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9pbnRlcm5hbE1vZGVsc0Zvcihtb2RlbE5hbWUpLmdldCh0cnVlSWQpOwoKICAgIGlmIChpbnRlcm5hbE1vZGVsKSB7CiAgICAgIGlmIChpbnRlcm5hbE1vZGVsLmhhc1NjaGVkdWxlZERlc3Ryb3koKSkgewogICAgICAgIGludGVybmFsTW9kZWwuZGVzdHJveVN5bmMoKTsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRJbnRlcm5hbE1vZGVsKG1vZGVsTmFtZSwgdHJ1ZUlkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkSW50ZXJuYWxNb2RlbChtb2RlbE5hbWUsIHRydWVJZCk7CiAgICB9CiAgfSwKCiAgX2ludGVybmFsTW9kZWxEaWRSZWNlaXZlUmVsYXRpb25zaGlwRGF0YShtb2RlbE5hbWUsIGlkLCByZWxhdGlvbnNoaXBEYXRhKSB7CiAgICB0aGlzLl9yZWxhdGlvbnNoaXBzUGF5bG9hZHMucHVzaChtb2RlbE5hbWUsIGlkLCByZWxhdGlvbnNoaXBEYXRhKTsKICB9LAoKICBfaW50ZXJuYWxNb2RlbERlc3Ryb3llZChpbnRlcm5hbE1vZGVsKSB7CiAgICB0aGlzLl9yZW1vdmVGcm9tSWRNYXAoaW50ZXJuYWxNb2RlbCk7CgogICAgaWYgKCF0aGlzLmlzRGVzdHJveWluZykgewogICAgICB0aGlzLl9yZWxhdGlvbnNoaXBzUGF5bG9hZHMudW5sb2FkKGludGVybmFsTW9kZWwubW9kZWxOYW1lLCBpbnRlcm5hbE1vZGVsLmlkKTsKICAgIH0KICB9LAoKICAvKioKICAgIEBtZXRob2QgZmluZE1hbnkKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0FycmF5fSBpbnRlcm5hbE1vZGVscwogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZE1hbnkoaW50ZXJuYWxNb2RlbHMpIHsKICAgIHZhciBmaW5kcyA9IG5ldyBBcnJheShpbnRlcm5hbE1vZGVscy5sZW5ndGgpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW50ZXJuYWxNb2RlbHMubGVuZ3RoOyBpKyspIHsKICAgICAgZmluZHNbaV0gPSB0aGlzLl9maW5kRW1wdHlJbnRlcm5hbE1vZGVsKGludGVybmFsTW9kZWxzW2ldKTsKICAgIH0KCiAgICByZXR1cm4gRW1iZXIuUlNWUC5Qcm9taXNlLmFsbChmaW5kcyk7CiAgfSwKCiAgLyoqCiAgICBJZiBhIHJlbGF0aW9uc2hpcCB3YXMgb3JpZ2luYWxseSBwb3B1bGF0ZWQgYnkgdGhlIGFkYXB0ZXIgYXMgYSBsaW5rCiAgICAoYXMgb3Bwb3NlZCB0byBhIGxpc3Qgb2YgSURzKSwgdGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gdGhlCiAgICByZWxhdGlvbnNoaXAgaXMgZmV0Y2hlZC4KICAgICBUaGUgbGluayAod2hpY2ggaXMgdXN1YWxseSBhIFVSTCkgaXMgcGFzc2VkIHRocm91Z2ggdW5jaGFuZ2VkLCBzbyB0aGUKICAgIGFkYXB0ZXIgY2FuIG1ha2Ugd2hhdGV2ZXIgcmVxdWVzdCBpdCB3YW50cy4KICAgICBUaGUgdXN1YWwgdXNlLWNhc2UgaXMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVnaXN0ZXIgYSBVUkwgYXMgYSBsaW5rLCBhbmQKICAgIHRoZW4gdXNlIHRoYXQgVVJMIGluIHRoZSBmdXR1cmUgdG8gbWFrZSBhIHJlcXVlc3QgZm9yIHRoZSByZWxhdGlvbnNoaXAuCiAgICAgQG1ldGhvZCBmaW5kSGFzTWFueQogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbAogICAgQHBhcmFtIHthbnl9IGxpbmsKICAgIEBwYXJhbSB7KFJlbGF0aW9uc2hpcCl9IHJlbGF0aW9uc2hpcAogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgZmluZEhhc01hbnkoaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSk7CgogICAgKHRydWUgJiYgIShhZGFwdGVyKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBsb2FkIGEgaGFzTWFueSByZWxhdGlvbnNoaXAgYnV0IHlvdSBoYXZlIG5vIGFkYXB0ZXIgKGZvciAke2ludGVybmFsTW9kZWwubW9kZWxOYW1lfSlgLCBhZGFwdGVyKSk7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBhZGFwdGVyLmZpbmRIYXNNYW55ID09PSAnZnVuY3Rpb24nKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBsb2FkIGEgaGFzTWFueSByZWxhdGlvbnNoaXAgZnJvbSBhIHNwZWNpZmllZCAnbGluaycgaW4gdGhlIG9yaWdpbmFsIHBheWxvYWQgYnV0IHlvdXIgYWRhcHRlciBkb2VzIG5vdCBpbXBsZW1lbnQgJ2ZpbmRIYXNNYW55J2AsIHR5cGVvZiBhZGFwdGVyLmZpbmRIYXNNYW55ID09PSAnZnVuY3Rpb24nKSk7CgoKICAgIHJldHVybiBfZmluZEhhc01hbnkoYWRhcHRlciwgdGhpcywgaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgZmluZEJlbG9uZ3NUbwogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbAogICAgQHBhcmFtIHthbnl9IGxpbmsKICAgIEBwYXJhbSB7UmVsYXRpb25zaGlwfSByZWxhdGlvbnNoaXAKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRCZWxvbmdzVG8oaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwKSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSk7CgogICAgKHRydWUgJiYgIShhZGFwdGVyKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBsb2FkIGEgYmVsb25nc1RvIHJlbGF0aW9uc2hpcCBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICR7aW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9KWAsIGFkYXB0ZXIpKTsKICAgICh0cnVlICYmICEodHlwZW9mIGFkYXB0ZXIuZmluZEJlbG9uZ3NUbyA9PT0gJ2Z1bmN0aW9uJykgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gbG9hZCBhIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAgZnJvbSBhIHNwZWNpZmllZCAnbGluaycgaW4gdGhlIG9yaWdpbmFsIHBheWxvYWQgYnV0IHlvdXIgYWRhcHRlciBkb2VzIG5vdCBpbXBsZW1lbnQgJ2ZpbmRCZWxvbmdzVG8nYCwgdHlwZW9mIGFkYXB0ZXIuZmluZEJlbG9uZ3NUbyA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICByZXR1cm4gX2ZpbmRCZWxvbmdzVG8oYWRhcHRlciwgdGhpcywgaW50ZXJuYWxNb2RlbCwgbGluaywgcmVsYXRpb25zaGlwKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIGRlbGVnYXRlcyBhIHF1ZXJ5IHRvIHRoZSBhZGFwdGVyLiBUaGlzIGlzIHRoZSBvbmUgcGxhY2Ugd2hlcmUKICAgIGFkYXB0ZXItbGV2ZWwgc2VtYW50aWNzIGFyZSBleHBvc2VkIHRvIHRoZSBhcHBsaWNhdGlvbi4KICAgICBFYWNoIHRpbWUgdGhpcyBtZXRob2QgaXMgY2FsbGVkIGEgbmV3IHJlcXVlc3QgaXMgbWFkZSB0aHJvdWdoIHRoZSBhZGFwdGVyLgogICAgIEV4cG9zaW5nIHF1ZXJpZXMgdGhpcyB3YXkgc2VlbXMgcHJlZmVyYWJsZSB0byBjcmVhdGluZyBhbiBhYnN0cmFjdCBxdWVyeQogICAgbGFuZ3VhZ2UgZm9yIGFsbCBzZXJ2ZXItc2lkZSBxdWVyaWVzLCBhbmQgdGhlbiByZXF1aXJlIGFsbCBhZGFwdGVycyB0bwogICAgaW1wbGVtZW50IHRoZW0uCiAgICAgLS0tCiAgICAgSWYgeW91IGRvIHNvbWV0aGluZyBsaWtlIHRoaXM6CiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUucXVlcnkoJ3BlcnNvbicsIHsgcGFnZTogMSB9KTsKICAgIGBgYAogICAgIFRoZSBjYWxsIG1hZGUgdG8gdGhlIHNlcnZlciwgdXNpbmcgYSBSYWlscyBiYWNrZW5kLCB3aWxsIGxvb2sgc29tZXRoaW5nIGxpa2UgdGhpczoKICAgICBgYGAKICAgIFN0YXJ0ZWQgR0VUICIvYXBpL3YxL3BlcnNvbj9wYWdlPTEiCiAgICBQcm9jZXNzaW5nIGJ5IEFwaTo6VjE6OlBlcnNvbnNDb250cm9sbGVyI2luZGV4IGFzIEhUTUwKICAgIFBhcmFtZXRlcnM6IHsgInBhZ2UiPT4iMSIgfQogICAgYGBgCiAgICAgLS0tCiAgICAgSWYgeW91IGRvIHNvbWV0aGluZyBsaWtlIHRoaXM6CiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUucXVlcnkoJ3BlcnNvbicsIHsgaWRzOiBbMSwgMiwgM10gfSk7CiAgICBgYGAKICAgICBUaGUgY2FsbCB0byB0aGUgc2VydmVyLCB1c2luZyBhIFJhaWxzIGJhY2tlbmQsIHdpbGwgbG9vayBzb21ldGhpbmcgbGlrZSB0aGlzOgogICAgIGBgYAogICAgU3RhcnRlZCBHRVQgIi9hcGkvdjEvcGVyc29uP2lkcyU1QiU1RD0xJmlkcyU1QiU1RD0yJmlkcyU1QiU1RD0zIgogICAgUHJvY2Vzc2luZyBieSBBcGk6OlYxOjpQZXJzb25zQ29udHJvbGxlciNpbmRleCBhcyBIVE1MCiAgICBQYXJhbWV0ZXJzOiB7ICJpZHMiID0+IFsiMSIsICIyIiwgIjMiXSB9CiAgICBgYGAKICAgICBUaGlzIG1ldGhvZCByZXR1cm5zIGEgcHJvbWlzZSwgd2hpY2ggaXMgcmVzb2x2ZWQgd2l0aCBhbgogICAgW2BBZGFwdGVyUG9wdWxhdGVkUmVjb3JkQXJyYXlgXShodHRwczovL2VtYmVyanMuY29tL2FwaS9kYXRhL2NsYXNzZXMvRFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5Lmh0bWwpCiAgICBvbmNlIHRoZSBzZXJ2ZXIgcmV0dXJucy4KICAgICBAc2luY2UgMS4xMy4wCiAgICBAbWV0aG9kIHF1ZXJ5CiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0ge2FueX0gcXVlcnkgYW4gb3BhcXVlIHF1ZXJ5IHRvIGJlIHVzZWQgYnkgdGhlIGFkYXB0ZXIKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIG9wdGlvbmFsLCBtYXkgaW5jbHVkZSBgYWRhcHRlck9wdGlvbnNgIGhhc2ggd2hpY2ggd2lsbCBiZSBwYXNzZWQgdG8gYWRhcHRlci5xdWVyeQogICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICovCiAgcXVlcnkobW9kZWxOYW1lLCBxdWVyeSwgb3B0aW9ucykgewogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgbW9kZWwgbmFtZSB0byB0aGUgc3RvcmUncyBxdWVyeSBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgIShxdWVyeSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgcXVlcnkgaGFzaCB0byB0aGUgc3RvcmUncyBxdWVyeSBtZXRob2RgLCBxdWVyeSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIGFkYXB0ZXJPcHRpb25zV3JhcHBlciA9IHt9OwoKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYWRhcHRlck9wdGlvbnMpIHsKICAgICAgYWRhcHRlck9wdGlvbnNXcmFwcGVyLmFkYXB0ZXJPcHRpb25zID0gb3B0aW9ucy5hZGFwdGVyT3B0aW9uczsKICAgIH0KCiAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgcmV0dXJuIHRoaXMuX3F1ZXJ5KG5vcm1hbGl6ZWRNb2RlbE5hbWUsIHF1ZXJ5LCBudWxsLCBhZGFwdGVyT3B0aW9uc1dyYXBwZXIpOwogIH0sCgogIF9xdWVyeShtb2RlbE5hbWUsIHF1ZXJ5LCBhcnJheSwgb3B0aW9ucykgewogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgbW9kZWwgbmFtZSB0byB0aGUgc3RvcmUncyBxdWVyeSBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgIShxdWVyeSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgcXVlcnkgaGFzaCB0byB0aGUgc3RvcmUncyBxdWVyeSBtZXRob2RgLCBxdWVyeSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihtb2RlbE5hbWUpOwogICAgKHRydWUgJiYgIShhZGFwdGVyKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBsb2FkIGEgcXVlcnkgYnV0IHlvdSBoYXZlIG5vIGFkYXB0ZXIgKGZvciAke21vZGVsTmFtZX0pYCwgYWRhcHRlcikpOwogICAgKHRydWUgJiYgISh0eXBlb2YgYWRhcHRlci5xdWVyeSA9PT0gJ2Z1bmN0aW9uJykgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gbG9hZCBhIHF1ZXJ5IGJ1dCB5b3VyIGFkYXB0ZXIgZG9lcyBub3QgaW1wbGVtZW50ICdxdWVyeSdgLCB0eXBlb2YgYWRhcHRlci5xdWVyeSA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICB2YXIgcEEgPSBwcm9taXNlQXJyYXkoX3F1ZXJ5KGFkYXB0ZXIsIHRoaXMsIG1vZGVsTmFtZSwgcXVlcnksIGFycmF5LCBvcHRpb25zKSk7CgogICAgcmV0dXJuIHBBOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgbWFrZXMgYSByZXF1ZXN0IGZvciBvbmUgcmVjb3JkLCB3aGVyZSB0aGUgYGlkYCBpcyBub3Qga25vd24KICAgIGJlZm9yZWhhbmQgKGlmIHRoZSBgaWRgIGlzIGtub3duLCB1c2UgW2BmaW5kUmVjb3JkYF0oI21ldGhvZF9maW5kUmVjb3JkKQogICAgaW5zdGVhZCkuCiAgICAgVGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgd2hlbiBpdCBpcyBjZXJ0YWluIHRoYXQgdGhlIHNlcnZlciB3aWxsIHJldHVybiBhCiAgICBzaW5nbGUgb2JqZWN0IGZvciB0aGUgcHJpbWFyeSBkYXRhLgogICAgIEVhY2ggdGltZSB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgYSBuZXcgcmVxdWVzdCBpcyBtYWRlIHRocm91Z2ggdGhlIGFkYXB0ZXIuCiAgICAgTGV0J3MgYXNzdW1lIG91ciBBUEkgcHJvdmlkZXMgYW4gZW5kcG9pbnQgZm9yIHRoZSBjdXJyZW50bHkgbG9nZ2VkIGluIHVzZXIKICAgIHZpYToKICAgICBgYGAKICAgIC8vIEdFVCAvYXBpL2N1cnJlbnRfdXNlcgogICAgewogICAgICB1c2VyOiB7CiAgICAgICAgaWQ6IDEyMzQsCiAgICAgICAgdXNlcm5hbWU6ICdhZG1pbicKICAgICAgfQogICAgfQogICAgYGBgCiAgICAgU2luY2UgdGhlIHNwZWNpZmljIGBpZGAgb2YgdGhlIGB1c2VyYCBpcyBub3Qga25vd24gYmVmb3JlaGFuZCwgd2UgY2FuIHVzZQogICAgYHF1ZXJ5UmVjb3JkYCB0byBnZXQgdGhlIHVzZXI6CiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUucXVlcnlSZWNvcmQoJ3VzZXInLCB7fSkudGhlbihmdW5jdGlvbih1c2VyKSB7CiAgICAgIGxldCB1c2VybmFtZSA9IHVzZXIuZ2V0KCd1c2VybmFtZScpOwogICAgICBjb25zb2xlLmxvZyhgQ3VycmVudGx5IGxvZ2dlZCBpbiBhcyAke3VzZXJuYW1lfWApOwogICAgfSk7CiAgICBgYGAKICAgICBUaGUgcmVxdWVzdCBpcyBtYWRlIHRocm91Z2ggdGhlIGFkYXB0ZXJzJyBgcXVlcnlSZWNvcmRgOgogICAgIGBgYGFwcC9hZGFwdGVycy91c2VyLmpzCiAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgcXVlcnlSZWNvcmQobW9kZWxOYW1lLCBxdWVyeSkgewogICAgICAgIHJldHVybiAkLmdldEpTT04oJy9hcGkvY3VycmVudF91c2VyJyk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgTm90ZTogdGhlIHByaW1hcnkgdXNlIGNhc2UgZm9yIGBzdG9yZS5xdWVyeVJlY29yZGAgaXMgd2hlbiBhIHNpbmdsZSByZWNvcmQKICAgIGlzIHF1ZXJpZWQgYW5kIHRoZSBgaWRgIGlzIG5vdCBrbm93biBiZWZvcmVoYW5kLiBJbiBhbGwgb3RoZXIgY2FzZXMKICAgIGBzdG9yZS5xdWVyeWAgYW5kIHVzaW5nIHRoZSBmaXJzdCBpdGVtIG9mIHRoZSBhcnJheSBpcyBsaWtlbHkgdGhlIHByZWZlcnJlZAogICAgd2F5OgogICAgIGBgYAogICAgLy8gR0VUIC91c2Vycz91c2VybmFtZT11bmlxdWUKICAgIHsKICAgICAgZGF0YTogW3sKICAgICAgICBpZDogMTIzNCwKICAgICAgICB0eXBlOiAndXNlcicsCiAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgdXNlcm5hbWU6ICJ1bmlxdWUiCiAgICAgICAgfQogICAgICB9XQogICAgfQogICAgYGBgCiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUucXVlcnkoJ3VzZXInLCB7IHVzZXJuYW1lOiAndW5pcXVlJyB9KS50aGVuKGZ1bmN0aW9uKHVzZXJzKSB7CiAgICAgIHJldHVybiB1c2Vycy5nZXQoJ2ZpcnN0T2JqZWN0Jyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgbGV0IGlkID0gdXNlci5nZXQoJ2lkJyk7CiAgICB9KTsKICAgIGBgYAogICAgIFRoaXMgbWV0aG9kIHJldHVybnMgYSBwcm9taXNlLCB3aGljaCByZXNvbHZlcyB3aXRoIHRoZSBmb3VuZCByZWNvcmQuCiAgICAgSWYgdGhlIGFkYXB0ZXIgcmV0dXJucyBubyBkYXRhIGZvciB0aGUgcHJpbWFyeSBkYXRhIG9mIHRoZSBwYXlsb2FkLCB0aGVuCiAgICBgcXVlcnlSZWNvcmRgIHJlc29sdmVzIHdpdGggYG51bGxgOgogICAgIGBgYAogICAgLy8gR0VUIC91c2Vycz91c2VybmFtZT11bmlxdWUKICAgIHsKICAgICAgZGF0YTogbnVsbAogICAgfQogICAgYGBgCiAgICAgYGBgamF2YXNjcmlwdAogICAgc3RvcmUucXVlcnlSZWNvcmQoJ3VzZXInLCB7IHVzZXJuYW1lOiAndW5pcXVlJyB9KS50aGVuKGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgY29uc29sZS5sb2codXNlcik7IC8vIG51bGwKICAgIH0pOwogICAgYGBgCiAgICAgQHNpbmNlIDEuMTMuMAogICAgQG1ldGhvZCBxdWVyeVJlY29yZAogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHthbnl9IHF1ZXJ5IGFuIG9wYXF1ZSBxdWVyeSB0byBiZSB1c2VkIGJ5IHRoZSBhZGFwdGVyCiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBvcHRpb25hbCwgbWF5IGluY2x1ZGUgYGFkYXB0ZXJPcHRpb25zYCBoYXNoIHdoaWNoIHdpbGwgYmUgcGFzc2VkIHRvIGFkYXB0ZXIucXVlcnlSZWNvcmQKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2l0aCB0aGUgZm91bmQgcmVjb3JkIG9yIGBudWxsYAogICovCiAgcXVlcnlSZWNvcmQobW9kZWxOYW1lLCBxdWVyeSwgb3B0aW9ucykgewogICAgKHRydWUgJiYgIShFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgbW9kZWwgbmFtZSB0byB0aGUgc3RvcmUncyBxdWVyeVJlY29yZCBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgIShxdWVyeSkgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgbmVlZCB0byBwYXNzIGEgcXVlcnkgaGFzaCB0byB0aGUgc3RvcmUncyBxdWVyeVJlY29yZCBtZXRob2RgLCBxdWVyeSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgIHZhciBhZGFwdGVyID0gdGhpcy5hZGFwdGVyRm9yKG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogICAgdmFyIGFkYXB0ZXJPcHRpb25zV3JhcHBlciA9IHt9OwoKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYWRhcHRlck9wdGlvbnMpIHsKICAgICAgYWRhcHRlck9wdGlvbnNXcmFwcGVyLmFkYXB0ZXJPcHRpb25zID0gb3B0aW9ucy5hZGFwdGVyT3B0aW9uczsKICAgIH0KCiAgICAodHJ1ZSAmJiAhKGFkYXB0ZXIpICYmIEVtYmVyLmFzc2VydChgWW91IHRyaWVkIHRvIG1ha2UgYSBxdWVyeSBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICR7bm9ybWFsaXplZE1vZGVsTmFtZX0pYCwgYWRhcHRlcikpOwogICAgKHRydWUgJiYgISh0eXBlb2YgYWRhcHRlci5xdWVyeVJlY29yZCA9PT0gJ2Z1bmN0aW9uJykgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gbWFrZSBhIHF1ZXJ5IGJ1dCB5b3VyIGFkYXB0ZXIgZG9lcyBub3QgaW1wbGVtZW50ICdxdWVyeVJlY29yZCdgLCB0eXBlb2YgYWRhcHRlci5xdWVyeVJlY29yZCA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICByZXR1cm4gcHJvbWlzZU9iamVjdChfcXVlcnlSZWNvcmQoYWRhcHRlciwgdGhpcywgbW9kZWxOYW1lLCBxdWVyeSwgYWRhcHRlck9wdGlvbnNXcmFwcGVyKS50aGVuKGludGVybmFsTW9kZWwgPT4gewogICAgICAvLyB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBzdG9yZS5xdWVyeVJlY29yZCBpcyBleHBlY3RlZCB0byByZXNvbHZlIHdpdGgKICAgICAgLy8gYW4gaW5zdGFuY2Ugb2YgRFMuTW9kZWwKICAgICAgaWYgKGludGVybmFsTW9kZWwpIHsKICAgICAgICByZXR1cm4gaW50ZXJuYWxNb2RlbC5nZXRSZWNvcmQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9KSk7CiAgfSwKCiAgLyoqCiAgICBgZmluZEFsbGAgYXNrcyB0aGUgYWRhcHRlcidzIGBmaW5kQWxsYCBtZXRob2QgdG8gZmluZCB0aGUgcmVjb3JkcyBmb3IgdGhlCiAgICBnaXZlbiB0eXBlLCBhbmQgcmV0dXJucyBhIHByb21pc2Ugd2hpY2ggd2lsbCByZXNvbHZlIHdpdGggYWxsIHJlY29yZHMgb2YKICAgIHRoaXMgdHlwZSBwcmVzZW50IGluIHRoZSBzdG9yZSwgZXZlbiBpZiB0aGUgYWRhcHRlciBvbmx5IHJldHVybnMgYSBzdWJzZXQKICAgIG9mIHRoZW0uCiAgICAgYGBgYXBwL3JvdXRlcy9hdXRob3JzLmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIG1vZGVsKHBhcmFtcykgewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRBbGwoJ2F1dGhvcicpOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIF9XaGVuXyB0aGUgcmV0dXJuZWQgcHJvbWlzZSByZXNvbHZlcyBkZXBlbmRzIG9uIHRoZSByZWxvYWQgYmVoYXZpb3IsCiAgICBjb25maWd1cmVkIHZpYSB0aGUgcGFzc2VkIGBvcHRpb25zYCBoYXNoIGFuZCB0aGUgcmVzdWx0IG9mIHRoZSBhZGFwdGVyJ3MKICAgIGBzaG91bGRSZWxvYWRBbGxgIG1ldGhvZC4KICAgICAjIyMgUmVsb2FkaW5nCiAgICAgSWYgYHsgcmVsb2FkOiB0cnVlIH1gIGlzIHBhc3NlZCBvciBgYWRhcHRlci5zaG91bGRSZWxvYWRBbGxgIGV2YWx1YXRlcyB0bwogICAgYHRydWVgLCB0aGVuIHRoZSByZXR1cm5lZCBwcm9taXNlIHJlc29sdmVzIG9uY2UgdGhlIGFkYXB0ZXIgcmV0dXJucyBkYXRhLAogICAgcmVnYXJkbGVzcyBpZiB0aGVyZSBhcmUgYWxyZWFkeSByZWNvcmRzIGluIHRoZSBzdG9yZToKICAgICBgYGBqcwogICAgc3RvcmUucHVzaCh7CiAgICAgIGRhdGE6IHsKICAgICAgICBpZDogJ2ZpcnN0JywKICAgICAgICB0eXBlOiAnYXV0aG9yJwogICAgICB9CiAgICB9KTsKICAgICAvLyBhZGFwdGVyI2ZpbmRBbGwgcmVzb2x2ZXMgd2l0aAogICAgLy8gWwogICAgLy8gICB7CiAgICAvLyAgICAgaWQ6ICdzZWNvbmQnLAogICAgLy8gICAgIHR5cGU6ICdhdXRob3InCiAgICAvLyAgIH0KICAgIC8vIF0KICAgIHN0b3JlLmZpbmRBbGwoJ2F1dGhvcicsIHsgcmVsb2FkOiB0cnVlIH0pLnRoZW4oZnVuY3Rpb24oYXV0aG9ycykgewogICAgICBhdXRob3JzLmdldEVhY2goJ2lkJyk7IC8vIFsnZmlyc3QnLCAnc2Vjb25kJ10KICAgIH0pOwogICAgYGBgCiAgICAgSWYgbm8gcmVsb2FkIGlzIGluZGljYXRlZCB2aWEgdGhlIGFib3ZlbWVudGlvbmVkIHdheXMsIHRoZW4gdGhlIHByb21pc2UKICAgIGltbWVkaWF0ZWx5IHJlc29sdmVzIHdpdGggYWxsIHRoZSByZWNvcmRzIGN1cnJlbnRseSBsb2FkZWQgaW4gdGhlIHN0b3JlLgogICAgICMjIyBCYWNrZ3JvdW5kIFJlbG9hZGluZwogICAgIE9wdGlvbmFsbHksIGlmIGBhZGFwdGVyLnNob3VsZEJhY2tncm91bmRSZWxvYWRBbGxgIGV2YWx1YXRlcyB0byBgdHJ1ZWAsCiAgICB0aGVuIGEgYmFja2dyb3VuZCByZWxvYWQgaXMgc3RhcnRlZC4gT25jZSB0aGlzIHJlc29sdmVzLCB0aGUgYXJyYXkgd2l0aAogICAgd2hpY2ggdGhlIHByb21pc2UgcmVzb2x2ZXMsIGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseSBzbyBpdCBjb250YWlucyBhbGwgdGhlCiAgICByZWNvcmRzIGluIHRoZSBzdG9yZToKICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgc2hvdWxkUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdHNBcnJheSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRBbGwoc3RvcmUsIHNuYXBzaG90c0FycmF5KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgIC8vIC4uLgogICAgIHN0b3JlLnB1c2goewogICAgICBkYXRhOiB7CiAgICAgICAgaWQ6ICdmaXJzdCcsCiAgICAgICAgdHlwZTogJ2F1dGhvcicKICAgICAgfQogICAgfSk7CiAgICAgbGV0IGFsbEF1dGhvcnM7CiAgICBzdG9yZS5maW5kQWxsKCdhdXRob3InKS50aGVuKGZ1bmN0aW9uKGF1dGhvcnMpIHsKICAgICAgYXV0aG9ycy5nZXRFYWNoKCdpZCcpOyAvLyBbJ2ZpcnN0J10KICAgICAgIGFsbEF1dGhvcnMgPSBhdXRob3JzOwogICAgfSk7CiAgICAgLy8gbGF0ZXIsIG9uY2UgYWRhcHRlciNmaW5kQWxsIHJlc29sdmVkIHdpdGgKICAgIC8vIFsKICAgIC8vICAgewogICAgLy8gICAgIGlkOiAnc2Vjb25kJywKICAgIC8vICAgICB0eXBlOiAnYXV0aG9yJwogICAgLy8gICB9CiAgICAvLyBdCiAgICAgYWxsQXV0aG9ycy5nZXRFYWNoKCdpZCcpOyAvLyBbJ2ZpcnN0JywgJ3NlY29uZCddCiAgICBgYGAKICAgICBJZiB5b3Ugd291bGQgbGlrZSB0byBmb3JjZSBvciBwcmV2ZW50IGJhY2tncm91bmQgcmVsb2FkaW5nLCB5b3UgY2FuIHNldCBhCiAgICBib29sZWFuIHZhbHVlIGZvciBgYmFja2dyb3VuZFJlbG9hZGAgaW4gdGhlIG9wdGlvbnMgb2JqZWN0IGZvcgogICAgYGZpbmRBbGxgLgogICAgIGBgYGFwcC9yb3V0ZXMvcG9zdC9lZGl0LmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIG1vZGVsKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRBbGwoJ3Bvc3QnLCB7IGJhY2tncm91bmRSZWxvYWQ6IGZhbHNlIH0pOwogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIElmIHlvdSBwYXNzIGFuIG9iamVjdCBvbiB0aGUgYGFkYXB0ZXJPcHRpb25zYCBwcm9wZXJ0eSBvZiB0aGUgb3B0aW9ucwogICAgYXJndW1lbnQgaXQgd2lsbCBiZSBwYXNzZWQgdG8geW91IGFkYXB0ZXIgdmlhIHRoZSBgc25hcHNob3RSZWNvcmRBcnJheWAKICAgICBgYGBhcHAvcm91dGVzL3Bvc3RzLmpzCiAgICBpbXBvcnQgUm91dGUgZnJvbSAnQGVtYmVyL3JvdXRpbmcvcm91dGUnOwogICAgIGV4cG9ydCBkZWZhdWx0IFJvdXRlLmV4dGVuZCh7CiAgICAgIG1vZGVsKHBhcmFtcykgewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmZpbmRBbGwoJ3Bvc3QnLCB7CiAgICAgICAgICBhZGFwdGVyT3B0aW9uczogeyBzdWJzY3JpYmU6IGZhbHNlIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAgICBgYGBhcHAvYWRhcHRlcnMvcG9zdC5qcwogICAgaW1wb3J0IE15Q3VzdG9tQWRhcHRlciBmcm9tICcuL2N1c3RvbS1hZGFwdGVyJzsKICAgICBleHBvcnQgZGVmYXVsdCBNeUN1c3RvbUFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSwgc2luY2VUb2tlbiwgc25hcHNob3RSZWNvcmRBcnJheSkgewogICAgICAgIGlmIChzbmFwc2hvdFJlY29yZEFycmF5LmFkYXB0ZXJPcHRpb25zLnN1YnNjcmliZSkgewogICAgICAgICAgLy8gLi4uCiAgICAgICAgfQogICAgICAgIC8vIC4uLgogICAgICB9CiAgICB9KTsKICAgIGBgYAogICAgIFNlZSBbcGVla0FsbF0oI21ldGhvZF9wZWVrQWxsKSB0byBnZXQgYW4gYXJyYXkgb2YgY3VycmVudCByZWNvcmRzIGluIHRoZQogICAgc3RvcmUsIHdpdGhvdXQgd2FpdGluZyB1bnRpbCBhIHJlbG9hZCBpcyBmaW5pc2hlZC4KICAgICAjIyMgUmV0cmlldmluZyBSZWxhdGVkIE1vZGVsIFJlY29yZHMKICAgICBJZiB5b3UgdXNlIGFuIGFkYXB0ZXIgc3VjaCBhcyBFbWJlcidzIGRlZmF1bHQKICAgIFtgSlNPTkFQSUFkYXB0ZXJgXShodHRwczovL2VtYmVyanMuY29tL2FwaS9kYXRhL2NsYXNzZXMvRFMuSlNPTkFQSUFkYXB0ZXIuaHRtbCkKICAgIHRoYXQgc3VwcG9ydHMgdGhlIFtKU09OIEFQSSBzcGVjaWZpY2F0aW9uXShodHRwOi8vanNvbmFwaS5vcmcvKSBhbmQgaWYgeW91ciBzZXJ2ZXIKICAgIGVuZHBvaW50IHN1cHBvcnRzIHRoZSB1c2Ugb2YgYW4KICAgIFsnaW5jbHVkZScgcXVlcnkgcGFyYW1ldGVyXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNmZXRjaGluZy1pbmNsdWRlcyksCiAgICB5b3UgY2FuIHVzZSBgZmluZEFsbCgpYCB0byBhdXRvbWF0aWNhbGx5IHJldHJpZXZlIGFkZGl0aW9uYWwgcmVjb3JkcyByZWxhdGVkIHRvCiAgICB0aG9zZSByZXF1ZXN0ZWQgYnkgc3VwcGx5aW5nIGFuIGBpbmNsdWRlYCBwYXJhbWV0ZXIgaW4gdGhlIGBvcHRpb25zYCBvYmplY3QuCiAgICAgRm9yIGV4YW1wbGUsIGdpdmVuIGEgYHBvc3RgIG1vZGVsIHRoYXQgaGFzIGEgYGhhc01hbnlgIHJlbGF0aW9uc2hpcCB3aXRoIGEgYGNvbW1lbnRgCiAgICBtb2RlbCwgd2hlbiB3ZSByZXRyaWV2ZSBhbGwgb2YgdGhlIHBvc3QgcmVjb3JkcyB3ZSBjYW4gaGF2ZSB0aGUgc2VydmVyIGFsc28gcmV0dXJuCiAgICBhbGwgb2YgdGhlIHBvc3RzJyBjb21tZW50cyBpbiB0aGUgc2FtZSByZXF1ZXN0OgogICAgIGBgYGFwcC9yb3V0ZXMvcG9zdHMuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCgncG9zdCcsIHsgaW5jbHVkZTogJ2NvbW1lbnRzJyB9KTsKICAgICAgfQogICAgfSk7CiAgICAgYGBgCiAgICBNdWx0aXBsZSByZWxhdGlvbnNoaXBzIGNhbiBiZSByZXF1ZXN0ZWQgdXNpbmcgYW4gYGluY2x1ZGVgIHBhcmFtZXRlciBjb25zaXN0aW5nIG9mIGEKICAgIGNvbW1hLXNlcGFyYXRlZCBsaXN0ICh3aXRob3V0IHdoaXRlLXNwYWNlKSB3aGlsZSBuZXN0ZWQgcmVsYXRpb25zaGlwcyBjYW4gYmUgc3BlY2lmaWVkCiAgICB1c2luZyBhIGRvdC1zZXBhcmF0ZWQgc2VxdWVuY2Ugb2YgcmVsYXRpb25zaGlwIG5hbWVzLiBTbyB0byByZXF1ZXN0IGJvdGggdGhlIHBvc3RzJwogICAgY29tbWVudHMgYW5kIHRoZSBhdXRob3JzIG9mIHRob3NlIGNvbW1lbnRzIHRoZSByZXF1ZXN0IHdvdWxkIGxvb2sgbGlrZSB0aGlzOgogICAgIGBgYGFwcC9yb3V0ZXMvcG9zdHMuanMKICAgIGltcG9ydCBSb3V0ZSBmcm9tICdAZW1iZXIvcm91dGluZy9yb3V0ZSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgUm91dGUuZXh0ZW5kKHsKICAgICAgbW9kZWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZmluZEFsbCgncG9zdCcsIHsgaW5jbHVkZTogJ2NvbW1lbnRzLGNvbW1lbnRzLmF1dGhvcicgfSk7CiAgICAgIH0KICAgIH0pOwogICAgIGBgYAogICAgIFNlZSBbcXVlcnldKCNtZXRob2RfcXVlcnkpIHRvIG9ubHkgZ2V0IGEgc3Vic2V0IG9mIHJlY29yZHMgZnJvbSB0aGUgc2VydmVyLgogICAgIEBzaW5jZSAxLjEzLjAKICAgIEBtZXRob2QgZmluZEFsbAogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAqLwogIGZpbmRBbGwobW9kZWxOYW1lLCBvcHRpb25zKSB7CiAgICAodHJ1ZSAmJiAhKEVtYmVyLmlzUHJlc2VudChtb2RlbE5hbWUpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBuZWVkIHRvIHBhc3MgYSBtb2RlbCBuYW1lIHRvIHRoZSBzdG9yZSdzIGZpbmRBbGwgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpKTsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgUGFzc2luZyBjbGFzc2VzIHRvIHN0b3JlIG1ldGhvZHMgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHBhc3MgYSBkYXNoZXJpemVkIHN0cmluZyBpbnN0ZWFkIG9mICR7bW9kZWxOYW1lfWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgogICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgIHZhciBmZXRjaCA9IHRoaXMuX2ZldGNoQWxsKG5vcm1hbGl6ZWRNb2RlbE5hbWUsIHRoaXMucGVla0FsbChub3JtYWxpemVkTW9kZWxOYW1lKSwgb3B0aW9ucyk7CgogICAgcmV0dXJuIGZldGNoOwogIH0sCgogIC8qKgogICAgQG1ldGhvZCBfZmV0Y2hBbGwKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0RTLk1vZGVsfSBtb2RlbE5hbWUKICAgIEBwYXJhbSB7RFMuUmVjb3JkQXJyYXl9IGFycmF5CiAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgKi8KICBfZmV0Y2hBbGwobW9kZWxOYW1lLCBhcnJheSwgb3B0aW9ucyA9IHt9KSB7CiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihtb2RlbE5hbWUpOwogICAgdmFyIHNpbmNlVG9rZW4gPSB0aGlzLl9pbnRlcm5hbE1vZGVsc0Zvcihtb2RlbE5hbWUpLm1ldGFkYXRhLnNpbmNlOwoKICAgICh0cnVlICYmICEoYWRhcHRlcikgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gbG9hZCBhbGwgcmVjb3JkcyBidXQgeW91IGhhdmUgbm8gYWRhcHRlciAoZm9yICR7bW9kZWxOYW1lfSlgLCBhZGFwdGVyKSk7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBhZGFwdGVyLmZpbmRBbGwgPT09ICdmdW5jdGlvbicpICYmIEVtYmVyLmFzc2VydChgWW91IHRyaWVkIHRvIGxvYWQgYWxsIHJlY29yZHMgYnV0IHlvdXIgYWRhcHRlciBkb2VzIG5vdCBpbXBsZW1lbnQgJ2ZpbmRBbGwnYCwgdHlwZW9mIGFkYXB0ZXIuZmluZEFsbCA9PT0gJ2Z1bmN0aW9uJykpOwoKCiAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHsKICAgICAgRW1iZXIuc2V0KGFycmF5LCAnaXNVcGRhdGluZycsIHRydWUpOwogICAgICByZXR1cm4gcHJvbWlzZUFycmF5KF9maW5kQWxsKGFkYXB0ZXIsIHRoaXMsIG1vZGVsTmFtZSwgc2luY2VUb2tlbiwgb3B0aW9ucykpOwogICAgfQoKICAgIHZhciBzbmFwc2hvdEFycmF5ID0gYXJyYXkuX2NyZWF0ZVNuYXBzaG90KG9wdGlvbnMpOwoKICAgIGlmIChhZGFwdGVyLnNob3VsZFJlbG9hZEFsbCh0aGlzLCBzbmFwc2hvdEFycmF5KSkgewogICAgICBFbWJlci5zZXQoYXJyYXksICdpc1VwZGF0aW5nJywgdHJ1ZSk7CiAgICAgIHJldHVybiBwcm9taXNlQXJyYXkoX2ZpbmRBbGwoYWRhcHRlciwgdGhpcywgbW9kZWxOYW1lLCBzaW5jZVRva2VuLCBvcHRpb25zKSk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuYmFja2dyb3VuZFJlbG9hZCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIHByb21pc2VBcnJheShFbWJlci5SU1ZQLlByb21pc2UucmVzb2x2ZShhcnJheSkpOwogICAgfQoKICAgIGlmIChvcHRpb25zLmJhY2tncm91bmRSZWxvYWQgfHwgYWRhcHRlci5zaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsKHRoaXMsIHNuYXBzaG90QXJyYXkpKSB7CiAgICAgIEVtYmVyLnNldChhcnJheSwgJ2lzVXBkYXRpbmcnLCB0cnVlKTsKICAgICAgX2ZpbmRBbGwoYWRhcHRlciwgdGhpcywgbW9kZWxOYW1lLCBzaW5jZVRva2VuLCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gcHJvbWlzZUFycmF5KEVtYmVyLlJTVlAuUHJvbWlzZS5yZXNvbHZlKGFycmF5KSk7CiAgfSwKCiAgLyoqCiAgICBAbWV0aG9kIF9kaWRVcGRhdGVBbGwKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEBwcml2YXRlCiAgKi8KICBfZGlkVXBkYXRlQWxsKG1vZGVsTmFtZSkgewogICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIuX2RpZFVwZGF0ZUFsbChtb2RlbE5hbWUpOwogIH0sCgogIGRpZFVwZGF0ZUFsbChtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEoZmFsc2UpICYmIEVtYmVyLmRlcHJlY2F0ZSgnZGlkVXBkYXRlQWxsIHdhcyBkb2N1bWVudGVkIGFzIHByaXZhdGUgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCB2ZXJzaW9uIG9mIEVtYmVyIERhdGEuJywgZmFsc2UsIHsgaWQ6ICdlbWJlci1kYXRhLmRpZFVwZGF0ZUFsbCcsIHVudGlsOiAnMi4xNy4wJyB9KSk7CgogICAgcmV0dXJuIHRoaXMuX2RpZFVwZGF0ZUFsbChtb2RlbE5hbWUpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgcmV0dXJucyBhIGZpbHRlcmVkIGFycmF5IHRoYXQgY29udGFpbnMgYWxsIG9mIHRoZQogICAga25vd24gcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlIGluIHRoZSBzdG9yZS4KICAgICBOb3RlIHRoYXQgYmVjYXVzZSBpdCdzIGp1c3QgYSBmaWx0ZXIsIHRoZSByZXN1bHQgd2lsbCBjb250YWluIGFueQogICAgbG9jYWxseSBjcmVhdGVkIHJlY29yZHMgb2YgdGhlIHR5cGUsIGhvd2V2ZXIsIGl0IHdpbGwgbm90IG1ha2UgYQogICAgcmVxdWVzdCB0byB0aGUgYmFja2VuZCB0byByZXRyaWV2ZSBhZGRpdGlvbmFsIHJlY29yZHMuIElmIHlvdQogICAgd291bGQgbGlrZSB0byByZXF1ZXN0IGFsbCB0aGUgcmVjb3JkcyBmcm9tIHRoZSBiYWNrZW5kIHBsZWFzZSB1c2UKICAgIFtzdG9yZS5maW5kQWxsXSgjbWV0aG9kX2ZpbmRBbGwpLgogICAgIEFsc28gbm90ZSB0aGF0IG11bHRpcGxlIGNhbGxzIHRvIGBwZWVrQWxsYCBmb3IgYSBnaXZlbiB0eXBlIHdpbGwgYWx3YXlzCiAgICByZXR1cm4gdGhlIHNhbWUgYFJlY29yZEFycmF5YC4KICAgICBFeGFtcGxlCiAgICAgYGBgamF2YXNjcmlwdAogICAgbGV0IGxvY2FsUG9zdHMgPSBzdG9yZS5wZWVrQWxsKCdwb3N0Jyk7CiAgICBgYGAKICAgICBAc2luY2UgMS4xMy4wCiAgICBAbWV0aG9kIHBlZWtBbGwKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEByZXR1cm4ge0RTLlJlY29yZEFycmF5fQogICovCiAgcGVla0FsbChtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgcGVla0FsbCBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCiAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwogICAgcmV0dXJuIHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLmxpdmVSZWNvcmRBcnJheUZvcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgIFRoaXMgbWV0aG9kIHVubG9hZHMgYWxsIHJlY29yZHMgaW4gdGhlIHN0b3JlLgogICAgSXQgc2NoZWR1bGVzIHVubG9hZGluZyB0byBoYXBwZW4gZHVyaW5nIHRoZSBuZXh0IHJ1biBsb29wLgogICAgIE9wdGlvbmFsbHkgeW91IGNhbiBwYXNzIGEgdHlwZSB3aGljaCB1bmxvYWQgYWxsIHJlY29yZHMgZm9yIGEgZ2l2ZW4gdHlwZS4KICAgICBgYGBqYXZhc2NyaXB0CiAgICBzdG9yZS51bmxvYWRBbGwoKTsKICAgIHN0b3JlLnVubG9hZEFsbCgncG9zdCcpOwogICAgYGBgCiAgICAgQG1ldGhvZCB1bmxvYWRBbGwKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAqLwogIHVubG9hZEFsbChtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEoIW1vZGVsTmFtZSB8fCB0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgIW1vZGVsTmFtZSB8fCB0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykpOwoKCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9pZGVudGl0eU1hcC5jbGVhcigpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgICAgdGhpcy5faW50ZXJuYWxNb2RlbHNGb3Iobm9ybWFsaXplZE1vZGVsTmFtZSkuY2xlYXIoKTsKICAgIH0KICB9LAoKICBmaWx0ZXIoKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5hc3NlcnQoJ1RoZSBmaWx0ZXIgQVBJIGhhcyBiZWVuIG1vdmVkIHRvIGEgcGx1Z2luLiBUbyBlbmFibGUgc3RvcmUuZmlsdGVyIHVzaW5nIGFuIGVudmlyb25tZW50IGZsYWcsIG9yIHRvIHVzZSBhbiBhbHRlcm5hdGl2ZSwgeW91IGNhbiB2aXNpdCB0aGUgZW1iZXItZGF0YS1maWx0ZXIgYWRkb24gcGFnZS4gaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyLWRhdGEvZW1iZXItZGF0YS1maWx0ZXInLCBmYWxzZSkpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaGFzIGJlZW4gZGVwcmVjYXRlZCBhbmQgaXMgYW4gYWxpYXMgZm9yIHN0b3JlLmhhc1JlY29yZEZvcklkLCB3aGljaCBzaG91bGQKICAgIGJlIHVzZWQgaW5zdGVhZC4KICAgICBAZGVwcmVjYXRlZAogICAgQG1ldGhvZCByZWNvcmRJc0xvYWRlZAogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtzdHJpbmd9IGlkCiAgICBAcmV0dXJuIHtib29sZWFufQogICovCiAgcmVjb3JkSXNMb2FkZWQobW9kZWxOYW1lLCBpZCkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgRW1iZXIuZGVwcmVjYXRlKGBVc2Ugb2YgcmVjb3JkSXNMb2FkZWQgaXMgZGVwcmVjYXRlZCwgdXNlIGhhc1JlY29yZEZvcklkIGluc3RlYWQuYCwgZmFsc2UsIHsKICAgICAgaWQ6ICdkcy5zdG9yZS5yZWNvcmRJc0xvYWRlZCcsCiAgICAgIHVudGlsOiAnMy4wJwogICAgfSkpOwoKICAgIHJldHVybiB0aGlzLmhhc1JlY29yZEZvcklkKG1vZGVsTmFtZSwgaWQpOwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uCiAgLy8gLiBQRVJTSVNUSU5HIC4KICAvLyAuLi4uLi4uLi4uLi4uLgoKICAvKioKICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSBgcmVjb3JkLnNhdmVgLCBhbmQgZ2V0cyBwYXNzZWQgYQogICAgcmVzb2x2ZXIgZm9yIHRoZSBwcm9taXNlIHRoYXQgYHJlY29yZC5zYXZlYCByZXR1cm5zLgogICAgIEl0IHNjaGVkdWxlcyBzYXZpbmcgdG8gaGFwcGVuIGF0IHRoZSBlbmQgb2YgdGhlIHJ1biBsb29wLgogICAgIEBtZXRob2Qgc2NoZWR1bGVTYXZlCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICBAcGFyYW0ge1Jlc29sdmVyfSByZXNvbHZlcgogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAqLwogIHNjaGVkdWxlU2F2ZShpbnRlcm5hbE1vZGVsLCByZXNvbHZlciwgb3B0aW9ucykgewogICAgdmFyIHNuYXBzaG90ID0gaW50ZXJuYWxNb2RlbC5jcmVhdGVTbmFwc2hvdChvcHRpb25zKTsKICAgIGludGVybmFsTW9kZWwuZmx1c2hDaGFuZ2VkQXR0cmlidXRlcygpOwogICAgaW50ZXJuYWxNb2RlbC5hZGFwdGVyV2lsbENvbW1pdCgpOwogICAgdGhpcy5fcGVuZGluZ1NhdmUucHVzaCh7CiAgICAgIHNuYXBzaG90OiBzbmFwc2hvdCwKICAgICAgcmVzb2x2ZXI6IHJlc29sdmVyCiAgICB9KTsKICAgIGVtYmVyUnVuLnNjaGVkdWxlT25jZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMuZmx1c2hQZW5kaW5nU2F2ZSk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYXQgdGhlIGVuZCBvZiB0aGUgcnVuIGxvb3AsIGFuZAogICAgZmx1c2hlcyBhbnkgcmVjb3JkcyBwYXNzZWQgaW50byBgc2NoZWR1bGVTYXZlYAogICAgIEBtZXRob2QgZmx1c2hQZW5kaW5nU2F2ZQogICAgQHByaXZhdGUKICAqLwogIGZsdXNoUGVuZGluZ1NhdmUoKSB7CiAgICB2YXIgcGVuZGluZyA9IHRoaXMuX3BlbmRpbmdTYXZlLnNsaWNlKCk7CiAgICB0aGlzLl9wZW5kaW5nU2F2ZSA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwLCBqID0gcGVuZGluZy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgdmFyIHBlbmRpbmdJdGVtID0gcGVuZGluZ1tpXTsKICAgICAgdmFyIHNuYXBzaG90ID0gcGVuZGluZ0l0ZW0uc25hcHNob3Q7CiAgICAgIHZhciByZXNvbHZlciA9IHBlbmRpbmdJdGVtLnJlc29sdmVyOwogICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHNuYXBzaG90Ll9pbnRlcm5hbE1vZGVsOwogICAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihpbnRlcm5hbE1vZGVsLm1vZGVsTmFtZSk7CiAgICAgIHZhciBvcGVyYXRpb24gPSB2b2lkIDA7CgogICAgICBpZiAoaW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUuc3RhdGVOYW1lID09PSAncm9vdC5kZWxldGVkLnNhdmVkJykgewogICAgICAgIHJlc29sdmVyLnJlc29sdmUoKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIGlmIChpbnRlcm5hbE1vZGVsLmlzTmV3KCkpIHsKICAgICAgICBvcGVyYXRpb24gPSAnY3JlYXRlUmVjb3JkJzsKICAgICAgfSBlbHNlIGlmIChpbnRlcm5hbE1vZGVsLmlzRGVsZXRlZCgpKSB7CiAgICAgICAgb3BlcmF0aW9uID0gJ2RlbGV0ZVJlY29yZCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3BlcmF0aW9uID0gJ3VwZGF0ZVJlY29yZCc7CiAgICAgIH0KCiAgICAgIHJlc29sdmVyLnJlc29sdmUoX2NvbW1pdChhZGFwdGVyLCB0aGlzLCBvcGVyYXRpb24sIHNuYXBzaG90KSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgb25jZSB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgYWRhcHRlcidzIGBjcmVhdGVSZWNvcmRgLCBgdXBkYXRlUmVjb3JkYCBvciBgZGVsZXRlUmVjb3JkYAogICAgaXMgcmVzb2x2ZWQuCiAgICAgSWYgdGhlIGRhdGEgcHJvdmlkZXMgYSBzZXJ2ZXItZ2VuZXJhdGVkIElELCBpdCB3aWxsCiAgICB1cGRhdGUgdGhlIHJlY29yZCBhbmQgdGhlIHN0b3JlJ3MgaW5kZXhlcy4KICAgICBAbWV0aG9kIGRpZFNhdmVSZWNvcmQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwgdGhlIGluLWZsaWdodCBpbnRlcm5hbCBtb2RlbAogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEgb3B0aW9uYWwgZGF0YSAoc2VlIGFib3ZlKQogICovCiAgZGlkU2F2ZVJlY29yZChpbnRlcm5hbE1vZGVsLCBkYXRhQXJnKSB7CiAgICB2YXIgZGF0YSA9IHZvaWQgMDsKICAgIGlmIChkYXRhQXJnKSB7CiAgICAgIGRhdGEgPSBkYXRhQXJnLmRhdGE7CiAgICB9CiAgICBpZiAoZGF0YSkgewogICAgICAvLyBub3JtYWxpemUgcmVsYXRpb25zaGlwIElEcyBpbnRvIHJlY29yZHMKICAgICAgdGhpcy51cGRhdGVJZChpbnRlcm5hbE1vZGVsLCBkYXRhKTsKICAgICAgdGhpcy5fc2V0dXBSZWxhdGlvbnNoaXBzRm9yTW9kZWwoaW50ZXJuYWxNb2RlbCwgZGF0YSk7CiAgICB9IGVsc2UgewogICAgICAodHJ1ZSAmJiAhKGludGVybmFsTW9kZWwuaWQpICYmIEVtYmVyLmFzc2VydChgWW91ciAke2ludGVybmFsTW9kZWwubW9kZWxOYW1lfSByZWNvcmQgd2FzIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGJ1dCB0aGUgcmVzcG9uc2UgZG9lcyBub3QgaGF2ZSBhbiBpZCBhbmQgbm8gaWQgaGFzIGJlZW4gc2V0IGNsaWVudCBzaWRlLiBSZWNvcmRzIG11c3QgaGF2ZSBpZHMuIFBsZWFzZSB1cGRhdGUgdGhlIHNlcnZlciByZXNwb25zZSB0byBwcm92aWRlIGFuIGlkIGluIHRoZSByZXNwb25zZSBvciBnZW5lcmF0ZSB0aGUgaWQgb24gdGhlIGNsaWVudCBzaWRlIGVpdGhlciBiZWZvcmUgc2F2aW5nIHRoZSByZWNvcmQgb3Igd2hpbGUgbm9ybWFsaXppbmcgdGhlIHJlc3BvbnNlLmAsIGludGVybmFsTW9kZWwuaWQpKTsKICAgIH0KCiAgICAvL1dlIGZpcnN0IG1ha2Ugc3VyZSB0aGUgcHJpbWFyeSBkYXRhIGhhcyBiZWVuIHVwZGF0ZWQKICAgIC8vVE9ETyB0cnkgdG8gbW92ZSBub3RpZmljYXRpb24gdG8gdGhlIHVzZXIgdG8gdGhlIGVuZCBvZiB0aGUgcnVubG9vcAogICAgaW50ZXJuYWxNb2RlbC5hZGFwdGVyRGlkQ29tbWl0KGRhdGEpOwogIH0sCgogIC8qKgogICAgVGhpcyBtZXRob2QgaXMgY2FsbGVkIG9uY2UgdGhlIHByb21pc2UgcmV0dXJuZWQgYnkgYW4KICAgIGFkYXB0ZXIncyBgY3JlYXRlUmVjb3JkYCwgYHVwZGF0ZVJlY29yZGAgb3IgYGRlbGV0ZVJlY29yZGAKICAgIGlzIHJlamVjdGVkIHdpdGggYSBgRFMuSW52YWxpZEVycm9yYC4KICAgICBAbWV0aG9kIHJlY29yZFdhc0ludmFsaWQKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwKICAgIEBwYXJhbSB7T2JqZWN0fSBlcnJvcnMKICAqLwogIHJlY29yZFdhc0ludmFsaWQoaW50ZXJuYWxNb2RlbCwgZXJyb3JzKSB7CiAgICBpbnRlcm5hbE1vZGVsLmFkYXB0ZXJEaWRJbnZhbGlkYXRlKGVycm9ycyk7CiAgfSwKCiAgLyoqCiAgICBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgb25jZSB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgYWRhcHRlcidzIGBjcmVhdGVSZWNvcmRgLCBgdXBkYXRlUmVjb3JkYCBvciBgZGVsZXRlUmVjb3JkYAogICAgaXMgcmVqZWN0ZWQgKHdpdGggYW55dGhpbmcgb3RoZXIgdGhhbiBhIGBEUy5JbnZhbGlkRXJyb3JgKS4KICAgICBAbWV0aG9kIHJlY29yZFdhc0Vycm9yCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtJbnRlcm5hbE1vZGVsfSBpbnRlcm5hbE1vZGVsCiAgICBAcGFyYW0ge0Vycm9yfSBlcnJvcgogICovCiAgcmVjb3JkV2FzRXJyb3IoaW50ZXJuYWxNb2RlbCwgZXJyb3IpIHsKICAgIGludGVybmFsTW9kZWwuYWRhcHRlckRpZEVycm9yKGVycm9yKTsKICB9LAoKICAvKioKICAgIFdoZW4gYW4gYWRhcHRlcidzIGBjcmVhdGVSZWNvcmRgLCBgdXBkYXRlUmVjb3JkYCBvciBgZGVsZXRlUmVjb3JkYAogICAgcmVzb2x2ZXMgd2l0aCBkYXRhLCB0aGlzIG1ldGhvZCBleHRyYWN0cyB0aGUgSUQgZnJvbSB0aGUgc3VwcGxpZWQKICAgIGRhdGEuCiAgICAgQG1ldGhvZCB1cGRhdGVJZAogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWxNb2RlbAogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAqLwogIHVwZGF0ZUlkKGludGVybmFsTW9kZWwsIGRhdGEpIHsKICAgIHZhciBvbGRJZCA9IGludGVybmFsTW9kZWwuaWQ7CiAgICB2YXIgbW9kZWxOYW1lID0gaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWU7CiAgICB2YXIgaWQgPSBjb2VyY2VJZChkYXRhLmlkKTsKCiAgICAvLyBJRCBhYnNvbHV0ZWx5IGNhbid0IGJlIG1pc3NpbmcgaWYgdGhlIG9sZElEIGlzIGVtcHR5IChtaXNzaW5nIElkIGluIHJlc3BvbnNlIGZvciBhIG5ldyByZWNvcmQpCiAgICAodHJ1ZSAmJiAhKCEoaWQgPT09IG51bGwgJiYgb2xkSWQgPT09IG51bGwpKSAmJiBFbWJlci5hc3NlcnQoYCcke21vZGVsTmFtZX0nIHdhcyBzYXZlZCB0byB0aGUgc2VydmVyLCBidXQgdGhlIHJlc3BvbnNlIGRvZXMgbm90IGhhdmUgYW4gaWQgYW5kIHlvdXIgcmVjb3JkIGRvZXMgbm90IGVpdGhlci5gLCAhKGlkID09PSBudWxsICYmIG9sZElkID09PSBudWxsKSkpOwoKICAgIC8vIElEIGFic29sdXRlbHkgY2FuJ3QgYmUgZGlmZmVyZW50IHRoYW4gb2xkSUQgaWYgb2xkSUQgaXMgbm90IG51bGwKCiAgICAodHJ1ZSAmJiAhKCEob2xkSWQgIT09IG51bGwgJiYgaWQgIT09IG9sZElkKSkgJiYgRW1iZXIuYXNzZXJ0KGAnJHttb2RlbE5hbWV9OiR7b2xkSWR9JyB3YXMgc2F2ZWQgdG8gdGhlIHNlcnZlciwgYnV0IHRoZSByZXNwb25zZSByZXR1cm5lZCB0aGUgbmV3IGlkICcke2lkfScuIFRoZSBzdG9yZSBjYW5ub3QgYXNzaWduIGEgbmV3IGlkIHRvIGEgcmVjb3JkIHRoYXQgYWxyZWFkeSBoYXMgYW4gaWQuYCwgIShvbGRJZCAhPT0gbnVsbCAmJiBpZCAhPT0gb2xkSWQpKSk7CgogICAgLy8gSUQgY2FuIGJlIG51bGwgaWYgb2xkSUQgaXMgbm90IG51bGwgKGFsdGVyZWQgSUQgaW4gcmVzcG9uc2UgZm9yIGEgcmVjb3JkKQogICAgLy8gaG93ZXZlciwgdGhpcyBpcyBtb3JlIHRoYW4gbGlrZWx5IGEgZGV2ZWxvcGVyIGVycm9yLgoKICAgIGlmIChvbGRJZCAhPT0gbnVsbCAmJiBpZCA9PT0gbnVsbCkgewogICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKGBZb3VyICR7bW9kZWxOYW1lfSByZWNvcmQgd2FzIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGJ1dCB0aGUgcmVzcG9uc2UgZG9lcyBub3QgaGF2ZSBhbiBpZC5gLCAhKG9sZElkICE9PSBudWxsICYmIGlkID09PSBudWxsKSkpOwoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBleGlzdGluZ0ludGVybmFsTW9kZWwgPSB0aGlzLl9leGlzdGluZ0ludGVybmFsTW9kZWxGb3JJZChtb2RlbE5hbWUsIGlkKTsKCiAgICAodHJ1ZSAmJiAhKEVtYmVyLmlzTm9uZShleGlzdGluZ0ludGVybmFsTW9kZWwpIHx8IGV4aXN0aW5nSW50ZXJuYWxNb2RlbCA9PT0gaW50ZXJuYWxNb2RlbCkgJiYgRW1iZXIuYXNzZXJ0KGAnJHttb2RlbE5hbWV9JyB3YXMgc2F2ZWQgdG8gdGhlIHNlcnZlciwgYnV0IHRoZSByZXNwb25zZSByZXR1cm5lZCB0aGUgbmV3IGlkICcke2lkfScsIHdoaWNoIGhhcyBhbHJlYWR5IGJlZW4gdXNlZCB3aXRoIGFub3RoZXIgcmVjb3JkLidgLCBFbWJlci5pc05vbmUoZXhpc3RpbmdJbnRlcm5hbE1vZGVsKSB8fCBleGlzdGluZ0ludGVybmFsTW9kZWwgPT09IGludGVybmFsTW9kZWwpKTsKCgogICAgdGhpcy5faW50ZXJuYWxNb2RlbHNGb3IoaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWUpLnNldChpZCwgaW50ZXJuYWxNb2RlbCk7CgogICAgaW50ZXJuYWxNb2RlbC5zZXRJZChpZCk7CiAgfSwKCiAgLyoqCiAgICBSZXR1cm5zIGEgbWFwIG9mIElEcyB0byBjbGllbnQgSURzIGZvciBhIGdpdmVuIG1vZGVsTmFtZS4KICAgICBAbWV0aG9kIF9pbnRlcm5hbE1vZGVsc0ZvcgogICAgQHByaXZhdGUKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEByZXR1cm4ge09iamVjdH0gcmVjb3JkTWFwCiAgKi8KICBfaW50ZXJuYWxNb2RlbHNGb3IobW9kZWxOYW1lKSB7CiAgICByZXR1cm4gdGhpcy5faWRlbnRpdHlNYXAucmV0cmlldmUobW9kZWxOYW1lKTsKICB9LAoKICAvLyAuLi4uLi4uLi4uLi4uLi4uCiAgLy8gLiBMT0FESU5HIERBVEEgLgogIC8vIC4uLi4uLi4uLi4uLi4uLi4KCiAgLyoqCiAgICBUaGlzIGludGVybmFsIG1ldGhvZCBpcyB1c2VkIGJ5IGBwdXNoYC4KICAgICBAbWV0aG9kIF9sb2FkCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtPYmplY3R9IGRhdGEKICAqLwogIF9sb2FkKGRhdGEpIHsKICAgIHZhciBtb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUoZGF0YS50eXBlKTsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpcy5faW50ZXJuYWxNb2RlbEZvcklkKG1vZGVsTmFtZSwgZGF0YS5pZCk7CgogICAgdmFyIGlzVXBkYXRlID0gaW50ZXJuYWxNb2RlbC5jdXJyZW50U3RhdGUuaXNFbXB0eSA9PT0gZmFsc2U7CgogICAgaW50ZXJuYWxNb2RlbC5zZXR1cERhdGEoZGF0YSk7CgogICAgaWYgKGlzVXBkYXRlKSB7CiAgICAgIHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLnJlY29yZERpZENoYW5nZShpbnRlcm5hbE1vZGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVjb3JkQXJyYXlNYW5hZ2VyLnJlY29yZFdhc0xvYWRlZChpbnRlcm5hbE1vZGVsKTsKICAgIH0KCiAgICByZXR1cm4gaW50ZXJuYWxNb2RlbDsKICB9LAoKICAvKgogICAgSW4gY2FzZSBzb21lb25lIGRlZmluZWQgYSByZWxhdGlvbnNoaXAgdG8gYSBtaXhpbiwgZm9yIGV4YW1wbGU6CiAgICBgYGAKICAgICAgbGV0IENvbW1lbnQgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIG93bmVyOiBiZWxvbmdzVG8oJ2NvbW1lbnRhYmxlJy4geyBwb2x5bW9ycGhpYzogdHJ1ZSB9KQogICAgICB9KTsKICAgICAgbGV0IENvbW1lbnRhYmxlID0gRW1iZXIuTWl4aW4uY3JlYXRlKHsKICAgICAgICBjb21tZW50czogaGFzTWFueSgnY29tbWVudCcpCiAgICAgIH0pOwogICAgYGBgCiAgICB3ZSB3YW50IHRvIGxvb2sgdXAgYSBDb21tZW50YWJsZSBjbGFzcyB3aGljaCBoYXMgYWxsIHRoZSBuZWNlc3NhcnkKICAgIHJlbGF0aW9uc2hpcCBtZXRhZGF0YS4gVGh1cywgd2UgbG9vayB1cCB0aGUgbWl4aW4gYW5kIGNyZWF0ZSBhIG1vY2sKICAgIERTLk1vZGVsLCBzbyB3ZSBjYW4gYWNjZXNzIHRoZSByZWxhdGlvbnNoaXAgQ1BzIG9mIHRoZSBtaXhpbiAoYGNvbW1lbnRzYCkKICAgIGluIHRoaXMgY2FzZQogICAgIEBwcml2YXRlCiAgKi8KICBfbW9kZWxGb3JNaXhpbihub3JtYWxpemVkTW9kZWxOYW1lKSB7CiAgICAvLyBjb250YWluZXIucmVnaXN0cnkgPSAyLjEKICAgIC8vIGNvbnRhaW5lci5fcmVnaXN0cnkgPSAxLjExIC0gMi4wCiAgICAvLyBjb250YWluZXIgPSA8IDEuMTEKICAgIHZhciBvd25lciA9IGdldE93bmVyKHRoaXMpOwogICAgdmFyIG1peGluID0gdm9pZCAwOwoKICAgIGlmIChvd25lci5mYWN0b3J5Rm9yKSB7CiAgICAgIHZhciBNYXliZU1peGluID0gb3duZXIuZmFjdG9yeUZvcihgbWl4aW46JHtub3JtYWxpemVkTW9kZWxOYW1lfWApOwogICAgICBtaXhpbiA9IE1heWJlTWl4aW4gJiYgTWF5YmVNaXhpbi5jbGFzczsKICAgIH0gZWxzZSB7CiAgICAgIG1peGluID0gb3duZXIuX2xvb2t1cEZhY3RvcnkoYG1peGluOiR7bm9ybWFsaXplZE1vZGVsTmFtZX1gKTsKICAgIH0KCiAgICBpZiAobWl4aW4pIHsKICAgICAgdmFyIE1vZGVsRm9yTWl4aW4gPSBNb2RlbC5leHRlbmQobWl4aW4pOwogICAgICBNb2RlbEZvck1peGluLnJlb3BlbkNsYXNzKHsKICAgICAgICBfX2lzTWl4aW46IHRydWUsCiAgICAgICAgX19taXhpbjogbWl4aW4KICAgICAgfSk7CgogICAgICAvL0NhY2hlIHRoZSBjbGFzcyBhcyBhIG1vZGVsCiAgICAgIG93bmVyLnJlZ2lzdGVyKCdtb2RlbDonICsgbm9ybWFsaXplZE1vZGVsTmFtZSwgTW9kZWxGb3JNaXhpbik7CiAgICB9CgogICAgcmV0dXJuIHRoaXMubW9kZWxGYWN0b3J5Rm9yKG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogIH0sCgogIC8qKgogICAgUmV0dXJucyB0aGUgbW9kZWwgY2xhc3MgZm9yIHRoZSBwYXJ0aWN1bGFyIGBtb2RlbE5hbWVgLgogICAgIFRoZSBjbGFzcyBvZiBhIG1vZGVsIG1pZ2h0IGJlIHVzZWZ1bCBpZiB5b3Ugd2FudCB0byBnZXQgYSBsaXN0IG9mIGFsbCB0aGUKICAgIHJlbGF0aW9uc2hpcCBuYW1lcyBvZiB0aGUgbW9kZWwsIHNlZQogICAgW2ByZWxhdGlvbnNoaXBOYW1lc2BdKGh0dHBzOi8vZW1iZXJqcy5jb20vYXBpL2RhdGEvY2xhc3Nlcy9EUy5Nb2RlbC5odG1sI3Byb3BlcnR5X3JlbGF0aW9uc2hpcE5hbWVzKQogICAgZm9yIGV4YW1wbGUuCiAgICAgQG1ldGhvZCBtb2RlbEZvcgogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHJldHVybiB7RFMuTW9kZWx9CiAgKi8KICBtb2RlbEZvcihtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgbW9kZWxGb3IgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpKTsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgUGFzc2luZyBjbGFzc2VzIHRvIHN0b3JlIG1ldGhvZHMgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHBhc3MgYSBkYXNoZXJpemVkIHN0cmluZyBpbnN0ZWFkIG9mICR7bW9kZWxOYW1lfWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgoKICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CgogICAgcmV0dXJuIHRoaXMuX21vZGVsRm9yKG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogIH0sCgogIC8qCiAgICBAcHJpdmF0ZQogICAqLwogIF9tb2RlbEZvcihtb2RlbE5hbWUpIHsKICAgIHZhciBtYXliZUZhY3RvcnkgPSB0aGlzLl9tb2RlbEZhY3RvcnlGb3IobW9kZWxOYW1lKTsKICAgIC8vIGZvciBmYWN0b3JGb3IgZmFjdG9yeS9jbGFzcyBzcGxpdAogICAgcmV0dXJuIG1heWJlRmFjdG9yeS5jbGFzcyA/IG1heWJlRmFjdG9yeS5jbGFzcyA6IG1heWJlRmFjdG9yeTsKICB9LAoKICBfbW9kZWxGYWN0b3J5Rm9yKG1vZGVsTmFtZSkgewogICAgdmFyIGZhY3RvcnkgPSB0aGlzLl9tb2RlbEZhY3RvcnlDYWNoZVttb2RlbE5hbWVdOwoKICAgIGlmICghZmFjdG9yeSkgewogICAgICBmYWN0b3J5ID0gdGhpcy5tb2RlbEZhY3RvcnlGb3IobW9kZWxOYW1lKTsKCiAgICAgIGlmICghZmFjdG9yeSkgewogICAgICAgIC8vU3VwcG9ydCBsb29raW5nIHVwIG1peGlucyBhcyBiYXNlIHR5cGVzIGZvciBwb2x5bW9ycGhpYyByZWxhdGlvbnNoaXBzCiAgICAgICAgZmFjdG9yeSA9IHRoaXMuX21vZGVsRm9yTWl4aW4obW9kZWxOYW1lKTsKICAgICAgfQogICAgICBpZiAoIWZhY3RvcnkpIHsKICAgICAgICB0aHJvdyBuZXcgRW1iZXIuRXJyb3IoYE5vIG1vZGVsIHdhcyBmb3VuZCBmb3IgJyR7bW9kZWxOYW1lfSdgKTsKICAgICAgfQoKICAgICAgLy8gaW50ZXJvcHQgd2l0aCB0aGUgZnV0dXJlCiAgICAgIHZhciBrbGFzcyA9IGdldE93bmVyKHRoaXMpLmZhY3RvcnlGb3IgPyBmYWN0b3J5LmNsYXNzIDogZmFjdG9yeTsKCiAgICAgICh0cnVlICYmICEoa2xhc3MuaXNNb2RlbCkgJiYgRW1iZXIuYXNzZXJ0KGAnJHtFbWJlci5pbnNwZWN0KGtsYXNzKX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlbWJlci1kYXRhIG1vZGVsYCwga2xhc3MuaXNNb2RlbCkpOwoKICAgICAgLy8gVE9ETzogZGVwcmVjYXRlIHRoaXMKCiAgICAgIHZhciBoYXNPd25Nb2RlbE5hbWVTZXQgPSBrbGFzcy5tb2RlbE5hbWUgJiYga2xhc3MuaGFzT3duUHJvcGVydHkoJ21vZGVsTmFtZScpOwogICAgICBpZiAoIWhhc093bk1vZGVsTmFtZVNldCkgewogICAgICAgIGtsYXNzLm1vZGVsTmFtZSA9IG1vZGVsTmFtZTsKICAgICAgfQoKICAgICAgdGhpcy5fbW9kZWxGYWN0b3J5Q2FjaGVbbW9kZWxOYW1lXSA9IGZhY3Rvcnk7CiAgICB9CgogICAgcmV0dXJuIGZhY3Rvcnk7CiAgfSwKCiAgLyoKICAgQHByaXZhdGUKICAgKi8KICBtb2RlbEZhY3RvcnlGb3IobW9kZWxOYW1lKSB7CiAgICAodHJ1ZSAmJiAhKEVtYmVyLmlzUHJlc2VudChtb2RlbE5hbWUpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBuZWVkIHRvIHBhc3MgYSBtb2RlbCBuYW1lIHRvIHRoZSBzdG9yZSdzIG1vZGVsRmFjdG9yeUZvciBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCgogICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKICAgIHZhciBvd25lciA9IGdldE93bmVyKHRoaXMpOwoKICAgIGlmIChvd25lci5mYWN0b3J5Rm9yKSB7CiAgICAgIHJldHVybiBvd25lci5mYWN0b3J5Rm9yKGBtb2RlbDoke25vcm1hbGl6ZWRNb2RlbE5hbWV9YCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gb3duZXIuX2xvb2t1cEZhY3RvcnkoYG1vZGVsOiR7bm9ybWFsaXplZE1vZGVsTmFtZX1gKTsKICAgIH0KICB9LAoKICAvKioKICAgIFB1c2ggc29tZSBkYXRhIGZvciBhIGdpdmVuIHR5cGUgaW50byB0aGUgc3RvcmUuCiAgICAgVGhpcyBtZXRob2QgZXhwZWN0cyBub3JtYWxpemVkIFtKU09OIEFQSV0oaHR0cDovL2pzb25hcGkub3JnLykgZG9jdW1lbnQuIFRoaXMgbWVhbnMgeW91IGhhdmUgdG8gZm9sbG93IFtKU09OIEFQSSBzcGVjaWZpY2F0aW9uXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0Lykgd2l0aCBmZXcgbWlub3IgYWRqdXN0bWVudHM6CiAgICAtIHJlY29yZCdzIGB0eXBlYCBzaG91bGQgYWx3YXlzIGJlIGluIHNpbmd1bGFyLCBkYXNoZXJpemVkIGZvcm0KICAgIC0gbWVtYmVycyAocHJvcGVydGllcykgc2hvdWxkIGJlIGNhbWVsQ2FzZWQKICAgICBbWW91ciBwcmltYXJ5IGRhdGEgc2hvdWxkIGJlIHdyYXBwZWQgaW5zaWRlIGBkYXRhYCBwcm9wZXJ0eV0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtdG9wLWxldmVsKToKICAgICBgYGBqcwogICAgc3RvcmUucHVzaCh7CiAgICAgIGRhdGE6IHsKICAgICAgICAvLyBwcmltYXJ5IGRhdGEgZm9yIHNpbmdsZSByZWNvcmQgb2YgdHlwZSBgUGVyc29uYAogICAgICAgIGlkOiAnMScsCiAgICAgICAgdHlwZTogJ3BlcnNvbicsCiAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgZmlyc3ROYW1lOiAnRGFuaWVsJywKICAgICAgICAgIGxhc3ROYW1lOiAnS21haycKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgW0RlbW8uXShodHRwOi8vZW1iZXItdHdpZGRsZS5jb20vZmI5OWYxOGNkM2I0ZDNlMmE0YzcpCiAgICAgYGRhdGFgIHByb3BlcnR5IGNhbiBhbHNvIGhvbGQgYW4gYXJyYXkgKG9mIHJlY29yZHMpOgogICAgIGBgYGpzCiAgICBzdG9yZS5wdXNoKHsKICAgICAgZGF0YTogWwogICAgICAgIC8vIGFuIGFycmF5IG9mIHJlY29yZHMKICAgICAgICB7CiAgICAgICAgICBpZDogJzEnLAogICAgICAgICAgdHlwZTogJ3BlcnNvbicsCiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIGZpcnN0TmFtZTogJ0RhbmllbCcsCiAgICAgICAgICAgIGxhc3ROYW1lOiAnS21haycKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIGlkOiAnMicsCiAgICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgICAgZmlyc3ROYW1lOiAnVG9tJywKICAgICAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgXQogICAgfSk7CiAgICBgYGAKICAgICBbRGVtby5dKGh0dHA6Ly9lbWJlci10d2lkZGxlLmNvbS82OWNkYmVhYTM3MDIxNTlkYzM1NSkKICAgICBUaGVyZSBhcmUgc29tZSB0eXBpY2FsIHByb3BlcnRpZXMgZm9yIGBKU09OQVBJYCBwYXlsb2FkOgogICAgKiBgaWRgIC0gbWFuZGF0b3J5LCB1bmlxdWUgcmVjb3JkJ3Mga2V5CiAgICAqIGB0eXBlYCAtIG1hbmRhdG9yeSBzdHJpbmcgd2hpY2ggbWF0Y2hlcyBgbW9kZWxgJ3MgZGFzaGVyaXplZCBuYW1lIGluIHNpbmd1bGFyIGZvcm0KICAgICogYGF0dHJpYnV0ZXNgIC0gb2JqZWN0IHdoaWNoIGhvbGRzIGRhdGEgZm9yIHJlY29yZCBhdHRyaWJ1dGVzIC0gYERTLmF0dHJgJ3MgZGVjbGFyZWQgaW4gbW9kZWwKICAgICogYHJlbGF0aW9uc2hpcHNgIC0gb2JqZWN0IHdoaWNoIG11c3QgY29udGFpbiBhbnkgb2YgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzIHVuZGVyIGVhY2ggcmVsYXRpb25zaGlwcycgcmVzcGVjdGl2ZSBrZXkgKGV4YW1wbGUgcGF0aCBpcyBgcmVsYXRpb25zaGlwcy5hY2hpZXZlbWVudHMuZGF0YWApOgogICAgICAtIFtgbGlua3NgXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1saW5rcykKICAgICAgLSBbYGRhdGFgXShodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1yZXNvdXJjZS1vYmplY3QtbGlua2FnZSkgLSBwbGFjZSBmb3IgcHJpbWFyeSBkYXRhCiAgICAgIC0gW2BtZXRhYF0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtbWV0YSkgLSBvYmplY3Qgd2hpY2ggY29udGFpbnMgbWV0YS1pbmZvcm1hdGlvbiBhYm91dCByZWxhdGlvbnNoaXAKICAgICBGb3IgdGhpcyBtb2RlbDoKICAgICBgYGBhcHAvbW9kZWxzL3BlcnNvbi5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIGZpcnN0TmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGxhc3ROYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgIGNoaWxkcmVuOiBEUy5oYXNNYW55KCdwZXJzb24nKQogICAgfSk7CiAgICBgYGAKICAgICBUbyByZXByZXNlbnQgdGhlIGNoaWxkcmVuIGFzIElEczoKICAgICBgYGBqcwogICAgewogICAgICBkYXRhOiB7CiAgICAgICAgaWQ6ICcxJywKICAgICAgICB0eXBlOiAncGVyc29uJywKICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICBmaXJzdE5hbWU6ICdUb20nLAogICAgICAgICAgbGFzdE5hbWU6ICdEYWxlJwogICAgICAgIH0sCiAgICAgICAgcmVsYXRpb25zaGlwczogewogICAgICAgICAgY2hpbGRyZW46IHsKICAgICAgICAgICAgZGF0YTogWwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlkOiAnMicsCiAgICAgICAgICAgICAgICB0eXBlOiAncGVyc29uJwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWQ6ICczJywKICAgICAgICAgICAgICAgIHR5cGU6ICdwZXJzb24nCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZDogJzQnLAogICAgICAgICAgICAgICAgdHlwZTogJ3BlcnNvbicKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGBgYAogICAgIFtEZW1vLl0oaHR0cDovL2VtYmVyLXR3aWRkbGUuY29tLzM0M2UxNzM1ZTAzNDA5MWY1YmRlKQogICAgIFRvIHJlcHJlc2VudCB0aGUgY2hpbGRyZW4gcmVsYXRpb25zaGlwIGFzIGEgVVJMOgogICAgIGBgYGpzCiAgICB7CiAgICAgIGRhdGE6IHsKICAgICAgICBpZDogJzEnLAogICAgICAgIHR5cGU6ICdwZXJzb24nLAogICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgIGZpcnN0TmFtZTogJ1RvbScsCiAgICAgICAgICBsYXN0TmFtZTogJ0RhbGUnCiAgICAgICAgfSwKICAgICAgICByZWxhdGlvbnNoaXBzOiB7CiAgICAgICAgICBjaGlsZHJlbjogewogICAgICAgICAgICBsaW5rczogewogICAgICAgICAgICAgIHJlbGF0ZWQ6ICcvcGVvcGxlLzEvY2hpbGRyZW4nCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGBgYAogICAgIElmIHlvdSdyZSBzdHJlYW1pbmcgZGF0YSBvciBpbXBsZW1lbnRpbmcgYW4gYWRhcHRlciwgbWFrZSBzdXJlCiAgICB0aGF0IHlvdSBoYXZlIGNvbnZlcnRlZCB0aGUgaW5jb21pbmcgZGF0YSBpbnRvIHRoaXMgZm9ybS4gVGhlCiAgICBzdG9yZSdzIFtub3JtYWxpemVdKCNtZXRob2Rfbm9ybWFsaXplKSBtZXRob2QgaXMgYSBjb252ZW5pZW5jZQogICAgaGVscGVyIGZvciBjb252ZXJ0aW5nIGEganNvbiBwYXlsb2FkIGludG8gdGhlIGZvcm0gRW1iZXIgRGF0YQogICAgZXhwZWN0cy4KICAgICBgYGBqcwogICAgc3RvcmUucHVzaChzdG9yZS5ub3JtYWxpemUoJ3BlcnNvbicsIGRhdGEpKTsKICAgIGBgYAogICAgIFRoaXMgbWV0aG9kIGNhbiBiZSB1c2VkIGJvdGggdG8gcHVzaCBpbiBicmFuZCBuZXcKICAgIHJlY29yZHMsIGFzIHdlbGwgYXMgdG8gdXBkYXRlIGV4aXN0aW5nIHJlY29yZHMuCiAgICAgQG1ldGhvZCBwdXNoCiAgICBAcGFyYW0ge09iamVjdH0gZGF0YQogICAgQHJldHVybiB7RFMuTW9kZWx8QXJyYXl9IHRoZSByZWNvcmQocykgdGhhdCB3YXMgY3JlYXRlZCBvcgogICAgICB1cGRhdGVkLgogICovCiAgcHVzaChkYXRhKSB7CiAgICB2YXIgcHVzaGVkID0gdGhpcy5fcHVzaChkYXRhKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShwdXNoZWQpKSB7CiAgICAgIHZhciByZWNvcmRzID0gcHVzaGVkLm1hcChpbnRlcm5hbE1vZGVsID0+IGludGVybmFsTW9kZWwuZ2V0UmVjb3JkKCkpOwoKICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICB9CgogICAgaWYgKHB1c2hlZCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICB2YXIgcmVjb3JkID0gcHVzaGVkLmdldFJlY29yZCgpOwoKICAgIHJldHVybiByZWNvcmQ7CiAgfSwKCiAgLyoKICAgIFB1c2ggc29tZSBkYXRhIGluIHRoZSBmb3JtIG9mIGEganNvbi1hcGkgZG9jdW1lbnQgaW50byB0aGUgc3RvcmUsCiAgICB3aXRob3V0IGNyZWF0aW5nIG1hdGVyaWFsaXplZCByZWNvcmRzLgogICAgIEBtZXRob2QgX3B1c2gKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge09iamVjdH0ganNvbkFwaURvYwogICAgQHJldHVybiB7RFMuSW50ZXJuYWxNb2RlbHxBcnJheTxEUy5JbnRlcm5hbE1vZGVsPn0gcHVzaGVkIEludGVybmFsTW9kZWwocykKICAqLwogIF9wdXNoKGpzb25BcGlEb2MpIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsT3JNb2RlbHMgPSB0aGlzLl9iYWNrYnVybmVyLmpvaW4oKCkgPT4gewogICAgICB2YXIgaW5jbHVkZWQgPSBqc29uQXBpRG9jLmluY2x1ZGVkOwogICAgICB2YXIgaSA9IHZvaWQgMCwKICAgICAgICAgIGxlbmd0aCA9IHZvaWQgMDsKCiAgICAgIGlmIChpbmNsdWRlZCkgewogICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGluY2x1ZGVkLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB0aGlzLl9wdXNoSW50ZXJuYWxNb2RlbChpbmNsdWRlZFtpXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoQXJyYXkuaXNBcnJheShqc29uQXBpRG9jLmRhdGEpKSB7CiAgICAgICAgbGVuZ3RoID0ganNvbkFwaURvYy5kYXRhLmxlbmd0aDsKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpbnRlcm5hbE1vZGVsc1tpXSA9IHRoaXMuX3B1c2hJbnRlcm5hbE1vZGVsKGpzb25BcGlEb2MuZGF0YVtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsczsKICAgICAgfQoKICAgICAgaWYgKGpzb25BcGlEb2MuZGF0YSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICAodHJ1ZSAmJiAhKEVtYmVyLnR5cGVPZihqc29uQXBpRG9jLmRhdGEpID09PSAnb2JqZWN0JykgJiYgRW1iZXIuYXNzZXJ0KGBFeHBlY3RlZCBhbiBvYmplY3QgaW4gdGhlICdkYXRhJyBwcm9wZXJ0eSBpbiBhIGNhbGwgdG8gJ3B1c2gnIGZvciAke2pzb25BcGlEb2MudHlwZX0sIGJ1dCB3YXMgJHtFbWJlci50eXBlT2YoanNvbkFwaURvYy5kYXRhKX1gLCBFbWJlci50eXBlT2YoanNvbkFwaURvYy5kYXRhKSA9PT0gJ29iamVjdCcpKTsKCgogICAgICByZXR1cm4gdGhpcy5fcHVzaEludGVybmFsTW9kZWwoanNvbkFwaURvYy5kYXRhKTsKICAgIH0pOwoKICAgIHJldHVybiBpbnRlcm5hbE1vZGVsT3JNb2RlbHM7CiAgfSwKCiAgX2hhc01vZGVsRm9yKG1vZGVsTmFtZSkgewogICAgdmFyIG93bmVyID0gZ2V0T3duZXIodGhpcyk7CiAgICBtb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICBpZiAob3duZXIuZmFjdG9yeUZvcikgewogICAgICByZXR1cm4gISFvd25lci5mYWN0b3J5Rm9yKGBtb2RlbDoke21vZGVsTmFtZX1gKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAhIW93bmVyLl9sb29rdXBGYWN0b3J5KGBtb2RlbDoke21vZGVsTmFtZX1gKTsKICAgIH0KICB9LAoKICBfcHVzaEludGVybmFsTW9kZWwoZGF0YSkgewogICAgdmFyIG1vZGVsTmFtZSA9IGRhdGEudHlwZTsKICAgICh0cnVlICYmICEoZGF0YS5pZCAhPT0gbnVsbCAmJiBkYXRhLmlkICE9PSB1bmRlZmluZWQgJiYgZGF0YS5pZCAhPT0gJycpICYmIEVtYmVyLmFzc2VydChgWW91IG11c3QgaW5jbHVkZSBhbiAnaWQnIGZvciAke21vZGVsTmFtZX0gaW4gYW4gb2JqZWN0IHBhc3NlZCB0byAncHVzaCdgLCBkYXRhLmlkICE9PSBudWxsICYmIGRhdGEuaWQgIT09IHVuZGVmaW5lZCAmJiBkYXRhLmlkICE9PSAnJykpOwogICAgKHRydWUgJiYgISh0aGlzLl9oYXNNb2RlbEZvcihtb2RlbE5hbWUpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSB0cmllZCB0byBwdXNoIGRhdGEgd2l0aCBhIHR5cGUgJyR7bW9kZWxOYW1lfScgYnV0IG5vIG1vZGVsIGNvdWxkIGJlIGZvdW5kIHdpdGggdGhhdCBuYW1lLmAsIHRoaXMuX2hhc01vZGVsRm9yKG1vZGVsTmFtZSkpKTsKCgogICAgewogICAgICAvLyBJZiBFTlYuRFNfV0FSTl9PTl9VTktOT1dOX0tFWVMgaXMgc2V0IHRvIHRydWUgYW5kIHRoZSBwYXlsb2FkCiAgICAgIC8vIGNvbnRhaW5zIHVua25vd24gYXR0cmlidXRlcyBvciByZWxhdGlvbnNoaXBzLCBsb2cgYSB3YXJuaW5nLgoKICAgICAgaWYgKEVOVi5EU19XQVJOX09OX1VOS05PV05fS0VZUykgewogICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5fbW9kZWxGb3IobW9kZWxOYW1lKTsKCiAgICAgICAgLy8gQ2hlY2sgdW5rbm93biBhdHRyaWJ1dGVzCiAgICAgICAgdmFyIHVua25vd25BdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZGF0YS5hdHRyaWJ1dGVzIHx8IHt9KS5maWx0ZXIoa2V5ID0+IHsKICAgICAgICAgIHJldHVybiAhRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdmaWVsZHMnKS5oYXMoa2V5KTsKICAgICAgICB9KTsKICAgICAgICB2YXIgdW5rbm93bkF0dHJpYnV0ZXNNZXNzYWdlID0gYFRoZSBwYXlsb2FkIGZvciAnJHttb2RlbE5hbWV9JyBjb250YWlucyB0aGVzZSB1bmtub3duIGF0dHJpYnV0ZXM6ICR7dW5rbm93bkF0dHJpYnV0ZXN9LiBNYWtlIHN1cmUgdGhleSd2ZSBiZWVuIGRlZmluZWQgaW4geW91ciBtb2RlbC5gOwogICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4odW5rbm93bkF0dHJpYnV0ZXNNZXNzYWdlLCB1bmtub3duQXR0cmlidXRlcy5sZW5ndGggPT09IDAsIHsgaWQ6ICdkcy5zdG9yZS51bmtub3duLWtleXMtaW4tcGF5bG9hZCcgfSkpOwoKICAgICAgICAvLyBDaGVjayB1bmtub3duIHJlbGF0aW9uc2hpcHMKCiAgICAgICAgdmFyIHVua25vd25SZWxhdGlvbnNoaXBzID0gT2JqZWN0LmtleXMoZGF0YS5yZWxhdGlvbnNoaXBzIHx8IHt9KS5maWx0ZXIoa2V5ID0+IHsKICAgICAgICAgIHJldHVybiAhRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdmaWVsZHMnKS5oYXMoa2V5KTsKICAgICAgICB9KTsKICAgICAgICB2YXIgdW5rbm93blJlbGF0aW9uc2hpcHNNZXNzYWdlID0gYFRoZSBwYXlsb2FkIGZvciAnJHttb2RlbE5hbWV9JyBjb250YWlucyB0aGVzZSB1bmtub3duIHJlbGF0aW9uc2hpcHM6ICR7dW5rbm93blJlbGF0aW9uc2hpcHN9LiBNYWtlIHN1cmUgdGhleSd2ZSBiZWVuIGRlZmluZWQgaW4geW91ciBtb2RlbC5gOwogICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4odW5rbm93blJlbGF0aW9uc2hpcHNNZXNzYWdlLCB1bmtub3duUmVsYXRpb25zaGlwcy5sZW5ndGggPT09IDAsIHsgaWQ6ICdkcy5zdG9yZS51bmtub3duLWtleXMtaW4tcGF5bG9hZCcgfSkpOwogICAgICB9CiAgICB9CgogICAgLy8gQWN0dWFsbHkgbG9hZCB0aGUgcmVjb3JkIGludG8gdGhlIHN0b3JlLgogICAgdmFyIGludGVybmFsTW9kZWwgPSB0aGlzLl9sb2FkKGRhdGEpOwoKICAgIHRoaXMuX3NldHVwUmVsYXRpb25zaGlwc0Zvck1vZGVsKGludGVybmFsTW9kZWwsIGRhdGEpOwoKICAgIHJldHVybiBpbnRlcm5hbE1vZGVsOwogIH0sCgogIF9zZXR1cFJlbGF0aW9uc2hpcHNGb3JNb2RlbChpbnRlcm5hbE1vZGVsLCBkYXRhKSB7CiAgICBpZiAoZGF0YS5yZWxhdGlvbnNoaXBzID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLl9wdXNoZWRJbnRlcm5hbE1vZGVscy5wdXNoKGludGVybmFsTW9kZWwsIGRhdGEpICE9PSAyKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9iYWNrYnVybmVyLnNjaGVkdWxlKCdub3JtYWxpemVSZWxhdGlvbnNoaXBzJywgdGhpcywgdGhpcy5fc2V0dXBSZWxhdGlvbnNoaXBzKTsKICB9LAoKICBfc2V0dXBSZWxhdGlvbnNoaXBzKCkgewogICAgdmFyIHB1c2hlZCA9IHRoaXMuX3B1c2hlZEludGVybmFsTW9kZWxzOwoKICAgIC8vIENhY2hlIHRoZSBpbnZlcnNlIG1hcHMgZm9yIGVhY2ggbW9kZWxDbGFzcyB0aGF0IHdlIHZpc2l0IGR1cmluZyB0aGlzCiAgICAvLyBwYXlsb2FkIHB1c2guICBJbiB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgd2UgYXJlIHB1c2hpbmcgbWFueSBtb3JlCiAgICAvLyBpbnN0YW5jZXMgdGhhbiB0eXBlcyB3ZSB3YW50IHRvIG1pbmltaXplIHRoZSBjb3N0IG9mIGxvb2tpbmcgdXAgdGhlCiAgICAvLyBpbnZlcnNlIG1hcCBhbmQgdGhlIG92ZXJoZWFkIG9mIEVtYmVyLmdldCBhZGRzIHVwLgogICAgdmFyIG1vZGVsTmFtZVRvSW52ZXJzZU1hcCA9IHZvaWQgMDsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHB1c2hlZC5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgbW9kZWxOYW1lVG9JbnZlcnNlTWFwID0gbW9kZWxOYW1lVG9JbnZlcnNlTWFwIHx8IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIC8vIFRoaXMgd2lsbCBjb252ZXJ0IHJlbGF0aW9uc2hpcHMgc3BlY2lmaWVkIGFzIElEcyBpbnRvIERTLk1vZGVsIGluc3RhbmNlcwogICAgICAvLyAocG9zc2libHkgdW5sb2FkZWQpIGFuZCBhbHNvIGNyZWF0ZSB0aGUgZGF0YSBzdHJ1Y3R1cmVzIHVzZWQgdG8gdHJhY2sKICAgICAgLy8gcmVsYXRpb25zaGlwcy4KICAgICAgdmFyIGludGVybmFsTW9kZWwgPSBwdXNoZWRbaV07CiAgICAgIHZhciBkYXRhID0gcHVzaGVkW2kgKyAxXTsKICAgICAgc2V0dXBSZWxhdGlvbnNoaXBzKHRoaXMsIGludGVybmFsTW9kZWwsIGRhdGEsIG1vZGVsTmFtZVRvSW52ZXJzZU1hcCk7CiAgICB9CgogICAgcHVzaGVkLmxlbmd0aCA9IDA7CiAgfSwKCiAgLyoqCiAgICBQdXNoIHNvbWUgcmF3IGRhdGEgaW50byB0aGUgc3RvcmUuCiAgICAgVGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgYm90aCB0byBwdXNoIGluIGJyYW5kIG5ldwogICAgcmVjb3JkcywgYXMgd2VsbCBhcyB0byB1cGRhdGUgZXhpc3RpbmcgcmVjb3Jkcy4gWW91CiAgICBjYW4gcHVzaCBpbiBtb3JlIHRoYW4gb25lIHR5cGUgb2Ygb2JqZWN0IGF0IG9uY2UuCiAgICBBbGwgb2JqZWN0cyBzaG91bGQgYmUgaW4gdGhlIGZvcm1hdCBleHBlY3RlZCBieSB0aGUKICAgIHNlcmlhbGl6ZXIuCiAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgZXhwb3J0IGRlZmF1bHQgRFMuQWN0aXZlTW9kZWxTZXJpYWxpemVyOwogICAgYGBgCiAgICAgYGBganMKICAgIGxldCBwdXNoRGF0YSA9IHsKICAgICAgcG9zdHM6IFsKICAgICAgICB7IGlkOiAxLCBwb3N0X3RpdGxlOiAiR3JlYXQgcG9zdCIsIGNvbW1lbnRfaWRzOiBbMl0gfQogICAgICBdLAogICAgICBjb21tZW50czogWwogICAgICAgIHsgaWQ6IDIsIGNvbW1lbnRfYm9keTogIkluc2lnaHRmdWwgY29tbWVudCIgfQogICAgICBdCiAgICB9CiAgICAgc3RvcmUucHVzaFBheWxvYWQocHVzaERhdGEpOwogICAgYGBgCiAgICAgQnkgZGVmYXVsdCwgdGhlIGRhdGEgd2lsbCBiZSBkZXNlcmlhbGl6ZWQgdXNpbmcgYSBkZWZhdWx0CiAgICBzZXJpYWxpemVyICh0aGUgYXBwbGljYXRpb24gc2VyaWFsaXplciBpZiBpdCBleGlzdHMpLgogICAgIEFsdGVybmF0aXZlbHksIGBwdXNoUGF5bG9hZGAgd2lsbCBhY2NlcHQgYSBtb2RlbCB0eXBlIHdoaWNoCiAgICB3aWxsIGRldGVybWluZSB3aGljaCBzZXJpYWxpemVyIHdpbGwgcHJvY2VzcyB0aGUgcGF5bG9hZC4KICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICBleHBvcnQgZGVmYXVsdCBEUy5BY3RpdmVNb2RlbFNlcmlhbGl6ZXI7CiAgICBgYGAKICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyOwogICAgYGBgCiAgICAgYGBganMKICAgIHN0b3JlLnB1c2hQYXlsb2FkKHB1c2hEYXRhKTsgLy8gV2lsbCB1c2UgdGhlIGFwcGxpY2F0aW9uIHNlcmlhbGl6ZXIKICAgIHN0b3JlLnB1c2hQYXlsb2FkKCdwb3N0JywgcHVzaERhdGEpOyAvLyBXaWxsIHVzZSB0aGUgcG9zdCBzZXJpYWxpemVyCiAgICBgYGAKICAgICBAbWV0aG9kIHB1c2hQYXlsb2FkCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIE9wdGlvbmFsbHksIGEgbW9kZWwgdHlwZSB1c2VkIHRvIGRldGVybWluZSB3aGljaCBzZXJpYWxpemVyIHdpbGwgYmUgdXNlZAogICAgQHBhcmFtIHtPYmplY3R9IGlucHV0UGF5bG9hZAogICovCiAgcHVzaFBheWxvYWQobW9kZWxOYW1lLCBpbnB1dFBheWxvYWQpIHsKICAgIHZhciBzZXJpYWxpemVyID0gdm9pZCAwOwogICAgdmFyIHBheWxvYWQgPSB2b2lkIDA7CiAgICBpZiAoIWlucHV0UGF5bG9hZCkgewogICAgICBwYXlsb2FkID0gbW9kZWxOYW1lOwogICAgICBzZXJpYWxpemVyID0gZGVmYXVsdFNlcmlhbGl6ZXIodGhpcyk7CiAgICAgICh0cnVlICYmICEodHlwZW9mIHNlcmlhbGl6ZXIucHVzaFBheWxvYWQgPT09ICdmdW5jdGlvbicpICYmIEVtYmVyLmFzc2VydChgWW91IGNhbm5vdCB1c2UgJ3N0b3JlI3B1c2hQYXlsb2FkJyB3aXRob3V0IGEgbW9kZWxOYW1lIHVubGVzcyB5b3VyIGRlZmF1bHQgc2VyaWFsaXplciBkZWZpbmVzICdwdXNoUGF5bG9hZCdgLCB0eXBlb2Ygc2VyaWFsaXplci5wdXNoUGF5bG9hZCA9PT0gJ2Z1bmN0aW9uJykpOwogICAgfSBlbHNlIHsKICAgICAgcGF5bG9hZCA9IGlucHV0UGF5bG9hZDsKICAgICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUgbWV0aG9kcyBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCiAgICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICAgIHNlcmlhbGl6ZXIgPSB0aGlzLnNlcmlhbGl6ZXJGb3Iobm9ybWFsaXplZE1vZGVsTmFtZSk7CiAgICB9CiAgICBzZXJpYWxpemVyLnB1c2hQYXlsb2FkKHRoaXMsIHBheWxvYWQpOwogIH0sCgogIC8qKgogICAgYG5vcm1hbGl6ZWAgY29udmVydHMgYSBqc29uIHBheWxvYWQgaW50byB0aGUgbm9ybWFsaXplZCBmb3JtIHRoYXQKICAgIFtwdXNoXSgjbWV0aG9kX3B1c2gpIGV4cGVjdHMuCiAgICAgRXhhbXBsZQogICAgIGBgYGpzCiAgICBzb2NrZXQub24oJ21lc3NhZ2UnLCBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIGxldCBtb2RlbE5hbWUgPSBtZXNzYWdlLm1vZGVsOwogICAgICBsZXQgZGF0YSA9IG1lc3NhZ2UuZGF0YTsKICAgICAgc3RvcmUucHVzaChzdG9yZS5ub3JtYWxpemUobW9kZWxOYW1lLCBkYXRhKSk7CiAgICB9KTsKICAgIGBgYAogICAgIEBtZXRob2Qgbm9ybWFsaXplCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2RlbCB0eXBlIGZvciB0aGlzIHBheWxvYWQKICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICBAcmV0dXJuIHtPYmplY3R9IFRoZSBub3JtYWxpemVkIHBheWxvYWQKICAqLwogIG5vcm1hbGl6ZShtb2RlbE5hbWUsIHBheWxvYWQpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3Mgbm9ybWFsaXplIG1ldGhvZGAsIEVtYmVyLmlzUHJlc2VudChtb2RlbE5hbWUpKSk7CiAgICAodHJ1ZSAmJiAhKHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSAmJiBFbWJlci5hc3NlcnQoYFBhc3NpbmcgY2xhc3NlcyB0byBzdG9yZSBtZXRob2RzIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSBwYXNzIGEgZGFzaGVyaXplZCBzdHJpbmcgaW5zdGVhZCBvZiAke0VtYmVyLmluc3BlY3QobW9kZWxOYW1lKX1gLCB0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykpOwoKICAgIHZhciBub3JtYWxpemVkTW9kZWxOYW1lID0gbm9ybWFsaXplTW9kZWxOYW1lKG1vZGVsTmFtZSk7CiAgICB2YXIgc2VyaWFsaXplciA9IHRoaXMuc2VyaWFsaXplckZvcihub3JtYWxpemVkTW9kZWxOYW1lKTsKICAgIHZhciBtb2RlbCA9IHRoaXMuX21vZGVsRm9yKG5vcm1hbGl6ZWRNb2RlbE5hbWUpOwogICAgcmV0dXJuIHNlcmlhbGl6ZXIubm9ybWFsaXplKG1vZGVsLCBwYXlsb2FkKTsKICB9LAoKICAvKioKICAgIEJ1aWxkIGEgYnJhbmQgbmV3IHJlY29yZCBmb3IgYSBnaXZlbiB0eXBlLCBJRCwgYW5kCiAgICBpbml0aWFsIGRhdGEuCiAgICAgQG1ldGhvZCBfYnVpbGRJbnRlcm5hbE1vZGVsCiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICBAcGFyYW0ge09iamVjdH0gZGF0YQogICAgQHJldHVybiB7SW50ZXJuYWxNb2RlbH0gaW50ZXJuYWwgbW9kZWwKICAqLwogIF9idWlsZEludGVybmFsTW9kZWwobW9kZWxOYW1lLCBpZCwgZGF0YSkgewogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgY2FuIG5vIGxvbmdlciBwYXNzIGEgbW9kZWxDbGFzcyBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gc3RvcmUuX2J1aWxkSW50ZXJuYWxNb2RlbC4gUGFzcyBtb2RlbE5hbWUgaW5zdGVhZC5gLCB0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykpOwoKCiAgICB2YXIgZXhpc3RpbmdJbnRlcm5hbE1vZGVsID0gdGhpcy5fZXhpc3RpbmdJbnRlcm5hbE1vZGVsRm9ySWQobW9kZWxOYW1lLCBpZCk7CgogICAgKHRydWUgJiYgISghZXhpc3RpbmdJbnRlcm5hbE1vZGVsKSAmJiBFbWJlci5hc3NlcnQoYFRoZSBpZCAke2lkfSBoYXMgYWxyZWFkeSBiZWVuIHVzZWQgd2l0aCBhbm90aGVyIHJlY29yZCBmb3IgbW9kZWxDbGFzcyAnJHttb2RlbE5hbWV9Jy5gLCAhZXhpc3RpbmdJbnRlcm5hbE1vZGVsKSk7CgogICAgLy8gbG9va3VwRmFjdG9yeSBzaG91bGQgcmVhbGx5IHJldHVybiBhbiBvYmplY3QgdGhhdCBjcmVhdGVzCiAgICAvLyBpbnN0YW5jZXMgd2l0aCB0aGUgaW5qZWN0aW9ucyBhcHBsaWVkCgogICAgdmFyIGludGVybmFsTW9kZWwgPSBuZXcgSW50ZXJuYWxNb2RlbChtb2RlbE5hbWUsIGlkLCB0aGlzLCBkYXRhKTsKCiAgICB0aGlzLl9pbnRlcm5hbE1vZGVsc0Zvcihtb2RlbE5hbWUpLmFkZChpbnRlcm5hbE1vZGVsLCBpZCk7CgogICAgcmV0dXJuIGludGVybmFsTW9kZWw7CiAgfSwKCiAgX2V4aXN0aW5nSW50ZXJuYWxNb2RlbEZvcklkKG1vZGVsTmFtZSwgaWQpIHsKICAgIHZhciBpbnRlcm5hbE1vZGVsID0gdGhpcy5faW50ZXJuYWxNb2RlbHNGb3IobW9kZWxOYW1lKS5nZXQoaWQpOwoKICAgIGlmIChpbnRlcm5hbE1vZGVsICYmIGludGVybmFsTW9kZWwuaGFzU2NoZWR1bGVkRGVzdHJveSgpKSB7CiAgICAgIC8vIHVubG9hZFJlY29yZCBpcyBhc3luYywgaWYgb25lIGF0dGVtcHRzIHRvIHVubG9hZCArIHRoZW4gc3luYyBjcmVhdGUsCiAgICAgIC8vIHdlIG11c3QgZW5zdXJlIHRoZSB1bmxvYWQgaXMgY29tcGxldGUgYmVmb3JlIHN0YXJ0aW5nIHRoZSBjcmVhdGUKICAgICAgaW50ZXJuYWxNb2RlbC5kZXN0cm95U3luYygpOwogICAgICBpbnRlcm5hbE1vZGVsID0gbnVsbDsKICAgIH0KICAgIHJldHVybiBpbnRlcm5hbE1vZGVsOwogIH0sCgogIGJ1aWxkSW50ZXJuYWxNb2RlbChtb2RlbE5hbWUsIGlkLCBkYXRhKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5kZXByZWNhdGUoJ2J1aWxkSW50ZXJuYWxNb2RlbCB3YXMgZG9jdW1lbnRlZCBhcyBwcml2YXRlIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgdmVyc2lvbiBvZiBFbWJlciBEYXRhLicsIGZhbHNlLCB7IGlkOiAnZW1iZXItZGF0YS5idWlsZEludGVybmFsTW9kZWwnLCB1bnRpbDogJzIuMTcuMCcgfSkpOwoKICAgIHJldHVybiB0aGlzLl9idWlsZEludGVybmFsTW9kZWwobW9kZWxOYW1lLCBpZCwgZGF0YSk7CiAgfSwKCiAgLy9DYWxsZWQgYnkgdGhlIHN0YXRlIG1hY2hpbmUgdG8gbm90aWZ5IHRoZSBzdG9yZSB0aGF0IHRoZSByZWNvcmQgaXMgcmVhZHkgdG8gYmUgaW50ZXJhY3RlZCB3aXRoCiAgcmVjb3JkV2FzTG9hZGVkKHJlY29yZCkgewogICAgdGhpcy5yZWNvcmRBcnJheU1hbmFnZXIucmVjb3JkV2FzTG9hZGVkKHJlY29yZCk7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uCiAgLy8gLiBERVNUUlVDVElPTiAuCiAgLy8gLi4uLi4uLi4uLi4uLi4uCgogIC8qKgogICAgV2hlbiBhIHJlY29yZCBpcyBkZXN0cm95ZWQsIHRoaXMgdW4taW5kZXhlcyBpdCBhbmQKICAgIHJlbW92ZXMgaXQgZnJvbSBhbnkgcmVjb3JkIGFycmF5cyBzbyBpdCBjYW4gYmUgR0NlZC4KICAgICBAbWV0aG9kIF9yZW1vdmVGcm9tSWRNYXAKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge0ludGVybmFsTW9kZWx9IGludGVybmFsTW9kZWwKICAqLwogIF9yZW1vdmVGcm9tSWRNYXAoaW50ZXJuYWxNb2RlbCkgewogICAgdmFyIHJlY29yZE1hcCA9IHRoaXMuX2ludGVybmFsTW9kZWxzRm9yKGludGVybmFsTW9kZWwubW9kZWxOYW1lKTsKICAgIHZhciBpZCA9IGludGVybmFsTW9kZWwuaWQ7CgogICAgcmVjb3JkTWFwLnJlbW92ZShpbnRlcm5hbE1vZGVsLCBpZCk7CiAgfSwKCiAgLy8gLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIC4gUEVSLVRZUEUgQURBUFRFUlMKICAvLyAuLi4uLi4uLi4uLi4uLi4uLi4uLi4uCgogIC8qKgogICAgUmV0dXJucyBhbiBpbnN0YW5jZSBvZiB0aGUgYWRhcHRlciBmb3IgYSBnaXZlbiB0eXBlLiBGb3IKICAgIGV4YW1wbGUsIGBhZGFwdGVyRm9yKCdwZXJzb24nKWAgd2lsbCByZXR1cm4gYW4gaW5zdGFuY2Ugb2YKICAgIGBBcHAuUGVyc29uQWRhcHRlcmAuCiAgICAgSWYgbm8gYEFwcC5QZXJzb25BZGFwdGVyYCBpcyBmb3VuZCwgdGhpcyBtZXRob2Qgd2lsbCBsb29rCiAgICBmb3IgYW4gYEFwcC5BcHBsaWNhdGlvbkFkYXB0ZXJgICh0aGUgZGVmYXVsdCBhZGFwdGVyIGZvcgogICAgeW91ciBlbnRpcmUgYXBwbGljYXRpb24pLgogICAgIElmIG5vIGBBcHAuQXBwbGljYXRpb25BZGFwdGVyYCBpcyBmb3VuZCwgaXQgd2lsbCByZXR1cm4KICAgIHRoZSB2YWx1ZSBvZiB0aGUgYGRlZmF1bHRBZGFwdGVyYC4KICAgICBAbWV0aG9kIGFkYXB0ZXJGb3IKICAgIEBwdWJsaWMKICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgIEByZXR1cm4gRFMuQWRhcHRlcgogICovCiAgYWRhcHRlckZvcihtb2RlbE5hbWUpIHsKICAgICh0cnVlICYmICEoRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpICYmIEVtYmVyLmFzc2VydChgWW91IG5lZWQgdG8gcGFzcyBhIG1vZGVsIG5hbWUgdG8gdGhlIHN0b3JlJ3MgYWRhcHRlckZvciBtZXRob2RgLCBFbWJlci5pc1ByZXNlbnQobW9kZWxOYW1lKSkpOwogICAgKHRydWUgJiYgISh0eXBlb2YgbW9kZWxOYW1lID09PSAnc3RyaW5nJykgJiYgRW1iZXIuYXNzZXJ0KGBQYXNzaW5nIGNsYXNzZXMgdG8gc3RvcmUuYWRhcHRlckZvciBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgcGFzcyBhIGRhc2hlcml6ZWQgc3RyaW5nIGluc3RlYWQgb2YgJHttb2RlbE5hbWV9YCwgdHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpKTsKCiAgICB2YXIgbm9ybWFsaXplZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZShtb2RlbE5hbWUpOwoKICAgIHZhciB7IF9hZGFwdGVyQ2FjaGUgfSA9IHRoaXM7CiAgICB2YXIgYWRhcHRlciA9IF9hZGFwdGVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV07CiAgICBpZiAoYWRhcHRlcikgewogICAgICByZXR1cm4gYWRhcHRlcjsKICAgIH0KCiAgICB2YXIgb3duZXIgPSBnZXRPd25lcih0aGlzKTsKCiAgICBhZGFwdGVyID0gb3duZXIubG9va3VwKGBhZGFwdGVyOiR7bm9ybWFsaXplZE1vZGVsTmFtZX1gKTsKICAgIGlmIChhZGFwdGVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgRW1iZXIuc2V0KGFkYXB0ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICBfYWRhcHRlckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gYWRhcHRlcjsKICAgICAgcmV0dXJuIGFkYXB0ZXI7CiAgICB9CgogICAgLy8gbm8gYWRhcHRlciBmb3VuZCBmb3IgdGhlIHNwZWNpZmljIG1vZGVsLCBmYWxsYmFjayBhbmQgY2hlY2sgZm9yIGFwcGxpY2F0aW9uIGFkYXB0ZXIKICAgIGFkYXB0ZXIgPSBfYWRhcHRlckNhY2hlLmFwcGxpY2F0aW9uIHx8IG93bmVyLmxvb2t1cCgnYWRhcHRlcjphcHBsaWNhdGlvbicpOwogICAgaWYgKGFkYXB0ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICBFbWJlci5zZXQoYWRhcHRlciwgJ3N0b3JlJywgdGhpcyk7CiAgICAgIF9hZGFwdGVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBhZGFwdGVyOwogICAgICBfYWRhcHRlckNhY2hlLmFwcGxpY2F0aW9uID0gYWRhcHRlcjsKICAgICAgcmV0dXJuIGFkYXB0ZXI7CiAgICB9CgogICAgLy8gbm8gbW9kZWwgc3BlY2lmaWMgYWRhcHRlciBvciBhcHBsaWNhdGlvbiBhZGFwdGVyLCBjaGVjayBmb3IgYW4gYGFkYXB0ZXJgCiAgICAvLyBwcm9wZXJ0eSBkZWZpbmVkIG9uIHRoZSBzdG9yZQogICAgdmFyIGFkYXB0ZXJOYW1lID0gdGhpcy5nZXQoJ2FkYXB0ZXInKTsKICAgIGFkYXB0ZXIgPSBfYWRhcHRlckNhY2hlW2FkYXB0ZXJOYW1lXSB8fCBvd25lci5sb29rdXAoYGFkYXB0ZXI6JHthZGFwdGVyTmFtZX1gKTsKICAgIGlmIChhZGFwdGVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgRW1iZXIuc2V0KGFkYXB0ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICBfYWRhcHRlckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gYWRhcHRlcjsKICAgICAgX2FkYXB0ZXJDYWNoZVthZGFwdGVyTmFtZV0gPSBhZGFwdGVyOwogICAgICByZXR1cm4gYWRhcHRlcjsKICAgIH0KCiAgICAvLyBmaW5hbCBmYWxsYmFjaywgbm8gbW9kZWwgc3BlY2lmaWMgYWRhcHRlciwgbm8gYXBwbGljYXRpb24gYWRhcHRlciwgbm8KICAgIC8vIGBhZGFwdGVyYCBwcm9wZXJ0eSBvbiBzdG9yZTogdXNlIGpzb24tYXBpIGFkYXB0ZXIKICAgIGFkYXB0ZXIgPSBfYWRhcHRlckNhY2hlWyctanNvbi1hcGknXSB8fCBvd25lci5sb29rdXAoJ2FkYXB0ZXI6LWpzb24tYXBpJyk7CiAgICBFbWJlci5zZXQoYWRhcHRlciwgJ3N0b3JlJywgdGhpcyk7CiAgICBfYWRhcHRlckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gYWRhcHRlcjsKICAgIF9hZGFwdGVyQ2FjaGVbJy1qc29uLWFwaSddID0gYWRhcHRlcjsKICAgIHJldHVybiBhZGFwdGVyOwogIH0sCgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgogIC8vIC4gUkVDT1JEIENIQU5HRSBOT1RJRklDQVRJT04gLgogIC8vIC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLgoKICAvKioKICAgIFJldHVybnMgYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcmlhbGl6ZXIgZm9yIGEgZ2l2ZW4gdHlwZS4gRm9yCiAgICBleGFtcGxlLCBgc2VyaWFsaXplckZvcigncGVyc29uJylgIHdpbGwgcmV0dXJuIGFuIGluc3RhbmNlIG9mCiAgICBgQXBwLlBlcnNvblNlcmlhbGl6ZXJgLgogICAgIElmIG5vIGBBcHAuUGVyc29uU2VyaWFsaXplcmAgaXMgZm91bmQsIHRoaXMgbWV0aG9kIHdpbGwgbG9vawogICAgZm9yIGFuIGBBcHAuQXBwbGljYXRpb25TZXJpYWxpemVyYCAodGhlIGRlZmF1bHQgc2VyaWFsaXplciBmb3IKICAgIHlvdXIgZW50aXJlIGFwcGxpY2F0aW9uKS4KICAgICBpZiBubyBgQXBwLkFwcGxpY2F0aW9uU2VyaWFsaXplcmAgaXMgZm91bmQsIGl0IHdpbGwgYXR0ZW1wdAogICAgdG8gZ2V0IHRoZSBgZGVmYXVsdFNlcmlhbGl6ZXJgIGZyb20gdGhlIGBQZXJzb25BZGFwdGVyYAogICAgKGBhZGFwdGVyRm9yKCdwZXJzb24nKWApLgogICAgIElmIGEgc2VyaWFsaXplciBjYW5ub3QgYmUgZm91bmQgb24gdGhlIGFkYXB0ZXIsIGl0IHdpbGwgZmFsbCBiYWNrCiAgICB0byBhbiBpbnN0YW5jZSBvZiBgRFMuSlNPTlNlcmlhbGl6ZXJgLgogICAgIEBtZXRob2Qgc2VyaWFsaXplckZvcgogICAgQHB1YmxpYwogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZSB0aGUgcmVjb3JkIHRvIHNlcmlhbGl6ZQogICAgQHJldHVybiB7RFMuU2VyaWFsaXplcn0KICAqLwogIHNlcmlhbGl6ZXJGb3IobW9kZWxOYW1lKSB7CiAgICAodHJ1ZSAmJiAhKEVtYmVyLmlzUHJlc2VudChtb2RlbE5hbWUpKSAmJiBFbWJlci5hc3NlcnQoYFlvdSBuZWVkIHRvIHBhc3MgYSBtb2RlbCBuYW1lIHRvIHRoZSBzdG9yZSdzIHNlcmlhbGl6ZXJGb3IgbWV0aG9kYCwgRW1iZXIuaXNQcmVzZW50KG1vZGVsTmFtZSkpKTsKICAgICh0cnVlICYmICEodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ3N0cmluZycpICYmIEVtYmVyLmFzc2VydChgUGFzc2luZyBjbGFzc2VzIHRvIHN0b3JlLnNlcmlhbGl6ZXJGb3IgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHBhc3MgYSBkYXNoZXJpemVkIHN0cmluZyBpbnN0ZWFkIG9mICR7bW9kZWxOYW1lfWAsIHR5cGVvZiBtb2RlbE5hbWUgPT09ICdzdHJpbmcnKSk7CgogICAgdmFyIG5vcm1hbGl6ZWRNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWUobW9kZWxOYW1lKTsKCiAgICB2YXIgeyBfc2VyaWFsaXplckNhY2hlIH0gPSB0aGlzOwogICAgdmFyIHNlcmlhbGl6ZXIgPSBfc2VyaWFsaXplckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdOwogICAgaWYgKHNlcmlhbGl6ZXIpIHsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZXI7CiAgICB9CgogICAgdmFyIG93bmVyID0gZ2V0T3duZXIodGhpcyk7CgogICAgc2VyaWFsaXplciA9IG93bmVyLmxvb2t1cChgc2VyaWFsaXplcjoke25vcm1hbGl6ZWRNb2RlbE5hbWV9YCk7CiAgICBpZiAoc2VyaWFsaXplciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIEVtYmVyLnNldChzZXJpYWxpemVyLCAnc3RvcmUnLCB0aGlzKTsKICAgICAgX3NlcmlhbGl6ZXJDYWNoZVtub3JtYWxpemVkTW9kZWxOYW1lXSA9IHNlcmlhbGl6ZXI7CiAgICAgIHJldHVybiBzZXJpYWxpemVyOwogICAgfQoKICAgIC8vIG5vIHNlcmlhbGl6ZXIgZm91bmQgZm9yIHRoZSBzcGVjaWZpYyBtb2RlbCwgZmFsbGJhY2sgYW5kIGNoZWNrIGZvciBhcHBsaWNhdGlvbiBzZXJpYWxpemVyCiAgICBzZXJpYWxpemVyID0gX3NlcmlhbGl6ZXJDYWNoZS5hcHBsaWNhdGlvbiB8fCBvd25lci5sb29rdXAoJ3NlcmlhbGl6ZXI6YXBwbGljYXRpb24nKTsKICAgIGlmIChzZXJpYWxpemVyICE9PSB1bmRlZmluZWQpIHsKICAgICAgRW1iZXIuc2V0KHNlcmlhbGl6ZXIsICdzdG9yZScsIHRoaXMpOwogICAgICBfc2VyaWFsaXplckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gc2VyaWFsaXplcjsKICAgICAgX3NlcmlhbGl6ZXJDYWNoZS5hcHBsaWNhdGlvbiA9IHNlcmlhbGl6ZXI7CiAgICAgIHJldHVybiBzZXJpYWxpemVyOwogICAgfQoKICAgIC8vIG5vIG1vZGVsIHNwZWNpZmljIHNlcmlhbGl6ZXIgb3IgYXBwbGljYXRpb24gc2VyaWFsaXplciwgY2hlY2sgZm9yIHRoZSBgZGVmYXVsdFNlcmlhbGl6ZXJgCiAgICAvLyBwcm9wZXJ0eSBkZWZpbmVkIG9uIHRoZSBhZGFwdGVyCiAgICB2YXIgYWRhcHRlciA9IHRoaXMuYWRhcHRlckZvcihtb2RlbE5hbWUpOwogICAgdmFyIHNlcmlhbGl6ZXJOYW1lID0gRW1iZXIuZ2V0KGFkYXB0ZXIsICdkZWZhdWx0U2VyaWFsaXplcicpOwogICAgc2VyaWFsaXplciA9IF9zZXJpYWxpemVyQ2FjaGVbc2VyaWFsaXplck5hbWVdIHx8IG93bmVyLmxvb2t1cChgc2VyaWFsaXplcjoke3NlcmlhbGl6ZXJOYW1lfWApOwogICAgaWYgKHNlcmlhbGl6ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICBFbWJlci5zZXQoc2VyaWFsaXplciwgJ3N0b3JlJywgdGhpcyk7CiAgICAgIF9zZXJpYWxpemVyQ2FjaGVbbm9ybWFsaXplZE1vZGVsTmFtZV0gPSBzZXJpYWxpemVyOwogICAgICBfc2VyaWFsaXplckNhY2hlW3NlcmlhbGl6ZXJOYW1lXSA9IHNlcmlhbGl6ZXI7CiAgICAgIHJldHVybiBzZXJpYWxpemVyOwogICAgfQoKICAgIC8vIGZpbmFsIGZhbGxiYWNrLCBubyBtb2RlbCBzcGVjaWZpYyBzZXJpYWxpemVyLCBubyBhcHBsaWNhdGlvbiBzZXJpYWxpemVyLCBubwogICAgLy8gYHNlcmlhbGl6ZXJgIHByb3BlcnR5IG9uIHN0b3JlOiB1c2UganNvbi1hcGkgc2VyaWFsaXplcgogICAgc2VyaWFsaXplciA9IF9zZXJpYWxpemVyQ2FjaGVbJy1kZWZhdWx0J10gfHwgb3duZXIubG9va3VwKCdzZXJpYWxpemVyOi1kZWZhdWx0Jyk7CiAgICBFbWJlci5zZXQoc2VyaWFsaXplciwgJ3N0b3JlJywgdGhpcyk7CiAgICBfc2VyaWFsaXplckNhY2hlW25vcm1hbGl6ZWRNb2RlbE5hbWVdID0gc2VyaWFsaXplcjsKICAgIF9zZXJpYWxpemVyQ2FjaGVbJy1kZWZhdWx0J10gPSBzZXJpYWxpemVyOwoKICAgIHJldHVybiBzZXJpYWxpemVyOwogIH0sCgogIGxvb2t1cEFkYXB0ZXIobmFtZSkgewogICAgKHRydWUgJiYgIShmYWxzZSkgJiYgRW1iZXIuZGVwcmVjYXRlKGBVc2Ugb2YgbG9va3VwQWRhcHRlciBpcyBkZXByZWNhdGVkLCB1c2UgYWRhcHRlckZvciBpbnN0ZWFkLmAsIGZhbHNlLCB7CiAgICAgIGlkOiAnZHMuc3RvcmUubG9va3VwQWRhcHRlcicsCiAgICAgIHVudGlsOiAnMy4wJwogICAgfSkpOwoKICAgIHJldHVybiB0aGlzLmFkYXB0ZXJGb3IobmFtZSk7CiAgfSwKCiAgbG9va3VwU2VyaWFsaXplcihuYW1lKSB7CiAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5kZXByZWNhdGUoYFVzZSBvZiBsb29rdXBTZXJpYWxpemVyIGlzIGRlcHJlY2F0ZWQsIHVzZSBzZXJpYWxpemVyRm9yIGluc3RlYWQuYCwgZmFsc2UsIHsKICAgICAgaWQ6ICdkcy5zdG9yZS5sb29rdXBTZXJpYWxpemVyJywKICAgICAgdW50aWw6ICczLjAnCiAgICB9KSk7CgogICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplckZvcihuYW1lKTsKICB9LAoKICB3aWxsRGVzdHJveSgpIHsKICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICB0aGlzLl9wdXNoZWRJbnRlcm5hbE1vZGVscyA9IG51bGw7CiAgICB0aGlzLnJlY29yZEFycmF5TWFuYWdlci5kZXN0cm95KCk7CgogICAgdGhpcy5fcmVsYXRpb25zaGlwc1BheWxvYWRzID0gbnVsbDsKICAgIHRoaXMuX2FkYXB0ZXJDYWNoZSA9IG51bGw7CiAgICB0aGlzLl9zZXJpYWxpemVyQ2FjaGUgPSBudWxsOwoKICAgIHRoaXMudW5sb2FkQWxsKCk7CiAgfSwKCiAgX3VwZGF0ZVJlbGF0aW9uc2hpcFN0YXRlKHJlbGF0aW9uc2hpcCkgewogICAgaWYgKHRoaXMuX3VwZGF0ZWRSZWxhdGlvbnNoaXBzLnB1c2gocmVsYXRpb25zaGlwKSAhPT0gMSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5fYmFja2J1cm5lci5qb2luKCgpID0+IHsKICAgICAgdGhpcy5fYmFja2J1cm5lci5zY2hlZHVsZSgnc3luY1JlbGF0aW9uc2hpcHMnLCB0aGlzLCB0aGlzLl9mbHVzaFVwZGF0ZWRSZWxhdGlvbnNoaXBzKTsKICAgIH0pOwogIH0sCgogIF9mbHVzaFVwZGF0ZWRSZWxhdGlvbnNoaXBzKCkgewogICAgdmFyIHVwZGF0ZWQgPSB0aGlzLl91cGRhdGVkUmVsYXRpb25zaGlwczsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHVwZGF0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHVwZGF0ZWRbaV0uZmx1c2hDYW5vbmljYWwoKTsKICAgIH0KCiAgICB1cGRhdGVkLmxlbmd0aCA9IDA7CiAgfSwKCiAgX3VwZGF0ZUludGVybmFsTW9kZWwoaW50ZXJuYWxNb2RlbCkgewogICAgaWYgKHRoaXMuX3VwZGF0ZWRJbnRlcm5hbE1vZGVscy5wdXNoKGludGVybmFsTW9kZWwpICE9PSAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBlbWJlclJ1bi5zY2hlZHVsZSgnYWN0aW9ucycsIHRoaXMsIHRoaXMuX2ZsdXNoVXBkYXRlZEludGVybmFsTW9kZWxzKTsKICB9LAoKICBfZmx1c2hVcGRhdGVkSW50ZXJuYWxNb2RlbHMoKSB7CiAgICB2YXIgdXBkYXRlZCA9IHRoaXMuX3VwZGF0ZWRJbnRlcm5hbE1vZGVsczsKCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHVwZGF0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHVwZGF0ZWRbaV0uX3RyaWdnZXJEZWZlcnJlZFRyaWdnZXJzKCk7CiAgICB9CgogICAgdXBkYXRlZC5sZW5ndGggPSAwOwogIH0sCgogIF9wdXNoUmVzb3VyY2VJZGVudGlmaWVyKHJlbGF0aW9uc2hpcCwgcmVzb3VyY2VJZGVudGlmaWVyKSB7CiAgICBpZiAoRW1iZXIuaXNOb25lKHJlc291cmNlSWRlbnRpZmllcikpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgICh0cnVlICYmICEoIUFycmF5LmlzQXJyYXkocmVzb3VyY2VJZGVudGlmaWVyKSkgJiYgRW1iZXIuYXNzZXJ0KGBBICR7cmVsYXRpb25zaGlwLmludGVybmFsTW9kZWwubW9kZWxOYW1lfSByZWNvcmQgd2FzIHB1c2hlZCBpbnRvIHRoZSBzdG9yZSB3aXRoIHRoZSB2YWx1ZSBvZiAke3JlbGF0aW9uc2hpcC5rZXl9IGJlaW5nICR7RW1iZXIuaW5zcGVjdChyZXNvdXJjZUlkZW50aWZpZXIpfSwgYnV0ICR7cmVsYXRpb25zaGlwLmtleX0gaXMgYSBiZWxvbmdzVG8gcmVsYXRpb25zaGlwIHNvIHRoZSB2YWx1ZSBtdXN0IG5vdCBiZSBhbiBhcnJheS4gWW91IHNob3VsZCBwcm9iYWJseSBjaGVjayB5b3VyIGRhdGEgcGF5bG9hZCBvciBzZXJpYWxpemVyLmAsICFBcnJheS5pc0FycmF5KHJlc291cmNlSWRlbnRpZmllcikpKTsKCiAgICAvL1RPRE86QmV0dGVyIGFzc2VydHMKCiAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbEZvcklkKHJlc291cmNlSWRlbnRpZmllci50eXBlLCByZXNvdXJjZUlkZW50aWZpZXIuaWQpOwogIH0sCgogIF9wdXNoUmVzb3VyY2VJZGVudGlmaWVycyhyZWxhdGlvbnNoaXAsIHJlc291cmNlSWRlbnRpZmllcnMpIHsKICAgIGlmIChFbWJlci5pc05vbmUocmVzb3VyY2VJZGVudGlmaWVycykpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgICh0cnVlICYmICEoQXJyYXkuaXNBcnJheShyZXNvdXJjZUlkZW50aWZpZXJzKSkgJiYgRW1iZXIuYXNzZXJ0KGBBICR7cmVsYXRpb25zaGlwLmludGVybmFsTW9kZWwubW9kZWxOYW1lfSByZWNvcmQgd2FzIHB1c2hlZCBpbnRvIHRoZSBzdG9yZSB3aXRoIHRoZSB2YWx1ZSBvZiAke3JlbGF0aW9uc2hpcC5rZXl9IGJlaW5nICcke0VtYmVyLmluc3BlY3QocmVzb3VyY2VJZGVudGlmaWVycyl9JywgYnV0ICR7cmVsYXRpb25zaGlwLmtleX0gaXMgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCBzbyB0aGUgdmFsdWUgbXVzdCBiZSBhbiBhcnJheS4gWW91IHNob3VsZCBwcm9iYWJseSBjaGVjayB5b3VyIGRhdGEgcGF5bG9hZCBvciBzZXJpYWxpemVyLmAsIEFycmF5LmlzQXJyYXkocmVzb3VyY2VJZGVudGlmaWVycykpKTsKCgogICAgdmFyIF9pbnRlcm5hbE1vZGVscyA9IG5ldyBBcnJheShyZXNvdXJjZUlkZW50aWZpZXJzLmxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc291cmNlSWRlbnRpZmllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgX2ludGVybmFsTW9kZWxzW2ldID0gdGhpcy5fcHVzaFJlc291cmNlSWRlbnRpZmllcihyZWxhdGlvbnNoaXAsIHJlc291cmNlSWRlbnRpZmllcnNbaV0pOwogICAgfQogICAgcmV0dXJuIF9pbnRlcm5hbE1vZGVsczsKICB9Cn0pOwoKLy8gRGVsZWdhdGlvbiB0byB0aGUgYWRhcHRlciBhbmQgcHJvbWlzZSBtYW5hZ2VtZW50CgoKZnVuY3Rpb24gZGVmYXVsdFNlcmlhbGl6ZXIoc3RvcmUpIHsKICByZXR1cm4gc3RvcmUuc2VyaWFsaXplckZvcignYXBwbGljYXRpb24nKTsKfQoKZnVuY3Rpb24gX2NvbW1pdChhZGFwdGVyLCBzdG9yZSwgb3BlcmF0aW9uLCBzbmFwc2hvdCkgewogIHZhciBpbnRlcm5hbE1vZGVsID0gc25hcHNob3QuX2ludGVybmFsTW9kZWw7CiAgdmFyIG1vZGVsTmFtZSA9IHNuYXBzaG90Lm1vZGVsTmFtZTsKICB2YXIgbW9kZWxDbGFzcyA9IHN0b3JlLl9tb2RlbEZvcihtb2RlbE5hbWUpOwogICh0cnVlICYmICEoYWRhcHRlcikgJiYgRW1iZXIuYXNzZXJ0KGBZb3UgdHJpZWQgdG8gdXBkYXRlIGEgcmVjb3JkIGJ1dCB5b3UgaGF2ZSBubyBhZGFwdGVyIChmb3IgJHttb2RlbE5hbWV9KWAsIGFkYXB0ZXIpKTsKICAodHJ1ZSAmJiAhKHR5cGVvZiBhZGFwdGVyW29wZXJhdGlvbl0gPT09ICdmdW5jdGlvbicpICYmIEVtYmVyLmFzc2VydChgWW91IHRyaWVkIHRvIHVwZGF0ZSBhIHJlY29yZCBidXQgeW91ciBhZGFwdGVyIChmb3IgJHttb2RlbE5hbWV9KSBkb2VzIG5vdCBpbXBsZW1lbnQgJyR7b3BlcmF0aW9ufSdgLCB0eXBlb2YgYWRhcHRlcltvcGVyYXRpb25dID09PSAnZnVuY3Rpb24nKSk7CgoKICB7CiAgICBpbmNyZW1lbnRSZXF1ZXN0Q291bnQoKTsKICB9CgogIHZhciBwcm9taXNlID0gRW1iZXIuUlNWUC5Qcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGFkYXB0ZXJbb3BlcmF0aW9uXShzdG9yZSwgbW9kZWxDbGFzcywgc25hcHNob3QpKTsKICB2YXIgc2VyaWFsaXplciA9IHNlcmlhbGl6ZXJGb3JBZGFwdGVyKHN0b3JlLCBhZGFwdGVyLCBtb2RlbE5hbWUpOwogIHZhciBsYWJlbCA9IGBEUzogRXh0cmFjdCBhbmQgbm90aWZ5IGFib3V0ICR7b3BlcmF0aW9ufSBjb21wbGV0aW9uIG9mICR7aW50ZXJuYWxNb2RlbH1gOwoKICAodHJ1ZSAmJiAhKHByb21pc2UgIT09IHVuZGVmaW5lZCkgJiYgRW1iZXIuYXNzZXJ0KGBZb3VyIGFkYXB0ZXIncyAnJHtvcGVyYXRpb259JyBtZXRob2QgbXVzdCByZXR1cm4gYSB2YWx1ZSwgYnV0IGl0IHJldHVybmVkICd1bmRlZmluZWQnYCwgcHJvbWlzZSAhPT0gdW5kZWZpbmVkKSk7CgoKICBwcm9taXNlID0gZ3VhcmREZXN0cm95ZWRTdG9yZShwcm9taXNlLCBzdG9yZSwgbGFiZWwpOwogIHByb21pc2UgPSBfZ3VhcmQocHJvbWlzZSwgX2JpbmQoX29iamVjdElzQWxpdmUsIGludGVybmFsTW9kZWwpKTsKCiAgcmV0dXJuIHByb21pc2UudGhlbihhZGFwdGVyUGF5bG9hZCA9PiB7CiAgICAvKgogICAgICBOb3RlIHRvIGZ1dHVyZSBzcGVsdW5rZXJzIGhvcGluZyB0byBvcHRpbWl6ZS4KICAgICAgV2UgcmVseSBvbiB0aGlzIGBydW5gIHRvIGNyZWF0ZSBhIHJ1biBsb29wIGlmIG5lZWRlZAogICAgICB0aGF0IGBzdG9yZS5fcHVzaGAgYW5kIGBzdG9yZS5kaWRTYXZlUmVjb3JkYCB3aWxsIGJvdGggc2hhcmUuCiAgICAgICBXZSB1c2UgYGpvaW5gIGJlY2F1c2UgaXQgaXMgb2Z0ZW4gdGhlIGNhc2UgdGhhdCB3ZQogICAgICBoYXZlIGFuIG91dGVyIHJ1biBsb29wIGF2YWlsYWJsZSBzdGlsbCBmcm9tIHRoZSBmaXJzdAogICAgICBjYWxsIHRvIGBzdG9yZS5fcHVzaGA7CiAgICAgKi8KICAgIHN0b3JlLl9iYWNrYnVybmVyLmpvaW4oKCkgPT4gewogICAgICB2YXIgcGF5bG9hZCA9IHZvaWQgMCwKICAgICAgICAgIGRhdGEgPSB2b2lkIDA7CiAgICAgIGlmIChhZGFwdGVyUGF5bG9hZCkgewogICAgICAgIHBheWxvYWQgPSBub3JtYWxpemVSZXNwb25zZUhlbHBlcihzZXJpYWxpemVyLCBzdG9yZSwgbW9kZWxDbGFzcywgYWRhcHRlclBheWxvYWQsIHNuYXBzaG90LmlkLCBvcGVyYXRpb24pOwogICAgICAgIGlmIChwYXlsb2FkLmluY2x1ZGVkKSB7CiAgICAgICAgICBzdG9yZS5fcHVzaCh7IGRhdGE6IG51bGwsIGluY2x1ZGVkOiBwYXlsb2FkLmluY2x1ZGVkIH0pOwogICAgICAgIH0KICAgICAgICBkYXRhID0gcGF5bG9hZC5kYXRhOwogICAgICB9CiAgICAgIHN0b3JlLmRpZFNhdmVSZWNvcmQoaW50ZXJuYWxNb2RlbCwgeyBkYXRhIH0pOwogICAgfSk7CgogICAgcmV0dXJuIGludGVybmFsTW9kZWw7CiAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJbnZhbGlkRXJyb3IpIHsKICAgICAgdmFyIGVycm9ycyA9IHNlcmlhbGl6ZXIuZXh0cmFjdEVycm9ycyhzdG9yZSwgbW9kZWxDbGFzcywgZXJyb3IsIHNuYXBzaG90LmlkKTsKCiAgICAgIHN0b3JlLnJlY29yZFdhc0ludmFsaWQoaW50ZXJuYWxNb2RlbCwgZXJyb3JzKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0b3JlLnJlY29yZFdhc0Vycm9yKGludGVybmFsTW9kZWwsIGVycm9yKTsKICAgIH0KCiAgICB0aHJvdyBlcnJvcjsKICB9LCBsYWJlbCk7Cn0KCmZ1bmN0aW9uIGlzSW52ZXJzZVJlbGF0aW9uc2hpcEluaXRpYWxpemVkKHN0b3JlLCBpbnRlcm5hbE1vZGVsLCBkYXRhLCBrZXksIG1vZGVsTmFtZVRvSW52ZXJzZU1hcCkgewogIHZhciByZWxhdGlvbnNoaXBEYXRhID0gZGF0YS5yZWxhdGlvbnNoaXBzW2tleV0uZGF0YTsKCiAgaWYgKCFyZWxhdGlvbnNoaXBEYXRhKSB7CiAgICAvLyBjYW4ndCBjaGVjayBpbnZlcnNlIGZvciBlZyB7IGNvbW1lbnRzOiB7IGxpbmtzOiB7IHJlbGF0ZWQ6IFVSTCB9fX0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBpbnZlcnNlTWFwID0gbW9kZWxOYW1lVG9JbnZlcnNlTWFwW2ludGVybmFsTW9kZWwubW9kZWxOYW1lXTsKICBpZiAoIWludmVyc2VNYXApIHsKICAgIGludmVyc2VNYXAgPSBtb2RlbE5hbWVUb0ludmVyc2VNYXBbaW50ZXJuYWxNb2RlbC5tb2RlbE5hbWVdID0gRW1iZXIuZ2V0KGludGVybmFsTW9kZWwudHlwZSwgJ2ludmVyc2VNYXAnKTsKICB9CiAgdmFyIGludmVyc2VSZWxhdGlvbnNoaXBNZXRhZGF0YSA9IGludmVyc2VNYXBba2V5XTsKICBpZiAoaW52ZXJzZVJlbGF0aW9uc2hpcE1ldGFkYXRhID09PSB1bmRlZmluZWQpIHsKICAgIGludmVyc2VSZWxhdGlvbnNoaXBNZXRhZGF0YSA9IGludGVybmFsTW9kZWwudHlwZS5pbnZlcnNlRm9yKGtleSwgc3RvcmUpOwogIH0KCiAgaWYgKCFpbnZlcnNlUmVsYXRpb25zaGlwTWV0YWRhdGEpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciB7IG5hbWU6IGludmVyc2VSZWxhdGlvbnNoaXBOYW1lIH0gPSBpbnZlcnNlUmVsYXRpb25zaGlwTWV0YWRhdGE7CgogIGlmIChBcnJheS5pc0FycmF5KHJlbGF0aW9uc2hpcERhdGEpKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbGF0aW9uc2hpcERhdGEubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGludmVyc2VJbnRlcm5hbE1vZGVsID0gc3RvcmUuX2ludGVybmFsTW9kZWxzRm9yKHJlbGF0aW9uc2hpcERhdGFbaV0udHlwZSkuZ2V0KHJlbGF0aW9uc2hpcERhdGFbaV0uaWQpOwogICAgICBpZiAoaW52ZXJzZUludGVybmFsTW9kZWwgJiYgaW52ZXJzZUludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuaGFzKGludmVyc2VSZWxhdGlvbnNoaXBOYW1lKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0gZWxzZSB7CiAgICB2YXIgX2ludmVyc2VJbnRlcm5hbE1vZGVsID0gc3RvcmUuX2ludGVybmFsTW9kZWxzRm9yKHJlbGF0aW9uc2hpcERhdGEudHlwZSkuZ2V0KHJlbGF0aW9uc2hpcERhdGEuaWQpOwogICAgcmV0dXJuIF9pbnZlcnNlSW50ZXJuYWxNb2RlbCAmJiBfaW52ZXJzZUludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuaGFzKGludmVyc2VSZWxhdGlvbnNoaXBOYW1lKTsKICB9Cn0KCmZ1bmN0aW9uIHNldHVwUmVsYXRpb25zaGlwcyhzdG9yZSwgaW50ZXJuYWxNb2RlbCwgZGF0YSwgbW9kZWxOYW1lVG9JbnZlcnNlTWFwKSB7CiAgT2JqZWN0LmtleXMoZGF0YS5yZWxhdGlvbnNoaXBzKS5mb3JFYWNoKHJlbGF0aW9uc2hpcE5hbWUgPT4gewogICAgdmFyIHJlbGF0aW9uc2hpcHMgPSBpbnRlcm5hbE1vZGVsLl9yZWxhdGlvbnNoaXBzOwogICAgdmFyIHJlbGF0aW9uc2hpcFJlcXVpcmVzTm90aWZpY2F0aW9uID0gcmVsYXRpb25zaGlwcy5oYXMocmVsYXRpb25zaGlwTmFtZSkgfHwgaXNJbnZlcnNlUmVsYXRpb25zaGlwSW5pdGlhbGl6ZWQoc3RvcmUsIGludGVybmFsTW9kZWwsIGRhdGEsIHJlbGF0aW9uc2hpcE5hbWUsIG1vZGVsTmFtZVRvSW52ZXJzZU1hcCk7CgogICAgaWYgKHJlbGF0aW9uc2hpcFJlcXVpcmVzTm90aWZpY2F0aW9uKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBEYXRhID0gZGF0YS5yZWxhdGlvbnNoaXBzW3JlbGF0aW9uc2hpcE5hbWVdOwogICAgICByZWxhdGlvbnNoaXBzLmdldChyZWxhdGlvbnNoaXBOYW1lKS5wdXNoKHJlbGF0aW9uc2hpcERhdGEsIGZhbHNlKTsKICAgIH0KCiAgICAvLyBpbiBkZWJ1ZywgYXNzZXJ0IHBheWxvYWQgdmFsaWRpdHkgZWFnZXJseQogICAgewogICAgICB2YXIgcmVsYXRpb25zaGlwTWV0YSA9IEVtYmVyLmdldChpbnRlcm5hbE1vZGVsLnR5cGUsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuZ2V0KHJlbGF0aW9uc2hpcE5hbWUpOwogICAgICB2YXIgX3JlbGF0aW9uc2hpcERhdGEgPSBkYXRhLnJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwTmFtZV07CiAgICAgIGlmICghX3JlbGF0aW9uc2hpcERhdGEgfHwgIXJlbGF0aW9uc2hpcE1ldGEpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChfcmVsYXRpb25zaGlwRGF0YS5saW5rcykgewogICAgICAgIHZhciBpc0FzeW5jID0gcmVsYXRpb25zaGlwTWV0YS5vcHRpb25zICYmIHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5hc3luYyAhPT0gZmFsc2U7CiAgICAgICAgKHRydWUgJiYgRW1iZXIud2FybihgWW91IHB1c2hlZCBhIHJlY29yZCBvZiB0eXBlICcke2ludGVybmFsTW9kZWwubW9kZWxOYW1lfScgd2l0aCBhIHJlbGF0aW9uc2hpcCAnJHtyZWxhdGlvbnNoaXBOYW1lfScgY29uZmlndXJlZCBhcyAnYXN5bmM6IGZhbHNlJy4gWW91J3ZlIGluY2x1ZGVkIGEgbGluayBidXQgbm8gcHJpbWFyeSBkYXRhLCB0aGlzIG1heSBiZSBhbiBlcnJvciBpbiB5b3VyIHBheWxvYWQuIEVtYmVyRGF0YSB3aWxsIHRyZWF0IHRoaXMgcmVsYXRpb25zaGlwIGFzIGtub3duLXRvLWJlLWVtcHR5LmAsIGlzQXN5bmMgfHwgX3JlbGF0aW9uc2hpcERhdGEuZGF0YSwgewogICAgICAgICAgaWQ6ICdkcy5zdG9yZS5wdXNoLWxpbmstZm9yLXN5bmMtcmVsYXRpb25zaGlwJwogICAgICAgIH0pKTsKICAgICAgfSBlbHNlIGlmIChfcmVsYXRpb25zaGlwRGF0YS5kYXRhKSB7CiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICAgICh0cnVlICYmICEoIUFycmF5LmlzQXJyYXkoX3JlbGF0aW9uc2hpcERhdGEuZGF0YSkpICYmIEVtYmVyLmFzc2VydChgQSAke2ludGVybmFsTW9kZWwudHlwZS5tb2RlbE5hbWV9IHJlY29yZCB3YXMgcHVzaGVkIGludG8gdGhlIHN0b3JlIHdpdGggdGhlIHZhbHVlIG9mICR7cmVsYXRpb25zaGlwTmFtZX0gYmVpbmcgJHtFbWJlci5pbnNwZWN0KF9yZWxhdGlvbnNoaXBEYXRhLmRhdGEpfSwgYnV0ICR7cmVsYXRpb25zaGlwTmFtZX0gaXMgYSBiZWxvbmdzVG8gcmVsYXRpb25zaGlwIHNvIHRoZSB2YWx1ZSBtdXN0IG5vdCBiZSBhbiBhcnJheS4gWW91IHNob3VsZCBwcm9iYWJseSBjaGVjayB5b3VyIGRhdGEgcGF5bG9hZCBvciBzZXJpYWxpemVyLmAsICFBcnJheS5pc0FycmF5KF9yZWxhdGlvbnNoaXBEYXRhLmRhdGEpKSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWxhdGlvbnNoaXBNZXRhLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgICAgKHRydWUgJiYgIShBcnJheS5pc0FycmF5KF9yZWxhdGlvbnNoaXBEYXRhLmRhdGEpKSAmJiBFbWJlci5hc3NlcnQoYEEgJHtpbnRlcm5hbE1vZGVsLnR5cGUubW9kZWxOYW1lfSByZWNvcmQgd2FzIHB1c2hlZCBpbnRvIHRoZSBzdG9yZSB3aXRoIHRoZSB2YWx1ZSBvZiAke3JlbGF0aW9uc2hpcE5hbWV9IGJlaW5nICcke0VtYmVyLmluc3BlY3QoX3JlbGF0aW9uc2hpcERhdGEuZGF0YSl9JywgYnV0ICR7cmVsYXRpb25zaGlwTmFtZX0gaXMgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCBzbyB0aGUgdmFsdWUgbXVzdCBiZSBhbiBhcnJheS4gWW91IHNob3VsZCBwcm9iYWJseSBjaGVjayB5b3VyIGRhdGEgcGF5bG9hZCBvciBzZXJpYWxpemVyLmAsIEFycmF5LmlzQXJyYXkoX3JlbGF0aW9uc2hpcERhdGEuZGF0YSkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKfQoKdmFyIFN0b3JlJDEgPSBTdG9yZTsKCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwoKLyoqCiAgQWxsIEVtYmVyIERhdGEgY2xhc3NlcywgbWV0aG9kcyBhbmQgZnVuY3Rpb25zIGFyZSBkZWZpbmVkIGluc2lkZSBvZiB0aGlzIG5hbWVzcGFjZS4KCiAgQGNsYXNzIERTCiAgQHN0YXRpYwoqLwoKLyoqCiAgQHByb3BlcnR5IFZFUlNJT04KICBAdHlwZSBTdHJpbmcKICBAc3RhdGljCiovCnZhciBEUyA9IEVtYmVyLk5hbWVzcGFjZS5jcmVhdGUoewogIFZFUlNJT046IFZFUlNJT04sCiAgbmFtZTogIkRTIgp9KTsKCmlmIChFbWJlci5saWJyYXJpZXMpIHsKICBFbWJlci5saWJyYXJpZXMucmVnaXN0ZXJDb3JlTGlicmFyeSgnRW1iZXIgRGF0YScsIERTLlZFUlNJT04pOwp9CgovKioKICBgRFMuYmVsb25nc1RvYCBpcyB1c2VkIHRvIGRlZmluZSBPbmUtVG8tT25lIGFuZCBPbmUtVG8tTWFueQogIHJlbGF0aW9uc2hpcHMgb24gYSBbRFMuTW9kZWxdKC9hcGkvZGF0YS9jbGFzc2VzL0RTLk1vZGVsLmh0bWwpLgoKCiAgYERTLmJlbG9uZ3NUb2AgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsIGN1cnJlbnRseQogIHN1cHBvcnRlZCBvcHRpb25zIGFyZToKCiAgLSBgYXN5bmNgOiBBIGJvb2xlYW4gdmFsdWUgdXNlZCB0byBleHBsaWNpdGx5IGRlY2xhcmUgdGhpcyB0byBiZSBhbiBhc3luYyByZWxhdGlvbnNoaXAuCiAgLSBgaW52ZXJzZWA6IEEgc3RyaW5nIHVzZWQgdG8gaWRlbnRpZnkgdGhlIGludmVyc2UgcHJvcGVydHkgb24gYQogICAgcmVsYXRlZCBtb2RlbCBpbiBhIE9uZS1Uby1NYW55IHJlbGF0aW9uc2hpcC4gU2VlIFtFeHBsaWNpdCBJbnZlcnNlc10oI3RvY19leHBsaWNpdC1pbnZlcnNlcykKCiAgIyMjIyBPbmUtVG8tT25lCiAgVG8gZGVjbGFyZSBhIG9uZS10by1vbmUgcmVsYXRpb25zaGlwIGJldHdlZW4gdHdvIG1vZGVscywgdXNlCiAgYERTLmJlbG9uZ3NUb2A6CgogIGBgYGFwcC9tb2RlbHMvdXNlci5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHByb2ZpbGU6IERTLmJlbG9uZ3NUbygncHJvZmlsZScpCiAgfSk7CiAgYGBgCgogIGBgYGFwcC9tb2RlbHMvcHJvZmlsZS5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIHVzZXI6IERTLmJlbG9uZ3NUbygndXNlcicpCiAgfSk7CiAgYGBgCgogICMjIyMgT25lLVRvLU1hbnkKICBUbyBkZWNsYXJlIGEgb25lLXRvLW1hbnkgcmVsYXRpb25zaGlwIGJldHdlZW4gdHdvIG1vZGVscywgdXNlCiAgYERTLmJlbG9uZ3NUb2AgaW4gY29tYmluYXRpb24gd2l0aCBgRFMuaGFzTWFueWAsIGxpa2UgdGhpczoKCiAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgY29tbWVudHM6IERTLmhhc01hbnkoJ2NvbW1lbnQnKQogIH0pOwogIGBgYAoKICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICBwb3N0OiBEUy5iZWxvbmdzVG8oJ3Bvc3QnKQogIH0pOwogIGBgYAoKICBZb3UgY2FuIGF2b2lkIHBhc3NpbmcgYSBzdHJpbmcgYXMgdGhlIGZpcnN0IHBhcmFtZXRlci4gSW4gdGhhdCBjYXNlIEVtYmVyIERhdGEKICB3aWxsIGluZmVyIHRoZSB0eXBlIGZyb20gdGhlIGtleSBuYW1lLgoKICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICBwb3N0OiBEUy5iZWxvbmdzVG8oKQogIH0pOwogIGBgYAoKICB3aWxsIGxvb2t1cCBmb3IgYSBQb3N0IHR5cGUuCgogIEBuYW1lc3BhY2UKICBAbWV0aG9kIGJlbG9uZ3NUbwogIEBmb3IgRFMKICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lIChvcHRpb25hbCkgdHlwZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgKG9wdGlvbmFsKSBhIGhhc2ggb2Ygb3B0aW9ucwogIEByZXR1cm4ge0VtYmVyLmNvbXB1dGVkfSByZWxhdGlvbnNoaXAKKi8KZnVuY3Rpb24gYmVsb25nc1RvKG1vZGVsTmFtZSwgb3B0aW9ucykgewogIHZhciBvcHRzID0gdm9pZCAwLAogICAgICB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9IHZvaWQgMDsKICBpZiAodHlwZW9mIG1vZGVsTmFtZSA9PT0gJ29iamVjdCcpIHsKICAgIG9wdHMgPSBtb2RlbE5hbWU7CiAgICB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9IHVuZGVmaW5lZDsKICB9IGVsc2UgewogICAgb3B0cyA9IG9wdGlvbnM7CiAgICB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9IG1vZGVsTmFtZTsKICB9CgogIGlmICh0eXBlb2YgdXNlckVudGVyZWRNb2RlbE5hbWUgPT09ICdzdHJpbmcnKSB7CiAgICB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9IG5vcm1hbGl6ZU1vZGVsTmFtZSh1c2VyRW50ZXJlZE1vZGVsTmFtZSk7CiAgfQoKICAodHJ1ZSAmJiAhKHR5cGVvZiB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHVzZXJFbnRlcmVkTW9kZWxOYW1lID09PSAndW5kZWZpbmVkJykgJiYgRW1iZXIuYXNzZXJ0KCJUaGUgZmlyc3QgYXJndW1lbnQgdG8gRFMuYmVsb25nc1RvIG11c3QgYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgbW9kZWwgdHlwZSBrZXksIG5vdCBhbiBpbnN0YW5jZSBvZiAiICsgRW1iZXIuaW5zcGVjdCh1c2VyRW50ZXJlZE1vZGVsTmFtZSkgKyAiLiBFLmcuLCB0byBkZWZpbmUgYSByZWxhdGlvbiB0byB0aGUgUGVyc29uIG1vZGVsLCB1c2UgRFMuYmVsb25nc1RvKCdwZXJzb24nKSIsIHR5cGVvZiB1c2VyRW50ZXJlZE1vZGVsTmFtZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHVzZXJFbnRlcmVkTW9kZWxOYW1lID09PSAndW5kZWZpbmVkJykpOwoKCiAgb3B0cyA9IG9wdHMgfHwge307CgogIHZhciBtZXRhID0gewogICAgdHlwZTogdXNlckVudGVyZWRNb2RlbE5hbWUsCiAgICBpc1JlbGF0aW9uc2hpcDogdHJ1ZSwKICAgIG9wdGlvbnM6IG9wdHMsCiAgICBraW5kOiAnYmVsb25nc1RvJywKICAgIG5hbWU6ICdCZWxvbmdzIFRvJywKICAgIGtleTogbnVsbAogIH07CgogIHJldHVybiBFbWJlci5jb21wdXRlZCh7CiAgICBnZXQoa2V5KSB7CiAgICAgIGlmIChvcHRzLmhhc093blByb3BlcnR5KCdzZXJpYWxpemUnKSkgewogICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4oYFlvdSBwcm92aWRlZCBhIHNlcmlhbGl6ZSBvcHRpb24gb24gdGhlICIke2tleX0iIHByb3BlcnR5IGluIHRoZSAiJHt0aGlzLl9pbnRlcm5hbE1vZGVsLm1vZGVsTmFtZX0iIGNsYXNzLCB0aGlzIGJlbG9uZ3MgaW4gdGhlIHNlcmlhbGl6ZXIuIFNlZSBEUy5TZXJpYWxpemVyIGFuZCBpdCdzIGltcGxlbWVudGF0aW9ucyBodHRwczovL2VtYmVyanMuY29tL2FwaS9kYXRhL2NsYXNzZXMvRFMuU2VyaWFsaXplci5odG1sYCwgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZHMubW9kZWwuc2VyaWFsaXplLW9wdGlvbi1pbi1iZWxvbmdzLXRvJwogICAgICAgIH0pKTsKICAgICAgfQoKICAgICAgaWYgKG9wdHMuaGFzT3duUHJvcGVydHkoJ2VtYmVkZGVkJykpIHsKICAgICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKGBZb3UgcHJvdmlkZWQgYW4gZW1iZWRkZWQgb3B0aW9uIG9uIHRoZSAiJHtrZXl9IiBwcm9wZXJ0eSBpbiB0aGUgIiR7dGhpcy5faW50ZXJuYWxNb2RlbC5tb2RlbE5hbWV9IiBjbGFzcywgdGhpcyBiZWxvbmdzIGluIHRoZSBzZXJpYWxpemVyLiBTZWUgRFMuRW1iZWRkZWRSZWNvcmRzTWl4aW4gaHR0cHM6Ly9lbWJlcmpzLmNvbS9hcGkvZGF0YS9jbGFzc2VzL0RTLkVtYmVkZGVkUmVjb3Jkc01peGluLmh0bWxgLCBmYWxzZSwgewogICAgICAgICAgaWQ6ICdkcy5tb2RlbC5lbWJlZGRlZC1vcHRpb24taW4tYmVsb25ncy10bycKICAgICAgICB9KSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzLl9pbnRlcm5hbE1vZGVsLl9yZWxhdGlvbnNoaXBzLmdldChrZXkpLmdldERhdGEoKTsKICAgIH0sCiAgICBzZXQoa2V5LCB2YWx1ZSkgewogICAgICB0aGlzLl9pbnRlcm5hbE1vZGVsLnNldERpcnR5QmVsb25nc1RvKGtleSwgdmFsdWUpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuZ2V0RGF0YSgpOwogICAgfQogIH0pLm1ldGEobWV0YSk7Cn0KCi8qKgogIEBtb2R1bGUgZW1iZXItZGF0YQoqLwovKioKICBgRFMuaGFzTWFueWAgaXMgdXNlZCB0byBkZWZpbmUgT25lLVRvLU1hbnkgYW5kIE1hbnktVG8tTWFueQogIHJlbGF0aW9uc2hpcHMgb24gYSBbRFMuTW9kZWxdKC9hcGkvZGF0YS9jbGFzc2VzL0RTLk1vZGVsLmh0bWwpLgoKICBgRFMuaGFzTWFueWAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsIGN1cnJlbnRseQogIHN1cHBvcnRlZCBvcHRpb25zIGFyZToKCiAgLSBgYXN5bmNgOiBBIGJvb2xlYW4gdmFsdWUgdXNlZCB0byBleHBsaWNpdGx5IGRlY2xhcmUgdGhpcyB0byBiZSBhbiBhc3luYyByZWxhdGlvbnNoaXAuCiAgLSBgaW52ZXJzZWA6IEEgc3RyaW5nIHVzZWQgdG8gaWRlbnRpZnkgdGhlIGludmVyc2UgcHJvcGVydHkgb24gYSByZWxhdGVkIG1vZGVsLgoKICAjIyMjIE9uZS1Uby1NYW55CiAgVG8gZGVjbGFyZSBhIG9uZS10by1tYW55IHJlbGF0aW9uc2hpcCBiZXR3ZWVuIHR3byBtb2RlbHMsIHVzZQogIGBEUy5iZWxvbmdzVG9gIGluIGNvbWJpbmF0aW9uIHdpdGggYERTLmhhc01hbnlgLCBsaWtlIHRoaXM6CgogIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KCdjb21tZW50JykKICB9KTsKICBgYGAKCiAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgcG9zdDogRFMuYmVsb25nc1RvKCdwb3N0JykKICB9KTsKICBgYGAKCiAgIyMjIyBNYW55LVRvLU1hbnkKICBUbyBkZWNsYXJlIGEgbWFueS10by1tYW55IHJlbGF0aW9uc2hpcCBiZXR3ZWVuIHR3byBtb2RlbHMsIHVzZQogIGBEUy5oYXNNYW55YDoKCiAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgdGFnczogRFMuaGFzTWFueSgndGFnJykKICB9KTsKICBgYGAKCiAgYGBgYXBwL21vZGVscy90YWcuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICBwb3N0czogRFMuaGFzTWFueSgncG9zdCcpCiAgfSk7CiAgYGBgCgogIFlvdSBjYW4gYXZvaWQgcGFzc2luZyBhIHN0cmluZyBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLiBJbiB0aGF0IGNhc2UgRW1iZXIgRGF0YQogIHdpbGwgaW5mZXIgdGhlIHR5cGUgZnJvbSB0aGUgc2luZ3VsYXJpemVkIGtleSBuYW1lLgoKICBgYGBhcHAvbW9kZWxzL3Bvc3QuanMKICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CgogIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICB0YWdzOiBEUy5oYXNNYW55KCkKICB9KTsKICBgYGAKCiAgd2lsbCBsb29rdXAgZm9yIGEgVGFnIHR5cGUuCgogICMjIyMgRXhwbGljaXQgSW52ZXJzZXMKCiAgRW1iZXIgRGF0YSB3aWxsIGRvIGl0cyBiZXN0IHRvIGRpc2NvdmVyIHdoaWNoIHJlbGF0aW9uc2hpcHMgbWFwIHRvCiAgb25lIGFub3RoZXIuIEluIHRoZSBvbmUtdG8tbWFueSBjb2RlIGFib3ZlLCBmb3IgZXhhbXBsZSwgRW1iZXIgRGF0YQogIGNhbiBmaWd1cmUgb3V0IHRoYXQgY2hhbmdpbmcgdGhlIGBjb21tZW50c2AgcmVsYXRpb25zaGlwIHNob3VsZCB1cGRhdGUKICB0aGUgYHBvc3RgIHJlbGF0aW9uc2hpcCBvbiB0aGUgaW52ZXJzZSBiZWNhdXNlIHBvc3QgaXMgdGhlIG9ubHkKICByZWxhdGlvbnNoaXAgdG8gdGhhdCBtb2RlbC4KCiAgSG93ZXZlciwgc29tZXRpbWVzIHlvdSBtYXkgaGF2ZSBtdWx0aXBsZSBgYmVsb25nc1RvYC9gaGFzTWFueWAgZm9yIHRoZQogIHNhbWUgdHlwZS4gWW91IGNhbiBzcGVjaWZ5IHdoaWNoIHByb3BlcnR5IG9uIHRoZSByZWxhdGVkIG1vZGVsIGlzCiAgdGhlIGludmVyc2UgdXNpbmcgYERTLmhhc01hbnlgJ3MgYGludmVyc2VgIG9wdGlvbjoKCiAgYGBgYXBwL21vZGVscy9jb21tZW50LmpzCiAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwoKICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgb25lUG9zdDogRFMuYmVsb25nc1RvKCdwb3N0JyksCiAgICB0d29Qb3N0OiBEUy5iZWxvbmdzVG8oJ3Bvc3QnKSwKICAgIHJlZFBvc3Q6IERTLmJlbG9uZ3NUbygncG9zdCcpLAogICAgYmx1ZVBvc3Q6IERTLmJlbG9uZ3NUbygncG9zdCcpCiAgfSk7CiAgYGBgCgogIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKCiAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgIGNvbW1lbnRzOiBEUy5oYXNNYW55KCdjb21tZW50JywgewogICAgICBpbnZlcnNlOiAncmVkUG9zdCcKICAgIH0pCiAgfSk7CiAgYGBgCgogIFlvdSBjYW4gYWxzbyBzcGVjaWZ5IGFuIGludmVyc2Ugb24gYSBgYmVsb25nc1RvYCwgd2hpY2ggd29ya3MgaG93CiAgeW91J2QgZXhwZWN0LgoKICBAbmFtZXNwYWNlCiAgQG1ldGhvZCBoYXNNYW55CiAgQGZvciBEUwogIEBwYXJhbSB7U3RyaW5nfSB0eXBlIChvcHRpb25hbCkgdHlwZSBvZiB0aGUgcmVsYXRpb25zaGlwCiAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgKG9wdGlvbmFsKSBhIGhhc2ggb2Ygb3B0aW9ucwogIEByZXR1cm4ge0VtYmVyLmNvbXB1dGVkfSByZWxhdGlvbnNoaXAKKi8KZnVuY3Rpb24gaGFzTWFueSh0eXBlLCBvcHRpb25zKSB7CiAgaWYgKHR5cGVvZiB0eXBlID09PSAnb2JqZWN0JykgewogICAgb3B0aW9ucyA9IHR5cGU7CiAgICB0eXBlID0gdW5kZWZpbmVkOwogIH0KCiAgKHRydWUgJiYgISh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHR5cGUgPT09ICd1bmRlZmluZWQnKSAmJiBFbWJlci5hc3NlcnQoYFRoZSBmaXJzdCBhcmd1bWVudCB0byBEUy5oYXNNYW55IG11c3QgYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgbW9kZWwgdHlwZSBrZXksIG5vdCBhbiBpbnN0YW5jZSBvZiAke0VtYmVyLmluc3BlY3QodHlwZSl9LiBFLmcuLCB0byBkZWZpbmUgYSByZWxhdGlvbiB0byB0aGUgQ29tbWVudCBtb2RlbCwgdXNlIERTLmhhc01hbnkoJ2NvbW1lbnQnKWAsIHR5cGVvZiB0eXBlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdHlwZSA9PT0gJ3VuZGVmaW5lZCcpKTsKCgogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICBpZiAodHlwZW9mIHR5cGUgPT09ICdzdHJpbmcnKSB7CiAgICB0eXBlID0gbm9ybWFsaXplTW9kZWxOYW1lKHR5cGUpOwogIH0KCiAgLy8gTWV0YWRhdGEgYWJvdXQgcmVsYXRpb25zaGlwcyBpcyBzdG9yZWQgb24gdGhlIG1ldGEgb2YKICAvLyB0aGUgcmVsYXRpb25zaGlwLiBUaGlzIGlzIHVzZWQgZm9yIGludHJvc3BlY3Rpb24gYW5kCiAgLy8gc2VyaWFsaXphdGlvbi4gTm90ZSB0aGF0IGBrZXlgIGlzIHBvcHVsYXRlZCBsYXppbHkKICAvLyB0aGUgZmlyc3QgdGltZSB0aGUgQ1AgaXMgY2FsbGVkLgogIHZhciBtZXRhID0gewogICAgdHlwZSwKICAgIG9wdGlvbnMsCiAgICBpc1JlbGF0aW9uc2hpcDogdHJ1ZSwKICAgIGtpbmQ6ICdoYXNNYW55JywKICAgIG5hbWU6ICdIYXMgTWFueScsCiAgICBrZXk6IG51bGwKICB9OwoKICByZXR1cm4gRW1iZXIuY29tcHV0ZWQoewogICAgZ2V0KGtleSkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxNb2RlbC5fcmVsYXRpb25zaGlwcy5nZXQoa2V5KS5nZXREYXRhKCk7CiAgICB9LAogICAgc2V0KGtleSwgcmVjb3JkcykgewogICAgICB0aGlzLl9pbnRlcm5hbE1vZGVsLnNldERpcnR5SGFzTWFueShrZXksIHJlY29yZHMpOwoKICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuX3JlbGF0aW9uc2hpcHMuZ2V0KGtleSkuZ2V0RGF0YSgpOwogICAgfQogIH0pLm1ldGEobWV0YSk7Cn0KCi8qKgoKICBXQVJOSU5HOiBUaGlzIGludGVyZmFjZSBpcyBsaWtlbHkgdG8gY2hhbmdlIGluIG9yZGVyIHRvIGFjY29tb2RhdGUgaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvcmZjcy9wdWxsLzQKCiAgIyMgVXNpbmcgQnVpbGRVUkxNaXhpbgoKICBUbyB1c2UgdXJsIGJ1aWxkaW5nLCBpbmNsdWRlIHRoZSBtaXhpbiB3aGVuIGV4dGVuZGluZyBhbiBhZGFwdGVyLCBhbmQgY2FsbCBgYnVpbGRVUkxgIHdoZXJlIG5lZWRlZC4KICBUaGUgZGVmYXVsdCBiZWhhdmlvdXIgaXMgZGVzaWduZWQgZm9yIFJFU1RBZGFwdGVyLgoKICAjIyMgRXhhbXBsZQoKICBgYGBqYXZhc2NyaXB0CiAgZXhwb3J0IGRlZmF1bHQgRFMuQWRhcHRlci5leHRlbmQoQnVpbGRVUkxNaXhpbiwgewogICAgZmluZFJlY29yZDogZnVuY3Rpb24oc3RvcmUsIHR5cGUsIGlkLCBzbmFwc2hvdCkgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgaWQsIHNuYXBzaG90LCAnZmluZFJlY29yZCcpOwogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcpOwogICAgfQogIH0pOwogIGBgYAoKICAjIyMgQXR0cmlidXRlcwoKICBUaGUgYGhvc3RgIGFuZCBgbmFtZXNwYWNlYCBhdHRyaWJ1dGVzIHdpbGwgYmUgdXNlZCBpZiBkZWZpbmVkLCBhbmQgYXJlIG9wdGlvbmFsLgoKICBAY2xhc3MgQnVpbGRVUkxNaXhpbgogIEBuYW1lc3BhY2UgRFMKKi8KdmFyIGJ1aWxkVXJsTWl4aW4gPSBFbWJlci5NaXhpbi5jcmVhdGUoewogIC8qKgogICAgQnVpbGRzIGEgVVJMIGZvciBhIGdpdmVuIHR5cGUgYW5kIG9wdGlvbmFsIElELgogICAgIEJ5IGRlZmF1bHQsIGl0IHBsdXJhbGl6ZXMgdGhlIHR5cGUncyBuYW1lIChmb3IgZXhhbXBsZSwgJ3Bvc3QnCiAgICBiZWNvbWVzICdwb3N0cycgYW5kICdwZXJzb24nIGJlY29tZXMgJ3Blb3BsZScpLiBUbyBvdmVycmlkZSB0aGUKICAgIHBsdXJhbGl6YXRpb24gc2VlIFtwYXRoRm9yVHlwZV0oI21ldGhvZF9wYXRoRm9yVHlwZSkuCiAgICAgSWYgYW4gSUQgaXMgc3BlY2lmaWVkLCBpdCBhZGRzIHRoZSBJRCB0byB0aGUgcGF0aCBnZW5lcmF0ZWQKICAgIGZvciB0aGUgdHlwZSwgc2VwYXJhdGVkIGJ5IGEgYC9gLgogICAgIFdoZW4gY2FsbGVkIGJ5IFJFU1RBZGFwdGVyLmZpbmRNYW55KCkgdGhlIGBpZGAgYW5kIGBzbmFwc2hvdGAgcGFyYW1ldGVycwogICAgd2lsbCBiZSBhcnJheXMgb2YgaWRzIGFuZCBzbmFwc2hvdHMuCiAgICAgQG1ldGhvZCBidWlsZFVSTAogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHBhcmFtIHsoU3RyaW5nfEFycmF5fE9iamVjdCl9IGlkIHNpbmdsZSBpZCBvciBhcnJheSBvZiBpZHMgb3IgcXVlcnkKICAgIEBwYXJhbSB7KERTLlNuYXBzaG90fEFycmF5KX0gc25hcHNob3Qgc2luZ2xlIHNuYXBzaG90IG9yIGFycmF5IG9mIHNuYXBzaG90cwogICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICBAcGFyYW0ge09iamVjdH0gcXVlcnkgb2JqZWN0IG9mIHF1ZXJ5IHBhcmFtZXRlcnMgdG8gc2VuZCBmb3IgcXVlcnkgcmVxdWVzdHMuCiAgICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICovCiAgYnVpbGRVUkwobW9kZWxOYW1lLCBpZCwgc25hcHNob3QsIHJlcXVlc3RUeXBlLCBxdWVyeSkgewogICAgc3dpdGNoIChyZXF1ZXN0VHlwZSkgewogICAgICBjYXNlICdmaW5kUmVjb3JkJzoKICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JGaW5kUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KTsKICAgICAgY2FzZSAnZmluZEFsbCc6CiAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yRmluZEFsbChtb2RlbE5hbWUsIHNuYXBzaG90KTsKICAgICAgY2FzZSAncXVlcnknOgogICAgICAgIHJldHVybiB0aGlzLnVybEZvclF1ZXJ5KHF1ZXJ5LCBtb2RlbE5hbWUpOwogICAgICBjYXNlICdxdWVyeVJlY29yZCc6CiAgICAgICAgcmV0dXJuIHRoaXMudXJsRm9yUXVlcnlSZWNvcmQocXVlcnksIG1vZGVsTmFtZSk7CiAgICAgIGNhc2UgJ2ZpbmRNYW55JzoKICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JGaW5kTWFueShpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCk7CiAgICAgIGNhc2UgJ2ZpbmRIYXNNYW55JzoKICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JGaW5kSGFzTWFueShpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCk7CiAgICAgIGNhc2UgJ2ZpbmRCZWxvbmdzVG8nOgogICAgICAgIHJldHVybiB0aGlzLnVybEZvckZpbmRCZWxvbmdzVG8oaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpOwogICAgICBjYXNlICdjcmVhdGVSZWNvcmQnOgogICAgICAgIHJldHVybiB0aGlzLnVybEZvckNyZWF0ZVJlY29yZChtb2RlbE5hbWUsIHNuYXBzaG90KTsKICAgICAgY2FzZSAndXBkYXRlUmVjb3JkJzoKICAgICAgICByZXR1cm4gdGhpcy51cmxGb3JVcGRhdGVSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpOwogICAgICBjYXNlICdkZWxldGVSZWNvcmQnOgogICAgICAgIHJldHVybiB0aGlzLnVybEZvckRlbGV0ZVJlY29yZChpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkVVJMKG1vZGVsTmFtZSwgaWQpOwogICAgfQogIH0sCgogIC8qKgogICAgQG1ldGhvZCBfYnVpbGRVUkwKICAgIEBwcml2YXRlCiAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgKi8KICBfYnVpbGRVUkwobW9kZWxOYW1lLCBpZCkgewogICAgdmFyIHBhdGggPSB2b2lkIDA7CiAgICB2YXIgdXJsID0gW107CiAgICB2YXIgaG9zdCA9IEVtYmVyLmdldCh0aGlzLCAnaG9zdCcpOwogICAgdmFyIHByZWZpeCA9IHRoaXMudXJsUHJlZml4KCk7CgogICAgaWYgKG1vZGVsTmFtZSkgewogICAgICBwYXRoID0gdGhpcy5wYXRoRm9yVHlwZShtb2RlbE5hbWUpOwogICAgICBpZiAocGF0aCkgewogICAgICAgIHVybC5wdXNoKHBhdGgpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlkKSB7CiAgICAgIHVybC5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChpZCkpOwogICAgfQogICAgaWYgKHByZWZpeCkgewogICAgICB1cmwudW5zaGlmdChwcmVmaXgpOwogICAgfQoKICAgIHVybCA9IHVybC5qb2luKCcvJyk7CiAgICBpZiAoIWhvc3QgJiYgdXJsICYmIHVybC5jaGFyQXQoMCkgIT09ICcvJykgewogICAgICB1cmwgPSAnLycgKyB1cmw7CiAgICB9CgogICAgcmV0dXJuIHVybDsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5maW5kUmVjb3JkKHR5cGUsIGlkKWAgY2FsbC4KICAgIEV4YW1wbGU6CiAgICBgYGBhcHAvYWRhcHRlcnMvdXNlci5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OQVBJQWRhcHRlci5leHRlbmQoewogICAgIHVybEZvckZpbmRSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChtb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCk7CiAgICAgICByZXR1cm4gYCR7YmFzZVVybH0vdXNlcnMvJHtzbmFwc2hvdC5hZGFwdGVyT3B0aW9ucy51c2VyX2lkfS9wbGF5bGlzdHMvJHtpZH1gOwogICAgIH0KICAgfSk7CiAgIGBgYAogICAgQG1ldGhvZCB1cmxGb3JGaW5kUmVjb3JkCiAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICAqLwogIHVybEZvckZpbmRSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5maW5kQWxsKHR5cGUpYCBjYWxsLgogICAgRXhhbXBsZToKICAgIGBgYGFwcC9hZGFwdGVycy9jb21tZW50LmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgdXJsRm9yRmluZEFsbChtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICAgICByZXR1cm4gJ2RhdGEvY29tbWVudHMuanNvbic7CiAgICAgfQogICB9KTsKICAgYGBgCiAgICBAbWV0aG9kIHVybEZvckZpbmRBbGwKICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICBAcGFyYW0ge0RTLlNuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90CiAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICovCiAgdXJsRm9yRmluZEFsbChtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5xdWVyeSh0eXBlLCBxdWVyeSlgIGNhbGwuCiAgICBFeGFtcGxlOgogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgaG9zdDogJ2h0dHBzOi8vYXBpLmdpdGh1Yi5jb20nLAogICAgIHVybEZvclF1ZXJ5IChxdWVyeSwgbW9kZWxOYW1lKSB7CiAgICAgICBzd2l0Y2gobW9kZWxOYW1lKSB7CiAgICAgICAgIGNhc2UgJ3JlcG8nOgogICAgICAgICAgIHJldHVybiBgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9vcmdzLyR7cXVlcnkub3JnSWR9L3JlcG9zYDsKICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgIH0KICAgICB9CiAgIH0pOwogICBgYGAKICAgIEBtZXRob2QgdXJsRm9yUXVlcnkKICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgKi8KICB1cmxGb3JRdWVyeShxdWVyeSwgbW9kZWxOYW1lKSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGBzdG9yZS5xdWVyeVJlY29yZCh0eXBlLCBxdWVyeSlgIGNhbGwuCiAgICBFeGFtcGxlOgogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgdXJsRm9yUXVlcnlSZWNvcmQoeyBzbHVnIH0sIG1vZGVsTmFtZSkgewogICAgICAgbGV0IGJhc2VVcmwgPSB0aGlzLmJ1aWxkVVJMKCk7CiAgICAgICByZXR1cm4gYCR7YmFzZVVybH0vJHtlbmNvZGVVUklDb21wb25lbnQoc2x1Zyl9YDsKICAgICB9CiAgIH0pOwogICBgYGAKICAgIEBtZXRob2QgdXJsRm9yUXVlcnlSZWNvcmQKICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgKi8KICB1cmxGb3JRdWVyeVJlY29yZChxdWVyeSwgbW9kZWxOYW1lKSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBjb2FsZXNjZWluZyBtdWx0aXBsZSBgc3RvcmUuZmluZFJlY29yZCh0eXBlLCBpZClgCiAgIHJlY29yZHMgaW50byAxIHJlcXVlc3Qgd2hlbiB0aGUgYWRhcHRlcidzIGBjb2FsZXNjZUZpbmRSZXF1ZXN0c2AKICAgcHJvcGVydHkgaXMgdHJ1ZS4KICAgIEV4YW1wbGU6CiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICB1cmxGb3JGaW5kTWFueShpZHMsIG1vZGVsTmFtZSkgewogICAgICAgbGV0IGJhc2VVcmwgPSB0aGlzLmJ1aWxkVVJMKCk7CiAgICAgICByZXR1cm4gYCR7YmFzZVVybH0vY29hbGVzY2VgOwogICAgIH0KICAgfSk7CiAgIGBgYAogICAgQG1ldGhvZCB1cmxGb3JGaW5kTWFueQogICBAcGFyYW0ge0FycmF5fSBpZHMKICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICBAcGFyYW0ge0FycmF5fSBzbmFwc2hvdHMKICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgKi8KICB1cmxGb3JGaW5kTWFueShpZHMsIG1vZGVsTmFtZSwgc25hcHNob3RzKSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBmZXRjaGluZyBhIGFzeW5jIGhhc01hbnkgcmVsYXRpb25zaGlwIHdoZW4gYSB1cmwKICAgaXMgbm90IHByb3ZpZGVkIGJ5IHRoZSBzZXJ2ZXIuCiAgICBFeGFtcGxlOgogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgdXJsRm9yRmluZEhhc01hbnkoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChpZCwgbW9kZWxOYW1lKTsKICAgICAgIHJldHVybiBgJHtiYXNlVXJsfS9yZWxhdGlvbnNoaXBzYDsKICAgICB9CiAgIH0pOwogICBgYGAKICAgIEBtZXRob2QgdXJsRm9yRmluZEhhc01hbnkKICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgKi8KICB1cmxGb3JGaW5kSGFzTWFueShpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCkgewogICAgcmV0dXJuIHRoaXMuX2J1aWxkVVJMKG1vZGVsTmFtZSwgaWQpOwogIH0sCgogIC8qKgogICBCdWlsZHMgYSBVUkwgZm9yIGZldGNoaW5nIGEgYXN5bmMgYmVsb25nc1RvIHJlbGF0aW9uc2hpcCB3aGVuIGEgdXJsCiAgIGlzIG5vdCBwcm92aWRlZCBieSB0aGUgc2VydmVyLgogICAgRXhhbXBsZToKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OQVBJQWRhcHRlci5leHRlbmQoewogICAgIHVybEZvckZpbmRCZWxvbmdzVG8oaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgIGxldCBiYXNlVXJsID0gdGhpcy5idWlsZFVSTChpZCwgbW9kZWxOYW1lKTsKICAgICAgIHJldHVybiBgJHtiYXNlVXJsfS9yZWxhdGlvbnNoaXBzYDsKICAgICB9CiAgIH0pOwogICBgYGAKICAgIEBtZXRob2QgdXJsRm9yRmluZEJlbG9uZ3NUbwogICBAcGFyYW0ge1N0cmluZ30gaWQKICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAqLwogIHVybEZvckZpbmRCZWxvbmdzVG8oaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGByZWNvcmQuc2F2ZSgpYCBjYWxsIHdoZW4gdGhlIHJlY29yZCB3YXMgY3JlYXRlZAogICBsb2NhbGx5IHVzaW5nIGBzdG9yZS5jcmVhdGVSZWNvcmQoKWAuCiAgICBFeGFtcGxlOgogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgdXJsRm9yQ3JlYXRlUmVjb3JkKG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgIHJldHVybiB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpICsgJy9uZXcnOwogICAgIH0KICAgfSk7CiAgIGBgYAogICAgQG1ldGhvZCB1cmxGb3JDcmVhdGVSZWNvcmQKICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICBAcmV0dXJuIHtTdHJpbmd9IHVybAogICAqLwogIHVybEZvckNyZWF0ZVJlY29yZChtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lKTsKICB9LAoKICAvKioKICAgQnVpbGRzIGEgVVJMIGZvciBhIGByZWNvcmQuc2F2ZSgpYCBjYWxsIHdoZW4gdGhlIHJlY29yZCBoYXMgYmVlbiB1cGRhdGUgbG9jYWxseS4KICAgIEV4YW1wbGU6CiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICB1cmxGb3JVcGRhdGVSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgICAgIHJldHVybiBgLyR7aWR9L2ZlZWQ/YWNjZXNzX3Rva2VuPSR7c25hcHNob3QuYWRhcHRlck9wdGlvbnMudG9rZW59YDsKICAgICB9CiAgIH0pOwogICBgYGAKICAgIEBtZXRob2QgdXJsRm9yVXBkYXRlUmVjb3JkCiAgIEBwYXJhbSB7U3RyaW5nfSBpZAogICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgIEByZXR1cm4ge1N0cmluZ30gdXJsCiAgICovCiAgdXJsRm9yVXBkYXRlUmVjb3JkKGlkLCBtb2RlbE5hbWUsIHNuYXBzaG90KSB7CiAgICByZXR1cm4gdGhpcy5fYnVpbGRVUkwobW9kZWxOYW1lLCBpZCk7CiAgfSwKCiAgLyoqCiAgIEJ1aWxkcyBhIFVSTCBmb3IgYSBgcmVjb3JkLnNhdmUoKWAgY2FsbCB3aGVuIHRoZSByZWNvcmQgaGFzIGJlZW4gZGVsZXRlZCBsb2NhbGx5LgogICAgRXhhbXBsZToKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUQWRhcHRlci5leHRlbmQoewogICAgIHVybEZvckRlbGV0ZVJlY29yZChpZCwgbW9kZWxOYW1lLCBzbmFwc2hvdCkgewogICAgICAgcmV0dXJuIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cykgKyAnL2Rlc3Ryb3knOwogICAgIH0KICAgfSk7CiAgIGBgYAogICAgQG1ldGhvZCB1cmxGb3JEZWxldGVSZWNvcmQKICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgQHJldHVybiB7U3RyaW5nfSB1cmwKICAgKi8KICB1cmxGb3JEZWxldGVSZWNvcmQoaWQsIG1vZGVsTmFtZSwgc25hcHNob3QpIHsKICAgIHJldHVybiB0aGlzLl9idWlsZFVSTChtb2RlbE5hbWUsIGlkKTsKICB9LAoKICAvKioKICAgIEBtZXRob2QgdXJsUHJlZml4CiAgICBAcHJpdmF0ZQogICAgQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgIEBwYXJhbSB7U3RyaW5nfSBwYXJlbnRVUkwKICAgIEByZXR1cm4ge1N0cmluZ30gdXJsUHJlZml4CiAgKi8KICB1cmxQcmVmaXgocGF0aCwgcGFyZW50VVJMKSB7CiAgICB2YXIgaG9zdCA9IEVtYmVyLmdldCh0aGlzLCAnaG9zdCcpOwogICAgdmFyIG5hbWVzcGFjZSA9IEVtYmVyLmdldCh0aGlzLCAnbmFtZXNwYWNlJyk7CgogICAgaWYgKCFob3N0IHx8IGhvc3QgPT09ICcvJykgewogICAgICBob3N0ID0gJyc7CiAgICB9CgogICAgaWYgKHBhdGgpIHsKICAgICAgLy8gUHJvdG9jb2wgcmVsYXRpdmUgdXJsCiAgICAgIGlmICgvXlwvXC8vLnRlc3QocGF0aCkgfHwgL2h0dHAocyk/OlwvXC8vLnRlc3QocGF0aCkpIHsKICAgICAgICAvLyBEbyBub3RoaW5nLCB0aGUgZnVsbCBob3N0IGlzIGFscmVhZHkgaW5jbHVkZWQuCiAgICAgICAgcmV0dXJuIHBhdGg7CgogICAgICAgIC8vIEFic29sdXRlIHBhdGgKICAgICAgfSBlbHNlIGlmIChwYXRoLmNoYXJBdCgwKSA9PT0gJy8nKSB7CiAgICAgICAgcmV0dXJuIGAke2hvc3R9JHtwYXRofWA7CiAgICAgICAgLy8gUmVsYXRpdmUgcGF0aAogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBgJHtwYXJlbnRVUkx9LyR7cGF0aH1gOwogICAgICB9CiAgICB9CgogICAgLy8gTm8gcGF0aCBwcm92aWRlZAogICAgdmFyIHVybCA9IFtdOwogICAgaWYgKGhvc3QpIHsKICAgICAgdXJsLnB1c2goaG9zdCk7CiAgICB9CiAgICBpZiAobmFtZXNwYWNlKSB7CiAgICAgIHVybC5wdXNoKG5hbWVzcGFjZSk7CiAgICB9CiAgICByZXR1cm4gdXJsLmpvaW4oJy8nKTsKICB9LAoKICAvKioKICAgIERldGVybWluZXMgdGhlIHBhdGhuYW1lIGZvciBhIGdpdmVuIHR5cGUuCiAgICAgQnkgZGVmYXVsdCwgaXQgcGx1cmFsaXplcyB0aGUgdHlwZSdzIG5hbWUgKGZvciBleGFtcGxlLAogICAgJ3Bvc3QnIGJlY29tZXMgJ3Bvc3RzJyBhbmQgJ3BlcnNvbicgYmVjb21lcyAncGVvcGxlJykuCiAgICAgIyMjIFBhdGhuYW1lIGN1c3RvbWl6YXRpb24KICAgICBGb3IgZXhhbXBsZSBpZiB5b3UgaGF2ZSBhbiBvYmplY3QgTGluZUl0ZW0gd2l0aCBhbgogICAgZW5kcG9pbnQgb2YgIi9saW5lX2l0ZW1zLyIuCiAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBpbXBvcnQgeyBkZWNhbWVsaXplIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICBpbXBvcnQgeyBwbHVyYWxpemUgfSBmcm9tICdlbWJlci1pbmZsZWN0b3InOwogICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgIHBhdGhGb3JUeXBlOiBmdW5jdGlvbihtb2RlbE5hbWUpIHsKICAgICAgICB2YXIgZGVjYW1lbGl6ZWQgPSBkZWNhbWVsaXplKG1vZGVsTmFtZSk7CiAgICAgICAgcmV0dXJuIHBsdXJhbGl6ZShkZWNhbWVsaXplZCk7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgICAgQG1ldGhvZCBwYXRoRm9yVHlwZQogICAgQHBhcmFtIHtTdHJpbmd9IG1vZGVsTmFtZQogICAgQHJldHVybiB7U3RyaW5nfSBwYXRoCiAgKiovCiAgcGF0aEZvclR5cGUobW9kZWxOYW1lKSB7CiAgICB2YXIgY2FtZWxpemVkID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKG1vZGVsTmFtZSk7CiAgICByZXR1cm4gZW1iZXJJbmZsZWN0b3IucGx1cmFsaXplKGNhbWVsaXplZCk7CiAgfQp9KTsKCnZhciBuZXdsaW5lID0gL1xyP1xuLzsKCmZ1bmN0aW9uIHBhcnNlUmVzcG9uc2VIZWFkZXJzKGhlYWRlcnNTdHJpbmcpIHsKICB2YXIgaGVhZGVycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogIGlmICghaGVhZGVyc1N0cmluZykgewogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQoKICB2YXIgaGVhZGVyUGFpcnMgPSBoZWFkZXJzU3RyaW5nLnNwbGl0KG5ld2xpbmUpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGhlYWRlclBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgaGVhZGVyID0gaGVhZGVyUGFpcnNbaV07CiAgICB2YXIgaiA9IDA7CiAgICB2YXIgZm91bmRTZXAgPSBmYWxzZTsKCiAgICBmb3IgKDsgaiA8IGhlYWRlci5sZW5ndGg7IGorKykgewogICAgICBpZiAoaGVhZGVyLmNoYXJDb2RlQXQoaikgPT09IDU4IC8qICc6JyAqLykgewogICAgICAgICAgZm91bmRTZXAgPSB0cnVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChmb3VuZFNlcCA9PT0gZmFsc2UpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgdmFyIGZpZWxkID0gaGVhZGVyLnN1YnN0cmluZygwLCBqKS50cmltKCk7CiAgICB2YXIgdmFsdWUgPSBoZWFkZXIuc3Vic3RyaW5nKGogKyAxLCBoZWFkZXIubGVuZ3RoKS50cmltKCk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIGhlYWRlcnNbZmllbGRdID0gdmFsdWU7CiAgICB9CiAgfQoKICByZXR1cm4gaGVhZGVyczsKfQoKZnVuY3Rpb24gaXNFbmFibGVkKCkgewogIHJldHVybiBFbWJlci5GRUFUVVJFUy5pc0VuYWJsZWQoLi4uYXJndW1lbnRzKTsKfQoKLyoKICBFeHRlbmQgYEVtYmVyLkRhdGFBZGFwdGVyYCB3aXRoIEVEIHNwZWNpZmljIGNvZGUuCgogIEBjbGFzcyBEZWJ1Z0FkYXB0ZXIKICBAbmFtZXNwYWNlIERTCiAgQGV4dGVuZHMgRW1iZXIuRGF0YUFkYXB0ZXIKICBAcHJpdmF0ZQoqLwovKioKICBAbW9kdWxlIGVtYmVyLWRhdGEKKi8KdmFyIGRlYnVnQWRhcHRlciA9IEVtYmVyLkRhdGFBZGFwdGVyLmV4dGVuZCh7CiAgZ2V0RmlsdGVycygpIHsKICAgIHJldHVybiBbeyBuYW1lOiAnaXNOZXcnLCBkZXNjOiAnTmV3JyB9LCB7IG5hbWU6ICdpc01vZGlmaWVkJywgZGVzYzogJ01vZGlmaWVkJyB9LCB7IG5hbWU6ICdpc0NsZWFuJywgZGVzYzogJ0NsZWFuJyB9XTsKICB9LAoKICBkZXRlY3QodHlwZUNsYXNzKSB7CiAgICByZXR1cm4gdHlwZUNsYXNzICE9PSBNb2RlbCAmJiBNb2RlbC5kZXRlY3QodHlwZUNsYXNzKTsKICB9LAoKICBjb2x1bW5zRm9yVHlwZSh0eXBlQ2xhc3MpIHsKICAgIHZhciBjb2x1bW5zID0gW3sKICAgICAgbmFtZTogJ2lkJywKICAgICAgZGVzYzogJ0lkJwogICAgfV07CiAgICB2YXIgY291bnQgPSAwOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgRW1iZXIuZ2V0KHR5cGVDbGFzcywgJ2F0dHJpYnV0ZXMnKS5mb3JFYWNoKChtZXRhLCBuYW1lKSA9PiB7CiAgICAgIGlmIChjb3VudCsrID4gc2VsZi5hdHRyaWJ1dGVMaW1pdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB2YXIgZGVzYyA9IEVtYmVyLlN0cmluZy5jYXBpdGFsaXplKEVtYmVyLlN0cmluZy51bmRlcnNjb3JlKG5hbWUpLnJlcGxhY2UoJ18nLCAnICcpKTsKICAgICAgY29sdW1ucy5wdXNoKHsgbmFtZTogbmFtZSwgZGVzYzogZGVzYyB9KTsKICAgIH0pOwogICAgcmV0dXJuIGNvbHVtbnM7CiAgfSwKCiAgZ2V0UmVjb3Jkcyhtb2RlbENsYXNzLCBtb2RlbE5hbWUpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAvLyBMZWdhY3kgRW1iZXIuanMgPCAxLjEzIHN1cHBvcnQKICAgICAgdmFyIGNvbnRhaW5lcktleSA9IG1vZGVsQ2xhc3MuX2RlYnVnQ29udGFpbmVyS2V5OwogICAgICBpZiAoY29udGFpbmVyS2V5KSB7CiAgICAgICAgdmFyIG1hdGNoID0gY29udGFpbmVyS2V5Lm1hdGNoKC9tb2RlbDooLiopLyk7CiAgICAgICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgICAgICBtb2RlbE5hbWUgPSBtYXRjaFsxXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgICh0cnVlICYmICEoISFtb2RlbE5hbWUpICYmIEVtYmVyLmFzc2VydCgiQ2Fubm90IGZpbmQgbW9kZWwgbmFtZS4gUGxlYXNlIHVwZ3JhZGUgdG8gRW1iZXIuanMgPj0gMS4xMyBmb3IgRW1iZXIgSW5zcGVjdG9yIHN1cHBvcnQiLCAhIW1vZGVsTmFtZSkpOwoKICAgIHJldHVybiB0aGlzLmdldCgnc3RvcmUnKS5wZWVrQWxsKG1vZGVsTmFtZSk7CiAgfSwKCiAgZ2V0UmVjb3JkQ29sdW1uVmFsdWVzKHJlY29yZCkgewogICAgdmFyIGNvdW50ID0gMDsKICAgIHZhciBjb2x1bW5WYWx1ZXMgPSB7IGlkOiBFbWJlci5nZXQocmVjb3JkLCAnaWQnKSB9OwoKICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGtleSA9PiB7CiAgICAgIGlmIChjb3VudCsrID4gdGhpcy5hdHRyaWJ1dGVMaW1pdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb2x1bW5WYWx1ZXNba2V5XSA9IEVtYmVyLmdldChyZWNvcmQsIGtleSk7CiAgICB9KTsKICAgIHJldHVybiBjb2x1bW5WYWx1ZXM7CiAgfSwKCiAgZ2V0UmVjb3JkS2V5d29yZHMocmVjb3JkKSB7CiAgICB2YXIga2V5d29yZHMgPSBbXTsKICAgIHZhciBrZXlzID0gRW1iZXIuQShbJ2lkJ10pOwogICAgcmVjb3JkLmVhY2hBdHRyaWJ1dGUoa2V5ID0+IGtleXMucHVzaChrZXkpKTsKICAgIGtleXMuZm9yRWFjaChrZXkgPT4ga2V5d29yZHMucHVzaChFbWJlci5nZXQocmVjb3JkLCBrZXkpKSk7CiAgICByZXR1cm4ga2V5d29yZHM7CiAgfSwKCiAgZ2V0UmVjb3JkRmlsdGVyVmFsdWVzKHJlY29yZCkgewogICAgcmV0dXJuIHsKICAgICAgaXNOZXc6IHJlY29yZC5nZXQoJ2lzTmV3JyksCiAgICAgIGlzTW9kaWZpZWQ6IHJlY29yZC5nZXQoJ2hhc0RpcnR5QXR0cmlidXRlcycpICYmICFyZWNvcmQuZ2V0KCdpc05ldycpLAogICAgICBpc0NsZWFuOiAhcmVjb3JkLmdldCgnaGFzRGlydHlBdHRyaWJ1dGVzJykKICAgIH07CiAgfSwKCiAgZ2V0UmVjb3JkQ29sb3IocmVjb3JkKSB7CiAgICB2YXIgY29sb3IgPSAnYmxhY2snOwogICAgaWYgKHJlY29yZC5nZXQoJ2lzTmV3JykpIHsKICAgICAgY29sb3IgPSAnZ3JlZW4nOwogICAgfSBlbHNlIGlmIChyZWNvcmQuZ2V0KCdoYXNEaXJ0eUF0dHJpYnV0ZXMnKSkgewogICAgICBjb2xvciA9ICdibHVlJzsKICAgIH0KICAgIHJldHVybiBjb2xvcjsKICB9LAoKICBvYnNlcnZlUmVjb3JkKHJlY29yZCwgcmVjb3JkVXBkYXRlZCkgewogICAgdmFyIHJlbGVhc2VNZXRob2RzID0gRW1iZXIuQSgpOwogICAgdmFyIGtleXNUb09ic2VydmUgPSBFbWJlci5BKFsnaWQnLCAnaXNOZXcnLCAnaGFzRGlydHlBdHRyaWJ1dGVzJ10pOwoKICAgIHJlY29yZC5lYWNoQXR0cmlidXRlKGtleSA9PiBrZXlzVG9PYnNlcnZlLnB1c2goa2V5KSk7CiAgICB2YXIgYWRhcHRlciA9IHRoaXM7CgogICAga2V5c1RvT2JzZXJ2ZS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVjb3JkVXBkYXRlZChhZGFwdGVyLndyYXBSZWNvcmQocmVjb3JkKSk7CiAgICAgIH07CiAgICAgIEVtYmVyLmFkZE9ic2VydmVyKHJlY29yZCwga2V5LCBoYW5kbGVyKTsKICAgICAgcmVsZWFzZU1ldGhvZHMucHVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgRW1iZXIucmVtb3ZlT2JzZXJ2ZXIocmVjb3JkLCBrZXksIGhhbmRsZXIpOwogICAgICB9KTsKICAgIH0pOwoKICAgIHZhciByZWxlYXNlID0gZnVuY3Rpb24gKCkgewogICAgICByZWxlYXNlTWV0aG9kcy5mb3JFYWNoKGZuID0+IGZuKCkpOwogICAgfTsKCiAgICByZXR1cm4gcmVsZWFzZTsKICB9Cn0pOwoKLy8gcHVibGljCgpleHBvcnRzLk1vZGVsID0gTW9kZWw7CmV4cG9ydHMuRXJyb3JzID0gRXJyb3JzOwpleHBvcnRzLlN0b3JlID0gU3RvcmUkMTsKZXhwb3J0cy5EUyA9IERTOwpleHBvcnRzLmJlbG9uZ3NUbyA9IGJlbG9uZ3NUbzsKZXhwb3J0cy5oYXNNYW55ID0gaGFzTWFueTsKZXhwb3J0cy5CdWlsZFVSTE1peGluID0gYnVpbGRVcmxNaXhpbjsKZXhwb3J0cy5TbmFwc2hvdCA9IFNuYXBzaG90OwpleHBvcnRzLkFkYXB0ZXJFcnJvciA9IEFkYXB0ZXJFcnJvcjsKZXhwb3J0cy5JbnZhbGlkRXJyb3IgPSBJbnZhbGlkRXJyb3I7CmV4cG9ydHMuVW5hdXRob3JpemVkRXJyb3IgPSBVbmF1dGhvcml6ZWRFcnJvcjsKZXhwb3J0cy5Gb3JiaWRkZW5FcnJvciA9IEZvcmJpZGRlbkVycm9yOwpleHBvcnRzLk5vdEZvdW5kRXJyb3IgPSBOb3RGb3VuZEVycm9yOwpleHBvcnRzLkNvbmZsaWN0RXJyb3IgPSBDb25mbGljdEVycm9yOwpleHBvcnRzLlNlcnZlckVycm9yID0gU2VydmVyRXJyb3I7CmV4cG9ydHMuVGltZW91dEVycm9yID0gVGltZW91dEVycm9yOwpleHBvcnRzLkFib3J0RXJyb3IgPSBBYm9ydEVycm9yOwpleHBvcnRzLmVycm9yc0hhc2hUb0FycmF5ID0gZXJyb3JzSGFzaFRvQXJyYXk7CmV4cG9ydHMuZXJyb3JzQXJyYXlUb0hhc2ggPSBlcnJvcnNBcnJheVRvSGFzaDsKZXhwb3J0cy5ub3JtYWxpemVNb2RlbE5hbWUgPSBub3JtYWxpemVNb2RlbE5hbWU7CmV4cG9ydHMuZ2V0T3duZXIgPSBnZXRPd25lcjsKZXhwb3J0cy5tb2RlbEhhc0F0dHJpYnV0ZU9yUmVsYXRpb25zaGlwTmFtZWRUeXBlID0gbW9kZWxIYXNBdHRyaWJ1dGVPclJlbGF0aW9uc2hpcE5hbWVkVHlwZTsKZXhwb3J0cy5jb2VyY2VJZCA9IGNvZXJjZUlkOwpleHBvcnRzLnBhcnNlUmVzcG9uc2VIZWFkZXJzID0gcGFyc2VSZXNwb25zZUhlYWRlcnM7CmV4cG9ydHMuaXNFbmFibGVkID0gaXNFbmFibGVkOwpleHBvcnRzLlJvb3RTdGF0ZSA9IFJvb3RTdGF0ZSQxOwpleHBvcnRzLkludGVybmFsTW9kZWwgPSBJbnRlcm5hbE1vZGVsOwpleHBvcnRzLlByb21pc2VBcnJheSA9IFByb21pc2VBcnJheTsKZXhwb3J0cy5Qcm9taXNlT2JqZWN0ID0gUHJvbWlzZU9iamVjdDsKZXhwb3J0cy5Qcm9taXNlTWFueUFycmF5ID0gUHJvbWlzZU1hbnlBcnJheTsKZXhwb3J0cy5SZWNvcmRBcnJheSA9IFJlY29yZEFycmF5OwpleHBvcnRzLkFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheSA9IEFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheTsKZXhwb3J0cy5NYW55QXJyYXkgPSBNYW55QXJyYXk7CmV4cG9ydHMuUmVjb3JkQXJyYXlNYW5hZ2VyID0gUmVjb3JkQXJyYXlNYW5hZ2VyOwpleHBvcnRzLlJlbGF0aW9uc2hpcCA9IFJlbGF0aW9uc2hpcDsKZXhwb3J0cy5NYXAgPSBNYXBXaXRoRGVwcmVjYXRpb25zOwpleHBvcnRzLk1hcFdpdGhEZWZhdWx0ID0gTWFwV2l0aERlZmF1bHQ7CmV4cG9ydHMuRGVidWdBZGFwdGVyID0gZGVidWdBZGFwdGVyOwpleHBvcnRzLmRpZmZBcnJheSA9IGRpZmZBcnJheTsKZXhwb3J0cy5SZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXIgPSBSZWxhdGlvbnNoaXBQYXlsb2Fkc01hbmFnZXI7CmV4cG9ydHMuUmVsYXRpb25zaGlwUGF5bG9hZHMgPSBSZWxhdGlvbnNoaXBQYXlsb2FkczsKZXhwb3J0cy5TbmFwc2hvdFJlY29yZEFycmF5ID0gU25hcHNob3RSZWNvcmRBcnJheTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7Cgp9KTsKCjtkZWZpbmUoJ2VtYmVyLWRhdGEvYWRhcHRlcicsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5PYmplY3QuZXh0ZW5kKHsKCiAgICAvKioKICAgICAgSWYgeW91IHdvdWxkIGxpa2UgeW91ciBhZGFwdGVyIHRvIHVzZSBhIGN1c3RvbSBzZXJpYWxpemVyIHlvdSBjYW4KICAgICAgc2V0IHRoZSBgZGVmYXVsdFNlcmlhbGl6ZXJgIHByb3BlcnR5IHRvIGJlIHRoZSBuYW1lIG9mIHRoZSBjdXN0b20KICAgICAgc2VyaWFsaXplci4KICAgICAgIE5vdGUgdGhlIGBkZWZhdWx0U2VyaWFsaXplcmAgc2VyaWFsaXplciBoYXMgYSBsb3dlciBwcmlvcml0eSB0aGFuCiAgICAgIGEgbW9kZWwgc3BlY2lmaWMgc2VyaWFsaXplciAoaS5lLiBgUG9zdFNlcmlhbGl6ZXJgKSBvciB0aGUKICAgICAgYGFwcGxpY2F0aW9uYCBzZXJpYWxpemVyLgogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2RqYW5nby5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZGVmYXVsdFNlcmlhbGl6ZXI6ICdkamFuZ28nCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBkZWZhdWx0U2VyaWFsaXplcgogICAgICBAdHlwZSB7U3RyaW5nfQogICAgKi8KICAgIGRlZmF1bHRTZXJpYWxpemVyOiAnLWRlZmF1bHQnLAoKICAgIC8qKgogICAgICBUaGUgYGZpbmRSZWNvcmQoKWAgbWV0aG9kIGlzIGludm9rZWQgd2hlbiB0aGUgc3RvcmUgaXMgYXNrZWQgZm9yIGEgcmVjb3JkIHRoYXQKICAgICAgaGFzIG5vdCBwcmV2aW91c2x5IGJlZW4gbG9hZGVkLiBJbiByZXNwb25zZSB0byBgZmluZFJlY29yZCgpYCBiZWluZyBjYWxsZWQsIHlvdQogICAgICBzaG91bGQgcXVlcnkgeW91ciBwZXJzaXN0ZW5jZSBsYXllciBmb3IgYSByZWNvcmQgd2l0aCB0aGUgZ2l2ZW4gSUQuIFRoZSBgZmluZFJlY29yZGAKICAgICAgbWV0aG9kIHNob3VsZCByZXR1cm4gYSBwcm9taXNlIHRoYXQgd2lsbCByZXNvbHZlIHRvIGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCB3aWxsIGJlCiAgICAgIG5vcm1hbGl6ZWQgYnkgdGhlIHNlcmlhbGl6ZXIuCiAgICAgICBIZXJlIGlzIGFuIGV4YW1wbGUgYGZpbmRSZWNvcmRgIGltcGxlbWVudGF0aW9uOgogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZFJlY29yZChzdG9yZSwgdHlwZSwgaWQsIHNuYXBzaG90KSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgJC5nZXRKU09OKGAvJHt0eXBlLm1vZGVsTmFtZX0vJHtpZH1gKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIHJlamVjdChqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGZpbmRSZWNvcmQKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gaWQKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGZpbmRSZWNvcmQ6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBgZmluZEFsbCgpYCBtZXRob2QgaXMgdXNlZCB0byByZXRyaWV2ZSBhbGwgcmVjb3JkcyBmb3IgYSBnaXZlbiB0eXBlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZmluZEFsbChzdG9yZSwgdHlwZSwgc2luY2VUb2tlbikgewogICAgICAgICAgbGV0IHF1ZXJ5ID0geyBzaW5jZTogc2luY2VUb2tlbiB9OwogICAgICAgICAgIHJldHVybiBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAkLmdldEpTT04oYC8ke3R5cGUubW9kZWxOYW1lfWAsIHF1ZXJ5KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIHJlamVjdChqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGZpbmRBbGwKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge1N0cmluZ30gc2luY2VUb2tlbgogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90UmVjb3JkQXJyYXkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGZpbmRBbGw6IG51bGwsCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHlvdSBjYWxsIGBxdWVyeWAgb24gdGhlIHN0b3JlLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IFJTVlAgZnJvbSAnUlNWUCc7CiAgICAgIGltcG9ydCAkIGZyb20gJ2pxdWVyeSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgcXVlcnkoc3RvcmUsIHR5cGUsIHF1ZXJ5KSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgJC5nZXRKU09OKGAvJHt0eXBlLm1vZGVsTmFtZX1gLCBxdWVyeSkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICByZWplY3QoanFYSFIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBxdWVyeQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSB0eXBlCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBxdWVyeQogICAgICBAcGFyYW0ge0RTLkFkYXB0ZXJQb3B1bGF0ZWRSZWNvcmRBcnJheX0gcmVjb3JkQXJyYXkKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIHF1ZXJ5OiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgYHF1ZXJ5UmVjb3JkKClgIG1ldGhvZCBpcyBpbnZva2VkIHdoZW4gdGhlIHN0b3JlIGlzIGFza2VkIGZvciBhIHNpbmdsZQogICAgICByZWNvcmQgdGhyb3VnaCBhIHF1ZXJ5IG9iamVjdC4KICAgICAgIEluIHJlc3BvbnNlIHRvIGBxdWVyeVJlY29yZCgpYCBiZWluZyBjYWxsZWQsIHlvdSBzaG91bGQgYWx3YXlzIGZldGNoIGZyZXNoCiAgICAgIGRhdGEuIE9uY2UgZm91bmQsIHlvdSBjYW4gYXN5bmNocm9ub3VzbHkgY2FsbCB0aGUgc3RvcmUncyBgcHVzaCgpYCBtZXRob2QKICAgICAgdG8gcHVzaCB0aGUgcmVjb3JkIGludG8gdGhlIHN0b3JlLgogICAgICAgSGVyZSBpcyBhbiBleGFtcGxlIGBxdWVyeVJlY29yZGAgaW1wbGVtZW50YXRpb246CiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgUlNWUCBmcm9tICdSU1ZQJzsKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKERTLkJ1aWxkVVJMTWl4aW4sIHsKICAgICAgICBxdWVyeVJlY29yZChzdG9yZSwgdHlwZSwgcXVlcnkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAkLmdldEpTT04oYC8ke3R5cGUubW9kZWxOYW1lfWAsIHF1ZXJ5KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIHJlamVjdChqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHF1ZXJ5UmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7c3ViY2xhc3Mgb2YgRFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBxdWVyeVJlY29yZDogbnVsbCwKCiAgICAvKioKICAgICAgSWYgdGhlIGdsb2JhbGx5IHVuaXF1ZSBJRHMgZm9yIHlvdXIgcmVjb3JkcyBzaG91bGQgYmUgZ2VuZXJhdGVkIG9uIHRoZSBjbGllbnQsCiAgICAgIGltcGxlbWVudCB0aGUgYGdlbmVyYXRlSWRGb3JSZWNvcmQoKWAgbWV0aG9kLiBUaGlzIG1ldGhvZCB3aWxsIGJlIGludm9rZWQKICAgICAgZWFjaCB0aW1lIHlvdSBjcmVhdGUgYSBuZXcgcmVjb3JkLCBhbmQgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gaXQgd2lsbCBiZQogICAgICBhc3NpZ25lZCB0byB0aGUgcmVjb3JkJ3MgYHByaW1hcnlLZXlgLgogICAgICAgTW9zdCB0cmFkaXRpb25hbCBSRVNULWxpa2UgSFRUUCBBUElzIHdpbGwgbm90IHVzZSB0aGlzIG1ldGhvZC4gSW5zdGVhZCwgdGhlIElECiAgICAgIG9mIHRoZSByZWNvcmQgd2lsbCBiZSBzZXQgYnkgdGhlIHNlcnZlciwgYW5kIHlvdXIgYWRhcHRlciB3aWxsIHVwZGF0ZSB0aGUgc3RvcmUKICAgICAgd2l0aCB0aGUgbmV3IElEIHdoZW4gaXQgY2FsbHMgYGRpZENyZWF0ZVJlY29yZCgpYC4gT25seSBpbXBsZW1lbnQgdGhpcyBtZXRob2QgaWYKICAgICAgeW91IGludGVuZCB0byBnZW5lcmF0ZSByZWNvcmQgSURzIG9uIHRoZSBjbGllbnQtc2lkZS4KICAgICAgIFRoZSBgZ2VuZXJhdGVJZEZvclJlY29yZCgpYCBtZXRob2Qgd2lsbCBiZSBpbnZva2VkIHdpdGggdGhlIHJlcXVlc3Rpbmcgc3RvcmUgYXMKICAgICAgdGhlIGZpcnN0IHBhcmFtZXRlciBhbmQgdGhlIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIGFzIHRoZSBzZWNvbmQgcGFyYW1ldGVyOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGltcG9ydCB7IHY0IH0gZnJvbSAndXVpZCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5BZGFwdGVyLmV4dGVuZCh7CiAgICAgICAgZ2VuZXJhdGVJZEZvclJlY29yZChzdG9yZSwgaW5wdXRQcm9wZXJ0aWVzKSB7CiAgICAgICAgICByZXR1cm4gdjQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgZ2VuZXJhdGVJZEZvclJlY29yZAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgICAgQHBhcmFtIHtPYmplY3R9IGlucHV0UHJvcGVydGllcyBhIGhhc2ggb2YgcHJvcGVydGllcyB0byBzZXQgb24gdGhlCiAgICAgICAgbmV3bHkgY3JlYXRlZCByZWNvcmQuCiAgICAgIEByZXR1cm4geyhTdHJpbmd8TnVtYmVyKX0gaWQKICAgICovCiAgICBnZW5lcmF0ZUlkRm9yUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBQcm94aWVzIHRvIHRoZSBzZXJpYWxpemVyJ3MgYHNlcmlhbGl6ZWAgbWV0aG9kLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICBsZXQgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHNuYXBzaG90LCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICAgIGxldCB1cmwgPSBgLyR7dHlwZS5tb2RlbE5hbWV9YDsKICAgICAgICAgICAvLyAuLi4KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSAgIG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBzZXJpYWxpemVkIHNuYXBzaG90CiAgICAqLwogICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBzbmFwc2hvdC5zZXJpYWxpemUob3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICBJbXBsZW1lbnQgdGhpcyBtZXRob2QgaW4gYSBzdWJjbGFzcyB0byBoYW5kbGUgdGhlIGNyZWF0aW9uIG9mCiAgICAgIG5ldyByZWNvcmRzLgogICAgICAgU2VyaWFsaXplcyB0aGUgcmVjb3JkIGFuZCBzZW5kcyBpdCB0byB0aGUgc2VydmVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgcnVuIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogICAgICBpbXBvcnQgUlNWUCBmcm9tICdSU1ZQJzsKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBjcmVhdGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICBsZXQgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHNuYXBzaG90LCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICAgICByZXR1cm4gbmV3IFJTVlAuUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICB0eXBlOiAnUE9TVCcsCiAgICAgICAgICAgICAgdXJsOiBgLyR7dHlwZS5tb2RlbE5hbWV9YCwKICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcnVuKG51bGwsIHJlc29sdmUsIGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIGpxWEhSLnRoZW4gPSBudWxsOyAvLyB0YW1lIGpRdWVyeSdzIGlsbCBtYW5uZXJlZCBwcm9taXNlcwogICAgICAgICAgICAgIHJ1bihudWxsLCByZWplY3QsIGpxWEhSKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUgICB0aGUgRFMuTW9kZWwgY2xhc3Mgb2YgdGhlIHJlY29yZAogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgY3JlYXRlUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBJbXBsZW1lbnQgdGhpcyBtZXRob2QgaW4gYSBzdWJjbGFzcyB0byBoYW5kbGUgdGhlIHVwZGF0aW5nIG9mCiAgICAgIGEgcmVjb3JkLgogICAgICAgU2VyaWFsaXplcyB0aGUgcmVjb3JkIHVwZGF0ZSBhbmQgc2VuZHMgaXQgdG8gdGhlIHNlcnZlci4KICAgICAgIFRoZSB1cGRhdGVSZWNvcmQgbWV0aG9kIGlzIGV4cGVjdGVkIHRvIHJldHVybiBhIHByb21pc2UgdGhhdCB3aWxsCiAgICAgIHJlc29sdmUgd2l0aCB0aGUgc2VyaWFsaXplZCByZWNvcmQuIFRoaXMgYWxsb3dzIHRoZSBiYWNrZW5kIHRvCiAgICAgIGluZm9ybSB0aGUgRW1iZXIgRGF0YSBzdG9yZSB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGlzIHJlY29yZCBhZnRlcgogICAgICB0aGUgdXBkYXRlLiBJZiBpdCBpcyBub3QgcG9zc2libGUgdG8gcmV0dXJuIGEgc2VyaWFsaXplZCByZWNvcmQKICAgICAgdGhlIHVwZGF0ZVJlY29yZCBwcm9taXNlIGNhbiBhbHNvIHJlc29sdmUgd2l0aCBgdW5kZWZpbmVkYCBhbmQgdGhlCiAgICAgIEVtYmVyIERhdGEgc3RvcmUgd2lsbCBhc3N1bWUgYWxsIG9mIHRoZSB1cGRhdGVzIHdlcmUgc3VjY2Vzc2Z1bGx5CiAgICAgIGFwcGxpZWQgb24gdGhlIGJhY2tlbmQuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyBydW4gfSBmcm9tICdAZW1iZXIvcnVubG9vcCc7CiAgICAgIGltcG9ydCBSU1ZQIGZyb20gJ1JTVlAnOwogICAgICBpbXBvcnQgJCBmcm9tICdqcXVlcnknOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuQWRhcHRlci5leHRlbmQoewogICAgICAgIHVwZGF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgICAgIGxldCBkYXRhID0gdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwogICAgICAgICAgbGV0IGlkID0gc25hcHNob3QuaWQ7CiAgICAgICAgICAgcmV0dXJuIG5ldyBSU1ZQLlByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICQuYWpheCh7CiAgICAgICAgICAgICAgdHlwZTogJ1BVVCcsCiAgICAgICAgICAgICAgdXJsOiBgLyR7dHlwZS5tb2RlbE5hbWV9LyR7aWR9YCwKICAgICAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgcnVuKG51bGwsIHJlc29sdmUsIGRhdGEpOwogICAgICAgICAgICB9LCBmdW5jdGlvbihqcVhIUikgewogICAgICAgICAgICAgIGpxWEhSLnRoZW4gPSBudWxsOyAvLyB0YW1lIGpRdWVyeSdzIGlsbCBtYW5uZXJlZCBwcm9taXNlcwogICAgICAgICAgICAgIHJ1bihudWxsLCByZWplY3QsIGpxWEhSKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUgICB0aGUgRFMuTW9kZWwgY2xhc3Mgb2YgdGhlIHJlY29yZAogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgdXBkYXRlUmVjb3JkOiBudWxsLAoKICAgIC8qKgogICAgICBJbXBsZW1lbnQgdGhpcyBtZXRob2QgaW4gYSBzdWJjbGFzcyB0byBoYW5kbGUgdGhlIGRlbGV0aW9uIG9mCiAgICAgIGEgcmVjb3JkLgogICAgICAgU2VuZHMgYSBkZWxldGUgcmVxdWVzdCBmb3IgdGhlIHJlY29yZCB0byB0aGUgc2VydmVyLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgcnVuIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogICAgICBpbXBvcnQgUlNWUCBmcm9tICdSU1ZQJzsKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBkZWxldGVSZWNvcmQoc3RvcmUsIHR5cGUsIHNuYXBzaG90KSB7CiAgICAgICAgICBsZXQgZGF0YSA9IHRoaXMuc2VyaWFsaXplKHNuYXBzaG90LCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKICAgICAgICAgIGxldCBpZCA9IHNuYXBzaG90LmlkOwogICAgICAgICAgIHJldHVybiBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgIHR5cGU6ICdERUxFVEUnLAogICAgICAgICAgICAgIHVybDogYC8ke3R5cGUubW9kZWxOYW1lfS8ke2lkfWAsCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICdqc29uJywKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHJ1bihudWxsLCByZXNvbHZlLCBkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgICBydW4obnVsbCwgcmVqZWN0LCBqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGRlbGV0ZVJlY29yZAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSB0eXBlICAgdGhlIERTLk1vZGVsIGNsYXNzIG9mIHRoZSByZWNvcmQKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGRlbGV0ZVJlY29yZDogbnVsbCwKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCB0aGUgc3RvcmUgd2lsbCB0cnkgdG8gY29hbGVzY2UgYWxsIGBmZXRjaFJlY29yZGAgY2FsbHMgd2l0aGluIHRoZSBzYW1lIHJ1bmxvb3AKICAgICAgaW50byBhcyBmZXcgcmVxdWVzdHMgYXMgcG9zc2libGUgYnkgY2FsbGluZyBncm91cFJlY29yZHNGb3JGaW5kTWFueSBhbmQgcGFzc2luZyBpdCBpbnRvIGEgZmluZE1hbnkgY2FsbC4KICAgICAgWW91IGNhbiBvcHQgb3V0IG9mIHRoaXMgYmVoYXZpb3VyIGJ5IGVpdGhlciBub3QgaW1wbGVtZW50aW5nIHRoZSBmaW5kTWFueSBob29rIG9yIGJ5IHNldHRpbmcKICAgICAgY29hbGVzY2VGaW5kUmVxdWVzdHMgdG8gZmFsc2UuCiAgICAgICBAcHJvcGVydHkgY29hbGVzY2VGaW5kUmVxdWVzdHMKICAgICAgQHR5cGUge2Jvb2xlYW59CiAgICAqLwogICAgY29hbGVzY2VGaW5kUmVxdWVzdHM6IHRydWUsCgogICAgLyoqCiAgICAgIFRoZSBzdG9yZSB3aWxsIGNhbGwgYGZpbmRNYW55YCBpbnN0ZWFkIG9mIG11bHRpcGxlIGBmaW5kUmVjb3JkYAogICAgICByZXF1ZXN0cyB0byBmaW5kIG11bHRpcGxlIHJlY29yZHMgYXQgb25jZSBpZiBjb2FsZXNjZUZpbmRSZXF1ZXN0cwogICAgICBpcyB0cnVlLgogICAgICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgcnVuIH0gZnJvbSAnQGVtYmVyL3J1bmxvb3AnOwogICAgICBpbXBvcnQgUlNWUCBmcm9tICdSU1ZQJzsKICAgICAgaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBmaW5kTWFueShzdG9yZSwgdHlwZSwgaWRzLCBzbmFwc2hvdHMpIHsKICAgICAgICAgIHJldHVybiBuZXcgUlNWUC5Qcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgIHR5cGU6ICdHRVQnLAogICAgICAgICAgICAgIHVybDogYC8ke3R5cGUubW9kZWxOYW1lfS9gLAogICAgICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsCiAgICAgICAgICAgICAgZGF0YTogeyBmaWx0ZXI6IHsgaWQ6IGlkcy5qb2luKCcsJykgfSB9CiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHJ1bihudWxsLCByZXNvbHZlLCBkYXRhKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oanFYSFIpIHsKICAgICAgICAgICAgICBqcVhIUi50aGVuID0gbnVsbDsgLy8gdGFtZSBqUXVlcnkncyBpbGwgbWFubmVyZWQgcHJvbWlzZXMKICAgICAgICAgICAgICBydW4obnVsbCwgcmVqZWN0LCBqcVhIUik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGZpbmRNYW55CiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUgICB0aGUgRFMuTW9kZWwgY2xhc3Mgb2YgdGhlIHJlY29yZHMKICAgICAgQHBhcmFtIHtBcnJheX0gICAgaWRzCiAgICAgIEBwYXJhbSB7QXJyYXl9IHNuYXBzaG90cwogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgZmluZE1hbnk6IG51bGwsCgogICAgLyoqCiAgICAgIE9yZ2FuaXplIHJlY29yZHMgaW50byBncm91cHMsIGVhY2ggb2Ygd2hpY2ggaXMgdG8gYmUgcGFzc2VkIHRvIHNlcGFyYXRlCiAgICAgIGNhbGxzIHRvIGBmaW5kTWFueWAuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91ciBhcGkgaGFzIG5lc3RlZCBVUkxzIHRoYXQgZGVwZW5kIG9uIHRoZSBwYXJlbnQsIHlvdSB3aWxsCiAgICAgIHdhbnQgdG8gZ3JvdXAgcmVjb3JkcyBieSB0aGVpciBwYXJlbnQuCiAgICAgICBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiByZXR1cm5zIHRoZSByZWNvcmRzIGFzIGEgc2luZ2xlIGdyb3VwLgogICAgICAgQG1ldGhvZCBncm91cFJlY29yZHNGb3JGaW5kTWFueQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0FycmF5fSBzbmFwc2hvdHMKICAgICAgQHJldHVybiB7QXJyYXl9ICBhbiBhcnJheSBvZiBhcnJheXMgb2YgcmVjb3JkcywgZWFjaCBvZiB3aGljaCBpcyB0byBiZQogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWQgc2VwYXJhdGVseSBieSBgZmluZE1hbnlgLgogICAgKi8KICAgIGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHN0b3JlLCBzbmFwc2hvdHMpIHsKICAgICAgcmV0dXJuIFtzbmFwc2hvdHNdOwogICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCBieSB0aGUgc3RvcmUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBzdG9yZSBzaG91bGQKICAgICAgcmVsb2FkIGEgcmVjb3JkIGZyb20gdGhlIGFkYXB0ZXIgd2hlbiBhIHJlY29yZCBpcyByZXF1ZXN0ZWQgYnkKICAgICAgYHN0b3JlLmZpbmRSZWNvcmRgLgogICAgICAgSWYgdGhpcyBtZXRob2QgcmV0dXJucyBgdHJ1ZWAsIHRoZSBzdG9yZSB3aWxsIHJlLWZldGNoIGEgcmVjb3JkIGZyb20KICAgICAgdGhlIGFkYXB0ZXIuIElmIHRoaXMgbWV0aG9kIHJldHVybnMgYGZhbHNlYCwgdGhlIHN0b3JlIHdpbGwgcmVzb2x2ZQogICAgICBpbW1lZGlhdGVseSB1c2luZyB0aGUgY2FjaGVkIHJlY29yZC4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3UgYXJlIGJ1aWxkaW5nIGFuIGV2ZW50cyB0aWNrZXRpbmcgc3lzdGVtLCBpbiB3aGljaCB1c2VycwogICAgICBjYW4gb25seSByZXNlcnZlIHRpY2tldHMgZm9yIDIwIG1pbnV0ZXMgYXQgYSB0aW1lLCBhbmQgd2FudCB0byBlbnN1cmUgdGhhdAogICAgICBpbiBlYWNoIHJvdXRlIHlvdSBoYXZlIGRhdGEgdGhhdCBpcyBubyBtb3JlIHRoYW4gMjAgbWludXRlcyBvbGQgeW91IGNvdWxkCiAgICAgIHdyaXRlOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzaG91bGRSZWxvYWRSZWNvcmQoc3RvcmUsIHRpY2tldFNuYXBzaG90KSB7CiAgICAgICAgbGV0IGxhc3RBY2Nlc3NlZEF0ID0gdGlja2V0U25hcHNob3QuYXR0cignbGFzdEFjY2Vzc2VkQXQnKTsKICAgICAgICBsZXQgdGltZURpZmYgPSBtb21lbnQoKS5kaWZmKGxhc3RBY2Nlc3NlZEF0LCAnbWludXRlcycpOwogICAgICAgICBpZiAodGltZURpZmYgPiAyMCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUaGlzIG1ldGhvZCB3b3VsZCBlbnN1cmUgdGhhdCB3aGVuZXZlciB5b3UgZG8gYHN0b3JlLmZpbmRSZWNvcmQoJ3RpY2tldCcsCiAgICAgIGlkKWAgeW91IHdpbGwgYWx3YXlzIGdldCBhIHRpY2tldCB0aGF0IGlzIG5vIG1vcmUgdGhhbiAyMCBtaW51dGVzIG9sZC4gSW4KICAgICAgY2FzZSB0aGUgY2FjaGVkIHZlcnNpb24gaXMgbW9yZSB0aGFuIDIwIG1pbnV0ZXMgb2xkLCBgZmluZFJlY29yZGAgd2lsbCBub3QKICAgICAgcmVzb2x2ZSB1bnRpbCB5b3UgZmV0Y2hlZCB0aGUgbGF0ZXN0IHZlcnNpb24uCiAgICAgICBCeSBkZWZhdWx0IHRoaXMgaG9vayByZXR1cm5zIGBmYWxzZWAsIGFzIG1vc3QgVUlzIHNob3VsZCBub3QgYmxvY2sgdXNlcgogICAgICBpbnRlcmFjdGlvbnMgd2hpbGUgd2FpdGluZyBvbiBkYXRhIHVwZGF0ZS4KICAgICAgIE5vdGUgdGhhdCwgd2l0aCBkZWZhdWx0IHNldHRpbmdzLCBgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZGAgd2lsbCBhbHdheXMKICAgICAgcmUtZmV0Y2ggdGhlIHJlY29yZHMgaW4gdGhlIGJhY2tncm91bmQgZXZlbiBpZiBgc2hvdWxkUmVsb2FkUmVjb3JkYCByZXR1cm5zCiAgICAgIGBmYWxzZWAuIFlvdSBjYW4gb3ZlcnJpZGUgYHNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmRgIGlmIHRoaXMgZG9lcyBub3QKICAgICAgc3VpdCB5b3VyIHVzZSBjYXNlLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIHNob3VsZFJlbG9hZFJlY29yZAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgKi8KICAgIHNob3VsZFJlbG9hZFJlY29yZChzdG9yZSwgc25hcHNob3QpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCBieSB0aGUgc3RvcmUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBzdG9yZSBzaG91bGQKICAgICAgcmVsb2FkIGFsbCByZWNvcmRzIGZyb20gdGhlIGFkYXB0ZXIgd2hlbiByZWNvcmRzIGFyZSByZXF1ZXN0ZWQgYnkKICAgICAgYHN0b3JlLmZpbmRBbGxgLgogICAgICAgSWYgdGhpcyBtZXRob2QgcmV0dXJucyBgdHJ1ZWAsIHRoZSBzdG9yZSB3aWxsIHJlLWZldGNoIGFsbCByZWNvcmRzIGZyb20KICAgICAgdGhlIGFkYXB0ZXIuIElmIHRoaXMgbWV0aG9kIHJldHVybnMgYGZhbHNlYCwgdGhlIHN0b3JlIHdpbGwgcmVzb2x2ZQogICAgICBpbW1lZGlhdGVseSB1c2luZyB0aGUgY2FjaGVkIHJlY29yZHMuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGFyZSBidWlsZGluZyBhbiBldmVudHMgdGlja2V0aW5nIHN5c3RlbSwgaW4gd2hpY2ggdXNlcnMKICAgICAgY2FuIG9ubHkgcmVzZXJ2ZSB0aWNrZXRzIGZvciAyMCBtaW51dGVzIGF0IGEgdGltZSwgYW5kIHdhbnQgdG8gZW5zdXJlIHRoYXQKICAgICAgaW4gZWFjaCByb3V0ZSB5b3UgaGF2ZSBkYXRhIHRoYXQgaXMgbm8gbW9yZSB0aGFuIDIwIG1pbnV0ZXMgb2xkIHlvdSBjb3VsZAogICAgICB3cml0ZToKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc2hvdWxkUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdEFycmF5KSB7CiAgICAgICAgbGV0IHNuYXBzaG90cyA9IHNuYXBzaG90QXJyYXkuc25hcHNob3RzKCk7CiAgICAgICAgIHJldHVybiBzbmFwc2hvdHMuYW55KCh0aWNrZXRTbmFwc2hvdCkgPT4gewogICAgICAgICAgbGV0IGxhc3RBY2Nlc3NlZEF0ID0gdGlja2V0U25hcHNob3QuYXR0cignbGFzdEFjY2Vzc2VkQXQnKTsKICAgICAgICAgIGxldCB0aW1lRGlmZiA9IG1vbWVudCgpLmRpZmYobGFzdEFjY2Vzc2VkQXQsICdtaW51dGVzJyk7CiAgICAgICAgICAgaWYgKHRpbWVEaWZmID4gMjApIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUaGlzIG1ldGhvZCB3b3VsZCBlbnN1cmUgdGhhdCB3aGVuZXZlciB5b3UgZG8gYHN0b3JlLmZpbmRBbGwoJ3RpY2tldCcpYCB5b3UKICAgICAgd2lsbCBhbHdheXMgZ2V0IGEgbGlzdCBvZiB0aWNrZXRzIHRoYXQgYXJlIG5vIG1vcmUgdGhhbiAyMCBtaW51dGVzIG9sZC4gSW4KICAgICAgY2FzZSBhIGNhY2hlZCB2ZXJzaW9uIGlzIG1vcmUgdGhhbiAyMCBtaW51dGVzIG9sZCwgYGZpbmRBbGxgIHdpbGwgbm90CiAgICAgIHJlc29sdmUgdW50aWwgeW91IGZldGNoZWQgdGhlIGxhdGVzdCB2ZXJzaW9ucy4KICAgICAgIEJ5IGRlZmF1bHQgdGhpcyBtZXRob2RzIHJldHVybnMgYHRydWVgIGlmIHRoZSBwYXNzZWQgYHNuYXBzaG90UmVjb3JkQXJyYXlgCiAgICAgIGlzIGVtcHR5IChtZWFuaW5nIHRoYXQgdGhlcmUgYXJlIG5vIHJlY29yZHMgbG9jYWxseSBhdmFpbGFibGUgeWV0KSwKICAgICAgb3RoZXJ3aXNlIGl0IHJldHVybnMgYGZhbHNlYC4KICAgICAgIE5vdGUgdGhhdCwgd2l0aCBkZWZhdWx0IHNldHRpbmdzLCBgc2hvdWxkQmFja2dyb3VuZFJlbG9hZEFsbGAgd2lsbCBhbHdheXMKICAgICAgcmUtZmV0Y2ggYWxsIHRoZSByZWNvcmRzIGluIHRoZSBiYWNrZ3JvdW5kIGV2ZW4gaWYgYHNob3VsZFJlbG9hZEFsbGAgcmV0dXJucwogICAgICBgZmFsc2VgLiBZb3UgY2FuIG92ZXJyaWRlIGBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsYCBpZiB0aGlzIGRvZXMgbm90IHN1aXQKICAgICAgeW91ciB1c2UgY2FzZS4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBzaG91bGRSZWxvYWRBbGwKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdFJlY29yZEFycmF5fSBzbmFwc2hvdFJlY29yZEFycmF5CiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgc2hvdWxkUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgIHJldHVybiAhc25hcHNob3RSZWNvcmRBcnJheS5sZW5ndGg7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIGJ5IHRoZSBzdG9yZSB0byBkZXRlcm1pbmUgaWYgdGhlIHN0b3JlIHNob3VsZAogICAgICByZWxvYWQgYSByZWNvcmQgYWZ0ZXIgdGhlIGBzdG9yZS5maW5kUmVjb3JkYCBtZXRob2QgcmVzb2x2ZXMgYQogICAgICBjYWNoZWQgcmVjb3JkLgogICAgICAgVGhpcyBtZXRob2QgaXMgKm9ubHkqIGNoZWNrZWQgYnkgdGhlIHN0b3JlIHdoZW4gdGhlIHN0b3JlIGlzCiAgICAgIHJldHVybmluZyBhIGNhY2hlZCByZWNvcmQuCiAgICAgICBJZiB0aGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYCB0aGUgc3RvcmUgd2lsbCByZS1mZXRjaCBhIHJlY29yZCBmcm9tCiAgICAgIHRoZSBhZGFwdGVyLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBkbyBub3Qgd2FudCB0byBmZXRjaCBjb21wbGV4IGRhdGEgb3ZlciBhIG1vYmlsZQogICAgICBjb25uZWN0aW9uLCBvciBpZiB0aGUgbmV0d29yayBpcyBkb3duLCB5b3UgY2FuIGltcGxlbWVudAogICAgICBgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZGAgYXMgZm9sbG93czoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZChzdG9yZSwgc25hcHNob3QpIHsKICAgICAgICBsZXQgY29ubmVjdGlvbiA9IHdpbmRvdy5uYXZpZ2F0b3IuY29ubmVjdGlvbjsKICAgICAgICAgaWYgKGNvbm5lY3Rpb24gPT09ICdjZWxsdWxhcicgfHwgY29ubmVjdGlvbiA9PT0gJ25vbmUnKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIEJ5IGRlZmF1bHQgdGhpcyBob29rIHJldHVybnMgYHRydWVgIHNvIHRoZSBkYXRhIGZvciB0aGUgcmVjb3JkIGlzIHVwZGF0ZWQKICAgICAgaW4gdGhlIGJhY2tncm91bmQuCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgc2hvdWxkQmFja2dyb3VuZFJlbG9hZFJlY29yZAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtCb29sZWFufQogICAgKi8KICAgIHNob3VsZEJhY2tncm91bmRSZWxvYWRSZWNvcmQoc3RvcmUsIHNuYXBzaG90KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKioKICAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCBieSB0aGUgc3RvcmUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBzdG9yZSBzaG91bGQKICAgICAgcmVsb2FkIGEgcmVjb3JkIGFycmF5IGFmdGVyIHRoZSBgc3RvcmUuZmluZEFsbGAgbWV0aG9kIHJlc29sdmVzCiAgICAgIHdpdGggYSBjYWNoZWQgcmVjb3JkIGFycmF5LgogICAgICAgVGhpcyBtZXRob2QgaXMgKm9ubHkqIGNoZWNrZWQgYnkgdGhlIHN0b3JlIHdoZW4gdGhlIHN0b3JlIGlzCiAgICAgIHJldHVybmluZyBhIGNhY2hlZCByZWNvcmQgYXJyYXkuCiAgICAgICBJZiB0aGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYCB0aGUgc3RvcmUgd2lsbCByZS1mZXRjaCBhbGwgcmVjb3JkcwogICAgICBmcm9tIHRoZSBhZGFwdGVyLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBkbyBub3Qgd2FudCB0byBmZXRjaCBjb21wbGV4IGRhdGEgb3ZlciBhIG1vYmlsZQogICAgICBjb25uZWN0aW9uLCBvciBpZiB0aGUgbmV0d29yayBpcyBkb3duLCB5b3UgY2FuIGltcGxlbWVudAogICAgICBgc2hvdWxkQmFja2dyb3VuZFJlbG9hZEFsbGAgYXMgZm9sbG93czoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgc2hvdWxkQmFja2dyb3VuZFJlbG9hZEFsbChzdG9yZSwgc25hcHNob3RBcnJheSkgewogICAgICAgIGxldCBjb25uZWN0aW9uID0gd2luZG93Lm5hdmlnYXRvci5jb25uZWN0aW9uOwogICAgICAgICBpZiAoY29ubmVjdGlvbiA9PT0gJ2NlbGx1bGFyJyB8fCBjb25uZWN0aW9uID09PSAnbm9uZScpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQnkgZGVmYXVsdCB0aGlzIG1ldGhvZCByZXR1cm5zIGB0cnVlYCwgaW5kaWNhdGluZyB0aGF0IGEgYmFja2dyb3VuZCByZWxvYWQKICAgICAgc2hvdWxkIGFsd2F5cyBiZSB0cmlnZ2VyZWQuCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgc2hvdWxkQmFja2dyb3VuZFJlbG9hZEFsbAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90UmVjb3JkQXJyYXl9IHNuYXBzaG90UmVjb3JkQXJyYXkKICAgICAgQHJldHVybiB7Qm9vbGVhbn0KICAgICovCiAgICBzaG91bGRCYWNrZ3JvdW5kUmVsb2FkQWxsKHN0b3JlLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9hZGFwdGVycy9lcnJvcnMnLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS8tcHJpdmF0ZSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3ByaXZhdGUpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdBZGFwdGVyRXJyb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5BZGFwdGVyRXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdJbnZhbGlkRXJyb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5JbnZhbGlkRXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdVbmF1dGhvcml6ZWRFcnJvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLlVuYXV0aG9yaXplZEVycm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnRm9yYmlkZGVuRXJyb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5Gb3JiaWRkZW5FcnJvcjsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ05vdEZvdW5kRXJyb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5Ob3RGb3VuZEVycm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQ29uZmxpY3RFcnJvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLkNvbmZsaWN0RXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdTZXJ2ZXJFcnJvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLlNlcnZlckVycm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnVGltZW91dEVycm9yJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3ByaXZhdGUuVGltZW91dEVycm9yOwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnQWJvcnRFcnJvcicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLkFib3J0RXJyb3I7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdlcnJvcnNIYXNoVG9BcnJheScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLmVycm9yc0hhc2hUb0FycmF5OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnZXJyb3JzQXJyYXlUb0hhc2gnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5lcnJvcnNBcnJheVRvSGFzaDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvYWRhcHRlcnMvanNvbi1hcGknLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS9hZGFwdGVycy9yZXN0JywgJ2VtYmVyLWluZmxlY3RvciddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3Jlc3QsIF9lbWJlckluZmxlY3RvcikgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKCgogIC8qKgogICAgVGhlIGBKU09OQVBJQWRhcHRlcmAgaXMgdGhlIGRlZmF1bHQgYWRhcHRlciB1c2VkIGJ5IEVtYmVyIERhdGEuIEl0CiAgICBpcyByZXNwb25zaWJsZSBmb3IgdHJhbnNmb3JtaW5nIHRoZSBzdG9yZSdzIHJlcXVlc3RzIGludG8gSFRUUAogICAgcmVxdWVzdHMgdGhhdCBmb2xsb3cgdGhlIFtKU09OIEFQSV0oaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8pCiAgICBmb3JtYXQuCiAgCiAgICAjIyBKU09OIEFQSSBDb252ZW50aW9ucwogIAogICAgVGhlIEpTT05BUElBZGFwdGVyIHVzZXMgSlNPTiBBUEkgY29udmVudGlvbnMgZm9yIGJ1aWxkaW5nIHRoZSB1cmwKICAgIGZvciBhIHJlY29yZCBhbmQgc2VsZWN0aW5nIHRoZSBIVFRQIHZlcmIgdG8gdXNlIHdpdGggYSByZXF1ZXN0LiBUaGUKICAgIGFjdGlvbnMgeW91IGNhbiB0YWtlIG9uIGEgcmVjb3JkIG1hcCBvbnRvIHRoZSBmb2xsb3dpbmcgVVJMcyBpbiB0aGUKICAgIEpTT04gQVBJIGFkYXB0ZXI6CiAgCiAgPHRhYmxlPgogICAgPHRyPgogICAgICA8dGg+CiAgICAgICAgQWN0aW9uCiAgICAgIDwvdGg+CiAgICAgIDx0aD4KICAgICAgICBIVFRQIFZlcmIKICAgICAgPC90aD4KICAgICAgPHRoPgogICAgICAgIFVSTAogICAgICA8L3RoPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIGBzdG9yZS5maW5kUmVjb3JkKCdwb3N0JywgMTIzKWAKICAgICAgPC90aD4KICAgICAgPHRkPgogICAgICAgIEdFVAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIGBzdG9yZS5maW5kQWxsKCdwb3N0JylgCiAgICAgIDwvdGg+CiAgICAgIDx0ZD4KICAgICAgICBHRVQKICAgICAgPC90ZD4KICAgICAgPHRkPgogICAgICAgIC9wb3N0cwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIFVwZGF0ZSBgcG9zdFJlY29yZC5zYXZlKClgCiAgICAgIDwvdGg+CiAgICAgIDx0ZD4KICAgICAgICBQQVRDSAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICAgIDx0cj4KICAgICAgPHRoPgogICAgICAgIENyZWF0ZSBgc3RvcmUuY3JlYXRlUmVjb3JkKCdwb3N0Jykuc2F2ZSgpYAogICAgICA8L3RoPgogICAgICA8dGQ+CiAgICAgICAgUE9TVAogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzCiAgICAgIDwvdGQ+CiAgICA8L3RyPgogICAgPHRyPgogICAgICA8dGg+CiAgICAgICAgRGVsZXRlIGBwb3N0UmVjb3JkLmRlc3Ryb3lSZWNvcmQoKWAKICAgICAgPC90aD4KICAgICAgPHRkPgogICAgICAgIERFTEVURQogICAgICA8L3RkPgogICAgICA8dGQ+CiAgICAgICAgL3Bvc3RzLzEyMwogICAgICA8L3RkPgogICAgPC90cj4KICA8L3RhYmxlPgogIAogICAgIyMgU3VjY2VzcyBhbmQgZmFpbHVyZQogIAogICAgVGhlIEpTT05BUElBZGFwdGVyIHdpbGwgY29uc2lkZXIgYSBzdWNjZXNzIGFueSByZXNwb25zZSB3aXRoIGEKICAgIHN0YXR1cyBjb2RlIG9mIHRoZSAyeHggZmFtaWx5ICgiU3VjY2VzcyIpLCBhcyB3ZWxsIGFzIDMwNCAoIk5vdAogICAgTW9kaWZpZWQiKS4gQW55IG90aGVyIHN0YXR1cyBjb2RlIHdpbGwgYmUgY29uc2lkZXJlZCBhIGZhaWx1cmUuCiAgCiAgICBPbiBzdWNjZXNzLCB0aGUgcmVxdWVzdCBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgZnVsbAogICAgcmVzcG9uc2UgcGF5bG9hZC4KICAKICAgIEZhaWxlZCByZXNwb25zZXMgd2l0aCBzdGF0dXMgY29kZSA0MjIgKCJVbnByb2Nlc3NhYmxlIEVudGl0eSIpIHdpbGwKICAgIGJlIGNvbnNpZGVyZWQgImludmFsaWQiLiBUaGUgcmVzcG9uc2Ugd2lsbCBiZSBkaXNjYXJkZWQsIGV4Y2VwdCBmb3IKICAgIHRoZSBgZXJyb3JzYCBrZXkuIFRoZSByZXF1ZXN0IHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoIGEKICAgIGBEUy5JbnZhbGlkRXJyb3JgLiBUaGlzIGVycm9yIG9iamVjdCB3aWxsIGVuY2Fwc3VsYXRlIHRoZSBzYXZlZAogICAgYGVycm9yc2AgdmFsdWUuCiAgCiAgICBBbnkgb3RoZXIgc3RhdHVzIGNvZGVzIHdpbGwgYmUgdHJlYXRlZCBhcyBhbiBhZGFwdGVyIGVycm9yLiBUaGUKICAgIHJlcXVlc3QgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkLCBzaW1pbGFybHkgdG8gdGhlIGludmFsaWQgY2FzZSwKICAgIGJ1dCB3aXRoIGFuIGluc3RhbmNlIG9mIGBEUy5BZGFwdGVyRXJyb3JgIGluc3RlYWQuCiAgCiAgICAjIyMgRW5kcG9pbnQgcGF0aCBjdXN0b21pemF0aW9uCiAgCiAgICBFbmRwb2ludCBwYXRocyBjYW4gYmUgcHJlZml4ZWQgd2l0aCBhIGBuYW1lc3BhY2VgIGJ5IHNldHRpbmcgdGhlCiAgICBuYW1lc3BhY2UgcHJvcGVydHkgb24gdGhlIGFkYXB0ZXI6CiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgIG5hbWVzcGFjZTogJ2FwaS8xJwogICAgfSk7CiAgICBgYGAKICAgIFJlcXVlc3RzIGZvciB0aGUgYHBlcnNvbmAgbW9kZWwgd291bGQgbm93IHRhcmdldCBgL2FwaS8xL3Blb3BsZS8xYC4KICAKICAgICMjIyBIb3N0IGN1c3RvbWl6YXRpb24KICAKICAgIEFuIGFkYXB0ZXIgY2FuIHRhcmdldCBvdGhlciBob3N0cyBieSBzZXR0aW5nIHRoZSBgaG9zdGAgcHJvcGVydHkuCiAgCiAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05BUElBZGFwdGVyLmV4dGVuZCh7CiAgICAgIGhvc3Q6ICdodHRwczovL2FwaS5leGFtcGxlLmNvbScKICAgIH0pOwogICAgYGBgCiAgCiAgICBSZXF1ZXN0cyBmb3IgdGhlIGBwZXJzb25gIG1vZGVsIHdvdWxkIG5vdyB0YXJnZXQKICAgIGBodHRwczovL2FwaS5leGFtcGxlLmNvbS9wZW9wbGUvMWAuCiAgCiAgICBAc2luY2UgMS4xMy4wCiAgICBAY2xhc3MgSlNPTkFQSUFkYXB0ZXIKICAgIEBjb25zdHJ1Y3RvcgogICAgQG5hbWVzcGFjZSBEUwogICAgQGV4dGVuZHMgRFMuUkVTVEFkYXB0ZXIKICAqLwogIHZhciBKU09OQVBJQWRhcHRlciA9IF9yZXN0LmRlZmF1bHQuZXh0ZW5kKHsKICAgIGRlZmF1bHRTZXJpYWxpemVyOiAnLWpzb24tYXBpJywKCiAgICAvKioKICAgICAgQG1ldGhvZCBhamF4T3B0aW9ucwogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSByZXF1ZXN0IHR5cGUgR0VULCBQT1NULCBQVVQsIERFTEVURSBldGMuCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBhamF4T3B0aW9ucyh1cmwsIHR5cGUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGhhc2ggPSB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwoKICAgICAgaWYgKGhhc2guY29udGVudFR5cGUpIHsKICAgICAgICBoYXNoLmNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL3ZuZC5hcGkranNvbic7CiAgICAgIH0KCiAgICAgIHZhciBiZWZvcmVTZW5kID0gaGFzaC5iZWZvcmVTZW5kOwogICAgICBoYXNoLmJlZm9yZVNlbmQgPSBmdW5jdGlvbiAoeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi92bmQuYXBpK2pzb24nKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgewogICAgICAgICAgYmVmb3JlU2VuZCh4aHIpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBoYXNoOwogICAgfSwKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCB0aGUgSlNPTkFQSUFkYXB0ZXIgd2lsbCBzZW5kIGVhY2ggZmluZCByZXF1ZXN0IGNvbWluZyBmcm9tIGEgYHN0b3JlLmZpbmRgCiAgICAgIG9yIGZyb20gYWNjZXNzaW5nIGEgcmVsYXRpb25zaGlwIHNlcGFyYXRlbHkgdG8gdGhlIHNlcnZlci4gSWYgeW91ciBzZXJ2ZXIgc3VwcG9ydHMgcGFzc2luZwogICAgICBpZHMgYXMgYSBxdWVyeSBzdHJpbmcsIHlvdSBjYW4gc2V0IGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIHRydWUgdG8gY29hbGVzY2UgYWxsIGZpbmQgcmVxdWVzdHMKICAgICAgd2l0aGluIGEgc2luZ2xlIHJ1bmxvb3AuCiAgICAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGhhdmUgYW4gaW5pdGlhbCBwYXlsb2FkIG9mOgogICAgICAgYGBgamF2YXNjcmlwdAogICAgICB7CiAgICAgICAgZGF0YTogewogICAgICAgICAgaWQ6IDEsCiAgICAgICAgICB0eXBlOiAncG9zdCcsCiAgICAgICAgICByZWxhdGlvbnNoaXA6IHsKICAgICAgICAgICAgY29tbWVudHM6IHsKICAgICAgICAgICAgICBkYXRhOiBbCiAgICAgICAgICAgICAgICB7IGlkOiAxLCB0eXBlOiAnY29tbWVudCcgfSwKICAgICAgICAgICAgICAgIHsgaWQ6IDIsIHR5cGU6ICdjb21tZW50JyB9CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQnkgZGVmYXVsdCBjYWxsaW5nIGBwb3N0LmdldCgnY29tbWVudHMnKWAgd2lsbCB0cmlnZ2VyIHRoZSBmb2xsb3dpbmcgcmVxdWVzdHMoYXNzdW1pbmcgdGhlCiAgICAgIGNvbW1lbnRzIGhhdmVuJ3QgYmVlbiBsb2FkZWQgYmVmb3JlKToKICAgICAgIGBgYAogICAgICBHRVQgL2NvbW1lbnRzLzEKICAgICAgR0VUIC9jb21tZW50cy8yCiAgICAgIGBgYAogICAgICAgSWYgeW91IHNldCBjb2FsZXNjZUZpbmRSZXF1ZXN0cyB0byBgdHJ1ZWAgaXQgd2lsbCBpbnN0ZWFkIHRyaWdnZXIgdGhlIGZvbGxvd2luZyByZXF1ZXN0OgogICAgICAgYGBgCiAgICAgIEdFVCAvY29tbWVudHM/ZmlsdGVyW2lkXT0xLDIKICAgICAgYGBgCiAgICAgICBTZXR0aW5nIGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBhbHNvIHdvcmtzIGZvciBgc3RvcmUuZmluZGAgcmVxdWVzdHMgYW5kIGBiZWxvbmdzVG9gCiAgICAgIHJlbGF0aW9uc2hpcHMgYWNjZXNzZWQgd2l0aGluIHRoZSBzYW1lIHJ1bmxvb3AuIElmIHlvdSBzZXQgYGNvYWxlc2NlRmluZFJlcXVlc3RzOiB0cnVlYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMSk7CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyKTsKICAgICAgYGBgCiAgICAgICB3aWxsIGFsc28gc2VuZCBhIHJlcXVlc3QgdG86IGBHRVQgL2NvbW1lbnRzP2ZpbHRlcltpZF09MSwyYAogICAgICAgTm90ZTogUmVxdWVzdHMgY29hbGVzY2luZyByZWx5IG9uIFVSTCBidWlsZGluZyBzdHJhdGVneS4gU28gaWYgeW91IG92ZXJyaWRlIGBidWlsZFVSTGAgaW4geW91ciBhcHAKICAgICAgYGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55YCBtb3JlIGxpa2VseSBzaG91bGQgYmUgb3ZlcnJpZGRlbiBhcyB3ZWxsIGluIG9yZGVyIGZvciBjb2FsZXNjaW5nIHRvIHdvcmsuCiAgICAgICBAcHJvcGVydHkgY29hbGVzY2VGaW5kUmVxdWVzdHMKICAgICAgQHR5cGUge2Jvb2xlYW59CiAgICAqLwogICAgY29hbGVzY2VGaW5kUmVxdWVzdHM6IGZhbHNlLAoKICAgIGZpbmRNYW55KHN0b3JlLCB0eXBlLCBpZHMsIHNuYXBzaG90cykgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgaWRzLCBzbmFwc2hvdHMsICdmaW5kTWFueScpOwogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcsIHsgZGF0YTogeyBmaWx0ZXI6IHsgaWQ6IGlkcy5qb2luKCcsJykgfSB9IH0pOwogICAgfSwKCiAgICBwYXRoRm9yVHlwZShtb2RlbE5hbWUpIHsKICAgICAgdmFyIGRhc2hlcml6ZWQgPSBFbWJlci5TdHJpbmcuZGFzaGVyaXplKG1vZGVsTmFtZSk7CiAgICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnBsdXJhbGl6ZSkoZGFzaGVyaXplZCk7CiAgICB9LAoKICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIG9uY2Ugd2UgaGF2ZSBhIGJldHRlciB3YXkgdG8gb3ZlcnJpZGUgSFRUUCB2ZXJicy4KICAgIHVwZGF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUubW9kZWxOYW1lKTsKCiAgICAgIHNlcmlhbGl6ZXIuc2VyaWFsaXplSW50b0hhc2goZGF0YSwgdHlwZSwgc25hcHNob3QsIHsgaW5jbHVkZUlkOiB0cnVlIH0pOwoKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIHNuYXBzaG90LmlkLCBzbmFwc2hvdCwgJ3VwZGF0ZVJlY29yZCcpOwoKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdQQVRDSCcsIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9KTsgLyogZ2xvYmFsIGhlaW1kYWxsICovCiAgLyoqCiAgICBAbW9kdWxlIGVtYmVyLWRhdGEKICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IEpTT05BUElBZGFwdGVyOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9hZGFwdGVycy9yZXN0JywgWydleHBvcnRzJywgJ2VtYmVyLWRhdGEvYWRhcHRlcicsICdlbWJlci1kYXRhLy1wcml2YXRlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfYWRhcHRlciwgX3ByaXZhdGUpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CgoKICB2YXIgUHJvbWlzZSA9IEVtYmVyLlJTVlAuUHJvbWlzZTsKCiAgLyoqCiAgICBUaGUgUkVTVCBhZGFwdGVyIGFsbG93cyB5b3VyIHN0b3JlIHRvIGNvbW11bmljYXRlIHdpdGggYW4gSFRUUCBzZXJ2ZXIgYnkKICAgIHRyYW5zbWl0dGluZyBKU09OIHZpYSBYSFIuIE1vc3QgRW1iZXIuanMgYXBwcyB0aGF0IGNvbnN1bWUgYSBKU09OIEFQSQogICAgc2hvdWxkIHVzZSB0aGUgUkVTVCBhZGFwdGVyLgogIAogICAgVGhpcyBhZGFwdGVyIGlzIGRlc2lnbmVkIGFyb3VuZCB0aGUgaWRlYSB0aGF0IHRoZSBKU09OIGV4Y2hhbmdlZCB3aXRoCiAgICB0aGUgc2VydmVyIHNob3VsZCBiZSBjb252ZW50aW9uYWwuCiAgCiAgICAjIyBTdWNjZXNzIGFuZCBmYWlsdXJlCiAgCiAgICBUaGUgUkVTVCBhZGFwdGVyIHdpbGwgY29uc2lkZXIgYSBzdWNjZXNzIGFueSByZXNwb25zZSB3aXRoIGEgc3RhdHVzIGNvZGUKICAgIG9mIHRoZSAyeHggZmFtaWx5ICgiU3VjY2VzcyIpLCBhcyB3ZWxsIGFzIDMwNCAoIk5vdCBNb2RpZmllZCIpLiBBbnkgb3RoZXIKICAgIHN0YXR1cyBjb2RlIHdpbGwgYmUgY29uc2lkZXJlZCBhIGZhaWx1cmUuCiAgCiAgICBPbiBzdWNjZXNzLCB0aGUgcmVxdWVzdCBwcm9taXNlIHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCB0aGUgZnVsbCByZXNwb25zZQogICAgcGF5bG9hZC4KICAKICAgIEZhaWxlZCByZXNwb25zZXMgd2l0aCBzdGF0dXMgY29kZSA0MjIgKCJVbnByb2Nlc3NhYmxlIEVudGl0eSIpIHdpbGwgYmUKICAgIGNvbnNpZGVyZWQgImludmFsaWQiLiBUaGUgcmVzcG9uc2Ugd2lsbCBiZSBkaXNjYXJkZWQsIGV4Y2VwdCBmb3IgdGhlCiAgICBgZXJyb3JzYCBrZXkuIFRoZSByZXF1ZXN0IHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCB3aXRoIGEgYERTLkludmFsaWRFcnJvcmAuCiAgICBUaGlzIGVycm9yIG9iamVjdCB3aWxsIGVuY2Fwc3VsYXRlIHRoZSBzYXZlZCBgZXJyb3JzYCB2YWx1ZS4KICAKICAgIEFueSBvdGhlciBzdGF0dXMgY29kZXMgd2lsbCBiZSB0cmVhdGVkIGFzIGFuICJhZGFwdGVyIGVycm9yIi4gVGhlIHJlcXVlc3QKICAgIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCwgc2ltaWxhcmx5IHRvIHRoZSAiaW52YWxpZCIgY2FzZSwgYnV0IHdpdGgKICAgIGFuIGluc3RhbmNlIG9mIGBEUy5BZGFwdGVyRXJyb3JgIGluc3RlYWQuCiAgCiAgICAjIyBKU09OIFN0cnVjdHVyZQogIAogICAgVGhlIFJFU1QgYWRhcHRlciBleHBlY3RzIHRoZSBKU09OIHJldHVybmVkIGZyb20geW91ciBzZXJ2ZXIgdG8gZm9sbG93CiAgICB0aGVzZSBjb252ZW50aW9ucy4KICAKICAgICMjIyBPYmplY3QgUm9vdAogIAogICAgVGhlIEpTT04gcGF5bG9hZCBzaG91bGQgYmUgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIHJlY29yZCBpbnNpZGUgYQogICAgcm9vdCBwcm9wZXJ0eS4gRm9yIGV4YW1wbGUsIGluIHJlc3BvbnNlIHRvIGEgYEdFVGAgcmVxdWVzdCBmb3IKICAgIGAvcG9zdHMvMWAsIHRoZSBKU09OIHNob3VsZCBsb29rIGxpa2UgdGhpczoKICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwb3N0cyI6IHsKICAgICAgICAiaWQiOiAxLAogICAgICAgICJ0aXRsZSI6ICJJJ20gUnVubmluZyB0byBSZWZvcm0gdGhlIFczQydzIFRhZyIsCiAgICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICBTaW1pbGFybHksIGluIHJlc3BvbnNlIHRvIGEgYEdFVGAgcmVxdWVzdCBmb3IgYC9wb3N0c2AsIHRoZSBKU09OIHNob3VsZAogICAgbG9vayBsaWtlIHRoaXM6CiAgCiAgICBgYGBqcwogICAgewogICAgICAicG9zdHMiOiBbCiAgICAgICAgewogICAgICAgICAgImlkIjogMSwKICAgICAgICAgICJ0aXRsZSI6ICJJJ20gUnVubmluZyB0byBSZWZvcm0gdGhlIFczQydzIFRhZyIsCiAgICAgICAgICAiYXV0aG9yIjogIlllaHVkYSBLYXR6IgogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgImlkIjogMiwKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJhdXRob3IiOiAiRDJIIgogICAgICAgIH0KICAgICAgXQogICAgfQogICAgYGBgCiAgCiAgICBOb3RlIHRoYXQgdGhlIG9iamVjdCByb290IGNhbiBiZSBwbHVyYWxpemVkIGZvciBib3RoIGEgc2luZ2xlLW9iamVjdCByZXNwb25zZQogICAgYW5kIGFuIGFycmF5IHJlc3BvbnNlOiB0aGUgUkVTVCBhZGFwdGVyIGlzIG5vdCBzdHJpY3Qgb24gdGhpcy4gRnVydGhlciwgaWYgdGhlCiAgICBIVFRQIHNlcnZlciByZXNwb25kcyB0byBhIGBHRVRgIHJlcXVlc3QgdG8gYC9wb3N0cy8xYCAoZS5nLiB0aGUgcmVzcG9uc2UgdG8gYQogICAgYGZpbmRSZWNvcmRgIHF1ZXJ5KSB3aXRoIG1vcmUgdGhhbiBvbmUgb2JqZWN0IGluIHRoZSBhcnJheSwgRW1iZXIgRGF0YSB3aWxsCiAgICBvbmx5IGRpc3BsYXkgdGhlIG9iamVjdCB3aXRoIHRoZSBtYXRjaGluZyBJRC4KICAKICAgICMjIyBDb252ZW50aW9uYWwgTmFtZXMKICAKICAgIEF0dHJpYnV0ZSBuYW1lcyBpbiB5b3VyIEpTT04gcGF5bG9hZCBzaG91bGQgYmUgdGhlIGNhbWVsQ2FzZWQgdmVyc2lvbnMgb2YKICAgIHRoZSBhdHRyaWJ1dGVzIGluIHlvdXIgRW1iZXIuanMgbW9kZWxzLgogIAogICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBoYXZlIGEgYFBlcnNvbmAgbW9kZWw6CiAgCiAgICBgYGBhcHAvbW9kZWxzL3BlcnNvbi5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgZmlyc3ROYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgbGFzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICBvY2N1cGF0aW9uOiBEUy5hdHRyKCdzdHJpbmcnKQogICAgfSk7CiAgICBgYGAKICAKICAgIFRoZSBKU09OIHJldHVybmVkIHNob3VsZCBsb29rIGxpa2UgdGhpczoKICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwZW9wbGUiOiB7CiAgICAgICAgImlkIjogNSwKICAgICAgICAiZmlyc3ROYW1lIjogIlphcGhvZCIsCiAgICAgICAgImxhc3ROYW1lIjogIkJlZWJsZWJyb3giLAogICAgICAgICJvY2N1cGF0aW9uIjogIlByZXNpZGVudCIKICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICAjIyMjIFJlbGF0aW9uc2hpcHMKICAKICAgIFJlbGF0aW9uc2hpcHMgYXJlIHVzdWFsbHkgcmVwcmVzZW50ZWQgYnkgaWRzIHRvIHRoZSByZWNvcmQgaW4gdGhlCiAgICByZWxhdGlvbnNoaXAuIFRoZSByZWxhdGVkIHJlY29yZHMgY2FuIHRoZW4gYmUgc2lkZWxvYWRlZCBpbiB0aGUKICAgIHJlc3BvbnNlIHVuZGVyIGEga2V5IGZvciB0aGUgdHlwZS4KICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwb3N0cyI6IHsKICAgICAgICAiaWQiOiA1LAogICAgICAgICJ0aXRsZSI6ICJJJ20gUnVubmluZyB0byBSZWZvcm0gdGhlIFczQydzIFRhZyIsCiAgICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIsCiAgICAgICAgImNvbW1lbnRzIjogWzEsIDJdCiAgICAgIH0sCiAgICAgICJjb21tZW50cyI6IFt7CiAgICAgICAgImlkIjogMSwKICAgICAgICAiYXV0aG9yIjogIlVzZXIgMSIsCiAgICAgICAgIm1lc3NhZ2UiOiAiRmlyc3QhIiwKICAgICAgfSwgewogICAgICAgICJpZCI6IDIsCiAgICAgICAgImF1dGhvciI6ICJVc2VyIDIiLAogICAgICAgICJtZXNzYWdlIjogIkdvb2QgTHVjayEiLAogICAgICB9XQogICAgfQogICAgYGBgCiAgCiAgICBJZiB0aGUgcmVjb3JkcyBpbiB0aGUgcmVsYXRpb25zaGlwIGFyZSBub3Qga25vd24gd2hlbiB0aGUgcmVzcG9uc2UKICAgIGlzIHNlcmlhbGl6ZWQgaXRzIGFsc28gcG9zc2libGUgdG8gcmVwcmVzZW50IHRoZSByZWxhdGlvbnNoaXAgYXMgYQogICAgdXJsIHVzaW5nIHRoZSBgbGlua3NgIGtleSBpbiB0aGUgcmVzcG9uc2UuIEVtYmVyIERhdGEgd2lsbCBmZXRjaAogICAgdGhpcyB1cmwgdG8gcmVzb2x2ZSB0aGUgcmVsYXRpb25zaGlwIHdoZW4gaXQgaXMgYWNjZXNzZWQgZm9yIHRoZQogICAgZmlyc3QgdGltZS4KICAKICAgIGBgYGpzCiAgICB7CiAgICAgICJwb3N0cyI6IHsKICAgICAgICAiaWQiOiA1LAogICAgICAgICJ0aXRsZSI6ICJJJ20gUnVubmluZyB0byBSZWZvcm0gdGhlIFczQydzIFRhZyIsCiAgICAgICAgImF1dGhvciI6ICJZZWh1ZGEgS2F0eiIsCiAgICAgICAgImxpbmtzIjogewogICAgICAgICAgImNvbW1lbnRzIjogIi9wb3N0cy81L2NvbW1lbnRzIgogICAgICAgIH0KICAgICAgfQogICAgfQogICAgYGBgCiAgCiAgICAjIyMgRXJyb3JzCiAgCiAgICBJZiBhIHJlc3BvbnNlIGlzIGNvbnNpZGVyZWQgYSBmYWlsdXJlLCB0aGUgSlNPTiBwYXlsb2FkIGlzIGV4cGVjdGVkIHRvIGluY2x1ZGUKICAgIGEgdG9wLWxldmVsIGtleSBgZXJyb3JzYCwgZGV0YWlsaW5nIGFueSBzcGVjaWZpYyBpc3N1ZXMuIEZvciBleGFtcGxlOgogIAogICAgYGBganMKICAgIHsKICAgICAgImVycm9ycyI6IHsKICAgICAgICAibXNnIjogIlNvbWV0aGluZyB3ZW50IHdyb25nIgogICAgICB9CiAgICB9CiAgICBgYGAKICAKICAgIFRoaXMgYWRhcHRlciBkb2VzIG5vdCBtYWtlIGFueSBhc3N1bXB0aW9ucyBhcyB0byB0aGUgZm9ybWF0IG9mIHRoZSBgZXJyb3JzYAogICAgb2JqZWN0LiBJdCB3aWxsIHNpbXBseSBiZSBwYXNzZWQgYWxvbmcgYXMgaXMsIHdyYXBwZWQgaW4gYW4gaW5zdGFuY2UKICAgIG9mIGBEUy5JbnZhbGlkRXJyb3JgIG9yIGBEUy5BZGFwdGVyRXJyb3JgLiBUaGUgc2VyaWFsaXplciBjYW4gaW50ZXJwcmV0IGl0CiAgICBhZnRlcndhcmRzLgogIAogICAgIyMgQ3VzdG9taXphdGlvbgogIAogICAgIyMjIEVuZHBvaW50IHBhdGggY3VzdG9taXphdGlvbgogIAogICAgRW5kcG9pbnQgcGF0aHMgY2FuIGJlIHByZWZpeGVkIHdpdGggYSBgbmFtZXNwYWNlYCBieSBzZXR0aW5nIHRoZSBuYW1lc3BhY2UKICAgIHByb3BlcnR5IG9uIHRoZSBhZGFwdGVyOgogIAogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUQWRhcHRlci5leHRlbmQoewogICAgICBuYW1lc3BhY2U6ICdhcGkvMScKICAgIH0pOwogICAgYGBgCiAgICBSZXF1ZXN0cyBmb3IgdGhlIGBQZXJzb25gIG1vZGVsIHdvdWxkIG5vdyB0YXJnZXQgYC9hcGkvMS9wZW9wbGUvMWAuCiAgCiAgICAjIyMgSG9zdCBjdXN0b21pemF0aW9uCiAgCiAgICBBbiBhZGFwdGVyIGNhbiB0YXJnZXQgb3RoZXIgaG9zdHMgYnkgc2V0dGluZyB0aGUgYGhvc3RgIHByb3BlcnR5LgogIAogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUQWRhcHRlci5leHRlbmQoewogICAgICBob3N0OiAnaHR0cHM6Ly9hcGkuZXhhbXBsZS5jb20nCiAgICB9KTsKICAgIGBgYAogIAogICAgIyMjIEhlYWRlcnMgY3VzdG9taXphdGlvbgogIAogICAgU29tZSBBUElzIHJlcXVpcmUgSFRUUCBoZWFkZXJzLCBlLmcuIHRvIHByb3ZpZGUgYW4gQVBJIGtleS4gQXJiaXRyYXJ5CiAgICBoZWFkZXJzIGNhbiBiZSBzZXQgYXMga2V5L3ZhbHVlIHBhaXJzIG9uIHRoZSBgUkVTVEFkYXB0ZXJgJ3MgYGhlYWRlcnNgCiAgICBvYmplY3QgYW5kIEVtYmVyIERhdGEgd2lsbCBzZW5kIHRoZW0gYWxvbmcgd2l0aCBlYWNoIGFqYXggcmVxdWVzdC4KICAKICAKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgaW1wb3J0IHsgY29tcHV0ZWQgfSBmcm9tICdAZW1iZXIvb2JqZWN0JzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RBZGFwdGVyLmV4dGVuZCh7CiAgICAgIGhlYWRlcnM6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAnQVBJX0tFWSc6ICdzZWNyZXQga2V5JywKICAgICAgICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIGBgYAogIAogICAgYGhlYWRlcnNgIGNhbiBhbHNvIGJlIHVzZWQgYXMgYSBjb21wdXRlZCBwcm9wZXJ0eSB0byBzdXBwb3J0IGR5bmFtaWMKICAgIGhlYWRlcnMuIEluIHRoZSBleGFtcGxlIGJlbG93LCB0aGUgYHNlc3Npb25gIG9iamVjdCBoYXMgYmVlbgogICAgaW5qZWN0ZWQgaW50byBhbiBhZGFwdGVyIGJ5IEVtYmVyJ3MgY29udGFpbmVyLgogIAogICAgYGBgYXBwL2FkYXB0ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgaGVhZGVyczogY29tcHV0ZWQoJ3Nlc3Npb24uYXV0aFRva2VuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICdBUElfS0VZJzogdGhpcy5nZXQoJ3Nlc3Npb24uYXV0aFRva2VuJyksCiAgICAgICAgICAnQU5PVEhFUl9IRUFERVInOiAnU29tZSBoZWFkZXIgdmFsdWUnCiAgICAgICAgfTsKICAgICAgfSkKICAgIH0pOwogICAgYGBgCiAgCiAgICBJbiBzb21lIGNhc2VzLCB5b3VyIGR5bmFtaWMgaGVhZGVycyBtYXkgcmVxdWlyZSBkYXRhIGZyb20gc29tZQogICAgb2JqZWN0IG91dHNpZGUgb2YgRW1iZXIncyBvYnNlcnZlciBzeXN0ZW0gKGZvciBleGFtcGxlCiAgICBgZG9jdW1lbnQuY29va2llYCkuIFlvdSBjYW4gdXNlIHRoZQogICAgW3ZvbGF0aWxlXSgvYXBpL2NsYXNzZXMvRW1iZXIuQ29tcHV0ZWRQcm9wZXJ0eS5odG1sI21ldGhvZF92b2xhdGlsZSkKICAgIGZ1bmN0aW9uIHRvIHNldCB0aGUgcHJvcGVydHkgaW50byBhIG5vbi1jYWNoZWQgbW9kZSBjYXVzaW5nIHRoZSBoZWFkZXJzIHRvCiAgICBiZSByZWNvbXB1dGVkIHdpdGggZXZlcnkgcmVxdWVzdC4KICAKICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgaW1wb3J0IHsgZ2V0IH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICBpbXBvcnQgeyBjb21wdXRlZCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgaGVhZGVyczogY29tcHV0ZWQoZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICdBUElfS0VZJzogZ2V0KGRvY3VtZW50LmNvb2tpZS5tYXRjaCgvYXBpS2V5XD0oW147XSopLyksICcxJyksCiAgICAgICAgICAnQU5PVEhFUl9IRUFERVInOiAnU29tZSBoZWFkZXIgdmFsdWUnCiAgICAgICAgfTsKICAgICAgfSkudm9sYXRpbGUoKQogICAgfSk7CiAgICBgYGAKICAKICAgIEBjbGFzcyBSRVNUQWRhcHRlcgogICAgQGNvbnN0cnVjdG9yCiAgICBAbmFtZXNwYWNlIERTCiAgICBAZXh0ZW5kcyBEUy5BZGFwdGVyCiAgICBAdXNlcyBEUy5CdWlsZFVSTE1peGluCiAgKi8KICAvKiBnbG9iYWwgaGVpbWRhbGwgKi8KICAvKiBnbG9iYWxzIG5hamF4ICovCiAgLyoqCiAgICBAbW9kdWxlIGVtYmVyLWRhdGEKICAqLwoKICB2YXIgUkVTVEFkYXB0ZXIgPSBfYWRhcHRlci5kZWZhdWx0LmV4dGVuZChfcHJpdmF0ZS5CdWlsZFVSTE1peGluLCB7CiAgICBkZWZhdWx0U2VyaWFsaXplcjogJy1yZXN0JywKCiAgICBmYXN0Ym9vdDogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gRW1iZXIuZ2V0T3duZXIodGhpcykubG9va3VwKCdzZXJ2aWNlOmZhc3Rib290Jyk7CiAgICB9KSwKCiAgICAvKioKICAgICAgQnkgZGVmYXVsdCwgdGhlIFJFU1RBZGFwdGVyIHdpbGwgc2VuZCB0aGUgcXVlcnkgcGFyYW1zIHNvcnRlZCBhbHBoYWJldGljYWxseSB0byB0aGUKICAgICAgc2VydmVyLgogICAgICAgRm9yIGV4YW1wbGU6CiAgICAgICBgYGBqcwogICAgICBzdG9yZS5xdWVyeSgncG9zdHMnLCB7IHNvcnQ6ICdwcmljZScsIGNhdGVnb3J5OiAncGV0cycgfSk7CiAgICAgIGBgYAogICAgICAgd2lsbCBnZW5lcmF0ZSBhIHJlcXVlc3RzIGxpa2UgdGhpcyBgL3Bvc3RzP2NhdGVnb3J5PXBldHMmc29ydD1wcmljZWAsIGV2ZW4gaWYgdGhlCiAgICAgIHBhcmFtZXRlcnMgd2VyZSBzcGVjaWZpZWQgaW4gYSBkaWZmZXJlbnQgb3JkZXIuCiAgICAgICBUaGF0IHdheSB0aGUgZ2VuZXJhdGVkIFVSTCB3aWxsIGJlIGRldGVybWluaXN0aWMgYW5kIHRoYXQgc2ltcGxpZmllcyBjYWNoaW5nIG1lY2hhbmlzbXMKICAgICAgaW4gdGhlIGJhY2tlbmQuCiAgICAgICBTZXR0aW5nIGBzb3J0UXVlcnlQYXJhbXNgIHRvIGEgZmFsc2V5IHZhbHVlIHdpbGwgcmVzcGVjdCB0aGUgb3JpZ2luYWwgb3JkZXIuCiAgICAgICBJbiBjYXNlIHlvdSB3YW50IHRvIHNvcnQgdGhlIHF1ZXJ5IHBhcmFtZXRlcnMgd2l0aCBhIGRpZmZlcmVudCBjcml0ZXJpYSwgc2V0CiAgICAgIGBzb3J0UXVlcnlQYXJhbXNgIHRvIHlvdXIgY3VzdG9tIHNvcnQgZnVuY3Rpb24uCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBzb3J0UXVlcnlQYXJhbXMocGFyYW1zKSB7CiAgICAgICAgICBsZXQgc29ydGVkS2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcykuc29ydCgpLnJldmVyc2UoKTsKICAgICAgICAgIGxldCBsZW4gPSBzb3J0ZWRLZXlzLmxlbmd0aCwgbmV3UGFyYW1zID0ge307CiAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBuZXdQYXJhbXNbc29ydGVkS2V5c1tpXV0gPSBwYXJhbXNbc29ydGVkS2V5c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIG5ld1BhcmFtczsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc29ydFF1ZXJ5UGFyYW1zCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvYmoKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIHNvcnRRdWVyeVBhcmFtcyhvYmopIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CiAgICAgIGlmIChsZW4gPCAyKSB7CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfQogICAgICB2YXIgbmV3UXVlcnlQYXJhbXMgPSB7fTsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBrZXlzLnNvcnQoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBuZXdRdWVyeVBhcmFtc1tzb3J0ZWRLZXlzW2ldXSA9IG9ialtzb3J0ZWRLZXlzW2ldXTsKICAgICAgfQogICAgICByZXR1cm4gbmV3UXVlcnlQYXJhbXM7CiAgICB9LAoKICAgIC8qKgogICAgICBCeSBkZWZhdWx0IHRoZSBSRVNUQWRhcHRlciB3aWxsIHNlbmQgZWFjaCBmaW5kIHJlcXVlc3QgY29taW5nIGZyb20gYSBgc3RvcmUuZmluZGAKICAgICAgb3IgZnJvbSBhY2Nlc3NpbmcgYSByZWxhdGlvbnNoaXAgc2VwYXJhdGVseSB0byB0aGUgc2VydmVyLiBJZiB5b3VyIHNlcnZlciBzdXBwb3J0cyBwYXNzaW5nCiAgICAgIGlkcyBhcyBhIHF1ZXJ5IHN0cmluZywgeW91IGNhbiBzZXQgY29hbGVzY2VGaW5kUmVxdWVzdHMgdG8gdHJ1ZSB0byBjb2FsZXNjZSBhbGwgZmluZCByZXF1ZXN0cwogICAgICB3aXRoaW4gYSBzaW5nbGUgcnVubG9vcC4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSBhbiBpbml0aWFsIHBheWxvYWQgb2Y6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICBwb3N0OiB7CiAgICAgICAgICBpZDogMSwKICAgICAgICAgIGNvbW1lbnRzOiBbMSwgMl0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBCeSBkZWZhdWx0IGNhbGxpbmcgYHBvc3QuZ2V0KCdjb21tZW50cycpYCB3aWxsIHRyaWdnZXIgdGhlIGZvbGxvd2luZyByZXF1ZXN0cyhhc3N1bWluZyB0aGUKICAgICAgY29tbWVudHMgaGF2ZW4ndCBiZWVuIGxvYWRlZCBiZWZvcmUpOgogICAgICAgYGBgCiAgICAgIEdFVCAvY29tbWVudHMvMQogICAgICBHRVQgL2NvbW1lbnRzLzIKICAgICAgYGBgCiAgICAgICBJZiB5b3Ugc2V0IGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBpdCB3aWxsIGluc3RlYWQgdHJpZ2dlciB0aGUgZm9sbG93aW5nIHJlcXVlc3Q6CiAgICAgICBgYGAKICAgICAgR0VUIC9jb21tZW50cz9pZHNbXT0xJmlkc1tdPTIKICAgICAgYGBgCiAgICAgICBTZXR0aW5nIGNvYWxlc2NlRmluZFJlcXVlc3RzIHRvIGB0cnVlYCBhbHNvIHdvcmtzIGZvciBgc3RvcmUuZmluZGAgcmVxdWVzdHMgYW5kIGBiZWxvbmdzVG9gCiAgICAgIHJlbGF0aW9uc2hpcHMgYWNjZXNzZWQgd2l0aGluIHRoZSBzYW1lIHJ1bmxvb3AuIElmIHlvdSBzZXQgYGNvYWxlc2NlRmluZFJlcXVlc3RzOiB0cnVlYAogICAgICAgYGBgamF2YXNjcmlwdAogICAgICBzdG9yZS5maW5kUmVjb3JkKCdjb21tZW50JywgMSk7CiAgICAgIHN0b3JlLmZpbmRSZWNvcmQoJ2NvbW1lbnQnLCAyKTsKICAgICAgYGBgCiAgICAgICB3aWxsIGFsc28gc2VuZCBhIHJlcXVlc3QgdG86IGBHRVQgL2NvbW1lbnRzP2lkc1tdPTEmaWRzW109MmAKICAgICAgIE5vdGU6IFJlcXVlc3RzIGNvYWxlc2NpbmcgcmVseSBvbiBVUkwgYnVpbGRpbmcgc3RyYXRlZ3kuIFNvIGlmIHlvdSBvdmVycmlkZSBgYnVpbGRVUkxgIGluIHlvdXIgYXBwCiAgICAgIGBncm91cFJlY29yZHNGb3JGaW5kTWFueWAgbW9yZSBsaWtlbHkgc2hvdWxkIGJlIG92ZXJyaWRkZW4gYXMgd2VsbCBpbiBvcmRlciBmb3IgY29hbGVzY2luZyB0byB3b3JrLgogICAgICAgQHByb3BlcnR5IGNvYWxlc2NlRmluZFJlcXVlc3RzCiAgICAgIEB0eXBlIHtib29sZWFufQogICAgKi8KICAgIGNvYWxlc2NlRmluZFJlcXVlc3RzOiBmYWxzZSwKCiAgICAvKioKICAgICAgRW5kcG9pbnQgcGF0aHMgY2FuIGJlIHByZWZpeGVkIHdpdGggYSBgbmFtZXNwYWNlYCBieSBzZXR0aW5nIHRoZSBuYW1lc3BhY2UKICAgICAgcHJvcGVydHkgb24gdGhlIGFkYXB0ZXI6CiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBuYW1lc3BhY2U6ICdhcGkvMScKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgUmVxdWVzdHMgZm9yIHRoZSBgUG9zdGAgbW9kZWwgd291bGQgbm93IHRhcmdldCBgL2FwaS8xL3Bvc3QvYC4KICAgICAgIEBwcm9wZXJ0eSBuYW1lc3BhY2UKICAgICAgQHR5cGUge1N0cmluZ30KICAgICovCgogICAgLyoqCiAgICAgIEFuIGFkYXB0ZXIgY2FuIHRhcmdldCBvdGhlciBob3N0cyBieSBzZXR0aW5nIHRoZSBgaG9zdGAgcHJvcGVydHkuCiAgICAgICBgYGBhcHAvYWRhcHRlcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVEFkYXB0ZXIuZXh0ZW5kKHsKICAgICAgICBob3N0OiAnaHR0cHM6Ly9hcGkuZXhhbXBsZS5jb20nCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFJlcXVlc3RzIGZvciB0aGUgYFBvc3RgIG1vZGVsIHdvdWxkIG5vdyB0YXJnZXQgYGh0dHBzOi8vYXBpLmV4YW1wbGUuY29tL3Bvc3QvYC4KICAgICAgIEBwcm9wZXJ0eSBob3N0CiAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAqLwoKICAgIC8qKgogICAgICBTb21lIEFQSXMgcmVxdWlyZSBIVFRQIGhlYWRlcnMsIGUuZy4gdG8gcHJvdmlkZSBhbiBBUEkKICAgICAga2V5LiBBcmJpdHJhcnkgaGVhZGVycyBjYW4gYmUgc2V0IGFzIGtleS92YWx1ZSBwYWlycyBvbiB0aGUKICAgICAgYFJFU1RBZGFwdGVyYCdzIGBoZWFkZXJzYCBvYmplY3QgYW5kIEVtYmVyIERhdGEgd2lsbCBzZW5kIHRoZW0KICAgICAgYWxvbmcgd2l0aCBlYWNoIGFqYXggcmVxdWVzdC4gRm9yIGR5bmFtaWMgaGVhZGVycyBzZWUgW2hlYWRlcnMKICAgICAgY3VzdG9taXphdGlvbl0oL2FwaS9kYXRhL2NsYXNzZXMvRFMuUkVTVEFkYXB0ZXIuaHRtbCN0b2NfaGVhZGVycy1jdXN0b21pemF0aW9uKS4KICAgICAgIGBgYGFwcC9hZGFwdGVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGltcG9ydCB7IGNvbXB1dGVkIH0gZnJvbSAnQGVtYmVyL29iamVjdCc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUQWRhcHRlci5leHRlbmQoewogICAgICAgIGhlYWRlcnM6IGNvbXB1dGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ0FQSV9LRVknOiAnc2VjcmV0IGtleScsCiAgICAgICAgICAgICdBTk9USEVSX0hFQURFUic6ICdTb21lIGhlYWRlciB2YWx1ZScKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQHByb3BlcnR5IGhlYWRlcnMKICAgICAgQHR5cGUge09iamVjdH0KICAgICAqLwoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIHRoZSBKU09OIGZvciBhIGdpdmVuCiAgICAgIHR5cGUgYW5kIElELgogICAgICAgVGhlIGBmaW5kUmVjb3JkYCBtZXRob2QgbWFrZXMgYW4gQWpheCByZXF1ZXN0IHRvIGEgVVJMIGNvbXB1dGVkIGJ5CiAgICAgIGBidWlsZFVSTGAsIGFuZCByZXR1cm5zIGEgcHJvbWlzZSBmb3IgdGhlIHJlc3VsdGluZyBwYXlsb2FkLgogICAgICAgVGhpcyBtZXRob2QgcGVyZm9ybXMgYW4gSFRUUCBgR0VUYCByZXF1ZXN0IHdpdGggdGhlIGlkIHByb3ZpZGVkIGFzIHBhcnQgb2YgdGhlIHF1ZXJ5IHN0cmluZy4KICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBmaW5kUmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGlkCiAgICAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kUmVjb3JkKHN0b3JlLCB0eXBlLCBpZCwgc25hcHNob3QpIHsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkLCBzbmFwc2hvdCwgJ2ZpbmRSZWNvcmQnKTsKICAgICAgdmFyIHF1ZXJ5ID0gdGhpcy5idWlsZFF1ZXJ5KHNuYXBzaG90KTsKCiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAnR0VUJywgeyBkYXRhOiBxdWVyeSB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggYSBKU09OIGFycmF5IGZvciBhbGwKICAgICAgb2YgdGhlIHJlY29yZHMgZm9yIGEgZ2l2ZW4gdHlwZS4KICAgICAgIFRoZSBgZmluZEFsbGAgbWV0aG9kIG1ha2VzIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAsIGFuZCByZXR1cm5zIGEKICAgICAgcHJvbWlzZSBmb3IgdGhlIHJlc3VsdGluZyBwYXlsb2FkLgogICAgICAgQG1ldGhvZCBmaW5kQWxsCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHNpbmNlVG9rZW4KICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdFJlY29yZEFycmF5fSBzbmFwc2hvdFJlY29yZEFycmF5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kQWxsKHN0b3JlLCB0eXBlLCBzaW5jZVRva2VuLCBzbmFwc2hvdFJlY29yZEFycmF5KSB7CiAgICAgIHZhciBxdWVyeSA9IHRoaXMuYnVpbGRRdWVyeShzbmFwc2hvdFJlY29yZEFycmF5KTsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIG51bGwsIHNuYXBzaG90UmVjb3JkQXJyYXksICdmaW5kQWxsJyk7CgogICAgICBpZiAoc2luY2VUb2tlbikgewogICAgICAgIHF1ZXJ5LnNpbmNlID0gc2luY2VUb2tlbjsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnLCB7IGRhdGE6IHF1ZXJ5IH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSBpbiBvcmRlciB0byBmZXRjaCBhIEpTT04gYXJyYXkgZm9yCiAgICAgIHRoZSByZWNvcmRzIHRoYXQgbWF0Y2ggYSBwYXJ0aWN1bGFyIHF1ZXJ5LgogICAgICAgVGhlIGBxdWVyeWAgbWV0aG9kIG1ha2VzIGFuIEFqYXggKEhUVFAgR0VUKSByZXF1ZXN0IHRvIGEgVVJMCiAgICAgIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAsIGFuZCByZXR1cm5zIGEgcHJvbWlzZSBmb3IgdGhlIHJlc3VsdGluZwogICAgICBwYXlsb2FkLgogICAgICAgVGhlIGBxdWVyeWAgYXJndW1lbnQgaXMgYSBzaW1wbGUgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCB3aWxsIGJlIHBhc3NlZCBkaXJlY3RseQogICAgICB0byB0aGUgc2VydmVyIGFzIHBhcmFtZXRlcnMuCiAgICAgICBAbWV0aG9kIHF1ZXJ5CiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBxdWVyeShzdG9yZSwgdHlwZSwgcXVlcnkpIHsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIG51bGwsIG51bGwsICdxdWVyeScsIHF1ZXJ5KTsKCiAgICAgIGlmICh0aGlzLnNvcnRRdWVyeVBhcmFtcykgewogICAgICAgIHF1ZXJ5ID0gdGhpcy5zb3J0UXVlcnlQYXJhbXMocXVlcnkpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcsIHsgZGF0YTogcXVlcnkgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIGEgSlNPTiBvYmplY3QgZm9yCiAgICAgIHRoZSByZWNvcmQgdGhhdCBtYXRjaGVzIGEgcGFydGljdWxhciBxdWVyeS4KICAgICAgIFRoZSBgcXVlcnlSZWNvcmRgIG1ldGhvZCBtYWtlcyBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byBhIFVSTAogICAgICBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhIHByb21pc2UgZm9yIHRoZSByZXN1bHRpbmcKICAgICAgcGF5bG9hZC4KICAgICAgIFRoZSBgcXVlcnlgIGFyZ3VtZW50IGlzIGEgc2ltcGxlIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgd2lsbCBiZSBwYXNzZWQgZGlyZWN0bHkKICAgICAgdG8gdGhlIHNlcnZlciBhcyBwYXJhbWV0ZXJzLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIHF1ZXJ5UmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtPYmplY3R9IHF1ZXJ5CiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBxdWVyeVJlY29yZChzdG9yZSwgdHlwZSwgcXVlcnkpIHsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIG51bGwsIG51bGwsICdxdWVyeVJlY29yZCcsIHF1ZXJ5KTsKCiAgICAgIGlmICh0aGlzLnNvcnRRdWVyeVBhcmFtcykgewogICAgICAgIHF1ZXJ5ID0gdGhpcy5zb3J0UXVlcnlQYXJhbXMocXVlcnkpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5hamF4KHVybCwgJ0dFVCcsIHsgZGF0YTogcXVlcnkgfSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIGluIG9yZGVyIHRvIGZldGNoIHNldmVyYWwgcmVjb3JkcyB0b2dldGhlciBpZiBgY29hbGVzY2VGaW5kUmVxdWVzdHNgIGlzIHRydWUKICAgICAgIEZvciBleGFtcGxlLCBpZiB0aGUgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJpZCI6IDEsCiAgICAgICAgInRpdGxlIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICJjb21tZW50cyI6IFsgMSwgMiwgMyBdCiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUaGUgSURzIHdpbGwgYmUgcGFzc2VkIGFzIGEgVVJMLWVuY29kZWQgQXJyYXkgb2YgSURzLCBpbiB0aGlzIGZvcm06CiAgICAgICBgYGAKICAgICAgaWRzW109MSZpZHNbXT0yJmlkc1tdPTMKICAgICAgYGBgCiAgICAgICBNYW55IHNlcnZlcnMsIHN1Y2ggYXMgUmFpbHMgYW5kIFBIUCwgd2lsbCBhdXRvbWF0aWNhbGx5IGNvbnZlcnQgdGhpcyBVUkwtZW5jb2RlZCBhcnJheQogICAgICBpbnRvIGFuIEFycmF5IGZvciB5b3Ugb24gdGhlIHNlcnZlci1zaWRlLiBJZiB5b3Ugd2FudCB0byBlbmNvZGUgdGhlCiAgICAgIElEcywgZGlmZmVyZW50bHksIGp1c3Qgb3ZlcnJpZGUgdGhpcyAob25lLWxpbmUpIG1ldGhvZC4KICAgICAgIFRoZSBgZmluZE1hbnlgIG1ldGhvZCBtYWtlcyBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLCBhbmQgcmV0dXJucyBhCiAgICAgIHByb21pc2UgZm9yIHRoZSByZXN1bHRpbmcgcGF5bG9hZC4KICAgICAgIEBtZXRob2QgZmluZE1hbnkKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge0FycmF5fSBpZHMKICAgICAgQHBhcmFtIHtBcnJheX0gc25hcHNob3RzCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kTWFueShzdG9yZSwgdHlwZSwgaWRzLCBzbmFwc2hvdHMpIHsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIGlkcywgc25hcHNob3RzLCAnZmluZE1hbnknKTsKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnLCB7IGRhdGE6IHsgaWRzOiBpZHMgfSB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggYSBKU09OIGFycmF5IGZvcgogICAgICB0aGUgdW5sb2FkZWQgcmVjb3JkcyBpbiBhIGhhcy1tYW55IHJlbGF0aW9uc2hpcCB0aGF0IHdlcmUgb3JpZ2luYWxseQogICAgICBzcGVjaWZpZWQgYXMgYSBVUkwgKGluc2lkZSBvZiBgbGlua3NgKS4KICAgICAgIEZvciBleGFtcGxlLCBpZiB5b3VyIG9yaWdpbmFsIHBheWxvYWQgbG9va3MgbGlrZSB0aGlzOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJwb3N0IjogewogICAgICAgICAgImlkIjogMSwKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJsaW5rcyI6IHsgImNvbW1lbnRzIjogIi9wb3N0cy8xL2NvbW1lbnRzIiB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhpcyBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgcGFyZW50IHJlY29yZCBhbmQgYC9wb3N0cy8xL2NvbW1lbnRzYC4KICAgICAgIFRoZSBgZmluZEhhc01hbnlgIG1ldGhvZCB3aWxsIG1ha2UgYW4gQWpheCAoSFRUUCBHRVQpIHJlcXVlc3QgdG8gdGhlIG9yaWdpbmFsbHkgc3BlY2lmaWVkIFVSTC4KICAgICAgIFRoZSBmb3JtYXQgb2YgeW91ciBgbGlua3NgIHZhbHVlIHdpbGwgaW5mbHVlbmNlIHRoZSBmaW5hbCByZXF1ZXN0IFVSTCB2aWEgdGhlIGB1cmxQcmVmaXhgIG1ldGhvZDoKICAgICAgICogTGlua3MgYmVnaW5uaW5nIHdpdGggYC8vYCwgYGh0dHA6Ly9gLCBgaHR0cHM6Ly9gLCB3aWxsIGJlIHVzZWQgYXMgaXMsIHdpdGggbm8gZnVydGhlciBtYW5pcHVsYXRpb24uCiAgICAgICAqIExpbmtzIGJlZ2lubmluZyB3aXRoIGEgc2luZ2xlIGAvYCB3aWxsIGhhdmUgdGhlIGN1cnJlbnQgYWRhcHRlcidzIGBob3N0YCB2YWx1ZSBwcmVwZW5kZWQgdG8gaXQuCiAgICAgICAqIExpbmtzIHdpdGggbm8gYmVnaW5uaW5nIGAvYCB3aWxsIGhhdmUgYSBwYXJlbnRVUkwgcHJlcGVuZGVkIHRvIGl0LCB2aWEgdGhlIGN1cnJlbnQgYWRhcHRlcidzIGBidWlsZFVSTGAuCiAgICAgICBAbWV0aG9kIGZpbmRIYXNNYW55CiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcCBtZXRhIG9iamVjdCBkZXNjcmliaW5nIHRoZSByZWxhdGlvbnNoaXAKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGZpbmRIYXNNYW55KHN0b3JlLCBzbmFwc2hvdCwgdXJsLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGlkID0gc25hcHNob3QuaWQ7CiAgICAgIHZhciB0eXBlID0gc25hcHNob3QubW9kZWxOYW1lOwoKICAgICAgdXJsID0gdGhpcy51cmxQcmVmaXgodXJsLCB0aGlzLmJ1aWxkVVJMKHR5cGUsIGlkLCBzbmFwc2hvdCwgJ2ZpbmRIYXNNYW55JykpOwoKICAgICAgcmV0dXJuIHRoaXMuYWpheCh1cmwsICdHRVQnKTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgaW4gb3JkZXIgdG8gZmV0Y2ggdGhlIEpTT04gZm9yIHRoZSB1bmxvYWRlZCByZWNvcmQgaW4gYQogICAgICBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcCB0aGF0IHdhcyBvcmlnaW5hbGx5IHNwZWNpZmllZCBhcyBhIFVSTCAoaW5zaWRlIG9mCiAgICAgIGBsaW5rc2ApLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdXIgb3JpZ2luYWwgcGF5bG9hZCBsb29rcyBsaWtlIHRoaXM6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBlcnNvbiI6IHsKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAibmFtZSI6ICJUb20gRGFsZSIsCiAgICAgICAgICAibGlua3MiOiB7ICJncm91cCI6ICIvcGVvcGxlLzEvZ3JvdXAiIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUaGlzIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBwYXJlbnQgcmVjb3JkIGFuZCBgL3Blb3BsZS8xL2dyb3VwYC4KICAgICAgIFRoZSBgZmluZEJlbG9uZ3NUb2AgbWV0aG9kIHdpbGwgbWFrZSBhbiBBamF4IChIVFRQIEdFVCkgcmVxdWVzdCB0byB0aGUgb3JpZ2luYWxseSBzcGVjaWZpZWQgVVJMLgogICAgICAgVGhlIGZvcm1hdCBvZiB5b3VyIGBsaW5rc2AgdmFsdWUgd2lsbCBpbmZsdWVuY2UgdGhlIGZpbmFsIHJlcXVlc3QgVVJMIHZpYSB0aGUgYHVybFByZWZpeGAgbWV0aG9kOgogICAgICAgKiBMaW5rcyBiZWdpbm5pbmcgd2l0aCBgLy9gLCBgaHR0cDovL2AsIGBodHRwczovL2AsIHdpbGwgYmUgdXNlZCBhcyBpcywgd2l0aCBubyBmdXJ0aGVyIG1hbmlwdWxhdGlvbi4KICAgICAgICogTGlua3MgYmVnaW5uaW5nIHdpdGggYSBzaW5nbGUgYC9gIHdpbGwgaGF2ZSB0aGUgY3VycmVudCBhZGFwdGVyJ3MgYGhvc3RgIHZhbHVlIHByZXBlbmRlZCB0byBpdC4KICAgICAgICogTGlua3Mgd2l0aCBubyBiZWdpbm5pbmcgYC9gIHdpbGwgaGF2ZSBhIHBhcmVudFVSTCBwcmVwZW5kZWQgdG8gaXQsIHZpYSB0aGUgY3VycmVudCBhZGFwdGVyJ3MgYGJ1aWxkVVJMYC4KICAgICAgIEBtZXRob2QgZmluZEJlbG9uZ3NUbwogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAgbWV0YSBvYmplY3QgZGVzY3JpYmluZyB0aGUgcmVsYXRpb25zaGlwCiAgICAgIEByZXR1cm4ge1Byb21pc2V9IHByb21pc2UKICAgICovCiAgICBmaW5kQmVsb25nc1RvKHN0b3JlLCBzbmFwc2hvdCwgdXJsLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGlkID0gc25hcHNob3QuaWQ7CiAgICAgIHZhciB0eXBlID0gc25hcHNob3QubW9kZWxOYW1lOwoKICAgICAgdXJsID0gdGhpcy51cmxQcmVmaXgodXJsLCB0aGlzLmJ1aWxkVVJMKHR5cGUsIGlkLCBzbmFwc2hvdCwgJ2ZpbmRCZWxvbmdzVG8nKSk7CiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAnR0VUJyk7CiAgICB9LAoKICAgIC8qKgogICAgICBDYWxsZWQgYnkgdGhlIHN0b3JlIHdoZW4gYSBuZXdseSBjcmVhdGVkIHJlY29yZCBpcwogICAgICBzYXZlZCB2aWEgdGhlIGBzYXZlYCBtZXRob2Qgb24gYSBtb2RlbCByZWNvcmQgaW5zdGFuY2UuCiAgICAgICBUaGUgYGNyZWF0ZVJlY29yZGAgbWV0aG9kIHNlcmlhbGl6ZXMgdGhlIHJlY29yZCBhbmQgbWFrZXMgYW4gQWpheCAoSFRUUCBQT1NUKSByZXF1ZXN0CiAgICAgIHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAuCiAgICAgICBTZWUgYHNlcmlhbGl6ZWAgZm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0byBjdXN0b21pemUgdGhlIHNlcmlhbGl6ZWQgZm9ybQogICAgICBvZiBhIHJlY29yZC4KICAgICAgIEBtZXRob2QgY3JlYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGNyZWF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUubW9kZWxOYW1lKTsKICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVUkwodHlwZS5tb2RlbE5hbWUsIG51bGwsIHNuYXBzaG90LCAnY3JlYXRlUmVjb3JkJyk7CgogICAgICBzZXJpYWxpemVyLnNlcmlhbGl6ZUludG9IYXNoKGRhdGEsIHR5cGUsIHNuYXBzaG90LCB7IGluY2x1ZGVJZDogdHJ1ZSB9KTsKCiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAiUE9TVCIsIHsgZGF0YTogZGF0YSB9KTsKICAgIH0sCgogICAgLyoqCiAgICAgIENhbGxlZCBieSB0aGUgc3RvcmUgd2hlbiBhbiBleGlzdGluZyByZWNvcmQgaXMgc2F2ZWQKICAgICAgdmlhIHRoZSBgc2F2ZWAgbWV0aG9kIG9uIGEgbW9kZWwgcmVjb3JkIGluc3RhbmNlLgogICAgICAgVGhlIGB1cGRhdGVSZWNvcmRgIG1ldGhvZCBzZXJpYWxpemVzIHRoZSByZWNvcmQgYW5kIG1ha2VzIGFuIEFqYXggKEhUVFAgUFVUKSByZXF1ZXN0CiAgICAgIHRvIGEgVVJMIGNvbXB1dGVkIGJ5IGBidWlsZFVSTGAuCiAgICAgICBTZWUgYHNlcmlhbGl6ZWAgZm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0byBjdXN0b21pemUgdGhlIHNlcmlhbGl6ZWQgZm9ybQogICAgICBvZiBhIHJlY29yZC4KICAgICAgIEBtZXRob2QgdXBkYXRlUmVjb3JkCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGUKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIHVwZGF0ZVJlY29yZChzdG9yZSwgdHlwZSwgc25hcHNob3QpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKHR5cGUubW9kZWxOYW1lKTsKCiAgICAgIHNlcmlhbGl6ZXIuc2VyaWFsaXplSW50b0hhc2goZGF0YSwgdHlwZSwgc25hcHNob3QpOwoKICAgICAgdmFyIGlkID0gc25hcHNob3QuaWQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLmJ1aWxkVVJMKHR5cGUubW9kZWxOYW1lLCBpZCwgc25hcHNob3QsICd1cGRhdGVSZWNvcmQnKTsKCiAgICAgIHJldHVybiB0aGlzLmFqYXgodXJsLCAiUFVUIiwgeyBkYXRhOiBkYXRhIH0pOwogICAgfSwKCiAgICAvKioKICAgICAgQ2FsbGVkIGJ5IHRoZSBzdG9yZSB3aGVuIGEgcmVjb3JkIGlzIGRlbGV0ZWQuCiAgICAgICBUaGUgYGRlbGV0ZVJlY29yZGAgbWV0aG9kICBtYWtlcyBhbiBBamF4IChIVFRQIERFTEVURSkgcmVxdWVzdCB0byBhIFVSTCBjb21wdXRlZCBieSBgYnVpbGRVUkxgLgogICAgICAgQG1ldGhvZCBkZWxldGVSZWNvcmQKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcmV0dXJuIHtQcm9taXNlfSBwcm9taXNlCiAgICAqLwogICAgZGVsZXRlUmVjb3JkKHN0b3JlLCB0eXBlLCBzbmFwc2hvdCkgewogICAgICB2YXIgaWQgPSBzbmFwc2hvdC5pZDsKCiAgICAgIHJldHVybiB0aGlzLmFqYXgodGhpcy5idWlsZFVSTCh0eXBlLm1vZGVsTmFtZSwgaWQsIHNuYXBzaG90LCAnZGVsZXRlUmVjb3JkJyksICJERUxFVEUiKTsKICAgIH0sCgogICAgX3N0cmlwSURGcm9tVVJMKHN0b3JlLCBzbmFwc2hvdCkgewogICAgICB2YXIgdXJsID0gdGhpcy5idWlsZFVSTChzbmFwc2hvdC5tb2RlbE5hbWUsIHNuYXBzaG90LmlkLCBzbmFwc2hvdCk7CgogICAgICB2YXIgZXhwYW5kZWRVUkwgPSB1cmwuc3BsaXQoJy8nKTsKICAgICAgLy8gQ2FzZSB3aGVuIHRoZSB1cmwgaXMgb2YgdGhlIGZvcm1hdCAuLi5zb21ldGhpbmcvOmlkCiAgICAgIC8vIFdlIGFyZSBkZWNvZGVVUklDb21wb25lbnQtaW5nIHRoZSBsYXN0U2VnbWVudCBiZWNhdXNlIGlmIGl0IHJlcHJlc2VudHMKICAgICAgLy8gdGhlIGlkLCBpdCBoYXMgYmVlbiBlbmNvZGVVUklDb21wb25lbnQtaWZpZWQgd2l0aGluIGBidWlsZFVSTGAuIElmIHdlCiAgICAgIC8vIGRvbid0IGRvIHRoaXMsIHRoZW4gcmVjb3JkcyB3aXRoIGlkIGhhdmluZyBzcGVjaWFsIGNoYXJhY3RlcnMgYXJlIG5vdAogICAgICAvLyBjb2FsZXNjZWQgY29ycmVjdGx5IChzZWUgR0ggIzQxOTAgZm9yIHRoZSByZXBvcnRlZCBidWcpCiAgICAgIHZhciBsYXN0U2VnbWVudCA9IGV4cGFuZGVkVVJMW2V4cGFuZGVkVVJMLmxlbmd0aCAtIDFdOwogICAgICB2YXIgaWQgPSBzbmFwc2hvdC5pZDsKICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChsYXN0U2VnbWVudCkgPT09IGlkKSB7CiAgICAgICAgZXhwYW5kZWRVUkxbZXhwYW5kZWRVUkwubGVuZ3RoIC0gMV0gPSAiIjsKICAgICAgfSBlbHNlIGlmIChlbmRzV2l0aChsYXN0U2VnbWVudCwgJz9pZD0nICsgaWQpKSB7CiAgICAgICAgLy9DYXNlIHdoZW4gdGhlIHVybCBpcyBvZiB0aGUgZm9ybWF0IC4uLnNvbWV0aGluZz9pZD06aWQKICAgICAgICBleHBhbmRlZFVSTFtleHBhbmRlZFVSTC5sZW5ndGggLSAxXSA9IGxhc3RTZWdtZW50LnN1YnN0cmluZygwLCBsYXN0U2VnbWVudC5sZW5ndGggLSBpZC5sZW5ndGggLSAxKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGV4cGFuZGVkVVJMLmpvaW4oJy8nKTsKICAgIH0sCgogICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy80MTcxNDIvd2hhdC1pcy10aGUtbWF4aW11bS1sZW5ndGgtb2YtYS11cmwtaW4tZGlmZmVyZW50LWJyb3dzZXJzCiAgICBtYXhVUkxMZW5ndGg6IDIwNDgsCgogICAgLyoqCiAgICAgIE9yZ2FuaXplIHJlY29yZHMgaW50byBncm91cHMsIGVhY2ggb2Ygd2hpY2ggaXMgdG8gYmUgcGFzc2VkIHRvIHNlcGFyYXRlCiAgICAgIGNhbGxzIHRvIGBmaW5kTWFueWAuCiAgICAgICBUaGlzIGltcGxlbWVudGF0aW9uIGdyb3VwcyB0b2dldGhlciByZWNvcmRzIHRoYXQgaGF2ZSB0aGUgc2FtZSBiYXNlIFVSTCBidXQKICAgICAgZGlmZmVyaW5nIGlkcy4gRm9yIGV4YW1wbGUgYC9jb21tZW50cy8xYCBhbmQgYC9jb21tZW50cy8yYCB3aWxsIGJlIGdyb3VwZWQgdG9nZXRoZXIKICAgICAgYmVjYXVzZSB3ZSBrbm93IGZpbmRNYW55IGNhbiBjb2FsZXNjZSB0aGVtIHRvZ2V0aGVyIGFzIGAvY29tbWVudHM/aWRzW109MSZpZHNbXT0yYAogICAgICAgSXQgYWxzbyBzdXBwb3J0cyB1cmxzIHdoZXJlIGlkcyBhcmUgcGFzc2VkIGFzIGEgcXVlcnkgcGFyYW0sIHN1Y2ggYXMgYC9jb21tZW50cz9pZD0xYAogICAgICBidXQgbm90IHRob3NlIHdoZXJlIHRoZXJlIGlzIG1vcmUgdGhhbiAxIHF1ZXJ5IHBhcmFtIHN1Y2ggYXMgYC9jb21tZW50cz9pZD0yJm5hbWU9RGF2aWRgCiAgICAgIEN1cnJlbnRseSBvbmx5IHRoZSBxdWVyeSBwYXJhbSBvZiBgaWRgIGlzIHN1cHBvcnRlZC4gSWYgeW91IG5lZWQgdG8gc3VwcG9ydCBvdGhlcnMsIHBsZWFzZQogICAgICBvdmVycmlkZSB0aGlzIG9yIHRoZSBgX3N0cmlwSURGcm9tVVJMYCBtZXRob2QuCiAgICAgICBJdCBkb2VzIG5vdCBncm91cCByZWNvcmRzIHRoYXQgaGF2ZSBkaWZmZXJpbmcgYmFzZSB1cmxzLCBzdWNoIGFzIGZvciBleGFtcGxlOiBgL3Bvc3RzLzEvY29tbWVudHMvMmAKICAgICAgYW5kIGAvcG9zdHMvMi9jb21tZW50cy8zYAogICAgICAgQG1ldGhvZCBncm91cFJlY29yZHNGb3JGaW5kTWFueQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0FycmF5fSBzbmFwc2hvdHMKICAgICAgQHJldHVybiB7QXJyYXl9ICBhbiBhcnJheSBvZiBhcnJheXMgb2YgcmVjb3JkcywgZWFjaCBvZiB3aGljaCBpcyB0byBiZQogICAgICAgICAgICAgICAgICAgICAgICBsb2FkZWQgc2VwYXJhdGVseSBieSBgZmluZE1hbnlgLgogICAgKi8KICAgIGdyb3VwUmVjb3Jkc0ZvckZpbmRNYW55KHN0b3JlLCBzbmFwc2hvdHMpIHsKICAgICAgdmFyIGdyb3VwcyA9IG5ldyBfcHJpdmF0ZS5NYXBXaXRoRGVmYXVsdCh7IGRlZmF1bHRWYWx1ZSgpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9IH0pOwogICAgICB2YXIgYWRhcHRlciA9IHRoaXM7CiAgICAgIHZhciBtYXhVUkxMZW5ndGggPSB0aGlzLm1heFVSTExlbmd0aDsKCiAgICAgIHNuYXBzaG90cy5mb3JFYWNoKHNuYXBzaG90ID0+IHsKICAgICAgICB2YXIgYmFzZVVybCA9IGFkYXB0ZXIuX3N0cmlwSURGcm9tVVJMKHN0b3JlLCBzbmFwc2hvdCk7CiAgICAgICAgZ3JvdXBzLmdldChiYXNlVXJsKS5wdXNoKHNuYXBzaG90KTsKICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBzcGxpdEdyb3VwVG9GaXRJblVybChncm91cCwgbWF4VVJMTGVuZ3RoLCBwYXJhbU5hbWVMZW5ndGgpIHsKICAgICAgICB2YXIgaWRzU2l6ZSA9IDA7CiAgICAgICAgdmFyIGJhc2VVcmwgPSBhZGFwdGVyLl9zdHJpcElERnJvbVVSTChzdG9yZSwgZ3JvdXBbMF0pOwogICAgICAgIHZhciBzcGxpdEdyb3VwcyA9IFtbXV07CgogICAgICAgIGdyb3VwLmZvckVhY2goc25hcHNob3QgPT4gewogICAgICAgICAgdmFyIGFkZGl0aW9uYWxMZW5ndGggPSBlbmNvZGVVUklDb21wb25lbnQoc25hcHNob3QuaWQpLmxlbmd0aCArIHBhcmFtTmFtZUxlbmd0aDsKICAgICAgICAgIGlmIChiYXNlVXJsLmxlbmd0aCArIGlkc1NpemUgKyBhZGRpdGlvbmFsTGVuZ3RoID49IG1heFVSTExlbmd0aCkgewogICAgICAgICAgICBpZHNTaXplID0gMDsKICAgICAgICAgICAgc3BsaXRHcm91cHMucHVzaChbXSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWRzU2l6ZSArPSBhZGRpdGlvbmFsTGVuZ3RoOwoKICAgICAgICAgIHZhciBsYXN0R3JvdXBJbmRleCA9IHNwbGl0R3JvdXBzLmxlbmd0aCAtIDE7CiAgICAgICAgICBzcGxpdEdyb3Vwc1tsYXN0R3JvdXBJbmRleF0ucHVzaChzbmFwc2hvdCk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBzcGxpdEdyb3VwczsKICAgICAgfQoKICAgICAgdmFyIGdyb3Vwc0FycmF5ID0gW107CiAgICAgIGdyb3Vwcy5mb3JFYWNoKChncm91cCwga2V5KSA9PiB7CiAgICAgICAgdmFyIHBhcmFtTmFtZUxlbmd0aCA9ICcmaWRzJTVCJTVEPScubGVuZ3RoOwogICAgICAgIHZhciBzcGxpdEdyb3VwcyA9IHNwbGl0R3JvdXBUb0ZpdEluVXJsKGdyb3VwLCBtYXhVUkxMZW5ndGgsIHBhcmFtTmFtZUxlbmd0aCk7CgogICAgICAgIHNwbGl0R3JvdXBzLmZvckVhY2goc3BsaXRHcm91cCA9PiBncm91cHNBcnJheS5wdXNoKHNwbGl0R3JvdXApKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gZ3JvdXBzQXJyYXk7CiAgICB9LAoKICAgIC8qKgogICAgICBUYWtlcyBhbiBhamF4IHJlc3BvbnNlLCBhbmQgcmV0dXJucyB0aGUganNvbiBwYXlsb2FkIG9yIGFuIGVycm9yLgogICAgICAgQnkgZGVmYXVsdCB0aGlzIGhvb2sganVzdCByZXR1cm5zIHRoZSBqc29uIHBheWxvYWQgcGFzc2VkIHRvIGl0LgogICAgICBZb3UgbWlnaHQgd2FudCB0byBvdmVycmlkZSBpdCBpbiB0d28gY2FzZXM6CiAgICAgICAxLiBZb3VyIEFQSSBtaWdodCByZXR1cm4gdXNlZnVsIHJlc3VsdHMgaW4gdGhlIHJlc3BvbnNlIGhlYWRlcnMuCiAgICAgIFJlc3BvbnNlIGhlYWRlcnMgYXJlIHBhc3NlZCBpbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICAgMi4gWW91ciBBUEkgbWlnaHQgcmV0dXJuIGVycm9ycyBhcyBzdWNjZXNzZnVsIHJlc3BvbnNlcyB3aXRoIHN0YXR1cyBjb2RlCiAgICAgIDIwMCBhbmQgYW4gRXJyb3JzIHRleHQgb3Igb2JqZWN0LiBZb3UgY2FuIHJldHVybiBhIGBEUy5JbnZhbGlkRXJyb3JgIG9yIGEKICAgICAgYERTLkFkYXB0ZXJFcnJvcmAgKG9yIGEgc3ViIGNsYXNzKSBmcm9tIHRoaXMgaG9vayBhbmQgaXQgd2lsbCBhdXRvbWF0aWNhbGx5CiAgICAgIHJlamVjdCB0aGUgcHJvbWlzZSBhbmQgcHV0IHlvdXIgcmVjb3JkIGludG8gdGhlIGludmFsaWQgb3IgZXJyb3Igc3RhdGUuCiAgICAgICBSZXR1cm5pbmcgYSBgRFMuSW52YWxpZEVycm9yYCBmcm9tIHRoaXMgbWV0aG9kIHdpbGwgY2F1c2UgdGhlCiAgICAgIHJlY29yZCB0byB0cmFuc2l0aW9uIGludG8gdGhlIGBpbnZhbGlkYCBzdGF0ZSBhbmQgbWFrZSB0aGUKICAgICAgYGVycm9yc2Agb2JqZWN0IGF2YWlsYWJsZSBvbiB0aGUgcmVjb3JkLiBXaGVuIHJldHVybmluZyBhbgogICAgICBgRFMuSW52YWxpZEVycm9yYCB0aGUgc3RvcmUgd2lsbCBhdHRlbXB0IHRvIG5vcm1hbGl6ZSB0aGUgZXJyb3IgZGF0YQogICAgICByZXR1cm5lZCBmcm9tIHRoZSBzZXJ2ZXIgdXNpbmcgdGhlIHNlcmlhbGl6ZXIncyBgZXh0cmFjdEVycm9yc2AKICAgICAgbWV0aG9kLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIGhhbmRsZVJlc3BvbnNlCiAgICAgIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgIEBwYXJhbSAge09iamVjdH0gaGVhZGVycwogICAgICBAcGFyYW0gIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtICB7T2JqZWN0fSByZXF1ZXN0RGF0YSAtIHRoZSBvcmlnaW5hbCByZXF1ZXN0IGluZm9ybWF0aW9uCiAgICAgIEByZXR1cm4ge09iamVjdCB8IERTLkFkYXB0ZXJFcnJvcn0gcmVzcG9uc2UKICAgICovCiAgICBoYW5kbGVSZXNwb25zZShzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKSB7CiAgICAgIGlmICh0aGlzLmlzU3VjY2VzcyhzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpKSB7CiAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ludmFsaWQoc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkKSkgewogICAgICAgIHJldHVybiBuZXcgX3ByaXZhdGUuSW52YWxpZEVycm9yKHBheWxvYWQuZXJyb3JzKTsKICAgICAgfQoKICAgICAgdmFyIGVycm9ycyA9IHRoaXMubm9ybWFsaXplRXJyb3JSZXNwb25zZShzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQpOwogICAgICB2YXIgZGV0YWlsZWRNZXNzYWdlID0gdGhpcy5nZW5lcmF0ZWREZXRhaWxlZE1lc3NhZ2Uoc3RhdHVzLCBoZWFkZXJzLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSk7CgogICAgICBzd2l0Y2ggKHN0YXR1cykgewogICAgICAgIGNhc2UgNDAxOgogICAgICAgICAgcmV0dXJuIG5ldyBfcHJpdmF0ZS5VbmF1dGhvcml6ZWRFcnJvcihlcnJvcnMsIGRldGFpbGVkTWVzc2FnZSk7CiAgICAgICAgY2FzZSA0MDM6CiAgICAgICAgICByZXR1cm4gbmV3IF9wcml2YXRlLkZvcmJpZGRlbkVycm9yKGVycm9ycywgZGV0YWlsZWRNZXNzYWdlKTsKICAgICAgICBjYXNlIDQwNDoKICAgICAgICAgIHJldHVybiBuZXcgX3ByaXZhdGUuTm90Rm91bmRFcnJvcihlcnJvcnMsIGRldGFpbGVkTWVzc2FnZSk7CiAgICAgICAgY2FzZSA0MDk6CiAgICAgICAgICByZXR1cm4gbmV3IF9wcml2YXRlLkNvbmZsaWN0RXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAoc3RhdHVzID49IDUwMCkgewogICAgICAgICAgICByZXR1cm4gbmV3IF9wcml2YXRlLlNlcnZlckVycm9yKGVycm9ycywgZGV0YWlsZWRNZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBfcHJpdmF0ZS5BZGFwdGVyRXJyb3IoZXJyb3JzLCBkZXRhaWxlZE1lc3NhZ2UpOwogICAgfSwKCiAgICAvKioKICAgICAgRGVmYXVsdCBgaGFuZGxlUmVzcG9uc2VgIGltcGxlbWVudGF0aW9uIHVzZXMgdGhpcyBob29rIHRvIGRlY2lkZSBpZiB0aGUKICAgICAgcmVzcG9uc2UgaXMgYSBzdWNjZXNzLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIGlzU3VjY2VzcwogICAgICBAcGFyYW0gIHtOdW1iZXJ9IHN0YXR1cwogICAgICBAcGFyYW0gIHtPYmplY3R9IGhlYWRlcnMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgaXNTdWNjZXNzKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICByZXR1cm4gc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAgfHwgc3RhdHVzID09PSAzMDQ7CiAgICB9LAoKICAgIC8qKgogICAgICBEZWZhdWx0IGBoYW5kbGVSZXNwb25zZWAgaW1wbGVtZW50YXRpb24gdXNlcyB0aGlzIGhvb2sgdG8gZGVjaWRlIGlmIHRoZQogICAgICByZXNwb25zZSBpcyBhbiBpbnZhbGlkIGVycm9yLgogICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIGlzSW52YWxpZAogICAgICBAcGFyYW0gIHtOdW1iZXJ9IHN0YXR1cwogICAgICBAcGFyYW0gIHtPYmplY3R9IGhlYWRlcnMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEByZXR1cm4ge0Jvb2xlYW59CiAgICAqLwogICAgaXNJbnZhbGlkKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICByZXR1cm4gc3RhdHVzID09PSA0MjI7CiAgICB9LAoKICAgIC8qKgogICAgICBUYWtlcyBhIFVSTCwgYW4gSFRUUCBtZXRob2QgYW5kIGEgaGFzaCBvZiBkYXRhLCBhbmQgbWFrZXMgYW4KICAgICAgSFRUUCByZXF1ZXN0LgogICAgICAgV2hlbiB0aGUgc2VydmVyIHJlc3BvbmRzIHdpdGggYSBwYXlsb2FkLCBFbWJlciBEYXRhIHdpbGwgY2FsbCBpbnRvIGBleHRyYWN0U2luZ2xlYAogICAgICBvciBgZXh0cmFjdEFycmF5YCAoZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIG9yaWdpbmFsIHF1ZXJ5IHdhcyBmb3Igb25lIHJlY29yZCBvcgogICAgICBtYW55IHJlY29yZHMpLgogICAgICAgQnkgZGVmYXVsdCwgYGFqYXhgIG1ldGhvZCBoYXMgdGhlIGZvbGxvd2luZyBiZWhhdmlvcjoKICAgICAgICogSXQgc2V0cyB0aGUgcmVzcG9uc2UgYGRhdGFUeXBlYCB0byBgImpzb24iYAogICAgICAqIElmIHRoZSBIVFRQIG1ldGhvZCBpcyBub3QgYCJHRVQiYCwgaXQgc2V0cyB0aGUgYENvbnRlbnQtVHlwZWAgdG8gYmUKICAgICAgICBgYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOGAKICAgICAgKiBJZiB0aGUgSFRUUCBtZXRob2QgaXMgbm90IGAiR0VUImAsIGl0IHN0cmluZ2lmaWVzIHRoZSBkYXRhIHBhc3NlZCBpbi4gVGhlCiAgICAgICAgZGF0YSBpcyB0aGUgc2VyaWFsaXplZCByZWNvcmQgaW4gdGhlIGNhc2Ugb2YgYSBzYXZlLgogICAgICAqIFJlZ2lzdGVycyBzdWNjZXNzIGFuZCBmYWlsdXJlIGhhbmRsZXJzLgogICAgICAgQG1ldGhvZCBhamF4CiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGV0Yy4KICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7UHJvbWlzZX0gcHJvbWlzZQogICAgKi8KICAgIGFqYXgodXJsLCB0eXBlLCBvcHRpb25zKSB7CiAgICAgIHZhciBhZGFwdGVyID0gdGhpczsKCiAgICAgIHZhciByZXF1ZXN0RGF0YSA9IHsKICAgICAgICB1cmw6IHVybCwKICAgICAgICBtZXRob2Q6IHR5cGUKICAgICAgfTsKICAgICAgdmFyIGhhc2ggPSBhZGFwdGVyLmFqYXhPcHRpb25zKHVybCwgdHlwZSwgb3B0aW9ucyk7CgogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGhhc2guc3VjY2VzcyA9IGZ1bmN0aW9uIChwYXlsb2FkLCB0ZXh0U3RhdHVzLCBqcVhIUikgewogICAgICAgICAgdmFyIHJlc3BvbnNlID0gYWpheFN1Y2Nlc3NIYW5kbGVyKGFkYXB0ZXIsIHBheWxvYWQsIGpxWEhSLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICBFbWJlci5ydW4uam9pbihudWxsLCByZXNvbHZlLCByZXNwb25zZSk7CiAgICAgICAgfTsKICAgICAgICBoYXNoLmVycm9yID0gZnVuY3Rpb24gKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgewogICAgICAgICAgdmFyIGVycm9yID0gYWpheEVycm9ySGFuZGxlcihhZGFwdGVyLCBqcVhIUiwgZXJyb3JUaHJvd24sIHJlcXVlc3REYXRhKTsKICAgICAgICAgIEVtYmVyLnJ1bi5qb2luKG51bGwsIHJlamVjdCwgZXJyb3IpOwogICAgICAgIH07CgogICAgICAgIGFkYXB0ZXIuX2FqYXgoaGFzaCk7CiAgICAgIH0sICdEUzogUkVTVEFkYXB0ZXIjYWpheCAnICsgdHlwZSArICcgdG8gJyArIHVybCk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF9hamF4UmVxdWVzdAogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBqUXVlcnkgYWpheCBvcHRpb25zIHRvIGJlIHVzZWQgZm9yIHRoZSBhamF4IHJlcXVlc3QKICAgICovCiAgICBfYWpheFJlcXVlc3Qob3B0aW9ucykgewogICAgICBFbWJlci4kLmFqYXgob3B0aW9ucyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF9uYWpheFJlcXVlc3QKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgalF1ZXJ5IGFqYXggb3B0aW9ucyB0byBiZSB1c2VkIGZvciB0aGUgbmFqYXggcmVxdWVzdAogICAgKi8KICAgIF9uYWpheFJlcXVlc3Qob3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIG5hamF4ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIG5hamF4KG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignbmFqYXggZG9lcyBub3Qgc2VlbSB0byBiZSBkZWZpbmVkIGluIHlvdXIgYXBwLiBEaWQgeW91IG92ZXJyaWRlIGl0IHZpYSBgYWRkT3JPdmVycmlkZVNhbmRib3hHbG9iYWxzYCBpbiB0aGUgZmFzdGJvb3Qgc2VydmVyPycpOwogICAgICB9CiAgICB9LAoKICAgIF9hamF4KG9wdGlvbnMpIHsKICAgICAgaWYgKEVtYmVyLmdldCh0aGlzLCAnZmFzdGJvb3QuaXNGYXN0Qm9vdCcpKSB7CiAgICAgICAgdGhpcy5fbmFqYXhSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2FqYXhSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIGFqYXhPcHRpb25zCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHJlcXVlc3QgdHlwZSBHRVQsIFBPU1QsIFBVVCwgREVMRVRFIGV0Yy4KICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIGFqYXhPcHRpb25zKHVybCwgdHlwZSwgb3B0aW9ucykgewogICAgICB2YXIgaGFzaCA9IG9wdGlvbnMgfHwge307CiAgICAgIGhhc2gudHlwZSA9IHR5cGU7CiAgICAgIGhhc2guZGF0YVR5cGUgPSAnanNvbic7CiAgICAgIGhhc2guY29udGV4dCA9IHRoaXM7CgogICAgICBpZiAoaGFzaC5kYXRhICYmIHR5cGUgIT09ICdHRVQnKSB7CiAgICAgICAgaGFzaC5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JzsKICAgICAgICBoYXNoLmRhdGEgPSBKU09OLnN0cmluZ2lmeShoYXNoLmRhdGEpOwogICAgICB9CgogICAgICB2YXIgaGVhZGVycyA9IEVtYmVyLmdldCh0aGlzLCAnaGVhZGVycycpOwogICAgICBpZiAoaGVhZGVycyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaGFzaC5iZWZvcmVTZW5kID0gZnVuY3Rpb24gKHhocikgewogICAgICAgICAgT2JqZWN0LmtleXMoaGVhZGVycykuZm9yRWFjaChrZXkgPT4geGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCBoZWFkZXJzW2tleV0pKTsKICAgICAgICB9OwogICAgICB9CgogICAgICBoYXNoLnVybCA9IHRoaXMuX2FqYXhVUkwodXJsKTsKCiAgICAgIHJldHVybiBoYXNoOwogICAgfSwKCiAgICBfYWpheFVSTCh1cmwpIHsKICAgICAgaWYgKEVtYmVyLmdldCh0aGlzLCAnZmFzdGJvb3QuaXNGYXN0Qm9vdCcpKSB7CiAgICAgICAgdmFyIGh0dHBSZWdleCA9IC9eaHR0cHM/OlwvXC8vOwogICAgICAgIHZhciBwcm90b2NvbFJlbGF0aXZlUmVnZXggPSAvXlwvXC8vOwogICAgICAgIHZhciBwcm90b2NvbCA9IEVtYmVyLmdldCh0aGlzLCAnZmFzdGJvb3QucmVxdWVzdC5wcm90b2NvbCcpOwogICAgICAgIHZhciBob3N0ID0gRW1iZXIuZ2V0KHRoaXMsICdmYXN0Ym9vdC5yZXF1ZXN0Lmhvc3QnKTsKCiAgICAgICAgaWYgKHByb3RvY29sUmVsYXRpdmVSZWdleC50ZXN0KHVybCkpIHsKICAgICAgICAgIHJldHVybiBgJHtwcm90b2NvbH0ke3VybH1gOwogICAgICAgIH0gZWxzZSBpZiAoIWh0dHBSZWdleC50ZXN0KHVybCkpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBgJHtwcm90b2NvbH0vLyR7aG9zdH0ke3VybH1gOwogICAgICAgICAgfSBjYXRjaCAoZmJFcnJvcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBhcmUgdXNpbmcgRW1iZXIgRGF0YSB3aXRoIG5vIGhvc3QgZGVmaW5lZCBpbiB5b3VyIGFkYXB0ZXIuIFRoaXMgd2lsbCBhdHRlbXB0IHRvIHVzZSB0aGUgaG9zdCBvZiB0aGUgRmFzdEJvb3QgcmVxdWVzdCwgd2hpY2ggaXMgbm90IGNvbmZpZ3VyZWQgZm9yIHRoZSBjdXJyZW50IGhvc3Qgb2YgdGhpcyByZXF1ZXN0LiBQbGVhc2Ugc2V0IHRoZSBob3N0V2hpdGVsaXN0IHByb3BlcnR5IGZvciBpbiB5b3VyIGVudmlyb25tZW50LmpzLiBGYXN0Qm9vdCBFcnJvcjogJyArIGZiRXJyb3IubWVzc2FnZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdXJsOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBwYXJzZUVycm9yUmVzcG9uc2UKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlc3BvbnNlVGV4dAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgcGFyc2VFcnJvclJlc3BvbnNlKHJlc3BvbnNlVGV4dCkgewogICAgICB2YXIganNvbiA9IHJlc3BvbnNlVGV4dDsKCiAgICAgIHRyeSB7CiAgICAgICAganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VUZXh0KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIGlnbm9yZWQKICAgICAgfQoKICAgICAgcmV0dXJuIGpzb247CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUVycm9yUmVzcG9uc2UKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtICB7TnVtYmVyfSBzdGF0dXMKICAgICAgQHBhcmFtICB7T2JqZWN0fSBoZWFkZXJzCiAgICAgIEBwYXJhbSAge09iamVjdH0gcGF5bG9hZAogICAgICBAcmV0dXJuIHtBcnJheX0gZXJyb3JzIHBheWxvYWQKICAgICovCiAgICBub3JtYWxpemVFcnJvclJlc3BvbnNlKHN0YXR1cywgaGVhZGVycywgcGF5bG9hZCkgewogICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcgJiYgcGF5bG9hZC5lcnJvcnMpIHsKICAgICAgICByZXR1cm4gcGF5bG9hZC5lcnJvcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFt7CiAgICAgICAgICBzdGF0dXM6IGAke3N0YXR1c31gLAogICAgICAgICAgdGl0bGU6ICJUaGUgYmFja2VuZCByZXNwb25kZWQgd2l0aCBhbiBlcnJvciIsCiAgICAgICAgICBkZXRhaWw6IGAke3BheWxvYWR9YAogICAgICAgIH1dOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBHZW5lcmF0ZXMgYSBkZXRhaWxlZCAoImZyaWVuZGx5IikgZXJyb3IgbWVzc2FnZSwgd2l0aCBwbGVudHkKICAgICAgb2YgaW5mb3JtYXRpb24gZm9yIGRlYnVnZ2luZyAoZ29vZCBsdWNrISkKICAgICAgIEBtZXRob2QgZ2VuZXJhdGVkRGV0YWlsZWRNZXNzYWdlCiAgICAgIEBwcml2YXRlCiAgICAgIEBwYXJhbSAge051bWJlcn0gc3RhdHVzCiAgICAgIEBwYXJhbSAge09iamVjdH0gaGVhZGVycwogICAgICBAcGFyYW0gIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtICB7T2JqZWN0fSByZXF1ZXN0RGF0YQogICAgICBAcmV0dXJuIHtTdHJpbmd9IGRldGFpbGVkIGVycm9yIG1lc3NhZ2UKICAgICovCiAgICBnZW5lcmF0ZWREZXRhaWxlZE1lc3NhZ2U6IGZ1bmN0aW9uIChzdGF0dXMsIGhlYWRlcnMsIHBheWxvYWQsIHJlcXVlc3REYXRhKSB7CiAgICAgIHZhciBzaG9ydGVuZWRQYXlsb2FkID0gdm9pZCAwOwogICAgICB2YXIgcGF5bG9hZENvbnRlbnRUeXBlID0gaGVhZGVyc1siQ29udGVudC1UeXBlIl0gfHwgIkVtcHR5IENvbnRlbnQtVHlwZSI7CgogICAgICBpZiAocGF5bG9hZENvbnRlbnRUeXBlID09PSAidGV4dC9odG1sIiAmJiBwYXlsb2FkLmxlbmd0aCA+IDI1MCkgewogICAgICAgIHNob3J0ZW5lZFBheWxvYWQgPSAiW09taXR0ZWQgTGVuZ3RoeSBIVE1MXSI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2hvcnRlbmVkUGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgIH0KCiAgICAgIHZhciByZXF1ZXN0RGVzY3JpcHRpb24gPSByZXF1ZXN0RGF0YS5tZXRob2QgKyAnICcgKyByZXF1ZXN0RGF0YS51cmw7CiAgICAgIHZhciBwYXlsb2FkRGVzY3JpcHRpb24gPSAnUGF5bG9hZCAoJyArIHBheWxvYWRDb250ZW50VHlwZSArICcpJzsKCiAgICAgIHJldHVybiBbJ0VtYmVyIERhdGEgUmVxdWVzdCAnICsgcmVxdWVzdERlc2NyaXB0aW9uICsgJyByZXR1cm5lZCBhICcgKyBzdGF0dXMsIHBheWxvYWREZXNjcmlwdGlvbiwgc2hvcnRlbmVkUGF5bG9hZF0uam9pbignXG4nKTsKICAgIH0sCgogICAgLy8gQHNpbmNlIDIuNS4wCiAgICBidWlsZFF1ZXJ5KHNuYXBzaG90KSB7CiAgICAgIHZhciBxdWVyeSA9IHt9OwoKICAgICAgaWYgKHNuYXBzaG90KSB7CiAgICAgICAgdmFyIHsgaW5jbHVkZSB9ID0gc25hcHNob3Q7CgogICAgICAgIGlmIChpbmNsdWRlKSB7CiAgICAgICAgICBxdWVyeS5pbmNsdWRlID0gaW5jbHVkZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBxdWVyeTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoYWRhcHRlciwgcGF5bG9hZCwgcmVxdWVzdERhdGEsIHJlc3BvbnNlRGF0YSkgewogICAgdmFyIHJlc3BvbnNlID0gdm9pZCAwOwogICAgdHJ5IHsKICAgICAgcmVzcG9uc2UgPSBhZGFwdGVyLmhhbmRsZVJlc3BvbnNlKHJlc3BvbnNlRGF0YS5zdGF0dXMsIHJlc3BvbnNlRGF0YS5oZWFkZXJzLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOwogICAgfQoKICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5pc0FkYXB0ZXJFcnJvcikgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVzcG9uc2UpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWpheEVycm9yKGFkYXB0ZXIsIHBheWxvYWQsIHJlcXVlc3REYXRhLCByZXNwb25zZURhdGEpIHsKICAgIGlmICh0cnVlKSB7CiAgICAgIHZhciBtZXNzYWdlID0gYFRoZSBzZXJ2ZXIgcmV0dXJuZWQgYW4gZW1wdHkgc3RyaW5nIGZvciAke3JlcXVlc3REYXRhLm1ldGhvZH0gJHtyZXF1ZXN0RGF0YS51cmx9LCB3aGljaCBjYW5ub3QgYmUgcGFyc2VkIGludG8gYSB2YWxpZCBKU09OLiBSZXR1cm4gZWl0aGVyIG51bGwgb3Ige30uYDsKICAgICAgdmFyIHZhbGlkSlNPTlN0cmluZyA9ICEocmVzcG9uc2VEYXRhLnRleHRTdGF0dXMgPT09ICJwYXJzZXJlcnJvciIgJiYgcGF5bG9hZCA9PT0gIiIpOwogICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKG1lc3NhZ2UsIHZhbGlkSlNPTlN0cmluZywgewogICAgICAgIGlkOiAnZHMuYWRhcHRlci5yZXR1cm5lZC1lbXB0eS1zdHJpbmctYXMtSlNPTicKICAgICAgfSkpOwogICAgfQoKICAgIHZhciBlcnJvciA9IHZvaWQgMDsKCiAgICBpZiAocmVzcG9uc2VEYXRhLmVycm9yVGhyb3duIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgZXJyb3IgPSByZXNwb25zZURhdGEuZXJyb3JUaHJvd247CiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRGF0YS50ZXh0U3RhdHVzID09PSAndGltZW91dCcpIHsKICAgICAgZXJyb3IgPSBuZXcgX3ByaXZhdGUuVGltZW91dEVycm9yKCk7CiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRGF0YS50ZXh0U3RhdHVzID09PSAnYWJvcnQnIHx8IHJlc3BvbnNlRGF0YS5zdGF0dXMgPT09IDApIHsKICAgICAgZXJyb3IgPSBuZXcgX3ByaXZhdGUuQWJvcnRFcnJvcigpOwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBlcnJvciA9IGFkYXB0ZXIuaGFuZGxlUmVzcG9uc2UocmVzcG9uc2VEYXRhLnN0YXR1cywgcmVzcG9uc2VEYXRhLmhlYWRlcnMsIHBheWxvYWQgfHwgcmVzcG9uc2VEYXRhLmVycm9yVGhyb3duLCByZXF1ZXN0RGF0YSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvciA9IGU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZXJyb3I7CiAgfQoKICAvL0Zyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yODA2MzQvZW5kc3dpdGgtaW4tamF2YXNjcmlwdAogIGZ1bmN0aW9uIGVuZHNXaXRoKHN0cmluZywgc3VmZml4KSB7CiAgICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUuZW5kc1dpdGggIT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHN0cmluZy5pbmRleE9mKHN1ZmZpeCwgc3RyaW5nLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzdHJpbmcuZW5kc1dpdGgoc3VmZml4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGFqYXhTdWNjZXNzSGFuZGxlcihhZGFwdGVyLCBwYXlsb2FkLCBqcVhIUiwgcmVxdWVzdERhdGEpIHsKICAgIHZhciByZXNwb25zZURhdGEgPSBhamF4UmVzcG9uc2VEYXRhKGpxWEhSKTsKICAgIHJldHVybiBhamF4U3VjY2VzcyhhZGFwdGVyLCBwYXlsb2FkLCByZXF1ZXN0RGF0YSwgcmVzcG9uc2VEYXRhKTsKICB9CgogIGZ1bmN0aW9uIGFqYXhFcnJvckhhbmRsZXIoYWRhcHRlciwganFYSFIsIGVycm9yVGhyb3duLCByZXF1ZXN0RGF0YSkgewogICAgdmFyIHJlc3BvbnNlRGF0YSA9IGFqYXhSZXNwb25zZURhdGEoanFYSFIpOwogICAgcmVzcG9uc2VEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CiAgICB2YXIgcGF5bG9hZCA9IGFkYXB0ZXIucGFyc2VFcnJvclJlc3BvbnNlKGpxWEhSLnJlc3BvbnNlVGV4dCk7CiAgICByZXR1cm4gYWpheEVycm9yKGFkYXB0ZXIsIHBheWxvYWQsIHJlcXVlc3REYXRhLCByZXNwb25zZURhdGEpOwogIH0KCiAgZnVuY3Rpb24gYWpheFJlc3BvbnNlRGF0YShqcVhIUikgewogICAgcmV0dXJuIHsKICAgICAgc3RhdHVzOiBqcVhIUi5zdGF0dXMsCiAgICAgIHRleHRTdGF0dXM6IGpxWEhSLnRleHRTdGF0dXMsCiAgICAgIGhlYWRlcnM6ICgwLCBfcHJpdmF0ZS5wYXJzZVJlc3BvbnNlSGVhZGVycykoanFYSFIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpCiAgICB9OwogIH0KCiAgZXhwb3J0cy5kZWZhdWx0ID0gUkVTVEFkYXB0ZXI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1kYXRhL2F0dHInLCBbJ2V4cG9ydHMnXSwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gYXR0cjsKCgogIC8qKgogICAgQG1vZHVsZSBlbWJlci1kYXRhCiAgKi8KCiAgZnVuY3Rpb24gZ2V0RGVmYXVsdFZhbHVlKHJlY29yZCwgb3B0aW9ucywga2V5KSB7CiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBvcHRpb25zLmRlZmF1bHRWYWx1ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IG9wdGlvbnMuZGVmYXVsdFZhbHVlOwogICAgICAodHJ1ZSAmJiAhKHR5cGVvZiBkZWZhdWx0VmFsdWUgIT09ICdvYmplY3QnIHx8IGRlZmF1bHRWYWx1ZSA9PT0gbnVsbCkgJiYgRW1iZXIuYXNzZXJ0KGBOb24gcHJpbWl0aXZlIGRlZmF1bHRWYWx1ZXMgYXJlIG5vdCBzdXBwb3J0ZWQgYmVjYXVzZSB0aGV5IGFyZSBzaGFyZWQgYmV0d2VlbiBhbGwgaW5zdGFuY2VzLiBJZiB5b3Ugd291bGQgbGlrZSB0byB1c2UgYSBjb21wbGV4IG9iamVjdCBhcyBhIGRlZmF1bHQgdmFsdWUgcGxlYXNlIHByb3ZpZGUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGNvbXBsZXggb2JqZWN0LmAsIHR5cGVvZiBkZWZhdWx0VmFsdWUgIT09ICdvYmplY3QnIHx8IGRlZmF1bHRWYWx1ZSA9PT0gbnVsbCkpOwoKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhc1ZhbHVlKHJlY29yZCwga2V5KSB7CiAgICByZXR1cm4ga2V5IGluIHJlY29yZC5fYXR0cmlidXRlcyB8fCBrZXkgaW4gcmVjb3JkLl9pbkZsaWdodEF0dHJpYnV0ZXMgfHwga2V5IGluIHJlY29yZC5fZGF0YTsKICB9CgogIC8qKgogICAgYERTLmF0dHJgIGRlZmluZXMgYW4gYXR0cmlidXRlIG9uIGEgW0RTLk1vZGVsXSgvYXBpL2RhdGEvY2xhc3Nlcy9EUy5Nb2RlbC5odG1sKS4KICAgIEJ5IGRlZmF1bHQsIGF0dHJpYnV0ZXMgYXJlIHBhc3NlZCB0aHJvdWdoIGFzLWlzLCBob3dldmVyIHlvdSBjYW4gc3BlY2lmeSBhbgogICAgb3B0aW9uYWwgdHlwZSB0byBoYXZlIHRoZSB2YWx1ZSBhdXRvbWF0aWNhbGx5IHRyYW5zZm9ybWVkLgogICAgRW1iZXIgRGF0YSBzaGlwcyB3aXRoIGZvdXIgYmFzaWMgdHJhbnNmb3JtIHR5cGVzOiBgc3RyaW5nYCwgYG51bWJlcmAsCiAgICBgYm9vbGVhbmAgYW5kIGBkYXRlYC4gWW91IGNhbiBkZWZpbmUgeW91ciBvd24gdHJhbnNmb3JtcyBieSBzdWJjbGFzc2luZwogICAgW0RTLlRyYW5zZm9ybV0oL2FwaS9kYXRhL2NsYXNzZXMvRFMuVHJhbnNmb3JtLmh0bWwpLgogIAogICAgTm90ZSB0aGF0IHlvdSBjYW5ub3QgdXNlIGBhdHRyYCB0byBkZWZpbmUgYW4gYXR0cmlidXRlIG9mIGBpZGAuCiAgCiAgICBgRFMuYXR0cmAgdGFrZXMgYW4gb3B0aW9uYWwgaGFzaCBhcyBhIHNlY29uZCBwYXJhbWV0ZXIsIGN1cnJlbnRseQogICAgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogIAogICAgLSBgZGVmYXVsdFZhbHVlYDogUGFzcyBhIHN0cmluZyBvciBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB0byBzZXQgdGhlIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgICAgICAgdG8gYSBkZWZhdWx0IHZhbHVlIGlmIG5vbmUgaXMgc3VwcGxpZWQuCiAgCiAgICBFeGFtcGxlCiAgCiAgICBgYGBhcHAvbW9kZWxzL3VzZXIuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIHVzZXJuYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgZW1haWw6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICB2ZXJpZmllZDogRFMuYXR0cignYm9vbGVhbicsIHsgZGVmYXVsdFZhbHVlOiBmYWxzZSB9KQogICAgfSk7CiAgICBgYGAKICAKICAgIERlZmF1bHQgdmFsdWUgY2FuIGFsc28gYmUgYSBmdW5jdGlvbi4gVGhpcyBpcyB1c2VmdWwgaXQgeW91IHdhbnQgdG8gcmV0dXJuCiAgICBhIG5ldyBvYmplY3QgZm9yIGVhY2ggYXR0cmlidXRlLgogIAogICAgYGBgYXBwL21vZGVscy91c2VyLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB1c2VybmFtZTogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGVtYWlsOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgc2V0dGluZ3M6IERTLmF0dHIoewogICAgICAgIGRlZmF1bHRWYWx1ZSgpIHsKICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KTsKICAgIGBgYAogIAogICAgVGhlIGBvcHRpb25zYCBoYXNoIGlzIHBhc3NlZCBhcyBzZWNvbmQgYXJndW1lbnQgdG8gYSB0cmFuc2Zvcm1zJwogICAgYHNlcmlhbGl6ZWAgYW5kIGBkZXNlcmlhbGl6ZWAgbWV0aG9kLiBUaGlzIGFsbG93cyB0byBjb25maWd1cmUgYQogICAgdHJhbnNmb3JtYXRpb24gYW5kIGFkYXB0IHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlLCBiYXNlZCBvbiB0aGUgY29uZmlnOgogIAogICAgYGBgYXBwL21vZGVscy9wb3N0LmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB0ZXh0OiBEUy5hdHRyKCd0ZXh0JywgewogICAgICAgIHVwcGVyY2FzZTogdHJ1ZQogICAgICB9KQogICAgfSk7CiAgICBgYGAKICAKICAgIGBgYGFwcC90cmFuc2Zvcm1zL3RleHQuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLlRyYW5zZm9ybS5leHRlbmQoewogICAgICBzZXJpYWxpemUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy51cHBlcmNhc2UpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0sCiAgCiAgICAgIGRlc2VyaWFsaXplKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICB9KQogICAgYGBgCiAgCiAgICBAbmFtZXNwYWNlCiAgICBAbWV0aG9kIGF0dHIKICAgIEBmb3IgRFMKICAgIEBwYXJhbSB7U3RyaW5nfE9iamVjdH0gdHlwZSB0aGUgYXR0cmlidXRlIHR5cGUKICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIGEgaGFzaCBvZiBvcHRpb25zCiAgICBAcmV0dXJuIHtBdHRyaWJ1dGV9CiAgKi8KCiAgZnVuY3Rpb24gYXR0cih0eXBlLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdvYmplY3QnKSB7CiAgICAgIG9wdGlvbnMgPSB0eXBlOwogICAgICB0eXBlID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB9CgogICAgdmFyIG1ldGEgPSB7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIGlzQXR0cmlidXRlOiB0cnVlLAogICAgICBvcHRpb25zOiBvcHRpb25zCiAgICB9OwoKICAgIHJldHVybiBFbWJlci5jb21wdXRlZCh7CiAgICAgIGdldChrZXkpIHsKICAgICAgICB2YXIgaW50ZXJuYWxNb2RlbCA9IHRoaXMuX2ludGVybmFsTW9kZWw7CiAgICAgICAgaWYgKGhhc1ZhbHVlKGludGVybmFsTW9kZWwsIGtleSkpIHsKICAgICAgICAgIHJldHVybiBpbnRlcm5hbE1vZGVsLmdldEF0dHJpYnV0ZVZhbHVlKGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBnZXREZWZhdWx0VmFsdWUodGhpcywgb3B0aW9ucywga2V5KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsTW9kZWwuc2V0RGlydHlBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pLm1ldGEobWV0YSk7CiAgfQp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS9pbmRleCIsIFsiZXhwb3J0cyIsICJlbWJlci1kYXRhLy1wcml2YXRlIiwgImVtYmVyLWRhdGEvc2V0dXAtY29udGFpbmVyIiwgImVtYmVyLWRhdGEvaW5pdGlhbGl6ZS1zdG9yZS1zZXJ2aWNlIiwgImVtYmVyLWRhdGEvdHJhbnNmb3Jtcy90cmFuc2Zvcm0iLCAiZW1iZXItZGF0YS90cmFuc2Zvcm1zL251bWJlciIsICJlbWJlci1kYXRhL3RyYW5zZm9ybXMvZGF0ZSIsICJlbWJlci1kYXRhL3RyYW5zZm9ybXMvc3RyaW5nIiwgImVtYmVyLWRhdGEvdHJhbnNmb3Jtcy9ib29sZWFuIiwgImVtYmVyLWRhdGEvYWRhcHRlciIsICJlbWJlci1kYXRhL2FkYXB0ZXJzL2pzb24tYXBpIiwgImVtYmVyLWRhdGEvYWRhcHRlcnMvcmVzdCIsICJlbWJlci1kYXRhL3NlcmlhbGl6ZXIiLCAiZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uLWFwaSIsICJlbWJlci1kYXRhL3NlcmlhbGl6ZXJzL2pzb24iLCAiZW1iZXItZGF0YS9zZXJpYWxpemVycy9yZXN0IiwgImVtYmVyLWRhdGEvc2VyaWFsaXplcnMvZW1iZWRkZWQtcmVjb3Jkcy1taXhpbiIsICJlbWJlci1kYXRhL2F0dHIiLCAiZW1iZXItaW5mbGVjdG9yIl0sIGZ1bmN0aW9uIChleHBvcnRzLCBfcHJpdmF0ZSwgX3NldHVwQ29udGFpbmVyLCBfaW5pdGlhbGl6ZVN0b3JlU2VydmljZSwgX3RyYW5zZm9ybSwgX251bWJlciwgX2RhdGUsIF9zdHJpbmcsIF9ib29sZWFuLCBfYWRhcHRlciwgX2pzb25BcGksIF9yZXN0LCBfc2VyaWFsaXplciwgX2pzb25BcGkyLCBfanNvbiwgX3Jlc3QyLCBfZW1iZWRkZWRSZWNvcmRzTWl4aW4sIF9hdHRyKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgLyoqCiAgICBFbWJlciBEYXRhCiAgICBAbW9kdWxlIGVtYmVyLWRhdGEKICAgIEBtYWluIGVtYmVyLWRhdGEKICAqLwoKICBpZiAoRW1iZXIuVkVSU0lPTi5tYXRjaCgvXjFcLihbMC05XXwxWzAtMl0pXC4vKSkgewogICAgdGhyb3cgbmV3IEVtYmVyLkVycm9yKCJFbWJlciBEYXRhIHJlcXVpcmVzIGF0IGxlYXN0IEVtYmVyIDEuMTMuMCwgYnV0IHlvdSBoYXZlICIgKyBFbWJlci5WRVJTSU9OICsgIi4gUGxlYXNlIHVwZ3JhZGUgeW91ciB2ZXJzaW9uIG9mIEVtYmVyLCB0aGVuIHVwZ3JhZGUgRW1iZXIgRGF0YS4iKTsKICB9CgogIF9wcml2YXRlLkRTLlN0b3JlID0gX3ByaXZhdGUuU3RvcmU7CiAgX3ByaXZhdGUuRFMuUHJvbWlzZUFycmF5ID0gX3ByaXZhdGUuUHJvbWlzZUFycmF5OwogIF9wcml2YXRlLkRTLlByb21pc2VPYmplY3QgPSBfcHJpdmF0ZS5Qcm9taXNlT2JqZWN0OwoKICBfcHJpdmF0ZS5EUy5Qcm9taXNlTWFueUFycmF5ID0gX3ByaXZhdGUuUHJvbWlzZU1hbnlBcnJheTsKCiAgX3ByaXZhdGUuRFMuTW9kZWwgPSBfcHJpdmF0ZS5Nb2RlbDsKICBfcHJpdmF0ZS5EUy5Sb290U3RhdGUgPSBfcHJpdmF0ZS5Sb290U3RhdGU7CiAgX3ByaXZhdGUuRFMuYXR0ciA9IF9hdHRyLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuRXJyb3JzID0gX3ByaXZhdGUuRXJyb3JzOwoKICBfcHJpdmF0ZS5EUy5JbnRlcm5hbE1vZGVsID0gX3ByaXZhdGUuSW50ZXJuYWxNb2RlbDsKICBfcHJpdmF0ZS5EUy5TbmFwc2hvdCA9IF9wcml2YXRlLlNuYXBzaG90OwoKICBfcHJpdmF0ZS5EUy5BZGFwdGVyID0gX2FkYXB0ZXIuZGVmYXVsdDsKCiAgX3ByaXZhdGUuRFMuQWRhcHRlckVycm9yID0gX3ByaXZhdGUuQWRhcHRlckVycm9yOwogIF9wcml2YXRlLkRTLkludmFsaWRFcnJvciA9IF9wcml2YXRlLkludmFsaWRFcnJvcjsKICBfcHJpdmF0ZS5EUy5UaW1lb3V0RXJyb3IgPSBfcHJpdmF0ZS5UaW1lb3V0RXJyb3I7CiAgX3ByaXZhdGUuRFMuQWJvcnRFcnJvciA9IF9wcml2YXRlLkFib3J0RXJyb3I7CgogIF9wcml2YXRlLkRTLlVuYXV0aG9yaXplZEVycm9yID0gX3ByaXZhdGUuVW5hdXRob3JpemVkRXJyb3I7CiAgX3ByaXZhdGUuRFMuRm9yYmlkZGVuRXJyb3IgPSBfcHJpdmF0ZS5Gb3JiaWRkZW5FcnJvcjsKICBfcHJpdmF0ZS5EUy5Ob3RGb3VuZEVycm9yID0gX3ByaXZhdGUuTm90Rm91bmRFcnJvcjsKICBfcHJpdmF0ZS5EUy5Db25mbGljdEVycm9yID0gX3ByaXZhdGUuQ29uZmxpY3RFcnJvcjsKICBfcHJpdmF0ZS5EUy5TZXJ2ZXJFcnJvciA9IF9wcml2YXRlLlNlcnZlckVycm9yOwoKICBfcHJpdmF0ZS5EUy5lcnJvcnNIYXNoVG9BcnJheSA9IF9wcml2YXRlLmVycm9yc0hhc2hUb0FycmF5OwogIF9wcml2YXRlLkRTLmVycm9yc0FycmF5VG9IYXNoID0gX3ByaXZhdGUuZXJyb3JzQXJyYXlUb0hhc2g7CgogIF9wcml2YXRlLkRTLlNlcmlhbGl6ZXIgPSBfc2VyaWFsaXplci5kZWZhdWx0OwoKICBfcHJpdmF0ZS5EUy5EZWJ1Z0FkYXB0ZXIgPSBfcHJpdmF0ZS5EZWJ1Z0FkYXB0ZXI7CgogIF9wcml2YXRlLkRTLlJlY29yZEFycmF5ID0gX3ByaXZhdGUuUmVjb3JkQXJyYXk7CiAgX3ByaXZhdGUuRFMuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5ID0gX3ByaXZhdGUuQWRhcHRlclBvcHVsYXRlZFJlY29yZEFycmF5OwogIF9wcml2YXRlLkRTLk1hbnlBcnJheSA9IF9wcml2YXRlLk1hbnlBcnJheTsKCiAgX3ByaXZhdGUuRFMuUmVjb3JkQXJyYXlNYW5hZ2VyID0gX3ByaXZhdGUuUmVjb3JkQXJyYXlNYW5hZ2VyOwoKICBfcHJpdmF0ZS5EUy5SRVNUQWRhcHRlciA9IF9yZXN0LmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuQnVpbGRVUkxNaXhpbiA9IF9wcml2YXRlLkJ1aWxkVVJMTWl4aW47CgogIF9wcml2YXRlLkRTLlJFU1RTZXJpYWxpemVyID0gX3Jlc3QyLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuSlNPTlNlcmlhbGl6ZXIgPSBfanNvbi5kZWZhdWx0OwoKICBfcHJpdmF0ZS5EUy5KU09OQVBJQWRhcHRlciA9IF9qc29uQXBpLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuSlNPTkFQSVNlcmlhbGl6ZXIgPSBfanNvbkFwaTIuZGVmYXVsdDsKCiAgX3ByaXZhdGUuRFMuVHJhbnNmb3JtID0gX3RyYW5zZm9ybS5kZWZhdWx0OwogIF9wcml2YXRlLkRTLkRhdGVUcmFuc2Zvcm0gPSBfZGF0ZS5kZWZhdWx0OwogIF9wcml2YXRlLkRTLlN0cmluZ1RyYW5zZm9ybSA9IF9zdHJpbmcuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5OdW1iZXJUcmFuc2Zvcm0gPSBfbnVtYmVyLmRlZmF1bHQ7CiAgX3ByaXZhdGUuRFMuQm9vbGVhblRyYW5zZm9ybSA9IF9ib29sZWFuLmRlZmF1bHQ7CgogIF9wcml2YXRlLkRTLkVtYmVkZGVkUmVjb3Jkc01peGluID0gX2VtYmVkZGVkUmVjb3Jkc01peGluLmRlZmF1bHQ7CgogIF9wcml2YXRlLkRTLmJlbG9uZ3NUbyA9IF9wcml2YXRlLmJlbG9uZ3NUbzsKICBfcHJpdmF0ZS5EUy5oYXNNYW55ID0gX3ByaXZhdGUuaGFzTWFueTsKCiAgX3ByaXZhdGUuRFMuUmVsYXRpb25zaGlwID0gX3ByaXZhdGUuUmVsYXRpb25zaGlwOwoKICBfcHJpdmF0ZS5EUy5fc2V0dXBDb250YWluZXIgPSBfc2V0dXBDb250YWluZXIuZGVmYXVsdDsKICBfcHJpdmF0ZS5EUy5faW5pdGlhbGl6ZVN0b3JlU2VydmljZSA9IF9pbml0aWFsaXplU3RvcmVTZXJ2aWNlLmRlZmF1bHQ7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShfcHJpdmF0ZS5EUywgJ25vcm1hbGl6ZU1vZGVsTmFtZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB3cml0YWJsZTogZmFsc2UsCiAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgdmFsdWU6IF9wcml2YXRlLm5vcm1hbGl6ZU1vZGVsTmFtZQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBfcHJpdmF0ZS5EUzsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvaW5pdGlhbGl6ZS1zdG9yZS1zZXJ2aWNlJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IGluaXRpYWxpemVTdG9yZVNlcnZpY2U7CiAgLyoKICAgIENvbmZpZ3VyZXMgYSByZWdpc3RyeSBmb3IgdXNlIHdpdGggYW4gRW1iZXItRGF0YQogICAgc3RvcmUuCiAgCiAgICBAbWV0aG9kIGluaXRpYWxpemVTdG9yZVNlcnZpY2UKICAgIEBwYXJhbSB7RW1iZXIuQXBwbGljYXRpb25JbnN0YW5jZSB8IEVtYmVyLkVuZ2luZUluc3RhbmNlfSBpbnN0YW5jZQogICovCiAgZnVuY3Rpb24gaW5pdGlhbGl6ZVN0b3JlU2VydmljZShpbnN0YW5jZSkgewogICAgLy8gaW5zdGFuY2UubG9va3VwIHN1cHBvcnRzIEVtYmVyIDIuMSBhbmQgaGlnaGVyCiAgICAvLyBpbnN0YW5jZS5jb250YWluZXIgc3VwcG9ydHMgRW1iZXIgMS4xMSAtIDIuMAogICAgdmFyIGNvbnRhaW5lciA9IGluc3RhbmNlLmxvb2t1cCA/IGluc3RhbmNlIDogaW5zdGFuY2UuY29udGFpbmVyOwoKICAgIC8vIEVhZ2VybHkgZ2VuZXJhdGUgdGhlIHN0b3JlIHNvIGRlZmF1bHRTdG9yZSBpcyBwb3B1bGF0ZWQuCiAgICBjb250YWluZXIubG9va3VwKCdzZXJ2aWNlOnN0b3JlJyk7CiAgfQp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9tb2RlbCcsIFsnZXhwb3J0cycsICdlbWJlci1kYXRhLy1wcml2YXRlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcHJpdmF0ZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2RlZmF1bHQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5Nb2RlbDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvcmVsYXRpb25zaGlwcycsIFsnZXhwb3J0cycsICdlbWJlci1kYXRhLy1wcml2YXRlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcHJpdmF0ZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2JlbG9uZ3NUbycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9wcml2YXRlLmJlbG9uZ3NUbzsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2hhc01hbnknLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5oYXNNYW55OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9zZXJpYWxpemVyJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewoKICAgIC8qKgogICAgICBUaGUgYHN0b3JlYCBwcm9wZXJ0eSBpcyB0aGUgYXBwbGljYXRpb24ncyBgc3RvcmVgIHRoYXQgY29udGFpbnMKICAgICAgYWxsIHJlY29yZHMuIEl0IGNhbiBiZSB1c2VkIHRvIGxvb2sgdXAgc2VyaWFsaXplcnMgZm9yIG90aGVyIG1vZGVsCiAgICAgIHR5cGVzIHRoYXQgbWF5IGJlIG5lc3RlZCBpbnNpZGUgdGhlIHBheWxvYWQgcmVzcG9uc2UuCiAgICAgICBFeGFtcGxlOgogICAgICAgYGBganMKICAgICAgU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIGV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwTW9kZWxOYW1lLCByZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgICB2YXIgbW9kZWxDbGFzcyA9IHRoaXMuc3RvcmUubW9kZWxGb3IocmVsYXRpb25zaGlwTW9kZWxOYW1lKTsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBTZXJpYWxpemVyID0gdGhpcy5zdG9yZS5zZXJpYWxpemVyRm9yKHJlbGF0aW9uc2hpcE1vZGVsTmFtZSk7CiAgICAgICAgICByZXR1cm4gcmVsYXRpb25zaGlwU2VyaWFsaXplci5ub3JtYWxpemUobW9kZWxDbGFzcywgcmVsYXRpb25zaGlwSGFzaCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAcHJvcGVydHkgc3RvcmUKICAgICAgQHR5cGUge0RTLlN0b3JlfQogICAgICBAcHVibGljCiAgICAqLwoKICAgIC8qKgogICAgICBUaGUgYG5vcm1hbGl6ZVJlc3BvbnNlYCBtZXRob2QgaXMgdXNlZCB0byBub3JtYWxpemUgYSBwYXlsb2FkIGZyb20gdGhlCiAgICAgIHNlcnZlciB0byBhIEpTT04tQVBJIERvY3VtZW50LgogICAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtc3RydWN0dXJlCiAgICAgICBFeGFtcGxlOgogICAgICAgYGBganMKICAgICAgU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIG5vcm1hbGl6ZVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgICAgICBpZiAocmVxdWVzdFR5cGUgPT09ICdmaW5kUmVjb3JkJykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUocHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQucmVkdWNlKGZ1bmN0aW9uKGRvY3VtZW50SGFzaCwgaXRlbSkgewogICAgICAgICAgICAgIGxldCB7IGRhdGEsIGluY2x1ZGVkIH0gPSB0aGlzLm5vcm1hbGl6ZShwcmltYXJ5TW9kZWxDbGFzcywgaXRlbSk7CiAgICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmluY2x1ZGVkLnB1c2goLi4uaW5jbHVkZWQpOwogICAgICAgICAgICAgIGRvY3VtZW50SGFzaC5kYXRhLnB1c2goZGF0YSk7CiAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgICAgICAgICAgfSwgeyBkYXRhOiBbXSwgaW5jbHVkZWQ6IFtdIH0pCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplUmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZVJlc3BvbnNlOiBudWxsLAoKICAgIC8qKgogICAgICBUaGUgYHNlcmlhbGl6ZWAgbWV0aG9kIGlzIHVzZWQgd2hlbiBhIHJlY29yZCBpcyBzYXZlZCBpbiBvcmRlciB0byBjb252ZXJ0CiAgICAgIHRoZSByZWNvcmQgaW50byB0aGUgZm9ybSB0aGF0IHlvdXIgZXh0ZXJuYWwgZGF0YSBzb3VyY2UgZXhwZWN0cy4KICAgICAgIGBzZXJpYWxpemVgIHRha2VzIGFuIG9wdGlvbmFsIGBvcHRpb25zYCBoYXNoIHdpdGggYSBzaW5nbGUgb3B0aW9uOgogICAgICAgLSBgaW5jbHVkZUlkYDogSWYgdGhpcyBpcyBgdHJ1ZWAsIGBzZXJpYWxpemVgIHNob3VsZCBpbmNsdWRlIHRoZSBJRAogICAgICAgIGluIHRoZSBzZXJpYWxpemVkIG9iamVjdCBpdCBidWlsZHMuCiAgICAgICBFeGFtcGxlOgogICAgICAgYGBganMKICAgICAgU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIGpzb24gPSB7CiAgICAgICAgICAgIGlkOiBzbmFwc2hvdC5pZAogICAgICAgICAgfTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKChrZXksIGF0dHJpYnV0ZSkgPT4gewogICAgICAgICAgICBqc29uW2tleV0gPSBzbmFwc2hvdC5hdHRyKGtleSk7CiAgICAgICAgICB9KTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoUmVsYXRpb25zaGlwKChrZXksIHJlbGF0aW9uc2hpcCkgPT4gewogICAgICAgICAgICBpZiAocmVsYXRpb25zaGlwLmtpbmQgPT09ICdiZWxvbmdzVG8nKSB7CiAgICAgICAgICAgICAganNvbltrZXldID0gc25hcHNob3QuYmVsb25nc1RvKGtleSwgeyBpZDogdHJ1ZSB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgICAganNvbltrZXldID0gc25hcHNob3QuaGFzTWFueShrZXksIHsgaWRzOiB0cnVlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9LAogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBzZXJpYWxpemU6IG51bGwsCgogICAgLyoqCiAgICAgIFRoZSBgbm9ybWFsaXplYCBtZXRob2QgaXMgdXNlZCB0byBjb252ZXJ0IGEgcGF5bG9hZCByZWNlaXZlZCBmcm9tIHlvdXIKICAgICAgZXh0ZXJuYWwgZGF0YSBzb3VyY2UgaW50byB0aGUgbm9ybWFsaXplZCBmb3JtIGBzdG9yZS5wdXNoKClgIGV4cGVjdHMuIFlvdQogICAgICBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QsIG11bmdlIHRoZSBoYXNoIGFuZCByZXR1cm4gdGhlIG5vcm1hbGl6ZWQKICAgICAgcGF5bG9hZC4KICAgICAgIEV4YW1wbGU6CiAgICAgICBgYGBqcwogICAgICBTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgbm9ybWFsaXplKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgIGlkOiAgICAgICAgICAgIHJlc291cmNlSGFzaC5pZCwKICAgICAgICAgICAgdHlwZTogICAgICAgICAgbW9kZWxDbGFzcy5tb2RlbE5hbWUsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6ICAgIHJlc291cmNlSGFzaAogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB7IGRhdGE6IGRhdGEgfTsKICAgICAgICB9CiAgICAgIH0pCiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBub3JtYWxpemUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBub3JtYWxpemUodHlwZUNsYXNzLCBoYXNoKSB7CiAgICAgIHJldHVybiBoYXNoOwogICAgfQoKICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvc2VyaWFsaXplcnMvZW1iZWRkZWQtcmVjb3Jkcy1taXhpbicsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5NaXhpbi5jcmVhdGUoewoKICAgIC8qKgogICAgICBOb3JtYWxpemUgdGhlIHJlY29yZCBhbmQgcmVjdXJzaXZlbHkgbm9ybWFsaXplL2V4dHJhY3QgYWxsIHRoZSBlbWJlZGRlZCByZWNvcmRzCiAgICAgIHdoaWxlIHB1c2hpbmcgdGhlbSBpbnRvIHRoZSBzdG9yZSBhcyB0aGV5IGFyZSBlbmNvdW50ZXJlZAogICAgICAgQSBwYXlsb2FkIHdpdGggYW4gYXR0ciBjb25maWd1cmVkIGZvciBlbWJlZGRlZCByZWNvcmRzIG5lZWRzIHRvIGJlIGV4dHJhY3RlZDoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAicG9zdCI6IHsKICAgICAgICAgICJpZCI6ICIxIgogICAgICAgICAgInRpdGxlIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICAgImlkIjogIjEiLAogICAgICAgICAgICAiYm9keSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgImlkIjogIjIiLAogICAgICAgICAgICAiYm9keSI6ICJPbWFrYXNlIE9fbyIKICAgICAgICAgIH1dCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgIEBtZXRob2Qgbm9ybWFsaXplCiAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZUNsYXNzCiAgICAgQHBhcmFtIHtPYmplY3R9IGhhc2ggdG8gYmUgbm9ybWFsaXplZAogICAgIEBwYXJhbSB7U3RyaW5nfSBwcm9wIHRoZSBoYXNoIGhhcyBiZWVuIHJlZmVyZW5jZWQgYnkKICAgICBAcmV0dXJuIHtPYmplY3R9IHRoZSBub3JtYWxpemVkIGhhc2gKICAgICoqLwogICAgbm9ybWFsaXplKHR5cGVDbGFzcywgaGFzaCwgcHJvcCkgewogICAgICB2YXIgbm9ybWFsaXplZEhhc2ggPSB0aGlzLl9zdXBlcih0eXBlQ2xhc3MsIGhhc2gsIHByb3ApOwogICAgICByZXR1cm4gdGhpcy5fZXh0cmFjdEVtYmVkZGVkUmVjb3Jkcyh0aGlzLCB0aGlzLnN0b3JlLCB0eXBlQ2xhc3MsIG5vcm1hbGl6ZWRIYXNoKTsKICAgIH0sCgogICAga2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgdHlwZUNsYXNzLCBtZXRob2QpIHsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3NlcmlhbGl6ZScgJiYgdGhpcy5oYXNTZXJpYWxpemVSZWNvcmRzT3B0aW9uKGtleSkgfHwgbWV0aG9kID09PSAnZGVzZXJpYWxpemUnICYmIHRoaXMuaGFzRGVzZXJpYWxpemVSZWNvcmRzT3B0aW9uKGtleSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5LCBtZXRob2QpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLl9zdXBlcihrZXksIHR5cGVDbGFzcywgbWV0aG9kKSB8fCBrZXk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIFNlcmlhbGl6ZSBgYmVsb25nc1RvYCByZWxhdGlvbnNoaXAgd2hlbiBpdCBpcyBjb25maWd1cmVkIGFzIGFuIGVtYmVkZGVkIG9iamVjdC4KICAgICAgIFRoaXMgZXhhbXBsZSBvZiBhbiBhdXRob3IgbW9kZWwgYmVsb25ncyB0byBhIHBvc3QgbW9kZWw6CiAgICAgICBgYGBqcwogICAgICBQb3N0ID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgICB0aXRsZTogICAgRFMuYXR0cignc3RyaW5nJyksCiAgICAgICAgYm9keTogICAgIERTLmF0dHIoJ3N0cmluZycpLAogICAgICAgIGF1dGhvcjogICBEUy5iZWxvbmdzVG8oJ2F1dGhvcicpCiAgICAgIH0pOwogICAgICAgQXV0aG9yID0gRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgICBuYW1lOiAgICAgRFMuYXR0cignc3RyaW5nJyksCiAgICAgICAgcG9zdDogICAgIERTLmJlbG9uZ3NUbygncG9zdCcpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFVzZSBhIGN1c3RvbSAodHlwZSkgc2VyaWFsaXplciBmb3IgdGhlIHBvc3QgbW9kZWwgdG8gY29uZmlndXJlIGVtYmVkZGVkIGF1dGhvcgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKERTLkVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGF1dGhvcjogeyBlbWJlZGRlZDogJ2Fsd2F5cycgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBBIHBheWxvYWQgd2l0aCBhbiBhdHRyaWJ1dGUgY29uZmlndXJlZCBmb3IgZW1iZWRkZWQgcmVjb3JkcyBjYW4gc2VyaWFsaXplCiAgICAgIHRoZSByZWNvcmRzIHRvZ2V0aGVyIHVuZGVyIHRoZSByb290IGF0dHJpYnV0ZSdzIHBheWxvYWQ6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3QiOiB7CiAgICAgICAgICAiaWQiOiAiMSIKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJhdXRob3IiOiB7CiAgICAgICAgICAgICJpZCI6ICIyIgogICAgICAgICAgICAibmFtZSI6ICJkaGgiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVCZWxvbmdzVG8KICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICAgKi8KICAgIHNlcmlhbGl6ZUJlbG9uZ3NUbyhzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBhdHRyID0gcmVsYXRpb25zaGlwLmtleTsKICAgICAgaWYgKHRoaXMubm9TZXJpYWxpemVPcHRpb25TcGVjaWZpZWQoYXR0cikpIHsKICAgICAgICB0aGlzLl9zdXBlcihzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGluY2x1ZGVJZHMgPSB0aGlzLmhhc1NlcmlhbGl6ZUlkc09wdGlvbihhdHRyKTsKICAgICAgdmFyIGluY2x1ZGVSZWNvcmRzID0gdGhpcy5oYXNTZXJpYWxpemVSZWNvcmRzT3B0aW9uKGF0dHIpOwogICAgICB2YXIgZW1iZWRkZWRTbmFwc2hvdCA9IHNuYXBzaG90LmJlbG9uZ3NUbyhhdHRyKTsKICAgICAgaWYgKGluY2x1ZGVJZHMpIHsKICAgICAgICB2YXIgc2VyaWFsaXplZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShyZWxhdGlvbnNoaXAua2V5LCBzbmFwc2hvdC50eXBlKTsKICAgICAgICBpZiAoc2VyaWFsaXplZEtleSA9PT0gcmVsYXRpb25zaGlwLmtleSAmJiB0aGlzLmtleUZvclJlbGF0aW9uc2hpcCkgewogICAgICAgICAgc2VyaWFsaXplZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcC5rZXksIHJlbGF0aW9uc2hpcC5raW5kLCAic2VyaWFsaXplIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWVtYmVkZGVkU25hcHNob3QpIHsKICAgICAgICAgIGpzb25bc2VyaWFsaXplZEtleV0gPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqc29uW3NlcmlhbGl6ZWRLZXldID0gZW1iZWRkZWRTbmFwc2hvdC5pZDsKCiAgICAgICAgICBpZiAocmVsYXRpb25zaGlwLm9wdGlvbnMucG9seW1vcnBoaWMpIHsKICAgICAgICAgICAgdGhpcy5zZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGluY2x1ZGVSZWNvcmRzKSB7CiAgICAgICAgdGhpcy5fc2VyaWFsaXplRW1iZWRkZWRCZWxvbmdzVG8oc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgIH0KICAgIH0sCgogICAgX3NlcmlhbGl6ZUVtYmVkZGVkQmVsb25nc1RvKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGVtYmVkZGVkU25hcHNob3QgPSBzbmFwc2hvdC5iZWxvbmdzVG8ocmVsYXRpb25zaGlwLmtleSk7CiAgICAgIHZhciBzZXJpYWxpemVkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KHJlbGF0aW9uc2hpcC5rZXksIHNuYXBzaG90LnR5cGUpOwogICAgICBpZiAoc2VyaWFsaXplZEtleSA9PT0gcmVsYXRpb25zaGlwLmtleSAmJiB0aGlzLmtleUZvclJlbGF0aW9uc2hpcCkgewogICAgICAgIHNlcmlhbGl6ZWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXAua2V5LCByZWxhdGlvbnNoaXAua2luZCwgInNlcmlhbGl6ZSIpOwogICAgICB9CgogICAgICBpZiAoIWVtYmVkZGVkU25hcHNob3QpIHsKICAgICAgICBqc29uW3NlcmlhbGl6ZWRLZXldID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBqc29uW3NlcmlhbGl6ZWRLZXldID0gZW1iZWRkZWRTbmFwc2hvdC5zZXJpYWxpemUoeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgdGhpcy5yZW1vdmVFbWJlZGRlZEZvcmVpZ25LZXkoc25hcHNob3QsIGVtYmVkZGVkU25hcHNob3QsIHJlbGF0aW9uc2hpcCwganNvbltzZXJpYWxpemVkS2V5XSk7CgogICAgICAgIGlmIChyZWxhdGlvbnNoaXAub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICAgICAgdGhpcy5zZXJpYWxpemVQb2x5bW9ycGhpY1R5cGUoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBTZXJpYWxpemVzIGBoYXNNYW55YCByZWxhdGlvbnNoaXBzIHdoZW4gaXQgaXMgY29uZmlndXJlZCBhcyBlbWJlZGRlZCBvYmplY3RzLgogICAgICAgVGhpcyBleGFtcGxlIG9mIGEgcG9zdCBtb2RlbCBoYXMgbWFueSBjb21tZW50czoKICAgICAgIGBgYGpzCiAgICAgIFBvc3QgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIHRpdGxlOiAgICBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgICBib2R5OiAgICAgRFMuYXR0cignc3RyaW5nJyksCiAgICAgICAgY29tbWVudHM6IERTLmhhc01hbnkoJ2NvbW1lbnQnKQogICAgICB9KTsKICAgICAgIENvbW1lbnQgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIGJvZHk6ICAgICBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgICBwb3N0OiAgICAgRFMuYmVsb25nc1RvKCdwb3N0JykKICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgVXNlIGEgY3VzdG9tICh0eXBlKSBzZXJpYWxpemVyIGZvciB0aGUgcG9zdCBtb2RlbCB0byBjb25maWd1cmUgZW1iZWRkZWQgY29tbWVudHMKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKERTLkVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGNvbW1lbnRzOiB7IGVtYmVkZGVkOiAnYWx3YXlzJyB9CiAgICAgICAgfQogICAgICB9KQogICAgICBgYGAKICAgICAgIEEgcGF5bG9hZCB3aXRoIGFuIGF0dHJpYnV0ZSBjb25maWd1cmVkIGZvciBlbWJlZGRlZCByZWNvcmRzIGNhbiBzZXJpYWxpemUKICAgICAgdGhlIHJlY29yZHMgdG9nZXRoZXIgdW5kZXIgdGhlIHJvb3QgYXR0cmlidXRlJ3MgcGF5bG9hZDoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAicG9zdCI6IHsKICAgICAgICAgICJpZCI6ICIxIgogICAgICAgICAgInRpdGxlIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICAgImJvZHkiOiAiSSB3YW50IHRoaXMgZm9yIG15IE9STSwgSSB3YW50IHRoYXQgZm9yIG15IHRlbXBsYXRlIGxhbmd1YWdlLi4uIgogICAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICAgImlkIjogIjEiLAogICAgICAgICAgICAiYm9keSI6ICJSYWlscyBpcyB1bmFnaSIKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgImlkIjogIjIiLAogICAgICAgICAgICAiYm9keSI6ICJPbWFrYXNlIE9fbyIKICAgICAgICAgIH1dCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhlIGF0dHJzIG9wdGlvbnMgb2JqZWN0IGNhbiB1c2UgbW9yZSBzcGVjaWZpYyBpbnN0cnVjdGlvbiBmb3IgZXh0cmFjdGluZyBhbmQKICAgICAgc2VyaWFsaXppbmcuIFdoZW4gc2VyaWFsaXppbmcsIGFuIG9wdGlvbiB0byBlbWJlZCBgaWRzYCwgYGlkcy1hbmQtdHlwZXNgIG9yIGByZWNvcmRzYCBjYW4gYmUgc2V0LgogICAgICBXaGVuIGV4dHJhY3RpbmcgdGhlIG9ubHkgb3B0aW9uIGlzIGByZWNvcmRzYC4KICAgICAgIFNvIGB7IGVtYmVkZGVkOiAnYWx3YXlzJyB9YCBpcyBzaG9ydGhhbmQgZm9yOgogICAgICBgeyBzZXJpYWxpemU6ICdyZWNvcmRzJywgZGVzZXJpYWxpemU6ICdyZWNvcmRzJyB9YAogICAgICAgVG8gZW1iZWQgdGhlIGBpZHNgIGZvciBhIHJlbGF0ZWQgb2JqZWN0ICh1c2luZyBhIGhhc01hbnkgcmVsYXRpb25zaGlwKToKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKERTLkVtYmVkZGVkUmVjb3Jkc01peGluLCB7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGNvbW1lbnRzOiB7IHNlcmlhbGl6ZTogJ2lkcycsIGRlc2VyaWFsaXplOiAncmVjb3JkcycgfQogICAgICAgIH0KICAgICAgfSkKICAgICAgYGBgCiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3QiOiB7CiAgICAgICAgICAiaWQiOiAiMSIKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJib2R5IjogIkkgd2FudCB0aGlzIGZvciBteSBPUk0sIEkgd2FudCB0aGF0IGZvciBteSB0ZW1wbGF0ZSBsYW5ndWFnZS4uLiIKICAgICAgICAgICJjb21tZW50cyI6IFsiMSIsICIyIl0KICAgICAgICB9CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBUbyBlbWJlZCB0aGUgcmVsYXRpb25zaGlwIGFzIGEgY29sbGVjdGlvbiBvZiBvYmplY3RzIHdpdGggYGlkYCBhbmQgYHR5cGVgIGtleXMsIHNldAogICAgICBgaWRzLWFuZC10eXBlc2AgZm9yIHRoZSByZWxhdGVkIG9iamVjdC4KICAgICAgIFRoaXMgaXMgcGFydGljdWxhcmx5IHVzZWZ1bCBmb3IgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwcyB3aGVyZSByZWNvcmRzIGRvbid0IHNoYXJlCiAgICAgIHRoZSBzYW1lIHRhYmxlIGFuZCB0aGUgYGlkYCBpcyBub3QgZW5vdWdoIGluZm9ybWF0aW9uLgogICAgICAgQnkgZXhhbXBsZSBoYXZpbmcgYSB1c2VyIHRoYXQgaGFzIG1hbnkgcGV0czoKICAgICAgIGBgYGpzCiAgICAgIFVzZXIgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIG5hbWU6ICAgIERTLmF0dHIoJ3N0cmluZycpLAogICAgICAgIHBldHM6IERTLmhhc01hbnkoJ3BldCcsIHsgcG9seW1vcnBoaWM6IHRydWUgfSkKICAgICAgfSk7CiAgICAgICBQZXQgPSBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIG5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICB9KTsKICAgICAgIENhdCA9IFBldC5leHRlbmQoewogICAgICAgIC8vIC4uLgogICAgICB9KTsKICAgICAgIFBhcnJvdCA9IFBldC5leHRlbmQoewogICAgICAgIC8vIC4uLgogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvdXNlci5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YTsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZChEUy5FbWJlZGRlZFJlY29yZHNNaXhpbiwgewogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICBwZXRzOiB7IHNlcmlhbGl6ZTogJ2lkcy1hbmQtdHlwZXMnLCBkZXNlcmlhbGl6ZTogJ3JlY29yZHMnIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAidXNlciI6IHsKICAgICAgICAgICJpZCI6ICIxIgogICAgICAgICAgIm5hbWUiOiAiQmVydGluIE9zYm9ybmUiLAogICAgICAgICAgInBldHMiOiBbCiAgICAgICAgICAgIHsgImlkIjogIjEiLCAidHlwZSI6ICJDYXQiIH0sCiAgICAgICAgICAgIHsgImlkIjogIjEiLCAidHlwZSI6ICJQYXJyb3QifQogICAgICAgICAgXQogICAgICAgIH0KICAgICAgfQogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplSGFzTWFueQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAqLwogICAgc2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBhdHRyID0gcmVsYXRpb25zaGlwLmtleTsKICAgICAgaWYgKHRoaXMubm9TZXJpYWxpemVPcHRpb25TcGVjaWZpZWQoYXR0cikpIHsKICAgICAgICB0aGlzLl9zdXBlcihzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmhhc1NlcmlhbGl6ZUlkc09wdGlvbihhdHRyKSkgewogICAgICAgIHZhciBzZXJpYWxpemVkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KHJlbGF0aW9uc2hpcC5rZXksIHNuYXBzaG90LnR5cGUpOwogICAgICAgIGlmIChzZXJpYWxpemVkS2V5ID09PSByZWxhdGlvbnNoaXAua2V5ICYmIHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICBzZXJpYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwLmtleSwgcmVsYXRpb25zaGlwLmtpbmQsICJzZXJpYWxpemUiKTsKICAgICAgICB9CgogICAgICAgIGpzb25bc2VyaWFsaXplZEtleV0gPSBzbmFwc2hvdC5oYXNNYW55KGF0dHIsIHsgaWRzOiB0cnVlIH0pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuaGFzU2VyaWFsaXplUmVjb3Jkc09wdGlvbihhdHRyKSkgewogICAgICAgIHRoaXMuX3NlcmlhbGl6ZUVtYmVkZGVkSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5oYXNTZXJpYWxpemVJZHNBbmRUeXBlc09wdGlvbihhdHRyKSkgewogICAgICAgICAgdGhpcy5fc2VyaWFsaXplSGFzTWFueUFzSWRzQW5kVHlwZXMoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qCiAgICAgIFNlcmlhbGl6ZXMgYSBoYXNNYW55IHJlbGF0aW9uc2hpcCBhcyBhbiBhcnJheSBvZiBvYmplY3RzIGNvbnRhaW5pbmcgb25seSBgaWRgIGFuZCBgdHlwZWAKICAgICAga2V5cy4KICAgICAgVGhpcyBoYXMgaXRzIHVzZSBjYXNlIG9uIHBvbHltb3JwaGljIGhhc01hbnkgcmVsYXRpb25zaGlwcyB3aGVyZSB0aGUgc2VydmVyIGlzIG5vdCBzdG9yaW5nCiAgICAgIGFsbCByZWNvcmRzIGluIHRoZSBzYW1lIHRhYmxlIHVzaW5nIFNUSSwgYW5kIHRoZXJlZm9yZSB0aGUgYGlkYCBpcyBub3QgZW5vdWdoIGluZm9ybWF0aW9uCiAgICAgICBUT0RPOiBNYWtlIHRoZSBkZWZhdWx0IGluIEVtYmVyLWRhdGEgMy4wPz8KICAgICovCiAgICBfc2VyaWFsaXplSGFzTWFueUFzSWRzQW5kVHlwZXMoc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgc2VyaWFsaXplZEtleSA9IHRoaXMua2V5Rm9yQXR0cmlidXRlKHJlbGF0aW9uc2hpcC5rZXksICdzZXJpYWxpemUnKTsKICAgICAgdmFyIGhhc01hbnkgPSBzbmFwc2hvdC5oYXNNYW55KHJlbGF0aW9uc2hpcC5rZXkpOwoKICAgICAganNvbltzZXJpYWxpemVkS2V5XSA9IEVtYmVyLkEoaGFzTWFueSkubWFwKGZ1bmN0aW9uIChyZWNvcmRTbmFwc2hvdCkgewogICAgICAgIC8vCiAgICAgICAgLy8gSSdtIHN1cmUgSSdtIGJlaW5nIHV0dGVybHkgbmFpdmUgaGVyZS4gUHJvcGFibHkgaWQgaXMgYSBjb25maWd1cmF0ZSBwcm9wZXJ0eSBhbmQKICAgICAgICAvLyB0eXBlIHRvbywgYW5kIHRoZSBtb2RlbE5hbWUgaGFzIHRvIGJlIG5vcm1hbGl6ZWQgc29tZWhvdy4KICAgICAgICAvLwogICAgICAgIHJldHVybiB7IGlkOiByZWNvcmRTbmFwc2hvdC5pZCwgdHlwZTogcmVjb3JkU25hcHNob3QubW9kZWxOYW1lIH07CiAgICAgIH0pOwogICAgfSwKCiAgICBfc2VyaWFsaXplRW1iZWRkZWRIYXNNYW55KHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIHNlcmlhbGl6ZWRLZXkgPSB0aGlzLl9nZXRNYXBwZWRLZXkocmVsYXRpb25zaGlwLmtleSwgc25hcHNob3QudHlwZSk7CiAgICAgIGlmIChzZXJpYWxpemVkS2V5ID09PSByZWxhdGlvbnNoaXAua2V5ICYmIHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKSB7CiAgICAgICAgc2VyaWFsaXplZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcC5rZXksIHJlbGF0aW9uc2hpcC5raW5kLCAic2VyaWFsaXplIik7CiAgICAgIH0KCiAgICAgICh0cnVlICYmIEVtYmVyLndhcm4oYFRoZSBlbWJlZGRlZCByZWxhdGlvbnNoaXAgJyR7c2VyaWFsaXplZEtleX0nIGlzIHVuZGVmaW5lZCBmb3IgJyR7c25hcHNob3QubW9kZWxOYW1lfScgd2l0aCBpZCAnJHtzbmFwc2hvdC5pZH0nLiBQbGVhc2UgaW5jbHVkZSBpdCBpbiB5b3VyIG9yaWdpbmFsIHBheWxvYWQuYCwgRW1iZXIudHlwZU9mKHNuYXBzaG90Lmhhc01hbnkocmVsYXRpb25zaGlwLmtleSkpICE9PSAndW5kZWZpbmVkJywgeyBpZDogJ2RzLnNlcmlhbGl6ZXIuZW1iZWRkZWQtcmVsYXRpb25zaGlwLXVuZGVmaW5lZCcgfSkpOwoKCiAgICAgIGpzb25bc2VyaWFsaXplZEtleV0gPSB0aGlzLl9nZW5lcmF0ZVNlcmlhbGl6ZWRIYXNNYW55KHNuYXBzaG90LCByZWxhdGlvbnNoaXApOwogICAgfSwKCiAgICAvKgogICAgICBSZXR1cm5zIGFuIGFycmF5IG9mIGVtYmVkZGVkIHJlY29yZHMgc2VyaWFsaXplZCB0byBKU09OCiAgICAqLwogICAgX2dlbmVyYXRlU2VyaWFsaXplZEhhc01hbnkoc25hcHNob3QsIHJlbGF0aW9uc2hpcCkgewogICAgICB2YXIgaGFzTWFueSA9IHNuYXBzaG90Lmhhc01hbnkocmVsYXRpb25zaGlwLmtleSk7CiAgICAgIHZhciBtYW55QXJyYXkgPSBFbWJlci5BKGhhc01hbnkpOwogICAgICB2YXIgcmV0ID0gbmV3IEFycmF5KG1hbnlBcnJheS5sZW5ndGgpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtYW55QXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZW1iZWRkZWRTbmFwc2hvdCA9IG1hbnlBcnJheVtpXTsKICAgICAgICB2YXIgZW1iZWRkZWRKc29uID0gZW1iZWRkZWRTbmFwc2hvdC5zZXJpYWxpemUoeyBpbmNsdWRlSWQ6IHRydWUgfSk7CiAgICAgICAgdGhpcy5yZW1vdmVFbWJlZGRlZEZvcmVpZ25LZXkoc25hcHNob3QsIGVtYmVkZGVkU25hcHNob3QsIHJlbGF0aW9uc2hpcCwgZW1iZWRkZWRKc29uKTsKICAgICAgICByZXRbaV0gPSBlbWJlZGRlZEpzb247CiAgICAgIH0KCiAgICAgIHJldHVybiByZXQ7CiAgICB9LAoKICAgIC8qKgogICAgICBXaGVuIHNlcmlhbGl6aW5nIGFuIGVtYmVkZGVkIHJlY29yZCwgbW9kaWZ5IHRoZSBwcm9wZXJ0eSAoaW4gdGhlIGpzb24gcGF5bG9hZCkKICAgICAgdGhhdCByZWZlcnMgdG8gdGhlIHBhcmVudCByZWNvcmQgKGZvcmVpZ24ga2V5IGZvciByZWxhdGlvbnNoaXApLgogICAgICAgU2VyaWFsaXppbmcgYSBgYmVsb25nc1RvYCByZWxhdGlvbnNoaXAgcmVtb3ZlcyB0aGUgcHJvcGVydHkgdGhhdCByZWZlcnMgdG8gdGhlCiAgICAgIHBhcmVudCByZWNvcmQKICAgICAgIFNlcmlhbGl6aW5nIGEgYGhhc01hbnlgIHJlbGF0aW9uc2hpcCBkb2VzIG5vdCByZW1vdmUgdGhlIHByb3BlcnR5IHRoYXQgcmVmZXJzIHRvCiAgICAgIHRoZSBwYXJlbnQgcmVjb3JkLgogICAgICAgQG1ldGhvZCByZW1vdmVFbWJlZGRlZEZvcmVpZ25LZXkKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gZW1iZWRkZWRTbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBqc29uCiAgICAqLwogICAgcmVtb3ZlRW1iZWRkZWRGb3JlaWduS2V5KHNuYXBzaG90LCBlbWJlZGRlZFNuYXBzaG90LCByZWxhdGlvbnNoaXAsIGpzb24pIHsKICAgICAgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnYmVsb25nc1RvJykgewogICAgICAgIHZhciBwYXJlbnRSZWNvcmQgPSBzbmFwc2hvdC50eXBlLmludmVyc2VGb3IocmVsYXRpb25zaGlwLmtleSwgdGhpcy5zdG9yZSk7CiAgICAgICAgaWYgKHBhcmVudFJlY29yZCkgewogICAgICAgICAgdmFyIG5hbWUgPSBwYXJlbnRSZWNvcmQubmFtZTsKICAgICAgICAgIHZhciBlbWJlZGRlZFNlcmlhbGl6ZXIgPSB0aGlzLnN0b3JlLnNlcmlhbGl6ZXJGb3IoZW1iZWRkZWRTbmFwc2hvdC5tb2RlbE5hbWUpOwogICAgICAgICAgdmFyIHBhcmVudEtleSA9IGVtYmVkZGVkU2VyaWFsaXplci5rZXlGb3JSZWxhdGlvbnNoaXAobmFtZSwgcGFyZW50UmVjb3JkLmtpbmQsICdkZXNlcmlhbGl6ZScpOwogICAgICAgICAgaWYgKHBhcmVudEtleSkgewogICAgICAgICAgICBkZWxldGUganNvbltwYXJlbnRLZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvKmVsc2UgaWYgKHJlbGF0aW9uc2hpcC5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICByZXR1cm47CiAgICAgICAgfSovCiAgICB9LAoKICAgIC8vIGNoZWNrcyBjb25maWcgZm9yIGF0dHJzIG9wdGlvbiB0byBlbWJlZGRlZCAoYWx3YXlzKSAtIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUKICAgIGhhc0VtYmVkZGVkQWx3YXlzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiBvcHRpb24gJiYgb3B0aW9uLmVtYmVkZGVkID09PSAnYWx3YXlzJzsKICAgIH0sCgogICAgLy8gY2hlY2tzIGNvbmZpZyBmb3IgYXR0cnMgb3B0aW9uIHRvIHNlcmlhbGl6ZSBpZHMKICAgIGhhc1NlcmlhbGl6ZVJlY29yZHNPcHRpb24oYXR0cikgewogICAgICB2YXIgYWx3YXlzRW1iZWQgPSB0aGlzLmhhc0VtYmVkZGVkQWx3YXlzT3B0aW9uKGF0dHIpOwogICAgICB2YXIgb3B0aW9uID0gdGhpcy5hdHRyc09wdGlvbihhdHRyKTsKICAgICAgcmV0dXJuIGFsd2F5c0VtYmVkIHx8IG9wdGlvbiAmJiBvcHRpb24uc2VyaWFsaXplID09PSAncmVjb3Jkcyc7CiAgICB9LAoKICAgIC8vIGNoZWNrcyBjb25maWcgZm9yIGF0dHJzIG9wdGlvbiB0byBzZXJpYWxpemUgcmVjb3JkcwogICAgaGFzU2VyaWFsaXplSWRzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiBvcHRpb24gJiYgKG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZHMnIHx8IG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZCcpOwogICAgfSwKCiAgICAvLyBjaGVja3MgY29uZmlnIGZvciBhdHRycyBvcHRpb24gdG8gc2VyaWFsaXplIHJlY29yZHMgYXMgb2JqZWN0cyBjb250YWluaW5nIGlkIGFuZCB0eXBlcwogICAgaGFzU2VyaWFsaXplSWRzQW5kVHlwZXNPcHRpb24oYXR0cikgewogICAgICB2YXIgb3B0aW9uID0gdGhpcy5hdHRyc09wdGlvbihhdHRyKTsKICAgICAgcmV0dXJuIG9wdGlvbiAmJiAob3B0aW9uLnNlcmlhbGl6ZSA9PT0gJ2lkcy1hbmQtdHlwZXMnIHx8IG9wdGlvbi5zZXJpYWxpemUgPT09ICdpZC1hbmQtdHlwZScpOwogICAgfSwKCiAgICAvLyBjaGVja3MgY29uZmlnIGZvciBhdHRycyBvcHRpb24gdG8gc2VyaWFsaXplIHJlY29yZHMKICAgIG5vU2VyaWFsaXplT3B0aW9uU3BlY2lmaWVkKGF0dHIpIHsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiAhKG9wdGlvbiAmJiAob3B0aW9uLnNlcmlhbGl6ZSB8fCBvcHRpb24uZW1iZWRkZWQpKTsKICAgIH0sCgogICAgLy8gY2hlY2tzIGNvbmZpZyBmb3IgYXR0cnMgb3B0aW9uIHRvIGRlc2VyaWFsaXplIHJlY29yZHMKICAgIC8vIGEgZGVmaW5lZCBvcHRpb24gb2JqZWN0IGZvciBhIHJlc291cmNlIGlzIHRyZWF0ZWQgdGhlIHNhbWUgYXMKICAgIC8vIGBkZXNlcmlhbGl6ZTogJ3JlY29yZHMnYAogICAgaGFzRGVzZXJpYWxpemVSZWNvcmRzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIGFsd2F5c0VtYmVkID0gdGhpcy5oYXNFbWJlZGRlZEFsd2F5c09wdGlvbihhdHRyKTsKICAgICAgdmFyIG9wdGlvbiA9IHRoaXMuYXR0cnNPcHRpb24oYXR0cik7CiAgICAgIHJldHVybiBhbHdheXNFbWJlZCB8fCBvcHRpb24gJiYgb3B0aW9uLmRlc2VyaWFsaXplID09PSAncmVjb3Jkcyc7CiAgICB9LAoKICAgIGF0dHJzT3B0aW9uKGF0dHIpIHsKICAgICAgdmFyIGF0dHJzID0gdGhpcy5nZXQoJ2F0dHJzJyk7CiAgICAgIHJldHVybiBhdHRycyAmJiAoYXR0cnNbRW1iZXIuU3RyaW5nLmNhbWVsaXplKGF0dHIpXSB8fCBhdHRyc1thdHRyXSk7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX2V4dHJhY3RFbWJlZGRlZFJlY29yZHMKICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9leHRyYWN0RW1iZWRkZWRSZWNvcmRzKHNlcmlhbGl6ZXIsIHN0b3JlLCB0eXBlQ2xhc3MsIHBhcnRpYWwpIHsKICAgICAgdHlwZUNsYXNzLmVhY2hSZWxhdGlvbnNoaXAoKGtleSwgcmVsYXRpb25zaGlwKSA9PiB7CiAgICAgICAgaWYgKHNlcmlhbGl6ZXIuaGFzRGVzZXJpYWxpemVSZWNvcmRzT3B0aW9uKGtleSkpIHsKICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gImhhc01hbnkiKSB7CiAgICAgICAgICAgIHRoaXMuX2V4dHJhY3RFbWJlZGRlZEhhc01hbnkoc3RvcmUsIGtleSwgcGFydGlhbCwgcmVsYXRpb25zaGlwKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gImJlbG9uZ3NUbyIpIHsKICAgICAgICAgICAgdGhpcy5fZXh0cmFjdEVtYmVkZGVkQmVsb25nc1RvKHN0b3JlLCBrZXksIHBhcnRpYWwsIHJlbGF0aW9uc2hpcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRpYWw7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX2V4dHJhY3RFbWJlZGRlZEhhc01hbnkKICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9leHRyYWN0RW1iZWRkZWRIYXNNYW55KHN0b3JlLCBrZXksIGhhc2gsIHJlbGF0aW9uc2hpcE1ldGEpIHsKICAgICAgdmFyIHJlbGF0aW9uc2hpcEhhc2ggPSBFbWJlci5nZXQoaGFzaCwgYGRhdGEucmVsYXRpb25zaGlwcy4ke2tleX0uZGF0YWApOwoKICAgICAgaWYgKCFyZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaGFzTWFueSA9IG5ldyBBcnJheShyZWxhdGlvbnNoaXBIYXNoLmxlbmd0aCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbGF0aW9uc2hpcEhhc2gubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaXRlbSA9IHJlbGF0aW9uc2hpcEhhc2hbaV07CiAgICAgICAgdmFyIHsgZGF0YSwgaW5jbHVkZWQgfSA9IHRoaXMuX25vcm1hbGl6ZUVtYmVkZGVkUmVsYXRpb25zaGlwKHN0b3JlLCByZWxhdGlvbnNoaXBNZXRhLCBpdGVtKTsKICAgICAgICBoYXNoLmluY2x1ZGVkID0gaGFzaC5pbmNsdWRlZCB8fCBbXTsKICAgICAgICBoYXNoLmluY2x1ZGVkLnB1c2goZGF0YSk7CiAgICAgICAgaWYgKGluY2x1ZGVkKSB7CiAgICAgICAgICBoYXNoLmluY2x1ZGVkLnB1c2goLi4uaW5jbHVkZWQpOwogICAgICAgIH0KCiAgICAgICAgaGFzTWFueVtpXSA9IHsgaWQ6IGRhdGEuaWQsIHR5cGU6IGRhdGEudHlwZSB9OwogICAgICB9CgogICAgICB2YXIgcmVsYXRpb25zaGlwID0geyBkYXRhOiBoYXNNYW55IH07CiAgICAgIEVtYmVyLnNldChoYXNoLCBgZGF0YS5yZWxhdGlvbnNoaXBzLiR7a2V5fWAsIHJlbGF0aW9uc2hpcCk7CiAgICB9LAoKICAgIC8qKgogICAgIEBtZXRob2QgX2V4dHJhY3RFbWJlZGRlZEJlbG9uZ3NUbwogICAgIEBwcml2YXRlCiAgICAqLwogICAgX2V4dHJhY3RFbWJlZGRlZEJlbG9uZ3NUbyhzdG9yZSwga2V5LCBoYXNoLCByZWxhdGlvbnNoaXBNZXRhKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gRW1iZXIuZ2V0KGhhc2gsIGBkYXRhLnJlbGF0aW9uc2hpcHMuJHtrZXl9LmRhdGFgKTsKICAgICAgaWYgKCFyZWxhdGlvbnNoaXBIYXNoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgeyBkYXRhLCBpbmNsdWRlZCB9ID0gdGhpcy5fbm9ybWFsaXplRW1iZWRkZWRSZWxhdGlvbnNoaXAoc3RvcmUsIHJlbGF0aW9uc2hpcE1ldGEsIHJlbGF0aW9uc2hpcEhhc2gpOwogICAgICBoYXNoLmluY2x1ZGVkID0gaGFzaC5pbmNsdWRlZCB8fCBbXTsKICAgICAgaGFzaC5pbmNsdWRlZC5wdXNoKGRhdGEpOwogICAgICBpZiAoaW5jbHVkZWQpIHsKICAgICAgICBoYXNoLmluY2x1ZGVkLnB1c2goLi4uaW5jbHVkZWQpOwogICAgICB9CgogICAgICB2YXIgYmVsb25nc1RvID0geyBpZDogZGF0YS5pZCwgdHlwZTogZGF0YS50eXBlIH07CiAgICAgIHZhciByZWxhdGlvbnNoaXAgPSB7IGRhdGE6IGJlbG9uZ3NUbyB9OwoKICAgICAgRW1iZXIuc2V0KGhhc2gsIGBkYXRhLnJlbGF0aW9uc2hpcHMuJHtrZXl9YCwgcmVsYXRpb25zaGlwKTsKICAgIH0sCgogICAgLyoqCiAgICAgQG1ldGhvZCBfbm9ybWFsaXplRW1iZWRkZWRSZWxhdGlvbnNoaXAKICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVFbWJlZGRlZFJlbGF0aW9uc2hpcChzdG9yZSwgcmVsYXRpb25zaGlwTWV0YSwgcmVsYXRpb25zaGlwSGFzaCkgewogICAgICB2YXIgbW9kZWxOYW1lID0gcmVsYXRpb25zaGlwTWV0YS50eXBlOwogICAgICBpZiAocmVsYXRpb25zaGlwTWV0YS5vcHRpb25zLnBvbHltb3JwaGljKSB7CiAgICAgICAgbW9kZWxOYW1lID0gcmVsYXRpb25zaGlwSGFzaC50eXBlOwogICAgICB9CiAgICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CgogICAgICByZXR1cm4gc2VyaWFsaXplci5ub3JtYWxpemUobW9kZWxDbGFzcywgcmVsYXRpb25zaGlwSGFzaCwgbnVsbCk7CiAgICB9LAogICAgaXNFbWJlZGRlZFJlY29yZHNNaXhpbjogdHJ1ZQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uLWFwaScsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3InLCAnZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uJywgJ2VtYmVyLWRhdGEvLXByaXZhdGUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckluZmxlY3RvciwgX2pzb24sIF9wcml2YXRlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgLyoqCiAgICBFbWJlciBEYXRhIDIuMCBTZXJpYWxpemVyOgogIAogICAgSW4gRW1iZXIgRGF0YSBhIFNlcmlhbGl6ZXIgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgICByZWNvcmRzIHdoZW4gdGhleSBhcmUgdHJhbnNmZXJyZWQgaW4gYW5kIG91dCBvZiBhbiBleHRlcm5hbCBzb3VyY2UuCiAgICBUaGlzIHByb2Nlc3MgaW52b2x2ZXMgbm9ybWFsaXppbmcgcHJvcGVydHkgbmFtZXMsIHRyYW5zZm9ybWluZwogICAgYXR0cmlidXRlIHZhbHVlcyBhbmQgc2VyaWFsaXppbmcgcmVsYXRpb25zaGlwcy4KICAKICAgIGBKU09OQVBJU2VyaWFsaXplcmAgc3VwcG9ydHMgdGhlIGh0dHA6Ly9qc29uYXBpLm9yZy8gc3BlYyBhbmQgaXMgdGhlCiAgICBzZXJpYWxpemVyIHJlY29tbWVuZGVkIGJ5IEVtYmVyIERhdGEuCiAgCiAgICBUaGlzIHNlcmlhbGl6ZXIgbm9ybWFsaXplcyBhIEpTT04gQVBJIHBheWxvYWQgdGhhdCBsb29rcyBsaWtlOgogIAogICAgYGBgYXBwL21vZGVscy9wbGF5ZXIuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIG5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICBza2lsbDogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIGdhbWVzUGxheWVkOiBEUy5hdHRyKCdudW1iZXInKSwKICAgICAgY2x1YjogRFMuYmVsb25nc1RvKCdjbHViJykKICAgIH0pOwogICAgYGBgCiAgCiAgICBgYGBhcHAvbW9kZWxzL2NsdWIuanMKICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAKICAgIGV4cG9ydCBkZWZhdWx0IERTLk1vZGVsLmV4dGVuZCh7CiAgICAgIG5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICBsb2NhdGlvbjogRFMuYXR0cignc3RyaW5nJyksCiAgICAgIHBsYXllcnM6IERTLmhhc01hbnkoJ3BsYXllcicpCiAgICB9KTsKICAgIGBgYAogIAogICAgYGBganMKICAgICAgewogICAgICAgICJkYXRhIjogWwogICAgICAgICAgewogICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAibmFtZSI6ICJCZW5maWNhIiwKICAgICAgICAgICAgICAibG9jYXRpb24iOiAiUG9ydHVnYWwiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICAgInJlbGF0aW9uc2hpcHMiOiB7CiAgICAgICAgICAgICAgInBsYXllcnMiOiB7CiAgICAgICAgICAgICAgICAiZGF0YSI6IFsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICJpZCI6ICIzIiwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJwbGF5ZXJzIgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAidHlwZSI6ICJjbHVicyIKICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgICJpbmNsdWRlZCI6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgImF0dHJpYnV0ZXMiOiB7CiAgICAgICAgICAgICAgIm5hbWUiOiAiRXVzZWJpbyBTaWx2YSBGZXJyZWlyYSIsCiAgICAgICAgICAgICAgInNraWxsIjogIlJvY2tldCBzaG90IiwKICAgICAgICAgICAgICAiZ2FtZXMtcGxheWVkIjogNDMxCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJpZCI6ICIzIiwKICAgICAgICAgICAgInJlbGF0aW9uc2hpcHMiOiB7CiAgICAgICAgICAgICAgImNsdWIiOiB7CiAgICAgICAgICAgICAgICAiZGF0YSI6IHsKICAgICAgICAgICAgICAgICAgImlkIjogIjEiLAogICAgICAgICAgICAgICAgICAidHlwZSI6ICJjbHVicyIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ0eXBlIjogInBsYXllcnMiCiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9CiAgICBgYGAKICAKICAgIHRvIHRoZSBmb3JtYXQgdGhhdCB0aGUgRW1iZXIgRGF0YSBzdG9yZSBleHBlY3RzLgogIAogICAgIyMjIEN1c3RvbWl6aW5nIG1ldGEKICAKICAgIFNpbmNlIGEgSlNPTiBBUEkgRG9jdW1lbnQgY2FuIGhhdmUgbWV0YSBkZWZpbmVkIGluIG11bHRpcGxlIGxvY2F0aW9ucyB5b3UgY2FuCiAgICB1c2UgdGhlIHNwZWNpZmljIHNlcmlhbGl6ZXIgaG9va3MgaWYgeW91IG5lZWQgdG8gY3VzdG9taXplIHRoZSBtZXRhLgogIAogICAgT25lIHNjZW5hcmlvIHdvdWxkIGJlIHRvIGNhbWVsQ2FzZSB0aGUgbWV0YSBrZXlzIG9mIHlvdXIgcGF5bG9hZC4gVGhlIGV4YW1wbGUKICAgIGJlbG93IHNob3dzIGhvdyB0aGlzIGNvdWxkIGJlIGRvbmUgdXNpbmcgYG5vcm1hbGl6ZUFycmF5UmVzcG9uc2VgIGFuZAogICAgYGV4dHJhY3RSZWxhdGlvbnNoaXBgLgogIAogICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBleHBvcnQgZGVmYXVsdCBKU09OQVBJU2VyaWFsaXplci5leHRlbmQoewogICAgICBub3JtYWxpemVBcnJheVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgICAgbGV0IG5vcm1hbGl6ZWREb2N1bWVudCA9IHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgCiAgICAgICAgLy8gQ3VzdG9taXplIGRvY3VtZW50IG1ldGEKICAgICAgICBub3JtYWxpemVkRG9jdW1lbnQubWV0YSA9IGNhbWVsQ2FzZUtleXMobm9ybWFsaXplZERvY3VtZW50Lm1ldGEpOwogIAogICAgICAgIHJldHVybiBub3JtYWxpemVkRG9jdW1lbnQ7CiAgICAgIH0sCiAgCiAgICAgIGV4dHJhY3RSZWxhdGlvbnNoaXAocmVsYXRpb25zaGlwSGFzaCkgewogICAgICAgIGxldCBub3JtYWxpemVkUmVsYXRpb25zaGlwID0gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAKICAgICAgICAvLyBDdXN0b21pemUgcmVsYXRpb25zaGlwIG1ldGEKICAgICAgICBub3JtYWxpemVkUmVsYXRpb25zaGlwLm1ldGEgPSBjYW1lbENhc2VLZXlzKG5vcm1hbGl6ZWRSZWxhdGlvbnNoaXAubWV0YSk7CiAgCiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRSZWxhdGlvbnNoaXA7CiAgICAgIH0KICAgIH0pOwogICAgYGBgCiAgCiAgICBAc2luY2UgMS4xMy4wCiAgICBAY2xhc3MgSlNPTkFQSVNlcmlhbGl6ZXIKICAgIEBuYW1lc3BhY2UgRFMKICAgIEBleHRlbmRzIERTLkpTT05TZXJpYWxpemVyCiAgKi8KICB2YXIgSlNPTkFQSVNlcmlhbGl6ZXIgPSBfanNvbi5kZWZhdWx0LmV4dGVuZCh7CgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZURvY3VtZW50SGVscGVyCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBkb2N1bWVudEhhc2gKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVEb2N1bWVudEhlbHBlcihkb2N1bWVudEhhc2gpIHsKCiAgICAgIGlmIChFbWJlci50eXBlT2YoZG9jdW1lbnRIYXNoLmRhdGEpID09PSAnb2JqZWN0JykgewogICAgICAgIGRvY3VtZW50SGFzaC5kYXRhID0gdGhpcy5fbm9ybWFsaXplUmVzb3VyY2VIZWxwZXIoZG9jdW1lbnRIYXNoLmRhdGEpOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZG9jdW1lbnRIYXNoLmRhdGEpKSB7CiAgICAgICAgdmFyIHJldCA9IG5ldyBBcnJheShkb2N1bWVudEhhc2guZGF0YS5sZW5ndGgpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvY3VtZW50SGFzaC5kYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGRvY3VtZW50SGFzaC5kYXRhW2ldOwogICAgICAgICAgcmV0W2ldID0gdGhpcy5fbm9ybWFsaXplUmVzb3VyY2VIZWxwZXIoZGF0YSk7CiAgICAgICAgfQoKICAgICAgICBkb2N1bWVudEhhc2guZGF0YSA9IHJldDsKICAgICAgfQoKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZG9jdW1lbnRIYXNoLmluY2x1ZGVkKSkgewogICAgICAgIHZhciBfcmV0ID0gbmV3IEFycmF5KCk7CiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRvY3VtZW50SGFzaC5pbmNsdWRlZC5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgIHZhciBpbmNsdWRlZCA9IGRvY3VtZW50SGFzaC5pbmNsdWRlZFtfaV07CiAgICAgICAgICB2YXIgbm9ybWFsaXplZCA9IHRoaXMuX25vcm1hbGl6ZVJlc291cmNlSGVscGVyKGluY2x1ZGVkKTsKICAgICAgICAgIGlmIChub3JtYWxpemVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIC8vIGNhbiBiZSBudWxsIHdoZW4gdW5rbm93biB0eXBlIGlzIGVuY291bnRlcmVkCiAgICAgICAgICAgIF9yZXQucHVzaChub3JtYWxpemVkKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZCA9IF9yZXQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBkb2N1bWVudEhhc2g7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF9ub3JtYWxpemVSZWxhdGlvbnNoaXBEYXRhSGVscGVyCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXBEYXRhSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX25vcm1hbGl6ZVJlbGF0aW9uc2hpcERhdGFIZWxwZXIocmVsYXRpb25zaGlwRGF0YUhhc2gpIHsKICAgICAgcmVsYXRpb25zaGlwRGF0YUhhc2gudHlwZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVsYXRpb25zaGlwRGF0YUhhc2gudHlwZSk7CgogICAgICByZXR1cm4gcmVsYXRpb25zaGlwRGF0YUhhc2g7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIF9ub3JtYWxpemVSZXNvdXJjZUhlbHBlcgogICAgICBAcGFyYW0ge09iamVjdH0gcmVzb3VyY2VIYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICAgQHByaXZhdGUKICAgICovCiAgICBfbm9ybWFsaXplUmVzb3VyY2VIZWxwZXIocmVzb3VyY2VIYXNoKSB7CiAgICAgICh0cnVlICYmICEoIUVtYmVyLmlzTm9uZShyZXNvdXJjZUhhc2gudHlwZSkpICYmIEVtYmVyLmFzc2VydCh0aGlzLndhcm5NZXNzYWdlRm9yVW5kZWZpbmVkVHlwZSgpLCAhRW1iZXIuaXNOb25lKHJlc291cmNlSGFzaC50eXBlKSwgewogICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci50eXBlLWlzLXVuZGVmaW5lZCcKICAgICAgfSkpOwoKCiAgICAgIHZhciBtb2RlbE5hbWUgPSB2b2lkIDAsCiAgICAgICAgICB1c2VkTG9va3VwID0gdm9pZCAwOwoKICAgICAgbW9kZWxOYW1lID0gdGhpcy5tb2RlbE5hbWVGcm9tUGF5bG9hZEtleShyZXNvdXJjZUhhc2gudHlwZSk7CiAgICAgIHVzZWRMb29rdXAgPSAnbW9kZWxOYW1lRnJvbVBheWxvYWRLZXknOwoKICAgICAgaWYgKCF0aGlzLnN0b3JlLl9oYXNNb2RlbEZvcihtb2RlbE5hbWUpKSB7CiAgICAgICAgKHRydWUgJiYgRW1iZXIud2Fybih0aGlzLndhcm5NZXNzYWdlTm9Nb2RlbEZvclR5cGUobW9kZWxOYW1lLCByZXNvdXJjZUhhc2gudHlwZSwgdXNlZExvb2t1cCksIGZhbHNlLCB7CiAgICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIubW9kZWwtZm9yLXR5cGUtbWlzc2luZycKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgbW9kZWxDbGFzcyA9IHRoaXMuc3RvcmUuX21vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgIHZhciBzZXJpYWxpemVyID0gdGhpcy5zdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CiAgICAgIHZhciB7IGRhdGEgfSA9IHNlcmlhbGl6ZXIubm9ybWFsaXplKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBwdXNoUGF5bG9hZAogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgKi8KICAgIHB1c2hQYXlsb2FkKHN0b3JlLCBwYXlsb2FkKSB7CiAgICAgIHZhciBub3JtYWxpemVkUGF5bG9hZCA9IHRoaXMuX25vcm1hbGl6ZURvY3VtZW50SGVscGVyKHBheWxvYWQpOwogICAgICBzdG9yZS5wdXNoKG5vcm1hbGl6ZWRQYXlsb2FkKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlc3BvbnNlCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNTaW5nbGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgaXNTaW5nbGUpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWRQYXlsb2FkID0gdGhpcy5fbm9ybWFsaXplRG9jdW1lbnRIZWxwZXIocGF5bG9hZCk7CiAgICAgIHJldHVybiBub3JtYWxpemVkUGF5bG9hZDsKICAgIH0sCgogICAgbm9ybWFsaXplUXVlcnlSZWNvcmRSZXNwb25zZSgpIHsKICAgICAgdmFyIG5vcm1hbGl6ZWQgPSB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwoKICAgICAgKHRydWUgJiYgISghQXJyYXkuaXNBcnJheShub3JtYWxpemVkLmRhdGEpKSAmJiBFbWJlci5hc3NlcnQoJ0V4cGVjdGVkIHRoZSBwcmltYXJ5IGRhdGEgcmV0dXJuZWQgYnkgdGhlIHNlcmlhbGl6ZXIgZm9yIGEgYHF1ZXJ5UmVjb3JkYCByZXNwb25zZSB0byBiZSBhIHNpbmdsZSBvYmplY3QgYnV0IGluc3RlYWQgaXQgd2FzIGFuIGFycmF5LicsICFBcnJheS5pc0FycmF5KG5vcm1hbGl6ZWQuZGF0YSksIHsKICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIuanNvbi1hcGkucXVlcnlSZWNvcmQtYXJyYXktcmVzcG9uc2UnCiAgICAgIH0pKTsKCgogICAgICByZXR1cm4gbm9ybWFsaXplZDsKICAgIH0sCgogICAgZXh0cmFjdEF0dHJpYnV0ZXMobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIHZhciBhdHRyaWJ1dGVzID0ge307CgogICAgICBpZiAocmVzb3VyY2VIYXNoLmF0dHJpYnV0ZXMpIHsKICAgICAgICBtb2RlbENsYXNzLmVhY2hBdHRyaWJ1dGUoa2V5ID0+IHsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdkZXNlcmlhbGl6ZScpOwogICAgICAgICAgaWYgKHJlc291cmNlSGFzaC5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUtleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSByZXNvdXJjZUhhc2guYXR0cmlidXRlc1thdHRyaWJ1dGVLZXldOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgaWYgKHJlc291cmNlSGFzaC5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUtleV0gPT09IHVuZGVmaW5lZCAmJiByZXNvdXJjZUhhc2guYXR0cmlidXRlc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5hc3NlcnQoYFlvdXIgcGF5bG9hZCBmb3IgJyR7bW9kZWxDbGFzcy5tb2RlbE5hbWV9JyBjb250YWlucyAnJHtrZXl9JywgYnV0IHlvdXIgc2VyaWFsaXplciBpcyBzZXR1cCB0byBsb29rIGZvciAnJHthdHRyaWJ1dGVLZXl9Jy4gVGhpcyBpcyBtb3N0IGxpa2VseSBiZWNhdXNlIEVtYmVyIERhdGEncyBKU09OIEFQSSBzZXJpYWxpemVyIGRhc2hlcml6ZXMgYXR0cmlidXRlIGtleXMgYnkgZGVmYXVsdC4gWW91IHNob3VsZCBzdWJjbGFzcyBKU09OQVBJU2VyaWFsaXplciBhbmQgaW1wbGVtZW50ICdrZXlGb3JBdHRyaWJ1dGUoa2V5KSB7IHJldHVybiBrZXk7IH0nIHRvIHByZXZlbnQgRW1iZXIgRGF0YSBmcm9tIGN1c3RvbWl6aW5nIHlvdXIgYXR0cmlidXRlIGtleXMuYCwgZmFsc2UpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0sCgogICAgLyoqCiAgICAgICBSZXR1cm5zIGEgcmVsYXRpb25zaGlwIGZvcm1hdHRlZCBhcyBhIEpTT04tQVBJICJyZWxhdGlvbnNoaXAgb2JqZWN0Ii4KICAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1yZXNvdXJjZS1vYmplY3QtcmVsYXRpb25zaGlwcwogICAgICAgIEBtZXRob2QgZXh0cmFjdFJlbGF0aW9uc2hpcAogICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcEhhc2gKICAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBleHRyYWN0UmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcEhhc2gpIHsKCiAgICAgIGlmIChFbWJlci50eXBlT2YocmVsYXRpb25zaGlwSGFzaC5kYXRhKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICByZWxhdGlvbnNoaXBIYXNoLmRhdGEgPSB0aGlzLl9ub3JtYWxpemVSZWxhdGlvbnNoaXBEYXRhSGVscGVyKHJlbGF0aW9uc2hpcEhhc2guZGF0YSk7CiAgICAgIH0KCiAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlbGF0aW9uc2hpcEhhc2guZGF0YSkpIHsKICAgICAgICB2YXIgcmV0ID0gbmV3IEFycmF5KHJlbGF0aW9uc2hpcEhhc2guZGF0YS5sZW5ndGgpOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlbGF0aW9uc2hpcEhhc2guZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGRhdGEgPSByZWxhdGlvbnNoaXBIYXNoLmRhdGFbaV07CiAgICAgICAgICByZXRbaV0gPSB0aGlzLl9ub3JtYWxpemVSZWxhdGlvbnNoaXBEYXRhSGVscGVyKGRhdGEpOwogICAgICAgIH0KCiAgICAgICAgcmVsYXRpb25zaGlwSGFzaC5kYXRhID0gcmV0OwogICAgICB9CgogICAgICByZXR1cm4gcmVsYXRpb25zaGlwSGFzaDsKICAgIH0sCgogICAgLyoqCiAgICAgICBSZXR1cm5zIHRoZSByZXNvdXJjZSdzIHJlbGF0aW9uc2hpcHMgZm9ybWF0dGVkIGFzIGEgSlNPTi1BUEkgInJlbGF0aW9uc2hpcHMgb2JqZWN0Ii4KICAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1yZXNvdXJjZS1vYmplY3QtcmVsYXRpb25zaGlwcwogICAgICAgIEBtZXRob2QgZXh0cmFjdFJlbGF0aW9uc2hpcHMKICAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2RlbENsYXNzCiAgICAgICBAcGFyYW0ge09iamVjdH0gcmVzb3VyY2VIYXNoCiAgICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFJlbGF0aW9uc2hpcHMobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBzID0ge307CgogICAgICBpZiAocmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHMpIHsKICAgICAgICBtb2RlbENsYXNzLmVhY2hSZWxhdGlvbnNoaXAoKGtleSwgcmVsYXRpb25zaGlwTWV0YSkgPT4gewogICAgICAgICAgdmFyIHJlbGF0aW9uc2hpcEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgcmVsYXRpb25zaGlwTWV0YS5raW5kLCAnZGVzZXJpYWxpemUnKTsKICAgICAgICAgIGlmIChyZXNvdXJjZUhhc2gucmVsYXRpb25zaGlwc1tyZWxhdGlvbnNoaXBLZXldICE9PSB1bmRlZmluZWQpIHsKCiAgICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBIYXNoID0gcmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHNbcmVsYXRpb25zaGlwS2V5XTsKICAgICAgICAgICAgcmVsYXRpb25zaGlwc1trZXldID0gdGhpcy5leHRyYWN0UmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcEhhc2gpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRydWUpIHsKICAgICAgICAgICAgaWYgKHJlc291cmNlSGFzaC5yZWxhdGlvbnNoaXBzW3JlbGF0aW9uc2hpcEtleV0gPT09IHVuZGVmaW5lZCAmJiByZXNvdXJjZUhhc2gucmVsYXRpb25zaGlwc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAodHJ1ZSAmJiAhKGZhbHNlKSAmJiBFbWJlci5hc3NlcnQoYFlvdXIgcGF5bG9hZCBmb3IgJyR7bW9kZWxDbGFzcy5tb2RlbE5hbWV9JyBjb250YWlucyAnJHtrZXl9JywgYnV0IHlvdXIgc2VyaWFsaXplciBpcyBzZXR1cCB0byBsb29rIGZvciAnJHtyZWxhdGlvbnNoaXBLZXl9Jy4gVGhpcyBpcyBtb3N0IGxpa2VseSBiZWNhdXNlIEVtYmVyIERhdGEncyBKU09OIEFQSSBzZXJpYWxpemVyIGRhc2hlcml6ZXMgcmVsYXRpb25zaGlwIGtleXMgYnkgZGVmYXVsdC4gWW91IHNob3VsZCBzdWJjbGFzcyBKU09OQVBJU2VyaWFsaXplciBhbmQgaW1wbGVtZW50ICdrZXlGb3JSZWxhdGlvbnNoaXAoa2V5KSB7IHJldHVybiBrZXk7IH0nIHRvIHByZXZlbnQgRW1iZXIgRGF0YSBmcm9tIGN1c3RvbWl6aW5nIHlvdXIgcmVsYXRpb25zaGlwIGtleXMuYCwgZmFsc2UpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gcmVsYXRpb25zaGlwczsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX2V4dHJhY3RUeXBlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcmV0dXJuIHtTdHJpbmd9CiAgICAgIEBwcml2YXRlCiAgICAqLwogICAgX2V4dHJhY3RUeXBlKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbE5hbWVGcm9tUGF5bG9hZEtleShyZXNvdXJjZUhhc2gudHlwZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBEYXNoZXJpemVzIGFuZCBzaW5ndWxhcml6ZXMgdGhlIG1vZGVsIG5hbWUgaW4gdGhlIHBheWxvYWQgdG8gbWF0Y2gKICAgICAgdGhlIGZvcm1hdCBFbWJlciBEYXRhIHVzZXMgaW50ZXJuYWxseSBmb3IgdGhlIG1vZGVsIG5hbWUuCiAgICAgICBGb3IgZXhhbXBsZSB0aGUga2V5IGBwb3N0c2Agd291bGQgYmUgY29udmVydGVkIHRvIGBwb3N0YCBhbmQgdGhlCiAgICAgIGtleSBgc3R1ZGVudEFzc2VzbWVudHNgIHdvdWxkIGJlIGNvbnZlcnRlZCB0byBgc3R1ZGVudC1hc3Nlc21lbnRgLgogICAgICAgQG1ldGhvZCBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIG1vZGVsJ3MgbW9kZWxOYW1lCiAgICAqLwogICAgLy8gVE9ETyBAZGVwcmVjYXRlZCBVc2UgbW9kZWxOYW1lRnJvbVBheWxvYWRUeXBlIGluc3RlYWQKICAgIG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KGtleSkgewogICAgICByZXR1cm4gKDAsIF9lbWJlckluZmxlY3Rvci5zaW5ndWxhcml6ZSkoKDAsIF9wcml2YXRlLm5vcm1hbGl6ZU1vZGVsTmFtZSkoa2V5KSk7CiAgICB9LAoKICAgIC8qKgogICAgICBDb252ZXJ0cyB0aGUgbW9kZWwgbmFtZSB0byBhIHBsdXJhbGl6ZWQgdmVyc2lvbiBvZiB0aGUgbW9kZWwgbmFtZS4KICAgICAgIEZvciBleGFtcGxlIGBwb3N0YCB3b3VsZCBiZSBjb252ZXJ0ZWQgdG8gYHBvc3RzYCBhbmQKICAgICAgYHN0dWRlbnQtYXNzZXNtZW50YCB3b3VsZCBiZSBjb252ZXJ0ZWQgdG8gYHN0dWRlbnQtYXNzZXNtZW50c2AuCiAgICAgICBAbWV0aG9kIHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtb2RlbE5hbWUKICAgICAgQHJldHVybiB7U3RyaW5nfQogICAgKi8KICAgIC8vIFRPRE8gQGRlcHJlY2F0ZWQgVXNlIHBheWxvYWRUeXBlRnJvbU1vZGVsTmFtZSBpbnN0ZWFkCiAgICBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZShtb2RlbE5hbWUpIHsKICAgICAgcmV0dXJuICgwLCBfZW1iZXJJbmZsZWN0b3IucGx1cmFsaXplKShtb2RlbE5hbWUpOwogICAgfSwKCiAgICBub3JtYWxpemUobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIGlmIChyZXNvdXJjZUhhc2guYXR0cmlidXRlcykgewogICAgICAgIHRoaXMubm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICBpZiAocmVzb3VyY2VIYXNoLnJlbGF0aW9uc2hpcHMpIHsKICAgICAgICB0aGlzLm5vcm1hbGl6ZVVzaW5nRGVjbGFyZWRNYXBwaW5nKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaC5yZWxhdGlvbnNoaXBzKTsKICAgICAgfQoKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgaWQ6IHRoaXMuZXh0cmFjdElkKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCksCiAgICAgICAgdHlwZTogdGhpcy5fZXh0cmFjdFR5cGUobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSwKICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLmV4dHJhY3RBdHRyaWJ1dGVzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCksCiAgICAgICAgcmVsYXRpb25zaGlwczogdGhpcy5leHRyYWN0UmVsYXRpb25zaGlwcyhtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpCiAgICAgIH07CgogICAgICB0aGlzLmFwcGx5VHJhbnNmb3Jtcyhtb2RlbENsYXNzLCBkYXRhLmF0dHJpYnV0ZXMpOwoKICAgICAgcmV0dXJuIHsgZGF0YSB9OwogICAgfSwKCiAgICAvKioKICAgICAgYGtleUZvckF0dHJpYnV0ZWAgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIHJ1bGVzIGZvciBob3cgdG8gY29udmVydCBhbgogICAgICBhdHRyaWJ1dGUgbmFtZSBpbiB5b3VyIG1vZGVsIHRvIGEga2V5IGluIHlvdXIgSlNPTi4KICAgICAgQnkgZGVmYXVsdCBgSlNPTkFQSVNlcmlhbGl6ZXJgIGZvbGxvd3MgdGhlIGZvcm1hdCB1c2VkIG9uIHRoZSBleGFtcGxlcyBvZgogICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0IGFuZCB1c2VzIGRhc2hlcyBhcyB0aGUgd29yZCBzZXBhcmF0b3IgaW4gdGhlIEpTT04KICAgICAgYXR0cmlidXRlIGtleXMuCiAgICAgICBUaGlzIGJlaGF2aW91ciBjYW4gYmUgZWFzaWx5IGN1c3RvbWl6ZWQgYnkgZXh0ZW5kaW5nIHRoaXMgbWV0aG9kLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgZGFzaGVyaXplIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OQVBJU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIGtleUZvckF0dHJpYnV0ZShhdHRyLCBtZXRob2QpIHsKICAgICAgICAgIHJldHVybiBkYXNoZXJpemUoYXR0cikudG9VcHBlckNhc2UoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qga2V5Rm9yQXR0cmlidXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZAogICAgICBAcmV0dXJuIHtTdHJpbmd9IG5vcm1hbGl6ZWQga2V5CiAgICAqLwogICAga2V5Rm9yQXR0cmlidXRlKGtleSwgbWV0aG9kKSB7CiAgICAgIHJldHVybiBFbWJlci5TdHJpbmcuZGFzaGVyaXplKGtleSk7CiAgICB9LAoKICAgIC8qKgogICAgIGBrZXlGb3JSZWxhdGlvbnNoaXBgIGNhbiBiZSB1c2VkIHRvIGRlZmluZSBhIGN1c3RvbSBrZXkgd2hlbgogICAgIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nIHJlbGF0aW9uc2hpcCBwcm9wZXJ0aWVzLgogICAgIEJ5IGRlZmF1bHQgYEpTT05BUElTZXJpYWxpemVyYCBmb2xsb3dzIHRoZSBmb3JtYXQgdXNlZCBvbiB0aGUgZXhhbXBsZXMgb2YKICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0IGFuZCB1c2VzIGRhc2hlcyBhcyB3b3JkIHNlcGFyYXRvcnMgaW4KICAgICByZWxhdGlvbnNoaXAgcHJvcGVydGllcy4KICAgICAgVGhpcyBiZWhhdmlvdXIgY2FuIGJlIGVhc2lseSBjdXN0b21pemVkIGJ5IGV4dGVuZGluZyB0aGlzIG1ldGhvZC4KICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OQVBJU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIGtleUZvclJlbGF0aW9uc2hpcChrZXksIHJlbGF0aW9uc2hpcCwgbWV0aG9kKSB7CiAgICAgICAgICByZXR1cm4gdW5kZXJzY29yZShrZXkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgIEBtZXRob2Qga2V5Rm9yUmVsYXRpb25zaGlwCiAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgIEBwYXJhbSB7U3RyaW5nfSB0eXBlQ2xhc3MKICAgICBAcGFyYW0ge1N0cmluZ30gbWV0aG9kCiAgICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkIGtleQogICAgKi8KICAgIGtleUZvclJlbGF0aW9uc2hpcChrZXksIHR5cGVDbGFzcywgbWV0aG9kKSB7CiAgICAgIHJldHVybiBFbWJlci5TdHJpbmcuZGFzaGVyaXplKGtleSk7CiAgICB9LAoKICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICB2YXIgZGF0YSA9IHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgIGRhdGEudHlwZSA9IHRoaXMucGF5bG9hZEtleUZyb21Nb2RlbE5hbWUoc25hcHNob3QubW9kZWxOYW1lKTsKCiAgICAgIHJldHVybiB7IGRhdGEgfTsKICAgIH0sCgogICAgc2VyaWFsaXplQXR0cmlidXRlKHNuYXBzaG90LCBqc29uLCBrZXksIGF0dHJpYnV0ZSkgewogICAgICB2YXIgdHlwZSA9IGF0dHJpYnV0ZS50eXBlOwoKICAgICAgaWYgKHRoaXMuX2NhblNlcmlhbGl6ZShrZXkpKSB7CiAgICAgICAganNvbi5hdHRyaWJ1dGVzID0ganNvbi5hdHRyaWJ1dGVzIHx8IHt9OwoKICAgICAgICB2YXIgdmFsdWUgPSBzbmFwc2hvdC5hdHRyKGtleSk7CiAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSB0aGlzLnRyYW5zZm9ybUZvcih0eXBlKTsKICAgICAgICAgIHZhbHVlID0gdHJhbnNmb3JtLnNlcmlhbGl6ZSh2YWx1ZSwgYXR0cmlidXRlLm9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBheWxvYWRLZXkgPSB0aGlzLl9nZXRNYXBwZWRLZXkoa2V5LCBzbmFwc2hvdC50eXBlKTsKCiAgICAgICAgaWYgKHBheWxvYWRLZXkgPT09IGtleSkgewogICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yQXR0cmlidXRlKGtleSwgJ3NlcmlhbGl6ZScpOwogICAgICAgIH0KCiAgICAgICAganNvbi5hdHRyaWJ1dGVzW3BheWxvYWRLZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0sCgogICAgc2VyaWFsaXplQmVsb25nc1RvKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CgogICAgICBpZiAodGhpcy5fY2FuU2VyaWFsaXplKGtleSkpIHsKICAgICAgICB2YXIgYmVsb25nc1RvID0gc25hcHNob3QuYmVsb25nc1RvKGtleSk7CiAgICAgICAgdmFyIGJlbG9uZ3NUb0lzTm90TmV3ID0gYmVsb25nc1RvICYmIGJlbG9uZ3NUby5yZWNvcmQgJiYgIWJlbG9uZ3NUby5yZWNvcmQuZ2V0KCdpc05ldycpOwoKICAgICAgICBpZiAoYmVsb25nc1RvID09PSBudWxsIHx8IGJlbG9uZ3NUb0lzTm90TmV3KSB7CiAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHMgPSBqc29uLnJlbGF0aW9uc2hpcHMgfHwge307CgogICAgICAgICAgdmFyIHBheWxvYWRLZXkgPSB0aGlzLl9nZXRNYXBwZWRLZXkoa2V5LCBzbmFwc2hvdC50eXBlKTsKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgJ2JlbG9uZ3NUbycsICdzZXJpYWxpemUnKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGF0YSA9IG51bGw7CiAgICAgICAgICBpZiAoYmVsb25nc1RvKSB7CiAgICAgICAgICAgIHZhciBwYXlsb2FkVHlwZSA9IHRoaXMucGF5bG9hZEtleUZyb21Nb2RlbE5hbWUoYmVsb25nc1RvLm1vZGVsTmFtZSk7CgogICAgICAgICAgICBkYXRhID0gewogICAgICAgICAgICAgIHR5cGU6IHBheWxvYWRUeXBlLAogICAgICAgICAgICAgIGlkOiBiZWxvbmdzVG8uaWQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHNbcGF5bG9hZEtleV0gPSB7IGRhdGEgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgICAgaWYgKHRoaXMuc2hvdWxkU2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwga2V5LCByZWxhdGlvbnNoaXApKSB7CiAgICAgICAgdmFyIGhhc01hbnkgPSBzbmFwc2hvdC5oYXNNYW55KGtleSk7CiAgICAgICAgaWYgKGhhc01hbnkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gb25seSBzZXJpYWxpemUgaGFzIG1hbnkgcmVsYXRpb25zaGlwcyB0aGF0IGFyZSBub3QgbmV3CiAgICAgICAgICB2YXIgbm9uTmV3SGFzTWFueSA9IGhhc01hbnkuZmlsdGVyKGl0ZW0gPT4gaXRlbS5yZWNvcmQgJiYgIWl0ZW0ucmVjb3JkLmdldCgnaXNOZXcnKSk7CgogICAgICAgICAgaWYgKG5vbk5ld0hhc01hbnkubGVuZ3RoID4gMCkgewogICAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHMgPSBqc29uLnJlbGF0aW9uc2hpcHMgfHwge307CgogICAgICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwogICAgICAgICAgICBpZiAocGF5bG9hZEtleSA9PT0ga2V5ICYmIHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKSB7CiAgICAgICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgJ2hhc01hbnknLCAnc2VyaWFsaXplJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkYXRhID0gbmV3IEFycmF5KG5vbk5ld0hhc01hbnkubGVuZ3RoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9uTmV3SGFzTWFueS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpdGVtID0gaGFzTWFueVtpXTsKICAgICAgICAgICAgICB2YXIgcGF5bG9hZFR5cGUgPSB0aGlzLnBheWxvYWRLZXlGcm9tTW9kZWxOYW1lKGl0ZW0ubW9kZWxOYW1lKTsKCiAgICAgICAgICAgICAgZGF0YVtpXSA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IHBheWxvYWRUeXBlLAogICAgICAgICAgICAgICAgaWQ6IGl0ZW0uaWQKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBqc29uLnJlbGF0aW9uc2hpcHNbcGF5bG9hZEtleV0gPSB7IGRhdGEgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOyAvKioKICAgICAgICBAbW9kdWxlIGVtYmVyLWRhdGEKICAgICAgKi8KCiAgaWYgKHRydWUpIHsKICAgIEpTT05BUElTZXJpYWxpemVyLnJlb3Blbih7CiAgICAgIHdpbGxNZXJnZU1peGluKHByb3BzKSB7CiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICAodHJ1ZSAmJiBFbWJlci53YXJuKGBZb3UndmUgZGVmaW5lZCAnZXh0cmFjdE1ldGEnIGluICR7Y29uc3RydWN0b3IudG9TdHJpbmcoKX0gd2hpY2ggaXMgbm90IHVzZWQgZm9yIHNlcmlhbGl6ZXJzIGV4dGVuZGluZyBKU09OQVBJU2VyaWFsaXplci4gUmVhZCBtb3JlIGF0IGh0dHBzOi8vZW1iZXJqcy5jb20vYXBpL2RhdGEvY2xhc3Nlcy9EUy5KU09OQVBJU2VyaWFsaXplci5odG1sI3RvY19jdXN0b21pemluZy1tZXRhIG9uIGhvdyB0byBjdXN0b21pemUgbWV0YSB3aGVuIHVzaW5nIEpTT04gQVBJLmAsIEVtYmVyLmlzTm9uZShwcm9wcy5leHRyYWN0TWV0YSkgfHwgcHJvcHMuZXh0cmFjdE1ldGEgPT09IF9qc29uLmRlZmF1bHQucHJvdG90eXBlLmV4dHJhY3RNZXRhLCB7CiAgICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIuanNvbi1hcGkuZXh0cmFjdE1ldGEnCiAgICAgICAgfSkpOwogICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4oJ1RoZSBKU09OQVBJU2VyaWFsaXplciBkb2VzIG5vdCB3b3JrIHdpdGggdGhlIEVtYmVkZGVkUmVjb3Jkc01peGluIGJlY2F1c2UgdGhlIEpTT04gQVBJIHNwZWMgZG9lcyBub3QgZGVzY3JpYmUgaG93IHRvIGZvcm1hdCBlbWJlZGRlZCByZXNvdXJjZXMuJywgIXByb3BzLmlzRW1iZWRkZWRSZWNvcmRzTWl4aW4sIHsKICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5lbWJlZGRlZC1yZWNvcmRzLW1peGluLW5vdC1zdXBwb3J0ZWQnCiAgICAgICAgfSkpOwogICAgICB9LAogICAgICB3YXJuTWVzc2FnZUZvclVuZGVmaW5lZFR5cGUoKSB7CiAgICAgICAgcmV0dXJuICdFbmNvdW50ZXJlZCBhIHJlc291cmNlIG9iamVjdCB3aXRoIGFuIHVuZGVmaW5lZCB0eXBlIChyZXNvbHZlZCByZXNvdXJjZSB1c2luZyAnICsgdGhpcy5jb25zdHJ1Y3Rvci50b1N0cmluZygpICsgJyknOwogICAgICB9LAogICAgICB3YXJuTWVzc2FnZU5vTW9kZWxGb3JUeXBlKG1vZGVsTmFtZSwgb3JpZ2luYWxUeXBlLCB1c2VkTG9va3VwKSB7CiAgICAgICAgcmV0dXJuIGBFbmNvdW50ZXJlZCBhIHJlc291cmNlIG9iamVjdCB3aXRoIHR5cGUgIiR7b3JpZ2luYWxUeXBlfSIsIGJ1dCBubyBtb2RlbCB3YXMgZm91bmQgZm9yIG1vZGVsIG5hbWUgIiR7bW9kZWxOYW1lfSIgKHJlc29sdmVkIG1vZGVsIG5hbWUgdXNpbmcgJyR7dGhpcy5jb25zdHJ1Y3Rvci50b1N0cmluZygpfS4ke3VzZWRMb29rdXB9KCIke29yaWdpbmFsVHlwZX0iKScpLmA7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZXhwb3J0cy5kZWZhdWx0ID0gSlNPTkFQSVNlcmlhbGl6ZXI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1kYXRhL3NlcmlhbGl6ZXJzL2pzb24nLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS9zZXJpYWxpemVyJywgJ2VtYmVyLWRhdGEvLXByaXZhdGUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9zZXJpYWxpemVyLCBfcHJpdmF0ZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKCgogIHZhciBlbWJlckFzc2lnbiA9IEVtYmVyLmFzc2lnbiB8fCBFbWJlci5tZXJnZTsKCiAgLyoqCiAgICBFbWJlciBEYXRhIDIuMCBTZXJpYWxpemVyOgogIAogICAgSW4gRW1iZXIgRGF0YSBhIFNlcmlhbGl6ZXIgaXMgdXNlZCB0byBzZXJpYWxpemUgYW5kIGRlc2VyaWFsaXplCiAgICByZWNvcmRzIHdoZW4gdGhleSBhcmUgdHJhbnNmZXJyZWQgaW4gYW5kIG91dCBvZiBhbiBleHRlcm5hbCBzb3VyY2UuCiAgICBUaGlzIHByb2Nlc3MgaW52b2x2ZXMgbm9ybWFsaXppbmcgcHJvcGVydHkgbmFtZXMsIHRyYW5zZm9ybWluZwogICAgYXR0cmlidXRlIHZhbHVlcyBhbmQgc2VyaWFsaXppbmcgcmVsYXRpb25zaGlwcy4KICAKICAgIEJ5IGRlZmF1bHQsIEVtYmVyIERhdGEgdXNlcyBhbmQgcmVjb21tZW5kcyB0aGUgYEpTT05BUElTZXJpYWxpemVyYC4KICAKICAgIGBKU09OU2VyaWFsaXplcmAgaXMgdXNlZnVsIGZvciBzaW1wbGVyIG9yIGxlZ2FjeSBiYWNrZW5kcyB0aGF0IG1heQogICAgbm90IHN1cHBvcnQgdGhlIGh0dHA6Ly9qc29uYXBpLm9yZy8gc3BlYy4KICAKICAgIEZvciBleGFtcGxlLCBnaXZlbiB0aGUgZm9sbG93aW5nIGBVc2VyYCBtb2RlbCBhbmQgSlNPTiBwYXlsb2FkOgogIAogICAgYGBgYXBwL21vZGVscy91c2VyLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICBmcmllbmRzOiBEUy5oYXNNYW55KCd1c2VyJyksCiAgICAgIGhvdXNlOiBEUy5iZWxvbmdzVG8oJ2xvY2F0aW9uJyksCiAgCiAgICAgIG5hbWU6IERTLmF0dHIoJ3N0cmluZycpCiAgICB9KTsKICAgIGBgYAogIAogICAgYGBganMKICAgIHsKICAgICAgaWQ6IDEsCiAgICAgIG5hbWU6ICdTZWJhc3RpYW4nLAogICAgICBmcmllbmRzOiBbMywgNF0sCiAgICAgIGxpbmtzOiB7CiAgICAgICAgaG91c2U6ICcvaG91c2VzL2xlZmthZGEnCiAgICAgIH0KICAgIH0KICAgIGBgYAogIAogICAgYEpTT05TZXJpYWxpemVyYCB3aWxsIG5vcm1hbGl6ZSB0aGUgSlNPTiBwYXlsb2FkIHRvIHRoZSBKU09OIEFQSSBmb3JtYXQgdGhhdCB0aGUKICAgIEVtYmVyIERhdGEgc3RvcmUgZXhwZWN0cy4KICAKICAgIFlvdSBjYW4gY3VzdG9taXplIGhvdyBKU09OU2VyaWFsaXplciBwcm9jZXNzZXMgaXRzIHBheWxvYWQgYnkgcGFzc2luZyBvcHRpb25zIGluCiAgICB0aGUgYGF0dHJzYCBoYXNoIG9yIGJ5IHN1YmNsYXNzaW5nIHRoZSBgSlNPTlNlcmlhbGl6ZXJgIGFuZCBvdmVycmlkaW5nIGhvb2tzOgogIAogICAgICAtIFRvIGN1c3RvbWl6ZSBob3cgYSBzaW5nbGUgcmVjb3JkIGlzIG5vcm1hbGl6ZWQsIHVzZSB0aGUgYG5vcm1hbGl6ZWAgaG9vay4KICAgICAgLSBUbyBjdXN0b21pemUgaG93IGBKU09OU2VyaWFsaXplcmAgbm9ybWFsaXplcyB0aGUgd2hvbGUgc2VydmVyIHJlc3BvbnNlLCB1c2UgdGhlCiAgICAgICAgYG5vcm1hbGl6ZVJlc3BvbnNlYCBob29rLgogICAgICAtIFRvIGN1c3RvbWl6ZSBob3cgYEpTT05TZXJpYWxpemVyYCBub3JtYWxpemVzIGEgc3BlY2lmaWMgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLAogICAgICAgIHVzZSBvbmUgb2YgdGhlIG1hbnkgc3BlY2lmaWMgYG5vcm1hbGl6ZVJlc3BvbnNlYCBob29rcy4KICAgICAgLSBUbyBjdXN0b21pemUgaG93IGBKU09OU2VyaWFsaXplcmAgbm9ybWFsaXplcyB5b3VyIGlkLCBhdHRyaWJ1dGVzIG9yIHJlbGF0aW9uc2hpcHMsCiAgICAgICAgdXNlIHRoZSBgZXh0cmFjdElkYCwgYGV4dHJhY3RBdHRyaWJ1dGVzYCBhbmQgYGV4dHJhY3RSZWxhdGlvbnNoaXBzYCBob29rcy4KICAKICAgIFRoZSBgSlNPTlNlcmlhbGl6ZXJgIG5vcm1hbGl6YXRpb24gcHJvY2VzcyBmb2xsb3dzIHRoZXNlIHN0ZXBzOgogIAogICAgICAtIGBub3JtYWxpemVSZXNwb25zZWAgLSBlbnRyeSBtZXRob2QgdG8gdGhlIHNlcmlhbGl6ZXIuCiAgICAgIC0gYG5vcm1hbGl6ZUNyZWF0ZVJlY29yZFJlc3BvbnNlYCAtIGEgYG5vcm1hbGl6ZVJlc3BvbnNlYCBmb3IgYSBzcGVjaWZpYyBvcGVyYXRpb24gaXMgY2FsbGVkLgogICAgICAtIGBub3JtYWxpemVTaW5nbGVSZXNwb25zZWB8YG5vcm1hbGl6ZUFycmF5UmVzcG9uc2VgIC0gZm9yIG1ldGhvZHMgbGlrZSBgY3JlYXRlUmVjb3JkYCB3ZSBleHBlY3QKICAgICAgICBhIHNpbmdsZSByZWNvcmQgYmFjaywgd2hpbGUgZm9yIG1ldGhvZHMgbGlrZSBgZmluZEFsbGAgd2UgZXhwZWN0IG11bHRpcGxlIHJlY29yZHMgYmFjay4KICAgICAgLSBgbm9ybWFsaXplYCAtIGBub3JtYWxpemVBcnJheWAgaXRlcmF0ZXMgYW5kIGNhbGxzIGBub3JtYWxpemVgIGZvciBlYWNoIG9mIGl0cyByZWNvcmRzIHdoaWxlIGBub3JtYWxpemVTaW5nbGVgCiAgICAgICAgY2FsbHMgaXQgb25jZS4gVGhpcyBpcyB0aGUgbWV0aG9kIHlvdSBtb3N0IGxpa2VseSB3YW50IHRvIHN1YmNsYXNzLgogICAgICAtIGBleHRyYWN0SWRgIHwgYGV4dHJhY3RBdHRyaWJ1dGVzYCB8IGBleHRyYWN0UmVsYXRpb25zaGlwc2AgLSBgbm9ybWFsaXplYCBkZWxlZ2F0ZXMgdG8gdGhlc2UgbWV0aG9kcyB0bwogICAgICAgIHR1cm4gdGhlIHJlY29yZCBwYXlsb2FkIGludG8gdGhlIEpTT04gQVBJIGZvcm1hdC4KICAKICAgIEBjbGFzcyBKU09OU2VyaWFsaXplcgogICAgQG5hbWVzcGFjZSBEUwogICAgQGV4dGVuZHMgRFMuU2VyaWFsaXplcgogICovCiAgdmFyIEpTT05TZXJpYWxpemVyID0gX3NlcmlhbGl6ZXIuZGVmYXVsdC5leHRlbmQoewoKICAgIC8qKgogICAgICBUaGUgYHByaW1hcnlLZXlgIGlzIHVzZWQgd2hlbiBzZXJpYWxpemluZyBhbmQgZGVzZXJpYWxpemluZwogICAgICBkYXRhLiBFbWJlciBEYXRhIGFsd2F5cyB1c2VzIHRoZSBgaWRgIHByb3BlcnR5IHRvIHN0b3JlIHRoZSBpZCBvZgogICAgICB0aGUgcmVjb3JkLiBUaGUgZXh0ZXJuYWwgc291cmNlIG1heSBub3QgYWx3YXlzIGZvbGxvdyB0aGlzCiAgICAgIGNvbnZlbnRpb24uIEluIHRoZXNlIGNhc2VzIGl0IGlzIHVzZWZ1bCB0byBvdmVycmlkZSB0aGUKICAgICAgYHByaW1hcnlLZXlgIHByb3BlcnR5IHRvIG1hdGNoIHRoZSBgcHJpbWFyeUtleWAgb2YgeW91ciBleHRlcm5hbAogICAgICBzdG9yZS4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHByaW1hcnlLZXk6ICdfaWQnCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBwcm9wZXJ0eSBwcmltYXJ5S2V5CiAgICAgIEB0eXBlIHtTdHJpbmd9CiAgICAgIEBkZWZhdWx0ICdpZCcKICAgICovCiAgICBwcmltYXJ5S2V5OiAnaWQnLAoKICAgIC8qKgogICAgICBUaGUgYGF0dHJzYCBvYmplY3QgY2FuIGJlIHVzZWQgdG8gZGVjbGFyZSBhIHNpbXBsZSBtYXBwaW5nIGJldHdlZW4KICAgICAgcHJvcGVydHkgbmFtZXMgb24gYERTLk1vZGVsYCByZWNvcmRzIGFuZCBwYXlsb2FkIGtleXMgaW4gdGhlCiAgICAgIHNlcmlhbGl6ZWQgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZWNvcmQuIEFuIG9iamVjdCB3aXRoIHRoZQogICAgICBwcm9wZXJ0eSBga2V5YCBjYW4gYWxzbyBiZSB1c2VkIHRvIGRlc2lnbmF0ZSB0aGUgYXR0cmlidXRlJ3Mga2V5IG9uCiAgICAgIHRoZSByZXNwb25zZSBwYXlsb2FkLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL21vZGVscy9wZXJzb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgICBmaXJzdE5hbWU6IERTLmF0dHIoJ3N0cmluZycpLAogICAgICAgIGxhc3ROYW1lOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgICBvY2N1cGF0aW9uOiBEUy5hdHRyKCdzdHJpbmcnKSwKICAgICAgICBhZG1pbjogRFMuYXR0cignYm9vbGVhbicpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wZXJzb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBhdHRyczogewogICAgICAgICAgYWRtaW46ICdpc19hZG1pbicsCiAgICAgICAgICBvY2N1cGF0aW9uOiB7IGtleTogJ2NhcmVlcicgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgWW91IGNhbiBhbHNvIHJlbW92ZSBhdHRyaWJ1dGVzIGJ5IHNldHRpbmcgdGhlIGBzZXJpYWxpemVgIGtleSB0bwogICAgICBgZmFsc2VgIGluIHlvdXIgbWFwcGluZyBvYmplY3QuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcGVyc29uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgIGFkbWluOiB7IHNlcmlhbGl6ZTogZmFsc2UgfSwKICAgICAgICAgIG9jY3VwYXRpb246IHsga2V5OiAnY2FyZWVyJyB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBXaGVuIHNlcmlhbGl6ZWQ6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICAiZmlyc3ROYW1lIjogIkhhcnJ5IiwKICAgICAgICAibGFzdE5hbWUiOiAiSG91ZGluaSIsCiAgICAgICAgImNhcmVlciI6ICJtYWdpY2lhbiIKICAgICAgfQogICAgICBgYGAKICAgICAgIE5vdGUgdGhhdCB0aGUgYGFkbWluYCBpcyBub3cgbm90IGluY2x1ZGVkIGluIHRoZSBwYXlsb2FkLgogICAgICAgQHByb3BlcnR5IGF0dHJzCiAgICAgIEB0eXBlIHtPYmplY3R9CiAgICAqLwogICAgbWVyZ2VkUHJvcGVydGllczogWydhdHRycyddLAoKICAgIC8qKgogICAgIEdpdmVuIGEgc3ViY2xhc3Mgb2YgYERTLk1vZGVsYCBhbmQgYSBKU09OIG9iamVjdCB0aGlzIG1ldGhvZCB3aWxsCiAgICAgaXRlcmF0ZSB0aHJvdWdoIGVhY2ggYXR0cmlidXRlIG9mIHRoZSBgRFMuTW9kZWxgIGFuZCBpbnZva2UgdGhlCiAgICAgYERTLlRyYW5zZm9ybSNkZXNlcmlhbGl6ZWAgbWV0aG9kIG9uIHRoZSBtYXRjaGluZyBwcm9wZXJ0eSBvZiB0aGUKICAgICBKU09OIG9iamVjdC4gIFRoaXMgbWV0aG9kIGlzIHR5cGljYWxseSBjYWxsZWQgYWZ0ZXIgdGhlCiAgICAgc2VyaWFsaXplcidzIGBub3JtYWxpemVgIG1ldGhvZC4KICAgICAgQG1ldGhvZCBhcHBseVRyYW5zZm9ybXMKICAgICBAcHJpdmF0ZQogICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGVDbGFzcwogICAgIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIHRyYW5zZm9ybQogICAgIEByZXR1cm4ge09iamVjdH0gZGF0YSBUaGUgdHJhbnNmb3JtZWQgZGF0YSBvYmplY3QKICAgICovCiAgICBhcHBseVRyYW5zZm9ybXModHlwZUNsYXNzLCBkYXRhKSB7CiAgICAgIHZhciBhdHRyaWJ1dGVzID0gRW1iZXIuZ2V0KHR5cGVDbGFzcywgJ2F0dHJpYnV0ZXMnKTsKCiAgICAgIHR5cGVDbGFzcy5lYWNoVHJhbnNmb3JtZWRBdHRyaWJ1dGUoKGtleSwgdHlwZUNsYXNzKSA9PiB7CiAgICAgICAgaWYgKGRhdGFba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdHJhbnNmb3JtID0gdGhpcy50cmFuc2Zvcm1Gb3IodHlwZUNsYXNzKTsKICAgICAgICB2YXIgdHJhbnNmb3JtTWV0YSA9IGF0dHJpYnV0ZXMuZ2V0KGtleSk7CiAgICAgICAgZGF0YVtrZXldID0gdHJhbnNmb3JtLmRlc2VyaWFsaXplKGRhdGFba2V5XSwgdHJhbnNmb3JtTWV0YS5vcHRpb25zKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gZGF0YTsKICAgIH0sCgogICAgLyoqCiAgICAgIFRoZSBgbm9ybWFsaXplUmVzcG9uc2VgIG1ldGhvZCBpcyB1c2VkIHRvIG5vcm1hbGl6ZSBhIHBheWxvYWQgZnJvbSB0aGUKICAgICAgc2VydmVyIHRvIGEgSlNPTi1BUEkgRG9jdW1lbnQuCiAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1zdHJ1Y3R1cmUKICAgICAgIFRoaXMgbWV0aG9kIGRlbGVnYXRlcyB0byBhIG1vcmUgc3BlY2lmaWMgbm9ybWFsaXplIG1ldGhvZCBiYXNlZCBvbgogICAgICB0aGUgYHJlcXVlc3RUeXBlYC4KICAgICAgIFRvIG92ZXJyaWRlIHRoaXMgbWV0aG9kIHdpdGggYSBjdXN0b20gb25lLCBtYWtlIHN1cmUgdG8gY2FsbAogICAgICBgcmV0dXJuIHRoaXMuX3N1cGVyKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKWAgd2l0aCB5b3VyCiAgICAgIHByZS1wcm9jZXNzZWQgZGF0YS4KICAgICAgIEhlcmUncyBhbiBleGFtcGxlIG9mIHVzaW5nIGBub3JtYWxpemVSZXNwb25zZWAgbWFudWFsbHk6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHNvY2tldC5vbignbWVzc2FnZScsIGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICB2YXIgZGF0YSA9IG1lc3NhZ2UuZGF0YTsKICAgICAgICB2YXIgbW9kZWxDbGFzcyA9IHN0b3JlLm1vZGVsRm9yKGRhdGEubW9kZWxOYW1lKTsKICAgICAgICB2YXIgc2VyaWFsaXplciA9IHN0b3JlLnNlcmlhbGl6ZXJGb3IoZGF0YS5tb2RlbE5hbWUpOwogICAgICAgIHZhciBub3JtYWxpemVkID0gc2VyaWFsaXplci5ub3JtYWxpemVTaW5nbGVSZXNwb25zZShzdG9yZSwgbW9kZWxDbGFzcywgZGF0YSwgZGF0YS5pZCk7CiAgICAgICAgIHN0b3JlLnB1c2gobm9ybWFsaXplZCk7CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgc3dpdGNoIChyZXF1ZXN0VHlwZSkgewogICAgICAgIGNhc2UgJ2ZpbmRSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRmluZFJlY29yZFJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgY2FzZSAncXVlcnlSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplUXVlcnlSZWNvcmRSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgICAgIGNhc2UgJ2ZpbmRBbGwnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRmluZEFsbFJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgY2FzZSAnZmluZEJlbG9uZ3NUbyc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVGaW5kQmVsb25nc1RvUmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgICAgICBjYXNlICdmaW5kSGFzTWFueSc6CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVGaW5kSGFzTWFueVJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgY2FzZSAnZmluZE1hbnknOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRmluZE1hbnlSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgICAgIGNhc2UgJ3F1ZXJ5JzoKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgICAgICBjYXNlICdjcmVhdGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQ3JlYXRlUmVjb3JkUmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgICAgICBjYXNlICdkZWxldGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplRGVsZXRlUmVjb3JkUmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgICAgICBjYXNlICd1cGRhdGVSZWNvcmQnOgogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplVXBkYXRlUmVjb3JkUmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRSZWNvcmRSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplRmluZFJlY29yZFJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplUXVlcnlSZWNvcmRSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplUXVlcnlSZWNvcmRSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTaW5nbGVSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRBbGxSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplRmluZEFsbFJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZUFycmF5UmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVGaW5kQmVsb25nc1RvUmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZUZpbmRCZWxvbmdzVG9SZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTaW5nbGVSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRIYXNNYW55UmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZUZpbmRIYXNNYW55UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUZpbmRNYW55UmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZUZpbmRNYW55UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZVF1ZXJ5UmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplQXJyYXlSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZUNyZWF0ZVJlY29yZFJlc3BvbnNlCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEByZXR1cm4ge09iamVjdH0gSlNPTi1BUEkgRG9jdW1lbnQKICAgICovCiAgICBub3JtYWxpemVDcmVhdGVSZWNvcmRSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVTYXZlUmVzcG9uc2UoLi4uYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBzaW5jZSAxLjEzLjAKICAgICAgQG1ldGhvZCBub3JtYWxpemVEZWxldGVSZWNvcmRSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplRGVsZXRlUmVjb3JkUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplU2F2ZVJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplVXBkYXRlUmVjb3JkUmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZVVwZGF0ZVJlY29yZFJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVNhdmVSZXNwb25zZSguLi5hcmd1bWVudHMpOwogICAgfSwKCiAgICAvKioKICAgICAgQHNpbmNlIDEuMTMuMAogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVNhdmVSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplU2F2ZVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlKC4uLmFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplU2luZ2xlUmVzcG9uc2UKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gcHJpbWFyeU1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICAgQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSBpZAogICAgICBAcGFyYW0ge1N0cmluZ30gcmVxdWVzdFR5cGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgKi8KICAgIG5vcm1hbGl6ZVNpbmdsZVJlc3BvbnNlKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCwgaWQsIHJlcXVlc3RUeXBlKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICBAc2luY2UgMS4xMy4wCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplQXJyYXlSZXNwb25zZQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge0RTLk1vZGVsfSBwcmltYXJ5TW9kZWxDbGFzcwogICAgICBAcGFyYW0ge09iamVjdH0gcGF5bG9hZAogICAgICBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IGlkCiAgICAgIEBwYXJhbSB7U3RyaW5nfSByZXF1ZXN0VHlwZQogICAgICBAcmV0dXJuIHtPYmplY3R9IEpTT04tQVBJIERvY3VtZW50CiAgICAqLwogICAgbm9ybWFsaXplQXJyYXlSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSkgewogICAgICByZXR1cm4gdGhpcy5fbm9ybWFsaXplUmVzcG9uc2Uoc3RvcmUsIHByaW1hcnlNb2RlbENsYXNzLCBwYXlsb2FkLCBpZCwgcmVxdWVzdFR5cGUsIGZhbHNlKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlc3BvbnNlCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNTaW5nbGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgaXNTaW5nbGUpIHsKICAgICAgdmFyIGRvY3VtZW50SGFzaCA9IHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGluY2x1ZGVkOiBbXQogICAgICB9OwoKICAgICAgdmFyIG1ldGEgPSB0aGlzLmV4dHJhY3RNZXRhKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCk7CiAgICAgIGlmIChtZXRhKSB7CiAgICAgICAgKHRydWUgJiYgIShFbWJlci50eXBlT2YobWV0YSkgPT09ICdvYmplY3QnKSAmJiBFbWJlci5hc3NlcnQoJ1RoZSBgbWV0YWAgcmV0dXJuZWQgZnJvbSBgZXh0cmFjdE1ldGFgIGhhcyB0byBiZSBhbiBvYmplY3QsIG5vdCAiJyArIEVtYmVyLnR5cGVPZihtZXRhKSArICciLicsIEVtYmVyLnR5cGVPZihtZXRhKSA9PT0gJ29iamVjdCcpKTsKCiAgICAgICAgZG9jdW1lbnRIYXNoLm1ldGEgPSBtZXRhOwogICAgICB9CgogICAgICBpZiAoaXNTaW5nbGUpIHsKICAgICAgICB2YXIgeyBkYXRhLCBpbmNsdWRlZCB9ID0gdGhpcy5ub3JtYWxpemUocHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQpOwogICAgICAgIGRvY3VtZW50SGFzaC5kYXRhID0gZGF0YTsKICAgICAgICBpZiAoaW5jbHVkZWQpIHsKICAgICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZCA9IGluY2x1ZGVkOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmV0ID0gbmV3IEFycmF5KHBheWxvYWQubGVuZ3RoKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBheWxvYWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB2YXIgaXRlbSA9IHBheWxvYWRbaV07CiAgICAgICAgICB2YXIgeyBkYXRhOiBfZGF0YSwgaW5jbHVkZWQ6IF9pbmNsdWRlZCB9ID0gdGhpcy5ub3JtYWxpemUocHJpbWFyeU1vZGVsQ2xhc3MsIGl0ZW0pOwogICAgICAgICAgaWYgKF9pbmNsdWRlZCkgewogICAgICAgICAgICBkb2N1bWVudEhhc2guaW5jbHVkZWQucHVzaCguLi5faW5jbHVkZWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0W2ldID0gX2RhdGE7CiAgICAgICAgfQoKICAgICAgICBkb2N1bWVudEhhc2guZGF0YSA9IHJldDsKICAgICAgfQoKICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgIH0sCgogICAgLyoqCiAgICAgIE5vcm1hbGl6ZXMgYSBwYXJ0IG9mIHRoZSBKU09OIHBheWxvYWQgcmV0dXJuZWQgYnkKICAgICAgdGhlIHNlcnZlci4gWW91IHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCwgbXVuZ2UgdGhlIGhhc2gKICAgICAgYW5kIGNhbGwgc3VwZXIgaWYgeW91IGhhdmUgZ2VuZXJpYyBub3JtYWxpemF0aW9uIHRvIGRvLgogICAgICAgSXQgdGFrZXMgdGhlIHR5cGUgb2YgdGhlIHJlY29yZCB0aGF0IGlzIGJlaW5nIG5vcm1hbGl6ZWQKICAgICAgKGFzIGEgRFMuTW9kZWwgY2xhc3MpLCB0aGUgcHJvcGVydHkgd2hlcmUgdGhlIGhhc2ggd2FzCiAgICAgIG9yaWdpbmFsbHkgZm91bmQsIGFuZCB0aGUgaGFzaCB0byBub3JtYWxpemUuCiAgICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCwgZm9yIGV4YW1wbGUsIHRvIG5vcm1hbGl6ZSB1bmRlcnNjb3JlZCBrZXlzIHRvIGNhbWVsaXplZAogICAgICBvciBvdGhlciBnZW5lcmFsLXB1cnBvc2Ugbm9ybWFsaXphdGlvbnMuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgIGltcG9ydCB7IGdldCB9IGZyb20gJ0BlbWJlci9vYmplY3QnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBub3JtYWxpemUodHlwZUNsYXNzLCBoYXNoKSB7CiAgICAgICAgICB2YXIgZmllbGRzID0gZ2V0KHR5cGVDbGFzcywgJ2ZpZWxkcycpOwogICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGZpZWxkKSB7CiAgICAgICAgICAgIHZhciBwYXlsb2FkRmllbGQgPSB1bmRlcnNjb3JlKGZpZWxkKTsKICAgICAgICAgICAgaWYgKGZpZWxkID09PSBwYXlsb2FkRmllbGQpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgICBoYXNoW2ZpZWxkXSA9IGhhc2hbcGF5bG9hZEZpZWxkXTsKICAgICAgICAgICAgZGVsZXRlIGhhc2hbcGF5bG9hZEZpZWxkXTsKICAgICAgICAgIH0pOwogICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBub3JtYWxpemUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICAgIEByZXR1cm4ge09iamVjdH0KICAgICovCiAgICBub3JtYWxpemUobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIHZhciBkYXRhID0gbnVsbDsKCiAgICAgIGlmIChyZXNvdXJjZUhhc2gpIHsKICAgICAgICB0aGlzLm5vcm1hbGl6ZVVzaW5nRGVjbGFyZWRNYXBwaW5nKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCk7CiAgICAgICAgaWYgKEVtYmVyLnR5cGVPZihyZXNvdXJjZUhhc2gubGlua3MpID09PSAnb2JqZWN0JykgewogICAgICAgICAgdGhpcy5ub3JtYWxpemVVc2luZ0RlY2xhcmVkTWFwcGluZyhtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gubGlua3MpOwogICAgICAgIH0KCiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgIGlkOiB0aGlzLmV4dHJhY3RJZChtb2RlbENsYXNzLCByZXNvdXJjZUhhc2gpLAogICAgICAgICAgdHlwZTogbW9kZWxDbGFzcy5tb2RlbE5hbWUsCiAgICAgICAgICBhdHRyaWJ1dGVzOiB0aGlzLmV4dHJhY3RBdHRyaWJ1dGVzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCksCiAgICAgICAgICByZWxhdGlvbnNoaXBzOiB0aGlzLmV4dHJhY3RSZWxhdGlvbnNoaXBzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkKICAgICAgICB9OwoKICAgICAgICB0aGlzLmFwcGx5VHJhbnNmb3Jtcyhtb2RlbENsYXNzLCBkYXRhLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICByZXR1cm4geyBkYXRhIH07CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSByZXNvdXJjZSdzIElELgogICAgICAgQG1ldGhvZCBleHRyYWN0SWQKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcmV0dXJuIHtTdHJpbmd9CiAgICAqLwogICAgZXh0cmFjdElkKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICB2YXIgcHJpbWFyeUtleSA9IEVtYmVyLmdldCh0aGlzLCAncHJpbWFyeUtleScpOwogICAgICB2YXIgaWQgPSByZXNvdXJjZUhhc2hbcHJpbWFyeUtleV07CiAgICAgIHJldHVybiAoMCwgX3ByaXZhdGUuY29lcmNlSWQpKGlkKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFJldHVybnMgdGhlIHJlc291cmNlJ3MgYXR0cmlidXRlcyBmb3JtYXR0ZWQgYXMgYSBKU09OLUFQSSAiYXR0cmlidXRlcyBvYmplY3QiLgogICAgICAgaHR0cDovL2pzb25hcGkub3JnL2Zvcm1hdC8jZG9jdW1lbnQtcmVzb3VyY2Utb2JqZWN0LWF0dHJpYnV0ZXMKICAgICAgIEBtZXRob2QgZXh0cmFjdEF0dHJpYnV0ZXMKICAgICAgQHBhcmFtIHtPYmplY3R9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdEF0dHJpYnV0ZXMobW9kZWxDbGFzcywgcmVzb3VyY2VIYXNoKSB7CiAgICAgIHZhciBhdHRyaWJ1dGVLZXkgPSB2b2lkIDA7CiAgICAgIHZhciBhdHRyaWJ1dGVzID0ge307CgogICAgICBtb2RlbENsYXNzLmVhY2hBdHRyaWJ1dGUoa2V5ID0+IHsKICAgICAgICBhdHRyaWJ1dGVLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdkZXNlcmlhbGl6ZScpOwogICAgICAgIGlmIChyZXNvdXJjZUhhc2hbYXR0cmlidXRlS2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzW2tleV0gPSByZXNvdXJjZUhhc2hbYXR0cmlidXRlS2V5XTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIGEgcmVsYXRpb25zaGlwIGZvcm1hdHRlZCBhcyBhIEpTT04tQVBJICJyZWxhdGlvbnNoaXAgb2JqZWN0Ii4KICAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXJlc291cmNlLW9iamVjdC1yZWxhdGlvbnNoaXBzCiAgICAgICBAbWV0aG9kIGV4dHJhY3RSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcE1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFJlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBNb2RlbE5hbWUsIHJlbGF0aW9uc2hpcEhhc2gpIHsKICAgICAgaWYgKEVtYmVyLmlzTm9uZShyZWxhdGlvbnNoaXBIYXNoKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIC8qCiAgICAgICAgV2hlbiBgcmVsYXRpb25zaGlwSGFzaGAgaXMgYW4gb2JqZWN0IGl0IHVzdWFsbHkgbWVhbnMgdGhhdCB0aGUgcmVsYXRpb25zaGlwCiAgICAgICAgaXMgcG9seW1vcnBoaWMuIEl0IGNvdWxkIGhvd2V2ZXIgYWxzbyBiZSBlbWJlZGRlZCByZXNvdXJjZXMgdGhhdCB0aGUKICAgICAgICBFbWJlZGRlZFJlY29yZHNNaXhpbiBoYXMgYmUgYWJsZSB0byBwcm9jZXNzLgogICAgICAqLwogICAgICBpZiAoRW1iZXIudHlwZU9mKHJlbGF0aW9uc2hpcEhhc2gpID09PSAnb2JqZWN0JykgewogICAgICAgIGlmIChyZWxhdGlvbnNoaXBIYXNoLmlkKSB7CiAgICAgICAgICByZWxhdGlvbnNoaXBIYXNoLmlkID0gKDAsIF9wcml2YXRlLmNvZXJjZUlkKShyZWxhdGlvbnNoaXBIYXNoLmlkKTsKICAgICAgICB9CgogICAgICAgIHZhciBtb2RlbENsYXNzID0gdGhpcy5zdG9yZS5tb2RlbEZvcihyZWxhdGlvbnNoaXBNb2RlbE5hbWUpOwogICAgICAgIGlmIChyZWxhdGlvbnNoaXBIYXNoLnR5cGUgJiYgISgwLCBfcHJpdmF0ZS5tb2RlbEhhc0F0dHJpYnV0ZU9yUmVsYXRpb25zaGlwTmFtZWRUeXBlKShtb2RlbENsYXNzKSkgewogICAgICAgICAgcmVsYXRpb25zaGlwSGFzaC50eXBlID0gdGhpcy5tb2RlbE5hbWVGcm9tUGF5bG9hZEtleShyZWxhdGlvbnNoaXBIYXNoLnR5cGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcEhhc2g7CiAgICAgIH0KICAgICAgcmV0dXJuIHsgaWQ6ICgwLCBfcHJpdmF0ZS5jb2VyY2VJZCkocmVsYXRpb25zaGlwSGFzaCksIHR5cGU6IHJlbGF0aW9uc2hpcE1vZGVsTmFtZSB9OwogICAgfSwKCiAgICAvKioKICAgICAgUmV0dXJucyBhIHBvbHltb3JwaGljIHJlbGF0aW9uc2hpcCBmb3JtYXR0ZWQgYXMgYSBKU09OLUFQSSAicmVsYXRpb25zaGlwIG9iamVjdCIuCiAgICAgICBodHRwOi8vanNvbmFwaS5vcmcvZm9ybWF0LyNkb2N1bWVudC1yZXNvdXJjZS1vYmplY3QtcmVsYXRpb25zaGlwcwogICAgICAgYHJlbGF0aW9uc2hpcE9wdGlvbnNgIGlzIGEgaGFzaCB3aGljaCBjb250YWlucyBtb3JlIGluZm9ybWF0aW9uIGFib3V0IHRoZQogICAgICBwb2x5bW9ycGhpYyByZWxhdGlvbnNoaXAgd2hpY2ggc2hvdWxkIGJlIGV4dHJhY3RlZDoKICAgICAgICAtIGByZXNvdXJjZUhhc2hgIGNvbXBsZXRlIGhhc2ggb2YgdGhlIHJlc291cmNlIHRoZSByZWxhdGlvbnNoaXAgc2hvdWxkIGJlCiAgICAgICAgICBleHRyYWN0ZWQgZnJvbQogICAgICAgIC0gYHJlbGF0aW9uc2hpcEtleWAga2V5IHVuZGVyIHdoaWNoIHRoZSB2YWx1ZSBmb3IgdGhlIHJlbGF0aW9uc2hpcCBpcwogICAgICAgICAgZXh0cmFjdGVkIGZyb20gdGhlIHJlc291cmNlSGFzaAogICAgICAgIC0gYHJlbGF0aW9uc2hpcE1ldGFgIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlbGF0aW9uc2hpcAogICAgICAgQG1ldGhvZCBleHRyYWN0UG9seW1vcnBoaWNSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcE1vZGVsTmFtZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwT3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwogICAgZXh0cmFjdFBvbHltb3JwaGljUmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcE1vZGVsTmFtZSwgcmVsYXRpb25zaGlwSGFzaCwgcmVsYXRpb25zaGlwT3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5leHRyYWN0UmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcE1vZGVsTmFtZSwgcmVsYXRpb25zaGlwSGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICBSZXR1cm5zIHRoZSByZXNvdXJjZSdzIHJlbGF0aW9uc2hpcHMgZm9ybWF0dGVkIGFzIGEgSlNPTi1BUEkgInJlbGF0aW9uc2hpcHMgb2JqZWN0Ii4KICAgICAgIGh0dHA6Ly9qc29uYXBpLm9yZy9mb3JtYXQvI2RvY3VtZW50LXJlc291cmNlLW9iamVjdC1yZWxhdGlvbnNoaXBzCiAgICAgICBAbWV0aG9kIGV4dHJhY3RSZWxhdGlvbnNoaXBzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBtb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSByZXNvdXJjZUhhc2gKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgKi8KICAgIGV4dHJhY3RSZWxhdGlvbnNoaXBzKG1vZGVsQ2xhc3MsIHJlc291cmNlSGFzaCkgewogICAgICB2YXIgcmVsYXRpb25zaGlwcyA9IHt9OwoKICAgICAgbW9kZWxDbGFzcy5lYWNoUmVsYXRpb25zaGlwKChrZXksIHJlbGF0aW9uc2hpcE1ldGEpID0+IHsKICAgICAgICB2YXIgcmVsYXRpb25zaGlwID0gbnVsbDsKICAgICAgICB2YXIgcmVsYXRpb25zaGlwS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXBNZXRhLmtpbmQsICdkZXNlcmlhbGl6ZScpOwogICAgICAgIGlmIChyZXNvdXJjZUhhc2hbcmVsYXRpb25zaGlwS2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVsYXRpb25zaGlwSGFzaCA9IHJlc291cmNlSGFzaFtyZWxhdGlvbnNoaXBLZXldOwogICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcE1ldGEub3B0aW9ucy5wb2x5bW9ycGhpYykgewogICAgICAgICAgICAgIC8vIGV4dHJhY3RpbmcgYSBwb2x5bW9ycGhpYyBiZWxvbmdzVG8gbWF5IG5lZWQgbW9yZSBpbmZvcm1hdGlvbgogICAgICAgICAgICAgIC8vIHRoYW4gdGhlIHR5cGUgYW5kIHRoZSBoYXNoICh3aGljaCBtaWdodCBvbmx5IGJlIGFuIGlkKSBmb3IgdGhlCiAgICAgICAgICAgICAgLy8gcmVsYXRpb25zaGlwLCBoZW5jZSB3ZSBwYXNzIHRoZSBrZXksIHJlc291cmNlIGFuZAogICAgICAgICAgICAgIC8vIHJlbGF0aW9uc2hpcE1ldGEgdG9vCiAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuZXh0cmFjdFBvbHltb3JwaGljUmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcE1ldGEudHlwZSwgcmVsYXRpb25zaGlwSGFzaCwgeyBrZXksIHJlc291cmNlSGFzaCwgcmVsYXRpb25zaGlwTWV0YSB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkYXRhID0gdGhpcy5leHRyYWN0UmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcE1ldGEudHlwZSwgcmVsYXRpb25zaGlwSGFzaCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAocmVsYXRpb25zaGlwTWV0YS5raW5kID09PSAnaGFzTWFueScpIHsKICAgICAgICAgICAgaWYgKCFFbWJlci5pc05vbmUocmVsYXRpb25zaGlwSGFzaCkpIHsKICAgICAgICAgICAgICBkYXRhID0gbmV3IEFycmF5KHJlbGF0aW9uc2hpcEhhc2gubGVuZ3RoKTsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHJlbGF0aW9uc2hpcEhhc2gubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHJlbGF0aW9uc2hpcEhhc2hbaV07CiAgICAgICAgICAgICAgICBkYXRhW2ldID0gdGhpcy5leHRyYWN0UmVsYXRpb25zaGlwKHJlbGF0aW9uc2hpcE1ldGEudHlwZSwgaXRlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZWxhdGlvbnNoaXAgPSB7IGRhdGEgfTsKICAgICAgICB9CgogICAgICAgIHZhciBsaW5rS2V5ID0gdGhpcy5rZXlGb3JMaW5rKGtleSwgcmVsYXRpb25zaGlwTWV0YS5raW5kKTsKICAgICAgICBpZiAocmVzb3VyY2VIYXNoLmxpbmtzICYmIHJlc291cmNlSGFzaC5saW5rc1tsaW5rS2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgcmVsYXRlZCA9IHJlc291cmNlSGFzaC5saW5rc1tsaW5rS2V5XTsKICAgICAgICAgIHJlbGF0aW9uc2hpcCA9IHJlbGF0aW9uc2hpcCB8fCB7fTsKICAgICAgICAgIHJlbGF0aW9uc2hpcC5saW5rcyA9IHsgcmVsYXRlZCB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgcmVsYXRpb25zaGlwc1trZXldID0gcmVsYXRpb25zaGlwOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gcmVsYXRpb25zaGlwczsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgbW9kZWxOYW1lRnJvbVBheWxvYWRLZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcmV0dXJuIHtTdHJpbmd9IHRoZSBtb2RlbCdzIG1vZGVsTmFtZQogICAgKi8KICAgIC8vIFRPRE8gQGRlcHJlY2F0ZWQgVXNlIG1vZGVsTmFtZUZyb21QYXlsb2FkVHlwZSBpbnN0ZWFkCiAgICBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleShrZXkpIHsKICAgICAgcmV0dXJuICgwLCBfcHJpdmF0ZS5ub3JtYWxpemVNb2RlbE5hbWUpKGtleSk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIG5vcm1hbGl6ZVJlbGF0aW9uc2hpcHMKICAgICAgQHByaXZhdGUKICAgICovCiAgICBub3JtYWxpemVSZWxhdGlvbnNoaXBzKHR5cGVDbGFzcywgaGFzaCkgewogICAgICB2YXIgcGF5bG9hZEtleSA9IHZvaWQgMDsKCiAgICAgIGlmICh0aGlzLmtleUZvclJlbGF0aW9uc2hpcCkgewogICAgICAgIHR5cGVDbGFzcy5lYWNoUmVsYXRpb25zaGlwKChrZXksIHJlbGF0aW9uc2hpcCkgPT4gewogICAgICAgICAgcGF5bG9hZEtleSA9IHRoaXMua2V5Rm9yUmVsYXRpb25zaGlwKGtleSwgcmVsYXRpb25zaGlwLmtpbmQsICdkZXNlcmlhbGl6ZScpOwogICAgICAgICAgaWYgKGtleSA9PT0gcGF5bG9hZEtleSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzaFtwYXlsb2FkS2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBoYXNoW2tleV0gPSBoYXNoW3BheWxvYWRLZXldOwogICAgICAgICAgZGVsZXRlIGhhc2hbcGF5bG9hZEtleV07CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2Qgbm9ybWFsaXplVXNpbmdEZWNsYXJlZE1hcHBpbmcKICAgICAgQHByaXZhdGUKICAgICovCiAgICBub3JtYWxpemVVc2luZ0RlY2xhcmVkTWFwcGluZyhtb2RlbENsYXNzLCBoYXNoKSB7CiAgICAgIHZhciBhdHRycyA9IEVtYmVyLmdldCh0aGlzLCAnYXR0cnMnKTsKICAgICAgdmFyIG5vcm1hbGl6ZWRLZXkgPSB2b2lkIDA7CiAgICAgIHZhciBwYXlsb2FkS2V5ID0gdm9pZCAwOwoKICAgICAgaWYgKGF0dHJzKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBub3JtYWxpemVkS2V5ID0gcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIG1vZGVsQ2xhc3MpOwoKICAgICAgICAgIGlmIChoYXNoW3BheWxvYWRLZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKEVtYmVyLmdldChtb2RlbENsYXNzLCAnYXR0cmlidXRlcycpLmhhcyhrZXkpKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChFbWJlci5nZXQobW9kZWxDbGFzcywgJ3JlbGF0aW9uc2hpcHNCeU5hbWUnKS5oYXMoa2V5KSkgewogICAgICAgICAgICBub3JtYWxpemVkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocGF5bG9hZEtleSAhPT0gbm9ybWFsaXplZEtleSkgewogICAgICAgICAgICBoYXNoW25vcm1hbGl6ZWRLZXldID0gaGFzaFtwYXlsb2FkS2V5XTsKICAgICAgICAgICAgZGVsZXRlIGhhc2hbcGF5bG9hZEtleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBMb29rcyB1cCB0aGUgcHJvcGVydHkga2V5IHRoYXQgd2FzIHNldCBieSB0aGUgY3VzdG9tIGBhdHRyYCBtYXBwaW5nCiAgICAgIHBhc3NlZCB0byB0aGUgc2VyaWFsaXplci4KICAgICAgIEBtZXRob2QgX2dldE1hcHBlZEtleQogICAgICBAcHJpdmF0ZQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge1N0cmluZ30ga2V5CiAgICAqLwogICAgX2dldE1hcHBlZEtleShrZXksIG1vZGVsQ2xhc3MpIHsKICAgICAgKHRydWUgJiYgRW1iZXIud2FybignVGhlcmUgaXMgbm8gYXR0cmlidXRlIG9yIHJlbGF0aW9uc2hpcCB3aXRoIHRoZSBuYW1lIGAnICsga2V5ICsgJ2Agb24gYCcgKyBtb2RlbENsYXNzLm1vZGVsTmFtZSArICdgLiBDaGVjayB5b3VyIHNlcmlhbGl6ZXJzIGF0dHJzIGhhc2guJywgRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdhdHRyaWJ1dGVzJykuaGFzKGtleSkgfHwgRW1iZXIuZ2V0KG1vZGVsQ2xhc3MsICdyZWxhdGlvbnNoaXBzQnlOYW1lJykuaGFzKGtleSksIHsKICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIubm8tbWFwcGVkLWF0dHJzLWtleScKICAgICAgfSkpOwoKCiAgICAgIHZhciBhdHRycyA9IEVtYmVyLmdldCh0aGlzLCAnYXR0cnMnKTsKICAgICAgdmFyIG1hcHBlZEtleSA9IHZvaWQgMDsKICAgICAgaWYgKGF0dHJzICYmIGF0dHJzW2tleV0pIHsKICAgICAgICBtYXBwZWRLZXkgPSBhdHRyc1trZXldOwogICAgICAgIC8vV2UgbmVlZCB0byBhY2NvdW50IGZvciBib3RoIHRoZSB7IHRpdGxlOiAncG9zdF90aXRsZScgfSBhbmQKICAgICAgICAvL3sgdGl0bGU6IHsga2V5OiAncG9zdF90aXRsZScgfX0gZm9ybXMKICAgICAgICBpZiAobWFwcGVkS2V5LmtleSkgewogICAgICAgICAgbWFwcGVkS2V5ID0gbWFwcGVkS2V5LmtleTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBtYXBwZWRLZXkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBrZXkgPSBtYXBwZWRLZXk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4ga2V5OwogICAgfSwKCiAgICAvKioKICAgICAgQ2hlY2sgYXR0cnMua2V5LnNlcmlhbGl6ZSBwcm9wZXJ0eSB0byBpbmZvcm0gaWYgdGhlIGBrZXlgCiAgICAgIGNhbiBiZSBzZXJpYWxpemVkCiAgICAgICBAbWV0aG9kIF9jYW5TZXJpYWxpemUKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBrZXkgY2FuIGJlIHNlcmlhbGl6ZWQKICAgICovCiAgICBfY2FuU2VyaWFsaXplKGtleSkgewogICAgICB2YXIgYXR0cnMgPSBFbWJlci5nZXQodGhpcywgJ2F0dHJzJyk7CgogICAgICByZXR1cm4gIWF0dHJzIHx8ICFhdHRyc1trZXldIHx8IGF0dHJzW2tleV0uc2VyaWFsaXplICE9PSBmYWxzZTsKICAgIH0sCgogICAgLyoqCiAgICAgIFdoZW4gYXR0cnMua2V5LnNlcmlhbGl6ZSBpcyBzZXQgdG8gdHJ1ZSB0aGVuCiAgICAgIGl0IHRha2VzIHByaW9yaXR5IG92ZXIgdGhlIG90aGVyIGNoZWNrcyBhbmQgdGhlIHJlbGF0ZWQKICAgICAgYXR0cmlidXRlL3JlbGF0aW9uc2hpcCB3aWxsIGJlIHNlcmlhbGl6ZWQKICAgICAgIEBtZXRob2QgX211c3RTZXJpYWxpemUKICAgICAgQHByaXZhdGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBrZXkgbXVzdCBiZSBzZXJpYWxpemVkCiAgICAqLwogICAgX211c3RTZXJpYWxpemUoa2V5KSB7CiAgICAgIHZhciBhdHRycyA9IEVtYmVyLmdldCh0aGlzLCAnYXR0cnMnKTsKCiAgICAgIHJldHVybiBhdHRycyAmJiBhdHRyc1trZXldICYmIGF0dHJzW2tleV0uc2VyaWFsaXplID09PSB0cnVlOwogICAgfSwKCiAgICAvKioKICAgICAgQ2hlY2sgaWYgdGhlIGdpdmVuIGhhc01hbnkgcmVsYXRpb25zaGlwIHNob3VsZCBiZSBzZXJpYWxpemVkCiAgICAgICBAbWV0aG9kIHNob3VsZFNlcmlhbGl6ZUhhc01hbnkKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcGFyYW0ge1N0cmluZ30gcmVsYXRpb25zaGlwVHlwZQogICAgICBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBoYXNNYW55IHJlbGF0aW9uc2hpcCBzaG91bGQgYmUgc2VyaWFsaXplZAogICAgKi8KICAgIHNob3VsZFNlcmlhbGl6ZUhhc01hbnkoc25hcHNob3QsIGtleSwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciByZWxhdGlvbnNoaXBUeXBlID0gc25hcHNob3QudHlwZS5kZXRlcm1pbmVSZWxhdGlvbnNoaXBUeXBlKHJlbGF0aW9uc2hpcCwgdGhpcy5zdG9yZSk7CiAgICAgIGlmICh0aGlzLl9tdXN0U2VyaWFsaXplKGtleSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fY2FuU2VyaWFsaXplKGtleSkgJiYgKHJlbGF0aW9uc2hpcFR5cGUgPT09ICdtYW55VG9Ob25lJyB8fCByZWxhdGlvbnNoaXBUeXBlID09PSAnbWFueVRvTWFueScpOwogICAgfSwKCiAgICAvLyBTRVJJQUxJWkUKICAgIC8qKgogICAgICBDYWxsZWQgd2hlbiBhIHJlY29yZCBpcyBzYXZlZCBpbiBvcmRlciB0byBjb252ZXJ0IHRoZQogICAgICByZWNvcmQgaW50byBKU09OLgogICAgICAgQnkgZGVmYXVsdCwgaXQgY3JlYXRlcyBhIEpTT04gb2JqZWN0IHdpdGggYSBrZXkgZm9yCiAgICAgIGVhY2ggYXR0cmlidXRlIGFuZCBiZWxvbmdzVG8gcmVsYXRpb25zaGlwLgogICAgICAgRm9yIGV4YW1wbGUsIGNvbnNpZGVyIHRoaXMgbW9kZWw6CiAgICAgICBgYGBhcHAvbW9kZWxzL2NvbW1lbnQuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgICB0aXRsZTogRFMuYXR0cigpLAogICAgICAgIGJvZHk6IERTLmF0dHIoKSwKICAgICAgICAgYXV0aG9yOiBEUy5iZWxvbmdzVG8oJ3VzZXInKQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBUaGUgZGVmYXVsdCBzZXJpYWxpemF0aW9uIHdvdWxkIGNyZWF0ZSBhIEpTT04gb2JqZWN0IGxpa2U6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgdW5hZ2kiLAogICAgICAgICJib2R5IjogIlJhaWxzPyBPbWFrYXNlPyBPX08iLAogICAgICAgICJhdXRob3IiOiAxMgogICAgICB9CiAgICAgIGBgYAogICAgICAgQnkgZGVmYXVsdCwgYXR0cmlidXRlcyBhcmUgcGFzc2VkIHRocm91Z2ggYXMtaXMsIHVubGVzcwogICAgICB5b3Ugc3BlY2lmaWVkIGFuIGF0dHJpYnV0ZSB0eXBlIChgRFMuYXR0cignZGF0ZScpYCkuIElmCiAgICAgIHlvdSBzcGVjaWZ5IGEgdHJhbnNmb3JtLCB0aGUgSmF2YVNjcmlwdCB2YWx1ZSB3aWxsIGJlCiAgICAgIHNlcmlhbGl6ZWQgd2hlbiBpbnNlcnRlZCBpbnRvIHRoZSBKU09OIGhhc2guCiAgICAgICBCeSBkZWZhdWx0LCBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcHMgYXJlIGNvbnZlcnRlZCBpbnRvCiAgICAgIElEcyB3aGVuIGluc2VydGVkIGludG8gdGhlIEpTT04gaGFzaC4KICAgICAgICMjIElEcwogICAgICAgYHNlcmlhbGl6ZWAgdGFrZXMgYW4gb3B0aW9ucyBoYXNoIHdpdGggYSBzaW5nbGUgb3B0aW9uOgogICAgICBgaW5jbHVkZUlkYC4gSWYgdGhpcyBvcHRpb24gaXMgYHRydWVgLCBgc2VyaWFsaXplYCB3aWxsLAogICAgICBieSBkZWZhdWx0IGluY2x1ZGUgdGhlIElEIGluIHRoZSBKU09OIG9iamVjdCBpdCBidWlsZHMuCiAgICAgICBUaGUgYWRhcHRlciBwYXNzZXMgaW4gYGluY2x1ZGVJZDogdHJ1ZWAgd2hlbiBzZXJpYWxpemluZwogICAgICBhIHJlY29yZCBmb3IgYGNyZWF0ZVJlY29yZGAsIGJ1dCBub3QgZm9yIGB1cGRhdGVSZWNvcmRgLgogICAgICAgIyMgQ3VzdG9taXphdGlvbgogICAgICAgWW91ciBzZXJ2ZXIgbWF5IGV4cGVjdCBhIGRpZmZlcmVudCBKU09OIGZvcm1hdCB0aGFuIHRoZQogICAgICBidWlsdC1pbiBzZXJpYWxpemF0aW9uIGZvcm1hdC4KICAgICAgIEluIHRoYXQgY2FzZSwgeW91IGNhbiBpbXBsZW1lbnQgYHNlcmlhbGl6ZWAgeW91cnNlbGYgYW5kCiAgICAgIHJldHVybiBhIEpTT04gaGFzaCBvZiB5b3VyIGNob29zaW5nLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBqc29uID0gewogICAgICAgICAgICBQT1NUX1RUTDogc25hcHNob3QuYXR0cigndGl0bGUnKSwKICAgICAgICAgICAgUE9TVF9CRFk6IHNuYXBzaG90LmF0dHIoJ2JvZHknKSwKICAgICAgICAgICAgUE9TVF9DTVM6IHNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJywgeyBpZHM6IHRydWUgfSkKICAgICAgICAgIH07CiAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICAgIGpzb24uUE9TVF9JRF8gPSBzbmFwc2hvdC5pZDsKICAgICAgICAgIH0KICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICMjIEN1c3RvbWl6aW5nIGFuIEFwcC1XaWRlIFNlcmlhbGl6ZXIKICAgICAgIElmIHlvdSB3YW50IHRvIGRlZmluZSBhIHNlcmlhbGl6ZXIgZm9yIHlvdXIgZW50aXJlCiAgICAgIGFwcGxpY2F0aW9uLCB5b3UnbGwgcHJvYmFibHkgd2FudCB0byB1c2UgYGVhY2hBdHRyaWJ1dGVgCiAgICAgIGFuZCBgZWFjaFJlbGF0aW9uc2hpcGAgb24gdGhlIHJlY29yZC4KICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGltcG9ydCB7IHNpbmd1bGFyaXplIH0gZnJvbSAnZW1iZXItaW5mbGVjdG9yJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHt9OwogICAgICAgICAgIHNuYXBzaG90LmVhY2hBdHRyaWJ1dGUoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBqc29uW3NlcnZlckF0dHJpYnV0ZU5hbWUobmFtZSldID0gc25hcHNob3QuYXR0cihuYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgIHNuYXBzaG90LmVhY2hSZWxhdGlvbnNoaXAoZnVuY3Rpb24obmFtZSwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2hhc01hbnknKSB7CiAgICAgICAgICAgICAganNvbltzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKV0gPSBzbmFwc2hvdC5oYXNNYW55KG5hbWUsIHsgaWRzOiB0cnVlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgICBpZiAob3B0aW9ucy5pbmNsdWRlSWQpIHsKICAgICAgICAgICAganNvbi5JRF8gPSBzbmFwc2hvdC5pZDsKICAgICAgICAgIH0KICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAgZnVuY3Rpb24gc2VydmVyQXR0cmlidXRlTmFtZShhdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm4gYXR0cmlidXRlLnVuZGVyc2NvcmUoKS50b1VwcGVyQ2FzZSgpOwogICAgICB9CiAgICAgICBmdW5jdGlvbiBzZXJ2ZXJIYXNNYW55TmFtZShuYW1lKSB7CiAgICAgICAgcmV0dXJuIHNlcnZlckF0dHJpYnV0ZU5hbWUoc2luZ3VsYXJpemUobmFtZSkpICsgIl9JRFMiOwogICAgICB9CiAgICAgIGBgYAogICAgICAgVGhpcyBzZXJpYWxpemVyIHdpbGwgZ2VuZXJhdGUgSlNPTiB0aGF0IGxvb2tzIGxpa2UgdGhpczoKICAgICAgIGBgYGphdmFzY3JpcHQKICAgICAgewogICAgICAgICJUSVRMRSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAiQk9EWSI6ICJZZXAuIE9tYWthc2UuIiwKICAgICAgICAiQ09NTUVOVF9JRFMiOiBbIDEsIDIsIDMgXQogICAgICB9CiAgICAgIGBgYAogICAgICAgIyMgVHdlYWtpbmcgdGhlIERlZmF1bHQgSlNPTgogICAgICAgSWYgeW91IGp1c3Qgd2FudCB0byBkbyBzb21lIHNtYWxsIHR3ZWFrcyBvbiB0aGUgZGVmYXVsdCBKU09OLAogICAgICB5b3UgY2FuIGNhbGwgc3VwZXIgZmlyc3QgYW5kIG1ha2UgdGhlIHR3ZWFrcyBvbiB0aGUgcmV0dXJuZWQKICAgICAgSlNPTi4KICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIganNvbiA9IHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICAganNvbi5zdWJqZWN0ID0ganNvbi50aXRsZTsKICAgICAgICAgIGRlbGV0ZSBqc29uLnRpdGxlOwogICAgICAgICAgIHJldHVybiBqc29uOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemUKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgQHJldHVybiB7T2JqZWN0fSBqc29uCiAgICAqLwogICAgc2VyaWFsaXplKHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgIHZhciBqc29uID0ge307CgogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmluY2x1ZGVJZCkgewogICAgICAgIHZhciBpZCA9IHNuYXBzaG90LmlkOwogICAgICAgIGlmIChpZCkgewogICAgICAgICAganNvbltFbWJlci5nZXQodGhpcywgJ3ByaW1hcnlLZXknKV0gPSBpZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHNuYXBzaG90LmVhY2hBdHRyaWJ1dGUoKGtleSwgYXR0cmlidXRlKSA9PiB7CiAgICAgICAgdGhpcy5zZXJpYWxpemVBdHRyaWJ1dGUoc25hcHNob3QsIGpzb24sIGtleSwgYXR0cmlidXRlKTsKICAgICAgfSk7CgogICAgICBzbmFwc2hvdC5lYWNoUmVsYXRpb25zaGlwKChrZXksIHJlbGF0aW9uc2hpcCkgPT4gewogICAgICAgIGlmIChyZWxhdGlvbnNoaXAua2luZCA9PT0gJ2JlbG9uZ3NUbycpIHsKICAgICAgICAgIHRoaXMuc2VyaWFsaXplQmVsb25nc1RvKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgIH0gZWxzZSBpZiAocmVsYXRpb25zaGlwLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgICAgdGhpcy5zZXJpYWxpemVIYXNNYW55KHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4ganNvbjsKICAgIH0sCgogICAgLyoqCiAgICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIGN1c3RvbWl6ZSBob3cgYSBzZXJpYWxpemVkIHJlY29yZCBpcyBhZGRlZCB0byB0aGUgY29tcGxldGUKICAgICAgSlNPTiBoYXNoIHRvIGJlIHNlbnQgdG8gdGhlIHNlcnZlci4gQnkgZGVmYXVsdCB0aGUgSlNPTiBTZXJpYWxpemVyIGRvZXMgbm90IG5hbWVzcGFjZQogICAgICB0aGUgcGF5bG9hZCBhbmQganVzdCBzZW5kcyB0aGUgcmF3IHNlcmlhbGl6ZWQgSlNPTiBvYmplY3QuCiAgICAgIElmIHlvdXIgc2VydmVyIGV4cGVjdHMgbmFtZXNwYWNlZCBrZXlzLCB5b3Ugc2hvdWxkIGNvbnNpZGVyIHVzaW5nIHRoZSBSRVNUU2VyaWFsaXplci4KICAgICAgT3RoZXJ3aXNlIHlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gY3VzdG9taXplIGhvdyB0aGUgcmVjb3JkIGlzIGFkZGVkIHRvIHRoZSBoYXNoLgogICAgICBUaGUgaGFzaCBwcm9wZXJ0eSBzaG91bGQgYmUgbW9kaWZpZWQgYnkgcmVmZXJlbmNlLgogICAgICAgRm9yIGV4YW1wbGUsIHlvdXIgc2VydmVyIG1heSBleHBlY3QgdW5kZXJzY29yZWQgcm9vdCBvYmplY3RzLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgZGVjYW1lbGl6ZSB9IGZyb20gJ0BlbWJlci9zdHJpbmcnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemVJbnRvSGFzaChkYXRhLCB0eXBlLCBzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHJvb3QgPSBkZWNhbWVsaXplKHR5cGUubW9kZWxOYW1lKTsKICAgICAgICAgIGRhdGFbcm9vdF0gPSB0aGlzLnNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZUludG9IYXNoCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBoYXNoCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHR5cGVDbGFzcwogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgKi8KICAgIHNlcmlhbGl6ZUludG9IYXNoKGhhc2gsIHR5cGVDbGFzcywgc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgZW1iZXJBc3NpZ24oaGFzaCwgdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpKTsKICAgIH0sCgogICAgLyoqCiAgICAgIGBzZXJpYWxpemVBdHRyaWJ1dGVgIGNhbiBiZSB1c2VkIHRvIGN1c3RvbWl6ZSBob3cgYERTLmF0dHJgCiAgICAgIHByb3BlcnRpZXMgYXJlIHNlcmlhbGl6ZWQKICAgICAgIEZvciBleGFtcGxlIGlmIHlvdSB3YW50ZWQgdG8gZW5zdXJlIGFsbCB5b3VyIGF0dHJpYnV0ZXMgd2VyZSBhbHdheXMKICAgICAgc2VyaWFsaXplZCBhcyBwcm9wZXJ0aWVzIG9uIGFuIGBhdHRyaWJ1dGVzYCBvYmplY3QgeW91IGNvdWxkCiAgICAgIHdyaXRlOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplQXR0cmlidXRlKHNuYXBzaG90LCBqc29uLCBrZXksIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGpzb24uYXR0cmlidXRlcyA9IGpzb24uYXR0cmlidXRlcyB8fCB7fTsKICAgICAgICAgIHRoaXMuX3N1cGVyKHNuYXBzaG90LCBqc29uLmF0dHJpYnV0ZXMsIGtleSwgYXR0cmlidXRlcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZUF0dHJpYnV0ZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBhdHRyaWJ1dGUKICAgICovCiAgICBzZXJpYWxpemVBdHRyaWJ1dGUoc25hcHNob3QsIGpzb24sIGtleSwgYXR0cmlidXRlKSB7CgogICAgICBpZiAodGhpcy5fY2FuU2VyaWFsaXplKGtleSkpIHsKICAgICAgICB2YXIgdHlwZSA9IGF0dHJpYnV0ZS50eXBlOwogICAgICAgIHZhciB2YWx1ZSA9IHNuYXBzaG90LmF0dHIoa2V5KTsKICAgICAgICBpZiAodHlwZSkgewogICAgICAgICAgdmFyIHRyYW5zZm9ybSA9IHRoaXMudHJhbnNmb3JtRm9yKHR5cGUpOwogICAgICAgICAgdmFsdWUgPSB0cmFuc2Zvcm0uc2VyaWFsaXplKHZhbHVlLCBhdHRyaWJ1dGUub3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICAvLyBpZiBwcm92aWRlZCwgdXNlIHRoZSBtYXBwaW5nIHByb3ZpZGVkIGJ5IGBhdHRyc2AgaW4KICAgICAgICAvLyB0aGUgc2VyaWFsaXplcgogICAgICAgIHZhciBwYXlsb2FkS2V5ID0gdGhpcy5fZ2V0TWFwcGVkS2V5KGtleSwgc25hcHNob3QudHlwZSk7CgogICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JBdHRyaWJ1dGUpIHsKICAgICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShrZXksICdzZXJpYWxpemUnKTsKICAgICAgICB9CgogICAgICAgIGpzb25bcGF5bG9hZEtleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgYHNlcmlhbGl6ZUJlbG9uZ3NUb2AgY2FuIGJlIHVzZWQgdG8gY3VzdG9taXplIGhvdyBgRFMuYmVsb25nc1RvYAogICAgICBwcm9wZXJ0aWVzIGFyZSBzZXJpYWxpemVkLgogICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyBpc05vbmUgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemVCZWxvbmdzVG8oc25hcHNob3QsIGpzb24sIHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CiAgICAgICAgICB2YXIgYmVsb25nc1RvID0gc25hcHNob3QuYmVsb25nc1RvKGtleSk7CiAgICAgICAgICAga2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAgPyB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXksICJiZWxvbmdzVG8iLCAic2VyaWFsaXplIikgOiBrZXk7CiAgICAgICAgICAganNvbltrZXldID0gaXNOb25lKGJlbG9uZ3NUbykgPyBiZWxvbmdzVG8gOiBiZWxvbmdzVG8ucmVjb3JkLnRvSlNPTigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVCZWxvbmdzVG8KICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IGpzb24KICAgICAgQHBhcmFtIHtPYmplY3R9IHJlbGF0aW9uc2hpcAogICAgKi8KICAgIHNlcmlhbGl6ZUJlbG9uZ3NUbyhzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwoKICAgICAgaWYgKHRoaXMuX2NhblNlcmlhbGl6ZShrZXkpKSB7CiAgICAgICAgdmFyIGJlbG9uZ3NUb0lkID0gc25hcHNob3QuYmVsb25nc1RvKGtleSwgeyBpZDogdHJ1ZSB9KTsKCiAgICAgICAgLy8gaWYgcHJvdmlkZWQsIHVzZSB0aGUgbWFwcGluZyBwcm92aWRlZCBieSBgYXR0cnNgIGluCiAgICAgICAgLy8gdGhlIHNlcmlhbGl6ZXIKICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwogICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSBrZXkgJiYgdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHBheWxvYWRLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXksICJiZWxvbmdzVG8iLCAic2VyaWFsaXplIik7CiAgICAgICAgfQoKICAgICAgICAvL05lZWQgdG8gY2hlY2sgd2hldGhlciB0aGUgaWQgaXMgdGhlcmUgZm9yIG5ldyZhc3luYyByZWNvcmRzCiAgICAgICAgaWYgKEVtYmVyLmlzTm9uZShiZWxvbmdzVG9JZCkpIHsKICAgICAgICAgIGpzb25bcGF5bG9hZEtleV0gPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqc29uW3BheWxvYWRLZXldID0gYmVsb25nc1RvSWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVsYXRpb25zaGlwLm9wdGlvbnMucG9seW1vcnBoaWMpIHsKICAgICAgICAgIHRoaXMuc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICBgc2VyaWFsaXplSGFzTWFueWAgY2FuIGJlIHVzZWQgdG8gY3VzdG9taXplIGhvdyBgRFMuaGFzTWFueWAKICAgICBwcm9wZXJ0aWVzIGFyZSBzZXJpYWxpemVkLgogICAgICBFeGFtcGxlCiAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9wb3N0LmpzCiAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICAgc2VyaWFsaXplSGFzTWFueShzbmFwc2hvdCwganNvbiwgcmVsYXRpb25zaGlwKSB7CiAgICAgICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwogICAgICAgICBpZiAoa2V5ID09PSAnY29tbWVudHMnKSB7CiAgICAgICAgICAgcmV0dXJuOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgIHRoaXMuX3N1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgIH0KICAgICAgIH0KICAgICB9KTsKICAgICBgYGAKICAgICAgQG1ldGhvZCBzZXJpYWxpemVIYXNNYW55CiAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgIEBwYXJhbSB7T2JqZWN0fSByZWxhdGlvbnNoaXAKICAgICovCiAgICBzZXJpYWxpemVIYXNNYW55KHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CgogICAgICBpZiAodGhpcy5zaG91bGRTZXJpYWxpemVIYXNNYW55KHNuYXBzaG90LCBrZXksIHJlbGF0aW9uc2hpcCkpIHsKICAgICAgICB2YXIgaGFzTWFueSA9IHNuYXBzaG90Lmhhc01hbnkoa2V5LCB7IGlkczogdHJ1ZSB9KTsKICAgICAgICBpZiAoaGFzTWFueSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAvLyBpZiBwcm92aWRlZCwgdXNlIHRoZSBtYXBwaW5nIHByb3ZpZGVkIGJ5IGBhdHRyc2AgaW4KICAgICAgICAgIC8vIHRoZSBzZXJpYWxpemVyCiAgICAgICAgICB2YXIgcGF5bG9hZEtleSA9IHRoaXMuX2dldE1hcHBlZEtleShrZXksIHNuYXBzaG90LnR5cGUpOwogICAgICAgICAgaWYgKHBheWxvYWRLZXkgPT09IGtleSAmJiB0aGlzLmtleUZvclJlbGF0aW9uc2hpcCkgewogICAgICAgICAgICBwYXlsb2FkS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCAiaGFzTWFueSIsICJzZXJpYWxpemUiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBqc29uW3BheWxvYWRLZXldID0gaGFzTWFueTsKICAgICAgICAgIC8vIFRPRE8gc3VwcG9ydCBmb3IgcG9seW1vcnBoaWMgbWFueVRvTm9uZSBhbmQgbWFueVRvTWFueSByZWxhdGlvbnNoaXBzCiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IHBvbHltb3JwaGljIG9iamVjdHMgYXJlCiAgICAgIHNlcmlhbGl6ZWQuIE9iamVjdHMgYXJlIGNvbnNpZGVyZWQgdG8gYmUgcG9seW1vcnBoaWMgaWYKICAgICAgYHsgcG9seW1vcnBoaWM6IHRydWUgfWAgaXMgcGFzcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIHRoZQogICAgICBgRFMuYmVsb25nc1RvYCBmdW5jdGlvbi4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9jb21tZW50LmpzCiAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgaW1wb3J0IHsgaXNOb25lIH0gZnJvbSAnQGVtYmVyL3V0aWxzJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHZhciBrZXkgPSByZWxhdGlvbnNoaXAua2V5OwogICAgICAgICAgdmFyIGJlbG9uZ3NUbyA9IHNuYXBzaG90LmJlbG9uZ3NUbyhrZXkpOwogICAgICAgICAgIGtleSA9IHRoaXMua2V5Rm9yQXR0cmlidXRlID8gdGhpcy5rZXlGb3JBdHRyaWJ1dGUoa2V5LCAnc2VyaWFsaXplJykgOiBrZXk7CiAgICAgICAgICAgaWYgKGlzTm9uZShiZWxvbmdzVG8pKSB7CiAgICAgICAgICAgIGpzb25ba2V5ICsgJ190eXBlJ10gPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAganNvbltrZXkgKyAnX3R5cGUnXSA9IGJlbG9uZ3NUby5tb2RlbE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAqLwogICAgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKCkge30sCgogICAgLyoqCiAgICAgIGBleHRyYWN0TWV0YWAgaXMgdXNlZCB0byBkZXNlcmlhbGl6ZSBhbnkgbWV0YSBpbmZvcm1hdGlvbiBpbiB0aGUKICAgICAgYWRhcHRlciBwYXlsb2FkLiBCeSBkZWZhdWx0IEVtYmVyIERhdGEgZXhwZWN0cyBtZXRhIGluZm9ybWF0aW9uIHRvCiAgICAgIGJlIGxvY2F0ZWQgb24gdGhlIGBtZXRhYCBwcm9wZXJ0eSBvZiB0aGUgcGF5bG9hZCBvYmplY3QuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5KU09OU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIGV4dHJhY3RNZXRhKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQuaGFzT3duUHJvcGVydHkoJ19wYWdpbmF0aW9uJykpIHsKICAgICAgICAgICAgbGV0IG1ldGEgPSBwYXlsb2FkLl9wYWdpbmF0aW9uOwogICAgICAgICAgICBkZWxldGUgcGF5bG9hZC5fcGFnaW5hdGlvbjsKICAgICAgICAgICAgcmV0dXJuIG1ldGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGV4dHJhY3RNZXRhCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICovCiAgICBleHRyYWN0TWV0YShzdG9yZSwgbW9kZWxDbGFzcywgcGF5bG9hZCkgewogICAgICBpZiAocGF5bG9hZCAmJiBwYXlsb2FkWydtZXRhJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBtZXRhID0gcGF5bG9hZC5tZXRhOwogICAgICAgIGRlbGV0ZSBwYXlsb2FkLm1ldGE7CiAgICAgICAgcmV0dXJuIG1ldGE7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgIGBleHRyYWN0RXJyb3JzYCBpcyB1c2VkIHRvIGV4dHJhY3QgbW9kZWwgZXJyb3JzIHdoZW4gYSBjYWxsCiAgICAgIHRvIGBEUy5Nb2RlbCNzYXZlYCBmYWlscyB3aXRoIGFuIGBJbnZhbGlkRXJyb3JgLiBCeSBkZWZhdWx0CiAgICAgIEVtYmVyIERhdGEgZXhwZWN0cyBlcnJvciBpbmZvcm1hdGlvbiB0byBiZSBsb2NhdGVkIG9uIHRoZSBgZXJyb3JzYAogICAgICBwcm9wZXJ0eSBvZiB0aGUgcGF5bG9hZCBvYmplY3QuCiAgICAgICBUaGlzIHNlcmlhbGl6ZXIgZXhwZWN0cyB0aGlzIGBlcnJvcnNgIG9iamVjdCB0byBiZSBhbiBBcnJheSBzaW1pbGFyCiAgICAgIHRvIHRoZSBmb2xsb3dpbmcsIGNvbXBsaWFudCB3aXRoIHRoZSBKU09OLUFQSSBzcGVjaWZpY2F0aW9uOgogICAgICAgYGBganMKICAgICAgewogICAgICAgICJlcnJvcnMiOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgICJkZXRhaWwiOiAiVGhpcyB1c2VybmFtZSBpcyBhbHJlYWR5IHRha2VuISIsCiAgICAgICAgICAgICJzb3VyY2UiOiB7CiAgICAgICAgICAgICAgInBvaW50ZXIiOiAiZGF0YS9hdHRyaWJ1dGVzL3VzZXJuYW1lIgogICAgICAgICAgICB9CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgICJkZXRhaWwiOiAiRG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBlbWFpbC4iLAogICAgICAgICAgICAic291cmNlIjogewogICAgICAgICAgICAgICJwb2ludGVyIjogImRhdGEvYXR0cmlidXRlcy9lbWFpbCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoZSBrZXkgYGRldGFpbGAgcHJvdmlkZXMgYSB0ZXh0dWFsIGRlc2NyaXB0aW9uIG9mIHRoZSBwcm9ibGVtLgogICAgICBBbHRlcm5hdGl2ZWx5LCB0aGUga2V5IGB0aXRsZWAgY2FuIGJlIHVzZWQgZm9yIHRoZSBzYW1lIHB1cnBvc2UuCiAgICAgICBUaGUgbmVzdGVkIGtleXMgYHNvdXJjZS5wb2ludGVyYCBkZXRhaWwgd2hpY2ggc3BlY2lmaWMgZWxlbWVudAogICAgICBvZiB0aGUgcmVxdWVzdCBkYXRhIHdhcyBpbnZhbGlkLgogICAgICAgTm90ZSB0aGF0IEpTT04tQVBJIGFsc28gYWxsb3dzIGZvciBvYmplY3QtbGV2ZWwgZXJyb3JzIHRvIGJlIHBsYWNlZAogICAgICBpbiBhbiBvYmplY3Qgd2l0aCBwb2ludGVyIGBkYXRhYCwgc2lnbmlmeWluZyB0aGF0IHRoZSBwcm9ibGVtCiAgICAgIGNhbm5vdCBiZSB0cmFjZWQgdG8gYSBzcGVjaWZpYyBhdHRyaWJ1dGU6CiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIHsKICAgICAgICAiZXJyb3JzIjogWwogICAgICAgICAgewogICAgICAgICAgICAiZGV0YWlsIjogIlNvbWUgZ2VuZXJpYyBub24gcHJvcGVydHkgZXJyb3IgbWVzc2FnZSIsCiAgICAgICAgICAgICJzb3VyY2UiOiB7CiAgICAgICAgICAgICAgInBvaW50ZXIiOiAiZGF0YSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfQogICAgICBgYGAKICAgICAgIFdoZW4gdHVybiBpbnRvIGEgYERTLkVycm9yc2Agb2JqZWN0LCB5b3UgY2FuIHJlYWQgdGhlc2UgZXJyb3JzCiAgICAgIHRocm91Z2ggdGhlIHByb3BlcnR5IGBiYXNlYDoKICAgICAgIGBgYGhhbmRsZWJhcnMKICAgICAge3sjZWFjaCBtb2RlbC5lcnJvcnMuYmFzZSBhcyB8ZXJyb3J8fX0KICAgICAgICA8ZGl2IGNsYXNzPSJlcnJvciI+CiAgICAgICAgICB7e2Vycm9yLm1lc3NhZ2V9fQogICAgICAgIDwvZGl2PgogICAgICB7ey9lYWNofX0KICAgICAgYGBgCiAgICAgICBFeGFtcGxlIG9mIGFsdGVybmF0aXZlIGltcGxlbWVudGF0aW9uLCBvdmVycmlkaW5nIHRoZSBkZWZhdWx0CiAgICAgIGJlaGF2aW9yIHRvIGRlYWwgd2l0aCBhIGRpZmZlcmVudCBmb3JtYXQgb2YgZXJyb3JzOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuSlNPTlNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBleHRyYWN0RXJyb3JzKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQsIGlkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZCA9PT0gJ29iamVjdCcgJiYgcGF5bG9hZC5fcHJvYmxlbXMpIHsKICAgICAgICAgICAgcGF5bG9hZCA9IHBheWxvYWQuX3Byb2JsZW1zOwogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZUVycm9ycyh0eXBlQ2xhc3MsIHBheWxvYWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBAbWV0aG9kIGV4dHJhY3RFcnJvcnMKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtEUy5Nb2RlbH0gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7KFN0cmluZ3xOdW1iZXIpfSBpZAogICAgICBAcmV0dXJuIHtPYmplY3R9IGpzb24gVGhlIGRlc2VyaWFsaXplZCBlcnJvcnMKICAgICovCiAgICBleHRyYWN0RXJyb3JzKHN0b3JlLCB0eXBlQ2xhc3MsIHBheWxvYWQsIGlkKSB7CiAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkID09PSAnb2JqZWN0JyAmJiBwYXlsb2FkLmVycm9ycykgewogICAgICAgIHBheWxvYWQgPSAoMCwgX3ByaXZhdGUuZXJyb3JzQXJyYXlUb0hhc2gpKHBheWxvYWQuZXJyb3JzKTsKCiAgICAgICAgdGhpcy5ub3JtYWxpemVVc2luZ0RlY2xhcmVkTWFwcGluZyh0eXBlQ2xhc3MsIHBheWxvYWQpOwoKICAgICAgICB0eXBlQ2xhc3MuZWFjaEF0dHJpYnV0ZShuYW1lID0+IHsKICAgICAgICAgIHZhciBrZXkgPSB0aGlzLmtleUZvckF0dHJpYnV0ZShuYW1lLCAnZGVzZXJpYWxpemUnKTsKICAgICAgICAgIGlmIChrZXkgIT09IG5hbWUgJiYgcGF5bG9hZFtrZXldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcGF5bG9hZFtuYW1lXSA9IHBheWxvYWRba2V5XTsKICAgICAgICAgICAgZGVsZXRlIHBheWxvYWRba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdHlwZUNsYXNzLmVhY2hSZWxhdGlvbnNoaXAobmFtZSA9PiB7CiAgICAgICAgICB2YXIga2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAobmFtZSwgJ2Rlc2VyaWFsaXplJyk7CiAgICAgICAgICBpZiAoa2V5ICE9PSBuYW1lICYmIHBheWxvYWRba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHBheWxvYWRbbmFtZV0gPSBwYXlsb2FkW2tleV07CiAgICAgICAgICAgIGRlbGV0ZSBwYXlsb2FkW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXlsb2FkOwogICAgfSwKCiAgICAvKioKICAgICAgYGtleUZvckF0dHJpYnV0ZWAgY2FuIGJlIHVzZWQgdG8gZGVmaW5lIHJ1bGVzIGZvciBob3cgdG8gY29udmVydCBhbgogICAgICBhdHRyaWJ1dGUgbmFtZSBpbiB5b3VyIG1vZGVsIHRvIGEga2V5IGluIHlvdXIgSlNPTi4KICAgICAgIEV4YW1wbGUKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGltcG9ydCB7IHVuZGVyc2NvcmUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAga2V5Rm9yQXR0cmlidXRlKGF0dHIsIG1ldGhvZCkgewogICAgICAgICAgcmV0dXJuIHVuZGVyc2NvcmUoYXR0cikudG9VcHBlckNhc2UoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qga2V5Rm9yQXR0cmlidXRlCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZAogICAgICBAcmV0dXJuIHtTdHJpbmd9IG5vcm1hbGl6ZWQga2V5CiAgICAqLwogICAga2V5Rm9yQXR0cmlidXRlKGtleSwgbWV0aG9kKSB7CiAgICAgIHJldHVybiBrZXk7CiAgICB9LAoKICAgIC8qKgogICAgICBga2V5Rm9yUmVsYXRpb25zaGlwYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgYSBjdXN0b20ga2V5IHdoZW4KICAgICAgc2VyaWFsaXppbmcgYW5kIGRlc2VyaWFsaXppbmcgcmVsYXRpb25zaGlwIHByb3BlcnRpZXMuIEJ5IGRlZmF1bHQKICAgICAgYEpTT05TZXJpYWxpemVyYCBkb2VzIG5vdCBwcm92aWRlIGFuIGltcGxlbWVudGF0aW9uIG9mIHRoaXMgbWV0aG9kLgogICAgICAgRXhhbXBsZQogICAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvcG9zdC5qcwogICAgICAgIGltcG9ydCBEUyBmcm9tICdlbWJlci1kYXRhJzsKICAgICAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLkpTT05TZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgICBrZXlGb3JSZWxhdGlvbnNoaXAoa2V5LCByZWxhdGlvbnNoaXAsIG1ldGhvZCkgewogICAgICAgICAgICByZXR1cm4gYHJlbF8ke3VuZGVyc2NvcmUoa2V5KX1gOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGBgYAogICAgICAgQG1ldGhvZCBrZXlGb3JSZWxhdGlvbnNoaXAKICAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZUNsYXNzCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QKICAgICAgQHJldHVybiB7U3RyaW5nfSBub3JtYWxpemVkIGtleQogICAgKi8KICAgIGtleUZvclJlbGF0aW9uc2hpcChrZXksIHR5cGVDbGFzcywgbWV0aG9kKSB7CiAgICAgIHJldHVybiBrZXk7CiAgICB9LAoKICAgIC8qKgogICAgIGBrZXlGb3JMaW5rYCBjYW4gYmUgdXNlZCB0byBkZWZpbmUgYSBjdXN0b20ga2V5IHdoZW4gZGVzZXJpYWxpemluZyBsaW5rCiAgICAgcHJvcGVydGllcy4KICAgICAgQG1ldGhvZCBrZXlGb3JMaW5rCiAgICAgQHBhcmFtIHtTdHJpbmd9IGtleQogICAgIEBwYXJhbSB7U3RyaW5nfSBraW5kIGBiZWxvbmdzVG9gIG9yIGBoYXNNYW55YAogICAgIEByZXR1cm4ge1N0cmluZ30gbm9ybWFsaXplZCBrZXkKICAgICovCiAgICBrZXlGb3JMaW5rKGtleSwga2luZCkgewogICAgICByZXR1cm4ga2V5OwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgLyoqCiAgICAgQG1ldGhvZCB0cmFuc2Zvcm1Gb3IKICAgICBAcHJpdmF0ZQogICAgIEBwYXJhbSB7U3RyaW5nfSBhdHRyaWJ1dGVUeXBlCiAgICAgQHBhcmFtIHtCb29sZWFufSBza2lwQXNzZXJ0aW9uCiAgICAgQHJldHVybiB7RFMuVHJhbnNmb3JtfSB0cmFuc2Zvcm0KICAgICovCiAgICB0cmFuc2Zvcm1Gb3IoYXR0cmlidXRlVHlwZSwgc2tpcEFzc2VydGlvbikgewogICAgICB2YXIgdHJhbnNmb3JtID0gKDAsIF9wcml2YXRlLmdldE93bmVyKSh0aGlzKS5sb29rdXAoJ3RyYW5zZm9ybTonICsgYXR0cmlidXRlVHlwZSk7CgogICAgICAodHJ1ZSAmJiAhKHNraXBBc3NlcnRpb24gfHwgISF0cmFuc2Zvcm0pICYmIEVtYmVyLmFzc2VydCgiVW5hYmxlIHRvIGZpbmQgdHJhbnNmb3JtIGZvciAnIiArIGF0dHJpYnV0ZVR5cGUgKyAiJyIsIHNraXBBc3NlcnRpb24gfHwgISF0cmFuc2Zvcm0pKTsKCgogICAgICByZXR1cm4gdHJhbnNmb3JtOwogICAgfQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBKU09OU2VyaWFsaXplcjsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvc2VyaWFsaXplcnMvcmVzdCcsIFsnZXhwb3J0cycsICdlbWJlci1pbmZsZWN0b3InLCAnZW1iZXItZGF0YS9zZXJpYWxpemVycy9qc29uJywgJ2VtYmVyLWRhdGEvLXByaXZhdGUnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckluZmxlY3RvciwgX2pzb24sIF9wcml2YXRlKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgLyoqCiAgICBOb3JtYWxseSwgYXBwbGljYXRpb25zIHdpbGwgdXNlIHRoZSBgUkVTVFNlcmlhbGl6ZXJgIGJ5IGltcGxlbWVudGluZwogICAgdGhlIGBub3JtYWxpemVgIG1ldGhvZC4KICAKICAgIFRoaXMgYWxsb3dzIHlvdSB0byBkbyB3aGF0ZXZlciBraW5kIG9mIG11bmdpbmcgeW91IG5lZWQsIGFuZCBpcwogICAgZXNwZWNpYWxseSB1c2VmdWwgaWYgeW91ciBzZXJ2ZXIgaXMgaW5jb25zaXN0ZW50IGFuZCB5b3UgbmVlZCB0bwogICAgZG8gbXVuZ2luZyBkaWZmZXJlbnRseSBmb3IgbWFueSBkaWZmZXJlbnQga2luZHMgb2YgcmVzcG9uc2VzLgogIAogICAgU2VlIHRoZSBgbm9ybWFsaXplYCBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGluZm9ybWF0aW9uLgogIAogICAgIyMgQWNyb3NzIHRoZSBCb2FyZCBOb3JtYWxpemF0aW9uCiAgCiAgICBUaGVyZSBhcmUgYWxzbyBhIG51bWJlciBvZiBob29rcyB0aGF0IHlvdSBtaWdodCBmaW5kIHVzZWZ1bCB0byBkZWZpbmUKICAgIGFjcm9zcy10aGUtYm9hcmQgcnVsZXMgZm9yIHlvdXIgcGF5bG9hZC4gVGhlc2UgcnVsZXMgd2lsbCBiZSB1c2VmdWwKICAgIGlmIHlvdXIgc2VydmVyIGlzIGNvbnNpc3RlbnQsIG9yIGlmIHlvdSdyZSBidWlsZGluZyBhbiBhZGFwdGVyIGZvcgogICAgYW4gaW5mcmFzdHJ1Y3R1cmUgc2VydmljZSwgbGlrZSBGaXJlYmFzZSwgYW5kIHdhbnQgdG8gZW5jb2RlIHNlcnZpY2UKICAgIGNvbnZlbnRpb25zLgogIAogICAgRm9yIGV4YW1wbGUsIGlmIGFsbCBvZiB5b3VyIGtleXMgYXJlIHVuZGVyc2NvcmVkIGFuZCBhbGwtY2FwcywgYnV0CiAgICBvdGhlcndpc2UgY29uc2lzdGVudCB3aXRoIHRoZSBuYW1lcyB5b3UgdXNlIGluIHlvdXIgbW9kZWxzLCB5b3UKICAgIGNhbiBpbXBsZW1lbnQgYWNyb3NzLXRoZS1ib2FyZCBydWxlcyBmb3IgaG93IHRvIGNvbnZlcnQgYW4gYXR0cmlidXRlCiAgICBuYW1lIGluIHlvdXIgbW9kZWwgdG8gYSBrZXkgaW4geW91ciBKU09OLgogIAogICAgYGBgYXBwL3NlcmlhbGl6ZXJzL2FwcGxpY2F0aW9uLmpzCiAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICBpbXBvcnQgeyB1bmRlcnNjb3JlIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgCiAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICBrZXlGb3JBdHRyaWJ1dGUoYXR0ciwgbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIHVuZGVyc2NvcmUoYXR0cikudG9VcHBlckNhc2UoKTsKICAgICAgfQogICAgfSk7CiAgICBgYGAKICAKICAgIFlvdSBjYW4gYWxzbyBpbXBsZW1lbnQgYGtleUZvclJlbGF0aW9uc2hpcGAsIHdoaWNoIHRha2VzIHRoZSBuYW1lCiAgICBvZiB0aGUgcmVsYXRpb25zaGlwIGFzIHRoZSBmaXJzdCBwYXJhbWV0ZXIsIHRoZSBraW5kIG9mCiAgICByZWxhdGlvbnNoaXAgKGBoYXNNYW55YCBvciBgYmVsb25nc1RvYCkgYXMgdGhlIHNlY29uZCBwYXJhbWV0ZXIsIGFuZAogICAgdGhlIG1ldGhvZCAoYHNlcmlhbGl6ZWAgb3IgYGRlc2VyaWFsaXplYCkgYXMgdGhlIHRoaXJkIHBhcmFtZXRlci4KICAKICAgIEBjbGFzcyBSRVNUU2VyaWFsaXplcgogICAgQG5hbWVzcGFjZSBEUwogICAgQGV4dGVuZHMgRFMuSlNPTlNlcmlhbGl6ZXIKICAqLwogIC8qKgogICAgQG1vZHVsZSBlbWJlci1kYXRhCiAgKi8KCiAgdmFyIFJFU1RTZXJpYWxpemVyID0gX2pzb24uZGVmYXVsdC5leHRlbmQoewoKICAgIC8qKgogICAgIGBrZXlGb3JQb2x5bW9ycGhpY1R5cGVgIGNhbiBiZSB1c2VkIHRvIGRlZmluZSBhIGN1c3RvbSBrZXkgd2hlbgogICAgIHNlcmlhbGl6aW5nIGFuZCBkZXNlcmlhbGl6aW5nIGEgcG9seW1vcnBoaWMgdHlwZS4gQnkgZGVmYXVsdCwgdGhlCiAgICAgcmV0dXJuZWQga2V5IGlzIGAke2tleX1UeXBlYC4KICAgICAgRXhhbXBsZQogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBrZXlGb3JQb2x5bW9ycGhpY1R5cGUoa2V5LCByZWxhdGlvbnNoaXApIHsKICAgICAgICAgIHZhciByZWxhdGlvbnNoaXBLZXkgPSB0aGlzLmtleUZvclJlbGF0aW9uc2hpcChrZXkpOwogICAgICAgICAgIHJldHVybiAndHlwZS0nICsgcmVsYXRpb25zaGlwS2V5OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICBAbWV0aG9kIGtleUZvclBvbHltb3JwaGljVHlwZQogICAgIEBwYXJhbSB7U3RyaW5nfSBrZXkKICAgICBAcGFyYW0ge1N0cmluZ30gdHlwZUNsYXNzCiAgICAgQHBhcmFtIHtTdHJpbmd9IG1ldGhvZAogICAgIEByZXR1cm4ge1N0cmluZ30gbm9ybWFsaXplZCBrZXkKICAgICovCiAgICBrZXlGb3JQb2x5bW9ycGhpY1R5cGUoa2V5LCB0eXBlQ2xhc3MsIG1ldGhvZCkgewogICAgICB2YXIgcmVsYXRpb25zaGlwS2V5ID0gdGhpcy5rZXlGb3JSZWxhdGlvbnNoaXAoa2V5KTsKCiAgICAgIHJldHVybiBgJHtyZWxhdGlvbnNoaXBLZXl9VHlwZWA7CiAgICB9LAoKICAgIC8qKgogICAgICBOb3JtYWxpemVzIGEgcGFydCBvZiB0aGUgSlNPTiBwYXlsb2FkIHJldHVybmVkIGJ5CiAgICAgIHRoZSBzZXJ2ZXIuIFlvdSBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QsIG11bmdlIHRoZSBoYXNoCiAgICAgIGFuZCBjYWxsIHN1cGVyIGlmIHlvdSBoYXZlIGdlbmVyaWMgbm9ybWFsaXphdGlvbiB0byBkby4KICAgICAgIEl0IHRha2VzIHRoZSB0eXBlIG9mIHRoZSByZWNvcmQgdGhhdCBpcyBiZWluZyBub3JtYWxpemVkCiAgICAgIChhcyBhIERTLk1vZGVsIGNsYXNzKSwgdGhlIHByb3BlcnR5IHdoZXJlIHRoZSBoYXNoIHdhcwogICAgICBvcmlnaW5hbGx5IGZvdW5kLCBhbmQgdGhlIGhhc2ggdG8gbm9ybWFsaXplLgogICAgICAgRm9yIGV4YW1wbGUsIGlmIHlvdSBoYXZlIGEgcGF5bG9hZCB0aGF0IGxvb2tzIGxpa2UgdGhpczoKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAicG9zdCI6IHsKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgb21ha2FzZSIsCiAgICAgICAgICAiY29tbWVudHMiOiBbIDEsIDIgXQogICAgICAgIH0sCiAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICJpZCI6IDEsCiAgICAgICAgICAiYm9keSI6ICJGSVJTVCIKICAgICAgICB9LCB7CiAgICAgICAgICAiaWQiOiAyLAogICAgICAgICAgImJvZHkiOiAiUmFpbHMgaXMgdW5hZ2kiCiAgICAgICAgfV0KICAgICAgfQogICAgICBgYGAKICAgICAgIFRoZSBgbm9ybWFsaXplYCBtZXRob2Qgd2lsbCBiZSBjYWxsZWQgdGhyZWUgdGltZXM6CiAgICAgICAqIFdpdGggYEFwcC5Qb3N0YCwgYCJwb3N0cyJgIGFuZCBgeyBpZDogMSwgdGl0bGU6ICJSYWlscyBpcyBvbWFrYXNlIiwgLi4uIH1gCiAgICAgICogV2l0aCBgQXBwLkNvbW1lbnRgLCBgImNvbW1lbnRzImAgYW5kIGB7IGlkOiAxLCBib2R5OiAiRklSU1QiIH1gCiAgICAgICogV2l0aCBgQXBwLkNvbW1lbnRgLCBgImNvbW1lbnRzImAgYW5kIGB7IGlkOiAyLCBib2R5OiAiUmFpbHMgaXMgdW5hZ2kiIH1gCiAgICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCwgZm9yIGV4YW1wbGUsIHRvIG5vcm1hbGl6ZSB1bmRlcnNjb3JlZCBrZXlzIHRvIGNhbWVsaXplZAogICAgICBvciBvdGhlciBnZW5lcmFsLXB1cnBvc2Ugbm9ybWFsaXphdGlvbnMuIFlvdSB3aWxsIG9ubHkgbmVlZCB0byBpbXBsZW1lbnQKICAgICAgYG5vcm1hbGl6ZWAgYW5kIG1hbmlwdWxhdGUgdGhlIHBheWxvYWQgYXMgZGVzaXJlZC4KICAgICAgIEZvciBleGFtcGxlLCBpZiB0aGUgYElEc2AgdW5kZXIgYCJjb21tZW50cyJgIGFyZSBwcm92aWRlZCBhcyBgX2lkYCBpbnN0ZWFkIG9mCiAgICAgIGBpZGAsIHlvdSBjYW4gc3BlY2lmeSBob3cgdG8gbm9ybWFsaXplIGp1c3QgdGhlIGNvbW1lbnRzOgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBub3JtYWxpemUobW9kZWwsIGhhc2gsIHByb3ApIHsKICAgICAgICAgIGlmIChwcm9wID09PSAnY29tbWVudHMnKSB7CiAgICAgICAgICAgIGhhc2guaWQgPSBoYXNoLl9pZDsKICAgICAgICAgICAgZGVsZXRlIGhhc2guX2lkOwogICAgICAgICAgfQogICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlciguLi5hcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgT24gZWFjaCBjYWxsIHRvIHRoZSBgbm9ybWFsaXplYCBtZXRob2QsIHRoZSB0aGlyZCBwYXJhbWV0ZXIgKGBwcm9wYCkgaXMgYWx3YXlzCiAgICAgIG9uZSBvZiB0aGUga2V5cyB0aGF0IHdlcmUgaW4gdGhlIG9yaWdpbmFsIHBheWxvYWQgb3IgaW4gdGhlIHJlc3VsdCBvZiBhbm90aGVyCiAgICAgIG5vcm1hbGl6YXRpb24gYXMgYG5vcm1hbGl6ZVJlc3BvbnNlYC4KICAgICAgIEBtZXRob2Qgbm9ybWFsaXplCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IG1vZGVsQ2xhc3MKICAgICAgQHBhcmFtIHtPYmplY3R9IHJlc291cmNlSGFzaAogICAgICBAcGFyYW0ge1N0cmluZ30gcHJvcAogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAqLwoKICAgIC8qKgogICAgICBOb3JtYWxpemVzIGFuIGFycmF5IG9mIHJlc291cmNlIHBheWxvYWRzIGFuZCByZXR1cm5zIGEgSlNPTi1BUEkgRG9jdW1lbnQKICAgICAgd2l0aCBwcmltYXJ5IGRhdGEgYW5kLCBpZiBhbnksIGluY2x1ZGVkIGRhdGEgYXMgYHsgZGF0YSwgaW5jbHVkZWQgfWAuCiAgICAgICBAbWV0aG9kIF9ub3JtYWxpemVBcnJheQogICAgICBAcGFyYW0ge0RTLlN0b3JlfSBzdG9yZQogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBhcnJheUhhc2gKICAgICAgQHBhcmFtIHtTdHJpbmd9IHByb3AKICAgICAgQHJldHVybiB7T2JqZWN0fQogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVBcnJheShzdG9yZSwgbW9kZWxOYW1lLCBhcnJheUhhc2gsIHByb3ApIHsKICAgICAgdmFyIGRvY3VtZW50SGFzaCA9IHsKICAgICAgICBkYXRhOiBbXSwKICAgICAgICBpbmNsdWRlZDogW10KICAgICAgfTsKCiAgICAgIHZhciBtb2RlbENsYXNzID0gc3RvcmUubW9kZWxGb3IobW9kZWxOYW1lKTsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBzdG9yZS5zZXJpYWxpemVyRm9yKG1vZGVsTmFtZSk7CgogICAgICBFbWJlci5tYWtlQXJyYXkoYXJyYXlIYXNoKS5mb3JFYWNoKGhhc2ggPT4gewogICAgICAgIHZhciB7IGRhdGEsIGluY2x1ZGVkIH0gPSB0aGlzLl9ub3JtYWxpemVQb2x5bW9ycGhpY1JlY29yZChzdG9yZSwgaGFzaCwgcHJvcCwgbW9kZWxDbGFzcywgc2VyaWFsaXplcik7CiAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEucHVzaChkYXRhKTsKICAgICAgICBpZiAoaW5jbHVkZWQpIHsKICAgICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZC5wdXNoKC4uLmluY2x1ZGVkKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgIH0sCgogICAgX25vcm1hbGl6ZVBvbHltb3JwaGljUmVjb3JkKHN0b3JlLCBoYXNoLCBwcm9wLCBwcmltYXJ5TW9kZWxDbGFzcywgcHJpbWFyeVNlcmlhbGl6ZXIpIHsKICAgICAgdmFyIHNlcmlhbGl6ZXIgPSBwcmltYXJ5U2VyaWFsaXplcjsKICAgICAgdmFyIG1vZGVsQ2xhc3MgPSBwcmltYXJ5TW9kZWxDbGFzczsKCiAgICAgIHZhciBwcmltYXJ5SGFzVHlwZUF0dHJpYnV0ZSA9ICgwLCBfcHJpdmF0ZS5tb2RlbEhhc0F0dHJpYnV0ZU9yUmVsYXRpb25zaGlwTmFtZWRUeXBlKShwcmltYXJ5TW9kZWxDbGFzcyk7CgogICAgICBpZiAoIXByaW1hcnlIYXNUeXBlQXR0cmlidXRlICYmIGhhc2gudHlwZSkgewogICAgICAgIC8vIFN1cHBvcnQgcG9seW1vcnBoaWMgcmVjb3JkcyBpbiBhc3luYyByZWxhdGlvbnNoaXBzCiAgICAgICAgdmFyIG1vZGVsTmFtZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkoaGFzaC50eXBlKTsKCiAgICAgICAgaWYgKHN0b3JlLl9oYXNNb2RlbEZvcihtb2RlbE5hbWUpKSB7CiAgICAgICAgICBzZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcihtb2RlbE5hbWUpOwogICAgICAgICAgbW9kZWxDbGFzcyA9IHN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc2VyaWFsaXplci5ub3JtYWxpemUobW9kZWxDbGFzcywgaGFzaCwgcHJvcCk7CiAgICB9LAoKICAgIC8qCiAgICAgIEBtZXRob2QgX25vcm1hbGl6ZVJlc3BvbnNlCiAgICAgIEBwYXJhbSB7RFMuU3RvcmV9IHN0b3JlCiAgICAgIEBwYXJhbSB7RFMuTW9kZWx9IHByaW1hcnlNb2RlbENsYXNzCiAgICAgIEBwYXJhbSB7T2JqZWN0fSBwYXlsb2FkCiAgICAgIEBwYXJhbSB7U3RyaW5nfE51bWJlcn0gaWQKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlcXVlc3RUeXBlCiAgICAgIEBwYXJhbSB7Qm9vbGVhbn0gaXNTaW5nbGUKICAgICAgQHJldHVybiB7T2JqZWN0fSBKU09OLUFQSSBEb2N1bWVudAogICAgICBAcHJpdmF0ZQogICAgKi8KICAgIF9ub3JtYWxpemVSZXNwb25zZShzdG9yZSwgcHJpbWFyeU1vZGVsQ2xhc3MsIHBheWxvYWQsIGlkLCByZXF1ZXN0VHlwZSwgaXNTaW5nbGUpIHsKICAgICAgdmFyIGRvY3VtZW50SGFzaCA9IHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGluY2x1ZGVkOiBbXQogICAgICB9OwoKICAgICAgdmFyIG1ldGEgPSB0aGlzLmV4dHJhY3RNZXRhKHN0b3JlLCBwcmltYXJ5TW9kZWxDbGFzcywgcGF5bG9hZCk7CiAgICAgIGlmIChtZXRhKSB7CiAgICAgICAgKHRydWUgJiYgIShFbWJlci50eXBlT2YobWV0YSkgPT09ICdvYmplY3QnKSAmJiBFbWJlci5hc3NlcnQoJ1RoZSBgbWV0YWAgcmV0dXJuZWQgZnJvbSBgZXh0cmFjdE1ldGFgIGhhcyB0byBiZSBhbiBvYmplY3QsIG5vdCAiJyArIEVtYmVyLnR5cGVPZihtZXRhKSArICciLicsIEVtYmVyLnR5cGVPZihtZXRhKSA9PT0gJ29iamVjdCcpKTsKCiAgICAgICAgZG9jdW1lbnRIYXNoLm1ldGEgPSBtZXRhOwogICAgICB9CgogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHBheWxvYWQpOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcHJvcCA9IGtleXNbaV07CiAgICAgICAgdmFyIG1vZGVsTmFtZSA9IHByb3A7CiAgICAgICAgdmFyIGZvcmNlZFNlY29uZGFyeSA9IGZhbHNlOwoKICAgICAgICAvKgogICAgICAgICAgSWYgeW91IHdhbnQgdG8gcHJvdmlkZSBzaWRlbG9hZGVkIHJlY29yZHMgb2YgdGhlIHNhbWUgdHlwZSB0aGF0IHRoZQogICAgICAgICAgcHJpbWFyeSBkYXRhIHlvdSBjYW4gZG8gdGhhdCBieSBwcmVmaXhpbmcgdGhlIGtleSB3aXRoIGBfYC4KICAgICAgICAgICBFeGFtcGxlCiAgICAgICAgICAgYGBgCiAgICAgICAgICB7CiAgICAgICAgICAgIHVzZXJzOiBbCiAgICAgICAgICAgICAgeyBpZDogMSwgdGl0bGU6ICdUb20nLCBtYW5hZ2VyOiAzIH0sCiAgICAgICAgICAgICAgeyBpZDogMiwgdGl0bGU6ICdZZWh1ZGEnLCBtYW5hZ2VyOiAzIH0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgX3VzZXJzOiBbCiAgICAgICAgICAgICAgeyBpZDogMywgdGl0bGU6ICdUb21zdGVyJyB9CiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICAgIGBgYAogICAgICAgICAgIFRoaXMgZm9yY2VzIGBfdXNlcnNgIHRvIGJlIGFkZGVkIHRvIGBpbmNsdWRlZGAgaW5zdGVhZCBvZiBgZGF0YWAuCiAgICAgICAgICovCiAgICAgICAgaWYgKHByb3AuY2hhckF0KDApID09PSAnXycpIHsKICAgICAgICAgIGZvcmNlZFNlY29uZGFyeSA9IHRydWU7CiAgICAgICAgICBtb2RlbE5hbWUgPSBwcm9wLnN1YnN0cigxKTsKICAgICAgICB9CgogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkobW9kZWxOYW1lKTsKICAgICAgICBpZiAoIXN0b3JlLm1vZGVsRmFjdG9yeUZvcih0eXBlTmFtZSkpIHsKICAgICAgICAgICh0cnVlICYmIEVtYmVyLndhcm4odGhpcy53YXJuTWVzc2FnZU5vTW9kZWxGb3JLZXkobW9kZWxOYW1lLCB0eXBlTmFtZSksIGZhbHNlLCB7CiAgICAgICAgICAgIGlkOiAnZHMuc2VyaWFsaXplci5tb2RlbC1mb3Ita2V5LW1pc3NpbmcnCiAgICAgICAgICB9KSk7CgogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgaXNQcmltYXJ5ID0gIWZvcmNlZFNlY29uZGFyeSAmJiB0aGlzLmlzUHJpbWFyeVR5cGUoc3RvcmUsIHR5cGVOYW1lLCBwcmltYXJ5TW9kZWxDbGFzcyk7CiAgICAgICAgdmFyIHZhbHVlID0gcGF5bG9hZFtwcm9wXTsKCiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICB2YXIgaXNRdWVyeVJlY29yZEFuQXJyYXkgPSByZXF1ZXN0VHlwZSA9PT0gJ3F1ZXJ5UmVjb3JkJyAmJiBpc1ByaW1hcnkgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICJUaGUgYWRhcHRlciByZXR1cm5lZCBhbiBhcnJheSBmb3IgdGhlIHByaW1hcnkgZGF0YSBvZiBhIGBxdWVyeVJlY29yZGAgcmVzcG9uc2UuIFRoaXMgaXMgZGVwcmVjYXRlZCBhcyBgcXVlcnlSZWNvcmRgIHNob3VsZCByZXR1cm4gYSBzaW5nbGUgcmVjb3JkLiI7CgogICAgICAgICAgKHRydWUgJiYgISghaXNRdWVyeVJlY29yZEFuQXJyYXkpICYmIEVtYmVyLmRlcHJlY2F0ZShtZXNzYWdlLCAhaXNRdWVyeVJlY29yZEFuQXJyYXksIHsKICAgICAgICAgICAgaWQ6ICdkcy5zZXJpYWxpemVyLnJlc3QucXVlcnlSZWNvcmQtYXJyYXktcmVzcG9uc2UnLAogICAgICAgICAgICB1bnRpbDogJzMuMCcKICAgICAgICAgIH0pKTsKICAgICAgICB9CgogICAgICAgIC8qCiAgICAgICAgICBTdXBwb3J0IHByaW1hcnkgZGF0YSBhcyBhbiBvYmplY3QgaW5zdGVhZCBvZiBhbiBhcnJheS4KICAgICAgICAgICBFeGFtcGxlCiAgICAgICAgICAgYGBgCiAgICAgICAgICB7CiAgICAgICAgICAgIHVzZXI6IHsgaWQ6IDEsIHRpdGxlOiAnVG9tJywgbWFuYWdlcjogMyB9CiAgICAgICAgICB9CiAgICAgICAgICBgYGAKICAgICAgICAgKi8KICAgICAgICBpZiAoaXNQcmltYXJ5ICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFyIHsgZGF0YTogX2RhdGEsIGluY2x1ZGVkOiBfaW5jbHVkZWQgfSA9IHRoaXMuX25vcm1hbGl6ZVBvbHltb3JwaGljUmVjb3JkKHN0b3JlLCB2YWx1ZSwgcHJvcCwgcHJpbWFyeU1vZGVsQ2xhc3MsIHRoaXMpOwogICAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEgPSBfZGF0YTsKICAgICAgICAgIGlmIChfaW5jbHVkZWQpIHsKICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmluY2x1ZGVkLnB1c2goLi4uX2luY2x1ZGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHsgZGF0YSwgaW5jbHVkZWQgfSA9IHRoaXMuX25vcm1hbGl6ZUFycmF5KHN0b3JlLCB0eXBlTmFtZSwgdmFsdWUsIHByb3ApOwoKICAgICAgICBpZiAoaW5jbHVkZWQpIHsKICAgICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZC5wdXNoKC4uLmluY2x1ZGVkKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc1NpbmdsZSkgewogICAgICAgICAgZGF0YS5mb3JFYWNoKHJlc291cmNlID0+IHsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgRmlndXJlcyBvdXQgaWYgdGhpcyBpcyB0aGUgcHJpbWFyeSByZWNvcmQgb3Igbm90LgogICAgICAgICAgICAgICBJdCdzIGVpdGhlcjoKICAgICAgICAgICAgICAgMS4gVGhlIHJlY29yZCB3aXRoIHRoZSBzYW1lIElEIGFzIHRoZSBvcmlnaW5hbCByZXF1ZXN0CiAgICAgICAgICAgICAgMi4gSWYgaXQncyBhIG5ld2x5IGNyZWF0ZWQgcmVjb3JkIHdpdGhvdXQgYW4gSUQsIHRoZSBmaXJzdCByZWNvcmQKICAgICAgICAgICAgICAgICBpbiB0aGUgYXJyYXkKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciBpc1VwZGF0ZWRSZWNvcmQgPSBpc1ByaW1hcnkgJiYgKDAsIF9wcml2YXRlLmNvZXJjZUlkKShyZXNvdXJjZS5pZCkgPT09IGlkOwogICAgICAgICAgICB2YXIgaXNGaXJzdENyZWF0ZWRSZWNvcmQgPSBpc1ByaW1hcnkgJiYgIWlkICYmICFkb2N1bWVudEhhc2guZGF0YTsKCiAgICAgICAgICAgIGlmIChpc0ZpcnN0Q3JlYXRlZFJlY29yZCB8fCBpc1VwZGF0ZWRSZWNvcmQpIHsKICAgICAgICAgICAgICBkb2N1bWVudEhhc2guZGF0YSA9IHJlc291cmNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvY3VtZW50SGFzaC5pbmNsdWRlZC5wdXNoKHJlc291cmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1ByaW1hcnkpIHsKICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmRhdGEgPSBkYXRhOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICBkb2N1bWVudEhhc2guaW5jbHVkZWQucHVzaCguLi5kYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGRvY3VtZW50SGFzaDsKICAgIH0sCgogICAgaXNQcmltYXJ5VHlwZShzdG9yZSwgdHlwZU5hbWUsIHByaW1hcnlUeXBlQ2xhc3MpIHsKICAgICAgcmV0dXJuIHN0b3JlLm1vZGVsRm9yKHR5cGVOYW1lKSA9PT0gcHJpbWFyeVR5cGVDbGFzczsKICAgIH0sCgogICAgLyoqCiAgICAgIFRoaXMgbWV0aG9kIGFsbG93cyB5b3UgdG8gcHVzaCBhIHBheWxvYWQgY29udGFpbmluZyB0b3AtbGV2ZWwKICAgICAgY29sbGVjdGlvbnMgb2YgcmVjb3JkcyBvcmdhbml6ZWQgcGVyIHR5cGUuCiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInBvc3RzIjogW3sKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJ0aXRsZSI6ICJSYWlscyBpcyBvbWFrYXNlIiwKICAgICAgICAgICJhdXRob3IiLCAiMSIsCiAgICAgICAgICAiY29tbWVudHMiOiBbICIxIiBdCiAgICAgICAgfV0sCiAgICAgICAgImNvbW1lbnRzIjogW3sKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJib2R5IjogIkZJUlNUIgogICAgICAgIH1dLAogICAgICAgICJ1c2VycyI6IFt7CiAgICAgICAgICAiaWQiOiAiMSIsCiAgICAgICAgICAibmFtZSI6ICJAZDJoIgogICAgICAgIH1dCiAgICAgIH0KICAgICAgYGBgCiAgICAgICBJdCB3aWxsIGZpcnN0IG5vcm1hbGl6ZSB0aGUgcGF5bG9hZCwgc28geW91IGNhbiB1c2UgdGhpcyB0byBwdXNoCiAgICAgIGluIGRhdGEgc3RyZWFtaW5nIGluIGZyb20geW91ciBzZXJ2ZXIgc3RydWN0dXJlZCB0aGUgc2FtZSB3YXkKICAgICAgdGhhdCBmZXRjaGVzIGFuZCBzYXZlcyBhcmUgc3RydWN0dXJlZC4KICAgICAgIEBtZXRob2QgcHVzaFBheWxvYWQKICAgICAgQHBhcmFtIHtEUy5TdG9yZX0gc3RvcmUKICAgICAgQHBhcmFtIHtPYmplY3R9IHBheWxvYWQKICAgICovCiAgICBwdXNoUGF5bG9hZChzdG9yZSwgcGF5bG9hZCkgewogICAgICB2YXIgZG9jdW1lbnRIYXNoID0gewogICAgICAgIGRhdGE6IFtdLAogICAgICAgIGluY2x1ZGVkOiBbXQogICAgICB9OwoKICAgICAgZm9yICh2YXIgcHJvcCBpbiBwYXlsb2FkKSB7CiAgICAgICAgdmFyIG1vZGVsTmFtZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocHJvcCk7CiAgICAgICAgaWYgKCFzdG9yZS5tb2RlbEZhY3RvcnlGb3IobW9kZWxOYW1lKSkgewogICAgICAgICAgKHRydWUgJiYgRW1iZXIud2Fybih0aGlzLndhcm5NZXNzYWdlTm9Nb2RlbEZvcktleShwcm9wLCBtb2RlbE5hbWUpLCBmYWxzZSwgewogICAgICAgICAgICBpZDogJ2RzLnNlcmlhbGl6ZXIubW9kZWwtZm9yLWtleS1taXNzaW5nJwogICAgICAgICAgfSkpOwoKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICB2YXIgdHlwZSA9IHN0b3JlLm1vZGVsRm9yKG1vZGVsTmFtZSk7CiAgICAgICAgdmFyIHR5cGVTZXJpYWxpemVyID0gc3RvcmUuc2VyaWFsaXplckZvcih0eXBlLm1vZGVsTmFtZSk7CgogICAgICAgIEVtYmVyLm1ha2VBcnJheShwYXlsb2FkW3Byb3BdKS5mb3JFYWNoKGhhc2ggPT4gewogICAgICAgICAgdmFyIHsgZGF0YSwgaW5jbHVkZWQgfSA9IHR5cGVTZXJpYWxpemVyLm5vcm1hbGl6ZSh0eXBlLCBoYXNoLCBwcm9wKTsKICAgICAgICAgIGRvY3VtZW50SGFzaC5kYXRhLnB1c2goZGF0YSk7CiAgICAgICAgICBpZiAoaW5jbHVkZWQpIHsKICAgICAgICAgICAgZG9jdW1lbnRIYXNoLmluY2x1ZGVkLnB1c2goLi4uaW5jbHVkZWQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBzdG9yZS5wdXNoKGRvY3VtZW50SGFzaCk7CiAgICB9LAoKICAgIC8qKgogICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIGNvbnZlcnQgZWFjaCBKU09OIHJvb3Qga2V5IGluIHRoZSBwYXlsb2FkCiAgICAgIGludG8gYSBtb2RlbE5hbWUgdGhhdCBpdCBjYW4gdXNlIHRvIGxvb2sgdXAgdGhlIGFwcHJvcHJpYXRlIG1vZGVsIGZvcgogICAgICB0aGF0IHBhcnQgb2YgdGhlIHBheWxvYWQuCiAgICAgICBGb3IgZXhhbXBsZSwgeW91ciBzZXJ2ZXIgbWF5IHNlbmQgYSBtb2RlbCBuYW1lIHRoYXQgZG9lcyBub3QgY29ycmVzcG9uZCB3aXRoCiAgICAgIHRoZSBuYW1lIG9mIHRoZSBtb2RlbCBpbiB5b3VyIGFwcC4gTGV0J3MgdGFrZSBhIGxvb2sgYXQgYW4gZXhhbXBsZSBtb2RlbCwKICAgICAgYW5kIGFuIGV4YW1wbGUgcGF5bG9hZDoKICAgICAgIGBgYGFwcC9tb2RlbHMvcG9zdC5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgICAgewogICAgICAgICAgImJsb2cvcG9zdCI6IHsKICAgICAgICAgICAgImlkIjogIjEKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIGBgYAogICAgICAgRW1iZXIgRGF0YSBpcyBnb2luZyB0byBub3JtYWxpemUgdGhlIHBheWxvYWQncyByb290IGtleSBmb3IgdGhlIG1vZGVsTmFtZS4gQXMgYSByZXN1bHQsCiAgICAgIGl0IHdpbGwgdHJ5IHRvIGxvb2sgdXAgdGhlICJibG9nL3Bvc3QiIG1vZGVsLiBTaW5jZSB3ZSBkb24ndCBoYXZlIGEgbW9kZWwgY2FsbGVkICJibG9nL3Bvc3QiCiAgICAgIChvciBhIGZpbGUgY2FsbGVkIGFwcC9tb2RlbHMvYmxvZy9wb3N0LmpzIGluIGVtYmVyLWNsaSksIEVtYmVyIERhdGEgd2lsbCB0aHJvdyBhbiBlcnJvcgogICAgICBiZWNhdXNlIGl0IGNhbm5vdCBmaW5kIHRoZSAiYmxvZy9wb3N0IiBtb2RlbC4KICAgICAgIFNpbmNlIHdlIHdhbnQgdG8gcmVtb3ZlIHRoaXMgbmFtZXNwYWNlLCB3ZSBjYW4gZGVmaW5lIGEgc2VyaWFsaXplciBmb3IgdGhlIGFwcGxpY2F0aW9uIHRoYXQgd2lsbAogICAgICByZW1vdmUgImJsb2cvIiBmcm9tIHRoZSBwYXlsb2FkIGtleSB3aGVudmVyIGl0J3MgZW5jb3VudGVyZWQgYnkgRW1iZXIgRGF0YToKICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KHBheWxvYWRLZXkpIHsKICAgICAgICAgIGlmIChwYXlsb2FkS2V5ID09PSAnYmxvZy9wb3N0JykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc3VwZXIocGF5bG9hZEtleS5yZXBsYWNlKCdibG9nLycsICcnKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgIHJldHVybiB0aGlzLl9zdXBlcihwYXlsb2FkS2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEFmdGVyIHJlZnJlc2hpbmcsIEVtYmVyIERhdGEgd2lsbCBhcHByb3ByaWF0ZWx5IGxvb2sgdXAgdGhlICJwb3N0IiBtb2RlbC4KICAgICAgIEJ5IGRlZmF1bHQgdGhlIG1vZGVsTmFtZSBmb3IgYSBtb2RlbCBpcyBpdHMKICAgICAgbmFtZSBpbiBkYXNoZXJpemVkIGZvcm0uIFRoaXMgbWVhbnMgdGhhdCBhIHBheWxvYWQga2V5IGxpa2UgImJsb2dQb3N0IiB3b3VsZCBiZQogICAgICBub3JtYWxpemVkIHRvICJibG9nLXBvc3QiIHdoZW4gRW1iZXIgRGF0YSBsb29rcyB1cCB0aGUgbW9kZWwuIFVzdWFsbHksIEVtYmVyIERhdGEKICAgICAgY2FuIHVzZSB0aGUgY29ycmVjdCBpbmZsZWN0aW9uIHRvIGRvIHRoaXMgZm9yIHlvdS4gTW9zdCBvZiB0aGUgdGltZSwgeW91IHdvbid0CiAgICAgIG5lZWQgdG8gb3ZlcnJpZGUgYG1vZGVsTmFtZUZyb21QYXlsb2FkS2V5YCBmb3IgdGhpcyBwdXJwb3NlLgogICAgICAgQG1ldGhvZCBtb2RlbE5hbWVGcm9tUGF5bG9hZEtleQogICAgICBAcGFyYW0ge1N0cmluZ30ga2V5CiAgICAgIEByZXR1cm4ge1N0cmluZ30gdGhlIG1vZGVsJ3MgbW9kZWxOYW1lCiAgICAqLwogICAgbW9kZWxOYW1lRnJvbVBheWxvYWRLZXkoa2V5KSB7CiAgICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnNpbmd1bGFyaXplKSgoMCwgX3ByaXZhdGUubm9ybWFsaXplTW9kZWxOYW1lKShrZXkpKTsKICAgIH0sCgogICAgLy8gU0VSSUFMSVpFCgogICAgLyoqCiAgICAgIENhbGxlZCB3aGVuIGEgcmVjb3JkIGlzIHNhdmVkIGluIG9yZGVyIHRvIGNvbnZlcnQgdGhlCiAgICAgIHJlY29yZCBpbnRvIEpTT04uCiAgICAgICBCeSBkZWZhdWx0LCBpdCBjcmVhdGVzIGEgSlNPTiBvYmplY3Qgd2l0aCBhIGtleSBmb3IKICAgICAgZWFjaCBhdHRyaWJ1dGUgYW5kIGJlbG9uZ3NUbyByZWxhdGlvbnNoaXAuCiAgICAgICBGb3IgZXhhbXBsZSwgY29uc2lkZXIgdGhpcyBtb2RlbDoKICAgICAgIGBgYGFwcC9tb2RlbHMvY29tbWVudC5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5Nb2RlbC5leHRlbmQoewogICAgICAgIHRpdGxlOiBEUy5hdHRyKCksCiAgICAgICAgYm9keTogRFMuYXR0cigpLAogICAgICAgICBhdXRob3I6IERTLmJlbG9uZ3NUbygndXNlcicpCiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIFRoZSBkZWZhdWx0IHNlcmlhbGl6YXRpb24gd291bGQgY3JlYXRlIGEgSlNPTiBvYmplY3QgbGlrZToKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAidGl0bGUiOiAiUmFpbHMgaXMgdW5hZ2kiLAogICAgICAgICJib2R5IjogIlJhaWxzPyBPbWFrYXNlPyBPX08iLAogICAgICAgICJhdXRob3IiOiAxMgogICAgICB9CiAgICAgIGBgYAogICAgICAgQnkgZGVmYXVsdCwgYXR0cmlidXRlcyBhcmUgcGFzc2VkIHRocm91Z2ggYXMtaXMsIHVubGVzcwogICAgICB5b3Ugc3BlY2lmaWVkIGFuIGF0dHJpYnV0ZSB0eXBlIChgRFMuYXR0cignZGF0ZScpYCkuIElmCiAgICAgIHlvdSBzcGVjaWZ5IGEgdHJhbnNmb3JtLCB0aGUgSmF2YVNjcmlwdCB2YWx1ZSB3aWxsIGJlCiAgICAgIHNlcmlhbGl6ZWQgd2hlbiBpbnNlcnRlZCBpbnRvIHRoZSBKU09OIGhhc2guCiAgICAgICBCeSBkZWZhdWx0LCBiZWxvbmdzLXRvIHJlbGF0aW9uc2hpcHMgYXJlIGNvbnZlcnRlZCBpbnRvCiAgICAgIElEcyB3aGVuIGluc2VydGVkIGludG8gdGhlIEpTT04gaGFzaC4KICAgICAgICMjIElEcwogICAgICAgYHNlcmlhbGl6ZWAgdGFrZXMgYW4gb3B0aW9ucyBoYXNoIHdpdGggYSBzaW5nbGUgb3B0aW9uOgogICAgICBgaW5jbHVkZUlkYC4gSWYgdGhpcyBvcHRpb24gaXMgYHRydWVgLCBgc2VyaWFsaXplYCB3aWxsLAogICAgICBieSBkZWZhdWx0IGluY2x1ZGUgdGhlIElEIGluIHRoZSBKU09OIG9iamVjdCBpdCBidWlsZHMuCiAgICAgICBUaGUgYWRhcHRlciBwYXNzZXMgaW4gYGluY2x1ZGVJZDogdHJ1ZWAgd2hlbiBzZXJpYWxpemluZwogICAgICBhIHJlY29yZCBmb3IgYGNyZWF0ZVJlY29yZGAsIGJ1dCBub3QgZm9yIGB1cGRhdGVSZWNvcmRgLgogICAgICAgIyMgQ3VzdG9taXphdGlvbgogICAgICAgWW91ciBzZXJ2ZXIgbWF5IGV4cGVjdCBhIGRpZmZlcmVudCBKU09OIGZvcm1hdCB0aGFuIHRoZQogICAgICBidWlsdC1pbiBzZXJpYWxpemF0aW9uIGZvcm1hdC4KICAgICAgIEluIHRoYXQgY2FzZSwgeW91IGNhbiBpbXBsZW1lbnQgYHNlcmlhbGl6ZWAgeW91cnNlbGYgYW5kCiAgICAgIHJldHVybiBhIEpTT04gaGFzaCBvZiB5b3VyIGNob29zaW5nLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBqc29uID0gewogICAgICAgICAgICBQT1NUX1RUTDogc25hcHNob3QuYXR0cigndGl0bGUnKSwKICAgICAgICAgICAgUE9TVF9CRFk6IHNuYXBzaG90LmF0dHIoJ2JvZHknKSwKICAgICAgICAgICAgUE9TVF9DTVM6IHNuYXBzaG90Lmhhc01hbnkoJ2NvbW1lbnRzJywgeyBpZHM6IHRydWUgfSkKICAgICAgICAgIH07CiAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICAgIGpzb24uUE9TVF9JRF8gPSBzbmFwc2hvdC5pZDsKICAgICAgICAgIH0KICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgICMjIEN1c3RvbWl6aW5nIGFuIEFwcC1XaWRlIFNlcmlhbGl6ZXIKICAgICAgIElmIHlvdSB3YW50IHRvIGRlZmluZSBhIHNlcmlhbGl6ZXIgZm9yIHlvdXIgZW50aXJlCiAgICAgIGFwcGxpY2F0aW9uLCB5b3UnbGwgcHJvYmFibHkgd2FudCB0byB1c2UgYGVhY2hBdHRyaWJ1dGVgCiAgICAgIGFuZCBgZWFjaFJlbGF0aW9uc2hpcGAgb24gdGhlIHJlY29yZC4KICAgICAgIGBgYGFwcC9zZXJpYWxpemVycy9hcHBsaWNhdGlvbi5qcwogICAgICBpbXBvcnQgRFMgZnJvbSAnZW1iZXItZGF0YSc7CiAgICAgIGltcG9ydCB7IHBsdXJhbGl6ZSB9IGZyb20gJ2VtYmVyLWluZmxlY3Rvcic7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIGpzb24gPSB7fTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoQXR0cmlidXRlKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAganNvbltzZXJ2ZXJBdHRyaWJ1dGVOYW1lKG5hbWUpXSA9IHNuYXBzaG90LmF0dHIobmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgICBzbmFwc2hvdC5lYWNoUmVsYXRpb25zaGlwKGZ1bmN0aW9uKG5hbWUsIHJlbGF0aW9uc2hpcCkgewogICAgICAgICAgICBpZiAocmVsYXRpb25zaGlwLmtpbmQgPT09ICdoYXNNYW55JykgewogICAgICAgICAgICAgIGpzb25bc2VydmVySGFzTWFueU5hbWUobmFtZSldID0gc25hcHNob3QuaGFzTWFueShuYW1lLCB7IGlkczogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5jbHVkZUlkKSB7CiAgICAgICAgICAgIGpzb24uSURfID0gc25hcHNob3QuaWQ7CiAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIGpzb247CiAgICAgICAgfQogICAgICB9KTsKICAgICAgIGZ1bmN0aW9uIHNlcnZlckF0dHJpYnV0ZU5hbWUoYXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZS51bmRlcnNjb3JlKCkudG9VcHBlckNhc2UoKTsKICAgICAgfQogICAgICAgZnVuY3Rpb24gc2VydmVySGFzTWFueU5hbWUobmFtZSkgewogICAgICAgIHJldHVybiBzZXJ2ZXJBdHRyaWJ1dGVOYW1lKHNpbmd1bGFyaXplKG5hbWUpKSArICJfSURTIjsKICAgICAgfQogICAgICBgYGAKICAgICAgIFRoaXMgc2VyaWFsaXplciB3aWxsIGdlbmVyYXRlIEpTT04gdGhhdCBsb29rcyBsaWtlIHRoaXM6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgIlRJVExFIjogIlJhaWxzIGlzIG9tYWthc2UiLAogICAgICAgICJCT0RZIjogIlllcC4gT21ha2FzZS4iLAogICAgICAgICJDT01NRU5UX0lEUyI6IFsgMSwgMiwgMyBdCiAgICAgIH0KICAgICAgYGBgCiAgICAgICAjIyBUd2Vha2luZyB0aGUgRGVmYXVsdCBKU09OCiAgICAgICBJZiB5b3UganVzdCB3YW50IHRvIGRvIHNvbWUgc21hbGwgdHdlYWtzIG9uIHRoZSBkZWZhdWx0IEpTT04sCiAgICAgIHlvdSBjYW4gY2FsbCBzdXBlciBmaXJzdCBhbmQgbWFrZSB0aGUgdHdlYWtzIG9uIHRoZSByZXR1cm5lZAogICAgICBKU09OLgogICAgICAgYGBgYXBwL3NlcmlhbGl6ZXJzL3Bvc3QuanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICAgZXhwb3J0IGRlZmF1bHQgRFMuUkVTVFNlcmlhbGl6ZXIuZXh0ZW5kKHsKICAgICAgICBzZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBqc29uID0gdGhpcy5fc3VwZXIoc25hcHNob3QsIG9wdGlvbnMpOwogICAgICAgICAgIGpzb24uc3ViamVjdCA9IGpzb24udGl0bGU7CiAgICAgICAgICBkZWxldGUganNvbi50aXRsZTsKICAgICAgICAgICByZXR1cm4ganNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBgYGAKICAgICAgIEBtZXRob2Qgc2VyaWFsaXplCiAgICAgIEBwYXJhbSB7RFMuU25hcHNob3R9IHNuYXBzaG90CiAgICAgIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICAgIEByZXR1cm4ge09iamVjdH0ganNvbgogICAgKi8KICAgIHNlcmlhbGl6ZShzbmFwc2hvdCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgIFlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kIHRvIGN1c3RvbWl6ZSB0aGUgcm9vdCBrZXlzIHNlcmlhbGl6ZWQgaW50byB0aGUgSlNPTi4KICAgICAgVGhlIGhhc2ggcHJvcGVydHkgc2hvdWxkIGJlIG1vZGlmaWVkIGJ5IHJlZmVyZW5jZSAocG9zc2libHkgdXNpbmcgc29tZXRoaW5nIGxpa2UgXy5leHRlbmQpCiAgICAgIEJ5IGRlZmF1bHQgdGhlIFJFU1QgU2VyaWFsaXplciBzZW5kcyB0aGUgbW9kZWxOYW1lIG9mIGEgbW9kZWwsIHdoaWNoIGlzIGEgY2FtZWxpemVkCiAgICAgIHZlcnNpb24gb2YgdGhlIG5hbWUuCiAgICAgICBGb3IgZXhhbXBsZSwgeW91ciBzZXJ2ZXIgbWF5IGV4cGVjdCB1bmRlcnNjb3JlZCByb290IG9iamVjdHMuCiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyBkZWNhbWVsaXplIH0gZnJvbSAnQGVtYmVyL3N0cmluZyc7CiAgICAgICBleHBvcnQgZGVmYXVsdCBEUy5SRVNUU2VyaWFsaXplci5leHRlbmQoewogICAgICAgIHNlcmlhbGl6ZUludG9IYXNoKGRhdGEsIHR5cGUsIHJlY29yZCwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHJvb3QgPSBkZWNhbWVsaXplKHR5cGUubW9kZWxOYW1lKTsKICAgICAgICAgIGRhdGFbcm9vdF0gPSB0aGlzLnNlcmlhbGl6ZShyZWNvcmQsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBzZXJpYWxpemVJbnRvSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gaGFzaAogICAgICBAcGFyYW0ge0RTLk1vZGVsfSB0eXBlQ2xhc3MKICAgICAgQHBhcmFtIHtEUy5TbmFwc2hvdH0gc25hcHNob3QKICAgICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICovCiAgICBzZXJpYWxpemVJbnRvSGFzaChoYXNoLCB0eXBlQ2xhc3MsIHNuYXBzaG90LCBvcHRpb25zKSB7CiAgICAgIHZhciBub3JtYWxpemVkUm9vdEtleSA9IHRoaXMucGF5bG9hZEtleUZyb21Nb2RlbE5hbWUodHlwZUNsYXNzLm1vZGVsTmFtZSk7CiAgICAgIGhhc2hbbm9ybWFsaXplZFJvb3RLZXldID0gdGhpcy5zZXJpYWxpemUoc25hcHNob3QsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvKioKICAgICAgWW91IGNhbiB1c2UgYHBheWxvYWRLZXlGcm9tTW9kZWxOYW1lYCB0byBvdmVycmlkZSB0aGUgcm9vdCBrZXkgZm9yIGFuIG91dGdvaW5nCiAgICAgIHJlcXVlc3QuIEJ5IGRlZmF1bHQsIHRoZSBSRVNUU2VyaWFsaXplciByZXR1cm5zIGEgY2FtZWxpemVkIHZlcnNpb24gb2YgdGhlCiAgICAgIG1vZGVsJ3MgbmFtZS4KICAgICAgIEZvciBhIG1vZGVsIGNhbGxlZCBUYWNvUGFydHksIGl0cyBgbW9kZWxOYW1lYCB3b3VsZCBiZSB0aGUgc3RyaW5nIGB0YWNvLXBhcnR5YC4gVGhlIFJFU1RTZXJpYWxpemVyCiAgICAgIHdpbGwgc2VuZCBpdCB0byB0aGUgc2VydmVyIHdpdGggYHRhY29QYXJ0eWAgYXMgdGhlIHJvb3Qga2V5IGluIHRoZSBKU09OIHBheWxvYWQ6CiAgICAgICBgYGBqcwogICAgICB7CiAgICAgICAgInRhY29QYXJ0eSI6IHsKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJsb2NhdGlvbiI6ICJNYXR0aGV3IEJlYWxlJ3MgSG91c2UiCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgRm9yIGV4YW1wbGUsIHlvdXIgc2VydmVyIG1heSBleHBlY3QgZGFzaGVyaXplZCByb290IG9iamVjdHM6CiAgICAgICBgYGBhcHAvc2VyaWFsaXplcnMvYXBwbGljYXRpb24uanMKICAgICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogICAgICBpbXBvcnQgeyBkYXNoZXJpemUgfSBmcm9tICdAZW1iZXIvc3RyaW5nJzsKICAgICAgIGV4cG9ydCBkZWZhdWx0IERTLlJFU1RTZXJpYWxpemVyLmV4dGVuZCh7CiAgICAgICAgcGF5bG9hZEtleUZyb21Nb2RlbE5hbWUobW9kZWxOYW1lKSB7CiAgICAgICAgICByZXR1cm4gZGFzaGVyaXplKG1vZGVsTmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYGBgCiAgICAgICBHaXZlbiBhIGBUYWNvUGFydHlgIG1vZGVsLCBjYWxsaW5nIGBzYXZlYCBvbiBpdCB3b3VsZCBwcm9kdWNlIGFuIG91dGdvaW5nCiAgICAgIHJlcXVlc3QgbGlrZToKICAgICAgIGBgYGpzCiAgICAgIHsKICAgICAgICAidGFjby1wYXJ0eSI6IHsKICAgICAgICAgICJpZCI6ICIxIiwKICAgICAgICAgICJsb2NhdGlvbiI6ICJNYXR0aGV3IEJlYWxlJ3MgSG91c2UiCiAgICAgICAgfQogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZQogICAgICBAcGFyYW0ge1N0cmluZ30gbW9kZWxOYW1lCiAgICAgIEByZXR1cm4ge1N0cmluZ30KICAgICovCiAgICBwYXlsb2FkS2V5RnJvbU1vZGVsTmFtZShtb2RlbE5hbWUpIHsKICAgICAgcmV0dXJuIEVtYmVyLlN0cmluZy5jYW1lbGl6ZShtb2RlbE5hbWUpOwogICAgfSwKCiAgICAvKioKICAgICAgWW91IGNhbiB1c2UgdGhpcyBtZXRob2QgdG8gY3VzdG9taXplIGhvdyBwb2x5bW9ycGhpYyBvYmplY3RzIGFyZSBzZXJpYWxpemVkLgogICAgICBCeSBkZWZhdWx0IHRoZSBSRVNUIFNlcmlhbGl6ZXIgY3JlYXRlcyB0aGUga2V5IGJ5IGFwcGVuZGluZyBgVHlwZWAgdG8KICAgICAgdGhlIGF0dHJpYnV0ZSBhbmQgdmFsdWUgZnJvbSB0aGUgbW9kZWwncyBjYW1lbGNhc2VkIG1vZGVsIG5hbWUuCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZVBvbHltb3JwaGljVHlwZQogICAgICBAcGFyYW0ge0RTLlNuYXBzaG90fSBzbmFwc2hvdAogICAgICBAcGFyYW0ge09iamVjdH0ganNvbgogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwCiAgICAqLwogICAgc2VyaWFsaXplUG9seW1vcnBoaWNUeXBlKHNuYXBzaG90LCBqc29uLCByZWxhdGlvbnNoaXApIHsKICAgICAgdmFyIGtleSA9IHJlbGF0aW9uc2hpcC5rZXk7CiAgICAgIHZhciB0eXBlS2V5ID0gdGhpcy5rZXlGb3JQb2x5bW9ycGhpY1R5cGUoa2V5LCByZWxhdGlvbnNoaXAudHlwZSwgJ3NlcmlhbGl6ZScpOwogICAgICB2YXIgYmVsb25nc1RvID0gc25hcHNob3QuYmVsb25nc1RvKGtleSk7CgogICAgICBpZiAoRW1iZXIuaXNOb25lKGJlbG9uZ3NUbykpIHsKICAgICAgICBqc29uW3R5cGVLZXldID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBqc29uW3R5cGVLZXldID0gRW1iZXIuU3RyaW5nLmNhbWVsaXplKGJlbG9uZ3NUby5tb2RlbE5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICBZb3UgY2FuIHVzZSB0aGlzIG1ldGhvZCB0byBjdXN0b21pemUgaG93IGEgcG9seW1vcnBoaWMgcmVsYXRpb25zaGlwIHNob3VsZAogICAgICBiZSBleHRyYWN0ZWQuCiAgICAgICBAbWV0aG9kIGV4dHJhY3RQb2x5bW9ycGhpY1JlbGF0aW9uc2hpcAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwVHlwZQogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwSGFzaAogICAgICBAcGFyYW0ge09iamVjdH0gcmVsYXRpb25zaGlwT3B0aW9ucwogICAgICBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIGV4dHJhY3RQb2x5bW9ycGhpY1JlbGF0aW9uc2hpcChyZWxhdGlvbnNoaXBUeXBlLCByZWxhdGlvbnNoaXBIYXNoLCByZWxhdGlvbnNoaXBPcHRpb25zKSB7CiAgICAgIHZhciB7IGtleSwgcmVzb3VyY2VIYXNoLCByZWxhdGlvbnNoaXBNZXRhIH0gPSByZWxhdGlvbnNoaXBPcHRpb25zOwoKICAgICAgLy8gQSBwb2x5bW9ycGhpYyBiZWxvbmdzVG8gcmVsYXRpb25zaGlwIGNhbiBiZSBwcmVzZW50IGluIHRoZSBwYXlsb2FkCiAgICAgIC8vIGVpdGhlciBpbiB0aGUgZm9ybSB3aGVyZSB0aGUgYGlkYCBhbmQgdGhlIGB0eXBlYCBhcmUgZ2l2ZW46CiAgICAgIC8vCiAgICAgIC8vICAgewogICAgICAvLyAgICAgbWVzc2FnZTogeyBpZDogMSwgdHlwZTogJ3Bvc3QnIH0KICAgICAgLy8gICB9CiAgICAgIC8vCiAgICAgIC8vIG9yIGJ5IHRoZSBgaWRgIGFuZCBhIGA8cmVsYXRpb25zaGlwPlR5cGVgIGF0dHJpYnV0ZToKICAgICAgLy8KICAgICAgLy8gICB7CiAgICAgIC8vICAgICBtZXNzYWdlOiAxLAogICAgICAvLyAgICAgbWVzc2FnZVR5cGU6ICdwb3N0JwogICAgICAvLyAgIH0KICAgICAgLy8KICAgICAgLy8gVGhlIG5leHQgY29kZSBjaGVja3MgaWYgdGhlIGxhdHRlciBjYXNlIGlzIHByZXNlbnQgYW5kIHJldHVybnMgdGhlCiAgICAgIC8vIGNvcnJlc3BvbmRpbmcgSlNPTi1BUEkgcmVwcmVzZW50YXRpb24uIFRoZSBmb3JtZXIgY2FzZSBpcyBoYW5kbGVkIHdpdGhpbgogICAgICAvLyB0aGUgYmFzZSBjbGFzcyBKU09OU2VyaWFsaXplci4KICAgICAgdmFyIGlzUG9seW1vcnBoaWMgPSByZWxhdGlvbnNoaXBNZXRhLm9wdGlvbnMucG9seW1vcnBoaWM7CiAgICAgIHZhciB0eXBlUHJvcGVydHkgPSB0aGlzLmtleUZvclBvbHltb3JwaGljVHlwZShrZXksIHJlbGF0aW9uc2hpcFR5cGUsICdkZXNlcmlhbGl6ZScpOwoKICAgICAgaWYgKGlzUG9seW1vcnBoaWMgJiYgcmVzb3VyY2VIYXNoW3R5cGVQcm9wZXJ0eV0gIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcmVsYXRpb25zaGlwSGFzaCAhPT0gJ29iamVjdCcpIHsKICAgICAgICB2YXIgdHlwZSA9IHRoaXMubW9kZWxOYW1lRnJvbVBheWxvYWRLZXkocmVzb3VyY2VIYXNoW3R5cGVQcm9wZXJ0eV0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpZDogcmVsYXRpb25zaGlwSGFzaCwKICAgICAgICAgIHR5cGU6IHR5cGUKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIH0KICB9KTsKCiAgaWYgKHRydWUpIHsKICAgIFJFU1RTZXJpYWxpemVyLnJlb3Blbih7CiAgICAgIHdhcm5NZXNzYWdlTm9Nb2RlbEZvcktleShwcm9wLCB0eXBlS2V5KSB7CiAgICAgICAgcmV0dXJuICdFbmNvdW50ZXJlZCAiJyArIHByb3AgKyAnIiBpbiBwYXlsb2FkLCBidXQgbm8gbW9kZWwgd2FzIGZvdW5kIGZvciBtb2RlbCBuYW1lICInICsgdHlwZUtleSArICciIChyZXNvbHZlZCBtb2RlbCBuYW1lIHVzaW5nICcgKyB0aGlzLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkgKyAnLm1vZGVsTmFtZUZyb21QYXlsb2FkS2V5KCInICsgcHJvcCArICciKSknOwogICAgICB9CiAgICB9KTsKICB9CgogIGV4cG9ydHMuZGVmYXVsdCA9IFJFU1RTZXJpYWxpemVyOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9zZXR1cC1jb250YWluZXInLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS8tcHJpdmF0ZScsICdlbWJlci1kYXRhL3NlcmlhbGl6ZXJzL2pzb24tYXBpJywgJ2VtYmVyLWRhdGEvc2VyaWFsaXplcnMvanNvbicsICdlbWJlci1kYXRhL3NlcmlhbGl6ZXJzL3Jlc3QnLCAnZW1iZXItZGF0YS9hZGFwdGVycy9qc29uLWFwaScsICdlbWJlci1kYXRhL2FkYXB0ZXJzL3Jlc3QnLCAnZW1iZXItZGF0YS90cmFuc2Zvcm1zL251bWJlcicsICdlbWJlci1kYXRhL3RyYW5zZm9ybXMvZGF0ZScsICdlbWJlci1kYXRhL3RyYW5zZm9ybXMvc3RyaW5nJywgJ2VtYmVyLWRhdGEvdHJhbnNmb3Jtcy9ib29sZWFuJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcHJpdmF0ZSwgX2pzb25BcGksIF9qc29uLCBfcmVzdCwgX2pzb25BcGkyLCBfcmVzdDIsIF9udW1iZXIsIF9kYXRlLCBfc3RyaW5nLCBfYm9vbGVhbikgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBzZXR1cENvbnRhaW5lcjsKCgogIGZ1bmN0aW9uIGhhcyhhcHBsaWNhdGlvbk9yUmVnaXN0cnksIGZ1bGxOYW1lKSB7CiAgICBpZiAoYXBwbGljYXRpb25PclJlZ2lzdHJ5LmhhcykgewogICAgICAvLyA8IDIuMS4wCiAgICAgIHJldHVybiBhcHBsaWNhdGlvbk9yUmVnaXN0cnkuaGFzKGZ1bGxOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIDIuMS4wKwogICAgICByZXR1cm4gYXBwbGljYXRpb25PclJlZ2lzdHJ5Lmhhc1JlZ2lzdHJhdGlvbihmdWxsTmFtZSk7CiAgICB9CiAgfQoKICAvKgogICBDb25maWd1cmVzIGEgcmVnaXN0cnkgZm9yIHVzZSB3aXRoIGFuIEVtYmVyLURhdGEKICAgc3RvcmUuIEFjY2VwdHMgYW4gb3B0aW9uYWwgbmFtZXNwYWNlIGFyZ3VtZW50LgogIAogICBAbWV0aG9kIGluaXRpYWxpemVTdG9yZQogICBAcGFyYW0ge0VtYmVyLlJlZ2lzdHJ5fSByZWdpc3RyeQogICAqLwogIGZ1bmN0aW9uIGluaXRpYWxpemVTdG9yZShyZWdpc3RyeSkgewogICAgdmFyIHJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUgPSByZWdpc3RyeS5yZWdpc3Rlck9wdGlvbnNGb3JUeXBlIHx8IHJlZ2lzdHJ5Lm9wdGlvbnNGb3JUeXBlOwogICAgcmVnaXN0ZXJPcHRpb25zRm9yVHlwZS5jYWxsKHJlZ2lzdHJ5LCAnc2VyaWFsaXplcicsIHsgc2luZ2xldG9uOiBmYWxzZSB9KTsKICAgIHJlZ2lzdGVyT3B0aW9uc0ZvclR5cGUuY2FsbChyZWdpc3RyeSwgJ2FkYXB0ZXInLCB7IHNpbmdsZXRvbjogZmFsc2UgfSk7CiAgICByZWdpc3RyeS5yZWdpc3Rlcignc2VyaWFsaXplcjotZGVmYXVsdCcsIF9qc29uLmRlZmF1bHQpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3NlcmlhbGl6ZXI6LXJlc3QnLCBfcmVzdC5kZWZhdWx0KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdhZGFwdGVyOi1yZXN0JywgX3Jlc3QyLmRlZmF1bHQpOwoKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdhZGFwdGVyOi1qc29uLWFwaScsIF9qc29uQXBpMi5kZWZhdWx0KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJpYWxpemVyOi1qc29uLWFwaScsIF9qc29uQXBpLmRlZmF1bHQpOwoKICAgIGlmICghaGFzKHJlZ2lzdHJ5LCAnc2VydmljZTpzdG9yZScpKSB7CiAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCdzZXJ2aWNlOnN0b3JlJywgX3ByaXZhdGUuU3RvcmUpOwogICAgfQogIH0KCiAgLyoKICAgQ29uZmlndXJlcyBhIHJlZ2lzdHJ5IHdpdGggaW5qZWN0aW9ucyBvbiBFbWJlciBhcHBsaWNhdGlvbnMKICAgZm9yIHRoZSBFbWJlci1EYXRhIHN0b3JlLiBBY2NlcHRzIGFuIG9wdGlvbmFsIG5hbWVzcGFjZSBhcmd1bWVudC4KICAKICAgQG1ldGhvZCBpbml0aWFsaXplRGVidWdBZGFwdGVyCiAgIEBwYXJhbSB7RW1iZXIuUmVnaXN0cnl9IHJlZ2lzdHJ5CiAgICovCiAgZnVuY3Rpb24gaW5pdGlhbGl6ZURhdGFBZGFwdGVyKHJlZ2lzdHJ5KSB7CiAgICByZWdpc3RyeS5yZWdpc3RlcignZGF0YS1hZGFwdGVyOm1haW4nLCBfcHJpdmF0ZS5EZWJ1Z0FkYXB0ZXIpOwogIH0KCiAgLyoKICAgQ29uZmlndXJlcyBhIHJlZ2lzdHJ5IHdpdGggaW5qZWN0aW9ucyBvbiBFbWJlciBhcHBsaWNhdGlvbnMKICAgZm9yIHRoZSBFbWJlci1EYXRhIHN0b3JlLiBBY2NlcHRzIGFuIG9wdGlvbmFsIG5hbWVzcGFjZSBhcmd1bWVudC4KICAKICAgQG1ldGhvZCBpbml0aWFsaXplU3RvcmVJbmplY3Rpb25zCiAgIEBwYXJhbSB7RW1iZXIuUmVnaXN0cnl9IHJlZ2lzdHJ5CiAgICovCiAgZnVuY3Rpb24gaW5pdGlhbGl6ZVN0b3JlSW5qZWN0aW9ucyhyZWdpc3RyeSkgewogICAgLy8gcmVnaXN0cnkuaW5qZWN0aW9uIGZvciBFbWJlciA8IDIuMS4wCiAgICAvLyBhcHBsaWNhdGlvbi5pbmplY3QgZm9yIEVtYmVyIDIuMS4wKwogICAgdmFyIGluamVjdCA9IHJlZ2lzdHJ5LmluamVjdCB8fCByZWdpc3RyeS5pbmplY3Rpb247CiAgICBpbmplY3QuY2FsbChyZWdpc3RyeSwgJ2NvbnRyb2xsZXInLCAnc3RvcmUnLCAnc2VydmljZTpzdG9yZScpOwogICAgaW5qZWN0LmNhbGwocmVnaXN0cnksICdyb3V0ZScsICdzdG9yZScsICdzZXJ2aWNlOnN0b3JlJyk7CiAgICBpbmplY3QuY2FsbChyZWdpc3RyeSwgJ2RhdGEtYWRhcHRlcicsICdzdG9yZScsICdzZXJ2aWNlOnN0b3JlJyk7CiAgfQoKICAvKgogICBDb25maWd1cmVzIGEgcmVnaXN0cnkgZm9yIHVzZSB3aXRoIEVtYmVyLURhdGEKICAgdHJhbnNmb3Jtcy4KICAKICAgQG1ldGhvZCBpbml0aWFsaXplVHJhbnNmb3JtcwogICBAcGFyYW0ge0VtYmVyLlJlZ2lzdHJ5fSByZWdpc3RyeQogICAqLwogIGZ1bmN0aW9uIGluaXRpYWxpemVUcmFuc2Zvcm1zKHJlZ2lzdHJ5KSB7CiAgICByZWdpc3RyeS5yZWdpc3RlcigndHJhbnNmb3JtOmJvb2xlYW4nLCBfYm9vbGVhbi5kZWZhdWx0KTsKICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKCd0cmFuc2Zvcm06ZGF0ZScsIF9kYXRlLmRlZmF1bHQpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3RyYW5zZm9ybTpudW1iZXInLCBfbnVtYmVyLmRlZmF1bHQpOwogICAgcmVnaXN0cnkucmVnaXN0ZXIoJ3RyYW5zZm9ybTpzdHJpbmcnLCBfc3RyaW5nLmRlZmF1bHQpOwogIH0KCiAgZnVuY3Rpb24gc2V0dXBDb250YWluZXIoYXBwbGljYXRpb24pIHsKICAgIGluaXRpYWxpemVEYXRhQWRhcHRlcihhcHBsaWNhdGlvbik7CiAgICBpbml0aWFsaXplVHJhbnNmb3JtcyhhcHBsaWNhdGlvbik7CiAgICBpbml0aWFsaXplU3RvcmVJbmplY3Rpb25zKGFwcGxpY2F0aW9uKTsKICAgIGluaXRpYWxpemVTdG9yZShhcHBsaWNhdGlvbik7CiAgfQp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS9zdG9yZScsIFsnZXhwb3J0cycsICdlbWJlci1kYXRhLy1wcml2YXRlJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfcHJpdmF0ZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2RlZmF1bHQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfcHJpdmF0ZS5TdG9yZTsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvdHJhbnNmb3JtJywgWydleHBvcnRzJywgJ2VtYmVyLWRhdGEvdHJhbnNmb3Jtcy90cmFuc2Zvcm0nXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF90cmFuc2Zvcm0pIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdkZWZhdWx0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX3RyYW5zZm9ybS5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS90cmFuc2Zvcm1zL2Jvb2xlYW4nLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS90cmFuc2Zvcm1zL3RyYW5zZm9ybSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3RyYW5zZm9ybSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBfdHJhbnNmb3JtLmRlZmF1bHQuZXh0ZW5kKHsKICAgIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWQsIG9wdGlvbnMpIHsKICAgICAgaWYgKEVtYmVyLmlzTm9uZShzZXJpYWxpemVkKSAmJiBvcHRpb25zLmFsbG93TnVsbCA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBzZXJpYWxpemVkOwogICAgICBpZiAodHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICByZXR1cm4gKC9eKHRydWV8dHwxKSQvaS50ZXN0KHNlcmlhbGl6ZWQpCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiBzZXJpYWxpemVkID09PSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKCiAgICBzZXJpYWxpemUoZGVzZXJpYWxpemVkLCBvcHRpb25zKSB7CiAgICAgIGlmIChFbWJlci5pc05vbmUoZGVzZXJpYWxpemVkKSAmJiBvcHRpb25zLmFsbG93TnVsbCA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gQm9vbGVhbihkZXNlcmlhbGl6ZWQpOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS90cmFuc2Zvcm1zL2RhdGUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS90cmFuc2Zvcm1zL3RyYW5zZm9ybSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3RyYW5zZm9ybSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBfdHJhbnNmb3JtLmRlZmF1bHQuZXh0ZW5kKHsKICAgIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWQpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2Ygc2VyaWFsaXplZDsKCiAgICAgIGlmICh0eXBlID09PSAic3RyaW5nIikgewogICAgICAgIHZhciBvZmZzZXQgPSBzZXJpYWxpemVkLmluZGV4T2YoJysnKTsKCiAgICAgICAgaWYgKG9mZnNldCAhPT0gLTEgJiYgc2VyaWFsaXplZC5sZW5ndGggLSA1ID09PSBvZmZzZXQpIHsKICAgICAgICAgIG9mZnNldCArPSAzOwogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHNlcmlhbGl6ZWQuc2xpY2UoMCwgb2Zmc2V0KSArICc6JyArIHNlcmlhbGl6ZWQuc2xpY2Uob2Zmc2V0KSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgRGF0ZShzZXJpYWxpemVkKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiBuZXcgRGF0ZShzZXJpYWxpemVkKTsKICAgICAgfSBlbHNlIGlmIChzZXJpYWxpemVkID09PSBudWxsIHx8IHNlcmlhbGl6ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIGlmIHRoZSB2YWx1ZSBpcyBudWxsIHJldHVybiBudWxsCiAgICAgICAgLy8gaWYgdGhlIHZhbHVlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBkYXRhIHJldHVybiB1bmRlZmluZWQKICAgICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSwKCiAgICBzZXJpYWxpemUoZGF0ZSkgewogICAgICBpZiAoZGF0ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKGRhdGUpKSB7CiAgICAgICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItZGF0YS90cmFuc2Zvcm1zL251bWJlcicsIFsnZXhwb3J0cycsICdlbWJlci1kYXRhL3RyYW5zZm9ybXMvdHJhbnNmb3JtJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfdHJhbnNmb3JtKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdmFsdWUgJiYgdmFsdWUgIT09IEluZmluaXR5ICYmIHZhbHVlICE9PSAtSW5maW5pdHk7CiAgfQoKICAvKioKICAgIFRoZSBgRFMuTnVtYmVyVHJhbnNmb3JtYCBjbGFzcyBpcyB1c2VkIHRvIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUKICAgIG51bWVyaWMgYXR0cmlidXRlcyBvbiBFbWJlciBEYXRhIHJlY29yZCBvYmplY3RzLiBUaGlzIHRyYW5zZm9ybSBpcwogICAgdXNlZCB3aGVuIGBudW1iZXJgIGlzIHBhc3NlZCBhcyB0aGUgdHlwZSBwYXJhbWV0ZXIgdG8gdGhlCiAgICBbRFMuYXR0cl0oLi4vLi4vZGF0YSNtZXRob2RfYXR0cikgZnVuY3Rpb24uCiAgCiAgICBVc2FnZQogIAogICAgYGBgYXBwL21vZGVscy9zY29yZS5qcwogICAgaW1wb3J0IERTIGZyb20gJ2VtYmVyLWRhdGEnOwogIAogICAgZXhwb3J0IGRlZmF1bHQgRFMuTW9kZWwuZXh0ZW5kKHsKICAgICAgdmFsdWU6IERTLmF0dHIoJ251bWJlcicpLAogICAgICBwbGF5ZXI6IERTLmJlbG9uZ3NUbygncGxheWVyJyksCiAgICAgIGRhdGU6IERTLmF0dHIoJ2RhdGUnKQogICAgfSk7CiAgICBgYGAKICAKICAgIEBjbGFzcyBOdW1iZXJUcmFuc2Zvcm0KICAgIEBleHRlbmRzIERTLlRyYW5zZm9ybQogICAgQG5hbWVzcGFjZSBEUwogICAqLwogIGV4cG9ydHMuZGVmYXVsdCA9IF90cmFuc2Zvcm0uZGVmYXVsdC5leHRlbmQoewogICAgZGVzZXJpYWxpemUoc2VyaWFsaXplZCkgewogICAgICB2YXIgdHJhbnNmb3JtZWQgPSB2b2lkIDA7CgogICAgICBpZiAoc2VyaWFsaXplZCA9PT0gJycgfHwgc2VyaWFsaXplZCA9PT0gbnVsbCB8fCBzZXJpYWxpemVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0cmFuc2Zvcm1lZCA9IE51bWJlcihzZXJpYWxpemVkKTsKCiAgICAgICAgcmV0dXJuIGlzTnVtYmVyKHRyYW5zZm9ybWVkKSA/IHRyYW5zZm9ybWVkIDogbnVsbDsKICAgICAgfQogICAgfSwKCiAgICBzZXJpYWxpemUoZGVzZXJpYWxpemVkKSB7CiAgICAgIHZhciB0cmFuc2Zvcm1lZCA9IHZvaWQgMDsKCiAgICAgIGlmIChkZXNlcmlhbGl6ZWQgPT09ICcnIHx8IGRlc2VyaWFsaXplZCA9PT0gbnVsbCB8fCBkZXNlcmlhbGl6ZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHRyYW5zZm9ybWVkID0gTnVtYmVyKGRlc2VyaWFsaXplZCk7CgogICAgICAgIHJldHVybiBpc051bWJlcih0cmFuc2Zvcm1lZCkgPyB0cmFuc2Zvcm1lZCA6IG51bGw7CiAgICAgIH0KICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLWRhdGEvdHJhbnNmb3Jtcy9zdHJpbmcnLCBbJ2V4cG9ydHMnLCAnZW1iZXItZGF0YS90cmFuc2Zvcm1zL3RyYW5zZm9ybSddLCBmdW5jdGlvbiAoZXhwb3J0cywgX3RyYW5zZm9ybSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBfdHJhbnNmb3JtLmRlZmF1bHQuZXh0ZW5kKHsKICAgIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWQpIHsKICAgICAgcmV0dXJuIEVtYmVyLmlzTm9uZShzZXJpYWxpemVkKSA/IG51bGwgOiBTdHJpbmcoc2VyaWFsaXplZCk7CiAgICB9LAogICAgc2VyaWFsaXplKGRlc2VyaWFsaXplZCkgewogICAgICByZXR1cm4gRW1iZXIuaXNOb25lKGRlc2VyaWFsaXplZCkgPyBudWxsIDogU3RyaW5nKGRlc2VyaWFsaXplZCk7CiAgICB9CiAgfSk7Cn0pOwo7ZGVmaW5lKCdlbWJlci1kYXRhL3RyYW5zZm9ybXMvdHJhbnNmb3JtJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IEVtYmVyLk9iamVjdC5leHRlbmQoewogICAgLyoqCiAgICAgIFdoZW4gZ2l2ZW4gYSBkZXNlcmlhbGl6ZWQgdmFsdWUgZnJvbSBhIHJlY29yZCBhdHRyaWJ1dGUgdGhpcwogICAgICBtZXRob2QgbXVzdCByZXR1cm4gdGhlIHNlcmlhbGl6ZWQgdmFsdWUuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICdAZW1iZXIvdXRpbHMnOwogICAgICAgc2VyaWFsaXplKGRlc2VyaWFsaXplZCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBpc0VtcHR5KGRlc2VyaWFsaXplZCkgPyBudWxsIDogTnVtYmVyKGRlc2VyaWFsaXplZCk7CiAgICAgIH0KICAgICAgYGBgCiAgICAgICBAbWV0aG9kIHNlcmlhbGl6ZQogICAgICBAcGFyYW0gZGVzZXJpYWxpemVkIFRoZSBkZXNlcmlhbGl6ZWQgdmFsdWUKICAgICAgQHBhcmFtIG9wdGlvbnMgaGFzaCBvZiBvcHRpb25zIHBhc3NlZCB0byBgRFMuYXR0cmAKICAgICAgQHJldHVybiBUaGUgc2VyaWFsaXplZCB2YWx1ZQogICAgKi8KICAgIHNlcmlhbGl6ZTogbnVsbCwKCiAgICAvKioKICAgICAgV2hlbiBnaXZlbiBhIHNlcmlhbGl6ZSB2YWx1ZSBmcm9tIGEgSlNPTiBvYmplY3QgdGhpcyBtZXRob2QgbXVzdAogICAgICByZXR1cm4gdGhlIGRlc2VyaWFsaXplZCB2YWx1ZSBmb3IgdGhlIHJlY29yZCBhdHRyaWJ1dGUuCiAgICAgICBFeGFtcGxlCiAgICAgICBgYGBqYXZhc2NyaXB0CiAgICAgIGRlc2VyaWFsaXplKHNlcmlhbGl6ZWQsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gZW1wdHkoc2VyaWFsaXplZCkgPyBudWxsIDogTnVtYmVyKHNlcmlhbGl6ZWQpOwogICAgICB9CiAgICAgIGBgYAogICAgICAgQG1ldGhvZCBkZXNlcmlhbGl6ZQogICAgICBAcGFyYW0gc2VyaWFsaXplZCBUaGUgc2VyaWFsaXplZCB2YWx1ZQogICAgICBAcGFyYW0gb3B0aW9ucyBoYXNoIG9mIG9wdGlvbnMgcGFzc2VkIHRvIGBEUy5hdHRyYAogICAgICBAcmV0dXJuIFRoZSBkZXNlcmlhbGl6ZWQgdmFsdWUKICAgICovCiAgICBkZXNlcmlhbGl6ZTogbnVsbAogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItZGF0YS92ZXJzaW9uIiwgWyJleHBvcnRzIl0sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9ICIzLjMuMSI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0nLCAnZW1iZXItaW5mbGVjdG9yL2xpYi9leHQvc3RyaW5nJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfc3lzdGVtKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdFJ1bGVzID0gZXhwb3J0cy5zaW5ndWxhcml6ZSA9IGV4cG9ydHMucGx1cmFsaXplID0gdW5kZWZpbmVkOwoKCiAgX3N5c3RlbS5JbmZsZWN0b3IuZGVmYXVsdFJ1bGVzID0gX3N5c3RlbS5kZWZhdWx0UnVsZXM7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlciwgJ0luZmxlY3RvcicsIHsKICAgIGdldCgpIHsKICAgICAgRW1iZXIuZGVwcmVjYXRlKGBFbWJlci5JbmZsZWN0b3IgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIGV4cGxpY2l0bHk6IGltcG9ydCBJbmZsZWN0b3IgZnJvbSAnZW1iZXItaW5mbGVjdG9yJztgLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItaW5mbGVjdG9yLmdsb2JhbHMnLAogICAgICAgIHVudGlsOiAnMy4wLjAnCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIF9zeXN0ZW0uSW5mbGVjdG9yOwogICAgfQogIH0pOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRW1iZXIuU3RyaW5nLCAnc2luZ3VsYXJpemUnLCB7CiAgICBnZXQoKSB7CiAgICAgIEVtYmVyLmRlcHJlY2F0ZShgRW1iZXIuU3RyaW5nLnNpbmd1bGFyaXplKCkgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIGV4cGxpY2l0bHk6IGltcG9ydCB7IHNpbmd1bGFyaXplIH0gZnJvbSAnZW1iZXItaW5mbGVjdG9yJztgLCBmYWxzZSwgewogICAgICAgIGlkOiAnZW1iZXItaW5mbGVjdG9yLmdsb2JhbHMnLAogICAgICAgIHVudGlsOiAnMy4wLjAnCiAgICAgIH0pOwoKICAgICAgcmV0dXJuIF9zeXN0ZW0uc2luZ3VsYXJpemU7CiAgICB9CiAgfSk7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbWJlci5TdHJpbmcsICdwbHVyYWxpemUnLCB7CiAgICBnZXQoKSB7CiAgICAgIEVtYmVyLmRlcHJlY2F0ZShgRW1iZXIuU3RyaW5nLnBsdXJhbGl6ZSgpIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSBleHBsaWNpdGx5OiBpbXBvcnQgeyBwbHVyYWxpemUgfSBmcm9tICdlbWJlci1pbmZsZWN0b3InO2AsIGZhbHNlLCB7CiAgICAgICAgaWQ6ICdlbWJlci1pbmZsZWN0b3IuZ2xvYmFscycsCiAgICAgICAgdW50aWw6ICczLjAuMCcKICAgICAgfSk7CgogICAgICByZXR1cm4gX3N5c3RlbS5wbHVyYWxpemU7CiAgICB9CiAgfSk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IF9zeXN0ZW0uSW5mbGVjdG9yOwogIGV4cG9ydHMucGx1cmFsaXplID0gX3N5c3RlbS5wbHVyYWxpemU7CiAgZXhwb3J0cy5zaW5ndWxhcml6ZSA9IF9zeXN0ZW0uc2luZ3VsYXJpemU7CiAgZXhwb3J0cy5kZWZhdWx0UnVsZXMgPSBfc3lzdGVtLmRlZmF1bHRSdWxlczsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvZXh0L3N0cmluZycsIFsnZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vc3RyaW5nJ10sIGZ1bmN0aW9uIChfc3RyaW5nKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBpZiAoRW1iZXIuRU5WLkVYVEVORF9QUk9UT1RZUEVTID09PSB0cnVlIHx8IEVtYmVyLkVOVi5FWFRFTkRfUFJPVE9UWVBFUy5TdHJpbmcpIHsKICAgIC8qKgogICAgICBTZWUge3sjY3Jvc3NMaW5rICJFbWJlci5TdHJpbmcvcGx1cmFsaXplIn19e3svY3Jvc3NMaW5rfX0KICAgICAgIEBtZXRob2QgcGx1cmFsaXplCiAgICAgIEBmb3IgU3RyaW5nCiAgICAqLwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFN0cmluZy5wcm90b3R5cGUsICdwbHVyYWxpemUnLCB7CiAgICAgIGdldCgpIHsKICAgICAgICBFbWJlci5kZXByZWNhdGUoYFN0cmluZy5wcm90b3R5cGUucGx1cmFsaXplKCkgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIGV4cGxpY2l0bHk6IGltcG9ydCB7IHBsdXJhbGl6ZSB9IGZyb20gJ2VtYmVyLWluZmxlY3Rvcic7YCwgZmFsc2UsIHsKICAgICAgICAgIGlkOiAnZW1iZXItaW5mbGVjdG9yLmdsb2JhbHMnLAogICAgICAgICAgdW50aWw6ICczLjAuMCcKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAoMCwgX3N0cmluZy5wbHVyYWxpemUpKHRoaXMpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwoKICAgIC8qKgogICAgICBTZWUge3sjY3Jvc3NMaW5rICJFbWJlci5TdHJpbmcvc2luZ3VsYXJpemUifX17ey9jcm9zc0xpbmt9fQogICAgICAgQG1ldGhvZCBzaW5ndWxhcml6ZQogICAgICBAZm9yIFN0cmluZwogICAgKi8KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShTdHJpbmcucHJvdG90eXBlLCAnc2luZ3VsYXJpemUnLCB7CiAgICAgIGdldCgpIHsKICAgICAgICBFbWJlci5kZXByZWNhdGUoYFN0cmluZy5wcm90b3R5cGUuc2luZ3VsYXJpemUoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgZXhwbGljaXRseTogaW1wb3J0IHsgc2luZ3VsYXJpemUgfSBmcm9tICdlbWJlci1pbmZsZWN0b3InO2AsIGZhbHNlLCB7CiAgICAgICAgICBpZDogJ2VtYmVyLWluZmxlY3Rvci5nbG9iYWxzJywKICAgICAgICAgIHVudGlsOiAnMy4wLjAnCiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gKDAsIF9zdHJpbmcuc2luZ3VsYXJpemUpKHRoaXMpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvaGVscGVycy9wbHVyYWxpemUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItaW5mbGVjdG9yJywgJ2VtYmVyLWluZmxlY3Rvci9saWIvdXRpbHMvbWFrZS1oZWxwZXInXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckluZmxlY3RvciwgX21ha2VIZWxwZXIpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gKDAsIF9tYWtlSGVscGVyLmRlZmF1bHQpKGZ1bmN0aW9uIChwYXJhbXMsIGhhc2gpIHsKICAgIGxldCBmdWxsUGFyYW1zID0gbmV3IEFycmF5KC4uLnBhcmFtcyk7CgogICAgaWYgKGZ1bGxQYXJhbXMubGVuZ3RoID09PSAyKSB7CiAgICAgIGZ1bGxQYXJhbXMucHVzaCh7IHdpdGhvdXRDb3VudDogaGFzaFsid2l0aG91dC1jb3VudCJdIH0pOwogICAgfQoKICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnBsdXJhbGl6ZSkoLi4uZnVsbFBhcmFtcyk7CiAgfSk7Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvbGliL2hlbHBlcnMvc2luZ3VsYXJpemUnLCBbJ2V4cG9ydHMnLCAnZW1iZXItaW5mbGVjdG9yJywgJ2VtYmVyLWluZmxlY3Rvci9saWIvdXRpbHMvbWFrZS1oZWxwZXInXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9lbWJlckluZmxlY3RvciwgX21ha2VIZWxwZXIpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gKDAsIF9tYWtlSGVscGVyLmRlZmF1bHQpKGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHJldHVybiAoMCwgX2VtYmVySW5mbGVjdG9yLnNpbmd1bGFyaXplKShwYXJhbXNbMF0pOwogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0iLCBbImV4cG9ydHMiLCAiZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vaW5mbGVjdG9yIiwgImVtYmVyLWluZmxlY3Rvci9saWIvc3lzdGVtL3N0cmluZyIsICJlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9pbmZsZWN0aW9ucyJdLCBmdW5jdGlvbiAoZXhwb3J0cywgX2luZmxlY3RvciwgX3N0cmluZywgX2luZmxlY3Rpb25zKSB7CiAgInVzZSBzdHJpY3QiOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdFJ1bGVzID0gZXhwb3J0cy5wbHVyYWxpemUgPSBleHBvcnRzLnNpbmd1bGFyaXplID0gZXhwb3J0cy5JbmZsZWN0b3IgPSB1bmRlZmluZWQ7CgoKICBfaW5mbGVjdG9yLmRlZmF1bHQuaW5mbGVjdG9yID0gbmV3IF9pbmZsZWN0b3IuZGVmYXVsdChfaW5mbGVjdGlvbnMuZGVmYXVsdCk7CgogIGV4cG9ydHMuSW5mbGVjdG9yID0gX2luZmxlY3Rvci5kZWZhdWx0OwogIGV4cG9ydHMuc2luZ3VsYXJpemUgPSBfc3RyaW5nLnNpbmd1bGFyaXplOwogIGV4cG9ydHMucGx1cmFsaXplID0gX3N0cmluZy5wbHVyYWxpemU7CiAgZXhwb3J0cy5kZWZhdWx0UnVsZXMgPSBfaW5mbGVjdGlvbnMuZGVmYXVsdDsKfSk7CjtkZWZpbmUoJ2VtYmVyLWluZmxlY3Rvci9saWIvc3lzdGVtL2luZmxlY3Rpb25zJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHsKICAgIHBsdXJhbHM6IFtbLyQvLCAncyddLCBbL3MkL2ksICdzJ10sIFsvXihheHx0ZXN0KWlzJC9pLCAnJDFlcyddLCBbLyhvY3RvcHx2aXIpdXMkL2ksICckMWknXSwgWy8ob2N0b3B8dmlyKWkkL2ksICckMWknXSwgWy8oYWxpYXN8c3RhdHVzfGJvbnVzKSQvaSwgJyQxZXMnXSwgWy8oYnUpcyQvaSwgJyQxc2VzJ10sIFsvKGJ1ZmZhbHx0b21hdClvJC9pLCAnJDFvZXMnXSwgWy8oW3RpXSl1bSQvaSwgJyQxYSddLCBbLyhbdGldKWEkL2ksICckMWEnXSwgWy9zaXMkL2ksICdzZXMnXSwgWy8oPzooW15mXSlmZXwoW2xyXSlmKSQvaSwgJyQxJDJ2ZXMnXSwgWy8oaGl2ZSkkL2ksICckMXMnXSwgWy8oW15hZWlvdXldfHF1KXkkL2ksICckMWllcyddLCBbLyh4fGNofHNzfHNoKSQvaSwgJyQxZXMnXSwgWy8obWF0cnx2ZXJ0fGluZCkoPzppeHxleCkkL2ksICckMWljZXMnXSwgWy9eKG18bClvdXNlJC9pLCAnJDFpY2UnXSwgWy9eKG18bClpY2UkL2ksICckMWljZSddLCBbL14ob3gpJC9pLCAnJDFlbiddLCBbL14ob3hlbikkL2ksICckMSddLCBbLyhxdWl6KSQvaSwgJyQxemVzJ11dLAoKICAgIHNpbmd1bGFyOiBbWy9zJC9pLCAnJ10sIFsvKHNzKSQvaSwgJyQxJ10sIFsvKG4pZXdzJC9pLCAnJDFld3MnXSwgWy8oW3RpXSlhJC9pLCAnJDF1bSddLCBbLygoYSluYWx5fChiKWF8KGQpaWFnbm98KHApYXJlbnRoZXwocClyb2dub3wocyl5bm9wfCh0KWhlKShzaXN8c2VzKSQvaSwgJyQxc2lzJ10sIFsvKF5hbmFseSkoc2lzfHNlcykkL2ksICckMXNpcyddLCBbLyhbXmZdKXZlcyQvaSwgJyQxZmUnXSwgWy8oaGl2ZSlzJC9pLCAnJDEnXSwgWy8odGl2ZSlzJC9pLCAnJDEnXSwgWy8oW2xyXSl2ZXMkL2ksICckMWYnXSwgWy8oW15hZWlvdXldfHF1KWllcyQvaSwgJyQxeSddLCBbLyhzKWVyaWVzJC9pLCAnJDFlcmllcyddLCBbLyhtKW92aWVzJC9pLCAnJDFvdmllJ10sIFsvKHh8Y2h8c3N8c2gpZXMkL2ksICckMSddLCBbL14obXxsKWljZSQvaSwgJyQxb3VzZSddLCBbLyhidXMpKGVzKT8kL2ksICckMSddLCBbLyhvKWVzJC9pLCAnJDEnXSwgWy8oc2hvZSlzJC9pLCAnJDEnXSwgWy8oY3Jpc3x0ZXN0KShpc3xlcykkL2ksICckMWlzJ10sIFsvXihhKXhbaWVdcyQvaSwgJyQxeGlzJ10sIFsvKG9jdG9wfHZpcikodXN8aSkkL2ksICckMXVzJ10sIFsvKGFsaWFzfHN0YXR1c3xib251cykoZXMpPyQvaSwgJyQxJ10sIFsvXihveCllbi9pLCAnJDEnXSwgWy8odmVydHxpbmQpaWNlcyQvaSwgJyQxZXgnXSwgWy8obWF0cilpY2VzJC9pLCAnJDFpeCddLCBbLyhxdWl6KXplcyQvaSwgJyQxJ10sIFsvKGRhdGFiYXNlKXMkL2ksICckMSddXSwKCiAgICBpcnJlZ3VsYXJQYWlyczogW1sncGVyc29uJywgJ3Blb3BsZSddLCBbJ21hbicsICdtZW4nXSwgWydjaGlsZCcsICdjaGlsZHJlbiddLCBbJ3NleCcsICdzZXhlcyddLCBbJ21vdmUnLCAnbW92ZXMnXSwgWydjb3cnLCAna2luZSddLCBbJ3pvbWJpZScsICd6b21iaWVzJ11dLAoKICAgIHVuY291bnRhYmxlOiBbJ2VxdWlwbWVudCcsICdpbmZvcm1hdGlvbicsICdyaWNlJywgJ21vbmV5JywgJ3NwZWNpZXMnLCAnc2VyaWVzJywgJ2Zpc2gnLCAnc2hlZXAnLCAnamVhbnMnLCAncG9saWNlJ10KICB9Owp9KTsKO2RlZmluZSgnZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vaW5mbGVjdG9yJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKCiAgdmFyIGNhcGl0YWxpemUgPSBFbWJlci5TdHJpbmcuY2FwaXRhbGl6ZTsKCiAgdmFyIEJMQU5LX1JFR0VYID0gL15ccyokLzsKICB2YXIgTEFTVF9XT1JEX0RBU0hFRF9SRUdFWCA9IC8oW1x3Ly1dK1tfL1xzLV0pKFthLXpcZF0rJCkvOwogIHZhciBMQVNUX1dPUkRfQ0FNRUxJWkVEX1JFR0VYID0gLyhbXHcvXHMtXSspKFtBLVpdW2EtelxkXSokKS87CiAgdmFyIENBTUVMSVpFRF9SRUdFWCA9IC9bQS1aXVthLXpcZF0qJC87CgogIGZ1bmN0aW9uIGxvYWRVbmNvdW50YWJsZShydWxlcywgdW5jb3VudGFibGUpIHsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSB1bmNvdW50YWJsZS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBydWxlcy51bmNvdW50YWJsZVt1bmNvdW50YWJsZVtpXS50b0xvd2VyQ2FzZSgpXSA9IHRydWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBsb2FkSXJyZWd1bGFyKHJ1bGVzLCBpcnJlZ3VsYXJQYWlycykgewogICAgdmFyIHBhaXI7CgogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGlycmVndWxhclBhaXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHBhaXIgPSBpcnJlZ3VsYXJQYWlyc1tpXTsKCiAgICAgIC8vcGx1cmFsaXppbmcKICAgICAgcnVsZXMuaXJyZWd1bGFyW3BhaXJbMF0udG9Mb3dlckNhc2UoKV0gPSBwYWlyWzFdOwogICAgICBydWxlcy5pcnJlZ3VsYXJbcGFpclsxXS50b0xvd2VyQ2FzZSgpXSA9IHBhaXJbMV07CgogICAgICAvL3Npbmd1bGFyaXppbmcKICAgICAgcnVsZXMuaXJyZWd1bGFySW52ZXJzZVtwYWlyWzFdLnRvTG93ZXJDYXNlKCldID0gcGFpclswXTsKICAgICAgcnVsZXMuaXJyZWd1bGFySW52ZXJzZVtwYWlyWzBdLnRvTG93ZXJDYXNlKCldID0gcGFpclswXTsKICAgIH0KICB9CgogIC8qKgogICAgSW5mbGVjdG9yLkVtYmVyIHByb3ZpZGVzIGEgbWVjaGFuaXNtIGZvciBzdXBwbHlpbmcgaW5mbGVjdGlvbiBydWxlcyBmb3IgeW91cgogICAgYXBwbGljYXRpb24uIEVtYmVyIGluY2x1ZGVzIGEgZGVmYXVsdCBzZXQgb2YgaW5mbGVjdGlvbiBydWxlcywgYW5kIHByb3ZpZGVzIGFuCiAgICBBUEkgZm9yIHByb3ZpZGluZyBhZGRpdGlvbmFsIHJ1bGVzLgogIAogICAgRXhhbXBsZXM6CiAgCiAgICBDcmVhdGluZyBhbiBpbmZsZWN0b3Igd2l0aCBubyBydWxlcy4KICAKICAgIGBgYGpzCiAgICB2YXIgaW5mbGVjdG9yID0gbmV3IEVtYmVyLkluZmxlY3RvcigpOwogICAgYGBgCiAgCiAgICBDcmVhdGluZyBhbiBpbmZsZWN0b3Igd2l0aCB0aGUgZGVmYXVsdCBlbWJlciBydWxlc2V0LgogIAogICAgYGBganMKICAgIHZhciBpbmZsZWN0b3IgPSBuZXcgRW1iZXIuSW5mbGVjdG9yKEVtYmVyLkluZmxlY3Rvci5kZWZhdWx0UnVsZXMpOwogIAogICAgaW5mbGVjdG9yLnBsdXJhbGl6ZSgnY293Jyk7IC8vPT4gJ2tpbmUnCiAgICBpbmZsZWN0b3Iuc2luZ3VsYXJpemUoJ2tpbmUnKTsgLy89PiAnY293JwogICAgYGBgCiAgCiAgICBDcmVhdGluZyBhbiBpbmZsZWN0b3IgYW5kIGFkZGluZyBydWxlcyBsYXRlci4KICAKICAgIGBgYGphdmFzY3JpcHQKICAgIHZhciBpbmZsZWN0b3IgPSBFbWJlci5JbmZsZWN0b3IuaW5mbGVjdG9yOwogIAogICAgaW5mbGVjdG9yLnBsdXJhbGl6ZSgnYWR2aWNlJyk7IC8vID0+ICdhZHZpY2VzJwogICAgaW5mbGVjdG9yLnVuY291bnRhYmxlKCdhZHZpY2UnKTsKICAgIGluZmxlY3Rvci5wbHVyYWxpemUoJ2FkdmljZScpOyAvLyA9PiAnYWR2aWNlJwogIAogICAgaW5mbGVjdG9yLnBsdXJhbGl6ZSgnZm9ybXVsYScpOyAvLyA9PiAnZm9ybXVsYXMnCiAgICBpbmZsZWN0b3IuaXJyZWd1bGFyKCdmb3JtdWxhJywgJ2Zvcm11bGFlJyk7CiAgICBpbmZsZWN0b3IucGx1cmFsaXplKCdmb3JtdWxhJyk7IC8vID0+ICdmb3JtdWxhZScKICAKICAgIC8vIHlvdSB3b3VsZCBub3QgbmVlZCB0byBhZGQgdGhlc2UgYXMgdGhleSBhcmUgdGhlIGRlZmF1bHQgcnVsZXMKICAgIGluZmxlY3Rvci5wbHVyYWwoLyQvLCAncycpOwogICAgaW5mbGVjdG9yLnNpbmd1bGFyKC9zJC9pLCAnJyk7CiAgICBgYGAKICAKICAgIENyZWF0aW5nIGFuIGluZmxlY3RvciB3aXRoIGEgbm9uZGVmYXVsdCBydWxlc2V0LgogIAogICAgYGBgamF2YXNjcmlwdAogICAgdmFyIHJ1bGVzID0gewogICAgICBwbHVyYWxzOiAgWwogICAgICAgIFsgLyQvLCAncycgXQogICAgICBdLAogICAgICBzaW5ndWxhcjogWwogICAgICAgIFsgL1xzJC8sICcnIF0KICAgICAgXSwKICAgICAgaXJyZWd1bGFyUGFpcnM6IFsKICAgICAgICBbICdjb3cnLCAna2luZScgXQogICAgICBdLAogICAgICB1bmNvdW50YWJsZTogWyAnZmlzaCcgXQogICAgfTsKICAKICAgIHZhciBpbmZsZWN0b3IgPSBuZXcgRW1iZXIuSW5mbGVjdG9yKHJ1bGVzKTsKICAgIGBgYAogIAogICAgQGNsYXNzIEluZmxlY3RvcgogICAgQG5hbWVzcGFjZSBFbWJlcgogICovCiAgZnVuY3Rpb24gSW5mbGVjdG9yKHJ1bGVTZXQpIHsKICAgIHJ1bGVTZXQgPSBydWxlU2V0IHx8IHt9OwogICAgcnVsZVNldC51bmNvdW50YWJsZSA9IHJ1bGVTZXQudW5jb3VudGFibGUgfHwgbWFrZURpY3Rpb25hcnkoKTsKICAgIHJ1bGVTZXQuaXJyZWd1bGFyUGFpcnMgPSBydWxlU2V0LmlycmVndWxhclBhaXJzIHx8IG1ha2VEaWN0aW9uYXJ5KCk7CgogICAgdmFyIHJ1bGVzID0gdGhpcy5ydWxlcyA9IHsKICAgICAgcGx1cmFsczogcnVsZVNldC5wbHVyYWxzIHx8IFtdLAogICAgICBzaW5ndWxhcjogcnVsZVNldC5zaW5ndWxhciB8fCBbXSwKICAgICAgaXJyZWd1bGFyOiBtYWtlRGljdGlvbmFyeSgpLAogICAgICBpcnJlZ3VsYXJJbnZlcnNlOiBtYWtlRGljdGlvbmFyeSgpLAogICAgICB1bmNvdW50YWJsZTogbWFrZURpY3Rpb25hcnkoKQogICAgfTsKCiAgICBsb2FkVW5jb3VudGFibGUocnVsZXMsIHJ1bGVTZXQudW5jb3VudGFibGUpOwogICAgbG9hZElycmVndWxhcihydWxlcywgcnVsZVNldC5pcnJlZ3VsYXJQYWlycyk7CgogICAgdGhpcy5lbmFibGVDYWNoZSgpOwogIH0KCiAgaWYgKCFPYmplY3QuY3JlYXRlICYmICFPYmplY3QuY3JlYXRlKG51bGwpLmhhc093blByb3BlcnR5KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IE9iamVjdC5jcmVhdGUobnVsbCksIHBsZWFzZSBwb2x5ZmlsIHdpdGggZXM1LXNoYW06IGh0dHA6Ly9naXQuaW8veUJVMnJnIik7CiAgfQoKICBmdW5jdGlvbiBtYWtlRGljdGlvbmFyeSgpIHsKICAgIHZhciBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBjYWNoZVsnX2RpY3QnXSA9IG51bGw7CiAgICBkZWxldGUgY2FjaGVbJ19kaWN0J107CiAgICByZXR1cm4gY2FjaGU7CiAgfQoKICBJbmZsZWN0b3IucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgIEBwdWJsaWMKICAgICAgIEFzIGluZmxlY3Rpb25zIGNhbiBiZSBjb3N0bHksIGFuZCBjb21tb25seSB0aGUgc2FtZSBzdWJzZXQgb2Ygd29yZHMgYXJlIHJlcGVhdGVkbHkKICAgICAgaW5mbGVjdGVkIGFuIG9wdGlvbmFsIGNhY2hlIGlzIHByb3ZpZGVkLgogICAgICAgQG1ldGhvZCBlbmFibGVDYWNoZQogICAgKi8KICAgIGVuYWJsZUNhY2hlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMucHVyZ2VDYWNoZSgpOwoKICAgICAgdGhpcy5zaW5ndWxhcml6ZSA9IGZ1bmN0aW9uICh3b3JkKSB7CiAgICAgICAgdGhpcy5fY2FjaGVVc2VkID0gdHJ1ZTsKICAgICAgICByZXR1cm4gdGhpcy5fc0NhY2hlW3dvcmRdIHx8ICh0aGlzLl9zQ2FjaGVbd29yZF0gPSB0aGlzLl9zaW5ndWxhcml6ZSh3b3JkKSk7CiAgICAgIH07CgogICAgICB0aGlzLnBsdXJhbGl6ZSA9IGZ1bmN0aW9uIChudW1iZXJPcldvcmQsIHdvcmQsIG9wdGlvbnMgPSB7fSkgewogICAgICAgIHRoaXMuX2NhY2hlVXNlZCA9IHRydWU7CiAgICAgICAgdmFyIGNhY2hlS2V5ID0gW251bWJlck9yV29yZCwgd29yZCwgb3B0aW9ucy53aXRob3V0Q291bnRdOwogICAgICAgIHJldHVybiB0aGlzLl9wQ2FjaGVbY2FjaGVLZXldIHx8ICh0aGlzLl9wQ2FjaGVbY2FjaGVLZXldID0gdGhpcy5fcGx1cmFsaXplKG51bWJlck9yV29yZCwgd29yZCwgb3B0aW9ucykpOwogICAgICB9OwogICAgfSwKCiAgICAvKioKICAgICAgQHB1YmxpYwogICAgICAgQG1ldGhvZCBwdXJnZWRDYWNoZQogICAgKi8KICAgIHB1cmdlQ2FjaGU6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5fY2FjaGVVc2VkID0gZmFsc2U7CiAgICAgIHRoaXMuX3NDYWNoZSA9IG1ha2VEaWN0aW9uYXJ5KCk7CiAgICAgIHRoaXMuX3BDYWNoZSA9IG1ha2VEaWN0aW9uYXJ5KCk7CiAgICB9LAoKICAgIC8qKgogICAgICBAcHVibGljCiAgICAgIGRpc2FibGUgY2FjaGluZwogICAgICAgQG1ldGhvZCBkaXNhYmxlQ2FjaGU7CiAgICAqLwogICAgZGlzYWJsZUNhY2hlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuX3NDYWNoZSA9IG51bGw7CiAgICAgIHRoaXMuX3BDYWNoZSA9IG51bGw7CiAgICAgIHRoaXMuc2luZ3VsYXJpemUgPSBmdW5jdGlvbiAod29yZCkgewogICAgICAgIHJldHVybiB0aGlzLl9zaW5ndWxhcml6ZSh3b3JkKTsKICAgICAgfTsKCiAgICAgIHRoaXMucGx1cmFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wbHVyYWxpemUoLi4uYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgcGx1cmFsCiAgICAgIEBwYXJhbSB7UmVnRXhwfSByZWdleAogICAgICBAcGFyYW0ge1N0cmluZ30gc3RyaW5nCiAgICAqLwogICAgcGx1cmFsOiBmdW5jdGlvbiAocmVnZXgsIHN0cmluZykgewogICAgICBpZiAodGhpcy5fY2FjaGVVc2VkKSB7CiAgICAgICAgdGhpcy5wdXJnZUNhY2hlKCk7CiAgICAgIH0KICAgICAgdGhpcy5ydWxlcy5wbHVyYWxzLnB1c2goW3JlZ2V4LCBzdHJpbmcudG9Mb3dlckNhc2UoKV0pOwogICAgfSwKCiAgICAvKioKICAgICAgQG1ldGhvZCBzaW5ndWxhcgogICAgICBAcGFyYW0ge1JlZ0V4cH0gcmVnZXgKICAgICAgQHBhcmFtIHtTdHJpbmd9IHN0cmluZwogICAgKi8KICAgIHNpbmd1bGFyOiBmdW5jdGlvbiAocmVnZXgsIHN0cmluZykgewogICAgICBpZiAodGhpcy5fY2FjaGVVc2VkKSB7CiAgICAgICAgdGhpcy5wdXJnZUNhY2hlKCk7CiAgICAgIH0KICAgICAgdGhpcy5ydWxlcy5zaW5ndWxhci5wdXNoKFtyZWdleCwgc3RyaW5nLnRvTG93ZXJDYXNlKCldKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgdW5jb3VudGFibGUKICAgICAgQHBhcmFtIHtTdHJpbmd9IHJlZ2V4CiAgICAqLwogICAgdW5jb3VudGFibGU6IGZ1bmN0aW9uIChzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuX2NhY2hlVXNlZCkgewogICAgICAgIHRoaXMucHVyZ2VDYWNoZSgpOwogICAgICB9CiAgICAgIGxvYWRVbmNvdW50YWJsZSh0aGlzLnJ1bGVzLCBbc3RyaW5nLnRvTG93ZXJDYXNlKCldKTsKICAgIH0sCgogICAgLyoqCiAgICAgIEBtZXRob2QgaXJyZWd1bGFyCiAgICAgIEBwYXJhbSB7U3RyaW5nfSBzaW5ndWxhcgogICAgICBAcGFyYW0ge1N0cmluZ30gcGx1cmFsCiAgICAqLwogICAgaXJyZWd1bGFyOiBmdW5jdGlvbiAoc2luZ3VsYXIsIHBsdXJhbCkgewogICAgICBpZiAodGhpcy5fY2FjaGVVc2VkKSB7CiAgICAgICAgdGhpcy5wdXJnZUNhY2hlKCk7CiAgICAgIH0KICAgICAgbG9hZElycmVndWxhcih0aGlzLnJ1bGVzLCBbW3Npbmd1bGFyLCBwbHVyYWxdXSk7CiAgICB9LAoKICAgIC8qKgogICAgICBAbWV0aG9kIHBsdXJhbGl6ZQogICAgICBAcGFyYW0ge1N0cmluZ30gd29yZAogICAgKi8KICAgIHBsdXJhbGl6ZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5fcGx1cmFsaXplKC4uLmFyZ3VtZW50cyk7CiAgICB9LAoKICAgIF9wbHVyYWxpemU6IGZ1bmN0aW9uICh3b3JkT3JDb3VudCwgd29yZCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh3b3JkID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmZsZWN0KHdvcmRPckNvdW50LCB0aGlzLnJ1bGVzLnBsdXJhbHMsIHRoaXMucnVsZXMuaXJyZWd1bGFyKTsKICAgICAgfQoKICAgICAgaWYgKHBhcnNlRmxvYXQod29yZE9yQ291bnQpICE9PSAxKSB7CiAgICAgICAgd29yZCA9IHRoaXMuaW5mbGVjdCh3b3JkLCB0aGlzLnJ1bGVzLnBsdXJhbHMsIHRoaXMucnVsZXMuaXJyZWd1bGFyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG9wdGlvbnMud2l0aG91dENvdW50ID8gd29yZCA6IGAke3dvcmRPckNvdW50fSAke3dvcmR9YDsKICAgIH0sCiAgICAvKioKICAgICAgQG1ldGhvZCBzaW5ndWxhcml6ZQogICAgICBAcGFyYW0ge1N0cmluZ30gd29yZAogICAgKi8KICAgIHNpbmd1bGFyaXplOiBmdW5jdGlvbiAod29yZCkgewogICAgICByZXR1cm4gdGhpcy5fc2luZ3VsYXJpemUod29yZCk7CiAgICB9LAoKICAgIF9zaW5ndWxhcml6ZTogZnVuY3Rpb24gKHdvcmQpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5mbGVjdCh3b3JkLCB0aGlzLnJ1bGVzLnNpbmd1bGFyLCB0aGlzLnJ1bGVzLmlycmVndWxhckludmVyc2UpOwogICAgfSwKCiAgICAvKioKICAgICAgQHByb3RlY3RlZAogICAgICAgQG1ldGhvZCBpbmZsZWN0CiAgICAgIEBwYXJhbSB7U3RyaW5nfSB3b3JkCiAgICAgIEBwYXJhbSB7T2JqZWN0fSB0eXBlUnVsZXMKICAgICAgQHBhcmFtIHtPYmplY3R9IGlycmVndWxhcgogICAgKi8KICAgIGluZmxlY3Q6IGZ1bmN0aW9uICh3b3JkLCB0eXBlUnVsZXMsIGlycmVndWxhcikgewogICAgICB2YXIgaW5mbGVjdGlvbiwgc3Vic3RpdHV0aW9uLCByZXN1bHQsIGxvd2VyY2FzZSwgd29yZFNwbGl0LCBmaXJzdFBocmFzZSwgbGFzdFdvcmQsIGlzQmxhbmssIGlzQ2FtZWxpemVkLCBydWxlLCBpc1VuY291bnRhYmxlOwoKICAgICAgaXNCbGFuayA9ICF3b3JkIHx8IEJMQU5LX1JFR0VYLnRlc3Qod29yZCk7CgogICAgICBpc0NhbWVsaXplZCA9IENBTUVMSVpFRF9SRUdFWC50ZXN0KHdvcmQpOwogICAgICBmaXJzdFBocmFzZSA9ICIiOwoKICAgICAgaWYgKGlzQmxhbmspIHsKICAgICAgICByZXR1cm4gd29yZDsKICAgICAgfQoKICAgICAgbG93ZXJjYXNlID0gd29yZC50b0xvd2VyQ2FzZSgpOwogICAgICB3b3JkU3BsaXQgPSBMQVNUX1dPUkRfREFTSEVEX1JFR0VYLmV4ZWMod29yZCkgfHwgTEFTVF9XT1JEX0NBTUVMSVpFRF9SRUdFWC5leGVjKHdvcmQpOwoKICAgICAgaWYgKHdvcmRTcGxpdCkgewogICAgICAgIGZpcnN0UGhyYXNlID0gd29yZFNwbGl0WzFdOwogICAgICAgIGxhc3RXb3JkID0gd29yZFNwbGl0WzJdLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0KCiAgICAgIGlzVW5jb3VudGFibGUgPSB0aGlzLnJ1bGVzLnVuY291bnRhYmxlW2xvd2VyY2FzZV0gfHwgdGhpcy5ydWxlcy51bmNvdW50YWJsZVtsYXN0V29yZF07CgogICAgICBpZiAoaXNVbmNvdW50YWJsZSkgewogICAgICAgIHJldHVybiB3b3JkOwogICAgICB9CgogICAgICBmb3IgKHJ1bGUgaW4gaXJyZWd1bGFyKSB7CiAgICAgICAgaWYgKGxvd2VyY2FzZS5tYXRjaChydWxlICsgIiQiKSkgewogICAgICAgICAgc3Vic3RpdHV0aW9uID0gaXJyZWd1bGFyW3J1bGVdOwoKICAgICAgICAgIGlmIChpc0NhbWVsaXplZCAmJiBpcnJlZ3VsYXJbbGFzdFdvcmRdKSB7CiAgICAgICAgICAgIHN1YnN0aXR1dGlvbiA9IGNhcGl0YWxpemUoc3Vic3RpdHV0aW9uKTsKICAgICAgICAgICAgcnVsZSA9IGNhcGl0YWxpemUocnVsZSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHdvcmQucmVwbGFjZShuZXcgUmVnRXhwKHJ1bGUsICdpJyksIHN1YnN0aXR1dGlvbik7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gdHlwZVJ1bGVzLmxlbmd0aCwgbWluID0gMDsgaSA+IG1pbjsgaS0tKSB7CiAgICAgICAgaW5mbGVjdGlvbiA9IHR5cGVSdWxlc1tpIC0gMV07CiAgICAgICAgcnVsZSA9IGluZmxlY3Rpb25bMF07CgogICAgICAgIGlmIChydWxlLnRlc3Qod29yZCkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaW5mbGVjdGlvbiA9IGluZmxlY3Rpb24gfHwgW107CgogICAgICBydWxlID0gaW5mbGVjdGlvblswXTsKICAgICAgc3Vic3RpdHV0aW9uID0gaW5mbGVjdGlvblsxXTsKCiAgICAgIHJlc3VsdCA9IHdvcmQucmVwbGFjZShydWxlLCBzdWJzdGl0dXRpb24pOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9OwoKICBleHBvcnRzLmRlZmF1bHQgPSBJbmZsZWN0b3I7Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvbGliL3N5c3RlbS9zdHJpbmcnLCBbJ2V4cG9ydHMnLCAnZW1iZXItaW5mbGVjdG9yL2xpYi9zeXN0ZW0vaW5mbGVjdG9yJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfaW5mbGVjdG9yKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuc2luZ3VsYXJpemUgPSBleHBvcnRzLnBsdXJhbGl6ZSA9IHVuZGVmaW5lZDsKCgogIGZ1bmN0aW9uIHBsdXJhbGl6ZSgpIHsKICAgIHJldHVybiBfaW5mbGVjdG9yLmRlZmF1bHQuaW5mbGVjdG9yLnBsdXJhbGl6ZSguLi5hcmd1bWVudHMpOwogIH0KCiAgZnVuY3Rpb24gc2luZ3VsYXJpemUod29yZCkgewogICAgcmV0dXJuIF9pbmZsZWN0b3IuZGVmYXVsdC5pbmZsZWN0b3Iuc2luZ3VsYXJpemUod29yZCk7CiAgfQoKICBleHBvcnRzLnBsdXJhbGl6ZSA9IHBsdXJhbGl6ZTsKICBleHBvcnRzLnNpbmd1bGFyaXplID0gc2luZ3VsYXJpemU7Cn0pOwo7ZGVmaW5lKCdlbWJlci1pbmZsZWN0b3IvbGliL3V0aWxzL21ha2UtaGVscGVyJywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IG1ha2VIZWxwZXI7CiAgZnVuY3Rpb24gbWFrZUhlbHBlcihoZWxwZXJGdW5jdGlvbikgewogICAgaWYgKEVtYmVyLkhlbHBlcikgewogICAgICByZXR1cm4gRW1iZXIuSGVscGVyLmhlbHBlcihoZWxwZXJGdW5jdGlvbik7CiAgICB9CiAgICBpZiAoRW1iZXIuSFRNTEJhcnMpIHsKICAgICAgcmV0dXJuIEVtYmVyLkhUTUxCYXJzLm1ha2VCb3VuZEhlbHBlcihoZWxwZXJGdW5jdGlvbik7CiAgICB9CiAgICByZXR1cm4gRW1iZXIuSGFuZGxlYmFycy5tYWtlQm91bmRIZWxwZXIoaGVscGVyRnVuY3Rpb24pOwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLWxvYWQtaW5pdGlhbGl6ZXJzL2luZGV4JywgWydleHBvcnRzJ10sIGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwoKICBleHBvcnRzLmRlZmF1bHQgPSBmdW5jdGlvbiAoYXBwLCBwcmVmaXgpIHsKICAgIHZhciBpbml0aWFsaXplclByZWZpeCA9IHByZWZpeCArICcvaW5pdGlhbGl6ZXJzLyc7CiAgICB2YXIgaW5zdGFuY2VJbml0aWFsaXplclByZWZpeCA9IHByZWZpeCArICcvaW5zdGFuY2UtaW5pdGlhbGl6ZXJzLyc7CiAgICB2YXIgaW5pdGlhbGl6ZXJzID0gW107CiAgICB2YXIgaW5zdGFuY2VJbml0aWFsaXplcnMgPSBbXTsKICAgIC8vIHRoaXMgaXMgMiBwYXNzIGJlY2F1c2UgZ2VuZXJhbGx5IHRoZSBmaXJzdCBwYXNzIGlzIHRoZSBwcm9ibGVtCiAgICAvLyBhbmQgaXMgcmVkdWNlZCwgYW5kIHJlc29sdmVJbml0aWFsaXplciBoYXMgcG90ZW50aWFsIHRvIGRlb3B0CiAgICB2YXIgbW9kdWxlTmFtZXMgPSBPYmplY3Qua2V5cyhyZXF1aXJlanMuX2Vha19zZWVuKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kdWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1vZHVsZU5hbWUgPSBtb2R1bGVOYW1lc1tpXTsKICAgICAgaWYgKG1vZHVsZU5hbWUubGFzdEluZGV4T2YoaW5pdGlhbGl6ZXJQcmVmaXgsIDApID09PSAwKSB7CiAgICAgICAgaWYgKCFfZW5kc1dpdGgobW9kdWxlTmFtZSwgJy10ZXN0JykpIHsKICAgICAgICAgIGluaXRpYWxpemVycy5wdXNoKG1vZHVsZU5hbWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtb2R1bGVOYW1lLmxhc3RJbmRleE9mKGluc3RhbmNlSW5pdGlhbGl6ZXJQcmVmaXgsIDApID09PSAwKSB7CiAgICAgICAgaWYgKCFfZW5kc1dpdGgobW9kdWxlTmFtZSwgJy10ZXN0JykpIHsKICAgICAgICAgIGluc3RhbmNlSW5pdGlhbGl6ZXJzLnB1c2gobW9kdWxlTmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZWdpc3RlckluaXRpYWxpemVycyhhcHAsIGluaXRpYWxpemVycyk7CiAgICByZWdpc3Rlckluc3RhbmNlSW5pdGlhbGl6ZXJzKGFwcCwgaW5zdGFuY2VJbml0aWFsaXplcnMpOwogIH07CgogIC8qIGdsb2JhbCByZXF1aXJlanM6ZmFsc2UsIHJlcXVpcmU6ZmFsc2UgKi8KICBmdW5jdGlvbiByZXNvbHZlSW5pdGlhbGl6ZXIobW9kdWxlTmFtZSkgewogICAgdmFyIG1vZHVsZSA9IHJlcXVpcmUobW9kdWxlTmFtZSwgbnVsbCwgbnVsbCwgdHJ1ZSk7CiAgICBpZiAoIW1vZHVsZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IobW9kdWxlTmFtZSArICcgbXVzdCBleHBvcnQgYW4gaW5pdGlhbGl6ZXIuJyk7CiAgICB9CiAgICB2YXIgaW5pdGlhbGl6ZXIgPSBtb2R1bGVbJ2RlZmF1bHQnXTsKICAgIGlmICghaW5pdGlhbGl6ZXIubmFtZSkgewogICAgICBpbml0aWFsaXplci5uYW1lID0gbW9kdWxlTmFtZS5zbGljZShtb2R1bGVOYW1lLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKICAgIH0KICAgIHJldHVybiBpbml0aWFsaXplcjsKICB9CgogIGZ1bmN0aW9uIHJlZ2lzdGVySW5pdGlhbGl6ZXJzKGFwcCwgbW9kdWxlTmFtZXMpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kdWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgYXBwLmluaXRpYWxpemVyKHJlc29sdmVJbml0aWFsaXplcihtb2R1bGVOYW1lc1tpXSkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVnaXN0ZXJJbnN0YW5jZUluaXRpYWxpemVycyhhcHAsIG1vZHVsZU5hbWVzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1vZHVsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFwcC5pbnN0YW5jZUluaXRpYWxpemVyKHJlc29sdmVJbml0aWFsaXplcihtb2R1bGVOYW1lc1tpXSkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gX2VuZHNXaXRoKHN0ciwgc3VmZml4KSB7CiAgICByZXR1cm4gc3RyLmluZGV4T2Yoc3VmZml4LCBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogIH0KfSk7CjsvKgogKiBUaGlzIGlzIGEgc3R1YiBmaWxlLCBpdCBtdXN0IGJlIG9uIGRpc2sgYi9jIGJhYmVsLXBsdWdpbi1kZWJ1Zy1tYWNyb3MKICogZG9lcyBub3Qgc3RyaXAgdGhlIG1vZHVsZSByZXF1aXJlIHdoZW4gdGhlIHRyYW5zcGlsZWQgdmFyaWFibGUgdXNhZ2UgaXMKICogc3RyaXBwZWQuCiAqLwpkZWZpbmUoImVtYmVyLXJlc29sdmVyL2ZlYXR1cmVzIiwgW10sIGZ1bmN0aW9uICgpIHsKICAidXNlIHN0cmljdCI7Cn0pOwo7ZGVmaW5lKCdlbWJlci1yZXNvbHZlci9pbmRleCcsIFsnZXhwb3J0cycsICdlbWJlci1yZXNvbHZlci9yZXNvbHZlcnMvY2xhc3NpYyddLCBmdW5jdGlvbiAoZXhwb3J0cywgX2NsYXNzaWMpIHsKICAndXNlIHN0cmljdCc7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdkZWZhdWx0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX2NsYXNzaWMuZGVmYXVsdDsKICAgIH0KICB9KTsKfSk7CjtkZWZpbmUoJ2VtYmVyLXJlc29sdmVyL3Jlc29sdmVyJywgWydleHBvcnRzJywgJ2VtYmVyLXJlc29sdmVyL3Jlc29sdmVycy9jbGFzc2ljJ10sIGZ1bmN0aW9uIChleHBvcnRzLCBfY2xhc3NpYykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ2RlZmF1bHQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfY2xhc3NpYy5kZWZhdWx0OwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItcmVzb2x2ZXIvcmVzb2x2ZXJzL2NsYXNzaWMvY29udGFpbmVyLWRlYnVnLWFkYXB0ZXInLCBbJ2V4cG9ydHMnLCAnZW1iZXItcmVzb2x2ZXIvcmVzb2x2ZXJzL2NsYXNzaWMvaW5kZXgnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9pbmRleCkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKCgogIGNvbnN0IHsgQ29udGFpbmVyRGVidWdBZGFwdGVyIH0gPSBFbWJlcjsKCiAgZnVuY3Rpb24gZ2V0UG9kKHR5cGUsIGtleSwgcHJlZml4KSB7CiAgICBsZXQgbWF0Y2ggPSBrZXkubWF0Y2gobmV3IFJlZ0V4cCgnXi8/JyArIHByZWZpeCArICcvKC4rKS8nICsgdHlwZSArICckJykpOwogICAgaWYgKG1hdGNoICE9PSBudWxsKSB7CiAgICAgIHJldHVybiBtYXRjaFsxXTsKICAgIH0KICB9CgogIC8qCiAgICogVGhpcyBtb2R1bGUgZGVmaW5lcyBhIHN1YmNsYXNzIG9mIEVtYmVyLkNvbnRhaW5lckRlYnVnQWRhcHRlciB0aGF0IGFkZHMKICAgKiBzdXBwb3J0IGZvciByZXNvbHZpbmcgZnJvbSBtb2R1bGVzLgogICAqCiAgICovCiAgZXhwb3J0cy5kZWZhdWx0ID0gQ29udGFpbmVyRGVidWdBZGFwdGVyLmV4dGVuZCh7CiAgICBfbW9kdWxlUmVnaXN0cnk6IG51bGwsCgogICAgaW5pdCgpIHsKICAgICAgdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKCiAgICAgIGlmICghdGhpcy5fbW9kdWxlUmVnaXN0cnkpIHsKICAgICAgICB0aGlzLl9tb2R1bGVSZWdpc3RyeSA9IG5ldyBfaW5kZXguTW9kdWxlUmVnaXN0cnkoKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAgICBUaGUgY29udGFpbmVyIG9mIHRoZSBhcHBsaWNhdGlvbiBiZWluZyBkZWJ1Z2dlZC4KICAgICAgICBUaGlzIHByb3BlcnR5IHdpbGwgYmUgaW5qZWN0ZWQKICAgICAgICBvbiBjcmVhdGlvbi4KICAgICAgICAgQHByb3BlcnR5IGNvbnRhaW5lcgogICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICAqLwoKICAgIC8qKgogICAgICAgIFRoZSByZXNvbHZlciBpbnN0YW5jZSBvZiB0aGUgYXBwbGljYXRpb24KICAgICAgICBiZWluZyBkZWJ1Z2dlZC4gVGhpcyBwcm9wZXJ0eSB3aWxsIGJlIGluamVjdGVkCiAgICAgICAgb24gY3JlYXRpb24uCiAgICAgICAgIEBwcm9wZXJ0eSByZXNvbHZlcgogICAgICAgIEBkZWZhdWx0IG51bGwKICAgICAgICAqLwoKICAgIC8qKgogICAgICAgIFJldHVybnMgdHJ1ZSBpZiBpdCBpcyBwb3NzaWJsZSB0byBjYXRhbG9nIGEgbGlzdCBvZiBhdmFpbGFibGUKICAgICAgICBjbGFzc2VzIGluIHRoZSByZXNvbHZlciBmb3IgYSBnaXZlbiB0eXBlLgogICAgICAgICBAbWV0aG9kIGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlCiAgICAgICAgQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIHR5cGUuIGUuZy4gIm1vZGVsIiwgImNvbnRyb2xsZXIiLCAicm91dGUiCiAgICAgICAgQHJldHVybiB7Ym9vbGVhbn0gd2hldGhlciBhIGxpc3QgaXMgYXZhaWxhYmxlIGZvciB0aGlzIHR5cGUuCiAgICAgICAgKi8KICAgIGNhbkNhdGFsb2dFbnRyaWVzQnlUeXBlKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgPT09ICdtb2RlbCcpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqCiAgICAgICAgUmV0dXJucyB0aGUgYXZhaWxhYmxlIGNsYXNzZXMgYSBnaXZlbiB0eXBlLgogICAgICAgICBAbWV0aG9kIGNhdGFsb2dFbnRyaWVzQnlUeXBlCiAgICAgICAgQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIHR5cGUuIGUuZy4gIm1vZGVsIiwgImNvbnRyb2xsZXIiLCAicm91dGUiCiAgICAgICAgQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGNsYXNzZXMuCiAgICAgICAgKi8KICAgIGNhdGFsb2dFbnRyaWVzQnlUeXBlKHR5cGUpIHsKICAgICAgbGV0IG1vZHVsZU5hbWVzID0gdGhpcy5fbW9kdWxlUmVnaXN0cnkubW9kdWxlTmFtZXMoKTsKICAgICAgbGV0IHR5cGVzID0gRW1iZXIuQSgpOwoKICAgICAgbGV0IHByZWZpeCA9IHRoaXMubmFtZXNwYWNlLm1vZHVsZVByZWZpeDsKCiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gbW9kdWxlTmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbGV0IGtleSA9IG1vZHVsZU5hbWVzW2ldOwoKICAgICAgICBpZiAoa2V5LmluZGV4T2YodHlwZSkgIT09IC0xKSB7CiAgICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGEgcG9kIG1vZHVsZQogICAgICAgICAgbGV0IG5hbWUgPSBnZXRQb2QodHlwZSwga2V5LCB0aGlzLm5hbWVzcGFjZS5wb2RNb2R1bGVQcmVmaXggfHwgcHJlZml4KTsKICAgICAgICAgIGlmICghbmFtZSkgewogICAgICAgICAgICAvLyBOb3QgcG9kCiAgICAgICAgICAgIG5hbWUgPSBrZXkuc3BsaXQodHlwZSArICdzLycpLnBvcCgpOwoKICAgICAgICAgICAgLy8gU3VwcG9ydCBmb3IgZGlmZmVyZW50IHByZWZpeCAoc3VjaCBhcyBlbWJlci1jbGkgYWRkb25zKS4KICAgICAgICAgICAgLy8gVW5jb21tZW50IHRoZSBjb2RlIGJlbG93IHdoZW4KICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyLWNsaS9lbWJlci1yZXNvbHZlci9wdWxsLzgwIGlzIG1lcmdlZC4KCiAgICAgICAgICAgIC8vbGV0IG1hdGNoID0ga2V5Lm1hdGNoKCdeLz8oLispLycgKyB0eXBlKTsKICAgICAgICAgICAgLy9pZiAobWF0Y2ggJiYgbWF0Y2hbMV0gIT09IHByZWZpeCkgewogICAgICAgICAgICAvLyBEaWZmZXJlbnQgcHJlZml4IHN1Y2ggYXMgYW4gYWRkb24KICAgICAgICAgICAgLy9uYW1lID0gbWF0Y2hbMV0gKyAnQCcgKyBuYW1lOwogICAgICAgICAgICAvL30KICAgICAgICAgIH0KICAgICAgICAgIHR5cGVzLmFkZE9iamVjdChuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHR5cGVzOwogICAgfQogIH0pOwp9KTsKO2RlZmluZSgnZW1iZXItcmVzb2x2ZXIvcmVzb2x2ZXJzL2NsYXNzaWMvaW5kZXgnLCBbJ2V4cG9ydHMnLCAnZW1iZXItcmVzb2x2ZXIvdXRpbHMvY2xhc3MtZmFjdG9yeScsICdlbWJlci1yZXNvbHZlci91dGlscy9tYWtlLWRpY3Rpb25hcnknXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF9jbGFzc0ZhY3RvcnksIF9tYWtlRGljdGlvbmFyeSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLk1vZHVsZVJlZ2lzdHJ5ID0gdW5kZWZpbmVkOwoKCiAgaWYgKHR5cGVvZiByZXF1aXJlanMuZW50cmllcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgIHJlcXVpcmVqcy5lbnRyaWVzID0gcmVxdWlyZWpzLl9lYWtfc2VlbjsKICB9IC8qIGdsb2JhbHMgcmVxdWlyZWpzLCByZXF1aXJlICovCgogIGNsYXNzIE1vZHVsZVJlZ2lzdHJ5IHsKICAgIGNvbnN0cnVjdG9yKGVudHJpZXMpIHsKICAgICAgdGhpcy5fZW50cmllcyA9IGVudHJpZXMgfHwgcmVxdWlyZWpzLmVudHJpZXM7CiAgICB9CiAgICBtb2R1bGVOYW1lcygpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2VudHJpZXMpOwogICAgfQogICAgaGFzKG1vZHVsZU5hbWUpIHsKICAgICAgcmV0dXJuIG1vZHVsZU5hbWUgaW4gdGhpcy5fZW50cmllczsKICAgIH0KICAgIGdldChtb2R1bGVOYW1lKSB7CiAgICAgIHJldHVybiByZXF1aXJlKG1vZHVsZU5hbWUpOwogICAgfQogIH0KCiAgZXhwb3J0cy5Nb2R1bGVSZWdpc3RyeSA9IE1vZHVsZVJlZ2lzdHJ5OwogIC8qCiAgICogVGhpcyBtb2R1bGUgZGVmaW5lcyBhIHN1YmNsYXNzIG9mIEVtYmVyLkRlZmF1bHRSZXNvbHZlciB0aGF0IGFkZHMgdHdvCiAgICogaW1wb3J0YW50IGZlYXR1cmVzOgogICAqCiAgICogIDEpIFRoZSByZXNvbHZlciBtYWtlcyB0aGUgY29udGFpbmVyIGF3YXJlIG9mIGVzNiBtb2R1bGVzIHZpYSB0aGUgQU1ECiAgICogICAgIG91dHB1dC4gVGhlIGxvYWRlcidzIF9tb2R1bGVFbnRyaWVzIGlzIGNvbnN1bHRlZCBzbyB0aGF0IGNsYXNzZXMgY2FuIGJlCiAgICogICAgIHJlc29sdmVkIGRpcmVjdGx5IHZpYSB0aGUgbW9kdWxlIGxvYWRlciwgd2l0aG91dCBuZWVkaW5nIGEgbWFudWFsCiAgICogICAgIGBpbXBvcnRgLgogICAqICAyKSBpcyBhYmxlIHRvIHByb3ZpZGUgaW5qZWN0aW9ucyB0byBjbGFzc2VzIHRoYXQgaW1wbGVtZW50IGBleHRlbmRgCiAgICogICAgIChhcyBpcyB0eXBpY2FsIHdpdGggRW1iZXIpLgogICAqLwoKICBjb25zdCB7CiAgICB1bmRlcnNjb3JlLAogICAgY2xhc3NpZnksCiAgICBkYXNoZXJpemUKICB9ID0gRW1iZXIuU3RyaW5nOwogIGNvbnN0IHsKICAgIGdldCwKICAgIERlZmF1bHRSZXNvbHZlcgogIH0gPSBFbWJlcjsKCiAgZnVuY3Rpb24gcGFyc2VOYW1lKGZ1bGxOYW1lKSB7CiAgICBpZiAoZnVsbE5hbWUucGFyc2VkTmFtZSA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gZnVsbE5hbWU7CiAgICB9CgogICAgbGV0IHByZWZpeCwgdHlwZSwgbmFtZTsKICAgIGxldCBmdWxsTmFtZVBhcnRzID0gZnVsbE5hbWUuc3BsaXQoJ0AnKTsKCiAgICAvLyBIVE1MQmFycyB1c2VzIGhlbHBlcjpAY29udGVudC1oZWxwZXIgd2hpY2ggY29sbGlkZXMKICAgIC8vIHdpdGggZW1iZXItY2xpIG5hbWVzcGFjZSBkZXRlY3Rpb24uCiAgICAvLyBUaGlzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSByZWxlYXNlIG9mIEhUTUxCYXJzLgogICAgaWYgKGZ1bGxOYW1lICE9PSAnaGVscGVyOkBjb250ZW50LWhlbHBlcicgJiYgZnVsbE5hbWVQYXJ0cy5sZW5ndGggPT09IDIpIHsKICAgICAgbGV0IHByZWZpeFBhcnRzID0gZnVsbE5hbWVQYXJ0c1swXS5zcGxpdCgnOicpOwoKICAgICAgaWYgKHByZWZpeFBhcnRzLmxlbmd0aCA9PT0gMikgewogICAgICAgIHByZWZpeCA9IHByZWZpeFBhcnRzWzFdOwogICAgICAgIHR5cGUgPSBwcmVmaXhQYXJ0c1swXTsKICAgICAgICBuYW1lID0gZnVsbE5hbWVQYXJ0c1sxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgbmFtZVBhcnRzID0gZnVsbE5hbWVQYXJ0c1sxXS5zcGxpdCgnOicpOwoKICAgICAgICBwcmVmaXggPSBmdWxsTmFtZVBhcnRzWzBdOwogICAgICAgIHR5cGUgPSBuYW1lUGFydHNbMF07CiAgICAgICAgbmFtZSA9IG5hbWVQYXJ0c1sxXTsKICAgICAgfQoKICAgICAgaWYgKHR5cGUgPT09ICd0ZW1wbGF0ZScgJiYgcHJlZml4Lmxhc3RJbmRleE9mKCdjb21wb25lbnRzLycsIDApID09PSAwKSB7CiAgICAgICAgbmFtZSA9IGBjb21wb25lbnRzLyR7bmFtZX1gOwogICAgICAgIHByZWZpeCA9IHByZWZpeC5zbGljZSgxMSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZ1bGxOYW1lUGFydHMgPSBmdWxsTmFtZS5zcGxpdCgnOicpOwogICAgICB0eXBlID0gZnVsbE5hbWVQYXJ0c1swXTsKICAgICAgbmFtZSA9IGZ1bGxOYW1lUGFydHNbMV07CiAgICB9CgogICAgbGV0IGZ1bGxOYW1lV2l0aG91dFR5cGUgPSBuYW1lOwogICAgbGV0IG5hbWVzcGFjZSA9IGdldCh0aGlzLCAnbmFtZXNwYWNlJyk7CiAgICBsZXQgcm9vdCA9IG5hbWVzcGFjZTsKCiAgICByZXR1cm4gewogICAgICBwYXJzZWROYW1lOiB0cnVlLAogICAgICBmdWxsTmFtZTogZnVsbE5hbWUsCiAgICAgIHByZWZpeDogcHJlZml4IHx8IHRoaXMucHJlZml4KHsgdHlwZTogdHlwZSB9KSwKICAgICAgdHlwZTogdHlwZSwKICAgICAgZnVsbE5hbWVXaXRob3V0VHlwZTogZnVsbE5hbWVXaXRob3V0VHlwZSwKICAgICAgbmFtZTogbmFtZSwKICAgICAgcm9vdDogcm9vdCwKICAgICAgcmVzb2x2ZU1ldGhvZE5hbWU6ICJyZXNvbHZlIiArIGNsYXNzaWZ5KHR5cGUpCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZU90aGVyKHBhcnNlZE5hbWUpIHsKICAgIEVtYmVyLmFzc2VydCgnYG1vZHVsZVByZWZpeGAgbXVzdCBiZSBkZWZpbmVkJywgdGhpcy5uYW1lc3BhY2UubW9kdWxlUHJlZml4KTsKCiAgICBsZXQgbm9ybWFsaXplZE1vZHVsZU5hbWUgPSB0aGlzLmZpbmRNb2R1bGVOYW1lKHBhcnNlZE5hbWUpOwoKICAgIGlmIChub3JtYWxpemVkTW9kdWxlTmFtZSkgewogICAgICBsZXQgZGVmYXVsdEV4cG9ydCA9IHRoaXMuX2V4dHJhY3REZWZhdWx0RXhwb3J0KG5vcm1hbGl6ZWRNb2R1bGVOYW1lLCBwYXJzZWROYW1lKTsKCiAgICAgIGlmIChkZWZhdWx0RXhwb3J0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCBFeHBlY3RlZCB0byBmaW5kOiAnJHtwYXJzZWROYW1lLmZ1bGxOYW1lfScgd2l0aGluICcke25vcm1hbGl6ZWRNb2R1bGVOYW1lfScgYnV0IGdvdCAndW5kZWZpbmVkJy4gRGlkIHlvdSBmb3JnZXQgdG8gJ2V4cG9ydCBkZWZhdWx0JyB3aXRoaW4gJyR7bm9ybWFsaXplZE1vZHVsZU5hbWV9Jz9gKTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuc2hvdWxkV3JhcEluQ2xhc3NGYWN0b3J5KGRlZmF1bHRFeHBvcnQsIHBhcnNlZE5hbWUpKSB7CiAgICAgICAgZGVmYXVsdEV4cG9ydCA9ICgwLCBfY2xhc3NGYWN0b3J5LmRlZmF1bHQpKGRlZmF1bHRFeHBvcnQpOwogICAgICB9CgogICAgICByZXR1cm4gZGVmYXVsdEV4cG9ydDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLl9zdXBlcihwYXJzZWROYW1lKTsKICAgIH0KICB9CgogIC8vIEVtYmVyLkRlZmF1bHRSZXNvbHZlciBkb2NzOgogIC8vICAgaHR0cHM6Ly9naXRodWIuY29tL2VtYmVyanMvZW1iZXIuanMvYmxvYi9tYXN0ZXIvcGFja2FnZXMvZW1iZXItYXBwbGljYXRpb24vbGliL3N5c3RlbS9yZXNvbHZlci5qcwogIGNvbnN0IFJlc29sdmVyID0gRGVmYXVsdFJlc29sdmVyLmV4dGVuZCh7CiAgICByZXNvbHZlT3RoZXIsCiAgICBwYXJzZU5hbWUsCiAgICByZXNvbHZlVGVtcGxhdGU6IHJlc29sdmVPdGhlciwKICAgIHBsdXJhbGl6ZWRUeXBlczogbnVsbCwKICAgIG1vZHVsZVJlZ2lzdHJ5OiBudWxsLAoKICAgIG1ha2VUb1N0cmluZyhmYWN0b3J5LCBmdWxsTmFtZSkgewogICAgICByZXR1cm4gJycgKyB0aGlzLm5hbWVzcGFjZS5tb2R1bGVQcmVmaXggKyAnQCcgKyBmdWxsTmFtZSArICc6JzsKICAgIH0sCgogICAgc2hvdWxkV3JhcEluQ2xhc3NGYWN0b3J5KCkgLyogbW9kdWxlLCBwYXJzZWROYW1lICovewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIGluaXQoKSB7CiAgICAgIHRoaXMuX3N1cGVyKCk7CiAgICAgIHRoaXMubW9kdWxlQmFzZWRSZXNvbHZlciA9IHRydWU7CgogICAgICBpZiAoIXRoaXMuX21vZHVsZVJlZ2lzdHJ5KSB7CiAgICAgICAgdGhpcy5fbW9kdWxlUmVnaXN0cnkgPSBuZXcgTW9kdWxlUmVnaXN0cnkoKTsKICAgICAgfQoKICAgICAgdGhpcy5fbm9ybWFsaXplQ2FjaGUgPSAoMCwgX21ha2VEaWN0aW9uYXJ5LmRlZmF1bHQpKCk7CgogICAgICB0aGlzLnBsdXJhbGl6ZWRUeXBlcyA9IHRoaXMucGx1cmFsaXplZFR5cGVzIHx8ICgwLCBfbWFrZURpY3Rpb25hcnkuZGVmYXVsdCkoKTsKCiAgICAgIGlmICghdGhpcy5wbHVyYWxpemVkVHlwZXMuY29uZmlnKSB7CiAgICAgICAgdGhpcy5wbHVyYWxpemVkVHlwZXMuY29uZmlnID0gJ2NvbmZpZyc7CiAgICAgIH0KICAgICAgdGhpcy5fZGVwcmVjYXRlZFBvZE1vZHVsZVByZWZpeCA9IGZhbHNlOwogICAgfSwKCiAgICBub3JtYWxpemUoZnVsbE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX25vcm1hbGl6ZUNhY2hlW2Z1bGxOYW1lXSB8fCAodGhpcy5fbm9ybWFsaXplQ2FjaGVbZnVsbE5hbWVdID0gdGhpcy5fbm9ybWFsaXplKGZ1bGxOYW1lKSk7CiAgICB9LAoKICAgIF9ub3JtYWxpemUoZnVsbE5hbWUpIHsKICAgICAgLy8gQSkgQ29udmVydCB1bmRlcnNjb3JlcyB0byBkYXNoZXMKICAgICAgLy8gQikgQ29udmVydCBjYW1lbENhc2UgdG8gZGFzaC1jYXNlLCBleGNlcHQgZm9yIGhlbHBlcnMgd2hlcmUgd2Ugd2FudCB0byBhdm9pZCBzaGFkb3dpbmcgY2FtZWxDYXNlIGV4cHJlc3Npb25zCiAgICAgIC8vIEMpIHJlcGxhY2UgYC5gIHdpdGggYC9gIGluIG9yZGVyIHRvIG1ha2UgbmVzdGVkIGNvbnRyb2xsZXJzIHdvcmsgaW4gdGhlIGZvbGxvd2luZyBjYXNlcwogICAgICAvLyAgICAgIDEuIGBuZWVkczogWydwb3N0cy9wb3N0J11gCiAgICAgIC8vICAgICAgMi4gYHt7cmVuZGVyICJwb3N0cy9wb3N0In19YAogICAgICAvLyAgICAgIDMuIGB0aGlzLnJlbmRlcigncG9zdHMvcG9zdCcpYCBmcm9tIFJvdXRlCgogICAgICBsZXQgc3BsaXQgPSBmdWxsTmFtZS5zcGxpdCgnOicpOwogICAgICBpZiAoc3BsaXQubGVuZ3RoID4gMSkgewogICAgICAgIGlmIChzcGxpdFswXSA9PT0gJ2hlbHBlcicpIHsKICAgICAgICAgIHJldHVybiBzcGxpdFswXSArICc6JyArIHNwbGl0WzFdLnJlcGxhY2UoL18vZywgJy0nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHNwbGl0WzBdICsgJzonICsgZGFzaGVyaXplKHNwbGl0WzFdLnJlcGxhY2UoL1wuL2csICcvJykpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZnVsbE5hbWU7CiAgICAgIH0KICAgIH0sCgogICAgcGx1cmFsaXplKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMucGx1cmFsaXplZFR5cGVzW3R5cGVdIHx8ICh0aGlzLnBsdXJhbGl6ZWRUeXBlc1t0eXBlXSA9IHR5cGUgKyAncycpOwogICAgfSwKCiAgICBwb2RCYXNlZExvb2t1cFdpdGhQcmVmaXgocG9kUHJlZml4LCBwYXJzZWROYW1lKSB7CiAgICAgIGxldCBmdWxsTmFtZVdpdGhvdXRUeXBlID0gcGFyc2VkTmFtZS5mdWxsTmFtZVdpdGhvdXRUeXBlOwoKICAgICAgaWYgKHBhcnNlZE5hbWUudHlwZSA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgIGZ1bGxOYW1lV2l0aG91dFR5cGUgPSBmdWxsTmFtZVdpdGhvdXRUeXBlLnJlcGxhY2UoL15jb21wb25lbnRzXC8vLCAnJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwb2RQcmVmaXggKyAnLycgKyBmdWxsTmFtZVdpdGhvdXRUeXBlICsgJy8nICsgcGFyc2VkTmFtZS50eXBlOwogICAgfSwKCiAgICBwb2RCYXNlZE1vZHVsZU5hbWUocGFyc2VkTmFtZSkgewogICAgICBsZXQgcG9kUHJlZml4ID0gdGhpcy5uYW1lc3BhY2UucG9kTW9kdWxlUHJlZml4IHx8IHRoaXMubmFtZXNwYWNlLm1vZHVsZVByZWZpeDsKCiAgICAgIHJldHVybiB0aGlzLnBvZEJhc2VkTG9va3VwV2l0aFByZWZpeChwb2RQcmVmaXgsIHBhcnNlZE5hbWUpOwogICAgfSwKCiAgICBwb2RCYXNlZENvbXBvbmVudHNJblN1YmRpcihwYXJzZWROYW1lKSB7CiAgICAgIGxldCBwb2RQcmVmaXggPSB0aGlzLm5hbWVzcGFjZS5wb2RNb2R1bGVQcmVmaXggfHwgdGhpcy5uYW1lc3BhY2UubW9kdWxlUHJlZml4OwogICAgICBwb2RQcmVmaXggPSBwb2RQcmVmaXggKyAnL2NvbXBvbmVudHMnOwoKICAgICAgaWYgKHBhcnNlZE5hbWUudHlwZSA9PT0gJ2NvbXBvbmVudCcgfHwgL15jb21wb25lbnRzLy50ZXN0KHBhcnNlZE5hbWUuZnVsbE5hbWVXaXRob3V0VHlwZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5wb2RCYXNlZExvb2t1cFdpdGhQcmVmaXgocG9kUHJlZml4LCBwYXJzZWROYW1lKTsKICAgICAgfQogICAgfSwKCiAgICByZXNvbHZlRW5naW5lKHBhcnNlZE5hbWUpIHsKICAgICAgbGV0IGVuZ2luZU5hbWUgPSBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGU7CiAgICAgIGxldCBlbmdpbmVNb2R1bGUgPSBlbmdpbmVOYW1lICsgJy9lbmdpbmUnOwoKICAgICAgaWYgKHRoaXMuX21vZHVsZVJlZ2lzdHJ5LmhhcyhlbmdpbmVNb2R1bGUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2V4dHJhY3REZWZhdWx0RXhwb3J0KGVuZ2luZU1vZHVsZSk7CiAgICAgIH0KICAgIH0sCgogICAgcmVzb2x2ZVJvdXRlTWFwKHBhcnNlZE5hbWUpIHsKICAgICAgbGV0IGVuZ2luZU5hbWUgPSBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGU7CiAgICAgIGxldCBlbmdpbmVSb3V0ZXNNb2R1bGUgPSBlbmdpbmVOYW1lICsgJy9yb3V0ZXMnOwoKICAgICAgaWYgKHRoaXMuX21vZHVsZVJlZ2lzdHJ5LmhhcyhlbmdpbmVSb3V0ZXNNb2R1bGUpKSB7CiAgICAgICAgbGV0IHJvdXRlTWFwID0gdGhpcy5fZXh0cmFjdERlZmF1bHRFeHBvcnQoZW5naW5lUm91dGVzTW9kdWxlKTsKCiAgICAgICAgRW1iZXIuYXNzZXJ0KGBUaGUgcm91dGUgbWFwIGZvciAke2VuZ2luZU5hbWV9IHNob3VsZCBiZSB3cmFwcGVkIGJ5ICdidWlsZFJvdXRlcycgYmVmb3JlIGV4cG9ydGluZy5gLCByb3V0ZU1hcC5pc1JvdXRlTWFwKTsKCiAgICAgICAgcmV0dXJuIHJvdXRlTWFwOwogICAgICB9CiAgICB9LAoKICAgIG1haW5Nb2R1bGVOYW1lKHBhcnNlZE5hbWUpIHsKICAgICAgaWYgKHBhcnNlZE5hbWUuZnVsbE5hbWVXaXRob3V0VHlwZSA9PT0gJ21haW4nKSB7CiAgICAgICAgLy8gaWYgcm91dGVyOm1haW4gb3IgYWRhcHRlcjptYWluIGxvb2sgZm9yIGEgbW9kdWxlIHdpdGgganVzdCB0aGUgdHlwZSBmaXJzdAogICAgICAgIHJldHVybiBwYXJzZWROYW1lLnByZWZpeCArICcvJyArIHBhcnNlZE5hbWUudHlwZTsKICAgICAgfQogICAgfSwKCiAgICBkZWZhdWx0TW9kdWxlTmFtZShwYXJzZWROYW1lKSB7CiAgICAgIHJldHVybiBwYXJzZWROYW1lLnByZWZpeCArICcvJyArIHRoaXMucGx1cmFsaXplKHBhcnNlZE5hbWUudHlwZSkgKyAnLycgKyBwYXJzZWROYW1lLmZ1bGxOYW1lV2l0aG91dFR5cGU7CiAgICB9LAoKICAgIHByZWZpeChwYXJzZWROYW1lKSB7CiAgICAgIGxldCB0bXBQcmVmaXggPSB0aGlzLm5hbWVzcGFjZS5tb2R1bGVQcmVmaXg7CgogICAgICBpZiAodGhpcy5uYW1lc3BhY2VbcGFyc2VkTmFtZS50eXBlICsgJ1ByZWZpeCddKSB7CiAgICAgICAgdG1wUHJlZml4ID0gdGhpcy5uYW1lc3BhY2VbcGFyc2VkTmFtZS50eXBlICsgJ1ByZWZpeCddOwogICAgICB9CgogICAgICByZXR1cm4gdG1wUHJlZml4OwogICAgfSwKCiAgICAvKioKICAgICAgQSBsaXN0aW5nIG9mIGZ1bmN0aW9ucyB0byB0ZXN0IGZvciBtb2R1bGVOYW1lJ3MgYmFzZWQgb24gdGhlIHByb3ZpZGVkCiAgICAgYHBhcnNlZE5hbWVgLiBUaGlzIGFsbG93cyBlYXN5IGN1c3RvbWl6YXRpb24gb2YgYWRkaXRpb25hbCBtb2R1bGUgYmFzZWQKICAgICBsb29rdXAgcGF0dGVybnMuCiAgICAgIEBwcm9wZXJ0eSBtb2R1bGVOYW1lTG9va3VwUGF0dGVybnMKICAgICBAcmV0dXJucyB7RW1iZXIuQXJyYXl9CiAgICAgKi8KICAgIG1vZHVsZU5hbWVMb29rdXBQYXR0ZXJuczogRW1iZXIuY29tcHV0ZWQoZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gW3RoaXMucG9kQmFzZWRNb2R1bGVOYW1lLCB0aGlzLnBvZEJhc2VkQ29tcG9uZW50c0luU3ViZGlyLCB0aGlzLm1haW5Nb2R1bGVOYW1lLCB0aGlzLmRlZmF1bHRNb2R1bGVOYW1lXTsKICAgIH0pLnJlYWRPbmx5KCksCgogICAgZmluZE1vZHVsZU5hbWUocGFyc2VkTmFtZSwgbG9nZ2luZ0Rpc2FibGVkKSB7CiAgICAgIGxldCBtb2R1bGVOYW1lTG9va3VwUGF0dGVybnMgPSB0aGlzLmdldCgnbW9kdWxlTmFtZUxvb2t1cFBhdHRlcm5zJyk7CiAgICAgIGxldCBtb2R1bGVOYW1lOwoKICAgICAgZm9yIChsZXQgaW5kZXggPSAwLCBsZW5ndGggPSBtb2R1bGVOYW1lTG9va3VwUGF0dGVybnMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGxldCBpdGVtID0gbW9kdWxlTmFtZUxvb2t1cFBhdHRlcm5zW2luZGV4XTsKCiAgICAgICAgbGV0IHRtcE1vZHVsZU5hbWUgPSBpdGVtLmNhbGwodGhpcywgcGFyc2VkTmFtZSk7CgogICAgICAgIC8vIGFsbG93IHRyZWF0IGFsbCBkYXNoZWQgYW5kIGFsbCB1bmRlcnNjb3JlZCBhcyB0aGUgc2FtZSB0aGluZwogICAgICAgIC8vIHN1cHBvcnRzIGNvbXBvbmVudHMgd2l0aCBkYXNoZXMgYW5kIG90aGVyIHN0dWZmIHdpdGggdW5kZXJzY29yZXMuCiAgICAgICAgaWYgKHRtcE1vZHVsZU5hbWUpIHsKICAgICAgICAgIHRtcE1vZHVsZU5hbWUgPSB0aGlzLmNob29zZU1vZHVsZU5hbWUodG1wTW9kdWxlTmFtZSwgcGFyc2VkTmFtZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodG1wTW9kdWxlTmFtZSAmJiB0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXModG1wTW9kdWxlTmFtZSkpIHsKICAgICAgICAgIG1vZHVsZU5hbWUgPSB0bXBNb2R1bGVOYW1lOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFsb2dnaW5nRGlzYWJsZWQpIHsKICAgICAgICAgIHRoaXMuX2xvZ0xvb2t1cChtb2R1bGVOYW1lLCBwYXJzZWROYW1lLCB0bXBNb2R1bGVOYW1lKTsKICAgICAgICB9CgogICAgICAgIGlmIChtb2R1bGVOYW1lKSB7CiAgICAgICAgICByZXR1cm4gbW9kdWxlTmFtZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgY2hvb3NlTW9kdWxlTmFtZShtb2R1bGVOYW1lLCBwYXJzZWROYW1lKSB7CiAgICAgIGxldCB1bmRlcnNjb3JlZE1vZHVsZU5hbWUgPSB1bmRlcnNjb3JlKG1vZHVsZU5hbWUpOwoKICAgICAgaWYgKG1vZHVsZU5hbWUgIT09IHVuZGVyc2NvcmVkTW9kdWxlTmFtZSAmJiB0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXMobW9kdWxlTmFtZSkgJiYgdGhpcy5fbW9kdWxlUmVnaXN0cnkuaGFzKHVuZGVyc2NvcmVkTW9kdWxlTmFtZSkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBBbWJpZ3VvdXMgbW9kdWxlIG5hbWVzOiAnJHttb2R1bGVOYW1lfScgYW5kICcke3VuZGVyc2NvcmVkTW9kdWxlTmFtZX0nYCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXMobW9kdWxlTmFtZSkpIHsKICAgICAgICByZXR1cm4gbW9kdWxlTmFtZTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl9tb2R1bGVSZWdpc3RyeS5oYXModW5kZXJzY29yZWRNb2R1bGVOYW1lKSkgewogICAgICAgIHJldHVybiB1bmRlcnNjb3JlZE1vZHVsZU5hbWU7CiAgICAgIH0KICAgICAgLy8gd29ya2Fyb3VuZCBmb3IgZGFzaGVyaXplZCBwYXJ0aWFsczoKICAgICAgLy8gc29tZXRoaW5nL3NvbWV0aGluZy8tc29tZXRoaW5nID0+IHNvbWV0aGluZy9zb21ldGhpbmcvX3NvbWV0aGluZwogICAgICBsZXQgcGFydGlhbGl6ZWRNb2R1bGVOYW1lID0gbW9kdWxlTmFtZS5yZXBsYWNlKC9cLy0oW14vXSopJC8sICcvXyQxJyk7CgogICAgICBpZiAodGhpcy5fbW9kdWxlUmVnaXN0cnkuaGFzKHBhcnRpYWxpemVkTW9kdWxlTmFtZSkpIHsKICAgICAgICBFbWJlci5kZXByZWNhdGUoJ01vZHVsZXMgc2hvdWxkIG5vdCBjb250YWluIHVuZGVyc2NvcmVzLiAnICsgJ0F0dGVtcHRlZCB0byBsb29rdXAgIicgKyBtb2R1bGVOYW1lICsgJyIgd2hpY2ggJyArICd3YXMgbm90IGZvdW5kLiBQbGVhc2UgcmVuYW1lICInICsgcGFydGlhbGl6ZWRNb2R1bGVOYW1lICsgJyIgJyArICd0byAiJyArIG1vZHVsZU5hbWUgKyAnIiBpbnN0ZWFkLicsIGZhbHNlLCB7IGlkOiAnZW1iZXItcmVzb2x2ZXIudW5kZXJzY29yZWQtbW9kdWxlcycsIHVudGlsOiAnMy4wLjAnIH0pOwoKICAgICAgICByZXR1cm4gcGFydGlhbGl6ZWRNb2R1bGVOYW1lOwogICAgICB9CgogICAgICBFbWJlci5ydW5JbkRlYnVnKCgpID0+IHsKICAgICAgICBsZXQgaXNDYW1lbENhc2VIZWxwZXIgPSBwYXJzZWROYW1lLnR5cGUgPT09ICdoZWxwZXInICYmIC9bYS16XStbQS1aXSsvLnRlc3QobW9kdWxlTmFtZSk7CiAgICAgICAgaWYgKGlzQ2FtZWxDYXNlSGVscGVyKSB7CiAgICAgICAgICB0aGlzLl9jYW1lbENhc2VIZWxwZXJXYXJuZWROYW1lcyA9IHRoaXMuX2NhbWVsQ2FzZUhlbHBlcldhcm5lZE5hbWVzIHx8IFtdOwogICAgICAgICAgbGV0IGFscmVhZHlXYXJuZWQgPSB0aGlzLl9jYW1lbENhc2VIZWxwZXJXYXJuZWROYW1lcy5pbmRleE9mKHBhcnNlZE5hbWUuZnVsbE5hbWUpID4gLTE7CiAgICAgICAgICBpZiAoIWFscmVhZHlXYXJuZWQgJiYgdGhpcy5fbW9kdWxlUmVnaXN0cnkuaGFzKGRhc2hlcml6ZShtb2R1bGVOYW1lKSkpIHsKICAgICAgICAgICAgdGhpcy5fY2FtZWxDYXNlSGVscGVyV2FybmVkTmFtZXMucHVzaChwYXJzZWROYW1lLmZ1bGxOYW1lKTsKICAgICAgICAgICAgRW1iZXIud2FybignQXR0ZW1wdGVkIHRvIGxvb2t1cCAiJyArIHBhcnNlZE5hbWUuZnVsbE5hbWUgKyAnIiB3aGljaCAnICsgJ3dhcyBub3QgZm91bmQuIEluIHByZXZpb3VzIHZlcnNpb25zIG9mIGVtYmVyLXJlc29sdmVyLCBhIGJ1ZyB3b3VsZCBoYXZlICcgKyAnY2F1c2VkIHRoZSBtb2R1bGUgYXQgIicgKyBkYXNoZXJpemUobW9kdWxlTmFtZSkgKyAnIiB0byBiZSAnICsgJ3JldHVybmVkIGZvciB0aGlzIGNhbWVsIGNhc2UgaGVscGVyIG5hbWUuIFRoaXMgaGFzIGJlZW4gZml4ZWQuICcgKyAnVXNlIHRoZSBkYXNoZXJpemVkIG5hbWUgdG8gcmVzb2x2ZSB0aGUgbW9kdWxlIHRoYXQgd291bGQgaGF2ZSBiZWVuICcgKyAncmV0dXJuZWQgaW4gcHJldmlvdXMgdmVyc2lvbnMuJywgZmFsc2UsIHsgaWQ6ICdlbWJlci1yZXNvbHZlci5jYW1lbGNhc2UtaGVscGVyLW5hbWVzJywgdW50aWw6ICczLjAuMCcgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgLy8gdXNlZCBieSBFbWJlci5EZWZhdWx0UmVzb2x2ZXIucHJvdG90eXBlLl9sb2dMb29rdXAKICAgIGxvb2t1cERlc2NyaXB0aW9uKGZ1bGxOYW1lKSB7CiAgICAgIGxldCBwYXJzZWROYW1lID0gdGhpcy5wYXJzZU5hbWUoZnVsbE5hbWUpOwoKICAgICAgbGV0IG1vZHVsZU5hbWUgPSB0aGlzLmZpbmRNb2R1bGVOYW1lKHBhcnNlZE5hbWUsIHRydWUpOwoKICAgICAgcmV0dXJuIG1vZHVsZU5hbWU7CiAgICB9LAoKICAgIC8vIG9ubHkgbmVlZGVkIHVudGlsIDEuNi4wLWJldGEuMiBjYW4gYmUgcmVxdWlyZWQKICAgIF9sb2dMb29rdXAoZm91bmQsIHBhcnNlZE5hbWUsIGRlc2NyaXB0aW9uKSB7CiAgICAgIGlmICghRW1iZXIuRU5WLkxPR19NT0RVTEVfUkVTT0xWRVIgJiYgIXBhcnNlZE5hbWUucm9vdC5MT0dfUkVTT0xWRVIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGxldCBwYWRkaW5nOwogICAgICBsZXQgc3ltYm9sID0gZm91bmQgPyAnW+Kck10nIDogJ1sgXSc7CgogICAgICBpZiAocGFyc2VkTmFtZS5mdWxsTmFtZS5sZW5ndGggPiA2MCkgewogICAgICAgIHBhZGRpbmcgPSAnLic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFkZGluZyA9IG5ldyBBcnJheSg2MCAtIHBhcnNlZE5hbWUuZnVsbE5hbWUubGVuZ3RoKS5qb2luKCcuJyk7CiAgICAgIH0KCiAgICAgIGlmICghZGVzY3JpcHRpb24pIHsKICAgICAgICBkZXNjcmlwdGlvbiA9IHRoaXMubG9va3VwRGVzY3JpcHRpb24ocGFyc2VkTmFtZSk7CiAgICAgIH0KCiAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi8KICAgICAgaWYgKGNvbnNvbGUgJiYgY29uc29sZS5pbmZvKSB7CiAgICAgICAgY29uc29sZS5pbmZvKHN5bWJvbCwgcGFyc2VkTmFtZS5mdWxsTmFtZSwgcGFkZGluZywgZGVzY3JpcHRpb24pOwogICAgICB9CiAgICB9LAoKICAgIGtub3duRm9yVHlwZSh0eXBlKSB7CiAgICAgIGxldCBtb2R1bGVLZXlzID0gdGhpcy5fbW9kdWxlUmVnaXN0cnkubW9kdWxlTmFtZXMoKTsKCiAgICAgIGxldCBpdGVtcyA9ICgwLCBfbWFrZURpY3Rpb25hcnkuZGVmYXVsdCkoKTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwLCBsZW5ndGggPSBtb2R1bGVLZXlzLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBsZXQgbW9kdWxlTmFtZSA9IG1vZHVsZUtleXNbaW5kZXhdOwogICAgICAgIGxldCBmdWxsbmFtZSA9IHRoaXMudHJhbnNsYXRlVG9Db250YWluZXJGdWxsbmFtZSh0eXBlLCBtb2R1bGVOYW1lKTsKCiAgICAgICAgaWYgKGZ1bGxuYW1lKSB7CiAgICAgICAgICBpdGVtc1tmdWxsbmFtZV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGl0ZW1zOwogICAgfSwKCiAgICB0cmFuc2xhdGVUb0NvbnRhaW5lckZ1bGxuYW1lKHR5cGUsIG1vZHVsZU5hbWUpIHsKICAgICAgbGV0IHByZWZpeCA9IHRoaXMucHJlZml4KHsgdHlwZSB9KTsKCiAgICAgIC8vIE5vdGU6IHVzaW5nIHN0cmluZyBtYW5pcHVsYXRpb24gaGVyZSByYXRoZXIgdGhhbiByZWdleGVzIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2UuCiAgICAgIC8vIHBvZCBtb2R1bGVzCiAgICAgIC8vICdeJyArIHByZWZpeCArICcvKC4rKS8nICsgdHlwZSArICckJwogICAgICBsZXQgcG9kUHJlZml4ID0gcHJlZml4ICsgJy8nOwogICAgICBsZXQgcG9kU3VmZml4ID0gJy8nICsgdHlwZTsKICAgICAgbGV0IHN0YXJ0ID0gbW9kdWxlTmFtZS5pbmRleE9mKHBvZFByZWZpeCk7CiAgICAgIGxldCBlbmQgPSBtb2R1bGVOYW1lLmluZGV4T2YocG9kU3VmZml4KTsKCiAgICAgIGlmIChzdGFydCA9PT0gMCAmJiBlbmQgPT09IG1vZHVsZU5hbWUubGVuZ3RoIC0gcG9kU3VmZml4Lmxlbmd0aCAmJiBtb2R1bGVOYW1lLmxlbmd0aCA+IHBvZFByZWZpeC5sZW5ndGggKyBwb2RTdWZmaXgubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHR5cGUgKyAnOicgKyBtb2R1bGVOYW1lLnNsaWNlKHN0YXJ0ICsgcG9kUHJlZml4Lmxlbmd0aCwgZW5kKTsKICAgICAgfQoKICAgICAgLy8gbm9uLXBvZCBtb2R1bGVzCiAgICAgIC8vICdeJyArIHByZWZpeCArICcvJyArIHBsdXJhbGl6ZWRUeXBlICsgJy8oLispJCcKICAgICAgbGV0IHBsdXJhbGl6ZWRUeXBlID0gdGhpcy5wbHVyYWxpemUodHlwZSk7CiAgICAgIGxldCBub25Qb2RQcmVmaXggPSBwcmVmaXggKyAnLycgKyBwbHVyYWxpemVkVHlwZSArICcvJzsKCiAgICAgIGlmIChtb2R1bGVOYW1lLmluZGV4T2Yobm9uUG9kUHJlZml4KSA9PT0gMCAmJiBtb2R1bGVOYW1lLmxlbmd0aCA+IG5vblBvZFByZWZpeC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gdHlwZSArICc6JyArIG1vZHVsZU5hbWUuc2xpY2Uobm9uUG9kUHJlZml4Lmxlbmd0aCk7CiAgICAgIH0KICAgIH0sCgogICAgX2V4dHJhY3REZWZhdWx0RXhwb3J0KG5vcm1hbGl6ZWRNb2R1bGVOYW1lKSB7CiAgICAgIGxldCBtb2R1bGUgPSByZXF1aXJlKG5vcm1hbGl6ZWRNb2R1bGVOYW1lLCBudWxsLCBudWxsLCB0cnVlIC8qIGZvcmNlIHN5bmMgKi8pOwoKICAgICAgaWYgKG1vZHVsZSAmJiBtb2R1bGVbJ2RlZmF1bHQnXSkgewogICAgICAgIG1vZHVsZSA9IG1vZHVsZVsnZGVmYXVsdCddOwogICAgICB9CgogICAgICByZXR1cm4gbW9kdWxlOwogICAgfQogIH0pOwoKICBSZXNvbHZlci5yZW9wZW5DbGFzcyh7CiAgICBtb2R1bGVCYXNlZFJlc29sdmVyOiB0cnVlCiAgfSk7CgogIGV4cG9ydHMuZGVmYXVsdCA9IFJlc29sdmVyOwp9KTsKO2RlZmluZSgnZW1iZXItcmVzb2x2ZXIvdXRpbHMvY2xhc3MtZmFjdG9yeScsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBjbGFzc0ZhY3Rvcnk7CiAgZnVuY3Rpb24gY2xhc3NGYWN0b3J5KGtsYXNzKSB7CiAgICByZXR1cm4gewogICAgICBjcmVhdGUoaW5qZWN0aW9ucykgewogICAgICAgIGlmICh0eXBlb2Yga2xhc3MuZXh0ZW5kID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4ga2xhc3MuZXh0ZW5kKGluamVjdGlvbnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga2xhc3M7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KfSk7CjtkZWZpbmUoJ2VtYmVyLXJlc29sdmVyL3V0aWxzL21ha2UtZGljdGlvbmFyeScsIFsnZXhwb3J0cyddLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBtYWtlRGljdGlvbmFyeTsKICBmdW5jdGlvbiBtYWtlRGljdGlvbmFyeSgpIHsKICAgIGxldCBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBjYWNoZVsnX2RpY3QnXSA9IG51bGw7CiAgICBkZWxldGUgY2FjaGVbJ19kaWN0J107CiAgICByZXR1cm4gY2FjaGU7CiAgfQp9KTsKO2RlZmluZSgnZW1iZXItd2VsY29tZS1wYWdlL2NvbXBvbmVudHMvd2VsY29tZS1wYWdlJywgWydleHBvcnRzJywgJ2VtYmVyLXdlbGNvbWUtcGFnZS90ZW1wbGF0ZXMvY29tcG9uZW50cy93ZWxjb21lLXBhZ2UnXSwgZnVuY3Rpb24gKGV4cG9ydHMsIF93ZWxjb21lUGFnZSkgewogICd1c2Ugc3RyaWN0JzsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5Db21wb25lbnQuZXh0ZW5kKHsKICAgIGxheW91dDogX3dlbGNvbWVQYWdlLmRlZmF1bHQsCgogICAgZW1iZXJWZXJzaW9uOiBFbWJlci5jb21wdXRlZChmdW5jdGlvbiAoKSB7CiAgICAgIGxldCBbbWFqb3IsIG1pbm9yXSA9IEVtYmVyLlZFUlNJT04uc3BsaXQoIi4iKTsKCiAgICAgIHJldHVybiBgJHttYWpvcn0uJHttaW5vcn0uMGA7CiAgICB9KQogIH0pOwp9KTsKO2RlZmluZSgiZW1iZXItd2VsY29tZS1wYWdlL3RlbXBsYXRlcy9jb21wb25lbnRzL3dlbGNvbWUtcGFnZSIsIFsiZXhwb3J0cyJdLCBmdW5jdGlvbiAoZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTsKICBleHBvcnRzLmRlZmF1bHQgPSBFbWJlci5IVE1MQmFycy50ZW1wbGF0ZSh7ICJpZCI6ICJWWlJzMWdNOCIsICJibG9jayI6ICJ7XCJzeW1ib2xzXCI6W10sXCJzdGF0ZW1lbnRzXCI6W1s3LFwiZGl2XCJdLFsxMSxcImlkXCIsXCJlbWJlci13ZWxjb21lLXBhZ2UtaWQtc2VsZWN0b3JcIl0sWzEyLFwiZGF0YS1lbWJlci12ZXJzaW9uXCIsWzI4LFtbMjEsXCJlbWJlclZlcnNpb25cIl1dXV0sWzldLFswLFwiXFxuICBcIl0sWzcsXCJkaXZcIl0sWzExLFwiY2xhc3NcIixcImNvbHVtbnNcIl0sWzldLFswLFwiXFxuICAgIFwiXSxbNyxcImRpdlwiXSxbMTEsXCJjbGFzc1wiLFwidG9tc3RlclwiXSxbOV0sWzAsXCJcXG4gICAgICBcIl0sWzcsXCJpbWdcIl0sWzExLFwic3JjXCIsXCJlbWJlci13ZWxjb21lLXBhZ2UvaW1hZ2VzL2NvbnN0cnVjdGlvbi5wbmdcIl0sWzExLFwiYWx0XCIsXCJVbmRlciBjb25zdHJ1Y3Rpb25cIl0sWzldLFsxMF0sWzAsXCJcXG4gICAgXCJdLFsxMF0sWzAsXCJcXG4gICAgXCJdLFs3LFwiZGl2XCJdLFsxMSxcImNsYXNzXCIsXCJ3ZWxjb21lXCJdLFs5XSxbMCxcIlxcbiAgICAgIFwiXSxbNyxcImgyXCJdLFsxMSxcImlkXCIsXCJ0aXRsZVwiXSxbOV0sWzAsXCJDb25ncmF0dWxhdGlvbnMsIHlvdSBtYWRlIGl0IVwiXSxbMTBdLFswLFwiXFxuXFxuICAgICAgXCJdLFs3LFwicFwiXSxbOV0sWzAsXCJZb3XigJl2ZSBvZmZpY2lhbGx5IHNwdW4gdXAgeW91ciB2ZXJ5IGZpcnN0IEVtYmVyIGFwcCA6LSlcIl0sWzEwXSxbMCxcIlxcbiAgICAgIFwiXSxbNyxcInBcIl0sWzldLFswLFwiWW914oCZdmUgZ290IG9uZSBtb3JlIGRlY2lzaW9uIHRvIG1ha2U6IHdoYXQgZG8geW91IHdhbnQgdG8gZG8gbmV4dD8gV2XigJlkIHN1Z2dlc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgdG8gaGVscCB5b3UgZ2V0IGdvaW5nOlwiXSxbMTBdLFswLFwiXFxuICAgICAgXCJdLFs3LFwib2xcIl0sWzldLFswLFwiXFxuICAgICAgICBcIl0sWzcsXCJsaVwiXSxbOV0sWzcsXCJhXCJdLFsxMixcImhyZWZcIixbMjgsW1wiaHR0cHM6Ly9ndWlkZXMuZW1iZXJqcy5jb20vdlwiLFsyMSxcImVtYmVyVmVyc2lvblwiXSxcIi9nZXR0aW5nLXN0YXJ0ZWQvcXVpY2stc3RhcnQvXCJdXV0sWzldLFswLFwiUXVpY2sgU3RhcnRcIl0sWzEwXSxbMCxcIiAtIGEgcXVpY2sgaW50cm9kdWN0aW9uIHRvIGhvdyBFbWJlciB3b3Jrcy4gTGVhcm4gYWJvdXQgZGVmaW5pbmcgeW91ciBmaXJzdCByb3V0ZSwgd3JpdGluZyBhIFVJIGNvbXBvbmVudCBhbmQgZGVwbG95aW5nIHlvdXIgYXBwbGljYXRpb24uXCJdLFsxMF0sWzAsXCJcXG4gICAgICAgIFwiXSxbNyxcImxpXCJdLFs5XSxbNyxcImFcIl0sWzEyLFwiaHJlZlwiLFsyOCxbXCJodHRwczovL2d1aWRlcy5lbWJlcmpzLmNvbS92XCIsWzIxLFwiZW1iZXJWZXJzaW9uXCJdLFwiL3R1dG9yaWFsL2VtYmVyLWNsaS9cIl1dXSxbOV0sWzAsXCJFbWJlciBHdWlkZXNcIl0sWzEwXSxbMCxcIiAtIHRoaXMgaXMgb3VyIG1vcmUgdGhvcm91Z2gsIGhhbmRzLW9uIGludHJvIHRvIEVtYmVyLiBZb3VyIGNyYXNoIGNvdXJzZSBpbiBFbWJlciBwaGlsb3NvcGh5LCBiYWNrZ3JvdW5kIGFuZCBzb21lIGluLWRlcHRoIGRpc2N1c3Npb24gb2YgaG93IHRoaW5ncyB3b3JrIChhbmQgd2h5IHRoZXkgd29yayB0aGUgd2F5IHRoZXkgZG8pLlwiXSxbMTBdLFswLFwiXFxuICAgICAgXCJdLFsxMF0sWzAsXCJcXG4gICAgICBcIl0sWzcsXCJwXCJdLFs5XSxbMCxcIklmIHlvdSBydW4gaW50byBwcm9ibGVtcywgeW91IGNhbiBjaGVjayBcIl0sWzcsXCJhXCJdLFsxMSxcImhyZWZcIixcImh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvdGFnZ2VkL2VtYmVyLmpzXCJdLFs5XSxbMCxcIlN0YWNrIE92ZXJmbG93XCJdLFsxMF0sWzAsXCIgb3IgXCJdLFs3LFwiYVwiXSxbMTEsXCJocmVmXCIsXCJodHRwOi8vZGlzY3Vzcy5lbWJlcmpzLmNvbS9cIl0sWzldLFswLFwib3VyIGZvcnVtc1wiXSxbMTBdLFswLFwiICBmb3IgaWRlYXMgYW5kIGFuc3dlcnPigJRzb21lb25l4oCZcyBwcm9iYWJseSBiZWVuIHRocm91Z2ggdGhlIHNhbWUgdGhpbmcgYW5kIGFscmVhZHkgcG9zdGVkIGFuIGFuc3dlci4gIElmIG5vdCwgeW91IGNhbiBwb3N0IHlvdXIgXCJdLFs3LFwic3Ryb25nXCJdLFs5XSxbMCxcIm93blwiXSxbMTBdLFswLFwiIHF1ZXN0aW9uLiBQZW9wbGUgbG92ZSB0byBoZWxwIG5ldyBFbWJlciBkZXZlbG9wZXJzIGdldCBzdGFydGVkLCBhbmQgb3VyIFwiXSxbNyxcImFcIl0sWzExLFwiaHJlZlwiLFwiaHR0cHM6Ly9lbWJlcmpzLmNvbS9jb21tdW5pdHkvXCJdLFs5XSxbMCxcIkVtYmVyIENvbW11bml0eVwiXSxbMTBdLFswLFwiIGlzIGluY3JlZGlibHkgc3VwcG9ydGl2ZS5cIl0sWzEwXSxbMCxcIlxcbiAgICBcIl0sWzEwXSxbMCxcIlxcbiAgXCJdLFsxMF0sWzAsXCJcXG4gICAgXCJdLFs3LFwicFwiXSxbMTEsXCJjbGFzc1wiLFwicG9zdHNjcmlwdFwiXSxbOV0sWzAsXCJUbyByZW1vdmUgdGhpcyB3ZWxjb21lIG1lc3NhZ2UsIHJlbW92ZSB0aGUgXCJdLFs3LFwiY29kZVwiXSxbOV0sWzAsXCJ7e3dlbGNvbWUtcGFnZX19XCJdLFsxMF0sWzAsXCIgY29tcG9uZW50IGZyb20geW91ciBcIl0sWzcsXCJjb2RlXCJdLFs5XSxbMCxcImFwcGxpY2F0aW9uLmhic1wiXSxbMTBdLFswLFwiIGZpbGUuXCJdLFs3LFwiYnJcIl0sWzldLFsxMF0sWzAsXCJZb3UnbGwgc2VlIHRoaXMgcGFnZSB1cGRhdGUgc29vbiBhZnRlciFcIl0sWzEwXSxbMCxcIlxcblwiXSxbMTBdLFswLFwiXFxuXCJdXSxcImhhc0V2YWxcIjpmYWxzZX0iLCAibWV0YSI6IHsgIm1vZHVsZU5hbWUiOiAiZW1iZXItd2VsY29tZS1wYWdlL3RlbXBsYXRlcy9jb21wb25lbnRzL3dlbGNvbWUtcGFnZS5oYnMiIH0gfSk7Cn0pOwo7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXZlbmRvci5tYXAK",
            "encoding": "base64"
          },
          "redirectURL": "",
          "headersSize": 329,
          "bodySize": 600563,
          "_transferSize": 600892
        },
        "cache": {},
        "timings": {
          "blocked": 7.341002000000881,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.02400000000000002,
          "wait": 81.24200000116392,
          "receive": 117.8780000009283,
          "_blocked_queueing": 1.0020000008807983
        },
        "serverIPAddress": "[::1]",
        "connection": "142391",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.861Z",
        "time": 90.64137700013694,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/assets/proxy-app.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 428,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Content-Encoding",
              "value": "gzip"
            },
            {
              "name": "Last-Modified",
              "value": "Wed, 01 Aug 2018 00:24:24 GMT"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "Content-Type",
              "value": "application/javascript; charset=utf-8"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "Transfer-Encoding",
              "value": "chunked"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            }
          ],
          "cookies": [],
          "content": {
            "size": 8140,
            "mimeType": "application/javascript",
            "compression": 6130,
            "text": "\"use strict\";\n\n\n\n;define('proxy-app/app', ['exports', 'proxy-app/resolver', 'ember-load-initializers', 'proxy-app/config/environment'], function (exports, _resolver, _emberLoadInitializers, _environment) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n\n\n  const App = Ember.Application.extend({\n    modulePrefix: _environment.default.modulePrefix,\n    podModulePrefix: _environment.default.podModulePrefix,\n    Resolver: _resolver.default\n  });\n\n  (0, _emberLoadInitializers.default)(App, _environment.default.modulePrefix);\n\n  exports.default = App;\n});\n;define('proxy-app/components/welcome-page', ['exports', 'ember-welcome-page/components/welcome-page'], function (exports, _welcomePage) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(exports, 'default', {\n    enumerable: true,\n    get: function () {\n      return _welcomePage.default;\n    }\n  });\n});\n;define('proxy-app/helpers/app-version', ['exports', 'proxy-app/config/environment', 'ember-cli-app-version/utils/regexp'], function (exports, _environment, _regexp) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.appVersion = appVersion;\n  function appVersion(_, hash = {}) {\n    const version = _environment.default.APP.version;\n    // e.g. 1.0.0-alpha.1+4jds75hf\n\n    // Allow use of 'hideSha' and 'hideVersion' For backwards compatibility\n    let versionOnly = hash.versionOnly || hash.hideSha;\n    let shaOnly = hash.shaOnly || hash.hideVersion;\n\n    let match = null;\n\n    if (versionOnly) {\n      if (hash.showExtended) {\n        match = version.match(_regexp.versionExtendedRegExp); // 1.0.0-alpha.1\n      }\n      // Fallback to just version\n      if (!match) {\n        match = version.match(_regexp.versionRegExp); // 1.0.0\n      }\n    }\n\n    if (shaOnly) {\n      match = version.match(_regexp.shaRegExp); // 4jds75hf\n    }\n\n    return match ? match[0] : version;\n  }\n\n  exports.default = Ember.Helper.helper(appVersion);\n});\n;define('proxy-app/helpers/pluralize', ['exports', 'ember-inflector/lib/helpers/pluralize'], function (exports, _pluralize) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = _pluralize.default;\n});\n;define('proxy-app/helpers/singularize', ['exports', 'ember-inflector/lib/helpers/singularize'], function (exports, _singularize) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = _singularize.default;\n});\n;define('proxy-app/initializers/app-version', ['exports', 'ember-cli-app-version/initializer-factory', 'proxy-app/config/environment'], function (exports, _initializerFactory, _environment) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n\n\n  let name, version;\n  if (_environment.default.APP) {\n    name = _environment.default.APP.name;\n    version = _environment.default.APP.version;\n  }\n\n  exports.default = {\n    name: 'App Version',\n    initialize: (0, _initializerFactory.default)(name, version)\n  };\n});\n;define('proxy-app/initializers/container-debug-adapter', ['exports', 'ember-resolver/resolvers/classic/container-debug-adapter'], function (exports, _containerDebugAdapter) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = {\n    name: 'container-debug-adapter',\n\n    initialize() {\n      let app = arguments[1] || arguments[0];\n\n      app.register('container-debug-adapter:main', _containerDebugAdapter.default);\n      app.inject('container-debug-adapter:main', 'namespace', 'application:main');\n    }\n  };\n});\n;define('proxy-app/initializers/ember-data', ['exports', 'ember-data/setup-container', 'ember-data'], function (exports, _setupContainer) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = {\n    name: 'ember-data',\n    initialize: _setupContainer.default\n  };\n});\n;define('proxy-app/initializers/export-application-global', ['exports', 'proxy-app/config/environment'], function (exports, _environment) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.initialize = initialize;\n  function initialize() {\n    var application = arguments[1] || arguments[0];\n    if (_environment.default.exportApplicationGlobal !== false) {\n      var theGlobal;\n      if (typeof window !== 'undefined') {\n        theGlobal = window;\n      } else if (typeof global !== 'undefined') {\n        theGlobal = global;\n      } else if (typeof self !== 'undefined') {\n        theGlobal = self;\n      } else {\n        // no reasonable global, just bail\n        return;\n      }\n\n      var value = _environment.default.exportApplicationGlobal;\n      var globalName;\n\n      if (typeof value === 'string') {\n        globalName = value;\n      } else {\n        globalName = Ember.String.classify(_environment.default.modulePrefix);\n      }\n\n      if (!theGlobal[globalName]) {\n        theGlobal[globalName] = application;\n\n        application.reopen({\n          willDestroy: function () {\n            this._super.apply(this, arguments);\n            delete theGlobal[globalName];\n          }\n        });\n      }\n    }\n  }\n\n  exports.default = {\n    name: 'export-application-global',\n\n    initialize: initialize\n  };\n});\n;define(\"proxy-app/instance-initializers/ember-data\", [\"exports\", \"ember-data/initialize-store-service\"], function (exports, _initializeStoreService) {\n  \"use strict\";\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = {\n    name: \"ember-data\",\n    initialize: _initializeStoreService.default\n  };\n});\n;define('proxy-app/resolver', ['exports', 'ember-resolver'], function (exports, _emberResolver) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = _emberResolver.default;\n});\n;define('proxy-app/router', ['exports', 'proxy-app/config/environment'], function (exports, _environment) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n\n\n  const Router = Ember.Router.extend({\n    location: _environment.default.locationType,\n    rootURL: _environment.default.rootURL\n  });\n\n  Router.map(function () {});\n\n  exports.default = Router;\n});\n;define('proxy-app/routes/application', ['exports'], function (exports) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = Ember.Route.extend({\n    model() {\n      return fetch('api/profile.json').then(response => {\n        return response.json();\n      });\n    }\n  });\n});\n;define('proxy-app/services/ajax', ['exports', 'ember-ajax/services/ajax'], function (exports, _ajax) {\n  'use strict';\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  Object.defineProperty(exports, 'default', {\n    enumerable: true,\n    get: function () {\n      return _ajax.default;\n    }\n  });\n});\n;define(\"proxy-app/templates/application\", [\"exports\"], function (exports) {\n  \"use strict\";\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = Ember.HTMLBars.template({ \"id\": \"pR9QxS3u\", \"block\": \"{\\\"symbols\\\":[],\\\"statements\\\":[[1,[21,\\\"outlet\\\"],false]],\\\"hasEval\\\":false}\", \"meta\": { \"moduleName\": \"proxy-app/templates/application.hbs\" } });\n});\n;\n\n;define('proxy-app/config/environment', [], function() {\n  var prefix = 'proxy-app';\ntry {\n  var metaName = prefix + '/config/environment';\n  var rawConfig = document.querySelector('meta[name=\"' + metaName + '\"]').getAttribute('content');\n  var config = JSON.parse(unescape(rawConfig));\n\n  var exports = { 'default': config };\n\n  Object.defineProperty(exports, '__esModule', { value: true });\n\n  return exports;\n}\ncatch(err) {\n  throw new Error('Could not read config from meta tag with name \"' + metaName + '\".');\n}\n\n});\n\n;\n          if (!runningTests) {\n            require(\"proxy-app/app\")[\"default\"].create({\"name\":\"proxy-app\",\"version\":\"0.0.0+881d7dc7\"});\n          }\n        \n//# sourceMappingURL=proxy-app.map\n"
          },
          "redirectURL": "",
          "headersSize": 329,
          "bodySize": 2010,
          "_transferSize": 2339
        },
        "cache": {},
        "timings": {
          "blocked": 6.386377000000502,
          "dns": 0.006000000000000227,
          "ssl": -1,
          "connect": 0.18299999999999983,
          "send": 0.9320000000000004,
          "wait": 80.13600000020233,
          "receive": 2.997999999934109,
          "_blocked_queueing": 1.3770000005024485
        },
        "serverIPAddress": "[::1]",
        "connection": "142531",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:08.873Z",
        "time": 81.02187600178513,
        "request": {
          "method": "GET",
          "url": "http://localhost:7021/livereload.js",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:7021"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 422,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Date",
              "value": "Wed, 01 Aug 2018 00:25:08 GMT"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Transfer-Encoding",
              "value": "chunked"
            },
            {
              "name": "Content-Type",
              "value": "application/javascript"
            }
          ],
          "cookies": [],
          "content": {
            "size": 39120,
            "mimeType": "application/javascript",
            "compression": -13,
            "text": "(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n(function() {\n  var Connector, PROTOCOL_6, PROTOCOL_7, Parser, Version, _ref;\n\n  _ref = require('./protocol'), Parser = _ref.Parser, PROTOCOL_6 = _ref.PROTOCOL_6, PROTOCOL_7 = _ref.PROTOCOL_7;\n\n  Version = '2.2.2';\n\n  exports.Connector = Connector = (function() {\n    function Connector(options, WebSocket, Timer, handlers) {\n      var path;\n      this.options = options;\n      this.WebSocket = WebSocket;\n      this.Timer = Timer;\n      this.handlers = handlers;\n      path = this.options.path ? \"\" + this.options.path : \"livereload\";\n      this._uri = \"ws\" + (this.options.https ? \"s\" : \"\") + \"://\" + this.options.host + \":\" + this.options.port + \"/\" + path;\n      this._nextDelay = this.options.mindelay;\n      this._connectionDesired = false;\n      this.protocol = 0;\n      this.protocolParser = new Parser({\n        connected: (function(_this) {\n          return function(protocol) {\n            _this.protocol = protocol;\n            _this._handshakeTimeout.stop();\n            _this._nextDelay = _this.options.mindelay;\n            _this._disconnectionReason = 'broken';\n            return _this.handlers.connected(protocol);\n          };\n        })(this),\n        error: (function(_this) {\n          return function(e) {\n            _this.handlers.error(e);\n            return _this._closeOnError();\n          };\n        })(this),\n        message: (function(_this) {\n          return function(message) {\n            return _this.handlers.message(message);\n          };\n        })(this)\n      });\n      this._handshakeTimeout = new Timer((function(_this) {\n        return function() {\n          if (!_this._isSocketConnected()) {\n            return;\n          }\n          _this._disconnectionReason = 'handshake-timeout';\n          return _this.socket.close();\n        };\n      })(this));\n      this._reconnectTimer = new Timer((function(_this) {\n        return function() {\n          if (!_this._connectionDesired) {\n            return;\n          }\n          return _this.connect();\n        };\n      })(this));\n      this.connect();\n    }\n\n    Connector.prototype._isSocketConnected = function() {\n      return this.socket && this.socket.readyState === this.WebSocket.OPEN;\n    };\n\n    Connector.prototype.connect = function() {\n      this._connectionDesired = true;\n      if (this._isSocketConnected()) {\n        return;\n      }\n      this._reconnectTimer.stop();\n      this._disconnectionReason = 'cannot-connect';\n      this.protocolParser.reset();\n      this.handlers.connecting();\n      this.socket = new this.WebSocket(this._uri);\n      this.socket.onopen = (function(_this) {\n        return function(e) {\n          return _this._onopen(e);\n        };\n      })(this);\n      this.socket.onclose = (function(_this) {\n        return function(e) {\n          return _this._onclose(e);\n        };\n      })(this);\n      this.socket.onmessage = (function(_this) {\n        return function(e) {\n          return _this._onmessage(e);\n        };\n      })(this);\n      return this.socket.onerror = (function(_this) {\n        return function(e) {\n          return _this._onerror(e);\n        };\n      })(this);\n    };\n\n    Connector.prototype.disconnect = function() {\n      this._connectionDesired = false;\n      this._reconnectTimer.stop();\n      if (!this._isSocketConnected()) {\n        return;\n      }\n      this._disconnectionReason = 'manual';\n      return this.socket.close();\n    };\n\n    Connector.prototype._scheduleReconnection = function() {\n      if (!this._connectionDesired) {\n        return;\n      }\n      if (!this._reconnectTimer.running) {\n        this._reconnectTimer.start(this._nextDelay);\n        return this._nextDelay = Math.min(this.options.maxdelay, this._nextDelay * 2);\n      }\n    };\n\n    Connector.prototype.sendCommand = function(command) {\n      if (this.protocol == null) {\n        return;\n      }\n      return this._sendCommand(command);\n    };\n\n    Connector.prototype._sendCommand = function(command) {\n      return this.socket.send(JSON.stringify(command));\n    };\n\n    Connector.prototype._closeOnError = function() {\n      this._handshakeTimeout.stop();\n      this._disconnectionReason = 'error';\n      return this.socket.close();\n    };\n\n    Connector.prototype._onopen = function(e) {\n      var hello;\n      this.handlers.socketConnected();\n      this._disconnectionReason = 'handshake-failed';\n      hello = {\n        command: 'hello',\n        protocols: [PROTOCOL_6, PROTOCOL_7]\n      };\n      hello.ver = Version;\n      if (this.options.ext) {\n        hello.ext = this.options.ext;\n      }\n      if (this.options.extver) {\n        hello.extver = this.options.extver;\n      }\n      if (this.options.snipver) {\n        hello.snipver = this.options.snipver;\n      }\n      this._sendCommand(hello);\n      return this._handshakeTimeout.start(this.options.handshake_timeout);\n    };\n\n    Connector.prototype._onclose = function(e) {\n      this.protocol = 0;\n      this.handlers.disconnected(this._disconnectionReason, this._nextDelay);\n      return this._scheduleReconnection();\n    };\n\n    Connector.prototype._onerror = function(e) {};\n\n    Connector.prototype._onmessage = function(e) {\n      return this.protocolParser.process(e.data);\n    };\n\n    return Connector;\n\n  })();\n\n}).call(this);\n\n},{\"./protocol\":6}],2:[function(require,module,exports){\n(function() {\n  var CustomEvents;\n\n  CustomEvents = {\n    bind: function(element, eventName, handler) {\n      if (element.addEventListener) {\n        return element.addEventListener(eventName, handler, false);\n      } else if (element.attachEvent) {\n        element[eventName] = 1;\n        return element.attachEvent('onpropertychange', function(event) {\n          if (event.propertyName === eventName) {\n            return handler();\n          }\n        });\n      } else {\n        throw new Error(\"Attempt to attach custom event \" + eventName + \" to something which isn't a DOMElement\");\n      }\n    },\n    fire: function(element, eventName) {\n      var event;\n      if (element.addEventListener) {\n        event = document.createEvent('HTMLEvents');\n        event.initEvent(eventName, true, true);\n        return document.dispatchEvent(event);\n      } else if (element.attachEvent) {\n        if (element[eventName]) {\n          return element[eventName]++;\n        }\n      } else {\n        throw new Error(\"Attempt to fire custom event \" + eventName + \" on something which isn't a DOMElement\");\n      }\n    }\n  };\n\n  exports.bind = CustomEvents.bind;\n\n  exports.fire = CustomEvents.fire;\n\n}).call(this);\n\n},{}],3:[function(require,module,exports){\n(function() {\n  var LessPlugin;\n\n  module.exports = LessPlugin = (function() {\n    LessPlugin.identifier = 'less';\n\n    LessPlugin.version = '1.0';\n\n    function LessPlugin(window, host) {\n      this.window = window;\n      this.host = host;\n    }\n\n    LessPlugin.prototype.reload = function(path, options) {\n      if (this.window.less && this.window.less.refresh) {\n        if (path.match(/\\.less$/i)) {\n          return this.reloadLess(path);\n        }\n        if (options.originalPath.match(/\\.less$/i)) {\n          return this.reloadLess(options.originalPath);\n        }\n      }\n      return false;\n    };\n\n    LessPlugin.prototype.reloadLess = function(path) {\n      var link, links, _i, _len;\n      links = (function() {\n        var _i, _len, _ref, _results;\n        _ref = document.getElementsByTagName('link');\n        _results = [];\n        for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n          link = _ref[_i];\n          if (link.href && link.rel.match(/^stylesheet\\/less$/i) || (link.rel.match(/stylesheet/i) && link.type.match(/^text\\/(x-)?less$/i))) {\n            _results.push(link);\n          }\n        }\n        return _results;\n      })();\n      if (links.length === 0) {\n        return false;\n      }\n      for (_i = 0, _len = links.length; _i < _len; _i++) {\n        link = links[_i];\n        link.href = this.host.generateCacheBustUrl(link.href);\n      }\n      this.host.console.log(\"LiveReload is asking LESS to recompile all stylesheets\");\n      this.window.less.refresh(true);\n      return true;\n    };\n\n    LessPlugin.prototype.analyze = function() {\n      return {\n        disable: !!(this.window.less && this.window.less.refresh)\n      };\n    };\n\n    return LessPlugin;\n\n  })();\n\n}).call(this);\n\n},{}],4:[function(require,module,exports){\n(function() {\n  var Connector, LiveReload, Options, ProtocolError, Reloader, Timer,\n    __hasProp = {}.hasOwnProperty;\n\n  Connector = require('./connector').Connector;\n\n  Timer = require('./timer').Timer;\n\n  Options = require('./options').Options;\n\n  Reloader = require('./reloader').Reloader;\n\n  ProtocolError = require('./protocol').ProtocolError;\n\n  exports.LiveReload = LiveReload = (function() {\n    function LiveReload(window) {\n      var k, v, _ref;\n      this.window = window;\n      this.listeners = {};\n      this.plugins = [];\n      this.pluginIdentifiers = {};\n      this.console = this.window.console && this.window.console.log && this.window.console.error ? this.window.location.href.match(/LR-verbose/) ? this.window.console : {\n        log: function() {},\n        error: this.window.console.error.bind(this.window.console)\n      } : {\n        log: function() {},\n        error: function() {}\n      };\n      if (!(this.WebSocket = this.window.WebSocket || this.window.MozWebSocket)) {\n        this.console.error(\"LiveReload disabled because the browser does not seem to support web sockets\");\n        return;\n      }\n      if ('LiveReloadOptions' in window) {\n        this.options = new Options();\n        _ref = window['LiveReloadOptions'];\n        for (k in _ref) {\n          if (!__hasProp.call(_ref, k)) continue;\n          v = _ref[k];\n          this.options.set(k, v);\n        }\n      } else {\n        this.options = Options.extract(this.window.document);\n        if (!this.options) {\n          this.console.error(\"LiveReload disabled because it could not find its own <SCRIPT> tag\");\n          return;\n        }\n      }\n      this.reloader = new Reloader(this.window, this.console, Timer);\n      this.connector = new Connector(this.options, this.WebSocket, Timer, {\n        connecting: (function(_this) {\n          return function() {};\n        })(this),\n        socketConnected: (function(_this) {\n          return function() {};\n        })(this),\n        connected: (function(_this) {\n          return function(protocol) {\n            var _base;\n            if (typeof (_base = _this.listeners).connect === \"function\") {\n              _base.connect();\n            }\n            _this.log(\"LiveReload is connected to \" + _this.options.host + \":\" + _this.options.port + \" (protocol v\" + protocol + \").\");\n            return _this.analyze();\n          };\n        })(this),\n        error: (function(_this) {\n          return function(e) {\n            if (e instanceof ProtocolError) {\n              if (typeof console !== \"undefined\" && console !== null) {\n                return console.log(\"\" + e.message + \".\");\n              }\n            } else {\n              if (typeof console !== \"undefined\" && console !== null) {\n                return console.log(\"LiveReload internal error: \" + e.message);\n              }\n            }\n          };\n        })(this),\n        disconnected: (function(_this) {\n          return function(reason, nextDelay) {\n            var _base;\n            if (typeof (_base = _this.listeners).disconnect === \"function\") {\n              _base.disconnect();\n            }\n            switch (reason) {\n              case 'cannot-connect':\n                return _this.log(\"LiveReload cannot connect to \" + _this.options.host + \":\" + _this.options.port + \", will retry in \" + nextDelay + \" sec.\");\n              case 'broken':\n                return _this.log(\"LiveReload disconnected from \" + _this.options.host + \":\" + _this.options.port + \", reconnecting in \" + nextDelay + \" sec.\");\n              case 'handshake-timeout':\n                return _this.log(\"LiveReload cannot connect to \" + _this.options.host + \":\" + _this.options.port + \" (handshake timeout), will retry in \" + nextDelay + \" sec.\");\n              case 'handshake-failed':\n                return _this.log(\"LiveReload cannot connect to \" + _this.options.host + \":\" + _this.options.port + \" (handshake failed), will retry in \" + nextDelay + \" sec.\");\n              case 'manual':\n                break;\n              case 'error':\n                break;\n              default:\n                return _this.log(\"LiveReload disconnected from \" + _this.options.host + \":\" + _this.options.port + \" (\" + reason + \"), reconnecting in \" + nextDelay + \" sec.\");\n            }\n          };\n        })(this),\n        message: (function(_this) {\n          return function(message) {\n            switch (message.command) {\n              case 'reload':\n                return _this.performReload(message);\n              case 'alert':\n                return _this.performAlert(message);\n            }\n          };\n        })(this)\n      });\n      this.initialized = true;\n    }\n\n    LiveReload.prototype.on = function(eventName, handler) {\n      return this.listeners[eventName] = handler;\n    };\n\n    LiveReload.prototype.log = function(message) {\n      return this.console.log(\"\" + message);\n    };\n\n    LiveReload.prototype.performReload = function(message) {\n      var _ref, _ref1, _ref2;\n      this.log(\"LiveReload received reload request: \" + (JSON.stringify(message, null, 2)));\n      return this.reloader.reload(message.path, {\n        liveCSS: (_ref = message.liveCSS) != null ? _ref : true,\n        liveImg: (_ref1 = message.liveImg) != null ? _ref1 : true,\n        reloadMissingCSS: (_ref2 = message.reloadMissingCSS) != null ? _ref2 : true,\n        originalPath: message.originalPath || '',\n        overrideURL: message.overrideURL || '',\n        serverURL: \"http://\" + this.options.host + \":\" + this.options.port\n      });\n    };\n\n    LiveReload.prototype.performAlert = function(message) {\n      return alert(message.message);\n    };\n\n    LiveReload.prototype.shutDown = function() {\n      var _base;\n      if (!this.initialized) {\n        return;\n      }\n      this.connector.disconnect();\n      this.log(\"LiveReload disconnected.\");\n      return typeof (_base = this.listeners).shutdown === \"function\" ? _base.shutdown() : void 0;\n    };\n\n    LiveReload.prototype.hasPlugin = function(identifier) {\n      return !!this.pluginIdentifiers[identifier];\n    };\n\n    LiveReload.prototype.addPlugin = function(pluginClass) {\n      var plugin;\n      if (!this.initialized) {\n        return;\n      }\n      if (this.hasPlugin(pluginClass.identifier)) {\n        return;\n      }\n      this.pluginIdentifiers[pluginClass.identifier] = true;\n      plugin = new pluginClass(this.window, {\n        _livereload: this,\n        _reloader: this.reloader,\n        _connector: this.connector,\n        console: this.console,\n        Timer: Timer,\n        generateCacheBustUrl: (function(_this) {\n          return function(url) {\n            return _this.reloader.generateCacheBustUrl(url);\n          };\n        })(this)\n      });\n      this.plugins.push(plugin);\n      this.reloader.addPlugin(plugin);\n    };\n\n    LiveReload.prototype.analyze = function() {\n      var plugin, pluginData, pluginsData, _i, _len, _ref;\n      if (!this.initialized) {\n        return;\n      }\n      if (!(this.connector.protocol >= 7)) {\n        return;\n      }\n      pluginsData = {};\n      _ref = this.plugins;\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        plugin = _ref[_i];\n        pluginsData[plugin.constructor.identifier] = pluginData = (typeof plugin.analyze === \"function\" ? plugin.analyze() : void 0) || {};\n        pluginData.version = plugin.constructor.version;\n      }\n      this.connector.sendCommand({\n        command: 'info',\n        plugins: pluginsData,\n        url: this.window.location.href\n      });\n    };\n\n    return LiveReload;\n\n  })();\n\n}).call(this);\n\n},{\"./connector\":1,\"./options\":5,\"./protocol\":6,\"./reloader\":7,\"./timer\":9}],5:[function(require,module,exports){\n(function() {\n  var Options;\n\n  exports.Options = Options = (function() {\n    function Options() {\n      this.https = false;\n      this.host = null;\n      this.port = 35729;\n      this.snipver = null;\n      this.ext = null;\n      this.extver = null;\n      this.mindelay = 1000;\n      this.maxdelay = 60000;\n      this.handshake_timeout = 5000;\n    }\n\n    Options.prototype.set = function(name, value) {\n      if (typeof value === 'undefined') {\n        return;\n      }\n      if (!isNaN(+value)) {\n        value = +value;\n      }\n      return this[name] = value;\n    };\n\n    return Options;\n\n  })();\n\n  Options.extract = function(document) {\n    var element, keyAndValue, m, mm, options, pair, src, _i, _j, _len, _len1, _ref, _ref1;\n    _ref = document.getElementsByTagName('script');\n    for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n      element = _ref[_i];\n      if ((src = element.src) && (m = src.match(/^[^:]+:\\/\\/(.*)\\/z?livereload\\.js(?:\\?(.*))?$/))) {\n        options = new Options();\n        options.https = src.indexOf(\"https\") === 0;\n        if (mm = m[1].match(/^([^\\/:]+)(?::(\\d+))?$/)) {\n          options.host = mm[1];\n          if (mm[2]) {\n            options.port = parseInt(mm[2], 10);\n          }\n        }\n        if (m[2]) {\n          _ref1 = m[2].split('&');\n          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {\n            pair = _ref1[_j];\n            if ((keyAndValue = pair.split('=')).length > 1) {\n              options.set(keyAndValue[0].replace(/-/g, '_'), keyAndValue.slice(1).join('='));\n            }\n          }\n        }\n        return options;\n      }\n    }\n    return null;\n  };\n\n}).call(this);\n\n},{}],6:[function(require,module,exports){\n(function() {\n  var PROTOCOL_6, PROTOCOL_7, Parser, ProtocolError,\n    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\n  exports.PROTOCOL_6 = PROTOCOL_6 = 'http://livereload.com/protocols/official-6';\n\n  exports.PROTOCOL_7 = PROTOCOL_7 = 'http://livereload.com/protocols/official-7';\n\n  exports.ProtocolError = ProtocolError = (function() {\n    function ProtocolError(reason, data) {\n      this.message = \"LiveReload protocol error (\" + reason + \") after receiving data: \\\"\" + data + \"\\\".\";\n    }\n\n    return ProtocolError;\n\n  })();\n\n  exports.Parser = Parser = (function() {\n    function Parser(handlers) {\n      this.handlers = handlers;\n      this.reset();\n    }\n\n    Parser.prototype.reset = function() {\n      return this.protocol = null;\n    };\n\n    Parser.prototype.process = function(data) {\n      var command, e, message, options, _ref;\n      try {\n        if (this.protocol == null) {\n          if (data.match(/^!!ver:([\\d.]+)$/)) {\n            this.protocol = 6;\n          } else if (message = this._parseMessage(data, ['hello'])) {\n            if (!message.protocols.length) {\n              throw new ProtocolError(\"no protocols specified in handshake message\");\n            } else if (__indexOf.call(message.protocols, PROTOCOL_7) >= 0) {\n              this.protocol = 7;\n            } else if (__indexOf.call(message.protocols, PROTOCOL_6) >= 0) {\n              this.protocol = 6;\n            } else {\n              throw new ProtocolError(\"no supported protocols found\");\n            }\n          }\n          return this.handlers.connected(this.protocol);\n        } else if (this.protocol === 6) {\n          message = JSON.parse(data);\n          if (!message.length) {\n            throw new ProtocolError(\"protocol 6 messages must be arrays\");\n          }\n          command = message[0], options = message[1];\n          if (command !== 'refresh') {\n            throw new ProtocolError(\"unknown protocol 6 command\");\n          }\n          return this.handlers.message({\n            command: 'reload',\n            path: options.path,\n            liveCSS: (_ref = options.apply_css_live) != null ? _ref : true\n          });\n        } else {\n          message = this._parseMessage(data, ['reload', 'alert']);\n          return this.handlers.message(message);\n        }\n      } catch (_error) {\n        e = _error;\n        if (e instanceof ProtocolError) {\n          return this.handlers.error(e);\n        } else {\n          throw e;\n        }\n      }\n    };\n\n    Parser.prototype._parseMessage = function(data, validCommands) {\n      var e, message, _ref;\n      try {\n        message = JSON.parse(data);\n      } catch (_error) {\n        e = _error;\n        throw new ProtocolError('unparsable JSON', data);\n      }\n      if (!message.command) {\n        throw new ProtocolError('missing \"command\" key', data);\n      }\n      if (_ref = message.command, __indexOf.call(validCommands, _ref) < 0) {\n        throw new ProtocolError(\"invalid command '\" + message.command + \"', only valid commands are: \" + (validCommands.join(', ')) + \")\", data);\n      }\n      return message;\n    };\n\n    return Parser;\n\n  })();\n\n}).call(this);\n\n},{}],7:[function(require,module,exports){\n(function() {\n  var IMAGE_STYLES, Reloader, numberOfMatchingSegments, pathFromUrl, pathsMatch, pickBestMatch, splitUrl;\n\n  splitUrl = function(url) {\n    var comboSign, hash, index, params;\n    if ((index = url.indexOf('#')) >= 0) {\n      hash = url.slice(index);\n      url = url.slice(0, index);\n    } else {\n      hash = '';\n    }\n    comboSign = url.indexOf('??');\n    if (comboSign >= 0) {\n      if (comboSign + 1 !== url.lastIndexOf('?')) {\n        index = url.lastIndexOf('?');\n      }\n    } else {\n      index = url.indexOf('?');\n    }\n    if (index >= 0) {\n      params = url.slice(index);\n      url = url.slice(0, index);\n    } else {\n      params = '';\n    }\n    return {\n      url: url,\n      params: params,\n      hash: hash\n    };\n  };\n\n  pathFromUrl = function(url) {\n    var path;\n    url = splitUrl(url).url;\n    if (url.indexOf('file://') === 0) {\n      path = url.replace(/^file:\\/\\/(localhost)?/, '');\n    } else {\n      path = url.replace(/^([^:]+:)?\\/\\/([^:\\/]+)(:\\d*)?\\//, '/');\n    }\n    return decodeURIComponent(path);\n  };\n\n  pickBestMatch = function(path, objects, pathFunc) {\n    var bestMatch, object, score, _i, _len;\n    bestMatch = {\n      score: 0\n    };\n    for (_i = 0, _len = objects.length; _i < _len; _i++) {\n      object = objects[_i];\n      score = numberOfMatchingSegments(path, pathFunc(object));\n      if (score > bestMatch.score) {\n        bestMatch = {\n          object: object,\n          score: score\n        };\n      }\n    }\n    if (bestMatch.score > 0) {\n      return bestMatch;\n    } else {\n      return null;\n    }\n  };\n\n  numberOfMatchingSegments = function(path1, path2) {\n    var comps1, comps2, eqCount, len;\n    path1 = path1.replace(/^\\/+/, '').toLowerCase();\n    path2 = path2.replace(/^\\/+/, '').toLowerCase();\n    if (path1 === path2) {\n      return 10000;\n    }\n    comps1 = path1.split('/').reverse();\n    comps2 = path2.split('/').reverse();\n    len = Math.min(comps1.length, comps2.length);\n    eqCount = 0;\n    while (eqCount < len && comps1[eqCount] === comps2[eqCount]) {\n      ++eqCount;\n    }\n    return eqCount;\n  };\n\n  pathsMatch = function(path1, path2) {\n    return numberOfMatchingSegments(path1, path2) > 0;\n  };\n\n  IMAGE_STYLES = [\n    {\n      selector: 'background',\n      styleNames: ['backgroundImage']\n    }, {\n      selector: 'border',\n      styleNames: ['borderImage', 'webkitBorderImage', 'MozBorderImage']\n    }\n  ];\n\n  exports.Reloader = Reloader = (function() {\n    function Reloader(window, console, Timer) {\n      this.window = window;\n      this.console = console;\n      this.Timer = Timer;\n      this.document = this.window.document;\n      this.importCacheWaitPeriod = 200;\n      this.plugins = [];\n    }\n\n    Reloader.prototype.addPlugin = function(plugin) {\n      return this.plugins.push(plugin);\n    };\n\n    Reloader.prototype.analyze = function(callback) {\n      return results;\n    };\n\n    Reloader.prototype.reload = function(path, options) {\n      var plugin, _base, _i, _len, _ref;\n      this.options = options;\n      if ((_base = this.options).stylesheetReloadTimeout == null) {\n        _base.stylesheetReloadTimeout = 15000;\n      }\n      _ref = this.plugins;\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        plugin = _ref[_i];\n        if (plugin.reload && plugin.reload(path, options)) {\n          return;\n        }\n      }\n      if (options.liveCSS && path.match(/\\.css(?:\\.map)?$/i)) {\n        if (this.reloadStylesheet(path)) {\n          return;\n        }\n      }\n      if (options.liveImg && path.match(/\\.(jpe?g|png|gif)$/i)) {\n        this.reloadImages(path);\n        return;\n      }\n      if (options.isChromeExtension) {\n        this.reloadChromeExtension();\n        return;\n      }\n      return this.reloadPage();\n    };\n\n    Reloader.prototype.reloadPage = function() {\n      return this.window.document.location.reload();\n    };\n\n    Reloader.prototype.reloadChromeExtension = function() {\n      return this.window.chrome.runtime.reload();\n    };\n\n    Reloader.prototype.reloadImages = function(path) {\n      var expando, img, selector, styleNames, styleSheet, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _results;\n      expando = this.generateUniqueString();\n      _ref = this.document.images;\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        img = _ref[_i];\n        if (pathsMatch(path, pathFromUrl(img.src))) {\n          img.src = this.generateCacheBustUrl(img.src, expando);\n        }\n      }\n      if (this.document.querySelectorAll) {\n        for (_j = 0, _len1 = IMAGE_STYLES.length; _j < _len1; _j++) {\n          _ref1 = IMAGE_STYLES[_j], selector = _ref1.selector, styleNames = _ref1.styleNames;\n          _ref2 = this.document.querySelectorAll(\"[style*=\" + selector + \"]\");\n          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {\n            img = _ref2[_k];\n            this.reloadStyleImages(img.style, styleNames, path, expando);\n          }\n        }\n      }\n      if (this.document.styleSheets) {\n        _ref3 = this.document.styleSheets;\n        _results = [];\n        for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {\n          styleSheet = _ref3[_l];\n          _results.push(this.reloadStylesheetImages(styleSheet, path, expando));\n        }\n        return _results;\n      }\n    };\n\n    Reloader.prototype.reloadStylesheetImages = function(styleSheet, path, expando) {\n      var e, rule, rules, styleNames, _i, _j, _len, _len1;\n      try {\n        rules = styleSheet != null ? styleSheet.cssRules : void 0;\n      } catch (_error) {\n        e = _error;\n      }\n      if (!rules) {\n        return;\n      }\n      for (_i = 0, _len = rules.length; _i < _len; _i++) {\n        rule = rules[_i];\n        switch (rule.type) {\n          case CSSRule.IMPORT_RULE:\n            this.reloadStylesheetImages(rule.styleSheet, path, expando);\n            break;\n          case CSSRule.STYLE_RULE:\n            for (_j = 0, _len1 = IMAGE_STYLES.length; _j < _len1; _j++) {\n              styleNames = IMAGE_STYLES[_j].styleNames;\n              this.reloadStyleImages(rule.style, styleNames, path, expando);\n            }\n            break;\n          case CSSRule.MEDIA_RULE:\n            this.reloadStylesheetImages(rule, path, expando);\n        }\n      }\n    };\n\n    Reloader.prototype.reloadStyleImages = function(style, styleNames, path, expando) {\n      var newValue, styleName, value, _i, _len;\n      for (_i = 0, _len = styleNames.length; _i < _len; _i++) {\n        styleName = styleNames[_i];\n        value = style[styleName];\n        if (typeof value === 'string') {\n          newValue = value.replace(/\\burl\\s*\\(([^)]*)\\)/, (function(_this) {\n            return function(match, src) {\n              if (pathsMatch(path, pathFromUrl(src))) {\n                return \"url(\" + (_this.generateCacheBustUrl(src, expando)) + \")\";\n              } else {\n                return match;\n              }\n            };\n          })(this));\n          if (newValue !== value) {\n            style[styleName] = newValue;\n          }\n        }\n      }\n    };\n\n    Reloader.prototype.reloadStylesheet = function(path) {\n      var imported, link, links, match, style, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1;\n      links = (function() {\n        var _i, _len, _ref, _results;\n        _ref = this.document.getElementsByTagName('link');\n        _results = [];\n        for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n          link = _ref[_i];\n          if (link.rel.match(/^stylesheet$/i) && !link.__LiveReload_pendingRemoval) {\n            _results.push(link);\n          }\n        }\n        return _results;\n      }).call(this);\n      imported = [];\n      _ref = this.document.getElementsByTagName('style');\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        style = _ref[_i];\n        if (style.sheet) {\n          this.collectImportedStylesheets(style, style.sheet, imported);\n        }\n      }\n      for (_j = 0, _len1 = links.length; _j < _len1; _j++) {\n        link = links[_j];\n        this.collectImportedStylesheets(link, link.sheet, imported);\n      }\n      if (this.window.StyleFix && this.document.querySelectorAll) {\n        _ref1 = this.document.querySelectorAll('style[data-href]');\n        for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n          style = _ref1[_k];\n          links.push(style);\n        }\n      }\n      this.console.log(\"LiveReload found \" + links.length + \" LINKed stylesheets, \" + imported.length + \" @imported stylesheets\");\n      match = pickBestMatch(path, links.concat(imported), (function(_this) {\n        return function(l) {\n          return pathFromUrl(_this.linkHref(l));\n        };\n      })(this));\n      if (match) {\n        if (match.object.rule) {\n          this.console.log(\"LiveReload is reloading imported stylesheet: \" + match.object.href);\n          this.reattachImportedRule(match.object);\n        } else {\n          this.console.log(\"LiveReload is reloading stylesheet: \" + (this.linkHref(match.object)));\n          this.reattachStylesheetLink(match.object);\n        }\n      } else {\n        if (this.options.reloadMissingCSS) {\n          this.console.log(\"LiveReload will reload all stylesheets because path '\" + path + \"' did not match any specific one. To disable this behavior, set 'options.reloadMissingCSS' to 'false'.\");\n          for (_l = 0, _len3 = links.length; _l < _len3; _l++) {\n            link = links[_l];\n            this.reattachStylesheetLink(link);\n          }\n        } else {\n          this.console.log(\"LiveReload will not reload path '\" + path + \"' because the stylesheet was not found on the page and 'options.reloadMissingCSS' was set to 'false'.\");\n        }\n      }\n      return true;\n    };\n\n    Reloader.prototype.collectImportedStylesheets = function(link, styleSheet, result) {\n      var e, index, rule, rules, _i, _len;\n      try {\n        rules = styleSheet != null ? styleSheet.cssRules : void 0;\n      } catch (_error) {\n        e = _error;\n      }\n      if (rules && rules.length) {\n        for (index = _i = 0, _len = rules.length; _i < _len; index = ++_i) {\n          rule = rules[index];\n          switch (rule.type) {\n            case CSSRule.CHARSET_RULE:\n              continue;\n            case CSSRule.IMPORT_RULE:\n              result.push({\n                link: link,\n                rule: rule,\n                index: index,\n                href: rule.href\n              });\n              this.collectImportedStylesheets(link, rule.styleSheet, result);\n              break;\n            default:\n              break;\n          }\n        }\n      }\n    };\n\n    Reloader.prototype.waitUntilCssLoads = function(clone, func) {\n      var callbackExecuted, executeCallback, poll;\n      callbackExecuted = false;\n      executeCallback = (function(_this) {\n        return function() {\n          if (callbackExecuted) {\n            return;\n          }\n          callbackExecuted = true;\n          return func();\n        };\n      })(this);\n      clone.onload = (function(_this) {\n        return function() {\n          _this.console.log(\"LiveReload: the new stylesheet has finished loading\");\n          _this.knownToSupportCssOnLoad = true;\n          return executeCallback();\n        };\n      })(this);\n      if (!this.knownToSupportCssOnLoad) {\n        (poll = (function(_this) {\n          return function() {\n            if (clone.sheet) {\n              _this.console.log(\"LiveReload is polling until the new CSS finishes loading...\");\n              return executeCallback();\n            } else {\n              return _this.Timer.start(50, poll);\n            }\n          };\n        })(this))();\n      }\n      return this.Timer.start(this.options.stylesheetReloadTimeout, executeCallback);\n    };\n\n    Reloader.prototype.linkHref = function(link) {\n      return link.href || link.getAttribute('data-href');\n    };\n\n    Reloader.prototype.reattachStylesheetLink = function(link) {\n      var clone, parent;\n      if (link.__LiveReload_pendingRemoval) {\n        return;\n      }\n      link.__LiveReload_pendingRemoval = true;\n      if (link.tagName === 'STYLE') {\n        clone = this.document.createElement('link');\n        clone.rel = 'stylesheet';\n        clone.media = link.media;\n        clone.disabled = link.disabled;\n      } else {\n        clone = link.cloneNode(false);\n      }\n      clone.href = this.generateCacheBustUrl(this.linkHref(link));\n      parent = link.parentNode;\n      if (parent.lastChild === link) {\n        parent.appendChild(clone);\n      } else {\n        parent.insertBefore(clone, link.nextSibling);\n      }\n      return this.waitUntilCssLoads(clone, (function(_this) {\n        return function() {\n          var additionalWaitingTime;\n          if (/AppleWebKit/.test(navigator.userAgent)) {\n            additionalWaitingTime = 5;\n          } else {\n            additionalWaitingTime = 200;\n          }\n          return _this.Timer.start(additionalWaitingTime, function() {\n            var _ref;\n            if (!link.parentNode) {\n              return;\n            }\n            link.parentNode.removeChild(link);\n            clone.onreadystatechange = null;\n            return (_ref = _this.window.StyleFix) != null ? _ref.link(clone) : void 0;\n          });\n        };\n      })(this));\n    };\n\n    Reloader.prototype.reattachImportedRule = function(_arg) {\n      var href, index, link, media, newRule, parent, rule, tempLink;\n      rule = _arg.rule, index = _arg.index, link = _arg.link;\n      parent = rule.parentStyleSheet;\n      href = this.generateCacheBustUrl(rule.href);\n      media = rule.media.length ? [].join.call(rule.media, ', ') : '';\n      newRule = \"@import url(\\\"\" + href + \"\\\") \" + media + \";\";\n      rule.__LiveReload_newHref = href;\n      tempLink = this.document.createElement(\"link\");\n      tempLink.rel = 'stylesheet';\n      tempLink.href = href;\n      tempLink.__LiveReload_pendingRemoval = true;\n      if (link.parentNode) {\n        link.parentNode.insertBefore(tempLink, link);\n      }\n      return this.Timer.start(this.importCacheWaitPeriod, (function(_this) {\n        return function() {\n          if (tempLink.parentNode) {\n            tempLink.parentNode.removeChild(tempLink);\n          }\n          if (rule.__LiveReload_newHref !== href) {\n            return;\n          }\n          parent.insertRule(newRule, index);\n          parent.deleteRule(index + 1);\n          rule = parent.cssRules[index];\n          rule.__LiveReload_newHref = href;\n          return _this.Timer.start(_this.importCacheWaitPeriod, function() {\n            if (rule.__LiveReload_newHref !== href) {\n              return;\n            }\n            parent.insertRule(newRule, index);\n            return parent.deleteRule(index + 1);\n          });\n        };\n      })(this));\n    };\n\n    Reloader.prototype.generateUniqueString = function() {\n      return 'livereload=' + Date.now();\n    };\n\n    Reloader.prototype.generateCacheBustUrl = function(url, expando) {\n      var hash, oldParams, originalUrl, params, _ref;\n      if (expando == null) {\n        expando = this.generateUniqueString();\n      }\n      _ref = splitUrl(url), url = _ref.url, hash = _ref.hash, oldParams = _ref.params;\n      if (this.options.overrideURL) {\n        if (url.indexOf(this.options.serverURL) < 0) {\n          originalUrl = url;\n          url = this.options.serverURL + this.options.overrideURL + \"?url=\" + encodeURIComponent(url);\n          this.console.log(\"LiveReload is overriding source URL \" + originalUrl + \" with \" + url);\n        }\n      }\n      params = oldParams.replace(/(\\?|&)livereload=(\\d+)/, function(match, sep) {\n        return \"\" + sep + expando;\n      });\n      if (params === oldParams) {\n        if (oldParams.length === 0) {\n          params = \"?\" + expando;\n        } else {\n          params = \"\" + oldParams + \"&\" + expando;\n        }\n      }\n      return url + params + hash;\n    };\n\n    return Reloader;\n\n  })();\n\n}).call(this);\n\n},{}],8:[function(require,module,exports){\n(function() {\n  var CustomEvents, LiveReload, k;\n\n  CustomEvents = require('./customevents');\n\n  LiveReload = window.LiveReload = new (require('./livereload').LiveReload)(window);\n\n  for (k in window) {\n    if (k.match(/^LiveReloadPlugin/)) {\n      LiveReload.addPlugin(window[k]);\n    }\n  }\n\n  LiveReload.addPlugin(require('./less'));\n\n  LiveReload.on('shutdown', function() {\n    return delete window.LiveReload;\n  });\n\n  LiveReload.on('connect', function() {\n    return CustomEvents.fire(document, 'LiveReloadConnect');\n  });\n\n  LiveReload.on('disconnect', function() {\n    return CustomEvents.fire(document, 'LiveReloadDisconnect');\n  });\n\n  CustomEvents.bind(document, 'LiveReloadShutDown', function() {\n    return LiveReload.shutDown();\n  });\n\n}).call(this);\n\n},{\"./customevents\":2,\"./less\":3,\"./livereload\":4}],9:[function(require,module,exports){\n(function() {\n  var Timer;\n\n  exports.Timer = Timer = (function() {\n    function Timer(func) {\n      this.func = func;\n      this.running = false;\n      this.id = null;\n      this._handler = (function(_this) {\n        return function() {\n          _this.running = false;\n          _this.id = null;\n          return _this.func();\n        };\n      })(this);\n    }\n\n    Timer.prototype.start = function(timeout) {\n      if (this.running) {\n        clearTimeout(this.id);\n      }\n      this.id = setTimeout(this._handler, timeout);\n      return this.running = true;\n    };\n\n    Timer.prototype.stop = function() {\n      if (this.running) {\n        clearTimeout(this.id);\n        this.running = false;\n        return this.id = null;\n      }\n    };\n\n    return Timer;\n\n  })();\n\n  Timer.start = function(timeout, func) {\n    return setTimeout(func, timeout);\n  };\n\n}).call(this);\n\n},{}]},{},[8]);\n"
          },
          "redirectURL": "",
          "headersSize": 146,
          "bodySize": 39133,
          "_transferSize": 39279
        },
        "cache": {},
        "timings": {
          "blocked": 2.174876000001881,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.05699999999999994,
          "wait": 76.26300000122842,
          "receive": 2.5270000005548354,
          "_blocked_queueing": 0.8760000018810388
        },
        "serverIPAddress": "[::1]",
        "connection": "142397",
        "pageref": "page_1"
      },
      {
        "startedDateTime": "2018-08-01T00:25:09.266Z",
        "time": 9.551493999191734,
        "request": {
          "method": "GET",
          "url": "http://localhost:1234/api/profile.json",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "Pragma",
              "value": "no-cache"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br"
            },
            {
              "name": "Host",
              "value": "localhost:1234"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            },
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.75 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Referer",
              "value": "http://localhost:1234/"
            },
            {
              "name": "Cookie",
              "value": "_ga=GA1.1.829006498.1522709868; visit=\"v=1&G\""
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Cache-Control",
              "value": "no-cache"
            }
          ],
          "queryString": [],
          "cookies": [
            {
              "name": "_ga",
              "value": "GA1.1.829006498.1522709868",
              "expires": null,
              "httpOnly": false,
              "secure": false
            },
            {
              "name": "visit",
              "value": "\"v=1&G\"",
              "expires": null,
              "httpOnly": false,
              "secure": false
            }
          ],
          "headersSize": 425,
          "bodySize": 0
        },
        "response": {
          "status": 200,
          "statusText": "OK",
          "httpVersion": "HTTP/1.1",
          "headers": [
            {
              "name": "date",
              "value": "Wed, 01 Aug 2018 00:25:09 GMT"
            },
            {
              "name": "x-content-type-options",
              "value": "nosniff"
            },
            {
              "name": "server",
              "value": "WEBrick/1.3.1 (Ruby/2.3.3/2016-11-21)"
            },
            {
              "name": "X-Powered-By",
              "value": "Express"
            },
            {
              "name": "Vary",
              "value": "Accept-Encoding"
            },
            {
              "name": "content-type",
              "value": "application/json"
            },
            {
              "name": "Cache-Control",
              "value": "private, max-age=0, must-revalidate"
            },
            {
              "name": "connection",
              "value": "close"
            },
            {
              "name": "content-length",
              "value": "42"
            }
          ],
          "cookies": [],
          "content": {
            "size": 42,
            "mimeType": "application/json",
            "compression": -1,
            "text": "{\"data\":\"Hello 2018-07-31 20:25:09 -0400\"}"
          },
          "redirectURL": "",
          "headersSize": 305,
          "bodySize": 43,
          "_transferSize": 348
        },
        "cache": {},
        "timings": {
          "blocked": 0.8134939999998896,
          "dns": -1,
          "ssl": -1,
          "connect": -1,
          "send": 0.039000000000000035,
          "wait": 7.395000001574633,
          "receive": 1.3039999976172112,
          "_blocked_queueing": 0.4939999998896383
        },
        "serverIPAddress": "[::1]",
        "connection": "142391",
        "pageref": "page_1"
      }
    ]
  }
}